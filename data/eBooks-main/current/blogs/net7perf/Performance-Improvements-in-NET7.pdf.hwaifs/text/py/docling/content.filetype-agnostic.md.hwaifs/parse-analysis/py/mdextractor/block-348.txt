private NetworkStream _client, _server; [GlobalSetup] public void Setup() { using var listener = new Socket(AddressFamily.InterNetwork, SocketType.Stream , ProtocolType.Tcp); listener.Bind(new IPEndPoint(IPAddress.Loopback , 0)); listener.Listen(1); var client = new Socket(AddressFamily.InterNetwork, SocketType.Stream , ProtocolType.Tcp); client.Connect(listener.LocalEndPoint); Socket server = listener.Accept(); _client = new NetworkStream(client, ownsSocket: true); _server = new NetworkStream(server, ownsSocket: true); } [Benchmark] public async Task Handshake() { using NegotiateStream client = new NegotiateStream(_client, leaveInnerStreamOpen: true); using NegotiateStream server = new NegotiateStream(_server, leaveInnerStreamOpen: true); await Task.WhenAll(client.AuthenticateAsClientAsync(), server.AuthenticateAsServerAsync()); }