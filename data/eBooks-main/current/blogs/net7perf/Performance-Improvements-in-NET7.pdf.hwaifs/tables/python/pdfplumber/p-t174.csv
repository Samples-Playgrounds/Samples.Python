,0
0,using System.Buffers;
1,using System.Diagnostics;
2,using System.IO.Compression;
3,using System.Text;
4,
5,using var hc = new HttpClient();
6,"byte[] data = await hc.GetByteArrayAsync(""https://www.gutenberg.org/ebooks/100.txt.utf-8"");"
7,Console.WriteLine(data.Length);
8,
9,var compressed = new MemoryStream();
10,var sw = new Stopwatch();
11,
12,for (int level = 0; level <= 11; level++)
13,{
14,const int Trials = 10;
15,
16,compressed.Position = 0;
17,"Compress(level, data, compressed);"
18,
19,sw.Restart();
20,for (int i = 0; i < Trials; i++)
21,{
22,compressed.Position = 0;
23,"Compress(level, data, compressed);"
24,}
25,sw.Stop();
26,
27,"Console.WriteLine($""{level},{sw.Elapsed.TotalMilliseconds /"
28,"Trials},{compressed.Position}"");"
29,
30,"static void Compress(int level, byte[] data, Stream destination)"
31,{
32,"var encoder = new BrotliEncoder(quality: level, window: 22);"
33,"Write(ref encoder, data, destination, false);"
34,"Write(ref encoder, Array.Empty<byte>(), destination, true);"
35,encoder.Dispose();
36,
37,"static void Write(ref BrotliEncoder encoder, byte[] data, Stream destination, bool"
38,isFinalBlock)
39,{
40,byte[] output = ArrayPool<byte>.Shared.Rent(4096);
41,
42,OperationStatus lastResult = OperationStatus.DestinationTooSmall;
43,ReadOnlySpan<byte> buffer = data;
44,while (lastResult == OperationStatus.DestinationTooSmall)
45,{
46,"lastResult = encoder.Compress(buffer, output, out int bytesConsumed, out"
47,"int bytesWritten, isFinalBlock);"
48,if (lastResult == OperationStatus.InvalidData) throw new
49,InvalidOperationException();
50,"if (bytesWritten > 0) destination.Write(output.AsSpan(0, bytesWritten));"
51,if (bytesConsumed > 0) buffer = buffer.Slice(bytesConsumed);
52,}
53,
54,ArrayPool<byte>.Shared.Return(output);
55,}
