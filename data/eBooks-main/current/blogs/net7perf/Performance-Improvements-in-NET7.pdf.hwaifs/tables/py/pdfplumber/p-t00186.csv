,0
0,"private SslStream _sslClient, _sslServer;"
1,private readonly byte[] _buffer = new byte[1];
2,private readonly SslServerAuthenticationOptions _options = new
3,SslServerAuthenticationOptions
4,{
5,"ServerCertificateContext = SslStreamCertificateContext.Create(GetCertificate(), null),"
6,};
7,
8,[GlobalSetup]
9,public void Setup()
10,{
11,"using var listener = new Socket(AddressFamily.InterNetwork, SocketType.Stream,"
12,ProtocolType.Tcp);
13,"listener.Bind(new IPEndPoint(IPAddress.Loopback, 0));"
14,listener.Listen(1);
15,
16,"var client = new Socket(AddressFamily.InterNetwork, SocketType.Stream,"
17,ProtocolType.Tcp);
18,client.Connect(listener.LocalEndPoint);
19,
20,"_sslClient = new SslStream(new NetworkStream(client, ownsSocket: true),"
21,"leaveInnerStreamOpen: true, delegate { return true; });"
22,"_sslServer = new SslStream(new NetworkStream(listener.Accept(), ownsSocket: true),"
23,"leaveInnerStreamOpen: true, delegate { return true; });"
24,
25,Task.WaitAll(
26,"_sslClient.AuthenticateAsClientAsync(""localhost"", null, SslProtocols.None,"
27,"checkCertificateRevocation: false),"
28,_sslServer.AuthenticateAsServerAsync(_options));
29,}
30,
31,[GlobalCleanup]
32,public void Cleanup()
33,{
34,_sslClient.Dispose();
35,_sslServer.Dispose();
36,}
37,
38,[Benchmark]
39,public async Task ReadWriteAsync()
40,{
41,for (int i = 0; i < 1000; i++)
42,{
43,ValueTask<int> read = _sslClient.ReadAsync(_buffer);
