"[\"Porting existing\\nASP.NET apps to\\nNET 7\\n\\nSteve \\\"ardalis\\\" Smith\\n\\nmE Microsoft\\n\\nPUBLISHED BY\\n\\nMicrosoft\", \" Developer Division, .NET, and Visual Studio product teams\\nA division of Microsoft Corporation\\n\\nOne \", \"Microsoft Way\\n\\nRedmond, Washington 98052-6399\\n\\nCopyright \\u00a9 2023 by Microsoft Corporation\\n\\nAll rights\", \" reserved. No part of this book's contents may be reproduced or transmitted in any form or\\nby any me\", \"ans without the written permission of the publisher.\\n\\nThis book is provided \\u201cas-is\\u201d and expresses th\", \"e author's views and opinions. The views, opinions, and\\ninformation expressed in this book, includin\", \"g URL and other Internet website references, may change\\nwithout notice.\\n\\nSome examples depicted here\", \"in are provided for illustration only and are fictitious. No real association\\nor connection is inten\", \"ded or should be inferred.\\n\\nMicrosoft and the trademarks listed at https://www.microsoft.com on the \", \"\\u201cTrademarks\\u201d webpage are\\ntrademarks of the Microsoft group of companies.\\n\\nMac and macOS are trademar\", \"ks of Apple Inc.\\n\\nThe Docker whale logo is a registered trademark of Docker, Inc. Used by permission\", \".\\nAll other marks and logos are property of their respective owners.\\n\\nAuthors:\\n\\nSteve \\u201cardalis\\u201d Smit\", \"h, Software Architect and Trainer - Ardalis.com\\nParticipants and Reviewers:\\n\\nNish Anil, Senior Progr\", \"am Manager, .NET team, Microsoft\\n\\nMike Rousos, Principal Software Engineer, .NET team, Microsoft\\nSco\", \"tt Addie, Senior Content Developer, .NET team, Microsoft\\n\\nDavid Pine, Senior Content Developer, .NET\", \" team, Microsoft\\n\\nVersion\\n\\nThis guide covers .NET 7 and updates related to the same technology \\u201cwave\", \"\\\" (that is, Azure and other\\nthird-party technologies) coinciding in time with the .NET 7 release. Th\", \"is book covers migration of\\napps that are currently running on .NET Framework 4.x.\\n\\nWho should use t\", \"his guide\\n\\nThis guide's audience is developers, development leads, and architects who are interested\", \" in\\nmigrating their existing apps written for ASP.NET MVC and Web API (.NET Framework 4.x) to the la\", \"test\\nmE Microsoft\\n\\n.NET version. ASP.NET Web Forms developers will benefit from this guide but shoul\", \"d also read the\\nBlazor for ASP.NET Web Forms Developers e-book.\\n\\nA secondary audience is technical d\", \"ecision-makers planning when to move their apps to .NET 7.\\n\\nThe target audience for this book is .NE\", \"T developers with large, existing apps that run on ASP.NET\\nMVC and Web API. Apps built on ASP.NET We\", \"b Forms are outside of the focus of this book, though\\nmuch of the information comparing .NET Framewo\", \"rk and .NET Core/latest may still be relevant.\\n\\nHow you can use this guide\\n\\nYou can read this book s\", \"traight through, as we expect many readers to do. This book will provide you\\nfirst with consideratio\", \"ns for whether you should port your app at all. That content is followed by\\narchitectural difference\", \"s between .NET Framework and .NET Core. From there, you'll learn strategies\\nfor migrating a large so\", \"lution over time and how to port a real app. Next, the book includes\\ndeployment scenarios that addre\", \"ss the need to run different apps while appearing as a single app to\\nusers. The book concludes with \", \"two case studies describing real apps that have migrated from\\nASP.NET MVC to ASP.NET Core.\\n\\nWhether \", \"or not you choose to start from the first chapter, you can reference any of these chapters to\\nlearn \", \"about specific concepts:\\n\\n\\u00b0 Architectural differences\\n\\n\\u00b0 Migrate large solutions\\n\\u00b0 Sample migration\\n\", \"\\u00b0 Deployment scenarios\\n\\nThis guide Is available both in PDF form and online. Feel free to forward th\", \"is document or links to its\\nonline version to your team to ensure a common understanding of these co\", \"ncepts.\\nContents\\n\\nIntroduction to porting apps to .NET 7 .....................ssssssssssssssssssssss\", \"ssssssscssssssscsseecs\\n\\nREFEFENCES oon .seecessessessssssscsssecsessscsecscsessessessecsecsecsecsecs\", \"ecsecuscnecuscsscuscucsussussucsucsussussussucsucsessesseeseeseesseseeaeeseeseeneeneess\\nMigration CO\", \"NSIGELATIONS.......cececsesessessssesessesessessssesssessssesssesussesussesssessssesssesessesssseses\", \"sesessesessesesseseeseseeseaeeneess\\nIs Migration to NET Core APPropriate? oe eececesssssssssessesese\", \"sesesessssessesecsesesessesessesesseeesseeesseesseenees\\nWhen is .NET Framework appropriate? ou... cc\", \"essesessesessesessessssesessesessessssesessesesseessesessesessesesseeesseeesseeess\\nREPFEPENCES....ec\", \"essesssssssssssssssssussscsscsscscsessecsecsessecsessecsecsecsecuscuscuecucsuseucsucsucaucsussucsucs\", \"ussucsussecaeeseeaeeseeneeneeaeeneenens\\nMigrate to ASP.NET Core 2.1 wccceccsessessssessssessssesesse\", \"ssssesessesessesessesessesessesessesessesssesessesessesessesessesesseseeseseeneens\\nShould apps run o\", \"n .NET Framework with ASP.NET Core 2.1 w.cccecccesssssssecessecessesesseeesseeesseeeees\\nREPFEPENCES.\", \"...ecessesssssssssssssssssussscsscsscscsessecsecsessecsessecsecsecsecuscuscuecucsuseucsucsucaucsussu\", \"csucsussucsussecaeeseeaeeseeneeneeaeeneenens\\nChoose the right .NET Core Version .....cccccsessssssse\", \"ssssessssessssesessesessesessesessesessesessesessesessesessesesseseeseeesseeeeaeeess\\nREPFEPENCES....\", \"ecessesssssssssssssssssussscsscsscscsessecsecsessecsessecsecsecsecuscuscuecucsuseucsucsucaucsussucsu\", \"csussucsussecaeeseeaeeseeneeneeaeeneenens\\nStrategies for Migrating INCFEMENtAl]Y...... ce csecsesses\", \"sesessesseccsessessesssessecscsessessesessessecussesssenssesseeseeeeseess\\nMigrating SlIC@ DY SlICO@ \", \"Le eeesessesesesessesessesesscsessssessssessssesscsessessssssessssessssessssessssesessesnssesesseces\", \"secesseensseenees\\nMigrating layer Dy layer... eccesssessessssessssesessessssssesssssssssessssesssses\", \"sssessssessesesussesssseseesesessesesseeessecesseensseenees\\nREPFEPENCES....ecessesssssssssssssssssus\", \"sscsscsscscsessecsecsessecsessecsecsecsecuscuscuecucsuseucsucsucaucsussucsucsussucsussecaeeseeaeesee\", \"neeneeaeeneenens\\nStrategies for migrating ASP.NET Web FOr app .u......cccssessessesssssssesecsesssss\", \"csessessecucsesseencseeseeseenssess\\nSeparate business logic ANd Other CONCEINS.......cecessesesseses\", \"sesessesessecsssessssesessecessesessecesseesseeeeseensseenees\\nImplement client behavior ANd Web APIS\", \"... eeesssssssssessessscssscsessssessssesscseseesesessesesseeesseeesseeeseenees\\nCONMSIer BlAZOM oe e\", \"eeeseesessessessseesessesscsessessesscsecsesscsessecsesscsecuesucsessesscsessecucsscsesuesucsessecue\", \"sessesuesucaeeneseeaeeneeneasens\\nSUIMIM ALY... eesesssssesscsesesesssesscscsesesesscucseseseseseesue\", \"seseseseseasssssesesesesscucsessseseseseseseneseseseneeeeneseseseseseeususeeseseseseeneeneess\\nREPFEP\", \"ENCES....ecessesssssssssssssssssussscsscsscscsessecsecsessecsessecsecsecsecuscuscuecucsuseucsucsucau\", \"csussucsucsussucsussecaeeseeaeeseeneeneeaeeneenens\\nDeployMeNnt StrateGle@S.......ccsecessessssecssse\", \"csssessssessssesessessssesessesssssssssesessesessesessesessesessesessesessesessesesseseeseseeseseene\", \"ens\\nCrOss-PlatfOrM OPtiONS........cccccccccsessessesesssssessesessessesessessessssessecsssessessecss\", \"sessecsssesseesecessesseeueseeseenesesseeneeneseess\\nCIOUC Native CEVEIOPME|NE uu... ee esessessssess\", \"esessesessesessssessesessssessssessesessssessesessesessesessesessesesseseeseseeseatenesesseens\\nLEVEL\", \"AGE CONTAINETS .....eeseesessessessesseesessessessessecsecsecsecsecsecsccsecuccuccussuccucsucsucsues\", \"ucsucsucsucsessecseeseeaeeseeseeaeeneeneeneens\\nSide-by-side GeplOyMeENt OPtiONS .......eessccessesss\", \"sesessessssesessesessesessesessecessesesseessecsseesseensseeesseeeeseesseenees\\n[WS OM WiNGOWS o... e\", \"e ececcessessesseseesessesscsessecscsscsecsecucsscsecucsucsecsesueassecuesucsessesucsecsecuesucsesse\", \"cucaesaecuessaessesucaesneeneeseass\\n\\nOther OPtioNs ON WINKOWS Wu... .eeessssssssssssesessessssesesse\", \"sesscsesscsessesessesessssessesessesessesessesessesesseseesesessesesseseeneans\\n\\nsesseceeuecseneenene\", \"ese 2\\nsesseceeuecseneeneneese 3\\n\\nsesseceeuecseneeneneese 4\\nsesseceeuecseneeneneese 4\\n\\nContents\\nREFEF\", \"ENCOS .....cccccccsceccsseccsceccsccscsscscesescescsccscscescsesacsccscceseacsccsesccsesccscsccsecsc\", \"secsesscsesscseacsescsscscsessesecaescsecscsecacaessesecaeeacaeeseaecacecs 9\\n\\nAdditional Migration F\", \"ESOUMCES ......ccecessesessesessssessesesssssssecsssecscsessssessssesussessssecsssecussecsssesussesu\", \"ssecessesussecusseensseeesseeeeseensaeenees 10\\nOfficial COCUMENTATION .......eeceececseessessessesse\", \"ssessessesscsecsscsscsscsecscsessecsecsecsecsecsecnecuecuecuecuccucsucsucsucsucsucssseeseeseeseeaees\", \"eeseeneeneenss 10\\nGITHUD oon ecceccessessessssessesscsscsesscsscsessccucsscsecucsscsecuecussecsecucs\", \"ussesuesucsscsecuesucsesnesucscnecucascsesuesucsesnecucaecnesuesucsecuesueseenecueateneeneaneass 10\\n\", \"Stack Overflow ....ccececsessssssssssssssessessessssessessecsecsessessessessessessessecsecsessecscsu\", \"scuccussuseucsucsucsucsucsussussucsucsecsusseeseeaeeaeeaeeaeeaeeneeneeneens 11\\nYOUTUDE CHANNEIS.....\", \" ee eeescesssseesesseseseesesscsscsessecucsecsessesscsessesuescsecsesucsessecsesessesucsscsesnecucse\", \"ssecucsucsecsesucsesseseesesaeeeseeeaeeneenenee 11\\nTwitter, Gitter, Slack, and other COMMUNIty Chann\", \"els... eesessesessesessecesseceeseeesseesesesesseeesseeesseeesseeeeseeseseeees 11\\nREFEPENCES....eses\", \"sessessessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucs\", \"ucsussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 11\\n\\nArchitectural differences between AS\", \"P.NET MVC and ASP.NET Core.u...ccccesescsesesesseseesesseseeseenees 12\\n\\nBreaking CHANGES.......ccecs\", \"essssessssesessessssessssecsssesessessssesussessssesssesssesessessssesussessssessssesessesussesesses\", \"essesessesessesessesessesessesessesesseseeseees 12\\n\\nApp startup differences between ASP.NET MVC and \", \"ASP.NET Core .....ecessssssessessessssessessesessssseetesessseeseeses 12\\nASP.NET MVC Startup uu. ccc\", \"cccsssssssssssessssesessssessssssesessssesesessssesessesesessesessenescsesssscsesussesesuceesescnese\", \"seeueseseseeneseseeneseseeneaees 13\\nASP.NET Core Startupn...cccecccsssssssssssssssssessssssesssssses\", \"esessesesessssesessssesessesesesssesessscseseesesesesesseseeneseseeueseseseseeseseeeeseseenesees 13\\n\", \"POrting CONSICELAtTIONS ......eeeeessessssesessesessesessesessesessesessesssesessescsessssessssesesu\", \"sssnescsesussssessssecussecessecussecessesussecessesesseensseenees 14\\nREFEPENCES....esessessessessss\", \"ssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucs\", \"ussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 14\\n\\nHosting differences between ASP.NET MVC and ASP.\", \"NET Core u.u..ccessssssessessessssessessssessesscscsesseencsessseseeneseess 14\\nREFEPENCES....esesses\", \"sessessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucs\", \"ussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 15\\n\\nServe static files in ASP.NET MVC and A\", \"SP.NET Core wu...cccccessssssssessessecsesssssessssscsucsucsucsussucseseeseeseeseeaeeaeeseeaseneenss\", \" 15\\nHost static files in ASP.NET MVC uu. ececsssessessessessessecsessessecscsuscuccussucsussucsussuc\", \"sussussussussucsussssesseeseeaeeseeaeeaseaeeaeeaeeneenee 15\\nHost static files in ASP.NET COre....cse\", \"sessessesssssessessesssssessesscssssnscussussussucsussucsussussucsuesucsussesseeseeaeeseeseeseeaeeae\", \"eaeeaeeneenee 15\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecs\", \"ecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 16\\n\\nD\", \"ependency injection differences between ASP.NET MVC and ASP.NET Core .u.cceessesessessestesesseeseee\", \"eseens 16\\nDependency Injection IN ASP.NET Core ....cccesssssssssssssssssssssssssssesssscsessssessese\", \"ssesesscsesessecessecsssesessesussecessesesseeesseenees 16\\nREFEPENCES....esessessessessssssssesscsns\", \"sussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsuesee\", \"sueseeseeaeeseeaeeaeeaeeaeeneeneenee 17\\n\\nCompare middleware to MOACUuIeS ANd NAaNdle/S ou... eeecess\", \"esessesessesessesessecsssecessesessecessesesseseesesessesessesesseeesseeesseeeeseees 17\\nASP.NET modu\", \"les and Nandlers ........ ee eesessssesssssesseseesecsesessecsecscsecsessessesessesucsessesnesussess\", \"esucsessesueseeseeseseeseeaeeeeeeaeeneeenees 17\\nASP.NET Core Middleware... .ccecesesssssssssssssesee\", \"ssssessesesessesucsessecsesucsessesuesecsesucsucsesnesucsessesucsecsesuesuesesseseseeaeseeeeeaeeneen\", \"enees 17\\nACCESSING HttO CONTEXT... eeecesscsessessssesessecessesessessssesussesussesussesussesussess\", \"ssesussesussesussesussesussesussesussesessesussesessesesaeeesseaeeseeess 17\\nREFEPENCES....esessesses\", \"sessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsuss\", \"ussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 18\\n\\nConfiguration differences between ASP.NET \", \"MVC and ASP.NET Core .uw..eccccccesessessesessessesecsessessestssseseeneseass 18\\nASP.NET MVC COnPIQu\", \"ration.....cccccessesssssssessesesssssesscsessessesssessecussesssssssussessseussessesnssussessesusse\", \"sseeucsusseeseaussesseenssesseeneaeeaees 19\\nASP.NET Core CONFIQUIATION .....ceeeeessessesessessesess\", \"essesscsssessesussessecussucsessesussessecussussesnesussesseeussesseeuesucseesesussesseenesesseenean\", \"siees 19\\n\\nil Contents\\nMigrate CONFIQUIATION ......seesessessessessesseeseesessessecsecsecsecsecsecse\", \"cnecsecuscuscuscuecuecucsucsussussucsussucsucsucsussesseeseeseeseeaeesteaeeseeaeeseeneenee 20\\n\\nREFEP\", \"ENCES....esessessessessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscus\", \"eucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 21\\nRouting differences betw\", \"een ASP.NET MVC and ASP.NET Core .....ecesssssssessessesessessessssessssscsssesseenssesseeseenesess \", \"21\\nRouting In ASP.NET MVC and We) API uu... ccecesscsssssssssssesscsssscsssscsessssessesessesesseses\", \"sssecessesseseeuesesussesessesnsseensseensseenees 21\\nROUTE table ooo. ecececcessesseseeseesessessese\", \"ssecsesscsessecsesessecsesuesessecucssssesuesucsessecussecsessesucsessecucsucsessesussessecucsecsecu\", \"esueaeeaesneseeaeeneeneaees 21\\nROUTING IN NET 7 weececcecccsesscssssesesscssssesessesessesssesessese\", \"ssesessesssesssesessssessesesscssssesessssessssesussecussecessecucsesessesessecesseeesseensseeseas 2\", \"3\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecu\", \"ecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 24\\nLogging differenc\", \"es between ASP.NET MVC and ASP.NET Core wu...ececsssssssssesesessessessesesssssesesessesncsessseseen\", \"eseess 25\\nASP.NET MVC lOQGIINg ....e.sesesssssssessssesessesessesessesssesussesussesussesussesussesu\", \"ssesussesussesussessssesussesussesussesussesussesussesusseeessesessesesseeess 25\\nASP.NET Core lOQGIn\", \"d.....e.secesssssssssessesessesessessssesessessssesssesussesussesussesussesussessssessssesussesusses\", \"uesesussesussesssesussesesseeesseeesseeeeseeess 25\\nMigrate LOGGING ......seessesessessssesessesesses\", \"essesessesessesessesessesessesessesessesssessssssessesessesessssessesesussesussesuesecussecuesecesse\", \"sueseensseeesseensseenees 26\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucsscsscsscsucscs\", \"ecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeenee\", \"neenee 26\\nCompare Razor Pages to ASP.NET MVC... csssssssssssesesesesesessesesesesesencsesesesesesses\", \"esesesesesuceeseseseaeenseucaeseseaeeneneeeees 26\\nREFEPENCES....esessessessessssssssesscsnssussucsuc\", \"sucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseesee\", \"aeeseeaeeaeeaeeaeeneeneenee 27\\nCompare ASP.NET Web API 2 and ASP.NET Core wu...eeccesscssssessssesss\", \"sesessesessesessesessesessesssesessesessesesseseesesnsseeesseeesseeess 2/7\\nREFEPENCES....esessessess\", \"essssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussu\", \"ssucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 27\\nCompare authentication and authorization bet\", \"ween ASP.NET MVC and ASP.NET Core ......eeseseeeeees 27\\nAUtQOFiZatiOn ......eececcessesesssssessesee\", \"sessecscsessecsesscsessesucsscsesuesucsessesucscsecsesuesessessesecsesucsucsessesucsecsesucsessesses\", \"ucsessesueaesseeneeeeaeeneenenees 28\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucsscsscs\", \"scsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeea\", \"eeaeeneeneenee 28\\nCompare ASP.NET Identity and ASP.NET Core IGe@ntity oc esesessssesessesessesessese\", \"ssessssesesseeessesessesesseeseseeesseeess 28\\nMigrate from OWIN / Katana....cccccccscsssssssescsssss\", \"ssesessessscsssessessecussesssssssessessecussssecsssussessecussesseeuessseeseeeseeseeneaeeaes 29\\nREF\", \"EPENCES....esessessessessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecusc\", \"useucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 29\\nCompare controllers in\", \" ASP.NET MVC and Web API with controllers in ASP.NET Core uu... eee: 29\\nREFEPENCES....esessessessess\", \"ssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussu\", \"csussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 30\\nCompare Razor usage in ASP.NET MVC and ASP.NET \", \"Core..u..cscsessessssessssesesscsessesessessssesessesessessssesessesnsseensseeess 30\\nTAG H@IP er... \", \"ccecessesessessssessssessssecsssesessessssesussesussesussesussesussesussesussesussesussesussesussesu\", \"ssesucsesussesussesussesussesussesussesssesessesesaeeeeseeess 30\\nRAZOP PAGES uu... ecesssesssseseses\", \"esesesscsesesesesesuesesesesesessesesesesesessussesesesesessssesesesesesessussesesesesessesesesesese\", \"seesueseseseseaeeeeeeneseaeseeeseeeeeess 30\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsuc\", \"sscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeesee\", \"aeeaeeaeeaeeneeneenee 31\\nCompare ASP.NET SignalR and ASP.NET Core SIQnalR ........ccessessssessssess\", \"ssesessesessesessesessesessesessesessesessesesseeneseeesseeess 31\\nFeature CIfference ......ceesecses\", \"sssssssessssssssessessessessecsecsessecsessesnecsecsecucsuseuccuscuscucsussussussucsucsucsussucsusse\", \"sseeseeseeaeeaeeaeeaeeaeeneeaeeneenee 31\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucssc\", \"sscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaee\", \"aeeaeeaeeneeneenee 31\\nCompare testing options between ASP.NET MVC and ASP.NET Core ......cccsessesss\", \"sessssesessesessessssestsseeesseetsseees 32\\n\\nContents\\nRETEFENCOS .....eccccccsceccscescssescsscscecs\", \"scescsccsesscscsccscccsecscsscscsscacsecscsccsesacsccscsccscsecsesacsscscsscscsscsesscaecacsecscsscs\", \"esscaeescsecsesscseceacseaeeneas 32\\n\\nMigrate large Solutions to ASP.NET COre.....cccsscssssssssssese\", \"ssesessessssssesssesessesessesesscsessssesessesessssesnsseeeeseeeeseaeees 33\\nREFEFENCES o.e.ceesesse\", \"ssessessessessesseesecsessecsecsessccsecuccuscucsucsucsussussussucsucsussucsucsucsucsecsecsecnecsecu\", \"seuecuscuscucsucsucsussussucsussucsecseeseeseeaeeneeaeeneenens 33\\nIdentify SEQUENCE OF PrOJECtS TO M\", \"IGKATE ou... eccecsessessesessessecsesessecsessssessecussesssssssucsessesussessecnssussessecussessee\", \"nssesseeneeneseess 33\\n\\nUNIt tOSES ee ecceccessesseseeseesessessesessessencsecuesucsessecuesscsesuesu\", \"csessecucsscsesuecucaessecuesucsecuesucsessecucsussecuecucaessecusscsecuesucaesaeeueateaeeneeneaees \", \"37\\nConsiderations fOr MIGratING MANY APPS........ccesessessssessessesesseesessssessessessssessecsese\", \"sseenesecsesseesssesseeseseeseeseessesseeseseeaes 37\\nSUIMIM ALY... eesesssesessssesesesesesscscseses\", \"escscsesesesesesscsesesesesesesussesesesesesesusuesesesesesessuesesesesesesucsesesesesesesssuesesese\", \"sesecucsescseseseeeenesenesenenees 38\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucsscssc\", \"sscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaee\", \"aeeaeeneeneenee 38\\nUnderstand and update dependencies... cccessessssessssessssessssessssessssesssses\", \"sssesessesessesessesessesessesessesessesessesessesesseseeseseeneees 38\\nUpdate class library AEPe@nde\", \"Nncle........ccessssssssssssesssesessesesscssssssessesessssessesessssessesesscsesessesessessesesesse\", \"seesecesseeesseensseenees 38\\nUpdate NuGet package CEPendeNnCle.......c.ccccssssssssssssssssesssscsss\", \"sessssssessssessssessesesscsesessecessessesesesseseesecnsseeesseensseenees 39\\nMigrate ASP.NET MVC pr\", \"ojects ....cccccsssssssssssssssssssssssssssssessssssssssssesessssessssessssessssessssesussessssesuss\", \"esessesessecesseeesseensaeeneas 40\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucsscsscssc\", \"sucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaee\", \"aeeneeneenee 40\\nStrategies for Migrating While FUNNING IN PFOCUCTION .......ceecsesessessessesesssss\", \"esssessecscsesssssesecsessssucsesseesesesseeseenesseass 40\\nRefactor the .NET Framework SOLUTION... c\", \"cecessessessessessecsessecsscnssucsucsucsscsucsussussussucsussussesseeseeseeseeseeseeaeeseeaeeaeenee\", \"nee 40\\nExtract front-end assets to a CDN... ccessesssssesssssessessesssssessscnscnsssssussscsucsussu\", \"csuesussusscsssessesseeaeeaeeaeeaeeaeeaeeaseaeeneenee 41\\nExtract and migrate Individual MICFOSEFVICE\", \"S .......eesessesssssssssscsessesesscsessesessesesscseseesecessecuesessssesessecusseensseensseenees \", \"41\\nDeploy multiple versions of the app Side-by-side iN WS... ssessessesessessesesessessesesesseessse\", \"ssesseeeseeseeneeeesee 41\\nApply the Strangler pattern 0... cccscssssessssessssesssssssssesessesssses\", \"essesessssssesessesussesssesussesessesussesessesessesessesessesesaeeesseeeeseeess 41\\nMUIti-targeting\", \" APPrOACNES ......eeesscsessessssessssesessesessessssesessesessesessssessessssssessssessesessesessss\", \"esseseceesecsesecesseseesecseseensseeseseenees 42\\nSUIMIM ALY... eesesssesessssesesesesesscscsesesesc\", \"scsesesesesesscsesesesesesesussesesesesesesusuesesesesesessuesesesesesesucsesesesesesesssueseseseses\", \"ecucsescseseseeeenesenesenenees 42\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucsscsscssc\", \"sucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaee\", \"aeeneeneenee 42\\n\\nExample migration Of ESHOP to ASP.NET Cre ...eccccesssscssessssessesecsessesessesss\", \"sessesscsessesesseseesessesesseeseaesseenees 43\\nRun AptPort to identify problematic APIS... ccccsses\", \"sessssscsessessessssssscsesssssscussesssssssussessecucsessecsssssesseencsesseenssesseeseeneseess 44\\n\", \"Update project files and NUGet reference SYNtAX......ceecessssessessesessessecsssessesnssucsessecues\", \"essecsesecsessesussesseenesesseeneeseseess 47\\nCreate NEW ASP.NET Core Project....ccecessessssesssses\", \"sssessssessssessssesessesessesessesssesussesessesessessssesessesesseseesesesseseesesesseeeeseeeeseee\", \"ss 49\\n\\nMigrating NUGet Package 0... ccessessssessssessssesessesssscssssessssesesssssssssessesesseses\", \"sssessssessssessssessssesessessesecessecessecusseeesseensseenees 51\\nMigrate Static FICS... cesesssse\", \"ssessesssessessesessessscsssessessecussessssusssssssecussessecussussessecussesssenssussessecussessee\", \"uesessesseaneseeseeneaeeaees 53\\nMigrate C# fiIlQS occ cecsssessesesssssssesscsessessesussessecussess\", \"essesussessesussussessecussussesussucsussecussussesucsussessecussussesucsussesseeneseeseeneeneaes 54\", \"\\nMIGKAtE VIQWS .....cessccessesessessssesessesessessssesussesussesussesussesussessesessssesussesusse\", \"sussessssesussessesesussessssesessesusseseesesucsesessesessesessesesseaeeseaeeneens 56\\nMigrate app S\", \"tartup COMPONENTS ou... eecessesessessssessssessssesessesessessssesssesessesssessssesssesessesessese\", \"ssesessesessesessesessesessesseseseeseens 58\\nCONFIGUPE MVC... eecesccsessessescsessesscsussessecussu\", \"ssesussussssecussussesussussucsecussussscucsussucsecussussecucsussscsesusseesecussesseeucausseeseaus\", \"aesseeneaeeaes 58\\n\\nIv Contents\\nData ACCESS CONSICELATIONS .......c.cccccccsccccesscssccsscesscescess\", \"ccsscssccscesscssecsscesscssccssceasesscesscesscssecsscsacessecssceasesseesscsasessectsceasesscenses\", \" 63\\n\\nMigrate to Entity Framework Core ....cccccssssssssssssessssssscsssssssssssssscsessssessssssscse\", \"ssssesscsessssesessecsesesessesessecesseeesseeesseenees 64\\nFIX All TODO task wo. eeeccecessessesssse\", \"ssesessessesscsssecscsucsecsecucsscsessesucsessecsesucsessesucsessesucsucsecsesucsessesucsucsecnesus\", \"aessecucsesaecnesusaeeneeneaeens 67\\nAdditional MVC CUSTOMIZATIONS... eeessessssessessessestesessesse\", \"sessecnesucsessesucsessecnecucsesnecuesucsesnesucaessesueseesecuesucaesseeeaeeneeneeeaees 68\\nOther C\", \"EPENCE\\u2122N CIES ou... eeecessssessesessessssesessesessecssesessesussessssesussessesecussessesesussesus\", \"sessesesuesesussesussesussessesesuesesesseseesesesseeeeseeeeseeess 69\\nREFEFENCES o.e.ceesessessesses\", \"sessessesseesecsessecsecsessccsecuccuscucsucsucsussussussucsucsussucsucsucsucsecsecsecnecsecuseuecus\", \"cuscucsucsucsussussucsussucsecseeseeseeaeeneeaeeneenens 69\\nMOre MIGratiONn SCONALIOS o.....cessesess\", \"esessesessesessessssesssessssessssesussesussessssessesessssessesessssessssessssesussesussesucsesecse\", \"sessesessesesseaesseseeneens 69\\n\\nMigrate ASP.NET MVC 5 and WebApi 2 to ASP.NET Core MVC wu... eccese\", \"ssssssesessecesseceesecssesesesesseesseensseenees 69\\n\\nMigrate HttpResponseMessage to ASP.NET Core ..\", \".cccccsssssssssessssssssscsssscsesssssssssesessesessessssesesseseesecesseeesseeesseenees 70\\n\\nMigrate\", \" content negotiation from ASP.NET Web API to ASP.NET Core ....ccecesessesessesessessestesseseenesees\", \"ee 71\\n\\nCUSTOM MOE] DINING ou... eecessssessssessesessesessesessesessesessssessssessssussesessesesses\", \"ussesessesessesesseaessesessesessesesseseesesesseseeseaesneseeneess 71\\n\\nMedia fOrmatte rs... .eccecs\", \"sssssssssssssssesssessesessessessessessessessessessecsessesusesssuscucsucsucsucsussucsucsussucsussus\", \"sussesseeseeseeseeaeeseeaeeaeeaeeaeeneenee 73\\n\\nCUSTOM FIITOLS ee eccecessessessecsecsecsccsecsccucsu\", \"ccsscussucsussucsucsucsucsucsucsucsessecsecsecsessecsecuccuscuscucauccucsussucsucsucsucsucsesseesees\", \"eeaeeseeneeaeeneenss 73\\n\\nROUTE CONSTIAINES oo. eeessesesseesesseseseesecsesucsessecsescsecuesussesse\", \"cucsscsesnecucsessecuescsessesscsecsecucsuesesuesucsessecusseesecueseeaeeneeneateaeeneeneaees 74\\n\\nCU\", \"STOM FOUt!| NANAIE|S 0... eeeeseesessessesseseesecsesscsessecucsssecsesscsecsecuesscsesuesucsesnecue\", \"sscsesuesucsessesucsecsesuescsesueseaeeneceaeeneeneneeass 15\\n\\nCORS SUPPDOMT oo... eeeececsesesesesss\", \"scsesesesesessescsenesesusscsesesesesesussesesesesesssscsesesesesesscsesesesesessuesesesesesesesusse\", \"sesesesecsseseseseseseeteneeeseneaees 76\\n\\nCUSTOM ALEAS 0... eeeesessssesescsesesscsesecsesesessesese\", \"ssescsesucsesecucsesesucuesesecusneaesueseaesecucaesucucsessuesesesussesesusscsesecucaeseseeaeaesees\", \"eaeeesseaeeneess T/\\n\\nIntegration tests for ASP.NET MVC and ASP.NET Web API... cececcsessessesscsesse\", \"ssessssesseesesessssseeesseseeneeneses 78\\n\\nWCE cliQnt CONFIGUFATION.......eececcccessessessesessesse\", \"ccssessecscsssecsesussessecussussecsssussessecussussessesussessecussessecucsueseesesusseeseensseesee\", \"neanesees 80\\n\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecs\", \"ecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 80\\n\\nDepl\", \"oyment scenarios when Migrating to ASP.NET Cre .u.....cesesssssssssesseseseesessssesessesessssesssee\", \"ssseeseneseees 81\\nSplit a large WED ADP... eccsessssssssssssesssesssecssssssssesessessssessssesusses\", \"ussesessesussesussesussecsssessesesussesussessssesussecesseeesaesesseensseessseeess 81\\nSUIMIMALY ..c\", \"eeesesessssesssssesecsesesesesesscscsesesesessuesesesesesesscussesesesesesussesesesesessusuesesesese\", \"ssausuesesesesesessesescsesesesesuesesesesesesesesseeeseseseaeeneseeeees 84\\nREFEFENCES o.e.ceesesses\", \"sessessessessesseesecsessecsecsessccsecuccuscucsucsucsussussussucsucsussucsucsucsucsecsecsecnecsecus\", \"euecuscuscucsucsucsussussucsussucsecseeseeseeaeeneeaeeneenens 85\\n\\nSummary: Port existing ASP.NET App\", \"s to .NET 7 .u.ccceccccsesessesesessssesessssesesesessesesesecsessensesseseeneseseeeeeseaes 86\\n\\nV Co\", \"ntents\\nCHAPTER\\n\\nIntroduction to porting\\naoos to .NEI /\\n\\n.NET Core and its latest version, .NET 7, re\", \"present a revolutionary step forward from .NET Framework.\\nIt offers a host of advantages over .NET F\", \"ramework across the board from productivity to\\nperformance, from cross-platform support to developer\", \" satisfaction. ASP.NET Core was even voted\\nthe most-loved web framework (tied with Svelte) in the 20\", \"21 Stack Overflow developer survey. Clearly\\nthere are strong reasons to consider migrating.\\n\\nEven be\", \"fore .NET 7 shipped, Microsoft was clear: .NET Core is the Future of .NET. To quote this article:\\n\\nN\", \"ew apps should be built on .NET Core. .NET Core is where future investments in .NET will happen.\\nExi\", \"sting apps are safe to remain on .NET Framework which will be supported. Existing apps that want\\nto \", \"take advantage of the new features in .NET should consider moving to .NET Core. As we plan into\\nthe \", \"future, we will be bringing in even more capabilities to the platform.\\n\\nToday, .NET 7 is what new ap\", \"ps should target, and if you're migrating an existing app from .NET\\nFramework, .NET 7 is your ideal \", \"target framework.\\n\\nHowever, upgrading your app to ASP.NET Core will require some effort. That effort\", \" should be\\nbalanced against business value and goals. .NET Framework apps have a long life ahead of \", \"them, with\\nsupport built into Windows for the foreseeable future. What are some of the questions you\", \" should\\nconsider before deciding migration to .NET 7 is appropriate? What are the expected advantage\", \"s?\\nWhat are the tradeoffs? How much effort is involved? These obvious questions are just the beginni\", \"ng,\\nbut make for a great starting point as teams consider how to support their customers\\u2019 needs with\", \"\\napps today and tomorrow.\\n\\n. Is migration to .NET 7 appropriate?\\n\\n. When does it make sense to remai\", \"n on .NET Framework?\\n\\n. Should apps target ASP.NET Core 2.1 as a stepping stone?\\n\\n. How should teams\", \" choose the right .NET version to target?\\n\\n. What strategies are recommended for incremental migrati\", \"on of large apps?\\n. What deployment strategies should be considered when porting to .NET 7?\\n. Where \", \"can we find additional resources?\\n\\nThis introductory chapter addresses all of these questions and mo\", \"re before moving on to more\\nspecific and technical considerations in future chapters.\\n\\n1 CHAPTER 1 |\", \" Introduction to porting apps to .NET 7\\nReferences\\n\\n\\u00b0 2021 Stack Overflow developer survey most love\", \"d web frameworks\\n\\u00b0 .NET Core is the Future of .NET\\n\\nMigration considerations\\n\\nThe most fundamental q\", \"uestion teams must answer when it comes to porting their apps to .NET Core\\nis, Should they port at a\", \"ll? In some cases, the best path forward Is to remain on .NET Framework using\\nASP.NET MVC and/or Web\", \" API. This chapter considers reasons why moving to .NET Core makes sense.\\nThe chapter also considers\", \" scenarios and counterpoints for staying on .NET Framework.\\n\\nIs migration to .NET Core appropriate?\\n\", \"\\nLet's start with some of the reasons why you might want to move to .NET Core/.NET 7. There are quit\", \"e\\na few, so don't consider this list exhaustive.\\n\\nCross-platform support\\n\\nApps built on .NET Core ar\", \"e truly cross-platform and can run on Windows, Linux, and macOS. Not only\\ncan your developers use wh\", \"atever hardware they want, but you can also host your app anywhere.\\nExamples range from local IIS to\", \" Azure in the cloud or from Linux Docker containers to loT devices.\\n\\nPerformance and scalability\\n\\nAp\", \"ps built with .NET Core are running on one of the fastest tech stacks available anywhere. ASP.NET\\nMV\", \"C apps often see performance improvements on ASP.NET Core, especially if they're updated to\\n\\ntake ad\", \"vantage of some new features available in .NET Core.\\n\\nCloud-native\\n\\nFor the above reasons and others\", \", .NET Core apps are well-suited to running in cloud hosting\\nenvironments. Lightweight and fast, .NE\", \"T Core apps can be deployed to Azure App Services or\\ncontainers and scaled horizontally as needed to\", \" meet immediate system demand.\\n\\nMaintainable\\n\\nFor many apps, while they've continued to meet custome\", \"r and business needs, technical debt has\\naccumulated and maintaining the app has grown expensive. AS\", \"P.NET Core apps are more easily\\ntested than ASP.NET MVC apps, making them easier to refactor and ext\", \"end with confidence.\\n\\nModular\\n\\nASP.NET Core is modular, using NuGet packages as a first-class part o\", \"f the framework. Apps built for\\n.NET Core all support dependency injection, making it easy to compos\", \"e solutions from whatever\\nimplementations are needed for a given environment. Building microservices\", \" with .NET Core is easier\\n\\n2 CHAPTER 1 | Introduction to porting apps to .NET 7\\nthan with ASP.NET MV\", \"C with its dependency on IIS, which opens up additional options to break up\\nlarge apps into smaller \", \"modules.\\n\\nModern\\n\\nStaying on a modern, actively developed technology stack has a host of advantages.\", \" New features\\nand C# language features will only be added to .NET Core. The .NET Framework has had i\", \"ts last\\nrelease with version 4.8, and versions of C# beyond 8 won't target .NET Framework. While ASP\", \".NET\\nMVC will remain supported by Microsoft for many years, the best and brightest .NET software\\ndev\", \"elopers are likely looking to use the more modern .NET Core framework, with all of the advantages\\nit\", \" offers (only some of which are summarized above). Finding developers with the skills to maintain an\", \"\\nASP.NET MVC app will start to become a challenge at some point, as will finding online training and\", \"\\ntroubleshooting assistance. There probably aren't that many new blog posts being written about\\nASP.\", \"NET MVC 5, while there are plenty being written for .NET 7, for example.\\n\\nThere are many compelling \", \"reasons to consider migrating to .NET Core, which presumably is why\\nyou're reading this book! But le\", \"t's consider some disadvantages and reasons why it may make more\\nsense to remain on the .NET Framewo\", \"rk.\\n\\nWhen is .NET Framework appropriate?\\n\\nThe biggest reason to stay on .NET Framework is when an ap\", \"p isn\\u2019t under active development and\\nwouldn't benefit substantially from the advantages listed above\", \". In that case, there probably isn\\u2019t a\\ngood business case to incur the cost of porting the app. If y\", \"our app might benefit from the\\nadvantages .NET Core offers, you may still need to stay on .NET Frame\", \"work if you need certain\\ntechnologies that are unavailable on .NET Core. There are some .NET technol\", \"ogies that are unavailable\\non .NET Core, including AppDomains, Remoting, Code Access Security (CAS),\", \" Security Transparency,\\nand System.EnterpriseServices. A brief summary of these technologies and the\", \"ir alternatives is\\nincluded here. For more detailed guidance, see the documentation.\\n\\nApplication do\", \"mains\\n\\nApplication domains (AppDomains) isolate apps from one another. AppDomains require runtime\\nsu\", \"pport and can be expensive. Creating additional app domains isn't supported, and there are no\\nplans \", \"to add this capability to .NET Core in the future. For code isolation, use separate processes or\\ncon\", \"tainers as an alternative. Some customers use AppDomains as a way of unloading assemblies. In\\n.NET C\", \"ore AssemblyLoadContext provides an alternative way to unload assemblies.\\n\\nWCF\\n\\n.NET Core and .NET 5\", \"+ support WCF clients. Server-side WCF is possible through CoreWCF, which is\\nofficially supported by\", \" Microsoft as of April 2022. Apps that require server-side WCF functionality can\\nalso consider a dif\", \"ferent communication technology (such as gRPC or REST) as part of a migration.\\n\\nThere is a WCF clien\", \"t port available from the .NET Foundation. It\\u2019s entirely open source, cross\\nplatform, and supported \", \"by Microsoft.\\n\\nTo learn more about migrating from WCF to gRPC, consult the gRPC for WCF Developers e\", \"book.\\n\\n3 CHAPTER 1 | Introduction to porting apps to .NET 7\\nRemoting\\n\\n.NET Remoting was identified a\", \"s a problematic architecture. It\\u2019s used for cross-AppDomain\\ncommunication, which is no longer suppor\", \"ted. Also, Remoting requires runtime support, which is\\nexpensive to maintain. For these reasons, .NE\", \"T Remoting isn't supported on .NET Core, and the\\nproduct team doesn\\u2019t plan on adding support for it \", \"in the future. There are several alternative\\nmessaging strategies and implementations you can use to\", \" replace remoting in your .NET Core apps.\\n\\nCode Access Security (CAS) and Security Transparency\\n\\nNei\", \"ther of these technologies are supported by .NET Core. Instead, the recommendation is to use\\nsecurit\", \"y boundaries provided by the operating system. For example, virtualization, containers, or user\\nacco\", \"unts. Run processes with the minimal set of privileges necessary.\\n\\nReferences\\n.NET Framework Technol\", \"ogies Unavailable on .NET Core\\n\\nMigrate to ASP.NET Core 2.1\\n\\nASP.NET Core 2.1 is an interesting rele\", \"ase because it's the most recently supported ASP.NET Core\\nrelease that supported both .NET Core and \", \".NET Framework runtimes. As such, it may offer an easier\\nupgrade path for some apps when compared to\", \" upgrading all parts of the app to .NET Core/.NET 7 at\\nonce. Although support for .NET Core 2.1 ende\", \"d in August 2021, it may make sense as an interim step\\nfor some apps. Also, support for ASP.NET Core\", \" 2.1 running on .NET Framework will continue for as\\n\\nlong as its underlying .NET Framework is suppor\", \"ted. A complete list of currently supported ASP.NET\\nCore 2.1 packages is available for reference.\\n\\nS\", \"hould apps run on .NET Framework with ASP.NET Core 2.1\\n\\nASP.NET Core 2.2 and earlier supported both \", \".NET Core and .NET Framework runtimes. Does it make\\nsense to migrate some or all of an app to ASP.NE\", \"T Core 2.1 as a stepping stone, before porting over\\ncompletely to .NET Core? Apps, or subsets of app\", \"s, could see their front-end ASP.NET logic ported to\\nuse ASP.NET Core, while still consuming .NET Fr\", \"amework libraries for business logic and infrastructure\\nconsumption. This approach may make sense wh\", \"en there\\u2019s a relatively thin UI layer without much\\nbusiness logic, and a much larger set of function\", \"ality in class libraries.\\n\\nThe main benefit of porting just the front-end web layer to ASP.NET Core \", \"2.1 is that the existing .NET\\nclass libraries can remain as is during the initial migration. They ma\", \"y be in continued use by other\\n.NET apps or simply don't need to be in scope for the first iteration\", \" of a planned full migration to .NET\\nCore. Reducing the scope of the initial migration for large app\", \"s helps provide incremental goals that\\nact as stepping stones toward the desired end state, which is\", \" often a complete port to .NET Core.\\n\\nIf you have an existing app that may use this strategy, some t\", \"hings you can do today to help prepare\\nfor the process are to move as much business logic, data acce\", \"ss, and other non-UI logic out of the\\nASP.NET projects and into separate class libraries as possible\", \". It will also help if you have automated\\n\\n4 CHAPTER 1 | Introduction to porting apps to .NET 7\\ntest\", \" coverage of your system, so that you can verify behavior remains consistent before and after the\\nmi\", \"gration.\\n\\nIf your app is so large that you can\\u2019t migrate the entire web app at once, and you need to\", \" be able to\\ndeploy the new ASP.NET Core app side-by-side with the existing ASP.NET app, there are de\", \"ployment\\nstrategies that can be used to achieve this. These are covered in Chapter 5: Deployment Sce\", \"narios.\\n\\nKeep in mind that ASP.NET Core 2.1 was the last LTS release of .NET Core that supported run\", \"ning on\\n\\n.NET Framework and consuming .NET Framework libraries. Although the release is now unsuppor\", \"ted\\n\\non .NET Core, it continues to be supported for use with .NET Framework. It will remain supporte\", \"d for\\nas long as the specific .NET Framework version is supported. For more information, see ASP.NET\", \" Core\\n2.1 on .NET Framework.\\n\\nReferences\\n\\nMigrating from ASP.NET to ASP.NET Core 2.1 ASP.NET Core 2.\", \"1 on .NET Framework ASP.NET Core 2.1\\nSupported Packages\\n\\nChoose the right .NET Core version\\n\\nThe lar\", \"gest consideration for most organizations when choosing which version of .NET to target is the\\nsuppo\", \"rt lifecycle. Long Term Support (LTS) releases ship less frequently but have a longer support\\nwindow\", \" than Standard Term Support (STS) releases. Currently, LTS releases are scheduled to ship\\nevery othe\", \"r year. Customers can choose which releases to target, and can install different releases of\\n.NET si\", \"de by side on the same machine. LTS releases will receive only critical and compatible fixes\\nthrough\", \"out their lifecycle. STS releases will receive these same fixes and will also be updated with\\ncompat\", \"ible innovations and features. LTS releases are supported for three years after their initial\\nreleas\", \"e. STS releases are supported for six months after a subsequent STS or LTS release.\\n\\n.NET 7 is the l\", \"atest STS release; .NET 6 is the latest LTS release.\\n\\nCustomers looking to migrate a large .NET Fram\", \"ework app to .NET today may be looking for a stable\\ndestination, given that they haven't already mad\", \"e the move to an earlier version of .NET Core. In this\\ncase, the best .NET version to target for the\", \" migration is .NET 6, which is the most recent LTS version.\\nWhile support for .NET Core 3.1 ended in\", \" December 2022, support for .NET 6 will continue until\\nNovember 2024.\\n\\nOther customers may want to e\", \"nsure they're upgrading to the latest supported version, so that post-\\nmigration they're not already\", \" behind a version. These customers will want to target .NET 7 for the\\nmigration.\\n\\nIn either case, th\", \"ere is very little difference in the migration process. This book assumes .NET\\nFramework apps will b\", \"e upgraded to .NET 7.\\n\\nReferences\\n\\n.NET and .NET Core Support Policy\\n\\n5 CHAPTER 1 | Introduction to \", \"porting apps to .NET 7\\nStrategies for migrating incrementally\\n\\nThe biggest challenge with migrating \", \"any large app is determining how to break the process into\\nsmaller tasks. There are several strategi\", \"es that can be applied for this purpose, including breaking the\\napp into horizontal layers such as U\", \"I, data access, business logic, or breaking up the app into separate,\\nsmaller apps. Another strategy\", \" is to upgrade some or all of the app to different framework versions on\\nthe way to a recent .NET Co\", \"re release. One approach you could use is to migrate vertical slices of the\\napp, rather than attempt\", \"ing to migrate one horizontal layer at a time. Let's consider each of these\\ndifferent approaches.\\n\\nM\", \"igrating slice by slice\\n\\nOne successful approach to migrating is to identify vertical slices of func\", \"tionality and migrate them to\\nthe target platform one by one. The first step is to create a new ASP.\", \"NET Core 7 app. Next, identify the\\nindividual page or API endpoint that will be migrated first. Buil\", \"d out just the necessary functionality to\\nsupport this one route in the new ASP.NET Core app. Then u\", \"se HTTP rewriting and/or a reverse proxy\\nto start sending requests for these pages or endpoints to t\", \"he new app rather than the ASP.NET app.\\nThis approach is well-suited to API projects, but can also w\", \"ork for many MVC apps.\\n\\nWhen migrating slice by slice, the entire stack of the individual API endpoi\", \"nt or requested route is\\nrecreated in the new project or solution. The very first such slice typical\", \"ly requires the most effort,\\nsince it will typically need several projects to be created and decisio\", \"ns to be made about data access\\nand solution organization. Once the first slice\\u2019s functionality mirr\", \"ors the existing app\\u2019s, it can be\\ndeployed and the existing app can redirect to it or simply be remo\", \"ved. This approach is then repeated\\nuntil the entire app has been ported to the new structure.\\n\\nSome\", \" specific guidance on how to follow this strategy using IIS is covered in Chapter 5, Deployment\\nScen\", \"arios.\\n\\nMigrating layer by layer\\n\\nConsider the challenge of migrating a large ASP.NET 4.5 app. One a\", \"pproach is to migrate the entire\\napp directly from .NET Framework 4.5 to .NET 7. However, this appro\", \"ach needs to account for every\\nbreaking change between the two frameworks and versions, which are su\", \"bstantial. Performing this\\nwork on one project at a time provides a set of stepping stones so that t\", \"he entire solution doesn\\u2019t\\nneed to be moved at once.\\n\\nOne piece of the .NET ecosystem that helps wit\", \"h interoperability between different .NET frameworks is\\n.NET Standard. .NET Standard allows librarie\", \"s to build against an agreed upon set of common APIs,\\nensuring they can be used in any .NET app. .NE\", \"T Standard 2.0 is notable because it covers most base\\nclass library functionality used by most .NET \", \"Framework and .NET Core apps. Unfortunately, the\\nearliest version of .NET with support for .NET Stan\", \"dard 2.0 is .NET Framework 4.6.1, and there are a\\nnumber of updates in .NET Framework 4.8 that make \", \"it a compelling choice for initial upgrades.\\n\\nOne approach to incrementally upgrade a .NET Framework\", \" 4.5 system layer-by-layer is to first update\\nits class library dependencies to .NET Framework 4.8. \", \"Then, modify these libraries to be .NET Standard\\nclass libraries. Use multi-targeting and conditiona\", \"l compilation, if necessary. This step can be helpful\\n\\n6 CHAPTER 1 | Introduction to porting apps to\", \" .NET 7\\nin scenarios where app dependencies require .NET Framework and cannot easily be ported direc\", \"tly to\\nuse .NET Standard and .NET Core. Since .NET Framework libraries can be consumed by ASP.NET Co\", \"re\\n2.1 apps, the next step is to migrate some or all of the web functionality of the app to ASP.NET \", \"Core\\n2.1 (as described in the previous chapter). This is a \\u201cbottom up\\u201d approach, starting with low l\", \"evel class\\nlibrary dependencies and working up to the web app entry point.\\n\\nOnce the app is running \", \"on ASP.NET Core 2.1, migrating it to .NET 7 in isolation is relatively\\nstraightforward. The most lik\", \"ely challenge during this step is updating incompatible dependencies to\\nsupport .NET Core and possib\", \"ly higher versions of .NET Standard. For apps that don\\u2019t have\\nproblematic dependencies on .NET Frame\", \"work-only libraries, there's little reason to upgrade to\\nASP.NET Core 2.1. Porting directly to ASP.N\", \"ET Core 7 makes more sense and requires less effort.\\n\\n.NET 7 is the latest version of .NET and will \", \"be supported until six months after the next STS or LTS\\nrelease (scheduled for November 2023) - so m\", \"ost likely support will last at least until May 2024. Many\\nteams looking to migrate today will choos\", \"e to upgrade to .NET 7.\\n\\nInstead of a \\u201cbottom up\\u201d approach, another alternative is to start with the\", \" web app (or even the entire\\nsolution) and use an automated tool to assist with the upgrade. The .NE\", \"T Upgrade Assistant tool can\\nbe used to help upgrade .NET Framework apps to .NET Core / .NET 7. It a\", \"utomates many of the\\ncommon tasks related to upgrading apps, such as modifying project file format, \", \"setting appropriate\\ntarget frameworks, updating NuGet dependencies, and more.\\n\\nReferences\\n\\n\\u00b0 What is\", \" .NET Standard?\\n\\n: Migrate from ASP.NET Core 6.0 to 7.0\\n\\n: Announcing .NET 6 - The Fastest .NET Yet\\n\", \". Introducing .NET 5\\n\\n: Migrate from ASP.NET Core 3.1 to 6.0 LTS\\n: .NET Upgrade Assistant tool\\n\\nStra\", \"tegies for migrating ASP.NET Web Forms apps\\n\\nThis book offers guidance for migrating large ASP.NET M\", \"VC and Web API apps to .NET Core. Some of\\nthese ASP.NET apps may also include Web Forms (.aspx) page\", \"s that must be addressed. ASP.NET Web\\nForms isn\\u2019t supported in ASP.NET Core (nor are ASP.NET Web Pag\", \"es). Typically, the functionality of\\nthese pages must be rewritten when porting to ASP.NET Core. The\", \"re are, however, some strategies\\nyou can apply before or during such migration to help reduce the ov\", \"erall effort required.\\n\\nWeb Forms will continue to be supported for quite some time. One option may \", \"be to keep this\\nfunctionality in an ASP.NET 4.x app.\\n\\nSeparate business logic and other concerns\\n\\nTh\", \"e less code in your ASP.NET Web Forms pages, the better. When possible, keep business logic and\\nothe\", \"r concerns like data access in separate classes, ideally in separate class libraries. These class\\nli\", \"braries can be ported to .NET Standard and consumed by any ASP.NET Core app.\\n\\n7 CHAPTER 1 | Introduc\", \"tion to porting apps to .NET 7\\nImplement client behavior and web APIs\\n\\nConsider the choice between i\", \"mplementing logic in Web Forms or in the browser with the help of API\\ncalls. Favor the latter. Migra\", \"ting APls to ASP.NET Core is supported. Client-side behavior should be\\nindependent of the server-sid\", \"e stack your app Is using. Using this approach has the added benefit of\\nproviding a more responsive \", \"user experience.\\n\\nConsider Blazor\\n\\nBlazor lets you build interactive web Uls with C# instead of Java\", \"Script. It can run on the server or in\\nthe browser using WebAssembly. ASP.NET Web Forms apps may be \", \"ported page-by-page to Blazor\\napps. For more information on porting Web Forms apps to Blazor, see Bl\", \"azor for ASP.NET Web Forms\\nDevelopers. In addition, many Web Forms controls have been ported to Blaz\", \"or as part of an open-\\nsource community project, Blazor Web Forms Components. With these components,\", \" you can more\\neasily port Web Forms pages to Blazor even if they use the built-in Web Forms controls\", \".\\n\\nSummary\\n\\nMigrating directly from ASP.NET Web Forms to ASP.NET Core isn't supported. However, ther\", \"e are\\nstrategies to make moving to ASP.NET Core easier. You can migrate your Web Forms functionality\", \" to\\nASP.NET Core successfully by:\\n\\n. Keeping non-web functionality out of your projects.\\n. Using web\", \" APIs wherever possible.\\n\\n. Considering Blazor as an option for a more modern UI.\\n\\nReferences\\n\\n\\u00b0 Fre\", \"e e-book: Blazor for ASP.NET Web Forms Developers\\n\\u00b0 Blazor Web Forms Components (Community Project)\\n\", \"\\nDeployment strategies\\n\\nOne consideration as you plan the migration of your large ASP.NET app to ASP\", \".NET Core is how you'll\\ndeploy the new app. With ASP.NET, deployment options were limited to IIS on \", \"Windows. With\\nASP.NET Core, a much wider array of deployment options is available.\\n\\nCross-platform o\", \"ptions\\n\\nBecause .NET Core runs on Linux, you'll find some hosting options available that weren't a\\nc\", \"onsideration previously. Linux-based hosting may be preferable for the following reasons:\\n\\n\\u00b0 Your or\", \"ganization has infrastructure or expertise.\\n\\n. Hosting providers offer attractive features or pricin\", \"g for Linux-based hosting.\\n\\n.NET Core opens the door to these options.\\n\\n8 CHAPTER 1 | Introduction t\", \"o porting apps to .NET 7\\nCloud native development\\n\\nMost organizations today are using cloud platform\", \"s for at least some of their software capabilities.\\nWith an app migration to .NET Core, it's a good \", \"time to consider whether the app should be\\npurposefully written with cloud hosting in mind. Such clo\", \"ud native apps are better able to apply cloud\\ncapabilities like serverless, microservices, and can b\", \"e less concerned with the low-level details of how\\nand where they may be deployed.\\n\\nLearn more about\", \" cloud native app development in this free e-book, Architecting Cloud Native .NET\\nApplications for A\", \"zure.\\n\\nLeverage containers\\n\\nModern apps often leverage containers as a means of reducing variation b\", \"etween hosting\\nenvironments. By deploying an app to a particular container, the container-hosted app\", \" will run the\\nsame whether it\\u2019s running on a developer's laptop or in production. As part of a migra\", \"tion to .NET\\nCore, it may make sense to consider whether the app would benefit from deployment via c\", \"ontainer,\\neither as a full monolith or broken up into multiple smaller containerized apps.\\n\\nSide-by-\", \"side deployment options\\n\\nMigrating large .NET Framework apps to .NET Core often requires a substanti\", \"al effort. Most\\norganizations will want to be able to break this effort up in some fashion, so that \", \"pieces of the app\\ncan be migrated and deployed in production before the entire migration is complete\", \". Running both\\nthe original ASP.NET app and its newly-migrated ASP.NET Core sub-app(s) side by side \", \"is a frequently\\ncited goal. This can be achieved through a number of mechanisms including leveraging\", \" IIS routing,\\nwhich is covered in chapter 5. Other options include leveraging app gateways or cloud \", \"design\\npatterns like backends for frontends to manage sets of ASP.NET Web APIs and ASP.NET Core API\\n\", \"endpoints.\\n\\nIIS on Windows\\n\\nYou can continue hosting your apps on IIS running on Windows. This is a \", \"fine option for customers\\nwho want to take advantage of ASP.NET Core features without changing their\", \" current deployment\\nmodel. While moving to ASP.NET Core provides more options in terms of how and wh\", \"ere to deploy\\nyour apps, it doesn\\u2019t require that you change from the status quo of using the proven \", \"combination of\\nIIS on Windows.\\n\\nOther options on Windows\\n\\nYou can host apps side-by-side apps on Win\", \"dows using any combination of Kestrel, HTTP.sys, and IIS\\nhosts, in addition to Docker containers, if\", \" needed. If your app requires a combination of Windows and\\nLinux services, hosting on a Windows serv\", \"er with WSL and/or Linux Docker containers provides a\\nsingle server solution to hosting all parts of\", \" the app.\\n\\nReferences\\n\\n. Host and deploy ASP.NET Core\\n9 CHAPTER 1 | Introduction to porting apps to \", \".NET 7\\n\\u00b0 Host ASP.NET Core on Windows with IIS\\n\\u00b0 Troubleshooting ASP.NET Core on Azure App Service a\", \"nd IIS\\n\\nAdditional migration resources\\n\\nAs you're planning and executing your migration from ASP.NET\", \" MVC and/or Web API to ASP.NET\\nCore, there are a number of resources available to help beyond this b\", \"ook. Make a note of these and\\nleverage them where appropriate to help you overcome obstacles you enc\", \"ounter on your migration\\njourney.\\n\\nOfficial documentation\\n\\nThe official documentation website, learn\", \".microsoft.com, has the most up-to-date information\\navailable about versions, frameworks, breaking c\", \"hanges, and support options. You'll find many links in\\nthis book to docs articles, but for any probl\", \"em you're facing it\\u2019s often worth at least doing a quick\\nsearch of the docs to see if there is alrea\", \"dy information covering the issue and offering a solution or\\nworkaround.\\n\\nGitHub\\n\\nBecause .NET Core \", \"Is an open-source project, many issues are discovered, reported, discussed, and\\nfixed on GitHub. Mic\", \"rosoft has several GitHub organizations in which you'll find repositories that may\\nbe helpful. A par\", \"tial list of these organizations and some of their public repositories are listed below:\\n\\n. Microsof\", \"t\\n\\n- ASP.NET API Versioning\\n- dotnet\\n\\n\\u2014 ASP.NET Core\\n\\n- .NET Runtime\\n\\n- Entity Framework Core\\n- C# L\", \"anguage\\n- Docs\\n- Docs Samples\\n\\u2014 Try Convert\\n- .NET Upgrade Assistant tool\\n. .NET Architecture Refere\", \"nce Apps\\n\\u2014 eShopModernizing\\n- eShopOnWeb\\n- eShopOnContainers\\nIf you run into problems with your migr\", \"ation, these GitHub repositories are a good place to report\\n\\nthem. The product teams watch the issue\", \"s and typically respond quickly to bug reports (though \\u201chow\\nto\\u201d questions may be more appropriately \", \"directed to Stack Overflow).\\n\\n10 CHAPTER 1 | Introduction to porting apps to .NET 7\\nStack Overflow\\n\\n\", \"Stack Overflow has a wealth of information in the form of previous questions asked and answers\\ngiven\", \", with the most helpful answers listed first and marked if they solved the problem. In addition to\\ns\", \"earching for an existing solution to a problem you may encounter, you can of course also ask a\\nquest\", \"ion yourself and hope for some response from the .NET community. Don\\u2019t forget you can narrow\\ndown a \", \"search by using tags, and remember to use appropriate tags when you ask questions to\\nmaximize the ch\", \"ances of someone with the experience needed noticing your question.\\n\\nYouTube channels\\n\\nYouTube has a\", \" huge amount of .NET and .NET Core video content, which may include useful tutorials\\nor walkthroughs\", \" covering any scenario you may encounter. Consider searching it separately if your\\nother efforts to \", \"find help online come up short. Here are a few good places to get started:\\n\\n\\u00b0 dotnet\\n\\u00b0 Visual Studio\", \"\\n\\nTwitter, Gitter, Slack, and other community channels\\n\\nYou'll find many other ways to connect with \", \".NET developers on the .NET Community page. You can\\nalso join the DotNetEvolution Discord server. Ad\", \"ditionally, many product teams and team members\\nare on Twitter as well as in various other communiti\", \"es. You can follow and communicate with the\\nauthor of this book on Twitter as well.\\n\\nReferences\\n\\n: O\", \"verview of porting from .NET Framework to .NET Core\\n. .NET Upgrade Assistant tool\\n\\n\\u00b0 Migrate from AS\", \"P.NET to ASP.NET Core\\n\\n: .NET Community Resources\\n\\n11 CHAPTER 1 | Introduction to porting apps to .N\", \"ET 7\\nCHAPTER 2\\n\\nArchitectural differences\\nbetween ASP.NET MVC\\nana ASP.NET Core\\n\\nThere are many archi\", \"tectural differences between ASP.NET MVC on .NET Framework and ASP.NET\\nCore. It's important to have \", \"a broad understanding of these differences as teams evaluate the work\\ninvolved in porting their ASP.\", \"NET MVC apps to ASP.NET Core. This chapter looks at each of the ways\\nin which ASP.NET Core differs s\", \"ubstantially from ASP.NET MVC.\\n\\nBreaking changes\\n\\n.NET Core is a cross-platform rewrite of .NET Fram\", \"ework. There are many breaking changes between\\nthe two frameworks. The following sections identify s\", \"pecific differences between how ASP.NET MVC\\nand ASP.NET Core apps are designed and developed. Take c\", \"are to also examine the documentation to\\ndetermine which framework libraries you're using that may n\", \"eed to change. In many cases, a\\nreplacement NuGet package exists to fill in any gaps left between .N\", \"ET Framework and .NET Core. In\\nrare cases, you may need to find a third-party solution or implement \", \"new custom code to address\\nincompatibilities.\\n\\nApp startup differences between ASP.NET MVC and\\nASP.N\", \"ET Core\\n\\nASP.NET MVC apps lived entirely within Internet Information Server (IIS), the primary web s\", \"erver\\navailable on Windows operating systems. Unlike ASP.NET MVC, ASP.NET Core apps are executable\\na\", \"pps. You can run them from the command line, using dotnet run. They have an entry point method\\nlike \", \"all C# programs, typically public static void Main() or a similar variation (perhaps with arguments\\n\", \"or async support). This is perhaps the biggest architectural difference between ASP.NET Core and\\nASP\", \".NET MVC, and is one of several differences that allows ASP.NET Core to run on non-Windows\\nsystems.\\n\", \"\\n12 CHAPTER 2 | Architectural differences between ASP.NET MVC and ASP.NET Core\\nASP.NET MVC Startup\\n\\n\", \"Hosted within IIS, ASP.NET apps rely on IIS to instantiate certain objects and call certain methods\\n\", \"when a request arrives. ASP.NET creates an instance of the Global.asax file's class, which derives f\", \"rom\\nHttpApplication. When the first request is received, before handling the request itself, ASP.NET\", \" calls\\nthe Application_Start method in the Global.asax file's class. Any logic that needs to run whe\", \"n the\\nASP.NET MVC app begins can be added to this method.\\n\\nMany NuGet packages for ASP.NET MVC and W\", \"eb API use the WebActivator package to let them run\\nsome code during app startup. By convention, thi\", \"s code would typically be added to an App _Start\\nfolder and would be configured via attribute to run\", \" either immediately before or just after\\nApplication_Start.\\n\\nIt's also possible to use the Open Web \", \"Interface for .NET (OWIN) and Project Katana with ASP.NET\\nMVC. When doing so, the app will include a\", \" Startup.cs file that is responsible for setting up request\\n\\nmiddleware in a way that's very similar\", \" to how ASP.NET Core behaves.\\n\\nIf you need to run code when your ASP.NET MVC app starts up, it will \", \"typically use one of these\\napproaches.\\n\\nASP.NET Core Startup\\n\\nAs noted previously, ASP.NET Core apps\", \" are standalone programs. As such, they typically include a\\nProgram.cs file containing the entry poi\", \"nt for the app. A typical example of this file is shown in Figure\\n2-1. Notice that in .NET 7, this f\", \"ile is streamlined by the use of implicit using statements and top-level\\nstatements, eliminating the\", \" need for a lot of \\u201cboiler plate\\u201d code.\\n\\nvar builder = WebApplication.CreateBuilder(args) ;\\n\\n// Add \", \"services to the container.\\nbuilder.Services.AddRazorPages() ;\\n\\nvar app = builder.Build();\\n\\n// Config\", \"ure the HTTP request pipeline.\\nif (!app.Environment.IsDevelopment() )\\n\\napp.UseExceptionHandler(\\\"/Err\", \"or\\\" ) ;\\n\\n// The default HSTS value is 30 days. You may want to change this for production\\nscenarios,\", \" see https://aka.ms/aspnetcore-hsts.\\n\\napp.UseHsts();\\n\\n}\\n\\nUseHttpsRedirection() ;\\nUseStaticFiles();\\n\\n\", \".UseRouting();\\n.UseAuthorization() ;\\n\\n.MapRazorPages() ;\\n\\n.Run();\\nFigure 2-7. A typical ASP.NET Core\", \" Program.cs file.\\n\\n13 CHAPTER 2 | Architectural differences between ASP.NET MVC and ASP.NET Core\\nThe\", \" code shown in Figure 2-1 uses a builder to configure the host and its services. Then, it creates th\", \"e\\nrequest pipeline for the app, which controls how every request to the app is handled.\\n\\nPrevious ve\", \"rsions of .NET would use a separate Startup.cs file, referenced by Program.cs. This approach\\nis stil\", \"l supported in .NET 7, but is no longer the default approach.\\n\\nIn addition to code related to config\", \"uring the app\\u2019s services and request pipeline, apps may have\\nother code that must run when the app b\", \"egins. Such code Is typically placed in Program.cs or\\nregistered as an IHostedService, which will be\", \" started by the generic host when the app starts.\\n\\nThe IHostedService interface just exposes two met\", \"hods, StartAsync and StopAsync. You register the\\ninterface when configuring the app\\u2019s services and t\", \"he host does the rest, calling the StartAsync\\nmethod before the app starts up.\\n\\nPorting consideratio\", \"ns\\n\\nTeams looking to migrate their apps from ASP.NET MVC to ASP.NET Core need to identify what code\\n\", \"is being run when their app starts up and determine the appropriate location for such code in their\\n\", \"ASP.NET Core app. For custom code needed to run when the app starts up, especially async code, the\\nr\", \"ecommended approach is typically to put such code into IHostedService implementations.\\n\\nReferences\\n\\n\", \": ASP.NET Application Life Cycle Overview for IIS 7\\n\\n. ASP.NET Application Life Cycle Overview for I\", \"IS 5 and 6\\n. Getting Started with OWIN and Katana\\n\\n: WebActivator\\n\\n: App Startup in ASP.NET Core\\n\\n. \", \".NET Generic Host in ASP.NET Core\\n\\n\\u00b0 lHostedService\\n\\nHosting differences between ASP.NET MVC and\\nASP\", \".NET Core\\n\\nASP.NET MVC apps are hosted in IIS, and may rely on IIS configuration for their behavior.\", \" This often\\nincludes IIS modules. As part of reviewing an app to prepare to port it from ASP.NET MVC\", \" to ASP.NET\\nCore, teams should identify which modules, if any, they're using from the list of IIS Mo\", \"dules installed\\non their server.\\n\\nASP.NET Core apps can run on a number of different servers. The de\", \"fault cross platform server,\\nKestrel, is a good default choice. Apps running in Kestrel can be hoste\", \"d by IIS, running in a separate\\nprocess. On Windows, apps can also run in process on IIS or using HT\", \"TP.sys. Kestrel is generally\\nrecommended for best performance. HTTP.sys can be used in scenarios whe\", \"re the app is exposed to\\nthe Internet and required capabilities are supported by HTTP.sys but not Ke\", \"strel.\\n\\n14 CHAPTER 2 | Architectural differences between ASP.NET MVC and ASP.NET Core\\nKestrel does n\", \"ot have an equivalent to IIS modules (though apps hosted in IIS can still take advantage\\nof IIS modu\", \"les). To achieve equivalent behavior, middleware configured in the ASP.NET Core app itself\\nis typica\", \"lly used.\\n\\nReferences\\n\\n\\u00b0 IIS Modules\\n\\u00b0 ASP.NET Core Middleware\\n\\u00b0 ASP.NET Core Servers\\n\\nServe static \", \"files in ASP.NET MVC and ASP.NET Core\\n\\nMost web apps involve a combination of server-side logic and \", \"static files that must be sent to the\\nclient as-is. How should your migration from ASP.NET MVC to AS\", \"P.NET Core handle serving static\\nfiles?\\n\\nHost static files in ASP.NET MVC\\n\\nASP.NET MVC apps, hosted \", \"by IIS, typically host static files directly from the app. ASP.NET MVC\\nsupports placing static files\", \" side by side with files that should be kept private on the server. IIS and\\nASP.NET require explicit\", \"ly restricting certain files or file extensions from being served from the folder\\nin which an ASP.NE\", \"T app is hosted.\\n\\nFor many static files, using a content delivery network (CDN) is a good practice. \", \"Static content hosting\\nallows better performance while reducing load and bandwidth from app servers.\", \"\\n\\nHost static files in ASP.NET Core\\n\\nIt may be surprising, but ASP.NET Core doesn't have built-in su\", \"pport for static files. This feature that\\nhas always existed as just a part of ASP.NET, enabled by I\", \"IS, isn't intrinsic to ASP.NET Core or its\\nKestrel web server. To serve static files from an ASP.NET\", \" Core app, you must configure static files\\nmiddleware.\\n\\nWith static files middleware configured, an \", \"ASP.NET Core app will serve all files located in a certain\\nfolder (typically Avwwroot). No other fil\", \"es in the app or project folder are at risk of being accidentally\\nexposed by the server. No special \", \"restrictions based on file names or extensions need to be\\nconfigured, as is the case with IIS. Inste\", \"ad, developers explicitly choose to expose files publicly when\\nthey place them in the wwwroot folder\", \". By default, files outside of this folder aren't shared.\\n\\nBecause support for static files uses mid\", \"dleware, any other middleware can be applied as part of the\\nsame request pipeline. Examples of middl\", \"eware include authentication, caching, and compression.\\n\\nOf course, CDNs remain a good choice for AS\", \"P.NET Core apps for all the same reasons they're used in\\nASP.NET MVC apps. As part of preparing to m\", \"igrate to .NET Core, if there are benefits your app could\\nrealize from using a CDN, it would be good\", \" to move static files to a CDN before migrating to .NET\\nCore. Doing so reduces the migration effort\\u2019\", \"s overall scope for static assets.\\n\\n15 CHAPTER 2 | Architectural differences between ASP.NET MVC and\", \" ASP.NET Core\\nReferences\\n\\n\\u00b0 Static content hosting\\n\\u00b0 Static files in ASP.NET Core\\n\\nDependency inject\", \"ion differences between ASP.NET\\nMVC and ASP.NET Core\\n\\nAlthough dependency injection (Dl) isn\\u2019t built\", \" into ASP.NET MVC or Web API, many apps enable it by\\nadding a NuGet package with an inversion of con\", \"trol (IOC) container. These are sometimes referred to\\nas DI containers, for dependency injection (or\", \" inversion). Some of the most popular containers used in\\nASP.NET MVC apps include:\\n\\n\\u00b0 Autofac\\n\\n\\u00b0 Uni\", \"ty\\n\\u00b0 Ninject\\n\\n\\u00b0 StructureMap (deprecated)\\n\\u00b0 Castle Windsor\\n\\nIf your ASP.NET MVC app isn\\u2019t using DI, \", \"you will probably want to investigate the built-in support for\\nDI in ASP.NET Core. DI promotes loose\", \" coupling of modules in your app and enables better testability\\nand adherence to principles like SOL\", \"ID.\\n\\nIf your app does use DI, then probably your best course of action Is to see if the container yo\", \"u're\\nusing supports ASP.NET Core. If so, you may be able to continue using it and your custom\\nconfig\", \"uration rules describing your type mappings and lifetimes.\\n\\nEither way, you should consider using th\", \"e built-in support for DI that ships with ASP.NET Core, as it\\nmay meet your app\\u2019s needs.\\n\\nDependency\", \" injection in ASP.NET Core\\n\\nASP.NET Core assumes apps will use DI. It's not just built into the fram\", \"ework, but is required in order\\nto bring support for framework features into your ASP.NET Core apps.\", \" In app startup, calls are made\\nto configure services using the builder.Services property of the web\", \" host builder. This property works\\nwith the application's DI container (service collection/service p\", \"rovider) and is used to create and inject\\nservice dependencies within the app. Built-in ASP.NET Core\", \" features like Entity Framework Core,\\nIdentity, and even MVC are brought into the app by configuring\", \" them as services during application\\nstartup.\\n\\nIn addition to using the default implementation, apps\", \" can still use custom containers. The\\ndocumentation covers how to replace the default service contai\", \"ner.\\n\\nDI is fundamental to ASP.NET Core. If your team isn't already well-versed in this practice, yo\", \"u'll want\\nto understand it before porting your app.\\n\\n16 CHAPTER 2 | Architectural differences betwee\", \"n ASP.NET MVC and ASP.NET Core\\nReferences\\n\\n\\u00b0 Dependency Injection in .NET\\n\\u00b0 Dependency Injection in \", \"ASP.NET Core\\n\\nCompare middleware to modules and handlers\\n\\nIf your existing ASP.NET MVC or Web API ap\", \"p uses OWIN/Katana, you're most likely already familiar\\nwith the concept of middleware and porting i\", \"t to ASP.NET Core should be fairly straightforward.\\nHowever, most ASP.NET apps rely on HTTP modules \", \"and HTTP handlers instead of middleware.\\nMigrating these to ASP.NET Core requires extra effort.\\n\\nASP\", \".NET modules and handlers\\n\\nHTTP modules and HTTP handlers are an integral part of the ASP.NET archit\", \"ecture. While a request is\\nbeing processed, each request is processed by multiple HTTP modules (for \", \"example, the\\nauthentication module and the session module) and is then processed by a single HTTP ha\", \"ndler. After\\nthe handler has processed the request, the request flows back through the HTTP modules.\", \"\\n\\nIf your app is using custom HTTP modules or HTTP handlers, you'll need a plan to migrate them to\\nA\", \"SP.NET Core. The most likely replacement in ASP.NET Core is middleware.\\n\\nASP.NET Core middleware\\n\\nAS\", \"P.NET Core defines a request pipeline in each app\\u2019s Configure method. This request pipeline\\ndefines \", \"how an incoming request is handled by the app, with each method in the pipeline calling the\\nnext met\", \"hod until eventually a method terminates, and the chain of middleware terminates and\\nreturns back up\", \" the stack. Middleware can target all requests, or can be configured to only map to\\ncertain requests\", \" based on the requested path or other factors. It can be configured wholly in the\\nConfigure method o\", \"f an app, or implemented in a separate class.\\n\\nBehavior in an ASP.NET MVC app that uses HTTP modules\", \" is probably best suited to custom\\nmiddleware. Custom HTTP handlers can be replaced with custom rout\", \"es or endpoints that respond to\\nthe same path.\\n\\nAccessing HttpContext\\n\\nMany .NET apps reference the \", \"current request\\u2019s context through HttpContext.Current. This static\\naccess can be a common source of \", \"problems with testing and other code usage outside of individual\\nrequests. When building ASP.NET Cor\", \"e apps, access to the current HttpContext should be provided as\\na method parameter on middleware, as\", \" this sample demonstrates:\\n\\npublic class Middleware\\n\\nt\\n\\nprivate readonly RequestDelegate _next;\\n\\npub\", \"lic Middleware(RequestDelegate next)\\n{\\n\\n_next = next;\\n\\n17 CHAPTER 2 | Architectural differences betw\", \"een ASP.NET MVC and ASP.NET Core\\n}\\n\\npublic Task Invoke(HttpContext httpContext)\\n\\n{\\nreturn _next(http\", \"Context) ;\\n\\n}\\n\\nSimilarly, ASP.NET Core filters pass a context argument to their methods, from which \", \"the current\\nHttpContext can be accessed:\\n\\npublic class MyActionFilterAttribute : ActionFilterAttribu\", \"te\\n{\\n\\npublic override void OnResultExecuting(ResultExecutingContext context)\\n\\nt\\n\\nvar headers = conte\", \"xt.HttpContext.Request.Headers;\\n// do something based on a header\\n\\nbase.OnResultExecuting (context) \", \";\\n\\nIf you have components or services that require access to HttpContext, rather than using a static\", \" call\\nlike HttoContext.Current you should instead use constructor dependency injection and the\\n\\n[Htt\", \"poContextAccessor interface:\\npublic class MyService\\n{\\nprivate readonly IHttpContextAccessor _httpCon\", \"textAccessor ;\\n\\npublic MyService(IHttpContextAccessor httpContextAccessor )\\n\\n_httpContextAccessor = \", \"httpContextAccessor;\\n\\n}\\n\\npublic void DoSomething( )\\nt\\n\\n}\\n\\nvar currentContext = _httpContextAccessor.\", \"HttpContext;\\n\\nThis approach eliminates the static coupling of the method to the current context whil\", \"e providing\\naccess in a testable fashion.\\n\\nReferences\\n\\n\\u00b0 ASP.NET HTTP modules and HTTP handlers\\n\\u00b0 AS\", \"P.NET Core middleware\\n\\nConfiguration differences between ASP.NET MVC\\nand ASP.NET Core\\n\\nHow configura\", \"tion values are stored and read changed dramatically between ASP.NET and ASP.NET\\nCore.\\n\\n18 CHAPTER 2\", \" | Architectural differences between ASP.NET MVC and ASP.NET Core\\nASP.NET MVC configuration\\n\\nIn ASP.\", \"NET apps, configuration uses the built-in .NET configuration files, web.config in the app folder\\nand\", \" machine.config on the server. Most ASP.NET MVC and Web API apps store their settings in the\\nconfigu\", \"ration file's appSettings or connectionStrings elements. Some also use custom configuration\\nsections\", \" that can be mapped to a settings class.\\n\\nConfiguration in a .NET Framework app is accessed using th\", \"e\\nSystem.Configuration.ConfigurationManager class. Unfortunately, this class provides static access \", \"to\\nthe configuration elements. As a result, very few ASP.NET MVC apps tend to abstract access to the\", \"ir\\nconfiguration settings or inject them where needed. Instead, most .NET Framework apps tend to\\ndir\", \"ectly access the configuration system anywhere the app needs to use a setting.\\n\\nTypical ASP.NET MVC \", \"configuration access:\\n\\nstring connectionString =\\n\\nConfigurationManager .ConnectionStrings|[ \\\"Default\", \"Connection\\\" |\\n.ConnectionString;\\n\\nASP.NET Core configuration\\n\\nIn ASP.NET Core apps, configuration is\", \", itself, configurable. However, most apps use a set of defaults\\nprovided as part of the standard pr\", \"oject templates and the ConfigureWebHostDefaults method used\\nin them. The default settings use JSON \", \"formatted files, with the ability to override settings in the base\\nappsettings.json file with enviro\", \"nment-specific files like appsettings. Development.json. Additionally, the\\ndefault configuration sys\", \"tem further overrides all file-based settings with any environment variable\\nthat exists for the same\", \" named setting. This is useful in many scenarios and is especially useful when\\ndeploying to a hostin\", \"g environment, since it eliminates the need to worry about whether deploying\\nconfiguration files wil\", \"l accidentally overwrite important production configuration settings.\\nConfiguration values can also \", \"be provided as command line arguments.\\n\\nAccessing configuration values can be done in many ways in .\", \"NET Core. Because dependency injection\\nis built into .NET Core, configuration values are generally a\", \"ccessed through an interface that is\\ninjected into classes that need them. This can involve passing \", \"a interface like |Configuration, but\\nusually it\\u2019s better to pass just the settings required by the c\", \"lass using the options pattern.\\n\\nFigure 2-2 shows how to pass IConfiguration into a Razor Page and a\", \"ccess configuration settings from\\nit:\\n\\nusing Microsoft.Extensions.Configuration;\\n\\npublic class TestM\", \"odel : PageModel\\n\\n{\\n\\nprivate readonly IConfiguration _configuration;\\n\\npublic TestModel(IConfiguratio\", \"n configuration)\\n\\n{\\n_configuration= configuration;\\n}\\npublic ContentResult OnGet()\\n{\\n\\n19 CHAPTER 2 | \", \"Architectural differences between ASP.NET MVC and ASP.NET Core\\nvar myKeyValue = _configuration[\\\"MyKe\", \"y\\\" ] ;\\n\\nFigure 2-2. Accessing configuration values with Configuration.\\n\\nUsing the options pattern, s\", \"ettings access Is similar but is strongly typed and more specific to the\\nsetting(s) needed by the co\", \"nsuming class, as Figure 2-3 demonstrates.\\n\\npublic class PositionOptions\\n\\nt\\n\\npublic const string Pos\", \"ition = nameof(Position) ;\\n\\npublic string Title { get; set; }\\npublic string Name { get; set; }\\n}\\npub\", \"lic class Test2Model : PageModel\\n{\\n\\nprivate readonly PositionOptions _options;\\n\\npublic Test2Model(IO\", \"ptions<PositionOptions> options)\\naf\\n\\n}\\n\\npublic ContentResult OnGet()\\n{\\n\\n}\\n\\n_options = options.Value;\", \"\\n\\nreturn Content($\\\"Title: {_options.Title}\\\\nName: {_options.Name}\\\") ;\\n\\nFigure 2-3. Using the options\", \" pattern in ASP.NET Core.\\n\\nFor the options pattern to work, the options type must be configured in C\", \"onfigureServices when the\\napp starts up:\\n\\nMigrate configuration\\n\\nWhen considering how to port an app\", \"\\u2019s configuration settings from .NET Framework to .NET Core, the\\nfirst step is to identify all of the\", \" configuration settings that are being used. Most of these will be in the\\nweb.config file in the app\", \"\\u2019s root folder, but some apps expect settings to be found in the shared\\nmachine.config file as well.\", \" These settings will include elements of the appSettings element, the\\nconnectionStrings element, and\", \" any custom configuration elements as well. In .NET Core, all of these\\nsettings are typically stored\", \" in the appsettings.json file.\\n\\nOnce all settings in the config files have been cataloged, the next \", \"step should be to identify where\\nand how the settings are used in the app itself. If some settings a\", \"ren't being used, these can probably\\nbe omitted from the migration. For each setting, note all of th\", \"e places it's being used so you can be\\nsure you don\\u2019t miss any when you migrate the code.\\n\\n20 CHAPTE\", \"R 2 | Architectural differences between ASP.NET MVC and ASP.NET Core\\nIf you're still maintaining the\", \" ASP.NET app, it may be helpful to avoid static references to\\nConfigurationManager and replace them \", \"with access through interfaces. This will ease the transition\\nto ASP.NET Core\\u2019s configuration system\", \". In general, static access to external resources makes code\\nharder to test and maintain, so be on t\", \"he lookout for anywhere else the app may be following this\\npattern.\\n\\nReferences\\n\\n: Configuration in \", \"ASP.NET Core\\n\\n. Options pattern in ASP.NET Core\\n\\n. Migrate configuration to ASP.NET Core\\n. Refactori\", \"ng Static Config Access\\n\\nRouting differences between ASP.NET MVC and\\nASP.NET Core\\n\\nRouting is respon\", \"sible for mapping incoming browser requests to particular controller actions (or\\nRazor Pages handler\", \"s). This section covers how routing differs between ASP.NET MVC (and Web API)\\nand ASP.NET Core (MVC,\", \" Razor Pages, and otherwise).\\n\\nRouting in ASP.NET MVC and Web API\\nASP.NET MVC offers two approaches \", \"to routing:\\n\\n1. The route table, which is a collection of routes that can be used to match incoming \", \"requests\\nto controller actions.\\n\\n2. Attribute routing, which performs the same function but is achie\", \"ved by decorating the actions\\nthemselves, rather than editing a global route table.\\n\\nRoute table\\n\\nTh\", \"e route table is configured when the app starts up. Typically, a static method call is used to\\nconfi\", \"gure the global route collection, like so:\\n\\npublic class MvcApplication : System.Web.HttpApplication\", \"\\n\\npublic static void RegisterRoutes(RouteCollection routes)\\n\\n{\\nroutes. IgnoreRoute(\\\"{resource}.axd/{\", \"*pathInfo}\\\") ;\\nroutes .MapRoute(\\nname: \\\"Default\\\",\\nurl: \\\"{controller}/{action}/{id}\\\",\\ndefaults: new {\", \" controller = \\\"Home\\\", action = \\\"Index\\\", id = \\\"\\\" },\\nconstraints: new { id = \\\"\\\\\\\\d+\\\" }\\n)3\\n}\\n\\nprotected \", \"void Application Start()\\n{\\n\\n21 CHAPTER 2 | Architectural differences between ASP.NET MVC and ASP.NET\", \" Core\\nRegisterRoutes(RouteTable. Routes) ;\\n\\nIn the preceding code, the route table is managed by the\", \" RouteCollection type, which is used to add\\nnew routes with MapRoute. Routes are named and include a\", \" route string, which can include\\nparameters for controllers, actions, areas, and other placeholders.\", \" If an app follows a standard\\nconvention, most of its actions can be handled by this single default \", \"route, with any exceptions to this\\nconvention configured using additional routes.\\n\\nAttribute routing\", \" in ASP.NET MVC\\n\\nRoutes that are defined with their actions may be easier to discover and reason abo\", \"ut than routes\\ndefined in an external location. Using attribute routing, an individual action method\", \" can have its route\\ndefined with a [Route] attribute:\\n\\npublic class ProductsController\\n\\n{\\n[Route(\\\"pr\", \"oducts\\\") ]\\n\\npublic ActionResult Index()\\n{\\n\\n}\\n\\nreturn View();\\n\\n[Route(\\\"products/{id}\\\") ]\\npublic Actio\", \"nResult Details(int id)\\n{\\n\\n}\\n\\nreturn View();\\n\\nAttribute routing in ASP.NET MVC 5 also supports defau\", \"lts and prefixes, which can be added at the\\ncontroller level (and which are applied to all actions w\", \"ithin that controller). Refer to the\\ndocumentation for details.\\n\\nSetting up attribute routing requir\", \"es adding one line to the default route table configuration:\\n\\nroutes .MapMvcAttributeRoutes() ;\\n\\nAtt\", \"ribute routing can take advantage of route constraints, both built-in and custom, and supports\\nnamed\", \" routes and areas using the [RouteArea] attribute. If your app uses areas, you'll need to\\nconfigure \", \"support for them in your route registration code by adding one more line:\\n\\nroutes .MapMvcAttributeRo\", \"utes() ;\\nAreaRegistration.RegisterAllAreas() ;\\n\\nAttribute routing in ASP.NET Web API 2\\n\\nAttribute ro\", \"uting in ASP.NET Web API 2 is similar to routing in ASP.NET MVC 5, with minor differences.\\nConfiguri\", \"ng Web API 2 is typically done in its own class, which is called during app startup. Attribute\\nrouti\", \"ng configuration is handled in this class:\\n\\npublic static class WebApiConfig\\n| t |\\n\\n22 CHAPTER 2 | A\", \"rchitectural differences between ASP.NET MVC and ASP.NET Core\\npublic static void Register(HttpConfig\", \"uration config)\\n{\\n\\n// Attribute routing.\\n\\nconfig .MapHttpAttributeRoutes ( ) ;\\n\\n// Convention-based \", \"routing.\\n\\nconfig .Routes.MapHttpRoute (\\nname: \\\"DefaultApi\\\",\\nrouteTemplate: \\\"api/{controller}/{id}\\\",\\n\", \"defaults: new { id = RouteParameter.Optional }\\n\\n);\\n\\nAs shown in the preceding code, attribute routin\", \"g may be combined with convention-based routing\\nin Web API apps.\\n\\nIn addition to attribute routing, \", \"ASP.NET Web API chooses which action to call based on the HTTP\\nmethod (for example, GET or POST), th\", \"e {action} placeholder in a route (if any), and parameters of the\\naction. In many cases, the name of\", \" the action will help determine whether it's matched, since prefixing\\nthe action name with \\u201cGet\\\" or \", \"\\u201cPost\\u201d is used to match the appropriate HTTP method to it.\\nAlternatively, actions can be decorated w\", \"ith an appropriate HTTP method attribute, like [HttpGet],\\nallowing the use of action names that aren\", \"'t prefixed with an HTTP method.\\n\\npublic class ProductsController : ApiController\\n\\n{\\n\\n// matched by \", \"name and (lack of) parameters\\npublic IEnumerable<Product> GetAll() { }\\n\\n// matched by GET and string\", \" parameter\\n[HttpGet ]\\npublic IEnumerable<Product> FindProductsByName(string name) { }\\n\\nGiven the abo\", \"ve controller, an HTTP GET request to localhost:123/products/ matches the GetAll\\naction. An HTTP GET\", \" request to localhost:123/products?name=ardalis matches the\\nFindProductsByName action.\\n\\nRouting in .\", \"NET 7\\n\\nIn ASP.NET Core, routing is handled by routing middleware, which matches the URLs of incoming\", \"\\nrequests to actions or other endpoints. Controller actions are either conventionally routed or\\nattr\", \"ibute-routed. Conventional routing is similar to the route table approach used in ASP.NET MVC\\nand We\", \"b API. Whether you're using conventional, attribute, or both, you need to configure your app\\nto use \", \"the routing middleware. To use the middleware, add the following code to your Program.cs file:\\n\\napp.\", \"UseRouting() ;\\n\\nConventional routing\\n\\nWith conventional routing, you set up one or more conventions \", \"that will be used to match incoming\\nURLs to endpoints in the app. In ASP.NET Core, these endpoints m\", \"ay be controller actions, like in\\nASP.NET MVC or Web API. The endpoints could also be Razor Pages, H\", \"ealth Checks, or SignalR hubs.\\nAll of these routable features are configured in a similar fashion us\", \"ing endpoints:\\n\\n23 CHAPTER 2 | Architectural differences between ASP.NET MVC and ASP.NET Core\\napp.Us\", \"eEndpoints(endpoints =>\\n\\nendpoints .MapHealthChecks(\\\"/healthz\\\") .RequireAuthorization() ;\\nendpoints \", \".MapControllerRoute(\\n\\nname: \\\"default\\\",\\npattern: \\\"{controller=Home}/{action=Index}/{id?}\\\") ;\\n\\nendpoin\", \"ts.MapRazorPages() ;\\n\\nThe preceding code is used (in addition to UseRouting) to configure various en\", \"dpoints, including\\nHealth Checks, controllers, and Razor Pages. For controllers, the above configura\", \"tion specifies a\\ndefault routing convention, which is the fairly standard {controller}/{action}/{id?\", \"} pattern that\\u2019s been\\nrecommended since the first versions of ASP.NET MVC.\\n\\nAttribute routing\\n\\nAttri\", \"bute routing in ASP.NET Core is the preferred approach for configuring routing in controllers. If\\nyo\", \"u're building APls, the [ApiController] attribute should be applied to your controllers. Among other\", \"\\nthings, this attribute requires the use of attribute routing for actions in such controller classes\", \".\\n\\nAttribute routing in ASP.NET Core behaves similarly in ASP.NET MVC and Web API. In addition to\\nsu\", \"pporting the [Route] attribute, however, route information can also be specified as part of the HTTP\", \"\\nmethod attribute:\\n\\n[HttpGet(\\\"api/products/{id}\\\") |\\npublic async ActionResult<Product> Details(int i\", \"d)\\n\\nt\\n\\n}\\n\\nHi coc\\n\\nAs with previous versions, you can specify a default route with placeholders, and \", \"add this at the\\ncontroller class level or even on a base class. You use the same [Route] attribute f\", \"or all of these cases.\\nFor example, a base API controller class might look like this:\\n\\n[Route(\\\"api/{\", \"controller}/{action}/{id?:int}\\\") ]\\npublic abstract class BaseApiController : ControllerBase, IApiCon\", \"troller\\n\\nt\\n}\\n\\nHi coc\\n\\nUsing this attribute, classes inheriting from this type would route URLs to ac\", \"tions based on the\\ncontroller name, action name, and an optional integer id parameter.\\n\\nReferences\\n\\n\", \"24\\n\\nASP.NET MVC Routing Overview\\n\\nAttribute Routing in ASP.NET MVC 5\\n\\nAttribute routing in ASP.NET W\", \"eb API 2\\n\\nRouting and Action Selection in ASP.NET Web API\\nRouting in ASP.NET Core\\n\\nRouting to contro\", \"ller actions in ASP.NET Core MVC\\n\\nCHAPTER 2 | Architectural differences between ASP.NET MVC and ASP.\", \"NET Core\\nLogging differences between ASP.NET MVC and\\nASP.NET Core\\n\\nApplication logging provides impo\", \"rtant diagnostic information, especially for apps running in\\nproduction. ASP.NET Core introduces a n\", \"ew system for adding standardized logging to any app.\\nExisting ASP.NET MVC and Web API apps most lik\", \"ely use third-party logging solutions, which likely\\ncontinue to be supported on ASP.NET Core.\\n\\nASP.N\", \"ET MVC logging\\n\\nThere's no built-in logging solution in ASP.NET MVC and Web API apps. Instead, most \", \"apps use third-\\nparty logging solutions like log4net, NLog, or Serilog. Many teams also choose to ro\", \"ll their own\\nlogging solution. Logging frameworks typically support multiple \\u201csinks\\u201d (or targets or \", \"appenders) for\\nlog output, such as text files, databases, or even emails. They use configuration to \", \"determine which\\nlevels of log messages from which parts of the system are routed to different sinks.\", \" When considering\\nhow to migrate an app\\u2019s logging to .NET Core, review how logging is performed and \", \"configured in the\\n\\nASP.NET Core logging\\n\\nIn ASP.NET Core, logging is a built-in feature that can be \", \"configured and extended when the app\\nstarts up. Third-party loggers, including those mentioned above\", \", can be integrated with ASP.NET Core\\nto enhance its functionality.\\n\\nASP.NET Core logging uses categ\", \"ories and levels to control what is logged and how. Classes typically\\nuse instances of the ILogger<T\", \"> interface, with the class's type used as the generic T type. In this\\nscenario, the class's fully q\", \"ualified name is used as the category. Loggers can also be created with a\\ncustom category using an I\", \"LoggerFactory. Log levels range from the most detailed, Trace, to the most\\nimportant, Critical. Usin\", \"g configuration, apps can specify what minimum level of logging should be\\nincluded on a per-category\", \" (with wildcards) basis.\\n\\nA typical logging configuration could log Information and above informatio\", \"n by default, but only\\nWarning or above from Microsoft-prefixed categories:\\n\\n{\\n\\\"Logging\\\": {\\n\\u201cLoglLev\", \"el\\\": {\\n\\\"Default\\\": \\\"Information\\\",\\n\\n\\\"Microsoft\\\": \\\"Warning\\\"\\n\\nSupport for logging in ASP.NET Core is ext\", \"ensive and flexible. For more detailed information, refer to\\nthe docs.\\n\\n25 CHAPTER 2 | Architectural\", \" differences between ASP.NET MVC and ASP.NET Core\\nMigrate logging\\n\\nHow you migrate your .NET Framewo\", \"rk app\\u2019s logging to .NET Core depends on how the app is\\nlogging now. If it's using a third-party NuG\", \"et package, refer to the upgrade documentation for that\\npackage. Most likely the upgrade path will b\", \"e fairly straightforward. If you're using your own logging\\nsolution, take one of the following actio\", \"ns:\\n\\n1. Migrate the logging solution yourself\\n2. Migrate to a third-party logging solution\\n3. | Use \", \"the built-in logging support in ASP.NET Core\\n\\nYou can reference the Microsoft.Extensions.Logging pac\", \"kage from .NET Framework apps as long as\\nthey're using NuGet 4.3 or later and are on .NET Framework \", \"4.6.1 or later. Once your app has\\nreferenced this package, you can convert your logging statements t\", \"o use the new extensions before\\nmigrating the app to .NET Core. This can provide a stepping stone to\", \"ward full migration, since the app\\ncan continue running on .NET Framework while logging using the ne\", \"wer extensions package.\\n\\nReferences\\n\\n\\u00b0 Logging in .NET Core and ASP.NET Core\\n\\u00b0 Microsoft.Extensions.\", \"Logging NuGet Package\\n\\nCompare Razor Pages to ASP.NET MVC\\n\\nRazor Pages Is the preferred way to creat\", \"e page- or form-based apps in ASP.NET Core. From the docs,\\n\\u201cRazor Pages can make coding page-focused\", \" scenarios easier and more productive than using\\ncontrollers and views.\\u201d If your ASP.NET MVC app mak\", \"es heavy use of views, you may want to consider\\nmigrating from actions and views to Razor Pages.\\n\\nA \", \"typical strongly typed view-based MVC app will use a controller to contain one or more actions. The\\n\", \"controller will interact with the domain or data model, and create an instance of a viewmodel class.\", \"\\nThen this viewmodel class is passed to the view associated with that action. Using this approach,\\nc\", \"oupled with the default folder structure of MVC apps, to add a new page to an app requires\\nmodifying\", \" a controller in one folder, a view in a nested subfolder in another folder, and a viewmodel\\nin yet \", \"another folder.\\n\\nRazor Pages group together the action (now a handler) and the viewmodel (called a P\", \"ageModel) in\\none class, and link this class to the view (called a Razor Page). All Razor Pages go in\", \"to a Pages folder in\\nthe root of the ASP.NET Core project. Razor Pages use a routing convention base\", \"d on their name and\\nlocation within this folder. Handlers behave exactly like action methods but hav\", \"e the HTTP verb they\\nhandle in their name (for example, OnGet). They also don\\u2019t necessarily need to \", \"return, since by default\\nthey're assumed to return the page they're associated with. This tends to k\", \"eep Razor Pages and their\\nhandlers smaller and more focused while at the same time making it easier \", \"to find and work with all of\\nthe files needed to add or modify a particular part of an app.\\n\\nAs part\", \" of a move from ASP.NET MVC to ASP.NET Core, teams should consider whether they want to\\nmigrate cont\", \"rollers and views to ASP.NET Core controllers and views, or to Razor Pages. The former\\n\\n26 CHAPTER 2\", \" | Architectural differences between ASP.NET MVC and ASP.NET Core\\nwill most likely require slightly \", \"less overall effort, but won't allow the team to take advantage of the\\nbenefits of Razor Pages over \", \"traditional view-based file organization.\\n\\nReferences\\n\\n\\u00b0 Introduction to Razor Pages in ASP.NET Core\", \"\\n\\u00b0 Simpler ASP.NET Core Apps with Razor Pages\\n\\nCompare ASP.NET Web API 2 and ASP.NET Core\\n\\nASP.NET C\", \"ore offers iterative improvements to ASP.NET Web API 2, but should feel familiar to\\ndevelopers who h\", \"ave used Web API 2. ASP.NET Web API 2 was developed and shipped alongside\\nASP.NET MVC. This meant th\", \"e two approaches had similar-but-different approaches to things like\\nattribute routing and dependenc\", \"y injection. In ASP.NET Core, there\\u2019s no longer any distinction\\nbetween MVC and Web APIs. There's on\", \"ly ASP.NET Core, which includes support for view-based\\nscenarios, API endpoints, Razor Pages, health\", \" checks, SignalR, and more.\\n\\nIn addition to being consistent and unified within ASP.NET Core, APIs b\", \"uilt in .NET Core are much\\neasier to test than those built on ASP.NET Web API 2. We'll cover testing\", \" differences in more detail in\\na moment. The built-in support for hosting ASP.NET Core apps, in a te\", \"st host that can create an\\nHttpClient that makes in-memory requests to the app, is a huge benefit wh\", \"en it comes to automated\\ntesting.\\n\\nSee Incremental ASP.NET to ASP.NET Core migration for an incremen\", \"tal approach to migrating to\\nASP.NET Core.\\n\\nReferences\\n\\n\\u00b0 Migrate from ASP.NET Web API to ASP.NET Co\", \"re\\n\\u00b0 Ardalis.ApiEndpoints NuGet package\\n\\nCompare authentication and authorization between\\nASP.NET MV\", \"C and ASP.NET Core\\n\\nIn ASP.NET MVC 5, authentication is configured in Startup.Auth.cs in the App_Sta\", \"rt folder. In ASP.NET\\nCore MVC, this configuration occurs in Startup.cs or Program.cs, as part of co\", \"nfiguring the app\\u2019s\\nservices and middleware.\\n\\nAuthentication and authorization are performed using m\", \"iddleware added to the request pipeline:\\n\\napp.UseRouting();\\n\\napp.UseAuthentication() ;\\napp.UseAuthor\", \"ization() ;\\n\\napp.UseEndpoints(endpoints =>\\n\\n27 CHAPTER 2 | Architectural differences between ASP.NET\", \" MVC and ASP.NET Core\\nendpoints .MapControllerRoute(\\n\\nname: \\\"default\\\",\\n\\npattern: \\\"{controller=Home}/\", \"{action=Index}/{id?}\\\") ;\\nendpoints .MapRazorPages() ;\\n\\n})5\\n\\nIt's important to add the auth middlewar\", \"e in the appropriate order in the middleware pipeline. Only\\nrequests that make it to the middleware \", \"will be impacted by it. For instance, if a call to UseStaticFiles()\\nwere placed above the code shown\", \" here, it wouldn't be protected by authentication and\\nauthorization.\\n\\nIn ASP.NET MVC and Web API, ap\", \"ps often refer to the current user using the ClaimsPrincipal.Current\\nproperty. This property isn't s\", \"et in ASP.NET Core, and any behavior in your app that depends on it will\\nneed to migrate from Claims\", \"Principal.Current by using the User property on ControllerBase or getting\\naccess to the current Http\", \"Context and referencing its User property. If neither of these solutions is an\\noption, services can \", \"request the User as an argument, in which case it must be supplied from\\nelsewhere in the app, or the\", \" IHttoContextAccessor can be requested and used to get the HttpContext.\\n\\nAuthorization\\n\\nAuthorizatio\", \"n defines what a given user can do within the app. It's separate from authentication,\\nwhich is conce\", \"rned merely with identifying who the user is. ASP.NET Core provides a simple,\\ndeclarative role and a\", \" rich, policy-based model for authorization. Specifying that a resource requires\\nauthorization is of\", \"ten as simple as adding the [Authorize] attribute to the action or controller. If you're\\nmigrating t\", \"o Razor Pages from MVC views, you should specify conventions for authorization when\\n\\nyou configure R\", \"azor Pages.\\n\\nAuthorization in ASP.NET Core may be as simple as prohibiting anonymous users while all\", \"owing\\nauthenticated users. Or it can scale up to support role-based, claims-based, or policy-based\\na\", \"uthorization approaches. For more information on these approaches, see the documentation on\\nauthoriz\", \"ation in ASP.NET Core. You'll likely find that one of them is closely aligned with your current\\nauth\", \"orization approach.\\n\\nReferences\\n\\n\\u00b0 Security, Authentication, and Authorization with ASP.NET MVC\\n\\u00b0 Mi\", \"grate Authentication and Identity to ASP.NET Core\\n\\n\\u00b0 Migrate from ClaimsPrincipal.Current\\n\\u00b0 Introduc\", \"tion to Authorization in ASP.NET Core\\n\\nCompare ASP.NET Identity and ASP.NET Core\\nIdentity\\n\\nIn ASP.NE\", \"T MVC, identity features are typically configured in IdentityConfig.cs in the App_Start folder.\\nRevi\", \"ew how this is configured in the existing app, and compare it to the configuration required for\\n\\nASP\", \".NET Core Identity in Program.cs.\\n\\n28 CHAPTER 2 | Architectural differences between ASP.NET MVC and \", \"ASP.NET Core\\nASP.NET Identity is an API that supports user interface login functionality and manages\", \" users,\\npasswords, profile data, roles, claims, tokens, email confirmations, and more. It supports e\", \"xternal login\\nproviders like Facebook, Google, Microsoft, and Twitter.\\n\\nIf your ASP.NET MVC app is u\", \"sing ASP.NET Membership, you'll find a guide to migrate from ASP.NET\\n\\nMembership authentication to A\", \"SP.NET Core 2.0 Identity. This is mainly a data migration exercise, at\\nthe completion of which you s\", \"hould be able to use ASP.NET Core Identity with your migrated user\\n\\nrecords.\\n\\nIf you migrate your AS\", \"P.NET Identity users to ASP.NET Core Identity, you may need to update their\\npassword hashes, or trac\", \"k which passwords are hashed with the new ASP.NET Core Identity approach\\nor the older ASP.NET Identi\", \"ty approach. This approach described on Stack Overflow provides some\\noptions for migrating user pass\", \"word hashes over time, rather than all at once.\\n\\nOne of the biggest differences when it comes to ASP\", \".NET Core Identity compared to ASP.NET Identity\\nis how little code you need to include in your proje\", \"ct. ASP.NET Core Identity now ships as a Razor\\nClass Library, meaning its UI and logic are all avail\", \"able from a NuGet package. You can override the\\nexisting UI and logic by scaffolding the ASP.NET Cor\", \"e Identity files but even in this case you need only\\nscaffold the pages you want to modify, not ever\", \"y one that exists.\\n\\nMigrate from OWIN / Katana\\n\\nThe following resources offer some guidance for migr\", \"ating from OWIN / Katana:\\n\\n\\u00b0 Migration\\n\\u00b0 Katana to ASPNET 5\\n\\nReferences\\n\\n: Migrate Authentication an\", \"d Identity to ASP.NET Core\\n: Introduction to Identity on ASP.NET Core\\n\\n: Configure ASP.NET Core Iden\", \"tity\\n\\n: Scaffold Identity in ASP.NET Core projects\\n\\nCompare controllers in ASP.NET MVC and Web API\\nw\", \"ith controllers in ASP.NET Core\\n\\nIn ASP.NET MVC 5 and Web API 2, there were two different Controller\", \" base types. MVC controllers\\ninherited from Controller; Web API controllers inherited from ApiContro\", \"ller. In ASP.NET Core, this\\nobject hierarchy has been merged. It\\u2019s recommended that API controllers \", \"in ASP.NET Core inherit\\nfrom ControllerBase and add the [ApiController] attribute. Standard view-bas\", \"ed MVC controllers\\nshould inherit from Controller.\\n\\nIn both frameworks, controllers are used to orga\", \"nize sets of action methods. Filters and routes can be\\napplied on a controller level in addition to \", \"at the action level. These conventions can be extended\\nfurther by using custom base Controller types\", \" with default behavior and attributes applied to them.\\n\\n29 CHAPTER 2 | Architectural differences bet\", \"ween ASP.NET MVC and ASP.NET Core\\nIn ASP.NET MVC, content negotiation isn\\u2019t supported. ASP.NET Web A\", \"PI 2 does support content\\nnegotiation, as does ASP.NET Core. Using content negotiation, the format o\", \"f the content returned to a\\nrequest can be determined by headers the client provides indicating its \", \"preferred manner of receiving\\nthe content.\\n\\nWhen migrating ASP.NET Web API controllers to ASP.NET Co\", \"re, a few components need to be\\nchanged if they exist. These include references to the ApiController\", \" base class, the System.Web.Http\\nnamespace, and the IHttpActionResult interface. Refer to the docume\", \"ntation for recommendations on\\nhow to migrate these specific differences. Note that the preferred re\", \"turn type for API actions in\\nASP.NET Core is ActionResult<T>.\\n\\nIn addition, the [ChildActionOnly] at\", \"tribute isn't supported in ASP.NET Core. In ASP.NET Core, similar\\nfunctionality is achieved using Vi\", \"ew Components.\\n\\nASP.NET Core includes two new attributes: ConsumesAttribute and ProducesAttribute. T\", \"hese are used\\nto specify the type an action consumes or produces, which can be helpful for routing a\", \"nd\\ndocumenting the API using tools like Swagger/OpenAPI.\\n\\nReferences\\n\\n\\u00b0 Format response data in ASP.\", \"NET Core Web API\\n\\u00b0 Migrate from ASP.NET Web API to ASP.NET Core\\n\\nCompare Razor usage in ASP.NET MVC \", \"and\\nASP.NET Core\\n\\nThe basic syntax of Razor hasn't changed substantially between ASP.NET MVC and ASP\", \".NET Core.\\nHowever, there are certain differences, such as the introduction of Tag Helpers and Razor\", \" Pages, that\\nshould be considered when migrating. If your app makes heavy use of custom Razor functi\", \"onality,\\nrefer to the Razor syntax reference for ASP.NET Core to see what changes may be required wh\", \"en you\\nmigrate to ASP.NET Core.\\n\\nTag Helpers\\n\\nTag Helpers enable server-side code to participate in \", \"creating and rendering HTML elements in Razor\\nfiles. They offer many advantages over HTML Helpers an\", \"d should be used in place of HTML Helpers\\nwherever possible. They provide an HTML-friendly developme\", \"nt experience, since they look like\\nstandard HTML and are ignored by most tooling designed to edit H\", \"TML. Within Visual Studio, there's\\nrich Intellisense support for creating HTML and Razor markup with\", \" Tag Helpers. Tag Helpers can\\nprovide simple or complex behavior from declarative markup in Razor fi\", \"les.\\n\\nRazor Pages\\n\\nRazor Pages offer an alternative to controllers, actions, and views for page- and\", \" form-based apps.\\nRazor Pages were compared to ASP.NET MVC earlier in this chapter.\\n\\n30 CHAPTER 2 | \", \"Architectural differences between ASP.NET MVC and ASP.NET Core\\nReferences\\n\\nMigrate from ASP.NET MVC \", \"to ASP.NET Core MVC: Controllers and Views\\nTag Helpers in ASP.NET Core\\n\\nIntroduction to Razor Pages \", \"in ASP.NET Core\\n\\nRazor syntax reference for ASP.NET Core\\n\\nCompare ASP.NET SignalR and ASP.NET Core\\nS\", \"ignalR\\n\\nASP.NET Core SignalR is incompatible with clients or servers using ASP.NET SignalR. You'll n\", \"eed to\\nupdate both clients and server to use ASP.NET Core SignalR. Some differences are described in\", \" this\\nsection, while the full list is available in the docs. ASP.NET Core SignalR requires .NET Core\", \" 2.1 or\\n\\ngreater.\\n\\nFeature differences\\n\\nASP.NET SignalR automatically attempts to reconnect dropped \", \"connections; this behavior is\\nopt-in for ASP.NET Core SignalR clients.\\n\\nBoth frameworks support JSON\", \"; ASP.NET Core SignalR also supports a binary protocol based\\non MessagePack, and custom protocols ca\", \"n be created.\\n\\nThe Forever Frame transport, supported by ASP.NET SignalR, isn\\u2019t supported in ASP.NET\", \" Core\\nSignalR.\\n\\nASP.NET Core SignalR must be configured by adding services.AddSignalR() and\\napp.UseE\", \"ndpoints in Program.cs.\\n\\nASP.NET Core SignalR requires sticky sessions; ASP.NET SignalR doesn't.\\n\\nAS\", \"P.NET Core simplifies the connection model; connections are only made to a single hub.\\nASP.NET Core \", \"SignalR supports streaming data from the hub to the client.\\n\\nASP.NET Core SignalR doesn\\u2019t support pa\", \"ssing state between clients and the hub (but method\\ncalls still allow passing information between hu\", \"bs and clients).\\n\\nThe PersistentConnection class doesn't exist in ASP.NET Core SignalR.\\n\\nASP.NET Sig\", \"nalR supports SQL Server and Redis. ASP.NET Core SignalR supports Azure\\nSignalR and Redis.\\n\\nReferenc\", \"es\\n\\n31\\n\\nDifferences between ASP.NET SignalR and ASP.NET Core SignalR\\nAzure SignalR Service\\n\\nCHAPTER \", \"2 | Architectural differences between ASP.NET MVC and ASP.NET Core\\nCompare testing options between A\", \"SP.NET MVC\\nand ASP.NET Core\\n\\nASP.NET MVC apps support unit testing of controllers, but this approach\", \" often omits many MVC\\nfeatures like routing, authorization, model binding, model validation, filters\", \", and more. To test these\\nMVC features in addition to the logic within the controller action itself,\", \" frequently the app would need\\nto be deployed and then tested with a tool like Selenium. These tests\", \" are substantially more\\nexpensive, more brittle, and slower than typical unit tests that can be run \", \"without the need for hosting\\nand running the entire app.\\n\\nASP.NET Core controllers can be unit teste\", \"d just like ASP.NET MVC controllers, but with the same\\nlimitations. However, ASP.NET Core supports f\", \"ast, easy-to-author integration tests as well. Integration\\n\\ntests are hosted by a TestHost class and\", \" are typically configured in a custom WebApplicationFactory\\nthat can override or replace app depende\", \"ncies. For instance, frequently during integration tests the\\napp will target a different data source\", \" and may replace services that send emails with fake or mock\\nimplementations.\\n\\nASP.NET MVC and Web A\", \"PI did not support anything like the integration testing scenarios available in\\nASP.NET Core. In any\", \" migration effort, you should allocate time to write some integration tests for\\nyour newly migrated \", \"system to ensure it\\u2019s working as expected and continues to do so. Even if you\\nweren't writing tests \", \"of your web app logic before the migration, you should strongly consider doing\\nSO as you move to ASP\", \".NET Core.\\n\\nReferences\\n\\n\\u00b0 Creating Unit Tests for ASP.NET MVC Applications\\n\\u00b0 Unit test controller lo\", \"gic in ASP.NET Core\\n\\u00b0 Integration tests in ASP.NET Core\\n\\n32 CHAPTER 2 | Architectural differences be\", \"tween ASP.NET MVC and ASP.NET Core\\nCHAPTER\\n\\nMigrate large solutions to\\nASP.NET Core\\n\\nMigrating large\", \" solutions from .NET Framework to .NET Core requires some planning. Dependencies\\nmust be migrated or\", \" updated before the projects that depend on them. There are tools that can\\nidentify dependencies and\", \" offer help with migrating to .NET Core. Depending on the app, its scope,\\nand current usage patterns\", \", different strategies may be employed when migrating. Do you migrate it\\nall at once, or over time, \", \"side-by-side with the current system? Do you wrap the current system in the\\nnew one, and incremental\", \"ly replace its functionality?\\n\\nIn this chapter, you'll learn how create a migration plan for a large\", \" solution, how to use tools to help\\nwith the migration, and some strategies to consider for the migr\", \"ation itself.\\n\\nReferences\\n\\n\\u00b0 What topics are important to migrating large MVC and Web API apps to .N\", \"ET Core?\\n\\u00b0 Porting from .NET Framework to .NET Core\\n\\nIdentify sequence of projects to migrate\\n\\nFor s\", \"olutions that involve multiple front-end apps, it\\u2019s best to migrate the apps one by one. For\\nexample\", \", create a solution that only includes one front-end app and its dependencies so you can\\neasily iden\", \"tify the scope of work involved. Solutions are lightweight, and you can include projects in\\nmultiple\", \" solutions if needed. Take advantage of solutions as an organizational tool when migrating.\\n\\nOnce yo\", \"u've identified the ASP.NET app to migrate and have its dependent projects located with it\\n(ideally \", \"in a solution), the next step is to identify framework and NuGet dependencies. Having\\nidentified all\", \" dependencies, the simplest migration approach is a \\u201cbottom up\\u201d approach. With this\\napproach, the lo\", \"west level of dependencies is migrated first. Then the next level of dependencies is\\nmigrated, until\", \" eventually the only thing left is the front-end app. Figure 3-1 shows an example set of\\nprojects co\", \"mposing an app. The low-level class libraries are at the bottom, and the ASP.NET MVC\\nproject is at t\", \"he top.\\n\\n33 CHAPTER 3 | Migrate large solutions to ASP.NET Core\\nContoso.Web\\n\\nASP.NET MVC 5\\n\\nContoso.\", \"BusinessLogic\\n\\n.NET 4.6.1 Class Library\\n\\nContoso.Data\\n\\n.NET 4.5 Class Library\\n\\nContoso.Utils\\n\\n.NET 4\", \".5 Class Library\\n\\nFigure 3-1. Project dependencies graph.\\n\\nChoose a particular front-end app, an ASP\", \".NET MVC 5 / Web API 2 project. Identify its dependencies\\nin the solution, and map out their depende\", \"ncies until you have a complete list. A diagram like the one\\nshown in Figure 3-1 may be useful when \", \"mapping out project dependencies. Visual Studio can\\nproduce a dependency diagram for your solution, \", \"depending on which edition you're using. The .NET\\nPortability Analyzer can also produce dependency d\", \"iagrams.\\n\\nFigure 3-2 shows the installer for the .NET Portability Analyzer Visual Studio extension:\\n\", \"\\n34 CHAPTER 3 | Migrate large solutions to ASP.NET Core\\na? VSIX Installer x\\n\\nInstall\\n-NET Portabilit\", \"y Analyzer License\\n\\nDigital Signature: Microsoft Corporation\\n\\nSelect the product(s) you want to inst\", \"all the extension to:\\n\\nVisual Studio Enterprise 2019\\nVisual Studio Enterprise 2019 Preview\\n\\nBy click\", \"ing \\u201cInstall\\u201d, you agree with the\\n\\nabove license terms (if any) and the |\\n\\ninstallation of any prere\", \"quisites.\\n\\nFigure 3-2. .NET Portability Analyzer installer.\\n\\nThe extension currently supports Visual\", \" Studio 2017 and 2019. Visual Studio 2022 support is planned.\\n\\nOnce installed, you configure it from\", \" the Analyze > Portability Analyzer Settings menu, as shown in\\nFigure 3-3.\\n\\n35 CHAPTER 3 | Migrate l\", \"arge solutions to ASP.NET Core\\nOptions\\n\\nSearch Options (Ctrl+E) General settings\\nDefault output dire\", \"ctory C:\\\\Portability Analysis\\n\\nEnvironment\\nProjects and Solutions Default output name ApiPortAnalysi\", \"s\\n\\nSource Control Output formats\\n\\nWork Items Excel HTML [_]Json\\nText Editor\\n\\nDebugging Target Platfo\", \"rms\\nIntelliTrace -NET Core\\nPerformance Tools 10 (J11 [)20 [J21 [422\\n\\n\\u2018NET Portability Analyzer .NET \", \"Core + Platform Extensions\\n\\nGeneral -j20 C21 22\\nAzure Service Authentication\\n= \\u00abNET Framework\\nContai\", \"ner Tools\\n\\neae RT 10 (J11 ()20 ()30 (435 (740 (145 (1451 (1452 (146 (1461 (1462 (1747 (1471 (472\\nDat\", \"abase Tools \\u00abNET Standard\\nF# Tools [J10 [414 (412 (713 (114 (1915 (716 (20 [)21\\n\\na Some ; -NET Stand\", \"ard + Platform Extensions\\nLive Unit Testing C16 \\u00a320\\n\\nNuGet Package Manager\\n\\nSnapshot Debugger \\u201cNET C\", \"ore\\nSOL Server Tools 0 (11 ()20\\nTest\\nWas leo o O35 O40 O45 O50\\nWeb Forms Designer\\n\\nWeb Performance T\", \"est Tools\\nWindows Forms Designer\\nXAML Designer\\n\\nevVVVVVVV\\n\\n}3.0 ()4.0 (]5.0\\n\\nb\\nb\\nb\\nb\\nb\\nb\\nb\\nb\\nb\\nb\\nb\\nb\", \"\\nb\\nb\\nb\\nb\\n\\n}8.1 (100 [J 10.1\\nWindows Phone\\n\\n[ ] 8.1\\n\\nWindows Phone Silverlight\\n\\n[]70 (J71 (J)80 ()38.\", \"1\\nXamarin Android\\n\\n|_] 1.0.0\\n\\nXamarin iOS\\n\\n[_] 1.0.0.0\\n\\nRefresh About Tool View Privacy Statement\\n\\n[\", \"aT] coe\\n\\nFigure 3-3. Configure the .NET Portability Analyzer.\\n\\nThe analyzer produces a detailed repo\", \"rt for each assembly. The report:\\n\\n. Describes how compatible each project is with a given target fr\", \"amework, such as .NET 7 or\\n.NET Standard 2.0.\\n\\n. Helps teams assess the effort required to port a pa\", \"rticular project to a particular target\\nframework.\\n\\nThe details of this analysis are covered in the \", \"next section.\\n\\nOnce you've mapped out the projects and their relationships with one another, you're \", \"ready to\\ndetermine the order in which you'll migrate the projects. Begin with projects that have no\\n\", \"dependencies. Then, work your way up the tree to the projects that depend on these projects.\\n\\nIn the\", \" example shown in Figure 3-1, you would start with the Contoso.Utils project, since it doesn't\\ndepen\", \"d on any other projects. Next, Contoso.Data since it only depends on \\u201cUtils\\u201d. Then migrate the\\n\\u201cBusi\", \"nessLogic\\u201d library, and finally the front-end ASP.NET \\u201cWeb\\u201d project. Following this \\u201cbottom up\\u201d\\nappr\", \"oach works well for relatively small and well-factored apps that can be migrated as a unit once all\\n\", \"of their projects have migrated. Larger apps with more complexity, or more code that will take longe\", \"r\\nto migrate, may need to consider more incremental strategies.\\n\\n36 CHAPTER 3 | Migrate large soluti\", \"ons to ASP.NET Core\\nUnit tests\\n\\nMissing from the previous diagrams are unit test projects. Hopefully\", \" there are tests covering at least\\nsome of the existing behavior of the libraries being ported.\\n\\nIf \", \"you have unit tests, it's best to convert those projects first. You'll want to continue testing chan\", \"ges\\nin the project you're working on. Remember that porting to .NET Core is a significant change to \", \"your\\ncodebase.\\n\\nMsSTest, xUnit, and NUnit all work on .NET Core. If you don\\u2019t currently have tests f\", \"or your app,\\nconsider building some characterization tests that verify the system's current behavior\", \". The benefit is\\nthat once the migration is complete, you can confirm the app\\u2019s behavior remains unc\", \"hanged.\\n\\nConsiderations for migrating many apps\\n\\nSome organizations will have many different apps to\", \" migrate, and migrating each one by hand may\\nrequire too many resources to be tenable. In these situ\", \"ations, some degree of automation is\\nrecommended. The steps followed in this chapter can be automate\", \"d. Structural changes, like project\\nfile differences and updates to common packages, can be applied \", \"by scripts. These scripts can be\\nrefined as they're run iteratively on more projects. On each run, e\", \"xamine whatever manual steps are\\nrequired for each project. Automate those manual steps, if possible\", \". Using this approach, the\\norganization should grow faster and better at porting their apps over tim\", \"e, with improved automation\\nsupport each step of the way.\\n\\nWatch an overview of how to employ this a\", \"pproach in this dotNetConf presentation by Lizzy\\nGallagher of Mastercard. The five phases employed i\", \"n this presentation included:\\n\\n. Migrate third-party NuGet dependencies\\n\\n. Migrate apps to use new .\", \"csproj file format\\n\\n. Update internal NuGet dependencies to .NET Standard\\n\\n\\u00b0 Migrate apps to ASP.NET\", \" Core (targeting .NET Framework)\\n\\n\\u00b0 Update all apps to target .NET 7\\nWhen automating a large suite o\", \"f apps, it helps significantly if they follow consistent coding\\nguidelines and project organization.\", \" Automation efforts rely on this consistency to be effective. In\\naddition to parsing and migrating p\", \"roject files, common code patterns can be migrated automatically.\\n\\nSome code pattern examples includ\", \"e differences in how controller actions are declared or how they\\nreturn results.\\n\\nFor example, a mig\", \"ration script could search files matching Controller.cs for lines of code matching\\none of these patt\", \"erns:\\n\\nreturn new HttpStatusCodeResult(2@0) ;\\n\\n// or\\nreturn new HttpStatusCodeResult (HttpStatusCode\", \".OK) ;\\n\\nIn ASP.NET Core, either of the preceding lines of code can be replaced with:\\n\\nreturn Ok();\\n\\n\", \"37 CHAPTER 3 | Migrate large solutions to ASP.NET Core\\nSummary\\n\\nThe best approach to porting a large\", \" .NET Framework app to .NET Core is to:\\n\\n1. Identify project dependencies.\\n2. Analyze what's require\", \"d to port each project.\\n\\n3. Start from the bottom up.\\n\\nYou can use the .NET Portability Analyzer to \", \"determine how compatible existing libraries may be with\\ntarget platforms. Automated tests will help \", \"ensure no breaking changes are introduced as the app is\\nported. These test projects should be among \", \"the first projects ported.\\n\\nReferences\\n\\n\\u00b0 Porting from .NET Framework to .NET Core\\n\\u00b0 The .NET Portab\", \"ility Analyzer\\n\\u00b0 2 Years, 200 Apps: A .NET Core Migration at Scale (Video\\n\\nUnderstand and update dep\", \"endencies\\n\\nAfter identifying the sequence in which the app\\u2019s individual projects must be migrated, t\", \"he next step\\nis to understand each project's dependencies and update them if necessary. For platform\", \"\\ndependencies, the best way to start is to run the .NET Portability Analyzer on the assembly in\\nques\", \"tion, and then look at the detailed results that are generated. You configure the tool to specify\\non\", \"e or more target platforms, such as .NET 7 or .NET Standard 2.0. Results are provided with details\\nf\", \"or each platform targeted. Figure 3-4 shows an example of the tool\\u2019s output.\\n\\n( [\\nTarget type | Targ\", \"et member | Assembly Name -NET Core + Platform Extensions,Version=q -NET Core,Version=v3.1 >| -NET S\", \"tandard + Platform Ext\\nT:System.Web.HttpRequestBase T:System.Web.HttpRequestBase eShopLegacyMVC Not \", \"supported Not supported Not supported\\nT:System.Web.HttpRequestBase M:System.Web.HttpRequestBase.get_\", \"Url eShopLegacyMVC Not supported Not supported Not supported\\nT:System.Web.SessionState.HttpSessionSt\", \"ate T:System.Web.SessionState.HttpSessionState eShopLegacyMVC Not supported Not supported Not suppor\", \"ted\\nT:System.Web.SessionState.HttpSessionState M:System.Web.SessionState.HttpSessionState.set_eShopL\", \"egacyMVC Not supported Not supported Not supported\\nT:System.Web.HttpApplication T:System,Web,HttpApp\", \"lication eShopLegacyMVC Not supported Not supported Not supported\\nT:System.Web.HttpApplication M:Sys\", \"tem.Web.HttpApplication.#ctor eShopLegacyMVC Not supported Not supported Not supported\\nT:System.Web.\", \"Routing.RouteCollection T:System.Web.Routing.RouteCollection eShopLegacyMVC Not supported Not suppor\", \"ted Not supported\\nT:System.Web.HttpRequest T:System.Web.HttpRequest eShopLegacyMVC Not supported Not\", \" supported Not supported\\nT:System.Web.HttpRequest M:System.Web.HttpRequest.get_RawUrl eShopLegacyMVC\", \" Not supported Not supported Not supported\\nT:System.Web.HttpRequest M:System.Web.HttpRequest.gev_Use\", \"rAgent eShopLegacyMVC Not supported Not supported Not supported\\nT:System.Web.Routing.Route T:System.\", \"Web.Routing.Route eShopLegacyMVC Not supported Not supported Not supported\\nT:System.Web.HttpContext \", \"T:System.Web.HttpContext eShopLegacyMVC Not supported Not supported Not supported\\nT:System.Web.HttpC\", \"ontext M:System.Web.HttpContext.get_Current eShopLegacyMVC Not supported Not supported Not supported\", \"\\nT:System.Web.HttpContext M:System.Web.HttpContext.get_Request eShopLegacyMVC Not supported Not supp\", \"orted Not supported\\nT-System.Web.HttpContext M:System.Web.HttpContext.get_Session eShopLegacyMVC Not\", \" supported Not supported Not supported\\nT:System.Web.HttpServerUtilityBase T:System.Web.HttpServerUti\", \"lityBase eShopLegacyMVC Not supported Not supported Not supported\\nT:System.Web.HttpServerUtilityBase\", \" M:System.Web.HttpServerUtilityBase.MapPath(Sy: eShopLegacyMVC Not supported Not supported Not suppo\", \"rted\\nT:System.Web.Hosting.HostingEnvironment T:System.Web.Hosting.HostingEnvironment eShopLegacyMVC \", \"Not supported Not supported Not supported\\nT:System.Web.Hosting.HostingEnvironment M:System.Web.Hosti\", \"ng.HostingEnvironment.get_# eShopLegacyMVC Not supported Not supported Not supported\\nT:System.Web.Ro\", \"uting.RouteTable T:System.Web.Routing.RouteTable eShopLegacyMVC Not supported Not supported Not supp\", \"orted\\nT:System.Web.Routing.RouteTable M:System.Web.Routing.RouteTable.get_Routes eShopLegacyMVC Not \", \"supported Not supported Not supported\\n\\nFigure 3-4. .NET Portability Analyzer report details.\\n\\nUpdate\", \" class library dependencies\\n\\nLarge apps typically involve multiple projects, and most projects other\", \" than the ASP.NET MVC web\\nproject are likely to be class libraries. Class libraries tend to be the e\", \"asiest to port between .NET\\n\\n38 CHAPTER 3 | Migrate large solutions to ASP.NET Core\\nplatforms, espec\", \"ially compared to ASP.NET projects, which are among the most difficult (and typically\\nneed to be re-\", \"created).\\n\\nTeams can consider the try-convert tool or the .NET Upgrade Assistant tool for migrating \", \"class\\nlibraries to .NET Core. These tools analyze a .NET Framework project file and attempt to migra\", \"te it to\\nthe .NET Core project file format, making any modifications it can safely perform in the pr\", \"ocess. The\\ntools may require some manual assistance to work with ASP.NET projects, but can usually h\", \"elp speed\\nup the process of migrating class libraries.\\n\\nThe try-convert and Upgrade Assistant tools \", \"are deployed as .NET Core command line tools. They only\\nrun on Windows, since they're designed to wo\", \"rk with .NET Framework apps. You can install try-\\nconvert by running the following command from a co\", \"mmand prompt:\\n\\ndotnet tool install -g try-convert\\n\\nOnce you've successfully installed the tool, you \", \"can run try-convert in the folder where the class\\nlibrary's project file is located.\\n\\nInstall the .N\", \"ET Upgrade Assistant with the following command (after installing try-convert):\\n\\ndotnet tool install\", \" -g upgrade-assistant\\n\\nRun the tool with the command upgrade-assistant upgrade <project> in the fold\", \"er where the project\\nfile is located.\\n\\nUpdate NuGet package dependencies\\n\\nAnalyze your use of third-\", \"party NuGet packages and determine if any of them don't yet support .NET\\nStandard (or do support it \", \"but only with a new version). It can be helpful to update NuGet packages\\nto use <PackageReference>_s\", \"yntax using Visual Studio's converter tool, so that top-level\\ndependencies are visible. Next, check \", \"whether the current or later versions of these packages support\\n.NET Core or .NET Standard. This inf\", \"ormation can be found on [nuget.org] or within Visual Studio for\\neach package.\\n\\nIf support exists us\", \"ing the version of the package the app currently uses, great! If not, see if a more\\nrecent version o\", \"f the package has the support and research what would be involved in upgrading.\\nThere may be breakin\", \"g changes in the package, especially if the major version of the package changes\\nbetween your curren\", \"tly used version and the one to which you're upgrading.\\n\\nIn some cases, no version of a given packag\", \"e works with .NET Core. In that case, teams have a couple\\noptions. They can continue depending on th\", \"e .NET Framework version, but this has limitations. The\\napp may only run on Windows, and the team ma\", \"y want to run Portability Analyzer on the package's\\nbinaries to see if there are any issues likely t\", \"o be encountered. Certainly the team will want to test\\nthoroughly, since if .NET Framework packages \", \"are used that reference APIs not available in .NET Core,\\na runtime exception will occur. The other o\", \"ption is to find a different package or, if the required\\npackage Is open source, upgrade it to .NET \", \"Standard or .NET Core themselves.\\n\\n39 CHAPTER 3 | Migrate large solutions to ASP.NET Core\\nMigrate AS\", \"P.NET MVC projects\\n\\nThe System.Web namespace and types don't exist in .NET Core. When you're analyzi\", \"ng dependencies\\nand using tools like try-convert, you'll find they don\\u2019t offer many suggestions for \", \"automatic migration\\nof ASP.NET MVC projects and any code in them that references System.Web. For the\", \"se projects, you'll\\nneed to start with a new ASP.NET Core web project and manually migrate files to \", \"this project.\\n\\nIn general, it's a good practice to minimize how much of an app\\u2019s business logic live\", \"s in its user\\ninterface layer. It's also best to keep controllers and views small. Apps that have fo\", \"llowed this\\nguidance will be easier to port than those that have a significant amount of their logic\", \" in the ASP.NET\\nweb project. If you have an app you're considering porting, but haven't begun the pr\", \"ocess yet, keep\\nthis in mind as you maintain it. Any effort you put toward minimizing how much code \", \"is in the\\nASP.NET MVC or Web API project will likely result in less work when the time comes to port\", \" the app.\\n\\nThe next chapter digs into details of how to migrate from ASP.NET MVC and Web API project\", \"s to\\nASP.NET Core projects. The previous chapter called out the biggest differences between the apps\", \".\\nOnce the basic project structure is in place, migrating individual controllers and views is usuall\", \"y\\nstraightforward, especially if they're mainly focused on web responsibilities.\\n\\nReferences\\n\\n\\u00b0 .NET\", \" Upgrade Assistant tool\\n\\u00b0 try-convert tool\\n\\u00b0 apiport tool\\n\\nStrategies for migrating while running in\", \" production\\n\\nMany teams have .NET Framework apps they plan to migrate to .NET Core/.NET 7, but the a\", \"pp is so\\nlarge that the migration requires a significant amount of time to complete. The original ap\", \"p needs to\\nlive on while the migration is done piece by piece. There needs to be a way for the old a\", \"nd new\\nversions of the app to work together side-by-side, or for the old version to be migrated in-p\", \"lace, at\\nleast some of the way, without breaking it. Teams can employ many different strategies to s\", \"upport\\nthese goals.\\n\\nRefactor the .NET Framework solution\\n\\nA good place to start if you plan to port\", \" a .NET Framework app to .NET Core is to refactor it to work\\nbetter with .NET Core. This means updat\", \"ing individual class libraries to target .NET Standard and\\nmoving as much logic out of your ASP.NET \", \"MVC projects and into these class libraries. Any code you\\nhave in .NET Standard libraries is immedia\", \"tely usable from both .NET Framework to .NET Core apps,\\nwhich is why this step is so valuable as par\", \"t of a migration.\\n\\nWhen refactoring, make sure you're following good refactoring fundamentals. For e\", \"xample, create\\ntests that verify what the system does before you start refactoring. Run these tests \", \"when you're done\\nto confirm you didn\\u2019t change the system's behavior. You may need to add characteriz\", \"ation tests to the\\nsystem if you don't already have a good suite of automated tests you can rely on.\", \"\\n\\n40 CHAPTER 3 | Migrate large solutions to ASP.NET Core\\nExtract front-end assets to a CDN\\n\\nIf your \", \".NET Framework apps include a lot of static assets, like scripts, CSS files, or images, you may be\\na\", \"ble to migrate these to a separate CDN. Then, update the existing app to reference the CDN links for\", \"\\nthese assets. When you port the app to .NET Core, these static files won't be part of the migration\", \",\\nand you'll just continue referencing them from the CDN in the ASP.NET Core app.\\n\\nExtract and migra\", \"te individual microservices\\n\\nLarge .NET Framework apps may already be comprised of separate front-en\", \"d systems that can be\\nmigrated individually. Or they may be candidates for migration to a microservi\", \"ces architecture, with\\nsome pieces of existing ASP.NET MVC apps being pulled out into new ASP.NET Co\", \"re microservice\\nimplementations. You can learn more about microservices in the associated ebook, .NE\", \"T\\n\\nMicroservices: Architecture for Containerized .NET Applications.\\n\\nFor example, the existing app m\", \"ight have a set of features it uses related to user sign-in and\\nregistration. These could be migrate\", \"d to a separate microservice, which could be built and deployed\\nusing ASP.NET Core and then integrat\", \"ed into the legacy .NET Framework app. Next, the app might\\nhave a few pages dedicated to tracking th\", \"e individual user's shopping cart. These pages could also be\\npulled out into their own separate micr\", \"oservice and again integrated into the existing app. In this way,\\nthe original .NET Framework app co\", \"ntinues running in production, but with more and more of its\\nfeatures coming from modernized .NET Co\", \"re microservices.\\n\\nDeploy multiple versions of the app side-by-side in IIS\\n\\nUsing a combination of h\", \"ost headers and redirects, an existing ASP.NET MVC app can be configured\\nto run side by side with an\", \" ASP.NET Core app on the same IIS server. As pieces of functionality, such\\nas individual controllers\", \", are ported to ASP.NET Core, their routes and URLs are mapped within IIS to\\ntarget the ASP.NET Core\", \" web site or sub-application (IIS virtual directories aren't supported with\\nASP.NET Core apps). An A\", \"SP.NET Core app can be hosted as an IIS sub-application (sub-app). The\\nsub-app\\u2019s path becomes part o\", \"f the root app\\u2019s URL.\\n\\nApply the Strangler pattern\\n\\nLarge ASP.NET MVC apps can be gradually replaced\", \" with a new ASP.NET Core app by incrementally\\nmigrating pieces of functionality. One approach to thi\", \"s is called the strangler pattern, named for\\nstrangler vines that strangle and eventually tear down \", \"trees. This approach relies on first\\nimplementing a facade layer over top of the existing solution. \", \"This facade should be built using the\\nnew approach to the problem, or an off-the-shelf solution such\", \" as an API gateway.\\n\\nOnce the facade is in place, you can route part of it to a new ASP.NET Core app\", \". As you port more of\\nthe original .NET Framework app to .NET Core, you continue to update the facad\", \"e layer accordingly,\\nsending more of the facade\\u2019s total functionality to the new system. Figure 3-5 \", \"shows the strangler\\npattern progression over time.\\n\\nAl CHAPTER 3 | Migrate large solutions to ASP.NE\", \"T Core\\nEarly migration Later migration Migration complete\\n\\nStrangler Facade\\n\\nStrangler Facade\\n\\nModer\", \"n\\nLegacy\\n\\nFigure 3-5. The Strangler pattern over time.\\n\\nModern\\nModern\\n\\nEventually, the entire facade\", \" layer corresponds to the new, modern implementation. At this point,\\nboth the legacy system and the \", \"face layer can be retired. Microsoft has guidance on how to achieve\\n\\nincremental ASP.NET to ASP.NET \", \"Core migration using the YARP reverse proxy.\\n\\nMulti-targeting approaches\\n\\nMulti-targeting is recomme\", \"nded for large apps that will be migrated over time and for teams\\napplying the Strangler pattern app\", \"roach. This approach can address BindingRedirect and package\\nrestoration challenges that surface fro\", \"m mixing PackageReference and packages.config restore styles.\\nThere are two options available for co\", \"de that must run in both .NET Framework and .NET Core\\nenvironments.\\n\\n. Preprocessor directives (#if \", \"in C# or #If in Visual Basic) allow you to implement different\\nfunctionality or use different depend\", \"encies when run in .NET Framework versus .NET Core.\\n\\n. Project files can use conditional globbing pa\", \"tterns, such as *.core.cs, to include different sets\\nof files based on which framework is being targ\", \"eted.\\n\\nTypically you only follow these recommendations for class libraries. These techniques allow a\", \" single\\ncommon codebase to be maintained while new functionality is added and features of the app ar\", \"e\\nincrementally ported to use .NET Core.\\n\\nSummary\\n\\nFrequently, large ASP.NET MVC and Web API apps wo\", \"n't be ported to ASP.NET Core all at once, but\\nwill migrate incrementally over time. This section of\", \"fers several strategies for performing this\\nincremental migration. Choose the one(s) that will work \", \"best for your organization and app.\\n\\nReferences\\n\\n\\u00b0 .NET Microservices: Architecture for Containerize\", \"d .NET Applications\\n\\n\\u00b0 eShopOnContainers Reference Microservices Application\\n\\u00b0 Host ASP.NET Core on \", \"Windows with IIS\\n\\n\\u00b0 Strangler pattern\\n\\u00b0 Incremental ASP.NET to ASP.NET Core Migration\\n\\n42 CHAPTER 3 \", \"| Migrate large solutions to ASP.NET Core\\nCHAPTER |\\n\\nExample migration of\\neShop to ASP.NET Core\\n\\nIn \", \"this chapter, you'll see how to migrate a .NET Framework app to .NET Core. The chapter examines a\\nsa\", \"mple online store app written for ASP.NET MVC 5. The app will use many of the concepts and tools\\ndes\", \"cribed earlier in this book. You'll find the starting point app in the eShopModernizing GitHub\\nrepos\", \"itory. There are several different starting point apps. This chapter focuses on the\\neShopLegacyMVCSo\", \"lution.\\n\\nThe initial version of the project is shown in Figure 4-1. It\\u2019s a fairly standard ASP.NET M\", \"VC 5 app.\\n\\ncao Connected Services\\n>b \\u00ae Properties\\nfo! References\\nFO App_Data\\nFO App_Start\\nF) Content\", \"\\nFE) Controllers\\n[1 fonts\\n[1 Images\\n[0 Models\\n[0 Modules\\n[FO Pics\\n[) Scripts\\nFO Services\\n[1 Setup\\n[0\", \" ViewModel\\n[0 Views\\nb Ba.) Application|nsights.config\\nA |i) favicon.ico\\nb Ad) Global.asax\\nAls log4Ne\", \"t.xml\\nb Bal Web.config\\n\\n\\u2014\\n\\nFr rr OE Er OY Ow\\n\\nFigure 4-1. The eShopModernizing MVC sample project st\", \"ructure.\\n\\n43 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\nThis chapter demonstrates how to\", \" perform many of the upgrade steps by hand. Alternatively, you can\\nuse the .NET Upgrade Assistant to\", \"ol to perform many of the initial steps, like converting the project\\nfile, changing the target frame\", \"work, and updating NuGet packages.\\n\\nRun ApiPort to identify problematic APIs\\n\\nThe first step in prep\", \"aring to migrate is to run the ApiPort tool. The tool identifies how many .NET\\nFramework APIs the ap\", \"p calls and how many of these have .NET Standard or .NET Core equivalents.\\nFocus primarily on your o\", \"wn app's logic, not third-party dependencies, and pay attention to\\nSystem.Web dependencies that will\", \" need to be ported. The ApiPort tool was introduced in the last\\nchapter on understanding and updatin\", \"g dependencies. Note that currently it requires Visual Studio\\n2019; Visual Studio 2022 support is pl\", \"anned.\\n\\nAfter installing and configuring the ApiPort tool, run the analysis from within Visual Studi\", \"o, as shown\\nin Figure 4-2.\\n\\n44 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\nAnalyze Tools \", \"Extensions Window _ He\\n\\nCode Cleanup\\n\\nRun Code Analysis\\nBuild and Suppress Active Issues\\n\\nConfigure \", \"Code Analysis\\n\\nCalculate Code Metrics\\n\\nAnalyze Solution for Code Clones\\n\\nAnalyze Assembly Portabilit\", \"y\\nPortability Analyzer Settings\\n\\nView analysis reports\\n\\nWindows\\n\\nFigure 4-2. Analyze assembly portab\", \"ility in Visual Studio.\\n\\nChoose the web project's assembly from the project's bin folder, as shown i\", \"n Figure 4-3.\\n\\n45 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\no\\u00a2) Select Assembly Files\\n\\n\", \"Organize ~ New folder\\n\\nA\\n$2 Dropbox\\n@ OneDrive\\n\\n\\u00ae This PC\\n_y 3D Objects\\n\\u2018gm Desktop\\n3 Documents\\n\\u201c\\u00a7 D\", \"ownloads\\nd Music\\n\\n= Pictures\\n\\u2018B Videos\\n= 20S (C:)\\n\\nv <\\n\\n*} | \\u00ab src > eShopLegacyMVC > bin >\\n\\nName\\n\\nM\", \"odels\\n\\nAntlir3.Runtime.dll\\n\\nAutofac.dll\\nAutofac.Integration.Mvc.dll\\nEntityFramework.dll\\nEntityFramew\", \"ork.SqlServer.dll\\neShopLegacyMVC.dll\\n\\nlog4net.dll\\nMicrosoft.Al.Agent.Intercept.dll\\nMicrosoft.Al.Depe\", \"ndencyCollector.dll\\nMicrosoft.Al.PerfCounterCollector.dll\\n\\na \\u2014e \\u2014*\\n\\nFile name: eShopLegacyMVC.dll\\n\\nF\", \"igure 4-3. Choose the project's web assembly.\\n\\nx\\nv \\u00a9 Search bin P\\n1 @\\nDate modified Type Size\\n10/25/\", \"2020 6:05 PM File folder\\n9/10/2013 4:29 PM Application extens...\\n2/18/2019 12:35 PM Application exte\", \"ns...\\n4/10/2017 3:40 PM Application extens...\\n10/23/2017 1:15 PM Application extens...\\n10/23/2017 1:\", \"15 PM Application extens...\\n10/25/2020 6:05 PM Application extens...\\n3/8/2017 7:26 PM Application ex\", \"tens...\\n6/27/2017 12:59 PM Application extens...\\n2/7/2019 1:42 AM Application extens...\\n2/7/2019 1:4\", \"4 AM Application extens...\\nv\\n>\\nAssembly Files (*.exe;*.dll) v\\n\\nIf your solution includes several pro\", \"jects, you can choose all of them. The eShop sample includes just a\\n\\nsingle MVC project.\\n\\nOnce the r\", \"eport is generated, open the file and review the results. The summary provides a high-level\\nview of \", \"what percentage of .NET Framework calls your app is making have compatible versions. Figure\\n4-4 show\", \"s the summary for the eShop MVC project.\\n\\nRo:\\n\\nHome Insert\\n\\n*]\\n\\n5 Target Framework\\nte .NETFramework,\", \"Version=v4.7.2\\n\\nFigure 4-4. ApiPort summary.\\n\\nPage Layout\\n\\n7d9637ec-b1a8-4808-8e19-59fdc4ecb3ea\\n\\nApi\", \"PortAnalysis.xlsx - Excel\\n\\nFormulas Data Review View Help Load Test\\n\\n80.59\\n\\nQ Tell me what you want \", \"to do\\n\\nsae .NET Core + Platform Extensions, Version=v3.1,.NET Core,Version=v3.1,.NET Standard + Plat\", \"form Extensions,Version=v2.0\\n\\nBd .NET Core + Platform Extensions,Version=v3.1 [MJ .NET Core,Version=\", \"v3.1 [MJ .NET Standard + Platform Extensions,Version=v2.0 [J\\n\\nFor this app, about 80 percent of the \", \".NET Framework calls are compatible. 20 percent of the calls\\nneed to be addressed during the porting\", \" process. Viewing the details reveals that all of the\\nincompatible calls are part of System.Web, whi\", \"ch is an expected incompatibility. The dependencies on\\nSystem.Web calls will be addressed when the a\", \"pp\\u2019s controllers and related classes are migrated in a\\nlater step. Figure 4-5 lists some of the spec\", \"ific types found by the tool:\\n\\n46\\n\\nCHAPTER 4 | Example migration of eShop to ASP.NET Core\\nTarget typ\", \"e\\nT:System.Web.Mvc.UrlParameter\\nT:System.Web.Mvc.UrlParameter\\nT:System.Web.HttpApplication\\nT:System.\", \"Web.HttpApplication\\nT:System.Web.Mvc.HttpNotFoundResult\\nT:System.Web.Mvc.Controller\\nT:System.Web.Mvc\", \".Controller\\nT:System.Web.Mvc.Controller\\nT:System.Web.Mvc.Controller\\nT:System.Web.Mvc.Controller\\nT:Sy\", \"stem.Web.Mvc.Controller\\nT:System.Web.Mvc.Controller\\nT:System.Web.Mvc.Controller\\nT:System.Web.Mvc.Con\", \"troller\\nT:System.Web.Mvc.Controller\\nT:System.Web.Mvc.Controller\\nT:System.Web.Mvc.ActionNameAttribute\", \"\\nT:System.Web.Mvc.ActionNameAttribute\\nT:System.Web.HttpContext\\nT:System.Web.HttpContext\\nT:System.Web\", \".HttpContext\\nT:System.Web.HttpContext\\nT:System.Web.Mvc.HandleErrorAttribute\\nT:System.Web.Mvc.HandleE\", \"rrorAttribute\\nT:System.Web.Mvc.HttpGetAttribute\\nT:System.Web.Mvc.HttpGetAttribute\\n\\nBad Target member\", \" Bd Assembly Name | |\\n\\nT:System.Web.Mvc.UrlParameter eShopLegacyMVC\\nF:System.Web.Mvc.UrlParameter.Op\", \"tional eShopLegacyMVC\\nT:System.Web.HttpApplication eShopLegacyMVC\\nM:System.Web.HttpApplication.#ctor\", \" eShopLegacyMVC\\nT:System.Web.Mvc.HttpNotFoundResult eShopLegacyMVC\\nT:System.Web.Mvc.Controller eShop\", \"LegacyMVC\\nM:System.Web.Mvc.Controller.#ctor eShopLegacyMVC\\n\\nM:System.Web.Mvc.Controller.Dispose(Syst\", \"em.Bo eShopLegacyMVC\\nM:System.Web.Mvc.Controller.File(System.Byte[],: eShopLegacyMVC\\nM:System.Web.Mv\", \"e.Controller.get_ModelState eShopLegacyMVC\\n\\nM:System.Web.Mvc.Controller.get_Request eShopLegacyMVC\\nM\", \":System.Web.Mvc.Controller.get_Server eShopLegacyMVC\\nM:System.Web.Mvc.Controller.get_Url eShopLegacy\", \"MVC\\n\\nM:System.Web.Mvc.Controller.HttpNotFound eShopLegacyMVC\\nM:System.Web.Mvc.Controller.RedirectToA\", \"ction(S eShopLegacyMVC\\nM:System.Web.Mvc.Controller.View(System.Objec eShopLegacyMVC\\n\\nT:System.Web.Mv\", \"c.ActionNameAttribute eShopLegacyMVC\\nM:System.Web.Mvc.ActionNameAttribute.#ctor(S\\\\ eShopLegacyMVC\\nT:\", \"System.Web.HttpContext eShopLegacyMVC\\nM:System.Web.HttpContext.get_Current eShopLegacyMVC\\nM:System.W\", \"eb.HttpContext.get_Request eShopLegacyMVC\\nM:System.Web.HttpContext.get_Session eShopLegacyMVC\\nT:Syst\", \"em.Web.Mvc.HandleErrorAttribute eShopLegacyMVC\\nM:System.Web.Mvc.HandleErrorAttribute.#ctor eShopLega\", \"cyMVC\\nT:System.Web.Mvc.HttpGetAttribute eShopLegacyMVC\\nM:System.Web.Mvc.HttpGetAttribute.#ctor eShop\", \"LegacyMVC\\n\\nFigure 4-5. ApiPort incompatible type details.\\n\\nMost of the incompatible types refer to C\", \"ontroller and various related attributes that have equivalents\\n\\nin ASP.NET Core.\\n\\nUpdate project fil\", \"es and NuGet reference syntax\\n\\nNext, migrate from the older .csproj file structure to the newer, sim\", \"pler structure introduced with .NET\\nCore. In doing so, you'll also migrate from using a packages.con\", \"fig file for NuGet references to using\\n<PackageReference> elements in the project file. Old-style pr\", \"oject files may also use\\n<PackageReference> elements, so it usually makes sense to migrate all NuGet\", \" package references to\\n\\nthis format first, before upgrading to the new project file format.\\n\\nThe ori\", \"ginal project's eShopLegacyMVC.csproj file is 418 lines long. A sample of the project file is\\nshown \", \"in Figure 4-6. To offer a sense of its overall size and complexity, the right side of the image\\n\\ncon\", \"tains a miniature view of the entire file.\\n\\n47\\n\\nCHAPTER 4 | Example migration of eShop to ASP.NET Co\", \"re\\n\\u00bb eShopLegacyMVC.csproj X\\n\\n\\u00ae eShopLegacyMVC.cspr\\n\\n=\\\"1.0\\\" encor g=\\\"utf-8\\\"\\n\\n\\u2018 ion=\\\"15.6\\\" DefaultTar\", \"gets=\\\"Build\\\" xmlns=\\\"http://schemas.microsoft.com/developer/msbuild/2006\\n=\\\"._.\\\\..\\\\packages\\\\Microsoft.\", \"CodeDom.Providers.DotNetCompilerPlatform.2.0@.1\\\\build\\\\net46\\\\Micros\\u00ab\\n=\\\",.\\\\..\\\\packages\\\\Microsoft.Net.C\", \"ompilers.2.10.0\\\\build\\\\Microsoft.Net.Compilers.props\\\" C\\n\\nject=\\\"$(MSBuildExtensionsPath32) \\\\Microsoft\\\\\", \"VisualStudio\\\\v$(VisualStudioVersion) \\\\TypeScript\\\\Micro\\n\\nject=\\\"$(MSBuildExtensionsPath) \\\\$(MSBuildToo\", \"lsVersion)\\\\Microsoft.Common.props\\\" Condition=\\\"Exists(\\n\\nlition=\\\"_ \\u2018'$(Configuration)|$(Platform)' == \", \"'Debug|AnycPuU' \\\"\\n\\nition=\\\"_ '$(Configuration) |$(Platform)' == 'Release|AnyCPU' \\\"\\n\\n\\u201cApp_Start\\\\Bundle\", \"Config.cs\\\"\\n\\n\\\"App Start\\\\FilterConfig.cs\\\"\\n\\u201cApp_Start\\\\RouteConfig.cs\\\"\\n\\\"Controllers\\\\PicController.cs\\\"\\n\\\"M\", \"odels\\\\Infrastructure\\\\CatalogDBInitializer.cs\\\"\\n\\\"Models\\\\CatalogItemHiLoGenerator.cs\\\"\\n\\\"\\u201cControllers\\\\Cat\", \"alogController.cs\\\"\\n\\\"Global.asax.cs\\\"\\n\\nGlobal.asax\\n\\n\\\"Models\\\\CatalogBrand.cs\\\"\\n\\u201cModels\\\\CatalogDBContext.\", \"cs\\\"\\n\\\"Models\\\\CatalogItem.cs\\\"\\n\\\"Models\\\\CatalogType.cs\\\"\\n\\n\\u201cModels\\\\Infrastructure\\\\PreconfiguredData.cs\\\"\\n\\nF\", \"igure 4-6. The eShopLegacyMVC.csproj file structure.\\n\\nA common way to create a new project file for \", \"an existing ASP.NET project is to create a new ASP.NET\\nCore app using dotnet new or File > New > Pro\", \"ject in Visual Studio. Then files can be copied from\\nthe old project to the new one to complete the \", \"migration.\\n\\nIn addition to the C# project file, NuGet dependencies are stored in a separate 45-line \", \"packages.config\\nfile, as shown in Figure 4-7.\\n\\n48 CHAPTER 4 | Example migration of eShop to ASP.NET \", \"Core\\npackages.config X\\n\\n1opLegacyMV ges.\\n\\nxml version= encoding=\\npackages\\n\\npackage id= version= targ\", \"etFramework=\\npackage id= version= targetFramework=\\npackage id= version= targetFramework=\\npackage id=\", \" version= targetFramework=\\npackage id= version= targetFramework=\\npackage id= version= targetFramewor\", \"k=\\npackage id= version= targetFramework=\\npackage id= version= targetFramework=\\npackage version= targ\", \"etFramework=\\npackage i version= targetFramework=\\npackage version= targetFramework=\\npackage version= \", \"targetFramework=\\npackage i version targetFramework\\npackage version= targetFramework=\\npackage id= ver\", \"sion= targetFramework=\\npackage i version targetFramework\\npackage id= version= targetFramework=\\npacka\", \"ge id= version= targetFramework=\\npackage version= targetFramework=\\npackage version= targetFramework=\", \"\\npackage i version= targetFramework=\\npackage version= targetFramework=\\npackage version= targetFramew\", \"ork=\\npackage version= targetFramework= developmentDependency=\\npackage version= targetFramework=\\npack\", \"age version= targetFramework=\\npackage version= targetFramework=\\npackage version= targetFramework=\\npa\", \"ckage i version targetFramework\\npackage version= targetFramework=\\npackage version= targetFramework=\\n\", \"package i version targetFramework\\npackage version= targetFramework=\\npackage version= targetFramework\", \"=\\n\\npackage version= targetFramework=\\n\\nFigure 4-7. The packages.config file.\\n\\nYou can migrate package\", \"s.config in class library projects using Visual Studio. This functionality doesn't\\nwork with ASP.NET\", \" projects, however.\\n<PackageReference> . If you have a large number of projects to migrate,\\n\\n. If yo\", \"u're using a tool to migrate the project file to the new format, you\\nshould do that after you've fin\", \"ished migrating all NuGet references to use <PackageReference>.\\n\\nAdd a new ASP.NET Core project to t\", \"he existing app\\u2019s solution to make moving files easier, as most of\\nthe work can be done from within \", \"Visual Studio's Solution Explorer. In Visual Studio, right-click on\\nyour app\\u2019s solution and choose A\", \"dd New Project. Choose ASP.NET Core web application, and give\\nthe new project a name as shown in Fig\", \"ure 4-8.\\nConfigure your new project\\n\\nASP.NET Core Web Application Ge Linux macOS Windows Cloud Servi\", \"ce Web\\nProject name\\neShopPorted\\n\\nLocation\\n\\nC:\\\\dev\\\\GitHub\\\\eShopModernizing\\\\eShopLegacyMVCSolution\\n\\nCr\", \"eate\\n\\nFigure 4-8. Add new ASP.NET Core web application.\\n\\nThe next dialog will ask you to choose whic\", \"h template to use. Select the Empty template. Be sure to\\nalso change the dropdown from .NET Core to \", \".NET Framework. Select ASP.NET Core 2.2, as shown\\nIn Figure 4-9.\\nCreate a new ASP.NET Core web appli\", \"cation\\n\\n\\u00abNET Framework ~ ASP.NET Core 2.2 -|\\n1 Empty Authentication\\n\\nAn empty project template for c\", \"reating an ASP.NET Core application. This template does not have any content in No Authentication\\nit\", \"\\n\\nA project template for creating an ASP.NET Core application with an example Controller for a RESTf\", \"ul HTTP service.\\nThis template can also be used for ASP.NET Core MVC Views and Controllers.\\n\\nAdvance\", \"d\\n\\nWeb Application |\\u00a5| Configure for HTTPS\\n\\nA project template for creating an ASP.NET Core applicat\", \"ion with example ASP.NET Core Razor Pages content.\\n\\nWeb Application (Model-View-Controller)\\n\\nA proje\", \"ct template for creating an ASP.NET Core application with example ASP.NET Core MVC Views and\\nControl\", \"lers. This template can also be used for RESTful HTTP services.\\n\\nA Angular\\nA project template for cr\", \"eating an ASP.NET Core application with Angular.\\ndep React.js Author: Microsoft\\nSource: Templates\\n\\nG\", \"et additional project templates\\n\\nFigure 4-9. Choose an Empty project template targeting .NET Framewo\", \"rk with ASP.NET Core 2.2.\\n\\nSince the built-in migration tool for migrating packages.config to <Packa\", \"geReference> doesn\\u2019t work\\non ASP.NET projects, you can use a community tool instead, or migrate by h\", \"and. A\\n\\nuses an XSL file to transform from one format to the other. To use it, first copy the\\npackag\", \"es.config file to the newly created ASP.NET Core project folder. Make a backup of your files, as\\nthi\", \"s script removes the packages.config file from all folders under where you run the script. Then run\\n\", \"these commands from the project folder (or for the entire solution if you prefer):\\niwr\\nhttps://gist.\", \"githubusercontent.com/aienabled/@bce5e4b17118122F2772e7c9218bf9C/raw/7789\\n53f89882877a7124894b47dccf\", \"b1ba3e80ae/Convert-ToPackageReference.psi1 -OutFile Convert-\\nToPackageReference.ps1\\niwr\\nhttps://gist\", \".githubusercontent.com/aienabled/@bce5e4b17118122F2772e7c9218bf9C/raw/7789\\n5389882877a7124894b47dccf\", \"b1ba3e80ae0/Convert-ToPackageReference.xsl -OutFile Convert-\\n\\nToPackageReference. xsl\\n./Convert-ToPa\", \"ckageReference.ps1 | Out-Null\\n\\nThe first two commands download files so that they exist locally. The\", \" last line runs the script. After\\nrunning it, try to build the new project. You'll most likely get s\", \"ome errors. To resolve them, you'll want\\nto eliminate some references (like most of the Microsoft.As\", \"pNet and System packages), and you may\\nneed to remove some xmlins attributes.\\nIn most ASP.NET MVC ap\", \"ps, many client-side dependencies like Bootstrap and jQuery were deployed\\nusing NuGet packages. In A\", \"SP.NET Core, NuGet packages are only used for server-side functionality.\\nClient files should be mana\", \"ged through other means. Review the list of <PackageReference>\\nelements added and remove and make no\", \"te of any that are for client libraries, including:\\n\\n\\u00b0 Bootstrap\\n\\n\\u00a2 JQuery\\n\\n\\u00a2  JQuery.Validation\\n\\u00b0 M\", \"odernizr\\n\\n\\u00b0 popper.js\\n\\n. Respond\\n\\nThe static client files installed by NuGet for these packages will\", \" be copied over to the new project's\\nwwwroot folder and hosted from there. It\\u2019s worth considering wh\", \"ether these files are still needed by\\nthe app, and whether it makes sense to continue hosting them o\", \"r to use a content delivery network\\n(CDN) instead. These library versions can be managed at build ti\", \"me using tools like or\\nFigure 4-10 shows the full eShopPorted.csproj file after migrating package re\", \"ferences using the\\nconversion tool shown and removing unnecessary packages.\\n\\nProject Sdk=\\nPropertyGr\", \"oup\\nTargetFramework>net461</TargetFramework\\nPropertyGroup\\nItemGroup\\nPackageReference Include=\\\"Micr t\", \".AspNet \\\" Version=\\nPackageReference Include=\\nVersion>3.5.@.2</Version\\nPackageReference\\nPackageRefere\", \"nce Include=\\nVersion>4.9.1</Version\\nPackageReference\\nPackageReference Include=\\nVersion>4.@.2</Versio\", \"n\\nPackageReference\\nPackageReference Include=\\nVersion>6.2.0</Version\\nPackageReference\\nPackageReferenc\", \"e Include=\\nVersion>2.@.8</Version\\n\\nPackageReference\\n\\nPackageReference Include=\\n\\nVersion>12.0.1</Vers\", \"ion\\nPackageReference\\nPackageReference Include=\\n\\nVersion>1.6.@</Version\\n\\nPackageReference\\n\\nItemGroup\\n\", \"\\nProject\\nFigure 4-10. Package references in the eShopPorted.csproj file.\\n\\nThe package references can\", \" be further compacted by making the <Version>1.0.0.0</Version>\\nelement a Version=1.0.0.0 attribute o\", \"n <PackageReference>.\\nMigrate static files\\n\\nAny static files the app uses, including third-party scr\", \"ipts and frameworks but also custom images and\\nstylesheets, must be copied from the old project to t\", \"he new one. In ASP.NET MVC apps, files were\\ntypically accessed based on their location within the pr\", \"oject folder. In ASP.NET Core apps, these static\\nfiles will be accessed based on their location with\", \"in the wwwroot folder. For the eShop project, there\\nare Static files in the following folders:\\n\\n\\u00b0 Co\", \"ntent\\n. fonts\\n\\n\\u00b0 Images\\n. Pics\\n\\n\\u00b0 Scripts\\n\\nThe Empty project template used in the previous step does\", \"n't include this folder by default, or the\\nmiddleware needed for it to work. You'll need to add them\", \".\\n\\nAdd a wwwroot folder to the root of the project.\\n\\nAdd version 2.2.0 of the Microsoft.AspNetCore.S\", \"taticFiles NuGet package.\\n\\nIn Startup.cs, add a call to app.UseStaticFiles() in the Configure method\", \":\\n\\npublic void Configure(IApplicationBuilder app, IHostingEnvironment env)\\na (env. IsDevelopment () \", \")\\n\\n}\\n\\napp.UseDeveloperExceptionPage() ;\\n\\napp.UseStaticFiles();\\n\\nHi coc\\n\\nCopy the Content folder from\", \" the ASP.NET MVC app to the new project's wwwroot folder.\\n\\nRun the app and navigate to its /Content/\", \"base.css folder to verify that the static file is served correctly\\nfrom its expected path. Continue \", \"copying the rest of the folders containing static files to the new\\nproject. You'll also want to copy\", \" the favicon.ico file from the project's root to the wwwroot folder.\\nFigure 4-11 shows the results a\", \"fter these files and their folders have all been copied.\\n\\n53 CHAPTER 4 | Example migration of eShop \", \"to ASP.NET Core\\nF bel eShopPorted\\n> cy Connected Services\\n>b = a! Dependencies\\n>b Ga] Properties\\na8 \", \"ma) wWwroot\\n>b 4) Content\\n>b 4) fonts\\n> 81 Images\\nb AL Pics\\n> A Scripts\\n\\nA favicon.ico\\n&() Controlle\", \"rs\\n4) Migrations\\n8) Models\\n8] Modules\\nA) Services\\n4) ViewModel\\nA) Views\\nBal app.contig\\n8 [ii] appset\", \"tings.json\\n> AC# Program.cs\\nb AC# Startup.cs\\n\\nSF SF Fr wr Ww\\n\\na\\n\\nFigure 4-11. Static folders copied \", \"over to wwwroot folder.\\n\\nMigrate C# files\\n\\nNext, copy over the C# files used by the app, including s\", \"tandard MVC folders and their contents like\\nControllers, Models, ViewModel, and Services. There will\", \" most likely be some changes needed in these\\nfiles. It's best to copy one folder (or subfolder) at a\", \" time and compile to see what errors need to be\\naddressed as you go.\\n\\nFor the eShop sample, the firs\", \"t folder | choose to migrate is the Models folder, which includes C#\\nentities and Entity Framework c\", \"lasses. This folder\\u2019s classes are used by most of the others, so they\\nwon't work until these classes\", \" have been copied. After copying the folder and building, the compiler\\nrevealed errors related to mi\", \"ssing namespace System.Web.Hosting, related access to\\nHostingEnvironment, and a reference to Configu\", \"rationManager.AppSettings. The solution to these\\nissues will be to pass in the necessary path data; \", \"for now the breaking lines are commented out and a\\nTODO: comment is added to each one to track it. A\", \"fter changing five lines, the Task List shows five\\nitems and the project builds.\\n\\nNext, the ViewMode\", \"l folder, with its one class, is copied over. It\\u2019s an easy one, and builds immediately.\\n\\nThe Service\", \"s folder is copied over. This folder\\u2019s classes depend on Entity Framework classes from the\\nModels fo\", \"lder, which is why it needed to be copied after that folder. Fortunately, it too builds without\\nerro\", \"rs.\\n\\n54 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\nThat leaves the Controllers folder an\", \"d its two Controller classes. After copying the folder to the new\\nproject and building, there are se\", \"ven build errors. Four of them are related to ViewBag access and\\nreport an error of:\\n\\nMissing compil\", \"er required member 'Microsoft.CSharp.RuntimeBinder.CSharpArgumentinfo.Create\\u2019\\n\\nTo resolve this error\", \", add a NuGet package reference to C#:\\n\\n<PackageReference Include=\\\"Microsoft.CSharp\\\" Version=\\\"4.7.0\\\"\", \" />\\n\\nThe remaining three errors specify types that are defined in an assembly that isn't referenced.\", \"\\nSpecifically these types:\\n\\n. HttpServerUtilityBase\\n. RouteValueDictionary\\n\\n\\u00b0 HttpRequestBase\\n\\nLet's\", \" look at each error one by one. The first error occurs while trying to reference the Server property\", \"\\nof Controller, which no longer exists. The goal of the operation is to get the path to an image fil\", \"e in\\nthe app:\\n\\nif (item != null)\\n\\n{\\nvar webRoot = Server.MapPath(\\\"~/Pics\\\"); // compiler error on thi\", \"s line\\nvar path = Path.Combine(webRoot, item.PictureFileName) ;\\n\\nstring imageFileExtension = Path.Ge\", \"tExtension(item.PictureFileName) ;\\n\\nstring mimetype = GetImageMimeTypeFromImageFileExtension(imageFi\", \"leExtension) ;\\nvar buffer = System.1I0.File.ReadAl1Bytes (path) ;\\n\\nreturn File(buffer, mimetype) ;\\n\\n\", \"There are two possible solutions to this problem. The first is to keep the functionality as it is. I\", \"n this\\ncase, rather than using Server.MapPath, a fixed path referencing the image files\\u2019 location in\", \" wwwroot\\nshould be used. Alternately, since the only purpose of this action method is to return a st\", \"atic image\\nfile, the references to this action in view files can be updated to reference the static \", \"files directly, which\\nimproves runtime performance. Since no processing is being done as part of thi\", \"s action, there\\u2019s no\\nreason not to just serve the files directly. If it's not tenable to update all \", \"references to this action, the\\naction could be rewritten to produce a redirect to the static file\\u2019s \", \"location.\\n\\nThe next two errors both occur in the same private method in the same line of code:\\n\\npriv\", \"ate void AddUriPlaceHolder(CatalogItem item)\\n{\\n\\nitem.PictureUri = this.Url.RouteUrl(PicController.Ge\", \"tPicRouteName, new { catalogItemId\\n\\n= item.Id }, this.Request.Url.Scheme) ;\\n}\\n\\nBoth this.Url and thi\", \"s.Request cause compiler errors. Looking at how this code is used, its purpose is\\nto build a link to\", \" the PicController action that renders image files. The same one we just discovered\\ncould probably b\", \"e replaced with direct links to the static files located in wwwroot. For now, it\\u2019s worth\\ncommenting \", \"out this code and adding a TODO: comment to reference the pics another way.\\n\\n55 CHAPTER 4 | Example \", \"migration of eShop to ASP.NET Core\\nIt's worth noting that the base Controller class, used by the Cat\", \"alogController class in which this code\\nappears, is still referring to System.Web.Mvc.Controller. Th\", \"ere will undoubtedly be more errors to fix\\nonce we update this to use ASP.NET Core. First, remove th\", \"e using System.Web.Mvc; line from the list\\nof using statements in CatalogController. Next, add the N\", \"uGet package Microsoft.AspoNetCore.Mvc.\\nFinally, add a using Microsoft.AsoNetCore.Mvc; statement, an\", \"d build the app again.\\n\\nThis time, there are 16 errors:\\n\\n\\u00b0 Include is not a valid named attribute ar\", \"gument (2)\\n\\u00b0 HttpStatusCodeResult not found (3)\\n\\n\\u00b0 HttpNotFound does not exist (3)\\n\\n\\u00b0 SelectList not\", \" found (8)\\n\\nOnce more, let's review these errors one by one. First, SelectList can be fixed by addin\", \"g using\\nMicrosoft.AsoNetCore.Mvc.Rendering;, which eliminates half of the errors.\\n\\nAll references to\", \" return HttpNotFound(); should be replaced with return NotFound();.\\n\\nAll references to return new Ht\", \"tpStatusCodeResult(HttpStatusCode.BadRequest); should be replaced\\nwith return BadRequest();.\\n\\nThat j\", \"ust leaves the use of Include with a [Bind] attribute on a couple of action methods that look like\\nt\", \"his:\\n\\n[HttpPost ]\\n[ValidateAntiForgeryToken |\\npublic ActionResult Create([Bind(Include =\\n\\n\\\"Id,Name, \", \"Description, Price, PictureFileName, CatalogTypelId, CatalogBrandId, AvailableStock, Rest\\nockThresho\", \"ld,MaxStockThreshold,OnReorder\\\") |] CatalogItem catalogIitem)\\n\\n{\\n\\nThe preceding code restricts model\", \" binding to the properties listed in the Include string. In ASP.NET\\nCore MVC, the [Bind] attribute s\", \"till exists, but no longer needs the Include = argument. Pass the list of\\nproperties directly to the\", \" [Bind] attribute:\\n\\n[HttpPost ]\\n[ValidateAntiForgeryToken |\\npublic ActionResult\\n\\nCreate([Bind(\\\"Id,Na\", \"me, Description, Price, PictureFileName, CatalogTypeld, CatalogBrandId,Availa\\nbleStock,RestockThresh\", \"old,MaxStockThreshold,OnReorder\\\")] CatalogItem catalogItem)\\n\\n{\\n\\nWith these changes, the project comp\", \"iles once more. It's generally a better practice to use separate\\nmodel types for controller inputs, \", \"rather than using model binding directly to your domain model or\\ndata model types.\\n\\nMigrate views\\n\\nT\", \"he two biggest ASP.NET Core MVC features related to views are Razor Pages and Tag Helpers. For\\nthe i\", \"nitial migration, we won't use either feature. You should, however, keep the features in mind if\\nyou\", \" continue supporting the app once it\\u2019s been migrated. The next step is to copy the Views folder\\nfrom\", \" the original project into the new one. After building, there are nine errors:\\n\\n56 CHAPTER 4 | Examp\", \"le migration of eShop to ASP.NET Core\\n\\u00b0 HttpContext does not exist (2)\\n\\u00b0 Scripts does not exist (5)\\n\", \"\\u00b0 Styles does not exist (1)\\n\\u00b0 HtmlString could not be found(1)\\nInvestigating these errors finds that\", \" most of them are in the main *_Layout.cshtml, with several related\\n\\nto rendering script and style t\", \"ags, or displaying when the server hosting the app was last restarted. The\\nfollowing code listing sh\", \"ows problem areas in the _Layout.cshtmI* file:\\n\\n// other lines omitted; only errors shown\\n@Styles.Re\", \"nder(\\\"~/Content/css\\\")\\n@Scripts.Render(\\\"~/bundles/modernizr\\\" )\\n\\n@{ var sessionInfo = new HtmlString($\", \"\\\"{HttpContext.Current.Session[ \\\"MachineName\\\" ]},\\n{HttpContext.Current.Session[ \\\"SessionStartTime\\\" | \", \"}\\\") ;}\\n\\n@Scripts.Render(\\\"~/bundles/jquery\\u201d\\\" )\\n@Scripts.Render(\\\"~/bundles/bootstrap\\\" )\\n\\nThe reference\", \" to Modernizr can be removed. The references to Bootstrap and jQuery can be replaced\\nwith CDN links \", \"to the appropriate version.\\n\\nReplace @Styles.Render line with:\\n\\n<link rel=\\\"stylesheet\\\"\\nhref=\\\"https:/\", \"/stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\\\"\\nintegrity=\\\"sha384-gg0yROiXCbMQv3X\", \"ipma34MD+dH/1fQ784/j6cY/iIJTQUOhcWr7x9IVORXT2MZw1T\\\"\\ncrossorigin=\\\"anonymous\\\" >\\n\\nReplace the last two \", \"Scripts.Render lines with:\\n\\n<script src=\\\"https://code. jquery.com/jquery-3.3.1.slim.min.js\\\" integrit\", \"y=\\\"sha384-\\nq8i/X+965Dz00rT7abK41IStQIAGVgRVzpbzo5smxXKp4YFRvH+8abtTE1Pi6jizo\\\"\\ncrossorigin=\\\"anonymous\", \"\\\" ></script>\\n\\n<script src=\\\"https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min. j\", \"s\\\"\\nintegrity=\\\"sha384-U02eTO@CpHqdSJQ6hIty5KVphtPhzwWj9WO1c LHTMGa3IDZwrnQq4sF86dIHNDzeW1\\\"\\ncrossorigi\", \"n=\\\"anonymous\\\" ></script>\\n\\n<script src=\\\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstr\", \"ap.min.js\\\"\\nintegrity=\\\"sha384-JjSmVgyd@p3pXB1rRibZUAYoIlLy60rQ6VrjIEaFF/nJIGZIxFDsf4xOxIM+BQ@7 jRM\\\"\\nc\", \"rossorigin=\\\"anonymous\\\" ></script>\\n\\nFinally, after the Bootstrap <link>, add additional <link> elemen\", \"ts for local styles your app uses. For\\neShop, the result is shown here:\\n\\n<link rel=\\\"stylesheet\\\" href\", \"=\\\"~/Content/custom.css\\\" />\\n<link rel=\\\"stylesheet\\\" href=\\\"~/Content/base.css\\\" />\\n<link rel=\\\"stylesheet\", \"\\\" href=\\\"~/Content/Site.css\\\" />\\n\\nTo determine the order in which the <link> elements should appear, l\", \"ook at your original app\\u2019s\\nrendered HTML. Alternatively, review BundleConfig.cs, which for the eShop\", \" sample includes this code\\nindicating the appropriate sequence:\\n\\nbundles.Add(new StyleBundle(\\\"~/Cont\", \"ent/css\\\") .Include(\\n\\\"~/Content/bootstrap.css\\\",\\n\\\"~/Content/custom.css\\\",\\n\\n57 CHAPTER 4 | Example migra\", \"tion of eShop to ASP.NET Core\\n\\\"~/Content/base.css\\\",\\n\\\"~/Content/site.css\\\"));\\n\\nBuilding again reveals \", \"one more error loading jQuery Validation on the Create and Edit views. Replace\\nit with this script:\\n\", \"\\n<script src=\\\"https://cdnjs.cloudflare.com/ajax/libs/jquery-\\nvalidate/1.17.0/jquery.validate.min.js\\\"\", \" integrity=\\\"sha512-\\n\\nO/nUTF 5mdFkKhEoQHFn9ONSwmgYyW323I06v8kr6l1tSRKriZyTr/8417taVWeabVS4i0NGK2V444Q\", \"D@P2cwhuTkg==\\\"\\ncrossorigin=\\\"anonymous\\\" ></script>\\n\\nThe last thing to fix in the views is the referen\", \"ce to Session to display how long the app has been\\nrunning, and on which machine. We can display thi\", \"s data directly in the site's *_Layout.cshtml* by\\nusing System.Environment.MachineName and\\nSystem.Di\", \"agnostics.Process.GetCurrentProcess().StartTime:\\n\\n<section class=\\\"col-sm-6\\\">\\n<img class=\\\"esh-app-foo\", \"ter-text hidden-xs\\\" src=\\\"~/images/main_footer_text.png\\\"\\nwidth=\\\"335\\\" height=\\\"26\\\" alt=\\\"footer text ima\", \"ge\\\" />\\n\\n<br />\\n<small>@Environment.MachineName -\\n@System.Diagnostics.Process.GetCurrentProcess().Sta\", \"rtTime. ToString() UTC</small>\\n</section>\\n\\nAt this point, the app once more builds successfully. How\", \"ever, trying to run it just yields Hello World!\\nbecause the Empty ASP.NET Core template is only conf\", \"igured to display that in response to any\\nrequest. In the next section, | complete the migration by \", \"configuring the app to use ASP.NET Core\\nMVC, including dependency injection and configuration. Once \", \"that\\u2019s in place, the app should run.\\nThen it will be time to fix the TODO: tasks that were created e\", \"arlier.\\n\\nMigrate app startup components\\n\\nThe last migration step is to take the app startup tasks fr\", \"om Global.asax, and the classes it calls, and\\nmigrate these to their ASP.NET Core equivalents. These\", \" tasks include configuration of MVC itself,\\nsetting up dependency injection, and working with the ne\", \"w configuration system. In ASP.NET Core,\\nthese tasks are handled in the Startup.cs file.\\n\\nConfigure \", \"MVC\\n\\nThe original ASP.NET MVC app has the following code in its Application_Start in Global.asax, wh\", \"ich\\nruns when the app starts up:\\n\\nprotected void Application Start()\\n\\n{\\ncontainer = RegisterContaine\", \"r() ;\\nAreaRegistration.RegisterAllAreas() ;\\nFilterConfig.RegisterGlobalFilters(GlobalFilters.Filters\", \") ;\\n\\nRouteConfig.RegisterRoutes (RouteTable. Routes) ;\\nBundleConfig.RegisterBundles(BundleTable. Bun\", \"dles) ;\\nConfigDataBase() ;\\n\\n58 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\nLooking at the\", \"se lines one by one, the RegisterContainer method sets up dependency injection, which\\nwill be ported\", \" below. The next three lines configure different parts of MVC: areas, filters, and routes.\\nBundles a\", \"re replaced by static files in the ported app. The last line sets up data access for the app,\\nwhich \", \"will be shown in a later section.\\n\\nSince this app isn't actually using areas, there\\u2019s nothing that n\", \"eeds to be done to migrate the area\\nregistration call. If your app does need to migrate areas, the d\", \"ocs specify how to configure areas in\\nASP.NET Core.\\n\\nThe call to register global filters invokes a h\", \"elper on the FilterConfig class in the app\\u2019s App_Start\\nfolder:\\n\\npublic static void RegisterGlobalFil\", \"ters(GlobalFilterCollection filters)\\n{\\n\\nfilters.Add(new HandleErrorAttribute() ) ;\\n}\\n\\nThe only attri\", \"bute added to the app is the ASP.NET MVC filter, HandleErrorAttribute. This filter ensures\\nthat when\", \" an exception occurs as part of a request, a default action and view are displayed, rather\\nthan the \", \"exception details. In ASP.NET Core, this same functionality is performed by the\\nUseExceptionHandler \", \"middleware. The detailed error messages aren't enabled by default. They must\\nbe configured using the\", \" UseDeveloperExceptionPage middleware. To configure this behavior to match\\nthe original app, the fol\", \"lowing code must be added to the start of the Configure method in Startup.cs:\\n\\npublic void Configure\", \"(IApplicationBuilder app, IwWebHostEnvironment env)\\n\\nt\\nif (env.IsDevelopment() )\\n\\nt\\n}\\n\\nelse\\n\\n{\\n\\napp.\", \"UseDeveloperExceptionPage() ;\\n\\napp.UseExceptionHandler(\\\"/Error\\\") ;\\n\\nHi coc\\n\\nThis takes care of the o\", \"nly filter used by the eShop app, and in this case it was done by using built-in\\nmiddleware. If you \", \"have global filters that must be configured in your app, this is done when MVC is\\nadded in Program.c\", \"s when you configure services, which is shown later in this chapter.\\n\\nThe last piece of MVC-related \", \"logic that needs to be migrated are the app\\u2019s default routes. The call to\\nRouteConfig.RegisterRoutes\", \"(RouteTable.Routes) passes the MVC route table to the RegisterRoutes\\nhelper method, where the follow\", \"ing code is executed when the app starts up:\\n\\npublic static void RegisterRoutes(RouteCollection rout\", \"es)\\n\\n{\\n\\nroutes .MapMvcAttributeRoutes() ;\\nroutes .IgnoreRoute(\\\"{resource}.axd/{*pathInfo}\\\") ;\\n\\nroute\", \"s .MapRoute(\\nname: \\\"Default\\\",\\nurl: \\\"{controller}/{action}/{id}\\\",\\ndefaults: new { controller = \\\"Catal\", \"og\\\", action = \\\"Index\\\", id =\\nUrlParameter.Optional }\\n\\n59 CHAPTER 4 | Example migration of eShop to AS\", \"P.NET Core\\n)3\\n}\\nTaking this code line-by-line, the first line sets up support for attribute routes. \", \"This is built into\\nASP.NET Core, so it's unnecessary to configure it separately. Likewise, {resource\", \"}.axd files aren't used\\nwith ASP.NET Core, so there\\u2019s no need to ignore such routes. The MapRoute me\", \"thod configures the\\ndefault for MVC, which uses the typical {controller}/{action}/{id} route templat\", \"e. It also specifies the\\ndefaults for this template, such that the CatalogController is the default \", \"controller used and the Index\\nmethod is the default action. Larger apps will frequently include more\", \" calls to MapRoute to set up\\nadditional routes.\\n\\nASP.NET Core MVC supports conventional routing and \", \"attribute routing. Conventional routing Is\\nanalogous to how the route table is configured in the Reg\", \"isterRoutes method listed previously. To set\\nup conventional routing with a default route like the o\", \"ne used in the eShop app, add the following\\ncode to the bottom of the Configure method in Startup.cs\", \":\\n\\napp.UseMvc(routes =>\\n\\nroutes.MapRoute(\\\"default\\\", \\\"{controller=Catalog}/{action=Index}/{id?}\\\");\\n})\", \"3\\n\\nNote\\n\\nWith ASP.NET Core 3.0 and later, this is changed to use endpoints. For the initial port to \", \"ASP.NET Core\\n2.2, this is the proper syntax for mapping conventional routes.\\n\\nWith these changes in \", \"place, the Configure method is almost done. The original template\\u2019s app.Run\\nmethod that prints Hello\", \" World! should be deleted. At this point, the method is as shown here:\\n\\npublic void Configure(IAppli\", \"cationBuilder app, IHostingEnvironment env)\\n\\nt\\nif (env.IsDevelopment() )\\n\\nt\\n}\\n\\nelse\\n\\n{\\n\\napp.UseDevel\", \"operExceptionPage() ;\\n\\napp.UseExceptionHandler(\\\"/Home/Error\\\" ) ;\\n\\napp.UseStaticFiles();\\n\\napp.UseMvc(\", \"routes =>\\n\\nroutes .MapRoute(\\\"default\\\", \\\"{controller=Catalog}/{action=Index}/{id?}\\\");\\n})3\\n\\nNow it's t\", \"ime to configure MVC services, followed by the rest of the app\\u2019s support for dependency\\ninjection (D\", \"l). So far, the eShopPorted project's Program.cs file hasn't added any service configuration.\\nNow it\", \"\\u2019s time to start adding necessary services.\\n\\nFirst, to get ASP.NET Core MVC to work properly, it nee\", \"ds to be added:\\n\\n60 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\nbuilder.Services.AddMvc()\", \";\\n\\nThe preceding code is the minimal configuration required to get MVC features working. There are\\nm\", \"any additional features that can be configured from this call (some of which are detailed later in t\", \"his\\nchapter), but for now this will suffice to build the app. Running it now routes the default requ\", \"est\\nproperly, but since we've not yet configured DI, an error occurs while activating CatalogControl\", \"ler,\\nbecause no implementation of type ICatalogService has been provided yet. We'll return to config\", \"ure\\nMVC further in a moment. For now, let's migrate the app\\u2019s dependency injection.\\n\\nMigrate depende\", \"ncy injection configuration\\nThe original app\\u2019s Global.asax file defines the following method, called\", \" when the app starts up:\\nprotected IContainer RegisterContainer ()\\n\\nvar builder = new ContainerBuild\", \"er() ;\\n\\nbuilder.RegisterControllers (typeof (MvcApplication) .Assembl]ly) ;\\n\\nvar mockData = bool.Par\", \"se(ConfigurationManager .AppSettings| \\\"UseMockData\\\" |) ;\\n\\nbuilder.RegisterModule(new ApplicationModu\", \"le(mockData) ) ;\\n\\nvar container = builder.Build();\\nDependencyResolver.SetResolver(new AutofacDepende\", \"ncyResolver (container) ) ;\\n\\nreturn container;\\n\\nThis code configures an Autofac container, reads a c\", \"onfig setting to determine whether real or mock\\ndata should be used, and passes this setting into an\", \" Autofac module (found in the app\\u2019s /Modules\\ndirectory). Fortunately, Autofac supports .NET Core, so\", \" the module can be migrated directly. Copy the\\nfolder into the new project and updates the class\\u2019s n\", \"amespace and it should compile.\\n\\nASP.NET Core has built-in support for dependency injection, but you\", \" can wire up a third-party\\ncontainer such as Autofac easily if necessary. In this case, since the ap\", \"p is already configured to use\\nAutofac, the simplest solution is to maintain its usage. In Program.c\", \"s, simply configure the builder to\\nuse the AutofacServiceProviderFactory as shown:\\n\\n// using Autofac\", \".Extensions.DependencyInjection\\n\\nbuilder.Host.UseServiceProviderFactory(new AutofacServiceProviderFa\", \"ctory());\\n// note: the factory calls builder.Populate so we don't need to here\\n\\nbool useMockData = t\", \"rue; // TODO: read from config\\nbuilder.Host.ConfigureContainer<ContainerBuilder>(builder =>\\nbuilder.\", \"RegisterModule(new ApplicationModule(useMockData) ) ) ;\\n\\nFor now, the setting for useMockData Is set\", \" to true. This setting will be read from configuration in a\\nmoment. At this point, the app compiles \", \"and should load successfully when run, as shown in Figure 4-\\n12.\\n\\n61 CHAPTER 4 | Example migration o\", \"f eShop to ASP.NET Core\\neS eSHOP\\nonCONTAINERS\\n\\nCreate New\\n\\nNAME DESCRIPTION BRAND TYPE PRICE PICTURE\", \" NAME STOCK RESTOCK MAX STOCK\\n\\n-NET Bot Black Hoodie -NET Bot Black Hoodie \\u2018NET T-Shirt $19.50 l.png\", \" 100 Oo 0 Edit | Details | Delete\\n-NET Black & White Mug -NET Black & White Mug -NET Mug $8.50 2.png\", \" 100 L8) 0 Edit | Details | Delete\\nPrism White T-Shirt Prism White T-Shirt Other T-Shirt $12.00 3.pn\", \"g 100 i) Oo Edit | Details | Delete\\n-NET Foundation T-shirt -NET Foundation T-shirt -NET T-Shirt $12\", \".00 4.png 100 OQ 0 Edit | Details | Delete\\nRoslyn Red Sheet Roslyn Red Sheet Other Sheet $8.50 5.png\", \" 100 oO 0 Edit | Details | Delete\\n.NET Blue Hoodie -NET Blue Hoodie -NET T-Shirt $12.00 6.png 100 0 \", \"0 Edit | Details | Delete\\nRoslyn Red T-Shirt Roslyn Red T-Shirt Other T-Shirt $12.00 7.png 100 Oo 0 \", \"Edit | Details | Delete\\nKudu Purple Hoodie Kudu Purple Hoodie Other T-Shirt $8.50 8.png 100 is) 0 Ed\", \"it | Details | Delete\\nCup<T> White Mug Cup<T> White Mug Other Mug $12.00 9.png 100 Oo Oo Edit | Deta\", \"ils | Delete\\n-NET Foundation Sheet -NET Foundation Sheet -NET Sheet $12.00 10.png 100 0 0 Edit | Det\", \"ails | Delete\\n\\nShowing 10 of 12 products - Page 1 - 2 Next\\n\\neC eSHOP\\nonCONTAINERS\\n\\nFigure 4-12. Port\", \"ed eShop app running locally with mock data.\\n\\nMigrate app settings\\n\\nASP.NET Core uses a new configur\", \"ation system, which by default uses an appsettings.json file. By using\\nCreateDefaultBuilder in Progr\", \"am.cs, the default configuration is already set up in the app. To access\\nconfiguration, classes just\", \" need to request it in their constructor. In Program.cs, configuration is\\naccessible from builder.Co\", \"nfiguration.\\n\\nThe original app referenced its settings using ConfigurationManager.AppSettings. A qui\", \"ck search for\\nall references of this term yields the set of settings the new app needs. There are on\", \"ly two:\\n\\n\\u00b0 UseMockData\\n\\n\\u00b0 UseCustomizationData\\nIf your app has more complex configuration, especiall\", \"y if it's using custom configuration sections,\\nyou'll probably want to create and bind objects to di\", \"fferent parts of your app\\u2019s configuration. These\\ntypes can then be accessed using the options patter\", \"n. However, as noted in the referenced doc, this\\n\\npattern shouldn't be used in Program.cs (or Startu\", \"p.ConfigureServices). Instead the ported app will\\nreference the UseMockData configuration value dire\", \"ctly.\\n\\nFirst, modify the ported app\\u2019s appsettings.json file and add the two settings in the root:\\n\\nt\", \"\\n\\\"Logging\\\": {\\n\\n62 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\n\\u201cLoglLevel\\\": {\\n\\\"Default\\\": \\\"\", \"Warning\\\"\\n\\n}\\n}s\\n\\\"AllowedHosts\\\": \\\"*\\\",\\n\\\"UseMockData\\\": \\\"true\\\",\\n\\\"UseCustomizationData\\\" : \\\"true\\\"\\n\\nNow, mod\", \"ify Program.cs to access the UseMockData setting from the builder.Configuration property\\n(where prev\", \"iously we set the value to true):\\n\\nAt this point, the setting is pulled from configuration. The othe\", \"r setting, UseCustomizationData, is\\nused by the CatalogDBlnitializer class. When you first ported th\", \"is class, you commented out the access\\nto ConfigurationManager.AppSettings[\\\"UseCustomizationData\\\"]. \", \"Now it's time to modify it to use\\nASP.NET Core configuration. Modify the constructor of CatalogDBlni\", \"tializer as follows:\\n\\n// add using Microsoft.Extensions.Configuration\\n\\npublic CatalogDBInitializer(C\", \"atalogItemHiLoGenerator indexGenerator,\\nIConfiguration configuration)\\n\\n{\\n\\nthis.indexGenerator = inde\", \"xGenerator;\\nuseCustomizationData = configuration.GetValue<bool>(\\\"UseCustomizationData\\u201d ) ;\\n\\nAll acce\", \"ss to configuration within the web app should be modified in this manner to use the new\\nIConfigurati\", \"on type. Dependencies that require access to .NET Framework configuration can include\\nsuch settings \", \"in an app.config file added to the web project. The dependent projects can work with\\nConfigurationMa\", \"nager to access settings, and shouldn't require any changes if they already use this\\napproach. Howev\", \"er, since ASP.NET Core apps run as their own executable, they don't reference\\nweb.config but rather \", \"app.config. By migrating settings from the legacy app\\u2019s web.config file to a new\\napp.config file in \", \"the ASP.NET Core app, components that use ConfigurationManager to access their\\nsettings will continu\", \"e to function properly.\\n\\nThe app\\u2019s migration is nearly complete. The only remaining task is data acc\", \"ess configuration.\\n\\nData access considerations\\n\\nASP.NET Core apps running on .NET Framework can cont\", \"inue to use Entity Framework (EF). If\\nperforming an incremental migration, getting the app working w\", \"ith EF 6 before trying to port its data\\naccess to use EF Core may be worthwhile. In this way, any pr\", \"oblems with the app\\u2019s migration can be\\nidentified and addressed before another block of migration ef\", \"fort is begun.\\n\\nAs it happens, configuring EF 6 in the eShop sample migration doesn\\u2019t require any sp\", \"ecial work, since\\nthis work was performed in the Autofac ApplicationModule. The only problem is that\", \" currently the\\nCatalogDBContext class tries to read its connection string from web.config. To addres\", \"s this, the\\nconnection details need to be added to appsettings.json. Then the connection string must\", \" be passed\\ninto CatalogDBContext when it\\u2019s created.\\n\\nUpdate the appsettings.json to include the conn\", \"ection string. The full file is listed here:\\n\\n63 CHAPTER 4 | Example migration of eShop to ASP.NET C\", \"ore\\n\\\"\\u201cConnectionStrings\\\": {\\n\\u201cDefaultConnection\\\":\\n\\\"Server=(localdb) \\\\\\\\mssqllocaldb;Database=eShopPort\", \"ed; Trusted_Connection=True;MultipleActive\\nResultSets=true\\\"\\nhs\\n\\\"Logging\\\": {\\n\\n\\u201cLoglLevel\\\": {\\n\\\"Default\", \"\\\": \\\"Warning\\\"\\n}\\n}s\\n\\\"AllowedHosts\\\": \\\"*\\\",\\n\\\"UseMockData\\\": \\\"false\\\",\\n\\\"\\u201c\\\"UseCustomizationData\\\": \\\"true\\\"\\n\\nThe\", \" connection string must be passed into the constructor when the DbContext is created. Since the\\ninst\", \"ances are created by Autofac, the change needs to be made in ApplicationModule. Modify the\\nmodule to\", \" take in a connectionString in its constructor and assign it to a field. Then modify the\\nregistratio\", \"n for CatalogDBContext to add connection string as a parameter:\\n\\nbuilder.RegisterType<CatalogDBConte\", \"xt >()\\n.WithParameter(\\\"connectionString\\\", _connectionString)\\n.InstancePerLifetimeScope() ;\\n\\nThe para\", \"meter must also be added to a new constructor overload in CatalogDBContext itself:\\n\\npublic CatalogDB\", \"Context(string connectionString) : base(connectionString )\\nt\\n}\\n\\nFinally, Program.cs must read the co\", \"nnection string from Configuration and pass it into the\\nApplicationModule when it instantiates it:\\n\\n\", \"bool useMockData = Configuration.GetValue<bool>(\\\"UseMockData\\\" ) ;\\n\\nstring connectionString = Configu\", \"ration.GetConnectionString(\\\"DefaultConnection\\\" ) ;\\nbuilder.RegisterModule(new ApplicationModule(useM\", \"ockData, connectionString) ) ;\\n\\nWith this code in place, the app runs as it did before, connecting t\", \"o a SQL Server database when\\nUseMockData is false.\\n\\nThe app can be deployed and run in production at\", \" this point, converted to ASP.NET Core but still\\nrunning on .NET Framework and EF 6. If desired, the\", \" app can be migrated to run on .NET Core and\\nEntity Framework Core, which will bring additional adva\", \"ntages described in earlier chapters. Specific\\nto Entity Framework, this documentation compares EF C\", \"ore and EF 6 and includes a grid showing\\nwhich library supports each of dozens of individual feature\", \"s.\\n\\nMigrate to Entity Framework Core\\n\\nAssuming a decision is made to migrate to EF Core, the steps c\", \"an be fairly straightforward, especially\\nif the original app used a code-based model approach. When \", \"preparing to port from EF 6 to EF Core,\\nreview the availability of features in the destination versi\", \"on of EF Core you'll be using. Review the\\n\\ndocumentation on porting from and EDMX-based model versus\", \" porting from a code-based model.\\n\\n64 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\nTo upgr\", \"ade to EF Core 2.2, the basic steps involved are to add the appropriate NuGet package(s) and\\nupdate \", \"namespaces. Then adjust how the connection string is passed to the DoContext type and how\\nthey're wi\", \"red up for dependency injection.\\n\\nEF Core is added as a package reference to the project:\\n\\n<PackageR\", \"eference Include=\\\"Microsoft.EntityFrameworkCore\\\" Version=\\\"2.2.6\\\" />\\n\\nThe reference to EF 6 is remove\", \"d:\\n\\n<PackageReference Include=\\\"EntityFramework\\\" Version=\\\"6.2.0\\\" />\\n\\nThe compiler will report errors \", \"in CatalogDBContext and CatalogDBlnitializer. CatalogDbContext\\nneeds to have the old namespaces remo\", \"ved and replaced with Microsoft.EntityFrameworkCore. Its\\nconstructors can be removed. DoModelBuilder\", \" should be replaced with ModelBuilder. The helper\\nmethods for configuring types are moved to separat\", \"e classes implementing\\nlEntityTypeConfiguration<T>. Then the CatalogDBContext class's OnModelCreatin\", \"g method simply\\nbecomes:\\n\\nprotected override void OnModelCreating(ModelBuilder builder)\\n\\nt\\n\\nbuilder \", \".ApplyConfigurationsFromAssembly (Assembly .GetExecutingAssembly() ) ;\\n\\nbase .OnModelCreating (build\", \"er) ;\\n\\nOther changes involved include:\\n\\nHasDatabaseGeneratedOption(DatabaseGeneratedOption.None) rep\", \"laced with\\nValueGeneratedNever\\u2018()\\n\\nHasRequired<T> replaced with HasOne<T>\\n\\nInstalled Microsoft.Entit\", \"yFrameworkCore.Relational package\\n\\nAdd a constructor to CatalogDBContext taking DoContextOptions and\", \" passing it to the base\\nconstructor\\n\\nAn example configuration class for CatalogType is shown here:\\n\\n\", \"using Microsoft.EntityFrameworkCore;\\nusing Microsoft.EntityFrameworkCore.Metadata.Builders;\\n\\nnamespa\", \"ce eShopPorted.Models.Config\\n\\nt\\n\\n65\\n\\npublic class CatalogTypeConfig :\\n\\nt\\n\\nTEntityTypeConfiguration<C\", \"atalogType>\\n\\npublic void Configure(EntityTypeBuilder<CatalogType> builder)\\n\\nt\\n\\nbuilder. ToTable(name\", \"of(CatalogType) ) ;\\n\\nbuilder.HasKey(ci => ci.Id);\\n\\nbuilder.Property(ci => ci.Id)\\n. IsRequired() ;\\n\\nb\", \"uilder.Property(cb => cb.Type)\\n. lsRequired()\\n. HasMaxLength(1@@) ;\\n\\nCHAPTER 4 | Example migration o\", \"f eShop to ASP.NET Core\\n}\\n\\nThe CatalogDBlnitializer and its base class, CreateDatabaselfNotExists<T>\", \", are incompatible with EF\\nCore. The purpose of this class is to create and seed the database. Using\", \" EF Core will create and drop\\nthe associated database for a DoContext using these methods:\\n\\ndbContex\", \"t.Database.EnsureDeleted() ;\\ndbContext.Database.EnsureCreated() ;\\n\\nSeeding data in EF Core can be do\", \"ne with manual scripts, or as part of the type configuration. Along\\nwith other entity properties, se\", \"ed data can be configured in |EntityTypeConfiguration classes by using\\nbuilder.HasData(). The origin\", \"al app loaded seed data from CSV files in the Setup directory. Given that\\nthere are only a handful o\", \"f items, these data records can instead be added as part of the entity\\nconfiguration. This approach \", \"works well for lookup data in tables that change infrequently. Adding the\\nfollowing to CatalogTypeCo\", \"nfig\\u2019s Configure method ensures the associated rows are present when\\nthe database is created:\\n\\nbuild\", \"er .HasData(\\nnew CatalogType { Id\\nnew CatalogType { Id\\n\\n\\\"Mug\\\" },\\n\\\"T-Shirt\\\" },\\n\\n\\\"Sheet\\\" },\\n\\n\\u201cUSB Memo\", \"ry Stick\\\" }\\n\\nnew CatalogType { Id\\nnew CatalogType { Id\\n\\nThe initial app includes a PreconfiguredData\", \" class, which includes data for CatalogBrand and\\nCatalogType, so using this method the HasData call \", \"reduces to:\\n\\nbuilder .HasData(\\nPreconfiguredData.GetPreconfiguredCatalogBrands( )\\n\\n);\\n\\nThe Cataloglt\", \"em data can also be pulled from PreconfiguredData, and assuming the associated\\nimages are kept in so\", \"urce control, that is the last table needed for the app to function. The\\nCatalogDBlnitializer class \", \"can be removed, along with any references to it. The\\nCatalogltemHiLoGenerator class and the SQL file\", \"s in the Infrastructure directory are also removed,\\nalong with any references to them (in CatalogSer\", \"vice, ApplicationModule).\\n\\nWith the elimination of the special key generator classes for Catalogltem\", \", this code now is removed\\nfrom CatalogltemConfig:\\n\\nbuilder.Property(ci => ci.Id)\\n\\n. ValueGeneratedN\", \"ever()\\n. [sRequired() ;\\n\\nWith these modifications, the ASP.NET Core app builds, but it doesn\\u2019t yet w\", \"ork with EF Core, which\\nmust still be configured for dependency injection. With EF Core, the simples\", \"t way to configure it is in\\nProgram.cs:\\n\\nbuilder.Services.AddMvc();\\n\\nbool useMockData = builder.Conf\", \"iguration.GetValue<bool>(\\\"UseMockData\\\" ) ;\\nif (!useMockData)\\n\\n{\\n\\n66 CHAPTER 4 | Example migration of\", \" eShop to ASP.NET Core\\nstring connectionString =\\nbuilder.Configuration.GetConnectionString(\\\"DefaultC\", \"onnection\\\") ;\\n\\nbuilder.Services.AddDbContext<CatalogDBContext>(options =>\\noptions .UseSqlServer(conn\", \"ectionString )\\n\\n);\\n\\nThe final version of Autofac\\u2019s ApplicationModule only configures one type, depen\", \"ding on whether the\\napp Is configured to use mock data:\\n\\npublic class ApplicationModule : Module\\n\\n{\\n\", \"\\nprivate bool _useMockData;\\n\\npublic ApplicationModule(bool useMockData)\\n{\\n\\n}\\n\\n_useMockData = useMock\", \"Data;\\n\\nprotected override void Load(ContainerBuilder builder)\\n\\naf\\nif (_useMockData)\\n\\nbuilder.Registe\", \"rType<CatalogServiceMock>()\\n.As<ICatalogService>()\\n.SingleInstance();\\n\\n}\\n\\nelse\\n\\nbuilder.RegisterType\", \"<CatalogService>()\\n.As<ICatalogService>()\\n.InstancePerLifetimeScope( ) ;\\n\\nThe ported app runs, but d\", \"oesn\\u2019t display any data if configured to use non-mock data. The seed data\\nadded through HasData is o\", \"nly inserted when migrations are applied. The source app didn\\u2019t use\\nmigrations, and if it had, they \", \"wouldn't migrate as-is. The best approach Is to start with a new\\nmigration script. To do this, add a\", \" package reference for Microsoft.EntityFrameworkCore.Design and\\nopen a terminal window in the projec\", \"t root. Then run:\\n\\ndotnet ef migrations add Initial\\n\\nDrop the existing eShopPorted database if it ex\", \"ists, then run:\\n\\ndotnet ef database update\\n\\nThis creates and seeds the database. It's now ready to r\", \"un, with a few small updates left to address.\\n\\nFix all TODO tasks\\n\\nRunning the ported app at this po\", \"int reveals that no pictures are shown on the page. This is because\\nthe PictureUri property of Catal\", \"ogitem is never set. Looking at the list of TODO items we created\\n\\n67 CHAPTER 4 | Example migration \", \"of eShop to ASP.NET Core\\nusing Visual Studio's Task List, the only one that remains is in CatalogCon\", \"troller, with a note to\\n\\u201cReference pic from wwwroot.\\\" The code in question is:\\n\\nprivate void AddUriP\", \"laceHolder(CatalogItem item)\\n\\n//TODO: Reference pic from wwwroot\\n//item.PictureUri = this.Url.RouteU\", \"r1(PicController.GetPicRouteName, new {\\ncatalogItemId = item.Id }, this.Request.Url.Scheme) ;\\n\\n}\\n\\nTh\", \"e simplest fix is to reference the public image files in the site\\u2019s public wwwroot/Pics directory. T\", \"his\\ntask can be accomplished by replacing the method with the following code:\\n\\nprivate void AddUriPl\", \"aceHolder(CatalogItem item)\\n{\\n\\n}\\n\\nitem.PictureUri = $\\\"/Pics/{item.Id}.png\\\";\\n\\nWith this change, runni\", \"ng the app reveals the images work as before.\\n\\nAdditional MVC customizations\\n\\nThe eShopLegacyMVC app\", \" is fairly simple, so there isn't much to configure in terms of default MVC\\nbehavior. However, if yo\", \"u do need to configure additional MVC components, such as CORS, filters,\\nand route constraints, you \", \"generally provide this information in Program.cs, where UseMvc Is called.\\nFor example, the following\", \" code listing configures CORS and sets up a global action filter:\\n\\nbuilder.Services.AddCors(options \", \"=>\\n{\\noptions .AddPolicy(MyAllowSpecificOrigins,\\nbuilder =>\\nbuilder.WithOrigins(\\\"http://example.com\\\",\", \" \\\"http://www. contoso.com\\\" )\\n.AllowAnyHeader ( )\\n-AllowAnyMethod() ) ;\\n\\n})5\\n\\nbuilder.Services.AddMvc\", \"(options =>\\n\\n{\\noptions.Filters.Add(new SampleGlobalActionFilter());\\n\\n}) .SetCompatibilityVersion(Com\", \"patibilityVersion.Version_2_ 2);\\n\\nNote\\n\\nTo finish configuring CORS, you must also call app.UseCors()\", \" after building the application.\\n\\nOther advanced scenarios, like adding custom model binders, format\", \"ters, and more are covered in the\\ndetailed ASP.NET Core docs. Generally these can be applied on an i\", \"ndividual controller or action basis,\\nor globally using the same options approach shown in the previ\", \"ous code listing.\\n\\n68 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\nOther dependencies\\n\\nDep\", \"endencies that use .NET Framework features that had a dependency on the legacy configuration\\nmodel, \", \"such as the WCF client type and tracing code, must be modified when ported. Rather than\\nhaving these\", \" types pull in their configuration information directly, they should be configured in code.\\nFor exam\", \"ple, a connection to a WCF service that was configured in an ASP.NET app\\u2019s web.config to use\\nbasicHt\", \"tpBinding could instead be configured programmatically with the following code:\\n\\nvar binding = new B\", \"asicHttpBinding() ;\\nbinding.MaxReceivedMessageSize = 2 000 000;\\n\\nvar endpointAddress = new EndpointA\", \"ddress(\\\"http://localhost:9200/ExampleService\\\") ;\\n\\n| var myClient = new MyServiceClient(binding, endp\", \"ointAddress) ; |\\n\\nRather than relying on config files for its settings, WCF clients and other .NET F\", \"ramework types should\\nhave their settings specified in code. Configured in this manner, these types \", \"can continue to work in\\nASP.NET Core 2.2 apps.\\n\\nReferences\\n\\n: eShopModernizing GitHub repository\\n\\n: \", \".NET Upgrade Assistant tool\\n\\n: Your API and ViewModels Should Not Reference Domain Models\\n: Develope\", \"r Exception Page Middleware\\n\\n. Deep Dive into EF Core HasData\\n\\nMore migration scenarios\\n\\nThis sectio\", \"n describes several different ASP.NET app scenarios, and offers specific techniques for\\nsolving each\", \" of them. You can use this section to identify scenarios applicable to your app, and\\nevaluate which \", \"techniques will work for your app and its hosting environment.\\n\\nMigrate ASP.NET MVC 5 and WebApi 2 t\", \"o ASP.NET Core MVC\\n\\nA common scenario in ASP.NET MVC 5 and Web API 2 apps was for both products to b\", \"e installed in\\nthe same application. This is a supported and relatively common approach used by many\", \" teams, but\\nbecause the two products use different abstractions, there is some redundant effort need\", \"ed. For\\nexample, setting up routes for ASP.NET MVC Is done using methods on RouteCollection, such as\", \"\\nMapMvcAttributeRoutes() and MapRoute(). But ASP.NET Web API 2 routing is managed with\\nHttpConfigura\", \"tion and methods like MapHttpAttributeRoutes() and MapHttpRoute().\\n\\nThe eShopLegacyMVC app includes \", \"both ASP.NET MVC and Web API, and includes methods in its\\nApp. Start folder for setting up routes fo\", \"r both. It also supports dependency injection using Autofac,\\nwhich also requires two sets of similar\", \" work to configure:\\n\\n69 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\nprotected IContainer \", \"RegisterContainer ()\\n\\nt\\n\\nvar builder = new ContainerBuilder() ;\\n\\nvar thisAssembly = Assembly.GetExec\", \"utingAssembly() ;\\nbuilder.RegisterControllers(thisAssembly) ; // MVC controllers\\nbuilder.RegisterApi\", \"Controllers(thisAssembly) ; // Web API controllers\\n\\nvar mockData = bool.Parse(ConfigurationManager.A\", \"ppSettings| \\\"UseMockData\\\" |) ;\\nbuilder.RegisterModule(new ApplicationModule(mockData) ) ;\\n\\nvar conta\", \"iner = builder.Build();\\n\\n// set mvc resolver\\nDependencyResolver.SetResolver(new AutofacDependencyRes\", \"olver(container) ) ;\\n\\n// set webapi resolver\\nvar resolver = new AutofacWebApiDependencyResolver (con\", \"tainer) ;\\nGlobalConfiguration.Configuration.DependencyResolver = resolver;\\n\\nreturn container;\\n\\nWhen \", \"upgrading these apps to use ASP.NET Core, this duplicate effort and the confusion that\\nsometimes acc\", \"ompanies it is eliminated. ASP.NET Core MVC Is a unified framework with one set of\\nrules for routing\", \", filters, and more. Dependency injection is built into .NET Core itself. All of this can be\\nconfigu\", \"red in Program.cs, as is shown in the eShopPorted app in the sample.\\n\\nMigrate HttpResponseMessage to\", \" ASP.NET Core\\n\\nSome ASP.NET Web API apps may have action methods that return HttopResponseMessage. T\", \"his type\\ndoes not exist in ASP.NET Core. Below is an example of its usage in a Delete action method,\", \" using the\\nResponseMessage helper method on the base ApiController:\\n\\n// DELETE api/<controller>/5\\n\\n[\", \"HttpDelete |\\n\\npublic IHttpActionResult Delete(int id)\\n\\n{\\nvar brandToDelete = _service.GetCatalogBran\", \"ds().FirstOrDefault(x => x.Id == id);\\nif (brandToDelete == null)\\n\\nt\\n}\\n\\nreturn ResponseMessage(new Ht\", \"tpResponseMessage(HttpStatusCode.NotFound) ) ;\\n\\n// demo only - don't actually delete\\nreturn Response\", \"Message(new HttpResponseMessage(HttpStatusCode. OK) ) ;\\n\\nIn ASP.NET Core MVC, there are helper metho\", \"ds available for all of the common HTTP response status\\ncodes, so the above method would be ported t\", \"o the following code:\\n\\n[HttpDelete(\\\"{id}\\\") ]\\npublic IActionResult Delete(int id)\\n{\\n\\nvar brandToDelet\", \"e = _service.GetCatalogBrands().FirstOrDefault(x => x.Id == id);\\nif (brandToDelete == null)\\n\\nt\\n\\n70 C\", \"HAPTER 4 | Example migration of eShop to ASP.NET Core\\nreturn NotFound();\\n\\n}\\n\\n// demo only - don't ac\", \"tually delete\\nreturn Ok();\\n\\nIf you do find that you need to return a custom status code for which no\", \" helper exists, you can always\\nuse return StatusCode(int statusCode) to return any numeric code you \", \"like.\\n\\nMigrate content negotiation from ASP.NET Web API to ASP.NET Core\\n\\nASP.NET Web API 2 supports \", \"content negotiation natively. The sample app includes a\\nBrandsController that demonstrates this supp\", \"ort by listing its results in either XML or JSON. This is\\nbased on the request\\u2019s Accept header, and \", \"changes when it includes application/xml or\\napplication/json.\\n\\nASP.NET MVC 5 apps do not have conten\", \"t negotiation support built in.\\n\\nContent negotiation is preferable to returning a specific encoding \", \"type, as it is more flexible and\\nmakes the API available to a larger number of clients. If you curre\", \"ntly have action methods that return\\na specific format, you should consider modifying them to return\", \" a result type that supports content\\nnegotiation when you port the code to ASP.NET Core.\\n\\nThe follow\", \"ing code returns data in JSON format regardless of client Accept header content:\\n\\n[HttpGet |\\npublic \", \"ActionResult Index()\\n\\nt\\n}\\n\\nreturn Json(new { Message = \\\"Hello World!\\\" });\\n\\nASP.NET Core MVC supports\", \" content negotiation natively, provided an appropriate return type is\\nused. Content negotiation is i\", \"mplemented by [ObjectResult] which is returned by the status code-\\n\\nspecific action results returned\", \" by the controller helper methods. The previous action method,\\nimplemented in ASP.NET Core MVC and u\", \"sing content negotiation, would be:\\n\\npublic IActionResult Index()\\n{\\n\\n}\\n\\nreturn Ok(new { Message = \\\"H\", \"ello World!\\\"} );\\n\\nThis will default to returning the data in JSON format. XML and other formats will\", \" be used if the app\\nhas been configured with the appropriate formatter.\\n\\nCustom model binding\\n\\nMost \", \"ASP.NET MVC and Web API apps make use of model binding. The default model binding syntax\\nmigrates fa\", \"irly seamlessly between these apps and ASP.NET Core MVC. However, in some cases\\ncustomers have writt\", \"en custom model binders to support specific model types or usage scenarios.\\nCustom model binders in \", \"ASP.NET MVC and Web API projects use separate IModelBinder interfaces\\ndefined in System.Web.Mvc and \", \"System.Web.Http namespaces, respectively. In both cases, the custom\\n\\n71 CHAPTER 4 | Example migratio\", \"n of eShop to ASP.NET Core\\nbinder exposes a Bind method that accepts a controller or action context \", \"and a model binding context\\nas arguments.\\n\\nOnce the custom binder is created, it must be registered \", \"with the app. This step requires creating\\nanother type, a ModelBinderProvider, which acts as a facto\", \"ry and creates the model binder during a\\nrequest. Binders can be added during ApplicationStart in MV\", \"C apps as shown:\\n\\nModelBinderProviders.BinderProviders.Insert(@, new MyCustomBinderProvider()); // M\", \"VC\\n\\nIn Web API apps, custom binders can be referenced using attributes. The ModelBinder attribute ca\", \"n\\nbe added to action method parameters or to the parameter\\u2019s type definition, as shown:\\n\\n// attribut\", \"e on action method parameter\\n\\npublic HttpResponseMessage([ModelBinder (typeof (MyCustomBinder) )] Cu\", \"stomDTO custom)\\nt\\n\\n}\\n\\n// attribute on type\\n[ModelBinder (typeof (MyCustomBinder) ) ]\\npublic class Cu\", \"stomDTO\\n\\n{\\n\\n}\\n\\nTo register a model binder globally in ASP.NET Web API, its provider must be added du\", \"ring app\\nstartup:\\n\\npublic static class WebApiConfig\\n{\\npublic static void Register(HttpConfiguration \", \"config)\\n{\\nvar provider = new CustomModelBinderProvider (\\ntypeof (CustomDTO), new CustomModelBinder (\", \") );\\nconfig.Services.Insert(typeof(ModelBinderProvider), 8, provider) ;\\n\\nWhen migrating custom model\", \" providers to ASP.NET Core, the Web API pattern is closer to the\\nASP.NET Core approach than the ASP.\", \"NET MVC 5. The main differences between ASP.NET Core\\u2019s\\nIModelBinder interface and Web API's is that \", \"the ASP.NET Core method is async (BindModelAsync)\\nand it only requires a single BindingModelContext \", \"parameter instead of two parameters like Web\\nAPI's version required. In ASP.NET Core, you can use a \", \"[ModelBinder] attribute on individual action\\nmethod parameters or their associated types. You can al\", \"so create a ModelBinderProvider that will be\\nused globally within the app where appropriate. To conf\", \"igure such a provider, you would add code to\\nProgram.cs:\\n\\nbuilder.Services.AddControllers(options =>\", \"\\n\\n{\\n})5\\n\\noptions.ModelBinderProviders.Insert(@, new CustomModelBinderProvider());\\n\\n72 CHAPTER 4 | Ex\", \"ample migration of eShop to ASP.NET Core\\nMedia formatters\\n\\nASP.NET Web API supports multiple media f\", \"ormats and can be extended by using custom media\\nformatters. The docs describe an example CSV Media \", \"Formatter that can be used to send data ina\\ncomma-separated value format. If your Web API app uses c\", \"ustom media formatters, you'll need to\\nconvert them to ASP.NET Core custom formatters.\\n\\nTo create a \", \"custom formatter in Web API 2, you inherited from an appropriate base class and then\\nadded the forma\", \"tter to the Web API pipeline using the HttpConfiguration object:\\n\\npublic static void ConfigureApis(H\", \"ttpConfiguration config)\\n{\\n\\nconfig.Formatters.Add(new ProductCsvFormatter() ) ;\\n\\n}\\n\\nIn ASP.NET Core,\", \" the process is similar. ASP.NET Core supports both input formatters (used by model\\nbinding) and out\", \"put formatters (used to format responses). Adding a custom formatter to output\\nresponses in a specif\", \"ic way involves inheriting from an appropriate base class and adding the\\nformatter to MVC in Program\", \".cs:\\n\\nbuilder.Services.AddControllers(options =>\\n\\nt\\n\\noptions.InputFormatters.Insert(@, new CustomInp\", \"utFormatter() );\\noptions.OutputFormatters.Insert(@, new CustomOutputFormatter() );\\n\\n})5\\n\\nYou'll find\", \" a complete list of base classes in the Microsoft.AsoNetCore.Mvc.Formatters namespace.\\n\\nThe steps to\", \" migrate from a Web API formatter to an ASP.NET Core MVC formatter are:\\n\\n1 Identify an appropriate b\", \"ase class for the new formatter.\\n\\n2 Create a new instance of the base class and implement its requir\", \"ed methods.\\n\\n3. Copy over the functionality from the Web API formatter to the new implementation.\\n4\\n\", \"\\nConfigure MVC in the ASP.NET Core App\\u2019s ConfigureServices method to use the new\\nformatter.\\n\\nCustom \", \"filters\\n\\nFilters are used in ASP.NET Core apps to execute code before and/or after certain stages in\", \" the\\nrequest processing pipeline. ASP.NET MVC and Web API also use filters in much the same way, but\", \" the\\ndetails vary. For instance, ASP.NET MVC supports four kinds of filters. ASP.NET Web API 2 suppo\", \"rts\\nsimilar filters, and both MVC and Web API included attributes to override filters.\\n\\nThe most com\", \"mon filter used in ASP.NET MVC and Web API apps is the action filter, which is defined\\nby an |Action\", \"Filter interface. This interface provides methods for before (OnActionExecuting) and after\\n(OnAction\", \"Executed) which can be used to execute code before and/or after an action executes, as\\nnoted for eac\", \"h method.\\n\\nASP.NET Core continues to support filters, and its unification of MVC and Web API means t\", \"here is only\\n\\none approach to their implementation. The docs include detailed coverage of the five (\", \"5) kinds of\\nfilters built into ASP.NET Core MVC. All of the filter variants supported in ASP.NET MVC\", \" and ASP.NET\\n\\n73 CHAPTER 4 | Example migration of eShop to ASP.NET Core\\nWeb API have associated vers\", \"ions in ASP.NET Core, so migration is generally just a matter of\\nidentifying the appropriate interfa\", \"ce and/or base class and migrating the code over.\\n\\nIn addition to the synchronous interfaces, ASP.NE\", \"T Core also provides async interfaces like\\n[AsyncActionFilter which provide a single async method th\", \"at can be used to incorporate code to run\\nboth before and after the action, as shown:\\n\\npublic class \", \"SampleAsyncActionFilter : IAsyncActionFilter\\n\\npublic async Task OnActionExecutionAsync (\\nActionExecu\", \"tingContext context,\\nActionExecutionDelegate next)\\n\\n// Do something before the action executes.\\n\\n// \", \"next() calls the action method.\\n\\nvar resultContext = await next();\\n\\n// resultContext.Result is set.\\n\", \"\\n// Do something after the action executes.\\n\\nWhen migrating async code (or code that should be async\", \"), teams should consider leveraging the\\nbuilt in async types that are provided for this purpose.\\n\\nMo\", \"st ASP.NET MVC and Web API apps do not use a large number of custom filters. Since the\\napproach to f\", \"ilters in ASP.NET Core MVC is closely aligned with filters in ASP.NET MVC and Web API,\\nthe migration\", \" of custom filters is generally fairly straightforward. Be sure to read the detailed\\ndocumentation o\", \"n filters in ASP.NET Core\\u2019s docs, and once you're sure you have a good\\nunderstanding of them, port t\", \"he logic from the old system to the new system\\u2019s filters.\\n\\nRoute constraints\\n\\nASP.NET Core uses rout\", \"e constraints to help ensure requests are routed properly to route a request.\\nASP.NET Core supports \", \"a large number of different route constraints for this purpose. Route\\nconstraints can be applied in \", \"the route table, but most apps built with ASP.NET MVC 5 and/or\\nASP.NET Web API 2 use inline route co\", \"nstraints applied to attribute routes. Inline route constraints use\\na format like this one:\\n\\n[Route(\", \"\\\"/customer/{id:int}\\\") ]\\n\\nThe :int after the id route parameter constrains the value to match the int\", \" type. One benefit of using\\nroute constraints is that they allow for two otherwise-identical routes \", \"to exist where the parameters\\ndiffer only by their type. This allows for the equivalent of method ov\", \"erloading of routes based solely\\non parameter type.\\n\\nThe set of route constraints, their syntax, and\", \" usage is very similar between all three approaches.\\nCustom route constraints are fairly rare in cus\", \"tomer applications. If your app uses a custom route\\nconstraint and needs to port to ASP.NET Core, th\", \"e docs include examples showing how to create\\ncustom route constraints in ASP.NET Core. Essentially \", \"all that's required is to implement\\n[RouteConstraint and its Match method, and then add the custom c\", \"onstraint when configuring\\nrouting for the app:\\n\\n74 CHAPTER 4 | Example migration of eShop to ASP.NE\", \"T Core\\nbuilder.Services.AddControllers() ;\\n\\nbuilder.Services.AddRouting(options =>\\n\\n{\\noptions.Constr\", \"aintMap.Add(\\\"customName\\\", typeof(MyCustomConstraint) ) ;\\n})3\\n\\nThis is very similar to how custom con\", \"straints are used in ASP.NET Web API, which uses\\nIHttoRouteConstraint and configures it using a reso\", \"lver and a call to\\nHttpConfiguration.MapHttpAttributeRoutes:\\n\\npublic static class WebApiConfig\\npubli\", \"c static void Register(HttpConfiguration config)\\n\\nt\\n\\nvar constraintResolver = new DefaultInlineConst\", \"raintResolver() ;\\nconstraintResolver.ConstraintMap.Add(\\\"nonzero\\\", typeof (CustomConstraint) ) ;\\n\\ncon\", \"fig .MapHttpAttributeRoutes(constraintResolver) ;\\n\\nASP.NET MVC 5 follows a very similar approach, us\", \"ing IRouteConstraint for its interface name and\\nconfiguring the constraint as part of route configur\", \"ation:\\n\\npublic class RouteConfig\\n\\nt\\n\\npublic static void RegisterRoutes(RouteCollection routes)\\n\\nt\\n\\nr\", \"outes. IgnoreRoute(\\\"{resource}.axd/{*pathInfo}\\\") ;\\n\\nvar constraintsResolver = new DefaultInlineConst\", \"raintResolver() ;\\nconstraintsResolver.ConstraintMap.Add(\\\"values\\\", typeof (ValuesConstraint) ) ;\\nrout\", \"es .MapMvcAttributeRoutes (constraintsResolver) ;\\n\\nMigrating route constraint usage as well as custo\", \"m route constraints to ASP.NET Core is typically very\\nstraightforward.\\n\\nCustom route handlers\\n\\nAnoth\", \"er fairly advanced feature of ASP.NET MVC 5 is route handlers. Custom route handlers\\nimplement |Rout\", \"eHandler, which includes a single method that returns an IHttpHandler for a give\\nrequest. The IHttpH\", \"andler, in turn, exposes an IsReusable property and a single ProcessRequest\\nmethod. In ASP.NET MVC 5\", \", you can configure a particular route in the route table to use your custom\\nhandler:\\n\\npublic static\", \" void RegisterRoutes(RouteCollection routes)\\n\\nt\\n\\nroutes .IgnoreRoute(\\\"{resource}.axd/{*pathInfo}\\\") ;\", \"\\n\\nroutes.Add(new Route(\\\"custom\\\", new CustomRouteHandler()));\\n\\n15 CHAPTER 4 | Example migration of eS\", \"hop to ASP.NET Core\\nTo migrate custom route handlers from ASP.NET MVC 5 to ASP.NET Core, you can eit\", \"her use a filter\\n(such as an action filter) or a custom IRouter. The filter approach is relatively s\", \"traightforward, and can\\nbe added as a global filter when MVC is added to the app\\u2019s services during s\", \"tartup:\\n\\nbuilder.Services.AddMvc(options =>\\n\\nt\\n\\noptions. Filters.Add(typeof(CustomActionFilter) ) ;\\n\", \"\\n})5\\n\\nThe IRouter option requires implementing the interface\\u2019s RouteAsync and GetVirtualPath methods\", \".\\nThe custom router is added to the request pipeline during app startup.\\n\\nHi aoc\\n\\napp.UseMvc(routes \", \"=>\\n\\nroutes.Routes.Add(new CustomRouter(routes.DefaultHandler) ) ;\\n\\n})5\\n\\nIn ASP.NET Web API, these ha\", \"ndlers are referred to as custom message handlers, rather than route\\nhandlers. Message handlers must\", \" derive from DelegatingHandler and override its SendAsync method.\\nMessage handlers can be chained to\", \"gether to form a pipeline in a fashion that is very similar to\\nASP.NET Core middleware and its reque\", \"st pipeline.\\n\\nASP.NET Core has no DelegatingHandler type or separate message handler pipeline. Inste\", \"ad, such\\nhandlers should be migrated using global filters, custom IRouter instances (see above), or \", \"custom\\nmiddleware. ASP.NET Core MVC filters and [Router types have the advantage of having built-in \", \"access\\nto MVC constructs like controllers and actions, while middleware is a lower level approach th\", \"at has no\\nties to MVC. This makes it more flexible but also requires more effort if you need to acce\", \"ss MVC\\ncomponents.\\n\\nCORS support\\n\\nCORS, or Cross-Origin Resource Sharing, is a W3C standard that all\", \"ows servers to accept requests that\\ndon't originate from responses they've served. ASP.NET MVC 5 and\", \" ASP.NET Web API 2 support CORS\\nin different ways. The simplest way to enable CORS support in ASP.NE\", \"T MVC 5 is with an action filter\\nlike this one:\\n\\npublic class AllowCrossSiteAttribute : ActionFilter\", \"Attribute\\n{\\n\\npublic override void OnActionExecuting (ActionExecutingContext filterContext)\\n{\\nfilterC\", \"ontext.RequestContext.HttpContext.Response. AddHeader (\\n\\\"Access-Control-Allow-Origin\\\", \\\"example.com\\\"\", \") ;\\nbase.OnActionExecuting(filterContext) ;\\n\\nASP.NET Web API can also use such a filter, but it has \", \"built-in support for enabling CORS as well:\\n\\npublic static class WebApiConfig\\naf\\n\\npublic static void\", \" Register(HttpConfiguration config)\\n\\nt\\nconfig.EnableCors() ;\\n\\n76 CHAPTER 4 | Example migration of eS\", \"hop to ASP.NET Core\\nOnce this is added, you can configure allowed origins, headers, and methods usin\", \"g the EnableCors\\nattribute, like so:\\n\\n[EnableCors(origins: \\\"https://dot.net\\\", headers: \\\"*\\\", methods:\", \" \\\"*\\\") ]\\npublic class TestController : ApiController\\n\\nt\\n\\n// Controller methods not shown...\\n\\n}\\n\\nBefor\", \"e migrating your CORS implementation from ASP.NET MVC 5 or ASP.NET Web API 2, be sure to\\nreview how \", \"CORS works and create some automated tests that demonstrate CORS is working as\\nexpected in your curr\", \"ent system.\\n\\nIn ASP.NET Core, there are three built-in ways to enable CORS:\\n\\n. Configured via policy\", \" in ConfigureServices\\n\\n\\u00b0 Enabled with endpoint routing\\n\\u00b0 Enabled with the EnableCors attribute\\n\\nEach\", \" of these approaches is covered in detail in the docs, which are linked from the above options.\\nWhic\", \"h one you choose will largely depend on how your existing app supports CORS. If the app uses\\nattribu\", \"tes, you can probably migrate to use the EnableCors attribute most easily. If your app uses\\nfilters,\", \" you could continue using that approach (though it\\u2019s not the typical approach used in ASP.NET\\nCore),\", \" or migrate to use attributes or policies. Endpoint routing is a relatively new feature introduced\\nw\", \"ith ASP.NET Core 3 and as such it doesn't have a close analog in ASP.NET MVC 5 or ASP.NET Web\\nAPI 2 \", \"apps.\\n\\nCustom areas\\n\\nMany ASP.NET MVC apps use Areas to organize the project. Areas typically reside\", \" in the root of the\\nproject in an Areas folder, and must be registered when the application starts, \", \"typically in\\nApplication_Start():\\n\\nAreaRegistration.RegisterAllAreas() ;\\n\\nAn alternative to register\", \"ing all areas in startup is to use the RouteArea attribute on individual\\ncontrollers:\\n\\n[ RouteArea( \", \"\\\"Admin\\\" ) ]\\npublic class SomeController : Controller\\n\\nWhen using Areas, additional arguments are pas\", \"sed into HTML helper methods to generate\\nlinks to actions in different areas:\\n@Html.ActionLink( \\\"New\", \"s\\\", \\\"Index\\\", \\\"News\\\", new { area = \\\"News\\\" }, null)\\n\\nASP.NET Web API apps don't typically use areas ex\", \"plicitly, since their controllers can be placed in any\\nfolder in the project. Teams can use any fold\", \"er structure they like to organize their API controllers.\\n\\n77 CHAPTER 4 | Example migration of eShop\", \" to ASP.NET Core\\nAreas are supported in ASP.NET Core MVC. The approach used is nearly identical to t\", \"he use of areas\\nin ASP.NET MVC 5. Developers migrating code using areas should keep in mind the foll\", \"owing\\ndifferences:\\n\\n\\u00b0 AreaRegistration.RegisterAllAreas is not used in ASP.NET Core MVC\\n\\u00b0 Areas are \", \"applied using the [Area(\\\"name'\\\")] attribute (not RouteArea as in ASP.NET MVC 5)\\n. Areas can be added\", \" to the route table templates, if desired (or they can use attribute routing)\\n\\nTo add area support t\", \"o the route table in ASP.NET Core MVC, you would add the following during app\\nstartup:\\n\\napp.UseEndpo\", \"ints(endpoints =>\\n\\nendpoints .MapControllerRoute(\\nname: \\\"MyArea\\\",\\npattern: \\\"{area:exists}/{controlle\", \"r=Home}/{action=Index}/{id?}\\\") ;\\n\\nendpoints .MapControllerRoute(\\nname: \\\"default\\\",\\npattern: \\\"{control\", \"ler=Home}/{action=Index}/{id?}\\\") ;\\n\\n})5\\n\\nAreas can also be used with attribute routing, using the {a\", \"rea} keyword in the route definition (it's one\\nof several reserved routing names that can be used wi\", \"th route templates).\\n\\nTag helpers support areas with the asp-area attribute, which can be used to ge\", \"nerate links in Razor\\nviews and pages:\\n\\n<ul>\\n<li>\\n<a aSp-area=\\\"Products\\\" asp-controller=\\\"Home\\\" asp-a\", \"ction=\\\"About\\\">\\nProducts/Home/About\\n</a>\\n</li>\\n<li>\\n<a aSp-area=\\\"Services\\\" asp-controller=\\\"Home\\\" asp-\", \"action=\\\"About\\\">\\nServices About\\n</a>\\n</li>\\n<li>\\n<a asp-area=\\\"\\\" asp-controller=\\\"Home\\\" asp-action=\\\"Abou\", \"t\\\">\\n/Home/About\\n</a>\\n</li>\\n</ul>\\n\\nIf you're migrating to Razor Pages you will need to use an Areas f\", \"older in your Pages folder. For more\\ninformation, see Areas with Razor Pages.\\n\\nIn addition to the ab\", \"ove guidance, teams should review how routing in ASP.NET Core works with\\nareas as part of their migr\", \"ation planning process.\\n\\nIntegration tests for ASP.NET MVC and ASP.NET Web API\\n\\nIntegration tests ar\", \"e automated tests that verify several different parts of an app work together\\ncorrectly. Writing int\", \"egration tests for ASP.NET MVC and ASP.NET Web API usually involved deploying\\n\\n78 CHAPTER 4 | Exampl\", \"e migration of eShop to ASP.NET Core\\nthe app to a real web server, such as a local instance of IIS o\", \"r IIS Express, and then making requests to\\nthis hosted application using an HTTP client. Some of the\", \"se tests may interact with the client-side user\\ninterface using browser automation tools like Seleni\", \"um, though often these are referred to as U/ tests\\n\\nrather than integration tests.\\n\\nIf your migrated\", \" app shares the same behavior as its original version, whatever existing technology\\nthe team is usin\", \"g to perform integration tests (and UI tests) should continue to work just as it did\\nbefore. These t\", \"ests are usually indifferent to the underlying technology used to host the app they're\\ntesting, and \", \"interact with it only through HTTP requests. Where things may get more challenging is\\nwith how the t\", \"ests interact with the app to get it into a known good state prior to each test. This may\\nrequire so\", \"me migration effort, since configuration and startup are significantly different in ASP.NET\\nCore com\", \"pared to ASP.NET MVC or ASP.NET Web API.\\n\\nTeams should strongly consider migrating their integration\", \" tests to use ASP.NET Core\\u2019s built-in\\nintegration testing support. In ASP.NET Core, apps can be test\", \"ed by deploying them to a TestHost,\\nwhich is configured using a WebApplicationFactory. There's a lit\", \"tle bit of setup required to host the\\napp for testing, but once this is in place, creating individua\", \"l integration tests is very straightforward.\\n\\nOne of the best features of ASP.NET Core\\u2019s integration\", \" testing support is that the app is hosted in\\nmemory. There\\u2019s no need to configure a real webserver \", \"to host the app. There\\u2019s no need to use a\\nbrowser automation tool (if you're only testing ASP.NET Co\", \"re and not client-side behavior). Many of\\nthe problems that can be encountered when trying to use a \", \"real web server for automated integration\\ntests, such as firewall issues or process start/stop Issue\", \"s, are eliminated with this approach. Since the\\nrequests are all made in memory with no network requ\", \"irement, the tests also tend to run much faster\\nthan tests that must set up a separate webserver and\", \" communicate with it over the network (even if\\nit's running on the same machine).\\n\\nBelow you can see\", \" an example ASP.NET Core integration test (Sometimes referred to as functional\\ntests to distinguish \", \"them from lower-level integration tests) from the eshopOnWeb reference\\n\\napplication:\\n\\npublic class G\", \"etByIdEndpoint : IClassFixture<ApiTestFixture>\\n{\\n\\nJsonSerializerOptions _jsonOptions = new JsonSeria\", \"lizerOptions {\\nPropertyNameCaseInsensitive = true };\\n\\npublic GetByIdEndpoint(ApiTestFixture factory)\", \"\\n{\\n\\n}\\n\\npublic HttpClient Client { get; }\\n\\nClient = factory.CreateClient();\\n\\n[Fact |\\n\\npublic async Ta\", \"sk ReturnsItemGivenValidId()\\n\\n{\\nvar response = await Client.GetAsync(\\\"api/catalog-items/5\\\") ;\\nrespon\", \"se. EnsureSuccessStatusCode() ;\\nvar stringResponse = await response.Content.ReadAsStringAsync() ;\\nva\", \"r model = stringResponse.FromJson<GetByIdCatalogItemResponse>() ;\\n\\nAssert.Equal(5, model.CatalogItem\", \".Id) ;\\nAssert.Equal(\\\"Roslyn Red Sheet\\\", model.CatalogItem.Name) ;\\n\\n19 CHAPTER 4 | Example migration \", \"of eShop to ASP.NET Core\\nhe |\\n\\nIf the app being migrated has no integration tests, the migration pro\", \"cess can be a great opportunity\\nto add some. These tests can verify that the migrated app behaves as\", \" the team expects. When such\\ntests are in place early in a migration, they can ensure that later mig\", \"ration efforts do not break\\npreviously migrated portions of the app. Given how easy it is to set up \", \"and run integration tests in\\nASP.NET Core, the return on the investment spent setting up such tests \", \"is usually pretty high.\\n\\nWCF client configuration\\n\\nIf your app currently relies on WCF services as a\", \" client, this scenario is supported. However, you will\\nneed to migrate your configuration from web.c\", \"onfig to use the new appsettings.json file. Another\\noption is to add any necessary configuration to \", \"your clients programmatically when you create them.\\nFor example:\\n\\nvar wcfClient = new OrderServiceCl\", \"ient(\\n\\nnew BasicHttpBinding(BasicHttpSecurityMode.None) ,\\nnew EndpointAddress(\\\"http://localhost:5050\", \"/OrderService.svc\\\"));\\n\\nIf your organization has extensive services built using WCF that your app rel\", \"ies on, consider migrating\\nthem to use gRPC instead. For more details on gRPC, why you may wish to m\", \"igrate, and a detailed\\nmigration guide, consult the gRPC for WCF Developers eBook.\\n\\nReferences\\n\\n\\u00b0 AS\", \"P.NET Web API Content Negotiation\\n\\n\\u00b0 Format response data in ASP.NET Core Web API\\n\\u00b0 Custom Model Bin\", \"ders in ASP.NET Web API\\n\\n\\u00b0 Custom Model Binders in ASP.NET Core\\n\\u00b0 Media Formatters in ASP.NET Web AP\", \"I 2\\n\\n. Custom formatters in ASP.NET Core Web API\\n\\n. Filters in ASP.NET Core\\n\\n. Route constraints in \", \"ASP.NET Web API 2\\n\\n: Route constraints in ASP.NET MVC 5\\n\\n\\u00b0 ASP.NET Core Route Constraint Reference\\n\\n\", \"\\u00b0 Custom message handlers in ASP.NET Web API 2\\n. Simple CORS control in MVC 5 and Web API 2\\n\\n. Enabl\", \"ing Cross-Origin Requests in Web API\\n\\n\\u00b0 Enable Cross-Origin Requests (CORS) in ASP.NET Core\\n\\u00b0 Areas \", \"in ASP.NET Core\\n\\n\\u00b0 Integration tests in ASP.NET Core\\n\\n80 CHAPTER 4 | Example migration of eShop to A\", \"SP.NET Core\\nCHAPTER 5\\n\\nDeployment scenarios\\nwhen migrating to\\nASP.NET Core\\n\\nExisting ASP.NET MVC and\", \" Web API apps run on IIS and Windows. Large apps may require a phased\\nor side-by-side approach when \", \"porting to ASP.NET Core. In previous chapters, you learned a number\\nof strategies for migrating larg\", \"e .NET Framework apps to ASP.NET Core in phases. In this chapter, you\\nwill see how different deploym\", \"ent scenarios can be achieved when there is a need to maintain the\\noriginal app in production while \", \"migrating portions of it.\\n\\nSplit a large web app\\n\\nConsider the common scenario of a large web app th\", \"at currently is hosted on IIS in a single web site.\\nWithin the large app, functionality is segmented\", \" into different routes and/or directories. The app is a\\nmix of MVC views and API endpoints. The MVC \", \"routes include many different paths based on\\nfunctionality and all start from the root of the app us\", \"ing the standard /{controller}/{action}/{id?} route\\ntemplate. The API endpoints follow a similar pat\", \"tern, but are all under an /api root.\\n\\nAssuming the task of porting the app is split such that eithe\", \"r the MVC functionality or the API\\nfunctionality is migrated to ASP.NET Core first, how would the or\", \"iginal site continue to function\\nseamlessly with the new ASP.NET Core app running somewhere else? Us\", \"ers of the system should\\ncontinue to see the same URLs they did prior to the migration, unless it\\u2019s \", \"absolutely necessary to\\nchange them.\\n\\nFortunately, IIS is a feature-rich web server, and two feature\", \"s it has are URL Rewrite module and\\nApplication Request Routing. Using these features, IIS can act a\", \"s a reverse proxy, routing client\\nrequests to the appropriate back-end web app. To configure IIS as \", \"a reverse proxy, check the Enable\\nproxy checkbox in the Application Request Routing feature, then ad\", \"d a URL Rewrite rule like this one:\\n\\n<rule name=\\\"NetCoreProxy\\\">\\n<match url=\\\"(.*)>\\\" />\\n\\n<action type=\", \"\\\"Rewrite\\\" url=\\\"http://servername/{R:1}\\\" />\\n</rule>\\n\\nAs a reverse proxy, IIS can route traffic matchi\", \"ng certain patterns to entirely separate apps, potentially\\non different servers.\\n\\n81 CHAPTER 5 | Dep\", \"loyment scenarios when migrating to ASP.NET Core\\nUsing just the URL Rewrite module (perhaps combined\", \" with host headers), IIS can easily support\\nmultiple web sites, each potentially running different v\", \"ersions of .NET. A large web app might be\\ndeployed as a collection of individual sites, each respond\", \"ing to different IP addresses and/or host\\nheaders, or as a single web site with one or more sub-appl\", \"ications in it responding to certain URL\\npaths (which doesn't even require URL Rewrite).\\n\\nImportant\\n\", \"\\nSubdomains typically refer to the portion of a domain preceding the top two levels. For example, in\", \"\\nthe domain api.contoso.com, api is a subdomain of the contoso.com domain (which itself is\\n\\ncomposed\", \" of the contoso domain name and the .com top-level domain or TLD). URL paths refer to\\nportion of the\", \" URL that follows the domain name, starting with a /. The URL https://contoso.com/api\\nhas a path of \", \"/api.\\n\\nThere are pros and cons to using the same or different subdomains (and domains) to host a sin\", \"gle\\napp. Features like cookies and intra-app communication using mechanisms like CORS may require\\nmo\", \"re configuration to work properly in distributed apps. However, apps that use different\\nsubdomains c\", \"an more easily use DNS to route requests to entirely different network destinations, and\\nso can more\", \" easily be deployed to many different servers (virtual or otherwise) without the need for\\nIIS to act\", \" as a reverse proxy.\\n\\nIn the example described above, assume the API endpoints are designated as the\", \" first part of the app\\nto be ported to ASP.NET Core. In this case, a new ASP.NET Core app is created\", \" and hosted in IIS as a\\nseparate web application within the existing ASP.NET MVC web site. Since it \", \"will be added as a child of\\nthe original web site and will be named api, its default route should no\", \" longer begin with api/.\\nKeeping this would result in it matching URLs of the form /api/api/endpoint\", \".\\n\\nFigure 5-1 shows how the ASP.NET Core 2.1 api app appears in IIS Manager as a part of the existin\", \"g\\nDotNetMvcApp site.\\n\\n82 CHAPTER 5 | Deployment scenarios when migrating to ASP.NET Core\\nLE Internet\", \" Information Services (IIS) Manager _ O x\\nfe 3s @ >\\u00bb NIGHTKING >\\u00bb Sites \\u00bb DotNetMvcApp > | Kea jaxl \", \"fp @ ,\\nFile View Help\\nConnections DotNetMvcAo Hi \\u2018Actions\\nOUNETIVIVC ome\\n(2 w PP ry Explore\\n83 NIGHT\", \"KING (NIGHTKING : -ssions...\\n\\u00a5 4 Es . \\u2018 \\\\stey Filter: ~ WGo - & Show All Group by: Edit Permissions\\n\", \"~ (5% Application Pools -\\n. Edit Site\\nv (8) Sites IIS a me\\nv @ DotNetMvcApp ) = ry ne\\n-) aspnet_clie\", \"nt * o (= =) 404 [=] Basic Settings...\\nbin Authentic... Compression Default Directory \\u2014_ Error Pages\", \" View Applications\\n>) Content Document Browsing View Victusall DoE\\n\\u00bb -) fonts = a> | =\\n\\u00bb 5) Scripts \", \"Psd) = i.| jr \\u20ac Manage Website \\u201c\\n*\\n\\u2018 5 Views Handler HTIP Logging MIMETypes Modules e Restart\\n\\u2018nf P \", \"api Mappings __ Respon... \\u00bb Start\\na Gi. e= 2 B Stop\\ni = Browse Website\\nOutput Request SSL Settings B\", \"rowse *:80 (http)\\nCaching Filtering\\nAdvanced Settings...\\nManagement a\\n| Configure\\nS Limits...\\nConfig\", \"urat... HSTS...\\nEditor 7) Help\\n< >| [=/ Features View |i73 Content View\\n\\nFigure 5-1. .NET Framework \", \"Site with .NET Core app in IIS.\\n\\nThe DotNetMvcApp site is hosted as an MVC 5 app running on .NET Fra\", \"mework 4.7.2. It has its own IIS\\napp pool configured in integrated mode and running .NET CLR version\", \" 4.0.30319. The api app is an\\nASP.NET Core app running on .NET Framework 4.6.1 (net461). It was adde\", \"d to the DotNetMvcApp as a\\nnew IIS app and configured to use its own Application Pool. Its Applicati\", \"on Pool is also running in\\nintegrated mode but is configured with a .NET CLR version of No Managed C\", \"ode since it will be\\nexecuted using the ASP.NET Core Module. The version of the ASP.NET Core app is \", \"just an example. It\\ncould also be configured to run on NET 5+. Though at that point, it would no lon\", \"ger be able to target\\n.NET Framework libraries (see Choose the Right .NET Core Version)\\n\\nConfigured \", \"in this manner, the only change that must be made in order for the ASP.NET Core app\\u2019s\\nAPIs to be rou\", \"ted properly is to change its default route template from [Route(\\\"[api/controller]\\\")] to\\n[Route(\\\"[co\", \"ntroller]\\\")].\\n\\nAlternately the ASP.NET Core app can be another top-level web site in IIS. In this ca\", \"se, you can\\nconfigure the original site to use a rewrite rule (with URL Rewrite) that will redirect \", \"to the other app if\\nthe path starts with /api. The ASP.NET Core app can use a different host header \", \"for its route so that it\\ndoesn't conflict with the main app but can still respond to requests using \", \"root-based routes.\\n\\nAs an example, the same ASP.NET Core app used in Figure 5-1 can be deployed to a\", \"nother folder\\nconfigured as an IIS web site. The site should use an app pool configured just as befo\", \"re, with No\\n\\n83 CHAPTER 5 | Deployment scenarios when migrating to ASP.NET Core\\nManaged Code. Config\", \"ure its bindings to respond to a unique host name on the server, such as\\napi.contoso.com. To configu\", \"re URL Rewrite to rewrite requests matching /api just add a new inbound\\nrule at the IIS server (or i\", \"ndividual site) level. Match the pattern \\u201c/api(.*) and specify an Action type of\\nRewrite and a Rewri\", \"te URL of api.contoso.com/{R:1}. The combination of using (.*) in the matching\\npattern and {R:1} in \", \"the rewrite URL will ensure the rest of the path gets used with the new URL. With\\nthis in place, sep\", \"arate sites on the same IIS server can coexist running separate versions of .NET, but\\nthey can be ma\", \"de to appear to the Internet as one web app. Figure 5-2 shows the rewrite rule as\\nconfigured in IIS \", \"with the separate web site.\\n\\nwe Internet Information Services (IIS) Manager _ .\\nPP\\n\\u20ac @3 + NIGHTKING \", \"> wa @-\\nFile View Help\\nConnections . Actions\\noy Edit Inbound Rule y pop\\nv =| NIGHTKING (NIGHTKING\\\\st\", \"ey \\u201c =} Cancel\\nf ~ eppcation Pools pattern: @ Back to Rules\\n\\u2018@\\u00ae api.contoso.com |*/api.\\u201d) | @ Help\\n@\", \" DotNetMvcApp\\nIgnore case\\nConditions\\nServer Variables\\nAction\\nAction type:\\nRewrite v\\nAction Propertie\", \"s\\nRewrite URL:\\napi -contoso.com/{R:1} v\\n< >\\nConfiguration: \\u2018localhost\\u2019 applicationHost.config | f\\n\\nF\", \"igure 5-2. Rewrite rule to rewrite subfolder requests to another web site.\\n\\nIf your app requires sin\", \"gle sign-on between different sites or apps within IIS, refer to the\\n\\ndocumentation on how to share \", \"authentication cookies among ASP.NET apps for detailed instructions\\non supporting this scenario.\\n\\nAn\", \"other alternative to IIS Rewrite rules is the use of a reverse proxy like YARP, which can facilitate\", \"\\nincremental ASP.NET to ASP.NET Core Migration.\\n\\nSummary\\n\\nA common approach to porting large apps fr\", \"om .NET Framework to ASP.NET Core is to choose\\nindividual portions of the app to migrate one by one.\", \" As each piece of the app is ported, the entire\\napp remains running and usable, with some parts of i\", \"t running in its original configuration and other\\nparts running on some version of .NET Core. By fol\", \"lowing this approach, a large app migration can be\\nperformed incrementally. This approach results in\", \" limiting risk by providing more rapid feedback and\\n\\n84 CHAPTER 5 | Deployment scenarios when migrat\", \"ing to ASP.NET Core\\nreducing total surface area involved in testing. It also allows for more rapid r\", \"ealization of benefits of\\n.NET Core, such as performance increases. Although ASP.NET Core apps are n\", \"o longer required to be\\nhosted on IIS, IIS remains a very flexible and powerful web server that can \", \"be configured to support a\\nvariety of hosting scenarios involving both .NET Framework and ASP.NET Co\", \"re apps on the same IIS\\ninstance or even hosted on different servers.\\n\\nReferences\\n\\n- Host ASP.NET Co\", \"re on Windows with IIS\\n\\n\\u00b0 URL Rewrite module and Application Request Routing\\n\\u00b0 URL Rewrite\\n\\n\\u00b0 ASP.NE\", \"T Core Module\\n\\n\\u00b0 Share authentication cookies among ASP.NET apps\\n\\u00b0 Samples used in this section\\n\\u00b0 In\", \"cremental ASP.NET to ASP.NET Core Migration\\n\\n85 CHAPTER 5 | Deployment scenarios when migrating to A\", \"SP.NET Core\\nCHAPTER\\n\\nSummary: Port existing\\nASP.NET Apps to .NET /\\n\\nIn this book, you've been given \", \"the resources needed to decide whether it makes sense to port your\\norganization's existing ASP.NET a\", \"pps running on .NET Framework to ASP.NET Core. You've learned\\nabout important considerations for cho\", \"osing when it makes sense to migrate to .NET Core, and when\\nit may be appropriate to keep (parts of)\", \" your app on .NET Framework. There are differences between\\n.NET Core versions and their capabilities\", \" and compatibilities with .NET Framework, and you learned\\n\\nhow to choose the right version of .NET C\", \"ore for your app.\\n\\nPorting a large app often entails a fair amount of risk and effort. You learned h\", \"ow to mitigate this risk\\n\\nby employing one or more incremental migration strategies along with sever\", \"al deployment strategies\\nfor keeping partially migrated apps running in production.\\n\\nThere are many \", \"architectural differences between ASP.NET and ASP.NET Core. In chapter 2, you\\nlearned about many of \", \"these differences and how they relate to your app\\u2019s migration. This chapter\\ncovered everything from \", \"app startup and low-level middleware to high-level controller and Web API\\ndifferences and new featur\", \"es enabling much better testing scenarios.\\n\\nLarge apps are often comprised of many projects and pack\", \"ages, and dependencies can play a major\\nrole in determining how easy or difficult migration may be. \", \"Chapter 3 helped you identify the\\n\\nsequence in which to migrate projects and how to understand and u\", \"pdate your app\\u2019s dependencies. It\\nalso detailed additional strategies for migrating apps while keepi\", \"ng them running in production.\\n\\nIn chapter 4, you saw how a real ASP.NET MVC reference app was migra\", \"ted to ASP.NET Core. This\\nchapter included a detailed breakdown of all the changes that were needed \", \"to take the existing app\\n\\nand port it over to run on ASP.NET Core. Refer back to it if you have spec\", \"ific questions about the\\nporting process and some of its more specific details.\\n\\nFinally, chapter 5 \", \"detailed specific deployment scenarios focused on IIS. You saw how you can use\\nyour existing IIS web\", \" server to host parts of your app that have been ported to ASP.NET Core while\\n\\nkeeping the app\\u2019s pub\", \"lic URLs consistent. IIS includes great support for URL rewriting and request\\nrouting that enables i\", \"t to host multiple versions of your site side by side or even on different servers,\\nwith no change t\", \"o the public-facing URLs the app exposes.\\n\\n86 CHAPTER 6 | Summary: Port existing ASP.NET Apps to .NE\", \"T 7\\n\"]"