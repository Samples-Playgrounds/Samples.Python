"[\"![](_page_0_Picture_0.jpeg)\\n\\n# Porting existing ASP.NET apps to .NET 7\\n\\n![](_page_0_Picture_2.jpeg)\\n\", \"\\nSteve \\\"ardalis\\\" Smith\\n\\n![](_page_1_Picture_0.jpeg)\\n\\nPUBLISHED BY\\n\\nMicrosoft Developer Division, .NE\", \"T, and Visual Studio product teams\\n\\nA division of Microsoft Corporation\\n\\nOne Microsoft Way\\n\\nRedmond,\", \" Washington 98052-6399\\n\\nCopyright \\u00a9 2023 by Microsoft Corporation\\n\\nAll rights reserved. No part of t\", \"his book's contents may be reproduced or transmitted in any form or by any means without the written\", \" permission of the publisher.\\n\\nThis book is provided \\\"as-is\\\" and expresses the author's views and op\", \"inions. The views, opinions, and information expressed in this book, including URL and other Interne\", \"t website references, may change without notice.\\n\\nSome examples depicted herein are provided for ill\", \"ustration only and are fictitious. No real association or connection is intended or should be inferr\", \"ed.\\n\\nMicrosoft and the trademarks listed at [https://www.microsoft.com](https://www.microsoft.com/) \", \"on the \\\"Trademarks\\\" webpage are trademarks of the Microsoft group of companies.\\n\\nMac and macOS are t\", \"rademarks of Apple Inc.\\n\\nThe Docker whale logo is a registered trademark of Docker, Inc. Used by per\", \"mission.\\n\\nAll other marks and logos are property of their respective owners.\\n\\nAuthors:\\n\\n**Steve \\\"ard\", \"alis\\\" Smith**, Software Architect and Trainer - [Ardalis.com](https://ardalis.com/)\\n\\nParticipants an\", \"d Reviewers:\\n\\n**Nish Anil**, Senior Program Manager, .NET team, Microsoft\\n\\n**Mike Rousos**, Principa\", \"l Software Engineer, .NET team, Microsoft\\n\\n**Scott Addie**, Senior Content Developer, .NET team, Mic\", \"rosoft\\n\\n**David Pine**, Senior Content Developer, .NET team, Microsoft\\n\\n# Version\\n\\nThis guide covers\", \" **.NET 7** and updates related to the same technology \\\"wave\\\" (that is, Azure and other third-party \", \"technologies) coinciding in time with the .NET 7 release. This book covers migration of apps that ar\", \"e currently running on .NET Framework 4.x.\\n\\n# Who should use this guide\\n\\nThis guide's audience is de\", \"velopers, development leads, and architects who are interested in migrating their existing apps writ\", \"ten for ASP.NET MVC and Web API (.NET Framework 4.x) to the latest\\n\\n![](_page_2_Picture_0.jpeg)\\n\\n.NE\", \"T version. ASP.NET Web Forms developers will benefit from this guide but should also read the [Blazo\", \"r for ASP.NET Web Forms Developers](https://docs.microsoft.com/en-us/dotnet/architecture/blazor-for-\", \"web-forms-developers/) e-book.\\n\\nA secondary audience is technical decision-makers planning when to m\", \"ove their apps to .NET 7.\\n\\nThe target audience for this book is .NET developers with large, existing\", \" apps that run on ASP.NET MVC and Web API. Apps built on ASP.NET Web Forms are outside of the focus \", \"of this book, though much of the information comparing .NET Framework and .NET Core/latest may still\", \" be relevant.\\n\\n# How you can use this guide\\n\\nYou can read this book straight through, as we expect m\", \"any readers to do. This book will provide you first with considerations for whether you should port \", \"your app at all. That content is followed by architectural differences between .NET Framework and .N\", \"ET Core. From there, you'll learn strategies for migrating a large solution over time and how to por\", \"t a real app. Next, the book includes deployment scenarios that address the need to run different ap\", \"ps while appearing as a single app to users. The book concludes with two case studies describing rea\", \"l apps that have migrated from ASP.NET MVC to ASP.NET Core.\\n\\nWhether or not you choose to start from\", \" the first chapter, you can reference any of these chapters to learn about specific concepts:\\n\\n- Arc\", \"hitectural differences\\n- [Migrate large solutions](#page-40-0)\\n- Sample migration\\n- Deployment scena\", \"rios\\n\\nThis guide is available both in [PDF form](https://aka.ms/aspnet-porting-ebook) and online. Fe\", \"el free to forward this document or links to its online version to your team to ensure a common unde\", \"rstanding of these concepts.\\n\\n# Contents\\n\\n| Introduction to porting apps to .NET 7                  \", \"| 1 |\\n|---------------------------------------------------------|---|\\n| References                  \", \"                            | 2 |\\n| Migration considerations                                | 2 |\\n| \", \"Is migration to .NET Core appropriate?                  | 2 |\\n| When is .NET Framework appropriate? \", \"                    | 3 |\\n| References                                              |   |\\n| Migrate \", \"to ASP.NET Core 2.1                             | \\u2220 |\\n| Should apps run on .NET Framework with ASP.N\", \"ET Core 2.1 |   |\\n| References                                              | 5 |\\n| Choose the right\", \" .NET Core version                      | 5 |\\n| References                                          \", \"    | 5 |\\n| Strategies for migrating incrementally                  | 6 |\\n| Migrating slice by slice\", \"                                | 6 |\\n| Migrating layer by layer                                | 6 \", \"|\\n| References                                              |   |\\n| Strategies for migrating ASP.NET\", \" Web Forms apps         | 7 |\\n| Separate business logic and other concerns              | 7 |\\n| Impl\", \"ement client behavior and web APIs                  | 8 |\\n| Consider Blazor                         \", \"                |   |\\n| Summary                                                 | 3 |\\n| References  \", \"                                            | 3 |\\n| Deployment strategies                           \", \"        |   |\\n| Cross-platform options                                  | 8 |\\n| Cloud native develop\", \"ment                                | C |\\n| Leverage containers                                     \", \"|   |\\n| Side-by-side deployment options                         |   |\\n| IIS on Windows              \", \"                            |   |\\n| Other options on Windows                                |   |\\n\\n|\", \" References                                                            | S  |\\n|---------------------\", \"--------------------------------------------------|----|\\n| Additional migration resources           \", \"                             | 10 |\\n| Official documentation                                        \", \"        | 10 |\\n| GitHub                                                                | 10 |\\n| Stac\", \"k Overflow                                                        | 11 |\\n| YouTube channels         \", \"                                             | 11 |\\n| Twitter, Gitter, Slack, and other community ch\", \"annels                  | 11 |\\n| References                                                         \", \"   | 11 |\\n| Architectural differences between ASP.NET MVC and ASP.NET Core        | 12 |\\n| Breaking \", \"changes                                                      | 12 |\\n| App startup differences betwee\", \"n ASP.NET MVC and ASP.NET Core          | 12 |\\n| ASP.NET MVC Startup                                \", \"                   | 13 |\\n| ASP.NET Core Startup                                                  | \", \"13 |\\n| Porting considerations                                                | 14 |\\n| References    \", \"                                                        | 14 |\\n| Hosting differences between ASP.NET\", \" MVC and ASP.NET Core              | 14 |\\n| References                                              \", \"              | 15 |\\n| Serve static files in ASP.NET MVC and ASP.NET Core                    | 15 |\\n\", \"| Host static files in ASP.NET MVC                                      | 15 |\\n| Host static files i\", \"n ASP.NET Core                                     | 15 |\\n| References                              \", \"                              | 16 |\\n| Dependency injection differences between ASP.NET MVC and ASP.\", \"NET Core | 16 |\\n| Dependency injection in ASP.NET Core                                  | 16 |\\n| Ref\", \"erences                                                            | 17 |\\n| Compare middleware to mo\", \"dules and handlers                            | 17 |\\n| ASP.NET modules and handlers                 \", \"                         | 17 |\\n| ASP.NET Core middleware                                           \", \"    | 17 |\\n| Accessing HttpContext                                                 | 17 |\\n| Referenc\", \"es                                                            |    |\\n| Configuration differences bet\", \"ween ASP.NET MVC and ASP.NET Core        |    |\\n| ASP.NET MVC configuration                         \", \"                    | 19 |\\n| ASP NET Core configuration                                            |\", \" 19 |\\n\\n| Migrate configuration                                                           | 20 |\\n|---\", \"------------------------------------------------------------------------------|----|\\n| References   \", \"                                                                   | 21 |\\n| Routing differences betw\", \"een ASP.NET MVC and ASP.NET Core                        | 21 |\\n| Routing in ASP.NET MVC and Web API \", \"                                             | 21 |\\n| Route table                                   \", \"                                  | 21 |\\n| Routing in .NET 7                                        \", \"                       | 23 |\\n| References                                                          \", \"            | 24 |\\n| Logging differences between ASP.NET MVC and ASP.NET Core                       \", \" | 25 |\\n| ASP.NET MVC logging                                                             | 25 |\\n| A\", \"SP.NET Core logging                                                            | 25 |\\n| Migrate logg\", \"ing                                                                 | 26 |\\n| References             \", \"                                                         | 26 |\\n| Compare Razor Pages to ASP.NET MVC\", \"                                              | 26 |\\n| References                                   \", \"                                   | 27 |\\n| Compare ASP.NET Web API 2 and ASP.NET Core              \", \"                        | 27 |\\n| References                                                         \", \"             | 27 |\\n| Compare authentication and authorization between ASP.NET MVC and ASP.NET Core \", \"  | 27 |\\n| Authorization                                                                   | 28 |\\n| \", \"References                                                                      | 28 |\\n| Compare ASP\", \".NET Identity and ASP.NET Core Identity                              | 28 |\\n| Migrate from OWIN / Ka\", \"tana                                                      | 29 |\\n| References                       \", \"                                               | 29 |\\n| Compare controllers in ASP.NET MVC and Web A\", \"PI with controllers in ASP.NET Core | 29 |\\n| References                                             \", \"                         | 30 |\\n| Compare Razor usage in ASP.NET MVC and ASP.NET Core               \", \"              | 30 |\\n| Tag Helpers                                                                  \", \"   | 30 |\\n| Razor Pages                                                                     | 30 |\\n|\", \" References                                                                      | 31 |\\n| Compare AS\", \"P.NET SignalR and ASP.NET Core SignalR                                | 31 |\\n| Feature differences  \", \"                                                           | 31 |\\n| References                      \", \"                                                | 31 |\\n| Compare testing options between ASP.NET MVC\", \" and ASP.NET Core                    | 32 |\\n\\n| References                                           \", \"   | 32 |\\n|---------------------------------------------------------|----|\\n| Migrate large solutions\", \" to ASP.NET Core                 | 33 |\\n| References                                              | \", \"   |\\n| Identify sequence of projects to migrate                |    |\\n| Unit tests                  \", \"                            |    |\\n| Considerations for migrating many apps                  | 37 |\\n\", \"| Summary                                                 | 38 |\\n| References                       \", \"                       | 38 |\\n| Understand and update dependencies                      | 38 |\\n| Upd\", \"ate class library dependencies                       | 38 |\\n| Update NuGet package dependencies     \", \"                  | 39 |\\n| Migrate ASP.NET MVC projects                            | 40 |\\n| Referenc\", \"es                                              | 40 |\\n| Strategies for migrating while running in p\", \"roduction    | 4( |\\n| Refactor the .NET Framework solution                    | 40 |\\n| Extract front\", \"-end assets to a CDN                       | 4  |\\n| Extract and migrate individual microservices    \", \"        | 4  |\\n| Deploy multiple versions of the app side-by-side in IIS | 4  |\\n| Apply the Strangle\", \"r pattern                             | 4  |\\n| Multi-targeting approaches                           \", \"   | 42 |\\n| Summary                                                 | 42 |\\n| References             \", \"                                 | 42 |\\n| Example migration of eShop to ASP.NET Core              | \", \"43 |\\n| Run <i>ApiPort</i> to identify problematic APIs         | 44 |\\n| Update project files and NuG\", \"et reference syntax         | 47 |\\n| Create new ASP.NET Core project                         | 49 |\\n\", \"| Migrating NuGet Packages                                | 5\\u00b4 |\\n| Migrate static files             \", \"                       | 53 |\\n| Migrate C# files                                        | 54 |\\n| Mig\", \"rate views                                           | 56 |\\n| Migrate app startup components        \", \"                  | 58 |\\n| Configure MVC                                           | 58 |\\n\\n| Data ac\", \"cess considerations                                       | 63 |\\n|----------------------------------\", \"--------------------------------|----|\\n| Migrate to Entity Framework Core                           \", \"      | 64 |\\n| Fix all TODO tasks                                               | 67 |\\n| Additional \", \"MVC customizations                                    | 68 |\\n| Other dependencies                   \", \"                            | 69 |\\n| References                                                     \", \"  | 69 |\\n| More migration scenarios                                         | 69 |\\n| Migrate ASP.NET\", \" MVC 5 and WebApi 2 to ASP.NET Core MVC           | 69 |\\n| Migrate HttpResponseMessage to ASP.NET Co\", \"re                      | 70 |\\n| Migrate content negotiation from ASP.NET Web API to ASP.NET Core | \", \"71 |\\n| Custom model binding                                             | 71 |\\n| Media formatters   \", \"                                              | 73 |\\n| Custom filters                               \", \"                    | 73 |\\n| Route constraints                                                | 74 |\", \"\\n| Custom route handlers                                            | 75 |\\n| CORS support           \", \"                                          | 76 |\\n| Custom areas                                     \", \"                | 77 |\\n| Integration tests for ASP.NET MVC and ASP.NET Web API            | 78 |\\n| W\", \"CF client configuration                                         | 80 |\\n| References                 \", \"                                      | 80 |\\n| Deployment scenarios when migrating to ASP.NET Core  \", \"            | 81 |\\n| Split a large web app                                            | 81 |\\n| Summa\", \"ry                                                          | 84 |\\n| References                     \", \"                                  | 85 |\\n| Summary: Port existing ASP.NET Apps to .NET 7            \", \"        | 86 |\\n\\n**CHAPTER** 1\\n\\n# <span id=\\\"page-8-0\\\"></span>Introduction to porting apps to .NET 7\\n\\n\", \".NET Core and its latest version, .NET 7, represent a revolutionary step forward from .NET Framework\", \". It offers a host of advantages over .NET Framework across the board from productivity to performan\", \"ce, from cross-platform support to developer satisfaction. ASP.NET Core was even voted the most-love\", \"d web framework (tied with Svelte) in the [2021 Stack Overflow developer survey.](https://insights.s\", \"tackoverflow.com/survey/2021#technology-most-loved-dreaded-and-wanted) Clearly there are strong reas\", \"ons to consider migrating.\\n\\nEven before .NET 7 shipped, Microsoft was clear: [.NET Core is the Futur\", \"e of .NET.](https://devblogs.microsoft.com/dotnet/net-core-is-the-future-of-net/) To quote this arti\", \"cle:\\n\\nNew apps should be built on .NET Core. .NET Core is where future investments in .NET will happ\", \"en. Existing apps are safe to remain on .NET Framework which will be supported. Existing apps that w\", \"ant to take advantage of the new features in .NET should consider moving to .NET Core. As we plan in\", \"to the future, we will be bringing in even more capabilities to the platform.\\n\\nToday, .NET 7 is what\", \" new apps should target, and if you're migrating an existing app from .NET Framework, .NET 7 is your\", \" ideal target framework.\\n\\nHowever, upgrading your app to ASP.NET Core will require some effort. That\", \" effort should be balanced against business value and goals. .NET Framework apps have a long life ah\", \"ead of them, with support built into Windows for the foreseeable future. What are some of the questi\", \"ons you should consider before deciding migration to .NET 7 is appropriate? What are the expected ad\", \"vantages? What are the tradeoffs? How much effort is involved? These obvious questions are just the \", \"beginning, but make for a great starting point as teams consider how to support their customers' nee\", \"ds with apps today and tomorrow.\\n\\n- Is migration to .NET 7 appropriate?\\n- When does it make sense to\", \" remain on .NET Framework?\\n- Should apps target ASP.NET Core 2.1 as a stepping stone?\\n- How should t\", \"eams choose the right .NET version to target?\\n- What strategies are recommended for incremental migr\", \"ation of large apps?\\n- What deployment strategies should be considered when porting to .NET 7?\\n- Whe\", \"re can we find additional resources?\\n\\nThis introductory chapter addresses all of these questions and\", \" more before moving on to more specific and technical considerations in future chapters.\\n\\n# <span id\", \"=\\\"page-9-0\\\"></span>References\\n\\n- [2021 Stack Overflow developer survey most loved web frameworks](ht\", \"tps://insights.stackoverflow.com/survey/2021#technology-most-loved-dreaded-and-wanted)\\n- [.NET Core \", \"is the Future of .NET](https://devblogs.microsoft.com/dotnet/net-core-is-the-future-of-net/)\\n\\n# <spa\", \"n id=\\\"page-9-1\\\"></span>Migration considerations\\n\\nThe most fundamental question teams must answer whe\", \"n it comes to porting their apps to .NET Core is, should they port at all? In some cases, the best p\", \"ath forward is to remain on .NET Framework using ASP.NET MVC and/or Web API. This chapter considers \", \"reasons why moving to .NET Core makes sense. The chapter also considers scenarios and counterpoints \", \"for staying on .NET Framework.\\n\\n#### <span id=\\\"page-9-2\\\"></span>**Is migration to .NET Core appropri\", \"ate?**\\n\\nLet's start with some of the reasons why you might want to move to .NET Core/.NET 7. There a\", \"re quite a few, so don't consider this list exhaustive.\\n\\n#### **Cross-platform support**\\n\\nApps built\", \" on .NET Core are truly cross-platform and can run on Windows, Linux, and macOS. Not only can your d\", \"evelopers use whatever hardware they want, but you can also host your app anywhere. Examples range f\", \"rom local IIS to Azure in the cloud or from Linux Docker containers to IoT devices.\\n\\n#### **Performa\", \"nce and scalability**\\n\\nApps built with .NET Core are running on [one of the fastest tech stacks avai\", \"lable anywhere.](https://www.techempower.com/benchmarks/#hw=ph&test=plaintext) ASP.NET MVC apps ofte\", \"n see performance improvements on ASP.NET Core, especially if they're updated to take advantage of s\", \"ome new features available in .NET Core.\\n\\n#### **Cloud-native**\\n\\nFor the above reasons and others, .\", \"NET Core apps are well-suited to running in cloud hosting environments. Lightweight and fast, .NET C\", \"ore apps can be deployed to Azure App Services or containers and scaled horizontally as needed to me\", \"et immediate system demand.\\n\\n#### **Maintainable**\\n\\nFor many apps, while they've continued to meet c\", \"ustomer and business needs, technical debt has accumulated and maintaining the app has grown expensi\", \"ve. ASP.NET Core apps are more easily tested than ASP.NET MVC apps, making them easier to refactor a\", \"nd extend with confidence.\\n\\n#### **Modular**\\n\\nASP.NET Core is modular, using NuGet packages as a fir\", \"st-class part of the framework. Apps built for .NET Core all support dependency injection, making it\", \" easy to compose solutions from whatever implementations are needed for a given environment. Buildin\", \"g microservices with .NET Core is easier than with ASP.NET MVC with its dependency on IIS, which ope\", \"ns up additional options to break up large apps into smaller modules.\\n\\n#### **Modern**\\n\\nStaying on a\", \" modern, actively developed technology stack has a host of advantages. New features and C# language \", \"features will only be added to .NET Core. The .NET Framework has had its last release with version 4\", \".8, and versions of C# beyond 8 won't target .NET Framework. While ASP.NET MVC will remain supported\", \" by Microsoft for many years, the best and brightest .NET software developers are likely looking to \", \"use the more modern .NET Core framework, with all of the advantages it offers (only some of which ar\", \"e summarized above). Finding developers with the skills to maintain an ASP.NET MVC app will start to\", \" become a challenge at some point, as will finding online training and troubleshooting assistance. T\", \"here probably aren't that many new blog posts being written about ASP.NET MVC 5, while there are ple\", \"nty being written for .NET 7, for example.\\n\\nThere are many compelling reasons to consider migrating \", \"to .NET Core, which presumably is why you're reading this book! But let's consider some disadvantage\", \"s and reasons why it may make more sense to remain on the .NET Framework.\\n\\n#### <span id=\\\"page-10-0\\\"\", \"></span>**When is .NET Framework appropriate?**\\n\\nThe biggest reason to stay on .NET Framework is whe\", \"n an app isn't under active development and wouldn't benefit substantially from the advantages liste\", \"d above. In that case, there probably isn't a good business case to incur the cost of porting the ap\", \"p. If your app might benefit from the advantages .NET Core offers, you may still need to stay on .NE\", \"T Framework if you need certain technologies that are unavailable on .NET Core. There are some [.NET\", \" technologies that are unavailable](https://docs.microsoft.com/en-us/dotnet/core/porting/net-framewo\", \"rk-tech-unavailable)  [on .NET Core,](https://docs.microsoft.com/en-us/dotnet/core/porting/net-frame\", \"work-tech-unavailable) including AppDomains, Remoting, Code Access Security (CAS), Security Transpar\", \"ency, and System.EnterpriseServices. A brief summary of these technologies and their alternatives is\", \" included here. For more detailed guidance, see the documentation.\\n\\n#### **Application domains**\\n\\nAp\", \"plication domains (AppDomains) isolate apps from one another. AppDomains require runtime support and\", \" can be expensive. Creating additional app domains isn't supported, and there are no plans to add th\", \"is capability to .NET Core in the future. For code isolation, use separate processes or containers a\", \"s an alternative. Some customers use AppDomains as a way of unloading assemblies. In .NET Core [Asse\", \"mblyLoadContext](https://docs.microsoft.com/en-us/dotnet/standard/assembly/unloadability) provides a\", \"n alternative way to unload assemblies.\\n\\n#### **WCF**\\n\\n.NET Core and .NET 5+ support WCF clients. Se\", \"rver-side WCF is possible through [CoreWCF,](https://www.nuget.org/profiles/corewcf) which is offici\", \"ally supported by Microsoft as of April 2022. Apps that require server-side WCF functionality can al\", \"so consider a different communication technology (such as gRPC or REST) as part of a migration.\\n\\nThe\", \"re is a [WCF client port available from the .NET Foundation](https://docs.microsoft.com/en-us/dotnet\", \"/core/whats-new/dotnet-5#windows-communication-foundation). It's entirely open source, cross platfor\", \"m, and supported by Microsoft.\\n\\nTo learn more about migrating from WCF to gRPC, consult the [gRPC fo\", \"r WCF Developers](https://docs.microsoft.com/en-us/dotnet/architecture/grpc-for-wcf-developers/) ebo\", \"ok.\\n\\n#### **Remoting**\\n\\n.NET Remoting was identified as a problematic architecture. It's used for cr\", \"oss-AppDomain communication, which is no longer supported. Also, Remoting requires runtime support, \", \"which is expensive to maintain. For these reasons, .NET Remoting isn't supported on .NET Core, and t\", \"he product team doesn't plan on adding support for it in the future. There are several alternative m\", \"essaging strategies and implementations you can use to replace remoting in your .NET Core apps.\\n\\n###\", \"# **Code Access Security (CAS) and Security Transparency**\\n\\nNeither of these technologies are suppor\", \"ted by .NET Core. Instead, the recommendation is to use security boundaries provided by the operatin\", \"g system. For example, virtualization, containers, or user accounts. Run processes with the minimal \", \"set of privileges necessary.\\n\\n#### <span id=\\\"page-11-0\\\"></span>**References**\\n\\n[.NET Framework Techn\", \"ologies Unavailable on .NET Core](https://docs.microsoft.com/en-us/dotnet/core/porting/net-framework\", \"-tech-unavailable)\\n\\n# <span id=\\\"page-11-1\\\"></span>Migrate to ASP.NET Core 2.1\\n\\nASP.NET Core 2.1 is a\", \"n interesting release because it's the most recently supported ASP.NET Core release that supported b\", \"oth .NET Core and .NET Framework runtimes. As such, it may offer an easier upgrade path for some app\", \"s when compared to upgrading all parts of the app to .NET Core/.NET 7 at once. Although support for \", \".NET Core 2.1 ended in August 2021, it may make sense as an interim step for some apps. Also, suppor\", \"t for ASP.NET Core 2.1 running on .NET Framework will continue for as long as [its underlying .NET F\", \"ramework is supported.](https://docs.microsoft.com/lifecycle/products/microsoft-net-framework) A com\", \"plete [list of currently supported ASP.NET](https://dotnet.microsoft.com/platform/support/policy/asp\", \"netcore-2.1)  [Core 2.1 packages](https://dotnet.microsoft.com/platform/support/policy/aspnetcore-2.\", \"1) is available for reference.\\n\\n#### <span id=\\\"page-11-2\\\"></span>**Should apps run on .NET Framework\", \" with ASP.NET Core 2.1**\\n\\nASP.NET Core 2.2 and earlier supported both .NET Core and .NET Framework r\", \"untimes. Does it make sense to migrate some or all of an app to ASP.NET Core 2.1 as a stepping stone\", \", before porting over completely to .NET Core? Apps, or subsets of apps, could see their front-end A\", \"SP.NET logic ported to use ASP.NET Core, while still consuming .NET Framework libraries for business\", \" logic and infrastructure consumption. This approach may make sense when there's a relatively thin U\", \"I layer without much business logic, and a much larger set of functionality in class libraries.\\n\\nThe\", \" main benefit of porting just the front-end web layer to ASP.NET Core 2.1 is that the existing .NET \", \"class libraries can remain as is during the initial migration. They may be in continued use by other\", \" .NET apps or simply don't need to be in scope for the first iteration of a planned full migration t\", \"o .NET Core. Reducing the scope of the initial migration for large apps helps provide incremental go\", \"als that act as stepping stones toward the desired end state, which is often a complete port to .NET\", \" Core.\\n\\nIf you have an existing app that may use this strategy, some things you can do today to help\", \" prepare for the process are to move as much business logic, data access, and other non-UI logic out\", \" of the ASP.NET projects and into separate class libraries as possible. It will also help if you hav\", \"e automated\\n\\ntest coverage of your system, so that you can verify behavior remains consistent before\", \" and after the migration.\\n\\nIf your app is so large that you can't migrate the entire web app at once\", \", and you need to be able to deploy the new ASP.NET Core app side-by-side with the existing ASP.NET \", \"app, there are deployment strategies that can be used to achieve this. These are covered in Chapter \", \"5: Deployment Scenarios.\\n\\nKeep in mind that ASP.NET Core 2.1 was the last LTS release of .NET Core t\", \"hat supported running on .NET Framework and consuming .NET Framework libraries. Although the release\", \" is now unsupported on .NET Core, it continues to be supported for use with .NET Framework. It will \", \"remain supported for as long as the specific .NET Framework version is supported. For more informati\", \"on, see [ASP.NET Core](https://dotnet.microsoft.com/platform/support/policy/dotnet-core)  [2.1 on .N\", \"ET Framework.](https://dotnet.microsoft.com/platform/support/policy/dotnet-core)\\n\\n#### <span id=\\\"pag\", \"e-12-0\\\"></span>**References**\\n\\n[Migrating from ASP.NET to ASP.NET Core 2.1](https://docs.microsoft.c\", \"om/aspnet/core/migration/proper-to-2x/?preserve-view=true&view=aspnetcore-2.1) [ASP.NET Core 2.1 on \", \".NET Framework](https://dotnet.microsoft.com/platform/support/policy/dotnet-core) [ASP.NET Core 2.1]\", \"(https://dotnet.microsoft.com/en-us/platform/support/policy/aspnetcore-2.1)  [Supported Packages](ht\", \"tps://dotnet.microsoft.com/en-us/platform/support/policy/aspnetcore-2.1)\\n\\n# <span id=\\\"page-12-1\\\"></s\", \"pan>Choose the right .NET Core version\\n\\nThe largest consideration for most organizations when choosi\", \"ng which version of .NET to target is the support lifecycle. Long Term Support (LTS) releases ship l\", \"ess frequently but have a longer support window than Standard Term Support (STS) releases. Currently\", \", LTS releases are scheduled to ship every other year. Customers can choose which releases to target\", \", and can install different releases of .NET side by side on the same machine. LTS releases will rec\", \"eive only critical and compatible fixes throughout their lifecycle. STS releases will receive these \", \"same fixes and will also be updated with compatible innovations and features. LTS releases are suppo\", \"rted for three years after their initial release. STS releases are supported for six months after a \", \"subsequent STS or LTS release.\\n\\n.NET 7 is the latest STS release; .NET 6 is the latest LTS release.\\n\", \"\\nCustomers looking to migrate a large .NET Framework app to .NET today may be looking for a stable d\", \"estination, given that they haven't already made the move to an earlier version of .NET Core. In thi\", \"s case, the best .NET version to target for the migration is .NET 6, which is the most recent LTS ve\", \"rsion. While support for .NET Core 3.1 ended in December 2022, support for .NET 6 will continue unti\", \"l November 2024.\\n\\nOther customers may want to ensure they're upgrading to the latest supported versi\", \"on, so that postmigration they're not already behind a version. These customers will want to target \", \".NET 7 for the migration.\\n\\nIn either case, there is very little difference in the migration process.\", \" This book assumes .NET Framework apps will be upgraded to .NET 7.\\n\\n#### <span id=\\\"page-12-2\\\"></span\", \">**References**\\n\\n[.NET and .NET Core Support Policy](https://dotnet.microsoft.com/platform/support/p\", \"olicy/dotnet-core)\\n\\n# <span id=\\\"page-13-0\\\"></span>Strategies for migrating incrementally\\n\\nThe bigges\", \"t challenge with migrating any large app is determining how to break the process into smaller tasks.\", \" There are several strategies that can be applied for this purpose, including breaking the app into \", \"horizontal layers such as UI, data access, business logic, or breaking up the app into separate, sma\", \"ller apps. Another strategy is to upgrade some or all of the app to different framework versions on \", \"the way to a recent .NET Core release. One approach you could use is to migrate [vertical slices](ht\", \"tps://deviq.com/practices/vertical-slices) of the app, rather than attempting to migrate one horizon\", \"tal layer at a time. Let's consider each of these different approaches.\\n\\n#### <span id=\\\"page-13-1\\\"><\", \"/span>**Migrating slice by slice**\\n\\nOne successful approach to migrating is to identify vertical sli\", \"ces of functionality and migrate them to the target platform one by one. The first step is to create\", \" a new ASP.NET Core 7 app. Next, identify the individual page or API endpoint that will be migrated \", \"first. Build out just the necessary functionality to support this one route in the new ASP.NET Core \", \"app. Then use HTTP rewriting and/or a reverse proxy to start sending requests for these pages or end\", \"points to the new app rather than the ASP.NET app. This approach is well-suited to API projects, but\", \" can also work for many MVC apps.\\n\\nWhen migrating slice by slice, the entire stack of the individual\", \" API endpoint or requested route is recreated in the new project or solution. The very first such sl\", \"ice typically requires the most effort, since it will typically need several projects to be created \", \"and decisions to be made about data access and solution organization. Once the first slice's functio\", \"nality mirrors the existing app's, it can be deployed and the existing app can redirect to it or sim\", \"ply be removed. This approach is then repeated until the entire app has been ported to the new struc\", \"ture.\\n\\nSome specific guidance on how to follow this strategy using IIS is covered in Chapter 5, Depl\", \"oyment Scenarios.\\n\\n#### <span id=\\\"page-13-2\\\"></span>**Migrating layer by layer**\\n\\nConsider the chall\", \"enge of migrating a large ASP.NET 4.5 app. One approach is to migrate the entire app directly from .\", \"NET Framework 4.5 to .NET 7. However, this approach needs to account for every breaking change betwe\", \"en the two frameworks and versions, which are substantial. Performing this work on one project at a \", \"time provides a set of stepping stones so that the entire solution doesn't need to be moved at once.\", \"\\n\\nOne piece of the .NET ecosystem that helps with interoperability between different .NET frameworks\", \" is [.NET Standard.](https://dotnet.microsoft.com/platform/dotnet-standard) .NET Standard allows lib\", \"raries to build against an agreed upon set of common APIs, ensuring they can be used in any .NET app\", \". .NET Standard 2.0 is notable because it covers most base class library functionality used by most \", \".NET Framework and .NET Core apps. Unfortunately, the earliest version of .NET with support for .NET\", \" Standard 2.0 is .NET Framework 4.6.1, and there are a number of updates in .NET Framework 4.8 that \", \"make it a compelling choice for initial upgrades.\\n\\nOne approach to incrementally upgrade a .NET Fram\", \"ework 4.5 system layer-by-layer is to first update its class library dependencies to .NET Framework \", \"4.8. Then, modify these libraries to be .NET Standard class libraries. Use multi-targeting and condi\", \"tional compilation, if necessary. This step can be helpful\\n\\nin scenarios where app dependencies requ\", \"ire .NET Framework and cannot easily be ported directly to use .NET Standard and .NET Core. Since .N\", \"ET Framework libraries can be consumed by ASP.NET Core 2.1 apps, the next step is to migrate some or\", \" all of the web functionality of the app to ASP.NET Core 2.1 (as described in the [previous chapter]\", \"(#page-12-1)). This is a \\\"bottom up\\\" approach, starting with low level class library dependencies an\", \"d working up to the web app entry point.\\n\\nOnce the app is running on ASP.NET Core 2.1, migrating it \", \"to .NET 7 in isolation is relatively straightforward. The most likely challenge during this step is \", \"updating incompatible dependencies to support .NET Core and possibly higher versions of .NET Standar\", \"d. For apps that don't have problematic dependencies on .NET Framework-only libraries, there's littl\", \"e reason to upgrade to ASP.NET Core 2.1. Porting directly to ASP.NET Core 7 makes more sense and req\", \"uires less effort.\\n\\n.NET 7 is the latest version of .NET and will be supported until six months afte\", \"r the next STS or LTS release (scheduled for November 2023) - so most likely support will last at le\", \"ast until May 2024. Many teams looking to migrate today will choose to upgrade to .NET 7.\\n\\nInstead o\", \"f a \\\"bottom up\\\" approach, another alternative is to start with the web app (or even the entire solut\", \"ion) and use an automated tool to assist with the upgrade. The [.NET Upgrade Assistant tool](https:/\", \"/aka.ms/dotnet-upgrade-assistant) can be used to help upgrade .NET Framework apps to .NET Core / .NE\", \"T 7. It automates many of the common tasks related to upgrading apps, such as modifying project file\", \" format, setting appropriate target frameworks, updating NuGet dependencies, and more.\\n\\n#### <span i\", \"d=\\\"page-14-0\\\"></span>**References**\\n\\n- [What is .NET Standard?](https://dotnet.microsoft.com/platfor\", \"m/dotnet-standard)\\n- [Migrate from ASP.NET Core 6.0 to 7.0](https://docs.microsoft.com/aspnet/core/m\", \"igration/60-70)\\n- [Announcing .NET 6 -](https://devblogs.microsoft.com/dotnet/announcing-net-6/) The\", \" Fastest .NET Yet\\n- [Introducing .NET 5](https://devblogs.microsoft.com/dotnet/introducing-net-5/)\\n-\", \" [Migrate from ASP.NET Core 3.1 to 6.0 LTS](https://docs.microsoft.com/aspnet/core/migration/31-to-6\", \"0)\\n- <span id=\\\"page-14-1\\\"></span>\\u2022 [.NET Upgrade Assistant tool](https://aka.ms/dotnet-upgrade-assis\", \"tant)\\n\\n# Strategies for migrating ASP.NET Web Forms apps\\n\\nThis book offers guidance for migrating la\", \"rge ASP.NET MVC and Web API apps to .NET Core. Some of these ASP.NET apps may also include Web Forms\", \" (*.aspx*) pages that must be addressed. ASP.NET Web Forms isn't supported in ASP.NET Core (nor are \", \"ASP.NET Web Pages). Typically, the functionality of these pages must be rewritten when porting to AS\", \"P.NET Core. There are, however, some strategies you can apply before or during such migration to hel\", \"p reduce the overall effort required.\\n\\nWeb Forms will continue to be supported for quite some time. \", \"One option may be to keep this functionality in an ASP.NET 4.x app.\\n\\n#### <span id=\\\"page-14-2\\\"></spa\", \"n>**Separate business logic and other concerns**\\n\\nThe less code in your ASP.NET Web Forms pages, the\", \" better. When possible, keep business logic and other concerns like data access in separate classes,\", \" ideally in separate class libraries. These class libraries can be ported to .NET Standard and consu\", \"med by any ASP.NET Core app.\\n\\n#### <span id=\\\"page-15-0\\\"></span>**Implement client behavior and web A\", \"PIs**\\n\\nConsider the choice between implementing logic in Web Forms or in the browser with the help o\", \"f API calls. Favor the latter. Migrating APIs to ASP.NET Core is supported. Client-side behavior sho\", \"uld be independent of the server-side stack your app is using. Using this approach has the added ben\", \"efit of providing a more responsive user experience.\\n\\n#### <span id=\\\"page-15-1\\\"></span>**Consider Bl\", \"azor**\\n\\nBlazor lets you build interactive web UIs with C# instead of JavaScript. It can run on the s\", \"erver or in the browser using WebAssembly. ASP.NET Web Forms apps may be ported page-by-page to Blaz\", \"or apps. For more information on porting Web Forms apps to Blazor, see [Blazor for ASP.NET Web Forms\", \"](https://devblogs.microsoft.com/aspnet/blazor-aspnet-webforms-ebook/)  [Developers.](https://devblo\", \"gs.microsoft.com/aspnet/blazor-aspnet-webforms-ebook/) In addition, many Web Forms controls have bee\", \"n ported to Blazor as part of an opensource community project, [Blazor Web Forms Components.](https:\", \"//fritzandfriends.github.io/BlazorWebFormsComponents/) With these components, you can more easily po\", \"rt Web Forms pages to Blazor even if they use the built-in Web Forms controls.\\n\\n#### <span id=\\\"page-\", \"15-2\\\"></span>**Summary**\\n\\nMigrating directly from ASP.NET Web Forms to ASP.NET Core isn't supported.\", \" However, there are strategies to make moving to ASP.NET Core easier. You can migrate your Web Forms\", \" functionality to ASP.NET Core successfully by:\\n\\n- Keeping non-web functionality out of your project\", \"s.\\n- Using web APIs wherever possible.\\n- Considering Blazor as an option for a more modern UI.\\n\\n####\", \" <span id=\\\"page-15-3\\\"></span>**References**\\n\\n- [Free e-book: Blazor for ASP.NET Web Forms Developers\", \"](https://devblogs.microsoft.com/aspnet/blazor-aspnet-webforms-ebook/)\\n- <span id=\\\"page-15-4\\\"></span\", \">\\u2022 [Blazor Web Forms Components \\\\(Community Project\\\\)](https://fritzandfriends.github.io/BlazorWebFo\", \"rmsComponents/)\\n\\n# Deployment strategies\\n\\nOne consideration as you plan the migration of your large \", \"ASP.NET app to ASP.NET Core is how you'll deploy the new app. With ASP.NET, deployment options were \", \"limited to IIS on Windows. With ASP.NET Core, a much wider array of deployment options is available.\", \"\\n\\n#### <span id=\\\"page-15-5\\\"></span>**Cross-platform options**\\n\\nBecause .NET Core runs on Linux, you'\", \"ll find some hosting options available that weren't a consideration previously. Linux-based hosting \", \"may be preferable for the following reasons:\\n\\n- Your organization has infrastructure or expertise.\\n-\", \" Hosting providers offer attractive features or pricing for Linux-based hosting.\\n\\n.NET Core opens th\", \"e door to these options.\\n\\n#### <span id=\\\"page-16-0\\\"></span>**Cloud native development**\\n\\nMost organi\", \"zations today are using cloud platforms for at least some of their software capabilities. With an ap\", \"p migration to .NET Core, it's a good time to consider whether the app should be purposefully writte\", \"n with cloud hosting in mind. Such *cloud native* apps are better able to apply cloud capabilities l\", \"ike serverless, microservices, and can be less concerned with the low-level details of how and where\", \" they may be deployed.\\n\\nLearn more about cloud native app development in this free e-book, [Architec\", \"ting Cloud Native .NET](https://docs.microsoft.com/en-us/dotnet/architecture/cloud-native/)  [Applic\", \"ations for Azure.](https://docs.microsoft.com/en-us/dotnet/architecture/cloud-native/)\\n\\n#### <span i\", \"d=\\\"page-16-1\\\"></span>**Leverage containers**\\n\\nModern apps often leverage containers as a means of re\", \"ducing variation between hosting environments. By deploying an app to a particular container, the co\", \"ntainer-hosted app will run the same whether it's running on a developer's laptop or in production. \", \"As part of a migration to .NET Core, it may make sense to consider whether the app would benefit fro\", \"m deployment via container, either as a full monolith or broken up into multiple smaller containeriz\", \"ed apps.\\n\\n#### <span id=\\\"page-16-2\\\"></span>**Side-by-side deployment options**\\n\\nMigrating large .NET\", \" Framework apps to .NET Core often requires a substantial effort. Most organizations will want to be\", \" able to break this effort up in some fashion, so that pieces of the app can be migrated and deploye\", \"d in production before the entire migration is complete. Running both the original ASP.NET app and i\", \"ts newly-migrated ASP.NET Core sub-app(s) side by side is a frequently cited goal. This can be achie\", \"ved through a number of mechanisms including leveraging IIS routing, which is covered in chapter 5. \", \"Other options include leveraging app gateways or cloud design patterns like [backends for frontends]\", \"(https://docs.microsoft.com/azure/architecture/patterns/backends-for-frontends) to manage sets of AS\", \"P.NET Web APIs and ASP.NET Core API endpoints.\\n\\n#### <span id=\\\"page-16-3\\\"></span>**IIS on Windows**\\n\", \"\\nYou can continue hosting your apps on IIS running on Windows. This is a fine option for customers w\", \"ho want to take advantage of ASP.NET Core features without changing their current deployment model. \", \"While moving to ASP.NET Core provides more options in terms of how and where to deploy your apps, it\", \" doesn't require that you change from the status quo of using the proven combination of IIS on Windo\", \"ws.\\n\\n#### <span id=\\\"page-16-4\\\"></span>**Other options on Windows**\\n\\nYou can host apps side-by-side a\", \"pps on Windows using any combination of Kestrel, HTTP.sys, and IIS hosts, in addition to Docker cont\", \"ainers, if needed. If your app requires a combination of Windows and Linux services, hosting on a Wi\", \"ndows server with [WSL](https://docs.microsoft.com/windows/wsl/about) and/or Linux Docker containers\", \" provides a single server solution to hosting all parts of the app.\\n\\n#### <span id=\\\"page-16-5\\\"></spa\", \"n>**References**\\n\\n\\u2022 [Host and deploy ASP.NET Core](https://docs.microsoft.com/aspnet/core/host-and-d\", \"eploy/)\\n\\n- [Host ASP.NET Core on Windows with IIS](https://docs.microsoft.com/aspnet/core/host-and-d\", \"eploy/iis/)\\n- <span id=\\\"page-17-0\\\"></span>\\u2022 [Troubleshooting ASP.NET Core on Azure App Service and I\", \"IS](https://docs.microsoft.com/aspnet/core/test/troubleshoot-azure-iis)\\n\\n# Additional migration reso\", \"urces\\n\\nAs you're planning and executing your migration from ASP.NET MVC and/or Web API to ASP.NET Co\", \"re, there are a number of resources available to help beyond this book. Make a note of these and lev\", \"erage them where appropriate to help you overcome obstacles you encounter on your migration journey.\", \"\\n\\n#### <span id=\\\"page-17-1\\\"></span>**Official documentation**\\n\\nThe official documentation website, [\", \"learn.microsoft.com,](https://docs.microsoft.com/) has the most up-to-date information available abo\", \"ut versions, frameworks, breaking changes, and support options. You'll find many links in this book \", \"to docs articles, but for any problem you're facing it's often worth at least doing a quick search o\", \"f the docs to see if there is already information covering the issue and offering a solution or work\", \"around.\\n\\n#### <span id=\\\"page-17-2\\\"></span>**GitHub**\\n\\nBecause .NET Core is an open-source project, m\", \"any issues are discovered, reported, discussed, and fixed on GitHub. Microsoft has several GitHub or\", \"ganizations in which you'll find repositories that may be helpful. A partial list of these organizat\", \"ions and some of their public repositories are listed below:\\n\\n- [Microsoft](https://github.com/micro\", \"soft)\\n  - [ASP.NET API Versioning](https://github.com/microsoft/aspnet-api-versioning)\\n- [dotnet](ht\", \"tps://github.com/dotnet)\\n  - [ASP.NET Core](https://github.com/dotnet/aspnetcore)\\n  - [.NET Runtime]\", \"(https://github.com/dotnet/runtime)\\n  - [Entity Framework Core](https://github.com/dotnet/efcore)\\n  \", \"- [C# Language](https://github.com/dotnet/csharplang)\\n  - [Docs](https://github.com/dotnet/docs)\\n  -\", \" [Docs Samples](https://github.com/dotnet/samples)\\n  - [Try Convert](https://github.com/dotnet/try-c\", \"onvert)\\n  - [.NET Upgrade Assistant tool](https://aka.ms/dotnet-upgrade-assistant)\\n- [.NET Architect\", \"ure Reference Apps](https://github.com/dotnet-architecture)\\n  - [eShopModernizing](https://github.co\", \"m/dotnet-architecture/eShopModernizing)\\n  - [eShopOnWeb](https://github.com/dotnet-architecture/eSho\", \"pOnWeb)\\n  - [eShopOnContainers](https://github.com/dotnet-architecture/eShopOnContainers)\\n\\nIf you ru\", \"n into problems with your migration, these GitHub repositories are a good place to report them. The \", \"product teams watch the issues and typically respond quickly to bug reports (though \\\"how to\\\" questio\", \"ns may be more appropriately directed to Stack Overflow).\\n\\n#### <span id=\\\"page-18-0\\\"></span>**Stack \", \"Overflow**\\n\\n[Stack Overflow](https://stackoverflow.com/) has a wealth of information in the form of \", \"previous questions asked and answers given, with the most helpful answers listed first and marked if\", \" they solved the problem. In addition to searching for an existing solution to a problem you may enc\", \"ounter, you can of course also ask a question yourself and hope for some response from the .NET comm\", \"unity. Don't forget you can narrow down a search by using tags, and remember to use appropriate tags\", \" when you ask questions to maximize the chances of someone with the experience needed noticing your \", \"question.\\n\\n#### <span id=\\\"page-18-1\\\"></span>**YouTube channels**\\n\\nYouTube has a huge amount of .NET \", \"and .NET Core video content, which may include useful tutorials or walkthroughs covering any scenari\", \"o you may encounter. Consider searching it separately if your other efforts to find help online come\", \" up short. Here are a few good places to get started:\\n\\n- [dotnet](https://www.youtube.com/dotnet)\\n- \", \"[Visual Studio](https://www.youtube.com/visualstudio)\\n\\n#### <span id=\\\"page-18-2\\\"></span>**Twitter, G\", \"itter, Slack, and other community channels**\\n\\nYou'll find many other ways to connect with .NET devel\", \"opers on the [.NET Community page.](https://dotnet.microsoft.com/platform/community) You can also jo\", \"in the [DotNetEvolution Discord server.](https://aka.ms/dotnet-discord) Additionally, many product t\", \"eams and team members are on Twitter as well as in various other communities. You can follow and com\", \"municate with [the](https://twitter.com/ardalis)  [author of this book on Twitter](https://twitter.c\", \"om/ardalis) as well.\\n\\n#### <span id=\\\"page-18-3\\\"></span>**References**\\n\\n- [Overview of porting from .\", \"NET Framework to .NET Core](https://docs.microsoft.com/en-us/dotnet/core/porting/)\\n- [.NET Upgrade A\", \"ssistant tool](https://aka.ms/dotnet-upgrade-assistant)\\n- [Migrate from ASP.NET to ASP.NET Core](htt\", \"ps://docs.microsoft.com/en-us/dotnet/core/porting/)\\n- [.NET Community Resources](https://dotnet.micr\", \"osoft.com/platform/community)\\n\\n# <span id=\\\"page-19-0\\\"></span>Architectural differences between ASP.N\", \"ET MVC and ASP.NET Core\\n\\nThere are many architectural differences between ASP.NET MVC on .NET Framew\", \"ork and ASP.NET Core. It's important to have a broad understanding of these differences as teams eva\", \"luate the work involved in porting their ASP.NET MVC apps to ASP.NET Core. This chapter looks at eac\", \"h of the ways in which ASP.NET Core differs substantially from ASP.NET MVC.\\n\\n# <span id=\\\"page-19-1\\\">\", \"</span>Breaking changes\\n\\n.NET Core is a cross-platform rewrite of .NET Framework. There are many [br\", \"eaking changes between](https://docs.microsoft.com/en-us/dotnet/core/compatibility/fx-core)  [the tw\", \"o frameworks.](https://docs.microsoft.com/en-us/dotnet/core/compatibility/fx-core) The following sec\", \"tions identify specific differences between how ASP.NET MVC and ASP.NET Core apps are designed and d\", \"eveloped. Take care to also examine the documentation to determine which framework libraries you're \", \"using that may need to change. In many cases, a replacement NuGet package exists to fill in any gaps\", \" left between .NET Framework and .NET Core. In rare cases, you may need to find a third-party soluti\", \"on or implement new custom code to address incompatibilities.\\n\\n# <span id=\\\"page-19-2\\\"></span>App sta\", \"rtup differences between ASP.NET MVC and ASP.NET Core\\n\\nASP.NET MVC apps lived entirely within Intern\", \"et Information Server (IIS), the primary web server available on Windows operating systems. Unlike A\", \"SP.NET MVC, ASP.NET Core apps are executable apps. You can run them from the command line, using dot\", \"net run. They have an entry point method like all C# programs, typically public static void Main() o\", \"r a similar variation (perhaps with arguments or async support). This is perhaps the biggest archite\", \"ctural difference between ASP.NET Core and ASP.NET MVC, and is one of several differences that allow\", \"s ASP.NET Core to run on non-Windows systems.\\n\\n#### <span id=\\\"page-20-0\\\"></span>**ASP.NET MVC Startu\", \"p**\\n\\nHosted within IIS, ASP.NET apps rely on IIS to instantiate certain objects and call certain met\", \"hods when a request arrives. ASP.NET creates an instance of the *Global.asax* file's class, which de\", \"rives from HttpApplication. When the first request is received, before handling the request itself, \", \"ASP.NET calls the Application\\\\_Start method in the *Global.asax* file's class. Any logic that needs \", \"to run when the ASP.NET MVC app begins can be added to this method.\\n\\nMany NuGet packages for ASP.NET\", \" MVC and Web API use the [WebActivator](https://github.com/davidebbo/WebActivator) package to let th\", \"em run some code during app startup. By convention, this code would typically be added to an *App\\\\_S\", \"tart* folder and would be configured via attribute to run either immediately before or just after Ap\", \"plication\\\\_Start.\\n\\nIt's also possible to use the [Open Web Interface for .NET \\\\(OWIN\\\\) and Project K\", \"atana with ASP.NET](https://docs.microsoft.com/aspnet/aspnet/overview/owin-and-katana/getting-starte\", \"d-with-owin-and-katana)  [MVC.](https://docs.microsoft.com/aspnet/aspnet/overview/owin-and-katana/ge\", \"tting-started-with-owin-and-katana) When doing so, the app will include a *Startup.cs* file that is \", \"responsible for setting up request middleware in a way that's very similar to how ASP.NET Core behav\", \"es.\\n\\nIf you need to run code when your ASP.NET MVC app starts up, it will typically use one of these\", \" approaches.\\n\\n#### <span id=\\\"page-20-1\\\"></span>**ASP.NET Core Startup**\\n\\nAs noted previously, ASP.NE\", \"T Core apps are standalone programs. As such, they typically include a *Program.cs* file containing \", \"the entry point for the app. A typical example of this file is shown in Figure 2-1. Notice that in .\", \"NET 7, this file is streamlined by the use of implicit using statements and top-level statements, el\", \"iminating the need for a lot of \\\"boiler plate\\\" code.\\n\\n```\\nvar builder = WebApplication.CreateBuilder\", \"(args);\\n// Add services to the container.\\nbuilder.Services.AddRazorPages();\\nvar app = builder.Build(\", \");\\n// Configure the HTTP request pipeline.\\nif (!app.Environment.IsDevelopment())\\n{\\n app.UseException\", \"Handler(\\\"/Error\\\");\\n // The default HSTS value is 30 days. You may want to change this for production\", \" \\nscenarios, see https://aka.ms/aspnetcore-hsts.\\n app.UseHsts();\\n}\\napp.UseHttpsRedirection();\\napp.Us\", \"eStaticFiles();\\napp.UseRouting();\\napp.UseAuthorization();\\napp.MapRazorPages();\\napp.Run();\\n```\\n\\n*Figu\", \"re 2-1. A typical ASP.NET Core Program.cs file.*\\n\\nThe code shown in Figure 2-1 uses a builder to con\", \"figure the host and its services. Then, it creates the request pipeline for the app, which controls \", \"how every request to the app is handled.\\n\\nPrevious versions of .NET would use a separate *Startup.cs\", \"* file, referenced by *Program.cs*. This approach is still supported in .NET 7, but is no longer the\", \" default approach.\\n\\nIn addition to code related to configuring the app's services and request pipeli\", \"ne, apps may have other code that must run when the app begins. Such code is typically placed in *Pr\", \"ogram.cs* or registered as an IHostedService, which will be started by the [generic host](https://do\", \"cs.microsoft.com/aspnet/core/fundamentals/host/generic-host) when the app starts.\\n\\nThe IHostedServic\", \"e interface just exposes two methods, StartAsync and StopAsync. You register the interface when conf\", \"iguring the app's services and the host does the rest, calling the StartAsync method before the app \", \"starts up.\\n\\n#### <span id=\\\"page-21-0\\\"></span>**Porting considerations**\\n\\nTeams looking to migrate th\", \"eir apps from ASP.NET MVC to ASP.NET Core need to identify what code is being run when their app sta\", \"rts up and determine the appropriate location for such code in their ASP.NET Core app. For custom co\", \"de needed to run when the app starts up, especially async code, the recommended approach is typicall\", \"y to put such code into IHostedService implementations.\\n\\n#### <span id=\\\"page-21-1\\\"></span>**Referenc\", \"es**\\n\\n- [ASP.NET Application Life Cycle Overview for IIS 7](https://docs.microsoft.com/previous-vers\", \"ions/aspnet/bb470252(v=vs.100))\\n- [ASP.NET Application Life Cycle Overview for IIS 5 and 6](https://\", \"docs.microsoft.com/previous-versions/aspnet/ms178473(v=vs.100))\\n- [Getting Started with OWIN and Kat\", \"ana](https://docs.microsoft.com/aspnet/aspnet/overview/owin-and-katana/getting-started-with-owin-and\", \"-katana)\\n- [WebActivator](https://github.com/davidebbo/WebActivator)\\n- [App Startup in ASP.NET Core]\", \"(https://docs.microsoft.com/aspnet/core/fundamentals/startup)\\n- [.NET Generic Host in ASP.NET Core](\", \"https://docs.microsoft.com/aspnet/core/fundamentals/host/generic-host)\\n- <span id=\\\"page-21-2\\\"></span\", \">\\u2022 [IHostedService](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/multi-contain\", \"er-microservice-net-applications/background-tasks-with-ihostedservice)\\n\\n# Hosting differences betwee\", \"n ASP.NET MVC and ASP.NET Core\\n\\nASP.NET MVC apps are hosted in IIS, and may rely on IIS configuratio\", \"n for their behavior. This often includes [IIS modules.](https://docs.microsoft.com/iis/get-started/\", \"introduction-to-iis/iis-modules-overview) As part of reviewing an app to prepare to port it from ASP\", \".NET MVC to ASP.NET Core, teams should identify which modules, if any, they're using from the list o\", \"f IIS Modules installed on their server.\\n\\n[ASP.NET Core apps can run on a number of different server\", \"s.](https://docs.microsoft.com/aspnet/core/fundamentals/servers/) The default cross platform server,\", \" Kestrel, is a good default choice. Apps running in Kestrel can be hosted by IIS, running in a separ\", \"ate process. On Windows, apps can also run in process on IIS or using HTTP.sys. Kestrel is generally\", \" recommended for best performance. HTTP.sys can be used in scenarios where the app is exposed to the\", \" Internet and required capabilities are supported by HTTP.sys but not Kestrel.\\n\\nKestrel does not hav\", \"e an equivalent to IIS modules (though apps hosted in IIS can still take advantage of IIS modules). \", \"To achieve equivalent behavior, [middleware](https://docs.microsoft.com/aspnet/core/fundamentals/mid\", \"dleware/) configured in the ASP.NET Core app itself is typically used.\\n\\n#### <span id=\\\"page-22-0\\\"></\", \"span>**References**\\n\\n- [IIS Modules](https://docs.microsoft.com/iis/get-started/introduction-to-iis/\", \"iis-modules-overview)\\n- [ASP.NET Core Middleware](https://docs.microsoft.com/aspnet/core/fundamental\", \"s/middleware/)\\n- [ASP.NET Core Servers](https://docs.microsoft.com/aspnet/core/fundamentals/servers/\", \")\\n\\n# <span id=\\\"page-22-1\\\"></span>Serve static files in ASP.NET MVC and ASP.NET Core\\n\\nMost web apps i\", \"nvolve a combination of server-side logic and static files that must be sent to the client as-is. Ho\", \"w should your migration from ASP.NET MVC to ASP.NET Core handle serving static files?\\n\\n#### <span id\", \"=\\\"page-22-2\\\"></span>**Host static files in ASP.NET MVC**\\n\\nASP.NET MVC apps, hosted by IIS, typically\", \" host static files directly from the app. ASP.NET MVC supports placing static files side by side wit\", \"h files that should be kept private on the server. IIS and ASP.NET require explicitly restricting ce\", \"rtain files or file extensions from being served from the folder in which an ASP.NET app is hosted.\\n\", \"\\nFor many static files, using a content delivery network (CDN) is a good practice. [Static content h\", \"osting](https://docs.microsoft.com/azure/architecture/patterns/static-content-hosting) allows better\", \" performance while reducing load and bandwidth from app servers.\\n\\n#### <span id=\\\"page-22-3\\\"></span>*\", \"*Host static files in ASP.NET Core**\\n\\nIt may be surprising, but ASP.NET Core doesn't have built-in s\", \"upport for static files. This feature that has always existed as just a part of ASP.NET, enabled by \", \"IIS, isn't intrinsic to ASP.NET Core or its Kestrel web server. To serve static files from an ASP.NE\", \"T Core app, you must configure [static files](https://docs.microsoft.com/aspnet/core/fundamentals/st\", \"atic-files)  [middleware.](https://docs.microsoft.com/aspnet/core/fundamentals/static-files)\\n\\nWith s\", \"tatic files middleware configured, an ASP.NET Core app will serve all files located in a certain fol\", \"der (typically */wwwroot*). No other files in the app or project folder are at risk of being acciden\", \"tally exposed by the server. No special restrictions based on file names or extensions need to be co\", \"nfigured, as is the case with IIS. Instead, developers explicitly choose to expose files publicly wh\", \"en they place them in the *wwwroot* folder. By default, files outside of this folder aren't shared.\\n\", \"\\nBecause support for static files uses middleware, any other middleware can be applied as part of th\", \"e same request pipeline. Examples of middleware include authentication, caching, and compression.\\n\\nO\", \"f course, CDNs remain a good choice for ASP.NET Core apps for all the same reasons they're used in A\", \"SP.NET MVC apps. As part of preparing to migrate to .NET Core, if there are benefits your app could \", \"realize from using a CDN, it would be good to move static files to a CDN before migrating to .NET Co\", \"re. Doing so reduces the migration effort's overall scope for static assets.\\n\\n#### <span id=\\\"page-23\", \"-0\\\"></span>**References**\\n\\n- [Static content hosting](https://docs.microsoft.com/azure/architecture/\", \"patterns/static-content-hosting)\\n- [Static files in ASP.NET Core](https://docs.microsoft.com/aspnet/\", \"core/fundamentals/static-files)\\n\\n# <span id=\\\"page-23-1\\\"></span>Dependency injection differences betw\", \"een ASP.NET MVC and ASP.NET Core\\n\\nAlthough dependency injection (DI) isn't built into ASP.NET MVC or\", \" Web API, many apps enable it by adding a NuGet package with an inversion of control (IOC) container\", \". These are sometimes referred to as DI containers, for dependency injection (or inversion). Some of\", \" the most popular containers used in ASP.NET MVC apps include:\\n\\n- [Autofac](https://www.autofac.org/\", \")\\n- [Unity](https://unitycontainer.github.io/)\\n- [Ninject](http://www.ninject.org/)\\n- [StructureMap]\", \"(http://structuremap.github.io/) *(deprecated)*\\n- [Castle Windsor](http://www.castleproject.org/proj\", \"ects/windsor/)\\n\\nIf your ASP.NET MVC app isn't using DI, you will probably want to investigate the bu\", \"ilt-in support for DI in ASP.NET Core. DI promotes loose coupling of modules in your app and enables\", \" better testability and adherence to principles like [SOLID.](https://www.weeklydevtips.com/episodes\", \"/047)\\n\\nIf your app does use DI, then probably your best course of action is to see if the container \", \"you're using supports ASP.NET Core. If so, you may be able to continue using it and your custom conf\", \"iguration rules describing your type mappings and lifetimes.\\n\\nEither way, you should consider using \", \"the built-in support for DI that ships with ASP.NET Core, as it may meet your app's needs.\\n\\n#### <sp\", \"an id=\\\"page-23-2\\\"></span>**Dependency injection in ASP.NET Core**\\n\\nASP.NET Core assumes apps will us\", \"e DI. It's not just built into the framework, but is required in order to bring support for framewor\", \"k features into your ASP.NET Core apps. In app startup, calls are made to configure services using t\", \"he builder.Services property of the web host builder. This property works with the application's DI \", \"container (service collection/service provider) and is used to create and inject service dependencie\", \"s within the app. Built-in ASP.NET Core features like Entity Framework Core, Identity, and even MVC \", \"are brought into the app by configuring them as services during application startup.\\n\\nIn addition to\", \" using the default implementation, apps can still use custom containers. The [documentation covers h\", \"ow to replace the default service container.](https://docs.microsoft.com/en-us/dotnet/core/extension\", \"s/dependency-injection-guidelines#default-service-container-replacement)\\n\\nDI is fundamental to ASP.N\", \"ET Core. If your team isn't already well-versed in this practice, you'll want to understand it befor\", \"e porting your app.\\n\\n#### <span id=\\\"page-24-0\\\"></span>**References**\\n\\n- [Dependency Injection in .NE\", \"T](https://docs.microsoft.com/en-us/dotnet/core/extensions/dependency-injection)\\n- [Dependency Injec\", \"tion in ASP.NET Core](https://docs.microsoft.com/aspnet/core/fundamentals/dependency-injection)\\n\\n# <\", \"span id=\\\"page-24-1\\\"></span>Compare middleware to modules and handlers\\n\\nIf your existing ASP.NET MVC \", \"or Web API app uses OWIN/Katana, you're most likely already familiar with the concept of middleware \", \"and porting it to ASP.NET Core should be fairly straightforward. However, most ASP.NET apps rely on \", \"HTTP modules and HTTP handlers instead of middleware. Migrating these to ASP.NET Core requires extra\", \" effort.\\n\\n#### <span id=\\\"page-24-2\\\"></span>**ASP.NET modules and handlers**\\n\\n[HTTP modules and HTTP \", \"handlers](https://docs.microsoft.com/troubleshoot/aspnet/http-modules-handlers) are an integral part\", \" of the ASP.NET architecture. While a request is being processed, each request is processed by multi\", \"ple HTTP modules (for example, the authentication module and the session module) and is then process\", \"ed by a single HTTP handler. After the handler has processed the request, the request flows back thr\", \"ough the HTTP modules.\\n\\nIf your app is using custom HTTP modules or HTTP handlers, you'll need a pla\", \"n to migrate them to ASP.NET Core. The most likely replacement in ASP.NET Core is middleware.\\n\\n#### \", \"<span id=\\\"page-24-3\\\"></span>**ASP.NET Core middleware**\\n\\nASP.NET Core defines a request pipeline in \", \"each app's Configure method. This request pipeline defines how an incoming request is handled by the\", \" app, with each method in the pipeline calling the next method until eventually a method terminates,\", \" and the chain of *middleware* terminates and returns back up the stack. Middleware can target all r\", \"equests, or can be configured to only map to certain requests based on the requested path or other f\", \"actors. It can be configured wholly in the Configure method of an app, or implemented in a separate \", \"class.\\n\\nBehavior in an ASP.NET MVC app that uses HTTP modules is probably best suited to [custom](ht\", \"tps://docs.microsoft.com/aspnet/core/fundamentals/middleware/?preserve-view=true&view=aspnetcore-3.1\", \")  [middleware.](https://docs.microsoft.com/aspnet/core/fundamentals/middleware/?preserve-view=true&\", \"view=aspnetcore-3.1) Custom HTTP handlers can be replaced with custom routes or endpoints that respo\", \"nd to the same path.\\n\\n#### <span id=\\\"page-24-4\\\"></span>**Accessing HttpContext**\\n\\nMany .NET apps ref\", \"erence the current request's context through HttpContext.Current. This static access can be a common\", \" source of problems with testing and other code usage outside of individual requests. When building \", \"ASP.NET Core apps, access to the current HttpContext should be provided as a method parameter on mid\", \"dleware, as this sample demonstrates:\\n\\n```\\npublic class Middleware\\n{\\n private readonly RequestDelega\", \"te _next;\\n public Middleware(RequestDelegate next)\\n {\\n _next = next;\\n```\\n\\n```\\n }\\n public Task Invoke\", \"(HttpContext httpContext)\\n {\\n return _next(httpContext);\\n }\\n}\\n```\\n\\nSimilarly, ASP.NET Core filters p\", \"ass a context argument to their methods, from which the current HttpContext can be accessed:\\n\\n```\\npu\", \"blic class MyActionFilterAttribute : ActionFilterAttribute\\n{\\n public override void OnResultExecuting\", \"(ResultExecutingContext context)\\n {\\n var headers = context.HttpContext.Request.Headers;\\n // do somet\", \"hing based on a header\\n base.OnResultExecuting(context);\\n }\\n}\\n```\\n\\nIf you have components or service\", \"s that require access to HttpContext, rather than using a static call like HttpContext.Current you s\", \"hould instead use constructor dependency injection and the [IHttpContextAccessor](https://docs.micro\", \"soft.com/dotnet/api/microsoft.aspnetcore.http.ihttpcontextaccessor) interface:\\n\\n```\\npublic class MyS\", \"ervice\\n{\\n private readonly IHttpContextAccessor _httpContextAccessor;\\n public MyService(IHttpContext\", \"Accessor httpContextAccessor)\\n {\\n _httpContextAccessor = httpContextAccessor;\\n }\\n public void DoSome\", \"thing()\\n {\\n var currentContext = _httpContextAccessor.HttpContext;\\n }\\n}\\n```\\n\\nThis approach eliminate\", \"s the static coupling of the method to the current context while providing access in a testable fash\", \"ion.\\n\\n#### <span id=\\\"page-25-0\\\"></span>**References**\\n\\n- [ASP.NET HTTP modules and HTTP handlers](ht\", \"tps://docs.microsoft.com/troubleshoot/aspnet/http-modules-handlers)\\n- [ASP.NET Core middleware](http\", \"s://docs.microsoft.com/aspnet/core/fundamentals/middleware/?preserve-view=true&view=aspnetcore-3.1)\\n\", \"\\n# <span id=\\\"page-25-1\\\"></span>Configuration differences between ASP.NET MVC and ASP.NET Core\\n\\nHow c\", \"onfiguration values are stored and read changed dramatically between ASP.NET and ASP.NET Core.\\n\\n####\", \" <span id=\\\"page-26-0\\\"></span>**ASP.NET MVC configuration**\\n\\nIn ASP.NET apps, configuration uses the \", \"built-in .NET configuration files, *web.config* in the app folder and *machine.config* on the server\", \". Most ASP.NET MVC and Web API apps store their settings in the configuration file's appSettings or \", \"connectionStrings elements. Some also use custom configuration sections that can be mapped to a sett\", \"ings class.\\n\\nConfiguration in a .NET Framework app is accessed using the\\n\\nSystem.Configuration.Confi\", \"gurationManager class. Unfortunately, this class provides static access to the configuration element\", \"s. As a result, very few ASP.NET MVC apps tend to abstract access to their configuration settings or\", \" inject them where needed. Instead, most .NET Framework apps tend to directly access the configurati\", \"on system anywhere the app needs to use a setting.\\n\\nTypical ASP.NET MVC configuration access:\\n\\n```\\ns\", \"tring connectionString =\\n ConfigurationManager.ConnectionStrings[\\\"DefaultConnection\\\"]\\n .ConnectionSt\", \"ring;\\n```\\n\\n#### <span id=\\\"page-26-1\\\"></span>**ASP.NET Core configuration**\\n\\nIn ASP.NET Core apps, co\", \"nfiguration is, itself, configurable. However, most apps use a set of defaults provided as part of t\", \"he standard project templates and the ConfigureWebHostDefaults method used in them. The default sett\", \"ings use JSON formatted files, with the ability to override settings in the base *appsettings.json* \", \"file with environment-specific files like *appsettings.Development.json*. Additionally, the default \", \"configuration system further overrides all file-based settings with any environment variable that ex\", \"ists for the same named setting. This is useful in many scenarios and is especially useful when depl\", \"oying to a hosting environment, since it eliminates the need to worry about whether deploying config\", \"uration files will accidentally overwrite important production configuration settings. Configuration\", \" values can also be provided as command line arguments.\\n\\nAccessing configuration values can be done \", \"in many ways in .NET Core. Because dependency injection is built into .NET Core, configuration value\", \"s are generally accessed through an interface that is injected into classes that need them. This can\", \" involve passing a interface like [IConfiguration,](https://docs.microsoft.com/dotnet/api/microsoft.\", \"extensions.configuration.iconfiguration) but usually it's better to pass just the settings required \", \"by the class using the [options pattern.](https://docs.microsoft.com/aspnet/core/fundamentals/config\", \"uration/options)\\n\\nFigure 2-2 shows how to pass IConfiguration into a Razor Page and access configura\", \"tion settings from it:\\n\\n```\\nusing Microsoft.Extensions.Configuration;\\npublic class TestModel : PageM\", \"odel\\n{\\n private readonly IConfiguration _configuration;\\n public TestModel(IConfiguration configurati\", \"on)\\n {\\n _configuration= configuration;\\n }\\n public ContentResult OnGet()\\n {\\n```\\n\\n```\\n var myKeyValue \", \"= _configuration[\\\"MyKey\\\"];\\n // ...\\n }\\n}\\n```\\n\\n*Figure 2-2. Accessing configuration values with IConfi\", \"guration.*\\n\\nUsing the [options pattern,](https://docs.microsoft.com/en-us/dotnet/core/extensions/opt\", \"ions) settings access is similar but is strongly typed and more specific to the setting(s) needed by\", \" the consuming class, as Figure 2-3 demonstrates.\\n\\n```\\npublic class PositionOptions\\n{\\n public const \", \"string Position = nameof(Position);\\n public string Title { get; set; }\\n public string Name { get; se\", \"t; }\\n}\\npublic class Test2Model : PageModel\\n{\\n private readonly PositionOptions _options;\\n public Tes\", \"t2Model(IOptions<PositionOptions> options)\\n {\\n _options = options.Value;\\n }\\n public ContentResult On\", \"Get()\\n {\\n return Content($\\\"Title: {_options.Title}\\\\nName: {_options.Name}\\\");\\n }\\n}\\n```\\n\\n*Figure 2-3. \", \"Using the options pattern in ASP.NET Core.*\\n\\nFor the options pattern to work, the options type must \", \"be configured in ConfigureServices when the app starts up:\\n\\n```\\n// required in ConfigureServices\\nser\", \"vices.Configure<PositionOptions>(Configuration.GetSection(PositionOptions.Position));\\n```\\n\\n#### <spa\", \"n id=\\\"page-27-0\\\"></span>**Migrate configuration**\\n\\nWhen considering how to port an app's configurati\", \"on settings from .NET Framework to .NET Core, the first step is to identify all of the configuration\", \" settings that are being used. Most of these will be in the *web.config* file in the app's root fold\", \"er, but some apps expect settings to be found in the shared *machine.config* file as well. These set\", \"tings will include elements of the appSettings element, the connectionStrings element, and any custo\", \"m configuration elements as well. In .NET Core, all of these settings are typically stored in the *a\", \"ppsettings.json* file.\\n\\nOnce all settings in the config files have been cataloged, the next step sho\", \"uld be to identify where and how the settings are used in the app itself. If some settings aren't be\", \"ing used, these can probably be omitted from the migration. For each setting, note all of the places\", \" it's being used so you can be sure you don't miss any when you migrate the code.\\n\\nIf you're still m\", \"aintaining the ASP.NET app, it may be helpful to avoid static references to ConfigurationManager and\", \" replace them with access through interfaces. This will ease the transition to ASP.NET Core's config\", \"uration system. In general, static access to external resources makes code harder to test and mainta\", \"in, so be on the lookout for anywhere else the app may be following this pattern.\\n\\n#### <span id=\\\"pa\", \"ge-28-0\\\"></span>**References**\\n\\n- [Configuration in ASP.NET Core](https://docs.microsoft.com/aspnet/\", \"core/fundamentals/configuration/)\\n- [Options pattern in ASP.NET Core](https://docs.microsoft.com/asp\", \"net/core/fundamentals/configuration/options)\\n- [Migrate configuration to ASP.NET Core](https://docs.\", \"microsoft.com/aspnet/core/migration/configuration)\\n- [Refactoring Static Config Access](https://arda\", \"lis.com/refactoring-static-config-access/)\\n\\n# <span id=\\\"page-28-1\\\"></span>Routing differences betwee\", \"n ASP.NET MVC and ASP.NET Core\\n\\nRouting is responsible for mapping incoming browser requests to part\", \"icular controller actions (or Razor Pages handlers). This section covers how routing differs between\", \" ASP.NET MVC (and Web API) and ASP.NET Core (MVC, Razor Pages, and otherwise).\\n\\n#### <span id=\\\"page-\", \"28-2\\\"></span>**Routing in ASP.NET MVC and Web API**\\n\\nASP.NET MVC offers two approaches to routing:\\n\\n\", \"- 1. The route table, which is a collection of routes that can be used to match incoming requests to\", \" controller actions.\\n- 2. Attribute routing, which performs the same function but is achieved by dec\", \"orating the actions themselves, rather than editing a global route table.\\n\\n#### <span id=\\\"page-28-3\\\"\", \"></span>**Route table**\\n\\nThe route table is configured when the app starts up. Typically, a static m\", \"ethod call is used to configure the global route collection, like so:\\n\\n```\\npublic class MvcApplicati\", \"on : System.Web.HttpApplication\\n{\\n public static void RegisterRoutes(RouteCollection routes)\\n {\\n rou\", \"tes.IgnoreRoute(\\\"{resource}.axd/{*pathInfo}\\\");\\n routes.MapRoute(\\n name: \\\"Default\\\",\\n url: \\\"{controlle\", \"r}/{action}/{id}\\\",\\n defaults: new { controller = \\\"Home\\\", action = \\\"Index\\\", id = \\\"\\\" },\\n constraints: \", \"new { id = \\\"\\\\\\\\d+\\\" }\\n );\\n }\\n protected void Application_Start()\\n {\\n```\\n\\n```\\n RegisterRoutes(RouteTabl\", \"e.Routes);\\n }\\n}\\n```\\n\\nIn the preceding code, the route table is managed by the RouteCollection type, \", \"which is used to add new routes with MapRoute. Routes are named and include a route string, which ca\", \"n include parameters for controllers, actions, areas, and other placeholders. If an app follows a st\", \"andard convention, most of its actions can be handled by this single default route, with any excepti\", \"ons to this convention configured using additional routes.\\n\\n#### **Attribute routing in ASP.NET MVC*\", \"*\\n\\nRoutes that are defined with their actions may be easier to discover and reason about than routes\", \" defined in an external location. Using attribute routing, an individual action method can have its \", \"route defined with a [Route] attribute:\\n\\n```\\npublic class ProductsController\\n{\\n [Route(\\\"products\\\")]\\n\", \" public ActionResult Index()\\n {\\n return View();\\n }\\n [Route(\\\"products/{id}\\\")]\\n public ActionResult De\", \"tails(int id)\\n {\\n return View();\\n }\\n}\\n```\\n\\n[Attribute routing in ASP.NET MVC 5](https://devblogs.mic\", \"rosoft.com/aspnet/attribute-routing-in-asp-net-mvc-5/) also supports defaults and prefixes, which ca\", \"n be added at the controller level (and which are applied to all actions within that controller). Re\", \"fer to the documentation for details.\\n\\nSetting up attribute routing requires adding one line to the \", \"default route table configuration:\\n\\n```\\nroutes.MapMvcAttributeRoutes();\\n```\\n\\nAttribute routing can t\", \"ake advantage of route constraints, both built-in and custom, and supports named routes and areas us\", \"ing the [RouteArea] attribute. If your app uses areas, you'll need to configure support for them in \", \"your route registration code by adding one more line:\\n\\n```\\nroutes.MapMvcAttributeRoutes();\\n```\\n\\nArea\", \"Registration.RegisterAllAreas();\\n\\n#### **Attribute routing in ASP.NET Web API 2**\\n\\n[Attribute routin\", \"g in ASP.NET Web API 2](https://docs.microsoft.com/aspnet/web-api/overview/web-api-routing-and-actio\", \"ns/attribute-routing-in-web-api-2) is similar to routing in ASP.NET MVC 5, with minor differences. C\", \"onfiguring Web API 2 is typically done in its own class, which is called during app startup. Attribu\", \"te routing configuration is handled in this class:\\n\\n```\\npublic static class WebApiConfig\\n{\\n```\\n\\n```\\n\", \" public static void Register(HttpConfiguration config)\\n {\\n // Attribute routing.\\n config.MapHttpAttr\", \"ibuteRoutes();\\n // Convention-based routing.\\n config.Routes.MapHttpRoute(\\n name: \\\"DefaultApi\\\",\\n rout\", \"eTemplate: \\\"api/{controller}/{id}\\\",\\n defaults: new { id = RouteParameter.Optional }\\n );\\n }\\n}\\n```\\n\\nAs\", \" shown in the preceding code, attribute routing may be combined with convention-based routing in Web\", \" API apps.\\n\\nIn addition to attribute routing, [ASP.NET Web API chooses which action to call](https:/\", \"/docs.microsoft.com/aspnet/web-api/overview/web-api-routing-and-actions/routing-and-action-selection\", \") based on the HTTP method (for example, GET or POST), the {action} placeholder in a route (if any),\", \" and parameters of the action. In many cases, the name of the action will help determine whether it'\", \"s matched, since prefixing the action name with \\\"Get\\\" or \\\"Post\\\" is used to match the appropriate HTT\", \"P method to it. Alternatively, actions can be decorated with an appropriate HTTP method attribute, l\", \"ike [HttpGet], allowing the use of action names that aren't prefixed with an HTTP method.\\n\\n```\\npubli\", \"c class ProductsController : ApiController\\n{\\n // matched by name and (lack of) parameters\\n public IE\", \"numerable<Product> GetAll() { }\\n // matched by GET and string parameter\\n [HttpGet]\\n public IEnumerab\", \"le<Product> FindProductsByName(string name) { }\\n}\\n```\\n\\nGiven the above controller, an HTTP GET reque\", \"st to localhost:123/products/ matches the GetAll action. An HTTP GET request to localhost:123/produc\", \"ts?name=ardalis matches the FindProductsByName action.\\n\\n#### <span id=\\\"page-30-0\\\"></span>**Routing i\", \"n .NET 7**\\n\\nIn ASP.NET Core, routing is handled by routing middleware, which matches the URLs of inc\", \"oming requests to actions or other endpoints. Controller actions are either conventionally routed or\", \" attribute-routed. Conventional routing is similar to the route table approach used in ASP.NET MVC a\", \"nd Web API. Whether you're using conventional, attribute, or both, you need to configure your app to\", \" use the routing middleware. To use the middleware, add the following code to your *Program.cs* file\", \":\\n\\n```\\napp.UseRouting();\\n```\\n\\n#### **Conventional routing**\\n\\nWith conventional routing, you set up o\", \"ne or more conventions that will be used to match incoming URLs to *endpoints* in the app. In ASP.NE\", \"T Core, these endpoints may be controller actions, like in ASP.NET MVC or Web API. The endpoints cou\", \"ld also be Razor Pages, Health Checks, or SignalR hubs. All of these routable features are configure\", \"d in a similar fashion using endpoints:\\n\\n```\\napp.UseEndpoints(endpoints =>\\n{\\n endpoints.MapHealthChe\", \"cks(\\\"/healthz\\\").RequireAuthorization();\\n endpoints.MapControllerRoute(\\n name: \\\"default\\\",\\n pattern: \\\"\", \"{controller=Home}/{action=Index}/{id?}\\\");\\n endpoints.MapRazorPages();\\n});\\n```\\n\\nThe preceding code is\", \" used (in addition to UseRouting) to configure various endpoints, including Health Checks, controlle\", \"rs, and Razor Pages. For controllers, the above configuration specifies a default routing convention\", \", which is the fairly standard {controller}/{action}/{id?} pattern that's been recommended since the\", \" first versions of ASP.NET MVC.\\n\\n#### **Attribute routing**\\n\\nAttribute routing in ASP.NET Core is th\", \"e preferred approach for configuring routing in controllers. If you're building APIs, the [ApiContro\", \"ller] attribute should be applied to your controllers. Among other things, this attribute requires t\", \"he use of attribute routing for actions in such controller classes.\\n\\nAttribute routing in ASP.NET Co\", \"re behaves similarly in ASP.NET MVC and Web API. In addition to supporting the [Route] attribute, ho\", \"wever, route information can also be specified as part of the HTTP method attribute:\\n\\n```\\n[HttpGet(\\\"\", \"api/products/{id}\\\")]\\npublic async ActionResult<Product> Details(int id)\\n{\\n // ...\\n}\\n```\\n\\nAs with pre\", \"vious versions, you can specify a default route with placeholders, and add this at the controller cl\", \"ass level or even on a base class. You use the same [Route] attribute for all of these cases. For ex\", \"ample, a base API controller class might look like this:\\n\\n```\\n[Route(\\\"api/{controller}/{action}/{id?\", \":int}\\\")]\\npublic abstract class BaseApiController : ControllerBase, IApiController\\n{\\n // ...\\n}\\n```\\n\\nU\", \"sing this attribute, classes inheriting from this type would route URLs to actions based on the cont\", \"roller name, action name, and an optional integer id parameter.\\n\\n#### <span id=\\\"page-31-0\\\"></span>**\", \"References**\\n\\n- [ASP.NET MVC Routing Overview](https://docs.microsoft.com/aspnet/mvc/overview/older-\", \"versions-1/controllers-and-routing/asp-net-mvc-routing-overview-cs)\\n- [Attribute Routing in ASP.NET \", \"MVC 5](https://devblogs.microsoft.com/aspnet/attribute-routing-in-asp-net-mvc-5/)\\n- [Attribute routi\", \"ng in ASP.NET Web API 2](https://docs.microsoft.com/aspnet/web-api/overview/web-api-routing-and-acti\", \"ons/attribute-routing-in-web-api-2)\\n- [Routing and Action Selection in ASP.NET Web API](https://docs\", \".microsoft.com/aspnet/web-api/overview/web-api-routing-and-actions/routing-and-action-selection)\\n- [\", \"Routing in ASP.NET Core](https://docs.microsoft.com/aspnet/core/fundamentals/routing)\\n- [Routing to \", \"controller actions in ASP.NET Core MVC](https://docs.microsoft.com/aspnet/core/mvc/controllers/routi\", \"ng)\\n\\n# <span id=\\\"page-32-0\\\"></span>Logging differences between ASP.NET MVC and ASP.NET Core\\n\\nApplica\", \"tion logging provides important diagnostic information, especially for apps running in production. A\", \"SP.NET Core introduces a new system for adding standardized logging to any app. Existing ASP.NET MVC\", \" and Web API apps most likely use third-party logging solutions, which likely continue to be support\", \"ed on ASP.NET Core.\\n\\n#### <span id=\\\"page-32-1\\\"></span>**ASP.NET MVC logging**\\n\\nThere's no built-in l\", \"ogging solution in ASP.NET MVC and Web API apps. Instead, most apps use thirdparty logging solutions\", \" like [log4net,](https://www.nuget.org/packages/log4net/) [NLog,](https://www.nuget.org/packages/NLo\", \"g/) or [Serilog.](https://www.nuget.org/packages/Serilog) Many teams also choose to roll their own l\", \"ogging solution. Logging frameworks typically support multiple \\\"sinks\\\" (or targets or appenders) for\", \" log output, such as text files, databases, or even emails. They use configuration to determine whic\", \"h levels of log messages from which parts of the system are routed to different sinks. When consider\", \"ing how to migrate an app's logging to .NET Core, review how logging is performed and configured in \", \"the app.\\n\\n#### <span id=\\\"page-32-2\\\"></span>**ASP.NET Core logging**\\n\\nIn ASP.NET Core, [logging is a \", \"built-in feature](https://docs.microsoft.com/aspnet/core/fundamentals/logging/) that can be configur\", \"ed and extended when the app starts up. Third-party loggers, including those mentioned above, can be\", \" integrated with ASP.NET Core to enhance its functionality.\\n\\nASP.NET Core logging uses categories an\", \"d levels to control what is logged and how. Classes typically use instances of the ILogger<T> interf\", \"ace, with the class's type used as the generic T type. In this scenario, the class's fully qualified\", \" name is used as the category. Loggers can also be created with a custom category using an ILoggerFa\", \"ctory. Log levels range from the most detailed, Trace, to the most important, Critical. Using config\", \"uration, apps can specify what minimum level of logging should be included on a per-category (with w\", \"ildcards) basis.\\n\\nA typical logging configuration could log Information and above information by def\", \"ault, but only Warning or above from Microsoft-prefixed categories:\\n\\n```\\n{\\n \\\"Logging\\\": {\\n \\\"LogLevel\\\"\", \": {\\n \\\"Default\\\": \\\"Information\\\",\\n \\\"Microsoft\\\": \\\"Warning\\\"\\n }\\n }\\n}\\n```\\n\\nSupport for logging in ASP.NET C\", \"ore is extensive and flexible. For more detailed information, [refer to](https://docs.microsoft.com/\", \"aspnet/core/fundamentals/logging/)  [the docs.](https://docs.microsoft.com/aspnet/core/fundamentals/\", \"logging/)\\n\\n#### <span id=\\\"page-33-0\\\"></span>**Migrate logging**\\n\\nHow you migrate your .NET Framework\", \" app's logging to .NET Core depends on how the app is logging now. If it's using a third-party NuGet\", \" package, refer to the upgrade documentation for that package. Most likely the upgrade path will be \", \"fairly straightforward. If you're using your own logging solution, take one of the following actions\", \":\\n\\n- 1. Migrate the logging solution yourself\\n- 2. Migrate to a third-party logging solution\\n- 3. Us\", \"e the built-in logging support in ASP.NET Core\\n\\nYou can reference the Microsoft.Extensions.Logging p\", \"ackage from .NET Framework apps as long as they're using NuGet 4.3 or later and are on .NET Framewor\", \"k 4.6.1 or later. Once your app has referenced this package, you can convert your logging statements\", \" to use the new extensions before migrating the app to .NET Core. This can provide a stepping stone \", \"toward full migration, since the app can continue running on .NET Framework while logging using the \", \"newer extensions package.\\n\\n#### <span id=\\\"page-33-1\\\"></span>**References**\\n\\n- [Logging in .NET Core \", \"and ASP.NET Core](https://docs.microsoft.com/aspnet/core/fundamentals/logging/)\\n- [Microsoft.Extensi\", \"ons.Logging NuGet Package](https://www.nuget.org/packages/microsoft.extensions.logging/)\\n\\n# <span id\", \"=\\\"page-33-2\\\"></span>Compare Razor Pages to ASP.NET MVC\\n\\nRazor Pages is the preferred way to create p\", \"age- or form-based apps in ASP.NET Core. From the [docs,](https://docs.microsoft.com/aspnet/core/raz\", \"or-pages/)  \\\"Razor Pages can make coding page-focused scenarios easier and more productive than usin\", \"g controllers and views.\\\" If your ASP.NET MVC app makes heavy use of views, you may want to consider\", \" migrating from actions and views to Razor Pages.\\n\\nA typical strongly typed view-based MVC app will \", \"use a controller to contain one or more actions. The controller will interact with the domain or dat\", \"a model, and create an instance of a viewmodel class. Then this viewmodel class is passed to the vie\", \"w associated with that action. Using this approach, coupled with the default folder structure of MVC\", \" apps, to add a new page to an app requires modifying a controller in one folder, a view in a nested\", \" subfolder in another folder, and a viewmodel in yet another folder.\\n\\nRazor Pages group together the\", \" action (now a *handler*) and the viewmodel (called a *PageModel*) in one class, and link this class\", \" to the view (called a Razor Page). All Razor Pages go into a *Pages* folder in the root of the ASP.\", \"NET Core project. Razor Pages use a routing convention based on their name and location within this \", \"folder. Handlers behave exactly like action methods but have the HTTP verb they handle in their name\", \" (for example, OnGet). They also don't necessarily need to return, since by default they're assumed \", \"to return the page they're associated with. This tends to keep Razor Pages and their handlers smalle\", \"r and more focused while at the same time making it easier to find and work with all of the files ne\", \"eded to add or modify a particular part of an app.\\n\\nAs part of a move from ASP.NET MVC to ASP.NET Co\", \"re, teams should consider whether they want to migrate controllers and views to ASP.NET Core control\", \"lers and views, or to Razor Pages. The former\\n\\nwill most likely require slightly less overall effort\", \", but won't allow the team to take advantage of the benefits of Razor Pages over traditional view-ba\", \"sed file organization.\\n\\n#### <span id=\\\"page-34-0\\\"></span>**References**\\n\\n- [Introduction to Razor Pa\", \"ges in ASP.NET Core](https://docs.microsoft.com/aspnet/core/razor-pages/)\\n- [Simpler ASP.NET Core Ap\", \"ps with Razor Pages](https://docs.microsoft.com/archive/msdn-magazine/2017/september/asp-net-core-si\", \"mpler-asp-net-mvc-apps-with-razor-pages)\\n\\n# <span id=\\\"page-34-1\\\"></span>Compare ASP.NET Web API 2 an\", \"d ASP.NET Core\\n\\nASP.NET Core offers iterative improvements to ASP.NET Web API 2, but should feel fam\", \"iliar to developers who have used Web API 2. ASP.NET Web API 2 was developed and shipped alongside A\", \"SP.NET MVC. This meant the two approaches had similar-but-different approaches to things like attrib\", \"ute routing and dependency injection. In ASP.NET Core, there's no longer any distinction between MVC\", \" and Web APIs. There's only [ASP.NET Core,](https://docs.microsoft.com/aspnet/core/introduction-to-a\", \"spnet-core) which includes support for view-based scenarios, API endpoints, Razor Pages, health chec\", \"ks, SignalR, and more.\\n\\nIn addition to being consistent and unified within ASP.NET Core, APIs built \", \"in .NET Core are much easier to test than those built on ASP.NET Web API 2. We'll cover testing diff\", \"erences in more detail in a moment. The built-in support for hosting ASP.NET Core apps, in a test ho\", \"st that can create an HttpClient that makes in-memory requests to the app, is a huge benefit when it\", \" comes to automated testing.\\n\\nSee [Incremental ASP.NET to ASP.NET Core migration](https://docs.micro\", \"soft.com/aspnet/core/migration/inc/overview) for an incremental approach to migrating to ASP.NET Cor\", \"e.\\n\\n#### <span id=\\\"page-34-2\\\"></span>**References**\\n\\n- [Migrate from ASP.NET Web API to ASP.NET Core\", \"](https://docs.microsoft.com/aspnet/core/migration/webapi)\\n- [Ardalis.ApiEndpoints NuGet package](ht\", \"tps://www.nuget.org/packages/Ardalis.ApiEndpoints/)\\n\\n# <span id=\\\"page-34-3\\\"></span>Compare authentic\", \"ation and authorization between ASP.NET MVC and ASP.NET Core\\n\\nIn ASP.NET MVC 5, authentication is co\", \"nfigured in *Startup.Auth.cs* in the *App\\\\_Start* folder. In ASP.NET Core MVC, this configuration oc\", \"curs in *Startup.cs* or *Program.cs*, as part of configuring the app's services and middleware.\\n\\nAut\", \"hentication and authorization are performed using middleware added to the request pipeline:\\n\\n```\\napp\", \".UseRouting();\\napp.UseAuthentication();\\napp.UseAuthorization();\\napp.UseEndpoints(endpoints =>\\n{\\n```\\n\", \"\\n```\\n endpoints.MapControllerRoute(\\n name: \\\"default\\\",\\n pattern: \\\"{controller=Home}/{action=Index}/{i\", \"d?}\\\");\\n endpoints.MapRazorPages();\\n});\\n```\\n\\nIt's important to add the auth middleware in the appropr\", \"iate order in the middleware pipeline. Only requests that make it to the middleware will be impacted\", \" by it. For instance, if a call to UseStaticFiles() were placed above the code shown here, it wouldn\", \"'t be protected by authentication and authorization.\\n\\nIn ASP.NET MVC and Web API, apps often refer t\", \"o the current user using the ClaimsPrincipal.Current property. This property isn't set in ASP.NET Co\", \"re, and any behavior in your app that depends on it will need to [migrate from ClaimsPrincipal.Curre\", \"nt](https://docs.microsoft.com/aspnet/core/migration/claimsprincipal-current) by using the User prop\", \"erty on ControllerBase or getting access to the current HttpContext and referencing its User propert\", \"y. If neither of these solutions is an option, services can request the User as an argument, in whic\", \"h case it must be supplied from elsewhere in the app, or the IHttpContextAccessor can be requested a\", \"nd used to get the HttpContext.\\n\\n#### <span id=\\\"page-35-0\\\"></span>**Authorization**\\n\\nAuthorization d\", \"efines what a given user can do within the app. It's separate from authentication, which is concerne\", \"d merely with identifying who the user is. ASP.NET Core provides a simple, declarative role and a ri\", \"ch, policy-based model for authorization. Specifying that a resource requires authorization is often\", \" as simple as adding the [Authorize] attribute to the action or controller. If you're migrating to R\", \"azor Pages from MVC views, you should [specify conventions for authorization when](https://docs.micr\", \"osoft.com/aspnet/core/security/authorization/razor-pages-authorization)  [you configure Razor Pages.\", \"](https://docs.microsoft.com/aspnet/core/security/authorization/razor-pages-authorization)\\n\\nAuthoriz\", \"ation in ASP.NET Core may be as simple as prohibiting anonymous users while allowing authenticated u\", \"sers. Or it can scale up to support role-based, claims-based, or policy-based authorization approach\", \"es. For more information on these approaches, see the documentation on [authorization in ASP.NET Cor\", \"e](https://docs.microsoft.com/aspnet/core/security/authorization/introduction). You'll likely find t\", \"hat one of them is closely aligned with your current authorization approach.\\n\\n#### <span id=\\\"page-35\", \"-1\\\"></span>**References**\\n\\n- [Security, Authentication, and Authorization with ASP.NET MVC](https://\", \"docs.microsoft.com/aspnet/mvc/overview/security/)\\n- [Migrate Authentication and Identity to ASP.NET \", \"Core](https://docs.microsoft.com/aspnet/mvc/overview/security/)\\n- [Migrate from ClaimsPrincipal.Curr\", \"ent](https://docs.microsoft.com/aspnet/core/migration/claimsprincipal-current)\\n- [Introduction to Au\", \"thorization in ASP.NET Core](https://docs.microsoft.com/aspnet/core/security/authorization/introduct\", \"ion)\\n\\n# <span id=\\\"page-35-2\\\"></span>Compare ASP.NET Identity and ASP.NET Core Identity\\n\\nIn ASP.NET M\", \"VC, identity features are typically configured in *IdentityConfig.cs* in the *App\\\\_Start* folder. Re\", \"view how this is configured in the existing app, and compare it to the [configuration required for](\", \"https://docs.microsoft.com/aspnet/core/security/authentication/identity-configuration)  [ASP.NET Cor\", \"e Identity](https://docs.microsoft.com/aspnet/core/security/authentication/identity-configuration) i\", \"n *Program.cs*.\\n\\nASP.NET Identity is an API that supports user interface login functionality and man\", \"ages users, passwords, profile data, roles, claims, tokens, email confirmations, and more. It suppor\", \"ts external login providers like Facebook, Google, Microsoft, and Twitter.\\n\\nIf your ASP.NET MVC app \", \"is using ASP.NET Membership, you'll find a guide to [migrate from ASP.NET](https://docs.microsoft.co\", \"m/aspnet/core/migration/proper-to-2x/membership-to-core-identity)  [Membership authentication to ASP\", \".NET Core 2.0 Identity.](https://docs.microsoft.com/aspnet/core/migration/proper-to-2x/membership-to\", \"-core-identity) This is mainly a data migration exercise, at the completion of which you should be a\", \"ble to use ASP.NET Core Identity with your migrated user records.\\n\\nIf you migrate your ASP.NET Ident\", \"ity users to ASP.NET Core Identity, you may need to update their password hashes, or track which pas\", \"swords are hashed with the new ASP.NET Core Identity approach or the older ASP.NET Identity approach\", \". [This approach described on Stack Overflow](https://stackoverflow.com/a/57074910/13729) provides s\", \"ome options for migrating user password hashes over time, rather than all at once.\\n\\nOne of the bigge\", \"st differences when it comes to ASP.NET Core Identity compared to ASP.NET Identity is how little cod\", \"e you need to include in your project. ASP.NET Core Identity now ships as a Razor Class Library, mea\", \"ning its UI and logic are all available from a NuGet package. You can override the existing UI and l\", \"ogic by [scaffolding the ASP.NET Core Identity files](https://docs.microsoft.com/aspnet/core/securit\", \"y/authentication/scaffold-identity) but even in this case you need only scaffold the pages you want \", \"to modify, not every one that exists.\\n\\n#### <span id=\\\"page-36-0\\\"></span>**Migrate from OWIN / Katana\", \"**\\n\\nThe following resources offer some guidance for migrating from OWIN / Katana:\\n\\n- [Migration](htt\", \"ps://docs.microsoft.com/aspnet/core/migration/proper-to-2x/#globalasax-file-replacement)\\n- [Katana t\", \"o ASPNET 5](https://devblogs.microsoft.com/aspnet/katana-asp-net-5-and-bridging-the-gap/)\\n\\n#### <spa\", \"n id=\\\"page-36-1\\\"></span>**References**\\n\\n- [Migrate Authentication and Identity to ASP.NET Core](http\", \"s://docs.microsoft.com/aspnet/core/migration/identity)\\n- [Introduction to Identity on ASP.NET Core](\", \"https://docs.microsoft.com/aspnet/core/security/authorization/introduction)\\n- [Configure ASP.NET Cor\", \"e Identity](https://docs.microsoft.com/aspnet/core/security/authentication/identity-configuration)\\n-\", \" <span id=\\\"page-36-2\\\"></span>\\u2022 [Scaffold Identity in ASP.NET Core projects](https://docs.microsoft.c\", \"om/aspnet/core/security/authentication/scaffold-identity)\\n\\n# Compare controllers in ASP.NET MVC and \", \"Web API with controllers in ASP.NET Core\\n\\nIn ASP.NET MVC 5 and Web API 2, there were two different C\", \"ontroller base types. MVC controllers inherited from Controller; Web API controllers inherited from \", \"ApiController. In ASP.NET Core, this object hierarchy has been merged. It's recommended that API con\", \"trollers in ASP.NET Core inherit from ControllerBase and add the [ApiController] attribute. Standard\", \" view-based MVC controllers should inherit from Controller.\\n\\nIn both frameworks, controllers are use\", \"d to organize sets of action methods. Filters and routes can be applied on a controller level in add\", \"ition to at the action level. These conventions can be extended further by using custom base Control\", \"ler types with default behavior and attributes applied to them.\\n\\nIn ASP.NET MVC, content negotiation\", \" isn't supported. ASP.NET Web API 2 does support content negotiation, as does ASP.NET Core. Using [c\", \"ontent negotiation,](https://docs.microsoft.com/aspnet/core/web-api/advanced/formatting) the format \", \"of the content returned to a request can be determined by headers the client provides indicating its\", \" preferred manner of receiving the content.\\n\\nWhen migrating ASP.NET Web API controllers to ASP.NET C\", \"ore, a few components need to be changed if they exist. These include references to the ApiControlle\", \"r base class, the System.Web.Http namespace, and the IHttpActionResult interface. Refer to the [docu\", \"mentation for recommendations on](https://docs.microsoft.com/aspnet/core/migration/webapi)  [how to \", \"migrate these specific differences.](https://docs.microsoft.com/aspnet/core/migration/webapi) Note t\", \"hat the preferred return type for API actions in ASP.NET Core is ActionResult<T>.\\n\\nIn addition, the \", \"[ChildActionOnly] attribute isn't supported in ASP.NET Core. In ASP.NET Core, similar functionality \", \"is achieved using [View Components.](https://docs.microsoft.com/aspnet/core/mvc/views/view-component\", \"s)\\n\\nASP.NET Core includes two new attributes: [ConsumesAttribute](https://docs.microsoft.com/dotnet/\", \"api/microsoft.aspnetcore.mvc.consumesattribute) and [ProducesAttribute.](https://docs.microsoft.com/\", \"dotnet/api/microsoft.aspnetcore.mvc.producesattribute) These are used to specify the type an action \", \"consumes or produces, which can be helpful for routing and documenting the API using tools like [Swa\", \"gger/OpenAPI.](https://docs.microsoft.com/aspnet/core/tutorials/web-api-help-pages-using-swagger)\\n\\n#\", \"### <span id=\\\"page-37-0\\\"></span>**References**\\n\\n- [Format response data in ASP.NET Core Web API](htt\", \"ps://docs.microsoft.com/aspnet/core/web-api/advanced/formatting)\\n- [Migrate from ASP.NET Web API to \", \"ASP.NET Core](https://docs.microsoft.com/aspnet/core/migration/webapi)\\n\\n# <span id=\\\"page-37-1\\\"></spa\", \"n>Compare Razor usage in ASP.NET MVC and ASP.NET Core\\n\\nThe basic syntax of Razor hasn't changed subs\", \"tantially between ASP.NET MVC and ASP.NET Core. However, there are certain differences, such as the \", \"introduction of [Tag Helpers](https://docs.microsoft.com/aspnet/core/mvc/views/tag-helpers/intro) an\", \"d Razor Pages, that should be considered when migrating. If your app makes heavy use of custom Razor\", \" functionality, refer to the [Razor syntax reference for ASP.NET Core](https://docs.microsoft.com/as\", \"pnet/core/razor-pages) to see what changes may be required when you migrate to ASP.NET Core.\\n\\n#### <\", \"span id=\\\"page-37-2\\\"></span>**Tag Helpers**\\n\\nTag Helpers enable server-side code to participate in cr\", \"eating and rendering HTML elements in Razor files. They offer many advantages over HTML Helpers and \", \"should be used in place of HTML Helpers wherever possible. They provide an HTML-friendly development\", \" experience, since they look like standard HTML and are ignored by most tooling designed to edit HTM\", \"L. Within *Visual Studio*, there's rich IntelliSense support for creating HTML and Razor markup with\", \" Tag Helpers. Tag Helpers can provide simple or complex behavior from declarative markup in Razor fi\", \"les.\\n\\n#### <span id=\\\"page-37-3\\\"></span>**Razor Pages**\\n\\nRazor Pages offer an alternative to controll\", \"ers, actions, and views for page- and form-based apps. [Razor Pages were compared to ASP.NET MVC ear\", \"lier in this chapter.](#page-33-2)\\n\\n#### <span id=\\\"page-38-0\\\"></span>**References**\\n\\n- [Migrate from\", \" ASP.NET MVC to ASP.NET Core MVC: Controllers and Views](https://docs.microsoft.com/aspnet/core/migr\", \"ation/mvc#migrate-controllers-and-views)\\n- [Tag Helpers in ASP.NET Core](https://docs.microsoft.com/\", \"aspnet/core/mvc/views/tag-helpers/intro)\\n- [Introduction to Razor Pages in ASP.NET Core](https://doc\", \"s.microsoft.com/aspnet/core/razor-pages)\\n- <span id=\\\"page-38-1\\\"></span>\\u2022 [Razor syntax reference for\", \" ASP.NET Core](https://docs.microsoft.com/aspnet/core/razor-pages)\\n\\n# Compare ASP.NET SignalR and AS\", \"P.NET Core SignalR\\n\\nASP.NET Core SignalR is incompatible with clients or servers using ASP.NET Signa\", \"lR. You'll need to update both clients and server to use ASP.NET Core SignalR. Some differences are \", \"described in this section, while the full list is available in the [docs.](https://docs.microsoft.co\", \"m/aspnet/core/signalr/version-differences) ASP.NET Core SignalR requires .NET Core 2.1 or greater.\\n\\n\", \"#### <span id=\\\"page-38-2\\\"></span>**Feature differences**\\n\\n- ASP.NET SignalR automatically attempts t\", \"o reconnect dropped connections; this behavior is opt-in for ASP.NET Core SignalR clients.\\n- Both fr\", \"ameworks support JSON; ASP.NET Core SignalR also supports a binary protocol based on MessagePack, an\", \"d custom protocols can be created.\\n- The Forever Frame transport, supported by ASP.NET SignalR, isn'\", \"t supported in ASP.NET Core SignalR.\\n- ASP.NET Core SignalR must be configured by adding services.Ad\", \"dSignalR() and app.UseEndpoints in *Program.cs*.\\n- ASP.NET Core SignalR requires sticky sessions; AS\", \"P.NET SignalR doesn't.\\n- ASP.NET Core simplifies the connection model; connections are only made to \", \"a single hub.\\n- ASP.NET Core SignalR supports streaming data from the hub to the client.\\n- ASP.NET C\", \"ore SignalR doesn't support passing state between clients and the hub (but method calls still allow \", \"passing information between hubs and clients).\\n- The PersistentConnection class doesn't exist in ASP\", \".NET Core SignalR.\\n- ASP.NET SignalR supports SQL Server and Redis. ASP.NET Core SignalR supports [A\", \"zure](https://docs.microsoft.com/azure/azure-signalr/)  [SignalR](https://docs.microsoft.com/azure/a\", \"zure-signalr/) and Redis.\\n\\n#### <span id=\\\"page-38-3\\\"></span>**References**\\n\\n- [Differences between A\", \"SP.NET SignalR and ASP.NET Core SignalR](https://docs.microsoft.com/aspnet/core/signalr/version-diff\", \"erences)\\n- [Azure SignalR Service](https://docs.microsoft.com/azure/azure-signalr/)\\n\\n# <span id=\\\"pag\", \"e-39-0\\\"></span>Compare testing options between ASP.NET MVC and ASP.NET Core\\n\\nASP.NET MVC apps suppor\", \"t unit testing of controllers, but this approach often omits many MVC features like routing, authori\", \"zation, model binding, model validation, filters, and more. To test these MVC features in addition t\", \"o the logic within the controller action itself, frequently the app would need to be deployed and th\", \"en tested with a tool like Selenium. These tests are substantially more expensive, more brittle, and\", \" slower than typical unit tests that can be run without the need for hosting and running the entire \", \"app.\\n\\n[ASP.NET Core controllers can be unit tested](https://docs.microsoft.com/aspnet/core/mvc/contr\", \"ollers/testing) just like ASP.NET MVC controllers, but with the same limitations. However, [ASP.NET \", \"Core supports fast, easy-to-author integration tests](https://docs.microsoft.com/aspnet/core/test/in\", \"tegration-tests) as well. Integration tests are hosted by a TestHost class and are typically configu\", \"red in a custom WebApplicationFactory that can override or replace app dependencies. For instance, f\", \"requently during integration tests the app will target a different data source and may replace servi\", \"ces that send emails with fake or mock implementations.\\n\\nASP.NET MVC and Web API did not support any\", \"thing like the integration testing scenarios available in ASP.NET Core. In any migration effort, you\", \" should allocate time to write some integration tests for your newly migrated system to ensure it's \", \"working as expected and continues to do so. Even if you weren't writing tests of your web app logic \", \"before the migration, you should strongly consider doing so as you move to ASP.NET Core.\\n\\n#### <span\", \" id=\\\"page-39-1\\\"></span>**References**\\n\\n- [Creating Unit Tests for ASP.NET MVC Applications](https://\", \"docs.microsoft.com/aspnet/mvc/overview/older-versions-1/unit-testing/creating-unit-tests-for-asp-net\", \"-mvc-applications-cs)\\n- [Unit test controller logic in ASP.NET Core](https://docs.microsoft.com/aspn\", \"et/core/mvc/controllers/testing)\\n- [Integration tests in ASP.NET Core](https://docs.microsoft.com/as\", \"pnet/core/test/integration-tests)\\n\\n**CHAPTER** 3\\n\\n# <span id=\\\"page-40-0\\\"></span>Migrate large soluti\", \"ons to ASP.NET Core\\n\\nMigrating large solutions from .NET Framework to .NET Core requires some planni\", \"ng. Dependencies must be migrated or updated before the projects that depend on them. There are tool\", \"s that can identify dependencies and offer help with migrating to .NET Core. Depending on the app, i\", \"ts scope, and current usage patterns, different strategies may be employed when migrating. Do you mi\", \"grate it all at once, or over time, side-by-side with the current system? Do you wrap the current sy\", \"stem in the new one, and incrementally replace its functionality?\\n\\nIn this chapter, you'll learn how\", \" create a migration plan for a large solution, how to use tools to help with the migration, and some\", \" strategies to consider for the migration itself.\\n\\n# <span id=\\\"page-40-1\\\"></span>References\\n\\n- [What\", \" topics are important to migrating large MVC and Web API apps to .NET Core?](https://twitter.com/ard\", \"alis/status/1313669040859217921)\\n- <span id=\\\"page-40-2\\\"></span>\\u2022 [Porting from .NET Framework to .NE\", \"T Core](https://docs.microsoft.com/en-us/dotnet/core/porting/)\\n\\n# Identify sequence of projects to m\", \"igrate\\n\\nFor solutions that involve multiple front-end apps, it's best to migrate the apps one by one\", \". For example, create a solution that only includes one front-end app and its dependencies so you ca\", \"n easily identify the scope of work involved. Solutions are lightweight, and you can include project\", \"s in multiple solutions if needed. Take advantage of solutions as an organizational tool when migrat\", \"ing.\\n\\nOnce you've identified the ASP.NET app to migrate and have its dependent projects located with\", \" it (ideally in a solution), the next step is to identify framework and NuGet dependencies. Having i\", \"dentified all dependencies, the simplest migration approach is a \\\"bottom up\\\" approach. With this app\", \"roach, the lowest level of dependencies is migrated first. Then the next level of dependencies is mi\", \"grated, until eventually the only thing left is the front-end app. Figure 3-1 shows an example set o\", \"f projects composing an app. The low-level class libraries are at the bottom, and the ASP.NET MVC pr\", \"oject is at the top.\\n\\n![](_page_41_Figure_0.jpeg)\\n\\n*Figure 3-1. Project dependencies graph.*\\n\\nChoose\", \" a particular front-end app, an ASP.NET MVC 5 / Web API 2 project. Identify its dependencies in the \", \"solution, and map out their dependencies until you have a complete list. A diagram like the one show\", \"n in Figure 3-1 may be useful when mapping out project dependencies. Visual Studio can produce a [de\", \"pendency diagram for your solution](https://docs.microsoft.com/visualstudio/modeling/create-layer-di\", \"agrams-from-your-code), depending on which edition you're using. [The .NET](https://docs.microsoft.c\", \"om/en-us/dotnet/standard/analyzers/portability-analyzer)  [Portability Analyzer](https://docs.micros\", \"oft.com/en-us/dotnet/standard/analyzers/portability-analyzer) can also produce dependency diagrams.\\n\", \"\\nFigure 3-2 shows the installer for the [.NET Portability Analyzer Visual Studio extension:](https:/\", \"/marketplace.visualstudio.com/items?itemName=ConnieYau.NETPortabilityAnalyzer)\\n\\n![](_page_42_Figure_\", \"0.jpeg)\\n\\n*Figure 3-2. .NET Portability Analyzer installer.*\\n\\nThe extension currently supports Visual\", \" Studio 2017 and 2019. Visual Studio 2022 support is planned.\\n\\nOnce installed, you configure it from\", \" the **Analyze** > **Portability Analyzer Settings** menu, as shown in Figure 3-3.\\n\\n![](_page_43_Fig\", \"ure_0.jpeg)\\n\\n*Figure 3-3. Configure the .NET Portability Analyzer.*\\n\\nThe analyzer produces a detaile\", \"d report for each assembly. The report:\\n\\n- Describes how compatible each project is with a given tar\", \"get framework, such as .NET 7 or .NET Standard 2.0.\\n- Helps teams assess the effort required to port\", \" a particular project to a particular target framework.\\n\\nThe details of this analysis are covered in\", \" the next section.\\n\\nOnce you've mapped out the projects and their relationships with one another, yo\", \"u're ready to determine the order in which you'll migrate the projects. Begin with projects that hav\", \"e no dependencies. Then, work your way up the tree to the projects that depend on these projects.\\n\\nI\", \"n the example shown in Figure 3-1, you would start with the *Contoso.Utils* project, since it doesn'\", \"t depend on any other projects. Next, *Contoso.Data* since it only depends on \\\"Utils\\\". Then migrate \", \"the \\\"BusinessLogic\\\" library, and finally the front-end ASP.NET \\\"Web\\\" project. Following this \\\"bottom\", \" up\\\" approach works well for relatively small and well-factored apps that can be migrated as a unit \", \"once all of their projects have migrated. Larger apps with more complexity, or more code that will t\", \"ake longer to migrate, may need to consider more incremental strategies.\\n\\n#### <span id=\\\"page-44-0\\\">\", \"</span>**Unit tests**\\n\\nMissing from the previous diagrams are unit test projects. Hopefully there ar\", \"e tests covering at least some of the existing behavior of the libraries being ported.\\n\\nIf you have \", \"unit tests, it's best to convert those projects first. You'll want to continue testing changes in th\", \"e project you're working on. Remember that porting to .NET Core is a significant change to your code\", \"base.\\n\\nMSTest, xUnit, and NUnit all work on .NET Core. If you don't currently have tests for your ap\", \"p, consider building some characterization tests that verify the system's current behavior. The bene\", \"fit is that once the migration is complete, you can confirm the app's behavior remains unchanged.\\n\\n#\", \"### <span id=\\\"page-44-1\\\"></span>**Considerations for migrating many apps**\\n\\nSome organizations will \", \"have many different apps to migrate, and migrating each one by hand may require too many resources t\", \"o be tenable. In these situations, some degree of automation is recommended. The steps followed in t\", \"his chapter can be automated. Structural changes, like project file differences and updates to commo\", \"n packages, can be applied by scripts. These scripts can be refined as they're run iteratively on mo\", \"re projects. On each run, examine whatever manual steps are required for each project. Automate thos\", \"e manual steps, if possible. Using this approach, the organization should grow faster and better at \", \"porting their apps over time, with improved automation support each step of the way.\\n\\nWatch an overv\", \"iew of how to employ this approach in this [dotNetConf presentation by Lizzy](https://www.youtube.co\", \"m/watch?v=C-2haqb60No)  [Gallagher of Mastercard.](https://www.youtube.com/watch?v=C-2haqb60No) The \", \"five phases employed in this presentation included:\\n\\n- Migrate third-party NuGet dependencies\\n- Migr\", \"ate apps to use new *.csproj* file format\\n- Update internal NuGet dependencies to .NET Standard\\n- Mi\", \"grate apps to ASP.NET Core (targeting .NET Framework)\\n- Update all apps to target .NET 7\\n\\nWhen autom\", \"ating a large suite of apps, it helps significantly if they follow consistent coding guidelines and \", \"project organization. Automation efforts rely on this consistency to be effective. In addition to pa\", \"rsing and migrating project files, common code patterns can be migrated automatically. Some code pat\", \"tern examples include differences in how controller actions are declared or how they return results.\", \"\\n\\nFor example, a migration script could search files matching *Controller.cs* for lines of code matc\", \"hing one of these patterns:\\n\\n```\\n return new HttpStatusCodeResult(200);\\n // or\\n return new HttpStatu\", \"sCodeResult(HttpStatusCode.OK);\\n```\\n\\nIn ASP.NET Core, either of the preceding lines of code can be r\", \"eplaced with:\\n\\n```\\n return Ok();\\n```\\n\\n# <span id=\\\"page-45-0\\\"></span>**Summary**\\n\\nThe best approach t\", \"o porting a large .NET Framework app to .NET Core is to:\\n\\n- 1. Identify project dependencies.\\n- 2. A\", \"nalyze what's required to port each project.\\n- 3. Start from the bottom up.\\n\\nYou can use the .NET Po\", \"rtability Analyzer to determine how compatible existing libraries may be with target platforms. Auto\", \"mated tests will help ensure no breaking changes are introduced as the app is ported. These test pro\", \"jects should be among the first projects ported.\\n\\n#### <span id=\\\"page-45-1\\\"></span>**References**\\n\\n-\", \" [Porting from .NET Framework to .NET Core](https://docs.microsoft.com/en-us/dotnet/core/porting/)\\n-\", \" [The .NET Portability Analyzer](https://docs.microsoft.com/en-us/dotnet/standard/analyzers/portabil\", \"ity-analyzer)\\n- <span id=\\\"page-45-2\\\"></span>\\u2022 [2 Years, 200 Apps: A .NET Core Migration at Scale \\\\(V\", \"ideo\\\\)](https://www.youtube.com/watch?v=C-2haqb60No)\\n\\n# Understand and update dependencies\\n\\nAfter id\", \"entifying the sequence in which the app's individual projects must be migrated, the next step is to \", \"understand each project's dependencies and update them if necessary. For platform dependencies, the \", \"best way to start is to run the [.NET Portability Analyzer](https://docs.microsoft.com/en-us/dotnet/\", \"standard/analyzers/portability-analyzer) on the assembly in question, and then look at the detailed \", \"results that are generated. You configure the tool to specify one or more target platforms, such as \", \".NET 7 or .NET Standard 2.0. Results are provided with details for each platform targeted. Figure 3-\", \"4 shows an example of the tool's output.\\n\\n![](_page_45_Picture_12.jpeg)\\n\\n*Figure 3-4. .NET Portabili\", \"ty Analyzer report details.*\\n\\n#### <span id=\\\"page-45-3\\\"></span>**Update class library dependencies**\", \"\\n\\nLarge apps typically involve multiple projects, and most projects other than the ASP.NET MVC web p\", \"roject are likely to be class libraries. Class libraries tend to be the easiest to port between .NET\", \"\\n\\nplatforms, especially compared to ASP.NET projects, which are among the most difficult (and typica\", \"lly need to be re-created).\\n\\nTeams can consider the [try-convert tool](https://github.com/dotnet/try\", \"-convert) or the [.NET Upgrade Assistant tool](https://aka.ms/dotnet-upgrade-assistant) for migratin\", \"g class libraries to .NET Core. These tools analyze a .NET Framework project file and attempt to mig\", \"rate it to the .NET Core project file format, making any modifications it can safely perform in the \", \"process. The tools may require some manual assistance to work with ASP.NET projects, but can usually\", \" help speed up the process of migrating class libraries.\\n\\nThe try-convert and Upgrade Assistant tool\", \"s are deployed as .NET Core command line tools. They only run on Windows, since they're designed to \", \"work with .NET Framework apps. You can install tryconvert by running the following command from a co\", \"mmand prompt:\\n\\ndotnet tool install -g try-convert\\n\\nOnce you've successfully installed the tool, you \", \"can run try-convert in the folder where the class library's project file is located.\\n\\nInstall the .N\", \"ET Upgrade Assistant with the following command (after installing try-convert):\\n\\ndotnet tool install\", \" -g upgrade-assistant\\n\\nRun the tool with the command upgrade-assistant upgrade <project> in the fold\", \"er where the project file is located.\\n\\n#### <span id=\\\"page-46-0\\\"></span>**Update NuGet package depen\", \"dencies**\\n\\nAnalyze your use of third-party NuGet packages and determine if any of them don't yet sup\", \"port .NET Standard (or do support it but only with a new version). It can be helpful to [update NuGe\", \"t packages](https://docs.microsoft.com/nuget/consume-packages/migrate-packages-config-to-package-ref\", \"erence)  to use <PackageReference> [syntax using Visual Studio's converter tool](https://docs.micros\", \"oft.com/nuget/consume-packages/migrate-packages-config-to-package-reference), so that top-level depe\", \"ndencies are visible. Next, check whether the current or later versions of these packages support .N\", \"ET Core or .NET Standard. This information can be found on [nuget.org] or within Visual Studio for e\", \"ach package.\\n\\nIf support exists using the version of the package the app currently uses, great! If n\", \"ot, see if a more recent version of the package has the support and research what would be involved \", \"in upgrading. There may be breaking changes in the package, especially if the major version of the p\", \"ackage changes between your currently used version and the one to which you're upgrading.\\n\\nIn some c\", \"ases, no version of a given package works with .NET Core. In that case, teams have a couple options.\", \" They can continue depending on the .NET Framework version, but this has limitations. The app may on\", \"ly run on Windows, and the team may want to run Portability Analyzer on the package's binaries to se\", \"e if there are any issues likely to be encountered. Certainly the team will want to test thoroughly,\", \" since if .NET Framework packages are used that reference APIs not available in .NET Core, a runtime\", \" exception will occur. The other option is to find a different package or, if the required package i\", \"s open source, upgrade it to .NET Standard or .NET Core themselves.\\n\\n#### <span id=\\\"page-47-0\\\"></spa\", \"n>**Migrate ASP.NET MVC projects**\\n\\nThe System.Web namespace and types don't exist in .NET Core. Whe\", \"n you're analyzing dependencies and using tools like try-convert, you'll find they don't offer many \", \"suggestions for automatic migration of ASP.NET MVC projects and any code in them that references Sys\", \"tem.Web. For these projects, you'll need to start with a new ASP.NET Core web project and manually m\", \"igrate files to this project.\\n\\nIn general, it's a good practice to minimize how much of an app's bus\", \"iness logic lives in its user interface layer. It's also best to keep controllers and views small. A\", \"pps that have followed this guidance will be easier to port than those that have a significant amoun\", \"t of their logic in the ASP.NET web project. If you have an app you're considering porting, but have\", \"n't begun the process yet, keep this in mind as you maintain it. Any effort you put toward minimizin\", \"g how much code is in the ASP.NET MVC or Web API project will likely result in less work when the ti\", \"me comes to port the app.\\n\\nThe next chapter digs into details of how to migrate from ASP.NET MVC and\", \" Web API projects to ASP.NET Core projects. The previous chapter called out the biggest differences \", \"between the apps. Once the basic project structure is in place, migrating individual controllers and\", \" views is usually straightforward, especially if they're mainly focused on web responsibilities.\\n\\n##\", \"## <span id=\\\"page-47-1\\\"></span>**References**\\n\\n- [.NET Upgrade Assistant tool](https://aka.ms/dotnet\", \"-upgrade-assistant)\\n- [try-convert tool](https://github.com/dotnet/try-convert)\\n- [apiport tool](htt\", \"ps://github.com/microsoft/dotnet-apiport)\\n\\n# <span id=\\\"page-47-2\\\"></span>Strategies for migrating wh\", \"ile running in production\\n\\nMany teams have .NET Framework apps they plan to migrate to .NET Core/.NE\", \"T 7, but the app is so large that the migration requires a significant amount of time to complete. T\", \"he original app needs to live on while the migration is done piece by piece. There needs to be a way\", \" for the old and new versions of the app to work together side-by-side, or for the old version to be\", \" migrated in-place, at least some of the way, without breaking it. Teams can employ many different s\", \"trategies to support these goals.\\n\\n#### <span id=\\\"page-47-3\\\"></span>**Refactor the .NET Framework so\", \"lution**\\n\\nA good place to start if you plan to port a .NET Framework app to .NET Core is to refactor\", \" it to work better with .NET Core. This means updating individual class libraries to target .NET Sta\", \"ndard and moving as much logic out of your ASP.NET MVC projects and into these class libraries. Any \", \"code you have in .NET Standard libraries is immediately usable from both .NET Framework to .NET Core\", \" apps, which is why this step is so valuable as part of a migration.\\n\\nWhen refactoring, make sure yo\", \"u're following good refactoring fundamentals. For example, create tests that verify what the system \", \"does before you start refactoring. Run these tests when you're done to confirm you didn't change the\", \" system's behavior. You may need to add characterization tests to the system if you don't already ha\", \"ve a good suite of automated tests you can rely on.\\n\\n#### <span id=\\\"page-48-0\\\"></span>**Extract fron\", \"t-end assets to a CDN**\\n\\nIf your .NET Framework apps include a lot of static assets, like scripts, C\", \"SS files, or images, you may be able to migrate these to a separate CDN. Then, update the existing a\", \"pp to reference the CDN links for these assets. When you port the app to .NET Core, these static fil\", \"es won't be part of the migration, and you'll just continue referencing them from the CDN in the ASP\", \".NET Core app.\\n\\n#### <span id=\\\"page-48-1\\\"></span>**Extract and migrate individual microservices**\\n\\nL\", \"arge .NET Framework apps may already be comprised of separate front-end systems that can be migrated\", \" individually. Or they may be candidates for migration to a microservices architecture, with some pi\", \"eces of existing ASP.NET MVC apps being pulled out into new ASP.NET Core microservice implementation\", \"s. You can learn more about microservices in the associated ebook, [.NET](https://aka.ms/microservic\", \"esebook)  [Microservices: Architecture for Containerized .NET Applications.](https://aka.ms/microser\", \"vicesebook)\\n\\nFor example, the existing app might have a set of features it uses related to user sign\", \"-in and registration. These could be migrated to a separate microservice, which could be built and d\", \"eployed using ASP.NET Core and then integrated into the legacy .NET Framework app. Next, the app mig\", \"ht have a few pages dedicated to tracking the individual user's shopping cart. These pages could als\", \"o be pulled out into their own separate microservice and again integrated into the existing app. In \", \"this way, the original .NET Framework app continues running in production, but with more and more of\", \" its features coming from modernized .NET Core microservices.\\n\\n#### <span id=\\\"page-48-2\\\"></span>**De\", \"ploy multiple versions of the app side-by-side in IIS**\\n\\nUsing a combination of host headers and red\", \"irects, an existing ASP.NET MVC app can be configured to run side by side with an ASP.NET Core app o\", \"n the same IIS server. As pieces of functionality, such as individual controllers, are ported to ASP\", \".NET Core, their routes and URLs are mapped within IIS to target the ASP.NET Core web site or sub-ap\", \"plication (IIS virtual directories aren't supported with ASP.NET Core apps). An ASP.NET Core app can\", \" be hosted as an IIS sub-application (sub-app). The sub-app's path becomes part of the root app's UR\", \"L.\\n\\n#### <span id=\\\"page-48-3\\\"></span>**Apply the Strangler pattern**\\n\\nLarge ASP.NET MVC apps can be \", \"gradually replaced with a new ASP.NET Core app by incrementally migrating pieces of functionality. O\", \"ne approach to this is called the [strangler pattern,](https://docs.microsoft.com/azure/architecture\", \"/patterns/strangler) named for strangler vines that strangle and eventually tear down trees. This ap\", \"proach relies on first implementing a facade layer over top of the existing solution. This facade sh\", \"ould be built using the new approach to the problem, or an off-the-shelf solution such as an API gat\", \"eway.\\n\\nOnce the facade is in place, you can route part of it to a new ASP.NET Core app. As you port \", \"more of the original .NET Framework app to .NET Core, you continue to update the facade layer accord\", \"ingly, sending more of the facade's total functionality to the new system. Figure 3-5 shows the stra\", \"ngler pattern progression over time.\\n\\n![](_page_49_Picture_0.jpeg)\\n\\n*Figure 3-5. The Strangler patte\", \"rn over time.*\\n\\nEventually, the entire facade layer corresponds to the new, modern implementation. A\", \"t this point, both the legacy system and the face layer can be retired. Microsoft has guidance on ho\", \"w to achieve [incremental ASP.NET to ASP.NET Core migration using the YARP reverse proxy.](https://d\", \"evblogs.microsoft.com/dotnet/incremental-asp-net-to-asp-net-core-migration/)\\n\\n#### <span id=\\\"page-49\", \"-0\\\"></span>**Multi-targeting approaches**\\n\\nMulti-targeting is recommended for large apps that will b\", \"e migrated over time and for teams applying the Strangler pattern approach. This approach can addres\", \"s BindingRedirect and package restoration challenges that surface from mixing [PackageReference](htt\", \"ps://docs.microsoft.com/nuget/consume-packages/package-references-in-project-files) and [packages.co\", \"nfig](https://docs.microsoft.com/nuget/reference/packages-config) restore styles. There are two opti\", \"ons available for code that must run in both .NET Framework and .NET Core environments.\\n\\n- Preproces\", \"sor directives [\\\\(#if in C#](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/prepr\", \"ocessor-directives#conditional-compilation) or [#If in Visual Basic\\\\)](https://docs.microsoft.com/do\", \"tnet/visual-basic/reference/language-specification/preprocessing-directives#conditional-compilation)\", \" allow you to implement different functionality or use different dependencies when run in .NET Frame\", \"work versus .NET Core.\\n- Project files can use conditional [globbing patterns,](https://docs.microso\", \"ft.com/en-us/dotnet/core/project-sdk/overview#default-includes-and-excludes) such as \\\\*.core.cs, to \", \"include different sets of files based on which framework is being targeted.\\n\\nTypically you only foll\", \"ow these recommendations for class libraries. These techniques allow a single common codebase to be \", \"maintained while new functionality is added and features of the app are incrementally ported to use \", \".NET Core.\\n\\n#### <span id=\\\"page-49-1\\\"></span>**Summary**\\n\\nFrequently, large ASP.NET MVC and Web API \", \"apps won't be ported to ASP.NET Core all at once, but will migrate incrementally over time. This sec\", \"tion offers several strategies for performing this incremental migration. Choose the one(s) that wil\", \"l work best for your organization and app.\\n\\n#### <span id=\\\"page-49-2\\\"></span>**References**\\n\\n- [.NET\", \" Microservices: Architecture for Containerized .NET Applications](https://aka.ms/microservicesebook)\", \"\\n- [eShopOnContainers Reference Microservices Application](https://github.com/dotnet-architecture/eS\", \"hopOnContainers)\\n- [Host ASP.NET Core on Windows with IIS](https://docs.microsoft.com/aspnet/core/ho\", \"st-and-deploy/iis/)\\n- [Strangler pattern](https://docs.microsoft.com/azure/architecture/patterns/str\", \"angler)\\n- [Incremental ASP.NET to ASP.NET Core Migration](https://devblogs.microsoft.com/dotnet/incr\", \"emental-asp-net-to-asp-net-core-migration/)\\n\\n# <span id=\\\"page-50-0\\\"></span>Example migration of eSho\", \"p to ASP.NET Core\\n\\nIn this chapter, you'll see how to migrate a .NET Framework app to .NET Core. The\", \" chapter examines a sample online store app written for ASP.NET MVC 5. The app will use many of the \", \"concepts and tools described earlier in this book. You'll find the starting point app in the *[eShop\", \"Modernizing](https://github.com/dotnet-architecture/eShopModernizing)* GitHub [repository.](https://\", \"github.com/dotnet-architecture/eShopModernizing) There are several different starting point apps. Th\", \"is chapter focuses on the *eShopLegacyMVCSolution*.\\n\\nThe initial version of the project is shown in \", \"Figure 4-1. It's a fairly standard ASP.NET MVC 5 app.\\n\\n![](_page_50_Figure_5.jpeg)\\n\\n*Figure 4-1. The\", \" eShopModernizing MVC sample project structure.*\\n\\nThis chapter demonstrates how to perform many of t\", \"he upgrade steps by hand. Alternatively, you can use the [.NET Upgrade Assistant tool](https://aka.m\", \"s/dotnet-upgrade-assistant) to perform many of the initial steps, like converting the project file, \", \"changing the target framework, and updating NuGet packages.\\n\\n# <span id=\\\"page-51-0\\\"></span>Run *ApiP\", \"ort* to identify problematic APIs\\n\\nThe first step in preparing to migrate is to run the *ApiPort* to\", \"ol. The tool identifies how many .NET Framework APIs the app calls and how many of these have .NET S\", \"tandard or .NET Core equivalents. Focus primarily on your own app's logic, not third-party dependenc\", \"ies, and pay attention to System.Web dependencies that will need to be ported. The ApiPort tool was \", \"introduced in the last chapter on [understanding and updating dependencies.](#page-45-2) Note that c\", \"urrently it requires Visual Studio 2019; Visual Studio 2022 support is planned.\\n\\nAfter [installing a\", \"nd configuring the](https://docs.microsoft.com/en-us/dotnet/standard/analyzers/portability-analyzer)\", \" *ApiPort* tool, run the analysis from within Visual Studio, as shown in Figure 4-2.\\n\\n![](_page_52_P\", \"icture_0.jpeg)\\n\\n*Figure 4-2. Analyze assembly portability in Visual Studio.*\\n\\nChoose the web project\", \"'s assembly from the project's *bin* folder, as shown in Figure 4-3.\\n\\n![](_page_53_Picture_0.jpeg)\\n\\n\", \"*Figure 4-3. Choose the project's web assembly.*\\n\\nIf your solution includes several projects, you ca\", \"n choose all of them. The *eShop* sample includes just a single MVC project.\\n\\nOnce the report is gen\", \"erated, open the file and review the results. The summary provides a high-level view of what percent\", \"age of .NET Framework calls your app is making have compatible versions. Figure 4-4 shows the summar\", \"y for the *eShop* MVC project.\\n\\n![](_page_53_Picture_4.jpeg)\\n\\n*Figure 4-4. ApiPort summary.*\\n\\nFor th\", \"is app, about 80 percent of the .NET Framework calls are compatible. 20 percent of the calls need to\", \" be addressed during the porting process. Viewing the details reveals that all of the incompatible c\", \"alls are part of System.Web, which is an expected incompatibility. The dependencies on System.Web ca\", \"lls will be addressed when the app's controllers and related classes are migrated in a later step. F\", \"igure 4-5 lists some of the specific types found by the tool:\\n\\n| Target type                        \", \"   | \\u25bc Target member                               | Assembly Name  |\\n|-----------------------------\", \"----------|-----------------------------------------------|----------------|\\n| T:System.Web.Mvc.UrlP\", \"arameter         | T:System.Web.Mvc.UrlParameter                 | eShopLegacyMVC |\\n| T:System.Web.M\", \"vc.UrlParameter         | F:System.Web.Mvc.UrlParameter.Optional        | eShopLegacyMVC |\\n| T:Syste\", \"m.Web.HttpApplication          | T:System.Web.HttpApplication                  | eShopLegacyMVC |\\n| \", \"T:System.Web.HttpApplication          | M:System.Web.HttpApplication.#ctor            | eShopLegacyM\", \"VC |\\n| T:System.Web.Mvc.HttpNotFoundResult   | T:System.Web.Mvc.HttpNotFoundResult           | eShop\", \"LegacyMVC |\\n| T:System.Web.Mvc.Controller           | T:System.Web.Mvc.Controller                   \", \"| eShopLegacyMVC |\\n| T:System.Web.Mvc.Controller           | M:System.Web.Mvc.Controller.#ctor      \", \"       | eShopLegacyMVC |\\n| T:System.Web.Mvc.Controller           | M:System.Web.Mvc.Controller.Disp\", \"ose(System.E  |                |\\n| T:System.Web.Mvc.Controller           | M:System.Web.Mvc.Controll\", \"er.File(System.Byte) | 1 0 /          |\\n| T:System.Web.Mvc.Controller           | M:System.Web.Mvc.C\", \"ontroller.get ModelState    | eShopLegacyMVC |\\n| T:System.Web.Mvc.Controller           | M:System.We\", \"b.Mvc.Controller.get Request       | eShopLegacyMVC |\\n| T:System.Web.Mvc.Controller           | M:Sy\", \"stem.Web.Mvc.Controller.get Server        | eShopLegacyMVC |\\n| T:System.Web.Mvc.Controller          \", \" | M:System.Web.Mvc.Controller.get Url           | eShopLegacyMVC |\\n| T:System.Web.Mvc.Controller   \", \"        | M:System.Web.Mvc.Controller.HttpNotFound      | eShopLegacyMVC |\\n| T:System.Web.Mvc.Contro\", \"ller           | M:System.Web.Mvc.Controller.RedirectToAction  |                |\\n| T:System.Web.Mvc\", \".Controller           | M:System.Web.Mvc.Controller.View(System.Obj   |                |\\n| T:System.\", \"Web.Mvc.ActionNameAttribute  | T:System.Web.Mvc.ActionNameAttribute          | eShopLegacyMVC |\\n| T:\", \"System.Web.Mvc.ActionNameAttribute  | M:System.Web.Mvc.ActionNameAttribute.#ctor(   | 1 0 /         \", \" |\\n| T:System.Web.HttpContext              | T:System.Web.HttpContext                      | eShopLe\", \"gacyMVC |\\n| T:System.Web.HttpContext              | M:System.Web.HttpContext.get Current          | \", \"eShopLegacyMVC |\\n| T:System.Web.HttpContext              | M:System.Web.HttpContext.get Request     \", \"     | eShopLegacyMVC |\\n| T:System.Web.HttpContext              | M:System.Web.HttpContext.get Sessi\", \"on          | eShopLegacyMVC |\\n| T:System.Web.Mvc.HandleErrorAttribute | T:System.Web.Mvc.HandleErro\", \"rAttribute         | eShopLegacyMVC |\\n| T:System.Web.Mvc.HandleErrorAttribute | M:System.Web.Mvc.Han\", \"dleErrorAttribute.#ctor   | eShopLegacyMVC |\\n| T:System.Web.Mvc.HttpGetAttribute     | T:System.Web.\", \"Mvc.HttpGetAttribute             | eShopLegacyMVC |\\n| T:System.Web.Mvc.HttpGetAttribute     | M:Syst\", \"em.Web.Myc.HttpGetAttribute.#ctor       | eShopLegacyMVC |\\n\\n*Figure 4-5. ApiPort incompatible type d\", \"etails.*\\n\\nMost of the incompatible types refer to Controller and various related attributes that hav\", \"e equivalents in ASP.NET Core.\\n\\n# <span id=\\\"page-54-0\\\"></span>Update project files and NuGet referen\", \"ce syntax\\n\\nNext, migrate from the older *.csproj* file structure to the newer, simpler structure int\", \"roduced with .NET Core. In doing so, you'll also migrate from using a *packages.config* file for NuG\", \"et references to using <PackageReference> elements in the project file. Old-style project files may \", \"also use <PackageReference> elements, so it usually makes sense to migrate all NuGet package referen\", \"ces to this format first, before upgrading to the new project file format.\\n\\nThe original project's *\", \"eShopLegacyMVC.csproj* file is 418 lines long. A sample of the project file is shown in Figure 4-6. \", \"To offer a sense of its overall size and complexity, the right side of the image contains a miniatur\", \"e view of the entire file.\\n\\n*Figure 4-6. The eShopLegacyMVC.csproj file structure.*\\n\\nA common way to\", \" create a new project file for an existing ASP.NET project is to create a new ASP.NET Core app using\", \" dotnet new or **File** > **New** > **Project** in Visual Studio. Then files can be copied from the \", \"old project to the new one to complete the migration.\\n\\nIn addition to the C# project file, NuGet dep\", \"endencies are stored in a separate 45-line *packages.config* file, as shown in Figure 4-7.\\n\\n*Figure \", \"4-7. The packages.config file.*\\n\\nYou can migrate *packages.config* in class library projects using V\", \"isual Studio. This functionality doesn't work with ASP.NET projects, however. [Learn more about migr\", \"ating](https://docs.microsoft.com/nuget/consume-packages/migrate-packages-config-to-package-referenc\", \"e) *packages.config* to [<PackageReference>](https://docs.microsoft.com/nuget/consume-packages/migra\", \"te-packages-config-to-package-reference) in Visual Studio. If you have a large number of projects to\", \" migrate, [this](https://github.com/MarkKharitonov/NuGetPCToPRMigrator)  [community tool may help](h\", \"ttps://github.com/MarkKharitonov/NuGetPCToPRMigrator). If you're using a tool to migrate the project\", \" file to the new format, you should do that after you've finished migrating all NuGet references to \", \"use <PackageReference>.\\n\\n# <span id=\\\"page-56-0\\\"></span>Create new ASP.NET Core project\\n\\nAdd a new AS\", \"P.NET Core project to the existing app's solution to make moving files easier, as most of the work c\", \"an be done from within Visual Studio's **Solution Explorer**. In Visual Studio, right-click on your \", \"app's solution and choose **Add New Project**. Choose **ASP.NET Core web application**, and give the\", \" new project a name as shown in Figure 4-8.\\n\\n![](_page_57_Picture_0.jpeg)\\n\\n*Figure 4-8. Add new ASP.\", \"NET Core web application.*\\n\\nThe next dialog will ask you to choose which template to use. Select the\", \" **Empty** template. Be sure to also change the dropdown from **.NET Core** to **.NET Framework**. S\", \"elect **ASP.NET Core 2.2**, as shown in Figure 4-9.\\n\\n![](_page_58_Figure_0.jpeg)\\n\\n*Figure 4-9. Choos\", \"e an Empty project template targeting .NET Framework with ASP.NET Core 2.2.*\\n\\n#### <span id=\\\"page-58\", \"-0\\\"></span>**Migrating NuGet Packages**\\n\\nSince the built-in migration tool for migrating *packages.c\", \"onfig* to <PackageReference> doesn't work on ASP.NET projects, you can use a community tool instead,\", \" or migrate by hand. A [community tool](https://gist.github.com/tomkuijsten/2d75074d9a3c19c04ee8ea19\", \"a6289ddf)  [I've used](https://gist.github.com/tomkuijsten/2d75074d9a3c19c04ee8ea19a6289ddf) uses an\", \" XSL file to transform from one format to the other. To use it, first copy the *packages.config* fil\", \"e to the newly created ASP.NET Core project folder. Make a backup of your files, as this script remo\", \"ves the *packages.config* file from all folders under where you run the script. Then run these comma\", \"nds from the project folder (or for the entire solution if you prefer):\\n\\n#### iwr\\n\\nhttps://gist.gith\", \"ubusercontent.com/aienabled/0bce5e4b17118122f2772e7c9218bf9c/raw/7789 53f89882877a7124894b47dccfb1ba\", \"3e80a0/Convert-ToPackageReference.ps1 -OutFile Convert-ToPackageReference.ps1\\n\\n#### iwr\\n\\nhttps://gis\", \"t.githubusercontent.com/aienabled/0bce5e4b17118122f2772e7c9218bf9c/raw/7789 53f89882877a7124894b47dc\", \"cfb1ba3e80a0/Convert-ToPackageReference.xsl -OutFile Convert-ToPackageReference.xsl\\n\\n./Convert-ToPac\", \"kageReference.ps1 | Out-Null\\n\\nThe first two commands download files so that they exist locally. The \", \"last line runs the script. After running it, try to build the new project. You'll most likely get so\", \"me errors. To resolve them, you'll want to eliminate some references (like most of the Microsoft.Asp\", \"Net and System packages), and you may need to remove some xmlns attributes.\\n\\nIn most ASP.NET MVC app\", \"s, many client-side dependencies like Bootstrap and jQuery were deployed using NuGet packages. In AS\", \"P.NET Core, NuGet packages are only used for server-side functionality. Client files should be manag\", \"ed through other means. Review the list of <PackageReference> elements added and remove and make not\", \"e of any that are for client libraries, including:\\n\\n- Bootstrap\\n- jQuery\\n- jQuery.Validation\\n- Moder\", \"nizr\\n- popper.js\\n- Respond\\n\\nThe static client files installed by NuGet for these packages will be co\", \"pied over to the new project's *wwwroot* folder and hosted from there. It's worth considering whethe\", \"r these files are still needed by the app, and whether it makes sense to continue hosting them or to\", \" use a content delivery network (CDN) instead. These library versions can be managed at build time u\", \"sing tools like [LibMan](https://docs.microsoft.com/aspnet/core/client-side/libman/) or [npm.](https\", \"://www.npmjs.com/)  Figure 4-10 shows the full *eShopPorted.csproj* file after migrating package ref\", \"erences using the conversion tool shown and removing unnecessary packages.\\n\\n*Figure 4-10. Package re\", \"ferences in the eShopPorted.csproj file.*\\n\\nThe package references can be further compacted by making\", \" the <Version>1.0.0.0</Version> element a Version=1.0.0.0 attribute on <PackageReference>.\\n\\n#### <sp\", \"an id=\\\"page-60-0\\\"></span>**Migrate static files**\\n\\nAny static files the app uses, including third-pa\", \"rty scripts and frameworks but also custom images and stylesheets, must be copied from the old proje\", \"ct to the new one. In ASP.NET MVC apps, files were typically accessed based on their location within\", \" the project folder. In ASP.NET Core apps, these static files will be accessed based on their locati\", \"on within the *wwwroot* folder. For the *eShop* project, there are static files in the following fol\", \"ders:\\n\\n- *Content*\\n- *fonts*\\n- *Images*\\n- *Pics*\\n- *Scripts*\\n\\nThe **Empty** project template used in\", \" the previous step doesn't include this folder by default, or the middleware needed for it to work. \", \"You'll need to add them.\\n\\nAdd a *wwwroot* folder to the root of the project.\\n\\nAdd version 2.2.0 of t\", \"he Microsoft.AspNetCore.StaticFiles NuGet package.\\n\\nIn *Startup.cs*, add a call to app.UseStaticFile\", \"s() in the Configure method:\\n\\n```\\npublic void Configure(IApplicationBuilder app, IHostingEnvironment\", \" env)\\n{\\n if (env.IsDevelopment())\\n {\\n app.UseDeveloperExceptionPage();\\n }\\n app.UseStaticFiles();\\n //\", \" ...\\n}\\n```\\n\\nCopy the *Content* folder from the ASP.NET MVC app to the new project's *wwwroot* folder\", \".\\n\\nRun the app and navigate to its */Content/base.css* folder to verify that the static file is serv\", \"ed correctly from its expected path. Continue copying the rest of the folders containing static file\", \"s to the new project. You'll also want to copy the *favicon.ico* file from the project's root to the\", \" *wwwroot* folder. Figure 4-11 shows the results after these files and their folders have all been c\", \"opied.\\n\\n![](_page_61_Figure_0.jpeg)\\n\\n*Figure 4-11. Static folders copied over to wwwroot folder.*\\n\\n#\", \"### <span id=\\\"page-61-0\\\"></span>**Migrate C# files**\\n\\nNext, copy over the C# files used by the app, \", \"including standard MVC folders and their contents like *Controllers*, *Models*, *ViewModel*, and *Se\", \"rvices*. There will most likely be some changes needed in these files. It's best to copy one folder \", \"(or subfolder) at a time and compile to see what errors need to be addressed as you go.\\n\\nFor the *eS\", \"hop* sample, the first folder I choose to migrate is the *Models* folder, which includes C# entities\", \" and Entity Framework classes. This folder's classes are used by most of the others, so they won't w\", \"ork until these classes have been copied. After copying the folder and building, the compiler reveal\", \"ed errors related to missing namespace System.Web.Hosting, related access to HostingEnvironment, and\", \" a reference to ConfigurationManager.AppSettings. The solution to these issues will be to pass in th\", \"e necessary path data; for now the breaking lines are commented out and a TODO: comment is added to \", \"each one to track it. After changing five lines, the **Task List** shows five items and the project \", \"builds.\\n\\nNext, the *ViewModel* folder, with its one class, is copied over. It's an easy one, and bui\", \"lds immediately.\\n\\nThe *Services* folder is copied over. This folder's classes depend on Entity Frame\", \"work classes from the *Models* folder, which is why it needed to be copied after that folder. Fortun\", \"ately, it too builds without errors.\\n\\nThat leaves the *Controllers* folder and its two Controller cl\", \"asses. After copying the folder to the new project and building, there are seven build errors. Four \", \"of them are related to ViewBag access and report an error of:\\n\\nMissing compiler required member 'Mic\", \"rosoft.CSharp.RuntimeBinder.CSharpArgumentInfo.Create'\\n\\nTo resolve this error, add a NuGet package r\", \"eference to C#:\\n\\n```\\n<PackageReference Include=\\\"Microsoft.CSharp\\\" Version=\\\"4.7.0\\\" />\\n```\\n\\nThe remain\", \"ing three errors specify types that are defined in an assembly that isn't referenced. Specifically t\", \"hese types:\\n\\n- HttpServerUtilityBase\\n- RouteValueDictionary\\n- HttpRequestBase\\n\\nLet's look at each er\", \"ror one by one. The first error occurs while trying to reference the Server property of Controller, \", \"which no longer exists. The goal of the operation is to get the path to an image file in the app:\\n\\n`\", \"``\\nif (item != null)\\n{\\n var webRoot = Server.MapPath(\\\"~/Pics\\\"); // compiler error on this line\\n var \", \"path = Path.Combine(webRoot, item.PictureFileName);\\n string imageFileExtension = Path.GetExtension(i\", \"tem.PictureFileName);\\n string mimetype = GetImageMimeTypeFromImageFileExtension(imageFileExtension);\", \"\\n var buffer = System.IO.File.ReadAllBytes(path);\\n return File(buffer, mimetype);\\n}\\n```\\n\\nThere are t\", \"wo possible solutions to this problem. The first is to keep the functionality as it is. In this case\", \", rather than using Server.MapPath, a fixed path referencing the image files' location in *wwwroot* \", \"should be used. Alternately, since the only purpose of this action method is to return a static imag\", \"e file, the references to this action in view files can be updated to reference the static files dir\", \"ectly, which improves runtime performance. Since no processing is being done as part of this action,\", \" there's no reason not to just serve the files directly. If it's not tenable to update all reference\", \"s to this action, the action could be rewritten to produce a redirect to the static file's location.\", \"\\n\\nThe next two errors both occur in the same private method in the same line of code:\\n\\n```\\nprivate v\", \"oid AddUriPlaceHolder(CatalogItem item)\\n{\\n item.PictureUri = this.Url.RouteUrl(PicController.GetPicR\", \"outeName, new { catalogItemId \\n= item.Id }, this.Request.Url.Scheme);\\n}\\n```\\n\\nBoth this.Url and this.\", \"Request cause compiler errors. Looking at how this code is used, its purpose is to build a link to t\", \"he PicController action that renders image files. The same one we just discovered could probably be \", \"replaced with direct links to the static files located in *wwwroot*. For now, it's worth commenting \", \"out this code and adding a TODO: comment to reference the pics another way.\\n\\nIt's worth noting that \", \"the base Controller class, used by the CatalogController class in which this code appears, is still \", \"referring to System.Web.Mvc.Controller. There will undoubtedly be more errors to fix once we update \", \"this to use ASP.NET Core. First, remove the using System.Web.Mvc; line from the list of using statem\", \"ents in CatalogController. Next, add the NuGet package Microsoft.AspNetCore.Mvc. Finally, add a usin\", \"g Microsoft.AspNetCore.Mvc; statement, and build the app again.\\n\\nThis time, there are 16 errors:\\n\\n- \", \"Include is not a valid named attribute argument (2)\\n- HttpStatusCodeResult not found (3)\\n- HttpNotFo\", \"und does not exist (3)\\n- SelectList not found (8)\\n\\nOnce more, let's review these errors one by one. \", \"First, SelectList can be fixed by adding using Microsoft.AspNetCore.Mvc.Rendering;, which eliminates\", \" half of the errors.\\n\\nAll references to return HttpNotFound(); should be replaced with return NotFou\", \"nd();.\\n\\nAll references to return new HttpStatusCodeResult(HttpStatusCode.BadRequest); should be repl\", \"aced with return BadRequest();.\\n\\nThat just leaves the use of Include with a [Bind] attribute on a co\", \"uple of action methods that look like this:\\n\\n```\\n[HttpPost]\\n[ValidateAntiForgeryToken]\\npublic Action\", \"Result Create([Bind(Include =\\n\\\"Id,Name,Description,Price,PictureFileName,CatalogTypeId,CatalogBrandI\", \"d,AvailableStock,Rest\\nockThreshold,MaxStockThreshold,OnReorder\\\")] CatalogItem catalogItem)\\n{\\n```\\n\\nTh\", \"e preceding code restricts model binding to the properties listed in the Include string. In ASP.NET \", \"Core MVC, the [Bind] attribute still exists, but no longer needs the Include = argument. Pass the li\", \"st of properties directly to the [Bind] attribute:\\n\\n```\\n[HttpPost]\\n[ValidateAntiForgeryToken]\\npublic\", \" ActionResult \\nCreate([Bind(\\\"Id,Name,Description,Price,PictureFileName,CatalogTypeId,CatalogBrandId,\", \"Availa\\nbleStock,RestockThreshold,MaxStockThreshold,OnReorder\\\")] CatalogItem catalogItem)\\n{\\n```\\n\\nWith\", \" these changes, the project compiles once more. It's generally a better practice to use separate mod\", \"el types for controller inputs, rather than using model binding directly to your domain model or dat\", \"a model types.\\n\\n# <span id=\\\"page-63-0\\\"></span>Migrate views\\n\\nThe two biggest ASP.NET Core MVC featur\", \"es related to views are [Razor Pages](https://docs.microsoft.com/aspnet/core/razor-pages/) and [Tag \", \"Helpers.](https://docs.microsoft.com/aspnet/core/mvc/views/tag-helpers/built-in/) For the initial mi\", \"gration, we won't use either feature. You should, however, keep the features in mind if you continue\", \" supporting the app once it's been migrated. The next step is to copy the *Views* folder from the or\", \"iginal project into the new one. After building, there are nine errors:\\n\\n- HttpContext does not exis\", \"t (2)\\n- Scripts does not exist (5)\\n- Styles does not exist (1)\\n- HtmlString could not be found(1)\\n\\nI\", \"nvestigating these errors finds that most of them are in the main \\\\*\\\\_Layout.cshtml*, with several r\", \"elated to rendering script and style tags, or displaying when the server hosting the app was last re\", \"started. The following code listing shows problem areas in the* \\\\_Layout.cshtml\\\\* file:\\n\\n```\\n// othe\", \"r lines omitted; only errors shown\\n@Styles.Render(\\\"~/Content/css\\\")\\n@Scripts.Render(\\\"~/bundles/modern\", \"izr\\\")\\n@{ var sessionInfo = new HtmlString($\\\"{HttpContext.Current.Session[\\\"MachineName\\\"]}, \\n{HttpCont\", \"ext.Current.Session[\\\"SessionStartTime\\\"]}\\\");}\\n@Scripts.Render(\\\"~/bundles/jquery\\\")\\n@Scripts.Render(\\\"~/\", \"bundles/bootstrap\\\")\\n```\\n\\nThe reference to Modernizr can be removed. The references to Bootstrap and \", \"jQuery can be replaced with CDN links to the appropriate version.\\n\\nReplace @Styles.Render line with:\", \"\\n\\n```\\n<link rel=\\\"stylesheet\\\"\\nhref=\\\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.\", \"min.css\\\"\\nintegrity=\\\"sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\\\"\\ncrossor\", \"igin=\\\"anonymous\\\">\\n```\\n\\nReplace the last two Scripts.Render lines with:\\n\\n```\\n<script src=\\\"https://cod\", \"e.jquery.com/jquery-3.3.1.slim.min.js\\\" integrity=\\\"sha384-\\nq8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXK\", \"p4YfRvH+8abtTE1Pi6jizo\\\"\\ncrossorigin=\\\"anonymous\\\"></script>\\n<script src=\\\"https://cdnjs.cloudflare.com/\", \"ajax/libs/popper.js/1.14.7/umd/popper.min.js\\\"\\nintegrity=\\\"sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1cl\", \"HTMGa3JDZwrnQq4sF86dIHNDz0W1\\\"\\ncrossorigin=\\\"anonymous\\\"></script>\\n<script src=\\\"https://stackpath.boots\", \"trapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js\\\"\\nintegrity=\\\"sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6V\", \"rjIEaFf/nJGzIxFDsf4x0xIM+B07jRM\\\"\\ncrossorigin=\\\"anonymous\\\"></script>\\n```\\n\\nFinally, after the Bootstrap\", \" <link>, add additional <link> elements for local styles your app uses. For *eShop*, the result is s\", \"hown here:\\n\\n```\\n<link rel=\\\"stylesheet\\\" href=\\\"~/Content/custom.css\\\" />\\n<link rel=\\\"stylesheet\\\" href=\\\"~\", \"/Content/base.css\\\" />\\n<link rel=\\\"stylesheet\\\" href=\\\"~/Content/Site.css\\\" />\\n```\\n\\nTo determine the orde\", \"r in which the <link> elements should appear, look at your original app's rendered HTML. Alternative\", \"ly, review *BundleConfig.cs*, which for the *eShop* sample includes this code indicating the appropr\", \"iate sequence:\\n\\n```\\nbundles.Add(new StyleBundle(\\\"~/Content/css\\\").Include(\\n \\\"~/Content/bootstrap.css\\\"\", \",\\n \\\"~/Content/custom.css\\\",\\n```\\n\\n```\\n \\\"~/Content/base.css\\\",\\n \\\"~/Content/site.css\\\"));\\n```\\n\\nBuilding ag\", \"ain reveals one more error loading jQuery Validation on the *Create* and *Edit* views. Replace it wi\", \"th this script:\\n\\n```\\n<script src=\\\"https://cdnjs.cloudflare.com/ajax/libs/jquery-\\nvalidate/1.17.0/jqu\", \"ery.validate.min.js\\\" integrity=\\\"sha512-\\nO/nUTF5mdFkhEoQHFn9N5wmgYyW323JO6v8kr6ltSRKriZyTr/8417taVWea\", \"bVS4iONGk2V444QD0P2cwhuTkg==\\\"\\ncrossorigin=\\\"anonymous\\\"></script>\\n```\\n\\nThe last thing to fix in the vi\", \"ews is the reference to Session to display how long the app has been running, and on which machine. \", \"We can display this data directly in the site's \\\\*\\\\_Layout.cshtml\\\\* by using System.Environment.Mach\", \"ineName and\\n\\nSystem.Diagnostics.Process.GetCurrentProcess().StartTime:\\n\\n```\\n<section class=\\\"col-sm-6\", \"\\\">\\n <img class=\\\"esh-app-footer-text hidden-xs\\\" src=\\\"~/images/main_footer_text.png\\\" \\nwidth=\\\"335\\\" heig\", \"ht=\\\"26\\\" alt=\\\"footer text image\\\" />\\n <br />\\n<small>@Environment.MachineName -\\n@System.Diagnostics.Pro\", \"cess.GetCurrentProcess().StartTime.ToString() UTC</small>\\n</section>\\n```\\n\\nAt this point, the app onc\", \"e more builds successfully. However, trying to run it just yields *Hello World!* because the **Empty\", \"** ASP.NET Core template is only configured to display that in response to any request. In the next \", \"section, I complete the migration by configuring the app to use ASP.NET Core MVC, including dependen\", \"cy injection and configuration. Once that's in place, the app should run. Then it will be time to fi\", \"x the TODO: tasks that were created earlier.\\n\\n# <span id=\\\"page-65-0\\\"></span>Migrate app startup comp\", \"onents\\n\\nThe last migration step is to take the app startup tasks from *Global.asax*, and the classes\", \" it calls, and migrate these to their ASP.NET Core equivalents. These tasks include configuration of\", \" MVC itself, setting up dependency injection, and working with the new configuration system. In ASP.\", \"NET Core, these tasks are handled in the *Startup.cs* file.\\n\\n#### <span id=\\\"page-65-1\\\"></span>**Conf\", \"igure MVC**\\n\\nThe original ASP.NET MVC app has the following code in its Application\\\\_Start in *Globa\", \"l.asax*, which runs when the app starts up:\\n\\n```\\nprotected void Application_Start()\\n{\\n container = R\", \"egisterContainer();\\n AreaRegistration.RegisterAllAreas();\\n FilterConfig.RegisterGlobalFilters(Global\", \"Filters.Filters);\\n RouteConfig.RegisterRoutes(RouteTable.Routes);\\n BundleConfig.RegisterBundles(Bund\", \"leTable.Bundles);\\n ConfigDataBase();\\n}\\n```\\n\\nLooking at these lines one by one, the RegisterContainer\", \" method sets up dependency injection, which will be ported below. The next three lines configure dif\", \"ferent parts of MVC: areas, filters, and routes. Bundles are replaced by static files in the ported \", \"app. The last line sets up data access for the app, which will be shown in a later section.\\n\\nSince t\", \"his app isn't actually using areas, there's nothing that needs to be done to migrate the area regist\", \"ration call. If your app does need to migrate areas, the [docs specify how to configure areas in](ht\", \"tps://docs.microsoft.com/aspnet/core/mvc/controllers/areas)  [ASP.NET Core.](https://docs.microsoft.\", \"com/aspnet/core/mvc/controllers/areas)\\n\\nThe call to register global filters invokes a helper on the \", \"FilterConfig class in the app's *App\\\\_Start* folder:\\n\\n```\\npublic static void RegisterGlobalFilters(G\", \"lobalFilterCollection filters)\\n{\\n filters.Add(new HandleErrorAttribute());\\n}\\n```\\n\\nThe only attribute\", \" added to the app is the ASP.NET MVC filter, HandleErrorAttribute. This filter ensures that when an \", \"exception occurs as part of a request, a default action and view are displayed, rather than the exce\", \"ption details. In ASP.NET Core, this same functionality is performed by the UseExceptionHandler midd\", \"leware. The detailed error messages aren't enabled by default. They must be configured using the Use\", \"DeveloperExceptionPage middleware. To configure this behavior to match the original app, the followi\", \"ng code must be added to the start of the Configure method in *Startup.cs*:\\n\\n```\\npublic void Configu\", \"re(IApplicationBuilder app, IWebHostEnvironment env)\\n{\\n if (env.IsDevelopment())\\n {\\n app.UseDevelope\", \"rExceptionPage();\\n }\\n else\\n {\\n app.UseExceptionHandler(\\\"/Error\\\");\\n }\\n // ...\\n}\\n```\\n\\nThis takes care \", \"of the only filter used by the eShop app, and in this case it was done by using built-in middleware.\", \" If you have global filters that must be configured in your app, this is done when MVC is added in *\", \"Program.cs* when you configure services, which is shown later in this chapter.\\n\\nThe last piece of MV\", \"C-related logic that needs to be migrated are the app's default routes. The call to RouteConfig.Regi\", \"sterRoutes(RouteTable.Routes) passes the MVC route table to the RegisterRoutes helper method, where \", \"the following code is executed when the app starts up:\\n\\n```\\npublic static void RegisterRoutes(RouteC\", \"ollection routes)\\n{\\n routes.MapMvcAttributeRoutes();\\n routes.IgnoreRoute(\\\"{resource}.axd/{*pathInfo}\", \"\\\");\\n routes.MapRoute(\\n name: \\\"Default\\\",\\n url: \\\"{controller}/{action}/{id}\\\",\\n defaults: new { control\", \"ler = \\\"Catalog\\\", action = \\\"Index\\\", id =\\nUrlParameter.Optional }\\n```\\n\\n```\\n );\\n}\\n```\\n\\nTaking this code\", \" line-by-line, the first line sets up support for attribute routes. This is built into ASP.NET Core,\", \" so it's unnecessary to configure it separately. Likewise, *{resource}.axd* files aren't used with A\", \"SP.NET Core, so there's no need to ignore such routes. The MapRoute method configures the default fo\", \"r MVC, which uses the typical {controller}/{action}/{id} route template. It also specifies the defau\", \"lts for this template, such that the CatalogController is the default controller used and the Index \", \"method is the default action. Larger apps will frequently include more calls to MapRoute to set up a\", \"dditional routes.\\n\\nASP.NET Core MVC supports [conventional routing and attribute routing.](https://d\", \"ocs.microsoft.com/aspnet/core/mvc/controllers/routing?preserve-view=true&view=aspnetcore-2.2) Conven\", \"tional routing is analogous to how the route table is configured in the RegisterRoutes method listed\", \" previously. To set up conventional routing with a default route like the one used in the *eShop* ap\", \"p, add the following code to the bottom of the Configure method in *Startup.cs*:\\n\\n```\\napp.UseMvc(rou\", \"tes =>\\n{\\n routes.MapRoute(\\\"default\\\", \\\"{controller=Catalog}/{action=Index}/{id?}\\\");\\n});\\n```\\n\\n#### **N\", \"ote**\\n\\nWith ASP.NET Core 3.0 and later, this is changed to use endpoints. For the initial port to AS\", \"P.NET Core 2.2, this is the proper syntax for mapping conventional routes.\\n\\nWith these changes in pl\", \"ace, the Configure method is almost done. The original template's app.Run method that prints *Hello \", \"World!* should be deleted. At this point, the method is as shown here:\\n\\n```\\npublic void Configure(IA\", \"pplicationBuilder app, IHostingEnvironment env)\\n{\\n if (env.IsDevelopment())\\n {\\n app.UseDeveloperExce\", \"ptionPage();\\n }\\n else\\n {\\n app.UseExceptionHandler(\\\"/Home/Error\\\");\\n }\\n app.UseStaticFiles();\\n app.Use\", \"Mvc(routes =>\\n {\\n routes.MapRoute(\\\"default\\\", \\\"{controller=Catalog}/{action=Index}/{id?}\\\");\\n });\\n}\\n``\", \"`\\n\\nNow it's time to configure MVC services, followed by the rest of the app's support for dependency\", \" injection (DI). So far, the *eShopPorted* project's *Program.cs* file hasn't added any service conf\", \"iguration. Now it's time to start adding necessary services.\\n\\nFirst, to get ASP.NET Core MVC to work\", \" properly, it needs to be added:\\n\\n```\\nbuilder.Services.AddMvc();\\n```\\n\\nThe preceding code is the mini\", \"mal configuration required to get MVC features working. There are many additional features that can \", \"be configured from this call (some of which are detailed later in this chapter), but for now this wi\", \"ll suffice to build the app. Running it now routes the default request properly, but since we've not\", \" yet configured DI, an error occurs while activating CatalogController, because no implementation of\", \" type ICatalogService has been provided yet. We'll return to configure MVC further in a moment. For \", \"now, let's migrate the app's dependency injection.\\n\\n#### **Migrate dependency injection configuratio\", \"n**\\n\\nThe original app's *Global.asax* file defines the following method, called when the app starts \", \"up:\\n\\n```\\nprotected IContainer RegisterContainer()\\n{\\n var builder = new ContainerBuilder();\\n builder.\", \"RegisterControllers(typeof(MvcApplication).Assembly);\\n var mockData = bool.Parse(ConfigurationManage\", \"r.AppSettings[\\\"UseMockData\\\"]);\\n builder.RegisterModule(new ApplicationModule(mockData));\\n var contai\", \"ner = builder.Build();\\n DependencyResolver.SetResolver(new AutofacDependencyResolver(container));\\n r\", \"eturn container;\\n}\\n```\\n\\nThis code configures an [Autofac](https://autofac.org/) container, reads a c\", \"onfig setting to determine whether real or mock data should be used, and passes this setting into an\", \" Autofac module (found in the app's */Modules* directory). Fortunately, Autofac supports .NET Core, \", \"so the module can be migrated directly. Copy the folder into the new project and updates the class's\", \" namespace and it should compile.\\n\\nASP.NET Core has built-in support for dependency injection, but y\", \"ou can wire up a third-party container such as Autofac easily if necessary. In this case, since the \", \"app is already configured to use Autofac, the simplest solution is to maintain its usage. In *Progra\", \"m.cs*, simply configure the builder to use the AutofacServiceProviderFactory as shown:\\n\\n```\\n// using\", \" Autofac.Extensions.DependencyInjection\\nbuilder.Host.UseServiceProviderFactory(new AutofacServicePro\", \"viderFactory());\\n// note: the factory calls builder.Populate so we don't need to here\\nbool useMockDa\", \"ta = true; // TODO: read from config\\nbuilder.Host.ConfigureContainer<ContainerBuilder>(builder =>\\n b\", \"uilder.RegisterModule(new ApplicationModule(useMockData)));\\n```\\n\\nFor now, the setting for useMockDat\", \"a is set to true. This setting will be read from configuration in a moment. At this point, the app c\", \"ompiles and should load successfully when run, as shown in Figure 4- 12.\\n\\n![](_page_69_Figure_0.jpeg\", \")\\n\\n*Figure 4-12. Ported eShop app running locally with mock data.*\\n\\n#### **Migrate app settings**\\n\\nA\", \"SP.NET Core uses a new [configuration system,](https://docs.microsoft.com/aspnet/core/fundamentals/c\", \"onfiguration/?preserve-view=true&view=aspnetcore-2.2) which by default uses an *appsettings.json* fi\", \"le. By using CreateDefaultBuilder in *Program.cs*, the default configuration is already set up in th\", \"e app. To access configuration, classes just need to request it in their constructor. In *Program.cs\", \"*, configuration is accessible from builder.Configuration.\\n\\nThe original app referenced its settings\", \" using ConfigurationManager.AppSettings. A quick search for all references of this term yields the s\", \"et of settings the new app needs. There are only two:\\n\\n- UseMockData\\n- UseCustomizationData\\n\\nIf your\", \" app has more complex configuration, especially if it's using custom configuration sections, you'll \", \"probably want to create and bind objects to different parts of your app's configuration. These types\", \" can then be accessed using the [options pattern.](https://docs.microsoft.com/en-us/dotnet/core/exte\", \"nsions/options) However, as noted in the referenced doc, this pattern shouldn't be used in *Program.\", \"cs* (or Startup.ConfigureServices). Instead the ported app will reference the UseMockData configurat\", \"ion value directly.\\n\\nFirst, modify the ported app's appsettings.json file and add the two settings i\", \"n the root:\\n\\n```\\n{\\n \\\"Logging\\\": {\\n```\\n\\n```\\n \\\"LogLevel\\\": {\\n \\\"Default\\\": \\\"Warning\\\"\\n }\\n },\\n \\\"AllowedHosts\", \"\\\": \\\"*\\\",\\n \\\"UseMockData\\\": \\\"true\\\",\\n \\\"UseCustomizationData\\\" : \\\"true\\\"\\n}\\n```\\n\\nNow, modify *Program.cs* to \", \"access the UseMockData setting from the builder.Configuration property (where previously we set the \", \"value to true):\\n\\n```\\nbool useMockData = builder.Configuration.GetValue<bool>(\\\"UseMockData\\\");\\n```\\n\\nAt\", \" this point, the setting is pulled from configuration. The other setting, UseCustomizationData, is u\", \"sed by the CatalogDBInitializer class. When you first ported this class, you commented out the acces\", \"s to ConfigurationManager.AppSettings[\\\"UseCustomizationData\\\"]. Now it's time to modify it to use ASP\", \".NET Core configuration. Modify the constructor of CatalogDBInitializer as follows:\\n\\n```\\n // add usi\", \"ng Microsoft.Extensions.Configuration\\n public CatalogDBInitializer(CatalogItemHiLoGenerator indexGen\", \"erator,\\n IConfiguration configuration)\\n {\\n this.indexGenerator = indexGenerator;\\n useCustomizationDa\", \"ta = configuration.GetValue<bool>(\\\"UseCustomizationData\\\");\\n }\\n```\\n\\nAll access to configuration withi\", \"n the web app should be modified in this manner to use the new IConfiguration type. Dependencies tha\", \"t require access to .NET Framework configuration can include such settings in an *app.config* file a\", \"dded to the web project. The dependent projects can work with ConfigurationManager to access setting\", \"s, and shouldn't require any changes if they already use this approach. However, since ASP.NET Core \", \"apps run as their own executable, they don't reference *web.config* but rather *app.config*. By migr\", \"ating settings from the legacy app's *web.config* file to a new *app.config* file in the ASP.NET Cor\", \"e app, components that use ConfigurationManager to access their settings will continue to function p\", \"roperly.\\n\\n<span id=\\\"page-70-0\\\"></span>The app's migration is nearly complete. The only remaining tas\", \"k is data access configuration.\\n\\n# Data access considerations\\n\\nASP.NET Core apps running on .NET Fra\", \"mework can continue to use Entity Framework (EF). If performing an incremental migration, getting th\", \"e app working with EF 6 before trying to port its data access to use EF Core may be worthwhile. In t\", \"his way, any problems with the app's migration can be identified and addressed before another block \", \"of migration effort is begun.\\n\\nAs it happens, configuring EF 6 in the eShop sample migration doesn't\", \" require any special work, since this work was performed in the Autofac ApplicationModule. The only \", \"problem is that currently the CatalogDBContext class tries to read its connection string from *web.c\", \"onfig*. To address this, the connection details need to be added to *appsettings.json*. Then the con\", \"nection string must be passed into CatalogDBContext when it's created.\\n\\nUpdate the *appsettings.json\", \"* to include the connection string. The full file is listed here:\\n\\n```\\n{\\n \\\"ConnectionStrings\\\": {\\n \\\"D\", \"efaultConnection\\\":\\n\\\"Server=(localdb)\\\\\\\\mssqllocaldb;Database=eShopPorted;Trusted_Connection=True;Mult\", \"ipleActive\\nResultSets=true\\\"\\n },\\n \\\"Logging\\\": {\\n \\\"LogLevel\\\": {\\n \\\"Default\\\": \\\"Warning\\\"\\n }\\n },\\n \\\"AllowedH\", \"osts\\\": \\\"*\\\",\\n \\\"UseMockData\\\": \\\"false\\\",\\n \\\"UseCustomizationData\\\": \\\"true\\\"\\n}\\n```\\n\\nThe connection string mu\", \"st be passed into the constructor when the DbContext is created. Since the instances are created by \", \"Autofac, the change needs to be made in ApplicationModule. Modify the module to take in a connection\", \"String in its constructor and assign it to a field. Then modify the registration for CatalogDBContex\", \"t to add connection string as a parameter:\\n\\n```\\nbuilder.RegisterType<CatalogDBContext>()\\n .WithParam\", \"eter(\\\"connectionString\\\", _connectionString)\\n .InstancePerLifetimeScope();\\n```\\n\\nThe parameter must al\", \"so be added to a new constructor overload in CatalogDBContext itself:\\n\\n```\\npublic CatalogDBContext(s\", \"tring connectionString) : base(connectionString)\\n{\\n}\\n```\\n\\nFinally, *Program.cs* must read the connec\", \"tion string from Configuration and pass it into the ApplicationModule when it instantiates it:\\n\\n```\\n\", \"bool useMockData = Configuration.GetValue<bool>(\\\"UseMockData\\\");\\nstring connectionString = Configurat\", \"ion.GetConnectionString(\\\"DefaultConnection\\\");\\nbuilder.RegisterModule(new ApplicationModule(useMockDa\", \"ta, connectionString));\\n```\\n\\nWith this code in place, the app runs as it did before, connecting to a\", \" SQL Server database when UseMockData is false.\\n\\nThe app can be deployed and run in production at th\", \"is point, converted to ASP.NET Core but still running on .NET Framework and EF 6. If desired, the ap\", \"p can be migrated to run on .NET Core and Entity Framework Core, which will bring additional advanta\", \"ges described in earlier chapters. Specific to Entity Framework, [this documentation compares EF Cor\", \"e and EF 6](https://docs.microsoft.com/ef/efcore-and-ef6/) and includes a grid showing which library\", \" supports each of dozens of individual features.\\n\\n#### <span id=\\\"page-71-0\\\"></span>**Migrate to Enti\", \"ty Framework Core**\\n\\nAssuming a decision is made to migrate to EF Core, the steps can be fairly stra\", \"ightforward, especially if the original app used a code-based model approach. When [preparing to por\", \"t from EF 6 to EF Core,](https://docs.microsoft.com/ef/efcore-and-ef6/porting/)  review the availabi\", \"lity of features in the destination version of EF Core you'll be using. Review the documentation on \", \"[porting from and EDMX-based model](https://docs.microsoft.com/ef/efcore-and-ef6/porting/port-edmx) \", \"versus [porting from a code-based model.](https://docs.microsoft.com/ef/efcore-and-ef6/porting/port-\", \"code)\\n\\nTo upgrade to EF Core 2.2, the basic steps involved are to add the appropriate NuGet package(\", \"s) and update namespaces. Then adjust how the connection string is passed to the DbContext type and \", \"how they're wired up for dependency injection.\\n\\nEF Core is added as a package reference to the proje\", \"ct:\\n\\n```\\n<PackageReference Include=\\\"Microsoft.EntityFrameworkCore\\\" Version=\\\"2.2.6\\\" />\\n```\\n\\nThe refer\", \"ence to EF 6 is removed:\\n\\n```\\n<PackageReference Include=\\\"EntityFramework\\\" Version=\\\"6.2.0\\\" />\\n```\\n\\nTh\", \"e compiler will report errors in CatalogDBContext and CatalogDBInitializer. CatalogDbContext needs t\", \"o have the old namespaces removed and replaced with Microsoft.EntityFrameworkCore. Its constructors \", \"can be removed. DbModelBuilder should be replaced with ModelBuilder. The helper methods for configur\", \"ing types are moved to separate classes implementing IEntityTypeConfiguration<T>. Then the CatalogDB\", \"Context class's OnModelCreating method simply becomes:\\n\\n```\\nprotected override void OnModelCreating(\", \"ModelBuilder builder)\\n{\\n builder.ApplyConfigurationsFromAssembly(Assembly.GetExecutingAssembly());\\n \", \"base.OnModelCreating(builder);\\n}\\n```\\n\\nOther changes involved include:\\n\\n- HasDatabaseGeneratedOption(\", \"DatabaseGeneratedOption.None) replaced with ValueGeneratedNever()\\n- HasRequired<T> replaced with Has\", \"One<T>\\n- Installed Microsoft.EntityFrameworkCore.Relational package\\n- Add a constructor to CatalogDB\", \"Context taking DbContextOptions and passing it to the base constructor\\n\\nAn example configuration cla\", \"ss for CatalogType is shown here:\\n\\n```\\nusing Microsoft.EntityFrameworkCore;\\nusing Microsoft.EntityFr\", \"ameworkCore.Metadata.Builders;\\nnamespace eShopPorted.Models.Config\\n{\\n public class CatalogTypeConfig\", \" : IEntityTypeConfiguration<CatalogType>\\n {\\n public void Configure(EntityTypeBuilder<CatalogType> bu\", \"ilder)\\n {\\n builder.ToTable(nameof(CatalogType));\\n builder.HasKey(ci => ci.Id);\\n builder.Property(ci \", \"=> ci.Id)\\n .IsRequired();\\n builder.Property(cb => cb.Type)\\n .IsRequired()\\n .HasMaxLength(100);\\n```\\n\\n\", \"```\\n }\\n }\\n}\\n```\\n\\nThe CatalogDBInitializer and its base class, CreateDatabaseIfNotExists<T>, are inco\", \"mpatible with EF Core. The purpose of this class is to create and seed the database. Using EF Core w\", \"ill [create and drop](https://docs.microsoft.com/ef/core/managing-schemas/ensure-created)  [the asso\", \"ciated database for a DbContext](https://docs.microsoft.com/ef/core/managing-schemas/ensure-created)\", \" using these methods:\\n\\n```\\ndbContext.Database.EnsureDeleted();\\ndbContext.Database.EnsureCreated();\\n`\", \"``\\n\\nSeeding data in EF Core can be done with manual scripts, or as part of the type configuration. A\", \"long with other entity properties, seed data can be configured in IEntityTypeConfiguration classes b\", \"y using builder.HasData(). The original app loaded seed data from CSV files in the *Setup* directory\", \". Given that there are only a handful of items, these data records can instead be added as part of t\", \"he entity configuration. This approach works well for lookup data in tables that change infrequently\", \". Adding the following to CatalogTypeConfig's Configure method ensures the associated rows are prese\", \"nt when the database is created:\\n\\n```\\nbuilder.HasData(\\n new CatalogType { Id = 1, Type = \\\"Mug\\\" },\\n n\", \"ew CatalogType { Id = 2, Type = \\\"T-Shirt\\\" },\\n new CatalogType { Id = 3, Type = \\\"Sheet\\\" },\\n new Catal\", \"ogType { Id = 4, Type = \\\"USB Memory Stick\\\" }\\n);\\n```\\n\\nThe initial app includes a PreconfiguredData cl\", \"ass, which includes data for CatalogBrand and CatalogType, so using this method the HasData call red\", \"uces to:\\n\\n```\\nbuilder.HasData(\\n PreconfiguredData.GetPreconfiguredCatalogBrands()\\n);\\n```\\n\\nThe Catalo\", \"gItem data can also be pulled from PreconfiguredData, and assuming the associated images are kept in\", \" source control, that is the last table needed for the app to function. The CatalogDBInitializer cla\", \"ss can be removed, along with any references to it. The CatalogItemHiLoGenerator class and the SQL f\", \"iles in the Infrastructure directory are also removed, along with any references to them (in Catalog\", \"Service, ApplicationModule).\\n\\nWith the elimination of the special key generator classes for CatalogI\", \"tem, this code now is removed from CatalogItemConfig:\\n\\n```\\nbuilder.Property(ci => ci.Id)\\n .ValueGene\", \"ratedNever()\\n .IsRequired();\\n```\\n\\nWith these modifications, the ASP.NET Core app builds, but it does\", \"n't yet work with EF Core, which must still be configured for dependency injection. With EF Core, th\", \"e simplest way to configure it is in *Program.cs*:\\n\\n```\\nbuilder.Services.AddMvc();\\nbool useMockData \", \"= builder.Configuration.GetValue<bool>(\\\"UseMockData\\\");\\nif (!useMockData)\\n{\\n```\\n\\n```\\n string connecti\", \"onString =\\nbuilder.Configuration.GetConnectionString(\\\"DefaultConnection\\\");\\n builder.Services.AddDbCo\", \"ntext<CatalogDBContext>(options =>\\n options.UseSqlServer(connectionString)\\n );\\n}\\n```\\n\\nThe final vers\", \"ion of Autofac's ApplicationModule only configures one type, depending on whether the app is configu\", \"red to use mock data:\\n\\n```\\npublic class ApplicationModule : Module\\n{\\n private bool _useMockData;\\n pu\", \"blic ApplicationModule(bool useMockData)\\n {\\n _useMockData = useMockData;\\n }\\n protected override void\", \" Load(ContainerBuilder builder)\\n {\\n if (_useMockData)\\n {\\n builder.RegisterType<CatalogServiceMock>()\", \"\\n .As<ICatalogService>()\\n .SingleInstance();\\n }\\n else\\n {\\n builder.RegisterType<CatalogService>()\\n .A\", \"s<ICatalogService>()\\n .InstancePerLifetimeScope();\\n }\\n }\\n}\\n```\\n\\nThe ported app runs, but doesn't dis\", \"play any data if configured to use non-mock data. The seed data added through HasData is only insert\", \"ed when migrations are applied. The source app didn't use migrations, and if it had, they wouldn't m\", \"igrate as-is. The best approach is to start with a new migration script. To do this, add a package r\", \"eference for Microsoft.EntityFrameworkCore.Design and open a terminal window in the project root. Th\", \"en run:\\n\\ndotnet ef migrations add Initial\\n\\nDrop the existing *eShopPorted* database if it exists, th\", \"en run:\\n\\ndotnet ef database update\\n\\nThis creates and seeds the database. It's now ready to run, with\", \" a few small updates left to address.\\n\\n# <span id=\\\"page-74-0\\\"></span>Fix all TODO tasks\\n\\nRunning the\", \" ported app at this point reveals that no pictures are shown on the page. This is because the Pictur\", \"eUri property of CatalogItem is never set. Looking at the list of TODO items we created\\n\\nusing Visua\", \"l Studio's **Task List**, the only one that remains is in CatalogController, with a note to \\\"Referen\", \"ce pic from wwwroot.\\\" The code in question is:\\n\\n```\\nprivate void AddUriPlaceHolder(CatalogItem item)\", \"\\n{\\n //TODO: Reference pic from wwwroot\\n //item.PictureUri = this.Url.RouteUrl(PicController.GetPicRo\", \"uteName, new { \\ncatalogItemId = item.Id }, this.Request.Url.Scheme);\\n}\\n```\\n\\nThe simplest fix is to r\", \"eference the public image files in the site's public *wwwroot/Pics* directory. This task can be acco\", \"mplished by replacing the method with the following code:\\n\\n```\\nprivate void AddUriPlaceHolder(Catalo\", \"gItem item)\\n{\\n item.PictureUri = $\\\"/Pics/{item.Id}.png\\\";\\n}\\n```\\n\\nWith this change, running the app re\", \"veals the images work as before.\\n\\n# <span id=\\\"page-75-0\\\"></span>Additional MVC customizations\\n\\nThe *\", \"eShopLegacyMVC* app is fairly simple, so there isn't much to configure in terms of default MVC behav\", \"ior. However, if you do need to configure additional MVC components, such as CORS, filters, and rout\", \"e constraints, you generally provide this information in *Program.cs*, where UseMvc is called. For e\", \"xample, the following code listing configures [CORS](https://docs.microsoft.com/aspnet/core/security\", \"/cors?preserve-view=true&view=aspnetcore-2.2) and sets up a global action filter:\\n\\n```\\nbuilder.Servi\", \"ces.AddCors(options =>\\n{\\n options.AddPolicy(MyAllowSpecificOrigins,\\n builder =>\\n builder.WithOrigins\", \"(\\\"http://example.com\\\", \\\"http://www.contoso.com\\\")\\n .AllowAnyHeader()\\n .AllowAnyMethod());\\n});\\nbuilder\", \".Services.AddMvc(options =>\\n{\\n options.Filters.Add(new SampleGlobalActionFilter());\\n}).SetCompatibil\", \"ityVersion(CompatibilityVersion.Version_2_2);\\n```\\n\\n#### **Note**\\n\\nTo finish configuring CORS, you mu\", \"st also call app.UseCors() after building the application.\\n\\nOther advanced scenarios, like adding [c\", \"ustom model binders,](https://docs.microsoft.com/aspnet/core/mvc/advanced/custom-model-binding?prese\", \"rve-view=true&view=aspnetcore-2.2) formatters, and more are covered in the detailed ASP.NET Core doc\", \"s. Generally these can be applied on an individual controller or action basis, or globally using the\", \" same options approach shown in the previous code listing.\\n\\n# <span id=\\\"page-76-0\\\"></span>Other depe\", \"ndencies\\n\\nDependencies that use .NET Framework features that had a dependency on the legacy configur\", \"ation model, such as the WCF client type and tracing code, must be modified when ported. Rather than\", \" having these types pull in their configuration information directly, they should be configured in c\", \"ode. For example, a connection to a WCF service that was configured in an ASP.NET app's *web.config*\", \" to use basicHttpBinding could instead be configured programmatically with the following code:\\n\\n```\\n\", \"var binding = new BasicHttpBinding();\\nbinding.MaxReceivedMessageSize = 2_000_000;\\nvar endpointAddres\", \"s = new EndpointAddress(\\\"http://localhost:9200/ExampleService\\\");\\nvar myClient = new MyServiceClient(\", \"binding, endpointAddress);\\n```\\n\\nRather than relying on config files for its settings, WCF clients an\", \"d other .NET Framework types should have their settings specified in code. Configured in this manner\", \", these types can continue to work in ASP.NET Core 2.2 apps.\\n\\n# <span id=\\\"page-76-1\\\"></span>Referenc\", \"es\\n\\n- [eShopModernizing GitHub repository](https://github.com/dotnet-architecture/eShopModernizing)\\n\", \"- [.NET Upgrade Assistant tool](https://aka.ms/dotnet-upgrade-assistant)\\n- [Your API and ViewModels \", \"Should Not Reference Domain Models](https://ardalis.com/your-api-and-view-models-should-not-referenc\", \"e-domain-models/)\\n- [Developer Exception Page Middleware](https://docs.microsoft.com/aspnet/core/fun\", \"damentals/error-handling#developer-exception-page)\\n- <span id=\\\"page-76-2\\\"></span>\\u2022 [Deep Dive into E\", \"F Core HasData](https://docs.microsoft.com/archive/msdn-magazine/2018/august/data-points-deep-dive-i\", \"nto-ef-core-hasdata-seeding)\\n\\n# More migration scenarios\\n\\nThis section describes several different A\", \"SP.NET app scenarios, and offers specific techniques for solving each of them. You can use this sect\", \"ion to identify scenarios applicable to your app, and evaluate which techniques will work for your a\", \"pp and its hosting environment.\\n\\n#### <span id=\\\"page-76-3\\\"></span>**Migrate ASP.NET MVC 5 and WebApi\", \" 2 to ASP.NET Core MVC**\\n\\nA common scenario in ASP.NET MVC 5 and Web API 2 apps was for both product\", \"s to be installed in the same application. This is a supported and relatively common approach used b\", \"y many teams, but because the two products use different abstractions, there is some redundant effor\", \"t needed. For example, setting up routes for ASP.NET MVC is done using methods on RouteCollection, s\", \"uch as MapMvcAttributeRoutes() and MapRoute(). But ASP.NET Web API 2 routing is managed with HttpCon\", \"figuration and methods like MapHttpAttributeRoutes() and MapHttpRoute().\\n\\nThe eShopLegacyMVC app inc\", \"ludes both ASP.NET MVC and Web API, and includes methods in its App\\\\_Start folder for setting up rou\", \"tes for both. It also supports dependency injection using Autofac, which also requires two sets of s\", \"imilar work to configure:\\n\\n```\\nprotected IContainer RegisterContainer()\\n{\\n var builder = new Contain\", \"erBuilder();\\n var thisAssembly = Assembly.GetExecutingAssembly();\\n builder.RegisterControllers(thisA\", \"ssembly); // MVC controllers\\n builder.RegisterApiControllers(thisAssembly); // Web API controllers\\n \", \"var mockData = bool.Parse(ConfigurationManager.AppSettings[\\\"UseMockData\\\"]);\\n builder.RegisterModule(\", \"new ApplicationModule(mockData));\\n var container = builder.Build();\\n // set mvc resolver\\n Dependency\", \"Resolver.SetResolver(new AutofacDependencyResolver(container));\\n // set webapi resolver\\n var resolve\", \"r = new AutofacWebApiDependencyResolver(container);\\n GlobalConfiguration.Configuration.DependencyRes\", \"olver = resolver;\\n return container;\\n}\\n```\\n\\nWhen upgrading these apps to use ASP.NET Core, this dupl\", \"icate effort and the confusion that sometimes accompanies it is eliminated. ASP.NET Core MVC is a un\", \"ified framework with one set of rules for routing, filters, and more. Dependency injection is built \", \"into .NET Core itself. All of this can be configured in *Program.cs*, as is shown in the eShopPorted\", \" app in the sample.\\n\\n#### <span id=\\\"page-77-0\\\"></span>**Migrate HttpResponseMessage to ASP.NET Core*\", \"*\\n\\nSome ASP.NET Web API apps may have action methods that return HttpResponseMessage. This type does\", \" not exist in ASP.NET Core. Below is an example of its usage in a Delete action method, using the Re\", \"sponseMessage helper method on the base ApiController:\\n\\n```\\n// DELETE api/<controller>/5\\n[HttpDelete\", \"]\\npublic IHttpActionResult Delete(int id)\\n{\\n var brandToDelete = _service.GetCatalogBrands().FirstOr\", \"Default(x => x.Id == id);\\n if (brandToDelete == null)\\n {\\n return ResponseMessage(new HttpResponseMes\", \"sage(HttpStatusCode.NotFound));\\n }\\n // demo only - don't actually delete\\n return ResponseMessage(new\", \" HttpResponseMessage(HttpStatusCode.OK));\\n}\\n```\\n\\nIn ASP.NET Core MVC, there are helper methods avail\", \"able for all of the common HTTP response status codes, so the above method would be ported to the fo\", \"llowing code:\\n\\n```\\n[HttpDelete(\\\"{id}\\\")]\\npublic IActionResult Delete(int id)\\n{\\n var brandToDelete = _\", \"service.GetCatalogBrands().FirstOrDefault(x => x.Id == id);\\n if (brandToDelete == null)\\n {\\n```\\n\\n```\\n\", \" return NotFound();\\n }\\n // demo only - don't actually delete\\n return Ok();\\n}\\n```\\n\\nIf you do find tha\", \"t you need to return a custom status code for which no helper exists, you can always use return Stat\", \"usCode(int statusCode) to return any numeric code you like.\\n\\n#### <span id=\\\"page-78-0\\\"></span>**Migr\", \"ate content negotiation from ASP.NET Web API to ASP.NET Core**\\n\\nASP.NET Web API 2 supports [content \", \"negotiation](https://docs.microsoft.com/aspnet/web-api/overview/formats-and-model-binding/content-ne\", \"gotiation) natively. The sample app includes a BrandsController that demonstrates this support by li\", \"sting its results in either XML or JSON. This is based on the request's Accept header, and changes w\", \"hen it includes application/xml or application/json.\\n\\nASP.NET MVC 5 apps do not have content negotia\", \"tion support built in.\\n\\nContent negotiation is preferable to returning a specific encoding type, as \", \"it is more flexible and makes the API available to a larger number of clients. If you currently have\", \" action methods that return a specific format, you should consider modifying them to return a result\", \" type that supports content negotiation when you port the code to ASP.NET Core.\\n\\nThe following code \", \"returns data in JSON format regardless of client Accept header content:\\n\\n```\\n[HttpGet]\\npublic Action\", \"Result Index()\\n{\\n return Json(new { Message = \\\"Hello World!\\\" });\\n}\\n```\\n\\n[ASP.NET Core MVC supports c\", \"ontent negotiation natively,](https://docs.microsoft.com/aspnet/core/web-api/advanced/formatting) pr\", \"ovided an appropriate [return type](https://docs.microsoft.com/aspnet/core/web-api/action-return-typ\", \"es) is used. Content negotiation is implemented by [ObjectResult] which is returned by the status co\", \"despecific action results returned by the controller helper methods. The previous action method, imp\", \"lemented in ASP.NET Core MVC and using content negotiation, would be:\\n\\n```\\npublic IActionResult Inde\", \"x()\\n{\\n return Ok(new { Message = \\\"Hello World!\\\"} );\\n}\\n```\\n\\nThis will default to returning the data i\", \"n JSON format. XML and other formats will be used [if the app](https://docs.microsoft.com/aspnet/cor\", \"e/web-api/advanced/formatting)  [has been configured with the appropriate formatter.](https://docs.m\", \"icrosoft.com/aspnet/core/web-api/advanced/formatting)\\n\\n#### <span id=\\\"page-78-1\\\"></span>**Custom mod\", \"el binding**\\n\\nMost ASP.NET MVC and Web API apps make use of model binding. The default model binding\", \" syntax migrates fairly seamlessly between these apps and ASP.NET Core MVC. However, in some cases c\", \"ustomers have written [custom model binders](https://docs.microsoft.com/aspnet/web-api/overview/form\", \"ats-and-model-binding/parameter-binding-in-aspnet-web-api#model-binders) to support specific model t\", \"ypes or usage scenarios. Custom model binders in ASP.NET MVC and Web API projects use separate IMode\", \"lBinder interfaces defined in System.Web.Mvc and System.Web.Http namespaces, respectively. In both c\", \"ases, the custom binder exposes a Bind method that accepts a controller or action context and a mode\", \"l binding context as arguments.\\n\\nOnce the custom binder is created, it must be registered with the a\", \"pp. This step requires creating another type, a ModelBinderProvider, which acts as a factory and cre\", \"ates the model binder during a request. Binders can be added during ApplicationStart in MVC apps as \", \"shown:\\n\\nModelBinderProviders.BinderProviders.Insert(0, **new** MyCustomBinderProvider()); // MVC\\n\\nIn\", \" Web API apps, custom binders can be referenced using attributes. The ModelBinder attribute can be a\", \"dded to action method parameters or to the parameter's type definition, as shown:\\n\\n```\\n// attribute \", \"on action method parameter\\npublic HttpResponseMessage([ModelBinder(typeof(MyCustomBinder))] CustomDT\", \"O custom)\\n{\\n}\\n// attribute on type\\n[ModelBinder(typeof(MyCustomBinder))]\\npublic class CustomDTO\\n{\\n}\\n\", \"```\\n\\nTo register a model binder globally in ASP.NET Web API, its provider must be added during app s\", \"tartup:\\n\\n```\\npublic static class WebApiConfig\\n{\\n public static void Register(HttpConfiguration confi\", \"g)\\n {\\n var provider = new CustomModelBinderProvider(\\n typeof(CustomDTO), new CustomModelBinder());\\n \", \"config.Services.Insert(typeof(ModelBinderProvider), 0, provider);\\n // ...\\n }\\n}\\n```\\n\\nWhen migrating [\", \"custom model providers to ASP.NET Core,](https://docs.microsoft.com/aspnet/core/mvc/advanced/custom-\", \"model-binding#custom-model-binder-sample) the Web API pattern is closer to the ASP.NET Core approach\", \" than the ASP.NET MVC 5. The main differences between ASP.NET Core's IModelBinder interface and Web \", \"API's is that the ASP.NET Core method is async (BindModelAsync) and it only requires a single Bindin\", \"gModelContext parameter instead of two parameters like Web API's version required. In ASP.NET Core, \", \"you can use a [ModelBinder] attribute on individual action method parameters or their associated typ\", \"es. You can also create a ModelBinderProvider that will be used globally within the app where approp\", \"riate. To configure such a provider, you would add code to *Program.cs*:\\n\\n```\\nbuilder.Services.AddCo\", \"ntrollers(options =>\\n{\\n options.ModelBinderProviders.Insert(0, new CustomModelBinderProvider());\\n});\", \"\\n```\\n\\n#### <span id=\\\"page-80-0\\\"></span>**Media formatters**\\n\\nASP.NET Web API supports multiple media\", \" formats and can be extended by using custom media formatters. The docs describe an [example CSV Med\", \"ia Formatter](https://docs.microsoft.com/aspnet/web-api/overview/formats-and-model-binding/media-for\", \"matters#example-creating-a-csv-media-formatter) that can be used to send data in a comma-separated v\", \"alue format. If your Web API app uses custom media formatters, you'll need to convert them to [ASP.N\", \"ET Core custom formatters.](https://docs.microsoft.com/aspnet/core/web-api/advanced/custom-formatter\", \"s)\\n\\nTo create a custom formatter in Web API 2, you inherited from an appropriate base class and then\", \" added the formatter to the Web API pipeline using the HttpConfiguration object:\\n\\n```\\npublic static \", \"void ConfigureApis(HttpConfiguration config)\\n{\\n config.Formatters.Add(new ProductCsvFormatter());\\n}\\n\", \"```\\n\\nIn ASP.NET Core, the process is similar. ASP.NET Core supports both input formatters (used by m\", \"odel binding) and output formatters (used to format responses). Adding a custom formatter to output \", \"responses in a specific way involves inheriting from an appropriate base class and adding the format\", \"ter to MVC in *Program.cs*:\\n\\n```\\nbuilder.Services.AddControllers(options =>\\n{\\n options.InputFormatte\", \"rs.Insert(0, new CustomInputFormatter());\\n options.OutputFormatters.Insert(0, new CustomOutputFormat\", \"ter());\\n});\\n```\\n\\nYou'll find a complete list of base classes in the [Microsoft.AspNetCore.Mvc.Format\", \"ters](https://docs.microsoft.com/dotnet/api/microsoft.aspnetcore.mvc.formatters) namespace.\\n\\nThe ste\", \"ps to migrate from a Web API formatter to an ASP.NET Core MVC formatter are:\\n\\n- 1. Identify an appro\", \"priate base class for the new formatter.\\n- 2. Create a new instance of the base class and implement \", \"its required methods.\\n- 3. Copy over the functionality from the Web API formatter to the new impleme\", \"ntation.\\n- 4. Configure MVC in the ASP.NET Core App's ConfigureServices method to use the new format\", \"ter.\\n\\n#### <span id=\\\"page-80-1\\\"></span>**Custom filters**\\n\\nFilters are used in ASP.NET Core apps to \", \"execute code before and/or after certain stages in the request processing pipeline. ASP.NET MVC and \", \"Web API also use filters in much the same way, but the details vary. For instance, [ASP.NET MVC supp\", \"orts four kinds of filters.](https://docs.microsoft.com/aspnet/mvc/overview/older-versions-1/control\", \"lers-and-routing/understanding-action-filters-cs#the-different-types-of-filters) ASP.NET Web API 2 s\", \"upports similar filters, and both MVC and Web API included attributes to [override filters.](https:/\", \"/docs.microsoft.com/dotnet/api/system.web.mvc.filters.ioverridefilter)\\n\\nThe most common filter used \", \"in ASP.NET MVC and Web API apps is the action filter, which is defined by an [IActionFilter interfac\", \"e.](https://docs.microsoft.com/dotnet/api/system.web.mvc.iactionfilter) This interface provides meth\", \"ods for before (OnActionExecuting) and after (OnActionExecuted) which can be used to execute code be\", \"fore and/or after an action executes, as noted for each method.\\n\\nASP.NET Core continues to support f\", \"ilters, and its unification of MVC and Web API means there is only one approach to their implementat\", \"ion. The [docs include detailed coverage of the five \\\\(5\\\\) kinds of](https://docs.microsoft.com/aspn\", \"et/core/mvc/controllers/filters#filter-types)  [filters built into ASP.NET Core MVC.](https://docs.m\", \"icrosoft.com/aspnet/core/mvc/controllers/filters#filter-types) All of the filter variants supported \", \"in ASP.NET MVC and ASP.NET\\n\\nWeb API have associated versions in ASP.NET Core, so migration is genera\", \"lly just a matter of identifying the appropriate interface and/or base class and migrating the code \", \"over.\\n\\nIn addition to the synchronous interfaces, ASP.NET Core also provides async interfaces like I\", \"AsyncActionFilter which provide a single async method that can be used to incorporate code to run bo\", \"th before and after the action, as shown:\\n\\n```\\npublic class SampleAsyncActionFilter : IAsyncActionFi\", \"lter\\n{\\n public async Task OnActionExecutionAsync(\\n ActionExecutingContext context,\\n ActionExecutionD\", \"elegate next)\\n {\\n // Do something before the action executes.\\n // next() calls the action method.\\n v\", \"ar resultContext = await next();\\n // resultContext.Result is set.\\n // Do something after the action \", \"executes.\\n }\\n}\\n```\\n\\nWhen migrating async code (or code that should be async), teams should consider \", \"leveraging the built in async types that are provided for this purpose.\\n\\nMost ASP.NET MVC and Web AP\", \"I apps do not use a large number of custom filters. Since the approach to filters in ASP.NET Core MV\", \"C is closely aligned with filters in ASP.NET MVC and Web API, the migration of custom filters is gen\", \"erally fairly straightforward. Be sure to read the detailed documentation on filters in ASP.NET Core\", \"'s docs, and once you're sure you have a good understanding of them, port the logic from the old sys\", \"tem to the new system's filters.\\n\\n#### <span id=\\\"page-81-0\\\"></span>**Route constraints**\\n\\nASP.NET Co\", \"re uses route constraints to help ensure requests are routed properly to route a request. [ASP.NET C\", \"ore supports a large number of different route constraints for this purpose.](https://docs.microsoft\", \".com/aspnet/core/fundamentals/routing#route-constraint-reference) Route constraints can be applied i\", \"n the route table, but most apps built with ASP.NET MVC 5 and/or [ASP.NET Web API 2](https://docs.mi\", \"crosoft.com/aspnet/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2#route\", \"-constraints) use inline route constraints applied to attribute routes. Inline route constraints use\", \" a format like this one:\\n\\n```\\n[Route(\\\"/customer/{id:int}\\\")]\\n```\\n\\nThe :int after the id route paramet\", \"er constrains the value to match the int type. One benefit of using route constraints is that they a\", \"llow for two otherwise-identical routes to exist where the parameters differ only by their type. Thi\", \"s allows for the equivalent of [method overloading](https://docs.microsoft.com/en-us/dotnet/standard\", \"/design-guidelines/member-overloading) of routes based solely on parameter type.\\n\\nThe set of route c\", \"onstraints, their syntax, and usage is very similar between all three approaches. Custom route const\", \"raints are fairly rare in customer applications. If your app uses a custom route constraint and need\", \"s to port to ASP.NET Core, the docs include examples showing [how to create](https://docs.microsoft.\", \"com/aspnet/core/fundamentals/routing#custom-route-constraints)  [custom route constraints in ASP.NET\", \" Core](https://docs.microsoft.com/aspnet/core/fundamentals/routing#custom-route-constraints). Essent\", \"ially all that's required is to implement IRouteConstraint and its Match method, and then add the cu\", \"stom constraint when configuring routing for the app:\\n\\n```\\nbuilder.Services.AddControllers();\\nbuilde\", \"r.Services.AddRouting(options =>\\n{\\n options.ConstraintMap.Add(\\\"customName\\\", typeof(MyCustomConstrain\", \"t));\\n});\\n```\\n\\nThis is very similar to how custom constraints are used in ASP.NET Web API, which uses\", \" IHttpRouteConstraint and configures it using a resolver and a call to HttpConfiguration.MapHttpAttr\", \"ibuteRoutes:\\n\\n```\\npublic static class WebApiConfig\\n{\\n public static void Register(HttpConfiguration \", \"config)\\n {\\n var constraintResolver = new DefaultInlineConstraintResolver();\\n constraintResolver.Cons\", \"traintMap.Add(\\\"nonzero\\\", typeof(CustomConstraint));\\n config.MapHttpAttributeRoutes(constraintResolve\", \"r);\\n }\\n}\\n```\\n\\nASP.NET MVC 5 follows a very similar approach, using IRouteConstraint for its interfac\", \"e name and configuring the constraint as part of route configuration:\\n\\n```\\npublic class RouteConfig\\n\", \"{\\n public static void RegisterRoutes(RouteCollection routes)\\n {\\n routes.IgnoreRoute(\\\"{resource}.axd/\", \"{*pathInfo}\\\");\\n var constraintsResolver = new DefaultInlineConstraintResolver();\\n constraintsResolve\", \"r.ConstraintMap.Add(\\\"values\\\", typeof(ValuesConstraint));\\n routes.MapMvcAttributeRoutes(constraintsRe\", \"solver);\\n }\\n}\\n```\\n\\nMigrating route constraint usage as well as custom route constraints to ASP.NET C\", \"ore is typically very straightforward.\\n\\n#### <span id=\\\"page-82-0\\\"></span>**Custom route handlers**\\n\\n\", \"Another fairly advanced feature of ASP.NET MVC 5 is route handlers. Custom route handlers implement \", \"IRouteHandler, which includes a single method that returns an IHttpHandler for a give request. The I\", \"HttpHandler, in turn, exposes an IsReusable property and a single ProcessRequest method. In ASP.NET \", \"MVC 5, you can configure a particular route in the route table to use your custom handler:\\n\\n```\\npubl\", \"ic static void RegisterRoutes(RouteCollection routes)\\n{\\n routes.IgnoreRoute(\\\"{resource}.axd/{*pathIn\", \"fo}\\\");\\n routes.Add(new Route(\\\"custom\\\", new CustomRouteHandler()));\\n}\\n```\\n\\nTo migrate custom route ha\", \"ndlers from ASP.NET MVC 5 to ASP.NET Core, you can either use a filter (such as an action filter) or\", \" a custom [IRouter.](https://docs.microsoft.com/dotnet/api/microsoft.aspnetcore.routing.irouter) The\", \" filter approach is relatively straightforward, and can be added as a global filter when MVC is adde\", \"d to the app's services during startup:\\n\\n```\\nbuilder.Services.AddMvc(options =>\\n{\\n options.Filters.A\", \"dd(typeof(CustomActionFilter));\\n});\\n```\\n\\nThe IRouter option requires implementing the interface's Ro\", \"uteAsync and GetVirtualPath methods. The custom router is added to the request pipeline during app s\", \"tartup.\\n\\n```\\n// ...\\napp.UseMvc(routes =>\\n{\\n routes.Routes.Add(new CustomRouter(routes.DefaultHandler\", \"));\\n});\\n```\\n\\nIn ASP.NET Web API, these handlers are referred to as [custom message handlers,](https:\", \"//docs.microsoft.com/aspnet/web-api/overview/advanced/http-message-handlers#custom-message-handlers)\", \" rather than *route handlers*. Message handlers must derive from DelegatingHandler and override its \", \"SendAsync method. Message handlers can be chained together to form a pipeline in a fashion that is v\", \"ery similar to ASP.NET Core middleware and its request pipeline.\\n\\nASP.NET Core has no DelegatingHand\", \"ler type or separate message handler pipeline. Instead, such handlers should be migrated using globa\", \"l filters, custom IRouter instances (see above), or custom middleware. ASP.NET Core MVC filters and \", \"IRouter types have the advantage of having built-in access to MVC constructs like controllers and ac\", \"tions, while middleware is a lower level approach that has no ties to MVC. This makes it more flexib\", \"le but also requires more effort if you need to access MVC components.\\n\\n#### <span id=\\\"page-83-0\\\"></\", \"span>**CORS support**\\n\\nCORS, or Cross-Origin Resource Sharing, is a W3C standard that allows servers\", \" to accept requests that don't originate from responses they've served. ASP.NET MVC 5 and ASP.NET We\", \"b API 2 support CORS in different ways. The simplest way to enable CORS support in ASP.NET MVC 5 is \", \"with an action filter like this one:\\n\\n```\\npublic class AllowCrossSiteAttribute : ActionFilterAttribu\", \"te\\n{\\n public override void OnActionExecuting(ActionExecutingContext filterContext)\\n {\\n filterContext\", \".RequestContext.HttpContext.Response.AddHeader(\\n \\\"Access-Control-Allow-Origin\\\", \\\"example.com\\\");\\n bas\", \"e.OnActionExecuting(filterContext);\\n }\\n}\\n```\\n\\nASP.NET Web API can also use such a filter, but it has\", \" [built-in support for enabling CORS](https://docs.microsoft.com/aspnet/web-api/overview/security/en\", \"abling-cross-origin-requests-in-web-api#enable-cors) as well:\\n\\n```\\npublic static class WebApiConfig\\n\", \"{\\n public static void Register(HttpConfiguration config)\\n {\\n config.EnableCors();\\n```\\n\\n```\\n // ...\\n \", \"}\\n}\\n```\\n\\nOnce this is added, you can configure allowed origins, headers, and methods using the Enabl\", \"eCors attribute, like so:\\n\\n```\\n[EnableCors(origins: \\\"https://dot.net\\\", headers: \\\"*\\\", methods: \\\"*\\\")]\\n\", \"public class TestController : ApiController\\n{\\n // Controller methods not shown...\\n}\\n```\\n\\nBefore migr\", \"ating your CORS implementation from ASP.NET MVC 5 or ASP.NET Web API 2, be sure to review [how CORS \", \"works](https://docs.microsoft.com/aspnet/web-api/overview/security/enabling-cross-origin-requests-in\", \"-web-api#how-cors-works) and create some automated tests that demonstrate CORS is working as expecte\", \"d in your current system.\\n\\nIn ASP.NET Core, there are three built-in ways to enable CORS:\\n\\n- [Config\", \"ured via policy](https://docs.microsoft.com/aspnet/core/security/cors?#cors-with-named-policy-and-mi\", \"ddleware) in ConfigureServices\\n- Enabled with [endpoint routing](https://docs.microsoft.com/aspnet/c\", \"ore/security/cors?#enable-cors-with-endpoint-routing)\\n- Enabled with the [EnableCors](https://docs.m\", \"icrosoft.com/aspnet/core/security/cors#enable-cors-with-attributes) attribute\\n\\nEach of these approac\", \"hes is covered in detail in the docs, which are linked from the above options. Which one you choose \", \"will largely depend on how your existing app supports CORS. If the app uses attributes, you can prob\", \"ably migrate to use the EnableCors attribute most easily. If your app uses filters, you could contin\", \"ue using that approach (though it's not the typical approach used in ASP.NET Core), or migrate to us\", \"e attributes or policies. Endpoint routing is a relatively new feature introduced with ASP.NET Core \", \"3 and as such it doesn't have a close analog in ASP.NET MVC 5 or ASP.NET Web API 2 apps.\\n\\n#### <span\", \" id=\\\"page-84-0\\\"></span>**Custom areas**\\n\\nMany ASP.NET MVC apps use Areas to organize the project. Ar\", \"eas typically reside in the root of the project in an *Areas* folder, and must be registered when th\", \"e application starts, typically in Application\\\\_Start():\\n\\nAreaRegistration.RegisterAllAreas();\\n\\nAn a\", \"lternative to registering all areas in startup is to use the RouteArea attribute on individual contr\", \"ollers:\\n\\n```\\n[RouteArea(\\\"Admin\\\")]\\npublic class SomeController : Controller\\nWhen using Areas, additio\", \"nal arguments are passed into HTML helper methods to generate \\nlinks to actions in different areas:\\n\", \"@Html.ActionLink(\\\"News\\\", \\\"Index\\\", \\\"News\\\", new { area = \\\"News\\\" }, null)\\n```\\n\\nASP.NET Web API apps don\", \"'t typically use areas explicitly, since their controllers can be placed in any folder in the projec\", \"t. Teams can use any folder structure they like to organize their API controllers.\\n\\n[Areas](https://\", \"docs.microsoft.com/aspnet/core/mvc/controllers/areas) are supported in ASP.NET Core MVC. The approac\", \"h used is nearly identical to the use of areas in ASP.NET MVC 5. Developers migrating code using are\", \"as should keep in mind the following differences:\\n\\n- AreaRegistration.RegisterAllAreas is not used i\", \"n ASP.NET Core MVC\\n- Areas are applied using the [Area(\\\"name\\\")] attribute (not RouteArea as in ASP.N\", \"ET MVC 5)\\n- Areas can be added to the route table templates, if desired (or they can use attribute r\", \"outing)\\n\\nTo add area support to the route table in ASP.NET Core MVC, you would add the following dur\", \"ing app startup:\\n\\n```\\napp.UseEndpoints(endpoints =>\\n{\\n endpoints.MapControllerRoute(\\n name: \\\"MyArea\\\"\", \",\\n pattern: \\\"{area:exists}/{controller=Home}/{action=Index}/{id?}\\\");\\n endpoints.MapControllerRoute(\\n\", \" name: \\\"default\\\",\\n pattern: \\\"{controller=Home}/{action=Index}/{id?}\\\");\\n});\\n```\\n\\nAreas can also be us\", \"ed with attribute routing, using the {area} keyword in the route definition (it's one of several [re\", \"served routing names](https://docs.microsoft.com/aspnet/core/mvc/controllers/routing#reserved-routin\", \"g-names) that can be used with route templates).\\n\\nTag helpers support areas with the asp-area attrib\", \"ute, which can be used to generate links in Razor views and pages:\\n\\n```\\n<ul>\\n <li>\\n <a asp-area=\\\"Pro\", \"ducts\\\" asp-controller=\\\"Home\\\" asp-action=\\\"About\\\">\\n Products/Home/About\\n </a>\\n </li>\\n <li>\\n <a asp-are\", \"a=\\\"Services\\\" asp-controller=\\\"Home\\\" asp-action=\\\"About\\\">\\n Services About\\n </a>\\n </li>\\n <li>\\n <a asp-ar\", \"ea=\\\"\\\" asp-controller=\\\"Home\\\" asp-action=\\\"About\\\">\\n /Home/About\\n </a>\\n </li>\\n</ul>\\n```\\n\\nIf you're migra\", \"ting to Razor Pages you will need to use an *Areas* folder in your *Pages* folder. For more informat\", \"ion, see [Areas with Razor Pages.](https://docs.microsoft.com/aspnet/core/mvc/controllers/areas#area\", \"s-with-razor-pages)\\n\\nIn addition to the above guidance, teams should review [how routing in ASP.NET \", \"Core works with](https://docs.microsoft.com/aspnet/core/mvc/controllers/routing#areas)  [areas](http\", \"s://docs.microsoft.com/aspnet/core/mvc/controllers/routing#areas) as part of their migration plannin\", \"g process.\\n\\n#### <span id=\\\"page-85-0\\\"></span>**Integration tests for ASP.NET MVC and ASP.NET Web API\", \"**\\n\\nIntegration tests are automated tests that verify several different parts of an app work togethe\", \"r correctly. Writing integration tests for ASP.NET MVC and ASP.NET Web API usually involved deployin\", \"g the app to a real web server, such as a local instance of IIS or IIS Express, and then making requ\", \"ests to this hosted application using an HTTP client. Some of these tests may interact with the clie\", \"nt-side user interface using browser automation tools like [Selenium,](https://www.selenium.dev/) th\", \"ough often these are referred to as *UI tests* rather than integration tests.\\n\\nIf your migrated app \", \"shares the same behavior as its original version, whatever existing technology the team is using to \", \"perform integration tests (and UI tests) should continue to work just as it did before. These tests \", \"are usually indifferent to the underlying technology used to host the app they're testing, and inter\", \"act with it only through HTTP requests. Where things may get more challenging is with how the tests \", \"interact with the app to get it into a known good state prior to each test. This may require some mi\", \"gration effort, since configuration and startup are significantly different in ASP.NET Core compared\", \" to ASP.NET MVC or ASP.NET Web API.\\n\\nTeams should strongly consider migrating their integration test\", \"s to use [ASP.NET Core's built](https://docs.microsoft.com/aspnet/core/test/integration-tests)-in [i\", \"ntegration testing](https://docs.microsoft.com/aspnet/core/test/integration-tests) support. In ASP.N\", \"ET Core, apps can be tested by deploying them to a TestHost, which is configured using a WebApplicat\", \"ionFactory. There's a little bit of setup required to host the app for testing, but once this is in \", \"place, creating individual integration tests is very straightforward.\\n\\nOne of the best features of A\", \"SP.NET Core's integration testing support is that the app is hosted in memory. There's no need to co\", \"nfigure a real webserver to host the app. There's no need to use a browser automation tool (if you'r\", \"e only testing ASP.NET Core and not client-side behavior). Many of the problems that can be encounte\", \"red when trying to use a real web server for automated integration tests, such as firewall issues or\", \" process start/stop issues, are eliminated with this approach. Since the requests are all made in me\", \"mory with no network requirement, the tests also tend to run much faster than tests that must set up\", \" a separate webserver and communicate with it over the network (even if it's running on the same mac\", \"hine).\\n\\nBelow you can see an example ASP.NET Core integration test (sometimes referred to as *functi\", \"onal tests* to distinguish them from lower-level integration tests) from the [eShopOnWeb reference](\", \"https://github.com/dotnet-architecture/eShopOnWeb)  [application:](https://github.com/dotnet-archite\", \"cture/eShopOnWeb)\\n\\n```\\npublic class GetByIdEndpoint : IClassFixture<ApiTestFixture>\\n{\\n JsonSerialize\", \"rOptions _jsonOptions = new JsonSerializerOptions {\\nPropertyNameCaseInsensitive = true };\\n public Ge\", \"tByIdEndpoint(ApiTestFixture factory)\\n {\\n Client = factory.CreateClient();\\n }\\n public HttpClient Cli\", \"ent { get; }\\n [Fact]\\n public async Task ReturnsItemGivenValidId()\\n {\\n var response = await Client.Ge\", \"tAsync(\\\"api/catalog-items/5\\\");\\n response.EnsureSuccessStatusCode();\\n var stringResponse = await resp\", \"onse.Content.ReadAsStringAsync();\\n var model = stringResponse.FromJson<GetByIdCatalogItemResponse>()\", \";\\n Assert.Equal(5, model.CatalogItem.Id);\\n Assert.Equal(\\\"Roslyn Red Sheet\\\", model.CatalogItem.Name);\", \"\\n```\\n\\n```\\n }\\n}\\n```\\n\\nIf the app being migrated has no integration tests, the migration process can be\", \" a great opportunity to add some. These tests can verify that the migrated app behaves as the team e\", \"xpects. When such tests are in place early in a migration, they can ensure that later migration effo\", \"rts do not break previously migrated portions of the app. Given how easy it is to set up and run int\", \"egration tests in ASP.NET Core, the return on the investment spent setting up such tests is usually \", \"pretty high.\\n\\n#### <span id=\\\"page-87-0\\\"></span>**WCF client configuration**\\n\\nIf your app currently r\", \"elies on WCF services as a client, this scenario is supported. However, you will need to [migrate yo\", \"ur configuration](https://docs.microsoft.com/aspnet/core/migration/configuration) from *web.config* \", \"to use the new *appsettings.json* file. Another option is to add any necessary configuration to your\", \" clients programmatically when you create them. For example:\\n\\n```\\nvar wcfClient = new OrderServiceCl\", \"ient(\\n new BasicHttpBinding(BasicHttpSecurityMode.None),\\n new EndpointAddress(\\\"http://localhost:5050\", \"/OrderService.svc\\\"));\\n```\\n\\nIf your organization has extensive services built using WCF that your app\", \" relies on, consider migrating them to use gRPC instead. For more details on gRPC, why you may wish \", \"to migrate, and a detailed migration guide, consult the [gRPC for WCF Developers](https://docs.micro\", \"soft.com/en-us/dotnet/architecture/grpc-for-wcf-developers/) eBook.\\n\\n#### <span id=\\\"page-87-1\\\"></spa\", \"n>**References**\\n\\n- [ASP.NET Web API Content Negotiation](https://docs.microsoft.com/aspnet/web-api/\", \"overview/formats-and-model-binding/content-negotiation)\\n- [Format response data in ASP.NET Core Web \", \"API](https://docs.microsoft.com/aspnet/core/web-api/advanced/formatting)\\n- [Custom Model Binders in \", \"ASP.NET Web API](https://docs.microsoft.com/aspnet/web-api/overview/formats-and-model-binding/parame\", \"ter-binding-in-aspnet-web-api#model-binders)\\n- [Custom Model Binders in ASP.NET Core](https://docs.m\", \"icrosoft.com/aspnet/core/mvc/advanced/custom-model-binding#custom-model-binder-sample)\\n- [Media Form\", \"atters in ASP.NET Web API 2](https://docs.microsoft.com/aspnet/web-api/overview/formats-and-model-bi\", \"nding/media-formatters)\\n- [Custom formatters in ASP.NET Core Web API](https://docs.microsoft.com/asp\", \"net/core/web-api/advanced/custom-formatters)\\n- [Filters in ASP.NET Core](https://docs.microsoft.com/\", \"aspnet/core/mvc/controllers/filters)\\n- [Route constraints in ASP.NET Web API 2](https://docs.microso\", \"ft.com/aspnet/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2#route-cons\", \"traints)\\n- [Route constraints in ASP.NET MVC 5](https://devblogs.microsoft.com/aspnet/attribute-rout\", \"ing-in-asp-net-mvc-5/#route-constraints)\\n- [ASP.NET Core Route Constraint Reference](https://docs.mi\", \"crosoft.com/aspnet/core/fundamentals/routing#route-constraint-reference)\\n- [Custom message handlers \", \"in ASP.NET Web API 2](https://docs.microsoft.com/aspnet/web-api/overview/advanced/http-message-handl\", \"ers#custom-message-handlers)\\n- [Simple CORS control in MVC 5 and Web API 2](https://stackoverflow.co\", \"m/questions/6290053/setting-access-control-allow-origin-in-asp-net-mvc-simplest-possible-method)\\n- [\", \"Enabling Cross-Origin Requests in Web API](https://docs.microsoft.com/aspnet/web-api/overview/securi\", \"ty/enabling-cross-origin-requests-in-web-api#enable-cors)\\n- [Enable Cross-Origin Requests \\\\(CORS\\\\) i\", \"n ASP.NET Core](https://docs.microsoft.com/aspnet/core/security/cors)\\n- [Areas in ASP.NET Core](http\", \"s://docs.microsoft.com/aspnet/core/mvc/controllers/areas)\\n- [Integration tests in ASP.NET Core](http\", \"s://docs.microsoft.com/aspnet/core/test/integration-tests)\\n\\n# <span id=\\\"page-88-0\\\"></span>Deployment\", \" scenarios when migrating to ASP.NET Core\\n\\nExisting ASP.NET MVC and Web API apps run on IIS and Wind\", \"ows. Large apps may require a phased or side-by-side approach when porting to ASP.NET Core. In previ\", \"ous chapters, you learned a number of strategies for migrating large .NET Framework apps to ASP.NET \", \"Core in phases. In this chapter, you will see how different deployment scenarios can be achieved whe\", \"n there is a need to maintain the original app in production while migrating portions of it.\\n\\n# <spa\", \"n id=\\\"page-88-1\\\"></span>Split a large web app\\n\\nConsider the common scenario of a large web app that \", \"currently is hosted on IIS in a single web site. Within the large app, functionality is segmented in\", \"to different routes and/or directories. The app is a mix of MVC views and API endpoints. The MVC rou\", \"tes include many different paths based on functionality and all start from the root of the app using\", \" the standard /{controller}/{action}/{id?} route template. The API endpoints follow a similar patter\", \"n, but are all under an /api root.\\n\\nAssuming the task of porting the app is split such that either t\", \"he MVC functionality or the API functionality is migrated to ASP.NET Core first, how would the origi\", \"nal site continue to function seamlessly with the new ASP.NET Core app running somewhere else? Users\", \" of the system should continue to see the same URLs they did prior to the migration, unless it's abs\", \"olutely necessary to change them.\\n\\nFortunately, IIS is a feature-rich web server, and two features i\", \"t has are [URL Rewrite module](https://docs.microsoft.com/iis/extensions/url-rewrite-module/url-rewr\", \"ite-module-video-walkthrough) and [Application Request Routing.](https://docs.microsoft.com/iis/exte\", \"nsions/planning-for-arr/application-request-routing-version-2-overview) Using these features, IIS ca\", \"n act as a [reverse proxy,](https://docs.microsoft.com/iis/extensions/url-rewrite-module/reverse-pro\", \"xy-with-url-rewrite-v2-and-application-request-routing) routing client requests to the appropriate b\", \"ack-end web app. To configure IIS as a reverse proxy, check the **Enable proxy** checkbox in the App\", \"lication Request Routing feature, then add a URL Rewrite rule like this one:\\n\\n```\\n<rule name=\\\"NetCor\", \"eProxy\\\">\\n <match url=\\\"(.*)>\\\" />\\n <action type=\\\"Rewrite\\\" url=\\\"http://servername/{R:1}\\\" />\\n</rule>\\n```\", \"\\n\\nAs a reverse proxy, IIS can route traffic matching certain patterns to entirely separate apps, pot\", \"entially on different servers.\\n\\nUsing just the URL Rewrite module (perhaps combined with host header\", \"s), IIS can easily support multiple web sites, each potentially running different versions of .NET. \", \"A large web app might be deployed as a collection of individual sites, each responding to different \", \"IP addresses and/or host headers, or as a single web site with one or more sub-applications in it re\", \"sponding to certain URL paths (which doesn't even require URL Rewrite).\\n\\n#### **Important**\\n\\nSubdoma\", \"ins typically refer to the portion of a domain preceding the top two levels. For example, in the dom\", \"ain api.contoso.com, api is a subdomain of the contoso.com domain (which itself is composed of the c\", \"ontoso domain name and the .com top-level domain or TLD). URL paths refer to portion of the URL that\", \" follows the domain name, starting with a /. The URL https://contoso.com/api has a path of /api.\\n\\nTh\", \"ere are pros and cons to using the same or different subdomains (and domains) to host a single app. \", \"Features like cookies and intra-app communication using mechanisms like [CORS](https://docs.microsof\", \"t.com/aspnet/core/security/cors) may require more configuration to work properly in distributed apps\", \". However, apps that use different subdomains can more easily use DNS to route requests to entirely \", \"different network destinations, and so can more easily be deployed to many different servers (virtua\", \"l or otherwise) without the need for IIS to act as a reverse proxy.\\n\\nIn the example described above,\", \" assume the API endpoints are designated as the first part of the app to be ported to ASP.NET Core. \", \"In this case, a new ASP.NET Core app is created and hosted in IIS as a separate web *application* wi\", \"thin the existing ASP.NET MVC web *site*. Since it will be added as a child of the original web site\", \" and will be named *api*, its default route should no longer begin with api/. Keeping this would res\", \"ult in it matching URLs of the form /api/api/endpoint.\\n\\nFigure 5-1 shows how the ASP.NET Core 2.1 *a\", \"pi* app appears in IIS Manager as a part of the existing *DotNetMvcApp* site.\\n\\n![](_page_90_Picture_\", \"0.jpeg)\\n\\n*Figure 5-1. .NET Framework Site with .NET Core app in IIS.*\\n\\nThe *DotNetMvcApp* site is ho\", \"sted as an MVC 5 app running on .NET Framework 4.7.2. It has its own IIS app pool configured in inte\", \"grated mode and running .NET CLR version 4.0.30319. The *api* app is an ASP.NET Core app running on \", \".NET Framework 4.6.1 (net461). It was added to the *DotNetMvcApp* as a new IIS app and configured to\", \" use its own Application Pool. Its Application Pool is also running in integrated mode but is config\", \"ured with a .NET CLR version of **No Managed Code** since it will be executed using the [ASP.NET Cor\", \"e Module.](https://docs.microsoft.com/aspnet/core/host-and-deploy/aspnet-core-module) The version of\", \" the ASP.NET Core app is just an example. It could also be configured to run on NET 5+. Though at th\", \"at point, it would no longer be able to target .NET Framework libraries (see [Choose the Right .NET \", \"Core Version\\\\)](#page-12-1)\\n\\nConfigured in this manner, the only change that must be made in order f\", \"or the ASP.NET Core app's APIs to be routed properly is to change its default route template from [R\", \"oute(\\\"[api/controller]\\\")] to [Route(\\\"[controller]\\\")].\\n\\nAlternately the ASP.NET Core app can be anoth\", \"er top-level web site in IIS. In this case, you can configure the original site to use a rewrite rul\", \"e (with [URL Rewrite\\\\)](https://www.iis.net/downloads/microsoft/url-rewrite) that will redirect to t\", \"he other app if the path starts with /api. The ASP.NET Core app can use a different host header for \", \"its route so that it doesn't conflict with the main app but can still respond to requests using root\", \"-based routes.\\n\\nAs an example, the same ASP.NET Core app used in Figure 5-1 can be deployed to anoth\", \"er folder configured as an IIS web site. The site should use an app pool configured just as before, \", \"with **No** \\n\\n**Managed Code**. Configure its bindings to respond to a unique host name on the serve\", \"r, such as api.contoso.com. To configure URL Rewrite to rewrite requests matching /api just add a ne\", \"w inbound rule at the IIS server (or individual site) level. Match the pattern ^/api(.\\\\*) and specif\", \"y an Action type of Rewrite and a Rewrite URL of api.contoso.com/{R:1}. The combination of using (.\\\\\", \"*) in the matching pattern and {R:1} in the rewrite URL will ensure the rest of the path gets used w\", \"ith the new URL. With this in place, separate sites on the same IIS server can coexist running separ\", \"ate versions of .NET, but they can be made to appear to the Internet as one web app. Figure 5-2 show\", \"s the rewrite rule as configured in IIS with the separate web site.\\n\\n![](_page_91_Picture_1.jpeg)\\n\\n*\", \"Figure 5-2. Rewrite rule to rewrite subfolder requests to another web site.*\\n\\nIf your app requires s\", \"ingle sign-on between different sites or apps within IIS, refer to the documentation on [how to shar\", \"e authentication cookies among ASP.NET apps](https://docs.microsoft.com/aspnet/core/host-and-deploy/\", \"iis/) for detailed instructions on supporting this scenario.\\n\\nAnother alternative to IIS Rewrite rul\", \"es is the use of a reverse proxy like [YARP,](https://microsoft.github.io/reverse-proxy/) which can \", \"facilitate [incremental ASP.NET to ASP.NET Core Migration.](https://devblogs.microsoft.com/dotnet/in\", \"cremental-asp-net-to-asp-net-core-migration/)\\n\\n# <span id=\\\"page-91-0\\\"></span>Summary\\n\\nA common appro\", \"ach to porting large apps from .NET Framework to ASP.NET Core is to choose individual portions of th\", \"e app to migrate one by one. As each piece of the app is ported, the entire app remains running and \", \"usable, with some parts of it running in its original configuration and other parts running on some \", \"version of .NET Core. By following this approach, a large app migration can be performed incremental\", \"ly. This approach results in limiting risk by providing more rapid feedback and\\n\\nreducing total surf\", \"ace area involved in testing. It also allows for more rapid realization of benefits of .NET Core, su\", \"ch as performance increases. Although ASP.NET Core apps are no longer required to be hosted on IIS, \", \"IIS remains a very flexible and powerful web server that can be configured to support a variety of h\", \"osting scenarios involving both .NET Framework and ASP.NET Core apps on the same IIS instance or eve\", \"n hosted on different servers.\\n\\n# <span id=\\\"page-92-0\\\"></span>References\\n\\n- [Host ASP.NET Core on Wi\", \"ndows with IIS](https://docs.microsoft.com/aspnet/core/host-and-deploy/iis/)\\n- [URL Rewrite module a\", \"nd Application Request Routing](https://docs.microsoft.com/iis/extensions/url-rewrite-module/reverse\", \"-proxy-with-url-rewrite-v2-and-application-request-routing)\\n- [URL Rewrite](https://www.iis.net/down\", \"loads/microsoft/url-rewrite)\\n- [ASP.NET Core Module](https://docs.microsoft.com/aspnet/core/host-and\", \"-deploy/aspnet-core-module)\\n- [Share authentication cookies among ASP.NET apps](https://docs.microso\", \"ft.com/aspnet/core/security/cookie-sharing)\\n- [Samples used in this section](https://github.com/arda\", \"lis/MigrateDotNetWithIIS)\\n- [Incremental ASP.NET to ASP.NET Core Migration](https://devblogs.microso\", \"ft.com/dotnet/incremental-asp-net-to-asp-net-core-migration/)\\n\\n# <span id=\\\"page-93-0\\\"></span>Summary\", \": Port existing ASP.NET Apps to .NET 7\\n\\nIn this book, you've been given the resources needed to deci\", \"de whether it makes sense to port your organization's existing ASP.NET apps running on .NET Framewor\", \"k to ASP.NET Core. You've learned about [important considerations](#page-9-1) for choosing when it m\", \"akes sense to migrate to .NET Core, and when it may be appropriate to keep (parts of) your app on .N\", \"ET Framework. There are differences between .NET Core versions and their capabilities and compatibil\", \"ities with .NET Framework, and you learned [how to choose the right version of .NET Core for your ap\", \"p.](#page-12-1)\\n\\nPorting a large app often entails a fair amount of risk and effort. You learned how\", \" to mitigate this risk by employing one or more [incremental migration strategies](#page-13-0) along\", \" with several [deployment strategies](#page-15-4) for keeping partially migrated apps running in pro\", \"duction.\\n\\nThere are many architectural differences between ASP.NET and ASP.NET Core. In chapter 2, y\", \"ou learned about many of these differences and how they relate to your app's migration. This chapter\", \" covered everything from app startup and low-level middleware to high-level controller and Web API d\", \"ifferences and new features enabling much better testing scenarios.\\n\\nLarge apps are often comprised \", \"of many projects and packages, and dependencies can play a major role in determining how easy or dif\", \"ficult migration may be. [Chapter 3](#page-40-0) helped you [identify the](#page-40-2)  [sequence in\", \" which to migrate projects](#page-40-2) and [how to understand and update your app's dependencies](#\", \"page-45-2). It also detailed additional strategies for migrating apps while keeping them running in \", \"production.\\n\\nIn chapter 4, you saw how a real ASP.NET MVC reference app was migrated to ASP.NET Core\", \". This chapter included a detailed breakdown of all the changes that were needed to take the existin\", \"g app and port it over to run on ASP.NET Core. Refer back to it if you have specific questions about\", \" the porting process and some of its more specific details.\\n\\nFinally, chapter 5 detailed specific de\", \"ployment scenarios focused on IIS. You saw how you can use your existing IIS web server to host part\", \"s of your app that have been ported to ASP.NET Core while keeping the app's public URLs consistent. \", \"IIS includes great support for URL rewriting and request routing that enables it to host multiple ve\", \"rsions of your site side by side or even on different servers, with no change to the public-facing U\", \"RLs the app exposes.\"]"