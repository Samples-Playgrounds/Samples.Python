"[\"DOWNLOAD available at: https://aka.ms/maui-ebook\\n\\nEDITION v2.0\\n\\nPUBLISHED BY\\n\\nMicrosoft Developer Di\", \"vision, .NET, and Visual Studio product teams\\n\\nA division of Microsoft Corporation\\n\\nOne Microsoft Wa\", \"y\\n\\nRedmond, Washington 98052-6399\\n\\nCopyright \\u00a9 2022 by Microsoft Corporation\\n\\nAll rights reserved. N\", \"o part of the contents of this book may be reproduced or transmitted in any form or by any means wit\", \"hout the written permission of the publisher.\\n\\nThis book is provided \\u201cas-is\\u201d and expresses the autho\", \"r\\u2019s views and opinions. The views, opinions, and information expressed in this book, including URL a\", \"nd other Internet website references, may change without notice.\\n\\nSome examples depicted herein are \", \"provided for illustration only and are fictitious. No real association or connection is intended or \", \"should be inferred.\\n\\nMicrosoft and the trademarks listed at https://www.microsoft.com on the \\u201cTradem\", \"arks\\u201d webpage are trademarks of the Microsoft group of companies.\\n\\nMac and macOS are trademarks of A\", \"pple Inc.\\n\\nAll other marks and logos are property of their respective owners.\\n\\nAuthors:\\n\\nMichael Sto\", \"nis, Mobile Software Architect, Eight-Bot\\n\\nReviewers:\\n\\nJames Montemagno, Principal Lead Program Mana\", \"ger, Microsoft Corp.\\n\\nDavid Pine, Developer Relations, Microsoft Corp.\\n\\nAcknowledgments\\n\\nThis book o\", \"riginated from the excellent Enterprise Application Patterns using Xamarin.Forms eBook by David Brit\", \"ch and Javier Suarez Ruiz. Without their hard work, detailed information, and excellent examples, th\", \"is book would not be possible.\\n\\nIntroduction\\n\\nEnterprise applications face a number of difficult pro\", \"blems to solve including ever changing business requirements, the need for quick turn around time, s\", \"upport for multiple platforms, and integration with multiple systems. Due to the varying nature of t\", \"hese problems, it\\u2019s important that our application\\u2019s architecture allows it to be modular, modifiabl\", \"e and extensible over time.\\n\\nThis book takes provides real world solutions for addressing these issu\", \"es when building an enterprise application using .NET MAUI. This book uses a pre-built .NET MAUI app\", \"lication that serves as the front-end of an online eCommerce application as a reference and a guide \", \"for common enterprise design patterns. This book covers topics such as the MVVM pattern, dependency \", \"injection, navigation, configuration, the loose-coupling of components and additional enterprise con\", \"cerns. The content of this book is helpful for anyone looking to build a new application for this bu\", \"siness or looking to solve the problems of applications that evolve over time.\\n\\nWho should use the b\", \"ook\\n\\nThis book is for .NET MAUI developers that are already familiar with the framework, but that ar\", \"e looking for guidance on architecture and implementation when building enterprise applications. Thi\", \"s book can help developers solve common problems using tried and true patterns.\\n\\nHow to use the book\", \"\\n\\nThis book focuses on building cross-platform enterprise apps using .NET MAUI. As such, it should b\", \"e read in its entirety to provide a foundation of understanding such apps and their technical consid\", \"erations. The book, along with its sample app, can also serve as a starting point or reference for c\", \"reating a new enterprise app. Use the associated sample app as a template for the new app, or to see\", \" how to organize an app\\u2019s component parts. Then, refer back to this guide for architectural guidance\", \". You can find the sample app on GitHub.\\n\\nWhat this book doesn\\u2019t cover\\n\\nThis book is aimed at reader\", \"s who are already familiar with .NET MAUI. It does cover some concepts of .NET MAUI to help better i\", \"llustrate the topic, but it does not cover most controls and concepts in any detail. For general gui\", \"dance on building a new .NET MAUI app, please refer to the Building your first app guide in the .NET\", \" MAUI documentation.\\n\\nAdditional resources\\n\\nFor official .NET MAUI content, see .NET MAUI docs. .NET\", \" MAUI is developed as an open-source project and is available on GitHub at dotnet/maui. For code sam\", \"ples developed with .NET MAUI, see the dotnet/maui-samples repo.\\n\\nContents\\n\\nPurpose ................\", \"....................................................................................................\", \"................. 1\\n\\nWhat\\u2019s left out of this guide\\u2019s scope .........................................\", \"....................................................................................... 1\\n\\nWho shoul\", \"d use this guide ...................................................................................\", \"............................................................... 1\\n\\nHow to use this guide ...........\", \"....................................................................................................\", \"............................................. 2\\n\\nIntroduction to .NET MAUI .........................\", \"........................................................................... 3\\n\\nSample application ..\", \"....................................................................................................\", \"............................................................ 4\\n\\nSample application architecture ....\", \"....................................................................................................\", \"................................ 5\\n\\nMulti-Platform app .............................................\", \"....................................................................................................\", \"................. 6\\n\\nMulti-Platform app solution ...................................................\", \"............................................................................................. 7\\n\\neSh\", \"op project .........................................................................................\", \"................................................................................... 7\\n\\nSummary .....\", \"....................................................................................................\", \"............................................................................ 8\\n\\nModel-View-ViewModel\", \" (MVVM) ......................................................................................... 9\\n\", \"\\nThe MVVM pattern ..................................................................................\", \"................................................................................ 9\\n\\nView ...........\", \"....................................................................................................\", \"........................................................................ 10\\n\\nViewModel .............\", \"....................................................................................................\", \"......................................................... 11\\n\\nModel ................................\", \"....................................................................................................\", \"................................................ 11\\n\\nConnecting view models to views ...............\", \"....................................................................................................\", \"............... 12\\n\\nCreating a view model declaratively ............................................\", \"................................................................................. 12\\n\\nCreating a vie\", \"w model programmatically ...........................................................................\", \"........................................ 13\\n\\nUpdating views in response to changes in the underlying\", \" view model or model...................................... 13\\n\\nMVVM Frameworks .....................\", \"....................................................................................................\", \"..................................... 15\\n\\nUI interaction using commands and behaviors ..............\", \".......................................................................................... 15\\n\\nImple\", \"menting commands ...................................................................................\", \".............................................................. 16\\n\\nInvoking commands from a view ...\", \"....................................................................................................\", \"............................ 17\\n\\nImplementing behaviors ............................................\", \"....................................................................................................\", \".... 17\\n\\nInvoking behaviors from a view ............................................................\", \".......................................................................... 20\\n\\nSummary .............\", \"....................................................................................................\", \"................................................................. 20\\n\\nDependency injection .........\", \".................................................................................................. 2\", \"1\\n\\ni\\n\\nContents\\n\\nIntroduction to dependency injection ...............................................\", \"........................................................................... 21\\n\\nRegistration .......\", \"....................................................................................................\", \".................................................................. 23\\n\\nResolution ..................\", \"....................................................................................................\", \".......................................................... 25\\n\\nSummary .............................\", \"....................................................................................................\", \"................................................. 26\\n\\nCommunicating between loosely coupled componen\", \"ts ................................................... 27\\n\\nIntroduction to MVVM Toolkit Messenger ..\", \"....................................................................................................\", \"........... 27\\n\\nDefining a message .................................................................\", \"............................................................................................. 29\\n\\nPu\", \"blishing a message .................................................................................\", \"......................................................................... 29\\n\\nSubscribing to a messa\", \"ge..................................................................................................\", \"................................................ 30\\n\\nUnsubscribing from a message ..................\", \"....................................................................................................\", \"................. 30\\n\\nSummary ......................................................................\", \"....................................................................................................\", \"........ 31\\n\\nNavigation ............................................................................\", \".................................................. 32\\n\\nNavigating between pages ....................\", \"....................................................................................................\", \"....................... 33\\n\\nCreating the MauiNavigationService instance ............................\", \".............................................................................. 34\\n\\nHandling navigati\", \"on requests ........................................................................................\", \".................................................. 34\\n\\nNavigating when the app is launched .........\", \"....................................................................................................\", \"............. 36\\n\\nPassing parameters during navigation .............................................\", \"............................................................................ 36\\n\\nInvoking navigation\", \" using behaviors ...................................................................................\", \"......................................... 37\\n\\nConfirming or cancelling navigation ..................\", \"....................................................................................................\", \"....... 38\\n\\nSummary ................................................................................\", \".................................................................................................. 3\", \"8\\n\\nValidation ......................................................................................\", \"......................................... 39\\n\\nSpecifying validation rules ..........................\", \"....................................................................................................\", \".................. 40\\n\\nAdding validation rules to a property .......................................\", \"................................................................................... 42\\n\\nTriggering v\", \"alidation ..........................................................................................\", \"................................................................. 42\\n\\nTriggering validation manually\", \" ...................................................................................................\", \"................................ 42\\n\\nTriggering validation when properties change ..................\", \".................................................................................. 43\\n\\nDisplaying va\", \"lidation errors ....................................................................................\", \".......................................................... 43\\n\\nHighlighting a control that contains \", \"invalid data .......................................................................................\", \"......... 44\\n\\nDisplaying error messages ............................................................\", \"............................................................................... 45\\n\\nSummary ........\", \"....................................................................................................\", \"...................................................................... 45\\n\\nApplication settings mana\", \"gement ...................................................................................... 46\\n\\nii\", \"\\n\\nContents\\n\\nCreating a Settings Interface ..........................................................\", \".................................................................................. 46\\n\\nAdding Settin\", \"gs .................................................................................................\", \".................................................................... 47\\n\\nData binding to user settin\", \"gs..................................................................................................\", \"......................................... 48\\n\\nSummary ..............................................\", \"....................................................................................................\", \"................................ 49\\n\\nContainerized microservices ...................................\", \"............................................................. 50\\n\\nMicroservices ....................\", \"....................................................................................................\", \".................................................. 51\\n\\nContainerization ............................\", \"....................................................................................................\", \".................................... 53\\n\\nCommunication between client and microservices ............\", \".................................................................................... 56\\n\\nCommunicati\", \"on between microservices ...........................................................................\", \"........................................... 57\\n\\nSummary ............................................\", \"....................................................................................................\", \".................................. 59\\n\\nAccessing remote data .......................................\", \"................................................................... 60\\n\\nIntroduction to Representati\", \"onal State Transfer ................................................................................\", \"...................... 60\\n\\nConsuming RESTful APIs ..................................................\", \".................................................................................................. 6\", \"1\\n\\nMaking web requests .............................................................................\", \"............................................................................. 61\\n\\nMaking a GET reque\", \"st .................................................................................................\", \"........................................................ 61\\n\\nMaking a POST request .................\", \"....................................................................................................\", \"................................. 64\\n\\nMaking a DELETE request ......................................\", \"....................................................................................................\", \"........ 67\\n\\nCaching data ..........................................................................\", \"................................................................................................. 68\", \"\\n\\nManaging data expiration .........................................................................\", \"........................................................................ 69\\n\\nCaching images ........\", \"....................................................................................................\", \"......................................................... 69\\n\\nIncreasing resilience ................\", \"....................................................................................................\", \"......................................... 70\\n\\nRetry pattern ........................................\", \"....................................................................................................\", \"............................... 70\\n\\nCircuit breaker pattern ........................................\", \"....................................................................................................\", \"............ 71\\n\\nSummary ...........................................................................\", \"....................................................................................................\", \"... 72\\n\\nAuthentication and authorization ...........................................................\", \"............................ 73\\n\\nAuthentication ....................................................\", \"....................................................................................................\", \"................ 73\\n\\nIssuing bearer tokens using IdentityServer ....................................\", \"........................................................................ 74\\n\\nAdding IdentityServer t\", \"o a web application ................................................................................\", \".......................... 75\\n\\nConfiguring IdentityServer ..........................................\", \"................................................................................................. 75\", \"\\n\\nConfiguring API resources ........................................................................\", \".................................................................... 76\\n\\nConfiguring identity resour\", \"ces ................................................................................................\", \"................................... 76\\n\\niii\\n\\nContents\\n\\nConfiguring clients .........................\", \"....................................................................................................\", \"............................. 77\\n\\nConfiguring the authentication flow ..............................\", \".......................................................................................... 78\\n\\nPerfo\", \"rming authentication ...............................................................................\", \"............................................................ 79\\n\\nSigning-in ........................\", \"....................................................................................................\", \"................................................ 80\\n\\nSigning-out ...................................\", \"....................................................................................................\", \".................................. 83\\n\\nAuthorization ...............................................\", \"....................................................................................................\", \"....................... 84\\n\\nConfiguring IdentityServer to perform authorization ....................\", \"........................................................................ 85\\n\\nMaking access requests \", \"to APIs ............................................................................................\", \".......................................... 86\\n\\nSummary .............................................\", \"....................................................................................................\", \"................................. 87\\n\\nMVVM Toolkit Features ........................................\", \"................................................................ 88\\n\\nMVVM Toolkit ..................\", \"....................................................................................................\", \".................................................. 88\\n\\nObservableObject ............................\", \"....................................................................................................\", \"................................. 89\\n\\nRelayCommand and AsyncRelayCommand ...........................\", \".................................................................................... 90\\n\\nSource Gene\", \"rators .............................................................................................\", \"................................................................... 91\\n\\nSummary ....................\", \"....................................................................................................\", \".......................................................... 93\\n\\nUnit testing ........................\", \"....................................................................................................\", \" 94\\n\\nDependency injection and unit testing .........................................................\", \"............................................................... 95\\n\\nTesting MVVM applications ......\", \"....................................................................................................\", \".................................... 95\\n\\nTesting asynchronous functionality ........................\", \"....................................................................................................\", \"... 96\\n\\nTesting INotifyPropertyChanged implementations .............................................\", \"................................................... 97\\n\\nTesting message-based communication ........\", \"....................................................................................................\", \"......... 97\\n\\nTesting exception handling ...........................................................\", \"................................................................................... 98\\n\\nTesting vali\", \"dation .............................................................................................\", \"..................................................................... 98\\n\\nSummary ..................\", \"....................................................................................................\", \"............................................................ 99\\n\\niv\\n\\nContents\\n\\nCHAPTER 1\\n\\nPurpose\\n\\nT\", \"his eBook provides guidance on building cross-platform enterprise apps using .NET MAUI. .NET MAUI is\", \" a cross-platform UI toolkit that allows developers to easily create native user interface layouts t\", \"hat can be shared across platforms, including iOS, macOS, Android, and Windows. It provides a compre\", \"hensive solution for Business to Employee (B2E), Business to Business (B2B), and Business to Consume\", \"r (B2C) apps, providing the ability to share code across all target platforms and helping to lower t\", \"he total cost of ownership (TCO).\\n\\nThe guide provides architectural guidance for developing adaptabl\", \"e, maintainable, and testable .NET MAUI enterprise apps. Guidance is provided on how to implement MV\", \"VM, dependency injection, navigation, validation, and configuration management, while maintaining lo\", \"ose coupling. In addition, there\\u2019s also guidance on performing authentication and authorization with\", \" IdentityServer, accessing data from containerized microservices, and unit testing.\\n\\nThe guide comes\", \" with source code for the eShop multi-platform app, and source code for the eShop reference app. The\", \" eShop multi-platform app is a cross-platform enterprise app developed using .NET MAUI, which connec\", \"ts to a series of containerized microservices known as the eShop reference app. However, the eShop m\", \"ulti-platform app can be configured to consume data from mock services for those who wish to avoid d\", \"eploying the containerized microservices.\\n\\nWhat\\u2019s left out of this guide\\u2019s scope\\n\\nThis guide is aime\", \"d at readers who are already familiar with .NET MAUI. For a detailed introduction to .NET MAUI, see \", \"the .NET MAUI documentation.\\n\\nWho should use this guide\\n\\nThe audience for this guide is mainly devel\", \"opers and architects who would like to learn how to architect and implement cross-platform enterpris\", \"e apps using .NET MAUI.\\n\\nA secondary audience is technical decision-makers who would like to receive\", \" an architectural and technology overview before deciding on what approach to select for cross-platf\", \"orm enterprise app development using .NET MAUI.\\n\\n1\\n\\nCHAPTER 1 | Purpose\\n\\nHow to use this guide\\n\\nThis\", \" guide focuses on building cross-platform enterprise apps using .NET MAUI. As such, it should be rea\", \"d in its entirety to provide a foundation of understanding such apps and their technical considerati\", \"ons. The guide and its sample app can also serve as a starting point or reference for creating a new\", \" enterprise app. Use the associated sample app as a template for the new app or see how to organize \", \"an app\\u2019s component parts. Then, refer back to this guide for architectural guidance.\\n\\nFeel free to f\", \"orward this guide to team members to help ensure a common understanding of cross- platform enterpris\", \"e app development using .NET MAUI. Having everybody working from a common set of terminologies and u\", \"nderlying principles will help ensure a consistent application of architectural patterns and practic\", \"es.\\n\\n2\\n\\nCHAPTER 1 | Purpose\\n\\nCHAPTER 2\\n\\nIntroduction to .NET MAUI\\n\\nRegardless of platform, developer\", \"s of enterprise apps face several challenges:\\n\\n\\n\\nApp requirements that can change over time.\\n\\n\\n\\nNew \", \"business opportunities and challenges.\\n\\n\\n\\nOngoing feedback during development that can significantly\", \" affect the scope and requirements of the app.\\n\\nWith these in mind, it\\u2019s important to build apps tha\", \"t can be easily modified or extended over time. Designing for such adaptability can be difficult as \", \"it requires an architecture that allows individual parts of the app to be independently developed an\", \"d tested in isolation without affecting the rest of the app.\\n\\nMany enterprise apps are sufficiently \", \"complex to require more than one developer. It can be a significant challenge to decide how to desig\", \"n an app so that multiple developers can work effectively on different pieces of the app independent\", \"ly, while ensuring that the pieces come together seamlessly when integrated into the app.\\n\\nThe tradi\", \"tional approach to designing and building an app results in what is referred to as a monolithic app,\", \" where components are tightly coupled with no clear separation between them. Typically, this monolit\", \"hic approach leads to apps that are difficult and inefficient to maintain, because it can be difficu\", \"lt to resolve bugs without breaking other components in the app, and it can be difficult to add new \", \"features or to replace existing features.\\n\\nAn effective remedy for these challenges is to partition \", \"an app into discrete, loosely coupled components that can be easily integrated together into an app.\", \" Such an approach offers several benefits:\\n\\n\\n\\nIt allows individual functionality to be developed, te\", \"sted, extended, and maintained by different individuals or teams.\\n\\n\\n\\nIt promotes reuse and a clean s\", \"eparation of concerns between the app\\u2019s horizontal capabilities, such as authentication and data acc\", \"ess, and the vertical capabilities, such as app specific business functionality. This allows the dep\", \"endencies and interactions between app components to be more easily managed.\\n\\n\\n\\nIt helps maintain a \", \"separation of roles by allowing different individuals, or teams, to focus on a specific task or piec\", \"e of functionality according to their expertise. In particular, it provides a cleaner separation bet\", \"ween the user interface and the app\\u2019s business logic.\\n\\nHowever, there are many issues that must be r\", \"esolved when partitioning an app into discrete, loosely coupled components. These include:\\n\\n3\\n\\nCHAPT\", \"ER 2 | Introduction to .NET MAUI\\n\\n\\n\\nDeciding how to provide a clean separation of concerns between t\", \"he user interface controls and their logic. One of the most important decisions when creating a .NET\", \" MAUI enterprise app is whether to place business logic in code-behind files, or whether to create a\", \" clean separation of concerns between the user interface controls and their logic, in order to make \", \"the app more maintainable and testable. For more information, see Model-View-ViewModel.\\n\\n\\n\\nDetermini\", \"ng whether to use a dependency injection container. Dependency injection containers reduce the depen\", \"dency coupling between objects by providing a facility to construct instances of classes with their \", \"dependencies injected, and manage their lifetime based on the configuration of the container. For mo\", \"re information, see Dependency injection.\\n\\n\\n\\nChoosing between platform provided eventing and loosely\", \" coupled message-based communication between components that are inconvenient to link by object and \", \"type references. For more information, see Introduction to Communicating between loosely coupled com\", \"ponents.\\n\\n\\n\\nDeciding how to navigate between pages, including how to invoke navigation, and where na\", \"vigation logic should reside. For more information, see Navigation.\\n\\n\\n\\nDetermining how to validate u\", \"ser input for correctness. The decision must include how to validate user input, and how to notify t\", \"he user about validation errors. For more information, see Validation.\\n\\n\\n\\nDeciding how to perform au\", \"thentication, and how to protect resources with authorization. For more information, see Authenticat\", \"ion and authorization.\\n\\n\\n\\nDetermining how to access remote data from web services, including how to \", \"reliably retrieve data, and how to cache data. For more information, see Accessing remote data.\\n\\n\\n\\nD\", \"eciding how to test the app. For more information, see Unit testing.\\n\\nThis guide provides guidance o\", \"n these issues, and focuses on the core patterns and architecture for building a cross-platform ente\", \"rprise app using .NET MAUI. The guidance aims to help to produce adaptable, maintainable, and testab\", \"le code, by addressing common .NET MAUI enterprise app development scenarios, and by separating the \", \"concerns of presentation, presentation logic, and entities through support for the Model-View-ViewMo\", \"del (MVVM) pattern.\\n\\nSample application\\n\\nThis guide includes a sample application, eShop, that\\u2019s an \", \"online store that includes the following functionality:\\n\\n\\n\\nAuthenticating and authorizing against a \", \"backend service.\\n\\n\\n\\nBrowsing a catalog of items.\\n\\n\\n\\nFiltering the catalog.\\n\\n\\n\\nOrdering items from th\", \"e catalog.\\n\\n\\n\\nViewing the user\\u2019s order history.\\n\\n\\n\\nConfiguration of settings.\\n\\n4\\n\\nCHAPTER 2 | Introd\", \"uction to .NET MAUI\\n\\nSample application architecture\\n\\nBelow is a high-level overview of the architec\", \"ture of the sample application.\\n\\nThe sample application ships with:\\n\\n\\n\\n.NET Aspire App Hosting & Orc\", \"hestration\\n\\n\\n\\nAn Blazor web application developed with ASP.NET Core.\\n\\n\\n\\nA multi-platform app develop\", \"ed with .NET MAUI, which supports iOS, Android, macOS via Mac Catalyst, and Windows.\\n\\nThe sample app\", \"lication includes the following backend services:\\n\\n\\n\\nAn identity microservice, which uses ASP.NET Co\", \"re Identity and IdentityServer.\\n\\n\\n\\nA catalog microservice, which is a data-driven create, read, upda\", \"te, delete (CRUD) service that consumes an SQL Server database using EntityFramework Core.\\n\\n\\n\\nAn ord\", \"ering microservice, which is a domain-driven service that uses domain-driven design patterns.\\n\\n\\n\\nA b\", \"asket microservice, which is a data-driven CRUD service that uses Redis Cache.\\n\\nThese backend servic\", \"es are implemented as microservices using ASP.NET Core, and are deployed as unique containers with .\", \"NET Aspire. Collectively, these backend services are referred to as the eShop reference application.\", \" Client apps communicate with the backend services through a Representational State Transfer (REST) \", \"web interface. For more information about microservices and conainers, see Containerized microservic\", \"es.\\n\\n5\\n\\nCHAPTER 2 | Introduction to .NET MAUI\\n\\nMulti-Platform app\\n\\nThis guide focuses on building cr\", \"oss-platform enterprise apps using .NET MAUI, and uses the eShop multi-platform app as an example. T\", \"he image below shows the pages from the eShop multi-platform app that provide the functionality outl\", \"ined earlier.\\n\\nThe multi-platform app consumes the backend services provided by the eShop reference \", \"application. However, it can be configured to consume data from mock services for those who wish to \", \"avoid deploying the backend services.\\n\\nThe eShop multi-platform app exercises the following .NET MAU\", \"I functionality:\\n\\n6\\n\\nCHAPTER 2 | Introduction to .NET MAUI\\n\\n\\n\\nXAML\\n\\n\\n\\nControls\\n\\n\\n\\nBindings\\n\\n\\n\\nConver\", \"ters\\n\\n\\n\\nStyles\\n\\n\\n\\nAnimations\\n\\n\\n\\nCommands\\n\\n\\n\\nBehaviors\\n\\n\\n\\nTriggers\\n\\n\\n\\nEffects\\n\\n\\n\\nCustom Controls\\n\\nFor\", \" more information about this functionality, see the .NET MAUI documentation.\\n\\nIn addition, unit test\", \"s are provided for some of the classes in the eShop multi-platform app.\\n\\nMulti-Platform app solution\", \"\\n\\nThe eShop multi-platform app solution organizes the source code and other resources into a multipl\", \"e projects. All of the core mobile components are contained in a singular project named eShopContain\", \"ers. This is a feature introduced with .NET 6 that allows a project to target multiple outputs which\", \" helps eliminate the need for multiple platform projects that we would have used in Xamarin.Forms an\", \"d earlier .NET versions. An additional project is included for unit testing.\\n\\nWhile this project has\", \" all of its components stored in a singular project, it is worth considering separating it into mult\", \"iple projects based on your needs. For example, if you have multiple implementations of service prov\", \"iders based off of a service with their own dependencies, it may make sense to break those service p\", \"rovider implementations out into their own separate project. Good candidates for project separation \", \"include shared models, service implementations, api client components, database or caching layers. A\", \"ny place where you feel that the business could re-use a component in another project is a potential\", \" candidate for separation. These projects can then be packaged via NuGet for easy distribution and v\", \"ersioning.\\n\\nAll of the projects use folders to organize the source code and other resources into cat\", \"egories. The classes from the eShop multi-platform app can be re-used in any .NET MAUI app with litt\", \"le or no modification.\\n\\neShop project\\n\\nThe eShop project contains the following folders:\\n\\nFolder\\n\\nDe\", \"scription\\n\\nAnimations\\n\\nContains classes that enable animations to be consumed in XAML.\\n\\nBehaviors\\n\\nC\", \"ontains behaviors that are exposed to view classes.\\n\\n7\\n\\nCHAPTER 2 | Introduction to .NET MAUI\\n\\nFolde\", \"r\\n\\nDescription\\n\\nControls\\n\\nContains custom controls used by the app.\\n\\nConverters\\n\\nContains value conv\", \"erters that apply custom logic to a binding.\\n\\nExceptions\\n\\nContains the custom ServiceAuthenticationE\", \"xception.\\n\\nExtensions\\n\\nContains extension methods for the VisualElement and IEnumerable<T> classes.\\n\", \"\\nHelpers\\n\\nContains helper classes for the app.\\n\\nModels\\n\\nContains the model classes for the app.\\n\\nPro\", \"perties\\n\\nContains AssemblyInfo.cs, a .NET assembly metadata file.\\n\\nServices\\n\\nContains interfaces and\", \" classes that implement services that are provided to the app.\\n\\nTriggers\\n\\nContains the BeginAnimatio\", \"n trigger, which is used to invoke an animation in XAML.\\n\\nValidations\\n\\nContains classes involved in \", \"validating data input.\\n\\nViewModels Contains the application logic that\\u2019s exposed to pages.\\n\\nViews\\n\\nC\", \"ontains the pages for the app.\\n\\nSummary\\n\\nMicrosoft\\u2019s cross-platform multi-platform app development t\", \"ools and platforms provide a comprehensive solution for B2E, B2B, and B2C mobile client apps, provid\", \"ing the ability to share code across all target platforms (iOS, macOS, Android, and Windows) and hel\", \"ping to lower the total cost of ownership. Apps can share their user interface and app logic code, w\", \"hile retaining the native platform look and feel.\\n\\nDevelopers of enterprise apps face several challe\", \"nges that can alter the architecture of the app during development. Therefore, it\\u2019s important to bui\", \"ld an app so that it can be modified or extended over time. Designing for such adaptability can be d\", \"ifficult, but typically involves partitioning an app into discrete, loosely coupled components that \", \"can be easily integrated together into an app.\\n\\n8\\n\\nCHAPTER 2 | Introduction to .NET MAUI\\n\\nCHAPTER 3\\n\", \"\\nModel-View-ViewModel (MVVM)\\n\\nThe .NET MAUI developer experience typically involves creating a user \", \"interface in XAML, and then adding code-behind that operates on the user interface. Complex maintena\", \"nce issues can arise as apps are modified and grow in size and scope. These issues include the tight\", \" coupling between the UI controls and the business logic, which increases the cost of making UI modi\", \"fications, and the difficulty of unit testing such code.\\n\\nThe MVVM pattern helps cleanly separate an\", \" application\\u2019s business and presentation logic from its user interface (UI). Maintaining a clean sep\", \"aration between application logic and the UI helps address numerous development issues and makes an \", \"application easier to test, maintain, and evolve. It can also significantly improve code re-use oppo\", \"rtunities and allows developers and UI designers to collaborate more easily when developing their re\", \"spective parts of an app.\\n\\nThe MVVM pattern\\n\\nThere are three core components in the MVVM pattern: th\", \"e model, the view, and the view model. Each serves a distinct purpose. The diagram below shows the r\", \"elationships between the three components.\\n\\nIn addition to understanding the responsibilities of eac\", \"h component, it\\u2019s also important to understand how they interact. At a high level, the view \\u201cknows a\", \"bout\\u201d the view model, and the view model \\u201cknows about\\u201d the model, but the model is unaware of the vi\", \"ew model, and the view model is unaware of the view. Therefore, the view model isolates the view fro\", \"m the model, and allows the model to evolve independently of the view.\\n\\nThe benefits of using the MV\", \"VM pattern are as follows:\\n\\n9\\n\\nCHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\n\\n\\nIf an existing model imple\", \"mentation encapsulates existing business logic, it can be difficult or risky to change it. In this s\", \"cenario, the view model acts as an adapter for the model classes and prevents you from making major \", \"changes to the model code.\\n\\n\\n\\nDevelopers can create unit tests for the view model and the model, wit\", \"hout using the view. The unit tests for the view model can exercise exactly the same functionality a\", \"s used by the view.\\n\\n\\n\\nThe app UI can be redesigned without touching the view model and model code, \", \"provided that the view is implemented entirely in XAML or C#. Therefore, a new version of the view s\", \"hould work with the existing view model.\\n\\n\\n\\nDesigners and developers can work independently and conc\", \"urrently on their components during development. Designers can focus on the view, while developers c\", \"an work on the view model and model components.\\n\\nThe key to using MVVM effectively lies in understan\", \"ding how to factor app code into the correct classes and how the classes interact. The following sec\", \"tions discuss the responsibilities of each of the classes in the MVVM pattern.\\n\\nView\\n\\nThe view is re\", \"sponsible for defining the structure, layout, and appearance of what the user sees on screen. Ideall\", \"y, each view is defined in XAML, with a limited code-behind that does not contain business logic. Ho\", \"wever, in some cases, the code-behind might contain UI logic that implements visual behavior that is\", \" difficult to express in XAML, such as animations.\\n\\nIn a .NET MAUI application, a view is typically \", \"a ContentPage-derived or ContentView-derived class. However, views can also be represented by a data\", \" template, which specifies the UI elements to be used to visually represent an object when it\\u2019s disp\", \"layed. A data template as a view does not have any code-behind, and is designed to bind to a specifi\", \"c view model type.\\n\\nTip\\n\\nAvoid enabling and disabling UI elements in the code-behind.\\n\\nEnsure that t\", \"he view models are responsible for defining logical state changes that affect some aspects of the vi\", \"ew\\u2019s display, such as whether a command is available, or an indication that an operation is pending.\", \" Therefore, enable and disable UI elements by binding to view model properties, rather than enabling\", \" and disabling them in code-behind.\\n\\nThere are several options for executing code on the view model \", \"in response to interactions on the view, such as a button click or item selection. If a control supp\", \"orts commands, the control\\u2019s Command property can be data-bound to an ICommand property on the view \", \"model. When the control\\u2019s command is invoked, the code in the view model will be executed. In additi\", \"on to commands, behaviors can be attached to an object in the view and can listen for either a comma\", \"nd to be invoked or the event to be raised. In response, the behavior can then invoke an ICommand on\", \" the view model or a method on the view model.\\n\\n10\\n\\nCHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\nViewMod\", \"el\\n\\nThe view model implements properties and commands to which the view can data bind to, and notifi\", \"es the view of any state changes through change notification events. The properties and commands tha\", \"t the view model provides define the functionality to be offered by the UI, but the view determines \", \"how that functionality is to be displayed.\\n\\nTip\\n\\nKeep the UI responsive with asynchronous operations\", \".\\n\\nMulti-platform apps should keep the UI thread unblocked to improve the user\\u2019s perception of perfo\", \"rmance. Therefore, in the view model, use asynchronous methods for I/O operations and raise events t\", \"o asynchronously notify views of property changes.\\n\\nThe view model is also responsible for coordinat\", \"ing the view\\u2019s interactions with any model classes that are required. There\\u2019s typically a one-to-man\", \"y relationship between the view model and the model classes. The view model might choose to expose m\", \"odel classes directly to the view so that controls in the view can data bind directly to them. In th\", \"is case, the model classes will need to be designed to support data binding and change notification \", \"events.\\n\\nEach view model provides data from a model in a form that the view can easily consume. To a\", \"ccomplish this, the view model sometimes performs data conversion. Placing this data conversion in t\", \"he view model is a good idea because it provides properties that the view can bind to. For example, \", \"the view model might combine the values of two properties to make it easier to display by the view.\\n\", \"\\nTip\\n\\nCentralize data conversions in a conversion layer.\\n\\nIt\\u2019s also possible to use converters as a \", \"separate data conversion layer that sits between the view model and the view. This can be necessary,\", \" for example, when data requires special formatting that the view model doesn\\u2019t provide.\\n\\nIn order f\", \"or the view model to participate in two-way data binding with the view, its properties must raise th\", \"e PropertyChanged event. View models satisfy this requirement by implementing the INotifyPropertyCha\", \"nged interface, and raising the PropertyChanged event when a property is changed.\\n\\nFor collections, \", \"the view-friendly ObservableCollection<T> is provided. This collection implements collection changed\", \" notification, relieving the developer from having to implement the INotifyCollectionChanged interfa\", \"ce on collections.\\n\\nModel\\n\\nModel classes are non-visual classes that encapsulate the app\\u2019s data. The\", \"refore, the model can be thought of as representing the app\\u2019s domain model, which usually includes a\", \" data model along with business and validation logic. Examples of model objects include data transfe\", \"r objects (DTOs), Plain Old CLR Objects (POCOs), and generated entity and proxy objects.\\n\\n11\\n\\nCHAPTE\", \"R 3 | Model-View-ViewModel (MVVM)\\n\\nModel classes are typically used in conjunction with services or \", \"repositories that encapsulate data access and caching.\\n\\nConnecting view models to views\\n\\nView models\", \" can be connected to views by using the data-binding capabilities of .NET MAUI. There are many appro\", \"aches that can be used to construct views and view models and associate them at runtime. These appro\", \"aches fall into two categories, known as view first composition, and view model first composition. C\", \"hoosing between view first composition and view model first composition is an issue of preference an\", \"d complexity. However, all approaches share the same aim, which is for the view to have a view model\", \" assigned to its BindingContext property.\\n\\nWith view first composition the app is conceptually compo\", \"sed of views that connect to the view models they depend on. The primary benefit of this approach is\", \" that it makes it easy to construct loosely coupled, unit testable apps because the view models have\", \" no dependence on the views themselves. It\\u2019s also easy to understand the structure of the app by fol\", \"lowing its visual structure, rather than having to track code execution to understand how classes ar\", \"e created and associated. In addition, view first construction aligns with the Microsoft Maui\\u2019s navi\", \"gation system that\\u2019s responsible for constructing pages when navigation occurs, which makes a view m\", \"odel first composition complex and misaligned with the platform.\\n\\nWith view model first composition,\", \" the app is conceptually composed of view models, with a service responsible for locating the view f\", \"or a view model. View model first composition feels more natural to some developers, since the view \", \"creation can be abstracted away, allowing them to focus on the logical non-UI structure of the app. \", \"In addition, it allows view models to be created by other view models. However, this approach is oft\", \"en complex, and it can become difficult to understand how the various parts of the app are created a\", \"nd associated.\\n\\nTip\\n\\nKeep view models and views independent.\\n\\nThe binding of views to a property in \", \"a data source should be the view\\u2019s principal dependency on its corresponding view model. Specificall\", \"y, don\\u2019t reference view types, such as Button and ListView, from view models. By following the princ\", \"iples outlined here, view models can be tested in isolation, therefore reducing the likelihood of so\", \"ftware defects by limiting scope.\\n\\nThe following sections discuss the main approaches to connecting \", \"view models to views.\\n\\nCreating a view model declaratively\\n\\nThe simplest approach is for the view to\", \" declaratively instantiate its corresponding view model in XAML. When the view is constructed, the c\", \"orresponding view model object will also be constructed. This approach is demonstrated in the follow\", \"ing code example:\\n\\n<ContentPage xmlns:local=\\\"clr-namespace:eShop\\\"> <ContentPage.BindingContext>\\n\\n12\\n\", \"\\nCHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\n<local:LoginViewModel /> </ContentPage.BindingContext> <!-\", \"- Omitted for brevity... --> </ContentPage>\\n\\nWhen the ContentPage is created, an instance of the Log\", \"inViewModel is automatically constructed and set as the view\\u2019s BindingContext.\\n\\nThis declarative con\", \"struction and assignment of the view model by the view has the advantage that it\\u2019s simple, but has t\", \"he disadvantage that it requires a default (parameter-less) constructor in the view model.\\n\\nCreating\", \" a view model programmatically\\n\\nA view can have code in the code-behind file, resulting in the view-\", \"model being assigned to its BindingContext property. This is often accomplished in the view\\u2019s constr\", \"uctor, as shown in the following code example:\\n\\npublic LoginView() { InitializeComponent(); BindingC\", \"ontext = new LoginViewModel(navigationService); }\\n\\nThe programmatic construction and assignment of t\", \"he view model within the view\\u2019s code-behind has the advantage that it\\u2019s simple. However, the main di\", \"sadvantage of this approach is that the view needs to provide the view model with any required depen\", \"dencies. Using a dependency injection container can help to maintain loose coupling between the view\", \" and view model. For more information, see Dependency injection.\\n\\nUpdating views in response to chan\", \"ges in the underlying view model or model\\n\\nAll view model and model classes that are accessible to a\", \" view should implement the [INotifyPropertyChanged interface. Implementing this interface in a view \", \"model or model class allows the class to provide change notifications to any data-bound controls in \", \"the view when the underlying property value changes.\\n\\nApp\\u2019s should be architected for the correct us\", \"e of property change notification, by meeting the following requirements:\\n\\n\\n\\nAlways raising a Proper\", \"tyChanged event if a public property\\u2019s value changes. Do not assume that raising the PropertyChanged\", \" event can be ignored because of knowledge of how XAML binding occurs.\\n\\n\\n\\nAlways raising a PropertyC\", \"hanged event for any calculated properties whose values are used by other properties in the view mod\", \"el or model.\\n\\n\\n\\nAlways raising the PropertyChanged event at the end of the method that makes a prope\", \"rty change, or when the object is known to be in a safe state. Raising the event interrupts the\\n\\n13\\n\", \"\\nCHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\noperation by invoking the event\\u2019s handlers synchronously. \", \"If this happens in the middle of an operation, it might expose the object to callback functions when\", \" it is in an unsafe, partially updated state. In addition, it\\u2019s possible for cascading changes to be\", \" triggered by PropertyChanged events. Cascading changes generally require updates to be complete bef\", \"ore the cascading change is safe to execute.\\n\\n\\n\\nNever raising a PropertyChanged event if the propert\", \"y does not change. This means that you must compare the old and new values before raising the Proper\", \"tyChanged event.\\n\\n\\n\\nNever raising the PropertyChanged event during a view model\\u2019s constructor if you\", \" are initializing a property. Data-bound controls in the view will not have subscribed to receive ch\", \"ange notifications at this point.\\n\\n\\n\\nNever raising more than one PropertyChanged event with the same\", \" property name argument within a single synchronous invocation of a public method of a class. For ex\", \"ample, given a NumberOfItems property whose backing store is the _numberOfItems field, if a method i\", \"ncrements _numberOfItems fifty times during the execution of a loop, it should only raise property c\", \"hange notification on the NumberOfItems property once, after all the work is complete. For asynchron\", \"ous methods, raise the PropertyChanged event for a given property name in each synchronous segment o\", \"f an asynchronous continuation chain.\\n\\nA simple way to provide this functionality would be to create\", \" an extension of the BindableObject class. In this example, the ExtendedBindableObject class provide\", \"s change notifications, which is shown in the following code example:\\n\\npublic abstract class Extende\", \"dBindableObject : BindableObject { public void RaisePropertyChanged<T>(Expression<Func<T>> property)\", \" { var name = GetMemberInfo(property).Name; OnPropertyChanged(name); }\\n\\nprivate MemberInfo GetMember\", \"Info(Expression expression) { // Omitted for brevity ... } }\\n\\n.NET MAUI\\u2019s BindableObject class imple\", \"ments the INotifyPropertyChanged interface, and provides an OnPropertyChanged method. The ExtendedBi\", \"ndableObject class provides the RaisePropertyChanged method to invoke property change notification, \", \"and in doing so uses the functionality provided by the BindableObject class.\\n\\nView model classes can\", \" then derive from the ExtendedBindableObject class. Therefore, each view model class uses the RaiseP\", \"ropertyChanged method in the ExtendedBindableObject class to provide property change notification. T\", \"he following code example shows how the eShop multi-platform app invokes property change notificatio\", \"n by using a lambda expression:\\n\\npublic bool IsLogin { get => _isLogin; set { _isLogin = value; Rais\", \"ePropertyChanged(() => IsLogin);\\n\\n14\\n\\nCHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\n} }\\n\\nUsing a lambda e\", \"xpression in this way involves a small performance cost because the lambda expression has to be eval\", \"uated for each call. Although the performance cost is small and would not typically impact an app, t\", \"he costs can accrue when there are many change notifications. However, the benefit of this approach \", \"is that it provides compile-time type safety and refactoring support when renaming properties.\\n\\nMVVM\", \" Frameworks\\n\\nThe MVVM pattern is well established in .NET, and the community has created many framew\", \"orks which help ease this development. Each framework provides a different set of features, but it i\", \"s standard for them to provide a common view model with an implementation of the INotifyPropertyChan\", \"ged interface. Additional features of MVVM frameworks include custom commands, navigation helpers, d\", \"ependency injection/service locator components, and UI platform integration. While it is not necessa\", \"ry to use these frameworks, they can speed up and standardize your development. The eShop multi-plat\", \"form app uses the .NET Community MVVM Toolkit. When choosing a framework, you should consider your a\", \"pplication\\u2019s needs and your team\\u2019s strengths. The list below includes some of the more common MVVM f\", \"rameworks for .NET MAUI.\\n\\n\\n\\n.NET Community MVVM Toolkit\\n\\n\\n\\nReactiveUI\\n\\n\\n\\nPrism Library\\n\\nUI interacti\", \"on using commands and behaviors\\n\\nIn multi-platform apps, actions are typically invoked in response t\", \"o a user action, such as a button click, that can be implemented by creating an event handler in the\", \" code-behind file. However, in the MVVM pattern, the responsibility for implementing the action lies\", \" with the view model, and placing code in the code-behind should be avoided.\\n\\nCommands provide a con\", \"venient way to represent actions that can be bound to controls in the UI. They encapsulate the code \", \"that implements the action and help to keep it decoupled from its visual representation in the view.\", \" This way, your view models become more portable to new platforms, as they do not have a direct depe\", \"ndency on events provided by the platform\\u2019s UI framework. .NET MAUI includes controls that can be de\", \"claratively connected to a command, and these controls will invoke the command when the user interac\", \"ts with the control.\\n\\nBehaviors also allow controls to be declaratively connected to a command. Howe\", \"ver, behaviors can be used to invoke an action that\\u2019s associated with a range of events raised by a \", \"control. Therefore, behaviors address many of the same scenarios as command-enabled controls, while \", \"providing a greater degree of flexibility and control. In addition, behaviors can also be used to as\", \"sociate command objects or methods with controls that were not specifically designed to interact wit\", \"h commands.\\n\\n15\\n\\nCHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\nImplementing commands\\n\\nView models typical\", \"ly expose public properties, for binding from the view, which implement the ICommand interface. Many\", \" .NET MAUI controls and gestures provide a Command property, which can be data bound to an ICommand \", \"object provided by the view model. The button control is one of the most commonly used controls, pro\", \"viding a command property that executes when the button is clicked.\\n\\nNote\\n\\nWhile it\\u2019s possible to ex\", \"pose the actual implementation of the ICommand interface that your view model uses (for example, Com\", \"mand<T> or RelayCommand), it is recommended to expose your commands publicly as ICommand. This way, \", \"if you ever need to change the implementation at a later date, it can easily be swapped out.\\n\\nThe IC\", \"ommand interface defines an Execute method, which encapsulates the operation itself, a CanExecute me\", \"thod, which indicates whether the command can be invoked, and a CanExecuteChanged event that occurs \", \"when changes occur that affect whether the command should execute. In most cases, we will only suppl\", \"y the Execute method for our commands. For a more detailed overview of ICommand, refer to the Comman\", \"ding documentation for .NET MAUI.\\n\\nProvided with .NET MAUI are the Command and Command<T> classes th\", \"at implement the ICommand interface, where T is the type of the arguments to Execute and CanExecute.\", \" Command and Command<T> are basic implementations that provide the minimal set of functionality need\", \"ed for the ICommand interface.\\n\\nNote\\n\\nMany MVVM frameworks offer more feature rich implementations o\", \"f the ICommand interface.\\n\\nThe Command or Command<T> constructor requires an Action callback object \", \"that\\u2019s called when the ICommand.Execute method is invoked. The CanExecute method is an optional cons\", \"tructor parameter, and is a Func that returns a bool.\\n\\nThe eShop multi-platform app uses the RelayCo\", \"mmand and AsyncRelayCommand. The primary benefit for modern applications is that the AsyncRelayComma\", \"nd provides better functionality for asynchronous operations.\\n\\nThe following code shows how a Comman\", \"d instance, which represents a register command, is constructed by specifying a delegate to the Regi\", \"ster view model method:\\n\\npublic ICommand RegisterCommand { get; }\\n\\nThe command is exposed to the vie\", \"w through a property that returns a reference to an ICommand. When the Execute method is called on t\", \"he Command object, it simply forwards the call to the method in the view model via the delegate that\", \" was specified in the Command constructor. An asynchronous method can be invoked by a command by usi\", \"ng the async and await keywords when specifying the command\\u2019s Execute delegate. This indicates that \", \"the callback is a Task and should be awaited. For\\n\\n16\\n\\nCHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\nexam\", \"ple, the following code shows how an ICommand instance, which represents a sign-in command, is const\", \"ructed by specifying a delegate to the SignInAsync view model method:\\n\\npublic ICommand SignInCommand\", \" { get; } ... SignInCommand = new AsyncRelayCommand(async () => await SignInAsync());\\n\\nParameters ca\", \"n be passed to the Execute and CanExecute actions by using the AsyncRelayCommand<T> class to instant\", \"iate the command. For example, the following code shows how an AsyncRelayCommand<T> instance is used\", \" to indicate that the NavigateAsync method will require an argument of type string:\\n\\npublic ICommand\", \" NavigateCommand { get; }\\n\\n... NavigateCommand = new AsyncRelayCommand<string>(NavigateAsync);\\n\\nIn b\", \"oth the RelayCommand and RelayCommand<T> classes, the delegate to the CanExecute method in each cons\", \"tructor is optional. If a delegate isn\\u2019t specified, the Command will return true for CanExecute. How\", \"ever, the view model can indicate a change in the command\\u2019s CanExecute status by calling the ChangeC\", \"anExecute method on the Command object. This causes the CanExecuteChanged event to be raised. Any UI\", \" controls bound to the command will then update their enabled status to reflect the availability of \", \"the data-bound command.\\n\\nInvoking commands from a view\\n\\nThe following code example shows how a Grid \", \"in the LoginView binds to the RegisterCommand in the LoginViewModel class by using a TapGestureRecog\", \"nizer instance:\\n\\n<Grid Grid.Column=\\\"1\\\" HorizontalOptions=\\\"Center\\\"> <Label Text=\\\"REGISTER\\\" TextColor=\", \"\\\"Gray\\\"/> <Grid.GestureRecognizers> <TapGestureRecognizer Command=\\\"{Binding RegisterCommand}\\\" NumberO\", \"fTapsRequired=\\\"1\\\" /> </Grid.GestureRecognizers> </Grid>\\n\\nA command parameter can also be optionally \", \"defined using the CommandParameter property. The type of the expected argument is specified in the E\", \"xecute and CanExecute target methods. The TapGestureRecognizer will automatically invoke the target \", \"command when the user interacts with the attached control. The CommandParameter, if provided, will b\", \"e passed as the argument to the command\\u2019s Execute delegate.\\n\\nImplementing behaviors\\n\\nBehaviors allow\", \" functionality to be added to UI controls without having to subclass them. Instead, the functionalit\", \"y is implemented in a behavior class and attached to the control as if it was part of the control it\", \"self. Behaviors enable you to implement code that you would typically have to write as code- behind,\", \" because it directly interacts with the API of the control, in such a way that it can be concisely\\n\\n\", \"17\\n\\nCHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\nattached to the control, and packaged for reuse across \", \"more than one view or app. In the context of MVVM, behaviors are a useful approach for connecting co\", \"ntrols to commands.\\n\\nA behavior that\\u2019s attached to a control through attached properties is known as\", \" an attached behavior. The behavior can then use the exposed API of the element to which it is attac\", \"hed to add functionality to that control, or other controls, in the visual tree of the view.\\n\\nA .NET\", \" MAUI behavior is a class that derives from the Behavior or Behavior<T> class, where T is the type o\", \"f the control to which the behavior should apply. These classes provide OnAttachedTo and OnDetaching\", \"From methods, which should be overridden to provide logic that will be executed when the behavior is\", \" attached to and detached from controls.\\n\\nIn the eShop multi-platform app, the BindableBehavior<T> c\", \"lass derives from the Behavior<T> class. The purpose of the BindableBehavior<T> class is to provide \", \"a base class for .NET MAUI behaviors that require the BindingContext of the behavior to be set to th\", \"e attached control.\\n\\nThe BindableBehavior<T> class provides an overridable OnAttachedTo method that \", \"sets the BindingContext of the behavior, and an overridable OnDetachingFrom method that cleans up th\", \"e BindingContext.\\n\\nThe eShop multi-platform app includes an EventToCommandBehavior class which is pr\", \"ovided by the MAUI Community toolkit. EventToCommandBehavior executes a command in response to an ev\", \"ent occurring. This class derives from the BaseBehavior<View> class so that the behavior can bind to\", \" and execute an ICommand specified by a Command property when the behavior is consumed. The followin\", \"g code example shows the EventToCommandBehavior class:\\n\\n/// <summary> /// The <see cref=\\\"EventToComm\", \"andBehavior\\\"/> is a behavior that allows the user to invoke a <see cref=\\\"ICommand\\\"/> through an even\", \"t. It is designed to associate Commands to events exposed by controls that were not designed to supp\", \"ort Commands. It allows you to map any arbitrary event on a control to a Command. /// </summary> pub\", \"lic class EventToCommandBehavior : BaseBehavior<VisualElement> { // Omitted for brevity...\\n\\n/// <inh\", \"eritdoc/> protected override void OnAttachedTo(VisualElement bindable) { base.OnAttachedTo(bindable)\", \"; RegisterEvent(); }\\n\\n/// <inheritdoc/> protected override void OnDetachingFrom(VisualElement bindab\", \"le) { UnregisterEvent(); base.OnDetachingFrom(bindable); }\\n\\nstatic void OnEventNamePropertyChanged(B\", \"indableObject bindable, object oldValue, object newValue) => ((EventToCommandBehavior)bindable).Regi\", \"sterEvent();\\n\\nvoid RegisterEvent() {\\n\\n18\\n\\nCHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\nUnregisterEvent()\", \";\\n\\nvar eventName = EventName; if (View is null || string.IsNullOrWhiteSpace(eventName)) { return; }\\n\", \"\\neventInfo = View.GetType()?.GetRuntimeEvent(eventName) ?? throw new ArgumentException($\\\"{nameof(Eve\", \"ntToCommandBehavior)}: Couldn't resolve the event.\\\", nameof(EventName));\\n\\nArgumentNullException.Thro\", \"wIfNull(eventInfo.EventHandlerType); ArgumentNullException.ThrowIfNull(eventHandlerMethodInfo);\\n\\neve\", \"ntHandler = eventHandlerMethodInfo.CreateDelegate(eventInfo.EventHandlerType, this) ?? throw new Arg\", \"umentException($\\\"{nameof(EventToCommandBehavior)}: Couldn't create event handler.\\\", nameof(EventName\", \"));\\n\\neventInfo.AddEventHandler(View, eventHandler); }\\n\\nvoid UnregisterEvent() { if (eventInfo is not\", \" null && eventHandler is not null) { eventInfo.RemoveEventHandler(View, eventHandler); }\\n\\neventInfo \", \"= null; eventHandler = null; }\\n\\n/// <summary> /// Virtual method that executes when a Command is inv\", \"oked /// </summary> /// <param name=\\\"sender\\\"></param> /// <param name=\\\"eventArgs\\\"></param> [Microsof\", \"t.Maui.Controls.Internals.Preserve(Conditional = true)] protected virtual void OnTriggerHandled(obje\", \"ct? sender = null, object? eventArgs = null) { var parameter = CommandParameter ?? EventArgsConverte\", \"r?.Convert(eventArgs, typeof(object), null, null);\\n\\nvar command = Command; if (command?.CanExecute(p\", \"arameter) ?? false) { command.Execute(parameter); } } }\\n\\nThe OnAttachedTo and OnDetachingFrom method\", \"s are used to register and deregister an event handler for the event defined in the EventName proper\", \"ty. Then, when the event fires, the OnTriggerHandled method is invoked, which executes the command.\\n\", \"\\n19\\n\\nCHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\nThe advantage of using the EventToCommandBehavior to e\", \"xecute a command when an event fires, is that commands can be associated with controls that weren\\u2019t \", \"designed to interact with commands. In addition, this moves event-handling code to view models, wher\", \"e it can be unit tested.\\n\\nInvoking behaviors from a view\\n\\nThe EventToCommandBehavior is particularly\", \" useful for attaching a command to a control that doesn\\u2019t support commands. For example, the LoginVi\", \"ew uses the EventToCommandBehavior to execute the ValidateCommand when the user changes the value of\", \" their password, as shown in the following code:\\n\\n<Entry IsPassword=\\\"True\\\" Text=\\\"{Binding Password.V\", \"alue, Mode=TwoWay}\\\"> <!-- Omitted for brevity... --> <Entry.Behaviors> <mct:EventToCommandBehavior E\", \"ventName=\\\"TextChanged\\\" Command=\\\"{Binding ValidateCommand}\\\" /> </Entry.Behaviors> <!-- Omitted for br\", \"evity... --> </Entry>\\n\\nAt runtime, the EventToCommandBehavior will respond to interaction with the E\", \"ntry. When a user types into the Entry field, the TextChanged event will fire, which will execute th\", \"e ValidateCommand in the LoginViewModel. By default, the event arguments for the event are passed to\", \" the command. If needed, the EventArgsConverter property can be used to convert the EventArgs provid\", \"ed by the event into a value that the command expects as input.\\n\\nFor more information about behavior\", \"s, see Behaviors on the .NET MAUI Developer Center.\\n\\nSummary\\n\\nThe Model-View-ViewModel (MVVM) patter\", \"n helps cleanly separate an application\\u2019s business and presentation logic from its user interface (U\", \"I). Maintaining a clean separation between application logic and the UI helps address numerous devel\", \"opment issues and makes an application easier to test, maintain, and evolve. It can also significant\", \"ly improve code re-use opportunities and allows developers and UI designers to collaborate more easi\", \"ly when developing their respective parts of an app.\\n\\nUsing the MVVM pattern, the UI of the app and \", \"the underlying presentation and business logic are separated into three separate classes: the view, \", \"which encapsulates the UI and UI logic; the view model, which encapsulates presentation logic and st\", \"ate; and the model, which encapsulates the app\\u2019s business logic and data.\\n\\n20\\n\\nCHAPTER 3 | Model-Vie\", \"w-ViewModel (MVVM)\\n\\nCHAPTER 4\\n\\nDependency injection\\n\\nTypically, a class constructor is invoked when \", \"instantiating an object, and any values that the object needs are passed as arguments to the constru\", \"ctor. This is an example of dependency injection known as constructor injection. The dependencies th\", \"e object needs are injected into the constructor.\\n\\nBy specifying dependencies as interface types, de\", \"pendency injection enables decoupling the concrete types from the code that depends on these types. \", \"It generally uses a container that holds a list of registrations and mappings between interfaces and\", \" abstract types, and the concrete types that implement or extend these types.\\n\\nThere are also other \", \"types of dependency injection, such as property setter injection and method call injection, but they\", \" are less commonly seen. Therefore, this chapter will focus solely on performing constructor injecti\", \"on with a dependency injection container.\\n\\nIntroduction to dependency injection\\n\\nDependency injectio\", \"n is a specialized version of the Inversion of Control (IoC) pattern, where the concern being invert\", \"ed is the process of obtaining the required dependency. With dependency injection, another class is \", \"responsible for injecting dependencies into an object at runtime. The following code example shows h\", \"ow the ProfileViewModel class is structured when using dependency injection:\\n\\nprivate readonly ISett\", \"ingsService _settingsService; private readonly IAppEnvironmentService _appEnvironmentService;\\n\\npubli\", \"c ProfileViewModel( IAppEnvironmentService appEnvironmentService, IDialogService dialogService, INav\", \"igationService navigationService, ISettingsService settingsService) : base(dialogService, navigation\", \"Service, settingsService) { _appEnvironmentService = appEnvironmentService; _settingsService = setti\", \"ngsService;\\n\\n// Omitted for brevity }\\n\\nThe ProfileViewModel constructor receives multiple interface \", \"object instances as arguments injected by another class. The only dependency in the ProfileViewModel\", \" class is on the interface types. Therefore, the ProfileViewModel class doesn\\u2019t have any knowledge o\", \"f the class that\\u2019s responsible for instantiating the interface objects. The class that\\u2019s responsible\", \" for instantiating the interface objects, and inserting it into the ProfileViewModel class, is known\", \" as the dependency injection container.\\n\\n21\\n\\nCHAPTER 4 | Dependency injection\\n\\nDependency injection \", \"containers reduce the coupling between objects by providing a facility to instantiate class instance\", \"s and manage their lifetime based on the configuration of the container. During object creation, the\", \" container injects any dependencies that the object requires into it. If those dependencies have not\", \" yet been created, the container creates and resolves their dependencies first.\\n\\nThere are several a\", \"dvantages to using a dependency injection container:\\n\\n\\n\\nA container removes the need for a class to \", \"locate its dependencies and manage its lifetimes.\\n\\n\\n\\nA container allows the mapping of implemented d\", \"ependencies without affecting the class.\\n\\n\\n\\nA container facilitates testability by allowing dependen\", \"cies to be mocked.\\n\\n\\n\\nA container increases maintainability by allowing new classes to be easily add\", \"ed to the app.\\n\\nIn the context of a .NET MAUI app that uses MVVM, a dependency injection container w\", \"ill typically be used for registering and resolving views, registering and resolving view models, an\", \"d for registering services and injecting them into view models.\\n\\nThere are many dependency injection\", \" containers available in .NET; the eShop multi-platform app uses Microsoft.Extensions.DependencyInje\", \"ction to manage the instantiation of views, view models, and service classes in the app. Microsoft.E\", \"xtensions.DependencyInjection facilitates building loosely coupled apps, and provides all of the fea\", \"tures commonly found in dependency injection containers, including methods to register type mappings\", \" and object instances, resolve objects, manage object lifetimes, and inject dependent objects into c\", \"onstructors of objects that it resolves. For more information about Microsoft.Extensions.DependencyI\", \"njection, see Dependency injection in .NET.\\n\\nIn .NET MAUI, the MauiProgram class will call into the \", \"CreateMauiApp method to create a MauiAppBuilder object. The MauiAppBuilder object has a Services pro\", \"perty of type IServiceCollection, which provides a place to register our components, such as views, \", \"view models, and services for dependency injection. Any components registered with the Services prop\", \"erty will be provided to the dependency injection container when the MauiAppBuilder.Build method is \", \"called.\\n\\nAt runtime, the container must know which implementation of the services are being requeste\", \"d in order to instantiate them for the requested objects. In the eShop multi-platform app, the IAppE\", \"nvironmentService, IDialogService , INavigationService, and ISettingsService interfaces need to be r\", \"esolved before it can instantiate a ProfileViewModel object. This involves the container performing \", \"the following actions:\\n\\n\\n\\nDeciding how to instantiate an object that implements the interface. This \", \"is known as registration.\\n\\n\\n\\nInstantiating the object that implements the required interface and the\", \" ProfileViewModel object. This is known as resolution.\\n\\nEventually, the app will finish using the Pr\", \"ofileViewModel object, and it will become available for garbage collection. At this point, the garba\", \"ge collector should dispose of any short-lived interface implementations if other classes do not sha\", \"re the same instance.\\n\\n22\\n\\nCHAPTER 4 | Dependency injection\\n\\nRegistration\\n\\nBefore dependencies can b\", \"e injected into an object, the types of the dependencies must first be registered with the container\", \". Registering a type involves passing the container an interface and a concrete type that implements\", \" the interface.\\n\\nThere are two ways of registering types and objects in the container through code:\\n\", \"\\n\\n\\nRegister a type or mapping with the container. This is known as transient registration. When requ\", \"ired, the container will build an instance of the specified type.\\n\\n\\n\\nRegister an existing object in \", \"the container as a singleton. When required, the container will return a reference to the existing o\", \"bject.\\n\\nNote\\n\\nDependency injection containers are not always suitable. Dependency injection introduc\", \"es additional complexity and requirements that might not be appropriate or useful to small apps. If \", \"a class does not have any dependencies, or is not a dependency for other types, it might not make se\", \"nse to put it in the container. In addition, if a class has a single set of dependencies that are in\", \"tegral to the type and will never change, it might not make sense to put it in the container.\\n\\nThe r\", \"egistration of types requiring dependency injection should be performed in a single method in an app\", \". This method should be invoked early in the app\\u2019s lifecycle to ensure it is aware of the dependenci\", \"es between its classes. The eShop multi-platform app performs this the MauiProgram.CreateMauiApp met\", \"hod. The following code example shows how the eShop multi- platform app declares the CreateMauiApp i\", \"n the MauiProgram class:\\n\\npublic static class MauiProgram { public static MauiApp CreateMauiApp() =>\", \" MauiApp.CreateBuilder() .UseMauiApp<App>() // Omitted for brevity .RegisterAppServices() .RegisterV\", \"iewModels() .RegisterViews() .Build(); }\\n\\nThe MauiApp.CreateBuilder method creates a MauiAppBuilder \", \"object that we can use to register our dependencies. Many dependencies in the eShop multi-platform a\", \"pp need to be registered, so the extension methods RegisterAppServices, RegisterViewModels, and Regi\", \"sterViews were created to help provide an organized and maintainable registration workflow. The foll\", \"owing code shows the RegisterViewModels method:\\n\\npublic static MauiAppBuilder RegisterViewModels(thi\", \"s MauiAppBuilder mauiAppBuilder) { mauiAppBuilder.Services.AddSingleton<ViewModels.MainViewModel>();\", \" mauiAppBuilder.Services.AddSingleton<ViewModels.LoginViewModel>(); mauiAppBuilder.Services.AddSingl\", \"eton<ViewModels.BasketViewModel>(); mauiAppBuilder.Services.AddSingleton<ViewModels.CatalogViewModel\", \">(); mauiAppBuilder.Services.AddSingleton<ViewModels.ProfileViewModel>();\\n\\n23\\n\\nCHAPTER 4 | Dependenc\", \"y injection\\n\\nmauiAppBuilder.Services.AddTransient<ViewModels.CheckoutViewModel>(); mauiAppBuilder.Se\", \"rvices.AddTransient<ViewModels.OrderDetailViewModel>(); mauiAppBuilder.Services.AddTransient<ViewMod\", \"els.SettingsViewModel>(); mauiAppBuilder.Services.AddTransient<ViewModels.CampaignViewModel>(); maui\", \"AppBuilder.Services.AddTransient<ViewModels.CampaignDetailsViewModel>();\\n\\nreturn mauiAppBuilder; }\\n\\n\", \"This method receives an instance of MauiAppBuilder, and we can use the Services property to register\", \" our view models. Depending on the needs of your application, you may need to add services with diff\", \"erent lifetimes. The following table provides information on when you may want to choose these diffe\", \"rent registration lifetimes:\\n\\nMethod\\n\\nDescription\\n\\nAddSingleton<T>\\n\\nWill create a single instance of\", \" the object which will be remain for the lifetime of the application.\\n\\nAddTransient<T>\\n\\nWill create \", \"a new instance of the object when requested during resolution. Transient objects do not have a pre-d\", \"efined lifetime, but will typically follow the lifetime of their host.\\n\\nNote\\n\\nThe view models do not\", \" inherit from an interface, so they only need their concrete type provided to the AddSingleton<T> an\", \"d AddTransient<T> methods.\\n\\nThe CatalogViewModel is used near the application\\u2019s root and should alwa\", \"ys be available, so registering it with AddSingleton<T> is beneficial. Other view models, such as Ch\", \"eckoutViewModel and OrderDetailViewModel are situationally navigated to or are used later in the app\", \"lication. Suppose you know that you have a component that may not always be used. In that case, if i\", \"t is memory or computationally intensive or requires just-in-time data, it may be a better candidate\", \" for AddTransient<T> registration.\\n\\nAnother common way to add services is using the AddSingleton<TSe\", \"rvice, TImplementation> and AddTransient<TService, TImplementation> methods. These methods take two \", \"input types: the interface definition and the concrete implementation. This type of registration is \", \"best for cases where you are implementing services based on interfaces. In the code example below, w\", \"e register our ISettingsService interface using the SettingsService implementation:\\n\\npublic static M\", \"auiAppBuilder RegisterAppServices(this MauiAppBuilder mauiAppBuilder) { mauiAppBuilder.Services.AddS\", \"ingleton<ISettingsService, SettingsService>(); // Omitted for brevity... }\\n\\nOnce all services have b\", \"een registered, the MauiAppBuilder.Build method should be called to create our MauiApp and populate \", \"our dependency injection container with all the registered services.\\n\\n24\\n\\nCHAPTER 4 | Dependency inj\", \"ection\\n\\nImportant\\n\\nOnce the Build method has been called, the dependency injection container is immu\", \"table and can no longer be updated or modified. Ensure that all services that you need within your a\", \"pplication have been registered before you call Build.\\n\\nResolution\\n\\nAfter a type is registered, it c\", \"an be resolved or injected as a dependency. When a type is being resolved, and the container needs t\", \"o create a new instance, it injects any dependencies into the instance.\\n\\nGenerally, when a type is r\", \"esolved, one of three things happens:\\n\\n1.\\n\\nIf the type hasn\\u2019t been registered, the container throws \", \"an exception.\\n\\n2.\\n\\nIf the type has been registered as a singleton, the container returns the singlet\", \"on instance. If this is the first time the type is called for, the container creates it if required \", \"and maintains a reference to it.\\n\\n3.\\n\\nIf the type has been registered as transient, the container re\", \"turns a new instance and doesn\\u2019t maintain a reference to it.\\n\\n.NET MAUI offers a number of ways to r\", \"esolve registered components based on your needs. The most direct way to gain access to the dependen\", \"cy injection container is from an Element using the Handler.MauiContext.Services. An example of this\", \" is shown below:\\n\\nvar settingsService = this.Handler.MauiContext.Services.GetServices<ISettingsServi\", \"ce>();\\n\\nThis can be helpful if you need to resolve a service from within an Element or from outside \", \"of the constructor of your Element.\\n\\nCaution\\n\\nThere is a possibility that the Handler property of yo\", \"ur Element may be null, so be aware that you may need to handle those situations. For more informati\", \"on, please refer to Handler lifecycle on the Microsoft Documentation Center.\\n\\nIf using the Shell con\", \"trol for .NET MAUI, it will implicitly call into the dependency injection container to create our ob\", \"jects during navigation. When setting up our Shell control, the Routing.RegisterRoute method will ti\", \"e a route path to a View as shown in the example below:\\n\\nRouting.RegisterRoute(\\\"Filter\\\", typeof(Filt\", \"ersView));\\n\\nDuring Shell navigation, it will look for registrations of the FiltersView, and if any a\", \"re found, it will create that view and inject any dependencies into the constructor. As shown in the\", \" code example below, the CatalogViewModel will be injected into the FiltersView:\\n\\nnamespace eShop.Vi\", \"ews;\\n\\npublic partial class FiltersView : ContentPage {\\n\\n25\\n\\nCHAPTER 4 | Dependency injection\\n\\npublic\", \" FiltersView(CatalogViewModel viewModel) { BindingContext = viewModel;\\n\\nInitializeComponent(); } }\\n\\n\", \"Tip\\n\\nThe dependency injection container is great for creating view model instances. If a view model \", \"has dependencies, it will handle the creation and injection of any required services. Just make sure\", \" that you register your view models and any dependencies that they may have with the CreateMauiApp m\", \"ethod in the MauiProgram class.\\n\\nSummary\\n\\nDependency injection enables the decoupling of concrete ty\", \"pes from the code that depends on these types. It typically uses a container that holds a list of re\", \"gistrations and mappings between interfaces and abstract types, and the concrete types that implemen\", \"t or extend these types.\\n\\nMicrosoft.Extensions.DependencyInjection facilitates building loosely coup\", \"led apps and provides all of the features commonly found in dependency injection containers, includi\", \"ng methods to register type mappings and object instances, resolve objects, manage object lifetimes,\", \" and inject dependent objects into constructors of objects it resolves.\\n\\n26\\n\\nCHAPTER 4 | Dependency \", \"injection\\n\\nCHAPTER 5\\n\\nCommunicating between loosely coupled components\\n\\nThe publish-subscribe patter\", \"n is a messaging pattern in which publishers send messages without knowing any receivers, known as s\", \"ubscribers. Similarly, subscribers listen for specific messages, without knowing any publishers.\\n\\nEv\", \"ents in .NET implement the publish-subscribe pattern and are the most simple approach for a communic\", \"ation layer between components if loose coupling is not required, such as a control and the page tha\", \"t contains it. However, the publisher and subscriber lifetimes are coupled by object references to e\", \"ach other, and the subscriber type must have a reference to the publisher type. This can create memo\", \"ry management issues, especially when there are short-lived objects that subscribe to an event of a \", \"static or long-lived object. If the event handler isn\\u2019t removed, the subscriber will be kept alive b\", \"y the reference to it in the publisher, and this will prevent or delay the garbage collection of the\", \" subscriber.\\n\\nIntroduction to MVVM Toolkit Messenger\\n\\nThe MVVM Toolkit IMessenger interface describe\", \"s the publish-subscribe pattern, allowing message- based communication between components that are i\", \"nconvenient to link by object and type references. This mechanism allows publishers and subscribers \", \"to communicate without having a direct reference to each other, helping to reduce dependencies betwe\", \"en components, while also allowing components to be independently developed and tested.\\n\\nNote\\n\\nThe M\", \"VVM Toolkit Messenger is part of the CommunityToolkit.Mvvm package. For information on how to add th\", \"e package to your project, see Introduction to the MVVM Toolkit on the Microsoft Developer Center.\\n\\n\", \"27\\n\\nCHAPTER 5 | Communicating between loosely coupled components\\n\\nWarning\\n\\n.NET MAUI contains a buil\", \"t-in MessagingCenter class that\\u2019s no longer recommended for use. Use the MVVM Toolkit Messenger inst\", \"ead.\\n\\nThe IMessenger interface allows for multicast publish-subscribe functionality. This means that\", \" there can be multiple publishers that publish a single message, and there can be multiple subscribe\", \"rs listening to the same message. The image below illustrates this relationship:\\n\\nThere are two impl\", \"ementations of the IMessenger interface that come with the CommunityToolkit.Mvvm package. The WeakRe\", \"ferenceMessenger uses weak references which can result in easier cleanup for message subscribers. Th\", \"is is a good option if your subscribers do not have a clearly defined lifecycle. The StrongReference\", \"Messenger uses strong references which can result in better performance and a more clearly controlle\", \"d lifetime of the subscription. If you have a workflow with a very controlled lifetime (for example,\", \" a subscription that is bound to a page\\u2019s OnAppearing and OnDisappearing methods), the StrongReferen\", \"ceManager may be a better option, if performance is a concern. Both of these implementations are ava\", \"ilable with default implementations ready to use by referencing either WeakReferenceMessenger.Defaul\", \"t or StrongReferenceMessenger.Default.\\n\\nNote\\n\\nWhile the IMessenger interface permits communication b\", \"etween loosely-coupled classes, it does not offer the only architectural solution to this issue. For\", \" example, communication between a view model and a view can also be achieved by the binding engine a\", \"nd through property change notifications. In addition, communication between two view models can als\", \"o be achieved by passing data during navigation.\\n\\nThe eShop multi-platform app uses the WeakReferenc\", \"eMessenger class to communicate between loosely coupled components. The app defines a single message\", \" named AddProductMessage. The AddProductMessage is published by the CatalogViewModel class when an i\", \"tem is added to the shopping basket. In return, the CatalogView class subscribes to the message and \", \"uses this to highlight the product adds with animation in response.\\n\\nIn the eShop multi-platform app\", \", WeakReferenceMessenger is used to update the UI in response to an action occurring in another clas\", \"s. Therefore, messages are published from the thread that the class is executing on, with subscriber\", \"s receiving the message on the same thread.\\n\\n28\\n\\nCHAPTER 5 | Communicating between loosely coupled c\", \"omponents\\n\\nTip\\n\\nMarshal to the UI or main thread when performing UI updates. If updates to user inte\", \"rfaces are not made on this thread, it can cause the application to crash or become unstable.\\n\\nIf a \", \"message that\\u2019s sent from a background thread is required to update the UI, process the message on th\", \"e UI thread in the subscriber by invoking the MainThread.BeginInvokeOnMainThread method.\\n\\nFor more i\", \"nformation about Messenger, see Messenger on the Microsoft Developer Center.\\n\\nDefining a message\\n\\nIM\", \"essenger messages are custom objects that provide custom payloads. The following code example shows \", \"the AddProductMessage message defined within the eShop multi-platform app:\\n\\npublic class AddProductM\", \"essage : ValueChangedMessage<int> { public AddProductMessage(int count) : base(count) { } }\\n\\nThe bas\", \"e class is defined using ValueChangedMessage<T> where T can be of any type needed to pass data. Both\", \" message publishers and subscribers can expect messages of a specific type (for example, AddProductM\", \"essage). This can help ensure that both parties have agreed to a messaging contract and that the dat\", \"a provided with that contract will be consistent. Additionally, this approach provides compile-time \", \"type safety and refactoring support.\\n\\nPublishing a message\\n\\nTo publish a message, we will need to us\", \"e the IMessenger.Send method. This can be accessed most commonly through WeakReferenceMessenger.Defa\", \"ult.Send or StrongReferenceMessenger.Default.Send. The message sent can be of any object type. The f\", \"ollowing code example demonstrates publishing the AddProduct message:\\n\\nWeakReferenceMessenger.Defaul\", \"t.Send(new Messages.AddProductMessage(BadgeCount));\\n\\nIn this example, the Send method specifies prov\", \"ides a new instance of the AddProductMessage object for downstream subscribers to receive. An additi\", \"onal second token parameter can be added to use when multiple different subscribers need to receive \", \"messages of the same type without receiving the wrong message.\\n\\nThe Send method will publish the mes\", \"sage, and its payload data, using a fire-and-forget approach. Therefore, the message is sent even if\", \" there are no subscribers registered to receive the message. In this situation, the sent message is \", \"ignored.\\n\\n29\\n\\nCHAPTER 5 | Communicating between loosely coupled components\\n\\nSubscribing to a message\", \"\\n\\nSubscribers can register to receive a message using one of the IMessenger.Register<T> overloads. T\", \"he following code example demonstrates how the eShop multi-platform app subscribes to, and processes\", \", the AddProductMessage message:\\n\\nWeakReferenceMessenger.Default .Register<CatalogView, Messages.Add\", \"ProductMessage>( this, async (recipient, message) => { await recipient.Dispatcher.DispatchAsync( asy\", \"nc () => { await recipient.badge.ScaleTo(1.2); await recipient.badge.ScaleTo(1.0); }); });\\n\\nIn the p\", \"receding example, the Register method subscribes to the AddProductMessage message and executes a cal\", \"lback delegate in response to receiving the message. This callback delegate, specified as a lambda e\", \"xpression, executes code that updates the UI.\\n\\nNote\\n\\nAvoid the use of this within your callback dele\", \"gate to avoid capturing that object within the delegate. This can help improve performance. Instead,\", \" use the recipient parameter.\\n\\nIf payload data is supplied, don\\u2019t attempt to modify the payload data\", \" from within a callback delegate because several threads could be accessing the received data simult\", \"aneously. In this scenario, the payload data should be immutable to avoid concurrency errors.\\n\\nUnsub\", \"scribing from a message\\n\\nSubscribers can unsubscribe from messages they no longer want to receive. T\", \"his is achieved with one of the IMessenger.Unregister overloads, as demonstrated in the following co\", \"de example:\\n\\nWeakReferenceMessenger.Default.Unregister<Messages.AddProductMessage>(this);\\n\\nNote\\n\\nIn \", \"this example, it isn\\u2019t fully necessary to call Unregister as the WeakReferenceMessenger will allow u\", \"nused objects to be garbage collected. If the StrongReferenceMessenger were used, it would be advise\", \"d to call Unregister for any subscriptions that are no longer in use.\\n\\nIn this example, the Unsubscr\", \"ibe method syntax specifies the type argument of the message and the recipient object that is listen\", \"ing for messages.\\n\\n30\\n\\nCHAPTER 5 | Communicating between loosely coupled components\\n\\nSummary\\n\\nThe MV\", \"VM Toolkit IMessenger interface describes the publish-subscribe pattern, allowing message- based com\", \"munication between components that are inconvenient to link by object and type references. This mech\", \"anism allows publishers and subscribers to communicate without having a reference to each other, hel\", \"ping to reduce dependencies between components, while also allowing components to be independently d\", \"eveloped and tested.\\n\\n31\\n\\nCHAPTER 5 | Communicating between loosely coupled components\\n\\nCHAPTER 6\\n\\nN\", \"avigation\\n\\n.NET MAUI includes support for page navigation, which typically results from the user\\u2019s i\", \"nteraction with the UI or from the app itself as a result of internal logic-driven state changes. Ho\", \"wever, navigation can be complex to implement in apps that use the Model-View-ViewModel (MVVM) patte\", \"rn, as the following challenges must be met:\\n\\n\\n\\nIdentifying the view to be navigated to using an app\", \"roach that does not introduce tight coupling and dependencies between views.\\n\\n\\n\\nCoordinating the pro\", \"cess by which the view to be navigated to is instantiated and initialized. When using MVVM, the view\", \" and view-model need to be instantiated and associated with each other via the view\\u2019s binding contex\", \"t. When an app is using a dependency injection container, the instantiation of views and view-models\", \" might require a specific construction mechanism.\\n\\nWhether to perform view-first navigation, or view\", \"-model-first navigation. With view-first\\n\\nnavigation, the page to navigate to refers to the name of \", \"the view type. During navigation, the specified view is instantiated, along with its corresponding v\", \"iew-model and other dependent services. An alternative approach is to use view-model-first navigatio\", \"n, where the page to navigate to refers to the name of the view-model type.\\n\\n\\n\\nDetermining how to cl\", \"eanly separate the navigational behavior of the app across the views and view-models. The MVVM patte\", \"rn separates the app\\u2019s UI and its presentation and business logic, but it doesn\\u2019t provide a direct m\", \"echanism for tying them together. However, the navigation behavior of an app will often span the UI \", \"and presentation parts of the app. The user will often initiate navigation from a view, and the view\", \" will be replaced as a result of the navigation. However, navigation might often also need to be ini\", \"tiated or coordinated from within the view-model.\\n\\n\\n\\nDetermining how to pass parameters during navig\", \"ation for initialization purposes. For example, if the user navigates to a view to update order deta\", \"ils, the order data will have to be passed to the view so that it can display the correct data.\\n\\n\\n\\nC\", \"oordinating navigation to ensure that specific business rules are obeyed. For example, users might b\", \"e prompted before navigating away from a view so that they can correct any invalid data or be prompt\", \"ed to submit or discard any data changes that were made within the view.\\n\\nThis chapter addresses the\", \"se challenges by presenting a navigation service class named MauiNavigationService that\\u2019s used to pe\", \"rform view-model-first page navigation.\\n\\nNote\\n\\nThe MauiNavigationService used by the app is simplist\", \"ic and does not cover all possible navigation types. The types of navigation needed by your applicat\", \"ion may require additional functionality.\\n\\n32\\n\\nCHAPTER 6 | Navigation\\n\\nNavigating between pages\\n\\nNav\", \"igation logic can reside in a view\\u2019s code-behind or a data-bound view-model. While placing navigatio\", \"n logic in a view might be the most straightforward approach, it is not easily testable through unit\", \" tests. Putting navigation logic in view-model classes means that the logic can be verified through \", \"unit tests. In addition, the view-model can then implement logic to control navigation to ensure tha\", \"t certain business rules are enforced. For example, an app might not allow the user to navigate away\", \" from a page without first ensuring that the entered data is valid.\\n\\nA navigation service is typical\", \"ly invoked from view-models, in order to promote testability. However, navigating to views from view\", \"-models would require the view-models to reference views, and particularly views that the active vie\", \"w-model isn\\u2019t associated with, which is not recommended. Therefore, the MauiNavigationService presen\", \"ted here specifies the view-model type as the target to navigate to.\\n\\nThe eShop multi-platform app u\", \"ses the MauiNavigationService class to provide view-model-first navigation. This class implements th\", \"e INavigationService interface, which is shown in the following code example:\\n\\npublic interface INav\", \"igationService { Task InitializeAsync();\\n\\nTask NavigateToAsync(string route, IDictionary<string, obj\", \"ect> routeParameters = null);\\n\\nTask PopAsync(); }\\n\\nThis interface specifies that an implementing cla\", \"ss must provide the following methods:\\n\\nMethod\\n\\nPurpose\\n\\nInitializeAsync\\n\\nPerforms navigation to one\", \" of two pages when the app is launched.\\n\\nNavigateToAsync(string route, IDictionary<string, object> r\", \"outeParameters = null)\\n\\nPerforms hierarchical navigation to a specified page using a registered navi\", \"gation route. Can optionally pass named route parameters to use for processing on the destination pa\", \"ge\\n\\nPopAsync\\n\\nRemoves the current page from the navigation stack.\\n\\nNote\\n\\nAn INavigationService inter\", \"face would usually also specify a GoBackAsync method, which is used to programmatically return to th\", \"e previous page in the navigation stack. However, this method is missing from the eShop multi-platfo\", \"rm app because it\\u2019s not required.\\n\\n33\\n\\nCHAPTER 6 | Navigation\\n\\nCreating the MauiNavigationService in\", \"stance\\n\\nThe MauiNavigationService class, which implements the INavigationService interface, is regis\", \"tered as a singleton with the dependency injection container in the MauiProgram.CreateMauiApp() meth\", \"od, as demonstrated in the following code example:\\n\\nmauiAppBuilder.Services.AddSingleton<INavigation\", \"Service, MauiNavigationService>();;\\n\\nThe INavigationService interface can then be resolved by adding\", \" it to the constructor of our views and view-models, as demonstrated in the following code example:\\n\", \"\\npublic AppShell(INavigationService navigationService)\\n\\nThis returns a reference to the MauiNavigati\", \"onService object that\\u2019s stored in the dependency injection container.\\n\\nThe ViewModelBase class store\", \"s the MauiNavigationService instance in a NavigationService property, of type INavigationService. Th\", \"erefore, all view-model classes, which derive from the ViewModelBase class, can use the NavigationSe\", \"rvice property to access the methods specified by the INavigationService interface.\\n\\nHandling naviga\", \"tion requests\\n\\n.NET MAUI provides multiple ways to navigate within an application. The traditional w\", \"ay to navigate is with the NavigationPage class, which implements a hierarchical navigation experien\", \"ce in which the user can navigate through pages, forward and backward, as desired. The eShop app use\", \"s the Shell component as the root container for the application and as a navigation host. For more i\", \"nformation about Shell navigation, see Shell Navigation on the Microsoft Developer Center.\\n\\nNavigati\", \"on is performed inside view-model classes by invoking one of the NavigateToAsync methods, specifying\", \" the route path for the page being navigated to, as demonstrated in the following code example:\\n\\nawa\", \"it NavigationService.NavigateToAsync(\\\"//Main\\\");\\n\\nThe following code example shows the NavigateToAsyn\", \"c method provided by the MauiNavigationService class:\\n\\npublic Task NavigateToAsync(string route, IDi\", \"ctionary<string, object> routeParameters = null) { return routeParameters != null ? Shell.Current.Go\", \"ToAsync(route, routeParameters) : Shell.Current.GoToAsync(route); }\\n\\nThe .NET MAUI Shell control is \", \"already familiar with route-based navigation, so the NavigateToAsync method works to mask this funct\", \"ionality. The NavigateToAsync method allows navigation data to be\\n\\n34\\n\\nCHAPTER 6 | Navigation\\n\\nspeci\", \"fied as an argument that\\u2019s passed to the view-model being navigated to, where it\\u2019s typically used to\", \" perform initialization. For more information, see Passing parameters during navigation.\\n\\nImportant\\n\", \"\\nThere are multiple ways to perform navigation in .NET MAUI. The MauiNavigationService is specifical\", \"ly build to work with Shell. If you are using a NavigationPage or TabbedPage or a different navigati\", \"on mechanism, this routing service would have to be updated to work using those components.\\n\\nIn orde\", \"r to register routes for the MauiNavigationService we need to supply route information from XAML or \", \"in the code-behind. The following example shows registration of routes via XAML.\\n\\n<?xml version=\\\"1.0\", \"\\\" encoding=\\\"UTF-8\\\" ?> <Shell xmlns=\\\"http://schemas.microsoft.com/dotnet/2021/maui\\\" xmlns:x=\\\"http://s\", \"chemas.microsoft.com/winfx/2009/xaml\\\" xmlns:views=\\\"clr-namespace:eShop.Views\\\" x:Class=\\\"eShop.AppShel\", \"l\\\">\\n\\n<!-- Omitted for brevity -->\\n\\n<FlyoutItem > <ShellContent x:Name=\\\"login\\\" ContentTemplate=\\\"{Data\", \"Template views:LoginView}\\\" Route=\\\"Login\\\" /> </FlyoutItem>\\n\\n<TabBar x:Name=\\\"main\\\" Route=\\\"Main\\\"> <Shel\", \"lContent Title=\\\"CATALOG\\\" Route=\\\"Catalog\\\" Icon=\\\"{StaticResource CatalogIconImageSource}\\\" ContentTempl\", \"ate=\\\"{DataTemplate views:CatalogView}\\\" /> <ShellContent Title=\\\"PROFILE\\\" Route=\\\"Profile\\\" Icon=\\\"{Stati\", \"cResource ProfileIconImageSource}\\\" ContentTemplate=\\\"{DataTemplate views:ProfileView}\\\" /> </TabBar> <\", \"/Shell>\\n\\nIn this example, the ShellContent and TabBar user interface objects are setting their Route\", \" property. This is the preferred method of registering routes for user interface objects that are co\", \"ntrolled by a Shell.\\n\\nIf we have objects that will be added to the navigation stack at a later time,\", \" then we will need to add those via code-behind. The following example show registration of routes i\", \"n code-behind.\\n\\nRouting.RegisterRoute(\\\"Filter\\\", typeof(FiltersView)); Routing.RegisterRoute(\\\"Basket\\\"\", \", typeof(BasketView));\\n\\nIn code-behind, we will call the Routing.RegisterRoute method which takes a \", \"route name as the first parameter and a view type as the second parameter. When a view-model uses th\", \"e NavigationService property to navigate, the application\\u2019s Shell object will look for registered ro\", \"utes and push them onto the navigation stack.\\n\\nAfter the view is created and navigated to, the Apply\", \"QueryAttributes and InitializeAsync methods of the view\\u2019s associated view-model are executed. For mo\", \"re information, see Passing parameters during navigation.\\n\\n35\\n\\nCHAPTER 6 | Navigation\\n\\nNavigating wh\", \"en the app is launched\\n\\nWhen the app is launched, a Shell object is set as the root view of the appl\", \"ication. Once set, the Shell will be used to control route registration and will be present at the r\", \"oot of our application going forward. Once the Shell has been created, we can wait for it to be atta\", \"ched to the application using the OnParentSet method to initialize our navigation route. The followi\", \"ng code example shows this method:\\n\\nprotected override async void OnParentSet() { base.OnParentSet()\", \";\\n\\nif (Parent is not null) { await _navigationService.InitializeAsync(); } }\\n\\nThe method uses an ins\", \"tance of INavigationService which is provided the constructor from dependency injection and invokes \", \"its InitializeAsync method.\\n\\nThe following code example shows the implementation of the MauiNavigati\", \"onService.InitializeAsync method:\\n\\npublic Task InitializeAsync() { return NavigateToAsync(string.IsN\", \"ullOrEmpty(_settingsService.AuthAccessToken) ? \\\"//Login\\\" : \\\"//Main/Catalog\\\"); }\\n\\nThe //Main/Catalog \", \"route is navigated to if the app has a cached access token, which is used for authentication. Otherw\", \"ise, the //Login route is navigated to.\\n\\nPassing parameters during navigation\\n\\nThe NavigateToAsync m\", \"ethod, specified by the INavigationService interface, enables navigation data to be specified as an \", \"IDictionary<string, object> of data that\\u2019s passed to the view-model being navigated to, where it\\u2019s t\", \"ypically used to perform initialization.\\n\\nFor example, the ProfileViewModel class contains an OrderD\", \"etailCommand that\\u2019s executed when the user selects an order on the ProfileView page. In turn, this e\", \"xecutes the OrderDetailAsync method, which is shown in the following code example:\\n\\nprivate async Ta\", \"sk OrderDetailAsync(Order order) { if (order is null) { return; }\\n\\nawait NavigationService.NavigateT\", \"oAsync( \\\"OrderDetail\\\",\\n\\n36\\n\\nCHAPTER 6 | Navigation\\n\\nnew Dictionary<string, object>{ { \\\"OrderNumber\\\",\", \" order.OrderNumber } }); }\\n\\nThis method invokes navigation to the OrderDetail route, passing order n\", \"umber information the order that the user selected. When the dependency injection framework creates \", \"the OrderDetailView for the OrderDetail route along with the OrderDetailViewModel class which is ass\", \"igned to the view\\u2019s BindingContext. The OrderDetailViewModel has an attribute added to it that allow\", \"s it to receive data from the navigation service as shown in the code example below.\\n\\n[QueryProperty\", \"(nameof(OrderNumber), \\\"OrderNumber\\\")] public class OrderDetailViewModel : ViewModelBase { public int\", \" OrderNumber { get; set; } }\\n\\nThe QueryProperty attribute allows us to provide a parameter for a pro\", \"perty to map values to and a key to find values from the query parameters dictionary. In this exampl\", \"e, the key \\u201cOrderNumber\\u201d and order number value were provided during the NavigateToAsync call. The v\", \"iew-model found the \\u201cOrderNumber\\u201d key and mapped the value to the OrderNumber property. The OrderNum\", \"ber property can then be used at a later time to retrieve the full order details from the OrderServi\", \"ce instance.\\n\\nInvoking navigation using behaviors\\n\\nNavigation is usually triggered from a view by a \", \"user interaction. For example, the LoginView performs navigation following successful authentication\", \". The following code example shows how the navigation is invoked by a behavior:\\n\\n<WebView> <WebView.\", \"Behaviors> <behaviors:EventToCommandBehavior EventName=\\\"Navigating\\\" EventArgsConverter=\\\"{StaticResou\", \"rce WebNavigatingEventArgsConverter}\\\" Command=\\\"{Binding NavigateCommand}\\\" /> </WebView.Behaviors> </\", \"WebView>\\n\\nAt runtime, the EventToCommandBehavior will respond to interaction with the WebView. When \", \"the WebView navigates to a web page, the Navigating event will fire, which will execute the Navigate\", \"Command in the LoginViewModel. By default, the event arguments for the event are passed to the comma\", \"nd. This data is converted as it\\u2019s passed between source and target by the converter specified in th\", \"e EventArgsConverter property, which returns the Url from the WebNavigatingEventArgs. Therefore, whe\", \"n the NavigationCommand is executed, the Url of the web page is passed as a parameter to the registe\", \"red Action.\\n\\nIn turn, the NavigationCommand executes the NavigateAsync method, which is shown in the\", \" following code example:\\n\\nprivate async Task NavigateAsync(string url) { // Omitted for brevity. if \", \"(!string.IsNullOrWhiteSpace(accessToken)) {\\n\\n37\\n\\nCHAPTER 6 | Navigation\\n\\n_settingsService.AuthAccess\", \"Token = accessToken; _settingsService.AuthIdToken = authResponse.IdentityToken; await NavigationServ\", \"ice.NavigateToAsync(\\\"//Main/Catalog\\\"); } }\\n\\nThis method invokes NavigationService route the applicat\", \"ion to the //Main/Catalog route.\\n\\nConfirming or cancelling navigation\\n\\nAn app might need to interact\", \" with the user during a navigation operation, so that the user can confirm or cancel navigation. Thi\", \"s might be necessary, for example, when the user attempts to navigate before having fully completed \", \"a data entry page. In this situation, an app should provide a notification that allows the user to n\", \"avigate away from the page, or to cancel the navigation operation before it occurs. This can be achi\", \"eved in a view-model class by using the response from a notification to control whether or not navig\", \"ation is invoked.\\n\\nSummary\\n\\n.NET MAUI includes support for page navigation, which typically results \", \"from the user\\u2019s interaction with the UI, or from the app itself, as a result of internal logic-drive\", \"n state changes. However, navigation can be complex to implement in apps that use the MVVM pattern.\\n\", \"\\nThis chapter presented a NavigationService class, which is used to perform view-model-first navigat\", \"ion from view-models. Placing navigation logic in view-model classes means that the logic can be exe\", \"rcised through automated tests. In addition, the view-model can then implement logic to control navi\", \"gation to ensure that certain business rules are enforced.\\n\\n38\\n\\nCHAPTER 6 | Navigation\\n\\nCHAPTER 7\\n\\nV\", \"alidation\\n\\nAny app that accepts input from users should ensure that the input is valid. An app could\", \", for example, check for input that contains only characters in a particular range, is of a certain \", \"length, or matches a particular format. Without validation, a user can supply data that causes the a\", \"pp to fail. Proper validation enforces business rules and could help to prevent an attacker from inj\", \"ecting malicious data.\\n\\nIn the context of the Model-View-ViewModel (MVVM) pattern, a view model or m\", \"odel will often be required to perform data validation and signal any validation errors to the view \", \"so that the user can correct them. The eShop multi-platform app performs synchronous client-side val\", \"idation of view model properties and notifies the user of any validation errors by highlighting the \", \"control that contains the invalid data, and by displaying error messages that inform the user of why\", \" the data is invalid. The image below shows the classes involved in performing validation in the eSh\", \"op multi- platform app.\\n\\nView model properties that require validation are of type ValidatableObject\", \"<T>, and each ValidatableObject<T> instance has validation rules added to its Validations property. \", \"Validation is\\n\\n39\\n\\nCHAPTER 7 | Validation\\n\\ninvoked from the view model by calling the Validate metho\", \"d of the ValidatableObject<T> instance, which retrieves the validation rules and executes them again\", \"st the ValidatableObject<T>.Value property. Any validation errors are placed into the Errors propert\", \"y of the ValidatableObject<T> instance, and the IsValid property of the ValidatableObject<T> instanc\", \"e is updated to indicate whether the validation succeeded or failed. The following code shows the im\", \"plementation of the ValidatableObject<T>:\\n\\nusing CommunityToolkit.Mvvm.ComponentModel; namespace eSh\", \"op.Validations; public class ValidatableObject<T> : ObservableObject, IValidity { private IEnumerabl\", \"e<string> _errors; private bool _isValid; private T _value; public List<IValidationRule<T>> Validati\", \"ons { get; } = new(); public IEnumerable<string> Errors { get => _errors; private set => SetProperty\", \"(ref _errors, value); } public bool IsValid { get => _isValid; private set => SetProperty(ref _isVal\", \"id, value); } public T Value { get => _value; set => SetProperty(ref _value, value); } public Valida\", \"tableObject() { _isValid = true; _errors = Enumerable.Empty<string>(); } public bool Validate() { Er\", \"rors = Validations ?.Where(v => !v.Check(Value)) ?.Select(v => v.ValidationMessage) ?.ToArray() ?? E\", \"numerable.Empty<string>(); IsValid = !Errors.Any(); return IsValid; } }\\n\\nProperty change notificatio\", \"n is provided by the ObservableObject class, and so an Entry control can bind to the IsValid propert\", \"y of ValidatableObject<T> instance in the view model class to be notified of whether or not the ente\", \"red data is valid.\\n\\nSpecifying validation rules\\n\\nValidation rules are specified by creating a class \", \"that derives from the IValidationRule<T> interface, which is shown in the following code example:\\n\\n4\", \"0\\n\\nCHAPTER 7 | Validation\\n\\npublic interface IValidationRule<T> { string ValidationMessage { get; set\", \"; } bool Check(T value); }\\n\\nThis interface specifies that a validation rule class must provide a boo\", \"lean Check method that is used to perform the required validation, and a ValidationMessage property \", \"whose value is the validation error message that will be displayed if validation fails.\\n\\nThe followi\", \"ng code example shows the IsNotNullOrEmptyRule<T> validation rule, which is used to perform validati\", \"on of the username and password entered by the user on the LoginView when using mock services in the\", \" eShop multi-platform app:\\n\\npublic class IsNotNullOrEmptyRule<T> : IValidationRule<T> { public strin\", \"g ValidationMessage { get; set; }\\n\\npublic bool Check(T value) => value is string str && !string.IsNu\", \"llOrWhiteSpace(str); }\\n\\nThe Check method returns a boolean indicating whether the value argument is \", \"null, empty, or consists only of whitespace characters.\\n\\nAlthough not used by the eShop multi-platfo\", \"rm app, the following code example shows a validation rule for validating email addresses:\\n\\npublic c\", \"lass EmailRule<T> : IValidationRule<T> { private readonly Regex _regex = new(@\\\"^([w.-]+)@([w-]+)((.(\", \"w){2,3})+)$\\\");\\n\\npublic string ValidationMessage { get; set; }\\n\\npublic bool Check(T value) => value i\", \"s string str && _regex.IsMatch(str); }\\n\\nThe Check method returns a boolean indicating whether or not\", \" the value argument is a valid email address. This is achieved by searching the value argument for t\", \"he first occurrence of the regular expression pattern specified in the Regex constructor. Whether th\", \"e regular expression pattern has been found in the input string can be determined by checking the va\", \"lue against Regex.IsMatch.\\n\\nNote\\n\\nProperty validation can sometimes involve dependent properties. An\", \" example of dependent properties is when the set of valid values for property A depends on the parti\", \"cular value that has been set in property B. To check that the value of property A is one of the all\", \"owed values would involve retrieving the value of property B. In addition, when the value of propert\", \"y B changes, property A would need to be revalidated.\\n\\n41\\n\\nCHAPTER 7 | Validation\\n\\nAdding validation\", \" rules to a property\\n\\nIn the eShop multi-platform app, view model properties that require validation\", \" are declared to be of type ValidatableObject<T>, where T is the type of the data to be validated. T\", \"he following code example shows an example of two such properties:\\n\\npublic ValidatableObject<string>\", \" UserName { get; private set; } public ValidatableObject<string> Password { get; private set; } For \", \"validation to occur, validation rules must be added to the Validations collection of each Validatabl\", \"eObject<T> instance, as demonstrated in the following code example: private void AddValidations() { \", \"UserName.Validations.Add(new IsNotNullOrEmptyRule<string> { ValidationMessage = \\\"A username is requi\", \"red.\\\" });\\n\\nPassword.Validations.Add(new IsNotNullOrEmptyRule<string> { ValidationMessage = \\\"A passwo\", \"rd is required.\\\" }); }\\n\\nThis method adds the IsNotNullOrEmptyRule<T> validation rule to the Validati\", \"ons collection of each ValidatableObject<T> instance, specifying values for the validation rule\\u2019s Va\", \"lidationMessage property, which specifies the validation error message that will be displayed if val\", \"idation fails.\\n\\nTriggering validation\\n\\nThe validation approach used in the eShop multi-platform app \", \"can manually trigger validation of a property, and automatically trigger validation when a property \", \"changes.\\n\\nTriggering validation manually\\n\\nValidation can be triggered manually for a view model prop\", \"erty. For example, this occurs in the eShop multi-platform app when the user taps the Login button o\", \"n the LoginView, when using mock services. The command delegate calls the MockSignInAsync method in \", \"the LoginViewModel, which invokes validation by executing the Validate method, which is shown in the\", \" following code example:\\n\\nprivate bool Validate() { bool isValidUser = ValidateUserName(); bool isVa\", \"lidPassword = ValidatePassword(); return isValidUser && isValidPassword; }\\n\\nprivate bool ValidateUse\", \"rName() { return _userName.Validate(); }\\n\\nprivate bool ValidatePassword() {\\n\\n42\\n\\nCHAPTER 7 | Validat\", \"ion\\n\\nreturn _password.Validate(); }\\n\\nThe Validate method performs validation of the username and pas\", \"sword entered by the user on the LoginView, by invoking the Validate method on each ValidatableObjec\", \"t<T> instance. The following code example shows the Validate method from the ValidatableObject<T> cl\", \"ass:\\n\\npublic bool Validate() { Errors = _validations ?.Where(v => !v.Check(Value)) ?.Select(v => v.V\", \"alidationMessage) ?.ToArray() ?? Enumerable.Empty<string>();\\n\\nIsValid = !Errors.Any();\\n\\nreturn IsVal\", \"id; }\\n\\nThis method retrieves any validation rules that were added to the object\\u2019s Validations collec\", \"tion. The Check method for each retrieved validation rule is executed, and the ValidationMessage pro\", \"perty value for any validation rule that fails to validate the data is added to the Errors collectio\", \"n of the ValidatableObject<T> instance. Finally, the IsValid property is set, and its value is retur\", \"ned to the calling method, indicating whether validation succeeded or failed.\\n\\nTriggering validation\", \" when properties change\\n\\nValidation is also automatically triggered whenever a bound property change\", \"s. For example, when a two-way binding in the LoginView sets the UserName or Password property, vali\", \"dation is triggered. The following code example demonstrates how this occurs:\\n\\n<Entry Text=\\\"{Binding\", \" UserName.Value, Mode=TwoWay}\\\"> <Entry.Behaviors> <behaviors:EventToCommandBehavior EventName=\\\"TextC\", \"hanged\\\" Command=\\\"{Binding ValidateUserNameCommand}\\\" /> </Entry.Behaviors> </Entry>\\n\\nThe Entry contro\", \"l binds to the UserName.Value property of the ValidatableObject<T> instance, and the control\\u2019s Behav\", \"iors collection has an EventToCommandBehavior instance added to it. This behavior executes the Valid\", \"ateUserNameCommand in response to the TextChanged event firing on the Entry, which is raised when th\", \"e text in the Entry changes. In turn, the ValidateUserNameCommand delegate executes the ValidateUser\", \"Name method, which executes the Validate method on the ValidatableObject<T> instance. Therefore, eve\", \"ry time the user enters a character in the Entry control for the username, validation of the entered\", \" data is performed.\\n\\nDisplaying validation errors\\n\\nThe eShop multi-platform app notifies the user of\", \" any validation errors by highlighting the control that contains the invalid data with a red backgro\", \"und, and by displaying an error message that informs\\n\\n43\\n\\nCHAPTER 7 | Validation\\n\\nthe user why the d\", \"ata is invalid below the control containing the invalid data. When the invalid data is corrected, th\", \"e background changes back to the default state and the error message is removed. The image below sho\", \"ws the LoginView in the eShop multi-platform app when validation errors are present.\\n\\nHighlighting a\", \" control that contains invalid data\\n\\n.NET MAUI offers a number of ways to present validation informa\", \"tion to end-users, but one of the most straight-forward ways is through the use of Triggers. Trigger\", \"s provide us a way to change the state of our controls, typically for appearance, based on an event \", \"or data change that occurs for a control. For validation, we will be using a DataTrigger which will \", \"listen to changes raised from a bound property and respond to the changes. The Entry controls on the\", \" LoginView are setup using the following code:\\n\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\">\", \" <Entry.Style> <OnPlatform x:TypeArguments=\\\"Style\\\"> <On Platform=\\\"iOS, Android\\\" Value=\\\"{StaticResour\", \"ce EntryStyle}\\\" /> <On Platform=\\\"WinUI\\\" Value=\\\"{StaticResource WinUIEntryStyle}\\\" /> </OnPlatform> </\", \"Entry.Style> <Entry.Behaviors> <mct:EventToCommandBehavior EventName=\\\"TextChanged\\\" Command=\\\"{Binding\", \" ValidateCommand}\\\" /> </Entry.Behaviors> <Entry.Triggers> <DataTrigger TargetType=\\\"Entry\\\" Binding=\\\"{\", \"Binding UserName.IsValid}\\\" Value=\\\"False\\\"> <Setter Property=\\\"BackgroundColor\\\" Value=\\\"{StaticResource \", \"ErrorColor}\\\" /> </DataTrigger> </Entry.Triggers> </Entry>\\n\\nThe DataTrigger specifies the following p\", \"roperties:\\n\\n44\\n\\nCHAPTER 7 | Validation\\n\\nProperty\\n\\nDescription\\n\\nTargetType\\n\\nThe control type that the\", \" trigger belongs to.\\n\\nBinding\\n\\nThe data Binding markup which will provide change notifications and v\", \"alue for the trigger condition.\\n\\nValue\\n\\nThe data value to specify when the trigger\\u2019s condition has b\", \"een met.\\n\\nFor this Entry, we will be listening for changes to the LoginViewModel.UserName.IsValid pr\", \"operty. Each time this property raises a change, the value will be compared against the Value proper\", \"ty set in the DataTrigger. If the values are equal, then the trigger condition will be met and any S\", \"etter objects provided to the DataTrigger will be executed. This control has a single Setter object \", \"that updates the BackgroundColor property to a custom color defined using the StaticResource markup.\", \" When a Trigger condition is no longer met, the control will revert the properties set by the Setter\", \" object to their previous state. For more information about Triggers, see .NET MAUI Docs: Triggers.\\n\", \"\\nDisplaying error messages\\n\\nThe UI displays validation error messages in Label controls below each c\", \"ontrol whose data failed validation. The following code example shows the Label that displays a vali\", \"dation error message, if the user has not entered a valid username:\\n\\n<Label\\n\\nText=\\\"{Binding UserName\", \".Errors, Converter={StaticResource FirstValidationErrorConverter}\\\" Style=\\\"{StaticResource Validation\", \"ErrorLabelStyle}\\\" />\\n\\nEach Label binds to the Errors property of the view model object that\\u2019s being \", \"validated. The Errors property is provided by the ValidatableObject<T> class, and is of type IEnumer\", \"able<string>. Because the Errors property can contain multiple validation errors, the FirstValidatio\", \"nErrorConverter instance is used to retrieve the first error from the collection for display.\\n\\nSumma\", \"ry\\n\\nThe eShop multi-platform app performs synchronous client-side validation of view model propertie\", \"s and notifies the user of any validation errors by highlighting the control that contains the inval\", \"id data, and by displaying error messages that inform the user why the data is invalid.\\n\\nView model \", \"properties that require validation are of type ValidatableObject<T>, and each ValidatableObject<T> i\", \"nstance has validation rules added to its Validations property. Validation is invoked from the view \", \"model by calling the Validate method of the ValidatableObject<T> instance, which retrieves the valid\", \"ation rules and executes them against the ValidatableObject<T> Value property. Any validation errors\", \" are placed into the Errors property of the ValidatableObject<T> instance, and the IsValid property \", \"of the ValidatableObject<T> instance is updated to indicate whether validation succeeded or failed.\\n\", \"\\n45\\n\\nCHAPTER 7 | Validation\\n\\nCHAPTER 8\\n\\nApplication settings management\\n\\nSettings allow the separati\", \"on of data that configures the behavior of an app from the code, allowing the behavior to be changed\", \" without rebuilding the app. There are two types of settings: app settings and user settings.\\n\\nApp s\", \"ettings are data that an app creates and manages. It can include data such as fixed web service endp\", \"oints, API keys, and runtime state. App settings are tied to core functionality and are only meaning\", \"ful to that app.\\n\\nUser settings are the customizable settings of an app that affect the app\\u2019s behavi\", \"or and don\\u2019t require frequent re-adjustment. For example, an app might let the user specify where to\", \" retrieve data and how to display it on the screen.\\n\\nCreating a Settings Interface\\n\\nWhile the prefer\", \"ences manager can be used directly in your application, it does come with the drawback of making you\", \"r application tightly coupled to the preferences manager implementation. This coupling means that cr\", \"eating unit tests or extending the functionality of preferences management will be limited since you\", \"r application will not have a direct way to intercept the behavior. To address this concern, an inte\", \"rface can be created to work as a proxy for preferences management. The interface will allow us to s\", \"upply an implementation that fits our needs. For example, when writing a unit test, we may want to s\", \"et specific settings, and the interface will give us an easy way to consistently set this data for t\", \"he test. The following code example shows the ISettingsService interface in the eShop multi-platform\", \" app:\\n\\nnamespace eShop.Services.Settings;\\n\\npublic interface ISettingsService { string AuthAccessToke\", \"n { get; set; } string AuthIdToken { get; set; } bool UseMocks { get; set; } string IdentityEndpoint\", \"Base { get; set; } string GatewayShoppingEndpointBase { get; set; } string GatewayMarketingEndpointB\", \"ase { get; set; } bool UseFakeLocation { get; set; } string Latitude { get; set; } string Longitude \", \"{ get; set; }\\n\\n46\\n\\nCHAPTER 8 | Application settings management\\n\\nbool AllowGpsLocation { get; set; } \", \"}\\n\\nAdding Settings\\n\\n.NET MAUI includes a preferences manager that provides a way to store runtime se\", \"ttings for a user. This feature can be accessed from anywhere within your application using the Micr\", \"osoft.Maui.Storage.Preferences class. The preferences manager provides a consistent, type-safe, cros\", \"s-platform approach for persisting and retrieving app and user settings, while using the native sett\", \"ings management provided by each platform. In addition, it\\u2019s straightforward to use data binding to \", \"access settings data exposed by the library. For more information, see the Preferences on the Micros\", \"oft Developer Center.\\n\\nTip\\n\\nPreferences is meant for storing relatively small data. If you need to s\", \"tore larger or more complex data, consider using a local database or filesystem to store the data.\\n\\n\", \"Our application will use the Preferences class need to implement the ISettingsService interface. The\", \" code below shows how the eShop multi-platform app\\u2019s SettingsService implements the AuthTokenAccess \", \"and UseMocks properties:\\n\\npublic sealed class SettingsService : ISettingsService { private const str\", \"ing AccessToken = \\\"access_token\\\"; private const string AccessTokenDefault = string.Empty;\\n\\nprivate c\", \"onst string IdUseMocks = \\\"use_mocks\\\"; private const bool UseMocksDefault = true;\\n\\npublic string Auth\", \"AccessToken { get => Preferences.Get(AccessToken, AccessTokenDefault); set => Preferences.Set(Access\", \"Token, value); }\\n\\npublic bool UseMocks { get => Preferences.Get(IdUseMocks, UseMocksDefault); set =>\", \" Preferences.Set(IdUseMocks, value); } }\\n\\nEach setting consists of a private key, a private default \", \"value, and a public property. The key is always a const string that defines a unique name, with the \", \"default value for the setting being a static read- only or constant value of the required type. Prov\", \"iding a default value ensures that a valid value is available if an unset setting is retrieved. This\", \" service implementation can be provided via dependency injection to our application for use in view-\", \"models or other services throughout the application.\\n\\n47\\n\\nCHAPTER 8 | Application settings managemen\", \"t\\n\\nData binding to user settings\\n\\nIn the eShop multi-platform app, the SettingsView exposes multiple\", \" settings the user can configure at runtime. These settings include allowing configuration of whethe\", \"r the app should retrieve data from microservices deployed as Docker containers or whether the app s\", \"hould retrieve data from mock services that don\\u2019t require an internet connection. When retrieving da\", \"ta from containerized microservices, a base endpoint URL for the microservices must be specified. Th\", \"e image below shows the SettingsView when the user has chosen to retrieve data from containerized mi\", \"croservices.\\n\\nData binding can be used to retrieve and set settings exposed by the ISettingService i\", \"nterface. This is achieved by controls on the view binding to view model properties that in turn acc\", \"ess properties in the ISettingService interface and raising a property changed notification if the v\", \"alue has changed.\\n\\nThe following code example shows the Entry control from the SettingsView that all\", \"ows the user to enter a base identity endpoint URL for the containerized microservices:\\n\\n<Entry Text\", \"=\\\"{Binding IdentityEndpoint, Mode=TwoWay}\\\" />\\n\\nThis Entry control binds to the IdentityEndpoint prop\", \"erty of the SettingsViewModel class, using a two- way binding. The following code example shows the \", \"IdentityEndpoint property:\\n\\nprivate readonly ISettingsService _settingsService;\\n\\nprivate string _ide\", \"ntityEndpoint;\\n\\npublic SettingsViewModel( ILocationService locationService, IAppEnvironmentService a\", \"ppEnvironmentService, IDialogService dialogService, INavigationService navigationService, ISettingsS\", \"ervice settingsService) : base(dialogService, navigationService, settingsService) { _settingsService\", \" = settingsService;\\n\\n_identityEndpoint = _settingsService.IdentityEndpointBase; }\\n\\npublic string Ide\", \"ntityEndpoint\\n\\n48\\n\\nCHAPTER 8 | Application settings management\\n\\n{ get => _identityEndpoint; set { Se\", \"tProperty(ref _identityEndpoint, value);\\n\\nif (!string.IsNullOrWhiteSpace(value)) { UpdateIdentityEnd\", \"point(); } } }\\n\\nWhen the IdentityEndpoint property is set, the UpdateIdentityEndpoint method is call\", \"ed, provided that the supplied value is valid. The following code example shows the UpdateIdentityEn\", \"dpoint method:\\n\\nprivate void UpdateIdentityEndpoint() { _settingsService.IdentityEndpointBase = _ide\", \"ntityEndpoint; }\\n\\nThis method updates the IdentityEndpointBase property in the ISettingService inter\", \"face implementation with the base endpoint URL value entered by the user. If the SettingsService cla\", \"ss is provided as the implementation for _settingsService, the value will persist to platform-specif\", \"ic storage.\\n\\nSummary\\n\\nSettings allow the separation of data that configures the behavior of an app f\", \"rom the code, allowing the behavior to be changed without rebuilding the app. App settings are data \", \"that an app creates and manages, and user settings are the customizable settings of an app that affe\", \"ct the app\\u2019s behavior and don\\u2019t require frequent re-adjustment.\\n\\nThe Microsoft.Maui.Storage.Preferen\", \"ces class provides a consistent, type-safe, cross-platform approach for persisting and retrieving ap\", \"p and user settings.\\n\\n49\\n\\nCHAPTER 8 | Application settings management\\n\\nCHAPTER 9\\n\\nContainerized micr\", \"oservices\\n\\nDeveloping client-server applications has resulted in a focus on building tiered applicat\", \"ions that use specific technologies in each tier. Such applications are often referred to as monolit\", \"hic and are packaged onto hardware pre-scaled for peak loads. The main drawbacks of this development\", \" approach are the tight coupling between components within each tier, that individual components can\", \"\\u2019t be easily scaled, and the cost of testing. A simple update can have unforeseen effects on the res\", \"t of the tier, so a change to an application component requires its entire tier to be retested and r\", \"edeployed.\\n\\nParticularly concerning, in the age of the cloud, is that individual components can\\u2019t be\", \" easily scaled. A monolithic application contains domain-specific functionality and is typically div\", \"ided by functional layers such as front-end, business logic, and data storage. The image below illus\", \"trates that a monolithic application is scaled by cloning the entire application onto multiple machi\", \"nes.\\n\\n50\\n\\nCHAPTER 9 | Containerized microservices\\n\\nMicroservices\\n\\nMicroservices offer a different ap\", \"proach to application development and deployment, an approach that\\u2019s suited to the agility, scale, a\", \"nd reliability requirements of modern cloud applications. A microservices application is split into \", \"independent components that work together to deliver the application\\u2019s overall functionality. The te\", \"rm microservice emphasizes that applications should be composed of services small enough to reflect \", \"particular concerns, so each microservice implements a single function. In addition, each microservi\", \"ce has well-defined contracts with which other microservices communicate and share data. Typical exa\", \"mples of microservices include shopping carts, inventory processing, purchase subsystems, and paymen\", \"t processing.\\n\\nMicroservices can scale independently compared to giant monolithic applications that \", \"scale together. This means that a specific functional area that requires more processing power or ne\", \"twork bandwidth to support demand can be scaled rather than unnecessarily scaling out other applicat\", \"ion areas. The image below illustrates this approach, where microservices are deployed and scaled in\", \"dependently, creating instances of services across machines.\\n\\n51\\n\\nCHAPTER 9 | Containerized microser\", \"vices\\n\\nMicroservice scale-out can be nearly instantaneous, allowing an application to adapt to chang\", \"ing loads. For example, a single microservice in the web-facing functionality of an application migh\", \"t be the only microservice that needs to scale out to handle additional incoming traffic.\\n\\nThe class\", \"ic model for application scalability is to have a load-balanced, stateless tier with a shared extern\", \"al datastore to store persistent data. Stateful microservices manage their own persistent data, usua\", \"lly storing it locally on the servers on which they are placed, to avoid the overhead of network acc\", \"ess and complexity of cross-service operations. This enables the fastest possible processing of data\", \" and can eliminate the need for caching systems. In addition, scalable stateful microservices usuall\", \"y partition data among their instances, in order to manage data size and transfer throughput beyond \", \"which a single server can support.\\n\\nMicroservices also support independent updates. This loose coupl\", \"ing between microservices provides a rapid and reliable application evolution. Their independent, di\", \"stributed nature helps rolling updates, where only a subset of instances of a single microservice wi\", \"ll update at any given time. Therefore, if a problem is detected, a buggy update can be rolled back,\", \" before all instances update with the faulty code or configuration. Similarly, microservices typical\", \"ly use schema versioning, so that clients see a consistent version when updates are being applied, r\", \"egardless of which microservice instance is being communicated with.\\n\\nTherefore, microservice applic\", \"ations have many benefits over monolithic applications:\\n\\n\\n\\nEach microservice is relatively small, ea\", \"sy to manage and evolve.\\n\\n\\n\\nEach microservice can be developed and deployed independently of other s\", \"ervices.\\n\\n\\n\\nEach microservice can be scaled-out independently. For example, a catalog service or sho\", \"pping basket service might need to be scaled-out more than an ordering service.\\n\\n52\\n\\nCHAPTER 9 | Con\", \"tainerized microservices\\n\\nTherefore, the resulting infrastructure will more efficiently consume reso\", \"urces when scaling out.\\n\\n\\n\\nEach microservice isolates any issues. For example, if there is an issue \", \"in a service it only impacts that service. The other services can continue to handle requests.\\n\\n\\n\\nEa\", \"ch microservice can use the latest technologies. Because microservices are autonomous and run side-b\", \"y-side, the latest technologies and frameworks can be used, rather than being forced to use an older\", \" framework that might be used by a monolithic application.\\n\\nHowever, a microservice-based solution a\", \"lso has potential drawbacks:\\n\\n\\n\\nChoosing how to partition an application into microservices can be c\", \"hallenging, as each microservice has to be completely autonomous, end-to-end, including responsibili\", \"ty for its data sources.\\n\\n\\n\\nDevelopers must implement inter-service communication, which adds comple\", \"xity and latency to the application.\\n\\n\\n\\nAtomic transactions between multiple microservices usually a\", \"ren\\u2019t possible. Therefore, business requirements must embrace eventual consistency between microserv\", \"ices.\\n\\n\\n\\nIn production, there is an operational complexity in deploying and managing a system compro\", \"mised of many independent services.\\n\\n\\n\\nDirect client-to-microservice communication can make it diffi\", \"cult to refactor the contracts of microservices. For example, over time how the system is partitione\", \"d into services might need to change. A single service might split into two or more services, and tw\", \"o services might merge. When clients communicate directly with microservices, this refactoring work \", \"can break compatibility with client apps.\\n\\nContainerization\\n\\nContainerization is an approach to soft\", \"ware development in which an application and its versioned set of dependencies, plus its environment\", \" configuration abstracted as deployment manifest files, are packaged together as a container image, \", \"tested as a unit, and deployed to a host operating system.\\n\\nA container is an isolated, resource con\", \"trolled, and portable operating environment, where an application can run without touching the resou\", \"rces of other containers, or the host. Therefore, a container looks and acts like a newly installed \", \"physical computer or a virtual machine.\\n\\nThere are many similarities between containers and virtual \", \"machines, as illustrated below.\\n\\n53\\n\\nCHAPTER 9 | Containerized microservices\\n\\nA container runs an op\", \"erating system, has a file system, and can be accessed over a network as if it were a physical or vi\", \"rtual machine. However, the technology and concepts used by containers are very different from virtu\", \"al machines. Virtual machines include the applications, the required dependencies, and a full guest \", \"operating system. Containers include the application and its dependencies, but share the operating s\", \"ystem with other containers, running as isolated processes on the host operating system (aside from \", \"Hyper-V containers which run inside of a special virtual machine per container). Therefore, containe\", \"rs share resources and typically require fewer resources than virtual machines.\\n\\nThe advantage of a \", \"container-oriented development and deployment approach is that it eliminates most of the issues that\", \" arise from inconsistent environment setups and the problems that come with them. In addition, conta\", \"iners permit fast application scale-up functionality by instancing new containers as required.\\n\\nThe \", \"key concepts when creating and working with containers are:\\n\\nConcept\\n\\nDescription\\n\\nContainer Host\\n\\nT\", \"he physical or virtual machine configured to host containers. The container host will run one or mor\", \"e containers.\\n\\nContainer Image\\n\\nAn image consists of a union of layered filesystems stacked on top o\", \"f each other, and is the basis of a container. An image does not have state and it never changes as \", \"it\\u2019s deployed to different environments.\\n\\nContainer\\n\\nA container is a runtime instance of an image.\\n\", \"\\n54\\n\\nCHAPTER 9 | Containerized microservices\\n\\nConcept\\n\\nDescription\\n\\nContainer OS Image\\n\\nContainers a\", \"re deployed from images. The container operating system image is the first layer in potentially many\", \" image layers that make up a container. A container operating system is immutable, and can\\u2019t be modi\", \"fied.\\n\\nContainer Repository\\n\\nEach time a container image is created, the image and its dependencies \", \"are stored in a local repository. These images can be reused many times on the container host. The c\", \"ontainer images can also be stored in a public or private registry, such as Docker Hub, so that they\", \" can be used across different container hosts.\\n\\nEnterprises are increasingly adopting containers whe\", \"n implementing microservice-based applications, and Docker has become the standard container impleme\", \"ntation that has been adopted by most software platforms and cloud vendors.\\n\\nThe eShop reference app\", \"lication uses Docker to host four containerized back-end microservices, as illustrated in the diagra\", \"m below.\\n\\n55\\n\\nCHAPTER 9 | Containerized microservices\\n\\nThe architecture of the back-end services in \", \"the reference application is decomposed into multiple autonomous sub-systems in the form of collabor\", \"ating microservices and containers. Each microservice provides a single area of functionality: an id\", \"entity service, a catalog service, an ordering service, and a basket service.\\n\\nEach microservice has\", \" its own database, allowing it to be fully decoupled from the other microservices. Where necessary, \", \"consistency between databases from different microservices is achieved using application-level event\", \"s. For more information, see Communication between microservices.\\n\\nCommunication between client and \", \"microservices\\n\\nThe eShop multi-platform app communicates with the containerized back-end microservic\", \"es using direct client-to-microservice communication, as shown below.\\n\\n56\\n\\nCHAPTER 9 | Containerized\", \" microservices\\n\\nWith direct client-to-microservice communication, the multi-platform app makes reque\", \"sts to each microservice directly through its public endpoint, with a different TCP port per microse\", \"rvice. In production, the endpoint would typically map to the microservice\\u2019s load balancer, which di\", \"stributes requests across the available instances.\\n\\nTip\\n\\nConsider using API gateway communication.\\n\\n\", \"Direct client-to-microservice communication can have drawbacks when building a large and complex mic\", \"roservice-based application, but it\\u2019s more than adequate for a small application. Consider using API\", \" gateway communication when designing a large microservice-based application with tens of microservi\", \"ces.\\n\\nCommunication between microservices\\n\\nA microservices-based application is a distributed system\", \", potentially running on multiple machines. Each service instance is typically a process. Therefore,\", \" services must interact using an inter-process communication protocol, such as HTTP, TCP, Advanced M\", \"essage Queuing Protocol (AMQP), or binary protocols, depending on the nature of each service.\\n\\nThe t\", \"wo common approaches for microservice-to-microservice communication are HTTP-based REST communicatio\", \"n when querying for data, and lightweight asynchronous messaging when communicating updates across m\", \"ultiple microservices.\\n\\nAsynchronous messaging-based event-driven communication is critical when pro\", \"pagating changes across multiple microservices. With this approach, a microservice publishes an even\", \"t when something notable happens, for example, when it updates a business entity. Other microservice\", \"s subscribe to these events. Then, when a microservice receives an event, it updates its own busines\", \"s entities, which might, in turn, lead to more events being published. This publish-subscribe functi\", \"onality is usually achieved with an event bus.\\n\\n57\\n\\nCHAPTER 9 | Containerized microservices\\n\\nAn even\", \"t bus allows publish-subscribe communication between microservices without requiring the components \", \"to be explicitly aware of each other, as shown below.\\n\\nFrom an application perspective, the event bu\", \"s is simply a publish-subscribe channel exposed via an interface. However, the way the event bus is \", \"implemented can vary. For example, an event bus implementation could use RabbitMQ, Azure Service Bus\", \", or other service buses such as NServiceBus and MassTransit. The diagram below shows how an event b\", \"us is used in the eShop reference application.\\n\\nThe eShop event bus, implemented using RabbitMQ, pro\", \"vides one-to-many asynchronous publish- subscribe functionality. This means that after publishing an\", \" event, there can be multiple subscribers listening for the same event. The diagram below illustrate\", \"s this relationship.\\n\\n58\\n\\nCHAPTER 9 | Containerized microservices\\n\\nThis one-to-many communication ap\", \"proach uses events to implement business transactions that span multiple services, ensuring eventual\", \" consistency between the services. An eventual-consistent transaction consists of a series of distri\", \"buted steps. Therefore, when the user-profile microservice receives the UpdateUser command, it updat\", \"es the user\\u2019s details in its database and publishes the UserUpdated event to the event bus. Both the\", \" basket microservice and the ordering microservice have subscribed to receive this event, and in res\", \"ponse, update their buyer information in their respective databases.\\n\\nSummary\\n\\nMicroservices offer a\", \"n approach to application development and deployment that\\u2019s suited to the agility, scale, and reliab\", \"ility requirements of modern cloud applications. One of the main advantages of microservices is that\", \" they can be scaled-out independently, which means that a specific functional area can be scaled tha\", \"t requires more processing power or network bandwidth to support demand without unnecessarily scalin\", \"g areas of the application that are not experiencing increased demand.\\n\\nA container is an isolated, \", \"resource-controlled, and portable operating environment where an application can run without touchin\", \"g the resources of other containers or the host. Enterprises are increasingly adopting containers wh\", \"en implementing microservice-based applications, and Docker has become the standard container implem\", \"entation that most software platforms and cloud vendors have adopted.\\n\\n59\\n\\nCHAPTER 9 | Containerized\", \" microservices\\n\\nCHAPTER 10\\n\\nAccessing remote data\\n\\nMany modern web-based solutions make use of web s\", \"ervices, hosted by web servers, to provide functionality for remote client applications. The operati\", \"ons that a web service exposes constitute a web API.\\n\\nClient apps should be able to utilize the web \", \"API without knowing how the data or operations that the API exposes are implemented. This requires t\", \"hat the API abides by common standards that enable a client app and web service to agree on which da\", \"ta formats to use, and the structure of the data that is exchanged between client apps and the web s\", \"ervice.\\n\\nIntroduction to Representational State Transfer\\n\\nRepresentational State Transfer (REST) is \", \"an architectural style for building distributed systems based on hypermedia. A primary advantage of \", \"the REST model is that it\\u2019s based on open standards and doesn\\u2019t bind the implementation of the model\", \" or the client apps that access it to any specific implementation. Therefore, a REST web service cou\", \"ld be implemented using Microsoft ASP.NET Core, and client apps could be developing using any langua\", \"ge and toolset that can generate HTTP requests and parse HTTP responses.\\n\\nThe REST model uses a navi\", \"gational scheme to represent objects and services over a network, referred to as resources. Systems \", \"that implement REST typically use the HTTP protocol to transmit requests to access these resources. \", \"In such systems, a client app submits a request in the form of a URI that identifies a resource, and\", \" an HTTP method (such as GET, POST, PUT, or DELETE) that indicates the operation to be performed on \", \"that resource. The body of the HTTP request contains any data required to perform the operation.\\n\\nNo\", \"te\\n\\nREST defines a stateless request model. Therefore, HTTP requests must be independent and might o\", \"ccur in any order.\\n\\nThe response from a REST request makes use of standard HTTP status codes. For ex\", \"ample, a request that returns valid data should include the HTTP response code 200 (OK), while a req\", \"uest that fails to find or delete a specified resource should return a response that includes the HT\", \"TP status code 404 (Not Found).\\n\\nA RESTful web API exposes a set of connected resources, and provide\", \"s the core operations that enable an app to manipulate those resources and easily navigate between t\", \"hem. For this reason, the URIs that constitute a typical RESTful web API are oriented towards the da\", \"ta that it exposes, and use the facilities provided by HTTP to operate on this data.\\n\\n60\\n\\nCHAPTER 10\", \" | Accessing remote data\\n\\nThe data included by a client app in an HTTP request, and the correspondin\", \"g response messages from the web server, could be presented in a variety of formats, known as media \", \"types. When a client app sends a request that returns data in the body of a message, it can specify \", \"the media types it can handle in the Accept header of the request. If the web server supports this m\", \"edia type, it can reply with a response that includes the Content-Type header that specifies the for\", \"mat of the data in the body of the message. It\\u2019s then the responsibility of the client app to parse \", \"the response message and interpret the results in the message body appropriately.\\n\\nFor more informat\", \"ion about REST, see API design and API implementation on Microsoft Docs.\\n\\nConsuming RESTful APIs\\n\\nTh\", \"e eShop multi-platform app uses the Model-View-ViewModel (MVVM) pattern, and the model elements of t\", \"he pattern represent the domain entities used in the app. The controller and repository classes in t\", \"he eShop reference application accept and return many of these model objects. Therefore, they are us\", \"ed as data transfer objects (DTOs) that hold all the data that is passed between the app and the con\", \"tainerized microservices. The main benefit of using DTOs to pass data to and receive data from a web\", \" service is that by transmitting more data in a single remote call, the app can reduce the number of\", \" remote calls that need to be made.\\n\\nMaking web requests\\n\\nThe eShop multi-platform app uses the Http\", \"Client class to make requests over HTTP, with JSON being used as the media type. This class provides\", \" functionality for asynchronously sending HTTP requests and receiving HTTP responses from a URI iden\", \"tified resource. The HttpResponseMessage class represents an HTTP response message received from a R\", \"EST API after an HTTP request has been made. It contains information about the response, including t\", \"he status code, headers, and any body. The HttpContent class represents the HTTP body and content he\", \"aders, such as Content-Type and Content-Encoding. The content can be read using any of the ReadAs me\", \"thods, such as ReadAsStringAsync and ReadAsByteArrayAsync, depending on the format of the data.\\n\\nMak\", \"ing a GET request\\n\\nThe CatalogService class is used to manage the data retrieval process from the ca\", \"talog microservice. In the RegisterViewModels method in the MauiProgram class, the CatalogService cl\", \"ass is registered as a type mapping against the ICatalogService type with the dependency injection c\", \"ontainer. Then, when an instance of the CatalogViewModel class is created, its constructor accepts a\", \"n ICatalogService type, which the dependency injection container resolves, returning an instance of \", \"the CatalogService class. For more information about dependency injection, see Dependency Injection.\", \"\\n\\nThe image below shows the interaction of classes that read catalog data from the catalog microserv\", \"ice for displaying by the CatalogView.\\n\\n61\\n\\nCHAPTER 10 | Accessing remote data\\n\\nWhen the CatalogView\", \" is navigated to, the OnInitialize method in the CatalogViewModel class is called. This method retri\", \"eves catalog data from the catalog microservice, as demonstrated in the following code example:\\n\\npub\", \"lic override async Task InitializeAsync() { Products = await _productsService.GetCatalogAsync(); }\\n\\n\", \"This method calls the GetCatalogAsync method of the CatalogService instance that was injected into t\", \"he CatalogViewModel by the dependency injection container. The following code example shows the GetC\", \"atalogAsync method:\\n\\npublic async Task<ObservableCollection<CatalogItem>> GetCatalogAsync() { UriBui\", \"lder builder = new UriBuilder(GlobalSetting.Instance.CatalogEndpoint); builder.Path = \\\"api/v1/catalo\", \"g/items\\\"; string uri = builder.ToString();\\n\\nCatalogRoot? catalog = await _requestProvider.GetAsync<C\", \"atalogRoot>(uri);\\n\\nreturn catalog?.Data; }\\n\\n62\\n\\nCHAPTER 10 | Accessing remote data\\n\\nThis method buil\", \"ds the URI that identifies the resource the request will be sent to, and uses the RequestProvider cl\", \"ass to invoke the GET HTTP method on the resource, before returning the results to the CatalogViewMo\", \"del. The RequestProvider class contains functionality that submits a request in the form of a URI th\", \"at identifies a resource, an HTTP method that indicates the operation to be performed on that resour\", \"ce, and a body that contains any data required to perform the operation. For information about how t\", \"he RequestProvider class is injected into the CatalogService class, see Dependency Injection.\\n\\nThe f\", \"ollowing code example shows the GetAsync method in the RequestProvider class:\\n\\npublic async Task<TRe\", \"sult> GetAsync<TResult>(string uri, string token = \\\"\\\") { HttpClient httpClient = GetOrCreateHttpClie\", \"nt(token); HttpResponseMessage response = await httpClient.GetAsync(uri);\\n\\nawait HandleResponse(resp\", \"onse); TResult result = await response.Content.ReadFromJsonAsync<TResult>();\\n\\nreturn result; }\\n\\nThis\", \" method calls the GetOrCreateHttpClient method, which returns an instance of the HttpClient class wi\", \"th the appropriate headers set. It then submits an asynchronous GET request to the resource identifi\", \"ed by the URI, with the response being stored in the HttpResponseMessage instance. The HandleRespons\", \"e method is then invoked, which throws an exception if the response doesn\\u2019t include a success HTTP s\", \"tatus code. Then the response is read as a string, converted from JSON to a CatalogRoot object, and \", \"returned to the CatalogService.\\n\\nThe GetOrCreateHttpClient method is shown in the following code exa\", \"mple:\\n\\nprivate readonly Lazy<HttpClient> _httpClient = new Lazy<HttpClient>( () => { var httpClient \", \"= new HttpClient(); httpClient.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue(\", \"\\\"application/json\\\")); return httpClient; }, LazyThreadSafetyMode.ExecutionAndPublication);\\n\\nprivate \", \"HttpClient GetOrCreateHttpClient(string token = \\\"\\\") { var httpClient = _httpClient.Value;\\n\\nif (!stri\", \"ng.IsNullOrEmpty(token)) { httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeader\", \"Value(\\\"Bearer\\\", token); } else { httpClient.DefaultRequestHeaders.Authorization = null; }\\n\\n63\\n\\nCHAPT\", \"ER 10 | Accessing remote data\\n\\nreturn httpClient; }\\n\\nThis method uses creates a new instance or retr\", \"ieves a cached instance of the HttpClient class, and sets the Accept header of any requests made by \", \"the HttpClient instance to application/json, which indicates that it expects the content of any resp\", \"onse to be formatted using JSON. Then, if an access token was passed as an argument to the GetOrCrea\", \"teHttpClient method, it\\u2019s added to the Authorization header of any requests made by the HttpClient i\", \"nstance, prefixed with the string Bearer. For more information about authorization, see Authorizatio\", \"n.\\n\\nTip\\n\\nIt is highly recommended to cache and reuse instances of the HttpClient for better applicat\", \"ion performance. Creating a new HttpClient for each operation can lead to issue with socket exhausti\", \"on. For more information, see HttpClient Instancing on the Microsoft Developer Center.\\n\\nWhen the Get\", \"Async method in the RequestProvider class calls HttpClient.GetAsync, the Items method in the Catalog\", \"Controller class in the Catalog.API project is invoked, which is shown in the following code example\", \":\\n\\n[HttpGet] [Route(\\\"[action]\\\")] public async Task<IActionResult> Items( [FromQuery]int pageSize = 1\", \"0, [FromQuery]int pageIndex = 0) { var totalItems = await _catalogContext.CatalogItems .LongCountAsy\", \"nc();\\n\\nvar itemsOnPage = await _catalogContext.CatalogItems .OrderBy(c => c.Name) .Skip(pageSize * p\", \"ageIndex) .Take(pageSize) .ToListAsync();\\n\\nitemsOnPage = ComposePicUri(itemsOnPage); var model = new\", \" PaginatedItemsViewModel<CatalogItem>( pageIndex, pageSize, totalItems, itemsOnPage);\\n\\nreturn Ok(mod\", \"el); }\\n\\nThis method retrieves the catalog data from the SQL database using EntityFramework, and retu\", \"rns it as a response message that includes a success HTTP status code, and a collection of JSON form\", \"atted CatalogItem instances.\\n\\nMaking a POST request\\n\\nThe BasketService class is used to manage the d\", \"ata retrieval and update process with the basket microservice. In the RegisterAppServices method in \", \"the MauiProgram class, the BasketService class is registered as a type mapping against the IBasketSe\", \"rvice type with the dependency injection container. Then, when an instance of the BasketViewModel cl\", \"ass is created, its constructor accepts an\\n\\n64\\n\\nCHAPTER 10 | Accessing remote data\\n\\nIBasketService t\", \"ype, which the dependency injection container resolves, returning an instance of the BasketService c\", \"lass. For more information about dependency injection, see Dependency Injection.\\n\\nThe image below sh\", \"ows the interaction of classes that send the basket data displayed by the BasketView, to the basket \", \"microservice.\\n\\nWhen an item is added to the shopping basket, the ReCalculateTotalAsync method in the\", \" BasketViewModel class is called. This method updates the total value of items in the basket, and se\", \"nds the basket data to the basket microservice, as demonstrated in the following code example:\\n\\npriv\", \"ate async Task ReCalculateTotalAsync() { // Omitted for brevity...\\n\\nawait _basketService.UpdateBaske\", \"tAsync( new CustomerBasket { BuyerId = userInfo.UserId, Items = BasketItems.ToList() }, authToken); \", \"}\\n\\n65\\n\\nCHAPTER 10 | Accessing remote data\\n\\nThis method calls the UpdateBasketAsync method of the Bas\", \"ketService instance that was injected into the BasketViewModel by the dependency injection container\", \". The following method shows the UpdateBasketAsync method:\\n\\npublic async Task<CustomerBasket> Update\", \"BasketAsync( CustomerBasket customerBasket, string token) { UriBuilder builder = new UriBuilder(Glob\", \"alSetting.Instance.BasketEndpoint); string uri = builder.ToString(); var result = await _requestProv\", \"ider.PostAsync(uri, customerBasket, token); return result; }\\n\\nThis method builds the URI that identi\", \"fies the resource the request will be sent to, and uses the RequestProvider class to invoke the POST\", \" HTTP method on the resource, before returning the results to the BasketViewModel. Note that an acce\", \"ss token, obtained from IdentityServer during the authentication process, is required to authorize r\", \"equests to the basket microservice. For more information about authorization, see Authorization.\\n\\nTh\", \"e following code example shows one of the PostAsync methods in the RequestProvider class:\\n\\npublic as\", \"ync Task<TResult> PostAsync<TResult>( string uri, TResult data, string token = \\\"\\\", string header = \\\"\", \"\\\") { HttpClient httpClient = GetOrCreateHttpClient(token);\\n\\nvar content = new StringContent(JsonSeri\", \"alizer.Serialize(data)); content.Headers.ContentType = new MediaTypeHeaderValue(\\\"application/json\\\");\", \" HttpResponseMessage response = await httpClient.PostAsync(uri, content);\\n\\nawait HandleResponse(resp\", \"onse); TResult result = await response.Content.ReadFromJsonAsync<TResult>();\\n\\nreturn result; }\\n\\nThis\", \" method calls the GetOrCreateHttpClient method, which returns an instance of the HttpClient class wi\", \"th the appropriate headers set. It then submits an asynchronous POST request to the resource identif\", \"ied by the URI, with the serialized basket data being sent in JSON format, and the response being st\", \"ored in the HttpResponseMessage instance. The HandleResponse method is then invoked, which throws an\", \" exception if the response doesn\\u2019t include a success HTTP status code. Then, the response is read as\", \" a string, converted from JSON to a CustomerBasket object, and returned to the BasketService. For mo\", \"re information about the GetOrCreateHttpClient method, see Making a GET request.\\n\\nWhen the PostAsync\", \" method in the RequestProvider class calls HttpClient.PostAsync, the Post method in the BasketContro\", \"ller class in the Basket.API project is invoked, which is shown in the following code example:\\n\\n[Htt\", \"pPost] public async Task<IActionResult> Post([FromBody] CustomerBasket value) { var basket = await _\", \"repository.UpdateBasketAsync(value); return Ok(basket); }\\n\\n66\\n\\nCHAPTER 10 | Accessing remote data\\n\\nT\", \"his method uses an instance of the RedisBasketRepository class to persist the basket data to the Red\", \"is cache, and returns it as a response message that includes a success HTTP status code, and a JSON \", \"formatted CustomerBasket instance.\\n\\nMaking a DELETE request\\n\\nThe image below shows the interactions \", \"of classes that delete basket data from the basket microservice, for the CheckoutView.\\n\\nWhen the che\", \"ckout process is invoked, the CheckoutAsync method in the CheckoutViewModel class is called. This me\", \"thod creates a new order, before clearing the shopping basket, as demonstrated in the following code\", \" example:\\n\\nprivate async Task CheckoutAsync() { // Omitted for brevity...\\n\\nawait _basketService.Clea\", \"rBasketAsync( _shippingAddress.Id.ToString(), authToken); }\\n\\nThis method calls the ClearBasketAsync \", \"method of the BasketService instance that was injected into the CheckoutViewModel by the dependency \", \"injection container. The following method shows the ClearBasketAsync method:\\n\\npublic async Task Clea\", \"rBasketAsync(string guidUser, string token) { UriBuilder builder = new(GlobalSetting.Instance.Basket\", \"Endpoint); builder.Path = guidUser; string uri = builder.ToString(); await _requestProvider.DeleteAs\", \"ync(uri, token); }\\n\\n67\\n\\nCHAPTER 10 | Accessing remote data\\n\\nThis method builds the URI that identifi\", \"es the resource that the request will be sent to, and uses the RequestProvider class to invoke the D\", \"ELETE HTTP method on the resource. Note that an access token, obtained from IdentityServer during th\", \"e authentication process, is required to authorize requests to the basket microservice. For more inf\", \"ormation about authorization, see Authorization.\\n\\nThe following code example shows the DeleteAsync m\", \"ethod in the RequestProvider class:\\n\\npublic async Task DeleteAsync(string uri, string token = \\\"\\\") { \", \"HttpClient httpClient = GetOrCreateHttpClient(token); await httpClient.DeleteAsync(uri); }\\n\\nThis met\", \"hod calls the GetOrCreateHttpClient method, which returns an instance of the HttpClient class with t\", \"he appropriate headers set. It then submits an asynchronous DELETE request to the resource identifie\", \"d by the URI. For more information about the GetOrCreateHttpClient method, see Making a GET request.\", \"\\n\\nWhen the DeleteAsync method in the RequestProvider class calls HttpClient.DeleteAsync, the Delete \", \"method in the BasketController class in the Basket.API project is invoked, which is shown in the fol\", \"lowing code example:\\n\\n[HttpDelete(\\\"{id}\\\")] public void Delete(string id) => _repository.DeleteBasket\", \"Async(id);\\n\\nThis method uses an instance of the RedisBasketRepository class to delete the basket dat\", \"a from the Redis cache.\\n\\nCaching data\\n\\nThe performance of an app can be improved by caching frequent\", \"ly accessed data to fast storage that\\u2019s located close to the app. If the fast storage is located clo\", \"ser to the app than the original source, then caching can significantly improve response times when \", \"retrieving data.\\n\\nThe most common form of caching is read-through caching, where an app retrieves da\", \"ta by referencing the cache. If the data isn\\u2019t in the cache, it\\u2019s retrieved from the data store and \", \"added to the cache. Apps can implement read-through caching with the cache-aside pattern. This patte\", \"rn determines whether the item is currently in the cache. If the item isn\\u2019t in the cache, it\\u2019s read \", \"from the data store and added to the cache. For more information, see the Cache-Aside pattern on Mic\", \"rosoft Docs.\\n\\nTip\\n\\nCache data that\\u2019s read frequently and changes infrequently.\\n\\nThis data can be add\", \"ed to the cache on demand the first time it is retrieved by an app. This means that the app needs to\", \" fetch the data only once from the data store, and that subsequent access can be satisfied by using \", \"the cache.\\n\\n68\\n\\nCHAPTER 10 | Accessing remote data\\n\\nDistributed applications, such as the eShop refe\", \"rence application, should provide either or both of the following caches:\\n\\n\\n\\nA shared cache, which c\", \"an be accessed by multiple processes or machines.\\n\\n\\n\\nA private cache, where data is held locally on \", \"the device running the app.\\n\\nThe eShop multi-platform app uses a private cache, where data is held l\", \"ocally on the device that\\u2019s running an instance of the app.\\n\\nTip\\n\\nThink of the cache as a transient \", \"data store that could disappear at any time.\\n\\nEnsure that data is maintained in the original data st\", \"ore as well as the cache. The chances of losing data are then minimized if the cache becomes unavail\", \"able.\\n\\nManaging data expiration\\n\\nIt\\u2019s impractical to expect that cached data will always be consiste\", \"nt with the original data. Data in the original data store might change after it\\u2019s been cached, caus\", \"ing the cached data to become stale. Therefore, apps should implement a strategy that helps to ensur\", \"e that the data in the cache is as up- to-date as possible, but can also detect and handle situation\", \"s that arise when the data in the cache has become stale. Most caching mechanisms enable the cache t\", \"o be configured to expire data, and hence reduce the period for which data might be out of date.\\n\\nTi\", \"p\\n\\nSet a default expiration time when configuring a cache.\\n\\nMany caches implement expiration, which \", \"invalidates data and removes it from the cache if it\\u2019s not accessed for a specified period. However,\", \" care must be taken when choosing the expiration period. If it\\u2019s made too short, data will expire to\", \"o quickly and the benefits of caching will be reduced. If it\\u2019s made too long, the data risks becomin\", \"g stale. Therefore, the expiration time should match the pattern of access for apps that use the dat\", \"a.\\n\\nWhen cached data expires, it should be removed from the cache, and the app must retrieve the dat\", \"a from the original data store and place it back into the cache.\\n\\nIt\\u2019s also possible that a cache mi\", \"ght fill up if data is allowed to remain for too long a period. Therefore, requests to add new items\", \" to the cache might be required to remove some items in a process known as eviction. Caching service\", \"s typically evict data on a least-recently-used basis. However, there are other eviction policies, i\", \"ncluding most-recently-used, and first-in-first-out. For more information, see Caching Guidance on M\", \"icrosoft Docs.\\n\\nCaching images\\n\\nThe eShop multi-platform app consumes remote product images that ben\", \"efit from being cached. These images are displayed by the Image control. The .NET MAUI Image control\", \" supports caching of\\n\\n69\\n\\nCHAPTER 10 | Accessing remote data\\n\\ndownloaded images which has caching en\", \"abled by default, and will store the image locally for 24 hours. In addition, the expiration time ca\", \"n be configured with the CacheValidity property. For more information, see Downloaded Image Caching \", \"on the Microsoft Developer Center.\\n\\nIncreasing resilience\\n\\nAll apps that communicate with remote ser\", \"vices and resources must be sensitive to transient faults. Transient faults include the momentary lo\", \"ss of network connectivity to services, the temporary unavailability of a service, or timeouts that \", \"arise when a service is busy. These faults are often self- correcting, and if the action is repeated\", \" after a suitable delay it\\u2019s likely to succeed.\\n\\nTransient faults can have a huge impact on the perc\", \"eived quality of an app, even if it has been thoroughly tested under all foreseeable circumstances. \", \"To ensure that an app that communicates with remote services operates reliably, it must be able to d\", \"o all of the following:\\n\\n\\n\\nDetect faults when they occur, and determine if the faults are likely to \", \"be transient.\\n\\n\\n\\nRetry the operation if it determines that the fault is likely to be transient and k\", \"eep track of the number of times the operation was retried.\\n\\n\\n\\nUse an appropriate retry strategy, wh\", \"ich specifies the number of retries, the delay between each attempt, and the actions to take after a\", \" failed attempt.\\n\\nThis transient fault handling can be achieved by wrapping all attempts to access a\", \" remote service in code that implements the retry pattern.\\n\\nRetry pattern\\n\\nIf an app detects a failu\", \"re when it tries to send a request to a remote service, it can handle the failure in any of the foll\", \"owing ways:\\n\\n\\n\\nRetrying the operation. The app could retry the failing request immediately.\\n\\n\\n\\nRetry\", \"ing the operation after a delay. The app should wait for a suitable amount of time before retrying t\", \"he request.\\n\\n\\n\\nCancelling the operation. The application should cancel the operation and report an e\", \"xception.\\n\\nThe retry strategy should be tuned to match the business requirements of the app. For exa\", \"mple, it\\u2019s important to optimize the retry count and retry interval to the operation being attempted\", \". If the operation is part of a user interaction, the retry interval should be short and only a few \", \"retries attempted to avoid making users wait for a response. If the operation is part of a long runn\", \"ing workflow, where cancelling or restarting the workflow is expensive or time-consuming, it\\u2019s appro\", \"priate to wait longer between attempts and to retry more times.\\n\\nNote\\n\\nAn aggressive retry strategy \", \"with minimal delay between attempts, and a large number of retries, could degrade a remote service t\", \"hat\\u2019s running close to or at capacity. In addition, such a retry strategy could also affect the resp\", \"onsiveness of the app if it\\u2019s continually trying to perform a failing operation.\\n\\n70\\n\\nCHAPTER 10 | A\", \"ccessing remote data\\n\\nIf a request still fails after a number of retries, it\\u2019s better for the app to\", \" prevent further requests going to the same resource and to report a failure. Then, after a set peri\", \"od, the app can make one or more requests to the resource to see if they\\u2019re successful. For more inf\", \"ormation, see Circuit breaker pattern.\\n\\nTip\\n\\nNever implement an endless retry mechanism. Instead, pr\", \"efer an exponential backoff.\\n\\nUse a finite number of retries, or implement the Circuit Breaker patte\", \"rn to allow a service to recover.\\n\\nThe eShop reference application does implement the retry pattern.\", \"\\n\\nFor more information about the retry pattern, see the Retry pattern on Microsoft Docs.\\n\\nCircuit br\", \"eaker pattern\\n\\nIn some situations, faults can occur due to anticipated events that take longer to fi\", \"x. These faults can range from a partial loss of connectivity to the complete failure of a service. \", \"In these situations, it\\u2019s pointless for an app to retry an operation that\\u2019s unlikely to succeed, and\", \" instead should accept that the operation has failed and handle this failure accordingly.\\n\\nThe circu\", \"it breaker pattern can prevent an app from repeatedly trying to execute an operation that\\u2019s likely t\", \"o fail, while also enabling the app to detect whether the fault has been resolved.\\n\\nNote\\n\\nThe purpos\", \"e of the circuit breaker pattern is different from the retry pattern. The retry pattern enables an a\", \"pp to retry an operation in the expectation that it\\u2019ll succeed. The circuit breaker pattern prevents\", \" an app from performing an operation that\\u2019s likely to fail.\\n\\nA circuit breaker acts as a proxy for o\", \"perations that might fail. The proxy should monitor the number of recent failures that have occurred\", \", and use this information to decide whether to allow the operation to proceed, or to return an exce\", \"ption immediately.\\n\\nThe eShop multi-platform app does not currently implement the circuit breaker pa\", \"ttern. However, the eShop does.\\n\\nTip\\n\\nCombine the retry and circuit breaker patterns.\\n\\nAn app can co\", \"mbine the retry and circuit breaker patterns by using the retry pattern to invoke an operation throu\", \"gh a circuit breaker. However, the retry logic should be sensitive to any exceptions returned by the\", \" circuit breaker and abandon retry attempts if the circuit breaker indicates that a fault is not tra\", \"nsient.\\n\\nFor more information about the circuit breaker pattern, see the Circuit Breaker pattern on \", \"Microsoft Docs.\\n\\n71\\n\\nCHAPTER 10 | Accessing remote data\\n\\nSummary\\n\\nMany modern web-based solutions ma\", \"ke use of web services, hosted by web servers, to provide functionality for remote client applicatio\", \"ns. The operations that a web service exposes constitute a web API, and client apps should be able t\", \"o utilize the web API without knowing how the data or operations that the API exposes are implemente\", \"d.\\n\\nThe performance of an app can be improved by caching frequently accessed data to fast storage th\", \"at\\u2019s located close to the app. Apps can implement read-through caching with the cache-aside pattern.\", \" This pattern determines whether the item is currently in the cache. If the item isn\\u2019t in the cache,\", \" it\\u2019s read from the data store and added to the cache.\\n\\nWhen communicating with web APIs, apps must \", \"be sensitive to transient faults. Transient faults include the momentary loss of network connectivit\", \"y to services, the temporary unavailability of a service, or timeouts that arise when a service is b\", \"usy. These faults are often self-correcting, and if the action is repeated after a suitable delay, t\", \"hen it\\u2019s likely to succeed. Therefore, apps should wrap all attempts to access a web API in code tha\", \"t implements a transient fault handling mechanism.\\n\\n72\\n\\nCHAPTER 10 | Accessing remote data\\n\\nCHAPTER \", \"11\\n\\nAuthentication and authorization\\n\\nAuthentication is the process of obtaining identification cred\", \"entials such as name and password from a user and validating those credentials against an authority.\", \" The entity that submitted the credentials is considered an authenticated identity if the credential\", \"s are valid. Once an identity has been established, an authorization process determines whether that\", \" identity has access to a given resource.\\n\\nThere are many approaches to integrating authentication a\", \"nd authorization into a .NET MAUI app that communicates with an ASP.NET web application, including u\", \"sing ASP.NET Core Identity, external authentication providers such as Microsoft, Google, Facebook, o\", \"r Twitter, and authentication middleware. The eShop multi-platform app performs authentication and a\", \"uthorization with a containerized identity microservice that uses IdentityServer. The app requests s\", \"ecurity tokens from IdentityServer to authenticate a user or access a resource. For IdentityServer t\", \"o issue tokens on behalf of a user, the user must sign in to IdentityServer. However, IdentityServer\", \" doesn\\u2019t provide a user interface or database for authentication. Therefore, in the eShop reference \", \"application, ASP.NET Core Identity is used for this purpose.\\n\\nAuthentication\\n\\nAuthentication is requ\", \"ired when an application needs to know the current user\\u2019s identity. ASP.NET Core\\u2019s primary mechanism\", \" for identifying users is the ASP.NET Core Identity membership system, which stores user information\", \" in a data store configured by the developer. Typically, this data store will be an EntityFramework \", \"store, though custom stores or third-party packages can be used to store identity information in Azu\", \"re storage, DocumentDB, or other locations.\\n\\nFor authentication scenarios that use a local user data\", \"store and persist identity information between requests via cookies (as is typical in ASP.NET web ap\", \"plications), ASP.NET Core Identity is a suitable solution. However, cookies are not always a natural\", \" means of persisting and transmitting data. For example, an ASP.NET Core web application that expose\", \"s RESTful endpoints that are accessed from an app will typically need to use bearer token authentica\", \"tion since cookies can\\u2019t be used in this scenario. However, bearer tokens can easily be retrieved an\", \"d included in the authorization header of web requests made from the app.\\n\\n73\\n\\nCHAPTER 11 | Authenti\", \"cation and authorization\\n\\nIssuing bearer tokens using IdentityServer\\n\\nIdentityServer is an open-sour\", \"ce OpenID Connect and OAuth 2.0 framework for ASP.NET Core, which can be used for many authenticatio\", \"n and authorization scenarios, including issuing security tokens for local ASP.NET Core Identity use\", \"rs.\\n\\nNote\\n\\nOpenID Connect and OAuth 2.0 are very similar, while having different responsibilities.\\n\\n\", \"OpenID Connect is an authentication layer on top of the OAuth 2.0 protocol. OAuth 2 is a protocol th\", \"at allows applications to request access tokens from a security token service and use them to commun\", \"icate with APIs. This delegation reduces complexity in both client applications and APIs since authe\", \"ntication and authorization can be centralized.\\n\\nOpenID Connect and OAuth 2.0 combine the two fundam\", \"ental security concerns of authentication and API access, and IdentityServer is an implementation of\", \" these protocols.\\n\\nIn applications that use direct client-to-microservice communication, such as the\", \" eShop reference application, a dedicated authentication microservice acting as a Security Token Ser\", \"vice (STS) can be used to authenticate users, as shown in the following diagram. For more informatio\", \"n about direct client-to-microservice communication, see Microservices.\\n\\nThe eShop multi-platform ap\", \"p communicates with the identity microservice, which uses IdentityServer to perform authentication, \", \"and access control for APIs. Therefore, the multi-platform app requests tokens from IdentityServer, \", \"either for authenticating a user or for accessing a resource:\\n\\n\\n\\nAuthenticating users with IdentityS\", \"erver is achieved by the multi-platform app requesting an identity token, representing an authentica\", \"tion process\\u2019s outcome. At a minimum, it contains an identifier for the user and information about h\", \"ow and when the user is authenticated. It can also include additional identity data.\\n\\n\\n\\nAccessing a \", \"resource with IdentityServer is achieved by the multi-platform app requesting an access token, which\", \" allows access to an API resource. Clients request access tokens and forward them to the API. Access\", \" tokens contain information about the client and the user, if present. APIs then use that informatio\", \"n to authorize access to their data.\\n\\nNote\\n\\nA client must be registered with IdentityServer before i\", \"t can successfully request tokens. For more information on adding clients, see Defining Clients.\\n\\n74\", \"\\n\\nCHAPTER 11 | Authentication and authorization\\n\\nAdding IdentityServer to a web application\\n\\nIn orde\", \"r for an ASP.NET Core web application to use IdentityServer, it must be added to the web application\", \"\\u2019s Visual Studio solution. For more information, see Setup and Overview in the IdentityServer docume\", \"ntation. Once IdentityServer is included in the web application\\u2019s Visual Studio solution, it must be\", \" added to its HTTP request processing pipeline to serve requests to OpenID Connect and OAuth 2.0 end\", \"points. This is configured in the Identity.API project\\u2019s Program.cs, as demonstrated in the followin\", \"g code example:\\n\\n...\\n\\napp.UseIdentityServer();\\n\\nOrder matters in the web application\\u2019s HTTP request \", \"processing pipeline. Therefore, IdentityServer must be added to the pipeline before the UI framework\", \" that implements the login screen.\\n\\nConfiguring IdentityServer\\n\\nIdentityServer should be configured \", \"in the ConfigureServices method in the web application\\u2019s Startup class by calling the services.AddId\", \"entityServer method, as demonstrated in the following code example from the eShop reference applicat\", \"ion:\\n\\npublic void ConfigureServices(IServiceCollection services) { services .AddIdentityServer(x => \", \"x.IssuerUri = \\\"null\\\") .AddSigningCredential(Certificate.Get()) .AddAspNetIdentity<ApplicationUser>()\", \" .AddConfigurationStore(builder => builder.UseSqlServer(connectionString, options => options.Migrati\", \"onsAssembly(migrationsAssembly))) .AddOperationalStore(builder => builder.UseSqlServer(connectionStr\", \"ing, options => options.MigrationsAssembly(migrationsAssembly))) .Services.AddTransient<IProfileServ\", \"ice, ProfileService>(); }\\n\\nAfter calling the services.AddIdentityServer method, additional fluent AP\", \"Is are called to configure the following:\\n\\n\\n\\nCredentials used for signing.\\n\\n\\n\\nAPI and identity resou\", \"rces that users might request access to.\\n\\n\\n\\nClients that will be connecting to request tokens.\\n\\n\\n\\nAS\", \"P.NET Core Identity.\\n\\nTip\\n\\nDynamically load the IdentityServer configuration. IdentityServer\\u2019s APIs \", \"allow for configuring IdentityServer from an in-memory list of configuration objects. In the eShop r\", \"eference application, these in-memory collections are hard-coded into the application. However, in p\", \"roduction scenarios they can be loaded dynamically from a configuration file or from a database.\\n\\n75\", \"\\n\\nCHAPTER 11 | Authentication and authorization\\n\\nFor information about configuring IdentityServer to\", \" use ASP.NET Core Identity, see Using ASP.NET Core Identity in the IdentityServer documentation.\\n\\nCo\", \"nfiguring API resources\\n\\nWhen configuring API resources, the AddInMemoryApiResources method expects \", \"an IEnumerable<ApiResource> collection. The following code example shows the GetApis method that pro\", \"vides this collection in the eShop reference application:\\n\\npublic static IEnumerable<ApiResource> Ge\", \"tApis() { return new List<ApiResource> { new ApiScope(\\\"orders\\\", \\\"Orders Service\\\"), new ApiScope(\\\"bas\", \"ket\\\", \\\"Basket Service\\\"), new ApiScope(\\\"webhooks\\\", \\\"Webhooks registration Service\\\"), }; }\\n\\nThis metho\", \"d specifies that IdentityServer should protect the orders and basket APIs. Therefore, IdentityServer\", \"-managed access tokens will be required when making calls to these APIs. For more information about \", \"the ApiResource type, see API Resource in the IdentityServer documentation.\\n\\nConfiguring identity re\", \"sources\\n\\nWhen configuring identity resources, the AddInMemoryIdentityResources method expects an IEn\", \"umerable<IdentityResource> collection. Identity resources are data such as user ID, name, or email a\", \"ddress. Each identity resource has a unique name, and arbitrary claim types can be assigned to it, w\", \"hich will be included in the identity token for the user. The following code example shows the GetRe\", \"sources method that provides this collection in the eShop reference application:\\n\\npublic static IEnu\", \"merable<IdentityResource> GetResources() { return new List<IdentityResource> { new IdentityResources\", \".OpenId(), new IdentityResources.Profile() }; }\\n\\nThe OpenID Connect specification specifies some sta\", \"ndard identity resources. The minimum requirement is that support is provided for emitting a unique \", \"ID for users. This is achieved by exposing the IdentityResources.OpenId identity resource.\\n\\nNote\\n\\nTh\", \"e IdentityResources class supports all of the scopes defined in the OpenID Connect specification (op\", \"enid, email, profile, telephone, and address).\\n\\nIdentityServer also supports defining custom identit\", \"y resources. For more information, see Defining custom identity resources in the IdentityServer docu\", \"mentation. For more information about the IdentityResource type, see Identity Resource in the Identi\", \"tyServer documentation.\\n\\n76\\n\\nCHAPTER 11 | Authentication and authorization\\n\\nConfiguring clients\\n\\nCli\", \"ents are applications that can request tokens from IdentityServer. Typically, the following settings\", \" must be defined for each client as a minimum:\\n\\n\\n\\nA unique client ID.\\n\\n\\n\\nThe allowed interactions wi\", \"th the token service (known as the grant type).\\n\\n\\n\\nThe location where identity and access tokens are\", \" sent to (known as a redirect URI).\\n\\n\\n\\nA list of resources that the client is allowed access to (kno\", \"wn as scopes).\\n\\nWhen configuring clients, the AddInMemoryClients method expects an IEnumerable<Clien\", \"t> collection. The following code example shows the configuration for the eShop multi-platform app i\", \"n the GetClients method that provides this collection in the eShop reference application:\\n\\npublic st\", \"atic IEnumerable<Client> GetClients(Dictionary<string,string> clientsUrl) { return new List<Client> \", \"{ // Omitted for brevity new Client { ClientId = \\\"maui\\\", ClientName = \\\"eShop .NET MAUI OpenId Client\", \"\\\", AllowedGrantTypes = GrantTypes.Hybrid, ClientSecrets = { new Secret(\\\"secret\\\".Sha256()) }, Redirec\", \"tUris = { clientsUrl[\\\"maui\\\"] }, RequireConsent = false, RequirePkce = true, PostLogoutRedirectUris =\", \" { $\\\"{clientsUrl[\\\"maui\\\"]}/Account/Redirecting\\\" }, AllowedCorsOrigins = { \\\"http://eshopmaui\\\" }, Allow\", \"edScopes = new List<string> { IdentityServerConstants.StandardScopes.OpenId, IdentityServerConstants\", \".StandardScopes.Profile, IdentityServerConstants.StandardScopes.OfflineAccess, \\\"orders\\\", \\\"basket\\\" },\", \" AllowOfflineAccess = true, AllowAccessTokensViaBrowser = true, AccessTokenLifetime = 60 * 60 * 2, /\", \"/ 2 hours IdentityTokenLifetime = 60 * 60 * 2 // 2 hours } }; }\\n\\nThis configuration specifies data f\", \"or the following properties:\\n\\nProperty\\n\\nDescription\\n\\nClientId\\n\\nA unique ID for the client.\\n\\nClientNa\", \"me\\n\\nThe client display name, which is used for logging and the consent screen.\\n\\n77\\n\\nCHAPTER 11 | Aut\", \"hentication and authorization\\n\\nProperty\\n\\nDescription\\n\\nAllowedGrantTypes\\n\\nSpecifies how a client want\", \"s to interact with IdentityServer. For more information see Configuring the authentication flow.\\n\\nCl\", \"ientSecrets\\n\\nSpecifies the client secret credentials that are used when requesting tokens from the t\", \"oken endpoint.\\n\\nRedirectUris\\n\\nSpecifies the allowed URIs to which to return tokens or authorization \", \"codes.\\n\\nRequireConsent\\n\\nSpecifies whether a consent screen is required.\\n\\nRequirePkce\\n\\nSpecifies whet\", \"her clients using an authorization code must send a proof key.\\n\\nPostLogoutRedirectUris\\n\\nSpecifies th\", \"e allowed URIs to redirect to after logout.\\n\\nAllowedCorsOrigins\\n\\nSpecifies the origin of the client \", \"so that IdentityServer can allow cross-origin calls from the origin.\\n\\nAllowedScopes\\n\\nSpecifies the r\", \"esources the client has access to. By default, a client has no access to any resources.\\n\\nAllowOfflin\", \"eAccess\\n\\nSpecifies whether the client can request refresh tokens.\\n\\nAllowAccessTokensViaBrowser\\n\\nSpec\", \"ifies whether the client can receive access tokens from a browser window.\\n\\nAlwaysIncludeUserClaimsIn\", \"IdToken\\n\\nSpecifies that the user claims will always be added to the id token. By default, these woul\", \"d have to be retrieved using the userinfo endpoint.\\n\\nAccessTokenLifetime\\n\\nSpecifies the lifetime of \", \"the access token in seconds.\\n\\nIdentityTokenLifetime\\n\\nSpecifies the lifetime of the identity token in\", \" seconds.\\n\\nConfiguring the authentication flow\\n\\nThe authentication flow between a client and Identit\", \"yServer can be configured by specifying the grant types in the Client.AllowedGrantTypes property. Th\", \"e OpenID Connect and OAuth 2.0 specifications define several authentication flows, including:\\n\\n78\\n\\nC\", \"HAPTER 11 | Authentication and authorization\\n\\nAuthentication Flow\\n\\nDescription\\n\\nImplicit\\n\\nThis flow \", \"is optimized for browser-based applications and should be used either for user authentication-only, \", \"or authentication and access token requests. All tokens are transmitted via the browser, and therefo\", \"re advanced features like refresh tokens are not permitted.\\n\\nAuthorization code\\n\\nThis flow provides \", \"the ability to retrieve tokens on a back channel, as opposed to the browser front channel, while als\", \"o supporting client authentication.\\n\\nHybrid\\n\\nThis flow is a combination of the implicit and authoriz\", \"ation code grant types. The identity token is transmitted via the browser channel and contains the s\", \"igned protocol response and other artifacts such as the authorization code. After successfully valid\", \"ating the response, the back channel should be used to retrieve the access and refresh token.\\n\\nTip\\n\\n\", \"Consider using the hybrid authentication flow. The hybrid authentication flow mitigates a number of \", \"attacks that apply to the browser channel, and is the recommended flow for native applications that \", \"want to retrieve access tokens (and possibly refresh tokens).\\n\\nFor more information about authentica\", \"tion flows, see Grant Types in the IdentityServer documentation.\\n\\nPerforming authentication\\n\\nFor Ide\", \"ntityServer to issue tokens on behalf of a user, the user must sign in to IdentityServer. However, I\", \"dentityServer doesn\\u2019t provide a user interface or database for authentication. Therefore, in the eSh\", \"op reference application, ASP.NET Core Identity is used for this purpose.\\n\\nThe eShop multi-platform \", \"app authenticates with IdentityServer with the hybrid authentication flow, which is illustrated in t\", \"he diagram below.\\n\\n79\\n\\nCHAPTER 11 | Authentication and authorization\\n\\nA sign in request is made to <\", \"base endpoint>:5105/connect/authorize. Following successful authentication, IdentityServer returns a\", \"n authentication response containing an authorization code and an identity token. The authorization \", \"code is sent to <base endpoint>:5105/connect/token, which responds with access, identity, and refres\", \"h tokens.\\n\\nThe eShop multi-platform app signs out of IdentityServer by sending a request to <base en\", \"dpoint>:5105/connect/endsession with additional parameters. After sign-out, IdentityServer responds \", \"by sending a post-logout redirecting URI back to the multi-platform app. The diagram below illustrat\", \"es this process.\\n\\nIn the eShop multi-platform app, communication with IdentityServer is performed by\", \" the IdentityService class, which implements the IIdentityService interface. This interface specifie\", \"s that the implementing class must provide SignInAsync, SignOutAsync, GetUserInfoAsync and GetAuthTo\", \"kenAsync methods.\\n\\nSigning-in\\n\\nWhen the user taps the LOGIN button on the LoginView, the SignInComma\", \"nd in the LoginViewModel class is executed, which in turn executes the SignInAsync method. The follo\", \"wing code example shows this method:\\n\\n[RelayCommand] private async Task SignInAsync() { await IsBusy\", \"For( async () => { var loginSuccess = await _appEnvironmentService.IdentityService.SignInAsync();\\n\\ni\", \"f (loginSuccess) { await NavigationService.NavigateToAsync(\\\"//Main/Catalog\\\"); }\\n\\n80\\n\\nCHAPTER 11 | Au\", \"thentication and authorization\\n\\n}); }\\n\\nThis method invokes the SignInAsync method in the IdentitySer\", \"vice class, as shown in the following code example:\\n\\npublic async Task<bool> SignInAsync() { var res\", \"ponse = await GetClient().LoginAsync(new LoginRequest()).ConfigureAwait(false);\\n\\nif (response.IsErro\", \"r) { return false; }\\n\\nawait _settingsService .SetUserTokenAsync( new UserToken { AccessToken = respo\", \"nse.AccessToken, IdToken = response.IdentityToken, RefreshToken = response.RefreshToken, ExpiresAt =\", \" response.AccessTokenExpiration }) .ConfigureAwait(false);\\n\\nreturn !response.IsError; }\\n\\nThe Identit\", \"yService makes use of the OidcClient provided with the IdentityModel.OidcClient NuGet package. This \", \"client displays the authentication web view to the user in the application and captures the authenti\", \"cation result. The client connects to the URI for IdentityServer\\u2019s authorization endpoint with the r\", \"equired parameters. The authorization endpoint is at /connect/authorize on port 5105 of the base end\", \"point exposed as a user setting. For more information about user settings, see Configuration Managem\", \"ent.\\n\\nNote\\n\\nThe attack surface of the eShop multi-platform app is reduced by implementing the Proof \", \"Key for Code Exchange (PKCE) extension to OAuth. PKCE protects the authorization code from being use\", \"d if it\\u2019s intercepted. This is achieved by the client generating a secret verifier, a hash of which \", \"is passed in the authorization request, and which is presented unhashed when redeeming the authoriza\", \"tion code. For more information about PKCE, see Proof Key for Code Exchange by OAuth Public Clients \", \"on the Internet Engineering Task Force web site.\\n\\n81\\n\\nCHAPTER 11 | Authentication and authorization\\n\", \"\\nIf the token endpoint receives valid authentication information, authorization code, and PKCE secre\", \"t verifier, it responds with an access token, identity token, and refresh token. The access token (w\", \"hich allows access to API resources) and identity token are stored as application settings, and page\", \" navigation is performed. Therefore, the overall effect in the eShop multi-platform app is this: pro\", \"vided that users are able to successfully authenticate with IdentityServer, they are navigated to th\", \"e //Main/Catalog route, which is a TabbedPage that displays the CatalogView as its selected tab.\\n\\n82\", \"\\n\\nCHAPTER 11 | Authentication and authorization\\n\\nFor information about page navigation, see Navigati\", \"on. For information about how WebView navigation causes a view model method to be executed, see Invo\", \"king navigation using behaviors. For information about application settings, see Configuration manag\", \"ement.\\n\\nNote\\n\\nThe eShop also allows a mock sign in when the app is configured to use mock services i\", \"n the SettingsView. In this mode, the app doesn\\u2019t communicate with IdentityServer, instead allowing \", \"the user to sign in using any credentials.\\n\\nSigning-out\\n\\nWhen the user taps the LOG OUT button in th\", \"e ProfileView, the LogoutCommand in the ProfileViewModel class is executed, which executes the Logou\", \"tAsync method. This method performs page navigation to the LoginView page, passing a Logout query pa\", \"rameter set to true.\\n\\nThat parameter is evaluated in the ApplyQueryAttributes method. If the Logout \", \"parameter is present with a true value, the PerformLogoutAsync method of the LoginViewModel class is\", \" executed, which is shown in the following code example:\\n\\nprivate async Task PerformLogoutAsync() { \", \"await _appEnvironmentService.IdentityService.SignOutAsync();\\n\\n_settingsService.UseFakeLocation = fal\", \"se;\\n\\nUserName.Value = string.Empty; Password.Value = string.Empty; }\\n\\nThis method invokes the SignOu\", \"tAsync method in the IdentityService class, which invokes the OidcClient to end the user\\u2019s session a\", \"nd clears any saved user tokens. For more information about application settings, see Configuration \", \"management. The following code example shows the SignOutAsync method:\\n\\npublic async Task<bool> SignO\", \"utAsync() { var response = await GetClient().LogoutAsync(new LogoutRequest()).ConfigureAwait(false);\", \"\\n\\nif (response.IsError) { return false; }\\n\\nawait _settingsService.SetUserTokenAsync(default);\\n\\nretur\", \"n !response.IsError; }\\n\\nThis method uses the OidcClient to call the URI to IdentityServer\\u2019s end sess\", \"ion endpoint with the required parameters. The end session endpoint is at /connect/endsession on por\", \"t 5105 of the base endpoint exposed as a user setting. Once the user has successfully signed out, Lo\", \"ginView is presented to the user, and any saved user information will be cleared.\\n\\n83\\n\\nCHAPTER 11 | \", \"Authentication and authorization\\n\\nFor information about page navigation, see Navigation. For informa\", \"tion about how WebView navigation causes a view model method to be executed, see Invoking navigation\", \" using behaviors. For information about application settings, see Configuration management.\\n\\nNote\\n\\nT\", \"he eShop also allows a mock sign-out when the app is configured to use mock services in the Settings\", \"View. In this mode, the app doesn\\u2019t communicate with IdentityServer, and instead clears any stored t\", \"okens from application settings.\\n\\nAuthorization\\n\\nAfter authentication, ASP.NET Core web APIs often n\", \"eed to authorize access, which allows a service to make APIs available to some authenticated users b\", \"ut not to all.\\n\\nRestricting access to an ASP.NET Core route can be achieved by applying an Authorize\", \" attribute to a controller or action, which limits access to the controller or action to authenticat\", \"ed users, as shown in the following code example:\\n\\n[Authorize] public sealed class BasketController \", \": Controller { // Omitted for brevity }\\n\\nIf an unauthorized user attempts to access a controller or \", \"action marked with the Authorize attribute, the API framework returns a 401 (unauthorized) HTTP stat\", \"us code.\\n\\nNote\\n\\nParameters can be specified on the Authorize attribute to restrict an API to specifi\", \"c users. For more information, see ASP.NET Core Docs: Authorization.\\n\\nIdentityServer can be integrat\", \"ed into the authorization workflow so that the access tokens provide control authorization. This app\", \"roach is shown in the diagram below.\\n\\n84\\n\\nCHAPTER 11 | Authentication and authorization\\n\\nThe eShop m\", \"ulti-platform app communicates with the identity microservice and requests an access token as part o\", \"f the authentication process. The access token is then forwarded to the APIs exposed by the ordering\", \" and basket microservices as part of the access requests. Access tokens contain information about th\", \"e client and the user. APIs then use that information to authorize access to their data. For informa\", \"tion about how to configure IdentityServer to protect APIs, see Configuring API resources.\\n\\nConfigur\", \"ing IdentityServer to perform authorization\\n\\nTo perform authorization with IdentityServer, its autho\", \"rization middleware must be added to the web application\\u2019s HTTP request pipeline. The middleware is \", \"added in the AddDefaultAuthentication extension method, which is invoked from the AddApplicationServ\", \"ices method in the Program class and is demonstrated in the following code example from the eShop re\", \"ference application:\\n\\npublic static IServiceCollection AddDefaultAuthentication(this IHostApplicatio\", \"nBuilder builder) { var services = builder.Services; var configuration = builder.Configuration;\\n\\nvar\", \" identitySection = configuration.GetSection(\\\"Identity\\\");\\n\\nif (!identitySection.Exists()) { // No ide\", \"ntity section, so no authentication return services; }\\n\\n// prevent from mapping \\\"sub\\\" claim to namei\", \"dentifier. JsonWebTokenHandler.DefaultInboundClaimTypeMap.Remove(\\\"sub\\\");\\n\\nservices.AddAuthentication\", \"().AddJwtBearer(options => {\\n\\n85\\n\\nCHAPTER 11 | Authentication and authorization\\n\\nvar identityUrl = i\", \"dentitySection.GetRequiredValue(\\\"Url\\\"); var audience = identitySection.GetRequiredValue(\\\"Audience\\\");\", \"\\n\\noptions.Authority = identityUrl; options.RequireHttpsMetadata = false; options.Audience = audience\", \"; options.TokenValidationParameters.ValidIssuers = [identityUrl]; options.TokenValidationParameters.\", \"ValidateAudience = false; });\\n\\nservices.AddAuthorization();\\n\\nreturn services; }\\n\\nThis method ensures\", \" that the API can only be accessed with a valid access token. The middleware validates the incoming \", \"token to ensure that it\\u2019s sent from a trusted issuer and validates that the token is valid to be use\", \"d with the API that receives it. Therefore, browsing to the ordering or basket controller will retur\", \"n a 401 (unauthorized) HTTP status code, indicating that an access token is required.\\n\\nMaking access\", \" requests to APIs\\n\\nWhen making requests to the ordering and basket microservices, the access token o\", \"btained from IdentityServer during the authentication process must be included in the request, as sh\", \"own in the following code example:\\n\\npublic async Task CreateOrderAsync(Models.Orders.Order newOrder)\", \" { var authToken = await _identityService.GetAuthTokenAsync().ConfigureAwait(false);\\n\\nif (string.IsN\", \"ullOrEmpty(authToken)) { return; }\\n\\nvar uri = $\\\"{UriHelper.CombineUri(_settingsService.GatewayOrders\", \"EndpointBase, ApiUrlBase)}?api-version=1.0\\\";\\n\\nvar success = await _requestProvider.PostAsync(uri, ne\", \"wOrder, authToken, \\\"x- requestid\\\").ConfigureAwait(false); }\\n\\nThe access token is stored with the IId\", \"entityService implementation and can be retrieved using the GetAuthTokenAsync method.\\n\\nSimilarly, th\", \"e access token must be included when sending data to an IdentityServer protected API, as shown in th\", \"e following code example:\\n\\npublic async Task ClearBasketAsync() { var authToken = await _identitySer\", \"vice.GetAuthTokenAsync().ConfigureAwait(false);\\n\\nif (string.IsNullOrEmpty(authToken)) { return;\\n\\n86\\n\", \"\\nCHAPTER 11 | Authentication and authorization\\n\\n}\\n\\nawait GetBasketClient().DeleteBasketAsync(new Del\", \"eteBasketRequest(), CreateAuthenticationHeaders(authToken)) .ConfigureAwait(false); }\\n\\nThe access to\", \"ken is retrieved from the IIdentityService and included in the call to the ClearBasketAsync method i\", \"n the BasketService class.\\n\\nThe RequestProvider class in the eShop multi-platform app uses the HttpC\", \"lient class to make requests to the RESTful APIs exposed by the eShop reference application. When ma\", \"king requests to the ordering and basket APIs, which require authorization, a valid access token mus\", \"t be included with the request. This is achieved by adding the access token to the headers of the Ht\", \"tpClient instance, as demonstrated in the following code example:\\n\\nhttpClient.DefaultRequestHeaders.\", \"Authorization = new AuthenticationHeaderValue(\\\"Bearer\\\", to ken);\\n\\nThe DefaultRequestHeaders property\", \" of the HttpClient class exposes the headers that are sent with each request, and the access token i\", \"s added to the Authorization header prefixed with the string Bearer. When the request is sent to a R\", \"ESTful API, the value of the Authorization header is extracted and validated to ensure that it\\u2019s sen\", \"t from a trusted issuer and used to determine whether the user has permission to invoke the API that\", \" receives it.\\n\\nFor more information about how the eShop multi-platform app makes web requests, see A\", \"ccessing remote data.\\n\\nSummary\\n\\nThere are many approaches to integrating authentication and authoriz\", \"ation into a .NET MAUI app that communicates with an ASP.NET web application. The eShop multi-platfo\", \"rm app performs authentication and authorization with a containerized identity microservice that use\", \"s IdentityServer. IdentityServer is an open-source OpenID Connect and OAuth 2.0 framework for ASP.NE\", \"T Core that integrates with ASP.NET Core Identity to perform bearer token authentication.\\n\\nThe multi\", \"-platform app requests security tokens from IdentityServer to authenticate a user or access a resour\", \"ce. When accessing a resource, an access token must be included in the request to APIs that require \", \"authorization. IdentityServer\\u2019s middleware validates incoming access tokens to ensure that they are \", \"sent from a trusted issuer and that they are valid to be used with the API that receives them.\\n\\n87\\n\\n\", \"CHAPTER 11 | Authentication and authorization\\n\\nCHAPTER 12\\n\\nMVVM Toolkit Features\\n\\nMVVM Toolkit\\n\\nThe \", \"Model-View-ViewModel (MVVM) pattern is a great structural basis for creating our applications. In th\", \"is pattern, the ViewModel becomes the backbone of our application as it provides communication to ou\", \"r front-end user interface and backing components. To provide integration with the user interface, w\", \"e will rely on the ViewModel\\u2019s properties and commands. As detailed in Updating views in response to\", \" changes in the underlying view model or model, the INotifyPropertyChanged interface on our ViewMode\", \"l to allows changes to our properties to notify when the value is changed. Implementing all of these\", \" features means that our ViewModel can end up becoming very verbose. For example, the following code\", \" shows a simple ViewModel with properties that raise changes:\\n\\npublic class SampleViewModel : INotif\", \"yPropertyChanged { private string _name; private int _value;\\n\\npublic event PropertyChangedEventHandl\", \"er PropertyChanged;\\n\\npublic string Name { get => _name; set => SetPropertyValue(ref _name, value); }\", \"\\n\\npublic int Value { get => _value; set => SetPropertyValue(ref _value, value); }\\n\\nprotected void Se\", \"tPropertyValue<T>(ref T storageField, T newValue, [CallerMemberName] string propertyName = \\\"\\\") { if \", \"(Equals(storageField, newValue)) return;\\n\\nstorageField = newValue; RaisePropertyChanged(propertyName\", \"); }\\n\\nprotected virtual void RaisePropertyChanged([CallerMemberName] string propertyName = \\\"\\\") { Pro\", \"pertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName)); } }\\n\\n88\\n\\nCHAPTER 12 | MVVM T\", \"oolkit Features\\n\\nWhile some optimizations could be made over time, we will still end up with a fairl\", \"y verbose set of code for defining our ViewModel. This code can be difficult to maintain and becomes\", \" error-prone.\\n\\nThe CommunityToolkit.Mvvm NuGet Package (aka MVVM Toolkit) can be used to help addres\", \"s and simplify these common MVVM patterns. The MVVM Toolkit, along with newer features to the .NET l\", \"anguage, allows for simplified logic, easy adoption into a project, and runtime independence. The ex\", \"ample below shows the same ViewModel using components that come with the MVVM Toolkit:\\n\\npublic parti\", \"al class SampleViewModel : ObservableObject { [ObservableProperty] private string _name;\\n\\n[Observabl\", \"eProperty] private int _value; }\\n\\nNote\\n\\nThe MVVM Toolkit is provided with the CommunityToolkit.Mvvm \", \"package. For information on how to add the package to your project, see Introduction to the MVVM Too\", \"lkit on the Microsoft Developer Center.\\n\\nIn comparison to the original example, we were able to dras\", \"tically reduce the overall complexity and simplify the maintainability of our ViewModel. The MVVM To\", \"olkit comes with many pre-built common components and features, such as the ObservableObject shown a\", \"bove, that simplifies and standardizes the code that we have throughout the application.\\n\\nObservable\", \"Object\\n\\nThe MVVM Toolkit provides ObservableObject which is intended for use as the base of our View\", \"Model objects or any object that needs to raise change notifications. It implements INotifyPropertyC\", \"hanged and INotifyPropertyChanging along with helper methods for setting properties and raising chan\", \"ges. Below is an example of a standard ViewModel using ObservableObject:\\n\\npublic class SampleViewMod\", \"el : ObservableObject { private string _name; private int _value;\\n\\npublic string Name { get => _name\", \"; set => SetProperty(ref _name, value); }\\n\\npublic int Value { get => _value; set => SetProperty(ref \", \"_value, value);\\n\\n89\\n\\nCHAPTER 12 | MVVM Toolkit Features\\n\\n} }\\n\\nObservableObject handles all of the lo\", \"gic needed for raising change notifications by using the SetProperty method in your property setter.\", \" If you have a property that returns a Task<T>, the SetPropertyAndNotifyOnCompletion method can be u\", \"sed to delay publishing a property change until the task has been completed. The methods OnPropertyC\", \"hanged and OnPropertyChanging that can also be used for raising property changes where needed in you\", \"r object.\\n\\nFor more detailed information on ObservableObject, see ObservableObject in the MVVM Toolk\", \"it Developer Center.\\n\\nRelayCommand and AsyncRelayCommand\\n\\nInteraction between .NET MAUI controls (fo\", \"r example, tapping a button or selecting an item from a collection) and the ViewModel is done with t\", \"he ICommand interface. .NET MAUI comes with a default implementation of ICommand with the Command ob\", \"ject. .NET MAUI\\u2019s Command is fairly basic and lacks support for more advanced features, such as supp\", \"orting asynchronous work and command execution status.\\n\\nThe MVVM Toolkit comes with two commands, Re\", \"layCommand and AsyncRelayCommand. RelayCommand is intended for situations where you have synchronous\", \" code to execute and has a fairly similar implementation to the .NET MAUI Command object.\\n\\nNote\\n\\nEve\", \"n though the .NET MAUI Command and RelayCommand are similar, using RelayCommand allows for decouplin\", \"g your ViewModel from any direct .NET MAUI references. This means that your ViewModel is more portab\", \"le, leading to easier reuse across projects.\\n\\nAsyncRelayCommand provides many additional features wh\", \"en working with asynchronous workflows. This is quite common in our ViewModel as we are typically co\", \"mmunicating with repositories, APIs, databases, and other systems that utilize async/await. The Asyn\", \"cRelayCommand constructor takes in an execution task defined as a Func<Task> or a delegate returning\", \" Task as part of the constructor. While the execution task is running, AsyncRelayCommand will monito\", \"r the state of the task and provides updates using the IsRunning property. The IsRunning property ca\", \"n be bound to the UI which helps manage control states such as showing loading with an ActivityIndic\", \"ator or disabling/enabling a control. While the execution task is being executed, the Cancel method \", \"can be called to attempt cancellation of the execution task, if supported.\\n\\nBy default, AsyncRelayCo\", \"mmand doesn\\u2019t allow concurrent execution. This is very helpful in situations where a user could unin\", \"tentionally tap a control multiple times to execute a long-running or costly operation. During task \", \"execution, AsyncRelayCommand will automatically call the CanExecuteChanged event. In .NET MAUI, cont\", \"rols that support the Command and CommandParameter properties, such as Button, will listen to this e\", \"vent and automatically enable or disable it during execution. This functionality can be overridden b\", \"y using a custom canExecute parameter or setting the AsyncRelayCommandOptions.AllowConcurrentExecuti\", \"ons flag in the constructor.\\n\\n90\\n\\nCHAPTER 12 | MVVM Toolkit Features\\n\\nFor more detailed information \", \"on implementing commands, see the section Implementing commands in the MVVM chapter. Detailed inform\", \"ation for the RelayCommand and AsyncRelayCommand is available in the Commanding of the MVVM Toolkit \", \"Developer Center.\\n\\nSource Generators\\n\\nUsing the MVVM Toolkit components out-of-the-box allows you to\", \" greatly simplify our ViewModel. The MVVM Toolkit allows you to simplify common code use cases even \", \"further by using Source Generators. The MVVM Toolkit source generators look for specific attributes \", \"in our code and can generate wrappers for properties and commands.\\n\\nImportant\\n\\nThe MVVM Toolkit Sour\", \"ce Generators generate code that is additive to our existing objects. Because of this, any object th\", \"at is leveraging a source generator will need to be marked as partial.\\n\\nThe MVVM Toolkit ObservableP\", \"roperty attribute can be applied to fields in objects that inherit from ObservableObject and will wr\", \"ap a private field with a property that generates changes. The following code shows an example of us\", \"ing the ObservableObject attribute on the _name field:\\n\\npublic partial class SampleViewModel : Obser\", \"vableObject { [ObservableProperty] private string _name; }\\n\\nWith the ObservableProperty attribute ap\", \"plied to the _name field, the source generator will run and generate another partial class with the \", \"following code:\\n\\npartial class SampleViewModel { public string Name { get => _name; set { if (!Equal\", \"ityComparer<string>.Default.Equals(_name, value)) { OnNameChanging(value); OnPropertyChanging(\\\"Name\\\"\", \"); _name = value; OnNameChanged(value); OnPropertyChanged(\\\"Name\\\"); } } } }\\n\\nThe generated SampleView\", \"Model has used the private _name field and generated a new Name property that implements all of the \", \"logic needed for raising change notifications.\\n\\n91\\n\\nCHAPTER 12 | MVVM Toolkit Features\\n\\nThe MVVM Too\", \"lkit RelayCommand attribute can be applied to methods within an ObservableObject and will create a c\", \"orresponding RelayCommand or AsyncRelayCommand. The following code shows examples of using the Relay\", \"Command attribute:\\n\\npublic partial class SampleViewModel : ObservableObject { public INavigationServ\", \"ice NavigationService { get; set; }\\n\\n[ObservableProperty] private string _name;\\n\\n[ObservableProperty\", \"] bool _isValid;\\n\\n[RelayCommand] private Task SettingsAsync() { return NavigationService.NavigateToA\", \"sync(\\\"Settings\\\"); }\\n\\n[RelayCommand] private void Validate() { IsValid = !string.IsNullOrEmpty(Name);\", \" } }\\n\\nThe RelayCommand applied to the Validate method will generate a RelayCommand validate Validate\", \"Command because it has a void return and the SettingsAsync method will generate an AsyncRelayCommand\", \" named SettingsCommand. The source generator will generate the following code in other partial class\", \"es:\\n\\npartial class SampleViewModel { private AsyncRelayCommand? settingsCommand;\\n\\nSettingsCommand =>\", \" settingsCommand ??= new AsyncRelayCommand(SettingsAsync); }\\n\\npartial class SampleViewModel { privat\", \"e RelayCommand? validateCommand;\\n\\npublic IRelayCommand ValidateCommand => validateCommand ??= new Re\", \"layCommand(Validate); }\\n\\nAll of the complexity of wrapping our ViewModel\\u2019s methods with an ICommand \", \"implementation has been handled by the source generator.\\n\\nFor more detailed information on MVVM Tool\", \"kit Source Generators, see MVVM source generators in the MVVM Toolkit Developer Center.\\n\\n92\\n\\nCHAPTER\", \" 12 | MVVM Toolkit Features\\n\\nSummary\\n\\nThe MVVM Toolkit is a great way to standardize and simplify ou\", \"r ViewModel code. The MVVM toolkit offers great implementations of standard MVVM components such as \", \"ObservableObject and Async/RelayCommand. The source generators help simplify our ViewModel propertie\", \"s and commands by generating all of the boilerplate code needed for user interface interactions. The\", \" MVVM Toolkit offers even more features outside of what has been shown in this chapter. For more inf\", \"ormation on the MVVM Toolkit, see Introduction to the MVVM Toolkit in the MVVM Toolkit Developer Cen\", \"ter.\\n\\n93\\n\\nCHAPTER 12 | MVVM Toolkit Features\\n\\nCHAPTER 13\\n\\nUnit testing\\n\\nmulti-platform apps experien\", \"ce problems similar to both desktop and web-based applications. Mobile users will differ by their de\", \"vices, network connectivity, availability of services, and various other factors. Therefore, multi-p\", \"latform apps should be tested as they would be used in the real world to improve their quality, reli\", \"ability, and performance. Many types of testing should be performed on an app, including unit testin\", \"g, integration testing, and user interface testing. Unit testing is the most common form and essenti\", \"al to building high-quality applications.\\n\\nA unit test takes a small unit of the app, typically a me\", \"thod, isolates it from the remainder of the code, and verifies that it behaves as expected. Its goal\", \" is to check that each unit of functionality performs as expected, so errors don\\u2019t propagate through\", \"out the app. Detecting a bug where it occurs is more efficient that observing the effect of a bug in\", \"directly at a secondary point of failure.\\n\\nUnit testing has the most significant effect on code qual\", \"ity when it\\u2019s an integral part of the software development workflow. Unit tests can act as design do\", \"cumentation and functional specifications for an application. As soon as a method has been written, \", \"unit tests should be written that verify the method\\u2019s behavior in response to standard, boundary, an\", \"d incorrect input data cases and check any explicit or implicit assumptions made by the code. Altern\", \"atively, with test-driven development, unit tests are written before the code. For more information \", \"on test-driven development and how to implement it, see Walkthrough: Test-driven development using T\", \"est Explorer.\\n\\nNote\\n\\nUnit tests are very effective against regression. That is, functionality that u\", \"sed to work, but has been disturbed by a faulty update.\\n\\nUnit tests typically use the arrange-act-as\", \"sert pattern:\\n\\nStep\\n\\nDescription\\n\\nArrange\\n\\nInitializes objects and sets the value of the data that i\", \"s passed to the method under test.\\n\\nAct\\n\\nInvokes the method under test with the required arguments.\\n\", \"\\nAssert\\n\\nVerifies that the action of the method under test behaves as expected.\\n\\nThis pattern ensure\", \"s that unit tests are readable, self-describing, and consistent.\\n\\n94\\n\\nCHAPTER 13 | Unit testing\\n\\nDep\", \"endency injection and unit testing\\n\\nOne of the motivations for adopting a loosely-coupled architectu\", \"re is that it facilitates unit testing. One of the types registered with the dependency injection se\", \"rvice is the IAppEnvironmentService interface. The following code example shows an outline of this c\", \"lass:\\n\\npublic class OrderDetailViewModel : ViewModelBase { private IAppEnvironmentService _appEnviro\", \"nmentService;\\n\\npublic OrderDetailViewModel( IAppEnvironmentService appEnvironmentService, IDialogSer\", \"vice dialogService, INavigationService navigationService, ISettingsService settingsService) : base(d\", \"ialogService, navigationService, settingsService) { _appEnvironmentService = appEnvironmentService; \", \"} }\\n\\nThe OrderDetailViewModel class has a dependency on the IAppEnvironmentService type, which the d\", \"ependency injection container resolves when it instantiates an OrderDetailViewModel object. However,\", \" rather than create an IAppEnvironmentService object which utilizes real servers, devices and config\", \"urations to unit test the OrderDetailViewModel class, instead, replace the IAppEnvironmentService ob\", \"ject with a mock object for the purpose of the tests. A mock object is one that has the same signatu\", \"re of an object or an interface, but is created in a specific manner to help with unit testing. It i\", \"s often used with dependency injection to provide specific implementations of interfaces for testing\", \" different data and workflow scenarios.\\n\\nThis approach allows the IAppEnvironmentService object to b\", \"e passed into the OrderDetailViewModel class at runtime, and in the interests of testability, it all\", \"ows a mock class to be passed into the OrderDetailViewModel class at test time. The main advantage o\", \"f this approach is that it enables unit tests to be executed without requiring unwieldy resources su\", \"ch as runtime platform features, web services, or databases.\\n\\nTesting MVVM applications\\n\\nTesting mod\", \"els and view models from MVVM applications is identical to testing any other class, and uses the sam\", \"e tools and techniques; this includes features such as unit testing and mocking. However, some patte\", \"rns that are typical to model and view model classes can benefit from specific unit testing techniqu\", \"es.\\n\\nTip\\n\\nTest one thing with each unit test. As the complexity of a test expands, it makes verifica\", \"tion of that test more difficult. By limiting a unit test to a single concern, we can ensure that ou\", \"r tests are more repeatable, isolated, and have a smaller execution time. See\\n\\nUnit testing best pra\", \"ctices with .NET for more best practices.\\n\\n95\\n\\nCHAPTER 13 | Unit testing\\n\\nDon\\u2019t be tempted to make a\", \" unit test exercise more than one aspect of the unit\\u2019s behavior. Doing so leads to tests that are di\", \"fficult to read and update. It can also lead to confusion when interpreting a failure.\\n\\nThe eShop mu\", \"lti-platform app uses MSTest to perform unit testing, which supports two different types of unit tes\", \"ts:\\n\\nTesting Type\\n\\nAttribute\\n\\nDescription\\n\\nTestMethod\\n\\nTestMethod Defines the actual test method to \", \"run..\\n\\nDataSource\\n\\nDataSource\\n\\nTests that are only true for a particular set of data.\\n\\nThe unit test\", \"s included with the eShop multi-platform app are TestMethod, so each unit test method is decorated w\", \"ith the TestMethod attribute. In addition to MSTest there are several other testing frameworks avail\", \"able including NUnit and xUnit.\\n\\nTesting asynchronous functionality\\n\\nWhen implementing the MVVM patt\", \"ern, view models usually invoke operations on services, often asynchronously. Tests for code that in\", \"vokes these operations typically use mocks as replacements for the actual services. The following co\", \"de example demonstrates testing asynchronous functionality by passing a mock service into a view mod\", \"el:\\n\\n[TestMethod] public async Task OrderPropertyIsNotNullAfterViewModelInitializationTest() { // Ar\", \"range var orderService = new OrderMockService(); var orderViewModel = new OrderDetailViewModel(order\", \"Service);\\n\\n// Act var order = await orderService.GetOrderAsync(1, GlobalSetting.Instance.AuthToken);\", \" await orderViewModel.InitializeAsync(order);\\n\\n// Assert Assert.IsNotNull(orderViewModel.Order); }\\n\\n\", \"This unit test checks that the Order property of the OrderDetailViewModel instance will have a value\", \" after the InitializeAsync method has been invoked. The InitializeAsync method is invoked when the v\", \"iew model\\u2019s corresponding view is navigated to. For more information about navigation, see Navigatio\", \"n.\\n\\nWhen the OrderDetailViewModel instance is created, it expects an IOrderService instance to be sp\", \"ecified as an argument. However, the OrderService retrieves data from a web service. Therefore, an O\", \"rderMockService instance, a mock version of the OrderService class, is specified as the argument to \", \"the OrderDetailViewModel constructor. Then, mock data is retrieved rather than communicating with a \", \"web service when the view model\\u2019s InitializeAsync method is invoked, which uses IOrderService operat\", \"ions.\\n\\n96\\n\\nCHAPTER 13 | Unit testing\\n\\nTesting INotifyPropertyChanged implementations\\n\\nImplementing t\", \"he INotifyPropertyChanged interface allows views to react to changes that originate from view models\", \" and models. These changes are not limited to data shown in controls \\u2013 they are also used to control\", \" the view, such as view model states that cause animations to be started or controls to be disabled.\", \"\\n\\nProperties that can be updated directly by the unit test can be tested by attaching an event handl\", \"er to the PropertyChanged event and checking whether the event is raised after setting a new value f\", \"or the property. The following code example shows such a test:\\n\\n[TestMethod] public async Task Setti\", \"ngOrderPropertyShouldRaisePropertyChanged() { var invoked = false; var orderService = new OrderMockS\", \"ervice(); var orderViewModel = new OrderDetailViewModel(orderService);\\n\\norderViewModel.PropertyChang\", \"ed += (sender, e) => { if (e.PropertyName.Equals(\\\"Order\\\")) invoked = true; }; var order = await orde\", \"rService.GetOrderAsync(1, GlobalSetting.Instance.AuthToken); await orderViewModel.InitializeAsync(or\", \"der);\\n\\nAssert.IsTrue(invoked); }\\n\\nThis unit test invokes the InitializeAsync method of the OrderView\", \"Model class, which causes its Order property to be updated. The unit test will pass, provided that t\", \"he PropertyChanged event is raised for the Order property.\\n\\nTesting message-based communication\\n\\nVie\", \"w models that use the MessagingCenter class to communicate between loosely coupled classes can be un\", \"it tested by subscribing to the message being sent by the code under test, as demonstrated in the fo\", \"llowing code example:\\n\\n[TestMethod] public void AddCatalogItemCommandSendsAddProductMessageTest() { \", \"var messageReceived = false; var catalogService = new CatalogMockService(); var catalogViewModel = n\", \"ew CatalogViewModel(catalogService);\\n\\nMessagingCenter.Subscribe<CatalogViewModel, CatalogItem>( this\", \", MessageKeys.AddProduct, (sender, arg) => { messageReceived = true; }); catalogViewModel.AddCatalog\", \"ItemCommand.Execute(null);\\n\\n97\\n\\nCHAPTER 13 | Unit testing\\n\\nAssert.IsTrue(messageReceived); }\\n\\nThis u\", \"nit test checks that the CatalogViewModel publishes the AddProduct message in response to its AddCat\", \"alogItemCommand being executed. Because the MessagingCenter class supports multicast message subscri\", \"ptions, the unit test can subscribe to the AddProduct message and execute a callback delegate in res\", \"ponse to receiving it. This callback delegate, specified as a lambda expression, sets a boolean fiel\", \"d that\\u2019s used by the Assert statement to verify the behavior of the test.\\n\\nTesting exception handlin\", \"g\\n\\nUnit tests can also be written that check that specific exceptions are thrown for invalid actions\", \" or inputs, as demonstrated in the following code example:\\n\\n[TestMethod] public void InvalidEventNam\", \"eShouldThrowArgumentExceptionText() { var behavior = new MockEventToCommandBehavior { EventName = \\\"O\", \"nItemTapped\\\" }; var listView = new ListView();\\n\\nAssert.Throws<ArgumentException>(() => listView.Beha\", \"viors.Add(behavior)); }\\n\\nThis unit test will throw an exception because the ListView control does no\", \"t have an event named OnItemTapped. The Assert.Throws<T> method is a generic method where T is the t\", \"ype of the expected exception. The argument passed to the Assert.Throws<T> method is a lambda expres\", \"sion that will throw the exception. Therefore, the unit test will pass provided that the lambda expr\", \"ession throws an ArgumentException.\\n\\nTip\\n\\nAvoid writing unit tests that examine exception message st\", \"rings. Exception message strings might change over time, and so unit tests that rely on their presen\", \"ce are regarded as brittle.\\n\\nTesting validation\\n\\nThere are two aspects to testing the validation imp\", \"lementation: testing that any validation rules are correctly implemented and testing that the Valida\", \"tableObject<T> class performs as expected.\\n\\nValidation logic is usually simple to test, because it i\", \"s typically a self-contained process where the output depends on the input. There should be tests on\", \" the results of invoking the Validate method on each property that has at least one associated valid\", \"ation rule, as demonstrated in the following code example:\\n\\n[TestMethod] public void CheckValidation\", \"PassesWhenBothPropertiesHaveDataTest() {\\n\\n98\\n\\nCHAPTER 13 | Unit testing\\n\\nvar mockViewModel = new Moc\", \"kViewModel(); mockViewModel.Forename.Value = \\\"John\\\"; mockViewModel.Surname.Value = \\\"Smith\\\";\\n\\nvar isV\", \"alid = mockViewModel.Validate();\\n\\nAssert.IsTrue(isValid); }\\n\\nThis unit test checks that validation s\", \"ucceeds when the two ValidatableObject<T> properties in the MockViewModel instance both have data.\\n\\n\", \"As well as checking that validation succeeds, validation unit tests should also check the values of \", \"the Value, IsValid, and Errors property of each ValidatableObject<T> instance, to verify that the cl\", \"ass performs as expected. The following code example demonstrates a unit test that does this:\\n\\n[Test\", \"Method] public void CheckValidationFailsWhenOnlyForenameHasDataTest() { var mockViewModel = new Mock\", \"ViewModel(); mockViewModel.Forename.Value = \\\"John\\\";\\n\\nbool isValid = mockViewModel.Validate();\\n\\nAsser\", \"t.IsFalse(isValid); Assert.IsNotNull(mockViewModel.Forename.Value); Assert.IsNull(mockViewModel.Surn\", \"ame.Value); Assert.IsTrue(mockViewModel.Forename.IsValid); Assert.IsFalse(mockViewModel.Surname.IsVa\", \"lid); Assert.AreEqual(mockViewModel.Forename.Errors.Count(), 0); Assert.AreNotEqual(mockViewModel.Su\", \"rname.Errors.Count(), 0); }\\n\\nThis unit test checks that validation fails when the Surname property o\", \"f the MockViewModel doesn\\u2019t have any data, and the Value, IsValid, and Errors property of each Valid\", \"atableObject<T> instance are correctly set.\\n\\nSummary\\n\\nA unit test takes a small unit of the app, typ\", \"ically a method, isolates it from the remainder of the code, and verifies that it behaves as expecte\", \"d. Its goal is to check that each unit of functionality performs as expected, so errors don\\u2019t propag\", \"ate throughout the app.\\n\\nThe behavior of an object under test can be isolated by replacing dependent\", \" objects with mock objects that simulate the behavior of the dependent objects. This enables unit te\", \"sts to be executed without requiring unwieldy resources such as runtime platform features, web servi\", \"ces, or databases\\n\\nTesting models and view models from MVVM applications is identical to testing any\", \" other classes, and the same tools and techniques can be used.\\n\\n99\\n\\nCHAPTER 13 | Unit testing\"]"