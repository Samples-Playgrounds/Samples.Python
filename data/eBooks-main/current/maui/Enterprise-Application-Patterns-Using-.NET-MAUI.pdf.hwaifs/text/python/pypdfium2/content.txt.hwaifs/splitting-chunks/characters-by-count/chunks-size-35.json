"[\"DOWNLOAD available at: https://aka.ms/maui-ebook\\nEDITION v2.0\\nPUBLISHED BY\\nMicrosoft Developer Divis\", \"ion, .NET, and Visual Studio product teams\\nA division of Microsoft Corporation\\nOne Microsoft Way\\nRed\", \"mond, Washington 98052-6399\\nCopyright \\u00a9 2022 by Microsoft Corporation\\nAll rights reserved. No part o\", \"f the contents of this book may be reproduced or transmitted in any \\nform or by any means without th\", \"e written permission of the publisher.\\nThis book is provided \\u201cas-is\\u201d and expresses the author\\u2019s view\", \"s and opinions. The views, opinions, and \\ninformation expressed in this book, including URL and othe\", \"r Internet website references, may change \\nwithout notice.\\nSome examples depicted herein are provide\", \"d for illustration only and are fictitious. No real association \\nor connection is intended or should\", \" be inferred.\\nMicrosoft and the trademarks listed at https://www.microsoft.com on the \\u201cTrademarks\\u201d w\", \"ebpage are \\ntrademarks of the Microsoft group of companies.\\nMac and macOS are trademarks of Apple In\", \"c.\\nAll other marks and logos are property of their respective owners.\\nAuthors:\\nMichael Stonis, Mobil\", \"e Software Architect, Eight-Bot\\nReviewers:\\nJames Montemagno, Principal Lead Program Manager, Microso\", \"ft Corp.\\nDavid Pine, Developer Relations, Microsoft Corp.\\nAcknowledgments\\nThis book originated from \", \"the excellent Enterprise Application Patterns using Xamarin.Forms eBook by \\nDavid Britch and Javier \", \"Suarez Ruiz. Without their hard work, detailed information, and excellent \\nexamples, this book would\", \" not be possible.\\nIntroduction\\nEnterprise applications face a number of difficult problems to solve \", \"including ever changing business \\nrequirements, the need for quick turn around time, support for mul\", \"tiple platforms, and integration \\nwith multiple systems. Due to the varying nature of these problems\", \", it\\u2019s important that our \\napplication\\u2019s architecture allows it to be modular, modifiable and extens\", \"ible over time.This book takes provides real world solutions for addressing these issues when buildi\", \"ng an enterprise \\napplication using .NET MAUI. This book uses a pre-built .NET MAUI application that\", \" serves as the \\nfront-end of an online eCommerce application as a reference and a guide for common e\", \"nterprise \\ndesign patterns. This book covers topics such as the MVVM pattern, dependency injection, \", \"navigation, \\nconfiguration, the loose-coupling of components and additional enterprise concerns. The\", \" content of \\nthis book is helpful for anyone looking to build a new application for this business or\", \" looking to solve \\nthe problems of applications that evolve over time.\\nWho should use the book\\nThis \", \"book is for .NET MAUI developers that are already familiar with the framework, but that are \\nlooking\", \" for guidance on architecture and implementation when building enterprise applications. This \\nbook c\", \"an help developers solve common problems using tried and true patterns.\\nHow to use the book\\nThis boo\", \"k focuses on building cross-platform enterprise apps using .NET MAUI. As such, it should be \\nread in\", \" its entirety to provide a foundation of understanding such apps and their technical \\nconsiderations\", \". The book, along with its sample app, can also serve as a starting point or reference for \\ncreating\", \" a new enterprise app. Use the associated sample app as a template for the new app, or to see \\nhow t\", \"o organize an app\\u2019s component parts. Then, refer back to this guide for architectural guidance. \\nYou\", \" can find the sample app on GitHub.\\nWhat this book doesn\\u2019t cover\\nThis book is aimed at readers who a\", \"re already familiar with .NET MAUI. It does cover some concepts \\nof .NET MAUI to help better illustr\", \"ate the topic, but it does not cover most controls and concepts in \\nany detail. For general guidance\", \" on building a new .NET MAUI app, please refer to the Building your \\nfirst app guide in the .NET MAU\", \"I documentation.\\nAdditional resources\\nFor official .NET MAUI content, see .NET MAUI docs. .NET MAUI \", \"is developed as an open-source \\nproject and is available on GitHub at dotnet/maui. For code samples \", \"developed with .NET MAUI, see \\nthe dotnet/maui-samples repo.i Contents\\nContents\\nPurpose.............\", \"....................................................................................................\", \".................... 1\\nWhat\\u2019s left out of this guide\\u2019s scope........................................\", \"........................................................................................1\\nWho should\", \" use this guide ....................................................................................\", \"..............................................................1\\nHow to use this guide...............\", \"....................................................................................................\", \".........................................2\\nIntroduction to .NET MAUI ...............................\", \"..................................................................... 3\\nSample application..........\", \"....................................................................................................\", \"....................................................4\\nSample application architecture ..............\", \"....................................................................................................\", \"......................5\\nMulti-Platform app..........................................................\", \"....................................................................................................\", \"....6\\nMulti-Platform app solution...................................................................\", \".............................................................................7\\neShop project........\", \"....................................................................................................\", \"................................................................7\\nSummary ..........................\", \"....................................................................................................\", \".......................................................8\\nModel-View-ViewModel (MVVM)................\", \"......................................................................... 9\\nThe MVVM pattern........\", \"....................................................................................................\", \"......................................................9\\nView .......................................\", \"....................................................................................................\", \"............................................ 10\\nViewModel ..........................................\", \"....................................................................................................\", \"............................ 11\\nModel...............................................................\", \"....................................................................................................\", \"................. 11\\nConnecting view models to views................................................\", \".................................................................................. 12\\nCreating a vie\", \"w model declaratively ..............................................................................\", \"............................................... 12\\nCreating a view model programmatically ..........\", \"....................................................................................................\", \"..... 13\\nUpdating views in response to changes in the underlying view model or model................\", \"...................... 13\\nMVVM Frameworks...........................................................\", \"................................................................................................... \", \"15\\nUI interaction using commands and behaviors .....................................................\", \"................................................... 15\\nImplementing commands .......................\", \"....................................................................................................\", \"...................... 16\\nInvoking commands from a view ............................................\", \"....................................................................................... 17\\nImplement\", \"ing behaviors ......................................................................................\", \".............................................................. 17\\nInvoking behaviors from a view....\", \"....................................................................................................\", \".............................. 20\\nSummary ..........................................................\", \"....................................................................................................\", \".................... 20\\nDependency injection .......................................................\", \".................................................... 21ii Contents\\nIntroduction to dependency inject\", \"ion.................................................................................................\", \"......................... 21\\nRegistration...........................................................\", \"....................................................................................................\", \".............. 23\\nResolution........................................................................\", \"....................................................................................................\", \".... 25\\nSummary ....................................................................................\", \".............................................................................................. 26\\nCo\", \"mmunicating between loosely coupled components ................................................... 2\", \"7\\nIntroduction to MVVM Toolkit Messenger............................................................\", \"..................................................... 27\\nDefining a message.........................\", \"....................................................................................................\", \"................................. 29\\nPublishing a message...........................................\", \"....................................................................................................\", \"........... 29\\nSubscribing to a message.............................................................\", \"..................................................................................... 30\\nUnsubscribi\", \"ng from a message...................................................................................\", \".................................................... 30\\nSummary ....................................\", \"....................................................................................................\", \".......................................... 31\\nNavigation............................................\", \".................................................................................. 32\\nNavigating bet\", \"ween pages .........................................................................................\", \"...................................................... 33\\nCreating the MauiNavigationService instanc\", \"e ..................................................................................................\", \"........ 34\\nHandling navigation requests............................................................\", \".............................................................................. 34\\nNavigating when th\", \"e app is launched...................................................................................\", \"....................................... 36\\nPassing parameters during navigation.....................\", \"....................................................................................................\", \" 36\\nInvoking navigation using behaviors ............................................................\", \"................................................................ 37\\nConfirming or cancelling navigat\", \"ion.................................................................................................\", \"............................ 38\\nSummary ............................................................\", \"....................................................................................................\", \".................. 38\\nValidation....................................................................\", \"........................................................... 39\\nSpecifying validation rules .........\", \"....................................................................................................\", \"................................... 40\\nAdding validation rules to a property .......................\", \"................................................................................................... \", \"42\\nTriggering validation ...........................................................................\", \"................................................................................ 42\\nTriggering valid\", \"ation manually......................................................................................\", \"............................................. 42\\nTriggering validation when properties change ......\", \".............................................................................................. 43\\nDi\", \"splaying validation errors .........................................................................\", \"..................................................................... 43\\nHighlighting a control that\", \" contains invalid data..............................................................................\", \".................. 44\\nDisplaying error messages ....................................................\", \"....................................................................................... 45\\nSummary .\", \"....................................................................................................\", \"............................................................................. 45\\nApplication setting\", \"s management ...................................................................................... \", \"46iii Contents\\nCreating a Settings Interface........................................................\", \".................................................................................... 46\\nAdding Setti\", \"ngs ................................................................................................\", \"..................................................................... 47\\nData binding to user settin\", \"gs..................................................................................................\", \"......................................... 48\\nSummary ...............................................\", \"....................................................................................................\", \"............................... 49\\nContainerized microservices .....................................\", \"........................................................... 50\\nMicroservices .......................\", \"....................................................................................................\", \"............................................... 51\\nContainerization ................................\", \"....................................................................................................\", \"................................ 53\\nCommunication between client and microservices .................\", \"............................................................................... 56\\nCommunication bet\", \"ween microservices..................................................................................\", \".................................... 57\\nSummary ....................................................\", \"....................................................................................................\", \".......................... 59\\nAccessing remote data.................................................\", \"......................................................... 60\\nIntroduction to Representational State \", \"Transfer............................................................................................\", \".......... 60\\nConsuming RESTful APIs................................................................\", \".................................................................................... 61\\nMaking web r\", \"equests ............................................................................................\", \".............................................................. 61\\nMaking a GET request..............\", \"....................................................................................................\", \"....................................... 61\\nMaking a POST request....................................\", \"....................................................................................................\", \".............. 64\\nMaking a DELETE request...........................................................\", \"....................................................................................... 67\\nCaching d\", \"ata.................................................................................................\", \".......................................................................... 68\\nManaging data expirati\", \"on..................................................................................................\", \"............................................... 69\\nCaching images ..................................\", \"....................................................................................................\", \"............................... 69\\nIncreasing resilience............................................\", \"....................................................................................................\", \"............. 70\\nRetry pattern......................................................................\", \"....................................................................................................\", \". 70\\nCircuit breaker pattern........................................................................\", \"................................................................................ 71\\nSummary ........\", \"....................................................................................................\", \"...................................................................... 72\\nAuthentication and authori\", \"zation ....................................................................................... 73\\nAu\", \"thentication........................................................................................\", \"................................................................................ 73\\nIssuing bearer t\", \"okens using IdentityServer..........................................................................\", \".................................. 74\\nAdding IdentityServer to a web application....................\", \"...................................................................................... 75\\nConfigurin\", \"g IdentityServer....................................................................................\", \"....................................................... 75\\nConfiguring API resources ...............\", \"....................................................................................................\", \"......................... 76\\nConfiguring identity resources ........................................\", \"........................................................................................... 76iv Con\", \"tents\\nConfiguring clients ..........................................................................\", \"................................................................................ 77\\nConfiguring the \", \"authentication flow ................................................................................\", \"........................................ 78\\nPerforming authentication ..............................\", \"....................................................................................................\", \"......... 79\\nSigning-in.............................................................................\", \"............................................................................................... 80\\nS\", \"igning-out..........................................................................................\", \"............................................................................... 83\\nAuthorization....\", \"....................................................................................................\", \".................................................................. 84\\nConfiguring IdentityServer to \", \"perform authorization ..............................................................................\", \".............. 85\\nMaking access requests to APIs....................................................\", \".................................................................................. 86\\nSummary ......\", \"....................................................................................................\", \"........................................................................ 87\\nMVVM Toolkit Features ..\", \"....................................................................................................\", \".. 88\\nMVVM Toolkit .................................................................................\", \"....................................................................................... 88\\nObservabl\", \"eObject.............................................................................................\", \".................................................................... 89\\nRelayCommand and AsyncRelayC\", \"ommand .............................................................................................\", \".................. 90\\nSource Generators ............................................................\", \"....................................................................................................\", \" 91\\nSummary ........................................................................................\", \".......................................................................................... 93\\nUnit t\", \"esting .............................................................................................\", \"............................... 94\\nDependency injection and unit testing............................\", \"............................................................................................ 95\\nTest\", \"ing MVVM applications...............................................................................\", \"............................................................... 95\\nTesting asynchronous functionalit\", \"y...................................................................................................\", \"............................ 96\\nTesting INotifyPropertyChanged implementations .....................\", \"........................................................................... 97\\nTesting message-based\", \" communication......................................................................................\", \"............................... 97\\nTesting exception handling ......................................\", \"....................................................................................................\", \".... 98\\nTesting validation..........................................................................\", \"........................................................................................ 98\\nSummary \", \"....................................................................................................\", \".............................................................................. 991 CHAPTER 1 | Purpo\", \"se\\nCHAPTER 1\\nPurpose\\nThis eBook provides guidance on building cross-platform enterprise apps using .\", \"NET MAUI. .NET \\nMAUI is a cross-platform UI toolkit that allows developers to easily create native u\", \"ser interface layouts \\nthat can be shared across platforms, including iOS, macOS, Android, and Windo\", \"ws. It provides a \\ncomprehensive solution for Business to Employee (B2E), Business to Business (B2B)\", \", and Business to \\nConsumer (B2C) apps, providing the ability to share code across all target platfo\", \"rms and helping to \\nlower the total cost of ownership (TCO).\\nThe guide provides architectural guidan\", \"ce for developing adaptable, maintainable, and testable .NET \\nMAUI enterprise apps. Guidance is prov\", \"ided on how to implement MVVM, dependency injection, \\nnavigation, validation, and configuration mana\", \"gement, while maintaining loose coupling. In addition, \\nthere\\u2019s also guidance on performing authenti\", \"cation and authorization with IdentityServer, accessing \\ndata from containerized microservices, and \", \"unit testing.\\nThe guide comes with source code for the eShop multi-platform app, and source code for\", \" the eShop \\nreference app. The eShop multi-platform app is a cross-platform enterprise app developed\", \" using .NET \\nMAUI, which connects to a series of containerized microservices known as the eShop refe\", \"rence app. \\nHowever, the eShop multi-platform app can be configured to consume data from mock servic\", \"es for \\nthose who wish to avoid deploying the containerized microservices.\\nWhat\\u2019s left out of this g\", \"uide\\u2019s scope\\nThis guide is aimed at readers who are already familiar with .NET MAUI. For a detailed \", \"introduction to \\n.NET MAUI, see the .NET MAUI documentation.\\nWho should use this guide\\nThe audience \", \"for this guide is mainly developers and architects who would like to learn how to \\narchitect and imp\", \"lement cross-platform enterprise apps using .NET MAUI.\\nA secondary audience is technical decision-ma\", \"kers who would like to receive an architectural and \\ntechnology overview before deciding on what app\", \"roach to select for cross-platform enterprise app \\ndevelopment using .NET MAUI.2 CHAPTER 1 | Purpose\", \"\\nHow to use this guide\\nThis guide focuses on building cross-platform enterprise apps using .NET MAUI\", \". As such, it should be \\nread in its entirety to provide a foundation of understanding such apps and\", \" their technical \\nconsiderations. The guide and its sample app can also serve as a starting point or\", \" reference for \\ncreating a new enterprise app. Use the associated sample app as a template for the n\", \"ew app or see \\nhow to organize an app\\u2019s component parts. Then, refer back to this guide for architec\", \"tural guidance.\\nFeel free to forward this guide to team members to help ensure a common understandin\", \"g of cross\\u0002platform enterprise app development using .NET MAUI. Having everybody working from a comm\", \"on \\nset of terminologies and underlying principles will help ensure a consistent application of arch\", \"itectural \\npatterns and practices.3 CHAPTER 2 | Introduction to .NET MAUI\\nCHAPTER 2\\nIntroduction to \", \".NET MAUI\\nRegardless of platform, developers of enterprise apps face several challenges:\\n\\u2022 App requi\", \"rements that can change over time.\\n\\u2022 New business opportunities and challenges.\\n\\u2022 Ongoing feedback d\", \"uring development that can significantly affect the scope and \\nrequirements of the app.\\nWith these i\", \"n mind, it\\u2019s important to build apps that can be easily modified or extended over time. \\nDesigning f\", \"or such adaptability can be difficult as it requires an architecture that allows individual \\nparts o\", \"f the app to be independently developed and tested in isolation without affecting the rest of \\nthe a\", \"pp.\\nMany enterprise apps are sufficiently complex to require more than one developer. It can be a \\ns\", \"ignificant challenge to decide how to design an app so that multiple developers can work effectively\", \" \\non different pieces of the app independently, while ensuring that the pieces come together seamles\", \"sly \\nwhen integrated into the app.\\nThe traditional approach to designing and building an app results\", \" in what is referred to as a \\nmonolithic app, where components are tightly coupled with no clear sep\", \"aration between them. \\nTypically, this monolithic approach leads to apps that are difficult and inef\", \"ficient to maintain, because \\nit can be difficult to resolve bugs without breaking other components \", \"in the app, and it can be \\ndifficult to add new features or to replace existing features.\\nAn effecti\", \"ve remedy for these challenges is to partition an app into discrete, loosely coupled \\ncomponents tha\", \"t can be easily integrated together into an app. Such an approach offers several \\nbenefits:\\n\\u2022 It all\", \"ows individual functionality to be developed, tested, extended, and maintained by \\ndifferent individ\", \"uals or teams.\\n\\u2022 It promotes reuse and a clean separation of concerns between the app\\u2019s horizontal \\n\", \"capabilities, such as authentication and data access, and the vertical capabilities, such as app \\nsp\", \"ecific business functionality. This allows the dependencies and interactions between app \\ncomponents\", \" to be more easily managed.\\n\\u2022 It helps maintain a separation of roles by allowing different individu\", \"als, or teams, to focus on \\na specific task or piece of functionality according to their expertise. \", \"In particular, it provides a \\ncleaner separation between the user interface and the app\\u2019s business l\", \"ogic.\\nHowever, there are many issues that must be resolved when partitioning an app into discrete, l\", \"oosely \\ncoupled components. These include:4 CHAPTER 2 | Introduction to .NET MAUI\\n\\u2022 Deciding how to \", \"provide a clean separation of concerns between the user interface controls \\nand their logic. One of \", \"the most important decisions when creating a .NET MAUI enterprise \\napp is whether to place business \", \"logic in code-behind files, or whether to create a clean \\nseparation of concerns between the user in\", \"terface controls and their logic, in order to make \\nthe app more maintainable and testable. For more\", \" information, see Model-View-ViewModel.\\n\\u2022 Determining whether to use a dependency injection containe\", \"r. Dependency injection \\ncontainers reduce the dependency coupling between objects by providing a fa\", \"cility to \\nconstruct instances of classes with their dependencies injected, and manage their lifetim\", \"e \\nbased on the configuration of the container. For more information, see Dependency injection.\\n\\u2022 Ch\", \"oosing between platform provided eventing and loosely coupled message-based \\ncommunication between c\", \"omponents that are inconvenient to link by object and type \\nreferences. For more information, see In\", \"troduction to Communicating between loosely \\ncoupled components.\\n\\u2022 Deciding how to navigate between \", \"pages, including how to invoke navigation, and where \\nnavigation logic should reside. For more infor\", \"mation, see Navigation.\\n\\u2022 Determining how to validate user input for correctness. The decision must \", \"include how to \\nvalidate user input, and how to notify the user about validation errors. For more in\", \"formation, \\nsee Validation.\\n\\u2022 Deciding how to perform authentication, and how to protect resources w\", \"ith authorization. For \\nmore information, see Authentication and authorization.\\n\\u2022 Determining how to\", \" access remote data from web services, including how to reliably retrieve \\ndata, and how to cache da\", \"ta. For more information, see Accessing remote data.\\n\\u2022 Deciding how to test the app. For more inform\", \"ation, see Unit testing.\\nThis guide provides guidance on these issues, and focuses on the core patte\", \"rns and architecture for \\nbuilding a cross-platform enterprise app using .NET MAUI. The guidance aim\", \"s to help to produce \\nadaptable, maintainable, and testable code, by addressing common .NET MAUI ent\", \"erprise app \\ndevelopment scenarios, and by separating the concerns of presentation, presentation log\", \"ic, and \\nentities through support for the Model-View-ViewModel (MVVM) pattern.\\nSample application\\nTh\", \"is guide includes a sample application, eShop, that\\u2019s an online store that includes the following \\nf\", \"unctionality:\\n\\u2022 Authenticating and authorizing against a backend service.\\n\\u2022 Browsing a catalog of it\", \"ems.\\n\\u2022 Filtering the catalog.\\n\\u2022 Ordering items from the catalog.\\n\\u2022 Viewing the user\\u2019s order history.\", \"\\n\\u2022 Configuration of settings.5 CHAPTER 2 | Introduction to .NET MAUI\\nSample application architecture\", \"\\nBelow is a high-level overview of the architecture of the sample application.\\nThe sample applicatio\", \"n ships with:\\n\\u2022 .NET Aspire App Hosting & Orchestration\\n\\u2022 An Blazor web application developed with A\", \"SP.NET Core.\\n\\u2022 A multi-platform app developed with .NET MAUI, which supports iOS, Android, macOS via\", \" \\nMac Catalyst, and Windows.\\nThe sample application includes the following backend services:\\n\\u2022 An id\", \"entity microservice, which uses ASP.NET Core Identity and IdentityServer.\\n\\u2022 A catalog microservice, \", \"which is a data-driven create, read, update, delete (CRUD) service that \\nconsumes an SQL Server data\", \"base using EntityFramework Core.\\n\\u2022 An ordering microservice, which is a domain-driven service that u\", \"ses domain-driven design \\npatterns.\\n\\u2022 A basket microservice, which is a data-driven CRUD service tha\", \"t uses Redis Cache.\\nThese backend services are implemented as microservices using ASP.NET Core, and \", \"are deployed as \\nunique containers with .NET Aspire. Collectively, these backend services are referr\", \"ed to as the eShop \\nreference application. Client apps communicate with the backend services through\", \" a Representational \\nState Transfer (REST) web interface. For more information about microservices a\", \"nd conainers, see \\nContainerized microservices.6 CHAPTER 2 | Introduction to .NET MAUI\\nMulti-Platfor\", \"m app\\nThis guide focuses on building cross-platform enterprise apps using .NET MAUI, and uses the eS\", \"hop \\nmulti-platform app as an example. The image below shows the pages from the eShop multi-platform\", \" \\napp that provide the functionality outlined earlier.\\nThe multi-platform app consumes the backend s\", \"ervices provided by the eShop reference application. \\nHowever, it can be configured to consume data \", \"from mock services for those who wish to avoid \\ndeploying the backend services.\\nThe eShop multi-plat\", \"form app exercises the following .NET MAUI functionality:7 CHAPTER 2 | Introduction to .NET MAUI\\n\\u2022 X\", \"AML\\n\\u2022 Controls\\n\\u2022 Bindings\\n\\u2022 Converters\\n\\u2022 Styles\\n\\u2022 Animations\\n\\u2022 Commands\\n\\u2022 Behaviors\\n\\u2022 Triggers\\n\\u2022 Eff\", \"ects\\n\\u2022 Custom Controls\\nFor more information about this functionality, see the .NET MAUI documentatio\", \"n.\\nIn addition, unit tests are provided for some of the classes in the eShop multi-platform app.\\nMul\", \"ti-Platform app solution\\nThe eShop multi-platform app solution organizes the source code and other r\", \"esources into a multiple \\nprojects. All of the core mobile components are contained in a singular pr\", \"oject named \\neShopContainers. This is a feature introduced with .NET 6 that allows a project to targ\", \"et multiple \\noutputs which helps eliminate the need for multiple platform projects that we would hav\", \"e used in \\nXamarin.Forms and earlier .NET versions. An additional project is included for unit testi\", \"ng.\\nWhile this project has all of its components stored in a singular project, it is worth consideri\", \"ng \\nseparating it into multiple projects based on your needs. For example, if you have multiple \\nimp\", \"lementations of service providers based off of a service with their own dependencies, it may make \\ns\", \"ense to break those service provider implementations out into their own separate project. Good \\ncand\", \"idates for project separation include shared models, service implementations, api client \\ncomponents\", \", database or caching layers. Any place where you feel that the business could re-use a \\ncomponent i\", \"n another project is a potential candidate for separation. These projects can then be \\npackaged via \", \"NuGet for easy distribution and versioning.\\nAll of the projects use folders to organize the source c\", \"ode and other resources into categories. The \\nclasses from the eShop multi-platform app can be re-us\", \"ed in any .NET MAUI app with little or no \\nmodification.\\neShop project\\nThe eShop project contains th\", \"e following folders:\\nFolder Description\\nAnimations Contains classes that enable animations to be con\", \"sumed in XAML.\\nBehaviors Contains behaviors that are exposed to view classes.8 CHAPTER 2 | Introduct\", \"ion to .NET MAUI\\nFolder Description\\nControls Contains custom controls used by the app.\\nConverters Co\", \"ntains value converters that apply custom logic to a binding.\\nExceptions Contains the custom Service\", \"AuthenticationException.\\nExtensions Contains extension methods for the VisualElement and IEnumerable\", \"<T> classes.\\nHelpers Contains helper classes for the app.\\nModels Contains the model classes for the \", \"app.\\nProperties Contains AssemblyInfo.cs, a .NET assembly metadata file.\\nServices Contains interface\", \"s and classes that implement services that are provided to the \\napp.\\nTriggers Contains the BeginAnim\", \"ation trigger, which is used to invoke an animation in XAML.\\nValidations Contains classes involved i\", \"n validating data input.\\nViewModels Contains the application logic that\\u2019s exposed to pages.\\nViews Co\", \"ntains the pages for the app.\\nSummary\\nMicrosoft\\u2019s cross-platform multi-platform app development tool\", \"s and platforms provide a \\ncomprehensive solution for B2E, B2B, and B2C mobile client apps, providin\", \"g the ability to share code \\nacross all target platforms (iOS, macOS, Android, and Windows) and help\", \"ing to lower the total cost of \\nownership. Apps can share their user interface and app logic code, w\", \"hile retaining the native platform \\nlook and feel.\\nDevelopers of enterprise apps face several challe\", \"nges that can alter the architecture of the app during \\ndevelopment. Therefore, it\\u2019s important to bu\", \"ild an app so that it can be modified or extended over \\ntime. Designing for such adaptability can be\", \" difficult, but typically involves partitioning an app into \\ndiscrete, loosely coupled components th\", \"at can be easily integrated together into an app.9 CHAPTER 3 | Model-View-ViewModel (MVVM)\\nCHAPTER 3\", \"\\nModel-View-ViewModel \\n(MVVM)\\nThe .NET MAUI developer experience typically involves creating a user \", \"interface in XAML, and then \\nadding code-behind that operates on the user interface. Complex mainten\", \"ance issues can arise as \\napps are modified and grow in size and scope. These issues include the tig\", \"ht coupling between the UI \\ncontrols and the business logic, which increases the cost of making UI m\", \"odifications, and the difficulty \\nof unit testing such code.\\nThe MVVM pattern helps cleanly separate\", \" an application\\u2019s business and presentation logic from its \\nuser interface (UI). Maintaining a clean\", \" separation between application logic and the UI helps address \\nnumerous development issues and make\", \"s an application easier to test, maintain, and evolve. It can \\nalso significantly improve code re-us\", \"e opportunities and allows developers and UI designers to \\ncollaborate more easily when developing t\", \"heir respective parts of an app.\\nThe MVVM pattern\\nThere are three core components in the MVVM patter\", \"n: the model, the view, and the view model. \\nEach serves a distinct purpose. The diagram below shows\", \" the relationships between the three \\ncomponents.\\nIn addition to understanding the responsibilities \", \"of each component, it\\u2019s also important to understand \\nhow they interact. At a high level, the view \\u201c\", \"knows about\\u201d the view model, and the view model \\u201cknows \\nabout\\u201d the model, but the model is unaware o\", \"f the view model, and the view model is unaware of the \\nview. Therefore, the view model isolates the\", \" view from the model, and allows the model to evolve \\nindependently of the view.\\nThe benefits of usi\", \"ng the MVVM pattern are as follows:10 CHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\u2022 If an existing model\", \" implementation encapsulates existing business logic, it can be difficult or \\nrisky to change it. In\", \" this scenario, the view model acts as an adapter for the model classes \\nand prevents you from makin\", \"g major changes to the model code.\\n\\u2022 Developers can create unit tests for the view model and the mod\", \"el, without using the view. \\nThe unit tests for the view model can exercise exactly the same functio\", \"nality as used by the \\nview.\\n\\u2022 The app UI can be redesigned without touching the view model and mode\", \"l code, provided \\nthat the view is implemented entirely in XAML or C#. Therefore, a new version of t\", \"he view \\nshould work with the existing view model.\\n\\u2022 Designers and developers can work independently\", \" and concurrently on their components \\nduring development. Designers can focus on the view, while de\", \"velopers can work on the view \\nmodel and model components.\\nThe key to using MVVM effectively lies in\", \" understanding how to factor app code into the correct \\nclasses and how the classes interact. The fo\", \"llowing sections discuss the responsibilities of each of the \\nclasses in the MVVM pattern.\\nView\\nThe \", \"view is responsible for defining the structure, layout, and appearance of what the user sees on \\nscr\", \"een. Ideally, each view is defined in XAML, with a limited code-behind that does not contain \\nbusine\", \"ss logic. However, in some cases, the code-behind might contain UI logic that implements \\nvisual beh\", \"avior that is difficult to express in XAML, such as animations.\\nIn a .NET MAUI application, a view i\", \"s typically a ContentPage-derived or ContentView-derived class. \\nHowever, views can also be represen\", \"ted by a data template, which specifies the UI elements to be \\nused to visually represent an object \", \"when it\\u2019s displayed. A data template as a view does not have any \\ncode-behind, and is designed to bi\", \"nd to a specific view model type.\\nTip\\nAvoid enabling and disabling UI elements in the code-behind.\\nE\", \"nsure that the view models are responsible for defining logical state changes that affect some \\naspe\", \"cts of the view\\u2019s display, such as whether a command is available, or an indication that an \\noperati\", \"on is pending. Therefore, enable and disable UI elements by binding to view model properties, \\nrathe\", \"r than enabling and disabling them in code-behind.\\nThere are several options for executing code on t\", \"he view model in response to interactions on the \\nview, such as a button click or item selection. If\", \" a control supports commands, the control\\u2019s Command \\nproperty can be data-bound to an ICommand prope\", \"rty on the view model. When the control\\u2019s \\ncommand is invoked, the code in the view model will be ex\", \"ecuted. In addition to commands, \\nbehaviors can be attached to an object in the view and can listen \", \"for either a command to be invoked \\nor the event to be raised. In response, the behavior can then in\", \"voke an ICommand on the view model \\nor a method on the view model.11 CHAPTER 3 | Model-View-ViewMode\", \"l (MVVM)\\nViewModel\\nThe view model implements properties and commands to which the view can data bind\", \" to, and \\nnotifies the view of any state changes through change notification events. The properties \", \"and \\ncommands that the view model provides define the functionality to be offered by the UI, but the\", \" view \\ndetermines how that functionality is to be displayed.\\nTip\\nKeep the UI responsive with asynchr\", \"onous operations.\\nMulti-platform apps should keep the UI thread unblocked to improve the user\\u2019s perc\", \"eption of \\nperformance. Therefore, in the view model, use asynchronous methods for I/O operations an\", \"d raise \\nevents to asynchronously notify views of property changes.\\nThe view model is also responsib\", \"le for coordinating the view\\u2019s interactions with any model classes that \\nare required. There\\u2019s typic\", \"ally a one-to-many relationship between the view model and the model \\nclasses. The view model might \", \"choose to expose model classes directly to the view so that controls in \\nthe view can data bind dire\", \"ctly to them. In this case, the model classes will need to be designed to \\nsupport data binding and \", \"change notification events.\\nEach view model provides data from a model in a form that the view can e\", \"asily consume. To \\naccomplish this, the view model sometimes performs data conversion. Placing this \", \"data conversion in \\nthe view model is a good idea because it provides properties that the view can b\", \"ind to. For example, \\nthe view model might combine the values of two properties to make it easier to\", \" display by the view.\\nTip\\nCentralize data conversions in a conversion layer.\\nIt\\u2019s also possible to u\", \"se converters as a separate data conversion layer that sits between the view \\nmodel and the view. Th\", \"is can be necessary, for example, when data requires special formatting that \\nthe view model doesn\\u2019t\", \" provide.\\nIn order for the view model to participate in two-way data binding with the view, its prop\", \"erties must \\nraise the PropertyChanged event. View models satisfy this requirement by implementing t\", \"he \\nINotifyPropertyChanged interface, and raising the PropertyChanged event when a property is \\nchan\", \"ged.\\nFor collections, the view-friendly ObservableCollection<T> is provided. This collection impleme\", \"nts \\ncollection changed notification, relieving the developer from having to implement the \\nINotifyC\", \"ollectionChanged interface on collections.\\nModel\\nModel classes are non-visual classes that encapsula\", \"te the app\\u2019s data. Therefore, the model can be \\nthought of as representing the app\\u2019s domain model, w\", \"hich usually includes a data model along with \\nbusiness and validation logic. Examples of model obje\", \"cts include data transfer objects (DTOs), Plain \\nOld CLR Objects (POCOs), and generated entity and p\", \"roxy objects.12 CHAPTER 3 | Model-View-ViewModel (MVVM)\\nModel classes are typically used in conjunct\", \"ion with services or repositories that encapsulate data \\naccess and caching.\\nConnecting view models \", \"to views\\nView models can be connected to views by using the data-binding capabilities of .NET MAUI. \", \"There \\nare many approaches that can be used to construct views and view models and associate them at\", \" \\nruntime. These approaches fall into two categories, known as view first composition, and view mode\", \"l \\nfirst composition. Choosing between view first composition and view model first composition is an\", \" \\nissue of preference and complexity. However, all approaches share the same aim, which is for the v\", \"iew \\nto have a view model assigned to its BindingContext property.\\nWith view first composition the a\", \"pp is conceptually composed of views that connect to the view \\nmodels they depend on. The primary be\", \"nefit of this approach is that it makes it easy to construct \\nloosely coupled, unit testable apps be\", \"cause the view models have no dependence on the views \\nthemselves. It\\u2019s also easy to understand the \", \"structure of the app by following its visual structure, \\nrather than having to track code execution \", \"to understand how classes are created and associated. In \\naddition, view first construction aligns w\", \"ith the Microsoft Maui\\u2019s navigation system that\\u2019s responsible \\nfor constructing pages when navigatio\", \"n occurs, which makes a view model first composition complex \\nand misaligned with the platform.\\nWith\", \" view model first composition, the app is conceptually composed of view models, with a service \\nresp\", \"onsible for locating the view for a view model. View model first composition feels more natural to \\n\", \"some developers, since the view creation can be abstracted away, allowing them to focus on the \\nlogi\", \"cal non-UI structure of the app. In addition, it allows view models to be created by other view \\nmod\", \"els. However, this approach is often complex, and it can become difficult to understand how the \\nvar\", \"ious parts of the app are created and associated.\\nTip\\nKeep view models and views independent.\\nThe bi\", \"nding of views to a property in a data source should be the view\\u2019s principal dependency on its \\ncorr\", \"esponding view model. Specifically, don\\u2019t reference view types, such as Button and ListView, from \\nv\", \"iew models. By following the principles outlined here, view models can be tested in isolation, \\nther\", \"efore reducing the likelihood of software defects by limiting scope.\\nThe following sections discuss \", \"the main approaches to connecting view models to views.\\nCreating a view model declaratively\\nThe simp\", \"lest approach is for the view to declaratively instantiate its corresponding view model in \\nXAML. Wh\", \"en the view is constructed, the corresponding view model object will also be constructed. \\nThis appr\", \"oach is demonstrated in the following code example:\\n<ContentPage xmlns:local=\\\"clr-namespace:eShop\\\">\\n\", \" <ContentPage.BindingContext>13 CHAPTER 3 | Model-View-ViewModel (MVVM)\\n <local:LoginViewModel />\\n <\", \"/ContentPage.BindingContext>\\n <!-- Omitted for brevity... -->\\n</ContentPage>\\nWhen the ContentPage is\", \" created, an instance of the LoginViewModel is automatically constructed \\nand set as the view\\u2019s Bind\", \"ingContext.\\nThis declarative construction and assignment of the view model by the view has the advan\", \"tage that \\nit\\u2019s simple, but has the disadvantage that it requires a default (parameter-less) constru\", \"ctor in the view \\nmodel.\\nCreating a view model programmatically\\nA view can have code in the code-beh\", \"ind file, resulting in the view-model being assigned to its \\nBindingContext property. This is often \", \"accomplished in the view\\u2019s constructor, as shown in the \\nfollowing code example:\\npublic LoginView()\\n\", \"{\\n InitializeComponent();\\n BindingContext = new LoginViewModel(navigationService);\\n}\\nThe programmati\", \"c construction and assignment of the view model within the view\\u2019s code-behind has \\nthe advantage tha\", \"t it\\u2019s simple. However, the main disadvantage of this approach is that the view \\nneeds to provide th\", \"e view model with any required dependencies. Using a dependency injection \\ncontainer can help to mai\", \"ntain loose coupling between the view and view model. For more \\ninformation, see Dependency injectio\", \"n.\\nUpdating views in response to changes in the \\nunderlying view model or model\\nAll view model and m\", \"odel classes that are accessible to a view should implement the \\n[INotifyPropertyChanged interface. \", \"Implementing this interface in a view model or model class allows \\nthe class to provide change notif\", \"ications to any data-bound controls in the view when the underlying \\nproperty value changes.\\nApp\\u2019s s\", \"hould be architected for the correct use of property change notification, by meeting the \\nfollowing \", \"requirements:\\n\\u2022 Always raising a PropertyChanged event if a public property\\u2019s value changes. Do not \", \"assume \\nthat raising the PropertyChanged event can be ignored because of knowledge of how XAML \\nbind\", \"ing occurs.\\n\\u2022 Always raising a PropertyChanged event for any calculated properties whose values are \", \"used \\nby other properties in the view model or model.\\n\\u2022 Always raising the PropertyChanged event at \", \"the end of the method that makes a property \\nchange, or when the object is known to be in a safe sta\", \"te. Raising the event interrupts the 14 CHAPTER 3 | Model-View-ViewModel (MVVM)\\noperation by invokin\", \"g the event\\u2019s handlers synchronously. If this happens in the middle of an \\noperation, it might expos\", \"e the object to callback functions when it is in an unsafe, partially \\nupdated state. In addition, i\", \"t\\u2019s possible for cascading changes to be triggered by \\nPropertyChanged events. Cascading changes gen\", \"erally require updates to be complete before \\nthe cascading change is safe to execute.\\n\\u2022 Never raisi\", \"ng a PropertyChanged event if the property does not change. This means that you \\nmust compare the ol\", \"d and new values before raising the PropertyChanged event.\\n\\u2022 Never raising the PropertyChanged event\", \" during a view model\\u2019s constructor if you are \\ninitializing a property. Data-bound controls in the v\", \"iew will not have subscribed to receive \\nchange notifications at this point.\\n\\u2022 Never raising more th\", \"an one PropertyChanged event with the same property name argument \\nwithin a single synchronous invoc\", \"ation of a public method of a class. For example, given a \\nNumberOfItems property whose backing stor\", \"e is the _numberOfItems field, if a method \\nincrements _numberOfItems fifty times during the executi\", \"on of a loop, it should only raise \\nproperty change notification on the NumberOfItems property once,\", \" after all the work is \\ncomplete. For asynchronous methods, raise the PropertyChanged event for a gi\", \"ven property \\nname in each synchronous segment of an asynchronous continuation chain.\\nA simple way t\", \"o provide this functionality would be to create an extension of the BindableObject class. \\nIn this e\", \"xample, the ExtendedBindableObject class provides change notifications, which is shown in \\nthe follo\", \"wing code example:\\npublic abstract class ExtendedBindableObject : BindableObject\\n{\\n public void Rais\", \"ePropertyChanged<T>(Expression<Func<T>> property)\\n {\\n var name = GetMemberInfo(property).Name;\\n OnPr\", \"opertyChanged(name);\\n }\\n private MemberInfo GetMemberInfo(Expression expression)\\n {\\n // Omitted for \", \"brevity ...\\n }\\n}\\n.NET MAUI\\u2019s BindableObject class implements the INotifyPropertyChanged interface, a\", \"nd provides an \\nOnPropertyChanged method. The ExtendedBindableObject class provides the RaisePropert\", \"yChanged \\nmethod to invoke property change notification, and in doing so uses the functionality prov\", \"ided by the \\nBindableObject class.\\nView model classes can then derive from the ExtendedBindableObjec\", \"t class. Therefore, each view \\nmodel class uses the RaisePropertyChanged method in the ExtendedBinda\", \"bleObject class to provide \\nproperty change notification. The following code example shows how the e\", \"Shop multi-platform app \\ninvokes property change notification by using a lambda expression:\\npublic b\", \"ool IsLogin\\n{\\n get => _isLogin;\\n set\\n {\\n _isLogin = value;\\n RaisePropertyChanged(() => IsLogin);15 C\", \"HAPTER 3 | Model-View-ViewModel (MVVM)\\n }\\n}\\nUsing a lambda expression in this way involves a small p\", \"erformance cost because the lambda \\nexpression has to be evaluated for each call. Although the perfo\", \"rmance cost is small and would not \\ntypically impact an app, the costs can accrue when there are man\", \"y change notifications. However, the \\nbenefit of this approach is that it provides compile-time type\", \" safety and refactoring support when \\nrenaming properties.\\nMVVM Frameworks\\nThe MVVM pattern is well \", \"established in .NET, and the community has created many frameworks \\nwhich help ease this development\", \". Each framework provides a different set of features, but it is \\nstandard for them to provide a com\", \"mon view model with an implementation of the \\nINotifyPropertyChanged interface. Additional features \", \"of MVVM frameworks include custom \\ncommands, navigation helpers, dependency injection/service locato\", \"r components, and UI platform \\nintegration. While it is not necessary to use these frameworks, they \", \"can speed up and standardize \\nyour development. The eShop multi-platform app uses the .NET Community\", \" MVVM Toolkit. When \\nchoosing a framework, you should consider your application\\u2019s needs and your tea\", \"m\\u2019s strengths. The \\nlist below includes some of the more common MVVM frameworks for .NET MAUI.\\n\\u2022 .NE\", \"T Community MVVM Toolkit\\n\\u2022 ReactiveUI\\n\\u2022 Prism Library\\nUI interaction using commands and behaviors\\nIn\", \" multi-platform apps, actions are typically invoked in response to a user action, such as a button \\n\", \"click, that can be implemented by creating an event handler in the code-behind file. However, in the\", \" \\nMVVM pattern, the responsibility for implementing the action lies with the view model, and placing\", \" \\ncode in the code-behind should be avoided.\\nCommands provide a convenient way to represent actions \", \"that can be bound to controls in the UI. \\nThey encapsulate the code that implements the action and h\", \"elp to keep it decoupled from its visual \\nrepresentation in the view. This way, your view models bec\", \"ome more portable to new platforms, as \\nthey do not have a direct dependency on events provided by t\", \"he platform\\u2019s UI framework. .NET MAUI \\nincludes controls that can be declaratively connected to a co\", \"mmand, and these controls will invoke \\nthe command when the user interacts with the control.\\nBehavio\", \"rs also allow controls to be declaratively connected to a command. However, behaviors can be \\nused t\", \"o invoke an action that\\u2019s associated with a range of events raised by a control. Therefore, \\nbehavio\", \"rs address many of the same scenarios as command-enabled controls, while providing a \\ngreater degree\", \" of flexibility and control. In addition, behaviors can also be used to associate command \\nobjects o\", \"r methods with controls that were not specifically designed to interact with commands.16 CHAPTER 3 |\", \" Model-View-ViewModel (MVVM)\\nImplementing commands\\nView models typically expose public properties, f\", \"or binding from the view, which implement the \\nICommand interface. Many .NET MAUI controls and gestu\", \"res provide a Command property, which can \\nbe data bound to an ICommand object provided by the view \", \"model. The button control is one of the \\nmost commonly used controls, providing a command property t\", \"hat executes when the button is \\nclicked.\\nNote\\nWhile it\\u2019s possible to expose the actual implementati\", \"on of the ICommand interface that your view \\nmodel uses (for example, Command<T> or RelayCommand), i\", \"t is recommended to expose your \\ncommands publicly as ICommand. This way, if you ever need to change\", \" the implementation at a later \\ndate, it can easily be swapped out.\\nThe ICommand interface defines a\", \"n Execute method, which encapsulates the operation itself, a \\nCanExecute method, which indicates whe\", \"ther the command can be invoked, and a \\nCanExecuteChanged event that occurs when changes occur that \", \"affect whether the command should \\nexecute. In most cases, we will only supply the Execute method fo\", \"r our commands. For a more \\ndetailed overview of ICommand, refer to the Commanding documentation for\", \" .NET MAUI.\\nProvided with .NET MAUI are the Command and Command<T> classes that implement the \\nIComm\", \"and interface, where T is the type of the arguments to Execute and CanExecute. Command and \\nCommand<\", \"T> are basic implementations that provide the minimal set of functionality needed for the \\nICommand \", \"interface.\\nNote\\nMany MVVM frameworks offer more feature rich implementations of the ICommand interfa\", \"ce.\\nThe Command or Command<T> constructor requires an Action callback object that\\u2019s called when the \", \"\\nICommand.Execute method is invoked. The CanExecute method is an optional constructor parameter, \\nan\", \"d is a Func that returns a bool.\\nThe eShop multi-platform app uses the RelayCommand and AsyncRelayCo\", \"mmand. The primary \\nbenefit for modern applications is that the AsyncRelayCommand provides better fu\", \"nctionality for \\nasynchronous operations.\\nThe following code shows how a Command instance, which rep\", \"resents a register command, is \\nconstructed by specifying a delegate to the Register view model meth\", \"od:\\npublic ICommand RegisterCommand { get; }\\nThe command is exposed to the view through a property t\", \"hat returns a reference to an ICommand. \\nWhen the Execute method is called on the Command object, it\", \" simply forwards the call to the method \\nin the view model via the delegate that was specified in th\", \"e Command constructor. An asynchronous \\nmethod can be invoked by a command by using the async and aw\", \"ait keywords when specifying the \\ncommand\\u2019s Execute delegate. This indicates that the callback is a \", \"Task and should be awaited. For 17 CHAPTER 3 | Model-View-ViewModel (MVVM)\\nexample, the following co\", \"de shows how an ICommand instance, which represents a sign-in command, \\nis constructed by specifying\", \" a delegate to the SignInAsync view model method:\\npublic ICommand SignInCommand { get; }\\n...\\nSignInC\", \"ommand = new AsyncRelayCommand(async () => await SignInAsync());\\nParameters can be passed to the Exe\", \"cute and CanExecute actions by using the \\nAsyncRelayCommand<T> class to instantiate the command. For\", \" example, the following code shows \\nhow an AsyncRelayCommand<T> instance is used to indicate that th\", \"e NavigateAsync method will \\nrequire an argument of type string:\\npublic ICommand NavigateCommand { g\", \"et; }\\n...\\nNavigateCommand = new AsyncRelayCommand<string>(NavigateAsync);\\nIn both the RelayCommand a\", \"nd RelayCommand<T> classes, the delegate to the CanExecute method \\nin each constructor is optional. \", \"If a delegate isn\\u2019t specified, the Command will return true for \\nCanExecute. However, the view model\", \" can indicate a change in the command\\u2019s CanExecute status by \\ncalling the ChangeCanExecute method on\", \" the Command object. This causes the CanExecuteChanged \\nevent to be raised. Any UI controls bound to\", \" the command will then update their enabled status to \\nreflect the availability of the data-bound co\", \"mmand.\\nInvoking commands from a view\\nThe following code example shows how a Grid in the LoginView bi\", \"nds to the RegisterCommand in the \\nLoginViewModel class by using a TapGestureRecognizer instance:\\n<G\", \"rid Grid.Column=\\\"1\\\" HorizontalOptions=\\\"Center\\\">\\n <Label Text=\\\"REGISTER\\\" TextColor=\\\"Gray\\\"/>\\n <Grid.Ge\", \"stureRecognizers>\\n <TapGestureRecognizer Command=\\\"{Binding RegisterCommand}\\\" NumberOfTapsRequired=\\\"1\", \"\\\"\\n/>\\n </Grid.GestureRecognizers>\\n</Grid>\\nA command parameter can also be optionally defined using th\", \"e CommandParameter property. The \\ntype of the expected argument is specified in the Execute and CanE\", \"xecute target methods. The \\nTapGestureRecognizer will automatically invoke the target command when t\", \"he user interacts with the \\nattached control. The CommandParameter, if provided, will be passed as t\", \"he argument to the \\ncommand\\u2019s Execute delegate.\\nImplementing behaviors\\nBehaviors allow functionality\", \" to be added to UI controls without having to subclass them. Instead, the \\nfunctionality is implemen\", \"ted in a behavior class and attached to the control as if it was part of the \\ncontrol itself. Behavi\", \"ors enable you to implement code that you would typically have to write as code\\u0002behind, because it d\", \"irectly interacts with the API of the control, in such a way that it can be concisely 18 CHAPTER 3 |\", \" Model-View-ViewModel (MVVM)\\nattached to the control, and packaged for reuse across more than one vi\", \"ew or app. In the context of \\nMVVM, behaviors are a useful approach for connecting controls to comma\", \"nds.\\nA behavior that\\u2019s attached to a control through attached properties is known as an attached beh\", \"avior. \\nThe behavior can then use the exposed API of the element to which it is attached to add func\", \"tionality \\nto that control, or other controls, in the visual tree of the view.\\nA .NET MAUI behavior \", \"is a class that derives from the Behavior or Behavior<T> class, where T is the \\ntype of the control \", \"to which the behavior should apply. These classes provide OnAttachedTo and \\nOnDetachingFrom methods,\", \" which should be overridden to provide logic that will be executed when \\nthe behavior is attached to\", \" and detached from controls.\\nIn the eShop multi-platform app, the BindableBehavior<T> class derives \", \"from the Behavior<T> class. \\nThe purpose of the BindableBehavior<T> class is to provide a base class\", \" for .NET MAUI behaviors that \\nrequire the BindingContext of the behavior to be set to the attached \", \"control.\\nThe BindableBehavior<T> class provides an overridable OnAttachedTo method that sets the \\nBi\", \"ndingContext of the behavior, and an overridable OnDetachingFrom method that cleans up the \\nBindingC\", \"ontext.\\nThe eShop multi-platform app includes an EventToCommandBehavior class which is provided by t\", \"he \\nMAUI Community toolkit. EventToCommandBehavior executes a command in response to an event \\noccur\", \"ring. This class derives from the BaseBehavior<View> class so that the behavior can bind to and \\nexe\", \"cute an ICommand specified by a Command property when the behavior is consumed. The \\nfollowing code \", \"example shows the EventToCommandBehavior class:\\n/// <summary>\\n/// The <see cref=\\\"EventToCommandBehav\", \"ior\\\"/> is a behavior that allows the user to invoke a \\n<see cref=\\\"ICommand\\\"/> through an event. It i\", \"s designed to associate Commands to events \\nexposed by controls that were not designed to support Co\", \"mmands. It allows you to map any \\narbitrary event on a control to a Command.\\n/// </summary>\\npublic c\", \"lass EventToCommandBehavior : BaseBehavior<VisualElement>\\n{\\n // Omitted for brevity...\\n /// <inherit\", \"doc/>\\n protected override void OnAttachedTo(VisualElement bindable)\\n {\\n base.OnAttachedTo(bindable);\", \"\\n RegisterEvent();\\n }\\n /// <inheritdoc/>\\n protected override void OnDetachingFrom(VisualElement bind\", \"able)\\n {\\n UnregisterEvent();\\n base.OnDetachingFrom(bindable);\\n }\\n static void OnEventNamePropertyCha\", \"nged(BindableObject bindable, object oldValue, object\\nnewValue)\\n => ((EventToCommandBehavior)bindabl\", \"e).RegisterEvent();\\n void RegisterEvent()\\n {19 CHAPTER 3 | Model-View-ViewModel (MVVM)\\n UnregisterEv\", \"ent();\\n var eventName = EventName;\\n if (View is null || string.IsNullOrWhiteSpace(eventName))\\n {\\n re\", \"turn;\\n }\\n eventInfo = View.GetType()?.GetRuntimeEvent(eventName) ??\\n throw new ArgumentException($\\\"{\", \"nameof(EventToCommandBehavior)}: Couldn't \\nresolve the event.\\\", nameof(EventName));\\n ArgumentNullExc\", \"eption.ThrowIfNull(eventInfo.EventHandlerType);\\n ArgumentNullException.ThrowIfNull(eventHandlerMetho\", \"dInfo);\\n eventHandler = eventHandlerMethodInfo.CreateDelegate(eventInfo.EventHandlerType,\\nthis) ??\\n \", \"throw new ArgumentException($\\\"{nameof(EventToCommandBehavior)}: Couldn't create \\nevent handler.\\\", na\", \"meof(EventName));\\n eventInfo.AddEventHandler(View, eventHandler);\\n }\\n void UnregisterEvent()\\n {\\n if \", \"(eventInfo is not null && eventHandler is not null)\\n {\\n eventInfo.RemoveEventHandler(View, eventHand\", \"ler);\\n }\\n eventInfo = null;\\n eventHandler = null;\\n }\\n /// <summary>\\n /// Virtual method that execute\", \"s when a Command is invoked\\n /// </summary>\\n /// <param name=\\\"sender\\\"></param>\\n /// <param name=\\\"eve\", \"ntArgs\\\"></param>\\n [Microsoft.Maui.Controls.Internals.Preserve(Conditional = true)]\\n protected virtua\", \"l void OnTriggerHandled(object? sender = null, object? eventArgs =\\nnull)\\n {\\n var parameter = Command\", \"Parameter\\n ?? EventArgsConverter?.Convert(eventArgs, typeof(object), null, null);\\n var command = Com\", \"mand;\\n if (command?.CanExecute(parameter) ?? false)\\n {\\n command.Execute(parameter);\\n }\\n }\\n}\\nThe OnAt\", \"tachedTo and OnDetachingFrom methods are used to register and deregister an event \\nhandler for the e\", \"vent defined in the EventName property. Then, when the event fires, the \\nOnTriggerHandled method is \", \"invoked, which executes the command.20 CHAPTER 3 | Model-View-ViewModel (MVVM)\\nThe advantage of usin\", \"g the EventToCommandBehavior to execute a command when an event fires, is \\nthat commands can be asso\", \"ciated with controls that weren\\u2019t designed to interact with commands. In \\naddition, this moves event\", \"-handling code to view models, where it can be unit tested.\\nInvoking behaviors from a view\\nThe Event\", \"ToCommandBehavior is particularly useful for attaching a command to a control that \\ndoesn\\u2019t support \", \"commands. For example, the LoginView uses the EventToCommandBehavior to \\nexecute the ValidateCommand\", \" when the user changes the value of their password, as shown in the \\nfollowing code:\\n<Entry\\n IsPassw\", \"ord=\\\"True\\\"\\n Text=\\\"{Binding Password.Value, Mode=TwoWay}\\\">\\n <!-- Omitted for brevity... -->\\n <Entry.B\", \"ehaviors>\\n <mct:EventToCommandBehavior\\n EventName=\\\"TextChanged\\\"\\n Command=\\\"{Binding ValidateCommand}\\\"\", \" />\\n </Entry.Behaviors>\\n <!-- Omitted for brevity... -->\\n</Entry>\\nAt runtime, the EventToCommandBeha\", \"vior will respond to interaction with the Entry. When a user \\ntypes into the Entry field, the TextCh\", \"anged event will fire, which will execute the ValidateCommand in \\nthe LoginViewModel. By default, th\", \"e event arguments for the event are passed to the command. If \\nneeded, the EventArgsConverter proper\", \"ty can be used to convert the EventArgs provided by the event \\ninto a value that the command expects\", \" as input.\\nFor more information about behaviors, see Behaviors on the .NET MAUI Developer Center.\\nSu\", \"mmary\\nThe Model-View-ViewModel (MVVM) pattern helps cleanly separate an application\\u2019s business and \\n\", \"presentation logic from its user interface (UI). Maintaining a clean separation between application \", \"\\nlogic and the UI helps address numerous development issues and makes an application easier to test,\", \" \\nmaintain, and evolve. It can also significantly improve code re-use opportunities and allows \\ndeve\", \"lopers and UI designers to collaborate more easily when developing their respective parts of an \\napp\", \".\\nUsing the MVVM pattern, the UI of the app and the underlying presentation and business logic are \\n\", \"separated into three separate classes: the view, which encapsulates the UI and UI logic; the view \\nm\", \"odel, which encapsulates presentation logic and state; and the model, which encapsulates the app\\u2019s \\n\", \"business logic and data.21 CHAPTER 4 | Dependency injection\\nCHAPTER 4\\nDependency injection\\nTypically\", \", a class constructor is invoked when instantiating an object, and any values that the object \\nneeds\", \" are passed as arguments to the constructor. This is an example of dependency injection known \\nas co\", \"nstructor injection. The dependencies the object needs are injected into the constructor.\\nBy specify\", \"ing dependencies as interface types, dependency injection enables decoupling the concrete \\ntypes fro\", \"m the code that depends on these types. It generally uses a container that holds a list of \\nregistra\", \"tions and mappings between interfaces and abstract types, and the concrete types that \\nimplement or \", \"extend these types.\\nThere are also other types of dependency injection, such as property setter inje\", \"ction and method call \\ninjection, but they are less commonly seen. Therefore, this chapter will focu\", \"s solely on performing \\nconstructor injection with a dependency injection container.\\nIntroduction to\", \" dependency injection\\nDependency injection is a specialized version of the Inversion of Control (IoC\", \") pattern, where the \\nconcern being inverted is the process of obtaining the required dependency. Wi\", \"th dependency \\ninjection, another class is responsible for injecting dependencies into an object at \", \"runtime. The \\nfollowing code example shows how the ProfileViewModel class is structured when using d\", \"ependency \\ninjection:\\nprivate readonly ISettingsService _settingsService;\\nprivate readonly IAppEnvir\", \"onmentService _appEnvironmentService;\\npublic ProfileViewModel(\\n IAppEnvironmentService appEnvironmen\", \"tService,\\n IDialogService dialogService,\\n INavigationService navigationService,\\n ISettingsService se\", \"ttingsService)\\n : base(dialogService, navigationService, settingsService)\\n{\\n _appEnvironmentService \", \"= appEnvironmentService;\\n _settingsService = settingsService;\\n // Omitted for brevity\\n}\\nThe ProfileV\", \"iewModel constructor receives multiple interface object instances as arguments injected \\nby another \", \"class. The only dependency in the ProfileViewModel class is on the interface types. \\nTherefore, the \", \"ProfileViewModel class doesn\\u2019t have any knowledge of the class that\\u2019s responsible for \\ninstantiating\", \" the interface objects. The class that\\u2019s responsible for instantiating the interface objects, \\nand i\", \"nserting it into the ProfileViewModel class, is known as the dependency injection container.22 CHAPT\", \"ER 4 | Dependency injection\\nDependency injection containers reduce the coupling between objects by p\", \"roviding a facility to \\ninstantiate class instances and manage their lifetime based on the configura\", \"tion of the container. \\nDuring object creation, the container injects any dependencies that the obje\", \"ct requires into it. If those \\ndependencies have not yet been created, the container creates and res\", \"olves their dependencies first.\\nThere are several advantages to using a dependency injection contain\", \"er:\\n\\u2022 A container removes the need for a class to locate its dependencies and manage its lifetimes.\\n\", \"\\u2022 A container allows the mapping of implemented dependencies without affecting the class.\\n\\u2022 A contai\", \"ner facilitates testability by allowing dependencies to be mocked.\\n\\u2022 A container increases maintaina\", \"bility by allowing new classes to be easily added to the app.\\nIn the context of a .NET MAUI app that\", \" uses MVVM, a dependency injection container will typically be \\nused for registering and resolving v\", \"iews, registering and resolving view models, and for registering \\nservices and injecting them into v\", \"iew models.\\nThere are many dependency injection containers available in .NET; the eShop multi-platfo\", \"rm app uses \\nMicrosoft.Extensions.DependencyInjection to manage the instantiation of views, view mod\", \"els, and \\nservice classes in the app. Microsoft.Extensions.DependencyInjection facilitates building \", \"loosely \\ncoupled apps, and provides all of the features commonly found in dependency injection conta\", \"iners, \\nincluding methods to register type mappings and object instances, resolve objects, manage ob\", \"ject \\nlifetimes, and inject dependent objects into constructors of objects that it resolves. For mor\", \"e \\ninformation about Microsoft.Extensions.DependencyInjection, see Dependency injection in .NET.\\nIn \", \".NET MAUI, the MauiProgram class will call into the CreateMauiApp method to create a \\nMauiAppBuilder\", \" object. The MauiAppBuilder object has a Services property of type IServiceCollection, \\nwhich provid\", \"es a place to register our components, such as views, view models, and services for \\ndependency inje\", \"ction. Any components registered with the Services property will be provided to the \\ndependency inje\", \"ction container when the MauiAppBuilder.Build method is called.\\nAt runtime, the container must know \", \"which implementation of the services are being requested in \\norder to instantiate them for the reque\", \"sted objects. In the eShop multi-platform app, the \\nIAppEnvironmentService, IDialogService , INaviga\", \"tionService, and ISettingsService interfaces need to \\nbe resolved before it can instantiate a Profil\", \"eViewModel object. This involves the container performing \\nthe following actions:\\n\\u2022 Deciding how to \", \"instantiate an object that implements the interface. This is known as \\nregistration.\\n\\u2022 Instantiating\", \" the object that implements the required interface and the ProfileViewModel \\nobject. This is known a\", \"s resolution.\\nEventually, the app will finish using the ProfileViewModel object, and it will become \", \"available for \\ngarbage collection. At this point, the garbage collector should dispose of any short-\", \"lived interface \\nimplementations if other classes do not share the same instance.23 CHAPTER 4 | Depe\", \"ndency injection\\nRegistration\\nBefore dependencies can be injected into an object, the types of the d\", \"ependencies must first be \\nregistered with the container. Registering a type involves passing the co\", \"ntainer an interface and a \\nconcrete type that implements the interface.\\nThere are two ways of regis\", \"tering types and objects in the container through code:\\n\\u2022 Register a type or mapping with the contai\", \"ner. This is known as transient registration. When \\nrequired, the container will build an instance o\", \"f the specified type.\\n\\u2022 Register an existing object in the container as a singleton. When required, \", \"the container will \\nreturn a reference to the existing object.\\nNote\\nDependency injection containers \", \"are not always suitable. Dependency injection introduces additional \\ncomplexity and requirements tha\", \"t might not be appropriate or useful to small apps. If a class does not \\nhave any dependencies, or i\", \"s not a dependency for other types, it might not make sense to put it in \\nthe container. In addition\", \", if a class has a single set of dependencies that are integral to the type and \\nwill never change, \", \"it might not make sense to put it in the container.\\nThe registration of types requiring dependency i\", \"njection should be performed in a single method in \\nan app. This method should be invoked early in t\", \"he app\\u2019s lifecycle to ensure it is aware of the \\ndependencies between its classes. The eShop multi-p\", \"latform app performs this the \\nMauiProgram.CreateMauiApp method. The following code example shows ho\", \"w the eShop multi\\u0002platform app declares the CreateMauiApp in the MauiProgram class:\\npublic static cl\", \"ass MauiProgram\\n{\\n public static MauiApp CreateMauiApp()\\n => MauiApp.CreateBuilder()\\n .UseMauiApp<Ap\", \"p>()\\n // Omitted for brevity \\n .RegisterAppServices()\\n .RegisterViewModels()\\n .RegisterViews()\\n .Bui\", \"ld();\\n}\\nThe MauiApp.CreateBuilder method creates a MauiAppBuilder object that we can use to register\", \" our \\ndependencies. Many dependencies in the eShop multi-platform app need to be registered, so the \", \"\\nextension methods RegisterAppServices, RegisterViewModels, and RegisterViews were created to help \\n\", \"provide an organized and maintainable registration workflow. The following code shows the \\nRegisterV\", \"iewModels method:\\npublic static MauiAppBuilder RegisterViewModels(this MauiAppBuilder mauiAppBuilder\", \")\\n{\\n mauiAppBuilder.Services.AddSingleton<ViewModels.MainViewModel>();\\n mauiAppBuilder.Services.AddS\", \"ingleton<ViewModels.LoginViewModel>();\\n mauiAppBuilder.Services.AddSingleton<ViewModels.BasketViewMo\", \"del>();\\n mauiAppBuilder.Services.AddSingleton<ViewModels.CatalogViewModel>();\\n mauiAppBuilder.Servic\", \"es.AddSingleton<ViewModels.ProfileViewModel>();24 CHAPTER 4 | Dependency injection\\n mauiAppBuilder.S\", \"ervices.AddTransient<ViewModels.CheckoutViewModel>();\\n mauiAppBuilder.Services.AddTransient<ViewMode\", \"ls.OrderDetailViewModel>();\\n mauiAppBuilder.Services.AddTransient<ViewModels.SettingsViewModel>();\\n \", \"mauiAppBuilder.Services.AddTransient<ViewModels.CampaignViewModel>();\\n mauiAppBuilder.Services.AddTr\", \"ansient<ViewModels.CampaignDetailsViewModel>();\\n return mauiAppBuilder;\\n}\\nThis method receives an in\", \"stance of MauiAppBuilder, and we can use the Services property to register \\nour view models. Dependi\", \"ng on the needs of your application, you may need to add services with \\ndifferent lifetimes. The fol\", \"lowing table provides information on when you may want to choose these \\ndifferent registration lifet\", \"imes:\\nMethod Description\\nAddSingleton<T> Will create a single instance of the object which \\nwill be \", \"remain for the lifetime of the application.\\nAddTransient<T> Will create a new instance of the object\", \" when \\nrequested during resolution. Transient objects \\ndo not have a pre-defined lifetime, but will \", \"\\ntypically follow the lifetime of their host.\\nNote\\nThe view models do not inherit from an interface,\", \" so they only need their concrete type provided to \\nthe AddSingleton<T> and AddTransient<T> methods.\", \"\\nThe CatalogViewModel is used near the application\\u2019s root and should always be available, so \\nregist\", \"ering it with AddSingleton<T> is beneficial. Other view models, such as CheckoutViewModel \\nand Order\", \"DetailViewModel are situationally navigated to or are used later in the application. Suppose \\nyou kn\", \"ow that you have a component that may not always be used. In that case, if it is memory or \\ncomputat\", \"ionally intensive or requires just-in-time data, it may be a better candidate for \\nAddTransient<T> r\", \"egistration.\\nAnother common way to add services is using the AddSingleton<TService, TImplementation>\", \" and \\nAddTransient<TService, TImplementation> methods. These methods take two input types: the \\ninte\", \"rface definition and the concrete implementation. This type of registration is best for cases where \", \"\\nyou are implementing services based on interfaces. In the code example below, we register our \\nISet\", \"tingsService interface using the SettingsService implementation:\\npublic static MauiAppBuilder Regist\", \"erAppServices(this MauiAppBuilder mauiAppBuilder)\\n{\\n mauiAppBuilder.Services.AddSingleton<ISettingsS\", \"ervice, SettingsService>();\\n // Omitted for brevity...\\n}\\nOnce all services have been registered, the\", \" MauiAppBuilder.Build method should be called to create \\nour MauiApp and populate our dependency inj\", \"ection container with all the registered services.25 CHAPTER 4 | Dependency injection\\nImportant\\nOnce\", \" the Build method has been called, the dependency injection container is immutable and can no \\nlonge\", \"r be updated or modified. Ensure that all services that you need within your application have \\nbeen \", \"registered before you call Build.\\nResolution\\nAfter a type is registered, it can be resolved or injec\", \"ted as a dependency. When a type is being \\nresolved, and the container needs to create a new instanc\", \"e, it injects any dependencies into the \\ninstance.\\nGenerally, when a type is resolved, one of three \", \"things happens:\\n1. If the type hasn\\u2019t been registered, the container throws an exception.\\n2. If the \", \"type has been registered as a singleton, the container returns the singleton instance. If \\nthis is t\", \"he first time the type is called for, the container creates it if required and maintains a \\nreferenc\", \"e to it.\\n3. If the type has been registered as transient, the container returns a new instance and d\", \"oesn\\u2019t \\nmaintain a reference to it.\\n.NET MAUI offers a number of ways to resolve registered componen\", \"ts based on your needs. The most \\ndirect way to gain access to the dependency injection container is\", \" from an Element using the \\nHandler.MauiContext.Services. An example of this is shown below:\\nvar set\", \"tingsService = this.Handler.MauiContext.Services.GetServices<ISettingsService>();\\nThis can be helpfu\", \"l if you need to resolve a service from within an Element or from outside of the \\nconstructor of you\", \"r Element.\\nCaution\\nThere is a possibility that the Handler property of your Element may be null, so \", \"be aware that you may \\nneed to handle those situations. For more information, please refer to Handle\", \"r lifecycle on the \\nMicrosoft Documentation Center.\\nIf using the Shell control for .NET MAUI, it wil\", \"l implicitly call into the dependency injection container \\nto create our objects during navigation. \", \"When setting up our Shell control, the Routing.RegisterRoute \\nmethod will tie a route path to a View\", \" as shown in the example below:\\nRouting.RegisterRoute(\\\"Filter\\\", typeof(FiltersView));\\nDuring Shell n\", \"avigation, it will look for registrations of the FiltersView, and if any are found, it will \\ncreate \", \"that view and inject any dependencies into the constructor. As shown in the code example \\nbelow, the\", \" CatalogViewModel will be injected into the FiltersView:\\nnamespace eShop.Views;\\npublic partial class\", \" FiltersView : ContentPage\\n{26 CHAPTER 4 | Dependency injection\\n public FiltersView(CatalogViewModel\", \" viewModel)\\n {\\n BindingContext = viewModel;\\n InitializeComponent();\\n }\\n}\\nTip\\nThe dependency injectio\", \"n container is great for creating view model instances. If a view model has \\ndependencies, it will h\", \"andle the creation and injection of any required services. Just make sure that \\nyou register your vi\", \"ew models and any dependencies that they may have with the CreateMauiApp \\nmethod in the MauiProgram \", \"class.\\nSummary\\nDependency injection enables the decoupling of concrete types from the code that depe\", \"nds on these \\ntypes. It typically uses a container that holds a list of registrations and mappings b\", \"etween interfaces \\nand abstract types, and the concrete types that implement or extend these types.\\n\", \"Microsoft.Extensions.DependencyInjection facilitates building loosely coupled apps and provides all \", \"of \\nthe features commonly found in dependency injection containers, including methods to register ty\", \"pe \\nmappings and object instances, resolve objects, manage object lifetimes, and inject dependent ob\", \"jects \\ninto constructors of objects it resolves.27 CHAPTER 5 | Communicating between loosely coupled\", \" components\\nCHAPTER 5\\nCommunicating between \\nloosely coupled \\ncomponents\\nThe publish-subscribe patte\", \"rn is a messaging pattern in which publishers send messages without \\nknowing any receivers, known as\", \" subscribers. Similarly, subscribers listen for specific messages, \\nwithout knowing any publishers.\\n\", \"Events in .NET implement the publish-subscribe pattern and are the most simple approach for a \\ncommu\", \"nication layer between components if loose coupling is not required, such as a control and the \\npage\", \" that contains it. However, the publisher and subscriber lifetimes are coupled by object \\nreferences\", \" to each other, and the subscriber type must have a reference to the publisher type. This \\ncan creat\", \"e memory management issues, especially when there are short-lived objects that subscribe \\nto an even\", \"t of a static or long-lived object. If the event handler isn\\u2019t removed, the subscriber will be \\nkept\", \" alive by the reference to it in the publisher, and this will prevent or delay the garbage collectio\", \"n \\nof the subscriber.\\nIntroduction to MVVM Toolkit Messenger\\nThe MVVM Toolkit IMessenger interface d\", \"escribes the publish-subscribe pattern, allowing message\\u0002based communication between components that\", \" are inconvenient to link by object and type \\nreferences. This mechanism allows publishers and subsc\", \"ribers to communicate without having a direct \\nreference to each other, helping to reduce dependenci\", \"es between components, while also allowing \\ncomponents to be independently developed and tested.\\nNot\", \"e\\nThe MVVM Toolkit Messenger is part of the CommunityToolkit.Mvvm package. For information on \\nhow t\", \"o add the package to your project, see Introduction to the MVVM Toolkit on the Microsoft \\nDeveloper \", \"Center.28 CHAPTER 5 | Communicating between loosely coupled components\\nWarning\\n.NET MAUI contains a \", \"built-in MessagingCenter class that\\u2019s no longer recommended for use. Use the \\nMVVM Toolkit Messenger\", \" instead.\\nThe IMessenger interface allows for multicast publish-subscribe functionality. This means \", \"that there \\ncan be multiple publishers that publish a single message, and there can be multiple subs\", \"cribers \\nlistening to the same message. The image below illustrates this relationship:\\nThere are two\", \" implementations of the IMessenger interface that come with the \\nCommunityToolkit.Mvvm package. The \", \"WeakReferenceMessenger uses weak references which can \\nresult in easier cleanup for message subscrib\", \"ers. This is a good option if your subscribers do not have \\na clearly defined lifecycle. The StrongR\", \"eferenceMessenger uses strong references which can result in \\nbetter performance and a more clearly \", \"controlled lifetime of the subscription. If you have a workflow \\nwith a very controlled lifetime (fo\", \"r example, a subscription that is bound to a page\\u2019s OnAppearing and \\nOnDisappearing methods), the St\", \"rongReferenceManager may be a better option, if performance is a \\nconcern. Both of these implementat\", \"ions are available with default implementations ready to use by \\nreferencing either WeakReferenceMes\", \"senger.Default or StrongReferenceMessenger.Default.\\nNote\\nWhile the IMessenger interface permits comm\", \"unication between loosely-coupled classes, it does not \\noffer the only architectural solution to thi\", \"s issue. For example, communication between a view model \\nand a view can also be achieved by the bin\", \"ding engine and through property change notifications. In \\naddition, communication between two view \", \"models can also be achieved by passing data during \\nnavigation.\\nThe eShop multi-platform app uses th\", \"e WeakReferenceMessenger class to communicate between \\nloosely coupled components. The app defines a\", \" single message named AddProductMessage. The \\nAddProductMessage is published by the CatalogViewModel\", \" class when an item is added to the \\nshopping basket. In return, the CatalogView class subscribes to\", \" the message and uses this to highlight \\nthe product adds with animation in response.\\nIn the eShop m\", \"ulti-platform app, WeakReferenceMessenger is used to update the UI in response to \\nan action occurri\", \"ng in another class. Therefore, messages are published from the thread that the class \\nis executing \", \"on, with subscribers receiving the message on the same thread.29 CHAPTER 5 | Communicating between l\", \"oosely coupled components\\nTip\\nMarshal to the UI or main thread when performing UI updates. If update\", \"s to user interfaces are not \\nmade on this thread, it can cause the application to crash or become u\", \"nstable.\\nIf a message that\\u2019s sent from a background thread is required to update the UI, process the\", \" message \\non the UI thread in the subscriber by invoking the MainThread.BeginInvokeOnMainThread meth\", \"od.\\nFor more information about Messenger, see Messenger on the Microsoft Developer Center.\\nDefining \", \"a message\\nIMessenger messages are custom objects that provide custom payloads. The following code ex\", \"ample \\nshows the AddProductMessage message defined within the eShop multi-platform app:\\npublic class\", \" AddProductMessage : ValueChangedMessage<int>\\n{\\n public AddProductMessage(int count) : base(count)\\n \", \"{\\n }\\n}\\nThe base class is defined using ValueChangedMessage<T> where T can be of any type needed to \\n\", \"pass data. Both message publishers and subscribers can expect messages of a specific type (for \\nexam\", \"ple, AddProductMessage). This can help ensure that both parties have agreed to a messaging \\ncontract\", \" and that the data provided with that contract will be consistent. Additionally, this approach \\nprov\", \"ides compile-time type safety and refactoring support.\\nPublishing a message\\nTo publish a message, we\", \" will need to use the IMessenger.Send method. This can be accessed most \\ncommonly through WeakRefere\", \"nceMessenger.Default.Send or \\nStrongReferenceMessenger.Default.Send. The message sent can be of any \", \"object type. The following \\ncode example demonstrates publishing the AddProduct message:\\nWeakReferen\", \"ceMessenger.Default.Send(new Messages.AddProductMessage(BadgeCount));\\nIn this example, the Send meth\", \"od specifies provides a new instance of the AddProductMessage object \\nfor downstream subscribers to \", \"receive. An additional second token parameter can be added to use \\nwhen multiple different subscribe\", \"rs need to receive messages of the same type without receiving the \\nwrong message.\\nThe Send method w\", \"ill publish the message, and its payload data, using a fire-and-forget approach. \\nTherefore, the mes\", \"sage is sent even if there are no subscribers registered to receive the message. In \\nthis situation,\", \" the sent message is ignored.30 CHAPTER 5 | Communicating between loosely coupled components\\nSubscri\", \"bing to a message\\nSubscribers can register to receive a message using one of the IMessenger.Register\", \"<T> overloads. \\nThe following code example demonstrates how the eShop multi-platform app subscribes \", \"to, and \\nprocesses, the AddProductMessage message:\\nWeakReferenceMessenger.Default\\n .Register<Catalog\", \"View, Messages.AddProductMessage>(\\n this,\\n async (recipient, message) =>\\n {\\n await recipient.Dispatc\", \"her.DispatchAsync(\\n async () =>\\n {\\n await recipient.badge.ScaleTo(1.2);\\n await recipient.badge.Scale\", \"To(1.0);\\n });\\n });\\nIn the preceding example, the Register method subscribes to the AddProductMessage\", \" message and \\nexecutes a callback delegate in response to receiving the message. This callback deleg\", \"ate, specified as \\na lambda expression, executes code that updates the UI.\\nNote\\nAvoid the use of thi\", \"s within your callback delegate to avoid capturing that object within the delegate. \\nThis can help i\", \"mprove performance. Instead, use the recipient parameter.\\nIf payload data is supplied, don\\u2019t attempt\", \" to modify the payload data from within a callback delegate \\nbecause several threads could be access\", \"ing the received data simultaneously. In this scenario, the \\npayload data should be immutable to avo\", \"id concurrency errors.\\nUnsubscribing from a message\\nSubscribers can unsubscribe from messages they n\", \"o longer want to receive. This is achieved with one \\nof the IMessenger.Unregister overloads, as demo\", \"nstrated in the following code example:\\nWeakReferenceMessenger.Default.Unregister<Messages.AddProduc\", \"tMessage>(this);\\nNote\\nIn this example, it isn\\u2019t fully necessary to call Unregister as the WeakRefere\", \"nceMessenger will allow \\nunused objects to be garbage collected. If the StrongReferenceMessenger wer\", \"e used, it would be \\nadvised to call Unregister for any subscriptions that are no longer in use.\\nIn \", \"this example, the Unsubscribe method syntax specifies the type argument of the message and the \\nreci\", \"pient object that is listening for messages.31 CHAPTER 5 | Communicating between loosely coupled com\", \"ponents\\nSummary\\nThe MVVM Toolkit IMessenger interface describes the publish-subscribe pattern, allow\", \"ing message\\u0002based communication between components that are inconvenient to link by object and type \", \"\\nreferences. This mechanism allows publishers and subscribers to communicate without having a \\nrefer\", \"ence to each other, helping to reduce dependencies between components, while also allowing \\ncomponen\", \"ts to be independently developed and tested.32 CHAPTER 6 | Navigation\\nCHAPTER 6\\nNavigation\\n.NET MAUI\", \" includes support for page navigation, which typically results from the user\\u2019s interaction \\nwith the\", \" UI or from the app itself as a result of internal logic-driven state changes. However, \\nnavigation \", \"can be complex to implement in apps that use the Model-View-ViewModel (MVVM) \\npattern, as the follow\", \"ing challenges must be met:\\n\\u2022 Identifying the view to be navigated to using an approach that does no\", \"t introduce tight \\ncoupling and dependencies between views.\\n\\u2022 Coordinating the process by which the \", \"view to be navigated to is instantiated and initialized. \\nWhen using MVVM, the view and view-model n\", \"eed to be instantiated and associated with \\neach other via the view\\u2019s binding context. When an app i\", \"s using a dependency injection \\ncontainer, the instantiation of views and view-models might require \", \"a specific construction \\nmechanism.\\n\\u2022 Whether to perform view-first navigation, or view-model-first \", \"navigation. With view-first \\nnavigation, the page to navigate to refers to the name of the view type\", \". During navigation, \\nthe specified view is instantiated, along with its corresponding view-model an\", \"d other \\ndependent services. An alternative approach is to use view-model-first navigation, where th\", \"e \\npage to navigate to refers to the name of the view-model type.\\n\\u2022 Determining how to cleanly separ\", \"ate the navigational behavior of the app across the views \\nand view-models. The MVVM pattern separat\", \"es the app\\u2019s UI and its presentation and business \\nlogic, but it doesn\\u2019t provide a direct mechanism \", \"for tying them together. However, the \\nnavigation behavior of an app will often span the UI and pres\", \"entation parts of the app. The \\nuser will often initiate navigation from a view, and the view will b\", \"e replaced as a result of the \\nnavigation. However, navigation might often also need to be initiated\", \" or coordinated from \\nwithin the view-model.\\n\\u2022 Determining how to pass parameters during navigation \", \"for initialization purposes. For \\nexample, if the user navigates to a view to update order details, \", \"the order data will have to be \\npassed to the view so that it can display the correct data.\\n\\u2022 Coordi\", \"nating navigation to ensure that specific business rules are obeyed. For example, users \\nmight be pr\", \"ompted before navigating away from a view so that they can correct any invalid \\ndata or be prompted \", \"to submit or discard any data changes that were made within the view.\\nThis chapter addresses these c\", \"hallenges by presenting a navigation service class named \\nMauiNavigationService that\\u2019s used to perfo\", \"rm view-model-first page navigation.\\nNote\\nThe MauiNavigationService used by the app is simplistic an\", \"d does not cover all possible navigation \\ntypes. The types of navigation needed by your application \", \"may require additional functionality.33 CHAPTER 6 | Navigation\\nNavigating between pages\\nNavigation l\", \"ogic can reside in a view\\u2019s code-behind or a data-bound view-model. While placing \\nnavigation logic \", \"in a view might be the most straightforward approach, it is not easily testable \\nthrough unit tests.\", \" Putting navigation logic in view-model classes means that the logic can be verified \\nthrough unit t\", \"ests. In addition, the view-model can then implement logic to control navigation to \\nensure that cer\", \"tain business rules are enforced. For example, an app might not allow the user to \\nnavigate away fro\", \"m a page without first ensuring that the entered data is valid.\\nA navigation service is typically in\", \"voked from view-models, in order to promote testability. However, \\nnavigating to views from view-mod\", \"els would require the view-models to reference views, and \\nparticularly views that the active view-m\", \"odel isn\\u2019t associated with, which is not recommended. \\nTherefore, the MauiNavigationService presente\", \"d here specifies the view-model type as the target to \\nnavigate to.\\nThe eShop multi-platform app use\", \"s the MauiNavigationService class to provide view-model-first \\nnavigation. This class implements the\", \" INavigationService interface, which is shown in the following \\ncode example:\\npublic interface INavi\", \"gationService\\n{\\n Task InitializeAsync();\\n Task NavigateToAsync(string route, IDictionary<string, obj\", \"ect> routeParameters = null);\\n Task PopAsync();\\n}\\nThis interface specifies that an implementing clas\", \"s must provide the following methods:\\nMethod Purpose\\nInitializeAsync Performs navigation to one of t\", \"wo pages when \\nthe app is launched.\\nNavigateToAsync(string route, \\nIDictionary<string, object> route\", \"Parameters = \\nnull)\\nPerforms hierarchical navigation to a specified \\npage using a registered navigat\", \"ion route. Can \\noptionally pass named route parameters to use \\nfor processing on the destination pag\", \"e\\nPopAsync Removes the current page from the navigation \\nstack.\\nNote\\nAn INavigationService interface\", \" would usually also specify a GoBackAsync method, which is used to \\nprogrammatically return to the p\", \"revious page in the navigation stack. However, this method is missing \\nfrom the eShop multi-platform\", \" app because it\\u2019s not required.34 CHAPTER 6 | Navigation\\nCreating the MauiNavigationService instance\", \"\\nThe MauiNavigationService class, which implements the INavigationService interface, is registered a\", \"s a \\nsingleton with the dependency injection container in the MauiProgram.CreateMauiApp() method, as\", \" \\ndemonstrated in the following code example:\\nmauiAppBuilder.Services.AddSingleton<INavigationServic\", \"e, MauiNavigationService>();;\\nThe INavigationService interface can then be resolved by adding it to \", \"the constructor of our views and \\nview-models, as demonstrated in the following code example:\\npublic\", \" AppShell(INavigationService navigationService)\\nThis returns a reference to the MauiNavigationServic\", \"e object that\\u2019s stored in the dependency injection \\ncontainer.\\nThe ViewModelBase class stores the Ma\", \"uiNavigationService instance in a NavigationService property, \\nof type INavigationService. Therefore\", \", all view-model classes, which derive from the ViewModelBase \\nclass, can use the NavigationService \", \"property to access the methods specified by the \\nINavigationService interface.\\nHandling navigation r\", \"equests\\n.NET MAUI provides multiple ways to navigate within an application. The traditional way to n\", \"avigate is \\nwith the NavigationPage class, which implements a hierarchical navigation experience in \", \"which the \\nuser can navigate through pages, forward and backward, as desired. The eShop app uses the\", \" Shell \\ncomponent as the root container for the application and as a navigation host. For more infor\", \"mation \\nabout Shell navigation, see Shell Navigation on the Microsoft Developer Center.\\nNavigation i\", \"s performed inside view-model classes by invoking one of the NavigateToAsync methods, \\nspecifying th\", \"e route path for the page being navigated to, as demonstrated in the following code \\nexample:\\nawait \", \"NavigationService.NavigateToAsync(\\\"//Main\\\");\\nThe following code example shows the NavigateToAsync me\", \"thod provided by the \\nMauiNavigationService class:\\npublic Task NavigateToAsync(string route, IDictio\", \"nary<string, object> routeParameters =\\nnull)\\n{\\n return\\n routeParameters != null\\n ? Shell.Current.GoT\", \"oAsync(route, routeParameters)\\n : Shell.Current.GoToAsync(route);\\n}\\nThe .NET MAUI Shell control is a\", \"lready familiar with route-based navigation, so the NavigateToAsync \\nmethod works to mask this funct\", \"ionality. The NavigateToAsync method allows navigation data to be 35 CHAPTER 6 | Navigation\\nspecifie\", \"d as an argument that\\u2019s passed to the view-model being navigated to, where it\\u2019s typically used \\nto p\", \"erform initialization. For more information, see Passing parameters during navigation.\\nImportant\\nThe\", \"re are multiple ways to perform navigation in .NET MAUI. The MauiNavigationService is specifically \\n\", \"build to work with Shell. If you are using a NavigationPage or TabbedPage or a different navigation \", \"\\nmechanism, this routing service would have to be updated to work using those components.\\nIn order t\", \"o register routes for the MauiNavigationService we need to supply route information from \\nXAML or in\", \" the code-behind. The following example shows registration of routes via XAML.\\n<?xml version=\\\"1.0\\\" e\", \"ncoding=\\\"UTF-8\\\" ?>\\n<Shell\\n xmlns=\\\"http://schemas.microsoft.com/dotnet/2021/maui\\\"\\n xmlns:x=\\\"http://sc\", \"hemas.microsoft.com/winfx/2009/xaml\\\"\\n xmlns:views=\\\"clr-namespace:eShop.Views\\\"\\n x:Class=\\\"eShop.AppShe\", \"ll\\\">\\n <!-- Omitted for brevity -->\\n <FlyoutItem >\\n <ShellContent x:Name=\\\"login\\\" ContentTemplate=\\\"{Da\", \"taTemplate views:LoginView}\\\" \\nRoute=\\\"Login\\\" />\\n </FlyoutItem>\\n <TabBar x:Name=\\\"main\\\" Route=\\\"Main\\\">\\n \", \"<ShellContent Title=\\\"CATALOG\\\" Route=\\\"Catalog\\\" Icon=\\\"{StaticResource \\nCatalogIconImageSource}\\\" Conten\", \"tTemplate=\\\"{DataTemplate views:CatalogView}\\\" />\\n <ShellContent Title=\\\"PROFILE\\\" Route=\\\"Profile\\\" Icon=\", \"\\\"{StaticResource \\nProfileIconImageSource}\\\" ContentTemplate=\\\"{DataTemplate views:ProfileView}\\\" />\\n </\", \"TabBar>\\n</Shell>\\nIn this example, the ShellContent and TabBar user interface objects are setting the\", \"ir Route property. \\nThis is the preferred method of registering routes for user interface objects th\", \"at are controlled by a \\nShell.\\nIf we have objects that will be added to the navigation stack at a la\", \"ter time, then we will need to add \\nthose via code-behind. The following example show registration o\", \"f routes in code-behind.\\nRouting.RegisterRoute(\\\"Filter\\\", typeof(FiltersView));\\nRouting.RegisterRoute\", \"(\\\"Basket\\\", typeof(BasketView));\\nIn code-behind, we will call the Routing.RegisterRoute method which \", \"takes a route name as the first \\nparameter and a view type as the second parameter. When a view-mode\", \"l uses the NavigationService \\nproperty to navigate, the application\\u2019s Shell object will look for reg\", \"istered routes and push them onto \\nthe navigation stack.\\nAfter the view is created and navigated to,\", \" the ApplyQueryAttributes and InitializeAsync methods of \\nthe view\\u2019s associated view-model are execu\", \"ted. For more information, see Passing parameters during \\nnavigation.36 CHAPTER 6 | Navigation\\nNavig\", \"ating when the app is launched\\nWhen the app is launched, a Shell object is set as the root view of t\", \"he application. Once set, the Shell \\nwill be used to control route registration and will be present \", \"at the root of our application going \\nforward. Once the Shell has been created, we can wait for it t\", \"o be attached to the application using \\nthe OnParentSet method to initialize our navigation route. T\", \"he following code example shows this \\nmethod:\\nprotected override async void OnParentSet()\\n{\\n base.On\", \"ParentSet();\\n if (Parent is not null)\\n {\\n await _navigationService.InitializeAsync();\\n }\\n}\\nThe metho\", \"d uses an instance of INavigationService which is provided the constructor from \\ndependency injectio\", \"n and invokes its InitializeAsync method.\\nThe following code example shows the implementation of the\", \" MauiNavigationService.InitializeAsync \\nmethod:\\npublic Task InitializeAsync()\\n{\\n return NavigateToAs\", \"ync(string.IsNullOrEmpty(_settingsService.AuthAccessToken)\\n ? \\\"//Login\\\"\\n : \\\"//Main/Catalog\\\");\\n}\\nThe \", \"//Main/Catalog route is navigated to if the app has a cached access token, which is used for \\nauthen\", \"tication. Otherwise, the //Login route is navigated to.\\nPassing parameters during navigation\\nThe Nav\", \"igateToAsync method, specified by the INavigationService interface, enables navigation data \\nto be s\", \"pecified as an IDictionary<string, object> of data that\\u2019s passed to the view-model being \\nnavigated \", \"to, where it\\u2019s typically used to perform initialization.\\nFor example, the ProfileViewModel class con\", \"tains an OrderDetailCommand that\\u2019s executed when the \\nuser selects an order on the ProfileView page.\", \" In turn, this executes the OrderDetailAsync method, \\nwhich is shown in the following code example:\\n\", \"private async Task OrderDetailAsync(Order order)\\n{\\n if (order is null)\\n {\\n return;\\n }\\n await Navigat\", \"ionService.NavigateToAsync(\\n \\\"OrderDetail\\\",37 CHAPTER 6 | Navigation\\n new Dictionary<string, object>\", \"{ { \\\"OrderNumber\\\", order.OrderNumber } });\\n}\\nThis method invokes navigation to the OrderDetail route\", \", passing order number information the order \\nthat the user selected. When the dependency injection \", \"framework creates the OrderDetailView for the \\nOrderDetail route along with the OrderDetailViewModel\", \" class which is assigned to the view\\u2019s \\nBindingContext. The OrderDetailViewModel has an attribute ad\", \"ded to it that allows it to receive data \\nfrom the navigation service as shown in the code example b\", \"elow.\\n[QueryProperty(nameof(OrderNumber), \\\"OrderNumber\\\")]\\npublic class OrderDetailViewModel : ViewMo\", \"delBase\\n{\\n public int OrderNumber { get; set; }\\n}\\nThe QueryProperty attribute allows us to provide a\", \" parameter for a property to map values to and a \\nkey to find values from the query parameters dicti\", \"onary. In this example, the key \\u201cOrderNumber\\u201d and \\norder number value were provided during the Navig\", \"ateToAsync call. The view-model found the \\n\\u201cOrderNumber\\u201d key and mapped the value to the OrderNumber\", \" property. The OrderNumber property \\ncan then be used at a later time to retrieve the full order det\", \"ails from the OrderService instance.\\nInvoking navigation using behaviors\\nNavigation is usually trigg\", \"ered from a view by a user interaction. For example, the LoginView performs \\nnavigation following su\", \"ccessful authentication. The following code example shows how the navigation \\nis invoked by a behavi\", \"or:\\n<WebView>\\n <WebView.Behaviors>\\n <behaviors:EventToCommandBehavior\\n EventName=\\\"Navigating\\\"\\n Event\", \"ArgsConverter=\\\"{StaticResource WebNavigatingEventArgsConverter}\\\"\\n Command=\\\"{Binding NavigateCommand}\", \"\\\" />\\n </WebView.Behaviors>\\n</WebView>\\nAt runtime, the EventToCommandBehavior will respond to interac\", \"tion with the WebView. When the \\nWebView navigates to a web page, the Navigating event will fire, wh\", \"ich will execute the \\nNavigateCommand in the LoginViewModel. By default, the event arguments for the\", \" event are passed \\nto the command. This data is converted as it\\u2019s passed between source and target b\", \"y the converter \\nspecified in the EventArgsConverter property, which returns the Url from the \\nWebNa\", \"vigatingEventArgs. Therefore, when the NavigationCommand is executed, the Url of the web \\npage is pa\", \"ssed as a parameter to the registered Action.\\nIn turn, the NavigationCommand executes the NavigateAs\", \"ync method, which is shown in the \\nfollowing code example:\\nprivate async Task NavigateAsync(string u\", \"rl)\\n{\\n // Omitted for brevity.\\n if (!string.IsNullOrWhiteSpace(accessToken))\\n {38 CHAPTER 6 | Naviga\", \"tion\\n _settingsService.AuthAccessToken = accessToken;\\n _settingsService.AuthIdToken = authResponse.I\", \"dentityToken;\\n await NavigationService.NavigateToAsync(\\\"//Main/Catalog\\\");\\n }\\n}\\nThis method invokes N\", \"avigationService route the application to the //Main/Catalog route.\\nConfirming or cancelling navigat\", \"ion\\nAn app might need to interact with the user during a navigation operation, so that the user can \", \"\\nconfirm or cancel navigation. This might be necessary, for example, when the user attempts to \\nnavi\", \"gate before having fully completed a data entry page. In this situation, an app should provide a \\nno\", \"tification that allows the user to navigate away from the page, or to cancel the navigation operatio\", \"n \\nbefore it occurs. This can be achieved in a view-model class by using the response from a notific\", \"ation \\nto control whether or not navigation is invoked.\\nSummary\\n.NET MAUI includes support for page \", \"navigation, which typically results from the user\\u2019s interaction \\nwith the UI, or from the app itself\", \", as a result of internal logic-driven state changes. However, \\nnavigation can be complex to impleme\", \"nt in apps that use the MVVM pattern.\\nThis chapter presented a NavigationService class, which is use\", \"d to perform view-model-first \\nnavigation from view-models. Placing navigation logic in view-model c\", \"lasses means that the logic can \\nbe exercised through automated tests. In addition, the view-model c\", \"an then implement logic to \\ncontrol navigation to ensure that certain business rules are enforced.39\", \" CHAPTER 7 | Validation\\nCHAPTER 7\\nValidation\\nAny app that accepts input from users should ensure tha\", \"t the input is valid. An app could, for \\nexample, check for input that contains only characters in a\", \" particular range, is of a certain length, or \\nmatches a particular format. Without validation, a us\", \"er can supply data that causes the app to fail. \\nProper validation enforces business rules and could\", \" help to prevent an attacker from injecting \\nmalicious data.\\nIn the context of the Model-View-ViewMo\", \"del (MVVM) pattern, a view model or model will often be \\nrequired to perform data validation and sig\", \"nal any validation errors to the view so that the user can \\ncorrect them. The eShop multi-platform a\", \"pp performs synchronous client-side validation of view \\nmodel properties and notifies the user of an\", \"y validation errors by highlighting the control that \\ncontains the invalid data, and by displaying e\", \"rror messages that inform the user of why the data is \\ninvalid. The image below shows the classes in\", \"volved in performing validation in the eShop multi\\u0002platform app.\\nView model properties that require \", \"validation are of type ValidatableObject<T>, and each \\nValidatableObject<T> instance has validation \", \"rules added to its Validations property. Validation is 40 CHAPTER 7 | Validation\\ninvoked from the vi\", \"ew model by calling the Validate method of the ValidatableObject<T> instance, \\nwhich retrieves the v\", \"alidation rules and executes them against the ValidatableObject<T>.Value \\nproperty. Any validation e\", \"rrors are placed into the Errors property of the ValidatableObject<T> \\ninstance, and the IsValid pro\", \"perty of the ValidatableObject<T> instance is updated to indicate \\nwhether the validation succeeded \", \"or failed. The following code shows the implementation of the \\nValidatableObject<T>:\\nusing Community\", \"Toolkit.Mvvm.ComponentModel;\\nnamespace eShop.Validations;\\npublic class ValidatableObject<T> : Observ\", \"ableObject, IValidity\\n{\\n private IEnumerable<string> _errors;\\n private bool _isValid;\\n private T _va\", \"lue;\\n public List<IValidationRule<T>> Validations { get; } = new();\\n public IEnumerable<string> Erro\", \"rs\\n {\\n get => _errors;\\n private set => SetProperty(ref _errors, value);\\n }\\n public bool IsValid\\n {\\n \", \"get => _isValid;\\n private set => SetProperty(ref _isValid, value);\\n }\\n public T Value\\n {\\n get => _va\", \"lue;\\n set => SetProperty(ref _value, value);\\n }\\n public ValidatableObject()\\n {\\n _isValid = true;\\n _e\", \"rrors = Enumerable.Empty<string>();\\n }\\n public bool Validate()\\n {\\n Errors = Validations\\n ?.Where(v =\", \"> !v.Check(Value))\\n ?.Select(v => v.ValidationMessage)\\n ?.ToArray()\\n ?? Enumerable.Empty<string>();\\n\", \" IsValid = !Errors.Any();\\n return IsValid;\\n }\\n}\\nProperty change notification is provided by the Obse\", \"rvableObject class, and so an Entry control can \\nbind to the IsValid property of ValidatableObject<T\", \"> instance in the view model class to be notified of \\nwhether or not the entered data is valid.\\nSpec\", \"ifying validation rules\\nValidation rules are specified by creating a class that derives from the IVa\", \"lidationRule<T> interface, \\nwhich is shown in the following code example:41 CHAPTER 7 | Validation\\np\", \"ublic interface IValidationRule<T>\\n{\\n string ValidationMessage { get; set; }\\n bool Check(T value);\\n}\", \"\\nThis interface specifies that a validation rule class must provide a boolean Check method that is u\", \"sed \\nto perform the required validation, and a ValidationMessage property whose value is the validat\", \"ion \\nerror message that will be displayed if validation fails.\\nThe following code example shows the \", \"IsNotNullOrEmptyRule<T> validation rule, which is used to \\nperform validation of the username and pa\", \"ssword entered by the user on the LoginView when using \\nmock services in the eShop multi-platform ap\", \"p:\\npublic class IsNotNullOrEmptyRule<T> : IValidationRule<T>\\n{\\n public string ValidationMessage { ge\", \"t; set; }\\n public bool Check(T value) =>\\n value is string str && !string.IsNullOrWhiteSpace(str);\\n}\\n\", \"The Check method returns a boolean indicating whether the value argument is null, empty, or consists\", \" \\nonly of whitespace characters.\\nAlthough not used by the eShop multi-platform app, the following co\", \"de example shows a validation \\nrule for validating email addresses:\\npublic class EmailRule<T> : IVal\", \"idationRule<T>\\n{\\n private readonly Regex _regex = new(@\\\"^([w.-]+)@([w-]+)((.(w){2,3})+)$\\\");\\n public \", \"string ValidationMessage { get; set; }\\n public bool Check(T value) =>\\n value is string str && _regex\", \".IsMatch(str);\\n}\\nThe Check method returns a boolean indicating whether or not the value argument is \", \"a valid email \\naddress. This is achieved by searching the value argument for the first occurrence of\", \" the regular \\nexpression pattern specified in the Regex constructor. Whether the regular expression \", \"pattern has \\nbeen found in the input string can be determined by checking the value against Regex.Is\", \"Match.\\nNote\\nProperty validation can sometimes involve dependent properties. An example of dependent \", \"\\nproperties is when the set of valid values for property A depends on the particular value that has \", \"been \\nset in property B. To check that the value of property A is one of the allowed values would in\", \"volve \\nretrieving the value of property B. In addition, when the value of property B changes, proper\", \"ty A \\nwould need to be revalidated.42 CHAPTER 7 | Validation\\nAdding validation rules to a property\\nI\", \"n the eShop multi-platform app, view model properties that require validation are declared to be of \", \"\\ntype ValidatableObject<T>, where T is the type of the data to be validated. The following code \\nexa\", \"mple shows an example of two such properties:\\npublic ValidatableObject<string> UserName { get; priva\", \"te set; }\\npublic ValidatableObject<string> Password { get; private set; }\\nFor validation to occur, v\", \"alidation rules must be added to the Validations collection of \\neach ValidatableObject<T> instance, \", \"as demonstrated in the following code example:\\nprivate void AddValidations()\\n{\\n UserName.Validations\", \".Add(new IsNotNullOrEmptyRule<string>\\n {\\n ValidationMessage = \\\"A username is required.\\\"\\n });\\n Passwo\", \"rd.Validations.Add(new IsNotNullOrEmptyRule<string>\\n {\\n ValidationMessage = \\\"A password is required.\", \"\\\"\\n });\\n}\\nThis method adds the IsNotNullOrEmptyRule<T> validation rule to the Validations collection \", \"of each \\nValidatableObject<T> instance, specifying values for the validation rule\\u2019s ValidationMessag\", \"e property, \\nwhich specifies the validation error message that will be displayed if validation fails\", \".\\nTriggering validation\\nThe validation approach used in the eShop multi-platform app can manually tr\", \"igger validation of a \\nproperty, and automatically trigger validation when a property changes.\\nTrigg\", \"ering validation manually\\nValidation can be triggered manually for a view model property. For exampl\", \"e, this occurs in the eShop \\nmulti-platform app when the user taps the Login button on the LoginView\", \", when using mock services. \\nThe command delegate calls the MockSignInAsync method in the LoginViewM\", \"odel, which invokes \\nvalidation by executing the Validate method, which is shown in the following co\", \"de example:\\nprivate bool Validate()\\n{\\n bool isValidUser = ValidateUserName();\\n bool isValidPassword \", \"= ValidatePassword();\\n return isValidUser && isValidPassword;\\n}\\nprivate bool ValidateUserName()\\n{\\n r\", \"eturn _userName.Validate();\\n}\\nprivate bool ValidatePassword()\\n{43 CHAPTER 7 | Validation\\n return _pa\", \"ssword.Validate();\\n}\\nThe Validate method performs validation of the username and password entered by\", \" the user on the \\nLoginView, by invoking the Validate method on each ValidatableObject<T> instance. \", \"The following \\ncode example shows the Validate method from the ValidatableObject<T> class:\\npublic bo\", \"ol Validate()\\n{\\n Errors = _validations\\n ?.Where(v => !v.Check(Value))\\n ?.Select(v => v.ValidationMes\", \"sage)\\n ?.ToArray()\\n ?? Enumerable.Empty<string>();\\n IsValid = !Errors.Any();\\n return IsValid;\\n}\\nThis\", \" method retrieves any validation rules that were added to the object\\u2019s Validations collection. The \\n\", \"Check method for each retrieved validation rule is executed, and the ValidationMessage property \\nval\", \"ue for any validation rule that fails to validate the data is added to the Errors collection of the \", \"\\nValidatableObject<T> instance. Finally, the IsValid property is set, and its value is returned to t\", \"he \\ncalling method, indicating whether validation succeeded or failed.\\nTriggering validation when pr\", \"operties change\\nValidation is also automatically triggered whenever a bound property changes. For ex\", \"ample, when a \\ntwo-way binding in the LoginView sets the UserName or Password property, validation i\", \"s triggered. \\nThe following code example demonstrates how this occurs:\\n<Entry Text=\\\"{Binding UserNam\", \"e.Value, Mode=TwoWay}\\\">\\n <Entry.Behaviors>\\n <behaviors:EventToCommandBehavior\\n EventName=\\\"TextChange\", \"d\\\"\\n Command=\\\"{Binding ValidateUserNameCommand}\\\" />\\n </Entry.Behaviors>\\n</Entry>\\nThe Entry control bi\", \"nds to the UserName.Value property of the ValidatableObject<T> instance, and \\nthe control\\u2019s Behavior\", \"s collection has an EventToCommandBehavior instance added to it. This \\nbehavior executes the Validat\", \"eUserNameCommand in response to the TextChanged event firing on \\nthe Entry, which is raised when the\", \" text in the Entry changes. In turn, the ValidateUserNameCommand \\ndelegate executes the ValidateUser\", \"Name method, which executes the Validate method on the \\nValidatableObject<T> instance. Therefore, ev\", \"ery time the user enters a character in the Entry control \\nfor the username, validation of the enter\", \"ed data is performed.\\nDisplaying validation errors\\nThe eShop multi-platform app notifies the user of\", \" any validation errors by highlighting the control \\nthat contains the invalid data with a red backgr\", \"ound, and by displaying an error message that informs 44 CHAPTER 7 | Validation\\nthe user why the dat\", \"a is invalid below the control containing the invalid data. When the invalid data is \\ncorrected, the\", \" background changes back to the default state and the error message is removed. The \\nimage below sho\", \"ws the LoginView in the eShop multi-platform app when validation errors are \\npresent.\\nHighlighting a\", \" control that contains invalid data\\n.NET MAUI offers a number of ways to present validation informat\", \"ion to end-users, but one of the \\nmost straight-forward ways is through the use of Triggers. Trigger\", \"s provide us a way to change the \\nstate of our controls, typically for appearance, based on an event\", \" or data change that occurs for a \\ncontrol. For validation, we will be using a DataTrigger which wil\", \"l listen to changes raised from a bound \\nproperty and respond to the changes. The Entry controls on \", \"the LoginView are setup using the \\nfollowing code:\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay\", \"}\\\">\\n <Entry.Style>\\n <OnPlatform x:TypeArguments=\\\"Style\\\">\\n <On Platform=\\\"iOS, Android\\\" Value=\\\"{Static\", \"Resource EntryStyle}\\\" />\\n <On Platform=\\\"WinUI\\\" Value=\\\"{StaticResource WinUIEntryStyle}\\\" />\\n </OnPlat\", \"form>\\n </Entry.Style>\\n <Entry.Behaviors>\\n <mct:EventToCommandBehavior\\n EventName=\\\"TextChanged\\\"\\n Comm\", \"and=\\\"{Binding ValidateCommand}\\\" />\\n </Entry.Behaviors>\\n <Entry.Triggers>\\n <DataTrigger\\n TargetType=\\\"\", \"Entry\\\"\\n Binding=\\\"{Binding UserName.IsValid}\\\"\\n Value=\\\"False\\\">\\n <Setter Property=\\\"BackgroundColor\\\" Val\", \"ue=\\\"{StaticResource ErrorColor}\\\" />\\n </DataTrigger>\\n </Entry.Triggers>\\n</Entry>\\nThe DataTrigger spec\", \"ifies the following properties:45 CHAPTER 7 | Validation\\nProperty Description\\nTargetType The control\", \" type that the trigger belongs to.\\nBinding The data Binding markup which will provide \\nchange notifi\", \"cations and value for the trigger \\ncondition.\\nValue The data value to specify when the trigger\\u2019s \\nco\", \"ndition has been met.\\nFor this Entry, we will be listening for changes to the LoginViewModel.UserNam\", \"e.IsValid property. \\nEach time this property raises a change, the value will be compared against the\", \" Value property set in \\nthe DataTrigger. If the values are equal, then the trigger condition will be\", \" met and any Setter objects \\nprovided to the DataTrigger will be executed. This control has a single\", \" Setter object that updates the \\nBackgroundColor property to a custom color defined using the Static\", \"Resource markup. When a \\nTrigger condition is no longer met, the control will revert the properties \", \"set by the Setter object to \\ntheir previous state. For more information about Triggers, see .NET MAU\", \"I Docs: Triggers.\\nDisplaying error messages\\nThe UI displays validation error messages in Label contr\", \"ols below each control whose data failed \\nvalidation. The following code example shows the Label tha\", \"t displays a validation error message, if the \\nuser has not entered a valid username:\\n<Label\\n \\nText=\", \"\\\"{Binding UserName.Errors, Converter={StaticResource FirstValidationErrorConverter}\\\"\\n Style=\\\"{Static\", \"Resource ValidationErrorLabelStyle}\\\" />\\nEach Label binds to the Errors property of the view model ob\", \"ject that\\u2019s being validated. The Errors \\nproperty is provided by the ValidatableObject<T> class, and\", \" is of type IEnumerable<string>. Because \\nthe Errors property can contain multiple validation errors\", \", the FirstValidationErrorConverter instance is \\nused to retrieve the first error from the collectio\", \"n for display.\\nSummary\\nThe eShop multi-platform app performs synchronous client-side validation of v\", \"iew model properties \\nand notifies the user of any validation errors by highlighting the control tha\", \"t contains the invalid data, \\nand by displaying error messages that inform the user why the data is \", \"invalid.\\nView model properties that require validation are of type ValidatableObject<T>, and each \\nV\", \"alidatableObject<T> instance has validation rules added to its Validations property. Validation is \\n\", \"invoked from the view model by calling the Validate method of the ValidatableObject<T> instance, \\nwh\", \"ich retrieves the validation rules and executes them against the ValidatableObject<T> Value \\npropert\", \"y. Any validation errors are placed into the Errors property of the ValidatableObject<T> \\ninstance, \", \"and the IsValid property of the ValidatableObject<T> instance is updated to indicate \\nwhether valida\", \"tion succeeded or failed.46 CHAPTER 8 | Application settings management\\nCHAPTER 8\\nApplication settin\", \"gs \\nmanagement\\nSettings allow the separation of data that configures the behavior of an app from the\", \" code, allowing \\nthe behavior to be changed without rebuilding the app. There are two types of setti\", \"ngs: app settings \\nand user settings.\\nApp settings are data that an app creates and manages. It can \", \"include data such as fixed web service \\nendpoints, API keys, and runtime state. App settings are tie\", \"d to core functionality and are only \\nmeaningful to that app.\\nUser settings are the customizable set\", \"tings of an app that affect the app\\u2019s behavior and don\\u2019t require \\nfrequent re-adjustment. For exampl\", \"e, an app might let the user specify where to retrieve data and \\nhow to display it on the screen.\\nCr\", \"eating a Settings Interface\\nWhile the preferences manager can be used directly in your application, \", \"it does come with the \\ndrawback of making your application tightly coupled to the preferences manage\", \"r implementation. \\nThis coupling means that creating unit tests or extending the functionality of pr\", \"eferences \\nmanagement will be limited since your application will not have a direct way to intercept\", \" the behavior. \\nTo address this concern, an interface can be created to work as a proxy for preferen\", \"ces management. \\nThe interface will allow us to supply an implementation that fits our needs. For ex\", \"ample, when writing \\na unit test, we may want to set specific settings, and the interface will give \", \"us an easy way to \\nconsistently set this data for the test. The following code example shows the ISe\", \"ttingsService interface \\nin the eShop multi-platform app:\\nnamespace eShop.Services.Settings;\\npublic \", \"interface ISettingsService\\n{\\n string AuthAccessToken { get; set; }\\n string AuthIdToken { get; set; }\", \"\\n bool UseMocks { get; set; }\\n string IdentityEndpointBase { get; set; }\\n string GatewayShoppingEndp\", \"ointBase { get; set; }\\n string GatewayMarketingEndpointBase { get; set; }\\n bool UseFakeLocation { ge\", \"t; set; }\\n string Latitude { get; set; }\\n string Longitude { get; set; }47 CHAPTER 8 | Application s\", \"ettings management\\n bool AllowGpsLocation { get; set; }\\n}\\nAdding Settings\\n.NET MAUI includes a prefe\", \"rences manager that provides a way to store runtime settings for a user. \\nThis feature can be access\", \"ed from anywhere within your application using the \\nMicrosoft.Maui.Storage.Preferences class. The pr\", \"eferences manager provides a consistent, type-safe, \\ncross-platform approach for persisting and retr\", \"ieving app and user settings, while using the native \\nsettings management provided by each platform.\", \" In addition, it\\u2019s straightforward to use data binding \\nto access settings data exposed by the libra\", \"ry. For more information, see the Preferences on the \\nMicrosoft Developer Center.\\nTip\\nPreferences is\", \" meant for storing relatively small data. If you need to store larger or more complex \\ndata, conside\", \"r using a local database or filesystem to store the data.\\nOur application will use the Preferences c\", \"lass need to implement the ISettingsService interface. The \\ncode below shows how the eShop multi-pla\", \"tform app\\u2019s SettingsService implements the \\nAuthTokenAccess and UseMocks properties:\\npublic sealed c\", \"lass SettingsService : ISettingsService\\n{\\n private const string AccessToken = \\\"access_token\\\";\\n priva\", \"te const string AccessTokenDefault = string.Empty;\\n private const string IdUseMocks = \\\"use_mocks\\\";\\n \", \"private const bool UseMocksDefault = true;\\n public string AuthAccessToken\\n {\\n get => Preferences.Get\", \"(AccessToken, AccessTokenDefault);\\n set => Preferences.Set(AccessToken, value);\\n }\\n public bool UseM\", \"ocks\\n {\\n get => Preferences.Get(IdUseMocks, UseMocksDefault);\\n set => Preferences.Set(IdUseMocks, va\", \"lue);\\n }\\n}\\nEach setting consists of a private key, a private default value, and a public property. T\", \"he key is always \\na const string that defines a unique name, with the default value for the setting \", \"being a static read\\u0002only or constant value of the required type. Providing a default value ensures t\", \"hat a valid value is \\navailable if an unset setting is retrieved. This service implementation can be\", \" provided via dependency \\ninjection to our application for use in view-models or other services thro\", \"ughout the application.48 CHAPTER 8 | Application settings management\\nData binding to user settings\\n\", \"In the eShop multi-platform app, the SettingsView exposes multiple settings the user can configure a\", \"t \\nruntime. These settings include allowing configuration of whether the app should retrieve data fr\", \"om \\nmicroservices deployed as Docker containers or whether the app should retrieve data from mock \\ns\", \"ervices that don\\u2019t require an internet connection. When retrieving data from containerized \\nmicroser\", \"vices, a base endpoint URL for the microservices must be specified. The image below shows \\nthe Setti\", \"ngsView when the user has chosen to retrieve data from containerized microservices.\\nData binding can\", \" be used to retrieve and set settings exposed by the ISettingService interface. This is \\nachieved by\", \" controls on the view binding to view model properties that in turn access properties in \\nthe ISetti\", \"ngService interface and raising a property changed notification if the value has changed.\\nThe follow\", \"ing code example shows the Entry control from the SettingsView that allows the user to \\nenter a base\", \" identity endpoint URL for the containerized microservices:\\n<Entry Text=\\\"{Binding IdentityEndpoint, \", \"Mode=TwoWay}\\\" />\\nThis Entry control binds to the IdentityEndpoint property of the SettingsViewModel \", \"class, using a two\\u0002way binding. The following code example shows the IdentityEndpoint property:\\npriv\", \"ate readonly ISettingsService _settingsService;\\nprivate string _identityEndpoint;\\npublic SettingsVie\", \"wModel(\\n ILocationService locationService, IAppEnvironmentService appEnvironmentService,\\n IDialogSer\", \"vice dialogService, INavigationService navigationService, ISettingsService \\nsettingsService)\\n : base\", \"(dialogService, navigationService, settingsService)\\n{\\n _settingsService = settingsService;\\n _identit\", \"yEndpoint = _settingsService.IdentityEndpointBase;\\n}\\npublic string IdentityEndpoint49 CHAPTER 8 | Ap\", \"plication settings management\\n{\\n get => _identityEndpoint;\\n set\\n {\\n SetProperty(ref _identityEndpoin\", \"t, value);\\n if (!string.IsNullOrWhiteSpace(value))\\n {\\n UpdateIdentityEndpoint();\\n }\\n }\\n}\\nWhen the Id\", \"entityEndpoint property is set, the UpdateIdentityEndpoint method is called, provided \\nthat the supp\", \"lied value is valid. The following code example shows the UpdateIdentityEndpoint \\nmethod:\\nprivate vo\", \"id UpdateIdentityEndpoint()\\n{\\n _settingsService.IdentityEndpointBase = _identityEndpoint;\\n}\\nThis met\", \"hod updates the IdentityEndpointBase property in the ISettingService interface \\nimplementation with \", \"the base endpoint URL value entered by the user. If the SettingsService class is \\nprovided as the im\", \"plementation for _settingsService, the value will persist to platform-specific storage.\\nSummary\\nSett\", \"ings allow the separation of data that configures the behavior of an app from the code, allowing \\nth\", \"e behavior to be changed without rebuilding the app. App settings are data that an app creates and \\n\", \"manages, and user settings are the customizable settings of an app that affect the app\\u2019s behavior an\", \"d \\ndon\\u2019t require frequent re-adjustment.\\nThe Microsoft.Maui.Storage.Preferences class provides a con\", \"sistent, type-safe, cross-platform \\napproach for persisting and retrieving app and user settings.50 \", \"CHAPTER 9 | Containerized microservices\\nCHAPTER 9\\nContainerized \\nmicroservices\\nDeveloping client-ser\", \"ver applications has resulted in a focus on building tiered applications that use \\nspecific technolo\", \"gies in each tier. Such applications are often referred to as monolithic and are \\npackaged onto hard\", \"ware pre-scaled for peak loads. The main drawbacks of this development \\napproach are the tight coupl\", \"ing between components within each tier, that individual components \\ncan\\u2019t be easily scaled, and the\", \" cost of testing. A simple update can have unforeseen effects on the rest \\nof the tier, so a change \", \"to an application component requires its entire tier to be retested and \\nredeployed.\\nParticularly co\", \"ncerning, in the age of the cloud, is that individual components can\\u2019t be easily scaled. A \\nmonolith\", \"ic application contains domain-specific functionality and is typically divided by functional \\nlayers\", \" such as front-end, business logic, and data storage. The image below illustrates that a \\nmonolithic\", \" application is scaled by cloning the entire application onto multiple machines.51 CHAPTER 9 | Conta\", \"inerized microservices\\nMicroservices\\nMicroservices offer a different approach to application develop\", \"ment and deployment, an approach \\nthat\\u2019s suited to the agility, scale, and reliability requirements \", \"of modern cloud applications. A \\nmicroservices application is split into independent components that\", \" work together to deliver the \\napplication\\u2019s overall functionality. The term microservice emphasizes\", \" that applications should be \\ncomposed of services small enough to reflect particular concerns, so e\", \"ach microservice implements a \\nsingle function. In addition, each microservice has well-defined cont\", \"racts with which other \\nmicroservices communicate and share data. Typical examples of microservices \", \"include shopping carts, \\ninventory processing, purchase subsystems, and payment processing.\\nMicroser\", \"vices can scale independently compared to giant monolithic applications that scale together. \\nThis m\", \"eans that a specific functional area that requires more processing power or network bandwidth \\nto su\", \"pport demand can be scaled rather than unnecessarily scaling out other application areas. The \\nimage\", \" below illustrates this approach, where microservices are deployed and scaled independently, \\ncreati\", \"ng instances of services across machines.52 CHAPTER 9 | Containerized microservices\\nMicroservice sca\", \"le-out can be nearly instantaneous, allowing an application to adapt to changing \\nloads. For example\", \", a single microservice in the web-facing functionality of an application might be \\nthe only microse\", \"rvice that needs to scale out to handle additional incoming traffic.\\nThe classic model for applicati\", \"on scalability is to have a load-balanced, stateless tier with a shared \\nexternal datastore to store\", \" persistent data. Stateful microservices manage their own persistent data, \\nusually storing it local\", \"ly on the servers on which they are placed, to avoid the overhead of network \\naccess and complexity \", \"of cross-service operations. This enables the fastest possible processing of data \\nand can eliminate\", \" the need for caching systems. In addition, scalable stateful microservices usually \\npartition data \", \"among their instances, in order to manage data size and transfer throughput beyond \\nwhich a single s\", \"erver can support.\\nMicroservices also support independent updates. This loose coupling between micro\", \"services provides \\na rapid and reliable application evolution. Their independent, distributed nature\", \" helps rolling updates, \\nwhere only a subset of instances of a single microservice will update at an\", \"y given time. Therefore, if a \\nproblem is detected, a buggy update can be rolled back, before all in\", \"stances update with the faulty \\ncode or configuration. Similarly, microservices typically use schema\", \" versioning, so that clients see a \\nconsistent version when updates are being applied, regardless of\", \" which microservice instance is being \\ncommunicated with.\\nTherefore, microservice applications have \", \"many benefits over monolithic applications:\\n\\u2022 Each microservice is relatively small, easy to manage \", \"and evolve.\\n\\u2022 Each microservice can be developed and deployed independently of other services.\\n\\u2022 Eac\", \"h microservice can be scaled-out independently. For example, a catalog service or \\nshopping basket s\", \"ervice might need to be scaled-out more than an ordering service. 53 CHAPTER 9 | Containerized micro\", \"services\\nTherefore, the resulting infrastructure will more efficiently consume resources when scalin\", \"g \\nout.\\n\\u2022 Each microservice isolates any issues. For example, if there is an issue in a service it o\", \"nly \\nimpacts that service. The other services can continue to handle requests.\\n\\u2022 Each microservice c\", \"an use the latest technologies. Because microservices are autonomous and \\nrun side-by-side, the late\", \"st technologies and frameworks can be used, rather than being \\nforced to use an older framework that\", \" might be used by a monolithic application.\\nHowever, a microservice-based solution also has potentia\", \"l drawbacks:\\n\\u2022 Choosing how to partition an application into microservices can be challenging, as ea\", \"ch \\nmicroservice has to be completely autonomous, end-to-end, including responsibility for its \\ndata\", \" sources.\\n\\u2022 Developers must implement inter-service communication, which adds complexity and latency\", \" \\nto the application.\\n\\u2022 Atomic transactions between multiple microservices usually aren\\u2019t possible. \", \"Therefore, \\nbusiness requirements must embrace eventual consistency between microservices.\\n\\u2022 In prod\", \"uction, there is an operational complexity in deploying and managing a system \\ncompromised of many i\", \"ndependent services.\\n\\u2022 Direct client-to-microservice communication can make it difficult to refactor\", \" the contracts of \\nmicroservices. For example, over time how the system is partitioned into services\", \" might need \\nto change. A single service might split into two or more services, and two services mig\", \"ht \\nmerge. When clients communicate directly with microservices, this refactoring work can break \\nco\", \"mpatibility with client apps.\\nContainerization\\nContainerization is an approach to software developme\", \"nt in which an application and its versioned set \\nof dependencies, plus its environment configuratio\", \"n abstracted as deployment manifest files, are \\npackaged together as a container image, tested as a \", \"unit, and deployed to a host operating system.\\nA container is an isolated, resource controlled, and \", \"portable operating environment, where an \\napplication can run without touching the resources of othe\", \"r containers, or the host. Therefore, a \\ncontainer looks and acts like a newly installed physical co\", \"mputer or a virtual machine.\\nThere are many similarities between containers and virtual machines, as\", \" illustrated below.54 CHAPTER 9 | Containerized microservices\\nA container runs an operating system, \", \"has a file system, and can be accessed over a network as if it \\nwere a physical or virtual machine. \", \"However, the technology and concepts used by containers are very \\ndifferent from virtual machines. V\", \"irtual machines include the applications, the required dependencies, \\nand a full guest operating sys\", \"tem. Containers include the application and its dependencies, but share \\nthe operating system with o\", \"ther containers, running as isolated processes on the host operating \\nsystem (aside from Hyper-V con\", \"tainers which run inside of a special virtual machine per container). \\nTherefore, containers share r\", \"esources and typically require fewer resources than virtual machines.\\nThe advantage of a container-o\", \"riented development and deployment approach is that it eliminates \\nmost of the issues that arise fro\", \"m inconsistent environment setups and the problems that come with \\nthem. In addition, containers per\", \"mit fast application scale-up functionality by instancing new \\ncontainers as required.\\nThe key conce\", \"pts when creating and working with containers are:\\nConcept Description\\nContainer Host The physical o\", \"r virtual machine configured to \\nhost containers. The container host will run one \\nor more container\", \"s.\\nContainer Image An image consists of a union of layered \\nfilesystems stacked on top of each other\", \", and is \\nthe basis of a container. An image does not \\nhave state and it never changes as it\\u2019s deplo\", \"yed \\nto different environments.\\nContainer A container is a runtime instance of an image.55 CHAPTER 9\", \" | Containerized microservices\\nConcept Description\\nContainer OS Image Containers are deployed from i\", \"mages. The \\ncontainer operating system image is the first \\nlayer in potentially many image layers th\", \"at make \\nup a container. A container operating system is \\nimmutable, and can\\u2019t be modified.\\nContaine\", \"r Repository Each time a container image is created, the \\nimage and its dependencies are stored in a\", \" local \\nrepository. These images can be reused many \\ntimes on the container host. The container \\nima\", \"ges can also be stored in a public or private \\nregistry, such as Docker Hub, so that they can \\nbe us\", \"ed across different container hosts.\\nEnterprises are increasingly adopting containers when implement\", \"ing microservice-based applications, \\nand Docker has become the standard container implementation th\", \"at has been adopted by most \\nsoftware platforms and cloud vendors.\\nThe eShop reference application u\", \"ses Docker to host four containerized back-end microservices, as \\nillustrated in the diagram below.5\", \"6 CHAPTER 9 | Containerized microservices\\nThe architecture of the back-end services in the reference\", \" application is decomposed into multiple \\nautonomous sub-systems in the form of collaborating micros\", \"ervices and containers. Each microservice \\nprovides a single area of functionality: an identity serv\", \"ice, a catalog service, an ordering service, and a \\nbasket service.\\nEach microservice has its own da\", \"tabase, allowing it to be fully decoupled from the other \\nmicroservices. Where necessary, consistenc\", \"y between databases from different microservices is \\nachieved using application-level events. For mo\", \"re information, see Communication between \\nmicroservices.\\nCommunication between client and microserv\", \"ices\\nThe eShop multi-platform app communicates with the containerized back-end microservices using \\n\", \"direct client-to-microservice communication, as shown below.57 CHAPTER 9 | Containerized microservic\", \"es\\nWith direct client-to-microservice communication, the multi-platform app makes requests to each \\n\", \"microservice directly through its public endpoint, with a different TCP port per microservice. In \\np\", \"roduction, the endpoint would typically map to the microservice\\u2019s load balancer, which distributes \\n\", \"requests across the available instances.\\nTip\\nConsider using API gateway communication.\\nDirect client\", \"-to-microservice communication can have drawbacks when building a large and complex \\nmicroservice-ba\", \"sed application, but it\\u2019s more than adequate for a small application. Consider using \\nAPI gateway co\", \"mmunication when designing a large microservice-based application with tens of \\nmicroservices.\\nCommu\", \"nication between microservices\\nA microservices-based application is a distributed system, potentiall\", \"y running on multiple machines. \\nEach service instance is typically a process. Therefore, services m\", \"ust interact using an inter-process \\ncommunication protocol, such as HTTP, TCP, Advanced Message Que\", \"uing Protocol (AMQP), or binary \\nprotocols, depending on the nature of each service.\\nThe two common \", \"approaches for microservice-to-microservice communication are HTTP-based REST \\ncommunication when qu\", \"erying for data, and lightweight asynchronous messaging when \\ncommunicating updates across multiple \", \"microservices.\\nAsynchronous messaging-based event-driven communication is critical when propagating \", \"changes \\nacross multiple microservices. With this approach, a microservice publishes an event when s\", \"omething \\nnotable happens, for example, when it updates a business entity. Other microservices subsc\", \"ribe to \\nthese events. Then, when a microservice receives an event, it updates its own business enti\", \"ties, which \\nmight, in turn, lead to more events being published. This publish-subscribe functionali\", \"ty is usually \\nachieved with an event bus.58 CHAPTER 9 | Containerized microservices\\nAn event bus al\", \"lows publish-subscribe communication between microservices without requiring the \\ncomponents to be e\", \"xplicitly aware of each other, as shown below.\\nFrom an application perspective, the event bus is sim\", \"ply a publish-subscribe channel exposed via an \\ninterface. However, the way the event bus is impleme\", \"nted can vary. For example, an event bus \\nimplementation could use RabbitMQ, Azure Service Bus, or o\", \"ther service buses such as NServiceBus \\nand MassTransit. The diagram below shows how an event bus is\", \" used in the eShop reference \\napplication.\\nThe eShop event bus, implemented using RabbitMQ, provides\", \" one-to-many asynchronous publish\\u0002subscribe functionality. This means that after publishing an event\", \", there can be multiple subscribers \\nlistening for the same event. The diagram below illustrates thi\", \"s relationship.59 CHAPTER 9 | Containerized microservices\\nThis one-to-many communication approach us\", \"es events to implement business transactions that span \\nmultiple services, ensuring eventual consist\", \"ency between the services. An eventual-consistent \\ntransaction consists of a series of distributed s\", \"teps. Therefore, when the user-profile microservice \\nreceives the UpdateUser command, it updates the\", \" user\\u2019s details in its database and publishes the \\nUserUpdated event to the event bus. Both the bask\", \"et microservice and the ordering microservice have \\nsubscribed to receive this event, and in respons\", \"e, update their buyer information in their respective \\ndatabases.\\nSummary\\nMicroservices offer an app\", \"roach to application development and deployment that\\u2019s suited to the \\nagility, scale, and reliabilit\", \"y requirements of modern cloud applications. One of the main advantages \\nof microservices is that th\", \"ey can be scaled-out independently, which means that a specific functional \\narea can be scaled that \", \"requires more processing power or network bandwidth to support demand \\nwithout unnecessarily scaling\", \" areas of the application that are not experiencing increased demand.\\nA container is an isolated, re\", \"source-controlled, and portable operating environment where an \\napplication can run without touching\", \" the resources of other containers or the host. Enterprises are \\nincreasingly adopting containers wh\", \"en implementing microservice-based applications, and Docker \\nhas become the standard container imple\", \"mentation that most software platforms and cloud vendors \\nhave adopted.60 CHAPTER 10 | Accessing rem\", \"ote data\\nCHAPTER 10\\nAccessing remote data\\nMany modern web-based solutions make use of web services, \", \"hosted by web servers, to provide \\nfunctionality for remote client applications. The operations that\", \" a web service exposes constitute a \\nweb API.\\nClient apps should be able to utilize the web API with\", \"out knowing how the data or operations that the \\nAPI exposes are implemented. This requires that the\", \" API abides by common standards that enable a \\nclient app and web service to agree on which data for\", \"mats to use, and the structure of the data that is \\nexchanged between client apps and the web servic\", \"e.\\nIntroduction to Representational State Transfer\\nRepresentational State Transfer (REST) is an arch\", \"itectural style for building distributed systems based \\non hypermedia. A primary advantage of the RE\", \"ST model is that it\\u2019s based on open standards and \\ndoesn\\u2019t bind the implementation of the model or t\", \"he client apps that access it to any specific \\nimplementation. Therefore, a REST web service could b\", \"e implemented using Microsoft ASP.NET Core, \\nand client apps could be developing using any language \", \"and toolset that can generate HTTP requests \\nand parse HTTP responses.\\nThe REST model uses a navigat\", \"ional scheme to represent objects and services over a network, referred \\nto as resources. Systems th\", \"at implement REST typically use the HTTP protocol to transmit requests to \\naccess these resources. I\", \"n such systems, a client app submits a request in the form of a URI that \\nidentifies a resource, and\", \" an HTTP method (such as GET, POST, PUT, or DELETE) that indicates the \\noperation to be performed on\", \" that resource. The body of the HTTP request contains any data required \\nto perform the operation.\\nN\", \"ote\\nREST defines a stateless request model. Therefore, HTTP requests must be independent and might \\n\", \"occur in any order.\\nThe response from a REST request makes use of standard HTTP status codes. For ex\", \"ample, a request \\nthat returns valid data should include the HTTP response code 200 (OK), while a re\", \"quest that fails to \\nfind or delete a specified resource should return a response that includes the \", \"HTTP status code 404 \\n(Not Found).\\nA RESTful web API exposes a set of connected resources, and provi\", \"des the core operations that \\nenable an app to manipulate those resources and easily navigate betwee\", \"n them. For this reason, the \\nURIs that constitute a typical RESTful web API are oriented towards th\", \"e data that it exposes, and use \\nthe facilities provided by HTTP to operate on this data.61 CHAPTER \", \"10 | Accessing remote data\\nThe data included by a client app in an HTTP request, and the correspondi\", \"ng response messages from \\nthe web server, could be presented in a variety of formats, known as medi\", \"a types. When a client app \\nsends a request that returns data in the body of a message, it can speci\", \"fy the media types it can \\nhandle in the Accept header of the request. If the web server supports th\", \"is media type, it can reply \\nwith a response that includes the Content-Type header that specifies th\", \"e format of the data in the \\nbody of the message. It\\u2019s then the responsibility of the client app to \", \"parse the response message and \\ninterpret the results in the message body appropriately.\\nFor more in\", \"formation about REST, see API design and API implementation on Microsoft Docs.\\nConsuming RESTful API\", \"s\\nThe eShop multi-platform app uses the Model-View-ViewModel (MVVM) pattern, and the model \\nelements\", \" of the pattern represent the domain entities used in the app. The controller and repository \\nclasse\", \"s in the eShop reference application accept and return many of these model objects. Therefore, \\nthey\", \" are used as data transfer objects (DTOs) that hold all the data that is passed between the app \\nand\", \" the containerized microservices. The main benefit of using DTOs to pass data to and receive data \\nf\", \"rom a web service is that by transmitting more data in a single remote call, the app can reduce the \", \"\\nnumber of remote calls that need to be made.\\nMaking web requests\\nThe eShop multi-platform app uses \", \"the HttpClient class to make requests over HTTP, with JSON being \\nused as the media type. This class\", \" provides functionality for asynchronously sending HTTP requests \\nand receiving HTTP responses from \", \"a URI identified resource. The HttpResponseMessage class \\nrepresents an HTTP response message receiv\", \"ed from a REST API after an HTTP request has been \\nmade. It contains information about the response,\", \" including the status code, headers, and any body. \\nThe HttpContent class represents the HTTP body a\", \"nd content headers, such as Content-Type and \\nContent-Encoding. The content can be read using any of\", \" the ReadAs methods, such as \\nReadAsStringAsync and ReadAsByteArrayAsync, depending on the format of\", \" the data.\\nMaking a GET request\\nThe CatalogService class is used to manage the data retrieval proces\", \"s from the catalog microservice. \\nIn the RegisterViewModels method in the MauiProgram class, the Cat\", \"alogService class is registered as \\na type mapping against the ICatalogService type with the depende\", \"ncy injection container. Then, when \\nan instance of the CatalogViewModel class is created, its const\", \"ructor accepts an ICatalogService type, \\nwhich the dependency injection container resolves, returnin\", \"g an instance of the CatalogService class. \\nFor more information about dependency injection, see Dep\", \"endency Injection.\\nThe image below shows the interaction of classes that read catalog data from the \", \"catalog microservice \\nfor displaying by the CatalogView.62 CHAPTER 10 | Accessing remote data\\nWhen t\", \"he CatalogView is navigated to, the OnInitialize method in the CatalogViewModel class is \\ncalled. Th\", \"is method retrieves catalog data from the catalog microservice, as demonstrated in the \\nfollowing co\", \"de example:\\npublic override async Task InitializeAsync()\\n{\\n Products = await _productsService.GetCat\", \"alogAsync();\\n}\\nThis method calls the GetCatalogAsync method of the CatalogService instance that was \", \"injected into \\nthe CatalogViewModel by the dependency injection container. The following code exampl\", \"e shows the \\nGetCatalogAsync method:\\npublic async Task<ObservableCollection<CatalogItem>> GetCatalog\", \"Async()\\n{\\n UriBuilder builder = new UriBuilder(GlobalSetting.Instance.CatalogEndpoint);\\n builder.Pat\", \"h = \\\"api/v1/catalog/items\\\";\\n string uri = builder.ToString();\\n CatalogRoot? catalog = await _request\", \"Provider.GetAsync<CatalogRoot>(uri);\\n return catalog?.Data; \\n}63 CHAPTER 10 | Accessing remote data\\n\", \"This method builds the URI that identifies the resource the request will be sent to, and uses the \\nR\", \"equestProvider class to invoke the GET HTTP method on the resource, before returning the results to \", \"\\nthe CatalogViewModel. The RequestProvider class contains functionality that submits a request in th\", \"e \\nform of a URI that identifies a resource, an HTTP method that indicates the operation to be perfo\", \"rmed \\non that resource, and a body that contains any data required to perform the operation. For \\nin\", \"formation about how the RequestProvider class is injected into the CatalogService class, see \\nDepend\", \"ency Injection.\\nThe following code example shows the GetAsync method in the RequestProvider class:\\np\", \"ublic async Task<TResult> GetAsync<TResult>(string uri, string token = \\\"\\\")\\n{\\n HttpClient httpClient \", \"= GetOrCreateHttpClient(token);\\n HttpResponseMessage response = await httpClient.GetAsync(uri);\\n awa\", \"it HandleResponse(response);\\n TResult result = await response.Content.ReadFromJsonAsync<TResult>();\\n\", \" return result;\\n}\\nThis method calls the GetOrCreateHttpClient method, which returns an instance of t\", \"he HttpClient class \\nwith the appropriate headers set. It then submits an asynchronous GET request t\", \"o the resource \\nidentified by the URI, with the response being stored in the HttpResponseMessage ins\", \"tance. The \\nHandleResponse method is then invoked, which throws an exception if the response doesn\\u2019t\", \" include a \\nsuccess HTTP status code. Then the response is read as a string, converted from JSON to \", \"a \\nCatalogRoot object, and returned to the CatalogService.\\nThe GetOrCreateHttpClient method is shown\", \" in the following code example:\\nprivate readonly Lazy<HttpClient> _httpClient =\\n new Lazy<HttpClient\", \">(\\n () =>\\n {\\n var httpClient = new HttpClient();\\n httpClient.DefaultRequestHeaders.Accept.Add(new\\nMe\", \"diaTypeWithQualityHeaderValue(\\\"application/json\\\"));\\n return httpClient;\\n },\\n LazyThreadSafetyMode.Ex\", \"ecutionAndPublication);\\nprivate HttpClient GetOrCreateHttpClient(string token = \\\"\\\")\\n {\\n var httpClie\", \"nt = _httpClient.Value;\\n if (!string.IsNullOrEmpty(token))\\n {\\n httpClient.DefaultRequestHeaders.Auth\", \"orization = new\\nAuthenticationHeaderValue(\\\"Bearer\\\", token);\\n }\\n else\\n {\\n httpClient.DefaultRequestHe\", \"aders.Authorization = null;\\n }64 CHAPTER 10 | Accessing remote data\\n return httpClient;\\n }\\nThis meth\", \"od uses creates a new instance or retrieves a cached instance of the HttpClient class, and \\nsets the\", \" Accept header of any requests made by the HttpClient instance to application/json, which \\nindicates\", \" that it expects the content of any response to be formatted using JSON. Then, if an access \\ntoken w\", \"as passed as an argument to the GetOrCreateHttpClient method, it\\u2019s added to the \\nAuthorization heade\", \"r of any requests made by the HttpClient instance, prefixed with the string Bearer. \\nFor more inform\", \"ation about authorization, see Authorization.\\nTip\\nIt is highly recommended to cache and reuse instan\", \"ces of the HttpClient for better application \\nperformance. Creating a new HttpClient for each operat\", \"ion can lead to issue with socket exhaustion. \\nFor more information, see HttpClient Instancing on th\", \"e Microsoft Developer Center.\\nWhen the GetAsync method in the RequestProvider class calls HttpClient\", \".GetAsync, the Items method \\nin the CatalogController class in the Catalog.API project is invoked, w\", \"hich is shown in the following \\ncode example:\\n[HttpGet]\\n[Route(\\\"[action]\\\")]\\npublic async Task<IActio\", \"nResult> Items(\\n [FromQuery]int pageSize = 10, [FromQuery]int pageIndex = 0)\\n{\\n var totalItems = awa\", \"it _catalogContext.CatalogItems\\n .LongCountAsync();\\n var itemsOnPage = await _catalogContext.Catalog\", \"Items\\n .OrderBy(c => c.Name)\\n .Skip(pageSize * pageIndex)\\n .Take(pageSize)\\n .ToListAsync();\\n itemsOn\", \"Page = ComposePicUri(itemsOnPage);\\n var model = new PaginatedItemsViewModel<CatalogItem>(\\n pageIndex\", \", pageSize, totalItems, itemsOnPage); \\n return Ok(model);\\n}\\nThis method retrieves the catalog data f\", \"rom the SQL database using EntityFramework, and returns it \\nas a response message that includes a su\", \"ccess HTTP status code, and a collection of JSON formatted \\nCatalogItem instances.\\nMaking a POST req\", \"uest\\nThe BasketService class is used to manage the data retrieval and update process with the basket\", \" \\nmicroservice. In the RegisterAppServices method in the MauiProgram class, the BasketService class \", \"is \\nregistered as a type mapping against the IBasketService type with the dependency injection conta\", \"iner. \\nThen, when an instance of the BasketViewModel class is created, its constructor accepts an 65\", \" CHAPTER 10 | Accessing remote data\\nIBasketService type, which the dependency injection container re\", \"solves, returning an instance of the \\nBasketService class. For more information about dependency inj\", \"ection, see Dependency Injection.\\nThe image below shows the interaction of classes that send the bas\", \"ket data displayed by the \\nBasketView, to the basket microservice.\\nWhen an item is added to the shop\", \"ping basket, the ReCalculateTotalAsync method in the \\nBasketViewModel class is called. This method u\", \"pdates the total value of items in the basket, and sends \\nthe basket data to the basket microservice\", \", as demonstrated in the following code example:\\nprivate async Task ReCalculateTotalAsync()\\n{\\n // Om\", \"itted for brevity...\\n await _basketService.UpdateBasketAsync(\\n new CustomerBasket\\n {\\n BuyerId = user\", \"Info.UserId,\\n Items = BasketItems.ToList()\\n },\\n authToken);\\n}66 CHAPTER 10 | Accessing remote data\\nT\", \"his method calls the UpdateBasketAsync method of the BasketService instance that was injected into \\n\", \"the BasketViewModel by the dependency injection container. The following method shows the \\nUpdateBas\", \"ketAsync method:\\npublic async Task<CustomerBasket> UpdateBasketAsync(\\n CustomerBasket customerBasket\", \", string token)\\n{\\n UriBuilder builder = new UriBuilder(GlobalSetting.Instance.BasketEndpoint);\\n stri\", \"ng uri = builder.ToString();\\n var result = await _requestProvider.PostAsync(uri, customerBasket, tok\", \"en);\\n return result;\\n}\\nThis method builds the URI that identifies the resource the request will be s\", \"ent to, and uses the \\nRequestProvider class to invoke the POST HTTP method on the resource, before r\", \"eturning the results \\nto the BasketViewModel. Note that an access token, obtained from IdentityServe\", \"r during the \\nauthentication process, is required to authorize requests to the basket microservice. \", \"For more \\ninformation about authorization, see Authorization.\\nThe following code example shows one o\", \"f the PostAsync methods in the RequestProvider class:\\npublic async Task<TResult> PostAsync<TResult>(\", \"\\n string uri, TResult data, string token = \\\"\\\", string header = \\\"\\\")\\n{\\n HttpClient httpClient = GetOrC\", \"reateHttpClient(token);\\n var content = new StringContent(JsonSerializer.Serialize(data));\\n content.H\", \"eaders.ContentType = new MediaTypeHeaderValue(\\\"application/json\\\");\\n HttpResponseMessage response = a\", \"wait httpClient.PostAsync(uri, content);\\n await HandleResponse(response);\\n TResult result = await re\", \"sponse.Content.ReadFromJsonAsync<TResult>();\\n \\n return result;\\n}\\nThis method calls the GetOrCreateHt\", \"tpClient method, which returns an instance of the HttpClient class \\nwith the appropriate headers set\", \". It then submits an asynchronous POST request to the resource \\nidentified by the URI, with the seri\", \"alized basket data being sent in JSON format, and the response \\nbeing stored in the HttpResponseMess\", \"age instance. The HandleResponse method is then invoked, \\nwhich throws an exception if the response \", \"doesn\\u2019t include a success HTTP status code. Then, the \\nresponse is read as a string, converted from \", \"JSON to a CustomerBasket object, and returned to the \\nBasketService. For more information about the \", \"GetOrCreateHttpClient method, see Making a GET \\nrequest.\\nWhen the PostAsync method in the RequestPro\", \"vider class calls HttpClient.PostAsync, the Post method \\nin the BasketController class in the Basket\", \".API project is invoked, which is shown in the following code \\nexample:\\n[HttpPost]\\npublic async Task\", \"<IActionResult> Post([FromBody] CustomerBasket value)\\n{\\n var basket = await _repository.UpdateBasket\", \"Async(value);\\n return Ok(basket);\\n}67 CHAPTER 10 | Accessing remote data\\nThis method uses an instanc\", \"e of the RedisBasketRepository class to persist the basket data to the \\nRedis cache, and returns it \", \"as a response message that includes a success HTTP status code, and a \\nJSON formatted CustomerBasket\", \" instance.\\nMaking a DELETE request\\nThe image below shows the interactions of classes that delete bas\", \"ket data from the basket \\nmicroservice, for the CheckoutView.\\nWhen the checkout process is invoked, \", \"the CheckoutAsync method in the CheckoutViewModel class is \\ncalled. This method creates a new order,\", \" before clearing the shopping basket, as demonstrated in the \\nfollowing code example:\\nprivate async \", \"Task CheckoutAsync()\\n{\\n // Omitted for brevity...\\n await _basketService.ClearBasketAsync(\\n _shipping\", \"Address.Id.ToString(), authToken);\\n}\\nThis method calls the ClearBasketAsync method of the BasketServ\", \"ice instance that was injected into \\nthe CheckoutViewModel by the dependency injection container. Th\", \"e following method shows the \\nClearBasketAsync method:\\npublic async Task ClearBasketAsync(string gui\", \"dUser, string token)\\n{\\n UriBuilder builder = new(GlobalSetting.Instance.BasketEndpoint);\\n builder.Pa\", \"th = guidUser;\\n string uri = builder.ToString();\\n await _requestProvider.DeleteAsync(uri, token);\\n}6\", \"8 CHAPTER 10 | Accessing remote data\\nThis method builds the URI that identifies the resource that th\", \"e request will be sent to, and uses the \\nRequestProvider class to invoke the DELETE HTTP method on t\", \"he resource. Note that an access token, \\nobtained from IdentityServer during the authentication proc\", \"ess, is required to authorize requests to \\nthe basket microservice. For more information about autho\", \"rization, see Authorization.\\nThe following code example shows the DeleteAsync method in the RequestP\", \"rovider class:\\npublic async Task DeleteAsync(string uri, string token = \\\"\\\")\\n{\\n HttpClient httpClient\", \" = GetOrCreateHttpClient(token);\\n await httpClient.DeleteAsync(uri);\\n}\\nThis method calls the GetOrCr\", \"eateHttpClient method, which returns an instance of the HttpClient class \\nwith the appropriate heade\", \"rs set. It then submits an asynchronous DELETE request to the resource \\nidentified by the URI. For m\", \"ore information about the GetOrCreateHttpClient method, see Making a \\nGET request.\\nWhen the DeleteAs\", \"ync method in the RequestProvider class calls HttpClient.DeleteAsync, the Delete \\nmethod in the Bask\", \"etController class in the Basket.API project is invoked, which is shown in the \\nfollowing code examp\", \"le:\\n[HttpDelete(\\\"{id}\\\")]\\npublic void Delete(string id) =>\\n _repository.DeleteBasketAsync(id);\\nThis m\", \"ethod uses an instance of the RedisBasketRepository class to delete the basket data from the \\nRedis \", \"cache.\\nCaching data\\nThe performance of an app can be improved by caching frequently accessed data to\", \" fast storage \\nthat\\u2019s located close to the app. If the fast storage is located closer to the app tha\", \"n the original source, \\nthen caching can significantly improve response times when retrieving data.\\n\", \"The most common form of caching is read-through caching, where an app retrieves data by \\nreferencing\", \" the cache. If the data isn\\u2019t in the cache, it\\u2019s retrieved from the data store and added to the \\ncac\", \"he. Apps can implement read-through caching with the cache-aside pattern. This pattern \\ndetermines w\", \"hether the item is currently in the cache. If the item isn\\u2019t in the cache, it\\u2019s read from the \\ndata \", \"store and added to the cache. For more information, see the Cache-Aside pattern on Microsoft \\nDocs.\\n\", \"Tip\\nCache data that\\u2019s read frequently and changes infrequently.\\nThis data can be added to the cache \", \"on demand the first time it is retrieved by an app. This means \\nthat the app needs to fetch the data\", \" only once from the data store, and that subsequent access can \\nbe satisfied by using the cache.69 C\", \"HAPTER 10 | Accessing remote data\\nDistributed applications, such as the eShop reference application,\", \" should provide either or both of the \\nfollowing caches:\\n\\u2022 A shared cache, which can be accessed by \", \"multiple processes or machines.\\n\\u2022 A private cache, where data is held locally on the device running \", \"the app.\\nThe eShop multi-platform app uses a private cache, where data is held locally on the device\", \" that\\u2019s \\nrunning an instance of the app.\\nTip\\nThink of the cache as a transient data store that could\", \" disappear at any time.\\nEnsure that data is maintained in the original data store as well as the cac\", \"he. The chances of losing \\ndata are then minimized if the cache becomes unavailable.\\nManaging data e\", \"xpiration\\nIt\\u2019s impractical to expect that cached data will always be consistent with the original da\", \"ta. Data in the \\noriginal data store might change after it\\u2019s been cached, causing the cached data to\", \" become stale. \\nTherefore, apps should implement a strategy that helps to ensure that the data in th\", \"e cache is as up\\u0002to-date as possible, but can also detect and handle situations that arise when the \", \"data in the cache \\nhas become stale. Most caching mechanisms enable the cache to be configured to ex\", \"pire data, and \\nhence reduce the period for which data might be out of date.\\nTip\\nSet a default expir\", \"ation time when configuring a cache.\\nMany caches implement expiration, which invalidates data and re\", \"moves it from the cache if it\\u2019s not \\naccessed for a specified period. However, care must be taken wh\", \"en choosing the expiration period. If \\nit\\u2019s made too short, data will expire too quickly and the ben\", \"efits of caching will be reduced. If it\\u2019s \\nmade too long, the data risks becoming stale. Therefore, \", \"the expiration time should match the pattern \\nof access for apps that use the data.\\nWhen cached data\", \" expires, it should be removed from the cache, and the app must retrieve the data \\nfrom the original\", \" data store and place it back into the cache.\\nIt\\u2019s also possible that a cache might fill up if data \", \"is allowed to remain for too long a period. Therefore, \\nrequests to add new items to the cache might\", \" be required to remove some items in a process known \\nas eviction. Caching services typically evict \", \"data on a least-recently-used basis. However, there are \\nother eviction policies, including most-rec\", \"ently-used, and first-in-first-out. For more information, see \\nCaching Guidance on Microsoft Docs.\\nC\", \"aching images\\nThe eShop multi-platform app consumes remote product images that benefit from being ca\", \"ched. \\nThese images are displayed by the Image control. The .NET MAUI Image control supports caching\", \" of 70 CHAPTER 10 | Accessing remote data\\ndownloaded images which has caching enabled by default, an\", \"d will store the image locally for 24 \\nhours. In addition, the expiration time can be configured wit\", \"h the CacheValidity property. For more \\ninformation, see Downloaded Image Caching on the Microsoft D\", \"eveloper Center.\\nIncreasing resilience\\nAll apps that communicate with remote services and resources \", \"must be sensitive to transient faults. \\nTransient faults include the momentary loss of network conne\", \"ctivity to services, the temporary \\nunavailability of a service, or timeouts that arise when a servi\", \"ce is busy. These faults are often self\\u0002correcting, and if the action is repeated after a suitable d\", \"elay it\\u2019s likely to succeed.\\nTransient faults can have a huge impact on the perceived quality of an \", \"app, even if it has been \\nthoroughly tested under all foreseeable circumstances. To ensure that an a\", \"pp that communicates with \\nremote services operates reliably, it must be able to do all of the follo\", \"wing:\\n\\u2022 Detect faults when they occur, and determine if the faults are likely to be transient.\\n\\u2022 Ret\", \"ry the operation if it determines that the fault is likely to be transient and keep track of the \\nnu\", \"mber of times the operation was retried.\\n\\u2022 Use an appropriate retry strategy, which specifies the nu\", \"mber of retries, the delay between \\neach attempt, and the actions to take after a failed attempt.\\nTh\", \"is transient fault handling can be achieved by wrapping all attempts to access a remote service in \\n\", \"code that implements the retry pattern.\\nRetry pattern\\nIf an app detects a failure when it tries to s\", \"end a request to a remote service, it can handle the failure \\nin any of the following ways:\\n\\u2022 Retryi\", \"ng the operation. The app could retry the failing request immediately.\\n\\u2022 Retrying the operation afte\", \"r a delay. The app should wait for a suitable amount of time before \\nretrying the request.\\n\\u2022 Cancell\", \"ing the operation. The application should cancel the operation and report an \\nexception.\\nThe retry s\", \"trategy should be tuned to match the business requirements of the app. For example, it\\u2019s \\nimportant \", \"to optimize the retry count and retry interval to the operation being attempted. If the \\noperation i\", \"s part of a user interaction, the retry interval should be short and only a few retries \\nattempted t\", \"o avoid making users wait for a response. If the operation is part of a long running \\nworkflow, wher\", \"e cancelling or restarting the workflow is expensive or time-consuming, it\\u2019s appropriate \\nto wait lo\", \"nger between attempts and to retry more times.\\nNote\\nAn aggressive retry strategy with minimal delay \", \"between attempts, and a large number of retries, \\ncould degrade a remote service that\\u2019s running clos\", \"e to or at capacity. In addition, such a retry strategy \\ncould also affect the responsiveness of the\", \" app if it\\u2019s continually trying to perform a failing operation.71 CHAPTER 10 | Accessing remote data\", \"\\nIf a request still fails after a number of retries, it\\u2019s better for the app to prevent further requ\", \"ests going \\nto the same resource and to report a failure. Then, after a set period, the app can make\", \" one or more \\nrequests to the resource to see if they\\u2019re successful. For more information, see Circu\", \"it breaker pattern.\\nTip\\nNever implement an endless retry mechanism. Instead, prefer an exponential b\", \"ackoff.\\nUse a finite number of retries, or implement the Circuit Breaker pattern to allow a service \", \"to recover.\\nThe eShop reference application does implement the retry pattern.\\nFor more information a\", \"bout the retry pattern, see the Retry pattern on Microsoft Docs.\\nCircuit breaker pattern\\nIn some sit\", \"uations, faults can occur due to anticipated events that take longer to fix. These faults can \\nrange\", \" from a partial loss of connectivity to the complete failure of a service. In these situations, it\\u2019s\", \" \\npointless for an app to retry an operation that\\u2019s unlikely to succeed, and instead should accept t\", \"hat \\nthe operation has failed and handle this failure accordingly.\\nThe circuit breaker pattern can p\", \"revent an app from repeatedly trying to execute an operation that\\u2019s \\nlikely to fail, while also enab\", \"ling the app to detect whether the fault has been resolved.\\nNote\\nThe purpose of the circuit breaker \", \"pattern is different from the retry pattern. The retry pattern enables \\nan app to retry an operation\", \" in the expectation that it\\u2019ll succeed. The circuit breaker pattern prevents \\nan app from performing\", \" an operation that\\u2019s likely to fail.\\nA circuit breaker acts as a proxy for operations that might fai\", \"l. The proxy should monitor the number \\nof recent failures that have occurred, and use this informat\", \"ion to decide whether to allow the \\noperation to proceed, or to return an exception immediately.\\nThe\", \" eShop multi-platform app does not currently implement the circuit breaker pattern. However, the \\neS\", \"hop does.\\nTip\\nCombine the retry and circuit breaker patterns.\\nAn app can combine the retry and circu\", \"it breaker patterns by using the retry pattern to invoke an \\noperation through a circuit breaker. Ho\", \"wever, the retry logic should be sensitive to any exceptions \\nreturned by the circuit breaker and ab\", \"andon retry attempts if the circuit breaker indicates that a fault \\nis not transient.\\nFor more infor\", \"mation about the circuit breaker pattern, see the Circuit Breaker pattern on Microsoft \\nDocs.72 CHAP\", \"TER 10 | Accessing remote data\\nSummary\\nMany modern web-based solutions make use of web services, hos\", \"ted by web servers, to provide \\nfunctionality for remote client applications. The operations that a \", \"web service exposes constitute a \\nweb API, and client apps should be able to utilize the web API wit\", \"hout knowing how the data or \\noperations that the API exposes are implemented.\\nThe performance of an\", \" app can be improved by caching frequently accessed data to fast storage \\nthat\\u2019s located close to th\", \"e app. Apps can implement read-through caching with the cache-aside \\npattern. This pattern determine\", \"s whether the item is currently in the cache. If the item isn\\u2019t in the \\ncache, it\\u2019s read from the da\", \"ta store and added to the cache.\\nWhen communicating with web APIs, apps must be sensitive to transie\", \"nt faults. Transient faults \\ninclude the momentary loss of network connectivity to services, the tem\", \"porary unavailability of a \\nservice, or timeouts that arise when a service is busy. These faults are\", \" often self-correcting, and if the \\naction is repeated after a suitable delay, then it\\u2019s likely to s\", \"ucceed. Therefore, apps should wrap all \\nattempts to access a web API in code that implements a tran\", \"sient fault handling mechanism.73 CHAPTER 11 | Authentication and authorization\\nCHAPTER 11\\nAuthentic\", \"ation and \\nauthorization\\nAuthentication is the process of obtaining identification credentials such \", \"as name and password from \\na user and validating those credentials against an authority. The entity \", \"that submitted the credentials \\nis considered an authenticated identity if the credentials are valid\", \". Once an identity has been \\nestablished, an authorization process determines whether that identity \", \"has access to a given resource.\\nThere are many approaches to integrating authentication and authoriz\", \"ation into a .NET MAUI app that \\ncommunicates with an ASP.NET web application, including using ASP.N\", \"ET Core Identity, external \\nauthentication providers such as Microsoft, Google, Facebook, or Twitter\", \", and authentication \\nmiddleware. The eShop multi-platform app performs authentication and authoriza\", \"tion with a \\ncontainerized identity microservice that uses IdentityServer. The app requests security\", \" tokens from \\nIdentityServer to authenticate a user or access a resource. For IdentityServer to issu\", \"e tokens on behalf \\nof a user, the user must sign in to IdentityServer. However, IdentityServer does\", \"n\\u2019t provide a user \\ninterface or database for authentication. Therefore, in the eShop reference appl\", \"ication, ASP.NET Core \\nIdentity is used for this purpose.\\nAuthentication\\nAuthentication is required \", \"when an application needs to know the current user\\u2019s identity. ASP.NET \\nCore\\u2019s primary mechanism for\", \" identifying users is the ASP.NET Core Identity membership system, \\nwhich stores user information in\", \" a data store configured by the developer. Typically, this data store \\nwill be an EntityFramework st\", \"ore, though custom stores or third-party packages can be used to store \\nidentity information in Azur\", \"e storage, DocumentDB, or other locations.\\nFor authentication scenarios that use a local user datast\", \"ore and persist identity information between \\nrequests via cookies (as is typical in ASP.NET web app\", \"lications), ASP.NET Core Identity is a suitable \\nsolution. However, cookies are not always a natural\", \" means of persisting and transmitting data. For \\nexample, an ASP.NET Core web application that expos\", \"es RESTful endpoints that are accessed from an \\napp will typically need to use bearer token authenti\", \"cation since cookies can\\u2019t be used in this scenario. \\nHowever, bearer tokens can easily be retrieved\", \" and included in the authorization header of web \\nrequests made from the app.74 CHAPTER 11 | Authent\", \"ication and authorization\\nIssuing bearer tokens using IdentityServer\\nIdentityServer is an open-sourc\", \"e OpenID Connect and OAuth 2.0 framework for ASP.NET Core, which \\ncan be used for many authenticatio\", \"n and authorization scenarios, including issuing security tokens for \\nlocal ASP.NET Core Identity us\", \"ers.\\nNote\\nOpenID Connect and OAuth 2.0 are very similar, while having different responsibilities.\\nOp\", \"enID Connect is an authentication layer on top of the OAuth 2.0 protocol. OAuth 2 is a protocol \\ntha\", \"t allows applications to request access tokens from a security token service and use them to \\ncommun\", \"icate with APIs. This delegation reduces complexity in both client applications and APIs since \\nauth\", \"entication and authorization can be centralized.\\nOpenID Connect and OAuth 2.0 combine the two fundam\", \"ental security concerns of authentication \\nand API access, and IdentityServer is an implementation o\", \"f these protocols.\\nIn applications that use direct client-to-microservice communication, such as the\", \" eShop reference \\napplication, a dedicated authentication microservice acting as a Security Token Se\", \"rvice (STS) can be \\nused to authenticate users, as shown in the following diagram. For more informat\", \"ion about direct \\nclient-to-microservice communication, see Microservices.\\nThe eShop multi-platform \", \"app communicates with the identity microservice, which uses IdentityServer \\nto perform authenticatio\", \"n, and access control for APIs. Therefore, the multi-platform app requests \\ntokens from IdentityServ\", \"er, either for authenticating a user or for accessing a resource:\\n\\u2022 Authenticating users with Identi\", \"tyServer is achieved by the multi-platform app requesting an \\nidentity token, representing an authen\", \"tication process\\u2019s outcome. At a minimum, it contains \\nan identifier for the user and information ab\", \"out how and when the user is authenticated. It \\ncan also include additional identity data.\\n\\u2022 Accessi\", \"ng a resource with IdentityServer is achieved by the multi-platform app requesting an \\naccess token,\", \" which allows access to an API resource. Clients request access tokens and \\nforward them to the API.\", \" Access tokens contain information about the client and the user, if \\npresent. APIs then use that in\", \"formation to authorize access to their data.\\nNote\\nA client must be registered with IdentityServer be\", \"fore it can successfully request tokens. For more \\ninformation on adding clients, see Defining Clien\", \"ts.75 CHAPTER 11 | Authentication and authorization\\nAdding IdentityServer to a web application\\nIn or\", \"der for an ASP.NET Core web application to use IdentityServer, it must be added to the web \\napplicat\", \"ion\\u2019s Visual Studio solution. For more information, see Setup and Overview in the \\nIdentityServer do\", \"cumentation. Once IdentityServer is included in the web application\\u2019s Visual Studio \\nsolution, it mu\", \"st be added to its HTTP request processing pipeline to serve requests to OpenID \\nConnect and OAuth 2\", \".0 endpoints. This is configured in the Identity.API project\\u2019s Program.cs, as \\ndemonstrated in the f\", \"ollowing code example:\\n...\\napp.UseIdentityServer();\\nOrder matters in the web application\\u2019s HTTP requ\", \"est processing pipeline. Therefore, IdentityServer \\nmust be added to the pipeline before the UI fram\", \"ework that implements the login screen.\\nConfiguring IdentityServer\\nIdentityServer should be configur\", \"ed in the ConfigureServices method in the web application\\u2019s Startup \\nclass by calling the services.A\", \"ddIdentityServer method, as demonstrated in the following code \\nexample from the eShop reference app\", \"lication:\\npublic void ConfigureServices(IServiceCollection services)\\n{\\n services\\n .AddIdentityServer\", \"(x => x.IssuerUri = \\\"null\\\")\\n .AddSigningCredential(Certificate.Get())\\n .AddAspNetIdentity<Applicatio\", \"nUser>()\\n .AddConfigurationStore(builder =>\\n builder.UseSqlServer(connectionString, options =>\\n opti\", \"ons.MigrationsAssembly(migrationsAssembly)))\\n .AddOperationalStore(builder =>\\n builder.UseSqlServer(\", \"connectionString, options =>\\n options.MigrationsAssembly(migrationsAssembly)))\\n .Services.AddTransie\", \"nt<IProfileService, ProfileService>();\\n}\\nAfter calling the services.AddIdentityServer method, additi\", \"onal fluent APIs are called to configure the \\nfollowing:\\n\\u2022 Credentials used for signing.\\n\\u2022 API and i\", \"dentity resources that users might request access to.\\n\\u2022 Clients that will be connecting to request t\", \"okens.\\n\\u2022 ASP.NET Core Identity.\\nTip\\nDynamically load the IdentityServer configuration. IdentityServe\", \"r\\u2019s APIs allow for configuring \\nIdentityServer from an in-memory list of configuration objects. In t\", \"he eShop reference application, \\nthese in-memory collections are hard-coded into the application. Ho\", \"wever, in production scenarios \\nthey can be loaded dynamically from a configuration file or from a d\", \"atabase.76 CHAPTER 11 | Authentication and authorization\\nFor information about configuring IdentityS\", \"erver to use ASP.NET Core Identity, see Using ASP.NET \\nCore Identity in the IdentityServer documenta\", \"tion.\\nConfiguring API resources\\nWhen configuring API resources, the AddInMemoryApiResources method e\", \"xpects an \\nIEnumerable<ApiResource> collection. The following code example shows the GetApis method \", \"that \\nprovides this collection in the eShop reference application:\\npublic static IEnumerable<ApiReso\", \"urce> GetApis()\\n{\\n return new List<ApiResource>\\n {\\n new ApiScope(\\\"orders\\\", \\\"Orders Service\\\"),\\n new A\", \"piScope(\\\"basket\\\", \\\"Basket Service\\\"),\\n new ApiScope(\\\"webhooks\\\", \\\"Webhooks registration Service\\\"),\\n };\", \"\\n}\\nThis method specifies that IdentityServer should protect the orders and basket APIs. Therefore, \\n\", \"IdentityServer-managed access tokens will be required when making calls to these APIs. For more \\ninf\", \"ormation about the ApiResource type, see API Resource in the IdentityServer documentation.\\nConfiguri\", \"ng identity resources\\nWhen configuring identity resources, the AddInMemoryIdentityResources method e\", \"xpects an \\nIEnumerable<IdentityResource> collection. Identity resources are data such as user ID, na\", \"me, or email \\naddress. Each identity resource has a unique name, and arbitrary claim types can be as\", \"signed to it, \\nwhich will be included in the identity token for the user. The following code example\", \" shows the \\nGetResources method that provides this collection in the eShop reference application:\\npu\", \"blic static IEnumerable<IdentityResource> GetResources()\\n{\\n return new List<IdentityResource>\\n {\\n ne\", \"w IdentityResources.OpenId(),\\n new IdentityResources.Profile()\\n };\\n}\\nThe OpenID Connect specificatio\", \"n specifies some standard identity resources. The minimum \\nrequirement is that support is provided f\", \"or emitting a unique ID for users. This is achieved by \\nexposing the IdentityResources.OpenId identi\", \"ty resource.\\nNote\\nThe IdentityResources class supports all of the scopes defined in the OpenID Conne\", \"ct specification \\n(openid, email, profile, telephone, and address).\\nIdentityServer also supports def\", \"ining custom identity resources. For more information, see Defining \\ncustom identity resources in th\", \"e IdentityServer documentation. For more information about the \\nIdentityResource type, see Identity \", \"Resource in the IdentityServer documentation.77 CHAPTER 11 | Authentication and authorization\\nConfig\", \"uring clients\\nClients are applications that can request tokens from IdentityServer. Typically, the f\", \"ollowing settings \\nmust be defined for each client as a minimum:\\n\\u2022 A unique client ID.\\n\\u2022 The allowed\", \" interactions with the token service (known as the grant type).\\n\\u2022 The location where identity and ac\", \"cess tokens are sent to (known as a redirect URI).\\n\\u2022 A list of resources that the client is allowed \", \"access to (known as scopes).\\nWhen configuring clients, the AddInMemoryClients method expects an IEnu\", \"merable<Client> \\ncollection. The following code example shows the configuration for the eShop multi-\", \"platform app in \\nthe GetClients method that provides this collection in the eShop reference applicat\", \"ion:\\npublic static IEnumerable<Client> GetClients(Dictionary<string,string> clientsUrl)\\n{\\n return ne\", \"w List<Client>\\n {\\n // Omitted for brevity\\n new Client\\n {\\n ClientId = \\\"maui\\\",\\n ClientName = \\\"eShop .N\", \"ET MAUI OpenId Client\\\",\\n AllowedGrantTypes = GrantTypes.Hybrid,\\n ClientSecrets =\\n {\\n new Secret(\\\"sec\", \"ret\\\".Sha256())\\n },\\n RedirectUris = { clientsUrl[\\\"maui\\\"] },\\n RequireConsent = false,\\n RequirePkce = t\", \"rue,\\n PostLogoutRedirectUris = { $\\\"{clientsUrl[\\\"maui\\\"]}/Account/Redirecting\\\" },\\n AllowedCorsOrigins \", \"= { \\\"http://eshopmaui\\\" },\\n AllowedScopes = new List<string>\\n {\\n IdentityServerConstants.StandardScop\", \"es.OpenId,\\n IdentityServerConstants.StandardScopes.Profile,\\n IdentityServerConstants.StandardScopes.\", \"OfflineAccess,\\n \\\"orders\\\",\\n \\\"basket\\\"\\n },\\n AllowOfflineAccess = true,\\n AllowAccessTokensViaBrowser = t\", \"rue,\\n AccessTokenLifetime = 60 * 60 * 2, // 2 hours\\n IdentityTokenLifetime = 60 * 60 * 2 // 2 hours\\n\", \" }\\n };\\n}\\nThis configuration specifies data for the following properties:\\nProperty Description\\nClient\", \"Id A unique ID for the client.\\nClientName The client display name, which is used for \\nlogging and th\", \"e consent screen.78 CHAPTER 11 | Authentication and authorization\\nProperty Description\\nAllowedGrantT\", \"ypes Specifies how a client wants to interact with \\nIdentityServer. For more information see \\nConfig\", \"uring the authentication flow.\\nClientSecrets Specifies the client secret credentials that are \\nused \", \"when requesting tokens from the token \\nendpoint.\\nRedirectUris Specifies the allowed URIs to which to\", \" return \\ntokens or authorization codes.\\nRequireConsent Specifies whether a consent screen is require\", \"d.\\nRequirePkce Specifies whether clients using an authorization \\ncode must send a proof key.\\nPostLog\", \"outRedirectUris Specifies the allowed URIs to redirect to after \\nlogout.\\nAllowedCorsOrigins Specifie\", \"s the origin of the client so that \\nIdentityServer can allow cross-origin calls from \\nthe origin.\\nAl\", \"lowedScopes Specifies the resources the client has access to. \\nBy default, a client has no access to\", \" any \\nresources.\\nAllowOfflineAccess Specifies whether the client can request refresh \\ntokens.\\nAllowA\", \"ccessTokensViaBrowser Specifies whether the client can receive access \\ntokens from a browser window.\", \"\\nAlwaysIncludeUserClaimsInIdToken Specifies that the user claims will always be \\nadded to the id tok\", \"en. By default, these would \\nhave to be retrieved using the userinfo \\nendpoint.\\nAccessTokenLifetime \", \"Specifies the lifetime of the access token in \\nseconds.\\nIdentityTokenLifetime Specifies the lifetime\", \" of the identity token in \\nseconds.\\nConfiguring the authentication flow\\nThe authentication flow betw\", \"een a client and IdentityServer can be configured by specifying the grant \\ntypes in the Client.Allow\", \"edGrantTypes property. The OpenID Connect and OAuth 2.0 specifications \\ndefine several authenticatio\", \"n flows, including:79 CHAPTER 11 | Authentication and authorization\\nAuthentication Flow Description\\n\", \"Implicit This flow is optimized for browser-based \\napplications and should be used either for user \\n\", \"authentication-only, or authentication and \\naccess token requests. All tokens are \\ntransmitted via t\", \"he browser, and therefore \\nadvanced features like refresh tokens are not \\npermitted.\\nAuthorization c\", \"ode This flow provides the ability to retrieve tokens \\non a back channel, as opposed to the browser \", \"\\nfront channel, while also supporting client \\nauthentication.\\nHybrid This flow is a combination of t\", \"he implicit and \\nauthorization code grant types. The identity \\ntoken is transmitted via the browser \", \"channel \\nand contains the signed protocol response and \\nother artifacts such as the authorization co\", \"de. \\nAfter successfully validating the response, the \\nback channel should be used to retrieve the \\na\", \"ccess and refresh token.\\nTip\\nConsider using the hybrid authentication flow. The hybrid authenticatio\", \"n flow mitigates a number of \\nattacks that apply to the browser channel, and is the recommended flow\", \" for native applications that \\nwant to retrieve access tokens (and possibly refresh tokens).\\nFor mor\", \"e information about authentication flows, see Grant Types in the IdentityServer \\ndocumentation.\\nPerf\", \"orming authentication\\nFor IdentityServer to issue tokens on behalf of a user, the user must sign in \", \"to IdentityServer. However, \\nIdentityServer doesn\\u2019t provide a user interface or database for authent\", \"ication. Therefore, in the eShop \\nreference application, ASP.NET Core Identity is used for this purp\", \"ose.\\nThe eShop multi-platform app authenticates with IdentityServer with the hybrid authentication f\", \"low, \\nwhich is illustrated in the diagram below.80 CHAPTER 11 | Authentication and authorization\\nA s\", \"ign in request is made to <base endpoint>:5105/connect/authorize. Following successful \\nauthenticati\", \"on, IdentityServer returns an authentication response containing an authorization code \\nand an ident\", \"ity token. The authorization code is sent to <base endpoint>:5105/connect/token, which \\nresponds wit\", \"h access, identity, and refresh tokens.\\nThe eShop multi-platform app signs out of IdentityServer by \", \"sending a request to <base \\nendpoint>:5105/connect/endsession with additional parameters. After sign\", \"-out, IdentityServer \\nresponds by sending a post-logout redirecting URI back to the multi-platform a\", \"pp. The diagram \\nbelow illustrates this process.\\nIn the eShop multi-platform app, communication with\", \" IdentityServer is performed by the \\nIdentityService class, which implements the IIdentityService in\", \"terface. This interface specifies that the \\nimplementing class must provide SignInAsync, SignOutAsyn\", \"c, GetUserInfoAsync and \\nGetAuthTokenAsync methods.\\nSigning-in\\nWhen the user taps the LOGIN button o\", \"n the LoginView, the SignInCommand in the LoginViewModel \\nclass is executed, which in turn executes \", \"the SignInAsync method. The following code example shows \\nthis method:\\n[RelayCommand]\\nprivate async \", \"Task SignInAsync()\\n{\\n await IsBusyFor(\\n async () =>\\n {\\n var loginSuccess = await _appEnvironmentServ\", \"ice.IdentityService.SignInAsync();\\n if (loginSuccess)\\n {\\n await NavigationService.NavigateToAsync(\\\"/\", \"/Main/Catalog\\\");\\n }81 CHAPTER 11 | Authentication and authorization\\n });\\n}\\nThis method invokes the S\", \"ignInAsync method in the IdentityService class, as shown in the following \\ncode example:\\npublic asyn\", \"c Task<bool> SignInAsync()\\n{\\n var response = await GetClient().LoginAsync(new LoginRequest()).Config\", \"ureAwait(false);\\n if (response.IsError)\\n {\\n return false;\\n }\\n await _settingsService\\n .SetUserTokenA\", \"sync(\\n new UserToken\\n {\\n AccessToken = response.AccessToken,\\n IdToken = response.IdentityToken,\\n Ref\", \"reshToken = response.RefreshToken,\\n ExpiresAt = response.AccessTokenExpiration\\n })\\n .ConfigureAwait(\", \"false);\\n return !response.IsError;\\n}\\nThe IdentityService makes use of the OidcClient provided with t\", \"he IdentityModel.OidcClient NuGet \\npackage. This client displays the authentication web view to the \", \"user in the application and captures \\nthe authentication result. The client connects to the URI for \", \"IdentityServer\\u2019s authorization endpoint\\nwith the required parameters. The authorization endpoint is \", \"at /connect/authorize on port 5105 of the \\nbase endpoint exposed as a user setting. For more informa\", \"tion about user settings, see Configuration \\nManagement.\\nNote\\nThe attack surface of the eShop multi-\", \"platform app is reduced by implementing the Proof Key for \\nCode Exchange (PKCE) extension to OAuth. \", \"PKCE protects the authorization code from being used if \\nit\\u2019s intercepted. This is achieved by the c\", \"lient generating a secret verifier, a hash of which is passed in \\nthe authorization request, and whi\", \"ch is presented unhashed when redeeming the authorization code. \\nFor more information about PKCE, se\", \"e Proof Key for Code Exchange by OAuth Public Clients on the \\nInternet Engineering Task Force web si\", \"te.82 CHAPTER 11 | Authentication and authorization\\nIf the token endpoint receives valid authenticat\", \"ion information, authorization code, and PKCE secret \\nverifier, it responds with an access token, id\", \"entity token, and refresh token. The access token (which \\nallows access to API resources) and identi\", \"ty token are stored as application settings, and page \\nnavigation is performed. Therefore, the overa\", \"ll effect in the eShop multi-platform app is this: provided \\nthat users are able to successfully aut\", \"henticate with IdentityServer, they are navigated to the \\n//Main/Catalog route, which is a TabbedPag\", \"e that displays the CatalogView as its selected tab.83 CHAPTER 11 | Authentication and authorization\", \"\\nFor information about page navigation, see Navigation. For information about how WebView \\nnavigatio\", \"n causes a view model method to be executed, see Invoking navigation using behaviors. For \\ninformati\", \"on about application settings, see Configuration management.\\nNote\\nThe eShop also allows a mock sign \", \"in when the app is configured to use mock services in the \\nSettingsView. In this mode, the app doesn\", \"\\u2019t communicate with IdentityServer, instead allowing the \\nuser to sign in using any credentials.\\nSig\", \"ning-out\\nWhen the user taps the LOG OUT button in the ProfileView, the LogoutCommand in the \\nProfile\", \"ViewModel class is executed, which executes the LogoutAsync method. This method performs \\npage navig\", \"ation to the LoginView page, passing a Logout query parameter set to true.\\nThat parameter is evaluat\", \"ed in the ApplyQueryAttributes method. If the Logout parameter is present \\nwith a true value, the Pe\", \"rformLogoutAsync method of the LoginViewModel class is executed, which is \\nshown in the following co\", \"de example:\\nprivate async Task PerformLogoutAsync()\\n{\\n await _appEnvironmentService.IdentityService.\", \"SignOutAsync();\\n _settingsService.UseFakeLocation = false;\\n UserName.Value = string.Empty;\\n Password\", \".Value = string.Empty;\\n}\\nThis method invokes the SignOutAsync method in the IdentityService class, w\", \"hich invokes the \\nOidcClient to end the user\\u2019s session and clears any saved user tokens. For more in\", \"formation about \\napplication settings, see Configuration management. The following code example show\", \"s the \\nSignOutAsync method:\\npublic async Task<bool> SignOutAsync()\\n{\\n var response = await GetClient\", \"().LogoutAsync(new\\nLogoutRequest()).ConfigureAwait(false);\\n if (response.IsError)\\n {\\n return false;\\n\", \" }\\n await _settingsService.SetUserTokenAsync(default);\\n return !response.IsError;\\n}\\nThis method uses\", \" the OidcClient to call the URI to IdentityServer\\u2019s end session endpoint with the \\nrequired paramete\", \"rs. The end session endpoint is at /connect/endsession on port 5105 of the base \\nendpoint exposed as\", \" a user setting. Once the user has successfully signed out, LoginView is presented \\nto the user, and\", \" any saved user information will be cleared.84 CHAPTER 11 | Authentication and authorization\\nFor inf\", \"ormation about page navigation, see Navigation. For information about how WebView \\nnavigation causes\", \" a view model method to be executed, see Invoking navigation using behaviors. For \\ninformation about\", \" application settings, see Configuration management.\\nNote\\nThe eShop also allows a mock sign-out when\", \" the app is configured to use mock services in the \\nSettingsView. In this mode, the app doesn\\u2019t comm\", \"unicate with IdentityServer, and instead clears any \\nstored tokens from application settings.\\nAuthor\", \"ization\\nAfter authentication, ASP.NET Core web APIs often need to authorize access, which allows a s\", \"ervice to \\nmake APIs available to some authenticated users but not to all.\\nRestricting access to an \", \"ASP.NET Core route can be achieved by applying an Authorize attribute to a \\ncontroller or action, wh\", \"ich limits access to the controller or action to authenticated users, as shown in \\nthe following cod\", \"e example:\\n[Authorize]\\npublic sealed class BasketController : Controller\\n{\\n // Omitted for brevity\\n}\", \"\\nIf an unauthorized user attempts to access a controller or action marked with the Authorize attribu\", \"te, \\nthe API framework returns a 401 (unauthorized) HTTP status code.\\nNote\\nParameters can be specifi\", \"ed on the Authorize attribute to restrict an API to specific users. For more \\ninformation, see ASP.N\", \"ET Core Docs: Authorization.\\nIdentityServer can be integrated into the authorization workflow so tha\", \"t the access tokens provide \\ncontrol authorization. This approach is shown in the diagram below.85 C\", \"HAPTER 11 | Authentication and authorization\\nThe eShop multi-platform app communicates with the iden\", \"tity microservice and requests an access \\ntoken as part of the authentication process. The access to\", \"ken is then forwarded to the APIs exposed \\nby the ordering and basket microservices as part of the a\", \"ccess requests. Access tokens contain \\ninformation about the client and the user. APIs then use that\", \" information to authorize access to their \\ndata. For information about how to configure IdentityServ\", \"er to protect APIs, see Configuring API \\nresources.\\nConfiguring IdentityServer to perform authorizat\", \"ion\\nTo perform authorization with IdentityServer, its authorization middleware must be added to the \", \"web \\napplication\\u2019s HTTP request pipeline. The middleware is added in the AddDefaultAuthentication \\ne\", \"xtension method, which is invoked from the AddApplicationServices method in the Program class \\nand i\", \"s demonstrated in the following code example from the eShop reference application:\\npublic static ISe\", \"rviceCollection AddDefaultAuthentication(this IHostApplicationBuilder \\nbuilder)\\n{\\n var services = bu\", \"ilder.Services;\\n var configuration = builder.Configuration;\\n var identitySection = configuration.Get\", \"Section(\\\"Identity\\\");\\n if (!identitySection.Exists())\\n {\\n // No identity section, so no authenticatio\", \"n\\n return services;\\n }\\n // prevent from mapping \\\"sub\\\" claim to nameidentifier.\\n JsonWebTokenHandler.\", \"DefaultInboundClaimTypeMap.Remove(\\\"sub\\\");\\n services.AddAuthentication().AddJwtBearer(options =>\\n {86\", \" CHAPTER 11 | Authentication and authorization\\n var identityUrl = identitySection.GetRequiredValue(\\\"\", \"Url\\\");\\n var audience = identitySection.GetRequiredValue(\\\"Audience\\\");\\n options.Authority = identityUr\", \"l;\\n options.RequireHttpsMetadata = false;\\n options.Audience = audience;\\n options.TokenValidationPara\", \"meters.ValidIssuers = [identityUrl];\\n options.TokenValidationParameters.ValidateAudience = false;\\n }\", \");\\n services.AddAuthorization();\\n return services;\\n}\\nThis method ensures that the API can only be ac\", \"cessed with a valid access token. The middleware \\nvalidates the incoming token to ensure that it\\u2019s s\", \"ent from a trusted issuer and validates that the token \\nis valid to be used with the API that receiv\", \"es it. Therefore, browsing to the ordering or basket \\ncontroller will return a 401 (unauthorized) HT\", \"TP status code, indicating that an access token is \\nrequired.\\nMaking access requests to APIs\\nWhen ma\", \"king requests to the ordering and basket microservices, the access token obtained from \\nIdentityServ\", \"er during the authentication process must be included in the request, as shown in the \\nfollowing cod\", \"e example:\\npublic async Task CreateOrderAsync(Models.Orders.Order newOrder)\\n{\\n var authToken = await\", \" _identityService.GetAuthTokenAsync().ConfigureAwait(false);\\n if (string.IsNullOrEmpty(authToken))\\n \", \"{\\n return;\\n }\\n var uri = $\\\"{UriHelper.CombineUri(_settingsService.GatewayOrdersEndpointBase, \\nApiUrl\", \"Base)}?api-version=1.0\\\";\\n var success = await _requestProvider.PostAsync(uri, newOrder, authToken, \\\"\", \"x\\u0002requestid\\\").ConfigureAwait(false);\\n}\\nThe access token is stored with the IIdentityService implemen\", \"tation and can be retrieved using the \\nGetAuthTokenAsync method.\\nSimilarly, the access token must be\", \" included when sending data to an IdentityServer protected API, as \\nshown in the following code exam\", \"ple:\\npublic async Task ClearBasketAsync()\\n{\\n var authToken = await _identityService.GetAuthTokenAsyn\", \"c().ConfigureAwait(false);\\n if (string.IsNullOrEmpty(authToken))\\n {\\n return;87 CHAPTER 11 | Authenti\", \"cation and authorization\\n }\\n await GetBasketClient().DeleteBasketAsync(new DeleteBasketRequest(),\\nCr\", \"eateAuthenticationHeaders(authToken))\\n .ConfigureAwait(false);\\n}\\nThe access token is retrieved from \", \"the IIdentityService and included in the call to the ClearBasketAsync \\nmethod in the BasketService c\", \"lass.\\nThe RequestProvider class in the eShop multi-platform app uses the HttpClient class to make re\", \"quests \\nto the RESTful APIs exposed by the eShop reference application. When making requests to the \", \"\\nordering and basket APIs, which require authorization, a valid access token must be included with t\", \"he \\nrequest. This is achieved by adding the access token to the headers of the HttpClient instance, \", \"as \\ndemonstrated in the following code example:\\nhttpClient.DefaultRequestHeaders.Authorization = new\", \" AuthenticationHeaderValue(\\\"Bearer\\\", to\\nken);\\nThe DefaultRequestHeaders property of the HttpClient c\", \"lass exposes the headers that are sent with \\neach request, and the access token is added to the Auth\", \"orization header prefixed with the string \\nBearer. When the request is sent to a RESTful API, the va\", \"lue of the Authorization header is extracted \\nand validated to ensure that it\\u2019s sent from a trusted \", \"issuer and used to determine whether the user \\nhas permission to invoke the API that receives it.\\nFo\", \"r more information about how the eShop multi-platform app makes web requests, see Accessing \\nremote \", \"data.\\nSummary\\nThere are many approaches to integrating authentication and authorization into a .NET \", \"MAUI app that \\ncommunicates with an ASP.NET web application. The eShop multi-platform app performs \\n\", \"authentication and authorization with a containerized identity microservice that uses IdentityServer\", \". \\nIdentityServer is an open-source OpenID Connect and OAuth 2.0 framework for ASP.NET Core that \\nin\", \"tegrates with ASP.NET Core Identity to perform bearer token authentication.\\nThe multi-platform app r\", \"equests security tokens from IdentityServer to authenticate a user or access a \\nresource. When acces\", \"sing a resource, an access token must be included in the request to APIs that \\nrequire authorization\", \". IdentityServer\\u2019s middleware validates incoming access tokens to ensure that \\nthey are sent from a \", \"trusted issuer and that they are valid to be used with the API that receives them.88 CHAPTER 12 | MV\", \"VM Toolkit Features\\nCHAPTER 12\\nMVVM Toolkit Features\\nMVVM Toolkit\\nThe Model-View-ViewModel (MVVM) pa\", \"ttern is a great structural basis for creating our applications. \\nIn this pattern, the ViewModel bec\", \"omes the backbone of our application as it provides \\ncommunication to our front-end user interface a\", \"nd backing components. To provide integration with \\nthe user interface, we will rely on the ViewMode\", \"l\\u2019s properties and commands. As detailed in Updating \\nviews in response to changes in the underlying\", \" view model or model, the INotifyPropertyChanged \\ninterface on our ViewModel to allows changes to ou\", \"r properties to notify when the value is changed. \\nImplementing all of these features means that our\", \" ViewModel can end up becoming very verbose. For \\nexample, the following code shows a simple ViewMod\", \"el with properties that raise changes:\\npublic class SampleViewModel : INotifyPropertyChanged\\n{\\n priv\", \"ate string _name;\\n private int _value;\\n public event PropertyChangedEventHandler PropertyChanged;\\n p\", \"ublic string Name\\n {\\n get => _name;\\n set => SetPropertyValue(ref _name, value);\\n }\\n public int Value\", \"\\n {\\n get => _value;\\n set => SetPropertyValue(ref _value, value);\\n }\\n protected void SetPropertyValue\", \"<T>(ref T storageField, T newValue, [CallerMemberName]\\nstring propertyName = \\\"\\\")\\n {\\n if (Equals(stor\", \"ageField, newValue))\\n return;\\n storageField = newValue;\\n RaisePropertyChanged(propertyName);\\n }\\n pro\", \"tected virtual void RaisePropertyChanged([CallerMemberName] string propertyName =\\n\\\"\\\")\\n {\\n PropertyCh\", \"anged?.Invoke(this, new PropertyChangedEventArgs(propertyName));\\n }\\n}89 CHAPTER 12 | MVVM Toolkit Fe\", \"atures\\nWhile some optimizations could be made over time, we will still end up with a fairly verbose \", \"set of \\ncode for defining our ViewModel. This code can be difficult to maintain and becomes error-pr\", \"one.\\nThe CommunityToolkit.Mvvm NuGet Package (aka MVVM Toolkit) can be used to help address and \\nsim\", \"plify these common MVVM patterns. The MVVM Toolkit, along with newer features to the .NET \\nlanguage,\", \" allows for simplified logic, easy adoption into a project, and runtime independence. The \\nexample b\", \"elow shows the same ViewModel using components that come with the MVVM Toolkit:\\npublic partial class\", \" SampleViewModel : ObservableObject\\n{\\n [ObservableProperty]\\n private string _name;\\n [ObservablePrope\", \"rty]\\n private int _value;\\n}\\nNote\\nThe MVVM Toolkit is provided with the CommunityToolkit.Mvvm package\", \". For information on how to \\nadd the package to your project, see Introduction to the MVVM Toolkit o\", \"n the Microsoft Developer \\nCenter.\\nIn comparison to the original example, we were able to drasticall\", \"y reduce the overall complexity and \\nsimplify the maintainability of our ViewModel. The MVVM Toolkit\", \" comes with many pre-built common \\ncomponents and features, such as the ObservableObject shown above\", \", that simplifies and \\nstandardizes the code that we have throughout the application.\\nObservableObje\", \"ct\\nThe MVVM Toolkit provides ObservableObject which is intended for use as the base of our \\nViewMode\", \"l objects or any object that needs to raise change notifications. It implements \\nINotifyPropertyChan\", \"ged and INotifyPropertyChanging along with helper methods for setting \\nproperties and raising change\", \"s. Below is an example of a standard ViewModel using \\nObservableObject:\\npublic class SampleViewModel\", \" : ObservableObject\\n{\\n private string _name;\\n private int _value;\\n public string Name\\n {\\n get => _na\", \"me;\\n set => SetProperty(ref _name, value);\\n }\\n public int Value\\n {\\n get => _value;\\n set => SetProper\", \"ty(ref _value, value);90 CHAPTER 12 | MVVM Toolkit Features\\n }\\n}\\nObservableObject handles all of the\", \" logic needed for raising change notifications by using the \\nSetProperty method in your property set\", \"ter. If you have a property that returns a Task<T>, the \\nSetPropertyAndNotifyOnCompletion method can\", \" be used to delay publishing a property change until \\nthe task has been completed. The methods OnPro\", \"pertyChanged and OnPropertyChanging that can \\nalso be used for raising property changes where needed\", \" in your object.\\nFor more detailed information on ObservableObject, see ObservableObject in the MVVM\", \" Toolkit \\nDeveloper Center.\\nRelayCommand and AsyncRelayCommand\\nInteraction between .NET MAUI control\", \"s (for example, tapping a button or selecting an item from a \\ncollection) and the ViewModel is done \", \"with the ICommand interface. .NET MAUI comes with a default \\nimplementation of ICommand with the Com\", \"mand object. .NET MAUI\\u2019s Command is fairly basic and \\nlacks support for more advanced features, such\", \" as supporting asynchronous work and command \\nexecution status.\\nThe MVVM Toolkit comes with two comm\", \"ands, RelayCommand and AsyncRelayCommand. \\nRelayCommand is intended for situations where you have sy\", \"nchronous code to execute and has a \\nfairly similar implementation to the .NET MAUI Command object.\\n\", \"Note\\nEven though the .NET MAUI Command and RelayCommand are similar, using RelayCommand allows \\nfor \", \"decoupling your ViewModel from any direct .NET MAUI references. This means that your \\nViewModel is m\", \"ore portable, leading to easier reuse across projects.\\nAsyncRelayCommand provides many additional fe\", \"atures when working with asynchronous workflows. \\nThis is quite common in our ViewModel as we are ty\", \"pically communicating with repositories, APIs, \\ndatabases, and other systems that utilize async/awai\", \"t. The AsyncRelayCommand constructor takes in \\nan execution task defined as a Func<Task> or a delega\", \"te returning Task as part of the constructor. \\nWhile the execution task is running, AsyncRelayComman\", \"d will monitor the state of the task and \\nprovides updates using the IsRunning property. The IsRunni\", \"ng property can be bound to the UI which \\nhelps manage control states such as showing loading with a\", \"n ActivityIndicator or disabling/enabling a \\ncontrol. While the execution task is being executed, th\", \"e Cancel method can be called to attempt \\ncancellation of the execution task, if supported.\\nBy defau\", \"lt, AsyncRelayCommand doesn\\u2019t allow concurrent execution. This is very helpful in situations \\nwhere \", \"a user could unintentionally tap a control multiple times to execute a long-running or costly \\nopera\", \"tion. During task execution, AsyncRelayCommand will automatically call the CanExecuteChanged \\nevent.\", \" In .NET MAUI, controls that support the Command and CommandParameter properties, such as \\nButton, w\", \"ill listen to this event and automatically enable or disable it during execution. This \\nfunctionalit\", \"y can be overridden by using a custom canExecute parameter or setting the \\nAsyncRelayCommandOptions.\", \"AllowConcurrentExecutions flag in the constructor.91 CHAPTER 12 | MVVM Toolkit Features\\nFor more det\", \"ailed information on implementing commands, see the section Implementing commands\\nin the MVVM chapte\", \"r. Detailed information for the RelayCommand and AsyncRelayCommand is \\navailable in the Commanding o\", \"f the MVVM Toolkit Developer Center.\\nSource Generators\\nUsing the MVVM Toolkit components out-of-the-\", \"box allows you to greatly simplify our ViewModel. \\nThe MVVM Toolkit allows you to simplify common co\", \"de use cases even further by using Source \\nGenerators. The MVVM Toolkit source generators look for s\", \"pecific attributes in our code and can \\ngenerate wrappers for properties and commands.\\nImportant\\nThe\", \" MVVM Toolkit Source Generators generate code that is additive to our existing objects. Because \\nof \", \"this, any object that is leveraging a source generator will need to be marked as partial.\\nThe MVVM T\", \"oolkit ObservableProperty attribute can be applied to fields in objects that inherit from \\nObservabl\", \"eObject and will wrap a private field with a property that generates changes. The following \\ncode sh\", \"ows an example of using the ObservableObject attribute on the _name field:\\npublic partial class Samp\", \"leViewModel : ObservableObject\\n{\\n [ObservableProperty]\\n private string _name;\\n}\\nWith the ObservableP\", \"roperty attribute applied to the _name field, the source generator will run and \\ngenerate another pa\", \"rtial class with the following code:\\npartial class SampleViewModel\\n{\\n public string Name\\n {\\n get => \", \"_name;\\n set\\n {\\n if (!EqualityComparer<string>.Default.Equals(_name, value))\\n {\\n OnNameChanging(value\", \");\\n OnPropertyChanging(\\\"Name\\\");\\n _name = value;\\n OnNameChanged(value);\\n OnPropertyChanged(\\\"Name\\\");\\n \", \"}\\n }\\n }\\n}\\nThe generated SampleViewModel has used the private _name field and generated a new Name \\np\", \"roperty that implements all of the logic needed for raising change notifications.92 CHAPTER 12 | MVV\", \"M Toolkit Features\\nThe MVVM Toolkit RelayCommand attribute can be applied to methods within an Obser\", \"vableObject \\nand will create a corresponding RelayCommand or AsyncRelayCommand. The following code s\", \"hows \\nexamples of using the RelayCommand attribute:\\npublic partial class SampleViewModel : Observabl\", \"eObject\\n{\\n public INavigationService NavigationService { get; set; }\\n [ObservableProperty]\\n private \", \"string _name;\\n [ObservableProperty]\\n bool _isValid;\\n [RelayCommand]\\n private Task SettingsAsync()\\n {\", \"\\n return NavigationService.NavigateToAsync(\\\"Settings\\\");\\n }\\n [RelayCommand]\\n private void Validate()\\n\", \" {\\n IsValid = !string.IsNullOrEmpty(Name);\\n }\\n}\\nThe RelayCommand applied to the Validate method will\", \" generate a RelayCommand validate \\nValidateCommand because it has a void return and the SettingsAsyn\", \"c method will generate an \\nAsyncRelayCommand named SettingsCommand. The source generator will genera\", \"te the following \\ncode in other partial classes:\\npartial class SampleViewModel\\n{\\n private AsyncRelay\", \"Command? settingsCommand;\\n SettingsCommand => settingsCommand ??= new AsyncRelayCommand(SettingsAsyn\", \"c);\\n}\\npartial class SampleViewModel\\n{\\n private RelayCommand? validateCommand;\\n public IRelayCommand \", \"ValidateCommand => validateCommand ??= new RelayCommand(Validate);\\n}\\nAll of the complexity of wrappi\", \"ng our ViewModel\\u2019s methods with an ICommand implementation has \\nbeen handled by the source generator\", \".\\nFor more detailed information on MVVM Toolkit Source Generators, see MVVM source generators in \\nth\", \"e MVVM Toolkit Developer Center.93 CHAPTER 12 | MVVM Toolkit Features\\nSummary\\nThe MVVM Toolkit is a \", \"great way to standardize and simplify our ViewModel code. The MVVM toolkit \\noffers great implementat\", \"ions of standard MVVM components such as ObservableObject and \\nAsync/RelayCommand. The source genera\", \"tors help simplify our ViewModel properties and commands \\nby generating all of the boilerplate code \", \"needed for user interface interactions. The MVVM Toolkit \\noffers even more features outside of what \", \"has been shown in this chapter. For more information on \\nthe MVVM Toolkit, see Introduction to the M\", \"VVM Toolkit in the MVVM Toolkit Developer Center.94 CHAPTER 13 | Unit testing\\nCHAPTER 13\\nUnit testin\", \"g\\nmulti-platform apps experience problems similar to both desktop and web-based applications. Mobile\", \" \\nusers will differ by their devices, network connectivity, availability of services, and various ot\", \"her factors. \\nTherefore, multi-platform apps should be tested as they would be used in the real worl\", \"d to improve \\ntheir quality, reliability, and performance. Many types of testing should be performed\", \" on an app, \\nincluding unit testing, integration testing, and user interface testing. Unit testing i\", \"s the most common \\nform and essential to building high-quality applications.\\nA unit test takes a sma\", \"ll unit of the app, typically a method, isolates it from the remainder of the code, \\nand verifies th\", \"at it behaves as expected. Its goal is to check that each unit of functionality performs as \\nexpecte\", \"d, so errors don\\u2019t propagate throughout the app. Detecting a bug where it occurs is more \\nefficient \", \"that observing the effect of a bug indirectly at a secondary point of failure.\\nUnit testing has the \", \"most significant effect on code quality when it\\u2019s an integral part of the software \\ndevelopment work\", \"flow. Unit tests can act as design documentation and functional specifications for \\nan application. \", \"As soon as a method has been written, unit tests should be written that verify the \\nmethod\\u2019s behavio\", \"r in response to standard, boundary, and incorrect input data cases and check any \\nexplicit or impli\", \"cit assumptions made by the code. Alternatively, with test-driven development, unit \\ntests are writt\", \"en before the code. For more information on test-driven development and how to \\nimplement it, see Wa\", \"lkthrough: Test-driven development using Test Explorer.\\nNote\\nUnit tests are very effective against r\", \"egression. That is, functionality that used to work, but has been \\ndisturbed by a faulty update.\\nUni\", \"t tests typically use the arrange-act-assert pattern:\\nStep Description\\nArrange Initializes objects a\", \"nd sets the value of the data \\nthat is passed to the method under test.\\nAct Invokes the method under\", \" test with the required \\narguments.\\nAssert Verifies that the action of the method under test \\nbehave\", \"s as expected.\\nThis pattern ensures that unit tests are readable, self-describing, and consistent.95\", \" CHAPTER 13 | Unit testing\\nDependency injection and unit testing\\nOne of the motivations for adopting\", \" a loosely-coupled architecture is that it facilitates unit testing. \\nOne of the types registered wi\", \"th the dependency injection service is the IAppEnvironmentService \\ninterface. The following code exa\", \"mple shows an outline of this class:\\npublic class OrderDetailViewModel : ViewModelBase\\n{\\n private IA\", \"ppEnvironmentService _appEnvironmentService;\\n public OrderDetailViewModel(\\n IAppEnvironmentService a\", \"ppEnvironmentService,\\n IDialogService dialogService, INavigationService navigationService,\\nISettings\", \"Service settingsService)\\n : base(dialogService, navigationService, settingsService)\\n {\\n _appEnvironm\", \"entService = appEnvironmentService;\\n }\\n}\\nThe OrderDetailViewModel class has a dependency on the IApp\", \"EnvironmentService type, which the \\ndependency injection container resolves when it instantiates an \", \"OrderDetailViewModel object. \\nHowever, rather than create an IAppEnvironmentService object which uti\", \"lizes real servers, devices and \\nconfigurations to unit test the OrderDetailViewModel class, instead\", \", replace the \\nIAppEnvironmentService object with a mock object for the purpose of the tests. A mock\", \" object is one \\nthat has the same signature of an object or an interface, but is created in a specif\", \"ic manner to help \\nwith unit testing. It is often used with dependency injection to provide specific\", \" implementations of \\ninterfaces for testing different data and workflow scenarios.\\nThis approach all\", \"ows the IAppEnvironmentService object to be passed into the OrderDetailViewModel \\nclass at runtime, \", \"and in the interests of testability, it allows a mock class to be passed into the \\nOrderDetailViewMo\", \"del class at test time. The main advantage of this approach is that it enables unit \\ntests to be exe\", \"cuted without requiring unwieldy resources such as runtime platform features, web \\nservices, or data\", \"bases.\\nTesting MVVM applications\\nTesting models and view models from MVVM applications is identical \", \"to testing any other class, and \\nuses the same tools and techniques; this includes features such as \", \"unit testing and mocking. However, \\nsome patterns that are typical to model and view model classes c\", \"an benefit from specific unit testing \\ntechniques.\\nTip\\nTest one thing with each unit test. As the co\", \"mplexity of a test expands, it makes verification of that \\ntest more difficult. By limiting a unit t\", \"est to a single concern, we can ensure that our tests are more \\nrepeatable, isolated, and have a sma\", \"ller execution time. See\\nUnit testing best practices with .NET for more best practices.96 CHAPTER 13\", \" | Unit testing\\nDon\\u2019t be tempted to make a unit test exercise more than one aspect of the unit\\u2019s beh\", \"avior. Doing so \\nleads to tests that are difficult to read and update. It can also lead to confusion\", \" when interpreting a \\nfailure.\\nThe eShop multi-platform app uses MSTest to perform unit testing, whi\", \"ch supports two different \\ntypes of unit tests:\\nTesting Type Attribute Description\\nTestMethod TestMe\", \"thod Defines the actual test method to run..\\nDataSource DataSource Tests that are only true for a pa\", \"rticular set of data.\\nThe unit tests included with the eShop multi-platform app are TestMethod, so e\", \"ach unit test method \\nis decorated with the TestMethod attribute. In addition to MSTest there are se\", \"veral other testing \\nframeworks available including NUnit and xUnit.\\nTesting asynchronous functional\", \"ity\\nWhen implementing the MVVM pattern, view models usually invoke operations on services, often \\nas\", \"ynchronously. Tests for code that invokes these operations typically use mocks as replacements for \\n\", \"the actual services. The following code example demonstrates testing asynchronous functionality by \\n\", \"passing a mock service into a view model:\\n[TestMethod]\\npublic async Task OrderPropertyIsNotNullAfter\", \"ViewModelInitializationTest()\\n{\\n // Arrange\\n var orderService = new OrderMockService();\\n var orderVi\", \"ewModel = new OrderDetailViewModel(orderService);\\n // Act\\n var order = await orderService.GetOrderAs\", \"ync(1, GlobalSetting.Instance.AuthToken);\\n await orderViewModel.InitializeAsync(order);\\n // Assert\\n \", \"Assert.IsNotNull(orderViewModel.Order);\\n}\\nThis unit test checks that the Order property of the Order\", \"DetailViewModel instance will have a value \\nafter the InitializeAsync method has been invoked. The I\", \"nitializeAsync method is invoked when the \\nview model\\u2019s corresponding view is navigated to. For more\", \" information about navigation, see \\nNavigation.\\nWhen the OrderDetailViewModel instance is created, i\", \"t expects an IOrderService instance to be \\nspecified as an argument. However, the OrderService retri\", \"eves data from a web service. Therefore, an \\nOrderMockService instance, a mock version of the OrderS\", \"ervice class, is specified as the argument to \\nthe OrderDetailViewModel constructor. Then, mock data\", \" is retrieved rather than communicating with \\na web service when the view model\\u2019s InitializeAsync me\", \"thod is invoked, which uses IOrderService \\noperations.97 CHAPTER 13 | Unit testing\\nTesting INotifyPr\", \"opertyChanged implementations\\nImplementing the INotifyPropertyChanged interface allows views to reac\", \"t to changes that originate \\nfrom view models and models. These changes are not limited to data show\", \"n in controls \\u2013 they are also \\nused to control the view, such as view model states that cause animat\", \"ions to be started or controls to \\nbe disabled.\\nProperties that can be updated directly by the unit \", \"test can be tested by attaching an event handler to \\nthe PropertyChanged event and checking whether \", \"the event is raised after setting a new value for the \\nproperty. The following code example shows su\", \"ch a test:\\n[TestMethod]\\npublic async Task SettingOrderPropertyShouldRaisePropertyChanged()\\n{\\n var in\", \"voked = false;\\n var orderService = new OrderMockService();\\n var orderViewModel = new OrderDetailView\", \"Model(orderService);\\n orderViewModel.PropertyChanged += (sender, e) =>\\n {\\n if (e.PropertyName.Equals\", \"(\\\"Order\\\"))\\n invoked = true;\\n };\\n var order = await orderService.GetOrderAsync(1, GlobalSetting.Insta\", \"nce.AuthToken);\\n await orderViewModel.InitializeAsync(order);\\n Assert.IsTrue(invoked);\\n}\\nThis unit t\", \"est invokes the InitializeAsync method of the OrderViewModel class, which causes its Order \\nproperty\", \" to be updated. The unit test will pass, provided that the PropertyChanged event is raised for \\nthe \", \"Order property.\\nTesting message-based communication\\nView models that use the MessagingCenter class t\", \"o communicate between loosely coupled classes \\ncan be unit tested by subscribing to the message bein\", \"g sent by the code under test, as demonstrated \\nin the following code example:\\n[TestMethod]\\npublic v\", \"oid AddCatalogItemCommandSendsAddProductMessageTest()\\n{\\n var messageReceived = false;\\n var catalogSe\", \"rvice = new CatalogMockService();\\n var catalogViewModel = new CatalogViewModel(catalogService);\\n Mes\", \"sagingCenter.Subscribe<CatalogViewModel, CatalogItem>(\\n this, MessageKeys.AddProduct, (sender, arg) \", \"=>\\n {\\n messageReceived = true;\\n });\\n catalogViewModel.AddCatalogItemCommand.Execute(null);98 CHAPTER\", \" 13 | Unit testing\\n Assert.IsTrue(messageReceived);\\n}\\nThis unit test checks that the CatalogViewMode\", \"l publishes the AddProduct message in response to its \\nAddCatalogItemCommand being executed. Because\", \" the MessagingCenter class supports multicast \\nmessage subscriptions, the unit test can subscribe to\", \" the AddProduct message and execute a callback \\ndelegate in response to receiving it. This callback \", \"delegate, specified as a lambda expression, sets a \\nboolean field that\\u2019s used by the Assert statemen\", \"t to verify the behavior of the test.\\nTesting exception handling\\nUnit tests can also be written that\", \" check that specific exceptions are thrown for invalid actions or \\ninputs, as demonstrated in the fo\", \"llowing code example:\\n[TestMethod]\\npublic void InvalidEventNameShouldThrowArgumentExceptionText()\\n{\\n\", \" var behavior = new MockEventToCommandBehavior\\n {\\n EventName = \\\"OnItemTapped\\\"\\n };\\n var listView = ne\", \"w ListView();\\n Assert.Throws<ArgumentException>(() => listView.Behaviors.Add(behavior));\\n}\\nThis unit\", \" test will throw an exception because the ListView control does not have an event named \\nOnItemTappe\", \"d. The Assert.Throws<T> method is a generic method where T is the type of the \\nexpected exception. T\", \"he argument passed to the Assert.Throws<T> method is a lambda expression \\nthat will throw the except\", \"ion. Therefore, the unit test will pass provided that the lambda expression \\nthrows an ArgumentExcep\", \"tion.\\nTip\\nAvoid writing unit tests that examine exception message strings. Exception message strings\", \" might \\nchange over time, and so unit tests that rely on their presence are regarded as brittle.\\nTes\", \"ting validation\\nThere are two aspects to testing the validation implementation: testing that any val\", \"idation rules are \\ncorrectly implemented and testing that the ValidatableObject<T> class performs as\", \" expected.\\nValidation logic is usually simple to test, because it is typically a self-contained proc\", \"ess where the \\noutput depends on the input. There should be tests on the results of invoking the Val\", \"idate method on \\neach property that has at least one associated validation rule, as demonstrated in \", \"the following code \\nexample:\\n[TestMethod]\\npublic void CheckValidationPassesWhenBothPropertiesHaveDat\", \"aTest()\\n{99 CHAPTER 13 | Unit testing\\n var mockViewModel = new MockViewModel();\\n mockViewModel.Foren\", \"ame.Value = \\\"John\\\";\\n mockViewModel.Surname.Value = \\\"Smith\\\";\\n var isValid = mockViewModel.Validate();\", \"\\n Assert.IsTrue(isValid);\\n}\\nThis unit test checks that validation succeeds when the two ValidatableO\", \"bject<T> properties in the \\nMockViewModel instance both have data.\\nAs well as checking that validati\", \"on succeeds, validation unit tests should also check the values of the \\nValue, IsValid, and Errors p\", \"roperty of each ValidatableObject<T> instance, to verify that the class \\nperforms as expected. The f\", \"ollowing code example demonstrates a unit test that does this:\\n[TestMethod]\\npublic void CheckValidat\", \"ionFailsWhenOnlyForenameHasDataTest()\\n{\\n var mockViewModel = new MockViewModel();\\n mockViewModel.For\", \"ename.Value = \\\"John\\\";\\n bool isValid = mockViewModel.Validate();\\n Assert.IsFalse(isValid);\\n Assert.Is\", \"NotNull(mockViewModel.Forename.Value);\\n Assert.IsNull(mockViewModel.Surname.Value);\\n Assert.IsTrue(m\", \"ockViewModel.Forename.IsValid);\\n Assert.IsFalse(mockViewModel.Surname.IsValid);\\n Assert.AreEqual(moc\", \"kViewModel.Forename.Errors.Count(), 0);\\n Assert.AreNotEqual(mockViewModel.Surname.Errors.Count(), 0)\", \";\\n}\\nThis unit test checks that validation fails when the Surname property of the MockViewModel doesn\", \"\\u2019t \\nhave any data, and the Value, IsValid, and Errors property of each ValidatableObject<T> instance\", \" are \\ncorrectly set.\\nSummary\\nA unit test takes a small unit of the app, typically a method, isolates\", \" it from the remainder of the code, \\nand verifies that it behaves as expected. Its goal is to check \", \"that each unit of functionality performs as \\nexpected, so errors don\\u2019t propagate throughout the app.\", \"\\nThe behavior of an object under test can be isolated by replacing dependent objects with mock \\nobje\", \"cts that simulate the behavior of the dependent objects. This enables unit tests to be executed \\nwit\", \"hout requiring unwieldy resources such as runtime platform features, web services, or databases\\nTest\", \"ing models and view models from MVVM applications is identical to testing any other classes, and \\nth\", \"e same tools and techniques can be used.\"]"