"[\"[DOWNLOAD available at: https://aka.ms/maui-ebook](https://aka.ms/maui-ebook)\\n\\n\\n**EDITION v2.0**\\n\\n\\nP\", \"UBLISHED BY\\n\\n\\nMicrosoft Developer Division, .NET, and Visual Studio product teams\\n\\n\\nA division of Mi\", \"crosoft Corporation\\n\\n\\nOne Microsoft Way\\n\\n\\nRedmond, Washington 98052-6399\\n\\n\\nCopyright \\u00a9 2022 by Micro\", \"soft Corporation\\n\\n\\nAll rights reserved. No part of the contents of this book may be reproduced or tr\", \"ansmitted in any\\nform or by any means without the written permission of the publisher.\\n\\n\\nThis book i\", \"s provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The views, opinions, and\\ninformati\", \"on expressed in this book, including URL and other Internet website references, may change\\nwithout n\", \"otice.\\n\\n\\nSome examples depicted herein are provided for illustration only and are fictitious. No rea\", \"l association\\nor connection is intended or should be inferred.\\n\\n\\n[Microsoft and the trademarks liste\", \"d at https://www.microsoft.com](https://www.microsoft.com/) on the \\u201cTrademarks\\u201d webpage are\\ntrademar\", \"ks of the Microsoft group of companies.\\n\\n\\nMac and macOS are trademarks of Apple Inc.\\n\\n\\nAll other mar\", \"ks and logos are property of their respective owners.\\n\\n\\nAuthors:\\n\\n\\n**[Michael Stonis](https://github\", \".com/michaelstonis)** [, Mobile Software Architect, Eight-Bot](https://eightbot.com/)\\n\\n\\nReviewers:\\n\\n\", \"\\n**[James Montemagno](https://github.com/jamesmontemagno)**, Principal Lead Program Manager, Microso\", \"ft Corp.\\n\\n\\n**[David Pine](https://github.com/IEvangelist)**, Developer Relations, Microsoft Corp.\\n##\", \"# Acknowledgments\\n\\n\\nThis book originated from the excellent Enterprise Application Patterns using Xa\", \"marin.Forms eBook by\\n[David Britch](https://github.com/davidbritch) [and Javier Suarez Ruiz. Without\", \" their hard work, detailed information, and excellent](https://github.com/jsuarezruiz)\\nexamples, thi\", \"s book would not be possible.\\n### Introduction\\n\\n\\nEnterprise applications face a number of difficult \", \"problems to solve including ever changing business\\nrequirements, the need for quick turn around time\", \", support for multiple platforms, and integration\\nwith multiple systems. Due to the varying nature o\", \"f these problems, it\\u2019s important that our\\napplication\\u2019s architecture allows it to be modular, modifi\", \"able and extensible over time.\\n\\n\\nThis book takes provides real world solutions for addressing these \", \"issues when building an enterprise\\napplication using .NET MAUI. This book uses a pre-built .NET MAUI\", \" application that serves as the\\nfront-end of an online eCommerce application as a reference and a gu\", \"ide for common enterprise\\ndesign patterns. This book covers topics such as the MVVM pattern, depende\", \"ncy injection, navigation,\\nconfiguration, the loose-coupling of components and additional enterprise\", \" concerns. The content of\\nthis book is helpful for anyone looking to build a new application for thi\", \"s business or looking to solve\\nthe problems of applications that evolve over time.\\n### Who should us\", \"e the book\\n\\n\\nThis book is for .NET MAUI developers that are already familiar with the framework, but\", \" that are\\nlooking for guidance on architecture and implementation when building enterprise applicati\", \"ons. This\\nbook can help developers solve common problems using tried and true patterns.\\n### How to u\", \"se the book\\n\\n\\nThis book focuses on building cross-platform enterprise apps using .NET MAUI. As such,\", \" it should be\\nread in its entirety to provide a foundation of understanding such apps and their tech\", \"nical\\nconsiderations. The book, along with its sample app, can also serve as a starting point or ref\", \"erence for\\ncreating a new enterprise app. Use the associated sample app as a template for the new ap\", \"p, or to see\\nhow to organize an app\\u2019s component parts. Then, refer back to this guide for architectu\", \"ral guidance.\\n[You can find the sample app on GitHub.](https://github.com/dotnet/eshop)\\n### What thi\", \"s book doesn\\u2019t cover\\n\\n\\nThis book is aimed at readers who are already familiar with .NET MAUI. It doe\", \"s cover some concepts\\nof .NET MAUI to help better illustrate the topic, but it does not cover most c\", \"ontrols and concepts in\\n[any detail. For general guidance on building a new .NET MAUI app, please re\", \"fer to the Building your](https://docs.microsoft.com/dotnet/maui/get-started/first-app)\\n[first app](\", \"https://docs.microsoft.com/dotnet/maui/get-started/first-app) guide in the .NET MAUI documentation.\\n\", \"#### **Additional resources**\\n\\n\\n[For official .NET MAUI content, see .NET MAUI docs. .NET MAUI is de\", \"veloped as an open-source](https://docs.microsoft.com/dotnet/maui)\\n[project and is available on GitH\", \"ub at dotnet/maui. For code samples developed with .NET MAUI, see](https://github.com/dotnet/maui)\\n[\", \"the dotnet/maui-samples repo.](https://github.com/dotnet/maui-samples)\\n\\n\\n## Contents\\n\\n**Purpose ....\", \"....................................................................................................\", \"............................. 1**\\n\\n\\nWhat\\u2019s left out of this guide\\u2019s scope ..........................\", \"....................................................................................................\", \".. 1\\n\\n\\nWho should use this guide ...................................................................\", \"............................................................................... 1\\n\\n\\nHow to use this \", \"guide ..............................................................................................\", \".............................................................. 2\\n\\n\\n**Introduction to .NET MAUI .....\", \"............................................................................................... 3**\\n\", \"\\n\\nSample application ...............................................................................\", \"................................................................................... 4\\n\\n\\nSample appli\", \"cation architecture ................................................................................\", \"........................................................ 5\\n\\n\\nMulti-Platform app ....................\", \"....................................................................................................\", \".......................................... 6\\n\\n\\nMulti-Platform app solution .........................\", \"....................................................................................................\", \"................... 7\\n\\n\\neShop project ..............................................................\", \"....................................................................................................\", \".......... 7\\n\\n\\nSummary .............................................................................\", \"....................................................................................................\", \".... 8\\n\\n\\n**Model-View-ViewModel (MVVM) .............................................................\", \"............................ 9**\\n\\n\\nThe MVVM pattern ................................................\", \"....................................................................................................\", \".............. 9\\n\\n\\nView ............................................................................\", \"....................................................................................................\", \"....... 10\\n\\n\\nViewModel .............................................................................\", \"............................................................................................. 11\\n\\n\\nM\", \"odel ...............................................................................................\", \"..................................................................................... 11\\n\\n\\nConnectin\", \"g view models to views .............................................................................\", \"..................................................... 12\\n\\n\\nCreating a view model declaratively .....\", \"....................................................................................................\", \".................... 12\\n\\n\\nCreating a view model programmatically ...................................\", \"................................................................................ 13\\n\\n\\nUpdating views\", \" in response to changes in the underlying view model or model...................................... \", \"13\\n\\n\\nMVVM Frameworks ...............................................................................\", \"............................................................................... 15\\n\\n\\nUI interaction \", \"using commands and behaviors .......................................................................\", \"................................. 15\\n\\n\\nImplementing commands .......................................\", \"....................................................................................................\", \"...... 16\\n\\n\\nInvoking commands from a view ..........................................................\", \"......................................................................... 17\\n\\n\\nImplementing behavior\", \"s ..................................................................................................\", \".................................................. 17\\n\\n\\nInvoking behaviors from a view .............\", \"....................................................................................................\", \"..................... 20\\n\\n\\nSummary .................................................................\", \"....................................................................................................\", \"............. 20\\n\\n\\n**Dependency injection ..........................................................\", \"................................................. 21**\\n\\n\\ni Contents\\n\\n\\nIntroduction to dependency inj\", \"ection .............................................................................................\", \"............................. 21\\n\\n\\nRegistration ....................................................\", \"....................................................................................................\", \"..................... 23\\n\\n\\nResolution ..............................................................\", \"....................................................................................................\", \".............. 25\\n\\n\\nSummary ........................................................................\", \"....................................................................................................\", \"...... 26\\n\\n\\n**Communicating between loosely coupled components .....................................\", \".............. 27**\\n\\n\\nIntroduction to MVVM Toolkit Messenger .......................................\", \".......................................................................... 27\\n\\n\\nDefining a message .\", \"....................................................................................................\", \"......................................................... 29\\n\\n\\nPublishing a message ................\", \"....................................................................................................\", \"...................................... 29\\n\\n\\nSubscribing to a message................................\", \"....................................................................................................\", \".............. 30\\n\\n\\nUnsubscribing from a message ...................................................\", \".................................................................................... 30\\n\\n\\nSummary ..\", \"....................................................................................................\", \"............................................................................ 31\\n\\n\\n**Navigation .....\", \"....................................................................................................\", \"..................... 32**\\n\\n\\nNavigating between pages ..............................................\", \"................................................................................................. 33\", \"\\n\\n\\nCreating the MauiNavigationService instance .....................................................\", \"..................................................... 34\\n\\n\\nHandling navigation requests ............\", \"....................................................................................................\", \".......................... 34\\n\\n\\nNavigating when the app is launched ................................\", \".......................................................................................... 36\\n\\n\\nPass\", \"ing parameters during navigation ...................................................................\", \"...................................................... 36\\n\\n\\nInvoking navigation using behaviors ....\", \"....................................................................................................\", \".................... 37\\n\\n\\nConfirming or cancelling navigation ......................................\", \"....................................................................................... 38\\n\\n\\nSummary\", \" ...................................................................................................\", \"............................................................................... 38\\n\\n\\n**Validation ..\", \"....................................................................................................\", \"......................... 39**\\n\\n\\nSpecifying validation rules .......................................\", \"....................................................................................................\", \"..... 40\\n\\n\\nAdding validation rules to a property ...................................................\", \"....................................................................... 42\\n\\n\\nTriggering validation .\", \"....................................................................................................\", \"...................................................... 42\\n\\n\\nTriggering validation manually .........\", \"....................................................................................................\", \"...................... 42\\n\\n\\nTriggering validation when properties change ...........................\", \"......................................................................... 43\\n\\n\\nDisplaying validation\", \" errors ............................................................................................\", \".................................................. 43\\n\\n\\nHighlighting a control that contains invalid\", \" data ..............................................................................................\", \".. 44\\n\\n\\nDisplaying error messages ..................................................................\", \"......................................................................... 45\\n\\n\\nSummary .............\", \"....................................................................................................\", \"................................................................. 45\\n\\n\\n**Application settings manage\", \"ment ...................................................................................... 46**\\n\\n\\ni\", \"i Contents\\n\\n\\nCreating a Settings Interface .........................................................\", \"................................................................................... 46\\n\\n\\nAdding Sett\", \"ings ...............................................................................................\", \"...................................................................... 47\\n\\n\\nData binding to user set\", \"tings...............................................................................................\", \"............................................ 48\\n\\n\\nSummary ..........................................\", \"....................................................................................................\", \".................................... 49\\n\\n\\n**Containerized microservices ............................\", \".................................................................... 50**\\n\\n\\nMicroservices ..........\", \"....................................................................................................\", \"............................................................ 51\\n\\n\\nContainerization .................\", \"....................................................................................................\", \"............................................... 53\\n\\n\\nCommunication between client and microservices \", \"................................................................................................ 56\\n\", \"\\n\\nCommunication between microservices ..............................................................\", \"........................................................ 57\\n\\n\\nSummary ..............................\", \"....................................................................................................\", \"................................................ 59\\n\\n\\n**Accessing remote data ......................\", \".................................................................................... 60**\\n\\n\\nIntroduc\", \"tion to Representational State Transfer ............................................................\", \".......................................... 60\\n\\n\\nConsuming RESTful APIs .............................\", \"....................................................................................................\", \"................... 61\\n\\n\\nMaking web requests .......................................................\", \"................................................................................................... \", \"61\\n\\n\\nMaking a GET request ..........................................................................\", \"............................................................................... 61\\n\\n\\nMaking a POST r\", \"equest .............................................................................................\", \"......................................................... 64\\n\\n\\nMaking a DELETE request .............\", \"....................................................................................................\", \"................................. 67\\n\\n\\nCaching data ................................................\", \"....................................................................................................\", \"....................... 68\\n\\n\\nManaging data expiration ..............................................\", \"................................................................................................... \", \"69\\n\\n\\nCaching images ................................................................................\", \"..................................................................................... 69\\n\\n\\nIncreasin\", \"g resilience .......................................................................................\", \"...................................................................... 70\\n\\n\\nRetry pattern ..........\", \"....................................................................................................\", \"............................................................. 70\\n\\n\\nCircuit breaker pattern .........\", \"....................................................................................................\", \"........................................... 71\\n\\n\\nSummary ...........................................\", \"....................................................................................................\", \"................................... 72\\n\\n\\n**Authentication and authorization ........................\", \"............................................................... 73**\\n\\n\\nAuthentication ..............\", \"....................................................................................................\", \"...................................................... 73\\n\\n\\nIssuing bearer tokens using IdentityServ\", \"er .................................................................................................\", \"........... 74\\n\\n\\nAdding IdentityServer to a web application ........................................\", \".................................................................. 75\\n\\n\\nConfiguring IdentityServer .\", \"....................................................................................................\", \"...................................... 75\\n\\n\\nConfiguring API resources ..............................\", \"....................................................................................................\", \".......... 76\\n\\n\\nConfiguring identity resources .....................................................\", \".............................................................................. 76\\n\\n\\niii Contents\\n\\n\\nC\", \"onfiguring clients .................................................................................\", \"......................................................................... 77\\n\\n\\nConfiguring the authe\", \"ntication flow .....................................................................................\", \"................................... 78\\n\\n\\nPerforming authentication .................................\", \"....................................................................................................\", \"...... 79\\n\\n\\nSigning-in .............................................................................\", \"............................................................................................... 80\\n\\n\", \"\\nSigning-out .......................................................................................\", \".................................................................................. 83\\n\\n\\nAuthorizatio\", \"n ..................................................................................................\", \"........................................................................ 84\\n\\n\\nConfiguring IdentitySe\", \"rver to perform authorization ......................................................................\", \"...................... 85\\n\\n\\nMaking access requests to APIs .........................................\", \"............................................................................................. 86\\n\\n\\nS\", \"ummary .............................................................................................\", \"..................................................................................... 87\\n\\n\\n**MVVM To\", \"olkit Features .....................................................................................\", \"................... 88**\\n\\n\\nMVVM Toolkit ............................................................\", \"....................................................................................................\", \"........ 88\\n\\n\\nObservableObject .....................................................................\", \"............................................................................................ 89\\n\\n\\nRe\", \"layCommand and AsyncRelayCommand ...................................................................\", \"............................................ 90\\n\\n\\nSource Generators ................................\", \"....................................................................................................\", \"............................ 91\\n\\n\\nSummary ..........................................................\", \"....................................................................................................\", \".................... 93\\n\\n\\n**Unit testing ...........................................................\", \"................................................................. 94**\\n\\n\\nDependency injection and un\", \"it testing .........................................................................................\", \"............................... 95\\n\\n\\nTesting MVVM applications .....................................\", \"....................................................................................................\", \"..... 95\\n\\n\\nTesting asynchronous functionality ......................................................\", \"......................................................................... 96\\n\\n\\nTesting INotifyProper\", \"tyChanged implementations ..........................................................................\", \"...................... 97\\n\\n\\nTesting message-based communication ....................................\", \"................................................................................. 97\\n\\n\\nTesting excep\", \"tion handling ......................................................................................\", \"........................................................ 98\\n\\n\\nTesting validation ...................\", \"....................................................................................................\", \"........................................... 98\\n\\n\\nSummary ...........................................\", \"....................................................................................................\", \"................................... 99\\n\\n\\niv Contents\\n\\n\\n**CHAPTER**\\n# 1\\n\\n## Purpose\\n\\n\\nThis eBook prov\", \"ides guidance on building cross-platform enterprise apps using .NET MAUI. .NET\\nMAUI is a cross-platf\", \"orm UI toolkit that allows developers to easily create native user interface layouts\\nthat can be sha\", \"red across platforms, including iOS, macOS, Android, and Windows. It provides a\\ncomprehensive soluti\", \"on for Business to Employee (B2E), Business to Business (B2B), and Business to\\nConsumer (B2C) apps, \", \"providing the ability to share code across all target platforms and helping to\\nlower the total cost \", \"of ownership (TCO).\\n\\n\\nThe guide provides architectural guidance for developing adaptable, maintainab\", \"le, and testable .NET\\nMAUI enterprise apps. Guidance is provided on how to implement MVVM, dependenc\", \"y injection,\\nnavigation, validation, and configuration management, while maintaining loose coupling.\", \" In addition,\\nthere\\u2019s also guidance on performing authentication and authorization with IdentityServ\", \"er, accessing\\ndata from containerized microservices, and unit testing.\\n\\n\\n[The guide comes with sourc\", \"e code for the eShop multi-platform app, and source code for the eShop](https://github.com/dotnet/eS\", \"hop/tree/main/src/ClientApp)\\n[reference app. The eShop multi-platform app is a cross-platform enterp\", \"rise app developed using .NET](https://github.com/dotnet/eShop)\\nMAUI, which connects to a series of \", \"containerized microservices known as the eShop reference app.\\nHowever, the eShop multi-platform app \", \"can be configured to consume data from mock services for\\nthose who wish to avoid deploying the conta\", \"inerized microservices.\\n\\n### What\\u2019s left out of this guide\\u2019s scope\\n\\n\\nThis guide is aimed at readers \", \"who are already familiar with .NET MAUI. For a detailed introduction to\\n[.NET MAUI, see the .NET MAU\", \"I documentation.](https://docs.microsoft.com/dotnet/maui/)\\n\\n### Who should use this guide\\n\\n\\nThe audi\", \"ence for this guide is mainly developers and architects who would like to learn how to\\narchitect and\", \" implement cross-platform enterprise apps using .NET MAUI.\\n\\n\\nA secondary audience is technical decis\", \"ion-makers who would like to receive an architectural and\\ntechnology overview before deciding on wha\", \"t approach to select for cross-platform enterprise app\\ndevelopment using .NET MAUI.\\n\\n\\n1 CHAPTER 1 | \", \"Purpose\\n\\n\\n### How to use this guide\\n\\nThis guide focuses on building cross-platform enterprise apps u\", \"sing .NET MAUI. As such, it should be\\nread in its entirety to provide a foundation of understanding \", \"such apps and their technical\\nconsiderations. The guide and its sample app can also serve as a start\", \"ing point or reference for\\ncreating a new enterprise app. Use the associated sample app as a templat\", \"e for the new app or see\\nhow to organize an app\\u2019s component parts. Then, refer back to this guide fo\", \"r architectural guidance.\\n\\n\\nFeel free to forward this guide to team members to help ensure a common \", \"understanding of crossplatform enterprise app development using .NET MAUI. Having everybody working \", \"from a common\\nset of terminologies and underlying principles will help ensure a consistent applicati\", \"on of architectural\\npatterns and practices.\\n\\n\\n2 CHAPTER 1 | Purpose\\n\\n\\n**CHAPTER**\\n# 2\\n\\n## Introducti\", \"on to .NET MAUI\\n\\n\\nRegardless of platform, developers of enterprise apps face several challenges:\\n\\n\\n \", \" - App requirements that can change over time.\\n\\n  - New business opportunities and challenges.\\n\\n  - \", \"Ongoing feedback during development that can significantly affect the scope and\\nrequirements of the \", \"app.\\n\\n\\nWith these in mind, it\\u2019s important to build apps that can be easily modified or extended over\", \" time.\\nDesigning for such adaptability can be difficult as it requires an architecture that allows i\", \"ndividual\\nparts of the app to be independently developed and tested in isolation without affecting t\", \"he rest of\\nthe app.\\n\\n\\nMany enterprise apps are sufficiently complex to require more than one develop\", \"er. It can be a\\nsignificant challenge to decide how to design an app so that multiple developers can\", \" work effectively\\non different pieces of the app independently, while ensuring that the pieces come \", \"together seamlessly\\nwhen integrated into the app.\\n\\n\\nThe traditional approach to designing and buildi\", \"ng an app results in what is referred to as a\\n_monolithic_ app, where components are tightly coupled\", \" with no clear separation between them.\\nTypically, this monolithic approach leads to apps that are d\", \"ifficult and inefficient to maintain, because\\nit can be difficult to resolve bugs without breaking o\", \"ther components in the app, and it can be\\ndifficult to add new features or to replace existing featu\", \"res.\\n\\n\\nAn effective remedy for these challenges is to partition an app into discrete, loosely couple\", \"d\\ncomponents that can be easily integrated together into an app. Such an approach offers several\\nben\", \"efits:\\n\\n\\n  - It allows individual functionality to be developed, tested, extended, and maintained by\", \"\\ndifferent individuals or teams.\\n\\n  - It promotes reuse and a clean separation of concerns between t\", \"he app\\u2019s horizontal\\ncapabilities, such as authentication and data access, and the vertical capabilit\", \"ies, such as app\\nspecific business functionality. This allows the dependencies and interactions betw\", \"een app\\ncomponents to be more easily managed.\\n\\n  - It helps maintain a separation of roles by allowi\", \"ng different individuals, or teams, to focus on\\na specific task or piece of functionality according \", \"to their expertise. In particular, it provides a\\ncleaner separation between the user interface and t\", \"he app\\u2019s business logic.\\n\\n\\nHowever, there are many issues that must be resolved when partitioning an\", \" app into discrete, loosely\\ncoupled components. These include:\\n\\n\\n3 CHAPTER 2 | Introduction to .NET \", \"MAUI\\n\\n\\n  - Deciding how to provide a clean separation of concerns between the user interface control\", \"s\\nand their logic. One of the most important decisions when creating a .NET MAUI enterprise\\napp is w\", \"hether to place business logic in code-behind files, or whether to create a clean\\nseparation of conc\", \"erns between the user interface controls and their logic, in order to make\\nthe app more maintainable\", \" and testable. For more information, see Model-View-ViewModel.\\n\\n  - Determining whether to use a dep\", \"endency injection container. Dependency injection\\ncontainers reduce the dependency coupling between \", \"objects by providing a facility to\\nconstruct instances of classes with their dependencies injected, \", \"and manage their lifetime\\nbased on the configuration of the container. For more information, see Dep\", \"endency injection.\\n\\n  - Choosing between platform provided eventing and loosely coupled message-base\", \"d\\ncommunication between components that are inconvenient to link by object and type\\nreferences. For \", \"more information, see Introduction to Communicating between loosely\\ncoupled components.\\n\\n  - Decidin\", \"g how to navigate between pages, including how to invoke navigation, and where\\nnavigation logic shou\", \"ld reside. For more information, see Navigation.\\n\\n  - Determining how to validate user input for cor\", \"rectness. The decision must include how to\\nvalidate user input, and how to notify the user about val\", \"idation errors. For more information,\\nsee Validation.\\n\\n  - Deciding how to perform authentication, a\", \"nd how to protect resources with authorization. For\\nmore information, see Authentication and authori\", \"zation.\\n\\n  - Determining how to access remote data from web services, including how to reliably retr\", \"ieve\\ndata, and how to cache data. For more information, see Accessing remote data.\\n\\n  - Deciding how\", \" to test the app. For more information, see Unit testing.\\n\\n\\nThis guide provides guidance on these is\", \"sues, and focuses on the core patterns and architecture for\\nbuilding a cross-platform enterprise app\", \" using .NET MAUI. The guidance aims to help to produce\\nadaptable, maintainable, and testable code, b\", \"y addressing common .NET MAUI enterprise app\\ndevelopment scenarios, and by separating the concerns o\", \"f presentation, presentation logic, and\\nentities through support for the Model-View-ViewModel (MVVM)\", \" pattern.\\n\\n### Sample application\\n\\n\\nThis guide includes a sample application, eShop, that\\u2019s an onlin\", \"e store that includes the following\\nfunctionality:\\n\\n\\n  - Authenticating and authorizing against a ba\", \"ckend service.\\n\\n  - Browsing a catalog of items.\\n\\n  - Filtering the catalog.\\n\\n  - Ordering items fro\", \"m the catalog.\\n\\n  - Viewing the user\\u2019s order history.\\n\\n  - Configuration of settings.\\n\\n\\n4 CHAPTER 2 \", \"| Introduction to .NET MAUI\\n\\n\\n### Sample application architecture\\n\\nBelow is a high-level overview of\", \" the architecture of the sample application.\\n\\n\\nThe sample application ships with:\\n\\n\\n  - .NET Aspire \", \"App Hosting & Orchestration\\n\\n  - An Blazor web application developed with ASP.NET Core.\\n\\n  - A multi\", \"-platform app developed with .NET MAUI, which supports iOS, Android, macOS via\\nMac Catalyst, and Win\", \"dows.\\n\\n\\nThe sample application includes the following backend services:\\n\\n\\n  - An identity microservi\", \"ce, which uses ASP.NET Core Identity and IdentityServer.\\n\\n  - A catalog microservice, which is a dat\", \"a-driven create, read, update, delete (CRUD) service that\\nconsumes an SQL Server database using Enti\", \"tyFramework Core.\\n\\n  - An ordering microservice, which is a domain-driven service that uses domain-d\", \"riven design\\npatterns.\\n\\n  - A basket microservice, which is a data-driven CRUD service that uses Red\", \"is Cache.\\n\\n\\nThese backend services are implemented as microservices using ASP.NET Core, and are depl\", \"oyed as\\nunique containers with .NET Aspire. Collectively, these backend services are referred to as \", \"the eShop\\nreference application. Client apps communicate with the backend services through a Represe\", \"ntational\\nState Transfer (REST) web interface. For more information about microservices and conainer\", \"s, see\\nContainerized microservices.\\n\\n\\n5 CHAPTER 2 | Introduction to .NET MAUI\\n\\n\\n### Multi-Platform a\", \"pp\\n\\nThis guide focuses on building cross-platform enterprise apps using .NET MAUI, and uses the eSho\", \"p\\nmulti-platform app as an example. The image below shows the pages from the eShop multi-platform\\nap\", \"p that provide the functionality outlined earlier.\\n\\n\\nThe multi-platform app consumes the backend ser\", \"vices provided by the eShop reference application.\\nHowever, it can be configured to consume data fro\", \"m mock services for those who wish to avoid\\ndeploying the backend services.\\n\\n\\nThe eShop multi-platfo\", \"rm app exercises the following .NET MAUI functionality:\\n\\n\\n6 CHAPTER 2 | Introduction to .NET MAUI\\n\\n\\n\", \"  - XAML\\n\\n  - Controls\\n\\n  - Bindings\\n\\n  - Converters\\n\\n  - Styles\\n\\n  - Animations\\n\\n  - Commands\\n\\n  - \", \"Behaviors\\n\\n  - Triggers\\n\\n  - Effects\\n\\n  - Custom Controls\\n\\n\\n[For more information about this functio\", \"nality, see the .NET MAUI documentation.](https://docs.microsoft.com/dotnet/maui)\\n\\n\\nIn addition, uni\", \"t tests are provided for some of the classes in the eShop multi-platform app.\\n\\n### Multi-Platform ap\", \"p solution\\n\\n\\nThe eShop multi-platform app solution organizes the source code and other resources int\", \"o a multiple\\nprojects. All of the core mobile components are contained in a singular project named\\ne\", \"ShopContainers. This is a feature introduced with .NET 6 that allows a project to target multiple\\nou\", \"tputs which helps eliminate the need for multiple platform projects that we would have used in\\nXamar\", \"in.Forms and earlier .NET versions. An additional project is included for unit testing.\\n\\n\\nWhile this\", \" project has all of its components stored in a singular project, it is worth considering\\nseparating \", \"it into multiple projects based on your needs. For example, if you have multiple\\nimplementations of \", \"service providers based off of a service with their own dependencies, it may make\\nsense to break tho\", \"se service provider implementations out into their own separate project. Good\\ncandidates for project\", \" separation include shared models, service implementations, api client\\ncomponents, database or cachi\", \"ng layers. Any place where you feel that the business could re-use a\\ncomponent in another project is\", \" a potential candidate for separation. These projects can then be\\n[packaged via NuGet](https://docs.\", \"microsoft.com/nuget/) for easy distribution and versioning.\\n\\n\\nAll of the projects use folders to org\", \"anize the source code and other resources into categories. The\\nclasses from the eShop multi-platform\", \" app can be re-used in any .NET MAUI app with little or no\\nmodification.\\n\\n### eShop project\\n\\n\\nThe eS\", \"hop project contains the following folders:\\n\\n|Folder|Description|\\n|---|---|\\n|_Animations_|Contains c\", \"lasses that enable animations to be consumed in XAML.|\\n|_Behaviors_|Contains behaviors that are expo\", \"sed to view classes.|\\n\\n\\n\\n7 CHAPTER 2 | Introduction to .NET MAUI\\n\\n\\n|Folder|Description|\\n|---|---|\\n|_\", \"Controls_|Contains custom controls used by the app.|\\n|_Converters_|Contains value converters that ap\", \"ply custom logic to a binding.|\\n|_Exceptions_|Contains the custom ServiceAuthenticationException.|\\n|\", \"_Extensions_|Contains extension methods for the VisualElement and IEnumerable<T> classes.|\\n|_Helpers\", \"_|Contains helper classes for the app.|\\n|_Models_|Contains the model classes for the app.|\\n|_Propert\", \"ies_|Contains AssemblyInfo.cs, a .NET assembly metadata file.|\\n|_Services_|Contains interfaces and c\", \"lasses that implement services that are provided to the<br>app.|\\n|_Triggers_|Contains the BeginAnima\", \"tion trigger, which is used to invoke an animation in XAML.|\\n|_Validations_|Contains classes involve\", \"d in validating data input.|\\n|_ViewModels_|Contains the application logic that\\u2019s exposed to pages.|\\n\", \"|_Views_|Contains the pages for the app.|\\n\\n### Summary\\n\\nMicrosoft\\u2019s cross-platform multi-platform ap\", \"p development tools and platforms provide a\\ncomprehensive solution for B2E, B2B, and B2C mobile clie\", \"nt apps, providing the ability to share code\\nacross all target platforms (iOS, macOS, Android, and W\", \"indows) and helping to lower the total cost of\\nownership. Apps can share their user interface and ap\", \"p logic code, while retaining the native platform\\nlook and feel.\\n\\n\\nDevelopers of enterprise apps fac\", \"e several challenges that can alter the architecture of the app during\\ndevelopment. Therefore, it\\u2019s \", \"important to build an app so that it can be modified or extended over\\ntime. Designing for such adapt\", \"ability can be difficult, but typically involves partitioning an app into\\ndiscrete, loosely coupled \", \"components that can be easily integrated together into an app.\\n\\n\\n8 CHAPTER 2 | Introduction to .NET \", \"MAUI\\n\\n\\n**CHAPTER**\\n# 3\\n\\n## Model-View-ViewModel (MVVM)\\n\\n\\nThe .NET MAUI developer experience typicall\", \"y involves creating a user interface in XAML, and then\\nadding code-behind that operates on the user \", \"interface. Complex maintenance issues can arise as\\napps are modified and grow in size and scope. The\", \"se issues include the tight coupling between the UI\\ncontrols and the business logic, which increases\", \" the cost of making UI modifications, and the difficulty\\nof unit testing such code.\\n\\n\\nThe MVVM patte\", \"rn helps cleanly separate an application\\u2019s business and presentation logic from its\\nuser interface (\", \"UI). Maintaining a clean separation between application logic and the UI helps address\\nnumerous deve\", \"lopment issues and makes an application easier to test, maintain, and evolve. It can\\nalso significan\", \"tly improve code re-use opportunities and allows developers and UI designers to\\ncollaborate more eas\", \"ily when developing their respective parts of an app.\\n\\n### The MVVM pattern\\n\\n\\nThere are three core c\", \"omponents in the MVVM pattern: the model, the view, and the view model.\\nEach serves a distinct purpo\", \"se. The diagram below shows the relationships between the three\\ncomponents.\\n\\n\\nIn addition to underst\", \"anding the responsibilities of each component, it\\u2019s also important to understand\\nhow they interact. \", \"At a high level, the view \\u201cknows about\\u201d the view model, and the view model \\u201cknows\\nabout\\u201d the model, \", \"but the model is unaware of the view model, and the view model is unaware of the\\nview. Therefore, th\", \"e view model isolates the view from the model, and allows the model to evolve\\nindependently of the v\", \"iew.\\n\\n\\nThe benefits of using the MVVM pattern are as follows:\\n\\n\\n9 CHAPTER 3 | Model-View-ViewModel (\", \"MVVM)\\n\\n\\n  - If an existing model implementation encapsulates existing business logic, it can be diff\", \"icult or\\nrisky to change it. In this scenario, the view model acts as an adapter for the model class\", \"es\\nand prevents you from making major changes to the model code.\\n\\n  - Developers can create unit tes\", \"ts for the view model and the model, without using the view.\\nThe unit tests for the view model can e\", \"xercise exactly the same functionality as used by the\\nview.\\n\\n  - The app UI can be redesigned withou\", \"t touching the view model and model code, provided\\nthat the view is implemented entirely in XAML or \", \"C#. Therefore, a new version of the view\\nshould work with the existing view model.\\n\\n  - Designers an\", \"d developers can work independently and concurrently on their components\\nduring development. Designe\", \"rs can focus on the view, while developers can work on the view\\nmodel and model components.\\n\\n\\nThe ke\", \"y to using MVVM effectively lies in understanding how to factor app code into the correct\\nclasses an\", \"d how the classes interact. The following sections discuss the responsibilities of each of the\\nclass\", \"es in the MVVM pattern.\\n\\n#### **View**\\n\\n\\nThe view is responsible for defining the structure, layout,\", \" and appearance of what the user sees on\\nscreen. Ideally, each view is defined in XAML, with a limit\", \"ed code-behind that does not contain\\nbusiness logic. However, in some cases, the code-behind might c\", \"ontain UI logic that implements\\nvisual behavior that is difficult to express in XAML, such as animat\", \"ions.\\n\\n\\nIn a .NET MAUI application, a view is typically a ContentPage-derived or ContentView-derived\", \" class.\\nHowever, views can also be represented by a data template, which specifies the UI elements t\", \"o be\\nused to visually represent an object when it\\u2019s displayed. A data template as a view does not ha\", \"ve any\\ncode-behind, and is designed to bind to a specific view model type.\\n\\n\\n\\n\\n\\n\\n\\nEnsure that the vi\", \"ew models are responsible for defining logical state changes that affect some\\naspects of the view\\u2019s \", \"display, such as whether a command is available, or an indication that an\\noperation is pending. Ther\", \"efore, enable and disable UI elements by binding to view model properties,\\nrather than enabling and \", \"disabling them in code-behind.\\n\\n\\nThere are several options for executing code on the view model in r\", \"esponse to interactions on the\\nview, such as a button click or item selection. If a control supports\", \" commands, the control\\u2019s Command\\nproperty can be data-bound to an ICommand property on the view mode\", \"l. When the control\\u2019s\\ncommand is invoked, the code in the view model will be executed. In addition t\", \"o commands,\\nbehaviors can be attached to an object in the view and can listen for either a command t\", \"o be invoked\\nor the event to be raised. In response, the behavior can then invoke an ICommand on the\", \" view model\\nor a method on the view model.\\n\\n\\n10 CHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\n\\n#### **Vie\", \"wModel**\\n\\nThe view model implements properties and commands to which the view can data bind to, and\\n\", \"notifies the view of any state changes through change notification events. The properties and\\ncomman\", \"ds that the view model provides define the functionality to be offered by the UI, but the view\\ndeter\", \"mines how that functionality is to be displayed.\\n\\n\\n\\n\\n\\n\\n\\nMulti-platform apps should keep the UI threa\", \"d unblocked to improve the user\\u2019s perception of\\nperformance. Therefore, in the view model, use async\", \"hronous methods for I/O operations and raise\\nevents to asynchronously notify views of property chang\", \"es.\\n\\n\\nThe view model is also responsible for coordinating the view\\u2019s interactions with any model cla\", \"sses that\\nare required. There\\u2019s typically a one-to-many relationship between the view model and the \", \"model\\nclasses. The view model might choose to expose model classes directly to the view so that cont\", \"rols in\\nthe view can data bind directly to them. In this case, the model classes will need to be des\", \"igned to\\nsupport data binding and change notification events.\\n\\n\\nEach view model provides data from a\", \" model in a form that the view can easily consume. To\\naccomplish this, the view model sometimes perf\", \"orms data conversion. Placing this data conversion in\\nthe view model is a good idea because it provi\", \"des properties that the view can bind to. For example,\\nthe view model might combine the values of tw\", \"o properties to make it easier to display by the view.\\n\\n\\n\\n\\n\\n\\n\\nIt\\u2019s also possible to use converters a\", \"s a separate data conversion layer that sits between the view\\nmodel and the view. This can be necess\", \"ary, for example, when data requires special formatting that\\nthe view model doesn\\u2019t provide.\\n\\n\\nIn or\", \"der for the view model to participate in two-way data binding with the view, its properties must\\nrai\", \"se the PropertyChanged event. View models satisfy this requirement by implementing the\\nINotifyProper\", \"tyChanged interface, and raising the PropertyChanged event when a property is\\nchanged.\\n\\n\\nFor collect\", \"ions, the view-friendly ObservableCollection<T> is provided. This collection implements\\ncollection c\", \"hanged notification, relieving the developer from having to implement the\\nINotifyCollectionChanged i\", \"nterface on collections.\\n\\n#### **Model**\\n\\n\\nModel classes are non-visual classes that encapsulate the\", \" app\\u2019s data. Therefore, the model can be\\nthought of as representing the app\\u2019s domain model, which us\", \"ually includes a data model along with\\nbusiness and validation logic. Examples of model objects incl\", \"ude data transfer objects (DTOs), Plain\\nOld CLR Objects (POCOs), and generated entity and proxy obje\", \"cts.\\n\\n\\n11 CHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\n\\nModel classes are typically used in conjunction \", \"with services or repositories that encapsulate data\\naccess and caching.\\n\\n### Connecting view models \", \"to views\\n\\n\\nView models can be connected to views by using the data-binding capabilities of .NET MAUI\", \". There\\nare many approaches that can be used to construct views and view models and associate them a\", \"t\\nruntime. These approaches fall into two categories, known as view first composition, and view mode\", \"l\\nfirst composition. Choosing between view first composition and view model first composition is an\\n\", \"issue of preference and complexity. However, all approaches share the same aim, which is for the vie\", \"w\\nto have a view model assigned to its BindingContext property.\\n\\n\\nWith view first composition the ap\", \"p is conceptually composed of views that connect to the view\\nmodels they depend on. The primary bene\", \"fit of this approach is that it makes it easy to construct\\nloosely coupled, unit testable apps becau\", \"se the view models have no dependence on the views\\nthemselves. It\\u2019s also easy to understand the stru\", \"cture of the app by following its visual structure,\\nrather than having to track code execution to un\", \"derstand how classes are created and associated. In\\naddition, view first construction aligns with th\", \"e Microsoft Maui\\u2019s navigation system that\\u2019s responsible\\nfor constructing pages when navigation occur\", \"s, which makes a view model first composition complex\\nand misaligned with the platform.\\n\\n\\nWith view \", \"model first composition, the app is conceptually composed of view models, with a service\\nresponsible\", \" for locating the view for a view model. View model first composition feels more natural to\\nsome dev\", \"elopers, since the view creation can be abstracted away, allowing them to focus on the\\nlogical non-U\", \"I structure of the app. In addition, it allows view models to be created by other view\\nmodels. Howev\", \"er, this approach is often complex, and it can become difficult to understand how the\\nvarious parts \", \"of the app are created and associated.\\n\\n\\n\\n\\n\\n\\n\\nThe binding of views to a property in a data source sh\", \"ould be the view\\u2019s principal dependency on its\\ncorresponding view model. Specifically, don\\u2019t referen\", \"ce view types, such as Button and ListView, from\\nview models. By following the principles outlined h\", \"ere, view models can be tested in isolation,\\ntherefore reducing the likelihood of software defects b\", \"y limiting scope.\\n\\n\\nThe following sections discuss the main approaches to connecting view models to \", \"views.\\n\\n### Creating a view model declaratively\\n\\n\\nThe simplest approach is for the view to declarati\", \"vely instantiate its corresponding view model in\\nXAML. When the view is constructed, the correspondi\", \"ng view model object will also be constructed.\\nThis approach is demonstrated in the following code e\", \"xample:\\n\\n\\n12 CHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\n\\nWhen the ContentPage is created, an instance \", \"of the LoginViewModel is automatically constructed\\nand set as the view\\u2019s BindingContext.\\n\\n\\nThis decl\", \"arative construction and assignment of the view model by the view has the advantage that\\nit\\u2019s simple\", \", but has the disadvantage that it requires a default (parameter-less) constructor in the view\\nmodel\", \".\\n\\n### Creating a view model programmatically\\n\\n\\nA view can have code in the code-behind file, result\", \"ing in the view-model being assigned to its\\nBindingContext property. This is often accomplished in t\", \"he view\\u2019s constructor, as shown in the\\nfollowing code example:\\n\\n\\nThe programmatic construction and a\", \"ssignment of the view model within the view\\u2019s code-behind has\\nthe advantage that it\\u2019s simple. Howeve\", \"r, the main disadvantage of this approach is that the view\\nneeds to provide the view model with any \", \"required dependencies. Using a dependency injection\\ncontainer can help to maintain loose coupling be\", \"tween the view and view model. For more\\ninformation, see Dependency injection.\\n\\n### Updating views i\", \"n response to changes in the underlying view model or model\\n\\n\\nAll view model and model classes that \", \"are accessible to a view should implement the\\n\\n[[INotifyPropertyChanged interface. Implementing this\", \" interface in a view model or model class allows](https://docs.microsoft.com/dotnet/api/system.compo\", \"nentmodel.inotifypropertychanged)\\nthe class to provide change notifications to any data-bound contro\", \"ls in the view when the underlying\\nproperty value changes.\\n\\n\\nApp\\u2019s should be architected for the cor\", \"rect use of property change notification, by meeting the\\nfollowing requirements:\\n\\n\\n  - Always raisin\", \"g a PropertyChanged event if a public property\\u2019s value changes. Do not assume\\nthat raising the Prope\", \"rtyChanged event can be ignored because of knowledge of how XAML\\nbinding occurs.\\n\\n  - Always raising\", \" a PropertyChanged event for any calculated properties whose values are used\\nby other properties in \", \"the view model or model.\\n\\n  - Always raising the PropertyChanged event at the end of the method that\", \" makes a property\\nchange, or when the object is known to be in a safe state. Raising the event inter\", \"rupts the\\n\\n\\n13 CHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\n\\noperation by invoking the event\\u2019s handlers \", \"synchronously. If this happens in the middle of an\\noperation, it might expose the object to callback\", \" functions when it is in an unsafe, partially\\nupdated state. In addition, it\\u2019s possible for cascadin\", \"g changes to be triggered by\\nPropertyChanged events. Cascading changes generally require updates to \", \"be complete before\\nthe cascading change is safe to execute.\\n\\n  - Never raising a PropertyChanged eve\", \"nt if the property does not change. This means that you\\nmust compare the old and new values before r\", \"aising the PropertyChanged event.\\n\\n  - Never raising the PropertyChanged event during a view model\\u2019s\", \" constructor if you are\\ninitializing a property. Data-bound controls in the view will not have subsc\", \"ribed to receive\\nchange notifications at this point.\\n\\n  - Never raising more than one PropertyChange\", \"d event with the same property name argument\\nwithin a single synchronous invocation of a public meth\", \"od of a class. For example, given a\\nNumberOfItems property whose backing store is the _numberOfItems\", \" field, if a method\\nincrements _numberOfItems fifty times during the execution of a loop, it should \", \"only raise\\nproperty change notification on the NumberOfItems property once, after all the work is\\nco\", \"mplete. For asynchronous methods, raise the PropertyChanged event for a given property\\nname in each \", \"synchronous segment of an asynchronous continuation chain.\\n\\n\\nA simple way to provide this functional\", \"ity would be to create an extension of the BindableObject class.\\nIn this example, the ExtendedBindab\", \"leObject class provides change notifications, which is shown in\\nthe following code example:\\n\\n\\n.NET M\", \"AUI\\u2019s BindableObject class implements the INotifyPropertyChanged interface, and provides an\\nOnProper\", \"tyChanged method. The ExtendedBindableObject class provides the RaisePropertyChanged\\nmethod to invok\", \"e property change notification, and in doing so uses the functionality provided by the\\nBindableObjec\", \"t class.\\n\\n\\nView model classes can then derive from the ExtendedBindableObject class. Therefore, each\", \" view\\nmodel class uses the RaisePropertyChanged method in the ExtendedBindableObject class to provid\", \"e\\nproperty change notification. The following code example shows how the eShop multi-platform app\\nin\", \"vokes property change notification by using a lambda expression:\\n\\n\\n14 CHAPTER 3 | Model-View-ViewMod\", \"el (MVVM)\\n\\n\\nUsing a lambda expression in this way involves a small performance cost because the lamb\", \"da\\nexpression has to be evaluated for each call. Although the performance cost is small and would no\", \"t\\ntypically impact an app, the costs can accrue when there are many change notifications. However, t\", \"he\\nbenefit of this approach is that it provides compile-time type safety and refactoring support whe\", \"n\\nrenaming properties.\\n\\n### MVVM Frameworks\\n\\n\\nThe MVVM pattern is well established in .NET, and the \", \"community has created many frameworks\\nwhich help ease this development. Each framework provides a di\", \"fferent set of features, but it is\\nstandard for them to provide a common view model with an implemen\", \"tation of the\\nINotifyPropertyChanged interface. Additional features of MVVM frameworks include custo\", \"m\\ncommands, navigation helpers, dependency injection/service locator components, and UI platform\\nint\", \"egration. While it is not necessary to use these frameworks, they can speed up and standardize\\n[your\", \" development. The eShop multi-platform app uses the .NET Community MVVM Toolkit. When](https://docs.\", \"microsoft.com/dotnet/communitytoolkit/mvvm/introduction)\\nchoosing a framework, you should consider y\", \"our application\\u2019s needs and your team\\u2019s strengths. The\\nlist below includes some of the more common M\", \"VVM frameworks for .NET MAUI.\\n\\n\\n  - [.NET Community MVVM Toolkit](https://docs.microsoft.com/dotnet/\", \"communitytoolkit/mvvm/introduction/)\\n\\n  - [ReactiveUI](https://www.reactiveui.net/)\\n\\n  - [Prism Libr\", \"ary](https://prismlibrary.com/)\\n\\n### UI interaction using commands and behaviors\\n\\n\\nIn multi-platform\", \" apps, actions are typically invoked in response to a user action, such as a button\\nclick, that can \", \"be implemented by creating an event handler in the code-behind file. However, in the\\nMVVM pattern, t\", \"he responsibility for implementing the action lies with the view model, and placing\\ncode in the code\", \"-behind should be avoided.\\n\\n\\nCommands provide a convenient way to represent actions that can be boun\", \"d to controls in the UI.\\nThey encapsulate the code that implements the action and help to keep it de\", \"coupled from its visual\\nrepresentation in the view. This way, your view models become more portable \", \"to new platforms, as\\nthey do not have a direct dependency on events provided by the platform\\u2019s UI fr\", \"amework. .NET MAUI\\nincludes controls that can be declaratively connected to a command, and these con\", \"trols will invoke\\nthe command when the user interacts with the control.\\n\\n\\nBehaviors also allow contr\", \"ols to be declaratively connected to a command. However, behaviors can be\\nused to invoke an action t\", \"hat\\u2019s associated with a range of events raised by a control. Therefore,\\nbehaviors address many of th\", \"e same scenarios as command-enabled controls, while providing a\\ngreater degree of flexibility and co\", \"ntrol. In addition, behaviors can also be used to associate command\\nobjects or methods with controls\", \" that were not specifically designed to interact with commands.\\n\\n\\n15 CHAPTER 3 | Model-View-ViewMode\", \"l (MVVM)\\n\\n\\n### Implementing commands\\n\\nView models typically expose public properties, for binding fr\", \"om the view, which implement the\\nICommand interface. Many .NET MAUI controls and gestures provide a \", \"Command property, which can\\nbe data bound to an ICommand object provided by the view model. The butt\", \"on control is one of the\\nmost commonly used controls, providing a command property that executes whe\", \"n the button is\\nclicked.\\n\\n\\n\\n\\n\\nThe ICommand interface defines an Execute method, which encapsulates t\", \"he operation itself, a\\nCanExecute method, which indicates whether the command can be invoked, and a\\n\", \"CanExecuteChanged event that occurs when changes occur that affect whether the command should\\nexecut\", \"e. In most cases, we will only supply the Execute method for our commands. For a more\\n[detailed over\", \"view of ICommand, refer to the Commanding](https://docs.microsoft.com/dotnet/maui/fundamentals/data-\", \"binding/commanding) documentation for .NET MAUI.\\n\\n\\nProvided with .NET MAUI are the Command and Comma\", \"nd<T> classes that implement the\\nICommand interface, where T is the type of the arguments to Execute\", \" and CanExecute. Command and\\nCommand<T> are basic implementations that provide the minimal set of fu\", \"nctionality needed for the\\nICommand interface.\\n\\n\\n\\n\\n\\n\\n\\nThe Command or Command<T> constructor requires\", \" an Action callback object that\\u2019s called when the\\nICommand.Execute method is invoked. The CanExecute\", \" method is an optional constructor parameter,\\nand is a Func that returns a bool.\\n\\n\\n[The eShop multi-\", \"platform app uses the RelayCommand](https://docs.microsoft.com/dotnet/communitytoolkit/mvvm/relaycom\", \"mand) [and AsyncRelayCommand. The primary](https://docs.microsoft.com/dotnet/communitytoolkit/mvvm/a\", \"syncrelaycommand)\\nbenefit for modern applications is that the AsyncRelayCommand provides better func\", \"tionality for\\nasynchronous operations.\\n\\n\\nThe following code shows how a Command instance, which repr\", \"esents a register command, is\\nconstructed by specifying a delegate to the Register view model method\", \":\\n\\n```\\npublic ICommand RegisterCommand { get ; }\\n\\n```\\n\\nThe command is exposed to the view through a \", \"property that returns a reference to an ICommand.\\nWhen the Execute method is called on the Command o\", \"bject, it simply forwards the call to the method\\nin the view model via the delegate that was specifi\", \"ed in the Command constructor. An asynchronous\\nmethod can be invoked by a command by using the async\", \" and await keywords when specifying the\\ncommand\\u2019s Execute delegate. This indicates that the callback\", \" is a Task and should be awaited. For\\n\\n\\n16 CHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\n\\nexample, the fo\", \"llowing code shows how an ICommand instance, which represents a sign-in command,\\nis constructed by s\", \"pecifying a delegate to the SignInAsync view model method:\\n\\n\\nParameters can be passed to the Execute\", \" and CanExecute actions by using the\\nAsyncRelayCommand<T> class to instantiate the command. For exam\", \"ple, the following code shows\\nhow an AsyncRelayCommand<T> instance is used to indicate that the Navi\", \"gateAsync method will\\nrequire an argument of type string:\\n\\n\\nIn both the RelayCommand and RelayComman\", \"d<T> classes, the delegate to the CanExecute method\\nin each constructor is optional. If a delegate i\", \"sn\\u2019t specified, the Command will return true for\\nCanExecute. However, the view model can indicate a \", \"change in the command\\u2019s CanExecute status by\\ncalling the ChangeCanExecute method on the Command obje\", \"ct. This causes the CanExecuteChanged\\nevent to be raised. Any UI controls bound to the command will \", \"then update their enabled status to\\nreflect the availability of the data-bound command.\\n\\n### Invokin\", \"g commands from a view\\n\\n\\nThe following code example shows how a Grid in the LoginView binds to the R\", \"egisterCommand in the\\nLoginViewModel class by using a TapGestureRecognizer instance:\\n\\n\\nA command par\", \"ameter can also be optionally defined using the CommandParameter property. The\\ntype of the expected \", \"argument is specified in the Execute and CanExecute target methods. The\\nTapGestureRecognizer will au\", \"tomatically invoke the target command when the user interacts with the\\nattached control. The Command\", \"Parameter, if provided, will be passed as the argument to the\\ncommand\\u2019s Execute delegate.\\n\\n### Imple\", \"menting behaviors\\n\\n\\nBehaviors allow functionality to be added to UI controls without having to subcl\", \"ass them. Instead, the\\nfunctionality is implemented in a behavior class and attached to the control \", \"as if it was part of the\\ncontrol itself. Behaviors enable you to implement code that you would typic\", \"ally have to write as codebehind, because it directly interacts with the API of the control, in such\", \" a way that it can be concisely\\n\\n\\n17 CHAPTER 3 | Model-View-ViewModel (MVVM)\\n\\n\\nattached to the contr\", \"ol, and packaged for reuse across more than one view or app. In the context of\\nMVVM, behaviors are a\", \" useful approach for connecting controls to commands.\\n\\n\\nA behavior that\\u2019s attached to a control thro\", \"ugh attached properties is known as an _attached behavior_ .\\nThe behavior can then use the exposed A\", \"PI of the element to which it is attached to add functionality\\nto that control, or other controls, i\", \"n the visual tree of the view.\\n\\n\\nA .NET MAUI behavior is a class that derives from the Behavior or B\", \"ehavior<T> class, where T is the\\ntype of the control to which the behavior should apply. These class\", \"es provide OnAttachedTo and\\nOnDetachingFrom methods, which should be overridden to provide logic tha\", \"t will be executed when\\nthe behavior is attached to and detached from controls.\\n\\n\\nIn the eShop multi\", \"-platform app, the BindableBehavior<T> class derives from the Behavior<T> class.\\nThe purpose of the \", \"BindableBehavior<T> class is to provide a base class for .NET MAUI behaviors that\\nrequire the Bindin\", \"gContext of the behavior to be set to the attached control.\\n\\n\\nThe BindableBehavior<T> class provides\", \" an overridable OnAttachedTo method that sets the\\nBindingContext of the behavior, and an overridable\", \" OnDetachingFrom method that cleans up the\\nBindingContext.\\n\\n\\n[The eShop multi-platform app includes \", \"an EventToCommandBehavior](https://docs.microsoft.com/dotnet/communitytoolkit/maui/behaviors/event-t\", \"o-command-behavior) class which is provided by the\\nMAUI Community toolkit. EventToCommandBehavior ex\", \"ecutes a command in response to an event\\noccurring. This class derives from the BaseBehavior<View> c\", \"lass so that the behavior can bind to and\\nexecute an ICommand specified by a Command property when t\", \"he behavior is consumed. The\\nfollowing code example shows the EventToCommandBehavior class:\\n\\n\\n18 CHA\", \"PTER 3 | Model-View-ViewModel (MVVM)\\n\\n\\nThe OnAttachedTo and OnDetachingFrom methods are used to regi\", \"ster and deregister an event\\nhandler for the event defined in the EventName property. Then, when the\", \" event fires, the\\nOnTriggerHandled method is invoked, which executes the command.\\n\\n\\n19 CHAPTER 3 | M\", \"odel-View-ViewModel (MVVM)\\n\\n\\nThe advantage of using the EventToCommandBehavior to execute a command \", \"when an event fires, is\\nthat commands can be associated with controls that weren\\u2019t designed to inter\", \"act with commands. In\\naddition, this moves event-handling code to view models, where it can be unit \", \"tested.\\n\\n### Invoking behaviors from a view\\n\\n\\nThe EventToCommandBehavior is particularly useful for \", \"attaching a command to a control that\\ndoesn\\u2019t support commands. For example, the LoginView uses the \", \"EventToCommandBehavior to\\nexecute the ValidateCommand when the user changes the value of their passw\", \"ord, as shown in the\\nfollowing code:\\n\\n\\nAt runtime, the EventToCommandBehavior will respond to intera\", \"ction with the Entry. When a user\\ntypes into the Entry field, the TextChanged event will fire, which\", \" will execute the ValidateCommand in\\nthe LoginViewModel. By default, the event arguments for the eve\", \"nt are passed to the command. If\\nneeded, the EventArgsConverter property can be used to convert the \", \"EventArgs provided by the event\\ninto a value that the command expects as input.\\n\\n\\n[For more informat\", \"ion about behaviors, see Behaviors](https://docs.microsoft.com/dotnet/maui/fundamentals/behaviors) o\", \"n the .NET MAUI Developer Center.\\n\\n### Summary\\n\\n\\nThe Model-View-ViewModel (MVVM) pattern helps clean\", \"ly separate an application\\u2019s business and\\npresentation logic from its user interface (UI). Maintaini\", \"ng a clean separation between application\\nlogic and the UI helps address numerous development issues\", \" and makes an application easier to test,\\nmaintain, and evolve. It can also significantly improve co\", \"de re-use opportunities and allows\\ndevelopers and UI designers to collaborate more easily when devel\", \"oping their respective parts of an\\napp.\\n\\n\\nUsing the MVVM pattern, the UI of the app and the underlyi\", \"ng presentation and business logic are\\nseparated into three separate classes: the view, which encaps\", \"ulates the UI and UI logic; the view\\nmodel, which encapsulates presentation logic and state; and the\", \" model, which encapsulates the app\\u2019s\\nbusiness logic and data.\\n\\n\\n20 CHAPTER 3 | Model-View-ViewModel \", \"(MVVM)\\n\\n\\n**CHAPTER**\\n# 4\\n\\n## Dependency injection\\n\\n\\nTypically, a class constructor is invoked when i\", \"nstantiating an object, and any values that the object\\nneeds are passed as arguments to the construc\", \"tor. This is an example of dependency injection known\\nas _constructor injection_ . The dependencies \", \"the object needs are injected into the constructor.\\n\\n\\nBy specifying dependencies as interface types,\", \" dependency injection enables decoupling the concrete\\ntypes from the code that depends on these type\", \"s. It generally uses a container that holds a list of\\nregistrations and mappings between interfaces \", \"and abstract types, and the concrete types that\\nimplement or extend these types.\\n\\n\\nThere are also ot\", \"her types of dependency injection, such as _property setter injection_ and _method call_\\n_injection_\", \", but they are less commonly seen. Therefore, this chapter will focus solely on performing\\nconstruct\", \"or injection with a dependency injection container.\\n\\n### Introduction to dependency injection\\n\\n\\nDepe\", \"ndency injection is a specialized version of the Inversion of Control (IoC) pattern, where the\\nconce\", \"rn being inverted is the process of obtaining the required dependency. With dependency\\ninjection, an\", \"other class is responsible for injecting dependencies into an object at runtime. The\\nfollowing code \", \"example shows how the ProfileViewModel class is structured when using dependency\\ninjection:\\n\\n\\nThe Pr\", \"ofileViewModel constructor receives multiple interface object instances as arguments injected\\nby ano\", \"ther class. The only dependency in the ProfileViewModel class is on the interface types.\\nTherefore, \", \"the ProfileViewModel class doesn\\u2019t have any knowledge of the class that\\u2019s responsible for\\ninstantiat\", \"ing the interface objects. The class that\\u2019s responsible for instantiating the interface objects,\\nand\", \" inserting it into the ProfileViewModel class, is known as the _dependency injection container_ .\\n\\n\\n\", \"21 CHAPTER 4 | Dependency injection\\n\\n\\nDependency injection containers reduce the coupling between ob\", \"jects by providing a facility to\\ninstantiate class instances and manage their lifetime based on the \", \"configuration of the container.\\nDuring object creation, the container injects any dependencies that \", \"the object requires into it. If those\\ndependencies have not yet been created, the container creates \", \"and resolves their dependencies first.\\n\\n\\nThere are several advantages to using a dependency injectio\", \"n container:\\n\\n\\n  - A container removes the need for a class to locate its dependencies and manage it\", \"s lifetimes.\\n\\n  - A container allows the mapping of implemented dependencies without affecting the c\", \"lass.\\n\\n  - A container facilitates testability by allowing dependencies to be mocked.\\n\\n  - A contain\", \"er increases maintainability by allowing new classes to be easily added to the app.\\n\\nIn the context \", \"of a .NET MAUI app that uses MVVM, a dependency injection container will typically be\\nused for regis\", \"tering and resolving views, registering and resolving view models, and for registering\\nservices and \", \"injecting them into view models.\\n\\n\\nThere are many dependency injection containers available in .NET;\", \" the eShop multi-platform app uses\\nMicrosoft.Extensions.DependencyInjection to manage the instantiat\", \"ion of views, view models, and\\nservice classes in the app. Microsoft.Extensions.DependencyInjection \", \"facilitates building loosely\\ncoupled apps, and provides all of the features commonly found in depend\", \"ency injection containers,\\nincluding methods to register type mappings and object instances, resolve\", \" objects, manage object\\nlifetimes, and inject dependent objects into constructors of objects that it\", \" resolves. For more\\n[information about Microsoft.Extensions.DependencyInjection, see Dependency inje\", \"ction in .NET.](https://docs.microsoft.com/dotnet/core/extensions/dependency-injection)\\n\\n\\nIn .NET MA\", \"UI, the MauiProgram class will call into the CreateMauiApp method to create a\\nMauiAppBuilder object.\", \" The MauiAppBuilder object has a Services property of type IServiceCollection,\\nwhich provides a plac\", \"e to register our components, such as views, view models, and services for\\ndependency injection. Any\", \" components registered with the Services property will be provided to the\\ndependency injection conta\", \"iner when the MauiAppBuilder.Build method is called.\\n\\n\\nAt runtime, the container must know which imp\", \"lementation of the services are being requested in\\norder to instantiate them for the requested objec\", \"ts. In the eShop multi-platform app, the\\nIAppEnvironmentService, IDialogService, INavigationService,\", \" and ISettingsService interfaces need to\\nbe resolved before it can instantiate a ProfileViewModel ob\", \"ject. This involves the container performing\\nthe following actions:\\n\\n\\n  - Deciding how to instantiat\", \"e an object that implements the interface. This is known as\\n_registration_ .\\n\\n  - Instantiating the \", \"object that implements the required interface and the ProfileViewModel\\nobject. This is known as _res\", \"olution_ .\\n\\n\\nEventually, the app will finish using the ProfileViewModel object, and it will become a\", \"vailable for\\ngarbage collection. At this point, the garbage collector should dispose of any short-li\", \"ved interface\\nimplementations if other classes do not share the same instance.\\n\\n\\n22 CHAPTER 4 | Depe\", \"ndency injection\\n\\n\\n### Registration\\n\\nBefore dependencies can be injected into an object, the types o\", \"f the dependencies must first be\\nregistered with the container. Registering a type involves passing \", \"the container an interface and a\\nconcrete type that implements the interface.\\n\\n\\nThere are two ways o\", \"f registering types and objects in the container through code:\\n\\n\\n  - Register a type or mapping with\", \" the container. This is known as transient registration. When\\nrequired, the container will build an \", \"instance of the specified type.\\n\\n  - Register an existing object in the container as a singleton. Wh\", \"en required, the container will\\nreturn a reference to the existing object.\\n\\n\\n\\n\\n\\nThe registration of \", \"types requiring dependency injection should be performed in a single method in\\nan app. This method s\", \"hould be invoked early in the app\\u2019s lifecycle to ensure it is aware of the\\ndependencies between its \", \"classes. The eShop multi-platform app performs this the\\nMauiProgram.CreateMauiApp method. The follow\", \"ing code example shows how the eShop multiplatform app declares the CreateMauiApp in the MauiProgram\", \" class:\\n\\n\\nThe MauiApp.CreateBuilder method creates a MauiAppBuilder object that we can use to regist\", \"er our\\ndependencies. Many dependencies in the eShop multi-platform app need to be registered, so the\", \"\\nextension methods RegisterAppServices, RegisterViewModels, and RegisterViews were created to help\\np\", \"rovide an organized and maintainable registration workflow. The following code shows the\\nRegisterVie\", \"wModels method:\\n\\n\\n23 CHAPTER 4 | Dependency injection\\n\\n\\nThis method receives an instance of MauiAppB\", \"uilder, and we can use the Services property to register\\nour view models. Depending on the needs of \", \"your application, you may need to add services with\\ndifferent lifetimes. The following table provide\", \"s information on when you may want to choose these\\ndifferent registration lifetimes:\\n\\n\\n|Method|Descr\", \"iption|\\n|---|---|\\n|AddSingleton<T>|Will create a single instance of the object which<br>will be rema\", \"in for the lifetime of the application.|\\n|AddTransient<T>|Will create a new instance of the object w\", \"hen<br>requested during resolution. Transient objects<br>do not have a pre-defined lifetime, but wil\", \"l<br>typically follow the lifetime of their host.|\\n\\n\\n\\n\\n\\nThe CatalogViewModel is used near the applic\", \"ation\\u2019s root and should always be available, so\\nregistering it with AddSingleton<T> is beneficial. O\", \"ther view models, such as CheckoutViewModel\\nand OrderDetailViewModel are situationally navigated to \", \"or are used later in the application. Suppose\\nyou know that you have a component that may not always\", \" be used. In that case, if it is memory or\\ncomputationally intensive or requires just-in-time data, \", \"it may be a better candidate for\\nAddTransient<T> registration.\\n\\n\\nAnother common way to add services \", \"is using the AddSingleton<TService, TImplementation> and\\nAddTransient<TService, TImplementation> met\", \"hods. These methods take two input types: the\\ninterface definition and the concrete implementation. \", \"This type of registration is best for cases where\\nyou are implementing services based on interfaces.\", \" In the code example below, we register our\\nISettingsService interface using the SettingsService imp\", \"lementation:\\n\\n\\nOnce all services have been registered, the MauiAppBuilder.Build method should be cal\", \"led to create\\nour MauiApp and populate our dependency injection container with all the registered se\", \"rvices.\\n\\n\\n24 CHAPTER 4 | Dependency injection\\n\\n\\n### Resolution\\n\\nAfter a type is registered, it can b\", \"e resolved or injected as a dependency. When a type is being\\nresolved, and the container needs to cr\", \"eate a new instance, it injects any dependencies into the\\ninstance.\\n\\n\\nGenerally, when a type is reso\", \"lved, one of three things happens:\\n\\n\\n1. If the type hasn\\u2019t been registered, the container throws an \", \"exception.\\n\\n2. If the type has been registered as a singleton, the container returns the singleton i\", \"nstance. If\\nthis is the first time the type is called for, the container creates it if required and \", \"maintains a\\nreference to it.\\n\\n3. If the type has been registered as transient, the container returns\", \" a new instance and doesn\\u2019t\\nmaintain a reference to it.\\n\\n\\n.NET MAUI offers a number of ways to resol\", \"ve registered components based on your needs. The most\\ndirect way to gain access to the dependency i\", \"njection container is from an Element using the\\nHandler.MauiContext.Services. An example of this is \", \"shown below:\\n\\n```\\nvar settingsService = this .Handler.MauiContext.Services.GetServices<ISettingsServ\", \"ice>();\\n\\n```\\n\\nThis can be helpful if you need to resolve a service from within an Element or from ou\", \"tside of the\\nconstructor of your Element.\\n\\n\\n\\n\\n\\nIf using the Shell control for .NET MAUI, it will imp\", \"licitly call into the dependency injection container\\nto create our objects during navigation. When s\", \"etting up our Shell control, the Routing.RegisterRoute\\nmethod will tie a route path to a View as sho\", \"wn in the example below:\\n\\n```\\nRouting.RegisterRoute(\\\"Filter\\\", typeof (FiltersView));\\n\\n```\\n\\nDuring Sh\", \"ell navigation, it will look for registrations of the FiltersView, and if any are found, it will\\ncre\", \"ate that view and inject any dependencies into the constructor. As shown in the code example\\nbelow, \", \"the CatalogViewModel will be injected into the FiltersView:\\n\\n\\n25 CHAPTER 4 | Dependency injection\\n\\n\\n\", \"### Summary\\n\\nDependency injection enables the decoupling of concrete types from the code that depend\", \"s on these\\ntypes. It typically uses a container that holds a list of registrations and mappings betw\", \"een interfaces\\nand abstract types, and the concrete types that implement or extend these types.\\n\\n\\nMi\", \"crosoft.Extensions.DependencyInjection facilitates building loosely coupled apps and provides all of\", \"\\nthe features commonly found in dependency injection containers, including methods to register type\\n\", \"mappings and object instances, resolve objects, manage object lifetimes, and inject dependent object\", \"s\\ninto constructors of objects it resolves.\\n\\n\\n26 CHAPTER 4 | Dependency injection\\n\\n\\n**CHAPTER**\\n# 5\\n\", \"\\n## Communicating between loosely coupled components\\n\\n\\nThe publish-subscribe pattern is a messaging \", \"pattern in which publishers send messages without\\nknowing any receivers, known as subscribers. Simil\", \"arly, subscribers listen for specific messages,\\nwithout knowing any publishers.\\n\\n\\nEvents in .NET imp\", \"lement the publish-subscribe pattern and are the most simple approach for a\\ncommunication layer betw\", \"een components if loose coupling is not required, such as a control and the\\npage that contains it. H\", \"owever, the publisher and subscriber lifetimes are coupled by object\\nreferences to each other, and t\", \"he subscriber type must have a reference to the publisher type. This\\ncan create memory management is\", \"sues, especially when there are short-lived objects that subscribe\\nto an event of a static or long-l\", \"ived object. If the event handler isn\\u2019t removed, the subscriber will be\\nkept alive by the reference \", \"to it in the publisher, and this will prevent or delay the garbage collection\\nof the subscriber.\\n\\n##\", \"# Introduction to MVVM Toolkit Messenger\\n\\n\\nThe MVVM Toolkit IMessenger interface describes the publi\", \"sh-subscribe pattern, allowing messagebased communication between components that are inconvenient t\", \"o link by object and type\\nreferences. This mechanism allows publishers and subscribers to communicat\", \"e without having a direct\\nreference to each other, helping to reduce dependencies between components\", \", while also allowing\\ncomponents to be independently developed and tested.\\n\\n\\n\\n\\n\\n27 CHAPTER 5 | Commu\", \"nicating between loosely coupled components\\n\\n\\nThe IMessenger interface allows for multicast publish-\", \"subscribe functionality. This means that there\\ncan be multiple publishers that publish a single mess\", \"age, and there can be multiple subscribers\\nlistening to the same message. The image below illustrate\", \"s this relationship:\\n\\n\\nThere are two implementations of the IMessenger interface that come with the\\n\", \"CommunityToolkit.Mvvm package. The WeakReferenceMessenger uses weak references which can\\nresult in e\", \"asier cleanup for message subscribers. This is a good option if your subscribers do not have\\na clear\", \"ly defined lifecycle. The StrongReferenceMessenger uses strong references which can result in\\nbetter\", \" performance and a more clearly controlled lifetime of the subscription. If you have a workflow\\nwith\", \" a very controlled lifetime (for example, a subscription that is bound to a page\\u2019s OnAppearing and\\nO\", \"nDisappearing methods), the StrongReferenceManager may be a better option, if performance is a\\nconce\", \"rn. Both of these implementations are available with default implementations ready to use by\\nreferen\", \"cing either WeakReferenceMessenger.Default or StrongReferenceMessenger.Default.\\n\\n\\n\\n\\n\\nThe eShop multi\", \"-platform app uses the WeakReferenceMessenger class to communicate between\\nloosely coupled component\", \"s. The app defines a single message named AddProductMessage. The\\nAddProductMessage is published by t\", \"he CatalogViewModel class when an item is added to the\\nshopping basket. In return, the CatalogView c\", \"lass subscribes to the message and uses this to highlight\\nthe product adds with animation in respons\", \"e.\\n\\n\\nIn the eShop multi-platform app, WeakReferenceMessenger is used to update the UI in response to\", \"\\nan action occurring in another class. Therefore, messages are published from the thread that the cl\", \"ass\\nis executing on, with subscribers receiving the message on the same thread.\\n\\n\\n28 CHAPTER 5 | Com\", \"municating between loosely coupled components\\n\\n\\nIf a message that\\u2019s sent from a background thread is\", \" required to update the UI, process the message\\non the UI thread in the subscriber by invoking the M\", \"ainThread.BeginInvokeOnMainThread method.\\n\\n\\n[For more information about Messenger, see Messenger](ht\", \"tps://docs.microsoft.com/dotnet/communitytoolkit/mvvm/messenger) on the Microsoft Developer Center.\\n\", \"\\n### Defining a message\\n\\n\\nIMessenger messages are custom objects that provide custom payloads. The f\", \"ollowing code example\\nshows the AddProductMessage message defined within the eShop multi-platform ap\", \"p:\\n\\n\\nThe base class is defined using ValueChangedMessage<T> where T can be of any type needed to\\npas\", \"s data. Both message publishers and subscribers can expect messages of a specific type (for\\nexample,\", \" AddProductMessage). This can help ensure that both parties have agreed to a messaging\\ncontract and \", \"that the data provided with that contract will be consistent. Additionally, this approach\\nprovides c\", \"ompile-time type safety and refactoring support.\\n\\n### Publishing a message\\n\\n\\nTo publish a message, w\", \"e will need to use the IMessenger.Send method. This can be accessed most\\ncommonly through WeakRefere\", \"nceMessenger.Default.Send or\\nStrongReferenceMessenger.Default.Send. The message sent can be of any o\", \"bject type. The following\\ncode example demonstrates publishing the AddProduct message:\\n\\n```\\nWeakRefe\", \"renceMessenger.Default.Send( new Messages.AddProductMessage(BadgeCount));\\n\\n```\\n\\nIn this example, the\", \" Send method specifies provides a new instance of the AddProductMessage object\\nfor downstream subscr\", \"ibers to receive. An additional second token parameter can be added to use\\nwhen multiple different s\", \"ubscribers need to receive messages of the same type without receiving the\\nwrong message.\\n\\n\\nThe Send\", \" method will publish the message, and its payload data, using a fire-and-forget approach.\\nTherefore,\", \" the message is sent even if there are no subscribers registered to receive the message. In\\nthis sit\", \"uation, the sent message is ignored.\\n\\n\\n29 CHAPTER 5 | Communicating between loosely coupled componen\", \"ts\\n\\n\\n### Subscribing to a message\\n\\nSubscribers can register to receive a message using one of the IM\", \"essenger.Register<T> overloads.\\nThe following code example demonstrates how the eShop multi-platform\", \" app subscribes to, and\\nprocesses, the AddProductMessage message:\\n\\n\\nIn the preceding example, the Re\", \"gister method subscribes to the AddProductMessage message and\\nexecutes a callback delegate in respon\", \"se to receiving the message. This callback delegate, specified as\\na lambda expression, executes code\", \" that updates the UI.\\n\\n\\n\\n\\n\\nIf payload data is supplied, don\\u2019t attempt to modify the payload data fro\", \"m within a callback delegate\\nbecause several threads could be accessing the received data simultaneo\", \"usly. In this scenario, the\\npayload data should be immutable to avoid concurrency errors.\\n\\n### Unsub\", \"scribing from a message\\n\\n\\nSubscribers can unsubscribe from messages they no longer want to receive. \", \"This is achieved with one\\nof the IMessenger.Unregister overloads, as demonstrated in the following c\", \"ode example:\\n\\n```\\nWeakReferenceMessenger.Default.Unregister<Messages.AddProductMessage>( this );\\n\\n``\", \"`\\n\\n\\n\\n\\nIn this example, the Unsubscribe method syntax specifies the type argument of the message and \", \"the\\nrecipient object that is listening for messages.\\n\\n\\n30 CHAPTER 5 | Communicating between loosely \", \"coupled components\\n\\n\\n### Summary\\n\\nThe MVVM Toolkit IMessenger interface describes the publish-subscr\", \"ibe pattern, allowing messagebased communication between components that are inconvenient to link by\", \" object and type\\nreferences. This mechanism allows publishers and subscribers to communicate without\", \" having a\\nreference to each other, helping to reduce dependencies between components, while also all\", \"owing\\ncomponents to be independently developed and tested.\\n\\n\\n31 CHAPTER 5 | Communicating between lo\", \"osely coupled components\\n\\n\\n**CHAPTER**\\n# 6\\n\\n## Navigation\\n\\n\\n.NET MAUI includes support for page navi\", \"gation, which typically results from the user\\u2019s interaction\\nwith the UI or from the app itself as a \", \"result of internal logic-driven state changes. However,\\nnavigation can be complex to implement in ap\", \"ps that use the Model-View-ViewModel (MVVM)\\npattern, as the following challenges must be met:\\n\\n\\n  - \", \"Identifying the view to be navigated to using an approach that does not introduce tight\\ncoupling and\", \" dependencies between views.\\n\\n  - Coordinating the process by which the view to be navigated to is i\", \"nstantiated and initialized.\\nWhen using MVVM, the view and view-model need to be instantiated and as\", \"sociated with\\neach other via the view\\u2019s binding context. When an app is using a dependency injection\", \"\\ncontainer, the instantiation of views and view-models might require a specific construction\\nmechani\", \"sm.\\n\\n  - Whether to perform view-first navigation, or view-model-first navigation. With view-first\\nn\", \"avigation, the page to navigate to refers to the name of the view type. During navigation,\\nthe speci\", \"fied view is instantiated, along with its corresponding view-model and other\\ndependent services. An \", \"alternative approach is to use view-model-first navigation, where the\\npage to navigate to refers to \", \"the name of the view-model type.\\n\\n  - Determining how to cleanly separate the navigational behavior \", \"of the app across the views\\nand view-models. The MVVM pattern separates the app\\u2019s UI and its present\", \"ation and business\\nlogic, but it doesn\\u2019t provide a direct mechanism for tying them together. However\", \", the\\nnavigation behavior of an app will often span the UI and presentation parts of the app. The\\nus\", \"er will often initiate navigation from a view, and the view will be replaced as a result of the\\nnavi\", \"gation. However, navigation might often also need to be initiated or coordinated from\\nwithin the vie\", \"w-model.\\n\\n  - Determining how to pass parameters during navigation for initialization purposes. For\\n\", \"example, if the user navigates to a view to update order details, the order data will have to be\\npas\", \"sed to the view so that it can display the correct data.\\n\\n  - Coordinating navigation to ensure that\", \" specific business rules are obeyed. For example, users\\nmight be prompted before navigating away fro\", \"m a view so that they can correct any invalid\\ndata or be prompted to submit or discard any data chan\", \"ges that were made within the view.\\n\\n\\nThis chapter addresses these challenges by presenting a naviga\", \"tion service class named\\nMauiNavigationService that\\u2019s used to perform view-model-first page navigati\", \"on.\\n\\n\\n\\n\\n\\n32 CHAPTER 6 | Navigation\\n\\n\\n### Navigating between pages\\n\\nNavigation logic can reside in a \", \"view\\u2019s code-behind or a data-bound view-model. While placing\\nnavigation logic in a view might be the\", \" most straightforward approach, it is not easily testable\\nthrough unit tests. Putting navigation log\", \"ic in view-model classes means that the logic can be verified\\nthrough unit tests. In addition, the v\", \"iew-model can then implement logic to control navigation to\\nensure that certain business rules are e\", \"nforced. For example, an app might not allow the user to\\nnavigate away from a page without first ens\", \"uring that the entered data is valid.\\n\\n\\nA navigation service is typically invoked from view-models, \", \"in order to promote testability. However,\\nnavigating to views from view-models would require the vie\", \"w-models to reference views, and\\nparticularly views that the active view-model isn\\u2019t associated with\", \", which is not recommended.\\nTherefore, the MauiNavigationService presented here specifies the view-m\", \"odel type as the target to\\nnavigate to.\\n\\n\\nThe eShop multi-platform app uses the MauiNavigationServic\", \"e class to provide view-model-first\\nnavigation. This class implements the INavigationService interfa\", \"ce, which is shown in the following\\ncode example:\\n\\n\\nThis interface specifies that an implementing cl\", \"ass must provide the following methods:\\n\\n\\n\\n\\n\\n\\n\\n\\n|Method|Purpose|\\n|---|---|\\n|InitializeAsync|Performs\", \" navigation to one of two pages when<br>the app is launched.|\\n|NavigateToAsync(string route,<br>IDic\", \"tionary<string, object> routeParameters =<br>null)|Performs hierarchical navigation to a specified<b\", \"r>page using a registered navigation route. Can<br>optionally pass named route parameters to use<br>\", \"for processing on the destination page|\\n|PopAsync|Removes the current page from the navigation<br>st\", \"ack.|\\n\\n\\n\\n\\n\\n33 CHAPTER 6 | Navigation\\n\\n\\n### Creating the MauiNavigationService instance\\n\\nThe MauiNavi\", \"gationService class, which implements the INavigationService interface, is registered as a\\nsingleton\", \" with the dependency injection container in the MauiProgram.CreateMauiApp() method, as\\ndemonstrated \", \"in the following code example:\\n\\n```\\nmauiAppBuilder.Services.AddSingleton<INavigationService, MauiNav\", \"igationService>();;\\n\\n```\\n\\nThe INavigationService interface can then be resolved by adding it to the \", \"constructor of our views and\\nview-models, as demonstrated in the following code example:\\n\\n```\\npublic\", \" AppShell(INavigationService navigationService)\\n\\n```\\n\\nThis returns a reference to the MauiNavigation\", \"Service object that\\u2019s stored in the dependency injection\\ncontainer.\\n\\n\\nThe ViewModelBase class stores\", \" the MauiNavigationService instance in a NavigationService property,\\nof type INavigationService. The\", \"refore, all view-model classes, which derive from the ViewModelBase\\nclass, can use the NavigationSer\", \"vice property to access the methods specified by the\\nINavigationService interface.\\n\\n### Handling nav\", \"igation requests\\n\\n\\n.NET MAUI provides multiple ways to navigate within an application. The tradition\", \"al way to navigate is\\nwith the NavigationPage class, which implements a hierarchical navigation expe\", \"rience in which the\\nuser can navigate through pages, forward and backward, as desired. The eShop app\", \" uses the Shell\\ncomponent as the root container for the application and as a navigation host. For mo\", \"re information\\n[about Shell navigation, see Shell Navigation](https://docs.microsoft.com/dotnet/maui\", \"/fundamentals/shell/navigation) on the Microsoft Developer Center.\\n\\n\\nNavigation is performed inside \", \"view-model classes by invoking one of the NavigateToAsync methods,\\nspecifying the route path for the\", \" page being navigated to, as demonstrated in the following code\\nexample:\\n\\n```\\nawait NavigationServic\", \"e.NavigateToAsync(\\\"//Main\\\");\\n\\n```\\n\\nThe following code example shows the NavigateToAsync method provi\", \"ded by the\\nMauiNavigationService class:\\n\\n\\nThe .NET MAUI Shell control is already familiar with route\", \"-based navigation, so the NavigateToAsync\\nmethod works to mask this functionality. The NavigateToAsy\", \"nc method allows navigation data to be\\n\\n\\n34 CHAPTER 6 | Navigation\\n\\n\\nspecified as an argument that\\u2019s\", \" passed to the view-model being navigated to, where it\\u2019s typically used\\nto perform initialization. F\", \"or more information, see Passing parameters during navigation.\\n\\n\\n\\n\\n\\nIn order to register routes for \", \"the MauiNavigationService we need to supply route information from\\nXAML or in the code-behind. The f\", \"ollowing example shows registration of routes via XAML.\\n\\n\\nIn this example, the ShellContent and TabB\", \"ar user interface objects are setting their Route property.\\nThis is the preferred method of register\", \"ing routes for user interface objects that are controlled by a\\nShell.\\n\\n\\nIf we have objects that will\", \" be added to the navigation stack at a later time, then we will need to add\\nthose via code-behind. T\", \"he following example show registration of routes in code-behind.\\n\\n\\nIn code-behind, we will call the \", \"Routing.RegisterRoute method which takes a route name as the first\\nparameter and a view type as the \", \"second parameter. When a view-model uses the NavigationService\\nproperty to navigate, the application\", \"\\u2019s Shell object will look for registered routes and push them onto\\nthe navigation stack.\\n\\n\\nAfter the\", \" view is created and navigated to, the ApplyQueryAttributes and InitializeAsync methods of\\nthe view\\u2019\", \"s associated view-model are executed. For more information, see Passing parameters during\\nnavigation\", \".\\n\\n\\n35 CHAPTER 6 | Navigation\\n\\n\\n### Navigating when the app is launched\\n\\nWhen the app is launched, a\", \" Shell object is set as the root view of the application. Once set, the Shell\\nwill be used to contro\", \"l route registration and will be present at the root of our application going\\nforward. Once the Shel\", \"l has been created, we can wait for it to be attached to the application using\\nthe OnParentSet metho\", \"d to initialize our navigation route. The following code example shows this\\nmethod:\\n\\n\\nThe method use\", \"s an instance of INavigationService which is provided the constructor from\\ndependency injection and \", \"invokes its InitializeAsync method.\\n\\n\\nThe following code example shows the implementation of the Mau\", \"iNavigationService.InitializeAsync\\nmethod:\\n\\n\\nThe //Main/Catalog route is navigated to if the app has\", \" a cached access token, which is used for\\nauthentication. Otherwise, the //Login route is navigated \", \"to.\\n\\n### Passing parameters during navigation\\n\\n\\nThe NavigateToAsync method, specified by the INaviga\", \"tionService interface, enables navigation data\\nto be specified as an IDictionary<string, object> of \", \"data that\\u2019s passed to the view-model being\\nnavigated to, where it\\u2019s typically used to perform initia\", \"lization.\\n\\n\\nFor example, the ProfileViewModel class contains an OrderDetailCommand that\\u2019s executed w\", \"hen the\\nuser selects an order on the ProfileView page. In turn, this executes the OrderDetailAsync m\", \"ethod,\\nwhich is shown in the following code example:\\n\\n\\n36 CHAPTER 6 | Navigation\\n\\n\\nThis method invok\", \"es navigation to the OrderDetail route, passing order number information the order\\nthat the user sel\", \"ected. When the dependency injection framework creates the OrderDetailView for the\\nOrderDetail route\", \" along with the OrderDetailViewModel class which is assigned to the view\\u2019s\\nBindingContext. The Order\", \"DetailViewModel has an attribute added to it that allows it to receive data\\nfrom the navigation serv\", \"ice as shown in the code example below.\\n\\n\\nThe QueryProperty attribute allows us to provide a paramet\", \"er for a property to map values to and a\\nkey to find values from the query parameters dictionary. In\", \" this example, the key \\u201cOrderNumber\\u201d and\\norder number value were provided during the NavigateToAsync\", \" call. The view-model found the\\n\\u201cOrderNumber\\u201d key and mapped the value to the OrderNumber property. \", \"The OrderNumber property\\ncan then be used at a later time to retrieve the full order details from th\", \"e OrderService instance.\\n\\n### Invoking navigation using behaviors\\n\\n\\nNavigation is usually triggered \", \"from a view by a user interaction. For example, the LoginView performs\\nnavigation following successf\", \"ul authentication. The following code example shows how the navigation\\nis invoked by a behavior:\\n\\n\\nA\", \"t runtime, the EventToCommandBehavior will respond to interaction with the WebView. When the\\nWebView\", \" navigates to a web page, the Navigating event will fire, which will execute the\\nNavigateCommand in \", \"the LoginViewModel. By default, the event arguments for the event are passed\\nto the command. This da\", \"ta is converted as it\\u2019s passed between source and target by the converter\\nspecified in the EventArgs\", \"Converter property, which returns the Url from the\\nWebNavigatingEventArgs. Therefore, when the Navig\", \"ationCommand is executed, the Url of the web\\npage is passed as a parameter to the registered Action.\", \"\\n\\n\\nIn turn, the NavigationCommand executes the NavigateAsync method, which is shown in the\\nfollowing\", \" code example:\\n\\n\\n37 CHAPTER 6 | Navigation\\n\\n\\nThis method invokes NavigationService route the applica\", \"tion to the //Main/Catalog route.\\n\\n### Confirming or cancelling navigation\\n\\n\\nAn app might need to in\", \"teract with the user during a navigation operation, so that the user can\\nconfirm or cancel navigatio\", \"n. This might be necessary, for example, when the user attempts to\\nnavigate before having fully comp\", \"leted a data entry page. In this situation, an app should provide a\\nnotification that allows the use\", \"r to navigate away from the page, or to cancel the navigation operation\\nbefore it occurs. This can b\", \"e achieved in a view-model class by using the response from a notification\\nto control whether or not\", \" navigation is invoked.\\n\\n### Summary\\n\\n\\n.NET MAUI includes support for page navigation, which typical\", \"ly results from the user\\u2019s interaction\\nwith the UI, or from the app itself, as a result of internal \", \"logic-driven state changes. However,\\nnavigation can be complex to implement in apps that use the MVV\", \"M pattern.\\n\\n\\nThis chapter presented a NavigationService class, which is used to perform view-model-f\", \"irst\\nnavigation from view-models. Placing navigation logic in view-model classes means that the logi\", \"c can\\nbe exercised through automated tests. In addition, the view-model can then implement logic to\\n\", \"control navigation to ensure that certain business rules are enforced.\\n\\n\\n38 CHAPTER 6 | Navigation\\n\\n\", \"\\n**CHAPTER**\\n# 7\\n\\n## Validation\\n\\n\\nAny app that accepts input from users should ensure that the input\", \" is valid. An app could, for\\nexample, check for input that contains only characters in a particular \", \"range, is of a certain length, or\\nmatches a particular format. Without validation, a user can supply\", \" data that causes the app to fail.\\nProper validation enforces business rules and could help to preve\", \"nt an attacker from injecting\\nmalicious data.\\n\\n\\nIn the context of the Model-View-ViewModel (MVVM) pa\", \"ttern, a view model or model will often be\\nrequired to perform data validation and signal any valida\", \"tion errors to the view so that the user can\\ncorrect them. The eShop multi-platform app performs syn\", \"chronous client-side validation of view\\nmodel properties and notifies the user of any validation err\", \"ors by highlighting the control that\\ncontains the invalid data, and by displaying error messages tha\", \"t inform the user of why the data is\\ninvalid. The image below shows the classes involved in performi\", \"ng validation in the eShop multiplatform app.\\n\\n\\nView model properties that require validation are of\", \" type ValidatableObject<T>, and each\\nValidatableObject<T> instance has validation rules added to its\", \" Validations property. Validation is\\n\\n\\n39 CHAPTER 7 | Validation\\n\\n\\ninvoked from the view model by ca\", \"lling the Validate method of the ValidatableObject<T> instance,\\nwhich retrieves the validation rules\", \" and executes them against the ValidatableObject<T>.Value\\nproperty. Any validation errors are placed\", \" into the Errors property of the ValidatableObject<T>\\ninstance, and the IsValid property of the Vali\", \"datableObject<T> instance is updated to indicate\\nwhether the validation succeeded or failed. The fol\", \"lowing code shows the implementation of the\\nValidatableObject<T>:\\n\\n\\nProperty change notification is \", \"provided by the ObservableObject class, and so an Entry control can\\nbind to the IsValid property of \", \"ValidatableObject<T> instance in the view model class to be notified of\\nwhether or not the entered d\", \"ata is valid.\\n\\n### Specifying validation rules\\n\\n\\nValidation rules are specified by creating a class \", \"that derives from the IValidationRule<T> interface,\\nwhich is shown in the following code example:\\n\\n\\n\", \"40 CHAPTER 7 | Validation\\n\\n\\nThis interface specifies that a validation rule class must provide a boo\", \"lean Check method that is used\\nto perform the required validation, and a ValidationMessage property \", \"whose value is the validation\\nerror message that will be displayed if validation fails.\\n\\n\\nThe follow\", \"ing code example shows the IsNotNullOrEmptyRule<T> validation rule, which is used to\\nperform validat\", \"ion of the username and password entered by the user on the LoginView when using\\nmock services in th\", \"e eShop multi-platform app:\\n\\n\\nThe Check method returns a boolean indicating whether the value argume\", \"nt is null, empty, or consists\\nonly of whitespace characters.\\n\\n\\nAlthough not used by the eShop multi\", \"-platform app, the following code example shows a validation\\nrule for validating email addresses:\\n\\n\\n\", \"The Check method returns a boolean indicating whether or not the value argument is a valid email\\nadd\", \"ress. This is achieved by searching the value argument for the first occurrence of the regular\\nexpre\", \"ssion pattern specified in the Regex constructor. Whether the regular expression pattern has\\n[been f\", \"ound in the input string can be determined by checking the value against Regex.IsMatch.](https://doc\", \"s.microsoft.com/dotnet/api/system.text.regularexpressions.regex.ismatch)\\n\\n\\n\\n\\n\\n41 CHAPTER 7 | Validat\", \"ion\\n\\n\\n### Adding validation rules to a property\\n\\nIn the eShop multi-platform app, view model propert\", \"ies that require validation are declared to be of\\ntype ValidatableObject<T>, where T is the type of \", \"the data to be validated. The following code\\nexample shows an example of two such properties:\\n\\n\\nThis\", \" method adds the IsNotNullOrEmptyRule<T> validation rule to the Validations collection of each\\nValid\", \"atableObject<T> instance, specifying values for the validation rule\\u2019s ValidationMessage property,\\nwh\", \"ich specifies the validation error message that will be displayed if validation fails.\\n\\n### Triggeri\", \"ng validation\\n\\n\\nThe validation approach used in the eShop multi-platform app can manually trigger va\", \"lidation of a\\nproperty, and automatically trigger validation when a property changes.\\n\\n#### **Trigge\", \"ring validation manually**\\n\\n\\nValidation can be triggered manually for a view model property. For exa\", \"mple, this occurs in the eShop\\nmulti-platform app when the user taps the Login button on the LoginVi\", \"ew, when using mock services.\\nThe command delegate calls the MockSignInAsync method in the LoginView\", \"Model, which invokes\\nvalidation by executing the Validate method, which is shown in the following co\", \"de example:\\n\\n\\n42 CHAPTER 7 | Validation\\n\\n\\nThe Validate method performs validation of the username an\", \"d password entered by the user on the\\nLoginView, by invoking the Validate method on each Validatable\", \"Object<T> instance. The following\\ncode example shows the Validate method from the ValidatableObject<\", \"T> class:\\n\\n\\nThis method retrieves any validation rules that were added to the object\\u2019s Validations c\", \"ollection. The\\nCheck method for each retrieved validation rule is executed, and the ValidationMessag\", \"e property\\nvalue for any validation rule that fails to validate the data is added to the Errors coll\", \"ection of the\\nValidatableObject<T> instance. Finally, the IsValid property is set, and its value is \", \"returned to the\\ncalling method, indicating whether validation succeeded or failed.\\n\\n#### **Triggerin\", \"g validation when properties change**\\n\\n\\nValidation is also automatically triggered whenever a bound \", \"property changes. For example, when a\\ntwo-way binding in the LoginView sets the UserName or Password\", \" property, validation is triggered.\\nThe following code example demonstrates how this occurs:\\n\\n\\nThe E\", \"ntry control binds to the UserName.Value property of the ValidatableObject<T> instance, and\\nthe cont\", \"rol\\u2019s Behaviors collection has an EventToCommandBehavior instance added to it. This\\nbehavior execute\", \"s the ValidateUserNameCommand in response to the TextChanged event firing on\\nthe Entry, which is rai\", \"sed when the text in the Entry changes. In turn, the ValidateUserNameCommand\\ndelegate executes the V\", \"alidateUserName method, which executes the Validate method on the\\nValidatableObject<T> instance. The\", \"refore, every time the user enters a character in the Entry control\\nfor the username, validation of \", \"the entered data is performed.\\n\\n### Displaying validation errors\\n\\n\\nThe eShop multi-platform app noti\", \"fies the user of any validation errors by highlighting the control\\nthat contains the invalid data wi\", \"th a red background, and by displaying an error message that informs\\n\\n\\n43 CHAPTER 7 | Validation\\n\\n\\nt\", \"he user why the data is invalid below the control containing the invalid data. When the invalid data\", \" is\\ncorrected, the background changes back to the default state and the error message is removed. Th\", \"e\\nimage below shows the LoginView in the eShop multi-platform app when validation errors are\\npresent\", \".\\n\\n#### **Highlighting a control that contains invalid data**\\n\\n\\n.NET MAUI offers a number of ways to\", \" present validation information to end-users, but one of the\\nmost straight-forward ways is through t\", \"he use of Triggers. Triggers provide us a way to change the\\nstate of our controls, typically for app\", \"earance, based on an event or data change that occurs for a\\ncontrol. For validation, we will be usin\", \"g a DataTrigger which will listen to changes raised from a bound\\nproperty and respond to the changes\", \". The Entry controls on the LoginView are setup using the\\nfollowing code:\\n\\n\\nThe DataTrigger specifie\", \"s the following properties:\\n\\n\\n44 CHAPTER 7 | Validation\\n\\n\\n|Property|Description|\\n|---|---|\\n|TargetTy\", \"pe|The control type that the trigger belongs to.|\\n|Binding|The data Binding markup which will provid\", \"e<br>change notifications and value for the trigger<br>condition.|\\n|Value|The data value to specify \", \"when the trigger\\u2019s<br>condition has been met.|\\n\\n\\nFor this Entry, we will be listening for changes to\", \" the LoginViewModel.UserName.IsValid property.\\nEach time this property raises a change, the value wi\", \"ll be compared against the Value property set in\\nthe DataTrigger. If the values are equal, then the \", \"trigger condition will be met and any Setter objects\\nprovided to the DataTrigger will be executed. T\", \"his control has a single Setter object that updates the\\nBackgroundColor property to a custom color d\", \"efined using the StaticResource markup. When a\\nTrigger condition is no longer met, the control will \", \"revert the properties set by the Setter object to\\n[their previous state. For more information about \", \"Triggers, see .NET MAUI Docs: Triggers.](https://docs.microsoft.com/dotnet/maui/fundamentals/trigger\", \"s)\\n\\n#### **Displaying error messages**\\n\\n\\nThe UI displays validation error messages in Label controls\", \" below each control whose data failed\\nvalidation. The following code example shows the Label that di\", \"splays a validation error message, if the\\nuser has not entered a valid username:\\n\\n\\nEach Label binds \", \"to the Errors property of the view model object that\\u2019s being validated. The Errors\\nproperty is provi\", \"ded by the ValidatableObject<T> class, and is of type IEnumerable<string>. Because\\nthe Errors proper\", \"ty can contain multiple validation errors, the FirstValidationErrorConverter instance is\\nused to ret\", \"rieve the first error from the collection for display.\\n\\n### Summary\\n\\n\\nThe eShop multi-platform app p\", \"erforms synchronous client-side validation of view model properties\\nand notifies the user of any val\", \"idation errors by highlighting the control that contains the invalid data,\\nand by displaying error m\", \"essages that inform the user why the data is invalid.\\n\\n\\nView model properties that require validatio\", \"n are of type ValidatableObject<T>, and each\\nValidatableObject<T> instance has validation rules adde\", \"d to its Validations property. Validation is\\ninvoked from the view model by calling the Validate met\", \"hod of the ValidatableObject<T> instance,\\nwhich retrieves the validation rules and executes them aga\", \"inst the ValidatableObject<T> Value\\nproperty. Any validation errors are placed into the Errors prope\", \"rty of the ValidatableObject<T>\\ninstance, and the IsValid property of the ValidatableObject<T> insta\", \"nce is updated to indicate\\nwhether validation succeeded or failed.\\n\\n\\n45 CHAPTER 7 | Validation\\n\\n\\n**C\", \"HAPTER**\\n# 8\\n\\n## Application settings management\\n\\n\\nSettings allow the separation of data that config\", \"ures the behavior of an app from the code, allowing\\nthe behavior to be changed without rebuilding th\", \"e app. There are two types of settings: app settings\\nand user settings.\\n\\n\\nApp settings are data that\", \" an app creates and manages. It can include data such as fixed web service\\nendpoints, API keys, and \", \"runtime state. App settings are tied to core functionality and are only\\nmeaningful to that app.\\n\\n\\nUs\", \"er settings are the customizable settings of an app that affect the app\\u2019s behavior and don\\u2019t require\", \"\\nfrequent re-adjustment. For example, an app might let the user specify where to retrieve data and\\nh\", \"ow to display it on the screen.\\n\\n### Creating a Settings Interface\\n\\n\\nWhile the preferences manager c\", \"an be used directly in your application, it does come with the\\ndrawback of making your application t\", \"ightly coupled to the preferences manager implementation.\\nThis coupling means that creating unit tes\", \"ts or extending the functionality of preferences\\nmanagement will be limited since your application w\", \"ill not have a direct way to intercept the behavior.\\nTo address this concern, an interface can be cr\", \"eated to work as a proxy for preferences management.\\nThe interface will allow us to supply an implem\", \"entation that fits our needs. For example, when writing\\na unit test, we may want to set specific set\", \"tings, and the interface will give us an easy way to\\nconsistently set this data for the test. The fo\", \"llowing code example shows the ISettingsService interface\\nin the eShop multi-platform app:\\n\\n\\n46 CHAP\", \"TER 8 | Application settings management\\n\\n\\n### Adding Settings\\n\\n.NET MAUI includes a preferences mana\", \"ger that provides a way to store runtime settings for a user.\\nThis feature can be accessed from anyw\", \"here within your application using the\\nMicrosoft.Maui.Storage.Preferences class. The preferences man\", \"ager provides a consistent, type-safe,\\ncross-platform approach for persisting and retrieving app and\", \" user settings, while using the native\\nsettings management provided by each platform. In addition, i\", \"t\\u2019s straightforward to use data binding\\n[to access settings data exposed by the library. For more in\", \"formation, see the Preferences on the](https://docs.microsoft.com/dotnet/maui/platform-integration/s\", \"torage/preferences)\\nMicrosoft Developer Center.\\n\\n\\n\\n\\n\\nOur application will use the Preferences class \", \"need to implement the ISettingsService interface. The\\ncode below shows how the eShop multi-platform \", \"app\\u2019s SettingsService implements the\\nAuthTokenAccess and UseMocks properties:\\n\\n\\nEach setting consist\", \"s of a private key, a private default value, and a public property. The key is always\\na const string\", \" that defines a unique name, with the default value for the setting being a static readonly or const\", \"ant value of the required type. Providing a default value ensures that a valid value is\\navailable if\", \" an unset setting is retrieved. This service implementation can be provided via dependency\\ninjection\", \" to our application for use in view-models or other services throughout the application.\\n\\n\\n47 CHAPTE\", \"R 8 | Application settings management\\n\\n\\n### Data binding to user settings\\n\\nIn the eShop multi-platfo\", \"rm app, the SettingsView exposes multiple settings the user can configure at\\nruntime. These settings\", \" include allowing configuration of whether the app should retrieve data from\\nmicroservices deployed \", \"as Docker containers or whether the app should retrieve data from mock\\nservices that don\\u2019t require a\", \"n internet connection. When retrieving data from containerized\\nmicroservices, a base endpoint URL fo\", \"r the microservices must be specified. The image below shows\\nthe SettingsView when the user has chos\", \"en to retrieve data from containerized microservices.\\n\\n\\nData binding can be used to retrieve and set\", \" settings exposed by the ISettingService interface. This is\\nachieved by controls on the view binding\", \" to view model properties that in turn access properties in\\nthe ISettingService interface and raisin\", \"g a property changed notification if the value has changed.\\n\\n\\nThe following code example shows the E\", \"ntry control from the SettingsView that allows the user to\\nenter a base identity endpoint URL for th\", \"e containerized microservices:\\n\\n```\\n< Entry Text=\\\"{Binding IdentityEndpoint, Mode=TwoWay}\\\" />\\n\\n```\\n\\n\", \"This Entry control binds to the IdentityEndpoint property of the SettingsViewModel class, using a tw\", \"oway binding. The following code example shows the IdentityEndpoint property:\\n\\n\\n48 CHAPTER 8 | Appli\", \"cation settings management\\n\\n\\nWhen the IdentityEndpoint property is set, the UpdateIdentityEndpoint m\", \"ethod is called, provided\\nthat the supplied value is valid. The following code example shows the Upd\", \"ateIdentityEndpoint\\nmethod:\\n\\n\\nThis method updates the IdentityEndpointBase property in the ISettingS\", \"ervice interface\\nimplementation with the base endpoint URL value entered by the user. If the Setting\", \"sService class is\\nprovided as the implementation for _settingsService, the value will persist to pla\", \"tform-specific storage.\\n\\n### Summary\\n\\n\\nSettings allow the separation of data that configures the beh\", \"avior of an app from the code, allowing\\nthe behavior to be changed without rebuilding the app. App s\", \"ettings are data that an app creates and\\nmanages, and user settings are the customizable settings of\", \" an app that affect the app\\u2019s behavior and\\ndon\\u2019t require frequent re-adjustment.\\n\\n\\nThe Microsoft.Mau\", \"i.Storage.Preferences class provides a consistent, type-safe, cross-platform\\napproach for persisting\", \" and retrieving app and user settings.\\n\\n\\n49 CHAPTER 8 | Application settings management\\n\\n\\n**CHAPTER*\", \"*\\n# 9\\n\\n## Containerized microservices\\n\\n\\nDeveloping client-server applications has resulted in a focu\", \"s on building tiered applications that use\\nspecific technologies in each tier. Such applications are\", \" often referred to as _monolithic_ and are\\npackaged onto hardware pre-scaled for peak loads. The mai\", \"n drawbacks of this development\\napproach are the tight coupling between components within each tier,\", \" that individual components\\ncan\\u2019t be easily scaled, and the cost of testing. A simple update can hav\", \"e unforeseen effects on the rest\\nof the tier, so a change to an application component requires its e\", \"ntire tier to be retested and\\nredeployed.\\n\\n\\nParticularly concerning, in the age of the cloud, is tha\", \"t individual components can\\u2019t be easily scaled. A\\nmonolithic application contains domain-specific fu\", \"nctionality and is typically divided by functional\\nlayers such as front-end, business logic, and dat\", \"a storage. The image below illustrates that a\\nmonolithic application is scaled by cloning the entire\", \" application onto multiple machines.\\n\\n\\n50 CHAPTER 9 | Containerized microservices\\n\\n\\n### Microservice\", \"s\\n\\nMicroservices offer a different approach to application development and deployment, an approach\\nt\", \"hat\\u2019s suited to the agility, scale, and reliability requirements of modern cloud applications. A\\nmic\", \"roservices application is split into independent components that work together to deliver the\\napplic\", \"ation\\u2019s overall functionality. The term microservice emphasizes that applications should be\\ncomposed\", \" of services small enough to reflect particular concerns, so each microservice implements a\\nsingle f\", \"unction. In addition, each microservice has well-defined contracts with which other\\nmicroservices co\", \"mmunicate and share data. Typical examples of microservices include shopping carts,\\ninventory proces\", \"sing, purchase subsystems, and payment processing.\\n\\n\\nMicroservices can scale independently compared \", \"to giant monolithic applications that scale together.\\nThis means that a specific functional area tha\", \"t requires more processing power or network bandwidth\\nto support demand can be scaled rather than un\", \"necessarily scaling out other application areas. The\\nimage below illustrates this approach, where mi\", \"croservices are deployed and scaled independently,\\ncreating instances of services across machines.\\n\\n\", \"\\n51 CHAPTER 9 | Containerized microservices\\n\\n\\nMicroservice scale-out can be nearly instantaneous, al\", \"lowing an application to adapt to changing\\nloads. For example, a single microservice in the web-faci\", \"ng functionality of an application might be\\nthe only microservice that needs to scale out to handle \", \"additional incoming traffic.\\n\\n\\nThe classic model for application scalability is to have a load-balan\", \"ced, stateless tier with a shared\\nexternal datastore to store persistent data. Stateful microservice\", \"s manage their own persistent data,\\nusually storing it locally on the servers on which they are plac\", \"ed, to avoid the overhead of network\\naccess and complexity of cross-service operations. This enables\", \" the fastest possible processing of data\\nand can eliminate the need for caching systems. In addition\", \", scalable stateful microservices usually\\npartition data among their instances, in order to manage d\", \"ata size and transfer throughput beyond\\nwhich a single server can support.\\n\\n\\nMicroservices also supp\", \"ort independent updates. This loose coupling between microservices provides\\na rapid and reliable app\", \"lication evolution. Their independent, distributed nature helps rolling updates,\\nwhere only a subset\", \" of instances of a single microservice will update at any given time. Therefore, if a\\nproblem is det\", \"ected, a buggy update can be rolled back, before all instances update with the faulty\\ncode or config\", \"uration. Similarly, microservices typically use schema versioning, so that clients see a\\nconsistent \", \"version when updates are being applied, regardless of which microservice instance is being\\ncommunica\", \"ted with.\\n\\n\\nTherefore, microservice applications have many benefits over monolithic applications:\\n\\n\\n\", \"  - Each microservice is relatively small, easy to manage and evolve.\\n\\n  - Each microservice can be \", \"developed and deployed independently of other services.\\n\\n  - Each microservice can be scaled-out ind\", \"ependently. For example, a catalog service or\\nshopping basket service might need to be scaled-out mo\", \"re than an ordering service.\\n\\n\\n52 CHAPTER 9 | Containerized microservices\\n\\n\\nTherefore, the resulting\", \" infrastructure will more efficiently consume resources when scaling\\nout.\\n\\n  - Each microservice iso\", \"lates any issues. For example, if there is an issue in a service it only\\nimpacts that service. The o\", \"ther services can continue to handle requests.\\n\\n  - Each microservice can use the latest technologie\", \"s. Because microservices are autonomous and\\nrun side-by-side, the latest technologies and frameworks\", \" can be used, rather than being\\nforced to use an older framework that might be used by a monolithic \", \"application.\\n\\n\\nHowever, a microservice-based solution also has potential drawbacks:\\n\\n\\n  - Choosing h\", \"ow to partition an application into microservices can be challenging, as each\\nmicroservice has to be\", \" completely autonomous, end-to-end, including responsibility for its\\ndata sources.\\n\\n  - Developers m\", \"ust implement inter-service communication, which adds complexity and latency\\nto the application.\\n\\n  \", \"- Atomic transactions between multiple microservices usually aren\\u2019t possible. Therefore,\\nbusiness re\", \"quirements must embrace eventual consistency between microservices.\\n\\n  - In production, there is an \", \"operational complexity in deploying and managing a system\\ncompromised of many independent services.\\n\", \"\\n  - Direct client-to-microservice communication can make it difficult to refactor the contracts of\\n\", \"microservices. For example, over time how the system is partitioned into services might need\\nto chan\", \"ge. A single service might split into two or more services, and two services might\\nmerge. When clien\", \"ts communicate directly with microservices, this refactoring work can break\\ncompatibility with clien\", \"t apps.\\n\\n### Containerization\\n\\n\\nContainerization is an approach to software development in which an \", \"application and its versioned set\\nof dependencies, plus its environment configuration abstracted as \", \"deployment manifest files, are\\npackaged together as a container image, tested as a unit, and deploye\", \"d to a host operating system.\\n\\n\\nA container is an isolated, resource controlled, and portable operat\", \"ing environment, where an\\napplication can run without touching the resources of other containers, or\", \" the host. Therefore, a\\ncontainer looks and acts like a newly installed physical computer or a virtu\", \"al machine.\\n\\n\\nThere are many similarities between containers and virtual machines, as illustrated be\", \"low.\\n\\n\\n53 CHAPTER 9 | Containerized microservices\\n\\n\\nA container runs an operating system, has a file\", \" system, and can be accessed over a network as if it\\nwere a physical or virtual machine. However, th\", \"e technology and concepts used by containers are very\\ndifferent from virtual machines. Virtual machi\", \"nes include the applications, the required dependencies,\\nand a full guest operating system. Containe\", \"rs include the application and its dependencies, but share\\nthe operating system with other container\", \"s, running as isolated processes on the host operating\\nsystem (aside from Hyper-V containers which r\", \"un inside of a special virtual machine per container).\\nTherefore, containers share resources and typ\", \"ically require fewer resources than virtual machines.\\n\\n\\nThe advantage of a container-oriented develo\", \"pment and deployment approach is that it eliminates\\nmost of the issues that arise from inconsistent \", \"environment setups and the problems that come with\\nthem. In addition, containers permit fast applica\", \"tion scale-up functionality by instancing new\\ncontainers as required.\\n\\n\\nThe key concepts when creati\", \"ng and working with containers are:\\n\\n|Concept|Description|\\n|---|---|\\n|Container Host|The physical or\", \" virtual machine configured to<br>host containers. The container host will run one<br>or more contai\", \"ners.|\\n|Container Image|An image consists of a union of layered<br>filesystems stacked on top of eac\", \"h other, and is<br>the basis of a container. An image does not<br>have state and it never changes as\", \" it\\u2019s deployed<br>to different environments.|\\n|Container|A container is a runtime instance of an ima\", \"ge.|\\n\\n\\n\\n54 CHAPTER 9 | Containerized microservices\\n\\n\\n|Concept|Description|\\n|---|---|\\n|Container OS I\", \"mage|Containers are deployed from images. The<br>container operating system image is the first<br>la\", \"yer in potentially many image layers that make<br>up a container. A container operating system is<br\", \">immutable, and can\\u2019t be modified.|\\n|Container Repository|Each time a container image is created, th\", \"e<br>image and its dependencies are stored in a local<br>repository. These images can be reused many\", \"<br>times on the container host. The container<br>images can also be stored in a public or private<b\", \"r>registry, such asDocker Hub, so that they can<br>be used across different container hosts.|\\n\\n\\nEnte\", \"rprises are increasingly adopting containers when implementing microservice-based applications,\\nand \", \"Docker has become the standard container implementation that has been adopted by most\\nsoftware platf\", \"orms and cloud vendors.\\n\\n\\nThe eShop reference application uses Docker to host four containerized bac\", \"k-end microservices, as\\nillustrated in the diagram below.\\n\\n\\n55 CHAPTER 9 | Containerized microservic\", \"es\\n\\n\\nThe architecture of the back-end services in the reference application is decomposed into multi\", \"ple\\nautonomous sub-systems in the form of collaborating microservices and containers. Each microserv\", \"ice\\nprovides a single area of functionality: an identity service, a catalog service, an ordering ser\", \"vice, and a\\nbasket service.\\n\\n\\nEach microservice has its own database, allowing it to be fully decoup\", \"led from the other\\nmicroservices. Where necessary, consistency between databases from different micr\", \"oservices is\\nachieved using application-level events. For more information, see Communication betwee\", \"n\\nmicroservices.\\n\\n### Communication between client and microservices\\n\\n\\nThe eShop multi-platform app \", \"communicates with the containerized back-end microservices using\\n_direct client-to-microservice_ com\", \"munication, as shown below.\\n\\n\\n56 CHAPTER 9 | Containerized microservices\\n\\n\\nWith direct client-to-mic\", \"roservice communication, the multi-platform app makes requests to each\\nmicroservice directly through\", \" its public endpoint, with a different TCP port per microservice. In\\nproduction, the endpoint would \", \"typically map to the microservice\\u2019s load balancer, which distributes\\nrequests across the available i\", \"nstances.\\n\\n\\n\\n\\n\\n\\n\\nDirect client-to-microservice communication can have drawbacks when building a larg\", \"e and complex\\nmicroservice-based application, but it\\u2019s more than adequate for a small application. C\", \"onsider using\\nAPI gateway communication when designing a large microservice-based application with t\", \"ens of\\nmicroservices.\\n\\n### Communication between microservices\\n\\n\\nA microservices-based application i\", \"s a distributed system, potentially running on multiple machines.\\nEach service instance is typically\", \" a process. Therefore, services must interact using an inter-process\\ncommunication protocol, such as\", \" HTTP, TCP, Advanced Message Queuing Protocol (AMQP), or binary\\nprotocols, depending on the nature o\", \"f each service.\\n\\n\\nThe two common approaches for microservice-to-microservice communication are HTTP-\", \"based REST\\ncommunication when querying for data, and lightweight asynchronous messaging when\\ncommuni\", \"cating updates across multiple microservices.\\n\\n\\nAsynchronous messaging-based event-driven communicat\", \"ion is critical when propagating changes\\nacross multiple microservices. With this approach, a micros\", \"ervice publishes an event when something\\nnotable happens, for example, when it updates a business en\", \"tity. Other microservices subscribe to\\nthese events. Then, when a microservice receives an event, it\", \" updates its own business entities, which\\nmight, in turn, lead to more events being published. This \", \"publish-subscribe functionality is usually\\nachieved with an event bus.\\n\\n\\n57 CHAPTER 9 | Containerize\", \"d microservices\\n\\n\\nAn event bus allows publish-subscribe communication between microservices without \", \"requiring the\\ncomponents to be explicitly aware of each other, as shown below.\\n\\n\\nFrom an application\", \" perspective, the event bus is simply a publish-subscribe channel exposed via an\\ninterface. However,\", \" the way the event bus is implemented can vary. For example, an event bus\\nimplementation could use R\", \"abbitMQ, Azure Service Bus, or other service buses such as NServiceBus\\nand MassTransit. The diagram \", \"below shows how an event bus is used in the eShop reference\\napplication.\\n\\n\\nThe eShop event bus, impl\", \"emented using RabbitMQ, provides one-to-many asynchronous publishsubscribe functionality. This means\", \" that after publishing an event, there can be multiple subscribers\\nlistening for the same event. The\", \" diagram below illustrates this relationship.\\n\\n\\n58 CHAPTER 9 | Containerized microservices\\n\\n\\nThis on\", \"e-to-many communication approach uses events to implement business transactions that span\\nmultiple s\", \"ervices, ensuring eventual consistency between the services. An eventual-consistent\\ntransaction cons\", \"ists of a series of distributed steps. Therefore, when the user-profile microservice\\nreceives the Up\", \"dateUser command, it updates the user\\u2019s details in its database and publishes the\\nUserUpdated event \", \"to the event bus. Both the basket microservice and the ordering microservice have\\nsubscribed to rece\", \"ive this event, and in response, update their buyer information in their respective\\ndatabases.\\n\\n### \", \"Summary\\n\\n\\nMicroservices offer an approach to application development and deployment that\\u2019s suited to\", \" the\\nagility, scale, and reliability requirements of modern cloud applications. One of the main adva\", \"ntages\\nof microservices is that they can be scaled-out independently, which means that a specific fu\", \"nctional\\narea can be scaled that requires more processing power or network bandwidth to support dema\", \"nd\\nwithout unnecessarily scaling areas of the application that are not experiencing increased demand\", \".\\n\\n\\nA container is an isolated, resource-controlled, and portable operating environment where an\\napp\", \"lication can run without touching the resources of other containers or the host. Enterprises are\\ninc\", \"reasingly adopting containers when implementing microservice-based applications, and Docker\\nhas beco\", \"me the standard container implementation that most software platforms and cloud vendors\\nhave adopted\", \".\\n\\n\\n59 CHAPTER 9 | Containerized microservices\\n\\n\\n**CHAPTER**\\n# 10\\n\\n## Accessing remote data\\n\\n\\nMany m\", \"odern web-based solutions make use of web services, hosted by web servers, to provide\\nfunctionality \", \"for remote client applications. The operations that a web service exposes constitute a\\nweb API.\\n\\n\\nCl\", \"ient apps should be able to utilize the web API without knowing how the data or operations that the\\n\", \"API exposes are implemented. This requires that the API abides by common standards that enable a\\ncli\", \"ent app and web service to agree on which data formats to use, and the structure of the data that is\", \"\\nexchanged between client apps and the web service.\\n\\n### Introduction to Representational State Tran\", \"sfer\\n\\n\\nRepresentational State Transfer (REST) is an architectural style for building distributed sys\", \"tems based\\non hypermedia. A primary advantage of the REST model is that it\\u2019s based on open standards\", \" and\\ndoesn\\u2019t bind the implementation of the model or the client apps that access it to any specific\\n\", \"[implementation. Therefore, a REST web service could be implemented using Microsoft ASP.NET Core,](h\", \"ttps://docs.microsoft.com/aspnet/core/introduction-to-aspnet-core)\\nand client apps could be developi\", \"ng using any language and toolset that can generate HTTP requests\\nand parse HTTP responses.\\n\\n\\nThe RE\", \"ST model uses a navigational scheme to represent objects and services over a network, referred\\nto as\", \" resources. Systems that implement REST typically use the HTTP protocol to transmit requests to\\nacce\", \"ss these resources. In such systems, a client app submits a request in the form of a URI that\\nidenti\", \"fies a resource, and an HTTP method (such as GET, POST, PUT, or DELETE) that indicates the\\noperation\", \" to be performed on that resource. The body of the HTTP request contains any data required\\nto perfor\", \"m the operation.\\n\\n\\n\\n\\n\\nThe response from a REST request makes use of standard HTTP status codes. For \", \"example, a request\\nthat returns valid data should include the HTTP response code 200 (OK), while a r\", \"equest that fails to\\nfind or delete a specified resource should return a response that includes the \", \"HTTP status code 404\\n(Not Found).\\n\\n\\nA RESTful web API exposes a set of connected resources, and prov\", \"ides the core operations that\\nenable an app to manipulate those resources and easily navigate betwee\", \"n them. For this reason, the\\nURIs that constitute a typical RESTful web API are oriented towards the\", \" data that it exposes, and use\\nthe facilities provided by HTTP to operate on this data.\\n\\n\\n60 CHAPTER\", \" 10 | Accessing remote data\\n\\n\\nThe data included by a client app in an HTTP request, and the correspo\", \"nding response messages from\\nthe web server, could be presented in a variety of formats, known as me\", \"dia types. When a client app\\nsends a request that returns data in the body of a message, it can spec\", \"ify the media types it can\\nhandle in the Accept header of the request. If the web server supports th\", \"is media type, it can reply\\nwith a response that includes the Content-Type header that specifies the\", \" format of the data in the\\nbody of the message. It\\u2019s then the responsibility of the client app to pa\", \"rse the response message and\\ninterpret the results in the message body appropriately.\\n\\n\\n[For more in\", \"formation about REST, see API design](https://docs.microsoft.com/azure/architecture/best-practices/a\", \"pi-design) [and API implementation](https://docs.microsoft.com/azure/architecture/best-practices/api\", \"-implementation) on Microsoft Docs.\\n\\n### Consuming RESTful APIs\\n\\n\\nThe eShop multi-platform app uses \", \"the Model-View-ViewModel (MVVM) pattern, and the model\\nelements of the pattern represent the domain \", \"entities used in the app. The controller and repository\\nclasses in the eShop reference application a\", \"ccept and return many of these model objects. Therefore,\\nthey are used as data transfer objects (DTO\", \"s) that hold all the data that is passed between the app\\nand the containerized microservices. The ma\", \"in benefit of using DTOs to pass data to and receive data\\nfrom a web service is that by transmitting\", \" more data in a single remote call, the app can reduce the\\nnumber of remote calls that need to be ma\", \"de.\\n\\n### Making web requests\\n\\n\\nThe eShop multi-platform app uses the HttpClient class to make reques\", \"ts over HTTP, with JSON being\\nused as the media type. This class provides functionality for asynchro\", \"nously sending HTTP requests\\nand receiving HTTP responses from a URI identified resource. The HttpRe\", \"sponseMessage class\\nrepresents an HTTP response message received from a REST API after an HTTP reque\", \"st has been\\nmade. It contains information about the response, including the status code, headers, an\", \"d any body.\\nThe HttpContent class represents the HTTP body and content headers, such as Content-Type\", \" and\\nContent-Encoding. The content can be read using any of the ReadAs methods, such as\\nReadAsString\", \"Async and ReadAsByteArrayAsync, depending on the format of the data.\\n\\n### Making a GET request\\n\\n\\nThe\", \" CatalogService class is used to manage the data retrieval process from the catalog microservice.\\nIn\", \" the RegisterViewModels method in the MauiProgram class, the CatalogService class is registered as\\na\", \" type mapping against the ICatalogService type with the dependency injection container. Then, when\\na\", \"n instance of the CatalogViewModel class is created, its constructor accepts an ICatalogService type\", \",\\nwhich the dependency injection container resolves, returning an instance of the CatalogService cla\", \"ss.\\nFor more information about dependency injection, see Dependency Injection.\\n\\n\\nThe image below sho\", \"ws the interaction of classes that read catalog data from the catalog microservice\\nfor displaying by\", \" the CatalogView.\\n\\n\\n61 CHAPTER 10 | Accessing remote data\\n\\n\\nWhen the CatalogView is navigated to, th\", \"e OnInitialize method in the CatalogViewModel class is\\ncalled. This method retrieves catalog data fr\", \"om the catalog microservice, as demonstrated in the\\nfollowing code example:\\n\\n\\nThis method calls the \", \"GetCatalogAsync method of the CatalogService instance that was injected into\\nthe CatalogViewModel by\", \" the dependency injection container. The following code example shows the\\nGetCatalogAsync method:\\n\\n\\n\", \"62 CHAPTER 10 | Accessing remote data\\n\\n\\nThis method builds the URI that identifies the resource the \", \"request will be sent to, and uses the\\nRequestProvider class to invoke the GET HTTP method on the res\", \"ource, before returning the results to\\nthe CatalogViewModel. The RequestProvider class contains func\", \"tionality that submits a request in the\\nform of a URI that identifies a resource, an HTTP method tha\", \"t indicates the operation to be performed\\non that resource, and a body that contains any data requir\", \"ed to perform the operation. For\\ninformation about how the RequestProvider class is injected into th\", \"e CatalogService class, see\\nDependency Injection.\\n\\n\\nThe following code example shows the GetAsync me\", \"thod in the RequestProvider class:\\n\\n\\nThis method calls the GetOrCreateHttpClient method, which retur\", \"ns an instance of the HttpClient class\\nwith the appropriate headers set. It then submits an asynchro\", \"nous GET request to the resource\\nidentified by the URI, with the response being stored in the HttpRe\", \"sponseMessage instance. The\\nHandleResponse method is then invoked, which throws an exception if the \", \"response doesn\\u2019t include a\\nsuccess HTTP status code. Then the response is read as a string, converte\", \"d from JSON to a\\nCatalogRoot object, and returned to the CatalogService.\\n\\n\\nThe GetOrCreateHttpClient\", \" method is shown in the following code example:\\n\\n\\n63 CHAPTER 10 | Accessing remote data\\n\\n\\nThis metho\", \"d uses creates a new instance or retrieves a cached instance of the HttpClient class, and\\nsets the A\", \"ccept header of any requests made by the HttpClient instance to application/json, which\\nindicates th\", \"at it expects the content of any response to be formatted using JSON. Then, if an access\\ntoken was p\", \"assed as an argument to the GetOrCreateHttpClient method, it\\u2019s added to the\\nAuthorization header of \", \"any requests made by the HttpClient instance, prefixed with the string Bearer.\\nFor more information \", \"about authorization, see Authorization.\\n\\n\\n\\n\\n\\nWhen the GetAsync method in the RequestProvider class c\", \"alls HttpClient.GetAsync, the Items method\\nin the CatalogController class in the Catalog.API project\", \" is invoked, which is shown in the following\\ncode example:\\n\\n\\n[This method retrieves the catalog data\", \" from the SQL database using EntityFramework, and returns it](https://docs.microsoft.com/ef/)\\nas a r\", \"esponse message that includes a success HTTP status code, and a collection of JSON formatted\\nCatalog\", \"Item instances.\\n\\n### Making a POST request\\n\\n\\nThe BasketService class is used to manage the data retr\", \"ieval and update process with the basket\\nmicroservice. In the RegisterAppServices method in the Maui\", \"Program class, the BasketService class is\\nregistered as a type mapping against the IBasketService ty\", \"pe with the dependency injection container.\\nThen, when an instance of the BasketViewModel class is c\", \"reated, its constructor accepts an\\n\\n\\n64 CHAPTER 10 | Accessing remote data\\n\\n\\nIBasketService type, wh\", \"ich the dependency injection container resolves, returning an instance of the\\nBasketService class. F\", \"or more information about dependency injection, see Dependency Injection.\\n\\n\\nThe image below shows th\", \"e interaction of classes that send the basket data displayed by the\\nBasketView, to the basket micros\", \"ervice.\\n\\n\\nWhen an item is added to the shopping basket, the ReCalculateTotalAsync method in the\\nBask\", \"etViewModel class is called. This method updates the total value of items in the basket, and sends\\nt\", \"he basket data to the basket microservice, as demonstrated in the following code example:\\n\\n\\n65 CHAPT\", \"ER 10 | Accessing remote data\\n\\n\\nThis method calls the UpdateBasketAsync method of the BasketService \", \"instance that was injected into\\nthe BasketViewModel by the dependency injection container. The follo\", \"wing method shows the\\nUpdateBasketAsync method:\\n\\n\\nThis method builds the URI that identifies the res\", \"ource the request will be sent to, and uses the\\nRequestProvider class to invoke the POST HTTP method\", \" on the resource, before returning the results\\nto the BasketViewModel. Note that an access token, ob\", \"tained from IdentityServer during the\\nauthentication process, is required to authorize requests to t\", \"he basket microservice. For more\\ninformation about authorization, see Authorization.\\n\\n\\nThe following\", \" code example shows one of the PostAsync methods in the RequestProvider class:\\n\\n\\nThis method calls t\", \"he GetOrCreateHttpClient method, which returns an instance of the HttpClient class\\nwith the appropri\", \"ate headers set. It then submits an asynchronous POST request to the resource\\nidentified by the URI,\", \" with the serialized basket data being sent in JSON format, and the response\\nbeing stored in the Htt\", \"pResponseMessage instance. The HandleResponse method is then invoked,\\nwhich throws an exception if t\", \"he response doesn\\u2019t include a success HTTP status code. Then, the\\nresponse is read as a string, conv\", \"erted from JSON to a CustomerBasket object, and returned to the\\nBasketService. For more information \", \"about the GetOrCreateHttpClient method, see Making a GET\\nrequest.\\n\\n\\nWhen the PostAsync method in the\", \" RequestProvider class calls HttpClient.PostAsync, the Post method\\nin the BasketController class in \", \"the Basket.API project is invoked, which is shown in the following code\\nexample:\\n\\n\\n66 CHAPTER 10 | A\", \"ccessing remote data\\n\\n\\nThis method uses an instance of the RedisBasketRepository class to persist th\", \"e basket data to the\\nRedis cache, and returns it as a response message that includes a success HTTP \", \"status code, and a\\nJSON formatted CustomerBasket instance.\\n\\n### Making a DELETE request\\n\\n\\nThe image \", \"below shows the interactions of classes that delete basket data from the basket\\nmicroservice, for th\", \"e CheckoutView.\\n\\n\\nWhen the checkout process is invoked, the CheckoutAsync method in the CheckoutView\", \"Model class is\\ncalled. This method creates a new order, before clearing the shopping basket, as demo\", \"nstrated in the\\nfollowing code example:\\n\\n\\nThis method calls the ClearBasketAsync method of the Baske\", \"tService instance that was injected into\\nthe CheckoutViewModel by the dependency injection container\", \". The following method shows the\\nClearBasketAsync method:\\n\\n\\n67 CHAPTER 10 | Accessing remote data\\n\\n\\n\", \"This method builds the URI that identifies the resource that the request will be sent to, and uses t\", \"he\\nRequestProvider class to invoke the DELETE HTTP method on the resource. Note that an access token\", \",\\nobtained from IdentityServer during the authentication process, is required to authorize requests \", \"to\\nthe basket microservice. For more information about authorization, see Authorization.\\n\\n\\nThe follo\", \"wing code example shows the DeleteAsync method in the RequestProvider class:\\n\\n\\nThis method calls the\", \" GetOrCreateHttpClient method, which returns an instance of the HttpClient class\\nwith the appropriat\", \"e headers set. It then submits an asynchronous DELETE request to the resource\\nidentified by the URI.\", \" For more information about the GetOrCreateHttpClient method, see Making a\\nGET request.\\n\\n\\nWhen the D\", \"eleteAsync method in the RequestProvider class calls HttpClient.DeleteAsync, the Delete\\nmethod in th\", \"e BasketController class in the Basket.API project is invoked, which is shown in the\\nfollowing code \", \"example:\\n\\n\\nThis method uses an instance of the RedisBasketRepository class to delete the basket data\", \" from the\\nRedis cache.\\n\\n### Caching data\\n\\n\\nThe performance of an app can be improved by caching freq\", \"uently accessed data to fast storage\\nthat\\u2019s located close to the app. If the fast storage is located\", \" closer to the app than the original source,\\nthen caching can significantly improve response times w\", \"hen retrieving data.\\n\\n\\nThe most common form of caching is read-through caching, where an app retriev\", \"es data by\\nreferencing the cache. If the data isn\\u2019t in the cache, it\\u2019s retrieved from the data store\", \" and added to the\\ncache. Apps can implement read-through caching with the cache-aside pattern. This \", \"pattern\\ndetermines whether the item is currently in the cache. If the item isn\\u2019t in the cache, it\\u2019s \", \"read from the\\n[data store and added to the cache. For more information, see the Cache-Aside pattern \", \"on Microsoft](https://docs.microsoft.com/azure/architecture/patterns/cache-aside)\\nDocs.\\n\\n\\n\\n\\n\\n\\n\\nThis \", \"data can be added to the cache on demand the first time it is retrieved by an app. This means\\nthat t\", \"he app needs to fetch the data only once from the data store, and that subsequent access can\\nbe sati\", \"sfied by using the cache.\\n\\n\\n68 CHAPTER 10 | Accessing remote data\\n\\n\\nDistributed applications, such a\", \"s the eShop reference application, should provide either or both of the\\nfollowing caches:\\n\\n\\n  - A sh\", \"ared cache, which can be accessed by multiple processes or machines.\\n\\n  - A private cache, where dat\", \"a is held locally on the device running the app.\\n\\n\\nThe eShop multi-platform app uses a private cache\", \", where data is held locally on the device that\\u2019s\\nrunning an instance of the app.\\n\\n\\n\\n\\n\\n\\n\\nEnsure that\", \" data is maintained in the original data store as well as the cache. The chances of losing\\ndata are \", \"then minimized if the cache becomes unavailable.\\n\\n### Managing data expiration\\n\\n\\nIt\\u2019s impractical to\", \" expect that cached data will always be consistent with the original data. Data in the\\noriginal data\", \" store might change after it\\u2019s been cached, causing the cached data to become stale.\\nTherefore, apps\", \" should implement a strategy that helps to ensure that the data in the cache is as upto-date as poss\", \"ible, but can also detect and handle situations that arise when the data in the cache\\nhas become sta\", \"le. Most caching mechanisms enable the cache to be configured to expire data, and\\nhence reduce the p\", \"eriod for which data might be out of date.\\n\\n\\n\\n\\n\\n\\n\\nMany caches implement expiration, which invalidate\", \"s data and removes it from the cache if it\\u2019s not\\naccessed for a specified period. However, care must\", \" be taken when choosing the expiration period. If\\nit\\u2019s made too short, data will expire too quickly \", \"and the benefits of caching will be reduced. If it\\u2019s\\nmade too long, the data risks becoming stale. T\", \"herefore, the expiration time should match the pattern\\nof access for apps that use the data.\\n\\n\\nWhen \", \"cached data expires, it should be removed from the cache, and the app must retrieve the data\\nfrom th\", \"e original data store and place it back into the cache.\\n\\n\\nIt\\u2019s also possible that a cache might fill\", \" up if data is allowed to remain for too long a period. Therefore,\\nrequests to add new items to the \", \"cache might be required to remove some items in a process known\\nas _eviction_ . Caching services typ\", \"ically evict data on a least-recently-used basis. However, there are\\nother eviction policies, includ\", \"ing most-recently-used, and first-in-first-out. For more information, see\\n[Caching Guidance](https:/\", \"/docs.microsoft.com/azure/architecture/best-practices/caching) on Microsoft Docs.\\n\\n### Caching image\", \"s\\n\\n\\nThe eShop multi-platform app consumes remote product images that benefit from being cached.\\nThes\", \"e images are displayed by the Image control. The .NET MAUI Image control supports caching of\\n\\n\\n69 CH\", \"APTER 10 | Accessing remote data\\n\\n\\ndownloaded images which has caching enabled by default, and will \", \"store the image locally for 24\\nhours. In addition, the expiration time can be configured with the Ca\", \"cheValidity property. For more\\n[information, see Downloaded Image Caching on the Microsoft Developer\", \" Center.](https://docs.microsoft.com/dotnet/maui/user-interface/controls/image#image-caching)\\n\\n### I\", \"ncreasing resilience\\n\\n\\nAll apps that communicate with remote services and resources must be sensitiv\", \"e to transient faults.\\nTransient faults include the momentary loss of network connectivity to servic\", \"es, the temporary\\nunavailability of a service, or timeouts that arise when a service is busy. These \", \"faults are often selfcorrecting, and if the action is repeated after a suitable delay it\\u2019s likely to\", \" succeed.\\n\\n\\nTransient faults can have a huge impact on the perceived quality of an app, even if it h\", \"as been\\nthoroughly tested under all foreseeable circumstances. To ensure that an app that communicat\", \"es with\\nremote services operates reliably, it must be able to do all of the following:\\n\\n\\n  - Detect \", \"faults when they occur, and determine if the faults are likely to be transient.\\n\\n  - Retry the opera\", \"tion if it determines that the fault is likely to be transient and keep track of the\\nnumber of times\", \" the operation was retried.\\n\\n  - Use an appropriate retry strategy, which specifies the number of re\", \"tries, the delay between\\neach attempt, and the actions to take after a failed attempt.\\n\\n\\nThis transi\", \"ent fault handling can be achieved by wrapping all attempts to access a remote service in\\ncode that \", \"implements the retry pattern.\\n\\n### Retry pattern\\n\\n\\nIf an app detects a failure when it tries to send\", \" a request to a remote service, it can handle the failure\\nin any of the following ways:\\n\\n\\n  - Retryi\", \"ng the operation. The app could retry the failing request immediately.\\n\\n  - Retrying the operation a\", \"fter a delay. The app should wait for a suitable amount of time before\\nretrying the request.\\n\\n  - Ca\", \"ncelling the operation. The application should cancel the operation and report an\\nexception.\\n\\n\\nThe r\", \"etry strategy should be tuned to match the business requirements of the app. For example, it\\u2019s\\nimpor\", \"tant to optimize the retry count and retry interval to the operation being attempted. If the\\noperati\", \"on is part of a user interaction, the retry interval should be short and only a few retries\\nattempte\", \"d to avoid making users wait for a response. If the operation is part of a long running\\nworkflow, wh\", \"ere cancelling or restarting the workflow is expensive or time-consuming, it\\u2019s appropriate\\nto wait l\", \"onger between attempts and to retry more times.\\n\\n\\n\\n\\n\\n70 CHAPTER 10 | Accessing remote data\\n\\n\\nIf a re\", \"quest still fails after a number of retries, it\\u2019s better for the app to prevent further requests goi\", \"ng\\nto the same resource and to report a failure. Then, after a set period, the app can make one or m\", \"ore\\nrequests to the resource to see if they\\u2019re successful. For more information, see Circuit breaker\", \" pattern.\\n\\n\\n\\n\\n\\n\\n\\n[Use a finite number of retries, or implement the Circuit Breaker](https://docs.mic\", \"rosoft.com/azure/architecture/patterns/circuit-breaker) pattern to allow a service to recover.\\n\\n\\nThe\", \" eShop reference application does implement the retry pattern.\\n\\n\\n[For more information about the ret\", \"ry pattern, see the Retry](https://docs.microsoft.com/azure/architecture/patterns/retry) pattern on \", \"Microsoft Docs.\\n\\n### Circuit breaker pattern\\n\\n\\nIn some situations, faults can occur due to anticipat\", \"ed events that take longer to fix. These faults can\\nrange from a partial loss of connectivity to the\", \" complete failure of a service. In these situations, it\\u2019s\\npointless for an app to retry an operation\", \" that\\u2019s unlikely to succeed, and instead should accept that\\nthe operation has failed and handle this\", \" failure accordingly.\\n\\n\\nThe circuit breaker pattern can prevent an app from repeatedly trying to exe\", \"cute an operation that\\u2019s\\nlikely to fail, while also enabling the app to detect whether the fault has\", \" been resolved.\\n\\n\\n\\n\\n\\nA circuit breaker acts as a proxy for operations that might fail. The proxy sho\", \"uld monitor the number\\nof recent failures that have occurred, and use this information to decide whe\", \"ther to allow the\\noperation to proceed, or to return an exception immediately.\\n\\n\\nThe eShop multi-pla\", \"tform app does not currently implement the circuit breaker pattern. However, the\\neShop does.\\n\\n\\n\\n\\n\\n\\n\\n\", \"An app can combine the retry and circuit breaker patterns by using the retry pattern to invoke an\\nop\", \"eration through a circuit breaker. However, the retry logic should be sensitive to any exceptions\\nre\", \"turned by the circuit breaker and abandon retry attempts if the circuit breaker indicates that a fau\", \"lt\\nis not transient.\\n\\n\\n[For more information about the circuit breaker pattern, see the Circuit Brea\", \"ker pattern on Microsoft](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker)\\nDo\", \"cs.\\n\\n\\n71 CHAPTER 10 | Accessing remote data\\n\\n\\n### Summary\\n\\nMany modern web-based solutions make use \", \"of web services, hosted by web servers, to provide\\nfunctionality for remote client applications. The\", \" operations that a web service exposes constitute a\\nweb API, and client apps should be able to utili\", \"ze the web API without knowing how the data or\\noperations that the API exposes are implemented.\\n\\n\\nTh\", \"e performance of an app can be improved by caching frequently accessed data to fast storage\\nthat\\u2019s l\", \"ocated close to the app. Apps can implement read-through caching with the cache-aside\\npattern. This \", \"pattern determines whether the item is currently in the cache. If the item isn\\u2019t in the\\ncache, it\\u2019s \", \"read from the data store and added to the cache.\\n\\n\\nWhen communicating with web APIs, apps must be se\", \"nsitive to transient faults. Transient faults\\ninclude the momentary loss of network connectivity to \", \"services, the temporary unavailability of a\\nservice, or timeouts that arise when a service is busy. \", \"These faults are often self-correcting, and if the\\naction is repeated after a suitable delay, then i\", \"t\\u2019s likely to succeed. Therefore, apps should wrap all\\nattempts to access a web API in code that imp\", \"lements a transient fault handling mechanism.\\n\\n\\n72 CHAPTER 10 | Accessing remote data\\n\\n\\n**CHAPTER**\\n\", \"# 11\\n\\n## Authentication and authorization\\n\\n\\nAuthentication is the process of obtaining identificatio\", \"n credentials such as name and password from\\na user and validating those credentials against an auth\", \"ority. The entity that submitted the credentials\\nis considered an authenticated identity if the cred\", \"entials are valid. Once an identity has been\\nestablished, an authorization process determines whethe\", \"r that identity has access to a given resource.\\n\\n\\nThere are many approaches to integrating authentic\", \"ation and authorization into a .NET MAUI app that\\ncommunicates with an ASP.NET web application, incl\", \"uding using ASP.NET Core Identity, external\\nauthentication providers such as Microsoft, Google, Face\", \"book, or Twitter, and authentication\\nmiddleware. The eShop multi-platform app performs authenticatio\", \"n and authorization with a\\ncontainerized identity microservice that uses IdentityServer. The app req\", \"uests security tokens from\\nIdentityServer to authenticate a user or access a resource. For IdentityS\", \"erver to issue tokens on behalf\\nof a user, the user must sign in to IdentityServer. However, Identit\", \"yServer doesn\\u2019t provide a user\\ninterface or database for authentication. Therefore, in the eShop ref\", \"erence application, ASP.NET Core\\nIdentity is used for this purpose.\\n\\n### Authentication\\n\\n\\nAuthentica\", \"tion is required when an application needs to know the current user\\u2019s identity. ASP.NET\\nCore\\u2019s prima\", \"ry mechanism for identifying users is the ASP.NET Core Identity membership system,\\nwhich stores user\", \" information in a data store configured by the developer. Typically, this data store\\nwill be an Enti\", \"tyFramework store, though custom stores or third-party packages can be used to store\\nidentity inform\", \"ation in Azure storage, DocumentDB, or other locations.\\n\\n\\nFor authentication scenarios that use a lo\", \"cal user datastore and persist identity information between\\nrequests via cookies (as is typical in A\", \"SP.NET web applications), ASP.NET Core Identity is a suitable\\nsolution. However, cookies are not alw\", \"ays a natural means of persisting and transmitting data. For\\nexample, an ASP.NET Core web applicatio\", \"n that exposes RESTful endpoints that are accessed from an\\napp will typically need to use bearer tok\", \"en authentication since cookies can\\u2019t be used in this scenario.\\nHowever, bearer tokens can easily be\", \" retrieved and included in the authorization header of web\\nrequests made from the app.\\n\\n\\n73 CHAPTER \", \"11 | Authentication and authorization\\n\\n\\n#### **Issuing bearer tokens using IdentityServer**\\n\\n[Identi\", \"tyServer](https://github.com/DuendeSoftware/IdentityServer) is an open-source OpenID Connect and OAu\", \"th 2.0 framework for ASP.NET Core, which\\ncan be used for many authentication and authorization scena\", \"rios, including issuing security tokens for\\nlocal ASP.NET Core Identity users.\\n\\n\\n\\n\\n\\n\\n\\nOpenID Connect\", \" is an authentication layer on top of the OAuth 2.0 protocol. OAuth 2 is a protocol\\nthat allows appl\", \"ications to request access tokens from a security token service and use them to\\ncommunicate with API\", \"s. This delegation reduces complexity in both client applications and APIs since\\nauthentication and \", \"authorization can be centralized.\\n\\n\\nOpenID Connect and OAuth 2.0 combine the two fundamental securit\", \"y concerns of authentication\\nand API access, and IdentityServer is an implementation of these protoc\", \"ols.\\n\\n\\nIn applications that use direct client-to-microservice communication, such as the eShop refer\", \"ence\\napplication, a dedicated authentication microservice acting as a Security Token Service (STS) c\", \"an be\\nused to authenticate users, as shown in the following diagram. For more information about dire\", \"ct\\nclient-to-microservice communication, see Microservices.\\n\\n\\nThe eShop multi-platform app communica\", \"tes with the identity microservice, which uses IdentityServer\\nto perform authentication, and access \", \"control for APIs. Therefore, the multi-platform app requests\\ntokens from IdentityServer, either for \", \"authenticating a user or for accessing a resource:\\n\\n\\n  - Authenticating users with IdentityServer is\", \" achieved by the multi-platform app requesting an\\n_identity_ token, representing an authentication p\", \"rocess\\u2019s outcome. At a minimum, it contains\\nan identifier for the user and information about how and\", \" when the user is authenticated. It\\ncan also include additional identity data.\\n\\n  - Accessing a reso\", \"urce with IdentityServer is achieved by the multi-platform app requesting an\\n_access_ token, which a\", \"llows access to an API resource. Clients request access tokens and\\nforward them to the API. Access t\", \"okens contain information about the client and the user, if\\npresent. APIs then use that information \", \"to authorize access to their data.\\n\\n\\n\\n\\n\\n74 CHAPTER 11 | Authentication and authorization\\n\\n\\n#### **Ad\", \"ding IdentityServer to a web application**\\n\\nIn order for an ASP.NET Core web application to use Iden\", \"tityServer, it must be added to the web\\n[application\\u2019s Visual Studio solution. For more information,\", \" see Setup and Overview](https://docs.duendesoftware.com/identityserver/v7/quickstarts/) in the\\nIden\", \"tityServer documentation. Once IdentityServer is included in the web application\\u2019s Visual Studio\\nsol\", \"ution, it must be added to its HTTP request processing pipeline to serve requests to OpenID\\nConnect \", \"and OAuth 2.0 endpoints. This is configured in the Identity.API project\\u2019s Program.cs, as\\ndemonstrate\", \"d in the following code example:\\n\\n\\nOrder matters in the web application\\u2019s HTTP request processing pi\", \"peline. Therefore, IdentityServer\\nmust be added to the pipeline before the UI framework that impleme\", \"nts the login screen.\\n\\n#### **Configuring IdentityServer**\\n\\n\\nIdentityServer should be configured in \", \"the ConfigureServices method in the web application\\u2019s Startup\\nclass by calling the services.AddIdent\", \"ityServer method, as demonstrated in the following code\\nexample from the eShop reference application\", \":\\n\\n\\nAfter calling the services.AddIdentityServer method, additional fluent APIs are called to config\", \"ure the\\nfollowing:\\n\\n\\n  - Credentials used for signing.\\n\\n  - API and identity resources that users mi\", \"ght request access to.\\n\\n  - Clients that will be connecting to request tokens.\\n\\n  - ASP.NET Core Ide\", \"ntity.\\n\\n\\n\\n\\n\\n75 CHAPTER 11 | Authentication and authorization\\n\\n\\n[For information about configuring Id\", \"entityServer to use ASP.NET Core Identity, see Using ASP.NET](https://docs.duendesoftware.com/identi\", \"tyserver/v7/quickstarts/5_aspnetid/)\\n[Core Identity](https://docs.duendesoftware.com/identityserver/\", \"v7/quickstarts/5_aspnetid/) in the IdentityServer documentation.\\n\\n#### **Configuring API resources**\", \"\\n\\n\\nWhen configuring API resources, the AddInMemoryApiResources method expects an\\nIEnumerable<ApiReso\", \"urce> collection. The following code example shows the GetApis method that\\nprovides this collection \", \"in the eShop reference application:\\n\\n\\nThis method specifies that IdentityServer should protect the o\", \"rders and basket APIs. Therefore,\\nIdentityServer-managed access tokens will be required when making \", \"calls to these APIs. For more\\n[information about the ApiResource type, see API Resource](https://doc\", \"s.duendesoftware.com/identityserver/v7/fundamentals/resources/api_resources/) in the IdentityServer \", \"documentation.\\n\\n#### **Configuring identity resources**\\n\\n\\nWhen configuring identity resources, the A\", \"ddInMemoryIdentityResources method expects an\\nIEnumerable<IdentityResource> collection. Identity res\", \"ources are data such as user ID, name, or email\\naddress. Each identity resource has a unique name, a\", \"nd arbitrary claim types can be assigned to it,\\nwhich will be included in the identity token for the\", \" user. The following code example shows the\\nGetResources method that provides this collection in the\", \" eShop reference application:\\n\\n\\n[The OpenID Connect specification specifies some standard identity r\", \"esources. The minimum](https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims)\\nrequiremen\", \"t is that support is provided for emitting a unique ID for users. This is achieved by\\nexposing the I\", \"dentityResources.OpenId identity resource.\\n\\n\\n\\n\\n\\n[IdentityServer also supports defining custom identi\", \"ty resources. For more information, see Defining](https://identityserver4.readthedocs.io/en/latest/t\", \"opics/resources.html#defining-custom-identity-resources)\\n[custom identity resources in the IdentityS\", \"erver documentation. For more information about the](https://identityserver4.readthedocs.io/en/lates\", \"t/topics/resources.html#defining-custom-identity-resources)\\n[IdentityResource type, see Identity Res\", \"ource](https://docs.duendesoftware.com/identityserver/v7/fundamentals/resources/identity/) in the Id\", \"entityServer documentation.\\n\\n\\n76 CHAPTER 11 | Authentication and authorization\\n\\n\\n#### **Configuring \", \"clients**\\n\\nClients are applications that can request tokens from IdentityServer. Typically, the foll\", \"owing settings\\nmust be defined for each client as a minimum:\\n\\n\\n  - A unique client ID.\\n\\n  - The allo\", \"wed interactions with the token service (known as the grant type).\\n\\n  - The location where identity \", \"and access tokens are sent to (known as a redirect URI).\\n\\n  - A list of resources that the client is\", \" allowed access to (known as scopes).\\n\\nWhen configuring clients, the AddInMemoryClients method expec\", \"ts an IEnumerable<Client>\\ncollection. The following code example shows the configuration for the eSh\", \"op multi-platform app in\\nthe GetClients method that provides this collection in the eShop reference \", \"application:\\n\\n\\nThis configuration specifies data for the following properties:\\n\\n|Property|Descriptio\", \"n|\\n|---|---|\\n|ClientId|A unique ID for the client.|\\n|ClientName|The client display name, which is us\", \"ed for<br>logging and the consent screen.|\\n\\n\\n\\n77 CHAPTER 11 | Authentication and authorization\\n\\n\\n|Pr\", \"operty|Description|\\n|---|---|\\n|AllowedGrantTypes|Specifies how a client wants to interact with<br>Id\", \"entityServer. For more information see<br>Configuring the authentication flow.|\\n|ClientSecrets|Speci\", \"fies the client secret credentials that are<br>used when requesting tokens from the token<br>endpoin\", \"t.|\\n|RedirectUris|Specifies the allowed URIs to which to return<br>tokens or authorization codes.|\\n|\", \"RequireConsent|Specifies whether a consent screen is required.|\\n|RequirePkce|Specifies whether clien\", \"ts using an authorization<br>code must send a proof key.|\\n|PostLogoutRedirectUris|Specifies the allo\", \"wed URIs to redirect to after<br>logout.|\\n|AllowedCorsOrigins|Specifies the origin of the client so \", \"that<br>IdentityServer can allow cross-origin calls from<br>the origin.|\\n|AllowedScopes|Specifies th\", \"e resources the client has access to.<br>By default, a client has no access to any<br>resources.|\\n|A\", \"llowOfflineAccess|Specifies whether the client can request refresh<br>tokens.|\\n|AllowAccessTokensVia\", \"Browser|Specifies whether the client can receive access<br>tokens from a browser window.|\\n|AlwaysInc\", \"ludeUserClaimsInIdToken|Specifies that the user claims will always be<br>added to the id token. By d\", \"efault, these would<br>have to be retrieved using the userinfo<br>endpoint.|\\n|AccessTokenLifetime|Sp\", \"ecifies the lifetime of the access token in<br>seconds.|\\n|IdentityTokenLifetime|Specifies the lifeti\", \"me of the identity token in<br>seconds.|\\n\\n#### **Configuring the authentication flow**\\n\\nThe authenti\", \"cation flow between a client and IdentityServer can be configured by specifying the grant\\ntypes in t\", \"he Client.AllowedGrantTypes property. The OpenID Connect and OAuth 2.0 specifications\\ndefine several\", \" authentication flows, including:\\n\\n\\n78 CHAPTER 11 | Authentication and authorization\\n\\n\\n|Authenticati\", \"on Flow|Description|\\n|---|---|\\n|Implicit|This flow is optimized for browser-based<br>applications an\", \"d should be used either for user<br>authentication-only, or authentication and<br>access token reque\", \"sts. All tokens are<br>transmitted via the browser, and therefore<br>advanced features like refresh \", \"tokens are not<br>permitted.|\\n|Authorization code|This flow provides the ability to retrieve tokens<\", \"br>on a back channel, as opposed to the browser<br>front channel, while also supporting client<br>au\", \"thentication.|\\n|Hybrid|This flow is a combination of the implicit and<br>authorization code grant ty\", \"pes. The identity<br>token is transmitted via the browser channel<br>and contains the signed protoco\", \"l response and<br>other artifacts such as the authorization code.<br>After successfully validating t\", \"he response, the<br>back channel should be used to retrieve the<br>access and refresh token.|\\n\\n\\n\\n\\n\\n[\", \"For more information about authentication flows, see Grant Types](https://docs.duendesoftware.com/id\", \"entityserver/v7/data/operational/grants/) in the IdentityServer\\ndocumentation.\\n\\n#### **Performing au\", \"thentication**\\n\\n\\nFor IdentityServer to issue tokens on behalf of a user, the user must sign in to Id\", \"entityServer. However,\\nIdentityServer doesn\\u2019t provide a user interface or database for authenticatio\", \"n. Therefore, in the eShop\\nreference application, ASP.NET Core Identity is used for this purpose.\\n\\n\\n\", \"The eShop multi-platform app authenticates with IdentityServer with the hybrid authentication flow,\\n\", \"which is illustrated in the diagram below.\\n\\n\\n79 CHAPTER 11 | Authentication and authorization\\n\\n\\nA si\", \"gn in request is made to <base endpoint>:5105/connect/authorize. Following successful\\nauthentication\", \", IdentityServer returns an authentication response containing an authorization code\\nand an identity\", \" token. The authorization code is sent to <base endpoint>:5105/connect/token, which\\nresponds with ac\", \"cess, identity, and refresh tokens.\\n\\n\\nThe eShop multi-platform app signs out of IdentityServer by se\", \"nding a request to <base\\nendpoint>:5105/connect/endsession with additional parameters. After sign-ou\", \"t, IdentityServer\\nresponds by sending a post-logout redirecting URI back to the multi-platform app. \", \"The diagram\\nbelow illustrates this process.\\n\\n\\nIn the eShop multi-platform app, communication with Id\", \"entityServer is performed by the\\nIdentityService class, which implements the IIdentityService interf\", \"ace. This interface specifies that the\\nimplementing class must provide SignInAsync, SignOutAsync, Ge\", \"tUserInfoAsync and\\nGetAuthTokenAsync methods.\\n\\n#### **Signing-in**\\n\\n\\nWhen the user taps the LOGIN bu\", \"tton on the LoginView, the SignInCommand in the LoginViewModel\\nclass is executed, which in turn exec\", \"utes the SignInAsync method. The following code example shows\\nthis method:\\n\\n\\n80 CHAPTER 11 | Authent\", \"ication and authorization\\n\\n\\nThis method invokes the SignInAsync method in the IdentityService class,\", \" as shown in the following\\ncode example:\\n\\n\\nThe IdentityService makes use of the OidcClient provided \", \"with the IdentityModel.OidcClient NuGet\\npackage. This client displays the authentication web view to\", \" the user in the application and captures\\n[the authentication result. The client connects to the URI\", \" for IdentityServer\\u2019s authorization endpoint](https://docs.duendesoftware.com/identityserver/v7/refe\", \"rence/endpoints/authorize/)\\nwith the required parameters. The authorization endpoint is at /connect/\", \"authorize on port 5105 of the\\nbase endpoint exposed as a user setting. For more information about us\", \"er settings, see Configuration\\nManagement.\\n\\n\\n\\n\\n\\n81 CHAPTER 11 | Authentication and authorization\\n\\n\\nI\", \"f the token endpoint receives valid authentication information, authorization code, and PKCE secret\\n\", \"verifier, it responds with an access token, identity token, and refresh token. The access token (whi\", \"ch\\nallows access to API resources) and identity token are stored as application settings, and page\\nn\", \"avigation is performed. Therefore, the overall effect in the eShop multi-platform app is this: provi\", \"ded\\nthat users are able to successfully authenticate with IdentityServer, they are navigated to the\\n\", \"//Main/Catalog route, which is a TabbedPage that displays the CatalogView as its selected tab.\\n\\n\\n82 \", \"CHAPTER 11 | Authentication and authorization\\n\\n\\nFor information about page navigation, see Navigatio\", \"n. For information about how WebView\\nnavigation causes a view model method to be executed, see Invok\", \"ing navigation using behaviors. For\\ninformation about application settings, see Configuration manage\", \"ment.\\n\\n\\n\\n\\n#### **Signing-out**\\n\\nWhen the user taps the LOG OUT button in the ProfileView, the Logout\", \"Command in the\\nProfileViewModel class is executed, which executes the LogoutAsync method. This metho\", \"d performs\\npage navigation to the LoginView page, passing a Logout query parameter set to true.\\n\\n\\nTh\", \"at parameter is evaluated in the ApplyQueryAttributes method. If the Logout parameter is present\\nwit\", \"h a true value, the PerformLogoutAsync method of the LoginViewModel class is executed, which is\\nshow\", \"n in the following code example:\\n\\n\\nThis method invokes the SignOutAsync method in the IdentityServic\", \"e class, which invokes the\\nOidcClient to end the user\\u2019s session and clears any saved user tokens. Fo\", \"r more information about\\napplication settings, see Configuration management. The following code exam\", \"ple shows the\\nSignOutAsync method:\\n\\n\\n[This method uses the OidcClient to call the URI to IdentitySer\", \"ver\\u2019s end session endpoint with the](https://docs.duendesoftware.com/identityserver/v7/reference/end\", \"points/end_session/)\\nrequired parameters. The end session endpoint is at /connect/endsession on port\", \" 5105 of the base\\nendpoint exposed as a user setting. Once the user has successfully signed out, Log\", \"inView is presented\\nto the user, and any saved user information will be cleared.\\n\\n\\n83 CHAPTER 11 | A\", \"uthentication and authorization\\n\\n\\nFor information about page navigation, see Navigation. For informa\", \"tion about how WebView\\nnavigation causes a view model method to be executed, see Invoking navigation\", \" using behaviors. For\\ninformation about application settings, see Configuration management.\\n\\n\\n\\n\\n### \", \"Authorization\\n\\nAfter authentication, ASP.NET Core web APIs often need to authorize access, which all\", \"ows a service to\\nmake APIs available to some authenticated users but not to all.\\n\\n\\nRestricting acces\", \"s to an ASP.NET Core route can be achieved by applying an Authorize attribute to a\\ncontroller or act\", \"ion, which limits access to the controller or action to authenticated users, as shown in\\nthe followi\", \"ng code example:\\n\\n\\nIf an unauthorized user attempts to access a controller or action marked with the\", \" Authorize attribute,\\nthe API framework returns a 401 (unauthorized) HTTP status code.\\n\\n\\n\\n\\n\\nIdentity\", \"Server can be integrated into the authorization workflow so that the access tokens provide\\ncontrol a\", \"uthorization. This approach is shown in the diagram below.\\n\\n\\n84 CHAPTER 11 | Authentication and auth\", \"orization\\n\\n\\nThe eShop multi-platform app communicates with the identity microservice and requests an\", \" access\\ntoken as part of the authentication process. The access token is then forwarded to the APIs \", \"exposed\\nby the ordering and basket microservices as part of the access requests. Access tokens conta\", \"in\\ninformation about the client and the user. APIs then use that information to authorize access to \", \"their\\ndata. For information about how to configure IdentityServer to protect APIs, see Configuring A\", \"PI\\nresources.\\n\\n### Configuring IdentityServer to perform authorization\\n\\n\\nTo perform authorization wi\", \"th IdentityServer, its authorization middleware must be added to the web\\napplication\\u2019s HTTP request \", \"pipeline. The middleware is added in the AddDefaultAuthentication\\nextension method, which is invoked\", \" from the AddApplicationServices method in the Program class\\nand is demonstrated in the following co\", \"de example from the eShop reference application:\\n\\n\\n85 CHAPTER 11 | Authentication and authorization\\n\", \"\\n\\nThis method ensures that the API can only be accessed with a valid access token. The middleware\\nva\", \"lidates the incoming token to ensure that it\\u2019s sent from a trusted issuer and validates that the tok\", \"en\\nis valid to be used with the API that receives it. Therefore, browsing to the ordering or basket\\n\", \"controller will return a 401 (unauthorized) HTTP status code, indicating that an access token is\\nreq\", \"uired.\\n\\n### Making access requests to APIs\\n\\n\\nWhen making requests to the ordering and basket microse\", \"rvices, the access token obtained from\\nIdentityServer during the authentication process must be incl\", \"uded in the request, as shown in the\\nfollowing code example:\\n\\n\\nThe access token is stored with the I\", \"IdentityService implementation and can be retrieved using the\\nGetAuthTokenAsync method.\\n\\n\\nSimilarly,\", \" the access token must be included when sending data to an IdentityServer protected API, as\\nshown in\", \" the following code example:\\n\\n\\n86 CHAPTER 11 | Authentication and authorization\\n\\n\\nThe access token i\", \"s retrieved from the IIdentityService and included in the call to the ClearBasketAsync\\nmethod in the\", \" BasketService class.\\n\\n\\nThe RequestProvider class in the eShop multi-platform app uses the HttpClien\", \"t class to make requests\\nto the RESTful APIs exposed by the eShop reference application. When making\", \" requests to the\\nordering and basket APIs, which require authorization, a valid access token must be\", \" included with the\\nrequest. This is achieved by adding the access token to the headers of the HttpCl\", \"ient instance, as\\ndemonstrated in the following code example:\\n\\n\\nThe DefaultRequestHeaders property o\", \"f the HttpClient class exposes the headers that are sent with\\neach request, and the access token is \", \"added to the Authorization header prefixed with the string\\nBearer. When the request is sent to a RES\", \"Tful API, the value of the Authorization header is extracted\\nand validated to ensure that it\\u2019s sent \", \"from a trusted issuer and used to determine whether the user\\nhas permission to invoke the API that r\", \"eceives it.\\n\\n\\nFor more information about how the eShop multi-platform app makes web requests, see Ac\", \"cessing\\nremote data.\\n\\n### Summary\\n\\n\\nThere are many approaches to integrating authentication and auth\", \"orization into a .NET MAUI app that\\ncommunicates with an ASP.NET web application. The eShop multi-pl\", \"atform app performs\\nauthentication and authorization with a containerized identity microservice that\", \" uses IdentityServer.\\nIdentityServer is an open-source OpenID Connect and OAuth 2.0 framework for AS\", \"P.NET Core that\\nintegrates with ASP.NET Core Identity to perform bearer token authentication.\\n\\n\\nThe \", \"multi-platform app requests security tokens from IdentityServer to authenticate a user or access a\\nr\", \"esource. When accessing a resource, an access token must be included in the request to APIs that\\nreq\", \"uire authorization. IdentityServer\\u2019s middleware validates incoming access tokens to ensure that\\nthey\", \" are sent from a trusted issuer and that they are valid to be used with the API that receives them.\\n\", \"\\n\\n87 CHAPTER 11 | Authentication and authorization\\n\\n\\n**CHAPTER**\\n# 12\\n\\n## MVVM Toolkit Features\\n\\n###\", \" MVVM Toolkit\\n\\n\\nThe Model-View-ViewModel (MVVM) pattern is a great structural basis for creating our\", \" applications.\\nIn this pattern, the ViewModel becomes the backbone of our application as it provides\", \"\\ncommunication to our front-end user interface and backing components. To provide integration with\\nt\", \"he user interface, we will rely on the ViewModel\\u2019s properties and commands. As detailed in Updating\\n\", \"views in response to changes in the underlying view model or model, the INotifyPropertyChanged\\ninter\", \"face on our ViewModel to allows changes to our properties to notify when the value is changed.\\nImple\", \"menting all of these features means that our ViewModel can end up becoming very verbose. For\\nexample\", \", the following code shows a simple ViewModel with properties that raise changes:\\n\\n\\n88 CHAPTER 12 | \", \"MVVM Toolkit Features\\n\\n\\nWhile some optimizations could be made over time, we will still end up with \", \"a fairly verbose set of\\ncode for defining our ViewModel. This code can be difficult to maintain and \", \"becomes error-prone.\\n\\n\\n[The CommunityToolkit.Mvvm NuGet Package (aka MVVM Toolkit) can be used to he\", \"lp address and](https://docs.microsoft.com/dotnet/communitytoolkit/mvvm/)\\nsimplify these common MVVM\", \" patterns. The MVVM Toolkit, along with newer features to the .NET\\nlanguage, allows for simplified l\", \"ogic, easy adoption into a project, and runtime independence. The\\nexample below shows the same ViewM\", \"odel using components that come with the MVVM Toolkit:\\n\\n\\n\\n\\n\\nIn comparison to the original example, w\", \"e were able to drastically reduce the overall complexity and\\nsimplify the maintainability of our Vie\", \"wModel. The MVVM Toolkit comes with many pre-built common\\ncomponents and features, such as the Obser\", \"vableObject shown above, that simplifies and\\nstandardizes the code that we have throughout the appli\", \"cation.\\n\\n### ObservableObject\\n\\n\\nThe MVVM Toolkit provides ObservableObject which is intended for use\", \" as the base of our\\nViewModel objects or any object that needs to raise change notifications. It imp\", \"lements\\nINotifyPropertyChanged and INotifyPropertyChanging along with helper methods for setting\\npro\", \"perties and raising changes. Below is an example of a standard ViewModel using\\nObservableObject:\\n\\n\\n8\", \"9 CHAPTER 12 | MVVM Toolkit Features\\n\\n\\nObservableObject handles all of the logic needed for raising \", \"change notifications by using the\\nSetProperty method in your property setter. If you have a property\", \" that returns a Task<T>, the\\nSetPropertyAndNotifyOnCompletion method can be used to delay publishing\", \" a property change until\\nthe task has been completed. The methods OnPropertyChanged and OnPropertyCh\", \"anging that can\\nalso be used for raising property changes where needed in your object.\\n\\n\\n[For more d\", \"etailed information on ObservableObject, see ObservableObject](https://docs.microsoft.com/dotnet/com\", \"munitytoolkit/mvvm/observableobject) in the MVVM Toolkit\\nDeveloper Center.\\n\\n### RelayCommand and Asy\", \"ncRelayCommand\\n\\n\\nInteraction between .NET MAUI controls (for example, tapping a button or selecting \", \"an item from a\\ncollection) and the ViewModel is done with the ICommand interface. .NET MAUI comes wi\", \"th a default\\nimplementation of ICommand with the Command object. .NET MAUI\\u2019s Command is fairly basic\", \" and\\nlacks support for more advanced features, such as supporting asynchronous work and command\\nexec\", \"ution status.\\n\\n\\nThe MVVM Toolkit comes with two commands, RelayCommand and AsyncRelayCommand.\\nRelayC\", \"ommand is intended for situations where you have synchronous code to execute and has a\\nfairly simila\", \"r implementation to the .NET MAUI Command object.\\n\\n\\n\\n\\n\\nAsyncRelayCommand provides many additional fe\", \"atures when working with asynchronous workflows.\\nThis is quite common in our ViewModel as we are typ\", \"ically communicating with repositories, APIs,\\ndatabases, and other systems that utilize async/await.\", \" The AsyncRelayCommand constructor takes in\\nan execution task defined as a Func<Task> or a delegate \", \"returning Task as part of the constructor.\\nWhile the execution task is running, AsyncRelayCommand wi\", \"ll monitor the state of the task and\\nprovides updates using the IsRunning property. The IsRunning pr\", \"operty can be bound to the UI which\\nhelps manage control states such as showing loading with an Acti\", \"vityIndicator or disabling/enabling a\\ncontrol. While the execution task is being executed, the Cance\", \"l method can be called to attempt\\ncancellation of the execution task, if supported.\\n\\n\\nBy default, As\", \"yncRelayCommand doesn\\u2019t allow concurrent execution. This is very helpful in situations\\nwhere a user \", \"could unintentionally tap a control multiple times to execute a long-running or costly\\noperation. Du\", \"ring task execution, AsyncRelayCommand will automatically call the CanExecuteChanged\\nevent. In .NET \", \"MAUI, controls that support the Command and CommandParameter properties, such as\\nButton, will listen\", \" to this event and automatically enable or disable it during execution. This\\nfunctionality can be ov\", \"erridden by using a custom canExecute parameter or setting the\\nAsyncRelayCommandOptions.AllowConcurr\", \"entExecutions flag in the constructor.\\n\\n\\n90 CHAPTER 12 | MVVM Toolkit Features\\n\\n\\nFor more detailed i\", \"nformation on implementing commands, see the section Implementing commands\\nin the MVVM chapter. Deta\", \"iled information for the RelayCommand and AsyncRelayCommand is\\n[available in the Commanding of the M\", \"VVM Toolkit Developer Center.](https://docs.microsoft.com/dotnet/communitytoolkit/mvvm/relaycommand)\", \"\\n\\n### Source Generators\\n\\n\\nUsing the MVVM Toolkit components out-of-the-box allows you to greatly sim\", \"plify our ViewModel.\\n[The MVVM Toolkit allows you to simplify common code use cases even further by \", \"using Source](https://docs.microsoft.com/dotnet/csharp/roslyn-sdk/source-generators-overview)\\n[Gener\", \"ators. The MVVM Toolkit source generators look for specific attributes in our code and can](https://\", \"docs.microsoft.com/dotnet/csharp/roslyn-sdk/source-generators-overview)\\ngenerate wrappers for proper\", \"ties and commands.\\n\\n\\n\\n\\n\\nThe MVVM Toolkit ObservableProperty attribute can be applied to fields in ob\", \"jects that inherit from\\nObservableObject and will wrap a private field with a property that generate\", \"s changes. The following\\ncode shows an example of using the ObservableObject attribute on the _name \", \"field:\\n\\n\\nWith the ObservableProperty attribute applied to the _name field, the source generator will\", \" run and\\ngenerate another partial class with the following code:\\n\\n\\nThe generated SampleViewModel has\", \" used the private _name field and generated a new Name\\nproperty that implements all of the logic nee\", \"ded for raising change notifications.\\n\\n\\n91 CHAPTER 12 | MVVM Toolkit Features\\n\\n\\nThe MVVM Toolkit Rel\", \"ayCommand attribute can be applied to methods within an ObservableObject\\nand will create a correspon\", \"ding RelayCommand or AsyncRelayCommand. The following code shows\\nexamples of using the RelayCommand \", \"attribute:\\n\\n\\nThe RelayCommand applied to the Validate method will generate a RelayCommand validate\\nV\", \"alidateCommand because it has a void return and the SettingsAsync method will generate an\\nAsyncRelay\", \"Command named SettingsCommand. The source generator will generate the following\\ncode in other partia\", \"l classes:\\n\\n\\nAll of the complexity of wrapping our ViewModel\\u2019s methods with an ICommand implementati\", \"on has\\nbeen handled by the source generator.\\n\\n\\n[For more detailed information on MVVM Toolkit Source\", \" Generators, see MVVM source generators in](https://docs.microsoft.com/dotnet/communitytoolkit/mvvm/\", \"generators/overview)\\nthe MVVM Toolkit Developer Center.\\n\\n\\n92 CHAPTER 12 | MVVM Toolkit Features\\n\\n\\n##\", \"# Summary\\n\\nThe MVVM Toolkit is a great way to standardize and simplify our ViewModel code. The MVVM \", \"toolkit\\noffers great implementations of standard MVVM components such as ObservableObject and\\nAsync/\", \"RelayCommand. The source generators help simplify our ViewModel properties and commands\\nby generatin\", \"g all of the boilerplate code needed for user interface interactions. The MVVM Toolkit\\noffers even m\", \"ore features outside of what has been shown in this chapter. For more information on\\n[the MVVM Toolk\", \"it, see Introduction to the MVVM Toolkit](https://docs.microsoft.com/dotnet/communitytoolkit/mvvm/) \", \"in the MVVM Toolkit Developer Center.\\n\\n\\n93 CHAPTER 12 | MVVM Toolkit Features\\n\\n\\n**CHAPTER**\\n# 13\\n\\n##\", \" Unit testing\\n\\n\\nmulti-platform apps experience problems similar to both desktop and web-based applic\", \"ations. Mobile\\nusers will differ by their devices, network connectivity, availability of services, a\", \"nd various other factors.\\nTherefore, multi-platform apps should be tested as they would be used in t\", \"he real world to improve\\ntheir quality, reliability, and performance. Many types of testing should b\", \"e performed on an app,\\nincluding unit testing, integration testing, and user interface testing. Unit\", \" testing is the most common\\nform and essential to building high-quality applications.\\n\\n\\nA unit test \", \"takes a small unit of the app, typically a method, isolates it from the remainder of the code,\\nand v\", \"erifies that it behaves as expected. Its goal is to check that each unit of functionality performs a\", \"s\\nexpected, so errors don\\u2019t propagate throughout the app. Detecting a bug where it occurs is more\\nef\", \"ficient that observing the effect of a bug indirectly at a secondary point of failure.\\n\\n\\nUnit testin\", \"g has the most significant effect on code quality when it\\u2019s an integral part of the software\\ndevelop\", \"ment workflow. Unit tests can act as design documentation and functional specifications for\\nan appli\", \"cation. As soon as a method has been written, unit tests should be written that verify the\\nmethod\\u2019s \", \"behavior in response to standard, boundary, and incorrect input data cases and check any\\nexplicit or\", \" implicit assumptions made by the code. Alternatively, with test-driven development, unit\\ntests are \", \"written before the code. For more information on test-driven development and how to\\n[implement it, s\", \"ee Walkthrough: Test-driven development using Test Explorer.](https://docs.microsoft.com/visualstudi\", \"o/test/quick-start-test-driven-development-with-test-explorer)\\n\\n\\n\\n\\n\\nUnit tests typically use the arr\", \"ange-act-assert pattern:\\n\\n|Step|Description|\\n|---|---|\\n|Arrange|Initializes objects and sets the val\", \"ue of the data<br>that is passed to the method under test.|\\n|Act|Invokes the method under test with \", \"the required<br>arguments.|\\n|Assert|Verifies that the action of the method under test<br>behaves as \", \"expected.|\\n\\n\\n\\nThis pattern ensures that unit tests are readable, self-describing, and consistent.\\n\\n\\n\", \"94 CHAPTER 13 | Unit testing\\n\\n\\n### Dependency injection and unit testing\\n\\nOne of the motivations for\", \" adopting a loosely-coupled architecture is that it facilitates unit testing.\\nOne of the types regis\", \"tered with the dependency injection service is the IAppEnvironmentService\\ninterface. The following c\", \"ode example shows an outline of this class:\\n\\n\\nThe OrderDetailViewModel class has a dependency on the\", \" IAppEnvironmentService type, which the\\ndependency injection container resolves when it instantiates\", \" an OrderDetailViewModel object.\\nHowever, rather than create an IAppEnvironmentService object which \", \"utilizes real servers, devices and\\nconfigurations to unit test the OrderDetailViewModel class, inste\", \"ad, replace the\\nIAppEnvironmentService object with a mock object for the purpose of the tests. A moc\", \"k object is one\\nthat has the same signature of an object or an interface, but is created in a specif\", \"ic manner to help\\nwith unit testing. It is often used with dependency injection to provide specific \", \"implementations of\\ninterfaces for testing different data and workflow scenarios.\\n\\n\\nThis approach all\", \"ows the IAppEnvironmentService object to be passed into the OrderDetailViewModel\\nclass at runtime, a\", \"nd in the interests of testability, it allows a mock class to be passed into the\\nOrderDetailViewMode\", \"l class at test time. The main advantage of this approach is that it enables unit\\ntests to be execut\", \"ed without requiring unwieldy resources such as runtime platform features, web\\nservices, or database\", \"s.\\n\\n### Testing MVVM applications\\n\\n\\nTesting models and view models from MVVM applications is identic\", \"al to testing any other class, and\\nuses the same tools and techniques; this includes features such a\", \"s unit testing and mocking. However,\\nsome patterns that are typical to model and view model classes \", \"can benefit from specific unit testing\\ntechniques.\\n\\n\\n\\n\\n\\n[Unit testing best practices with .NET for m\", \"ore best practices.](https://docs.microsoft.com/dotnet/core/testing/unit-testing-best-practices)\\n\\n\\n9\", \"5 CHAPTER 13 | Unit testing\\n\\n\\nDon\\u2019t be tempted to make a unit test exercise more than one aspect of \", \"the unit\\u2019s behavior. Doing so\\nleads to tests that are difficult to read and update. It can also lead\", \" to confusion when interpreting a\\nfailure.\\n\\n\\n[The eShop multi-platform app uses MSTest](https://docs\", \".microsoft.com/dotnet/core/testing/unit-testing-with-mstest) to perform unit testing, which supports\", \" two different\\ntypes of unit tests:\\n\\n|Testing Type|Attribute|Description|\\n|---|---|---|\\n|TestMethod|\", \"TestMethod|Defines the actual test method to run..|\\n|DataSource|DataSource|Tests that are only true \", \"for a particular set of data.|\\n\\n\\n\\nThe unit tests included with the eShop multi-platform app are Test\", \"Method, so each unit test method\\nis decorated with the TestMethod attribute. In addition to MSTest t\", \"here are several other testing\\n[frameworks available including NUnit](https://docs.microsoft.com/dot\", \"net/core/testing/unit-testing-with-nunit) [and xUnit.](https://docs.microsoft.com/dotnet/core/testin\", \"g/unit-testing-with-dotnet-test)\\n\\n### Testing asynchronous functionality\\n\\n\\nWhen implementing the MVV\", \"M pattern, view models usually invoke operations on services, often\\nasynchronously. Tests for code t\", \"hat invokes these operations typically use mocks as replacements for\\nthe actual services. The follow\", \"ing code example demonstrates testing asynchronous functionality by\\npassing a mock service into a vi\", \"ew model:\\n\\n\\nThis unit test checks that the Order property of the OrderDetailViewModel instance will \", \"have a value\\nafter the InitializeAsync method has been invoked. The InitializeAsync method is invoke\", \"d when the\\nview model\\u2019s corresponding view is navigated to. For more information about navigation, s\", \"ee\\nNavigation.\\n\\n\\nWhen the OrderDetailViewModel instance is created, it expects an IOrderService inst\", \"ance to be\\nspecified as an argument. However, the OrderService retrieves data from a web service. Th\", \"erefore, an\\nOrderMockService instance, a mock version of the OrderService class, is specified as the\", \" argument to\\nthe OrderDetailViewModel constructor. Then, mock data is retrieved rather than communic\", \"ating with\\na web service when the view model\\u2019s InitializeAsync method is invoked, which uses IOrderS\", \"ervice\\noperations.\\n\\n\\n96 CHAPTER 13 | Unit testing\\n\\n\\n### Testing INotifyPropertyChanged implementatio\", \"ns\\n\\nImplementing the INotifyPropertyChanged interface allows views to react to changes that originat\", \"e\\nfrom view models and models. These changes are not limited to data shown in controls \\u2013 they are al\", \"so\\nused to control the view, such as view model states that cause animations to be started or contro\", \"ls to\\nbe disabled.\\n\\n\\nProperties that can be updated directly by the unit test can be tested by attac\", \"hing an event handler to\\nthe PropertyChanged event and checking whether the event is raised after se\", \"tting a new value for the\\nproperty. The following code example shows such a test:\\n\\n\\nThis unit test i\", \"nvokes the InitializeAsync method of the OrderViewModel class, which causes its Order\\nproperty to be\", \" updated. The unit test will pass, provided that the PropertyChanged event is raised for\\nthe Order p\", \"roperty.\\n\\n### Testing message-based communication\\n\\n\\nView models that use the MessagingCenter class t\", \"o communicate between loosely coupled classes\\ncan be unit tested by subscribing to the message being\", \" sent by the code under test, as demonstrated\\nin the following code example:\\n\\n\\n97 CHAPTER 13 | Unit \", \"testing\\n\\n\\nThis unit test checks that the CatalogViewModel publishes the AddProduct message in respon\", \"se to its\\nAddCatalogItemCommand being executed. Because the MessagingCenter class supports multicast\", \"\\nmessage subscriptions, the unit test can subscribe to the AddProduct message and execute a callback\", \"\\ndelegate in response to receiving it. This callback delegate, specified as a lambda expression, set\", \"s a\\nboolean field that\\u2019s used by the Assert statement to verify the behavior of the test.\\n\\n### Testi\", \"ng exception handling\\n\\n\\nUnit tests can also be written that check that specific exceptions are throw\", \"n for invalid actions or\\ninputs, as demonstrated in the following code example:\\n\\n\\nThis unit test wil\", \"l throw an exception because the ListView control does not have an event named\\nOnItemTapped. The Ass\", \"ert.Throws<T> method is a generic method where T is the type of the\\nexpected exception. The argument\", \" passed to the Assert.Throws<T> method is a lambda expression\\nthat will throw the exception. Therefo\", \"re, the unit test will pass provided that the lambda expression\\nthrows an ArgumentException.\\n\\n\\n\\n\\n###\", \" Testing validation\\n\\nThere are two aspects to testing the validation implementation: testing that an\", \"y validation rules are\\ncorrectly implemented and testing that the ValidatableObject<T> class perform\", \"s as expected.\\n\\n\\nValidation logic is usually simple to test, because it is typically a self-containe\", \"d process where the\\noutput depends on the input. There should be tests on the results of invoking th\", \"e Validate method on\\neach property that has at least one associated validation rule, as demonstrated\", \" in the following code\\nexample:\\n\\n\\n98 CHAPTER 13 | Unit testing\\n\\n\\nThis unit test checks that validati\", \"on succeeds when the two ValidatableObject<T> properties in the\\nMockViewModel instance both have dat\", \"a.\\n\\n\\nAs well as checking that validation succeeds, validation unit tests should also check the value\", \"s of the\\nValue, IsValid, and Errors property of each ValidatableObject<T> instance, to verify that t\", \"he class\\nperforms as expected. The following code example demonstrates a unit test that does this:\\n\\n\", \"\\nThis unit test checks that validation fails when the Surname property of the MockViewModel doesn\\u2019t\\n\", \"have any data, and the Value, IsValid, and Errors property of each ValidatableObject<T> instance are\", \"\\ncorrectly set.\\n\\n### Summary\\n\\n\\nA unit test takes a small unit of the app, typically a method, isolat\", \"es it from the remainder of the code,\\nand verifies that it behaves as expected. Its goal is to check\", \" that each unit of functionality performs as\\nexpected, so errors don\\u2019t propagate throughout the app.\", \"\\n\\n\\nThe behavior of an object under test can be isolated by replacing dependent objects with mock\\nobj\", \"ects that simulate the behavior of the dependent objects. This enables unit tests to be executed\\nwit\", \"hout requiring unwieldy resources such as runtime platform features, web services, or databases\\n\\n\\nTe\", \"sting models and view models from MVVM applications is identical to testing any other classes, and\\nt\", \"he same tools and techniques can be used.\\n\\n\\n99 CHAPTER 13 | Unit testing\\n\\n\\n\"]"