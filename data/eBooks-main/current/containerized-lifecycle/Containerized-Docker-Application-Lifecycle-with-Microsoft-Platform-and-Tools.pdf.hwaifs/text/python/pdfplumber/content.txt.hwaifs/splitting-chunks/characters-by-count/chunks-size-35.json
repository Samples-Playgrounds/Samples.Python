"[\"EDITION v6.0.0 - Updated to ASP.NET Core 6.0\\nRefer changelog for the book updates and community cont\", \"ributions.\\nThis guide is a general overview for developing and deploying containerized ASP.NET Core\\n\", \"applications with Docker, using the Microsoft platform and tools. The guide includes a high-level\\nin\", \"troduction to Azure DevOps, for implementing CI/CD pipelines, as well as Azure Container Registry\\n(A\", \"CR) and Azure Kubernetes Services AKS for deployment.\\nFor low-level, development-related details you\", \" can see the .NET Microservices: Architecture for\\nContainerized .NET Applications guide and it relat\", \"ed reference application eShopOnContainers.\\nCredits\\nAuthor:\\nCesar de la Torre, Sr. PM, .NET product \", \"team, Microsoft Corp.\\nAcquisitions Editor:\\nJanine Patrick\\nDevelopmental Editor:\\nBob Russell, Solutio\", \"ns Professional at Microsoft\\nOctal Publishing, Inc.\\nEditorial Production:\\nDianne Russell\\nOctal Publi\", \"shing, Inc.\\nCopyeditor:\\nBob Russell, Solutions Professional at Microsoft\\nParticipants and reviewers:\", \"\\nNish Anil, Sr. Program Manager, .NET team, Microsoft\\nMiguel Veloso, Software Development Engineer a\", \"t Plain Concepts\\nSumit Ghosh, Principal Consultant at Neudesic\\nColin Dembovsky, DevOps Practice Lead\", \", Cognizant Microsoft Business Group\\nCopyright\\nPUBLISHED BY\\nMicrosoft Developer Division, .NET and V\", \"isual Studio product teams\\nA division of Microsoft CorporationOne Microsoft Way\\nRedmond, Washington \", \"98052-6399\\nCopyright \\u00a9 2022 by Microsoft Corporation\\nAll rights reserved. No part of the contents of\", \" this book may be reproduced or transmitted in any\\nform or by any means without the written permissi\", \"on of the publisher.\\nThis book is provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. Th\", \"e views, opinions, and\\ninformation expressed in this book, including URL and other Internet website \", \"references, may change\\nwithout notice.\\nSome examples depicted herein are provided for illustration o\", \"nly and are fictitious. No real association\\nor connection is intended or should be inferred.\\nMicroso\", \"ft and the trademarks listed at https://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are\\ntrademarks\", \" of the Microsoft group of companies.\\nMac and macOS are trademarks of Apple Inc.\\nThe Docker whale lo\", \"go is a registered trademark of Docker, Inc. Used by permission.\\nAll other marks and logos are prope\", \"rty of their respective owners.Contents\\nOverview of Containers and Docker ..........................\", \"............................................................ 1\\nLearn Docker ........................\", \"....................................................................................................\", \".................................................. 2\\nComparing Docker containers with virtual machin\", \"es ........................................................................................... 3\\nA s\", \"imple analogy ......................................................................................\", \"........................................................................... 4\\nLearn Docker specific \", \"terminologies ......................................................................................\", \".......................................... 4\\nLearn docker containers, images, and registries .......\", \".................................................................................................. 6\", \"\\nRoad to modern applications based on containers ...................................................\", \"................................................ 8\\nIntroduction to the Docker application life cycle\", \" ................................................................ 9\\nContainers as the foundation for\", \" DevOps collaboration ..............................................................................\", \"........... 9\\nChallenges in the application life cycle when using Docker. ..........................\", \"................................................ 10\\nIntroduction to a generic end-to-end Docker appl\", \"ication life cycle workflow ....................................... 11\\nBenefits of DevOps for contai\", \"nerized applications ...............................................................................\", \"............. 12\\nIntroduction to the Microsoft platform and tools for containerized apps ...........\", \".......... 13\\nDesigning and developing containerized apps using Docker and Microsoft Azure ...... 17\", \"\\nDesign Docker applications ........................................................................\", \"...................................................................... 17\\nCommon container design pr\", \"inciples ...........................................................................................\", \"................................ 18\\nContainer equals a process .....................................\", \"....................................................................................................\", \". 18\\nMonolithic applications .......................................................................\", \"............................................................................... 18\\nMonolithic applic\", \"ation deployed as a container ......................................................................\", \"........................... 21\\nPublish a single Docker container app to Azure App Service ..........\", \".............................................................. 21\\nState and data in Docker applicati\", \"ons.................................................................................................\", \"......................... 22\\nService-oriented applications .........................................\", \"................................................................................................. 25\", \"\\nOrchestrating microservices and multi-container applications for high scalability and availability.\", \"... 25\\nSoftware platforms for container clustering, orchestration, and scheduling ..................\", \"......................... 27\\nUsing container-based orchestrators in Azure ..........................\", \"........................................................................... 28\\nUsing Azure Kubernete\", \"s Service ..........................................................................................\", \"...................................... 29\\nDevelopment environment for Kubernetes ...................\", \"........................................................................................ 30\\nGet star\", \"ted with Azure Kubernetes Service (AKS) ............................................................\", \"................................... 31\\ni ContentsDeploy with Helm charts into Kubernetes clusters ..\", \"........................................................................................... 31\\nAddit\", \"ional resources ....................................................................................\", \"................................................................... 32\\nUsing Azure Service Fabric ..\", \"....................................................................................................\", \"..................................... 32\\nStateless versus stateful microservices ...................\", \"................................................................................................. 35\", \"\\nUsing Azure Service Fabric Mesh ...................................................................\", \"............................................................ 36\\nChoosing orchestrators in Azure ....\", \"....................................................................................................\", \"....................... 37\\nDeploy to Azure Kubernetes Service (AKS) ................................\", \"................................................................................ 38\\nCreate the AKS e\", \"nvironment in Azure ................................................................................\", \"..................................... 38\\nCreate the AKS cluster ....................................\", \"....................................................................................................\", \"............ 38\\nDevelopment environment for Docker apps ............................................\", \"................................................................. 40\\nDevelopment tools choices: IDE \", \"or editor ..........................................................................................\", \".................... 40\\nLanguage and framework choices .............................................\", \"............................................................................... 41\\nInner-loop develo\", \"pment workflow for Docker apps .....................................................................\", \"......................... 41\\nBuilding a single app within a Docker container using Visual Studio Cod\", \"e and Docker CLI............. 42\\nUse Docker Tools in Visual Studio on Windows ......................\", \"................................................................................. 52\\nConfigure your \", \"local environment ..................................................................................\", \".......................................... 52\\nDocker support in Visual Studio ......................\", \"....................................................................................................\", \"...... 52\\nConfigure Docker tools ...................................................................\", \"............................................................................... 55\\nUsing Windows Pow\", \"erShell commands in a DockerFile to set up Windows Containers (Docker\\nstandard based) ..............\", \"....................................................................................................\", \"................................................... 56\\nBuild ASP.NET Core applications deployed as L\", \"inux containers into an AKS/Kubernetes orchestrator\\n................................................\", \"....................................................................................................\", \".................................................. 57\\nCreating the ASP.NET Core Project using Visual\", \" Studio 2022........................................................................ 57\\nRegister the\", \" Solution in an Azure Container Registry (ACR) .....................................................\", \"..................... 66\\nDocker application DevOps workflow with Microsoft tools ...................\", \".......................... 74\\nSteps in the outer-loop DevOps workflow for a Docker application .....\", \".......................................................... 75\\nStep 1: Inner-loop development workflo\", \"w ..................................................................................................\", \".......... 76\\nStep 2: Source-Code Control integration and management with Azure DevOps Services and \", \"Git 76\\nStep 3: Build, CI, Integrate, and Test with Azure DevOps Services/GitHub and Docker .........\", \"............. 76\\nStep 4: CD, Deploy ................................................................\", \"........................................................................................... 83\\nStep \", \"5: Run and manage ..................................................................................\", \"............................................................. 89\\nStep 6: Monitor and diagnose ......\", \"....................................................................................................\", \".......................... 89\\nii ContentsCreate CI/CD pipelines in Azure DevOps Services for a .NET \", \"application on Containers and\\ndeploying to a Kubernetes cluster ....................................\", \"............................................................................................. 89\\nRun\", \", manage, and monitor Docker production environments ........................................ 93\\nRun\", \" composed and microservices-based applications in production environments ..........................\", \"..... 93\\nIntroduction to orchestrators, schedulers, and container clusters .........................\", \"...................................... 93\\nManage production Docker environments ....................\", \"............................................................................................ 94\\nCont\", \"ainer Service and management tools .................................................................\", \"............................................ 94\\nAzure Service Fabric ...............................\", \"....................................................................................................\", \"..................... 95\\nMonitor containerized application services ................................\", \"............................................................................... 96\\nAzure Monitor ...\", \"....................................................................................................\", \"............................................................ 96\\nSecurity and backup services........\", \"....................................................................................................\", \"........................... 96\\nContainerized Docker Application Lifecycle key takeaways ............\", \"................................. 98\\niii Contents1\\nCHAPTER\\nOverview of Containers\\nand Docker\\nContain\", \"erization is an approach to software development in which an application or service, its\\ndependencie\", \"s, and its configuration (abstracted as deployment manifest files) are packaged together as\\na contai\", \"ner image. You then can test the containerized application as a unit and deploy it as a container\\nim\", \"age instance to the host operating system (OS).\\nJust as shipping containers allow goods to be transp\", \"orted by ship, train, or truck regardless of the\\ncargo inside, software containers act as a standard\", \" unit of software deployment that can contain\\ndifferent code and dependencies. Containerizing softwa\", \"re this way enables developers and IT\\nprofessionals to deploy them across environments with little o\", \"r no modification.\\nContainers also isolate applications from each other on a shared OS. Containerize\", \"d applications run\\non top of a container host that in turn runs on the OS (Linux or Windows). Contai\", \"ners therefore have a\\nmuch smaller footprint than virtual machine (VM) images.\\nEach container can ru\", \"n a whole web application or a service, as shown in Figure 1-1. In this example,\\nDocker host is a co\", \"ntainer host, and App1, App2, Svc1, and Svc2 are containerized applications or\\nservices.\\nFigure 1-1.\", \" Multiple containers running on a container host\\nAnother benefit you can derive from containerizatio\", \"n is scalability. You can scale out quickly by\\ncreating new containers for short-term tasks. From an\", \" application point of view, instantiating an\\nimage (creating a container) is similar to instantiatin\", \"g a process like a service or web app. For\\nreliability, however, when you run multiple instances of \", \"the same image across multiple host servers,\\nyou typically want each container (image instance) to r\", \"un in a different host server or VM in different\\nfault domains.\\nIn short, containers offer the benef\", \"its of isolation, portability, agility, scalability, and control across the\\nentire application lifec\", \"ycle workflow. The most important benefit is the environment isolation\\nprovided between Dev and Ops.\", \"\\n1 CHAPTER 1 | Overview of Containers and DockerLearn Docker\\nDocker is an open-source project for au\", \"tomating the deployment of applications as portable, self-\\nsufficient containers that can run on the\", \" cloud or on-premises. Docker is also a company that\\npromotes and evolves this technology, working i\", \"n collaboration with cloud, Linux, and Windows\\nvendors, including Microsoft.\\nFigure 1-2. Docker depl\", \"oys containers at all layers of the hybrid cloud\\nAs shown in the above diagram, Docker containers ca\", \"n run anywhere, on-premises in the customer\\ndatacenter, in an external service provider or in the cl\", \"oud, on Azure. Docker image containers can also\\nrun natively on Linux and Windows. However, Windows \", \"images can run only on Windows hosts and\\nLinux images can run on Linux hosts and Windows hosts (usin\", \"g a Hyper-V Linux VM, so far), where\\nhost means a server or a VM.\\nDevelopers can use development env\", \"ironments on Windows, Linux, or macOS. On the development\\ncomputer, the developer runs a Docker host\", \" where Docker images are deployed, including the app\\nand its dependencies. Developers who work on Li\", \"nux or on the Mac, use a Docker host that\\u2019s Linux-\\nbased, and they can only create images for Linux \", \"containers. (Developers working on the Mac can edit\\ncode or run the Docker command-line interface (C\", \"LI) from macOS, but as of this writing, containers\\ndon\\u2019t run directly on macOS.) Developers who work\", \" on Windows can create images for either Linux or\\nWindows Containers.\\nTo host containers in developm\", \"ent environments and provide additional developer tools, Docker\\nships Docker Desktop for Windows or \", \"for macOS. These products install the necessary VM (the Docker\\nhost) to host the containers.\\nTo run \", \"Windows Containers, there are two types of runtimes:\\n\\u2022 Windows Server Containers provide application\", \" isolation through process and namespace\\nisolation technology. A Windows Server Container shares a k\", \"ernel with the container host and\\nwith all containers running on the host.\\n\\u2022 Hyper-V Containers expa\", \"nd on the isolation provided by Windows Server Containers by\\nrunning each container in a highly opti\", \"mized virtual machine. In this configuration, the kernel\\nof the container host isn\\u2019t shared with the\", \" Hyper-V Containers, providing better isolation.\\n2 CHAPTER 1 | Overview of Containers and DockerThe \", \"images for these containers are created and work just the same way. The difference is in how the\\ncon\", \"tainer is created from the image\\u2014running a Hyper-V Container requires an extra parameter. For\\ndetail\", \"s, see Hyper-V Containers.\\nComparing Docker containers with virtual machines\\nFigure 1-3 shows a comp\", \"arison between VMs and Docker containers.\\nFigure 1-3. Comparison of traditional virtual machines to \", \"Docker containers\\nAs shown in the above diagram, for VMs, there are three base layers in the host se\", \"rver. From the\\nbottom-up: Infrastructure, Host Operating System, and a Hypervisor. On top of all tha\", \"t, each VM has\\nits own OS and all necessary libraries. On the other hand, for Docker, the host serve\", \"r only has the\\nInfrastructure and the OS. On top of that, the container engine keeps containers isol\", \"ated, but lets\\nthem share the single base OS\\u2019s services.\\nBecause containers require far fewer resour\", \"ces (for example, they don\\u2019t need a full OS), they\\u2019re easy to\\ndeploy and they start fast. This allow\", \"s you to have higher density, meaning that it allows you to run\\nmore services on the same hardware u\", \"nit, thereby reducing costs.\\nAs a side effect of running on the same kernel, you get less isolation \", \"than VMs.\\nThe main goal of an image is to ensure the same environment (dependencies) across differen\", \"t\\ndeployments. This means that you can debug it on your machine and then deploy it to another\\nmachin\", \"e, the same environment guaranteed.\\nA container image is a way to package an app or service and depl\", \"oy it in a reliable and reproducible\\nway. You could say that Docker isn\\u2019t only a technology but also\", \" a philosophy and a process.\\n3 CHAPTER 1 | Overview of Containers and DockerWhen using Docker, you w\", \"on\\u2019t hear developers say, \\u201cIt works on my machine, why not in production?\\u201d\\nThey can just say, \\u201cIt ru\", \"ns on Docker\\u201d, because the packaged Docker application can be executed on\\nany supported Docker envir\", \"onment, and it runs the way it was intended to on all deployment targets\\n(such as Dev, QA, staging, \", \"and production).\\nA simple analogy\\nPerhaps a simple analogy can help getting the grasp of the core co\", \"ncept of Docker.\\nLet\\u2019s go back in time to the 1950s for a moment. There were no word processors, and\", \" the\\nphotocopiers were used everywhere (well, kind of).\\nImagine you\\u2019re responsible for quickly issui\", \"ng batches of letters as required, to mail them to\\ncustomers, using real paper and envelopes, to be \", \"delivered physically to each customer\\u2019s address\\n(there was no email back then).\\nAt some point, you r\", \"ealize the letters are just a composition of a large set of paragraphs, which are\\npicked and arrange\", \"d as needed, according to the purpose of the letter, so you devise a system to\\nissue letters quickly\", \", expecting to get a hefty raise.\\nThe system is simple:\\n1. You begin with a deck of transparent shee\", \"ts containing one paragraph each.\\n2. To issue a set of letters, you pick the sheets with the paragra\", \"phs you need, then you stack and\\nalign them so they look and read fine.\\n3. Finally, you place the se\", \"t in the photocopier and press start to produce as many letters as\\nrequired.\\nSo, simplifying, that\\u2019s\", \" the core idea of Docker.\\nIn Docker, each layer is the resulting set of changes that happen to the f\", \"ilesystem after executing a\\ncommand, such as, installing a program.\\nSo, when you \\u201clook\\u201d at the files\", \"ystem after the layer has been copied, you see all the files, included the\\nlayer when the program wa\", \"s installed.\\nYou can think of an image as an auxiliary read-only hard disk ready to be installed in \", \"a \\u201ccomputer\\u201d\\nwhere the operating system is already installed.\\nSimilarly, you can think of a containe\", \"r as the \\u201ccomputer\\u201d with the image hard disk installed. The\\ncontainer, just like a computer, can be \", \"powered on or off.\\nLearn Docker specific terminologies\\nThis section lists terms and definitions you \", \"should be familiar with before getting deeper into Docker.\\nFor further definitions, see the extensiv\", \"e glossary provided by Docker.\\nContainer image: A package with all the dependencies and information \", \"needed to create a container.\\nAn image includes all the dependencies (such as frameworks) plus deplo\", \"yment and execution\\n4 CHAPTER 1 | Overview of Containers and Dockerconfiguration to be used by a con\", \"tainer runtime. Usually, an image derives from multiple base images\\nthat are layers stacked on top o\", \"f each other to form the container\\u2019s filesystem. An image is immutable\\nonce it has been created.\\nDoc\", \"kerfile: A text file that contains instructions for building a Docker image. It\\u2019s like a batch scrip\", \"t,\\nthe first line states the base image to begin with and then follow the instructions to install re\", \"quired\\nprograms, copy files, and so on, until you get the working environment you need.\\nBuild: The a\", \"ction of building a container image based on the information and context provided by its\\nDockerfile,\", \" plus additional files in the folder where the image is built. You can build images with the\\nfollowi\", \"ng Docker command:\\ndocker build\\nContainer: An instance of a Docker image. A container represents the\", \" execution of a single\\napplication, process, or service. It consists of the contents of a Docker ima\", \"ge, an execution\\nenvironment, and a standard set of instructions. When scaling a service, you create\", \" multiple instances\\nof a container from the same image. Or a batch job can create multiple container\", \"s from the same\\nimage, passing different parameters to each instance.\\nVolumes: Offer a writable file\", \"system that the container can use. Since images are read-only but most\\nprograms need to write to the\", \" filesystem, volumes add a writable layer, on top of the container image,\\nso the programs have acces\", \"s to a writable filesystem. The program doesn\\u2019t know it\\u2019s accessing a\\nlayered filesystem, it\\u2019s just \", \"the filesystem as usual. Volumes live in the host system and are managed\\nby Docker.\\nTag: A mark or l\", \"abel you can apply to images so that different images or versions of the same image\\n(depending on th\", \"e version number or the target environment) can be identified.\\nMulti-stage Build: Is a feature, sinc\", \"e Docker 17.05 or higher, that helps to reduce the size of the final\\nimages. For example, a large ba\", \"se image, containing the SDK can be used for compiling and\\npublishing and then a small runtime-only \", \"base image can be used to host the application.\\nRepository (repo): A collection of related Docker im\", \"ages, labeled with a tag that indicates the image\\nversion. Some repos contain multiple variants of a\", \" specific image, such as an image containing SDKs\\n(heavier), an image containing only runtimes (ligh\", \"ter), etc. Those variants can be marked with tags. A\\nsingle repo can contain platform variants, such\", \" as a Linux image and a Windows image.\\nRegistry: A service that provides access to repositories. The\", \" default registry for most public images is\\nDocker Hub (owned by Docker as an organization). A regis\", \"try usually contains repositories from\\nmultiple teams. Companies often have private registries to st\", \"ore and manage images they\\u2019ve created.\\nAzure Container Registry is another example.\\nMulti-arch image\", \": For multi-architecture, it\\u2019s a feature that simplifies the selection of the appropriate\\nimage, acc\", \"ording to the platform where Docker is running. For example, when a Dockerfile requests a\\nbase image\", \" FROM mcr.microsoft.com/dotnet/sdk:6.0 from the registry, it actually gets 6.0-\\nnanoserver-20H2, 6.0\", \"-nanoserver-1809 or 6.0-bullseye-slim, depending on the operating system\\nand version where Docker is\", \" running.\\n5 CHAPTER 1 | Overview of Containers and DockerDocker Hub: A public registry to upload ima\", \"ges and work with them. Docker Hub provides Docker\\nimage hosting, public or private registries, buil\", \"d triggers and web hooks, and integration with GitHub\\nand Bitbucket.\\nAzure Container Registry: A pub\", \"lic resource for working with Docker images and its components in\\nAzure. This provides a registry th\", \"at\\u2019s close to your deployments in Azure and that gives you control\\nover access, making it possible t\", \"o use your Azure Active Directory groups and permissions.\\nDocker Trusted Registry (DTR): A Docker re\", \"gistry service (from Docker) that can be installed on-\\npremises so it lives within the organization\\u2019\", \"s datacenter and network. It\\u2019s convenient for private\\nimages that should be managed within the enter\", \"prise. Docker Trusted Registry is included as part of\\nthe Docker Datacenter product.\\nDocker Desktop:\", \" Development tools for Windows and macOS for building, running, and testing\\ncontainers locally. Dock\", \"er Desktop for Windows provides development environments for both Linux\\nand Windows Containers. The \", \"Linux Docker host on Windows is based on a Hyper-V virtual machine.\\nThe host for Windows Containers \", \"is directly based on Windows. Docker Desktop for Mac is based on\\nthe Apple Hypervisor framework and \", \"the xhyve hypervisor, which provides a Linux Docker host virtual\\nmachine on macOS. Docker Desktop fo\", \"r Windows and for Mac replaces Docker Toolbox, which was\\nbased on Oracle VirtualBox.\\nCompose: A comm\", \"and-line tool and YAML file format with metadata for defining and running multi-\\ncontainer applicati\", \"ons. You define a single application based on multiple images with one or more\\n.yml files that can o\", \"verride values depending on the environment. After you\\u2019ve created the definitions,\\nyou can deploy th\", \"e whole multi-container application with a single command (docker-compose up)\\nthat creates a contain\", \"er per image on the Docker host.\\nCluster: A collection of Docker hosts exposed as if it were a singl\", \"e virtual Docker host, so that the\\napplication can scale to multiple instances of the services sprea\", \"d across multiple hosts within the\\ncluster. Docker clusters can be created with Kubernetes, Azure Se\", \"rvice Fabric, Docker Swarm and\\nMesosphere DC/OS.\\nOrchestrator: A tool that simplifies the management\", \" of clusters and Docker hosts. Orchestrators\\nenable you to manage their images, containers, and host\", \"s through a command-line interface (CLI) or a\\ngraphical UI. You can manage container networking, con\", \"figurations, load balancing, service discovery,\\nhigh availability, Docker host configuration, and mo\", \"re. An orchestrator is responsible for running,\\ndistributing, scaling, and healing workloads across \", \"a collection of nodes. Typically, orchestrator\\nproducts are the same products that provide cluster i\", \"nfrastructure, like Kubernetes and Azure Service\\nFabric, among other offerings in the market.\\nLearn \", \"docker containers, images, and registries\\nWhen using Docker, you create an app or service and packag\", \"e it and its dependencies into a\\ncontainer image. An image is a static representation of the app or \", \"service and its configuration and\\ndependencies.\\nTo run the app or service, the app\\u2019s image is instan\", \"tiated to create a container, which will be running\\non the Docker host. Containers are initially tes\", \"ted in a development environment or PC.\\n6 CHAPTER 1 | Overview of Containers and DockerYou store ima\", \"ges in a registry that acts as a library of images. You need a registry when deploying to\\nproduction\", \" orchestrators. Docker maintains a public registry via Docker Hub; other vendors provide\\nregistries \", \"for different collections of images, including Azure Container Registry. Alternatively,\\nenterprises \", \"can have a private registry on-premises for their own Docker images.\\nFigure 1-4 shows how images and\", \" registries in Docker relate to other components. It also shows the\\nmultiple registry offerings from\", \" vendors.\\nFigure 1-4. Taxonomy of Docker terms and concepts\\nThe registry is like a bookshelf where i\", \"mages are stored and available to be pulled for building\\ncontainers to run services or web apps. The\", \"re are private Docker registries on-premises and on the\\npublic cloud. Docker Hub is a public registr\", \"y maintained by Docker, along the Docker Trusted Registry\\nan enterprise-grade solution, Azure offers\", \" the Azure Container Registry. AWS, Google and others also\\nhave container registries.\\nBy putting ima\", \"ges in a registry, you can store static and immutable application bits, including all\\nof their depen\", \"dencies, at a framework level. You then can version and deploy images in multiple\\nenvironments and t\", \"hus provide a consistent deployment unit.\\n7 CHAPTER 1 | Overview of Containers and DockerPrivate ima\", \"ge registries, either hosted on-premises or in the cloud, are recommended when:\\n\\u2022 Your images must n\", \"ot be shared publicly due to confidentiality.\\n\\u2022 You want to have minimum network latency between you\", \"r images and your chosen\\ndeployment environment. For example, if your production environment is Azur\", \"e, you probably\\nwant to store your images in Azure Container Registry so that network latency is min\", \"imal. In a\\nsimilar way, if your production environment is on-premises, you might want to have an on-\", \"\\npremises Docker Trusted Registry available within the same local network.\\nRoad to modern applicatio\", \"ns based on containers\\nYou\\u2019re probably reading this book because you\\u2019re planning the development of \", \"new applications or\\nyou\\u2019re assessing the impact of using Docker, Containers, and new approaches like\", \" Microservices in\\nyour company.\\nThe adoption of new development paradigms must be taken with caution\", \" before starting a project, to\\nassess the impact on your dev teams, your budget, or your infrastruct\", \"ure.\\nMicrosoft has been working on rich guidance, sample applications, and a suite of e-books that c\", \"an\\nhelp you make an informed decision and guide your team through a successful development,\\ndeployme\", \"nt, and operations of your new applications.\\nThis book belongs to a Microsoft suite of guides that c\", \"over many of the needs and challenges you\\u2019ll\\nface during the process of developing new modern applic\", \"ations based on containers.\\nYou can find additional Microsoft e-books related to Docker containers i\", \"n the list below:\\n\\u2022 .NET Microservices: Architecture for Containerized .NET Applications\\nhttps://lea\", \"rn.microsoft.com/dotnet/architecture/microservices/\\n\\u2022 Modernize existing .NET applications with Azur\", \"e cloud and Windows Containers\\nhttps://learn.microsoft.com/dotnet/architecture/modernize-with-azure-\", \"containers/\\n8 CHAPTER 1 | Overview of Containers and Docker2\\nCHAPTER\\nIntroduction to the Docker\\nappl\", \"ication life cycle\\nThe life cycle of containerized applications is a journey that begins with the de\", \"veloper. The developer\\nchooses to implement containers and Docker because it eliminates frictions in\", \" deployments and IT\\noperations, which ultimately helps everyone to be more agile, more productive en\", \"d-to-end, and faster.\\nContainers as the foundation for DevOps\\ncollaboration\\nBy the very nature of th\", \"e containers and Docker technology, developers can share their software and\\ndependencies easily with\", \" IT operations and production environments while eliminating the typical \\u201cit\\nworks on my machine\\u201d ex\", \"cuse. Containers solve application conflicts between different environments.\\nIndirectly, containers \", \"and Docker bring developers and IT operations closer together, making it easier\\nfor them to collabor\", \"ate effectively. Adopting the container workflow provides many customers\\nwith the DevOps continuity \", \"they\\u2019ve sought but previously had to implement via more complex\\nconfiguration for release and build \", \"pipelines. Containers simplify the build/test/deploy pipelines\\nin DevOps.\\nFigure 2-1. Main workloads\", \" per \\u201cpersonas\\u201d in the life cycle for containerized Docker applications\\nWith Docker containers, deve\", \"lopers own what\\u2019s within the container (application and service, and\\ndependencies to frameworks and \", \"components) and how the containers and services behave together\\nas an application composed by a coll\", \"ection of services. The interdependencies of the multiple\\ncontainers are defined in a docker-compose\", \".yml file, or what could be called a deployment manifest.\\nMeanwhile, IT operations teams (IT profess\", \"ionals and management) can focus on the management\\n9 CHAPTER 2 | Introduction to the Docker applicat\", \"ion life cycleof production environments; infrastructure; scalability; monitoring; and, ultimately, \", \"ensuring that the\\napplications are delivering properly for the end users, without having to know the\", \" contents of the\\nvarious containers. Hence, the name \\u201ccontainer,\\u201d recalling the analogy to real-worl\", \"d shipping\\ncontainers. Thus, the owners of a container\\u2019s content need not concern themselves with ho\", \"w the\\ncontainer will be shipped, and the shipping company transports a container from its point of o\", \"rigin\\nto its destination without knowing or caring about the contents. In a similar manner, develope\", \"rs can\\ncreate and own the contents within a Docker container without the need to concern themselves \", \"with\\nthe \\u201ctransport\\u201d mechanisms.\\nIn the pillar on the left side of Figure 2-1, developers write and \", \"run code locally in Docker containers\\nby using Docker for Windows or Mac. They define the operating \", \"environment for the code by using a\\nDockerfile that specifies the base operating system to run as we\", \"ll as the build steps for building their\\ncode into a Docker image. The developers define how one or \", \"more images will interoperate using the\\naforementioned docker-compose.yml file deployment manifest. \", \"As they complete their local\\ndevelopment, they push their application code plus the Docker configura\", \"tion files to the code\\nrepository of their choice (that is, Git repository).\\nThe DevOps pillar defin\", \"es the build\\u2013Continuous Integration (CI) pipelines using the Dockerfile\\nprovided in the code reposit\", \"ory. The CI system pulls the base container images from the selected\\nDocker registry and builds the \", \"custom Docker images for the application. The images then are\\nvalidated and pushed to the Docker reg\", \"istry used for the deployments to multiple environments.\\nIn the pillar on the right, operations team\", \"s manage deployed applications and infrastructure in\\nproduction while monitoring the environment and\", \" applications so that they can provide feedback and\\ninsights to the development team about how the a\", \"pplication might be improved. Container apps are\\ntypically run in production using container orchest\", \"rators like Kubernetes, where usually Helm charts\\nare used to configure deployment units, instead of\", \" docker-compose files.\\nThe two teams are collaborating through a foundational platform (Docker conta\", \"iners) that provides\\na separation of concerns as a contract, while greatly improving the two teams\\u2019 \", \"collaboration in the\\napplication life cycle. The developers own the container contents, its operatin\", \"g environment, and the\\ncontainer interdependencies, whereas the operations teams take the built imag\", \"es along with the\\nmanifest and runs them in their orchestration system.\\nChallenges in the applicatio\", \"n life cycle when using Docker.\\nThere are many reasons that will increase the number of containerize\", \"d applications in the upcoming\\nyears, and one of these reasons is the creation of applications based\", \" on microservices.\\nDuring the last 15 years, the use of web services has been the base of thousands \", \"of applications, and\\nprobably, after a few years, you\\u2019ll find the same situation with microservice-b\", \"ased applications\\nrunning on Docker containers.\\nIt is also worth to mention that you can also use Do\", \"cker containers for monolithic applications and\\nyou still get most of the benefits of Docker. Contai\", \"ners are not targeting only microservices.\\nThe use of Docker containerization and microservices caus\", \"es new challenges in the development\\nprocess of your organizations and therefore, you need a solid s\", \"trategy to maintain many containers\\n10 CHAPTER 2 | Introduction to the Docker application life cycle\", \"and microservices running on production systems. Eventually, enterprise applications will have\\nhundr\", \"eds or thousands of containers/instances running in production.\\nThese challenges create new demands \", \"when using DevOps tools, so you\\u2019ll have to define new\\nprocesses in your DevOps activities, and find \", \"answers for the following type of questions:\\n\\u2022 Which tools can I use for development, CI/CD, managem\", \"ent and operations??\\n\\u2022 How can my company manage errors in containers when running in production?\\n\\u2022 \", \"How can we change pieces of our software in production with minimum downtime?\\n\\u2022 How can we scale and\", \" monitor our production system?\\n\\u2022 How can we include the testing and deployment of containers in our\", \" release pipeline?\\n\\u2022 How can we use Open Source tools/platforms for containers in Microsoft Azure?\\nI\", \"f you can answer all those questions, you\\u2019ll be better prepared to move your applications (existing \", \"or\\nnew apps) to Docker containers.\\nIntroduction to a generic end-to-end Docker application life cycl\", \"e\\nworkflow\\nFigure 2-2 presents a more detailed workflow for a Docker application life cycle, focusin\", \"g in this\\ninstance on specific DevOps activities and assets.\\nFigure 2-2. High-level workflow for the\", \" Docker containerized application life cycle\\nEverything begins with the developer, who starts writin\", \"g code in the inner-loop workflow. The inner-\\nloop stage is where developers define everything that \", \"happens before pushing code into the code\\nrepository (for example, a source control system such as G\", \"it). After it\\u2019s committed, the repository\\ntriggers Continuous Integration (CI) and the rest of the w\", \"orkflow.\\n11 CHAPTER 2 | Introduction to the Docker application life cycleThe inner loop consists of \", \"typical steps like \\u201ccode,\\u201d \\u201crun,\\u201d \\u201ctest,\\u201d and \\u201cdebug,\\u201d plus the additional steps\\nneeded right before\", \" running the app locally. This is the developer\\u2019s process to run and test the app as\\na Docker contai\", \"ner. The inner-loop workflow will be explained in the sections that follow.\\nTaking a step back to lo\", \"ok at the end-to-end workflow, the DevOps workflow is more than a\\ntechnology or a tool set, it\\u2019s a m\", \"indset that requires cultural evolution. It\\u2019s people, processes, and the\\nappropriate tools to make y\", \"our application life cycle faster and more predictable. Enterprises that\\nadopt a containerized workf\", \"low typically restructure their organizations to represent people and\\nprocesses that match the conta\", \"inerized workflow.\\nPracticing DevOps can help teams respond faster together to competitive pressures\", \" by replacing\\nerror-prone manual processes with automation, which results in improved traceability a\", \"nd repeatable\\nworkflows. Organizations also can manage environments more efficiently and realize cos\", \"t savings with\\na combination of on-premises and cloud resources as well as tightly integrated toolin\", \"g.\\nWhen implementing your DevOps workflow for Docker applications, you\\u2019ll see that Docker\\ntechnologi\", \"es are present in almost every stage of the workflow, from your development box while\\nworking in the\", \" inner loop (code, run, debug), the build-test-CI phase, and, finally, the deployment of\\nthose conta\", \"iners to the staging and production environments.\\nImprovement of quality practices helps to identify\", \" defects early in the development cycle, which\\nreduces the cost of fixing them. By including the env\", \"ironment and dependencies in the image and\\nadopting a philosophy of deploying the same image across \", \"multiple environments, you promote a\\ndiscipline of extracting the environment-specific configuration\", \"s making deployments more reliable.\\nRich data obtained through effective instrumentation (monitoring\", \" and diagnostics) provides insight\\ninto performance issues and user behavior to guide future priorit\", \"ies and investments.\\nDevOps should be considered a journey, not a destination. It should be implemen\", \"ted incrementally\\nthrough appropriately scoped projects from which you can demonstrate success, lear\", \"n, and evolve.\\nBenefits of DevOps for containerized applications\\nHere are some of the most important\", \" benefits provided by a solid DevOps workflow:\\n\\u2022 Deliver better-quality software, faster and with be\", \"tter compliance.\\n\\u2022 Drive continuous improvement and adjustments earlier and more economically.\\n\\u2022 Inc\", \"rease transparency and collaboration among stakeholders involved in delivering and\\noperating softwar\", \"e.\\n\\u2022 Control costs and utilize provisioned resources more effectively while minimizing security\\nrisk\", \"s.\\n\\u2022 Plug and play well with many of your existing DevOps investments, including investments in\\nopen\", \"-source.\\n12 CHAPTER 2 | Introduction to the Docker application life cycle3\\nCHAPTER\\nIntroduction to t\", \"he\\nMicrosoft platform\\nand tools for containerized\\napps\\nVision: Create an adaptable, enterprise-grade\", \", containerized application life cycle that spans your\\ndevelopment, IT operations, and production ma\", \"nagement.\\nFigure 3-1 shows the main pillars in the life cycle of Docker apps classified by the type \", \"of work\\ndelivered by multiple teams (app-development, DevOps infrastructure processes, and IT manage\", \"ment\\nand operations). Usually, in the enterprise, the profiles of \\u201cthe persona\\u201d responsible for each\", \" area are\\ndifferent. So are their skills.\\n13 CHAPTER 3 | Introduction to the Microsoft platform and \", \"tools for containerized appsFigure 3-1. Main pillars in the life cycle for containerized Docker appl\", \"ications with Microsoft platform and tools\\nA containerized Docker life-cycle workflow can be initial\", \"ly prescriptive based on \\u201cby-default product\\nchoices,\\u201d making it easier for developers to get starte\", \"d faster, but it\\u2019s fundamental that under the\\nhood there must be an open framework so that it will b\", \"e a flexible workflow capable of adjusting to\\nthe different contexts from each organization or enter\", \"prise. The workflow infrastructure (components\\nand products) must be flexible enough to cover the en\", \"vironment that each company will have in the\\nfuture, even being capable of swapping development or D\", \"evOps products to others. This flexibility,\\nopenness, and the broad choice of technologies in the pl\", \"atform and infrastructure are precisely the\\nMicrosoft priorities for containerized Docker applicatio\", \"ns, as explained in the chapters that follow.\\nTable 3-1 demonstrates that the intention of the Azure\", \" DevOps for containerized Docker applications\\nis to provide an open DevOps workflow so that you can \", \"choose what products to use for each phase\\n(Microsoft or third-party) while providing a simplified w\", \"orkflow that provides \\u201cby-default-products\\u201d\\nalready connected; thus, you can quickly get started wit\", \"h your enterprise-level DevOps workflow for\\nDocker apps.\\nTable 3-1. DevOps workflows, open to any te\", \"chnology\\nHost Microsoft technologies Third-party (Azure pluggable)\\nPlatform for \\u2022 Microsoft Visual S\", \"tudio and \\u2022 Any code editor (for example, Sublime)\\nDocker apps Visual Studio Code \\u2022 Any language (No\", \"de.js, Java, Go, etc.)\\n\\u2022 .NET \\u2022 Any orchestrator and scheduler\\n\\u2022 Microsoft Azure Kubernetes \\u2022 Any Do\", \"cker registry\\\\\\nService (AKS)\\n\\u2022 Azure Container Registry\\\\\\n14 CHAPTER 3 | Introduction to the Microsof\", \"t platform and tools for containerized appsHost Microsoft technologies Third-party (Azure pluggable)\", \"\\nDevOps for \\u2022 Azure DevOps Services \\u2022 GitHub, Git, Subversion, etc.\\nDocker apps \\u2022 Microsoft Team Fou\", \"ndation \\u2022 Jenkins, Chef, Puppet, Velocity, CircleCI,\\nServer TravisCI, etc.\\n\\u2022 GitHub \\u2022 On-premises Do\", \"cker Datacenter, Kubernetes,\\n\\u2022 Azure Kubernetes Service Mesos DC/OS, etc.\\\\\\n(AKS)\\\\\\nManagement \\u2022 Azure\", \" Monitor \\u2022 Marathon, Chronos, etc.\\\\\\nand\\nmonitoring\\nThe Microsoft platform and tools for containerize\", \"d Docker apps, as defined in Table 3-1, comprise the\\nfollowing components:\\n\\u2022 Platform for Docker App\", \"s development The development of a service, or collection of\\nservices that make up an \\u201capp.\\u201d The dev\", \"elopment platform provides all the work developers\\nrequires prior to pushing their code to a shared \", \"code repository. Developing services,\\ndeployed as containers, are similar to the development of the \", \"same apps or services without\\nDocker. You continue to use your preferred language (.NET, Node.js, Go\", \", etc.) and preferred\\neditor or IDE like Visual Studio or Visual Studio Code. However, rather than c\", \"onsider Docker a\\ndeployment destination, you develop your services in the Docker environment. You bu\", \"ild, run,\\ntest, and debug your code in containers locally, providing the destination environment at\\n\", \"development time. By providing the destination environment locally, Docker containers set up\\nwhat wi\", \"ll drastically help you improve your DevOps life cycle. Visual Studio and Visual Studio\\nCode have ex\", \"tensions to integrate Docker containers within your development process.\\n\\u2022 DevOps for Docker Apps De\", \"velopers creating Docker applications can use Azure DevOps,\\nGitHub or any other third-party product,\", \" like Jenkins, to build out a comprehensive\\nautomated application life-cycle management (ALM).\\nWith \", \"Azure DevOps and/or GitHub, developers can create container-focused DevOps for a\\nfast, iterative pro\", \"cess that covers source-code control from anywhere (Azure DevOps-Git,\\nGitHub, any remote Git reposit\", \"ory, or Subversion), Continuous Integration (CI), internal unit\\ntests, inter-container/service integ\", \"ration tests, Continuous Delivery (CD), and release\\nmanagement (RM). Developers also can automate th\", \"eir Docker application releases into Azure\\nKubernetes Service (AKS), from development to staging and\", \" production environments.\\n\\u2022 Management and Monitoring IT can manage and monitor production applicati\", \"ons and\\nservices in several ways, integrating both perspectives in a consolidated experience.\\n\\u2013 Azur\", \"e portal Azure Kubernetes Service (AKS) helps you to set up and maintain your\\nDocker environments. Y\", \"ou can also use other orchestrators to visualize and configure\\nyour cluster.\\n\\u2013 Docker tools You can \", \"manage your container applications using familiar tools.\\nThere\\u2019s no need to change your existing Doc\", \"ker management practices to move\\ncontainer workloads to the cloud. Use the application management to\", \"ols you\\u2019re\\n15 CHAPTER 3 | Introduction to the Microsoft platform and tools for containerized appsalr\", \"eady familiar with and connect via the standard API endpoints for the orchestrator\\nof your choice. Y\", \"ou also can use other third-party tools to manage your Docker\\napplications or even CLI Docker tools.\", \"\\nEven if you\\u2019re familiar with Linux commands, you can manage your container\\napplications using Micro\", \"soft Windows and PowerShell with a Linux Subsystem\\ncommand line and the products (Docker, Kubernetes\", \"\\u2026) clients running on this Linux\\nSubsystem capability. You\\u2019ll learn more about using these tools und\", \"er Linux\\nSubsystem using your favorite Microsoft Windows OS later in this book.\\n\\u2013 Open-source tools \", \"Because AKS exposes the standard API endpoints for the\\norchestration engine, the most popular tools \", \"are compatible with AKS and, in most\\ncases, will work out of the box\\u2014including visualizers, monitori\", \"ng, command-line\\ntools, and even future tools as they become available.\\n\\u2013 GitHub Advanced Security G\", \"itHub Advanced Security offers a suite of tools for\\nsecuring the software supply chain that can seam\", \"lessly integrate security into the\\ndaily workflow of teams developing containerized applications.\\n\\u2013 \", \"Azure Monitor Is Azure\\u2019s solution to monitor every angle of your production\\nenvironment. You can mon\", \"itor production Docker applications by just setting up its\\nSDK into your services so that you can ge\", \"t system-generated log data from the\\napplications.\\nThus, Microsoft offers a complete foundation for \", \"an end-to-end containerized Docker application life\\ncycle. However, it\\u2019s a collection of products an\", \"d technologies that allow you to optionally select and\\nintegrate with existing tools and processes. \", \"The flexibility in a broad approach along with the strength\\nin the depth of capabilities place Micro\", \"soft in a strong position for containerized Docker application\\ndevelopment.\\n16 CHAPTER 3 | Introduct\", \"ion to the Microsoft platform and tools for containerized apps4\\nCHAPTER\\nDesigning and developing\\ncon\", \"tainerized apps using\\nDocker and Microsoft\\nAzure\\nVision: Design and develop scalable solutions with \", \"Docker in mind.\\nThere are many great-fit use cases for containers, not just for microservices-orient\", \"ed architectures, but\\nalso when you simply have regular services or web applications to run and you \", \"want to reduce frictions\\nbetween development and production environment deployments.\\nDesign Docker a\", \"pplications\\nChapter 1 introduced the fundamental concepts regarding containers and Docker. That info\", \"rmation is\\nthe basic level of information you need to get started. But, enterprise applications can \", \"be complex and\\ncomposed of multiple services instead of a single service or container. For those opt\", \"ional use cases,\\nyou need to know additional approaches to design, such as Service-Oriented Architec\", \"ture (SOA) and\\nthe more advanced microservices concepts and container orchestration concepts. The sc\", \"ope of this\\ndocument is not limited to microservices but to any Docker application life cycle, there\", \"fore, it does\\nnot explore microservices architecture in depth because you can also use containers an\", \"d Docker with\\nregular SOA, background tasks or jobs, or even with monolithic application deployment \", \"approaches.\\nMore info To learn more about enterprise applications and microservices architecture in \", \"depth, read\\nthe guide NET Microservices: Architecture for Containerized .NET Applications that you c\", \"an also\\ndownload from https://aka.ms/MicroservicesEbook.\\nHowever, before you get into the applicatio\", \"n life cycle and DevOps, it\\u2019s important to know how you\\u2019re\\ngoing to design and construct your applic\", \"ation and what are your design choices.\\n17 CHAPTER 4 | Designing and developing containerized apps u\", \"sing Docker and Microsoft AzureCommon container design principles\\nAhead of getting into the developm\", \"ent process there are a few basic concepts worth mentioning with\\nregard to how you use containers.\\nC\", \"ontainer equals a process\\nIn the container model, a container represents a single process. By defini\", \"ng a container as a process\\nboundary, you begin to create the primitives used to scale, or batch-off\", \", processes. When you run a\\nDocker container, you\\u2019ll see an ENTRYPOINT definition. This defines the \", \"process and the lifetime of\\nthe container. When the process completes, the container life-cycle ends\", \". There are long-running\\nprocesses, such as web servers, and short-lived processes, such as batch jo\", \"bs, which might have\\nbeen implemented as Microsoft Azure WebJobs. If the process fails, the containe\", \"r ends, and the\\norchestrator takes over. If the orchestrator was instructed to keep five instances r\", \"unning and one fails,\\nthe orchestrator will create another container to replace the failed process. \", \"In a batch job, the process\\nis started with parameters. When the process completes, the work is comp\", \"lete.\\nYou might find a scenario in which you want multiple processes running in a single container. \", \"In any\\narchitecture document, there\\u2019s never a \\u201cnever,\\u201d nor is there always an \\u201calways.\\u201d For scenario\", \"s requiring\\nmultiple processes, a common pattern is to use Supervisor.\\nMonolithic applications\\nIn th\", \"is scenario, you\\u2019re building a single and monolithic web application or service and deploying it as\\n\", \"a container. Within the application, the structure might not be monolithic; it might comprise severa\", \"l\\nlibraries, components, or even layers (application layer, domain layer, data access layer, etc.).\\n\", \"Externally, it\\u2019s a single container, like a single process, single web application, or single servic\", \"e.\\nTo manage this model, you deploy a single container to represent the application. To scale it, ju\", \"st add\\na few more copies with a load balancer in front. The simplicity comes from managing a single\\n\", \"deployment in a single container or virtual machine (VM).\\nFollowing the principal that a container d\", \"oes one thing only, and does it in one process, the\\nmonolithic pattern is in conflict. You can inclu\", \"de multiple components/libraries or internal layers\\nwithin each container, as illustrated in Figure \", \"4-1.\\n18 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureFigu\", \"re 4-1. An example of monolithic application architecture\\nA monolithic app has all or most of its fu\", \"nctionality within a single process or container and it\\u2019s\\ncomponentized in internal layers or librar\", \"ies. The downside to this approach comes if or when the\\napplication grows, requiring it to scale. If\", \" the entire application scaled, it\\u2019s not really a problem.\\nHowever, in most cases, a few parts of th\", \"e application are the choke points that require scaling,\\nwhereas other components are used less.\\nUsi\", \"ng the typical e-commerce example, what you likely need is to scale the product information\\ncomponen\", \"t. Many more customers browse products than purchase them. More customers use their\\nbasket than use \", \"the payment pipeline. Fewer customers add comments or view their purchase history.\\nAnd you likely ha\", \"ve only a handful of employees, in a single region, that need to manage the content\\nand marketing ca\", \"mpaigns. By scaling the monolithic design, all of the code is deployed multiple times.\\nIn addition t\", \"o the \\u201cscale-everything\\u201d problem, changes to a single component require complete\\nretesting of the en\", \"tire application as well as a complete redeployment of all the instances.\\nThe monolithic approach is\", \" common, and many organizations are developing with this architectural\\nmethod. Many enjoy good enoug\", \"h results, whereas others encounter limits. Many designed their\\napplications in this model because t\", \"he tools and infrastructure were too difficult to build SOAs, and\\nthey didn\\u2019t see the need\\u2014until the\", \" app grew.\\nFrom an infrastructure perspective, each server can run many applications within the same\", \" host and\\nhave an acceptable ratio of efficiency in your resources usage, as shown in Figure 4-2.\\n19\", \" CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureFigure 4-2.\", \" A host running multiple apps/containers\\nFinally, from an availability perspective, monolithic appli\", \"cations must be deployed as a whole; that\\nmeans that in case you must stop and start, all functional\", \"ity and all users will be affected during the\\ndeployment window. In certain situations, the use of A\", \"zure and containers can minimize these\\nsituations and reduce the probability of downtime of your app\", \"lication, as you can see in Figure 4-3.\\nYou can deploy monolithic applications in Azure by using ded\", \"icated VMs for each instance. Using\\nAzure VM Scale Sets, you can scale the VMs easily.\\nYou can also \", \"use Azure App Services to run monolithic applications and easily scale instances without\\nhaving to m\", \"anage the VMs. Azure App Services can run single instances of Docker containers, as well,\\nsimplifyin\", \"g the deployment.\\nYou can deploy multiple VMs as Docker hosts and run any number of containers per V\", \"M. Then, by\\nusing an Azure Load Balancer, as illustrated in the Figure 4-3, you can manage scaling.\\n\", \"Figure 4-3. Multiple hosts scaling out a single Docker application\\nYou can manage the deployment of \", \"the hosts themselves via traditional deployment techniques.\\nYou can manage Docker containers from th\", \"e command line by using commands like docker run and\\ndocker-compose up, and you can also automate it\", \" in Continuous Delivery (CD) pipelines and deploy\\nto Docker hosts from Azure DevOps Services, for in\", \"stance.\\n20 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureM\", \"onolithic application deployed as a container\\nThere are benefits to using containers to manage monol\", \"ithic deployments. Scaling the instances of\\ncontainers is far faster and easier than deploying addit\", \"ional VMs.\\nDeploying updates as Docker images is far faster and network efficient. Docker containers\", \" typically\\nstart in seconds, speeding rollouts. Tearing down a Docker container is as easy as invoki\", \"ng the docker\\nstop command, typically completing in less than a second.\\nBecause containers are inher\", \"ently immutable, by design, you never need to worry about corrupted\\nVMs because an update script for\", \"got to account for some specific configuration or file left on disk.\\nAlthough monolithic apps can be\", \"nefit from Docker, we\\u2019re touching on only the tips of the benefits.\\nThe larger benefits of managing \", \"containers come from deploying with container orchestrators that\\nmanage the various instances and li\", \"fe cycle of each container instance. Breaking up the monolithic\\napplication into subsystems that can\", \" be scaled, developed, and deployed individually is your entry\\npoint into the realm of microservices\", \".\\nTo learn about how to \\u201clift and shift\\u201d monolithic applications with containers and how you can\\nmod\", \"ernize your applications, you can read this additional Microsoft guide, Modernize existing .NET\\nappl\", \"ications with Azure cloud and Windows Containers, which you can also download as PDF from\\nhttps://ak\", \"a.ms/LiftAndShiftWithContainersEbook.\\nPublish a single Docker container app to Azure App Service\\nEit\", \"her because you want to get a quick validation of a container deployed to Azure or because the\\napp i\", \"s simply a single-container app, Azure App Services provides a great way to provide scalable\\nsingle-\", \"container services.\\nUsing Azure App Service is intuitive and you can get up and running quickly beca\", \"use it provides great\\nGit integration to take your code, build it in Microsoft Visual Studio, and di\", \"rectly deploy it to Azure.\\nBut, traditionally (with no Docker), if you needed other capabilities, fr\", \"ameworks, or dependencies that\\naren\\u2019t supported in App Services, you needed to wait for it until the\", \" Azure team updates those\\ndependencies in App Service or switched to other services like Service Fab\", \"ric, Cloud Services, or even\\nplain VMs, for which you have further control and can install a require\", \"d component or framework for\\nyour application.\\nNow, as shown in Figure 4-4, when using Visual Studio\", \" 2022, container support in Azure App Service\\ngives you the ability to include whatever you want in \", \"your app environment. If you added a\\ndependency to your app, because you\\u2019re running it in a containe\", \"r, you get the capability of including\\nthose dependencies in your Dockerfile or Docker image.\\n21 CHA\", \"PTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureFigure 4-4. Pub\", \"lishing a container to Azure App Service from Visual Studio apps/containers\\nFigure 4-4 also shows th\", \"at the publish flow pushes an image through a Container Registry, which can\\nbe the Azure Container R\", \"egistry (a registry near to your deployments in Azure and secured by Azure\\nActive Directory groups a\", \"nd accounts) or any other Docker Registry like Docker Hub or on-premises\\nregistries.\\nState and data \", \"in Docker applications\\nIn most cases, you can think of a container as an instance of a process. A pr\", \"ocess does not maintain\\npersistent state. While a container can write to its local storage, assuming\", \" that an instance will be\\naround indefinitely is like assuming that a single location in memory will\", \" be durable. Container\\nimages, like processes, should be assumed to have multiple instances and that\", \" they will eventually be\\nkilled; if they\\u2019re managed with a container orchestrator, it should be assu\", \"med that they might get\\nmoved from one node or VM to another.\\nThe following solutions are used to ma\", \"nage persistent data in Docker applications:\\nFrom the Docker host, as Docker Volumes:\\n\\u2022 Volumes are \", \"stored in an area of the host filesystem that\\u2019s managed by Docker.\\n\\u2022 Bind mounts can map to any fold\", \"er in the host filesystem, so access can\\u2019t be controlled from\\na Docker process and can pose a securi\", \"ty risk as a container could access sensitive OS folders.\\n22 CHAPTER 4 | Designing and developing co\", \"ntainerized apps using Docker and Microsoft Azure\\u2022 tmpfs mounts are like virtual folders that only e\", \"xist in the host\\u2019s memory and are never\\nwritten to the filesystem.\\nFrom remote storage:\\n\\u2022 Azure Stor\", \"age provides geo-distributable storage, providing a good long-term persistence\\nsolution for containe\", \"rs.\\n\\u2022 Remote relational databases like Azure SQL Database, NoSQL databases like Azure Cosmos\\nDB, or \", \"cache services like Redis.\\nFrom the Docker container:\\n\\u2022 Docker provides a feature named the overlay \", \"file system. This feature implements a copy-on-\\nwrite task that stores updated information to the ro\", \"ot file system of the container. That\\ninformation \\u201clays on top of\\u201d the original image on which the c\", \"ontainer is based. If the\\ncontainer is deleted from the system, those changes are lost. Therefore, w\", \"hile it\\u2019s possible to\\nsave the state of a container within its local storage, designing a system bas\", \"ed on this feature\\nwould conflict with the premise of container design, which by default is stateles\", \"s.\\n\\u2022 However, Docker Volumes is now the preferred way to handle local data in Docker. If you\\nneed mo\", \"re information about storage in containers, check on Docker storage drivers and\\nAbout images, contai\", \"ners, and storage drivers.\\nThe following provides additional detail about these options.\\nVolumes are\", \" directories mapped from the host OS to directories in containers. When code in the\\ncontainer has ac\", \"cess to the directory, that access is actually to a directory on the host OS. This\\ndirectory is not \", \"tied to the lifetime of the container itself, and the directory is managed by Docker and\\nisolated fr\", \"om the core functionality of the host machine. Thus, data volumes are designed to persist\\ndata indep\", \"endently of the life of the container. If you delete a container or an image from the Docker\\nhost, t\", \"he data persisted in the data volume is not deleted.\\nVolumes can be named or anonymous (the default)\", \". Named volumes are the evolution of Data\\nVolume Containers and make it easy to share data between c\", \"ontainers. Volumes also support\\nvolume drivers that allow you to store data on remote hosts, among o\", \"ther options.\\nBind mounts have been available for a long time and allow the mapping of any folder to\", \" a mount\\npoint in a container. Bind mounts have more limitations than volumes and some important sec\", \"urity\\nissues, so volumes are the recommended option.\\ntmpfs mounts are virtual folders that live only\", \" in the host\\u2019s memory and are never written to the\\nfilesystem. They are fast and secure but use memo\", \"ry and are only meant for non-persistent data.\\nAs shown in Figure 4-5, regular Docker volumes can be\", \" stored outside of the containers themselves\\nbut within the physical boundaries of the host server o\", \"r VM. However, Docker containers cannot\\naccess a volume from one host server or VM to another. In ot\", \"her words, with these volumes, it isn\\u2019t\\npossible to manage data shared between containers that run o\", \"n different Docker hosts, although it\\ncould be achieved with a volume driver that supports remote ho\", \"sts.\\n23 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureFigu\", \"re 4-5. Volumes and external data sources for container-based applications\\nIn addition, when Docker \", \"containers are managed by an orchestrator, containers might \\u201cmove\\u201d\\nbetween hosts, depending on the o\", \"ptimizations performed by the cluster. Therefore, it isn\\u2019t\\nrecommended that you use data volumes for\", \" business data. But they are a good mechanism to work\\nwith trace files, temporal files, or similar, \", \"that will not impact business data consistency.\\nRemote data sources and cache tools like Azure SQL D\", \"atabase, Azure Cosmos DB, or a remote cache\\nlike Redis can be used in containerized applications the\", \" same way they are used when developing\\nwithout containers. This is a proven way to store business a\", \"pplication data.\\nAzure Storage. Business data usually needs to be placed in external resources or da\", \"tabases, like\\nAzure Storage. Azure Storage provides the following services in the cloud:\\n\\u2022 Blob stor\", \"age stores unstructured object data. A blob can be any type of text or binary data,\\nsuch as document\", \" or media files (images, audio, and video files). Blob storage is also referred\\nto as Object storage\", \".\\n\\u2022 File storage offers shared storage for legacy applications using the standard SMB protocol.\\nAzur\", \"e virtual machines and cloud services can share file data across application components\\nvia mounted \", \"shares. On-premises applications can access file data in a share via the File\\nService REST API.\\n\\u2022 Ta\", \"ble storage stores structured datasets. Table storage is a NoSQL key-attribute data store,\\nwhich all\", \"ows rapid development and fast access to large quantities of data.\\nRelational databases and NoSQL da\", \"tabases. There are many choices for external databases, from\\nrelational databases like SQL Server, P\", \"ostgreSQL, Oracle, or NoSQL databases like Azure Cosmos DB,\\nMongoDB, etc. These databases are not go\", \"ing to be explained as part of this guide since they are a\\ndifferent topic altogether.\\n24 CHAPTER 4 \", \"| Designing and developing containerized apps using Docker and Microsoft AzureService-oriented appli\", \"cations\\nService-Oriented Architecture (SOA) was an overused term that meant many different things to\", \"\\ndifferent people. But as a common denominator, SOA means that you structure the architecture of\\nyou\", \"r application by decomposing it into several services (most commonly as HTTP services) that can\\nbe c\", \"lassified in different types like subsystems or, in other cases, as tiers.\\nToday, you can deploy tho\", \"se services as Docker containers, which solve deployment-related issues\\nbecause all of the dependenc\", \"ies are included in the container image. However, when you need to\\nscale out SOAs, you might encount\", \"er challenges if you\\u2019re deploying based on single instances. This\\nchallenge can be handled using Doc\", \"ker clustering software or an orchestrator. You\\u2019ll get to look at\\norchestrators in greater detail in\", \" the next section, when you explore microservices approaches.\\nDocker containers are useful (but not \", \"required) for both traditional service-oriented architectures and\\nthe more advanced microservices ar\", \"chitectures.\\nAt the end of the day, the container clustering solutions are useful for both a traditi\", \"onal SOA\\narchitecture and for a more advanced microservices architecture in which each microservice \", \"owns its\\ndata model. And thanks to multiple databases, you can also scale out the data tier instead \", \"of working\\nwith monolithic databases shared by the SOA services. However, the discussion about split\", \"ting the\\ndata is purely about architecture and design.\\nOrchestrating microservices and multi-contain\", \"er\\napplications for high scalability and availability\\nUsing orchestrators for production-ready appli\", \"cations is essential if your application is based on\\nmicroservices or split across multiple containe\", \"rs. As introduced previously, in a microservice-based\\napproach, each microservice owns its model and\", \" data so that it will be autonomous from a\\ndevelopment and deployment point of view. But even if you\", \" have a more traditional application that\\u2019s\\ncomposed of multiple services (like SOA), you\\u2019ll also ha\", \"ve multiple containers or services comprising a\\nsingle business application that need to be deployed\", \" as a distributed system. These kinds of systems\\nare complex to scale out and manage; therefore, you\", \" absolutely need an orchestrator if you want to\\nhave a production-ready and scalable multi-container\", \" application.\\nFigure 4-6 illustrates deployment into a cluster of an application composed of multipl\", \"e microservices\\n(containers).\\n25 CHAPTER 4 | Designing and developing containerized apps using Docke\", \"r and Microsoft AzureFigure 4-6. A cluster of containers\\nIt looks like a logical approach. But how a\", \"re you handling load balancing, routing, and orchestrating\\nthese composed applications?\\nThe Docker C\", \"LI meets the needs of managing one container on one host, but it falls short when it\\ncomes to managi\", \"ng multiple containers deployed on multiple hosts for more complex distributed\\napplications. In most\", \" cases, you need a management platform that will automatically start containers,\\nscale out container\", \"s with multiple instances per image, suspend them, or shut them down when\\nneeded, and ideally also c\", \"ontrol how they access resources like the network and data storage.\\nTo go beyond the management of i\", \"ndividual containers or simple composed apps and move toward\\nlarger enterprise applications with mic\", \"roservices, you must turn to orchestration and clustering\\nplatforms.\\nFrom an architecture and develo\", \"pment point of view, if you\\u2019re building large, enterprise,\\nmicroservices-based, applications, it\\u2019s i\", \"mportant to understand the following platforms and products\\nthat support advanced scenarios:\\n\\u2022 Clust\", \"ers and orchestrators. When you need to scale out applications across many Docker\\nhosts, such as wit\", \"h a large microservices-based application, it\\u2019s critical to be able to manage\\nall of those hosts as \", \"a single cluster by abstracting the complexity of the underlying platform.\\nThat\\u2019s what the container\", \" clusters and orchestrators provide. Examples of orchestrators are\\nAzure Service Fabric and Kubernet\", \"es. Kubernetes is available in Azure through Azure\\nKubernetes Service.\\n26 CHAPTER 4 | Designing and \", \"developing containerized apps using Docker and Microsoft Azure\\u2022 Schedulers. Scheduling means to have\", \" the capability for an administrator to launch containers\\nin a cluster, so schedulers also provide a\", \" user interface for doing so. A cluster scheduler has\\nseveral responsibilities: to use the cluster\\u2019s\", \" resources efficiently, to set the constraints\\nprovided by the user, to efficiently load-balance con\", \"tainers across nodes or hosts, and to be\\nrobust against errors while providing high availability.\\nTh\", \"e concepts of a cluster and a scheduler are closely related, so the products provided by different\\nv\", \"endors often provide both sets of capabilities. The section below shows the most important platform\\n\", \"and software choices you have for clusters and schedulers. These orchestrators are widely offered in\", \"\\npublic clouds like Azure.\\nSoftware platforms for container clustering, orchestration, and\\nschedulin\", \"g\\nPlatform Comments\\nKubernetes Kubernetes is an open-source product that\\nprovides functionality that\", \" ranges from\\ncluster infrastructure and container\\nscheduling to orchestrating capabilities. It\\nlets \", \"you automate deployment, scaling,\\nand operations of application containers\\nacross clusters of hosts.\", \"\\nKubernetes provides a container-centric\\ninfrastructure that groups application\\ncontainers into logi\", \"cal units for easy\\nmanagement and discovery.\\nKubernetes is mature in Linux, less mature\\nin Windows.\\n\", \"Azure Kubernetes Service (AKS) Azure Kubernetes Service (AKS) is a\\nmanaged Kubernetes container\\norch\", \"estration service in Azure that\\nsimplifies Kubernetes cluster\\u2019s\\nmanagement, deployment, and\\noperatio\", \"ns.\\n27 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzurePlatf\", \"orm Comments\\nAzure Service Fabric Service Fabric is a Microsoft microservices\\nplatform for building \", \"applications. It\\u2019s an\\norchestrator of services and creates\\nclusters of machines. Service Fabric can\\n\", \"deploy services as containers or as plain\\nprocesses. It can even mix services in\\nprocesses with serv\", \"ices in containers\\nwithin the same application and cluster.\\nService Fabric clusters can be deployed \", \"in\\nAzure, on-premises or in any cloud.\\nHowever, deployment in Azure is\\nsimplified with a managed app\", \"roach.\\nService Fabric provides additional and\\noptional prescriptive Service Fabric\\nprogramming model\", \"s like stateful services\\nand Reliable Actors.\\nService Fabric is mature in Windows (years\\nevolving in\", \" Windows), less mature in Linux.\\nBoth Linux and Windows containers are\\nsupported in Service Fabric s\", \"ince 2017.\\nAzure Service Fabric Mesh | Azure Service Fabric Mesh offers the same reliability, missio\", \"n-\\ncritical performance and scale as Service Fabric, but also offers a fully managed and serverless\\n\", \"platform. You don\\u2019t need to manage a cluster, VMs, storage or networking configuration. You just\\nfoc\", \"us on your application\\u2019s development. Service Fabric Mesh supports both Windows and Linux\\ncontainers\", \", allowing you to develop with any programming language and framework of your choice.\\nAzure Containe\", \"r Apps | Azure Container Apps is a\\nmanaged serverless container service for building and deploying m\", \"odern apps at scale. |\\nUsing container-based orchestrators in Azure\\nSeveral cloud vendors offer Dock\", \"er containers support plus Docker clusters and orchestration support,\\nincluding Azure, Amazon EC2 Co\", \"ntainer Service, and Google Container Engine. Azure provides Docker\\n28 CHAPTER 4 | Designing and dev\", \"eloping containerized apps using Docker and Microsoft Azurecluster and orchestrator support through \", \"Azure Kubernetes Service (AKS), Azure Service Fabric, and\\nAzure Service Fabric Mesh.\\nUsing Azure Kub\", \"ernetes Service\\nA Kubernetes cluster pools several Docker hosts and exposes them as a single virtual\", \" Docker host, so\\nyou can deploy multiple containers into the cluster and scale-out with any number o\", \"f container\\ninstances. The cluster will handle all the complex management plumbing, like scalability\", \", health, and\\nso forth.\\nAKS provides a way to simplify the creation, configuration, and management o\", \"f a cluster of virtual\\nmachines in Azure that are preconfigured to run containerized applications. U\", \"sing an optimized\\nconfiguration of popular open-source scheduling and orchestration tools, AKS enabl\", \"es you to use\\nyour existing skills or draw on a large and growing body of community expertise to dep\", \"loy and\\nmanage container-based applications on Microsoft Azure.\\nAzure Kubernetes Service optimizes t\", \"he configuration of popular Docker clustering open-source tools\\nand technologies specifically for Az\", \"ure. You get an open solution that offers portability for both your\\ncontainers and your application \", \"configuration. You select the size, the number of hosts, and the\\norchestrator tools, and AKS handles\", \" everything else.\\n29 CHAPTER 4 | Designing and developing containerized apps using Docker and Micros\", \"oft AzureFigure 4-7. Kubernetes cluster\\u2019s simplified structure and topology\\nFigure 4-7 shows the str\", \"ucture of a Kubernetes cluster where a master node (VM) controls most of the\\ncoordination of the clu\", \"ster, and you can deploy containers to the rest of the nodes that are managed\\nas a single pool from \", \"an application point of view. This allows you to scale to thousands or even tens\\nof thousands of con\", \"tainers.\\nDevelopment environment for Kubernetes\\nIn the development environment that Docker announced\", \" in July 2018, Kubernetes can also run in a\\nsingle development machine (Windows 10 or macOS) by just\", \" installing Docker Desktop. You can later\\ndeploy to the cloud (AKS) for further integration tests, a\", \"s shown in figure 4-8.\\n30 CHAPTER 4 | Designing and developing containerized apps using Docker and M\", \"icrosoft AzureFigure 4-8. Running Kubernetes in dev machine and the cloud\\nGet started with Azure Kub\", \"ernetes Service (AKS)\\nTo begin using AKS, you deploy an AKS cluster from the Azure portal or by usin\", \"g the CLI. For more\\ninformation on deploying a Kubernetes cluster to Azure, see Deploy an Azure Kube\", \"rnetes Service\\n(AKS) cluster.\\nThere are no fees for any of the software installed by default as part\", \" of AKS. All default options are\\nimplemented with open-source software. AKS is available for multipl\", \"e virtual machines in Azure.\\nYou\\u2019re charged only for the compute instances you choose, as well as th\", \"e other underlying\\ninfrastructure resources consumed, such as storage and networking. There are no i\", \"ncremental charges\\nfor AKS itself.\\nFor further implementation information on deployment to Kubernete\", \"s based on kubectl and original\\n.yaml files, see Deploy to Azure Kubernetes Service (AKS).\\nDeploy wi\", \"th Helm charts into Kubernetes clusters\\nWhen deploying an application to a Kubernetes cluster, you c\", \"an use the original kubectl.exe CLI tool\\nusing deployment files based on the native format (.yaml fi\", \"les), as already mentioned in the previous\\nsection. However, for more complex Kubernetes application\", \"s such as when deploying complex\\nmicroservice-based applications, it\\u2019s recommended to use Helm.\\nHelm\", \" Charts helps you define, version, install, share, upgrade, or rollback even the most complex\\nKubern\", \"etes application. Helm is maintained by the Cloud Native Computing Foundation (CNCF) in\\ncollaboratio\", \"n with Microsoft, Google, Bitnami, and the Helm contributor community.\\nFor further implementation in\", \"formation on Helm charts and Kubernetes, see the section called Install\\neShopOnContainers using Helm\", \".\\n31 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureAdditio\", \"nal resources\\n\\u2022 Getting started with Azure Kubernetes Service (AKS)\\nhttps://learn.microsoft.com/azur\", \"e/aks/kubernetes-walkthrough-portal\\n\\u2022 Kubernetes. The official site.\\nhttps://kubernetes.io/\\nUsing Az\", \"ure Service Fabric\\nAzure Service Fabric arose from Microsoft\\u2019s transition from delivering \\u201cbox\\u201d prod\", \"ucts, which were\\ntypically monolithic in style, to delivering services. The experience of building a\", \"nd operating large\\nservices at scale, such as Azure SQL Database, Azure Cosmos DB, Azure Service Bus\", \", or Cortana\\u2019s\\nBackend, shaped Service Fabric. The platform evolved over time as more and more servi\", \"ces adopted\\nit. Importantly, Service Fabric had to run not only in Azure but also in standalone Wind\", \"ows Server\\ndeployments.\\nThe aim of Service Fabric is to solve the hard problems of building and runn\", \"ing a service and utilizing\\ninfrastructure resources efficiently, so that teams can solve business p\", \"roblems using a microservices\\napproach.\\nService Fabric provides two broad areas to help you build ap\", \"plications that use a microservices\\napproach:\\n\\u2022 A platform that provides system services to deploy, \", \"scale, upgrade, detect, and restart failed\\nservices, discover service location, manage state, and mo\", \"nitor health. These system services in\\neffect enable many of the characteristics of microservices de\", \"scribed previously.\\n\\u2022 Programming APIs, or frameworks, to help you build applications as microservic\", \"es: reliable\\nactors and reliable services. You can choose any code to build your microservice, but t\", \"hese\\nAPIs make the job more straightforward, and they integrate with the platform at a deeper\\nlevel.\", \" This way you can get health and diagnostics information, or you can take advantage of\\nreliable stat\", \"e management.\\nService Fabric is agnostic with respect to how you build your service, and you can use\", \" any technology.\\nHowever, it provides built-in programming APIs that make it easier to build microse\", \"rvices.\\nAs shown in Figure 4-10, you can create and run microservices in Service Fabric either as si\", \"mple\\nprocesses or as Docker containers. It\\u2019s also possible to mix container-based microservices with\", \"\\nprocess-based microservices within the same Service Fabric cluster.\\n32 CHAPTER 4 | Designing and de\", \"veloping containerized apps using Docker and Microsoft AzureFigure 4-10. Deploying microservices as \", \"processes or as containers in Azure Service Fabric\\nIn the first image, you see microservices as proc\", \"esses, where each node runs one process for each\\nmicroservice. In the second image, you see microser\", \"vices as containers, where each node runs Docker\\nwith several containers, one container per microser\", \"vice. Service Fabric clusters based on Linux and\\nWindows hosts can run Docker Linux containers and W\", \"indows Containers, respectively.\\nFor up-to-date information about containers support in Azure Servic\", \"e Fabric, see Service Fabric and\\ncontainers.\\nService Fabric is a good example of a platform where yo\", \"u can define a different logical architecture\\n(business microservices or Bounded Contexts) than the \", \"physical implementation. For example, if you\\nimplement Stateful Reliable Services in Azure Service F\", \"abric, which are introduced in the next section,\\n\\u201cStateless versus stateful microservices,\\u201d you have\", \" a business microservice concept with multiple\\nphysical services.\\nAs shown in Figure 4-10, and think\", \"ing from a logical/business microservice perspective, when\\nimplementing a Service Fabric Stateful Re\", \"liable Service, you usually will need to implement two tiers\\nof services. The first is the back-end \", \"stateful reliable service, which handles multiple partitions (each\\npartition is a stateful service).\", \" The second is the front-end service, or Gateway service, in charge of\\nrouting and data aggregation \", \"across multiple partitions or stateful service instances. That Gateway\\nservice also handles client-s\", \"ide communication with retry loops accessing the back-end service. It\\u2019s\\ncalled a Gateway service if \", \"you implement your custom service, or alternatively you can also use the\\nout-of-the-box Service Fabr\", \"ic reverse proxy.\\n33 CHAPTER 4 | Designing and developing containerized apps using Docker and Micros\", \"oft AzureFigure 4-11. Business microservice with several stateful service instances and a custom gat\", \"eway front end\\nIn any case, when you use Service Fabric Stateful Reliable Services, you also have a \", \"logical or business\\nmicroservice (Bounded Context) that\\u2019s composed of multiple physical services. Ea\", \"ch of them, the\\nGateway service, and Partition service could be implemented as ASP.NET Web API servi\", \"ces, as shown\\nin Figure 4-11. Service Fabric has prescription to support several stateful reliable s\", \"ervices in containers.\\nIn Service Fabric, you can group and deploy groups of services as a Service F\", \"abric Application, which is\\nthe unit of packaging and deployment for the orchestrator or cluster. Th\", \"erefore, the Service Fabric\\nApplication could be mapped to this autonomous business and logical micr\", \"oservice boundary or\\nBounded Context, as well, so you could deploy these services autonomously.\\nServ\", \"ice Fabric and containers\\nWith regard to containers in Service Fabric, you can also deploy services \", \"in container images within a\\nService Fabric cluster. As Figure 4-12 shows, most of the time there wi\", \"ll only be one container per\\nservice.\\nFigure 4-12. Business microservice with several services (cont\", \"ainers) in Service Fabric\\n34 CHAPTER 4 | Designing and developing containerized apps using Docker an\", \"d Microsoft AzureA Service Fabric application can run several containers accessing an external datab\", \"ase and the whole\\nset would be the logical boundary of a Business Microservice. However, so-called \\u201c\", \"sidecar\\u201d containers\\n(two containers that must be deployed together as part of a logical service) are\", \" also possible in\\nService Fabric. The important thing is that a business microservice is the logical\", \" boundary around\\nseveral cohesive elements. In many cases, it might be a single service with a singl\", \"e data model, but in\\nsome other cases you might have several physical services as well.\\nNote that yo\", \"u can mix services in processes, and services in containers, in the same Service Fabric\\napplication,\", \" as shown in Figure 4-13.\\nFigure 4-13. Business microservice mapped to a Service Fabric application \", \"with containers and stateful services\\nFor more information about container support in Azure Service \", \"Fabric, see Service Fabric and\\ncontainers.\\nStateless versus stateful microservices\\nAs mentioned earl\", \"ier, each microservice (logical Bounded Context) must own its domain model (data\\nand logic). In the \", \"case of stateless microservices, the databases will be external, employing relational\\noptions like S\", \"QL Server, or NoSQL options like Azure Cosmos DB or MongoDB.\\nBut the services themselves can also be\", \" stateful in Service Fabric, which means that the data resides\\nwithin the microservice. This data mi\", \"ght exist not just on the same server, but within the microservice\\nprocess, in memory and persisted \", \"on hard drives and replicated to other nodes. Figure 4-14 shows the\\ndifferent approaches.\\n35 CHAPTER\", \" 4 | Designing and developing containerized apps using Docker and Microsoft AzureFigure 4-14. Statel\", \"ess versus stateful microservices\\nIn stateless services, the state (persistence, database) is kept o\", \"ut of the microservice. In stateful\\nservices, state is kept inside the microservice. A stateless app\", \"roach is perfectly valid and is easier to\\nimplement than stateful microservices, since the approach \", \"is similar to traditional and well-known\\npatterns. But stateless microservices impose latency betwee\", \"n the process and data sources. They also\\ninvolve more moving pieces when you\\u2019re trying to improve p\", \"erformance with additional cache and\\nqueues. The result is that you can end up with complex architec\", \"tures that have too many tiers.\\nIn contrast, stateful microservices can excel in advanced scenarios,\", \" because there\\u2019s no latency between\\nthe domain logic and data. Heavy data processing, gaming back en\", \"ds, databases as a service, and\\nother low-latency scenarios all benefit from stateful services, whic\", \"h enable local state for faster access.\\nStateless and stateful services are complementary. For insta\", \"nce, as you can see in the right diagram in\\nFigure 4-14, a stateful service can be split into multip\", \"le partitions. To access those partitions, you\\nmight need a stateless service acting as a gateway se\", \"rvice that knows how to address each partition\\nbased on partition keys.\\nStateful services do have dr\", \"awbacks. They impose a high complexity level to be scaled out.\\nFunctionality that would usually be i\", \"mplemented by external database systems must be addressed for\\ntasks such as data replication across \", \"stateful microservices and data partitioning. However, this is one\\nof the areas where an orchestrato\", \"r like Azure Service Fabric with its stateful reliable services can help\\nthe most\\u2014by simplifying the\", \" development and lifecycle of stateful microservices using the Reliable\\nServices API and Reliable Ac\", \"tors.\\nOther microservice frameworks that allow stateful services, support the Actor pattern, and imp\", \"rove\\nfault tolerance and latency between business logic and data are Microsoft Orleans, from Microso\", \"ft\\nResearch, and Akka.NET. Both frameworks are currently improving their support for Docker.\\nRemembe\", \"r that Docker containers are themselves stateless. If you want to implement a stateful\\nservice, you \", \"need one of the additional prescriptive and higher-level frameworks noted earlier.\\nUsing Azure Servi\", \"ce Fabric Mesh\\nAzure Service Fabric Mesh is a fully managed service that enables developers to build\", \" and deploy\\nmission critical applications without managing any infrastructure. Use Service Fabric Me\", \"sh to build\\nand run secure, distributed microservices applications that scale on demand.\\n36 CHAPTER \", \"4 | Designing and developing containerized apps using Docker and Microsoft AzureAs shown in figure 4\", \"-15, applications hosted on Service Fabric Mesh run and scale without you\\nworrying about the infrast\", \"ructure powering it.\\nFigure 4-15. Deploying a microservice/containers application to Service Fabric \", \"Mesh\\nUnder the covers, Service Fabric Mesh consists of clusters of thousands of machines. All cluste\", \"r\\noperations are hidden from the developer. You simply need to upload your containers and specify\\nre\", \"sources you need, availability requirements, and resource limits. Service Fabric Mesh automatically\\n\", \"allocates the infrastructure requested by your application deployment and also handles infrastructur\", \"e\\nfailures, making sure your applications are highly available. You only need to care about the heal\", \"th\\nand responsiveness of your application, not the infrastructure.\\nFor further information, see the \", \"Service Fabric Mesh documentation.\\nChoosing orchestrators in Azure\\nThe following table provides guid\", \"ance on what orchestrator to use depending on workloads and OS\\nfocus.\\nFigure 4-16. Orchestrator sele\", \"ction in Azure guidance\\n37 CHAPTER 4 | Designing and developing containerized apps using Docker and \", \"Microsoft AzureDeploy to Azure Kubernetes Service (AKS)\\nYou can interact with AKS using your preferr\", \"ed client operating system (Windows, macOS, or Linux)\\nwith Azure command-line interface (Azure CLI) \", \"installed. For more details, refer Azure CLI\\ndocumentation and Installation guide for the available \", \"environments.\\nCreate the AKS environment in Azure\\nThere are several ways to create the AKS Environme\", \"nt. It can be done by using Azure CLI commands\\nor by using the Azure portal.\\nHere you can explore so\", \"me examples using the Azure CLI to create the cluster and the Azure portal to\\nreview the results. Yo\", \"u also need to have Kubectl and Docker in your development machine.\\nCreate the AKS cluster\\nCreate th\", \"e AKS cluster using this command (the resource group must exist):\\naz aks create --resource-group exp\", \"lore-docker-aks-rg --name explore-docker-aks --node-\\nvm-size Standard_B2s --node-count 1 --generate-\", \"ssh-keys --location westeurope\\nNote\\nThe --node-vm-size and --node-count parameter values are good en\", \"ough for a sample/dev\\napplication.\\nAfter the creation job finishes, you can see:\\n\\u2022 The AKS cluster c\", \"reated in the initial resource group\\n\\u2022 A new, related resource group, containing the resources relat\", \"ed to the AKS cluster, as show in\\nthe following images.\\nThe initial resource group, with the AKS clu\", \"ster:\\n38 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureFig\", \"ure 4-17. AKS Resource Group view from Azure.\\nThe AKS cluster resource group:\\nFigure 4-18. AKS view \", \"from Azure.\\nImportant\\nIn general, you shouldn\\u2019t need to modify the resources in the AKS cluster reso\", \"urce group. For\\nexample, the resource group is deleted when you delete the AKS cluster.\\nYou can also\", \" view the node created using Azure CLI and Kubectl.\\nFirst, getting the credentials:\\naz aks get-crede\", \"ntials --resource-group explore-docker-aks-rg --name explore-docker-\\naks\\n39 CHAPTER 4 | Designing an\", \"d developing containerized apps using Docker and Microsoft AzureFigure 4-19. aks get-credentials com\", \"mand result.\\nAnd then, getting nodes from Kubectl:\\nkubectl get nodes\\nFigure 4-20. kubectl get nodes \", \"command result.\\nDevelopment environment for Docker apps\\nDevelopment tools choices: IDE or editor\\nNo \", \"matter if you prefer a full and powerful IDE or a lightweight and agile editor, Microsoft has you\\nco\", \"vered when it comes to developing Docker applications.\\nVisual Studio Code and Docker CLI (cross-plat\", \"form tools for Mac, Linux, and\\nWindows)\\nIf you prefer a lightweight, cross-platform editor supportin\", \"g any development language, you can use\\nVisual Studio Code and Docker CLI. These products provide a \", \"simple yet robust experience, which is\\ncritical for streamlining the developer workflow. By installi\", \"ng \\u201cDocker for Mac\\u201d or \\u201cDocker for\\nWindows\\u201d (development environment), Docker developers can use a s\", \"ingle Docker CLI to build apps\\nfor both Windows or Linux (runtime environment). Plus, Visual Studio \", \"Code supports extensions for\\nDocker with IntelliSense for Dockerfiles and shortcut-tasks to run Dock\", \"er commands from the editor.\\nNote\\nTo download Visual Studio Code, go to https://code.visualstudio.co\", \"m/download.\\nTo download Docker for Mac and Windows, go to https://www.docker.com/products/docker.\\nVi\", \"sual Studio with Docker Tools (Windows development machine)\\nIt\\u2019s recommended that you use Visual Stu\", \"dio 2022 or later with the built-in Docker Tools enabled.\\nWith Visual Studio, you can develop, run, \", \"and validate your applications directly in the chosen Docker\\nenvironment. Press F5 to debug your app\", \"lication (single container or multiple containers) directly in a\\nDocker host, or press Ctrl+F5 to ed\", \"it and refresh your app without having to rebuild the container. It\\u2019s\\nthe simplest and most powerful\", \" choice for Windows developers to create Docker containers for Linux\\nor Windows.\\n40 CHAPTER 4 | Desi\", \"gning and developing containerized apps using Docker and Microsoft AzureVisual Studio for Mac (Mac d\", \"evelopment machine)\\nYou can use Visual Studio for Mac when developing Docker-based applications. Vis\", \"ual Studio for Mac\\noffers a richer IDE when compared to Visual Studio Code for Mac.\\nLanguage and fra\", \"mework choices\\nYou can develop Docker applications using Microsoft tools with most modern languages.\", \" The\\nfollowing is an initial list, but you\\u2019re not limited to it:\\n\\u2022 .NET and ASP.NET Core\\n\\u2022 Node.js\\n\\u2022\", \" Go\\n\\u2022 Java\\n\\u2022 Ruby\\n\\u2022 Python\\nBasically, you can use any modern language supported by Docker in Linux o\", \"r Windows.\\nInner-loop development workflow for Docker apps\\nBefore triggering the outer-loop workflow\", \" spanning the entire DevOps cycle, it all begins on each\\ndeveloper\\u2019s machine, coding the app itself,\", \" using their preferred languages or platforms, and testing it\\nlocally (Figure 4-21). But in every ca\", \"se, you\\u2019ll have an important point in common, no matter what\\nlanguage, framework, or platforms you c\", \"hoose. In this specific workflow, you\\u2019re always developing and\\ntesting Docker containers in no other\", \" environments, but locally.\\nFigure 4-21. Inner-loop development context\\nThe container or instance of\", \" a Docker image will contain these components:\\n\\u2022 An operating system selection (for example, a Linux\", \" distribution or Windows)\\n\\u2022 Files added by the developer (for example, app binaries)\\n\\u2022 Configuration\", \" (for example, environment settings and dependencies)\\n\\u2022 Instructions for what processes to run by Do\", \"cker\\nYou can set up the inner-loop development workflow that utilizes Docker as the process (describ\", \"ed in\\nthe next section). Consider that the initial steps to set up the environment are not included,\", \" because\\nyou only need to do it once.\\n41 CHAPTER 4 | Designing and developing containerized apps usi\", \"ng Docker and Microsoft AzureBuilding a single app within a Docker container using Visual Studio\\nCod\", \"e and Docker CLI\\nApps are made up from your own services plus additional libraries (dependencies).\\nF\", \"igure 4-22 shows the basic steps that you usually need to carry out when building a Docker app,\\nfoll\", \"owed by detailed descriptions of each step.\\nFigure 4-22. High-level workflow for the life cycle for \", \"Docker containerized applications using Docker CLI\\nStep 1: Start coding in Visual Studio Code and cr\", \"eate your initial app/service\\nbaseline\\nThe way you develop your application is similar to the way yo\", \"u do it without Docker. The difference is\\nthat while developing, you\\u2019re deploying and testing your a\", \"pplication or services running within Docker\\ncontainers placed in your local environment (like a Lin\", \"ux VM or Windows).\\nSetting up your local environment\\nWith the latest versions of Docker Desktop for \", \"Mac and Windows, it\\u2019s easier than ever to develop\\nDocker applications, and the setup is straightforw\", \"ard.\\nTip\\nFor instructions on setting up Docker Desktop for Windows, go to https://docs.docker.com/do\", \"cker-\\nfor-windows/.\\nFor instructions on setting up Docker Desktop for Mac, go to https://docs.docker\", \".com/docker-for-\\nmac/.\\nIn addition, you\\u2019ll need a code editor so that you can actually develop your \", \"application while using\\nDocker CLI.\\n42 CHAPTER 4 | Designing and developing containerized apps using\", \" Docker and Microsoft AzureMicrosoft provides Visual Studio Code, which is a lightweight code editor\", \" that\\u2019s supported on\\nWindows, Linux, and macOS, and provides IntelliSense with support for many lang\", \"uages (JavaScript,\\n.NET, Go, Java, Ruby, Python, and most modern languages), debugging, integration \", \"with Git and\\nextensions support. This editor is a great fit for macOS and Linux developers. In Windo\", \"ws, you also\\ncan use Visual Studio.\\nTip\\nFor instructions on installing Visual Studio Code for Window\", \"s, Linux, or macOS, go to\\nhttps://code.visualstudio.com/docs/setup/setup-overview/.\\nFor instructions\", \" on setting up Docker for Mac, go to https://docs.docker.com/docker-for-mac/.\\nYou can work with Dock\", \"er CLI and write your code using any code editor, but using Visual Studio\\nCode with the Docker exten\", \"sion makes it easy to author Dockerfile and docker-compose.yml files in\\nyour workspace. You can also\", \" run tasks and scripts from the Visual Studio Code IDE to execute Docker\\ncommands using the Docker C\", \"LI underneath.\\nThe Docker extension for VS Code provides the following features:\\n\\u2022 Automatic Dockerf\", \"ile and docker-compose.yml file generation\\n\\u2022 Syntax highlighting and hover tips for docker-compose.y\", \"ml and Dockerfile files\\n\\u2022 IntelliSense (completions) for Dockerfile and docker-compose.yml files\\n\\u2022 L\", \"inting (errors and warnings) for Dockerfile files\\n\\u2022 Command Palette (F1) integration for the most co\", \"mmon Docker commands\\n\\u2022 Explorer integration for managing Images and Containers\\n\\u2022 Deploy images from \", \"DockerHub and Azure Container Registries to Azure App Service\\nTo install the Docker extension, press\", \" Ctrl+Shift+P, type ext install, and then run the Install Extension\\ncommand to bring up the Marketpl\", \"ace extension list. Next, type docker to filter the results, and then\\nselect the Docker Support exte\", \"nsion, as depicted in Figure 4-23.\\nFigure 4-23. Installing the Docker Extension in Visual Studio Cod\", \"e\\n43 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureStep 2:\", \" Create a DockerFile related to an existing image (plain OS or dev\\nenvironments like .NET, Node.js, \", \"and Ruby)\\nYou\\u2019ll need a DockerFile per custom image to be built and per container to be deployed. If\", \" your app is\\nmade up of single custom service, you\\u2019ll need a single DockerFile. But if your app is c\", \"omposed of\\nmultiple services (as in a microservices architecture), you\\u2019ll need one Dockerfile per se\", \"rvice.\\nThe DockerFile is commonly placed in the root folder of your app or service and contains the \", \"required\\ncommands so that Docker knows how to set up and run that app or service. You can create you\", \"r\\nDockerFile and add it to your project along with your code (node.js, .NET, etc.), or, if you\\u2019re ne\", \"w to the\\nenvironment, take a look at the following Tip.\\nTip\\nYou can use the Docker extension to guid\", \"e you when using the Dockerfile and docker-compose.yml\\nfiles related to your Docker containers. Even\", \"tually, you\\u2019ll probably write these kinds of files without\\nthis tool, but using the Docker extension\", \" is a good starting point that will accelerate your learning\\ncurve.\\nIn Figure 4-24, you can see the \", \"steps to add the docker files to a project by using the Docker\\nExtension for VS Code:\\n1. Open the co\", \"mmand palette, type \\u201cdocker\\u201d and select \\u201cAdd Docker Files to Workspace\\u201d.\\n2. Select Application Platf\", \"orm (ASP.NET Core)\\n3. Select Operating System (Linux)\\n4. Include optional Docker Compose files\\n5. En\", \"ter ports to publish (80, 443)\\n6. Select the project\\n44 CHAPTER 4 | Designing and developing contain\", \"erized apps using Docker and Microsoft AzureFigure 4-24. Docker files added using the Add Docker fil\", \"es to Workspace command\\nWhen you add a DockerFile, you specify what base Docker image you\\u2019ll be usin\", \"g (like using FROM\\nmcr.microsoft.com/dotnet/aspnet). You\\u2019ll usually build your custom image on top o\", \"f a base image\\nthat you get from any official repository at the Docker Hub registry (like an image f\", \"or .NET or the one\\nfor Node.js).\\nTip\\nYou\\u2019ll have to repeat this procedure for every project in your \", \"application. However, the extension will\\nask to overwrite the generated docker-compose file after th\", \"e first time. You should reply to not\\noverwrite it, so the extension creates separate docker-compose\", \" files, that you can then merge by\\nhand, prior to running docker-compose.\\nUse an existing official D\", \"ocker image\\nUsing an official repository of a language stack with a version number ensures that the \", \"same language\\nfeatures are available on all machines (including development, testing, and production\", \").\\nThe following is a sample DockerFile for a .NET container:\\n45 CHAPTER 4 | Designing and developin\", \"g containerized apps using Docker and Microsoft AzureFROM mcr.microsoft.com/dotnet/aspnet:6.0 AS bas\", \"e\\nWORKDIR /app\\nEXPOSE 80\\nEXPOSE 443\\nFROM mcr.microsoft.com/dotnet/sdk:6.0 AS build\\nWORKDIR /src\\nCOPY\", \" [\\\"src/WebApi/WebApi.csproj\\\", \\\"src/WebApi/\\\"]\\nRUN dotnet restore \\\"src/WebApi/WebApi.csproj\\\"\\nCOPY . .\\n\", \"WORKDIR \\\"/src/src/WebApi\\\"\\nRUN dotnet build \\\"WebApi.csproj\\\" -c Release -o /app/build\\nFROM build AS pu\", \"blish\\nRUN dotnet publish \\\"WebApi.csproj\\\" -c Release -o /app/publish\\nFROM base AS final\\nWORKDIR /app\\n\", \"COPY --from=publish /app/publish .\\nENTRYPOINT [\\\"dotnet\\\", \\\"WebApi.dll\\\"]\\nIn this case, the image is ba\", \"sed on version 6.0 of the official ASP.NET Core Docker image (multi-arch\\nfor Linux and Windows), as \", \"per the line FROM mcr.microsoft.com/dotnet/aspnet:6.0. (For more\\ninformation about this topic, see t\", \"he ASP.NET Core Docker Image page and the .NET Docker Image\\npage).\\nIn the DockerFile, you can also i\", \"nstruct Docker to listen to the TCP port that you\\u2019ll use at run time\\n(such as port 80 or 443).\\nYou c\", \"an specify additional configuration settings in the Dockerfile, depending on the language and\\nframew\", \"ork you\\u2019re using. For instance, the ENTRYPOINT line with [\\\"dotnet\\\", \\\"WebMvcApplication.dll\\\"]\\ntells D\", \"ocker to run a .NET application. If you\\u2019re using the SDK and the .NET CLI (dotnet CLI) to build\\nand \", \"run the .NET application, this setting would be different. The key point here is that the\\nENTRYPOINT\", \" line and other settings depend on the language and platform you choose for your\\napplication.\\nTip\\nFo\", \"r more information about building Docker images for .NET applications, see\\nhttps://learn.microsoft.c\", \"om/dotnet/core/docker/build-container.\\nTo learn more about building your own images, go to\\nhttps://d\", \"ocs.docker.com/engine/tutorials/dockerimages/.\\nUse multi-arch image repositories\\nA single image name\", \" in a repo can contain platform variants, such as a Linux image and a Windows\\nimage. This feature al\", \"lows vendors like Microsoft (base image creators) to create a single repo to\\ncover multiple platform\", \"s (that is, Linux and Windows). For example, the dotnet/aspnet repository\\navailable in the Docker Hu\", \"b registry provides support for Linux and Windows Nano Server by using\\nthe same image name.\\nPulling \", \"the dotnet/aspnet image from a Windows host pulls the Windows variant, whereas pulling the\\nsame imag\", \"e name from a Linux host pulls the Linux variant.\\n46 CHAPTER 4 | Designing and developing containeri\", \"zed apps using Docker and Microsoft AzureCreate your base image from scratch\\nYou can create your own\", \" Docker base image from scratch as explained in this article from Docker. This\\nscenario is probably \", \"not the best for you if you\\u2019re just starting with Docker, but if you want to set the\\nspecific bits o\", \"f your own base image, you can do it.\\nStep 3: Create your custom Docker images embedding your servic\", \"e in it\\nFor each custom service that comprises your app, you\\u2019ll need to create a related image. If y\", \"our app is\\nmade up of a single service or web app, you\\u2019ll need just a single image.\\nNote\\nWhen taking\", \" into account the \\u201couter-loop DevOps workflow\\u201d, the images will be created by an\\nautomated build pro\", \"cess whenever you push your source code to a Git repository (Continuous\\nIntegration), so the images \", \"will be created in that global environment from your source code.\\nBut before you consider going to t\", \"hat outer-loop route, you need to ensure that the Docker\\napplication is actually working properly so\", \" that they don\\u2019t push code that might not work properly to\\nthe source control system (Git, etc.).\\nTh\", \"erefore, each developer first needs to do the entire inner-loop process to test locally and continue\", \"\\ndeveloping until they want to push a complete feature or change to the source control system.\\nTo cr\", \"eate an image in your local environment and using the DockerFile, you can use the docker build\\ncomma\", \"nd, as shown in Figure 4-25, because it already tags the image for you and builds the images\\nfor all\", \" services in the application with a simple command.\\nFigure 4-25. Running docker build\\nOptionally, in\", \"stead of directly running docker build from the project folder, you first can generate a\\ndeployable \", \"folder with the .NET libraries needed by using the run dotnet publish command, and then\\nrun docker b\", \"uild.\\nThis example creates a Docker image with the name webapi:latest (:latest is a tag, like a spec\", \"ific\\nversion). You can take this step for each custom image you need to create for your composed Doc\", \"ker\\n47 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azureappli\", \"cation with several containers. However, we\\u2019ll see in the next section that it\\u2019s easier to do this\\nu\", \"sing docker-compose.\\nYou can find the existing images in your local repository (your development mac\", \"hine) by using the\\ndocker images command, as illustrated in Figure 4-26.\\nFigure 4-26. Viewing existi\", \"ng images using docker images\\nStep 4: Define your services in docker-compose.yml when building a com\", \"posed\\nDocker app with multiple services\\nWith the docker-compose.yml file, you can define a set of re\", \"lated services to be deployed as a\\ncomposed application with the deployment commands explained in th\", \"e next step section.\\nCreate that file in your main or root solution folder; it should have content s\", \"imilar to that shown in this\\ndocker-compose.yml file:\\nversion: \\\"3.4\\\"\\nservices:\\nwebapi:\\nimage: webapi\", \"\\nbuild:\\ncontext: .\\ndockerfile: src/WebApi/Dockerfile\\nports:\\n- 51080:80\\ndepends_on:\\n- redis\\nenvironme\", \"nt:\\n- ASPNETCORE_ENVIRONMENT=Development\\n- ASPNETCORE_URLS=http://+:80\\nwebapp:\\nimage: webapp\\nbuild:\\n\", \"context: .\\ndockerfile: src/WebApp/Dockerfile\\nports:\\n- 50080:80\\nenvironment:\\n- ASPNETCORE_ENVIRONMENT\", \"=Development\\n- ASPNETCORE_URLS=http://+:80\\n- WebApiBaseAddress=http://webapi\\nredis:\\nimage: redis\\nIn \", \"this particular case, this file defines three services: the web API service (your custom service), a\", \" web\\napplication, and the Redis service (a popular cache service). Each service will be deployed as \", \"a\\ncontainer, so you need to use a concrete Docker image for each. For this particular application:\\n4\", \"8 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azure\\u2022 The web \", \"API service is built from the DockerFile in the src/WebApi/Dockerfile directory.\\n\\u2022 The host port 510\", \"80 is forwarded to the exposed port 80 on the webapi container.\\n\\u2022 The web API service depends on the\", \" Redis service\\n\\u2022 The web application accesses the web API service using the internal address: http:/\", \"/webapi.\\n\\u2022 The Redis service uses the latest public redis image pulled from the Docker Hub registry.\", \"\\nRedis is a popular cache system for server-side applications.\\nStep 5: Build and run your Docker app\", \"\\nIf your app has only a single container, you just need to run it by deploying it to your Docker Hos\", \"t\\n(VM or physical server). However, if your app is made up of multiple services, you need to compose\", \" it,\\ntoo. Let\\u2019s see the different options.\\nOption A: Run a single container or service\\nYou can run t\", \"he Docker image by using the docker run command, as shown here:\\ndocker run -t -d -p 50080:80 webapp:\", \"latest\\nFor this particular deployment, we\\u2019ll be redirecting requests sent to port 50080 on the host \", \"to the\\ninternal port 80.\\nOption B: Compose and run a multiple-container application\\nIn most enterpri\", \"se scenarios, a Docker application will be composed of multiple services. For these\\ncases, you can r\", \"un the docker-compose up command (Figure 4-27), which will use the docker-\\ncompose.yml file that you\", \" created previously. Running this command builds all custom images and\\ndeploys the composed applicat\", \"ion with all of its related containers.\\n49 CHAPTER 4 | Designing and developing containerized apps u\", \"sing Docker and Microsoft AzureFigure 4-27. Results of running the \\u201cdocker-compose up\\u201d command\\nAfter\", \" you run docker-compose up, you deploy your application and its related container(s) into your\\nDocke\", \"r Host, as illustrated in Figure 4-28, in the VM representation.\\nFigure 4-28. VM with Docker contain\", \"ers deployed\\nStep 6: Test your Docker application (locally, in your local CD VM)\\nThis step will vary\", \" depending on what your app is doing.\\nIn a simple .NET Web API \\u201cHello World\\u201d deployed as a single co\", \"ntainer or service, you\\u2019d just need to\\naccess the service by providing the TCP port specified in the\", \" DockerFile.\\nOn the Docker host, open a browser and navigate to that site; you should see your app/s\", \"ervice\\nrunning, as demonstrated in Figure 4-29.\\n50 CHAPTER 4 | Designing and developing containerize\", \"d apps using Docker and Microsoft AzureFigure 4-29. Testing your Docker application locally by using\", \" the browser\\nNote that it\\u2019s using port 50080, but internally it\\u2019s being redirected to port 80, becau\", \"se that\\u2019s how it\\nwas deployed with docker compose, as explained earlier.\\nYou can test this by using \", \"the browser using CURL from the terminal, as depicted in Figure 4-30.\\nFigure 4-30. Testing a Docker \", \"application locally by using CURL\\nDebugging a container running on Docker\\nVisual Studio Code support\", \"s debugging Docker if you\\u2019re using Node.js and other platforms like .NET\\ncontainers.\\n51 CHAPTER 4 | \", \"Designing and developing containerized apps using Docker and Microsoft AzureYou also can debug .NET \", \"or .NET Framework containers in Docker when using Visual Studio for\\nWindows or Mac, as described in \", \"the next section.\\nTip\\nTo learn more about debugging Node.js Docker containers, see\\nhttps://learn.mic\", \"rosoft.com/archive/blogs/user_ed/visual-studio-code-new-features-13-big-\\ndebugging-updates-rich-obje\", \"ct-hover-conditional-breakpoints-node-js-mono-more.\\nUse Docker Tools in Visual Studio on Windows\\nThe\", \" developer workflow when using the Docker Tools included in Visual Studio 2022 version 17.0 and\\nlate\", \"r, is similar to using Visual Studio Code and Docker CLI (in fact, it\\u2019s based on the same Docker CLI\", \"),\\nbut it\\u2019s easier to get started, simplifies the process, and provides greater productivity for the\", \" build,\\nrun, and compose tasks. It can also run and debug your containers via the usual F5 and Ctrl+\", \"F5keys\\nfrom Visual Studio. You can even debug a whole solution if its containers are defined in the \", \"same\\ndocker-compose.yml file at the solution level.\\nConfigure your local environment\\nWith the latest\", \" versions of Docker for Windows, it\\u2019s easier than ever to develop Docker applications\\nbecause the se\", \"tup is straightforward, as explained in the following references.\\nTip\\nTo learn more about installing\", \" Docker for Windows, go to (https://docs.docker.com/docker-for-\\nwindows/).\\nDocker support in Visual \", \"Studio\\nThere are two levels of Docker support you can add to a project. In ASP.NET Core projects, yo\", \"u can\\njust add a Dockerfile file to the project by enabling Docker support. The next level is contai\", \"ner\\norchestration support, which adds a Dockerfile to the project (if it doesn\\u2019t already exist) and \", \"a docker-\\ncompose.yml file at the solution level. Container orchestration support, via Docker Compos\", \"e, is\\navailable in Visual Studio 2022 versions 17.0. Container orchestration support is an opt-in fe\", \"ature in\\nVisual Studio 2022 versions 17.0 or later. Visual Studio 2022 also supports Kubernetes/Helm\", \"\\ndeployment.\\nThe Add > Docker Support and Add > Container Orchestrator Support commands are located \", \"on\\nthe right-click menu (or context menu) of the project node for an ASP.NET Core project in Solutio\", \"n\\nExplorer, as shown in Figure 4-31:\\n52 CHAPTER 4 | Designing and developing containerized apps usin\", \"g Docker and Microsoft AzureFigure 4-31. Adding Docker support to a Visual Studio project\\nAdd Docker\", \" support\\nBesides the option to add Docker support to an existing application, as shown in the previo\", \"us section,\\nyou can also enable Docker support during project creation by selecting Enable Docker Su\", \"pport in\\nthe New ASP.NET Core Web Application dialog box that opens after you click OK in the New\\nPr\", \"oject dialog box, as shown in Figure 4-32.\\n53 CHAPTER 4 | Designing and developing containerized app\", \"s using Docker and Microsoft AzureFigure 4-32. Enable Docker support during project creation in Visu\", \"al Studio\\nWhen you add or enable Docker support, Visual Studio adds a Dockerfile file to the project\", \", that\\nincludes references to all required project from the solution.\\nAdd container orchestration su\", \"pport\\nWhen you want to compose a multi-container solution, add container orchestration support to yo\", \"ur\\nprojects. This lets you run and debug a group of containers (a whole solution) at the same time i\", \"f\\nthey\\u2019re defined in the same docker-compose.yml file.\\nTo add container orchestration support, right\", \"-click on the project node in Solution Explorer, and\\nchoose Add > Container Orchestration Support. T\", \"hen choose Docker Compose to manage the\\ncontainers.\\nAfter you add container orchestration support to\", \" your project, you see a Dockerfile added to the\\nproject and a docker-compose folder added to the so\", \"lution in Solution Explorer, as shown in Figure\\n4-33:\\n54 CHAPTER 4 | Designing and developing contai\", \"nerized apps using Docker and Microsoft AzureFigure 4-33. Docker files in Solution Explorer in Visua\", \"l Studio\\nIf docker-compose.yml already exists, Visual Studio just adds the required lines of configu\", \"ration code\\nto it.\\nConfigure Docker tools\\nFrom the main menu, choose Tools > Options, and expand Con\", \"tainer Tools > Settings. The\\ncontainer tools settings appear.\\n55 CHAPTER 4 | Designing and developin\", \"g containerized apps using Docker and Microsoft AzureFigure 4-34. Docker Tools Options\\nFor more deta\", \"iled configurations refer to Container Tools settings\\nTip\\nFor further details on the services implem\", \"entation and use of Visual Studio Tools for Docker, read the\\nfollowing articles:\\nUse the Containers \", \"tool window to view container details such as the filesystem, logs, environment,\\nports, and more: ht\", \"tps://learn.microsoft.com/visualstudio/containers/view-and-diagnose-containers\\nDebug apps in a local\", \" Docker container: https://learn.microsoft.com/visualstudio/containers/edit-and-\\nrefresh\\nDeploy an A\", \"SP.NET container to a container registry using Visual Studio:\\nhttps://learn.microsoft.com/visualstud\", \"io/containers/hosting-web-apps-in-docker\\nUsing Windows PowerShell commands in a\\nDockerFile to set up\", \" Windows Containers (Docker\\nstandard based)\\nWith Windows Containers, you can convert your existing W\", \"indows applications to Docker images and\\ndeploy them with the same tools as the rest of the Docker e\", \"cosystem.\\n56 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azur\", \"eTo use Windows Containers, you just need to write Windows PowerShell commands in the DockerFile,\\nas\", \" demonstrated in the following example:\\nFROM mcr.microsoft.com/windows/servercore:ltsc2019\\nLABEL Des\", \"cription=\\\"IIS\\\" Vendor=\\\"Microsoft\\\" Version=\\\"10\\\"\\nRUN powershell Get-WindowsFeature web-server\\nRUN powe\", \"rshell Install-windowsfeature web-server\\nRUN powershell add-windowsfeature web-asp-net45\\nCMD [ \\\"ping\", \"\\\", \\\"localhost\\\", \\\"-t\\\" ]\\nIn this case, we\\u2019re using Windows PowerShell to install a Windows Server Core\", \" base image as well\\nas IIS.\\nIn a similar way, you also could use Windows PowerShell commands to set \", \"up additional components\\nlike the traditional ASP.NET 4.x and .NET Framework 4.6 or any other Window\", \"s software, as shown\\nhere:\\nRUN powershell add-windowsfeature web-asp-net45\\nBuild ASP.NET Core applic\", \"ations deployed as Linux\\ncontainers into an AKS/Kubernetes orchestrator\\nAzure Kubernetes Services (A\", \"KS) is Azure\\u2019s managed Kubernetes orchestrations services that simplify\\ncontainer deployment and man\", \"agement.\\nThe main features of AKS are:\\n\\u2022 An Azure-hosted control plane.\\n\\u2022 Automated upgrades.\\n\\u2022 Self\", \"-healing.\\n\\u2022 User-configurable scaling.\\n\\u2022 Simpler user experience for both developers and cluster ope\", \"rators.\\nThe following examples explore the creation of an ASP.NET Core 6.0 application that runs on \", \"Linux\\nand deploys to an AKS Cluster in Azure. Development is done using Visual Studio 2022 version 1\", \"7.0.\\nCreating the ASP.NET Core Project using Visual Studio 2022\\nASP.NET Core is a general-purpose de\", \"velopment platform maintained by Microsoft and the .NET\\ncommunity on GitHub. It\\u2019s cross-platform, su\", \"pporting Windows, macOS and Linux, and can be used in\\ndevice, cloud, and embedded/IoT scenarios.\\nThi\", \"s example uses a couple of simple projects based on Visual Studio templates, so you don\\u2019t need\\nmuch \", \"additional knowledge to create the sample. You only have to create the project using a\\nstandard temp\", \"late that includes all the elements to run a small project with a REST API and a Web\\nApp with Razor \", \"pages, using ASP.NET Core 6.0 technology.\\nFor reference, you can download the sample from .NET Appli\", \"cation Architecture\\u2019s repo explore-\\ndocker.\\n57 CHAPTER 4 | Designing and developing containerized ap\", \"ps using Docker and Microsoft AzureFigure 4-35. Creating an ASP.NET Core Web Application in Visual S\", \"tudio 2022.\\nTo create the sample project in Visual Studio, select File > New > Project, select the W\", \"eb project\\ntype and then the ASP.NET Core Web Api template. You can also search for the template if \", \"you need\\nit.\\nThen enter the application name and location as shown in the next image.\\n58 CHAPTER 4 |\", \" Designing and developing containerized apps using Docker and Microsoft AzureFigure 4-36. Enter the \", \"project name and location in Visual Studio 2022.\\nVerify that you\\u2019ve selected ASP.NET Core 6.0 as the\", \" framework. .NET 6 is included in the latest release\\nof Visual Studio 2022 and is automatically inst\", \"alled and configured for you when you install Visual\\nStudio.\\n59 CHAPTER 4 | Designing and developing\", \" containerized apps using Docker and Microsoft AzureFigure 4-37. Selecting ASP.NET CORE 6.0 and Web \", \"API project type\\nNotice Docker support is not enabled now. You\\u2019ll do that in the next step after the\", \" project creation.\\nYou\\u2019ll also notice that by default controller option is checked. You can uncheck \", \"that if you want to\\nCreate a minimal web API with ASP.NET Core.\\nTo show you can \\u201cDockerize\\u201d your pro\", \"ject at any time, you\\u2019ll add Docker support now. So right-click\\non the project node in Solution Expl\", \"orer and select Add > Docker support on the context menu.\\n60 CHAPTER 4 | Designing and developing co\", \"ntainerized apps using Docker and Microsoft AzureFigure 4-38. Adding Docker support to an existing p\", \"roject\\nTo complete adding Docker support, you can choose Windows or Linux. In this case, select Linu\", \"x.\\nFigure 4-39. Selecting Linux containers.\\n61 CHAPTER 4 | Designing and developing containerized ap\", \"ps using Docker and Microsoft AzureWith these simple steps, you have your ASP.NET Core 6.0 applicati\", \"on running on a Linux container.\\nIn a similar way, you can also add a very simple WebApp project (Fi\", \"gure 4-40) to consume the web\\nAPI endpoint, although the details can be seen in the code repo.\\nAfter\", \" that, you add orchestrator support for your WebApi project as shown next, in image 4-40.\\nFigure 4-4\", \"0. Adding orchestrator support to WebApi project.\\nWhen you choose the Docker Compose option, which i\", \"s fine for local development, Visual Studio\\nadds the docker-compose project, with the docker-compose\", \" files as shown in image 4-41.\\n62 CHAPTER 4 | Designing and developing containerized apps using Dock\", \"er and Microsoft AzureFigure 4-41. Adding orchestrator support to WebApi project.\\nThe initial files \", \"added are similar to these ones:\\ndocker-compose.yml\\nversion: \\\"3.4\\\"\\nservices:\\nwebapi:\\nimage: ${DOCKER\", \"_REGISTRY-}webapi\\nbuild:\\ncontext: .\\ndockerfile: WebApi/Dockerfile\\nwebapp:\\nimage: ${DOCKER_REGISTRY-}\", \"webapp\\nbuild:\\ncontext: .\\ndockerfile: WebApp/Dockerfile\\ndocker-compose.override.yml\\nversion: \\\"3.4\\\"\\nse\", \"rvices:\\nwebapi:\\nenvironment:\\n- ASPNETCORE_ENVIRONMENT=Development\\n- ASPNETCORE_URLS=https://+:443;ht\", \"tp://+:80\\nports:\\n- \\\"80\\\"\\n- \\\"443\\\"\\nvolumes:\\n- ${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersec\", \"rets:ro\\n- ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro\\nwebapp:\\nenvironment:\\n- ASPNETCORE_ENVIRONM\", \"ENT=Development\\n- ASPNETCORE_URLS=https://+:443;http://+:80\\nports:\\n- \\\"80\\\"\\n- \\\"443\\\"\\n63 CHAPTER 4 | Des\", \"igning and developing containerized apps using Docker and Microsoft Azurevolumes:\\n- ${APPDATA}/Micro\", \"soft/UserSecrets:/root/.microsoft/usersecrets:ro\\n- ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro\\nT\", \"o run your app with Docker Compose, you just have to make a few tweaks to docker-\\ncompose.override.y\", \"ml.\\nservices:\\nwebapi:\\n#...\\nports:\\n- \\\"51080:80\\\"\\n- \\\"51443:443\\\"\\n#...\\nwebapp:\\nenvironment:\\n#...\\n- WebApi\", \"BaseAddress=http://webapi\\nports:\\n- \\\"50080:80\\\"\\n- \\\"50443:443\\\"\\n#...\\nNow you can run your application wi\", \"th the F5 key, or by using the Play button, or the Ctrl+F5 key,\\nselecting the docker-compose project\", \", as shown in image 4-42.\\nFigure 4-42. Adding orchestrator support to WebApi project.\\nWhen running t\", \"he docker-compose application as explained, you get:\\n1. The images built and containers created as p\", \"er the docker-compose file.\\n2. The browser open in the address configured in the \\u201cProperties\\u201d dialog\", \" for the docker-\\ncompose project.\\n3. The Container window open (in Visual Studio 2022 version 17.0 a\", \"nd later).\\n4. Debugger support for all projects in the solution, as shown in the following images.\\nB\", \"rowser opened:\\n64 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft\", \" AzureFigure 4-43. Browser window with an application running on multiple containers.\\nContainers win\", \"dow:\\nFigure 4-44. Visual Studio \\u201cContainers\\u201d window\\nThe Containers window lets you view running cont\", \"ainers, browse available images, view environment\\nvariables, logs, and port mappings, inspect the fi\", \"lesystem, attach a debugger, or open a terminal\\nwindow inside the container environment.\\nAs you can \", \"see, the integration between Visual Studio 2022 and Docker is completely oriented to the\\ndeveloper\\u2019s\", \" productivity.\\nOf course, you can also list the images using the docker images command. You should s\", \"ee the webapi\\nand webapp images with the dev tags created by the automatic deployment of our project\", \" with Visual\\nStudio 2022.\\ndocker images\\n65 CHAPTER 4 | Designing and developing containerized apps u\", \"sing Docker and Microsoft AzureFigure 4-45. View of Docker images\\nRegister the Solution in an Azure \", \"Container Registry (ACR)\\nYou can upload the images to the Azure Container Registry (ACR), but you co\", \"uld also use Docker Hub\\nor any other registry, so the images can be deployed to the AKS cluster from\", \" that registry.\\nCreate an ACR instance\\nRun the following command from the az cli:\\naz acr create --na\", \"me exploredocker --resource-group explore-docker-aks-rg --sku basic\\n--admin-enabled\\nNote\\nThe contain\", \"er registry name (for example, exploredocker) must be unique within Azure and contain 5-\\n50 alphanum\", \"eric characters. For more details, see Create a container registry.\\nCreate the image in Release mode\", \"\\nYou\\u2019ll now create the image in Release mode (ready for production) by changing to Release, as\\nshown\", \" in Figure 4-46, and running the application as you did before.\\nFigure 4-46. Selecting Release Mode\\n\", \"If you execute the docker images command, you\\u2019ll see both images created, one for debug (dev) and\\nth\", \"e other for release (latest) mode.\\nCreate a new Tag for the Image\\nEach container image needs to be t\", \"agged with the loginServer name of the registry. This tag is used\\nfor routing when pushing container\", \" images to an image registry.\\nYou can view the loginServer name from the Azure portal, taking the in\", \"formation from the Azure\\nContainer Registry\\n66 CHAPTER 4 | Designing and developing containerized ap\", \"ps using Docker and Microsoft AzureFigure 4-47. View of the name of the Registry\\nOr by running the f\", \"ollowing command:\\naz acr list --resource-group <resource-group-name> --query\\n\\\"[].{acrLoginServer:log\", \"inServer}\\\" --output table\\nFigure 4-48. Get the name of the registry using az cli\\nIn both cases, you\\u2019\", \"ll obtain the name. In our example, exploredocker.azurecr.io.\\nNow you can tag the image, taking the \", \"latest image (the Release image), with the command:\\ndocker tag <image-name>:latest <login-server-nam\", \"e>/<image-name>:v1\\nAfter running the docker tag command, list the images with the docker images comm\", \"and, and you\\nshould see the image with the new tag.\\nFigure 4-49. View of tagged images\\nPush the imag\", \"e into the Azure ACR\\nLog in to the Azure Container Registry\\naz acr login --name exploredocker\\nPush t\", \"he image into the Azure ACR, using the following command:\\ndocker push <login-server-name>/<image-nam\", \"e>:v1\\n67 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureThi\", \"s command takes a while uploading the images but gives you feedback in the process. In the\\nfollowing\", \" image, you can see the output from one image completed and another in progress.\\nFigure 4-50. Consol\", \"e output from the push command.\\nTo deploy your multi-container app into your AKS cluster you need so\", \"me manifest .yaml files that\\nhave, most of the properties taken from the docker-compose.yml and dock\", \"er-compose.override.yml\\nfiles.\\ndeploy-webapi.yml\\napiVersion: apps/v1\\nkind: Deployment\\nmetadata:\\nname\", \": webapi\\nlabels:\\napp: weather-forecast\\nspec:\\nreplicas: 1\\nselector:\\nmatchLabels:\\nservice: webapi\\ntemp\", \"late:\\nmetadata:\\nlabels:\\napp: weather-forecast\\nservice: webapi\\nspec:\\ncontainers:\\n- name: webapi\\nimage\", \": exploredocker.azurecr.io/webapi:v1\\nimagePullPolicy: IfNotPresent\\nports:\\n- containerPort: 80\\nprotoc\", \"ol: TCP\\nenv:\\n- name: ASPNETCORE_URLS\\nvalue: http://+:80\\n68 CHAPTER 4 | Designing and developing cont\", \"ainerized apps using Docker and Microsoft Azure---\\napiVersion: v1\\nkind: Service\\nmetadata:\\nname: weba\", \"pi\\nlabels:\\napp: weather-forecast\\nservice: webapi\\nspec:\\nports:\\n- port: 80\\ntargetPort: 80\\nprotocol: TC\", \"P\\nselector:\\nservice: webapi\\ndeploy-webapp.yml\\napiVersion: apps/v1\\nkind: Deployment\\nmetadata:\\nname: w\", \"ebapp\\nlabels:\\napp: weather-forecast\\nspec:\\nreplicas: 1\\nselector:\\nmatchLabels:\\nservice: webapp\\ntemplat\", \"e:\\nmetadata:\\nlabels:\\napp: weather-forecast\\nservice: webapp\\nspec:\\ncontainers:\\n- name: webapp\\nimage: e\", \"xploredocker.azurecr.io/webapp:v1\\nimagePullPolicy: IfNotPresent\\nports:\\n- containerPort: 80\\nprotocol:\", \" TCP\\nenv:\\n- name: ASPNETCORE_URLS\\nvalue: http://+:80\\n- name: WebApiBaseAddress\\nvalue: http://webapi\\n\", \"---\\napiVersion: v1\\nkind: Service\\nmetadata:\\nname: webapp\\nlabels:\\napp: weather-forecast\\nservice: webap\", \"p\\nspec:\\ntype: LoadBalancer\\nports:\\n- port: 80\\ntargetPort: 80\\nprotocol: TCP\\nselector:\\nservice: webapp\\n\", \"69 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureNote\\nThe \", \"previous .yml files only enable the HTTP ports, using the ASPNETCORE_URLS parameter, to avoid\\nissues\", \" with the missing certificate in the sample app.\\nTip\\nYou can see how to create the AKS Cluster for t\", \"his sample in section Deploy to Azure Kubernetes\\nService (AKS) on this guide.\\nNow you\\u2019re almost read\", \"y to deploy using kubectl, but first you must get the credentials from the AKS\\nCluster with this com\", \"mand:\\naz aks get-credentials --resource-group explore-docker-aks-rg --name explore-docker-aks\\nFigure\", \" 4-51. Getting credentials from AKS into the kubectl environment.\\nYou also have to allow the AKS clu\", \"ster to pull images from the ACR, using this command:\\naz aks update --name explore-docker-aks --reso\", \"urce-group explore-docker-aks-rg --attach-acr\\nexploredocker\\nThe previous command might take a couple\", \" of minutes to complete. Then, use the kubectl apply\\ncommand to launch the deployments, and then kub\", \"ectl get all to list the cluster objects.\\nkubectl apply -f deploy-webapi.yml\\nkubectl apply -f deploy\", \"-webapp.yml\\nkubectl get all\\n70 CHAPTER 4 | Designing and developing containerized apps using Docker \", \"and Microsoft AzureFigure 4-52. Deployment to Kubernetes\\nYou\\u2019ll have to wait a while until the load \", \"balancer gets the external IP, checking with kubectl get\\nservices, and then the application should b\", \"e available at that address, as shown in the next image:\\n71 CHAPTER 4 | Designing and developing con\", \"tainerized apps using Docker and Microsoft AzureFigure 4-53. Deployment to Kubernetes\\nWhen the deplo\", \"yment completes, you can access the Kubernetes Web UI with a local proxy, using an\\nssh tunnel.\\nFirst\", \" you must create a ClusterRoleBinding with the following command:\\nkubectl create clusterrolebinding \", \"kubernetes-dashboard --clusterrole=cluster-admin --\\nserviceaccount=kube-system:kubernetes-dashboard\\n\", \"And then this command to start the proxy:\\naz aks browse --resource-group exploredocker-aks-rg --name\", \" explore-docker-aks\\nA browser window should open at http://127.0.0.1:8001 with a view similar to thi\", \"s one:\\n72 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft AzureFi\", \"gure 4-54. View Kubernetes cluster information\\nNow you have your ASP.NET Core application, running i\", \"n Linux containers, and deployed to an AKS\\ncluster on Azure.\\nNote\\nFor more information on deployment\", \" with Kubernetes see:\\nhttps://kubernetes.io/docs/reference/kubectl/cheatsheet/\\n73 CHAPTER 4 | Design\", \"ing and developing containerized apps using Docker and Microsoft Azure5\\nCHAPTER\\nDocker application\\nD\", \"evOps workflow with\\nMicrosoft tools\\nMicrosoft Visual Studio, Azure DevOps Services and/or GitHub, Te\", \"am Foundation Server, and Azure\\nMonitor provide a comprehensive ecosystem for development and IT ope\", \"rations that give your team the\\ntools to manage projects and rapidly build, test, and deploy contain\", \"erized applications.\\nTeams can choose which tools and platforms they want to use for end to end DevO\", \"ps. With Visual\\nStudio and Azure DevOps Services in the cloud, along with Team Foundation Server on-\", \"premises,\\ndevelopment teams can productively build, test, and release containerized applications tha\", \"t target\\neither Windows or Linux. Alternatively, teams can also use Visual Studio Code and GitHub. T\", \"eams can\\neven use combinations: for example, storing source code in GitHub and using Azure Boards fo\", \"r work\\nitem tracking and Azure Pipelines for CI/CD.\\nMicrosoft tools can automate the pipeline for sp\", \"ecific implementations of containerized\\napplications\\u2014Docker, .NET, or any combination with other pla\", \"tforms\\u2014from global builds and\\nContinuous Integration (CI) and tests with Azure DevOps Services, Team\", \" Foundation Server or GitHub,\\nto Continuous Deployment (CD) to Docker environments (Development, Sta\", \"ging, Production), and to\\ntransmit analytics information about the services to the development team \", \"through Azure Monitor.\\nEvery code commit can initiate a build (CI) and automatically deploy the serv\", \"ices to specific\\ncontainerized environments (CD).\\nDevelopers and testers can easily and quickly prov\", \"ision production-like development and test\\nenvironments based on Docker by using templates in Micros\", \"oft Azure.\\nThe complexity of containerized application development increases steadily depending on t\", \"he\\nbusiness complexity and scalability needs. A good example of this complexity are applications bas\", \"ed\\non microservices architectures. To succeed in such an environment, your project must automate the\", \"\\nentire life cycle\\u2014not only the build and deployment, but it also must manage versions along with\\nth\", \"e collection of telemetry. Azure DevOps Services, GitHub and Azure offer the following capabilities:\", \"\\n\\u2022 Azure DevOps Services/Team Foundation Server source code management (based on Git or\\nTeam Foundat\", \"ion Version Control), Agile planning (Agile, Scrum, and CMMI are supported),\\nCI, release management,\", \" and other tools for Agile teams.\\n74 CHAPTER 5 | Docker application DevOps workflow with Microsoft t\", \"ools\\u2022 Azure DevOps Services and Team Foundation Server include a powerful and growing\\necosystem of f\", \"irst and third-party extensions with which you easily can construct a CI, build,\\ntest, delivery, and\", \" release management pipeline for microservices.\\n\\u2022 GitHub or GitHub Enterprise Server offer similar c\", \"apabilities, with source control based on Git,\\nProjects and Issues for project tracking, GitHub Acti\", \"ons for automating workflows including\\nCI/CD, and GitHub Advanced Security for dependency, secret an\", \"d vulnerability scanning.\\n\\u2022 Run automated tests as part of your build pipeline in Azure DevOps Servi\", \"ces or through\\nGitHub Actions\\n\\u2022 Azure DevOps Services/GitHub can tighten the DevOps life cycle with \", \"delivery to multiple\\nenvironments, not just for production environments, but also for testing, inclu\", \"ding A/B\\nexperimentation, canary releases, and so on.\\n\\u2022 Organizations easily can provision Docker co\", \"ntainers from private images stored in Azure\\nContainer Registry along with any dependency on Azure c\", \"omponents (Data, PaaS, etc.) using\\nAzure Resource Manager templates with tools they\\u2019re already comfo\", \"rtable with.\\nSteps in the outer-loop DevOps workflow for a\\nDocker application\\nFigure 5-1 presents an\", \" end-to-end depiction of the steps comprising the DevOps outer-loop\\nworkflow. It shows the \\u201couter lo\", \"op\\u201d of DevOps. When code is pushed to the repo, a CI pipeline is\\nstarted, then begins the CD pipelin\", \"e, where the application gets deployed. Metrics collected from\\ndeployed applications are fed back in\", \"to the development workload, where the \\u201cinner loop\\u201d occurs, so\\ndevelopment teams have actual data to\", \" respond to user and business needs.\\nFigure 5-1. DevOps outer-loop workflow for Docker applications \", \"with Microsoft tools\\nNow, let\\u2019s examine each of these steps in greater detail.\\n75 CHAPTER 5 | Docker\", \" application DevOps workflow with Microsoft toolsStep 1: Inner-loop development workflow\\nThis step i\", \"s explained in detail in Chapter 4, but, to recap, here is where the outer-loop begins, the\\nmoment a\", \"t which a developer pushes code to the source control management system (like Git)\\ninitiating CI pip\", \"eline actions.\\nStep 2: Source-Code Control integration and management with Azure\\nDevOps Services and\", \" Git\\nAt this step, you need to have a version-control system to gather a consolidated version of all\", \" the\\ncode coming from the different developers in the team.\\nEven though source-code control (SCC) an\", \"d source-code management might seem second-nature to\\nmost developers, when creating Docker applicati\", \"ons in a DevOps life cycle, it\\u2019s critical to emphasize\\nthat you must not submit the Docker images wi\", \"th the application directly to the global Docker\\nRegistry (like Azure Container Registry or Docker H\", \"ub) from the developer\\u2019s machine. On the contrary,\\nthe Docker images to be released and deployed to \", \"production environments must be created solely\\non the source code that\\u2019s being integrated in your gl\", \"obal build or CI pipeline based on your source-\\ncode repository (like Git).\\nThe local images, genera\", \"ted by developers, should just be used by them when testing within their\\nown machines. That\\u2019s why it\", \"\\u2019s critical to have the DevOps pipeline activated from the SCC code.\\nAzure DevOps Services and Team \", \"Foundation Server support Git and Team Foundation Version\\nControl. You can choose between them and u\", \"se it for an end-to-end Microsoft experience. However,\\nyou can also manage your code in external rep\", \"ositories (like GitHub, on-premises Git repositories, or\\nSubversion) and still be able to connect to\", \" it and get the code as the starting point for your DevOps CI\\npipeline. You can also use GitHub Acti\", \"ons for CI/CD pipelines.\\nStep 3: Build, CI, Integrate, and Test with Azure DevOps\\nServices/GitHub an\", \"d Docker\\nCI has emerged as a standard for modern software testing and delivery. The Docker solution\\n\", \"maintains a clear separation of concerns between the development and operations teams. The\\nimmutabil\", \"ity of Docker images ensures a repeatable deployment between what\\u2019s developed, tested\\nthrough CI, an\", \"d run in production. Docker Engine deployed across the developer laptops and test\\ninfrastructure mak\", \"es the containers portable across environments.\\nAt this point, after you have a version-control syst\", \"em with the correct code submitted, you need a\\nbuild service to pick up the code and run the global \", \"build and tests.\\nThe internal workflow for this step (CI, build, test) is about the construction of \", \"a CI pipeline consisting\\nof your code repository (Git, etc.), your build server (Azure DevOps Servic\", \"es/GitHub), Docker Engine,\\nand a Docker Registry.\\nYou can use Azure DevOps Services as the foundatio\", \"n for building your applications and setting your\\nCI pipeline, and for publishing the built \\u201cartifac\", \"ts\\u201d to an \\u201cartifacts repository,\\u201d which is explained in the\\nnext step. Alternatively, you can use Gi\", \"tHub to implement the same workflow.\\n76 CHAPTER 5 | Docker application DevOps workflow with Microsof\", \"t toolsWhen using Docker for the deployment, the \\u201cfinal artifacts\\u201d to be deployed are Docker images \", \"with\\nyour application or services embedded within them. Those images are pushed or published to a\\nDo\", \"cker Registry (a private repository like the ones you can have in Azure Container Registry, or a\\npub\", \"lic one like Docker Hub Registry or GitHub Container Registry, which is commonly used for official\\nb\", \"ase images).\\nHere is the basic concept: The CI pipeline will be kicked-off by a commit to an SCC rep\", \"ository like Git.\\nThe commit will cause Azure DevOps Services/GitHub to run a build job within a Doc\", \"ker container\\nand, upon successful completion of that job, push a Docker image to the Docker Registr\", \"y, as\\nillustrated in Figure 5-2. The first part of the outer loop involves steps 1 to 3, from code, \", \"run, debug\\nand validate, then the code repo up to the build and test CI step.\\nFigure 5-2. The steps \", \"involved in CI\\nHere are the basic CI workflow steps with Docker and Azure DevOps Services:\\n77 CHAPTE\", \"R 5 | Docker application DevOps workflow with Microsoft tools1. The developer pushes a commit to an \", \"SCC repository (Git/Azure DevOps Services, GitHub,\\netc.).\\n2. If you\\u2019re using Azure DevOps Services o\", \"r Git, CI is built in, which means that it\\u2019s as simple as\\nselecting a check box in Azure DevOps Serv\", \"ices. If you\\u2019re using an external SCC (like GitHub),\\na webhook will notify Azure DevOps Services of \", \"the update or push to Git/GitHub.\\n3. Azure DevOps Services pulls the SCC repository, including the D\", \"ockerfile describing the\\nimage, as well as the application and test code.\\n4. Azure DevOps Services b\", \"uilds a Docker image and labels it with a build number.\\n5. Azure DevOps Services instantiates the Do\", \"cker container within the provisioned Docker Host,\\nand runs the appropriate tests.\\n6. If the tests a\", \"re successful, the image is first relabeled to a meaningful name so that you know\\nit\\u2019s a \\u201cblessed bu\", \"ild\\u201d (like \\u201c/1.0.0\\u201d or any other label), and then pushed up to your Docker\\nRegistry (Docker Hub, Azu\", \"re Container Registry, DTR, etc.)\\nHere are the basic CI workflow steps with Docker and GitHub:\\n1. Th\", \"e developer pushes a commit to a GitHub repo.\\n2. CI is built in, so Actions will trigger base on the\", \" event filters.\\n3. GitHub pulls the SCC repository, including the Dockerfile describing the image, a\", \"s well as the\\napplication and test code.\\n4. GitHub builds a Docker image and labels it with a build \", \"number.\\n5. GitHub instantiates the Docker container within the provisioned Docker Host, and runs the\", \"\\nappropriate tests.\\n6. If the tests are successful, the image is first relabeled to a meaningful nam\", \"e so that you know\\nit\\u2019s a \\u201cblessed build\\u201d (like \\u201c/1.0.0\\u201d or any other label), and then pushed up to \", \"your Docker\\nRegistry (Docker Hub, Azure Container Registry, DTR, etc.)\\nImplement a CI pipeline with \", \"Azure DevOps Services and the Docker extension for\\nAzure DevOps Services\\nVisual Studio Azure DevOps \", \"Services contains Build & Release Templates that you can use in your\\nCI/CD pipeline with which you c\", \"an build Docker images, push Docker images to an authenticated\\nDocker registry, run Docker images, o\", \"r run other operations offered by the Docker CLI. It also adds a\\nDocker Compose task that you can us\", \"e to build, push, and run multi-container Docker applications, or\\nrun other operations offered by th\", \"e Docker Compose CLI, as shown in Figure 5-3.\\n78 CHAPTER 5 | Docker application DevOps workflow with\", \" Microsoft toolsFigure 5-3. The Docker CI pipeline in Azure DevOps Services including Build & Releas\", \"e Templates and associated tasks.\\nYou can use these templates and tasks to construct your CI/CD arti\", \"facts to Build / Test and Deploy in\\nAzure Service Fabric, Azure Kubernetes Service, and similar offe\", \"rings.\\nWith these Visual Studio Team Services tasks, a build Linux-Docker Host/VM provisioned in Azu\", \"re and\\nyour preferred Docker registry (Azure Container Registry, Docker Hub, private Docker DTR, or \", \"any\\nother Docker registry) you can assemble your Docker CI pipeline in a very consistent way.\\nRequir\", \"ements:\\n\\u2022 Azure DevOps Services, or for on-premises installations, Team Foundation Server 2015\\nUpdat\", \"e 3 or later.\\n\\u2022 An Azure DevOps Services agent that has the Docker binaries.\\nAn easy way to create o\", \"ne of these agents is to use Docker to run a container based on the\\nAzure DevOps Services agent Dock\", \"er image.\\nTip\\nTo read more about assembling an Azure DevOps Services Docker CI pipeline and view the\", \"\\nwalkthroughs, visit these sites:\\n\\u2022 Running a Visual Studio Team Services (Now Azure DevOps Services\", \") agent as a Docker\\ncontainer:\\nhttps://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent\\n79 CHAP\", \"TER 5 | Docker application DevOps workflow with Microsoft tools\\u2022 Building .NET Linux Docker images w\", \"ith Azure DevOps Services:\\nhttps://learn.microsoft.com/archive/blogs/stevelasker/building-net-core-l\", \"inux-docker-\\nimages-with-visual-studio-team-services\\n\\u2022 Building a Linux-based Visual Studio Team Ser\", \"vice build machine with Docker support:\\nhttps://www.donovanbrown.com/post/Building-a-Linux-Based-Vis\", \"ual-Studio-Team-Service-\\nBuild-Machine-with-Docker-Support\\nImplement a CI pipeline with GitHub Actio\", \"ns\\nGitHub Actions allow you to create automation scripts that can build Docker images, push Docker\\ni\", \"mages to an authenticated Docker registry, run Docker images, or run other operations offered by\\nthe\", \" Docker CLI.\\nYou can use public Actions (such as Azure Login) and run (shell) commands to construct \", \"your CI/CD\\nartifacts to Build / Test and Deploy in Azure Service Fabric, Azure Kubernetes Service, a\", \"nd similar\\nofferings.\\nWith these Actions, a build Linux-Docker Host/VM provisioned in Azure and your\", \" preferred Docker\\nregistry (Azure Container Registry, Docker Hub, private Docker DTR, or any other D\", \"ocker registry) you\\ncan assemble your Docker CI pipeline in a very consistent way.\\nIntegrate, test, \", \"and validate multi-container Docker applications\\nTypically, most Docker applications are composed of\", \" multiple containers rather than a single\\ncontainer. A good example is a microservices-oriented appl\", \"ication for which you would have one\\ncontainer per microservice. But, even without strictly followin\", \"g the microservices approach patterns,\\nit\\u2019s probable that your Docker application would be composed \", \"of multiple containers or services.\\nTherefore, after building the application containers in the CI p\", \"ipeline, you also need to deploy,\\nintegrate, and test the application as a whole with all of its con\", \"tainers within an integration Docker\\nhost or even into a test cluster to which your containers are d\", \"istributed.\\nIf you\\u2019re using a single host, you can use Docker commands such as docker-compose to bui\", \"ld and\\ndeploy related containers to test and validate the Docker environment in a single VM. But, if\", \" you\\u2019re\\nworking with an orchestrator cluster like DC/OS, Kubernetes, or Docker Swarm, you need to de\", \"ploy\\nyour containers through a different mechanism or orchestrator, depending on your selected\\nclust\", \"er/scheduler.\\nThe following are several types of tests that you can run against Docker containers:\\n\\u2022\", \" Unit tests for Docker containers\\n\\u2022 Testing groups of interrelated applications or microservices\\n\\u2022 T\", \"est in production and \\u201ccanary\\u201d releases\\nThe important point is that when running integration and fun\", \"ctional tests, you must run those tests\\nfrom outside of the containers. Tests are not contained or r\", \"un in the containers you\\u2019re deploying,\\nbecause the containers are based on static images that should\", \" be exactly like the ones you\\u2019ll be\\ndeploying to production.\\n80 CHAPTER 5 | Docker application DevOp\", \"s workflow with Microsoft toolsA practical option when testing more advanced scenarios, like includi\", \"ng several clusters (test cluster,\\nstaging cluster, and production cluster) is to publish the images\", \" to a registry, so it can be tested in\\nvarious clusters.\\nPush the custom application Docker image in\", \"to your global Docker Registry\\nAfter the Docker images have been tested and validated, you\\u2019ll want t\", \"o tag and publish them to your\\nDocker registry. The Docker registry is a critical piece in the Docke\", \"r application life cycle because it\\u2019s\\nthe central place where you store your custom test (also known\", \" as \\u201cblessed images\\u201d) to be deployed\\ninto QA and production environments.\\nSimilar to how the applica\", \"tion code stored in your SCC repository (Git, etc.) is your \\u201csource of truth,\\u201d\\nthe Docker registry i\", \"s your \\u201csource of truth\\u201d for your binary application or bits to be deployed to the\\nQA or production \", \"environments.\\nTypically, you might want to have your private repositories for your custom images eit\", \"her in a private\\nrepository in Azure Container Registry or in an on-premises registry like Docker Tr\", \"usted Registry, or in\\na public-cloud registry with restricted access (like Docker Hub), although in \", \"this last case if your code\\nis not open source, you must trust the vendor\\u2019s security. Either way, th\", \"e method you use is similar and\\nis based on the docker push command, as shown in Figure 5-4.\\n81 CHAP\", \"TER 5 | Docker application DevOps workflow with Microsoft toolsFigure 5-4. Publishing custom images \", \"to Docker Registry\\n82 CHAPTER 5 | Docker application DevOps workflow with Microsoft toolsIn step 3, \", \"for building integration and testing (CI) you might publish the resulting docker images to a\\nprivate\", \" or public registry. There are multiple offerings of Docker registries from cloud vendors like\\nAzure\", \" Container Registry, Amazon Web Services Container Registry, Google Container Registry,\\nGitHub Conta\", \"iner Registry, Quay Registry, and so on.\\nUsing the Docker tasks, you can push a set of service image\", \"s defined by a docker-compose.yml file,\\nwith multiple tags, to an authenticated Docker registry (lik\", \"e Azure Container Registry), as shown in\\nFigure 5-5.\\nFigure 5-5. Using Azure DevOps Services to publ\", \"ishing custom images to a Docker Registry\\nTip\\nFor more information about Azure Container Registry, s\", \"ee https://aka.ms/azurecontainerregistry.\\nStep 4: CD, Deploy\\nThe immutability of Docker images ensur\", \"es a repeatable deployment with what\\u2019s developed, tested\\nthrough CI, and run in production. After yo\", \"u have the application Docker images published in your\\nDocker registry (either private or public), y\", \"ou can deploy them to the several environments that you\\nmight have (production, QA, staging, etc.) f\", \"rom your CD pipeline by using Azure DevOps Services\\npipeline tasks, Azure DevOps Services Release Ma\", \"nagement or GitHub Actions.\\n83 CHAPTER 5 | Docker application DevOps workflow with Microsoft toolsHo\", \"wever, at this point it depends on what kind of Docker application you\\u2019re deploying. Deploying a\\nsim\", \"ple application (from a composition and deployment point of view) like a monolithic application\\ncomp\", \"rising a few containers or services and deployed to a few servers or VMs is different from\\ndeploying\", \" a more complex application like a microservices-oriented application with hyperscale\\ncapabilities. \", \"These two scenarios are explained in the following sections.\\nDeploying composed Docker applications \", \"to multiple Docker environments\\nLet\\u2019s look first at the less-complex scenario: deploying to simple D\", \"ocker hosts (VMs or servers) in a\\nsingle environment or multiple environments (QA, staging, and prod\", \"uction). In this scenario, internally\\nyour CD pipeline can use docker-compose (from your Azure DevOp\", \"s Services deployment tasks) to\\ndeploy the Docker applications with its related set of containers or\", \" services, as illustrated in Figure 5-6.\\nFigure 5-6. Deploying application containers to simple Dock\", \"er host environments registry\\nFigure 5-7 highlights how you can connect your build CI to QA/test env\", \"ironments via Azure DevOps\\nServices by clicking Docker Compose in the Add Task dialog box. However, \", \"when deploying to staging\\nor production environments, you would usually use Release Management featu\", \"res handling multiple\\nenvironments (like QA, staging, and production). If you\\u2019re deploying to single\", \" Docker hosts, it is using\\nthe Azure DevOps Services \\u201cDocker Compose\\u201d task (which is invoking the do\", \"cker-compose up\\ncommand under the hood). If you\\u2019re deploying to Azure Kubernetes Service (AKS), it u\", \"ses the Docker\\n84 CHAPTER 5 | Docker application DevOps workflow with Microsoft toolsDeployment task\", \", as explained in the section that follows. Similar steps can be built for deployment\\nusing GitHub A\", \"ctions.\\nFigure 5-7. Adding a Docker Compose task in an Azure DevOps Services pipeline or GitHub work\", \"flow\\nWhen you create a release in Azure DevOps Services, it takes a set of input artifacts. These ar\", \"tifacts are\\nintended to be immutable for the lifetime of the release, across all environments. When \", \"you introduce\\ncontainers, the input artifacts identify images in a registry to deploy. Depending on \", \"how these images\\nare identified, they are not guaranteed to remain the same throughout the duration \", \"of the release, the\\nmost obvious case being when you reference myimage:latest from a docker-compose \", \"file.\\nThe Azure DevOps Services templates give you the ability to generate build artifacts that cont\", \"ain\\nspecific registry image digests that are guaranteed to uniquely identify the same image binary. \", \"These\\nare what you really want to use as input to a release. You can invoke docker-compose in a run \", \"step\\ninside GitHub Actions to accomplish the same goal.\\nManaging releases to Docker environments by \", \"using Azure DevOps Services\\nRelease Management or GitHub Actions\\nThrough the Azure DevOps Services t\", \"emplates, you can build a new image, publish it to a Docker\\nregistry, run it on Linux or Windows hos\", \"ts, and use commands such as docker-compose to deploy\\nmultiple containers as an entire application, \", \"all through the Azure DevOps Services Release\\nManagement capabilities intended for multiple environm\", \"ents, as shown in Figure 5-8.\\n85 CHAPTER 5 | Docker application DevOps workflow with Microsoft tools\", \"Figure 5-8. Configuring Azure DevOps Services Docker Compose tasks from Azure DevOps Services Releas\", \"e\\nManagement\\nHowever, keep in mind that the scenario shown in Figure 5-6 and implemented in Figure 5\", \"-8 is a\\nsimple one (it\\u2019s deploying to single Docker hosts and VMs, and there will be a single contai\", \"ner or\\ninstance per image) and probably should be used only for development or test scenarios. In mo\", \"st\\nenterprise production scenarios, you would want to have High Availability (HA) and easy-to-manage\", \"\\nscalability by load balancing across multiple nodes, servers, and VMs, plus \\u201cintelligent failovers\\u201d\", \" so if a\\nserver or node fails, its services and containers will be moved to another host server or V\", \"M. In that\\ncase, you need more advanced technologies such as container clusters, orchestrators, and \", \"schedulers.\\nThus, the way to deploy to those clusters is by handling the advanced scenarios explaine\", \"d in the next\\nsection.\\nGitHub Actions can be used in the same manner, including the use of environme\", \"nts for approvals.\\nDeploying Docker applications to Docker clusters\\nThe nature of distributed applic\", \"ations requires compute resources that are also distributed. To have\\nproduction-scale capabilities, \", \"you need to have clustering capabilities that provide high scalability and\\nhigh availability based o\", \"n pooled resources.\\nYou could deploy containers manually to those clusters from a CLI tool or a web \", \"UI, but you should\\nreserve that kind of manual work to spot deployment testing or management purpose\", \"s like scaling-\\nout or monitoring.\\nFrom a CD point of view, you can use Azure DevOps Services or Git\", \"Hub Actions to run specially made\\ndeployment tasks from your environments that will deploy your cont\", \"ainerized applications to\\ndistributed clusters in Container Service, as illustrated in Figure 5-9.\\n8\", \"6 CHAPTER 5 | Docker application DevOps workflow with Microsoft toolsFigure 5-9. Deploying distribut\", \"ed applications to Container Service\\nInitially, when deploying to certain clusters or orchestrators,\", \" you would traditionally use specific\\ndeployment scripts and mechanisms per each orchestrator (that \", \"is, Kubernetes and Service Fabric\\nhave different deployment mechanisms) instead of the simpler and e\", \"asy-to-use docker-compose tool\\nbased on the docker-compose.yml definition file. However, thanks to t\", \"he Azure DevOps Services\\nDocker Deploy task, shown in Figure 5-10, now you can also deploy to the su\", \"pported orchestrators by\\njust using your familiar docker-compose.yml file because the tool performs \", \"that \\u201ctranslation\\u201d for you\\n(from your docker-compose.yml file to the format needed by the orchestrat\", \"or).\\n87 CHAPTER 5 | Docker application DevOps workflow with Microsoft toolsFigure 5-10. Adding the D\", \"eploy to Kubernetes task to your Environment\\nFigure 5-11 demonstrates how you can edit the Deploy to\", \" Kubernetes task with the sections available\\nfor configuration. This is the task that will retrieve \", \"your ready-to-use custom Docker images to be\\ndeployed as containers in the cluster.\\nFigure 5-11. Doc\", \"ker Deploy task definition deploying to ACS DC/OS\\n88 CHAPTER 5 | Docker application DevOps workflow \", \"with Microsoft toolsTip\\nTo read more about the CD pipeline with Azure DevOps Services and Docker, vi\", \"sit\\nhttps://azure.microsoft.com/services/devops/pipelines\\nTip\\nTo see GitHub Actions workflows for CI\", \", visit https://github.com/dotnet-\\narchitecture/eShopOnContainers/wiki/GitHub-Actions. For a walkthr\", \"ough of GitHub Actions\\nperforming deployment to an Azure Kubernetes environment, visit https://githu\", \"b.com/dotnet-\\narchitecture/eShopOnContainers/wiki/Deployment-With-GitHub-Actions.\\nStep 5: Run and ma\", \"nage\\nBecause running and managing applications at enterprise-production level is a major subject in \", \"and of\\nitself, and due to the type of operations and people working at that level (IT operations) as\", \" well as the\\nlarge scope of this area, the entire next chapter is devoted to explaining it.\\nStep 6: \", \"Monitor and diagnose\\nThis topic also is covered in the next chapter as part of the tasks that IT per\", \"forms in production\\nsystems; however, is important to highlight that the insights obtained in this s\", \"tep must feed back to\\nthe development team so that the application is constantly improved. From that\", \" point of view, it\\u2019s also\\npart of DevOps, although the tasks and operations are commonly performed b\", \"y IT.\\nOnly when monitoring and diagnostics are 100% within the realm of DevOps are the monitoring\\npr\", \"ocesses and analytics performed by the development team against testing or beta environments.\\nThis i\", \"s done either by performing load testing or by monitoring beta or QA environments, where beta\\ntester\", \"s are trying the new versions.\\nCreate CI/CD pipelines in Azure DevOps Services for\\na .NET applicatio\", \"n on Containers and deploying to a\\nKubernetes cluster\\nIn Figure 5-12 you can see the end-to-end DevO\", \"ps scenario covering the code management, code\\ncompilation, Docker images build, Docker images push \", \"to a Docker registry and finally the\\ndeployment to a Kubernetes cluster in Azure.\\n89 CHAPTER 5 | Doc\", \"ker application DevOps workflow with Microsoft toolsFigure 5-12. CI/CD scenario creating Docker imag\", \"es and deploying to a Kubernetes cluster in Azure\\nIt is important to highlight that the two pipeline\", \"s, build/CI, and release/CD, are connected through the\\nDocker Registry (such as Docker Hub or Azure \", \"Container Registry). The Docker registry is one of the\\nmain differences compared to a traditional CI\", \"/CD process without Docker.\\nAs shown in Figure 5-13, the first phase is the build/CI pipeline. In Az\", \"ure DevOps Services you can\\ncreate build/CI pipelines that will compile the code, create the Docker \", \"images, and push them to a\\nDocker Registry like Docker Hub or Azure Container Registry.\\n90 CHAPTER 5\", \" | Docker application DevOps workflow with Microsoft toolsFigure 5-13. Build/CI pipeline in Azure De\", \"vOps building Docker images and pushing images to a Docker registry\\nThe second phase is to create a \", \"deployment/release pipeline. In Azure DevOps Services, you can easily\\ncreate a deployment pipeline t\", \"argeting a Kubernetes cluster by using the Kubernetes tasks for Azure\\nDevOps Services, as shown in F\", \"igure 5-14.\\nFigure 5-14. Release/CD pipeline in Azure DevOps Services deploying to a Kubernetes clus\", \"ter\\n[!Walkthrough] Deploying eShopModernized to Kubernetes:\\n91 CHAPTER 5 | Docker application DevOps\", \" workflow with Microsoft toolsFor a detailed walkthrough of Azure DevOps CI/CD pipelines deploying t\", \"o Kubernetes, see this post:\\nhttps://github.com/dotnet-architecture/eShopModernizing/wiki/04.-How-to\", \"-deploy-your-Windows-\\nContainers-based-apps-into-Kubernetes-in-Azure-Container-Service-(Including-CI\", \"-CD)\\n92 CHAPTER 5 | Docker application DevOps workflow with Microsoft tools6\\nCHAPTER\\nRun, manage, an\", \"d monitor\\nDocker production\\nenvironments\\nVision: Enterprise applications need to run with high avail\", \"ability and high scalability; IT operations\\nneed to be able to manage and monitor the environments a\", \"nd the applications themselves.\\nThis last pillar in the containerized Docker applications life cycle\", \" is centered on how you can run,\\nmanage, and monitor your applications in scalable, high availabilit\", \"y (HA) production environments.\\nThe way you run your containerized applications in production (infra\", \"structure architecture and\\nplatform technologies) is very much related and based on the chosen archi\", \"tecture and development\\nplatforms discussed in Chapter 1 of this e-book.\\nThis chapter examines speci\", \"fic products and technologies from Microsoft and other vendors that you\\ncan use to effectively run s\", \"calable, HA distributed applications plus how you can manage and monitor\\nthem from the IT perspectiv\", \"e.\\nRun composed and microservices-based\\napplications in production environments\\nApplications compose\", \"d by multiple microservices do need to be deployed into orchestrator clusters in\\norder to simplify t\", \"he complexity of deployment and make it viable from an IT point of view. Without\\nan orchestrator clu\", \"ster, it would be difficult to deploy and scale out a complex microservices\\napplication.\\nIntroductio\", \"n to orchestrators, schedulers, and container clusters\\nEarlier in this e-book, clusters and schedule\", \"rs were introduced as part of the discussion on software\\narchitecture and development. Kubernetes an\", \"d Service Fabric are examples of Docker clusters. Both of\\nthese orchestrators can run as a part of t\", \"he infrastructure provided by Microsoft Azure Kubernetes\\nService.\\n93 CHAPTER 6 | Run, manage, and mo\", \"nitor Docker production environmentsWhen applications are scaled-out across multiple host systems, t\", \"he ability to manage each host\\nsystem and abstract away the complexity of the underlying platform be\", \"comes attractive. That\\u2019s\\nprecisely what orchestrators and schedulers provide. Let\\u2019s take a brief loo\", \"k at them here:\\n\\u2022 Schedulers. \\u201cScheduling\\u201d refers to the ability for an administrator to load a serv\", \"ice file onto\\na host system that establishes how to run a specific container. Launching containers i\", \"n a\\nDocker cluster tends to be known as scheduling. Although scheduling refers to the specific act\\no\", \"f loading the service definition, in a more general sense, schedulers are responsible for\\nhooking in\", \"to a host\\u2019s init system to manage services in whatever capacity needed.\\nA cluster scheduler has mult\", \"iple goals: using the cluster\\u2019s resources efficiently, working with\\nuser-supplied placement constrai\", \"nts, scheduling applications rapidly to not leave them in a\\npending state, having a degree of \\u201cfairn\", \"ess,\\u201d being robust to errors, and always be available.\\n\\u2022 Orchestrators. Platforms extend life-cycle \", \"management capabilities to complex, multi-\\ncontainer workloads deployed on a cluster of hosts. By ab\", \"stracting the host infrastructure,\\norchestration tools give users a way to treat the entire cluster \", \"as a single deployment target.\\nThe process of orchestration involves tooling and a platform that can\", \" automate all aspects of\\napplication management from initial placement or deployment per container; \", \"moving\\ncontainers to different hosts depending on its host\\u2019s health or performance; versioning and\\nr\", \"olling updates and health monitoring functions that support scaling and failover; and many\\nmore.\\nOrc\", \"hestration is a broad term that refers to container scheduling, cluster management, and\\npossibly the\", \" provisioning of additional hosts.\\nThe capabilities provided by orchestrators and schedulers are com\", \"plex to develop and create from\\nscratch, therefore you usually would want to use orchestration solut\", \"ions offered by vendors.\\nManage production Docker environments\\nCluster management and orchestration \", \"is the process of controlling a group of hosts. This can involve\\nadding and removing hosts from a cl\", \"uster, getting information about the current state of hosts and\\ncontainers, and starting and stoppin\", \"g processes. Cluster management and orchestration are closely\\ntied to scheduling because the schedul\", \"er must have access to each host in the cluster in order to\\nschedule services. For this reason, the \", \"same tool is often used for both purposes.\\nContainer Service and management tools\\nContainer Service \", \"provides rapid deployment of popular open-source container clustering and\\norchestration solutions. I\", \"t uses Docker images to ensure that your application containers are fully\\nportable. By using Contain\", \"er Service, you can deploy DC/OS (powered by Mesosphere and Apache\\nMesos) and Docker Swarm clusters \", \"with Azure Resource Manager templates or the Azure portal to\\nensure that you can scale these applica\", \"tions to thousands\\u2014even tens of thousands\\u2014of containers.\\nYou deploy these clusters by using Azure Vi\", \"rtual Machine Scale Sets, and the clusters take advantage\\nof Azure networking and storage offerings.\", \" To access Container Service, you need an Azure\\n94 CHAPTER 6 | Run, manage, and monitor Docker produ\", \"ction environmentssubscription. With Container Service, you can take advantage of the enterprise-gra\", \"de features of\\nAzure while still maintaining application portability, including at the orchestration\", \" layers.\\nTable 6-1 lists common management tools related to their orchestrators, schedulers, and clu\", \"stering\\nplatform.\\nTable 6-1. Docker management tools\\nManagement tools Description Related orchestrat\", \"ors\\nAzure Monitor for Containers Azure dedicated Azure Kubernetes Services (AKS)\\nKubernetes\\nmanageme\", \"nt tool\\nKubernetes Web UI Kubernetes Azure Kubernetes Service (AKS)\\n(dashboard) management tool, Loc\", \"al Kubernetes\\ncan monitor and\\nmanage local\\nKubernetes cluster\\nAzure portal for Service Fabric Online\", \" and desktop Azure Service Fabric\\nAzure Service Fabric Explorer version for managing\\nService Fabric\\n\", \"clusters, on Azure, on\\npremises, local\\ndevelopment, and\\nother clouds\\nContainer Monitoring (Azure Gen\", \"eral container Azure Service Fabric\\nMonitor) management y Azure Kubernetes Service (AKS)\\nmonitoring \", \"solution. Mesosphere DC/OS and others.\\nCan manage\\nKubernetes clusters\\nthrough Azure\\nMonitor for\\nCont\", \"ainers.\\nAzure Service Fabric\\nAnother choice for cluster-deployment and management is Azure Service F\", \"abric. Service Fabric is a\\nMicrosoft microservices platform that includes container orchestration as\", \" well as developer\\nprogramming models to build highly scalable microservices applications. Service F\", \"abric supports\\nDocker in Linux and Windows Containers and can run in Windows and Linux servers.\\nThe \", \"following are Service Fabric management tools:\\n\\u2022 Azure portal for Service Fabric cluster-related ope\", \"rations (create/update/delete) a cluster or\\nconfigure its infrastructure (VMs, load balancer, networ\", \"king, etc.)\\n\\u2022 Azure Service Fabric Explorer is a specialized web UI and desktop multi-platform tool \", \"that\\nprovides insights and certain operations on the Service Fabric cluster, from the nodes/VMs\\npoin\", \"t of view and from the application and services point of view.\\n95 CHAPTER 6 | Run, manage, and monit\", \"or Docker production environmentsMonitor containerized application services\\nIt\\u2019s critical for applic\", \"ations split into multiple containers and microservices to have a way to monitor\\nand analyze the beh\", \"avior of the whole application.\\nAzure Monitor\\nAzure Monitor is an extensible analytics service that \", \"monitors your live application. It helps you to\\ndetect and diagnose performance issues and to unders\", \"tand what users actually do with your app. It\\u2019s\\ndesigned for developers, with the intent of helping \", \"you to continuously improve the performance and\\nusability of your services or applications. Azure Mo\", \"nitor works with both web/services and standalone\\napps on a wide variety of platforms like .NET, Jav\", \"a, Node.js and many other platforms, hosted on-\\npremises or in the cloud.\\nAdditional resources\\n\\u2022 Ove\", \"rview of Azure Monitor\\nhttps://learn.microsoft.com/azure/azure-monitor/overview\\n\\u2022 What is Applicatio\", \"n Insights?\\nhttps://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview\\n\\u2022 What is Azur\", \"e Monitor Metrics?\\nhttps://learn.microsoft.com/azure/azure-monitor/platform/data-platform-metrics\\n\\u2022 \", \"Container Monitoring solution in Azure Monitor\\nhttps://learn.microsoft.com/azure/azure-monitor/insig\", \"hts/containers\\nSecurity and backup services\\nThere are many support chores with lots of details that \", \"you have to handle to ensure your applications\\nand infrastructure are in top notch condition to supp\", \"ort business needs, and the situation becomes\\nmore complicated in the microservices realm, so you ne\", \"ed a way to have both high-level and detailed\\nviews when you need to take action.\\nAzure has the tool\", \"s to manage and provide a unified view of four critical aspects of both your cloud\\nand on-premises r\", \"esources:\\n\\u2022 Security. With Azure Security Center.\\n\\u2013 Get full visibility and control over the securit\", \"y of your virtual machines, apps, and\\nworkloads.\\n\\u2013 Centralize the management of your security polici\", \"es and integrate existing processes\\nand tools.\\n\\u2013 Detect real threats with advanced analytics.\\n\\u2022 Back\", \"up. With Azure Backup.\\n\\u2013 Avoid costly business disruptions, meet compliance goals, and protect your \", \"data\\nagainst ransomware and human errors.\\n\\u2013 Keep your backup data encrypted in transit and at rest.\\n\", \"96 CHAPTER 6 | Run, manage, and monitor Docker production environments\\u2013 Ensure access based on multi\", \"factor authentication to prevent unauthorized use.\\n\\u2022 On-premises resources. With hybrid cloud soluti\", \"ons.\\n97 CHAPTER 6 | Run, manage, and monitor Docker production environments7\\nCHAPTER\\nContainerized D\", \"ocker\\nApplication Lifecycle key\\ntakeaways\\n\\u2022 Container-based solutions provide important cost-saving \", \"benefits because containers solve\\ndeployment problems caused by dependency failures in production en\", \"vironments, thereby\\nimproving DevOps and production operations significantly.\\n\\u2022 Docker has become th\", \"e de facto standard in the container industry and is supported by the\\nmost significant vendors in th\", \"e Linux and Windows ecosystems, including Microsoft. In the\\nfuture, Docker will be ubiquitous in any\", \" datacenter in the cloud or on-premises.\\n\\u2022 A Docker container is becoming the standard unit of deplo\", \"yment for any server-based\\napplication or service.\\n\\u2022 Docker orchestrators like the ones provided in \", \"Azure Kubernetes Service (AKS) and Azure\\nService Fabric are fundamental and indispensable for any mi\", \"croservices-based or multi-\\ncontainer applications that have significant complexity and scalability \", \"needs.\\n\\u2022 An end-to-end DevOps environment that supports Continuous Integration/Continuous\\nDeployment\", \" (CI/CD) and connects to the production Docker environments can provide agility\\nand ultimately impro\", \"ve the time to market of your applications.\\n\\u2022 Azure DevOps Services greatly simplifies your DevOps e\", \"nvironment by deploying to Docker\\nenvironments from your CI/CD pipelines. This statement applies to \", \"simple Docker\\nenvironments as well as to advanced microservice and container orchestrators based on\\n\", \"Azure.\\n98 CHAPTER 7 | Containerized Docker Application Lifecycle key takeaways\"]"