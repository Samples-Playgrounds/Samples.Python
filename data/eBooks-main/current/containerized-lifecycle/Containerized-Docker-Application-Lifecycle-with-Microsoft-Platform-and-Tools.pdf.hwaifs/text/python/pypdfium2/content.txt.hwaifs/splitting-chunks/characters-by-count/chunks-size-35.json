"[\"EDITION v6.0.0 - Updated to ASP.NET Core 6.0\\nRefer changelog for the book updates and community cont\", \"ributions.\\nThis guide is a general overview for developing and deploying containerized ASP.NET Core \", \"\\napplications with Docker, using the Microsoft platform and tools. The guide includes a high-level \\n\", \"introduction to Azure DevOps, for implementing CI/CD pipelines, as well as Azure Container Registry \", \"\\n(ACR) and Azure Kubernetes Services AKS for deployment.\\nFor low-level, development-related details \", \"you can see the .NET Microservices: Architecture for \\nContainerized .NET Applications guide and it r\", \"elated reference application eShopOnContainers.\\nCredits\\nAuthor:\\nCesar de la Torre, Sr. PM, .NET prod\", \"uct team, Microsoft Corp.\\nAcquisitions Editor:\\nJanine Patrick\\nDevelopmental Editor:\\nBob Russell, Sol\", \"utions Professional at Microsoft\\nOctal Publishing, Inc.\\nEditorial Production:\\nDianne Russell\\nOctal P\", \"ublishing, Inc.\\nCopyeditor:\\nBob Russell, Solutions Professional at Microsoft\\nParticipants and review\", \"ers:\\nNish Anil, Sr. Program Manager, .NET team, Microsoft\\nMiguel Veloso, Software Development Engine\", \"er at Plain Concepts\\nSumit Ghosh, Principal Consultant at Neudesic\\nColin Dembovsky, DevOps Practice \", \"Lead, Cognizant Microsoft Business Group\\nCopyright\\nPUBLISHED BY\\nMicrosoft Developer Division, .NET a\", \"nd Visual Studio product teams\\nA division of Microsoft CorporationOne Microsoft Way\\nRedmond, Washing\", \"ton 98052-6399\\nCopyright \\u00a9 2022 by Microsoft Corporation\\nAll rights reserved. No part of the content\", \"s of this book may be reproduced or transmitted in any \\nform or by any means without the written per\", \"mission of the publisher.\\nThis book is provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinion\", \"s. The views, opinions, and \\ninformation expressed in this book, including URL and other Internet we\", \"bsite references, may change \\nwithout notice.\\nSome examples depicted herein are provided for illustr\", \"ation only and are fictitious. No real association \\nor connection is intended or should be inferred.\", \"\\nMicrosoft and the trademarks listed at https://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are \\nt\", \"rademarks of the Microsoft group of companies.\\nMac and macOS are trademarks of Apple Inc.\\nThe Docker\", \" whale logo is a registered trademark of Docker, Inc. Used by permission.\\nAll other marks and logos \", \"are property of their respective owners.i Contents\\nContents\\nOverview of Containers and Docker.......\", \"............................................................................... 1\\nLearn Docker......\", \"....................................................................................................\", \"....................................................................2\\nComparing Docker containers wi\", \"th virtual machines.................................................................................\", \"..........3\\nA simple analogy........................................................................\", \".........................................................................................4\\nLearn Doc\", \"ker specific terminologies .........................................................................\", \".......................................................4\\nLearn docker containers, images, and regist\", \"ries ...............................................................................................\", \"..........6\\nRoad to modern applications based on containers ........................................\", \"...........................................................8\\nIntroduction to the Docker application \", \"life cycle ................................................................ 9\\nContainers as the foun\", \"dation for DevOps collaboration ....................................................................\", \".....................9\\nChallenges in the application life cycle when using Docker. .................\", \"......................................................... 10\\nIntroduction to a generic end-to-end Do\", \"cker application life cycle workflow ....................................... 11\\nBenefits of DevOps f\", \"or containerized applications ......................................................................\", \"...................... 12\\nIntroduction to the Microsoft platform and tools for containerized apps ..\", \"................... 13\\nDesigning and developing containerized apps using Docker and Microsoft Azure \", \"...... 17\\nDesign Docker applications ...............................................................\", \"............................................................................... 17\\nCommon container \", \"design principles...................................................................................\", \"........................................ 18\\nContainer equals a process .............................\", \"....................................................................................................\", \"......... 18\\nMonolithic applications ...............................................................\", \"....................................................................................... 18\\nMonolithi\", \"c application deployed as a container...............................................................\", \".................................. 21\\nPublish a single Docker container app to Azure App Service ...\", \"..................................................................... 21\\nState and data in Docker ap\", \"plications..........................................................................................\", \"................................ 22\\nService-oriented applications ..................................\", \"....................................................................................................\", \".... 25\\nOrchestrating microservices and multi-container applications for high scalability and availa\", \"bility.... 25\\nSoftware platforms for container clustering, orchestration, and scheduling............\", \"............................... 27\\nUsing container-based orchestrators in Azure.....................\", \"................................................................................ 28\\nUsing Azure Kube\", \"rnetes Service .....................................................................................\", \"........................................... 29\\nDevelopment environment for Kubernetes...............\", \"............................................................................................ 30\\nGet \", \"started with Azure Kubernetes Service (AKS) ........................................................\", \"....................................... 31ii Contents\\nDeploy with Helm charts into Kubernetes cluste\", \"rs............................................................................................. 31\\nA\", \"dditional resources ................................................................................\", \"....................................................................... 32\\nUsing Azure Service Fabri\", \"c ..................................................................................................\", \"......................................... 32\\nStateless versus stateful microservices ...............\", \"....................................................................................................\", \". 35\\nUsing Azure Service Fabric Mesh................................................................\", \"............................................................... 36\\nChoosing orchestrators in Azure .\", \"....................................................................................................\", \".......................... 37\\nDeploy to Azure Kubernetes Service (AKS) .............................\", \"................................................................................... 38\\nCreate the AK\", \"S environment in Azure .............................................................................\", \"........................................ 38\\nCreate the AKS cluster..................................\", \"....................................................................................................\", \".............. 38\\nDevelopment environment for Docker apps ..........................................\", \"................................................................... 40\\nDevelopment tools choices: ID\", \"E or editor.........................................................................................\", \"..................... 40\\nLanguage and framework choices ............................................\", \"................................................................................ 41\\nInner-loop devel\", \"opment workflow for Docker apps ....................................................................\", \".......................... 41\\nBuilding a single app within a Docker container using Visual Studio Co\", \"de and Docker CLI............. 42\\nUse Docker Tools in Visual Studio on Windows......................\", \"................................................................................. 52\\nConfigure your \", \"local environment ..................................................................................\", \".......................................... 52\\nDocker support in Visual Studio ......................\", \"....................................................................................................\", \"...... 52\\nConfigure Docker tools....................................................................\", \".............................................................................. 55\\nUsing Windows Powe\", \"rShell commands in a DockerFile to set up Windows Containers (Docker \\nstandard based)...............\", \"....................................................................................................\", \".................................................. 56\\nBuild ASP.NET Core applications deployed as Li\", \"nux containers into an AKS/Kubernetes orchestrator\\n.................................................\", \"....................................................................................................\", \"................................................. 57\\nCreating the ASP.NET Core Project using Visual \", \"Studio 2022........................................................................ 57\\nRegister the \", \"Solution in an Azure Container Registry (ACR) ......................................................\", \".................... 66\\nDocker application DevOps workflow with Microsoft tools.....................\", \"........................ 74\\nSteps in the outer-loop DevOps workflow for a Docker application........\", \"....................................................... 75\\nStep 1: Inner-loop development workflow..\", \"....................................................................................................\", \"...... 76\\nStep 2: Source-Code Control integration and management with Azure DevOps Services and Git \", \"76\\nStep 3: Build, CI, Integrate, and Test with Azure DevOps Services/GitHub and Docker..............\", \"........ 76\\nStep 4: CD, Deploy......................................................................\", \"..................................................................................... 83\\nStep 5: Run\", \" and manage.........................................................................................\", \"...................................................... 89\\nStep 6: Monitor and diagnose .............\", \"....................................................................................................\", \"................... 89iii Contents\\nCreate CI/CD pipelines in Azure DevOps Services for a .NET applic\", \"ation on Containers and \\ndeploying to a Kubernetes cluster..........................................\", \"....................................................................................... 89\\nRun, mana\", \"ge, and monitor Docker production environments ........................................ 93\\nRun compo\", \"sed and microservices-based applications in production environments ............................... \", \"93\\nIntroduction to orchestrators, schedulers, and container clusters ...............................\", \"................................ 93\\nManage production Docker environments ..........................\", \"...................................................................................... 94\\nContainer \", \"Service and management tools........................................................................\", \"..................................... 94\\nAzure Service Fabric ......................................\", \"....................................................................................................\", \".............. 95\\nMonitor containerized application services .......................................\", \"........................................................................ 96\\nAzure Monitor ..........\", \"....................................................................................................\", \"..................................................... 96\\nSecurity and backup services...............\", \"....................................................................................................\", \".................... 96\\nContainerized Docker Application Lifecycle key takeaways....................\", \"......................... 981 CHAPTER 1 | Overview of Containers and Docker\\nCHAPTER 1\\nOverview of Co\", \"ntainers \\nand Docker\\nContainerization is an approach to software development in which an application\", \" or service, its \\ndependencies, and its configuration (abstracted as deployment manifest files) are \", \"packaged together as \\na container image. You then can test the containerized application as a unit a\", \"nd deploy it as a container \\nimage instance to the host operating system (OS).\\nJust as shipping cont\", \"ainers allow goods to be transported by ship, train, or truck regardless of the \\ncargo inside, softw\", \"are containers act as a standard unit of software deployment that can contain \\ndifferent code and de\", \"pendencies. Containerizing software this way enables developers and IT \\nprofessionals to deploy them\", \" across environments with little or no modification.\\nContainers also isolate applications from each \", \"other on a shared OS. Containerized applications run \\non top of a container host that in turn runs o\", \"n the OS (Linux or Windows). Containers therefore have a \\nmuch smaller footprint than virtual machin\", \"e (VM) images.\\nEach container can run a whole web application or a service, as shown in Figure 1-1. \", \"In this example, \\nDocker host is a container host, and App1, App2, Svc1, and Svc2 are containerized \", \"applications or \\nservices.\\nFigure 1-1. Multiple containers running on a container host\\nAnother benef\", \"it you can derive from containerization is scalability. You can scale out quickly by \\ncreating new c\", \"ontainers for short-term tasks. From an application point of view, instantiating an \\nimage (creating\", \" a container) is similar to instantiating a process like a service or web app. For \\nreliability, how\", \"ever, when you run multiple instances of the same image across multiple host servers, \\nyou typically\", \" want each container (image instance) to run in a different host server or VM in different \\nfault do\", \"mains.\\nIn short, containers offer the benefits of isolation, portability, agility, scalability, and \", \"control across the \\nentire application lifecycle workflow. The most important benefit is the environ\", \"ment isolation \\nprovided between Dev and Ops.2 CHAPTER 1 | Overview of Containers and Docker\\nLearn D\", \"ocker\\nDocker is an open-source project for automating the deployment of applications as portable, se\", \"lf\\u0002sufficient containers that can run on the cloud or on-premises. Docker is also a company that \\npr\", \"omotes and evolves this technology, working in collaboration with cloud, Linux, and Windows \\nvendors\", \", including Microsoft.\\nFigure 1-2. Docker deploys containers at all layers of the hybrid cloud\\nAs sh\", \"own in the above diagram, Docker containers can run anywhere, on-premises in the customer \\ndatacente\", \"r, in an external service provider or in the cloud, on Azure. Docker image containers can also \\nrun \", \"natively on Linux and Windows. However, Windows images can run only on Windows hosts and \\nLinux imag\", \"es can run on Linux hosts and Windows hosts (using a Hyper-V Linux VM, so far), where \\nhost means a \", \"server or a VM.\\nDevelopers can use development environments on Windows, Linux, or macOS. On the deve\", \"lopment \\ncomputer, the developer runs a Docker host where Docker images are deployed, including the \", \"app \\nand its dependencies. Developers who work on Linux or on the Mac, use a Docker host that\\u2019s Linu\", \"x\\u0002based, and they can only create images for Linux containers. (Developers working on the Mac can ed\", \"it \\ncode or run the Docker command-line interface (CLI) from macOS, but as of this writing, containe\", \"rs \\ndon\\u2019t run directly on macOS.) Developers who work on Windows can create images for either Linux \", \"or \\nWindows Containers.\\nTo host containers in development environments and provide additional develo\", \"per tools, Docker \\nships Docker Desktop for Windows or for macOS. These products install the necessa\", \"ry VM (the Docker \\nhost) to host the containers.\\nTo run Windows Containers, there are two types of r\", \"untimes:\\n\\u2022 Windows Server Containers provide application isolation through process and namespace \\nis\", \"olation technology. A Windows Server Container shares a kernel with the container host and \\nwith all\", \" containers running on the host.\\n\\u2022 Hyper-V Containers expand on the isolation provided by Windows Se\", \"rver Containers by \\nrunning each container in a highly optimized virtual machine. In this configurat\", \"ion, the kernel \\nof the container host isn\\u2019t shared with the Hyper-V Containers, providing better is\", \"olation.3 CHAPTER 1 | Overview of Containers and Docker\\nThe images for these containers are created \", \"and work just the same way. The difference is in how the \\ncontainer is created from the image\\u2014runnin\", \"g a Hyper-V Container requires an extra parameter. For \\ndetails, see Hyper-V Containers.\\nComparing D\", \"ocker containers with virtual machines\\nFigure 1-3 shows a comparison between VMs and Docker containe\", \"rs.\\nFigure 1-3. Comparison of traditional virtual machines to Docker containers\\nAs shown in the abov\", \"e diagram, for VMs, there are three base layers in the host server. From the \\nbottom-up: Infrastruct\", \"ure, Host Operating System, and a Hypervisor. On top of all that, each VM has \\nits own OS and all ne\", \"cessary libraries. On the other hand, for Docker, the host server only has the\\nInfrastructure and th\", \"e OS. On top of that, the container engine keeps containers isolated, but lets \\nthem share the singl\", \"e base OS\\u2019s services.\\nBecause containers require far fewer resources (for example, they don\\u2019t need a\", \" full OS), they\\u2019re easy to \\ndeploy and they start fast. This allows you to have higher density, mean\", \"ing that it allows you to run \\nmore services on the same hardware unit, thereby reducing costs.\\nAs a\", \" side effect of running on the same kernel, you get less isolation than VMs.\\nThe main goal of an ima\", \"ge is to ensure the same environment (dependencies) across different \\ndeployments. This means that y\", \"ou can debug it on your machine and then deploy it to another \\nmachine, the same environment guarant\", \"eed.\\nA container image is a way to package an app or service and deploy it in a reliable and reprodu\", \"cible \\nway. You could say that Docker isn\\u2019t only a technology but also a philosophy and a process.4 \", \"CHAPTER 1 | Overview of Containers and Docker\\nWhen using Docker, you won\\u2019t hear developers say, \\u201cIt \", \"works on my machine, why not in production?\\u201d \\nThey can just say, \\u201cIt runs on Docker\\u201d, because the pa\", \"ckaged Docker application can be executed on \\nany supported Docker environment, and it runs the way \", \"it was intended to on all deployment targets \\n(such as Dev, QA, staging, and production).\\nA simple a\", \"nalogy\\nPerhaps a simple analogy can help getting the grasp of the core concept of Docker.\\nLet\\u2019s go b\", \"ack in time to the 1950s for a moment. There were no word processors, and the \\nphotocopiers were use\", \"d everywhere (well, kind of).\\nImagine you\\u2019re responsible for quickly issuing batches of letters as r\", \"equired, to mail them to \\ncustomers, using real paper and envelopes, to be delivered physically to e\", \"ach customer\\u2019s address \\n(there was no email back then).\\nAt some point, you realize the letters are j\", \"ust a composition of a large set of paragraphs, which are \\npicked and arranged as needed, according \", \"to the purpose of the letter, so you devise a system to \\nissue letters quickly, expecting to get a h\", \"efty raise.\\nThe system is simple:\\n1. You begin with a deck of transparent sheets containing one para\", \"graph each.\\n2. To issue a set of letters, you pick the sheets with the paragraphs you need, then you\", \" stack and \\nalign them so they look and read fine.\\n3. Finally, you place the set in the photocopier \", \"and press start to produce as many letters as \\nrequired.\\nSo, simplifying, that\\u2019s the core idea of Do\", \"cker.\\nIn Docker, each layer is the resulting set of changes that happen to the filesystem after exec\", \"uting a \\ncommand, such as, installing a program.\\nSo, when you \\u201clook\\u201d at the filesystem after the lay\", \"er has been copied, you see all the files, included the \\nlayer when the program was installed.\\nYou c\", \"an think of an image as an auxiliary read-only hard disk ready to be installed in a \\u201ccomputer\\u201d \\nwher\", \"e the operating system is already installed.\\nSimilarly, you can think of a container as the \\u201ccompute\", \"r\\u201d with the image hard disk installed. The \\ncontainer, just like a computer, can be powered on or of\", \"f.\\nLearn Docker specific terminologies\\nThis section lists terms and definitions you should be famili\", \"ar with before getting deeper into Docker. \\nFor further definitions, see the extensive glossary prov\", \"ided by Docker.\\nContainer image: A package with all the dependencies and information needed to creat\", \"e a container. \\nAn image includes all the dependencies (such as frameworks) plus deployment and exec\", \"ution 5 CHAPTER 1 | Overview of Containers and Docker\\nconfiguration to be used by a container runtim\", \"e. Usually, an image derives from multiple base images \\nthat are layers stacked on top of each other\", \" to form the container\\u2019s filesystem. An image is immutable \\nonce it has been created.\\nDockerfile: A \", \"text file that contains instructions for building a Docker image. It\\u2019s like a batch script, \\nthe fir\", \"st line states the base image to begin with and then follow the instructions to install required \\npr\", \"ograms, copy files, and so on, until you get the working environment you need.\\nBuild: The action of \", \"building a container image based on the information and context provided by its \\nDockerfile, plus ad\", \"ditional files in the folder where the image is built. You can build images with the \\nfollowing Dock\", \"er command:\\ndocker build\\nContainer: An instance of a Docker image. A container represents the execut\", \"ion of a single \\napplication, process, or service. It consists of the contents of a Docker image, an\", \" execution \\nenvironment, and a standard set of instructions. When scaling a service, you create mult\", \"iple instances \\nof a container from the same image. Or a batch job can create multiple containers fr\", \"om the same \\nimage, passing different parameters to each instance.\\nVolumes: Offer a writable filesys\", \"tem that the container can use. Since images are read-only but most \\nprograms need to write to the f\", \"ilesystem, volumes add a writable layer, on top of the container image, \\nso the programs have access\", \" to a writable filesystem. The program doesn\\u2019t know it\\u2019s accessing a \\nlayered filesystem, it\\u2019s just \", \"the filesystem as usual. Volumes live in the host system and are managed \\nby Docker.\\nTag: A mark or \", \"label you can apply to images so that different images or versions of the same image \\n(depending on \", \"the version number or the target environment) can be identified.\\nMulti-stage Build: Is a feature, si\", \"nce Docker 17.05 or higher, that helps to reduce the size of the final \\nimages. For example, a large\", \" base image, containing the SDK can be used for compiling and \\npublishing and then a small runtime-o\", \"nly base image can be used to host the application.\\nRepository (repo): A collection of related Docke\", \"r images, labeled with a tag that indicates the image \\nversion. Some repos contain multiple variants\", \" of a specific image, such as an image containing SDKs \\n(heavier), an image containing only runtimes\", \" (lighter), etc. Those variants can be marked with tags. A \\nsingle repo can contain platform variant\", \"s, such as a Linux image and a Windows image.\\nRegistry: A service that provides access to repositori\", \"es. The default registry for most public images is \\nDocker Hub (owned by Docker as an organization).\", \" A registry usually contains repositories from \\nmultiple teams. Companies often have private registr\", \"ies to store and manage images they\\u2019ve created. \\nAzure Container Registry is another example.\\nMulti-\", \"arch image: For multi-architecture, it\\u2019s a feature that simplifies the selection of the appropriate \", \"\\nimage, according to the platform where Docker is running. For example, when a Dockerfile requests a\", \" \\nbase image FROM mcr.microsoft.com/dotnet/sdk:6.0 from the registry, it actually gets 6.0-\\nnanoserv\", \"er-20H2, 6.0-nanoserver-1809 or 6.0-bullseye-slim, depending on the operating system \\nand version wh\", \"ere Docker is running.6 CHAPTER 1 | Overview of Containers and Docker\\nDocker Hub: A public registry \", \"to upload images and work with them. Docker Hub provides Docker \\nimage hosting, public or private re\", \"gistries, build triggers and web hooks, and integration with GitHub \\nand Bitbucket.\\nAzure Container \", \"Registry: A public resource for working with Docker images and its components in \\nAzure. This provid\", \"es a registry that\\u2019s close to your deployments in Azure and that gives you control \\nover access, mak\", \"ing it possible to use your Azure Active Directory groups and permissions.\\nDocker Trusted Registry (\", \"DTR): A Docker registry service (from Docker) that can be installed on\\u0002premises so it lives within t\", \"he organization\\u2019s datacenter and network. It\\u2019s convenient for private \\nimages that should be managed\", \" within the enterprise. Docker Trusted Registry is included as part of \\nthe Docker Datacenter produc\", \"t.\\nDocker Desktop: Development tools for Windows and macOS for building, running, and testing \\nconta\", \"iners locally. Docker Desktop for Windows provides development environments for both Linux \\nand Wind\", \"ows Containers. The Linux Docker host on Windows is based on a Hyper-V virtual machine. \\nThe host fo\", \"r Windows Containers is directly based on Windows. Docker Desktop for Mac is based on \\nthe Apple Hyp\", \"ervisor framework and the xhyve hypervisor, which provides a Linux Docker host virtual \\nmachine on m\", \"acOS. Docker Desktop for Windows and for Mac replaces Docker Toolbox, which was \\nbased on Oracle Vir\", \"tualBox.\\nCompose: A command-line tool and YAML file format with metadata for defining and running mu\", \"lti\\u0002container applications. You define a single application based on multiple images with one or mor\", \"e \\n.yml files that can override values depending on the environment. After you\\u2019ve created the defini\", \"tions, \\nyou can deploy the whole multi-container application with a single command (docker-compose u\", \"p) \\nthat creates a container per image on the Docker host.\\nCluster: A collection of Docker hosts exp\", \"osed as if it were a single virtual Docker host, so that the \\napplication can scale to multiple inst\", \"ances of the services spread across multiple hosts within the \\ncluster. Docker clusters can be creat\", \"ed with Kubernetes, Azure Service Fabric, Docker Swarm and \\nMesosphere DC/OS.\\nOrchestrator: A tool t\", \"hat simplifies the management of clusters and Docker hosts. Orchestrators \\nenable you to manage thei\", \"r images, containers, and hosts through a command-line interface (CLI) or a \\ngraphical UI. You can m\", \"anage container networking, configurations, load balancing, service discovery, \\nhigh availability, D\", \"ocker host configuration, and more. An orchestrator is responsible for running, \\ndistributing, scali\", \"ng, and healing workloads across a collection of nodes. Typically, orchestrator \\nproducts are the sa\", \"me products that provide cluster infrastructure, like Kubernetes and Azure Service \\nFabric, among ot\", \"her offerings in the market.\\nLearn docker containers, images, and registries\\nWhen using Docker, you \", \"create an app or service and package it and its dependencies into a \\ncontainer image. An image is a \", \"static representation of the app or service and its configuration and \\ndependencies.\\nTo run the app \", \"or service, the app\\u2019s image is instantiated to create a container, which will be running \\non the Doc\", \"ker host. Containers are initially tested in a development environment or PC.7 CHAPTER 1 | Overview \", \"of Containers and Docker\\nYou store images in a registry that acts as a library of images. You need a\", \" registry when deploying to \\nproduction orchestrators. Docker maintains a public registry via Docker\", \" Hub; other vendors provide \\nregistries for different collections of images, including Azure Contain\", \"er Registry. Alternatively, \\nenterprises can have a private registry on-premises for their own Docke\", \"r images.\\nFigure 1-4 shows how images and registries in Docker relate to other components. It also s\", \"hows the \\nmultiple registry offerings from vendors.\\nFigure 1-4. Taxonomy of Docker terms and concept\", \"s\\nThe registry is like a bookshelf where images are stored and available to be pulled for building \\n\", \"containers to run services or web apps. There are private Docker registries on-premises and on the \\n\", \"public cloud. Docker Hub is a public registry maintained by Docker, along the Docker Trusted Registr\", \"y \\nan enterprise-grade solution, Azure offers the Azure Container Registry. AWS, Google and others a\", \"lso \\nhave container registries.\\nBy putting images in a registry, you can store static and immutable \", \"application bits, including all \\nof their dependencies, at a framework level. You then can version a\", \"nd deploy images in multiple \\nenvironments and thus provide a consistent deployment unit.8 CHAPTER 1\", \" | Overview of Containers and Docker\\nPrivate image registries, either hosted on-premises or in the c\", \"loud, are recommended when:\\n\\u2022 Your images must not be shared publicly due to confidentiality.\\n\\u2022 You \", \"want to have minimum network latency between your images and your chosen \\ndeployment environment. Fo\", \"r example, if your production environment is Azure, you probably \\nwant to store your images in Azure\", \" Container Registry so that network latency is minimal. In a \\nsimilar way, if your production enviro\", \"nment is on-premises, you might want to have an on\\u0002premises Docker Trusted Registry available within\", \" the same local network.\\nRoad to modern applications based on containers\\nYou\\u2019re probably reading thi\", \"s book because you\\u2019re planning the development of new applications or \\nyou\\u2019re assessing the impact o\", \"f using Docker, Containers, and new approaches like Microservices in \\nyour company.\\nThe adoption of \", \"new development paradigms must be taken with caution before starting a project, to \\nassess the impac\", \"t on your dev teams, your budget, or your infrastructure.\\nMicrosoft has been working on rich guidanc\", \"e, sample applications, and a suite of e-books that can \\nhelp you make an informed decision and guid\", \"e your team through a successful development, \\ndeployment, and operations of your new applications.\\n\", \"This book belongs to a Microsoft suite of guides that cover many of the needs and challenges you\\u2019ll \", \"\\nface during the process of developing new modern applications based on containers.\\nYou can find add\", \"itional Microsoft e-books related to Docker containers in the list below:\\n\\u2022 .NET Microservices: Arch\", \"itecture for Containerized .NET Applications\\nhttps://learn.microsoft.com/dotnet/architecture/microse\", \"rvices/\\n\\u2022 Modernize existing .NET applications with Azure cloud and Windows Containers\\nhttps://learn\", \".microsoft.com/dotnet/architecture/modernize-with-azure-containers/9 CHAPTER 2 | Introduction to the\", \" Docker application life cycle\\nCHAPTER 2\\nIntroduction to the Docker \\napplication life cycle\\nThe life\", \" cycle of containerized applications is a journey that begins with the developer. The developer \\ncho\", \"oses to implement containers and Docker because it eliminates frictions in deployments and IT \\nopera\", \"tions, which ultimately helps everyone to be more agile, more productive end-to-end, and faster.\\nCon\", \"tainers as the foundation for DevOps \\ncollaboration\\nBy the very nature of the containers and Docker \", \"technology, developers can share their software and \\ndependencies easily with IT operations and prod\", \"uction environments while eliminating the typical \\u201cit \\nworks on my machine\\u201d excuse. Containers solve\", \" application conflicts between different environments. \\nIndirectly, containers and Docker bring deve\", \"lopers and IT operations closer together, making it easier \\nfor them to collaborate effectively. Ado\", \"pting the container workflow provides many customers \\nwith the DevOps continuity they\\u2019ve sought but \", \"previously had to implement via more complex \\nconfiguration for release and build pipelines. Contain\", \"ers simplify the build/test/deploy pipelines \\nin DevOps.\\nFigure 2-1. Main workloads per \\u201cpersonas\\u201d i\", \"n the life cycle for containerized Docker applications\\nWith Docker containers, developers own what\\u2019s\", \" within the container (application and service, and \\ndependencies to frameworks and components) and \", \"how the containers and services behave together \\nas an application composed by a collection of servi\", \"ces. The interdependencies of the multiple \\ncontainers are defined in a docker-compose.yml file, or \", \"what could be called a deployment manifest. \\nMeanwhile, IT operations teams (IT professionals and ma\", \"nagement) can focus on the management 10 CHAPTER 2 | Introduction to the Docker application life cyc\", \"le\\nof production environments; infrastructure; scalability; monitoring; and, ultimately, ensuring th\", \"at the \\napplications are delivering properly for the end users, without having to know the contents \", \"of the \\nvarious containers. Hence, the name \\u201ccontainer,\\u201d recalling the analogy to real-world shippin\", \"g \\ncontainers. Thus, the owners of a container\\u2019s content need not concern themselves with how the \\nc\", \"ontainer will be shipped, and the shipping company transports a container from its point of origin \\n\", \"to its destination without knowing or caring about the contents. In a similar manner, developers can\", \" \\ncreate and own the contents within a Docker container without the need to concern themselves with \", \"\\nthe \\u201ctransport\\u201d mechanisms.\\nIn the pillar on the left side of Figure 2-1, developers write and run \", \"code locally in Docker containers \\nby using Docker for Windows or Mac. They define the operating env\", \"ironment for the code by using a \\nDockerfile that specifies the base operating system to run as well\", \" as the build steps for building their \\ncode into a Docker image. The developers define how one or m\", \"ore images will interoperate using the \\naforementioned docker-compose.yml file deployment manifest. \", \"As they complete their local \\ndevelopment, they push their application code plus the Docker configur\", \"ation files to the code \\nrepository of their choice (that is, Git repository).\\nThe DevOps pillar def\", \"ines the build\\u2013Continuous Integration (CI) pipelines using the Dockerfile \\nprovided in the code repo\", \"sitory. The CI system pulls the base container images from the selected \\nDocker registry and builds \", \"the custom Docker images for the application. The images then are \\nvalidated and pushed to the Docke\", \"r registry used for the deployments to multiple environments.\\nIn the pillar on the right, operations\", \" teams manage deployed applications and infrastructure in \\nproduction while monitoring the environme\", \"nt and applications so that they can provide feedback and \\ninsights to the development team about ho\", \"w the application might be improved. Container apps are \\ntypically run in production using container\", \" orchestrators like Kubernetes, where usually Helm charts\\nare used to configure deployment units, in\", \"stead of docker-compose files.\\nThe two teams are collaborating through a foundational platform (Dock\", \"er containers) that provides \\na separation of concerns as a contract, while greatly improving the tw\", \"o teams\\u2019 collaboration in the \\napplication life cycle. The developers own the container contents, it\", \"s operating environment, and the \\ncontainer interdependencies, whereas the operations teams take the\", \" built images along with the \\nmanifest and runs them in their orchestration system.\\nChallenges in th\", \"e application life cycle when using Docker.\\nThere are many reasons that will increase the number of \", \"containerized applications in the upcoming \\nyears, and one of these reasons is the creation of appli\", \"cations based on microservices.\\nDuring the last 15 years, the use of web services has been the base \", \"of thousands of applications, and \\nprobably, after a few years, you\\u2019ll find the same situation with \", \"microservice-based applications \\nrunning on Docker containers.\\nIt is also worth to mention that you \", \"can also use Docker containers for monolithic applications and \\nyou still get most of the benefits o\", \"f Docker. Containers are not targeting only microservices.\\nThe use of Docker containerization and mi\", \"croservices causes new challenges in the development \\nprocess of your organizations and therefore, y\", \"ou need a solid strategy to maintain many containers 11 CHAPTER 2 | Introduction to the Docker appli\", \"cation life cycle\\nand microservices running on production systems. Eventually, enterprise applicatio\", \"ns will have \\nhundreds or thousands of containers/instances running in production.\\nThese challenges \", \"create new demands when using DevOps tools, so you\\u2019ll have to define new \\nprocesses in your DevOps a\", \"ctivities, and find answers for the following type of questions:\\n\\u2022 Which tools can I use for develop\", \"ment, CI/CD, management and operations??\\n\\u2022 How can my company manage errors in containers when runni\", \"ng in production?\\n\\u2022 How can we change pieces of our software in production with minimum downtime?\\n\\u2022 \", \"How can we scale and monitor our production system?\\n\\u2022 How can we include the testing and deployment \", \"of containers in our release pipeline?\\n\\u2022 How can we use Open Source tools/platforms for containers i\", \"n Microsoft Azure?\\nIf you can answer all those questions, you\\u2019ll be better prepared to move your app\", \"lications (existing or \\nnew apps) to Docker containers.\\nIntroduction to a generic end-to-end Docker \", \"application life cycle \\nworkflow\\nFigure 2-2 presents a more detailed workflow for a Docker applicati\", \"on life cycle, focusing in this \\ninstance on specific DevOps activities and assets.\\nFigure 2-2. High\", \"-level workflow for the Docker containerized application life cycle\\nEverything begins with the devel\", \"oper, who starts writing code in the inner-loop workflow. The inner\\u0002loop stage is where developers d\", \"efine everything that happens before pushing code into the code \\nrepository (for example, a source c\", \"ontrol system such as Git). After it\\u2019s committed, the repository \\ntriggers Continuous Integration (C\", \"I) and the rest of the workflow.12 CHAPTER 2 | Introduction to the Docker application life cycle\\nThe\", \" inner loop consists of typical steps like \\u201ccode,\\u201d \\u201crun,\\u201d \\u201ctest,\\u201d and \\u201cdebug,\\u201d plus the additional s\", \"teps \\nneeded right before running the app locally. This is the developer\\u2019s process to run and test t\", \"he app as \\na Docker container. The inner-loop workflow will be explained in the sections that follow\", \".\\nTaking a step back to look at the end-to-end workflow, the DevOps workflow is more than a \\ntechnol\", \"ogy or a tool set, it\\u2019s a mindset that requires cultural evolution. It\\u2019s people, processes, and the \", \"\\nappropriate tools to make your application life cycle faster and more predictable. Enterprises that\", \" \\nadopt a containerized workflow typically restructure their organizations to represent people and \\n\", \"processes that match the containerized workflow.\\nPracticing DevOps can help teams respond faster tog\", \"ether to competitive pressures by replacing \\nerror-prone manual processes with automation, which res\", \"ults in improved traceability and repeatable \\nworkflows. Organizations also can manage environments \", \"more efficiently and realize cost savings with \\na combination of on-premises and cloud resources as \", \"well as tightly integrated tooling.\\nWhen implementing your DevOps workflow for Docker applications, \", \"you\\u2019ll see that Docker \\ntechnologies are present in almost every stage of the workflow, from your de\", \"velopment box while \\nworking in the inner loop (code, run, debug), the build-test-CI phase, and, fin\", \"ally, the deployment of \\nthose containers to the staging and production environments.\\nImprovement of\", \" quality practices helps to identify defects early in the development cycle, which \\nreduces the cost\", \" of fixing them. By including the environment and dependencies in the image and \\nadopting a philosop\", \"hy of deploying the same image across multiple environments, you promote a \\ndiscipline of extracting\", \" the environment-specific configurations making deployments more reliable.\\nRich data obtained throug\", \"h effective instrumentation (monitoring and diagnostics) provides insight \\ninto performance issues a\", \"nd user behavior to guide future priorities and investments.\\nDevOps should be considered a journey, \", \"not a destination. It should be implemented incrementally \\nthrough appropriately scoped projects fro\", \"m which you can demonstrate success, learn, and evolve.\\nBenefits of DevOps for containerized applica\", \"tions\\nHere are some of the most important benefits provided by a solid DevOps workflow:\\n\\u2022 Deliver be\", \"tter-quality software, faster and with better compliance.\\n\\u2022 Drive continuous improvement and adjustm\", \"ents earlier and more economically.\\n\\u2022 Increase transparency and collaboration among stakeholders inv\", \"olved in delivering and \\noperating software.\\n\\u2022 Control costs and utilize provisioned resources more \", \"effectively while minimizing security \\nrisks.\\n\\u2022 Plug and play well with many of your existing DevOps\", \" investments, including investments in \\nopen-source.13 CHAPTER 3 | Introduction to the Microsoft pla\", \"tform and tools for containerized apps\\nCHAPTER 3\\nIntroduction to the \\nMicrosoft platform \\nand tools \", \"for containerized \\napps\\nVision: Create an adaptable, enterprise-grade, containerized application lif\", \"e cycle that spans your \\ndevelopment, IT operations, and production management.\\nFigure 3-1 shows the\", \" main pillars in the life cycle of Docker apps classified by the type of work \\ndelivered by multiple\", \" teams (app-development, DevOps infrastructure processes, and IT management \\nand operations). Usuall\", \"y, in the enterprise, the profiles of \\u201cthe persona\\u201d responsible for each area are \\ndifferent. So are\", \" their skills.14 CHAPTER 3 | Introduction to the Microsoft platform and tools for containerized apps\", \"\\nFigure 3-1. Main pillars in the life cycle for containerized Docker applications with Microsoft pla\", \"tform and tools\\nA containerized Docker life-cycle workflow can be initially prescriptive based on \\u201cb\", \"y-default product \\nchoices,\\u201d making it easier for developers to get started faster, but it\\u2019s fundame\", \"ntal that under the \\nhood there must be an open framework so that it will be a flexible workflow cap\", \"able of adjusting to \\nthe different contexts from each organization or enterprise. The workflow infr\", \"astructure (components \\nand products) must be flexible enough to cover the environment that each com\", \"pany will have in the \\nfuture, even being capable of swapping development or DevOps products to othe\", \"rs. This flexibility, \\nopenness, and the broad choice of technologies in the platform and infrastruc\", \"ture are precisely the \\nMicrosoft priorities for containerized Docker applications, as explained in \", \"the chapters that follow.\\nTable 3-1 demonstrates that the intention of the Azure DevOps for containe\", \"rized Docker applications \\nis to provide an open DevOps workflow so that you can choose what product\", \"s to use for each phase \\n(Microsoft or third-party) while providing a simplified workflow that provi\", \"des \\u201cby-default-products\\u201d \\nalready connected; thus, you can quickly get started with your enterprise\", \"-level DevOps workflow for \\nDocker apps.\\nTable 3-1. DevOps workflows, open to any technology\\nHost Mi\", \"crosoft technologies Third-party (Azure pluggable)\\nPlatform for \\nDocker apps\\n\\u2022 Microsoft Visual Stud\", \"io and \\nVisual Studio Code\\n\\u2022 .NET\\n\\u2022 Microsoft Azure Kubernetes \\nService (AKS)\\n\\u2022 Azure Container Regi\", \"stry\\\\\\n\\u2022 Any code editor (for example, Sublime)\\n\\u2022 Any language (Node.js, Java, Go, etc.)\\n\\u2022 Any orches\", \"trator and scheduler\\n\\u2022 Any Docker registry\\\\15 CHAPTER 3 | Introduction to the Microsoft platform and\", \" tools for containerized apps\\nHost Microsoft technologies Third-party (Azure pluggable)\\nDevOps for \\n\", \"Docker apps\\n\\u2022 Azure DevOps Services\\n\\u2022 Microsoft Team Foundation \\nServer\\n\\u2022 GitHub\\n\\u2022 Azure Kubernetes \", \"Service \\n(AKS)\\\\\\n\\u2022 GitHub, Git, Subversion, etc.\\n\\u2022 Jenkins, Chef, Puppet, Velocity, CircleCI, \\nTravis\", \"CI, etc.\\n\\u2022 On-premises Docker Datacenter, Kubernetes, \\nMesos DC/OS, etc.\\\\\\nManagement \\nand \\nmonitorin\", \"g\\n\\u2022 Azure Monitor \\u2022 Marathon, Chronos, etc.\\\\\\nThe Microsoft platform and tools for containerized Dock\", \"er apps, as defined in Table 3-1, comprise the \\nfollowing components:\\n\\u2022 Platform for Docker Apps dev\", \"elopment The development of a service, or collection of \\nservices that make up an \\u201capp.\\u201d The develop\", \"ment platform provides all the work developers \\nrequires prior to pushing their code to a shared cod\", \"e repository. Developing services, \\ndeployed as containers, are similar to the development of the sa\", \"me apps or services without \\nDocker. You continue to use your preferred language (.NET, Node.js, Go,\", \" etc.) and preferred \\neditor or IDE like Visual Studio or Visual Studio Code. However, rather than c\", \"onsider Docker a \\ndeployment destination, you develop your services in the Docker environment. You b\", \"uild, run, \\ntest, and debug your code in containers locally, providing the destination environment a\", \"t \\ndevelopment time. By providing the destination environment locally, Docker containers set up \\nwha\", \"t will drastically help you improve your DevOps life cycle. Visual Studio and Visual Studio \\nCode ha\", \"ve extensions to integrate Docker containers within your development process.\\n\\u2022 DevOps for Docker Ap\", \"ps Developers creating Docker applications can use Azure DevOps, \\nGitHub or any other third-party pr\", \"oduct, like Jenkins, to build out a comprehensive \\nautomated application life-cycle management (ALM)\", \".\\nWith Azure DevOps and/or GitHub, developers can create container-focused DevOps for a \\nfast, itera\", \"tive process that covers source-code control from anywhere (Azure DevOps-Git, \\nGitHub, any remote Gi\", \"t repository, or Subversion), Continuous Integration (CI), internal unit \\ntests, inter-container/ser\", \"vice integration tests, Continuous Delivery (CD), and release \\nmanagement (RM). Developers also can \", \"automate their Docker application releases into Azure \\nKubernetes Service (AKS), from development to\", \" staging and production environments.\\n\\u2022 Management and Monitoring IT can manage and monitor producti\", \"on applications and \\nservices in several ways, integrating both perspectives in a consolidated exper\", \"ience.\\n\\u2013 Azure portal Azure Kubernetes Service (AKS) helps you to set up and maintain your \\nDocker e\", \"nvironments. You can also use other orchestrators to visualize and configure \\nyour cluster.\\n\\u2013 Docker\", \" tools You can manage your container applications using familiar tools. \\nThere\\u2019s no need to change y\", \"our existing Docker management practices to move \\ncontainer workloads to the cloud. Use the applicat\", \"ion management tools you\\u2019re 16 CHAPTER 3 | Introduction to the Microsoft platform and tools for cont\", \"ainerized apps\\nalready familiar with and connect via the standard API endpoints for the orchestrator\", \" \\nof your choice. You also can use other third-party tools to manage your Docker \\napplications or ev\", \"en CLI Docker tools.\\nEven if you\\u2019re familiar with Linux commands, you can manage your container \\napp\", \"lications using Microsoft Windows and PowerShell with a Linux Subsystem \\ncommand line and the produc\", \"ts (Docker, Kubernetes\\u2026) clients running on this Linux \\nSubsystem capability. You\\u2019ll learn more abou\", \"t using these tools under Linux \\nSubsystem using your favorite Microsoft Windows OS later in this bo\", \"ok.\\n\\u2013 Open-source tools Because AKS exposes the standard API endpoints for the \\norchestration engine\", \", the most popular tools are compatible with AKS and, in most \\ncases, will work out of the box\\u2014inclu\", \"ding visualizers, monitoring, command-line \\ntools, and even future tools as they become available.\\n\\u2013\", \" GitHub Advanced Security GitHub Advanced Security offers a suite of tools for \\nsecuring the softwar\", \"e supply chain that can seamlessly integrate security into the \\ndaily workflow of teams developing c\", \"ontainerized applications.\\n\\u2013 Azure Monitor Is Azure\\u2019s solution to monitor every angle of your produc\", \"tion \\nenvironment. You can monitor production Docker applications by just setting up its \\nSDK into y\", \"our services so that you can get system-generated log data from the \\napplications.\\nThus, Microsoft o\", \"ffers a complete foundation for an end-to-end containerized Docker application life \\ncycle. However,\", \" it\\u2019s a collection of products and technologies that allow you to optionally select and \\nintegrate w\", \"ith existing tools and processes. The flexibility in a broad approach along with the strength \\nin th\", \"e depth of capabilities place Microsoft in a strong position for containerized Docker application \\nd\", \"evelopment.17 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azu\", \"re\\nCHAPTER 4\\nDesigning and developing \\ncontainerized apps using \\nDocker and Microsoft \\nAzure\\nVision:\", \" Design and develop scalable solutions with Docker in mind.\\nThere are many great-fit use cases for c\", \"ontainers, not just for microservices-oriented architectures, but \\nalso when you simply have regular\", \" services or web applications to run and you want to reduce frictions \\nbetween development and produ\", \"ction environment deployments.\\nDesign Docker applications\\nChapter 1 introduced the fundamental conce\", \"pts regarding containers and Docker. That information is \\nthe basic level of information you need to\", \" get started. But, enterprise applications can be complex and \\ncomposed of multiple services instead\", \" of a single service or container. For those optional use cases, \\nyou need to know additional approa\", \"ches to design, such as Service-Oriented Architecture (SOA) and \\nthe more advanced microservices con\", \"cepts and container orchestration concepts. The scope of this \\ndocument is not limited to microservi\", \"ces but to any Docker application life cycle, therefore, it does \\nnot explore microservices architec\", \"ture in depth because you can also use containers and Docker with \\nregular SOA, background tasks or \", \"jobs, or even with monolithic application deployment approaches.\\nMore info To learn more about enter\", \"prise applications and microservices architecture in depth, read \\nthe guide NET Microservices: Archi\", \"tecture for Containerized .NET Applications that you can also \\ndownload from https://aka.ms/Microser\", \"vicesEbook.\\nHowever, before you get into the application life cycle and DevOps, it\\u2019s important to kn\", \"ow how you\\u2019re \\ngoing to design and construct your application and what are your design choices.18 CH\", \"APTER 4 | Designing and developing containerized apps using Docker and Microsoft Azure\\nCommon contai\", \"ner design principles\\nAhead of getting into the development process there are a few basic concepts w\", \"orth mentioning with \\nregard to how you use containers.\\nContainer equals a process\\nIn the container \", \"model, a container represents a single process. By defining a container as a process \\nboundary, you \", \"begin to create the primitives used to scale, or batch-off, processes. When you run a \\nDocker contai\", \"ner, you\\u2019ll see an ENTRYPOINT definition. This defines the process and the lifetime of \\nthe containe\", \"r. When the process completes, the container life-cycle ends. There are long-running \\nprocesses, suc\", \"h as web servers, and short-lived processes, such as batch jobs, which might have \\nbeen implemented \", \"as Microsoft Azure WebJobs. If the process fails, the container ends, and the \\norchestrator takes ov\", \"er. If the orchestrator was instructed to keep five instances running and one fails, \\nthe orchestrat\", \"or will create another container to replace the failed process. In a batch job, the process \\nis star\", \"ted with parameters. When the process completes, the work is complete.\\nYou might find a scenario in \", \"which you want multiple processes running in a single container. In any \\narchitecture document, ther\", \"e\\u2019s never a \\u201cnever,\\u201d nor is there always an \\u201calways.\\u201d For scenarios requiring \\nmultiple processes, a\", \" common pattern is to use Supervisor.\\nMonolithic applications\\nIn this scenario, you\\u2019re building a si\", \"ngle and monolithic web application or service and deploying it as \\na container. Within the applicat\", \"ion, the structure might not be monolithic; it might comprise several \\nlibraries, components, or eve\", \"n layers (application layer, domain layer, data access layer, etc.). \\nExternally, it\\u2019s a single cont\", \"ainer, like a single process, single web application, or single service.\\nTo manage this model, you d\", \"eploy a single container to represent the application. To scale it, just add \\na few more copies with\", \" a load balancer in front. The simplicity comes from managing a single \\ndeployment in a single conta\", \"iner or virtual machine (VM).\\nFollowing the principal that a container does one thing only, and does\", \" it in one process, the \\nmonolithic pattern is in conflict. You can include multiple components/libr\", \"aries or internal layers \\nwithin each container, as illustrated in Figure 4-1.19 CHAPTER 4 | Designi\", \"ng and developing containerized apps using Docker and Microsoft Azure\\nFigure 4-1. An example of mono\", \"lithic application architecture\\nA monolithic app has all or most of its functionality within a singl\", \"e process or container and it\\u2019s \\ncomponentized in internal layers or libraries. The downside to this\", \" approach comes if or when the \\napplication grows, requiring it to scale. If the entire application \", \"scaled, it\\u2019s not really a problem. \\nHowever, in most cases, a few parts of the application are the c\", \"hoke points that require scaling, \\nwhereas other components are used less.\\nUsing the typical e-comme\", \"rce example, what you likely need is to scale the product information \\ncomponent. Many more customer\", \"s browse products than purchase them. More customers use their \\nbasket than use the payment pipeline\", \". Fewer customers add comments or view their purchase history. \\nAnd you likely have only a handful o\", \"f employees, in a single region, that need to manage the content \\nand marketing campaigns. By scalin\", \"g the monolithic design, all of the code is deployed multiple times.\\nIn addition to the \\u201cscale-every\", \"thing\\u201d problem, changes to a single component require complete \\nretesting of the entire application \", \"as well as a complete redeployment of all the instances.\\nThe monolithic approach is common, and many\", \" organizations are developing with this architectural \\nmethod. Many enjoy good enough results, where\", \"as others encounter limits. Many designed their \\napplications in this model because the tools and in\", \"frastructure were too difficult to build SOAs, and \\nthey didn\\u2019t see the need\\u2014until the app grew.\\nFro\", \"m an infrastructure perspective, each server can run many applications within the same host and \\nhav\", \"e an acceptable ratio of efficiency in your resources usage, as shown in Figure 4-2.20 CHAPTER 4 | D\", \"esigning and developing containerized apps using Docker and Microsoft Azure\\nFigure 4-2. A host runni\", \"ng multiple apps/containers\\nFinally, from an availability perspective, monolithic applications must \", \"be deployed as a whole; that \\nmeans that in case you must stop and start, all functionality and all \", \"users will be affected during the \\ndeployment window. In certain situations, the use of Azure and co\", \"ntainers can minimize these \\nsituations and reduce the probability of downtime of your application, \", \"as you can see in Figure 4-3.\\nYou can deploy monolithic applications in Azure by using dedicated VMs\", \" for each instance. Using \\nAzure VM Scale Sets, you can scale the VMs easily.\\nYou can also use Azure\", \" App Services to run monolithic applications and easily scale instances without \\nhaving to manage th\", \"e VMs. Azure App Services can run single instances of Docker containers, as well, \\nsimplifying the d\", \"eployment.\\nYou can deploy multiple VMs as Docker hosts and run any number of containers per VM. Then\", \", by \\nusing an Azure Load Balancer, as illustrated in the Figure 4-3, you can manage scaling.\\nFigure\", \" 4-3. Multiple hosts scaling out a single Docker application\\nYou can manage the deployment of the ho\", \"sts themselves via traditional deployment techniques.\\nYou can manage Docker containers from the comm\", \"and line by using commands like docker run and \\ndocker-compose up, and you can also automate it in C\", \"ontinuous Delivery (CD) pipelines and deploy \\nto Docker hosts from Azure DevOps Services, for instan\", \"ce.21 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azure\\nMonol\", \"ithic application deployed as a container\\nThere are benefits to using containers to manage monolithi\", \"c deployments. Scaling the instances of \\ncontainers is far faster and easier than deploying addition\", \"al VMs.\\nDeploying updates as Docker images is far faster and network efficient. Docker containers ty\", \"pically \\nstart in seconds, speeding rollouts. Tearing down a Docker container is as easy as invoking\", \" the docker \\nstop command, typically completing in less than a second.\\nBecause containers are inhere\", \"ntly immutable, by design, you never need to worry about corrupted \\nVMs because an update script for\", \"got to account for some specific configuration or file left on disk.\\nAlthough monolithic apps can be\", \"nefit from Docker, we\\u2019re touching on only the tips of the benefits. \\nThe larger benefits of managing\", \" containers come from deploying with container orchestrators that \\nmanage the various instances and \", \"life cycle of each container instance. Breaking up the monolithic \\napplication into subsystems that \", \"can be scaled, developed, and deployed individually is your entry \\npoint into the realm of microserv\", \"ices.\\nTo learn about how to \\u201clift and shift\\u201d monolithic applications with containers and how you can\", \" \\nmodernize your applications, you can read this additional Microsoft guide, Modernize existing .NET\", \" \\napplications with Azure cloud and Windows Containers, which you can also download as PDF from \\nhtt\", \"ps://aka.ms/LiftAndShiftWithContainersEbook.\\nPublish a single Docker container app to Azure App Serv\", \"ice\\nEither because you want to get a quick validation of a container deployed to Azure or because th\", \"e \\napp is simply a single-container app, Azure App Services provides a great way to provide scalable\", \" \\nsingle-container services.\\nUsing Azure App Service is intuitive and you can get up and running qui\", \"ckly because it provides great \\nGit integration to take your code, build it in Microsoft Visual Stud\", \"io, and directly deploy it to Azure. \\nBut, traditionally (with no Docker), if you needed other capab\", \"ilities, frameworks, or dependencies that \\naren\\u2019t supported in App Services, you needed to wait for \", \"it until the Azure team updates those \\ndependencies in App Service or switched to other services lik\", \"e Service Fabric, Cloud Services, or even \\nplain VMs, for which you have further control and can ins\", \"tall a required component or framework for \\nyour application.\\nNow, as shown in Figure 4-4, when usin\", \"g Visual Studio 2022, container support in Azure App Service \\ngives you the ability to include whate\", \"ver you want in your app environment. If you added a \\ndependency to your app, because you\\u2019re running\", \" it in a container, you get the capability of including \\nthose dependencies in your Dockerfile or Do\", \"cker image.22 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azu\", \"re\\nFigure 4-4. Publishing a container to Azure App Service from Visual Studio apps/containers\\nFigure\", \" 4-4 also shows that the publish flow pushes an image through a Container Registry, which can \\nbe th\", \"e Azure Container Registry (a registry near to your deployments in Azure and secured by Azure \\nActiv\", \"e Directory groups and accounts) or any other Docker Registry like Docker Hub or on-premises \\nregist\", \"ries.\\nState and data in Docker applications\\nIn most cases, you can think of a container as an instan\", \"ce of a process. A process does not maintain \\npersistent state. While a container can write to its l\", \"ocal storage, assuming that an instance will be \\naround indefinitely is like assuming that a single \", \"location in memory will be durable. Container \\nimages, like processes, should be assumed to have mul\", \"tiple instances and that they will eventually be \\nkilled; if they\\u2019re managed with a container orches\", \"trator, it should be assumed that they might get \\nmoved from one node or VM to another.\\nThe followin\", \"g solutions are used to manage persistent data in Docker applications:\\nFrom the Docker host, as Dock\", \"er Volumes:\\n\\u2022 Volumes are stored in an area of the host filesystem that\\u2019s managed by Docker.\\n\\u2022 Bind \", \"mounts can map to any folder in the host filesystem, so access can\\u2019t be controlled from \\na Docker pr\", \"ocess and can pose a security risk as a container could access sensitive OS folders.23 CHAPTER 4 | D\", \"esigning and developing containerized apps using Docker and Microsoft Azure\\n\\u2022 tmpfs mounts are like \", \"virtual folders that only exist in the host\\u2019s memory and are never \\nwritten to the filesystem.\\nFrom \", \"remote storage:\\n\\u2022 Azure Storage provides geo-distributable storage, providing a good long-term persi\", \"stence \\nsolution for containers.\\n\\u2022 Remote relational databases like Azure SQL Database, NoSQL databa\", \"ses like Azure Cosmos \\nDB, or cache services like Redis.\\nFrom the Docker container:\\n\\u2022 Docker provide\", \"s a feature named the overlay file system. This feature implements a copy-on\\u0002write task that stores \", \"updated information to the root file system of the container. That \\ninformation \\u201clays on top of\\u201d the\", \" original image on which the container is based. If the \\ncontainer is deleted from the system, those\", \" changes are lost. Therefore, while it\\u2019s possible to \\nsave the state of a container within its local\", \" storage, designing a system based on this feature \\nwould conflict with the premise of container des\", \"ign, which by default is stateless.\\n\\u2022 However, Docker Volumes is now the preferred way to handle loc\", \"al data in Docker. If you \\nneed more information about storage in containers, check on Docker storag\", \"e drivers and \\nAbout images, containers, and storage drivers.\\nThe following provides additional deta\", \"il about these options.\\nVolumes are directories mapped from the host OS to directories in containers\", \". When code in the \\ncontainer has access to the directory, that access is actually to a directory on\", \" the host OS. This \\ndirectory is not tied to the lifetime of the container itself, and the directory\", \" is managed by Docker and \\nisolated from the core functionality of the host machine. Thus, data volu\", \"mes are designed to persist \\ndata independently of the life of the container. If you delete a contai\", \"ner or an image from the Docker \\nhost, the data persisted in the data volume is not deleted.\\nVolumes\", \" can be named or anonymous (the default). Named volumes are the evolution of Data \\nVolume Containers\", \" and make it easy to share data between containers. Volumes also support \\nvolume drivers that allow \", \"you to store data on remote hosts, among other options.\\nBind mounts have been available for a long t\", \"ime and allow the mapping of any folder to a mount \\npoint in a container. Bind mounts have more limi\", \"tations than volumes and some important security \\nissues, so volumes are the recommended option.\\ntmp\", \"fs mounts are virtual folders that live only in the host\\u2019s memory and are never written to the \\nfile\", \"system. They are fast and secure but use memory and are only meant for non-persistent data.\\nAs shown\", \" in Figure 4-5, regular Docker volumes can be stored outside of the containers themselves \\nbut withi\", \"n the physical boundaries of the host server or VM. However, Docker containers cannot \\naccess a volu\", \"me from one host server or VM to another. In other words, with these volumes, it isn\\u2019t \\npossible to \", \"manage data shared between containers that run on different Docker hosts, although it \\ncould be achi\", \"eved with a volume driver that supports remote hosts.24 CHAPTER 4 | Designing and developing contain\", \"erized apps using Docker and Microsoft Azure\\nFigure 4-5. Volumes and external data sources for conta\", \"iner-based applications\\nIn addition, when Docker containers are managed by an orchestrator, containe\", \"rs might \\u201cmove\\u201d \\nbetween hosts, depending on the optimizations performed by the cluster. Therefore, \", \"it isn\\u2019t \\nrecommended that you use data volumes for business data. But they are a good mechanism to \", \"work \\nwith trace files, temporal files, or similar, that will not impact business data consistency.\\n\", \"Remote data sources and cache tools like Azure SQL Database, Azure Cosmos DB, or a remote cache \\nlik\", \"e Redis can be used in containerized applications the same way they are used when developing \\nwithou\", \"t containers. This is a proven way to store business application data.\\nAzure Storage. Business data \", \"usually needs to be placed in external resources or databases, like \\nAzure Storage. Azure Storage pr\", \"ovides the following services in the cloud:\\n\\u2022 Blob storage stores unstructured object data. A blob c\", \"an be any type of text or binary data, \\nsuch as document or media files (images, audio, and video fi\", \"les). Blob storage is also referred \\nto as Object storage.\\n\\u2022 File storage offers shared storage for \", \"legacy applications using the standard SMB protocol. \\nAzure virtual machines and cloud services can \", \"share file data across application components \\nvia mounted shares. On-premises applications can acce\", \"ss file data in a share via the File \\nService REST API.\\n\\u2022 Table storage stores structured datasets. \", \"Table storage is a NoSQL key-attribute data store, \\nwhich allows rapid development and fast access t\", \"o large quantities of data.\\nRelational databases and NoSQL databases. There are many choices for ext\", \"ernal databases, from \\nrelational databases like SQL Server, PostgreSQL, Oracle, or NoSQL databases \", \"like Azure Cosmos DB, \\nMongoDB, etc. These databases are not going to be explained as part of this g\", \"uide since they are a \\ndifferent topic altogether.25 CHAPTER 4 | Designing and developing containeri\", \"zed apps using Docker and Microsoft Azure\\nService-oriented applications\\nService-Oriented Architectur\", \"e (SOA) was an overused term that meant many different things to \\ndifferent people. But as a common \", \"denominator, SOA means that you structure the architecture of \\nyour application by decomposing it in\", \"to several services (most commonly as HTTP services) that can \\nbe classified in different types like\", \" subsystems or, in other cases, as tiers.\\nToday, you can deploy those services as Docker containers,\", \" which solve deployment-related issues \\nbecause all of the dependencies are included in the containe\", \"r image. However, when you need to \\nscale out SOAs, you might encounter challenges if you\\u2019re deployi\", \"ng based on single instances. This \\nchallenge can be handled using Docker clustering software or an \", \"orchestrator. You\\u2019ll get to look at \\norchestrators in greater detail in the next section, when you e\", \"xplore microservices approaches.\\nDocker containers are useful (but not required) for both traditiona\", \"l service-oriented architectures and \\nthe more advanced microservices architectures.\\nAt the end of t\", \"he day, the container clustering solutions are useful for both a traditional SOA \\narchitecture and f\", \"or a more advanced microservices architecture in which each microservice owns its \\ndata model. And t\", \"hanks to multiple databases, you can also scale out the data tier instead of working \\nwith monolithi\", \"c databases shared by the SOA services. However, the discussion about splitting the \\ndata is purely \", \"about architecture and design.\\nOrchestrating microservices and multi-container \\napplications for hig\", \"h scalability and availability\\nUsing orchestrators for production-ready applications is essential if\", \" your application is based on \\nmicroservices or split across multiple containers. As introduced prev\", \"iously, in a microservice-based \\napproach, each microservice owns its model and data so that it will\", \" be autonomous from a \\ndevelopment and deployment point of view. But even if you have a more traditi\", \"onal application that\\u2019s \\ncomposed of multiple services (like SOA), you\\u2019ll also have multiple contain\", \"ers or services comprising a \\nsingle business application that need to be deployed as a distributed \", \"system. These kinds of systems \\nare complex to scale out and manage; therefore, you absolutely need \", \"an orchestrator if you want to \\nhave a production-ready and scalable multi-container application.\\nFi\", \"gure 4-6 illustrates deployment into a cluster of an application composed of multiple microservices \", \"\\n(containers).26 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft \", \"Azure\\nFigure 4-6. A cluster of containers\\nIt looks like a logical approach. But how are you handling\", \" load balancing, routing, and orchestrating \\nthese composed applications?\\nThe Docker CLI meets the n\", \"eeds of managing one container on one host, but it falls short when it \\ncomes to managing multiple c\", \"ontainers deployed on multiple hosts for more complex distributed \\napplications. In most cases, you \", \"need a management platform that will automatically start containers, \\nscale out containers with mult\", \"iple instances per image, suspend them, or shut them down when \\nneeded, and ideally also control how\", \" they access resources like the network and data storage.\\nTo go beyond the management of individual \", \"containers or simple composed apps and move toward \\nlarger enterprise applications with microservice\", \"s, you must turn to orchestration and clustering \\nplatforms.\\nFrom an architecture and development po\", \"int of view, if you\\u2019re building large, enterprise, \\nmicroservices-based, applications, it\\u2019s importan\", \"t to understand the following platforms and products \\nthat support advanced scenarios:\\n\\u2022 Clusters an\", \"d orchestrators. When you need to scale out applications across many Docker \\nhosts, such as with a l\", \"arge microservices-based application, it\\u2019s critical to be able to manage \\nall of those hosts as a si\", \"ngle cluster by abstracting the complexity of the underlying platform. \\nThat\\u2019s what the container cl\", \"usters and orchestrators provide. Examples of orchestrators are \\nAzure Service Fabric and Kubernetes\", \". Kubernetes is available in Azure through Azure \\nKubernetes Service.27 CHAPTER 4 | Designing and de\", \"veloping containerized apps using Docker and Microsoft Azure\\n\\u2022 Schedulers. Scheduling means to have \", \"the capability for an administrator to launch containers \\nin a cluster, so schedulers also provide a\", \" user interface for doing so. A cluster scheduler has \\nseveral responsibilities: to use the cluster\\u2019\", \"s resources efficiently, to set the constraints \\nprovided by the user, to efficiently load-balance c\", \"ontainers across nodes or hosts, and to be \\nrobust against errors while providing high availability.\", \"\\nThe concepts of a cluster and a scheduler are closely related, so the products provided by differen\", \"t \\nvendors often provide both sets of capabilities. The section below shows the most important platf\", \"orm \\nand software choices you have for clusters and schedulers. These orchestrators are widely offer\", \"ed in \\npublic clouds like Azure.\\nSoftware platforms for container clustering, orchestration, and \\nsc\", \"heduling\\nPlatform Comments\\nKubernetes Kubernetes is an open-source product that \\nprovides functional\", \"ity that ranges from \\ncluster infrastructure and container \\nscheduling to orchestrating capabilities\", \". It \\nlets you automate deployment, scaling, \\nand operations of application containers \\nacross clust\", \"ers of hosts.\\nKubernetes provides a container-centric \\ninfrastructure that groups application \\nconta\", \"iners into logical units for easy \\nmanagement and discovery.\\nKubernetes is mature in Linux, less mat\", \"ure \\nin Windows.\\nAzure Kubernetes Service (AKS) Azure Kubernetes Service (AKS) is a \\nmanaged Kuberne\", \"tes container \\norchestration service in Azure that \\nsimplifies Kubernetes cluster\\u2019s \\nmanagement, dep\", \"loyment, and \\noperations.28 CHAPTER 4 | Designing and developing containerized apps using Docker and\", \" Microsoft Azure\\nPlatform Comments\\nAzure Service Fabric Service Fabric is a Microsoft microservices \", \"\\nplatform for building applications. It\\u2019s an \\norchestrator of services and creates \\nclusters of mach\", \"ines. Service Fabric can \\ndeploy services as containers or as plain \\nprocesses. It can even mix serv\", \"ices in \\nprocesses with services in containers \\nwithin the same application and cluster.\\nService Fab\", \"ric clusters can be deployed in \\nAzure, on-premises or in any cloud. \\nHowever, deployment in Azure i\", \"s \\nsimplified with a managed approach.\\nService Fabric provides additional and \\noptional prescriptive\", \" Service Fabric \\nprogramming models like stateful services\\nand Reliable Actors.\\nService Fabric is ma\", \"ture in Windows (years \\nevolving in Windows), less mature in Linux.\\nBoth Linux and Windows container\", \"s are \\nsupported in Service Fabric since 2017.\\nAzure Service Fabric Mesh | Azure Service Fabric Mesh\", \" offers the same reliability, mission\\u0002critical performance and scale as Service Fabric, but also off\", \"ers a fully managed and serverless \\nplatform. You don\\u2019t need to manage a cluster, VMs, storage or ne\", \"tworking configuration. You just \\nfocus on your application\\u2019s development. Service Fabric Mesh suppo\", \"rts both Windows and Linux \\ncontainers, allowing you to develop with any programming language and fr\", \"amework of your choice.\\nAzure Container Apps | Azure Container Apps is a \\nmanaged serverless contain\", \"er service for building and deploying modern apps at scale. |\\nUsing container-based orchestrators in\", \" Azure\\nSeveral cloud vendors offer Docker containers support plus Docker clusters and orchestration \", \"support, \\nincluding Azure, Amazon EC2 Container Service, and Google Container Engine. Azure provides\", \" Docker 29 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azure\\n\", \"cluster and orchestrator support through Azure Kubernetes Service (AKS), Azure Service Fabric, and \\n\", \"Azure Service Fabric Mesh.\\nUsing Azure Kubernetes Service\\nA Kubernetes cluster pools several Docker \", \"hosts and exposes them as a single virtual Docker host, so \\nyou can deploy multiple containers into \", \"the cluster and scale-out with any number of container \\ninstances. The cluster will handle all the c\", \"omplex management plumbing, like scalability, health, and \\nso forth.\\nAKS provides a way to simplify \", \"the creation, configuration, and management of a cluster of virtual \\nmachines in Azure that are prec\", \"onfigured to run containerized applications. Using an optimized \\nconfiguration of popular open-sourc\", \"e scheduling and orchestration tools, AKS enables you to use \\nyour existing skills or draw on a larg\", \"e and growing body of community expertise to deploy and \\nmanage container-based applications on Micr\", \"osoft Azure.\\nAzure Kubernetes Service optimizes the configuration of popular Docker clustering open-\", \"source tools \\nand technologies specifically for Azure. You get an open solution that offers portabil\", \"ity for both your \\ncontainers and your application configuration. You select the size, the number of\", \" hosts, and the \\norchestrator tools, and AKS handles everything else.30 CHAPTER 4 | Designing and de\", \"veloping containerized apps using Docker and Microsoft Azure\\nFigure 4-7. Kubernetes cluster\\u2019s simpli\", \"fied structure and topology\\nFigure 4-7 shows the structure of a Kubernetes cluster where a master no\", \"de (VM) controls most of the \\ncoordination of the cluster, and you can deploy containers to the rest\", \" of the nodes that are managed \\nas a single pool from an application point of view. This allows you \", \"to scale to thousands or even tens \\nof thousands of containers.\\nDevelopment environment for Kubernet\", \"es\\nIn the development environment that Docker announced in July 2018, Kubernetes can also run in a \\n\", \"single development machine (Windows 10 or macOS) by just installing Docker Desktop. You can later \\nd\", \"eploy to the cloud (AKS) for further integration tests, as shown in figure 4-8.31 CHAPTER 4 | Design\", \"ing and developing containerized apps using Docker and Microsoft Azure\\nFigure 4-8. Running Kubernete\", \"s in dev machine and the cloud\\nGet started with Azure Kubernetes Service (AKS)\\nTo begin using AKS, y\", \"ou deploy an AKS cluster from the Azure portal or by using the CLI. For more \\ninformation on deployi\", \"ng a Kubernetes cluster to Azure, see Deploy an Azure Kubernetes Service \\n(AKS) cluster.\\nThere are n\", \"o fees for any of the software installed by default as part of AKS. All default options are \\nimpleme\", \"nted with open-source software. AKS is available for multiple virtual machines in Azure. \\nYou\\u2019re cha\", \"rged only for the compute instances you choose, as well as the other underlying \\ninfrastructure reso\", \"urces consumed, such as storage and networking. There are no incremental charges \\nfor AKS itself.\\nFo\", \"r further implementation information on deployment to Kubernetes based on kubectl and original \\n.yam\", \"l files, see Deploy to Azure Kubernetes Service (AKS).\\nDeploy with Helm charts into Kubernetes clust\", \"ers\\nWhen deploying an application to a Kubernetes cluster, you can use the original kubectl.exe CLI \", \"tool \\nusing deployment files based on the native format (.yaml files), as already mentioned in the p\", \"revious \\nsection. However, for more complex Kubernetes applications such as when deploying complex \\n\", \"microservice-based applications, it\\u2019s recommended to use Helm.\\nHelm Charts helps you define, version\", \", install, share, upgrade, or rollback even the most complex \\nKubernetes application. Helm is mainta\", \"ined by the Cloud Native Computing Foundation (CNCF) in \\ncollaboration with Microsoft, Google, Bitna\", \"mi, and the Helm contributor community.\\nFor further implementation information on Helm charts and Ku\", \"bernetes, see the section called Install \\neShopOnContainers using Helm.32 CHAPTER 4 | Designing and \", \"developing containerized apps using Docker and Microsoft Azure\\nAdditional resources\\n\\u2022 Getting starte\", \"d with Azure Kubernetes Service (AKS)\\nhttps://learn.microsoft.com/azure/aks/kubernetes-walkthrough-p\", \"ortal\\n\\u2022 Kubernetes. The official site.\\nhttps://kubernetes.io/\\nUsing Azure Service Fabric\\nAzure Servi\", \"ce Fabric arose from Microsoft\\u2019s transition from delivering \\u201cbox\\u201d products, which were \\ntypically mo\", \"nolithic in style, to delivering services. The experience of building and operating large \\nservices \", \"at scale, such as Azure SQL Database, Azure Cosmos DB, Azure Service Bus, or Cortana\\u2019s \\nBackend, sha\", \"ped Service Fabric. The platform evolved over time as more and more services adopted \\nit. Importantl\", \"y, Service Fabric had to run not only in Azure but also in standalone Windows Server \\ndeployments.\\nT\", \"he aim of Service Fabric is to solve the hard problems of building and running a service and utilizi\", \"ng \\ninfrastructure resources efficiently, so that teams can solve business problems using a microser\", \"vices \\napproach.\\nService Fabric provides two broad areas to help you build applications that use a m\", \"icroservices \\napproach:\\n\\u2022 A platform that provides system services to deploy, scale, upgrade, detect\", \", and restart failed \\nservices, discover service location, manage state, and monitor health. These s\", \"ystem services in \\neffect enable many of the characteristics of microservices described previously.\\n\", \"\\u2022 Programming APIs, or frameworks, to help you build applications as microservices: reliable \\nactors\", \" and reliable services. You can choose any code to build your microservice, but these \\nAPIs make the\", \" job more straightforward, and they integrate with the platform at a deeper \\nlevel. This way you can\", \" get health and diagnostics information, or you can take advantage of \\nreliable state management.\\nSe\", \"rvice Fabric is agnostic with respect to how you build your service, and you can use any technology.\", \" \\nHowever, it provides built-in programming APIs that make it easier to build microservices.\\nAs show\", \"n in Figure 4-10, you can create and run microservices in Service Fabric either as simple \\nprocesses\", \" or as Docker containers. It\\u2019s also possible to mix container-based microservices with \\nprocess-base\", \"d microservices within the same Service Fabric cluster.33 CHAPTER 4 | Designing and developing conta\", \"inerized apps using Docker and Microsoft Azure\\nFigure 4-10. Deploying microservices as processes or \", \"as containers in Azure Service Fabric\\nIn the first image, you see microservices as processes, where \", \"each node runs one process for each \\nmicroservice. In the second image, you see microservices as con\", \"tainers, where each node runs Docker \\nwith several containers, one container per microservice. Servi\", \"ce Fabric clusters based on Linux and \\nWindows hosts can run Docker Linux containers and Windows Con\", \"tainers, respectively.\\nFor up-to-date information about containers support in Azure Service Fabric, \", \"see Service Fabric and \\ncontainers.\\nService Fabric is a good example of a platform where you can def\", \"ine a different logical architecture \\n(business microservices or Bounded Contexts) than the physical\", \" implementation. For example, if you \\nimplement Stateful Reliable Services in Azure Service Fabric, \", \"which are introduced in the next section, \\n\\u201cStateless versus stateful microservices,\\u201d you have a bus\", \"iness microservice concept with multiple \\nphysical services.\\nAs shown in Figure 4-10, and thinking f\", \"rom a logical/business microservice perspective, when \\nimplementing a Service Fabric Stateful Reliab\", \"le Service, you usually will need to implement two tiers \\nof services. The first is the back-end sta\", \"teful reliable service, which handles multiple partitions (each \\npartition is a stateful service). T\", \"he second is the front-end service, or Gateway service, in charge of \\nrouting and data aggregation a\", \"cross multiple partitions or stateful service instances. That Gateway \\nservice also handles client-s\", \"ide communication with retry loops accessing the back-end service. It\\u2019s \\ncalled a Gateway service if\", \" you implement your custom service, or alternatively you can also use the \\nout-of-the-box Service Fa\", \"bric reverse proxy.34 CHAPTER 4 | Designing and developing containerized apps using Docker and Micro\", \"soft Azure\\nFigure 4-11. Business microservice with several stateful service instances and a custom g\", \"ateway front end\\nIn any case, when you use Service Fabric Stateful Reliable Services, you also have \", \"a logical or business \\nmicroservice (Bounded Context) that\\u2019s composed of multiple physical services.\", \" Each of them, the \\nGateway service, and Partition service could be implemented as ASP.NET Web API s\", \"ervices, as shown \\nin Figure 4-11. Service Fabric has prescription to support several stateful relia\", \"ble services in containers.\\nIn Service Fabric, you can group and deploy groups of services as a Serv\", \"ice Fabric Application, which is \\nthe unit of packaging and deployment for the orchestrator or clust\", \"er. Therefore, the Service Fabric \\nApplication could be mapped to this autonomous business and logic\", \"al microservice boundary or \\nBounded Context, as well, so you could deploy these services autonomous\", \"ly.\\nService Fabric and containers\\nWith regard to containers in Service Fabric, you can also deploy s\", \"ervices in container images within a \\nService Fabric cluster. As Figure 4-12 shows, most of the time\", \" there will only be one container per \\nservice.\\nFigure 4-12. Business microservice with several serv\", \"ices (containers) in Service Fabric35 CHAPTER 4 | Designing and developing containerized apps using \", \"Docker and Microsoft Azure\\nA Service Fabric application can run several containers accessing an exte\", \"rnal database and the whole \\nset would be the logical boundary of a Business Microservice. However, \", \"so-called \\u201csidecar\\u201d containers \\n(two containers that must be deployed together as part of a logical \", \"service) are also possible in \\nService Fabric. The important thing is that a business microservice i\", \"s the logical boundary around \\nseveral cohesive elements. In many cases, it might be a single servic\", \"e with a single data model, but in \\nsome other cases you might have several physical services as wel\", \"l.\\nNote that you can mix services in processes, and services in containers, in the same Service Fabr\", \"ic \\napplication, as shown in Figure 4-13.\\nFigure 4-13. Business microservice mapped to a Service Fab\", \"ric application with containers and stateful services\\nFor more information about container support i\", \"n Azure Service Fabric, see Service Fabric and \\ncontainers.\\nStateless versus stateful microservices\\n\", \"As mentioned earlier, each microservice (logical Bounded Context) must own its domain model (data \\na\", \"nd logic). In the case of stateless microservices, the databases will be external, employing relatio\", \"nal \\noptions like SQL Server, or NoSQL options like Azure Cosmos DB or MongoDB.\\nBut the services the\", \"mselves can also be stateful in Service Fabric, which means that the data resides \\nwithin the micros\", \"ervice. This data might exist not just on the same server, but within the microservice \\nprocess, in \", \"memory and persisted on hard drives and replicated to other nodes. Figure 4-14 shows the \\ndifferent \", \"approaches.36 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azu\", \"re\\nFigure 4-14. Stateless versus stateful microservices\\nIn stateless services, the state (persistenc\", \"e, database) is kept out of the microservice. In stateful \\nservices, state is kept inside the micros\", \"ervice. A stateless approach is perfectly valid and is easier to \\nimplement than stateful microservi\", \"ces, since the approach is similar to traditional and well-known \\npatterns. But stateless microservi\", \"ces impose latency between the process and data sources. They also \\ninvolve more moving pieces when \", \"you\\u2019re trying to improve performance with additional cache and \\nqueues. The result is that you can e\", \"nd up with complex architectures that have too many tiers.\\nIn contrast, stateful microservices can e\", \"xcel in advanced scenarios, because there\\u2019s no latency between \\nthe domain logic and data. Heavy dat\", \"a processing, gaming back ends, databases as a service, and \\nother low-latency scenarios all benefit\", \" from stateful services, which enable local state for faster access.\\nStateless and stateful services\", \" are complementary. For instance, as you can see in the right diagram in \\nFigure 4-14, a stateful se\", \"rvice can be split into multiple partitions. To access those partitions, you \\nmight need a stateless\", \" service acting as a gateway service that knows how to address each partition \\nbased on partition ke\", \"ys.\\nStateful services do have drawbacks. They impose a high complexity level to be scaled out. \\nFunc\", \"tionality that would usually be implemented by external database systems must be addressed for \\ntask\", \"s such as data replication across stateful microservices and data partitioning. However, this is one\", \" \\nof the areas where an orchestrator like Azure Service Fabric with its stateful reliable services c\", \"an help \\nthe most\\u2014by simplifying the development and lifecycle of stateful microservices using the R\", \"eliable \\nServices API and Reliable Actors.\\nOther microservice frameworks that allow stateful service\", \"s, support the Actor pattern, and improve \\nfault tolerance and latency between business logic and da\", \"ta are Microsoft Orleans, from Microsoft \\nResearch, and Akka.NET. Both frameworks are currently impr\", \"oving their support for Docker.\\nRemember that Docker containers are themselves stateless. If you wan\", \"t to implement a stateful \\nservice, you need one of the additional prescriptive and higher-level fra\", \"meworks noted earlier.\\nUsing Azure Service Fabric Mesh\\nAzure Service Fabric Mesh is a fully managed \", \"service that enables developers to build and deploy \\nmission critical applications without managing \", \"any infrastructure. Use Service Fabric Mesh to build \\nand run secure, distributed microservices appl\", \"ications that scale on demand.37 CHAPTER 4 | Designing and developing containerized apps using Docke\", \"r and Microsoft Azure\\nAs shown in figure 4-15, applications hosted on Service Fabric Mesh run and sc\", \"ale without you \\nworrying about the infrastructure powering it.\\nFigure 4-15. Deploying a microservic\", \"e/containers application to Service Fabric Mesh\\nUnder the covers, Service Fabric Mesh consists of cl\", \"usters of thousands of machines. All cluster \\noperations are hidden from the developer. You simply n\", \"eed to upload your containers and specify \\nresources you need, availability requirements, and resour\", \"ce limits. Service Fabric Mesh automatically \\nallocates the infrastructure requested by your applica\", \"tion deployment and also handles infrastructure \\nfailures, making sure your applications are highly \", \"available. You only need to care about the health \\nand responsiveness of your application, not the i\", \"nfrastructure.\\nFor further information, see the Service Fabric Mesh documentation.\\nChoosing orchestr\", \"ators in Azure\\nThe following table provides guidance on what orchestrator to use depending on worklo\", \"ads and OS \\nfocus.\\nFigure 4-16. Orchestrator selection in Azure guidance38 CHAPTER 4 | Designing and\", \" developing containerized apps using Docker and Microsoft Azure\\nDeploy to Azure Kubernetes Service (\", \"AKS)\\nYou can interact with AKS using your preferred client operating system (Windows, macOS, or Linu\", \"x) \\nwith Azure command-line interface (Azure CLI) installed. For more details, refer Azure CLI \\ndocu\", \"mentation and Installation guide for the available environments.\\nCreate the AKS environment in Azure\", \"\\nThere are several ways to create the AKS Environment. It can be done by using Azure CLI commands \\no\", \"r by using the Azure portal.\\nHere you can explore some examples using the Azure CLI to create the cl\", \"uster and the Azure portal to \\nreview the results. You also need to have Kubectl and Docker in your \", \"development machine.\\nCreate the AKS cluster\\nCreate the AKS cluster using this command (the resource \", \"group must exist):\\naz aks create --resource-group explore-docker-aks-rg --name explore-docker-aks --\", \"node\\u0002vm-size Standard_B2s --node-count 1 --generate-ssh-keys --location westeurope\\nNote\\nThe --node-v\", \"m-size and --node-count parameter values are good enough for a sample/dev \\napplication.\\nAfter the cr\", \"eation job finishes, you can see:\\n\\u2022 The AKS cluster created in the initial resource group\\n\\u2022 A new, r\", \"elated resource group, containing the resources related to the AKS cluster, as show in \\nthe followin\", \"g images.\\nThe initial resource group, with the AKS cluster:39 CHAPTER 4 | Designing and developing c\", \"ontainerized apps using Docker and Microsoft Azure\\nFigure 4-17. AKS Resource Group view from Azure.\\n\", \"The AKS cluster resource group:\\nFigure 4-18. AKS view from Azure.\\nImportant\\nIn general, you shouldn\\u2019\", \"t need to modify the resources in the AKS cluster resource group. For \\nexample, the resource group i\", \"s deleted when you delete the AKS cluster.\\nYou can also view the node created using Azure CLI and Ku\", \"bectl.\\nFirst, getting the credentials:\\naz aks get-credentials --resource-group explore-docker-aks-rg\", \" --name explore-docker\\u0002aks40 CHAPTER 4 | Designing and developing containerized apps using Docker an\", \"d Microsoft Azure\\nFigure 4-19. aks get-credentials command result.\\nAnd then, getting nodes from Kube\", \"ctl:\\nkubectl get nodes\\nFigure 4-20. kubectl get nodes command result.\\nDevelopment environment for Do\", \"cker apps\\nDevelopment tools choices: IDE or editor\\nNo matter if you prefer a full and powerful IDE o\", \"r a lightweight and agile editor, Microsoft has you \\ncovered when it comes to developing Docker appl\", \"ications.\\nVisual Studio Code and Docker CLI (cross-platform tools for Mac, Linux, and \\nWindows)\\nIf y\", \"ou prefer a lightweight, cross-platform editor supporting any development language, you can use \\nVis\", \"ual Studio Code and Docker CLI. These products provide a simple yet robust experience, which is \\ncri\", \"tical for streamlining the developer workflow. By installing \\u201cDocker for Mac\\u201d or \\u201cDocker for \\nWindow\", \"s\\u201d (development environment), Docker developers can use a single Docker CLI to build apps \\nfor both \", \"Windows or Linux (runtime environment). Plus, Visual Studio Code supports extensions for \\nDocker wit\", \"h IntelliSense for Dockerfiles and shortcut-tasks to run Docker commands from the editor.\\nNote\\nTo do\", \"wnload Visual Studio Code, go to https://code.visualstudio.com/download.\\nTo download Docker for Mac \", \"and Windows, go to https://www.docker.com/products/docker.\\nVisual Studio with Docker Tools (Windows \", \"development machine)\\nIt\\u2019s recommended that you use Visual Studio 2022 or later with the built-in Doc\", \"ker Tools enabled. \\nWith Visual Studio, you can develop, run, and validate your applications directl\", \"y in the chosen Docker \\nenvironment. Press F5 to debug your application (single container or multipl\", \"e containers) directly in a \\nDocker host, or press Ctrl+F5 to edit and refresh your app without havi\", \"ng to rebuild the container. It\\u2019s \\nthe simplest and most powerful choice for Windows developers to c\", \"reate Docker containers for Linux \\nor Windows.41 CHAPTER 4 | Designing and developing containerized \", \"apps using Docker and Microsoft Azure\\nVisual Studio for Mac (Mac development machine)\\nYou can use Vi\", \"sual Studio for Mac when developing Docker-based applications. Visual Studio for Mac \\noffers a riche\", \"r IDE when compared to Visual Studio Code for Mac.\\nLanguage and framework choices\\nYou can develop Do\", \"cker applications using Microsoft tools with most modern languages. The \\nfollowing is an initial lis\", \"t, but you\\u2019re not limited to it:\\n\\u2022 .NET and ASP.NET Core\\n\\u2022 Node.js\\n\\u2022 Go\\n\\u2022 Java\\n\\u2022 Ruby\\n\\u2022 Python\\nBasic\", \"ally, you can use any modern language supported by Docker in Linux or Windows.\\nInner-loop developmen\", \"t workflow for Docker apps\\nBefore triggering the outer-loop workflow spanning the entire DevOps cycl\", \"e, it all begins on each \\ndeveloper\\u2019s machine, coding the app itself, using their preferred language\", \"s or platforms, and testing it \\nlocally (Figure 4-21). But in every case, you\\u2019ll have an important p\", \"oint in common, no matter what \\nlanguage, framework, or platforms you choose. In this specific workf\", \"low, you\\u2019re always developing and \\ntesting Docker containers in no other environments, but locally.\\n\", \"Figure 4-21. Inner-loop development context\\nThe container or instance of a Docker image will contain\", \" these components:\\n\\u2022 An operating system selection (for example, a Linux distribution or Windows)\\n\\u2022 \", \"Files added by the developer (for example, app binaries)\\n\\u2022 Configuration (for example, environment s\", \"ettings and dependencies)\\n\\u2022 Instructions for what processes to run by Docker\\nYou can set up the inne\", \"r-loop development workflow that utilizes Docker as the process (described in \\nthe next section). Co\", \"nsider that the initial steps to set up the environment are not included, because \\nyou only need to \", \"do it once.42 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azu\", \"re\\nBuilding a single app within a Docker container using Visual Studio \\nCode and Docker CLI\\nApps are\", \" made up from your own services plus additional libraries (dependencies).\\nFigure 4-22 shows the basi\", \"c steps that you usually need to carry out when building a Docker app, \\nfollowed by detailed descrip\", \"tions of each step.\\nFigure 4-22. High-level workflow for the life cycle for Docker containerized app\", \"lications using Docker CLI\\nStep 1: Start coding in Visual Studio Code and create your initial app/se\", \"rvice \\nbaseline\\nThe way you develop your application is similar to the way you do it without Docker.\", \" The difference is \\nthat while developing, you\\u2019re deploying and testing your application or services\", \" running within Docker \\ncontainers placed in your local environment (like a Linux VM or Windows).\\nSe\", \"tting up your local environment\\nWith the latest versions of Docker Desktop for Mac and Windows, it\\u2019s\", \" easier than ever to develop \\nDocker applications, and the setup is straightforward.\\nTip\\nFor instruc\", \"tions on setting up Docker Desktop for Windows, go to https://docs.docker.com/docker\\u0002for-windows/.\\nF\", \"or instructions on setting up Docker Desktop for Mac, go to https://docs.docker.com/docker-for\\u0002mac/.\", \"\\nIn addition, you\\u2019ll need a code editor so that you can actually develop your application while usin\", \"g \\nDocker CLI.43 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft \", \"Azure\\nMicrosoft provides Visual Studio Code, which is a lightweight code editor that\\u2019s supported on \", \"\\nWindows, Linux, and macOS, and provides IntelliSense with support for many languages (JavaScript, \\n\", \".NET, Go, Java, Ruby, Python, and most modern languages), debugging, integration with Git and \\nexten\", \"sions support. This editor is a great fit for macOS and Linux developers. In Windows, you also \\ncan \", \"use Visual Studio.\\nTip\\nFor instructions on installing Visual Studio Code for Windows, Linux, or macO\", \"S, go to \\nhttps://code.visualstudio.com/docs/setup/setup-overview/.\\nFor instructions on setting up D\", \"ocker for Mac, go to https://docs.docker.com/docker-for-mac/.\\nYou can work with Docker CLI and write\", \" your code using any code editor, but using Visual Studio \\nCode with the Docker extension makes it e\", \"asy to author Dockerfile and docker-compose.yml files in \\nyour workspace. You can also run tasks and\", \" scripts from the Visual Studio Code IDE to execute Docker \\ncommands using the Docker CLI underneath\", \".\\nThe Docker extension for VS Code provides the following features:\\n\\u2022 Automatic Dockerfile and docke\", \"r-compose.yml file generation\\n\\u2022 Syntax highlighting and hover tips for docker-compose.yml and Docker\", \"file files\\n\\u2022 IntelliSense (completions) for Dockerfile and docker-compose.yml files\\n\\u2022 Linting (error\", \"s and warnings) for Dockerfile files\\n\\u2022 Command Palette (F1) integration for the most common Docker c\", \"ommands\\n\\u2022 Explorer integration for managing Images and Containers\\n\\u2022 Deploy images from DockerHub and\", \" Azure Container Registries to Azure App Service\\nTo install the Docker extension, press Ctrl+Shift+P\", \", type ext install, and then run the Install Extension \\ncommand to bring up the Marketplace extensio\", \"n list. Next, type docker to filter the results, and then \\nselect the Docker Support extension, as d\", \"epicted in Figure 4-23.\\nFigure 4-23. Installing the Docker Extension in Visual Studio Code44 CHAPTER\", \" 4 | Designing and developing containerized apps using Docker and Microsoft Azure\\nStep 2: Create a D\", \"ockerFile related to an existing image (plain OS or dev \\nenvironments like .NET, Node.js, and Ruby)\\n\", \"You\\u2019ll need a DockerFile per custom image to be built and per container to be deployed. If your app \", \"is \\nmade up of single custom service, you\\u2019ll need a single DockerFile. But if your app is composed o\", \"f \\nmultiple services (as in a microservices architecture), you\\u2019ll need one Dockerfile per service.\\nT\", \"he DockerFile is commonly placed in the root folder of your app or service and contains the required\", \" \\ncommands so that Docker knows how to set up and run that app or service. You can create your \\nDock\", \"erFile and add it to your project along with your code (node.js, .NET, etc.), or, if you\\u2019re new to t\", \"he \\nenvironment, take a look at the following Tip.\\nTip\\nYou can use the Docker extension to guide you\", \" when using the Dockerfile and docker-compose.yml \\nfiles related to your Docker containers. Eventual\", \"ly, you\\u2019ll probably write these kinds of files without \\nthis tool, but using the Docker extension is\", \" a good starting point that will accelerate your learning \\ncurve.\\nIn Figure 4-24, you can see the st\", \"eps to add the docker files to a project by using the Docker \\nExtension for VS Code:\\n1. Open the com\", \"mand palette, type \\u201cdocker\\u201d and select \\u201cAdd Docker Files to Workspace\\u201d.\\n2. Select Application Platfo\", \"rm (ASP.NET Core)\\n3. Select Operating System (Linux)\\n4. Include optional Docker Compose files\\n5. Ent\", \"er ports to publish (80, 443)\\n6. Select the project45 CHAPTER 4 | Designing and developing container\", \"ized apps using Docker and Microsoft Azure\\nFigure 4-24. Docker files added using the Add Docker file\", \"s to Workspace command\\nWhen you add a DockerFile, you specify what base Docker image you\\u2019ll be using\", \" (like using FROM \\nmcr.microsoft.com/dotnet/aspnet). You\\u2019ll usually build your custom image on top o\", \"f a base image \\nthat you get from any official repository at the Docker Hub registry (like an image \", \"for .NET or the one \\nfor Node.js).\\nTip\\nYou\\u2019ll have to repeat this procedure for every project in you\", \"r application. However, the extension will \\nask to overwrite the generated docker-compose file after\", \" the first time. You should reply to not \\noverwrite it, so the extension creates separate docker-com\", \"pose files, that you can then merge by \\nhand, prior to running docker-compose.\\nUse an existing offic\", \"ial Docker image\\nUsing an official repository of a language stack with a version number ensures that\", \" the same language \\nfeatures are available on all machines (including development, testing, and prod\", \"uction).\\nThe following is a sample DockerFile for a .NET container:46 CHAPTER 4 | Designing and deve\", \"loping containerized apps using Docker and Microsoft Azure\\nFROM mcr.microsoft.com/dotnet/aspnet:6.0 \", \"AS base\\nWORKDIR /app\\nEXPOSE 80\\nEXPOSE 443\\nFROM mcr.microsoft.com/dotnet/sdk:6.0 AS build\\nWORKDIR /sr\", \"c\\nCOPY [\\\"src/WebApi/WebApi.csproj\\\", \\\"src/WebApi/\\\"]\\nRUN dotnet restore \\\"src/WebApi/WebApi.csproj\\\"\\nCOP\", \"Y . .\\nWORKDIR \\\"/src/src/WebApi\\\"\\nRUN dotnet build \\\"WebApi.csproj\\\" -c Release -o /app/build\\nFROM build\", \" AS publish\\nRUN dotnet publish \\\"WebApi.csproj\\\" -c Release -o /app/publish\\nFROM base AS final\\nWORKDIR\", \" /app\\nCOPY --from=publish /app/publish .\\nENTRYPOINT [\\\"dotnet\\\", \\\"WebApi.dll\\\"]\\nIn this case, the image\", \" is based on version 6.0 of the official ASP.NET Core Docker image (multi-arch \\nfor Linux and Window\", \"s), as per the line FROM mcr.microsoft.com/dotnet/aspnet:6.0. (For more \\ninformation about this topi\", \"c, see the ASP.NET Core Docker Image page and the .NET Docker Image\\npage).\\nIn the DockerFile, you ca\", \"n also instruct Docker to listen to the TCP port that you\\u2019ll use at run time \\n(such as port 80 or 44\", \"3).\\nYou can specify additional configuration settings in the Dockerfile, depending on the language a\", \"nd \\nframework you\\u2019re using. For instance, the ENTRYPOINT line with [\\\"dotnet\\\", \\\"WebMvcApplication.dll\", \"\\\"] \\ntells Docker to run a .NET application. If you\\u2019re using the SDK and the .NET CLI (dotnet CLI) to\", \" build \\nand run the .NET application, this setting would be different. The key point here is that th\", \"e \\nENTRYPOINT line and other settings depend on the language and platform you choose for your \\nappli\", \"cation.\\nTip\\nFor more information about building Docker images for .NET applications, see \\nhttps://le\", \"arn.microsoft.com/dotnet/core/docker/build-container.\\nTo learn more about building your own images, \", \"go to \\nhttps://docs.docker.com/engine/tutorials/dockerimages/.\\nUse multi-arch image repositories\\nA s\", \"ingle image name in a repo can contain platform variants, such as a Linux image and a Windows \\nimage\", \". This feature allows vendors like Microsoft (base image creators) to create a single repo to \\ncover\", \" multiple platforms (that is, Linux and Windows). For example, the dotnet/aspnet repository \\navailab\", \"le in the Docker Hub registry provides support for Linux and Windows Nano Server by using \\nthe same \", \"image name.\\nPulling the dotnet/aspnet image from a Windows host pulls the Windows variant, whereas p\", \"ulling the \\nsame image name from a Linux host pulls the Linux variant.47 CHAPTER 4 | Designing and d\", \"eveloping containerized apps using Docker and Microsoft Azure\\nCreate your base image from scratch\\nYo\", \"u can create your own Docker base image from scratch as explained in this article from Docker. This \", \"\\nscenario is probably not the best for you if you\\u2019re just starting with Docker, but if you want to s\", \"et the \\nspecific bits of your own base image, you can do it.\\nStep 3: Create your custom Docker image\", \"s embedding your service in it\\nFor each custom service that comprises your app, you\\u2019ll need to creat\", \"e a related image. If your app is \\nmade up of a single service or web app, you\\u2019ll need just a single\", \" image.\\nNote\\nWhen taking into account the \\u201couter-loop DevOps workflow\\u201d, the images will be created b\", \"y an \\nautomated build process whenever you push your source code to a Git repository (Continuous \\nIn\", \"tegration), so the images will be created in that global environment from your source code.\\nBut befo\", \"re you consider going to that outer-loop route, you need to ensure that the Docker \\napplication is a\", \"ctually working properly so that they don\\u2019t push code that might not work properly to \\nthe source co\", \"ntrol system (Git, etc.).\\nTherefore, each developer first needs to do the entire inner-loop process \", \"to test locally and continue \\ndeveloping until they want to push a complete feature or change to the\", \" source control system.\\nTo create an image in your local environment and using the DockerFile, you c\", \"an use the docker build \\ncommand, as shown in Figure 4-25, because it already tags the image for you\", \" and builds the images \\nfor all services in the application with a simple command.\\nFigure 4-25. Runn\", \"ing docker build\\nOptionally, instead of directly running docker build from the project folder, you f\", \"irst can generate a \\ndeployable folder with the .NET libraries needed by using the run dotnet publis\", \"h command, and then \\nrun docker build.\\nThis example creates a Docker image with the name webapi:late\", \"st (:latest is a tag, like a specific \\nversion). You can take this step for each custom image you ne\", \"ed to create for your composed Docker 48 CHAPTER 4 | Designing and developing containerized apps usi\", \"ng Docker and Microsoft Azure\\napplication with several containers. However, we\\u2019ll see in the next se\", \"ction that it\\u2019s easier to do this \\nusing docker-compose.\\nYou can find the existing images in your lo\", \"cal repository (your development machine) by using the \\ndocker images command, as illustrated in Fig\", \"ure 4-26.\\nFigure 4-26. Viewing existing images using docker images\\nStep 4: Define your services in d\", \"ocker-compose.yml when building a composed \\nDocker app with multiple services\\nWith the docker-compos\", \"e.yml file, you can define a set of related services to be deployed as a \\ncomposed application with \", \"the deployment commands explained in the next step section.\\nCreate that file in your main or root so\", \"lution folder; it should have content similar to that shown in this \\ndocker-compose.yml file:\\nversio\", \"n: \\\"3.4\\\"\\nservices:\\n webapi:\\n image: webapi\\n build:\\n context: .\\n dockerfile: src/WebApi/Dockerfile\\n p\", \"orts:\\n - 51080:80\\n depends_on:\\n - redis\\n environment:\\n - ASPNETCORE_ENVIRONMENT=Development\\n - ASPNE\", \"TCORE_URLS=http://+:80\\n webapp:\\n image: webapp\\n build:\\n context: .\\n dockerfile: src/WebApp/Dockerfil\", \"e\\n ports:\\n - 50080:80\\n environment:\\n - ASPNETCORE_ENVIRONMENT=Development\\n - ASPNETCORE_URLS=http://\", \"+:80\\n - WebApiBaseAddress=http://webapi\\n redis:\\n image: redis\\nIn this particular case, this file def\", \"ines three services: the web API service (your custom service), a web \\napplication, and the Redis se\", \"rvice (a popular cache service). Each service will be deployed as a \\ncontainer, so you need to use a\", \" concrete Docker image for each. For this particular application:49 CHAPTER 4 | Designing and develo\", \"ping containerized apps using Docker and Microsoft Azure\\n\\u2022 The web API service is built from the Doc\", \"kerFile in the src/WebApi/Dockerfile directory.\\n\\u2022 The host port 51080 is forwarded to the exposed po\", \"rt 80 on the webapi container.\\n\\u2022 The web API service depends on the Redis service\\n\\u2022 The web applicat\", \"ion accesses the web API service using the internal address: http://webapi.\\n\\u2022 The Redis service uses\", \" the latest public redis image pulled from the Docker Hub registry. \\nRedis is a popular cache system\", \" for server-side applications.\\nStep 5: Build and run your Docker app\\nIf your app has only a single c\", \"ontainer, you just need to run it by deploying it to your Docker Host \\n(VM or physical server). Howe\", \"ver, if your app is made up of multiple services, you need to compose it, \\ntoo. Let\\u2019s see the differ\", \"ent options.\\nOption A: Run a single container or service\\nYou can run the Docker image by using the d\", \"ocker run command, as shown here:\\ndocker run -t -d -p 50080:80 webapp:latest\\nFor this particular dep\", \"loyment, we\\u2019ll be redirecting requests sent to port 50080 on the host to the \\ninternal port 80.\\nOpti\", \"on B: Compose and run a multiple-container application\\nIn most enterprise scenarios, a Docker applic\", \"ation will be composed of multiple services. For these \\ncases, you can run the docker-compose up com\", \"mand (Figure 4-27), which will use the docker\\u0002compose.yml file that you created previously. Running \", \"this command builds all custom images and \\ndeploys the composed application with all of its related \", \"containers.50 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azu\", \"re\\nFigure 4-27. Results of running the \\u201cdocker-compose up\\u201d command\\nAfter you run docker-compose up, \", \"you deploy your application and its related container(s) into your \\nDocker Host, as illustrated in F\", \"igure 4-28, in the VM representation.\\nFigure 4-28. VM with Docker containers deployed\\nStep 6: Test y\", \"our Docker application (locally, in your local CD VM)\\nThis step will vary depending on what your app\", \" is doing.\\nIn a simple .NET Web API \\u201cHello World\\u201d deployed as a single container or service, you\\u2019d j\", \"ust need to \\naccess the service by providing the TCP port specified in the DockerFile.\\nOn the Docker\", \" host, open a browser and navigate to that site; you should see your app/service \\nrunning, as demons\", \"trated in Figure 4-29.51 CHAPTER 4 | Designing and developing containerized apps using Docker and Mi\", \"crosoft Azure\\nFigure 4-29. Testing your Docker application locally by using the browser\\nNote that it\", \"\\u2019s using port 50080, but internally it\\u2019s being redirected to port 80, because that\\u2019s how it \\nwas dep\", \"loyed with docker compose, as explained earlier.\\nYou can test this by using the browser using CURL f\", \"rom the terminal, as depicted in Figure 4-30.\\nFigure 4-30. Testing a Docker application locally by u\", \"sing CURL\\nDebugging a container running on Docker\\nVisual Studio Code supports debugging Docker if yo\", \"u\\u2019re using Node.js and other platforms like .NET \\ncontainers.52 CHAPTER 4 | Designing and developing\", \" containerized apps using Docker and Microsoft Azure\\nYou also can debug .NET or .NET Framework conta\", \"iners in Docker when using Visual Studio for \\nWindows or Mac, as described in the next section.\\nTip\\n\", \"To learn more about debugging Node.js Docker containers, see \\nhttps://learn.microsoft.com/archive/bl\", \"ogs/user_ed/visual-studio-code-new-features-13-big\\u0002debugging-updates-rich-object-hover-conditional-b\", \"reakpoints-node-js-mono-more.\\nUse Docker Tools in Visual Studio on Windows\\nThe developer workflow wh\", \"en using the Docker Tools included in Visual Studio 2022 version 17.0 and \\nlater, is similar to usin\", \"g Visual Studio Code and Docker CLI (in fact, it\\u2019s based on the same Docker CLI), \\nbut it\\u2019s easier t\", \"o get started, simplifies the process, and provides greater productivity for the build, \\nrun, and co\", \"mpose tasks. It can also run and debug your containers via the usual F5 and Ctrl+F5keys \\nfrom Visual\", \" Studio. You can even debug a whole solution if its containers are defined in the same \\ndocker-compo\", \"se.yml file at the solution level.\\nConfigure your local environment\\nWith the latest versions of Dock\", \"er for Windows, it\\u2019s easier than ever to develop Docker applications \\nbecause the setup is straightf\", \"orward, as explained in the following references.\\nTip\\nTo learn more about installing Docker for Wind\", \"ows, go to (https://docs.docker.com/docker-for\\u0002windows/).\\nDocker support in Visual Studio\\nThere are \", \"two levels of Docker support you can add to a project. In ASP.NET Core projects, you can \\njust add a\", \" Dockerfile file to the project by enabling Docker support. The next level is container \\norchestrati\", \"on support, which adds a Dockerfile to the project (if it doesn\\u2019t already exist) and a docker\\u0002compos\", \"e.yml file at the solution level. Container orchestration support, via Docker Compose, is \\navailable\", \" in Visual Studio 2022 versions 17.0. Container orchestration support is an opt-in feature in \\nVisua\", \"l Studio 2022 versions 17.0 or later. Visual Studio 2022 also supports Kubernetes/Helm\\ndeployment.\\nT\", \"he Add > Docker Support and Add > Container Orchestrator Support commands are located on \\nthe right-\", \"click menu (or context menu) of the project node for an ASP.NET Core project in Solution \\nExplorer, \", \"as shown in Figure 4-31:53 CHAPTER 4 | Designing and developing containerized apps using Docker and \", \"Microsoft Azure\\nFigure 4-31. Adding Docker support to a Visual Studio project\\nAdd Docker support\\nBes\", \"ides the option to add Docker support to an existing application, as shown in the previous section, \", \"\\nyou can also enable Docker support during project creation by selecting Enable Docker Support in \\nt\", \"he New ASP.NET Core Web Application dialog box that opens after you click OK in the New \\nProject dia\", \"log box, as shown in Figure 4-32.54 CHAPTER 4 | Designing and developing containerized apps using Do\", \"cker and Microsoft Azure\\nFigure 4-32. Enable Docker support during project creation in Visual Studio\", \"\\nWhen you add or enable Docker support, Visual Studio adds a Dockerfile file to the project, that \\ni\", \"ncludes references to all required project from the solution.\\nAdd container orchestration support\\nWh\", \"en you want to compose a multi-container solution, add container orchestration support to your \\nproj\", \"ects. This lets you run and debug a group of containers (a whole solution) at the same time if \\nthey\", \"\\u2019re defined in the same docker-compose.yml file.\\nTo add container orchestration support, right-click\", \" on the project node in Solution Explorer, and \\nchoose Add > Container Orchestration Support. Then c\", \"hoose Docker Compose to manage the \\ncontainers.\\nAfter you add container orchestration support to you\", \"r project, you see a Dockerfile added to the \\nproject and a docker-compose folder added to the solut\", \"ion in Solution Explorer, as shown in Figure \\n4-33:55 CHAPTER 4 | Designing and developing container\", \"ized apps using Docker and Microsoft Azure\\nFigure 4-33. Docker files in Solution Explorer in Visual \", \"Studio\\nIf docker-compose.yml already exists, Visual Studio just adds the required lines of configura\", \"tion code \\nto it.\\nConfigure Docker tools\\nFrom the main menu, choose Tools > Options, and expand Cont\", \"ainer Tools > Settings. The \\ncontainer tools settings appear.56 CHAPTER 4 | Designing and developing\", \" containerized apps using Docker and Microsoft Azure\\nFigure 4-34. Docker Tools Options\\nFor more deta\", \"iled configurations refer to Container Tools settings\\nTip\\nFor further details on the services implem\", \"entation and use of Visual Studio Tools for Docker, read the \\nfollowing articles:\\nUse the Containers\", \" tool window to view container details such as the filesystem, logs, environment, \\nports, and more: \", \"https://learn.microsoft.com/visualstudio/containers/view-and-diagnose-containers\\nDebug apps in a loc\", \"al Docker container: https://learn.microsoft.com/visualstudio/containers/edit-and\\u0002refresh\\nDeploy an \", \"ASP.NET container to a container registry using Visual Studio: \\nhttps://learn.microsoft.com/visualst\", \"udio/containers/hosting-web-apps-in-docker\\nUsing Windows PowerShell commands in a \\nDockerFile to set\", \" up Windows Containers (Docker \\nstandard based)\\nWith Windows Containers, you can convert your existi\", \"ng Windows applications to Docker images and \\ndeploy them with the same tools as the rest of the Doc\", \"ker ecosystem.57 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft \", \"Azure\\nTo use Windows Containers, you just need to write Windows PowerShell commands in the DockerFil\", \"e, \\nas demonstrated in the following example:\\nFROM mcr.microsoft.com/windows/servercore:ltsc2019\\nLAB\", \"EL Description=\\\"IIS\\\" Vendor=\\\"Microsoft\\\" Version=\\\"10\\\"\\nRUN powershell Get-WindowsFeature web-server\\nRU\", \"N powershell Install-windowsfeature web-server\\nRUN powershell add-windowsfeature web-asp-net45\\nCMD [\", \" \\\"ping\\\", \\\"localhost\\\", \\\"-t\\\" ]\\nIn this case, we\\u2019re using Windows PowerShell to install a Windows Serve\", \"r Core base image as well \\nas IIS.\\nIn a similar way, you also could use Windows PowerShell commands \", \"to set up additional components \\nlike the traditional ASP.NET 4.x and .NET Framework 4.6 or any othe\", \"r Windows software, as shown \\nhere:\\nRUN powershell add-windowsfeature web-asp-net45\\nBuild ASP.NET Co\", \"re applications deployed as Linux \\ncontainers into an AKS/Kubernetes orchestrator\\nAzure Kubernetes S\", \"ervices (AKS) is Azure\\u2019s managed Kubernetes orchestrations services that simplify \\ncontainer deploym\", \"ent and management.\\nThe main features of AKS are:\\n\\u2022 An Azure-hosted control plane.\\n\\u2022 Automated upgra\", \"des.\\n\\u2022 Self-healing.\\n\\u2022 User-configurable scaling.\\n\\u2022 Simpler user experience for both developers and \", \"cluster operators.\\nThe following examples explore the creation of an ASP.NET Core 6.0 application th\", \"at runs on Linux \\nand deploys to an AKS Cluster in Azure. Development is done using Visual Studio 20\", \"22 version 17.0.\\nCreating the ASP.NET Core Project using Visual Studio 2022\\nASP.NET Core is a genera\", \"l-purpose development platform maintained by Microsoft and the .NET \\ncommunity on GitHub. It\\u2019s cross\", \"-platform, supporting Windows, macOS and Linux, and can be used in \\ndevice, cloud, and embedded/IoT \", \"scenarios.\\nThis example uses a couple of simple projects based on Visual Studio templates, so you do\", \"n\\u2019t need \\nmuch additional knowledge to create the sample. You only have to create the project using \", \"a \\nstandard template that includes all the elements to run a small project with a REST API and a Web\", \" \\nApp with Razor pages, using ASP.NET Core 6.0 technology.\\nFor reference, you can download the sampl\", \"e from .NET Application Architecture\\u2019s repo explore\\u0002docker.58 CHAPTER 4 | Designing and developing c\", \"ontainerized apps using Docker and Microsoft Azure\\nFigure 4-35. Creating an ASP.NET Core Web Applica\", \"tion in Visual Studio 2022.\\nTo create the sample project in Visual Studio, select File > New > Proje\", \"ct, select the Web project \\ntype and then the ASP.NET Core Web Api template. You can also search for\", \" the template if you need \\nit.\\nThen enter the application name and location as shown in the next ima\", \"ge.59 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Azure\\nFigur\", \"e 4-36. Enter the project name and location in Visual Studio 2022.\\nVerify that you\\u2019ve selected ASP.N\", \"ET Core 6.0 as the framework. .NET 6 is included in the latest release \\nof Visual Studio 2022 and is\", \" automatically installed and configured for you when you install Visual \\nStudio.60 CHAPTER 4 | Desig\", \"ning and developing containerized apps using Docker and Microsoft Azure\\nFigure 4-37. Selecting ASP.N\", \"ET CORE 6.0 and Web API project type\\nNotice Docker support is not enabled now. You\\u2019ll do that in the\", \" next step after the project creation. \\nYou\\u2019ll also notice that by default controller option is chec\", \"ked. You can uncheck that if you want to \\nCreate a minimal web API with ASP.NET Core.\\nTo show you ca\", \"n \\u201cDockerize\\u201d your project at any time, you\\u2019ll add Docker support now. So right-click \\non the projec\", \"t node in Solution Explorer and select Add > Docker support on the context menu.61 CHAPTER 4 | Desig\", \"ning and developing containerized apps using Docker and Microsoft Azure\\nFigure 4-38. Adding Docker s\", \"upport to an existing project\\nTo complete adding Docker support, you can choose Windows or Linux. In\", \" this case, select Linux.\\nFigure 4-39. Selecting Linux containers.62 CHAPTER 4 | Designing and devel\", \"oping containerized apps using Docker and Microsoft Azure\\nWith these simple steps, you have your ASP\", \".NET Core 6.0 application running on a Linux container.\\nIn a similar way, you can also add a very si\", \"mple WebApp project (Figure 4-40) to consume the web \\nAPI endpoint, although the details can be seen\", \" in the code repo.\\nAfter that, you add orchestrator support for your WebApi project as shown next, i\", \"n image 4-40.\\nFigure 4-40. Adding orchestrator support to WebApi project.\\nWhen you choose the Docker\", \" Compose option, which is fine for local development, Visual Studio \\nadds the docker-compose project\", \", with the docker-compose files as shown in image 4-41.63 CHAPTER 4 | Designing and developing conta\", \"inerized apps using Docker and Microsoft Azure\\nFigure 4-41. Adding orchestrator support to WebApi pr\", \"oject.\\nThe initial files added are similar to these ones:\\ndocker-compose.yml\\nversion: \\\"3.4\\\"\\nservices\", \":\\n webapi:\\n image: ${DOCKER_REGISTRY-}webapi\\n build:\\n context: .\\n dockerfile: WebApi/Dockerfile\\n web\", \"app:\\n image: ${DOCKER_REGISTRY-}webapp\\n build:\\n context: .\\n dockerfile: WebApp/Dockerfile\\ndocker-com\", \"pose.override.yml\\nversion: \\\"3.4\\\"\\nservices:\\n webapi:\\n environment:\\n - ASPNETCORE_ENVIRONMENT=Developm\", \"ent\\n - ASPNETCORE_URLS=https://+:443;http://+:80\\n ports:\\n - \\\"80\\\"\\n - \\\"443\\\"\\n volumes:\\n - ${APPDATA}/Mi\", \"crosoft/UserSecrets:/root/.microsoft/usersecrets:ro\\n - ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:\", \"ro\\n webapp:\\n environment:\\n - ASPNETCORE_ENVIRONMENT=Development\\n - ASPNETCORE_URLS=https://+:443;htt\", \"p://+:80\\n ports:\\n - \\\"80\\\"\\n - \\\"443\\\"64 CHAPTER 4 | Designing and developing containerized apps using Do\", \"cker and Microsoft Azure\\n volumes:\\n - ${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:\", \"ro\\n - ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro\\nTo run your app with Docker Compose, you just \", \"have to make a few tweaks to docker\\u0002compose.override.yml.\\nservices:\\n webapi:\\n #...\\n ports:\\n - \\\"51080\", \":80\\\"\\n - \\\"51443:443\\\"\\n #...\\n webapp:\\n environment:\\n #...\\n - WebApiBaseAddress=http://webapi\\n ports:\\n -\", \" \\\"50080:80\\\"\\n - \\\"50443:443\\\"\\n #...\\nNow you can run your application with the F5 key, or by using the P\", \"lay button, or the Ctrl+F5 key, \\nselecting the docker-compose project, as shown in image 4-42.\\nFigur\", \"e 4-42. Adding orchestrator support to WebApi project.\\nWhen running the docker-compose application a\", \"s explained, you get:\\n1. The images built and containers created as per the docker-compose file.\\n2. \", \"The browser open in the address configured in the \\u201cProperties\\u201d dialog for the docker\\u0002compose project\", \".\\n3. The Container window open (in Visual Studio 2022 version 17.0 and later).\\n4. Debugger support f\", \"or all projects in the solution, as shown in the following images.\\nBrowser opened:65 CHAPTER 4 | Des\", \"igning and developing containerized apps using Docker and Microsoft Azure\\nFigure 4-43. Browser windo\", \"w with an application running on multiple containers.\\nContainers window:\\nFigure 4-44. Visual Studio \", \"\\u201cContainers\\u201d window\\nThe Containers window lets you view running containers, browse available images,\", \" view environment \\nvariables, logs, and port mappings, inspect the filesystem, attach a debugger, or\", \" open a terminal \\nwindow inside the container environment.\\nAs you can see, the integration between V\", \"isual Studio 2022 and Docker is completely oriented to the \\ndeveloper\\u2019s productivity.\\nOf course, you\", \" can also list the images using the docker images command. You should see the webapi \\nand webapp ima\", \"ges with the dev tags created by the automatic deployment of our project with Visual \\nStudio 2022.\\nd\", \"ocker images66 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft Az\", \"ure\\nFigure 4-45. View of Docker images\\nRegister the Solution in an Azure Container Registry (ACR)\\nYo\", \"u can upload the images to the Azure Container Registry (ACR), but you could also use Docker Hub \\nor\", \" any other registry, so the images can be deployed to the AKS cluster from that registry.\\nCreate an \", \"ACR instance\\nRun the following command from the az cli:\\naz acr create --name exploredocker --resourc\", \"e-group explore-docker-aks-rg --sku basic \\n--admin-enabled\\nNote\\nThe container registry name (for exa\", \"mple, exploredocker) must be unique within Azure and contain 5-\\n50 alphanumeric characters. For more\", \" details, see Create a container registry.\\nCreate the image in Release mode\\nYou\\u2019ll now create the im\", \"age in Release mode (ready for production) by changing to Release, as \\nshown in Figure 4-46, and run\", \"ning the application as you did before.\\nFigure 4-46. Selecting Release Mode\\nIf you execute the docke\", \"r images command, you\\u2019ll see both images created, one for debug (dev) and \\nthe other for release (la\", \"test) mode.\\nCreate a new Tag for the Image\\nEach container image needs to be tagged with the loginSer\", \"ver name of the registry. This tag is used \\nfor routing when pushing container images to an image re\", \"gistry.\\nYou can view the loginServer name from the Azure portal, taking the information from the Azu\", \"re \\nContainer Registry67 CHAPTER 4 | Designing and developing containerized apps using Docker and Mi\", \"crosoft Azure\\nFigure 4-47. View of the name of the Registry\\nOr by running the following command:\\naz \", \"acr list --resource-group <resource-group-name> --query \\n\\\"[].{acrLoginServer:loginServer}\\\" --output \", \"table\\nFigure 4-48. Get the name of the registry using az cli\\nIn both cases, you\\u2019ll obtain the name. \", \"In our example, exploredocker.azurecr.io.\\nNow you can tag the image, taking the latest image (the Re\", \"lease image), with the command:\\ndocker tag <image-name>:latest <login-server-name>/<image-name>:v1\\nA\", \"fter running the docker tag command, list the images with the docker images command, and you \\nshould\", \" see the image with the new tag.\\nFigure 4-49. View of tagged images\\nPush the image into the Azure AC\", \"R\\nLog in to the Azure Container Registry\\naz acr login --name exploredocker\\nPush the image into the A\", \"zure ACR, using the following command:\\ndocker push <login-server-name>/<image-name>:v168 CHAPTER 4 |\", \" Designing and developing containerized apps using Docker and Microsoft Azure\\nThis command takes a w\", \"hile uploading the images but gives you feedback in the process. In the \\nfollowing image, you can se\", \"e the output from one image completed and another in progress.\\nFigure 4-50. Console output from the \", \"push command.\\nTo deploy your multi-container app into your AKS cluster you need some manifest .yaml \", \"files that \\nhave, most of the properties taken from the docker-compose.yml and docker-compose.overri\", \"de.yml \\nfiles.\\ndeploy-webapi.yml\\napiVersion: apps/v1\\nkind: Deployment\\nmetadata:\\n name: webapi\\n label\", \"s:\\n app: weather-forecast\\nspec:\\n replicas: 1\\n selector:\\n matchLabels:\\n service: webapi\\n template:\\n m\", \"etadata:\\n labels:\\n app: weather-forecast\\n service: webapi\\n spec:\\n containers:\\n - name: webapi\\n image\", \": exploredocker.azurecr.io/webapi:v1\\n imagePullPolicy: IfNotPresent\\n ports:\\n - containerPort: 80\\n pr\", \"otocol: TCP\\n env:\\n - name: ASPNETCORE_URLS\\n value: http://+:8069 CHAPTER 4 | Designing and developin\", \"g containerized apps using Docker and Microsoft Azure\\n---\\napiVersion: v1\\nkind: Service\\nmetadata:\\n na\", \"me: webapi\\n labels:\\n app: weather-forecast\\n service: webapi\\nspec:\\n ports:\\n - port: 80\\n targetPort: 8\", \"0\\n protocol: TCP\\n selector:\\n service: webapi\\ndeploy-webapp.yml\\napiVersion: apps/v1\\nkind: Deployment\\n\", \"metadata:\\n name: webapp\\n labels:\\n app: weather-forecast\\nspec:\\n replicas: 1\\n selector:\\n matchLabels:\\n\", \" service: webapp\\n template:\\n metadata:\\n labels:\\n app: weather-forecast\\n service: webapp\\n spec:\\n cont\", \"ainers:\\n - name: webapp\\n image: exploredocker.azurecr.io/webapp:v1\\n imagePullPolicy: IfNotPresent\\n p\", \"orts:\\n - containerPort: 80\\n protocol: TCP\\n env:\\n - name: ASPNETCORE_URLS\\n value: http://+:80\\n - name\", \": WebApiBaseAddress\\n value: http://webapi\\n---\\napiVersion: v1\\nkind: Service\\nmetadata:\\n name: webapp\\n \", \"labels:\\n app: weather-forecast\\n service: webapp\\nspec:\\n type: LoadBalancer\\n ports:\\n - port: 80\\n targe\", \"tPort: 80\\n protocol: TCP\\n selector:\\n service: webapp70 CHAPTER 4 | Designing and developing containe\", \"rized apps using Docker and Microsoft Azure\\nNote\\nThe previous .yml files only enable the HTTP ports,\", \" using the ASPNETCORE_URLS parameter, to avoid \\nissues with the missing certificate in the sample ap\", \"p.\\nTip\\nYou can see how to create the AKS Cluster for this sample in section Deploy to Azure Kubernet\", \"es \\nService (AKS) on this guide.\\nNow you\\u2019re almost ready to deploy using kubectl, but first you must\", \" get the credentials from the AKS \\nCluster with this command:\\naz aks get-credentials --resource-grou\", \"p explore-docker-aks-rg --name explore-docker-aks\\nFigure 4-51. Getting credentials from AKS into the\", \" kubectl environment.\\nYou also have to allow the AKS cluster to pull images from the ACR, using this\", \" command:\\naz aks update --name explore-docker-aks --resource-group explore-docker-aks-rg --attach-ac\", \"r \\nexploredocker\\nThe previous command might take a couple of minutes to complete. Then, use the kube\", \"ctl apply \\ncommand to launch the deployments, and then kubectl get all to list the cluster objects.\\n\", \"kubectl apply -f deploy-webapi.yml\\nkubectl apply -f deploy-webapp.yml\\nkubectl get all71 CHAPTER 4 | \", \"Designing and developing containerized apps using Docker and Microsoft Azure\\nFigure 4-52. Deployment\", \" to Kubernetes\\nYou\\u2019ll have to wait a while until the load balancer gets the external IP, checking wi\", \"th kubectl get \\nservices, and then the application should be available at that address, as shown in \", \"the next image:72 CHAPTER 4 | Designing and developing containerized apps using Docker and Microsoft\", \" Azure\\nFigure 4-53. Deployment to Kubernetes\\nWhen the deployment completes, you can access the Kuber\", \"netes Web UI with a local proxy, using an \\nssh tunnel.\\nFirst you must create a ClusterRoleBinding wi\", \"th the following command:\\nkubectl create clusterrolebinding kubernetes-dashboard --clusterrole=clust\", \"er-admin --\\nserviceaccount=kube-system:kubernetes-dashboard\\nAnd then this command to start the proxy\", \":\\naz aks browse --resource-group exploredocker-aks-rg --name explore-docker-aks\\nA browser window sho\", \"uld open at http://127.0.0.1:8001 with a view similar to this one:73 CHAPTER 4 | Designing and devel\", \"oping containerized apps using Docker and Microsoft Azure\\nFigure 4-54. View Kubernetes cluster infor\", \"mation\\nNow you have your ASP.NET Core application, running in Linux containers, and deployed to an A\", \"KS \\ncluster on Azure.\\nNote\\nFor more information on deployment with Kubernetes see: \\nhttps://kubernet\", \"es.io/docs/reference/kubectl/cheatsheet/74 CHAPTER 5 | Docker application DevOps workflow with Micro\", \"soft tools\\nCHAPTER 5\\nDocker application \\nDevOps workflow with \\nMicrosoft tools\\nMicrosoft Visual Stud\", \"io, Azure DevOps Services and/or GitHub, Team Foundation Server, and Azure \\nMonitor provide a compre\", \"hensive ecosystem for development and IT operations that give your team the \\ntools to manage project\", \"s and rapidly build, test, and deploy containerized applications.\\nTeams can choose which tools and p\", \"latforms they want to use for end to end DevOps. With Visual \\nStudio and Azure DevOps Services in th\", \"e cloud, along with Team Foundation Server on-premises, \\ndevelopment teams can productively build, t\", \"est, and release containerized applications that target \\neither Windows or Linux. Alternatively, tea\", \"ms can also use Visual Studio Code and GitHub. Teams can \\neven use combinations: for example, storin\", \"g source code in GitHub and using Azure Boards for work \\nitem tracking and Azure Pipelines for CI/CD\", \".\\nMicrosoft tools can automate the pipeline for specific implementations of containerized \\napplicati\", \"ons\\u2014Docker, .NET, or any combination with other platforms\\u2014from global builds and \\nContinuous Integra\", \"tion (CI) and tests with Azure DevOps Services, Team Foundation Server or GitHub, \\nto Continuous Dep\", \"loyment (CD) to Docker environments (Development, Staging, Production), and to \\ntransmit analytics i\", \"nformation about the services to the development team through Azure Monitor. \\nEvery code commit can \", \"initiate a build (CI) and automatically deploy the services to specific \\ncontainerized environments \", \"(CD).\\nDevelopers and testers can easily and quickly provision production-like development and test \\n\", \"environments based on Docker by using templates in Microsoft Azure.\\nThe complexity of containerized \", \"application development increases steadily depending on the \\nbusiness complexity and scalability nee\", \"ds. A good example of this complexity are applications based \\non microservices architectures. To suc\", \"ceed in such an environment, your project must automate the \\nentire life cycle\\u2014not only the build an\", \"d deployment, but it also must manage versions along with \\nthe collection of telemetry. Azure DevOps\", \" Services, GitHub and Azure offer the following capabilities:\\n\\u2022 Azure DevOps Services/Team Foundatio\", \"n Server source code management (based on Git or \\nTeam Foundation Version Control), Agile planning (\", \"Agile, Scrum, and CMMI are supported), \\nCI, release management, and other tools for Agile teams.75 C\", \"HAPTER 5 | Docker application DevOps workflow with Microsoft tools\\n\\u2022 Azure DevOps Services and Team \", \"Foundation Server include a powerful and growing \\necosystem of first and third-party extensions with\", \" which you easily can construct a CI, build, \\ntest, delivery, and release management pipeline for mi\", \"croservices.\\n\\u2022 GitHub or GitHub Enterprise Server offer similar capabilities, with source control ba\", \"sed on Git, \\nProjects and Issues for project tracking, GitHub Actions for automating workflows inclu\", \"ding \\nCI/CD, and GitHub Advanced Security for dependency, secret and vulnerability scanning.\\n\\u2022 Run a\", \"utomated tests as part of your build pipeline in Azure DevOps Services or through \\nGitHub Actions\\n\\u2022 \", \"Azure DevOps Services/GitHub can tighten the DevOps life cycle with delivery to multiple \\nenvironmen\", \"ts, not just for production environments, but also for testing, including A/B \\nexperimentation, cana\", \"ry releases, and so on.\\n\\u2022 Organizations easily can provision Docker containers from private images s\", \"tored in Azure \\nContainer Registry along with any dependency on Azure components (Data, PaaS, etc.) \", \"using \\nAzure Resource Manager templates with tools they\\u2019re already comfortable with.\\nSteps in the ou\", \"ter-loop DevOps workflow for a \\nDocker application\\nFigure 5-1 presents an end-to-end depiction of th\", \"e steps comprising the DevOps outer-loop \\nworkflow. It shows the \\u201couter loop\\u201d of DevOps. When code i\", \"s pushed to the repo, a CI pipeline is \\nstarted, then begins the CD pipeline, where the application \", \"gets deployed. Metrics collected from \\ndeployed applications are fed back into the development workl\", \"oad, where the \\u201cinner loop\\u201d occurs, so \\ndevelopment teams have actual data to respond to user and bu\", \"siness needs.\\nFigure 5-1. DevOps outer-loop workflow for Docker applications with Microsoft tools\\nNo\", \"w, let\\u2019s examine each of these steps in greater detail.76 CHAPTER 5 | Docker application DevOps work\", \"flow with Microsoft tools\\nStep 1: Inner-loop development workflow\\nThis step is explained in detail i\", \"n Chapter 4, but, to recap, here is where the outer-loop begins, the \\nmoment at which a developer pu\", \"shes code to the source control management system (like Git) \\ninitiating CI pipeline actions.\\nStep 2\", \": Source-Code Control integration and management with Azure \\nDevOps Services and Git\\nAt this step, y\", \"ou need to have a version-control system to gather a consolidated version of all the \\ncode coming fr\", \"om the different developers in the team.\\nEven though source-code control (SCC) and source-code manag\", \"ement might seem second-nature to \\nmost developers, when creating Docker applications in a DevOps li\", \"fe cycle, it\\u2019s critical to emphasize \\nthat you must not submit the Docker images with the applicatio\", \"n directly to the global Docker \\nRegistry (like Azure Container Registry or Docker Hub) from the dev\", \"eloper\\u2019s machine. On the contrary, \\nthe Docker images to be released and deployed to production envi\", \"ronments must be created solely \\non the source code that\\u2019s being integrated in your global build or \", \"CI pipeline based on your source\\u0002code repository (like Git).\\nThe local images, generated by develope\", \"rs, should just be used by them when testing within their \\nown machines. That\\u2019s why it\\u2019s critical to\", \" have the DevOps pipeline activated from the SCC code.\\nAzure DevOps Services and Team Foundation Ser\", \"ver support Git and Team Foundation Version \\nControl. You can choose between them and use it for an \", \"end-to-end Microsoft experience. However, \\nyou can also manage your code in external repositories (l\", \"ike GitHub, on-premises Git repositories, or \\nSubversion) and still be able to connect to it and get\", \" the code as the starting point for your DevOps CI \\npipeline. You can also use GitHub Actions for CI\", \"/CD pipelines.\\nStep 3: Build, CI, Integrate, and Test with Azure DevOps \\nServices/GitHub and Docker\\n\", \"CI has emerged as a standard for modern software testing and delivery. The Docker solution \\nmaintain\", \"s a clear separation of concerns between the development and operations teams. The \\nimmutability of \", \"Docker images ensures a repeatable deployment between what\\u2019s developed, tested \\nthrough CI, and run \", \"in production. Docker Engine deployed across the developer laptops and test \\ninfrastructure makes th\", \"e containers portable across environments.\\nAt this point, after you have a version-control system wi\", \"th the correct code submitted, you need a \\nbuild service to pick up the code and run the global buil\", \"d and tests.\\nThe internal workflow for this step (CI, build, test) is about the construction of a CI\", \" pipeline consisting \\nof your code repository (Git, etc.), your build server (Azure DevOps Services/\", \"GitHub), Docker Engine, \\nand a Docker Registry.\\nYou can use Azure DevOps Services as the foundation \", \"for building your applications and setting your \\nCI pipeline, and for publishing the built \\u201cartifact\", \"s\\u201d to an \\u201cartifacts repository,\\u201d which is explained in the \\nnext step. Alternatively, you can use Gi\", \"tHub to implement the same workflow.77 CHAPTER 5 | Docker application DevOps workflow with Microsoft\", \" tools\\nWhen using Docker for the deployment, the \\u201cfinal artifacts\\u201d to be deployed are Docker images \", \"with \\nyour application or services embedded within them. Those images are pushed or published to a \\n\", \"Docker Registry (a private repository like the ones you can have in Azure Container Registry, or a \\n\", \"public one like Docker Hub Registry or GitHub Container Registry, which is commonly used for officia\", \"l \\nbase images).\\nHere is the basic concept: The CI pipeline will be kicked-off by a commit to an SCC\", \" repository like Git. \\nThe commit will cause Azure DevOps Services/GitHub to run a build job within \", \"a Docker container \\nand, upon successful completion of that job, push a Docker image to the Docker R\", \"egistry, as \\nillustrated in Figure 5-2. The first part of the outer loop involves steps 1 to 3, from\", \" code, run, debug \\nand validate, then the code repo up to the build and test CI step.\\nFigure 5-2. Th\", \"e steps involved in CI\\nHere are the basic CI workflow steps with Docker and Azure DevOps Services:78\", \" CHAPTER 5 | Docker application DevOps workflow with Microsoft tools\\n1. The developer pushes a commi\", \"t to an SCC repository (Git/Azure DevOps Services, GitHub, \\netc.).\\n2. If you\\u2019re using Azure DevOps S\", \"ervices or Git, CI is built in, which means that it\\u2019s as simple as \\nselecting a check box in Azure D\", \"evOps Services. If you\\u2019re using an external SCC (like GitHub), \\na webhook will notify Azure DevOps S\", \"ervices of the update or push to Git/GitHub.\\n3. Azure DevOps Services pulls the SCC repository, incl\", \"uding the Dockerfile describing the \\nimage, as well as the application and test code.\\n4. Azure DevOp\", \"s Services builds a Docker image and labels it with a build number.\\n5. Azure DevOps Services instant\", \"iates the Docker container within the provisioned Docker Host, \\nand runs the appropriate tests.\\n6. I\", \"f the tests are successful, the image is first relabeled to a meaningful name so that you know \\nit\\u2019s\", \" a \\u201cblessed build\\u201d (like \\u201c/1.0.0\\u201d or any other label), and then pushed up to your Docker \\nRegistry (\", \"Docker Hub, Azure Container Registry, DTR, etc.)\\nHere are the basic CI workflow steps with Docker an\", \"d GitHub:\\n1. The developer pushes a commit to a GitHub repo.\\n2. CI is built in, so Actions will trig\", \"ger base on the event filters.\\n3. GitHub pulls the SCC repository, including the Dockerfile describi\", \"ng the image, as well as the \\napplication and test code.\\n4. GitHub builds a Docker image and labels \", \"it with a build number.\\n5. GitHub instantiates the Docker container within the provisioned Docker Ho\", \"st, and runs the \\nappropriate tests.\\n6. If the tests are successful, the image is first relabeled to\", \" a meaningful name so that you know \\nit\\u2019s a \\u201cblessed build\\u201d (like \\u201c/1.0.0\\u201d or any other label), and \", \"then pushed up to your Docker \\nRegistry (Docker Hub, Azure Container Registry, DTR, etc.)\\nImplement \", \"a CI pipeline with Azure DevOps Services and the Docker extension for \\nAzure DevOps Services\\nVisual \", \"Studio Azure DevOps Services contains Build & Release Templates that you can use in your \\nCI/CD pipe\", \"line with which you can build Docker images, push Docker images to an authenticated \\nDocker registry\", \", run Docker images, or run other operations offered by the Docker CLI. It also adds a \\nDocker Compo\", \"se task that you can use to build, push, and run multi-container Docker applications, or \\nrun other \", \"operations offered by the Docker Compose CLI, as shown in Figure 5-3.79 CHAPTER 5 | Docker applicati\", \"on DevOps workflow with Microsoft tools\\nFigure 5-3. The Docker CI pipeline in Azure DevOps Services \", \"including Build & Release Templates and associated tasks.\\nYou can use these templates and tasks to c\", \"onstruct your CI/CD artifacts to Build / Test and Deploy in \\nAzure Service Fabric, Azure Kubernetes \", \"Service, and similar offerings.\\nWith these Visual Studio Team Services tasks, a build Linux-Docker H\", \"ost/VM provisioned in Azure and \\nyour preferred Docker registry (Azure Container Registry, Docker Hu\", \"b, private Docker DTR, or any \\nother Docker registry) you can assemble your Docker CI pipeline in a \", \"very consistent way.\\nRequirements:\\n\\u2022 Azure DevOps Services, or for on-premises installations, Team F\", \"oundation Server 2015 \\nUpdate 3 or later.\\n\\u2022 An Azure DevOps Services agent that has the Docker binar\", \"ies.\\nAn easy way to create one of these agents is to use Docker to run a container based on the \\nAzu\", \"re DevOps Services agent Docker image.\\nTip\\nTo read more about assembling an Azure DevOps Services Do\", \"cker CI pipeline and view the \\nwalkthroughs, visit these sites:\\n\\u2022 Running a Visual Studio Team Servi\", \"ces (Now Azure DevOps Services) agent as a Docker \\ncontainer:\\nhttps://hub.docker.com/_/microsoft-azu\", \"re-pipelines-vsts-agent80 CHAPTER 5 | Docker application DevOps workflow with Microsoft tools\\n\\u2022 Buil\", \"ding .NET Linux Docker images with Azure DevOps Services:\\nhttps://learn.microsoft.com/archive/blogs/\", \"stevelasker/building-net-core-linux-docker\\u0002images-with-visual-studio-team-services\\n\\u2022 Building a Linu\", \"x-based Visual Studio Team Service build machine with Docker support:\\nhttps://www.donovanbrown.com/p\", \"ost/Building-a-Linux-Based-Visual-Studio-Team-Service\\u0002Build-Machine-with-Docker-Support\\nImplement a \", \"CI pipeline with GitHub Actions\\nGitHub Actions allow you to create automation scripts that can build\", \" Docker images, push Docker \\nimages to an authenticated Docker registry, run Docker images, or run o\", \"ther operations offered by \\nthe Docker CLI.\\nYou can use public Actions (such as Azure Login) and run\", \" (shell) commands to construct your CI/CD \\nartifacts to Build / Test and Deploy in Azure Service Fab\", \"ric, Azure Kubernetes Service, and similar \\nofferings.\\nWith these Actions, a build Linux-Docker Host\", \"/VM provisioned in Azure and your preferred Docker \\nregistry (Azure Container Registry, Docker Hub, \", \"private Docker DTR, or any other Docker registry) you \\ncan assemble your Docker CI pipeline in a ver\", \"y consistent way.\\nIntegrate, test, and validate multi-container Docker applications\\nTypically, most \", \"Docker applications are composed of multiple containers rather than a single \\ncontainer. A good exam\", \"ple is a microservices-oriented application for which you would have one \\ncontainer per microservice\", \". But, even without strictly following the microservices approach patterns, \\nit\\u2019s probable that your\", \" Docker application would be composed of multiple containers or services.\\nTherefore, after building \", \"the application containers in the CI pipeline, you also need to deploy, \\nintegrate, and test the app\", \"lication as a whole with all of its containers within an integration Docker \\nhost or even into a tes\", \"t cluster to which your containers are distributed.\\nIf you\\u2019re using a single host, you can use Docke\", \"r commands such as docker-compose to build and \\ndeploy related containers to test and validate the D\", \"ocker environment in a single VM. But, if you\\u2019re \\nworking with an orchestrator cluster like DC/OS, K\", \"ubernetes, or Docker Swarm, you need to deploy \\nyour containers through a different mechanism or orc\", \"hestrator, depending on your selected \\ncluster/scheduler.\\nThe following are several types of tests t\", \"hat you can run against Docker containers:\\n\\u2022 Unit tests for Docker containers\\n\\u2022 Testing groups of in\", \"terrelated applications or microservices\\n\\u2022 Test in production and \\u201ccanary\\u201d releases\\nThe important po\", \"int is that when running integration and functional tests, you must run those tests \\nfrom outside of\", \" the containers. Tests are not contained or run in the containers you\\u2019re deploying, \\nbecause the con\", \"tainers are based on static images that should be exactly like the ones you\\u2019ll be \\ndeploying to prod\", \"uction.81 CHAPTER 5 | Docker application DevOps workflow with Microsoft tools\\nA practical option whe\", \"n testing more advanced scenarios, like including several clusters (test cluster, \\nstaging cluster, \", \"and production cluster) is to publish the images to a registry, so it can be tested in \\nvarious clus\", \"ters.\\nPush the custom application Docker image into your global Docker Registry\\nAfter the Docker ima\", \"ges have been tested and validated, you\\u2019ll want to tag and publish them to your \\nDocker registry. Th\", \"e Docker registry is a critical piece in the Docker application life cycle because it\\u2019s \\nthe central\", \" place where you store your custom test (also known as \\u201cblessed images\\u201d) to be deployed \\ninto QA and\", \" production environments.\\nSimilar to how the application code stored in your SCC repository (Git, et\", \"c.) is your \\u201csource of truth,\\u201d \\nthe Docker registry is your \\u201csource of truth\\u201d for your binary applic\", \"ation or bits to be deployed to the \\nQA or production environments.\\nTypically, you might want to hav\", \"e your private repositories for your custom images either in a private \\nrepository in Azure Containe\", \"r Registry or in an on-premises registry like Docker Trusted Registry, or in \\na public-cloud registr\", \"y with restricted access (like Docker Hub), although in this last case if your code \\nis not open sou\", \"rce, you must trust the vendor\\u2019s security. Either way, the method you use is similar and \\nis based o\", \"n the docker push command, as shown in Figure 5-4.82 CHAPTER 5 | Docker application DevOps workflow \", \"with Microsoft tools\\nFigure 5-4. Publishing custom images to Docker Registry83 CHAPTER 5 | Docker ap\", \"plication DevOps workflow with Microsoft tools\\nIn step 3, for building integration and testing (CI) \", \"you might publish the resulting docker images to a \\nprivate or public registry. There are multiple o\", \"fferings of Docker registries from cloud vendors like \\nAzure Container Registry, Amazon Web Services\", \" Container Registry, Google Container Registry, \\nGitHub Container Registry, Quay Registry, and so on\", \".\\nUsing the Docker tasks, you can push a set of service images defined by a docker-compose.yml file,\", \" \\nwith multiple tags, to an authenticated Docker registry (like Azure Container Registry), as shown \", \"in \\nFigure 5-5.\\nFigure 5-5. Using Azure DevOps Services to publishing custom images to a Docker Regi\", \"stry\\nTip\\nFor more information about Azure Container Registry, see https://aka.ms/azurecontainerregis\", \"try.\\nStep 4: CD, Deploy\\nThe immutability of Docker images ensures a repeatable deployment with what\\u2019\", \"s developed, tested \\nthrough CI, and run in production. After you have the application Docker images\", \" published in your \\nDocker registry (either private or public), you can deploy them to the several e\", \"nvironments that you \\nmight have (production, QA, staging, etc.) from your CD pipeline by using Azur\", \"e DevOps Services \\npipeline tasks, Azure DevOps Services Release Management or GitHub Actions.84 CHA\", \"PTER 5 | Docker application DevOps workflow with Microsoft tools\\nHowever, at this point it depends o\", \"n what kind of Docker application you\\u2019re deploying. Deploying a \\nsimple application (from a composit\", \"ion and deployment point of view) like a monolithic application \\ncomprising a few containers or serv\", \"ices and deployed to a few servers or VMs is different from \\ndeploying a more complex application li\", \"ke a microservices-oriented application with hyperscale \\ncapabilities. These two scenarios are expla\", \"ined in the following sections.\\nDeploying composed Docker applications to multiple Docker environmen\", \"ts\\nLet\\u2019s look first at the less-complex scenario: deploying to simple Docker hosts (VMs or servers) \", \"in a \\nsingle environment or multiple environments (QA, staging, and production). In this scenario, i\", \"nternally \\nyour CD pipeline can use docker-compose (from your Azure DevOps Services deployment tasks\", \") to \\ndeploy the Docker applications with its related set of containers or services, as illustrated \", \"in Figure 5-6.\\nFigure 5-6. Deploying application containers to simple Docker host environments regis\", \"try\\nFigure 5-7 highlights how you can connect your build CI to QA/test environments via Azure DevOps\", \" \\nServices by clicking Docker Compose in the Add Task dialog box. However, when deploying to staging\", \" \\nor production environments, you would usually use Release Management features handling multiple \\ne\", \"nvironments (like QA, staging, and production). If you\\u2019re deploying to single Docker hosts, it is us\", \"ing \\nthe Azure DevOps Services \\u201cDocker Compose\\u201d task (which is invoking the docker-compose up \\ncomma\", \"nd under the hood). If you\\u2019re deploying to Azure Kubernetes Service (AKS), it uses the Docker 85 CHA\", \"PTER 5 | Docker application DevOps workflow with Microsoft tools\\nDeployment task, as explained in th\", \"e section that follows. Similar steps can be built for deployment \\nusing GitHub Actions.\\nFigure 5-7.\", \" Adding a Docker Compose task in an Azure DevOps Services pipeline or GitHub workflow\\nWhen you creat\", \"e a release in Azure DevOps Services, it takes a set of input artifacts. These artifacts are \\nintend\", \"ed to be immutable for the lifetime of the release, across all environments. When you introduce \\ncon\", \"tainers, the input artifacts identify images in a registry to deploy. Depending on how these images \", \"\\nare identified, they are not guaranteed to remain the same throughout the duration of the release, \", \"the \\nmost obvious case being when you reference myimage:latest from a docker-compose file.\\nThe Azure\", \" DevOps Services templates give you the ability to generate build artifacts that contain \\nspecific r\", \"egistry image digests that are guaranteed to uniquely identify the same image binary. These \\nare wha\", \"t you really want to use as input to a release. You can invoke docker-compose in a run step \\ninside \", \"GitHub Actions to accomplish the same goal.\\nManaging releases to Docker environments by using Azure \", \"DevOps Services \\nRelease Management or GitHub Actions\\nThrough the Azure DevOps Services templates, y\", \"ou can build a new image, publish it to a Docker \\nregistry, run it on Linux or Windows hosts, and us\", \"e commands such as docker-compose to deploy \\nmultiple containers as an entire application, all throu\", \"gh the Azure DevOps Services Release \\nManagement capabilities intended for multiple environments, as\", \" shown in Figure 5-8.86 CHAPTER 5 | Docker application DevOps workflow with Microsoft tools\\nFigure 5\", \"-8. Configuring Azure DevOps Services Docker Compose tasks from Azure DevOps Services Release \\nManag\", \"ement\\nHowever, keep in mind that the scenario shown in Figure 5-6 and implemented in Figure 5-8 is a\", \" \\nsimple one (it\\u2019s deploying to single Docker hosts and VMs, and there will be a single container or\", \" \\ninstance per image) and probably should be used only for development or test scenarios. In most \\ne\", \"nterprise production scenarios, you would want to have High Availability (HA) and easy-to-manage \\nsc\", \"alability by load balancing across multiple nodes, servers, and VMs, plus \\u201cintelligent failovers\\u201d so\", \" if a \\nserver or node fails, its services and containers will be moved to another host server or VM.\", \" In that \\ncase, you need more advanced technologies such as container clusters, orchestrators, and s\", \"chedulers. \\nThus, the way to deploy to those clusters is by handling the advanced scenarios explaine\", \"d in the next \\nsection.\\nGitHub Actions can be used in the same manner, including the use of environm\", \"ents for approvals.\\nDeploying Docker applications to Docker clusters\\nThe nature of distributed appli\", \"cations requires compute resources that are also distributed. To have \\nproduction-scale capabilities\", \", you need to have clustering capabilities that provide high scalability and \\nhigh availability base\", \"d on pooled resources.\\nYou could deploy containers manually to those clusters from a CLI tool or a w\", \"eb UI, but you should \\nreserve that kind of manual work to spot deployment testing or management pur\", \"poses like scaling\\u0002out or monitoring.\\nFrom a CD point of view, you can use Azure DevOps Services or \", \"GitHub Actions to run specially made \\ndeployment tasks from your environments that will deploy your \", \"containerized applications to \\ndistributed clusters in Container Service, as illustrated in Figure 5\", \"-9.87 CHAPTER 5 | Docker application DevOps workflow with Microsoft tools\\nFigure 5-9. Deploying dist\", \"ributed applications to Container Service\\nInitially, when deploying to certain clusters or orchestra\", \"tors, you would traditionally use specific \\ndeployment scripts and mechanisms per each orchestrator \", \"(that is, Kubernetes and Service Fabric \\nhave different deployment mechanisms) instead of the simple\", \"r and easy-to-use docker-compose tool \\nbased on the docker-compose.yml definition file. However, tha\", \"nks to the Azure DevOps Services \\nDocker Deploy task, shown in Figure 5-10, now you can also deploy \", \"to the supported orchestrators by \\njust using your familiar docker-compose.yml file because the tool\", \" performs that \\u201ctranslation\\u201d for you \\n(from your docker-compose.yml file to the format needed by the\", \" orchestrator).88 CHAPTER 5 | Docker application DevOps workflow with Microsoft tools\\nFigure 5-10. A\", \"dding the Deploy to Kubernetes task to your Environment\\nFigure 5-11 demonstrates how you can edit th\", \"e Deploy to Kubernetes task with the sections available \\nfor configuration. This is the task that wi\", \"ll retrieve your ready-to-use custom Docker images to be \\ndeployed as containers in the cluster.\\nFig\", \"ure 5-11. Docker Deploy task definition deploying to ACS DC/OS89 CHAPTER 5 | Docker application DevO\", \"ps workflow with Microsoft tools\\nTip\\nTo read more about the CD pipeline with Azure DevOps Services a\", \"nd Docker, visit \\nhttps://azure.microsoft.com/services/devops/pipelines\\nTip\\nTo see GitHub Actions wo\", \"rkflows for CI, visit https://github.com/dotnet\\u0002architecture/eShopOnContainers/wiki/GitHub-Actions. \", \"For a walkthrough of GitHub Actions \\nperforming deployment to an Azure Kubernetes environment, visit\", \" https://github.com/dotnet\\u0002architecture/eShopOnContainers/wiki/Deployment-With-GitHub-Actions.\\nStep \", \"5: Run and manage\\nBecause running and managing applications at enterprise-production level is a majo\", \"r subject in and of \\nitself, and due to the type of operations and people working at that level (IT \", \"operations) as well as the \\nlarge scope of this area, the entire next chapter is devoted to explaini\", \"ng it.\\nStep 6: Monitor and diagnose\\nThis topic also is covered in the next chapter as part of the ta\", \"sks that IT performs in production \\nsystems; however, is important to highlight that the insights ob\", \"tained in this step must feed back to \\nthe development team so that the application is constantly im\", \"proved. From that point of view, it\\u2019s also \\npart of DevOps, although the tasks and operations are co\", \"mmonly performed by IT.\\nOnly when monitoring and diagnostics are 100% within the realm of DevOps are\", \" the monitoring \\nprocesses and analytics performed by the development team against testing or beta e\", \"nvironments. \\nThis is done either by performing load testing or by monitoring beta or QA environment\", \"s, where beta \\ntesters are trying the new versions.\\nCreate CI/CD pipelines in Azure DevOps Services \", \"for \\na .NET application on Containers and deploying to a \\nKubernetes cluster\\nIn Figure 5-12 you can \", \"see the end-to-end DevOps scenario covering the code management, code \\ncompilation, Docker images bu\", \"ild, Docker images push to a Docker registry and finally the \\ndeployment to a Kubernetes cluster in \", \"Azure.90 CHAPTER 5 | Docker application DevOps workflow with Microsoft tools\\nFigure 5-12. CI/CD scen\", \"ario creating Docker images and deploying to a Kubernetes cluster in Azure\\nIt is important to highli\", \"ght that the two pipelines, build/CI, and release/CD, are connected through the \\nDocker Registry (su\", \"ch as Docker Hub or Azure Container Registry). The Docker registry is one of the \\nmain differences c\", \"ompared to a traditional CI/CD process without Docker.\\nAs shown in Figure 5-13, the first phase is t\", \"he build/CI pipeline. In Azure DevOps Services you can \\ncreate build/CI pipelines that will compile \", \"the code, create the Docker images, and push them to a \\nDocker Registry like Docker Hub or Azure Con\", \"tainer Registry.91 CHAPTER 5 | Docker application DevOps workflow with Microsoft tools\\nFigure 5-13. \", \"Build/CI pipeline in Azure DevOps building Docker images and pushing images to a Docker registry\\nThe\", \" second phase is to create a deployment/release pipeline. In Azure DevOps Services, you can easily \\n\", \"create a deployment pipeline targeting a Kubernetes cluster by using the Kubernetes tasks for Azure \", \"\\nDevOps Services, as shown in Figure 5-14.\\nFigure 5-14. Release/CD pipeline in Azure DevOps Services\", \" deploying to a Kubernetes cluster\\n[!Walkthrough] Deploying eShopModernized to Kubernetes:92 CHAPTER\", \" 5 | Docker application DevOps workflow with Microsoft tools\\nFor a detailed walkthrough of Azure Dev\", \"Ops CI/CD pipelines deploying to Kubernetes, see this post:\\nhttps://github.com/dotnet-architecture/e\", \"ShopModernizing/wiki/04.-How-to-deploy-your-Windows\\u0002Containers-based-apps-into-Kubernetes-in-Azure-C\", \"ontainer-Service-(Including-CI-CD)93 CHAPTER 6 | Run, manage, and monitor Docker production environm\", \"ents\\nCHAPTER 6\\nRun, manage, and monitor \\nDocker production \\nenvironments\\nVision: Enterprise applicat\", \"ions need to run with high availability and high scalability; IT operations \\nneed to be able to mana\", \"ge and monitor the environments and the applications themselves.\\nThis last pillar in the containeriz\", \"ed Docker applications life cycle is centered on how you can run, \\nmanage, and monitor your applicat\", \"ions in scalable, high availability (HA) production environments.\\nThe way you run your containerized\", \" applications in production (infrastructure architecture and \\nplatform technologies) is very much re\", \"lated and based on the chosen architecture and development \\nplatforms discussed in Chapter 1 of this\", \" e-book.\\nThis chapter examines specific products and technologies from Microsoft and other vendors t\", \"hat you \\ncan use to effectively run scalable, HA distributed applications plus how you can manage an\", \"d monitor \\nthem from the IT perspective.\\nRun composed and microservices-based \\napplications in produ\", \"ction environments\\nApplications composed by multiple microservices do need to be deployed into orche\", \"strator clusters in \\norder to simplify the complexity of deployment and make it viable from an IT po\", \"int of view. Without \\nan orchestrator cluster, it would be difficult to deploy and scale out a compl\", \"ex microservices \\napplication.\\nIntroduction to orchestrators, schedulers, and container clusters\\nEar\", \"lier in this e-book, clusters and schedulers were introduced as part of the discussion on software \\n\", \"architecture and development. Kubernetes and Service Fabric are examples of Docker clusters. Both of\", \" \\nthese orchestrators can run as a part of the infrastructure provided by Microsoft Azure Kubernetes\", \" \\nService.94 CHAPTER 6 | Run, manage, and monitor Docker production environments\\nWhen applications a\", \"re scaled-out across multiple host systems, the ability to manage each host \\nsystem and abstract awa\", \"y the complexity of the underlying platform becomes attractive. That\\u2019s \\nprecisely what orchestrators\", \" and schedulers provide. Let\\u2019s take a brief look at them here:\\n\\u2022 Schedulers. \\u201cScheduling\\u201d refers to \", \"the ability for an administrator to load a service file onto \\na host system that establishes how to \", \"run a specific container. Launching containers in a \\nDocker cluster tends to be known as scheduling.\", \" Although scheduling refers to the specific act \\nof loading the service definition, in a more genera\", \"l sense, schedulers are responsible for \\nhooking into a host\\u2019s init system to manage services in wha\", \"tever capacity needed.\\nA cluster scheduler has multiple goals: using the cluster\\u2019s resources efficie\", \"ntly, working with \\nuser-supplied placement constraints, scheduling applications rapidly to not leav\", \"e them in a \\npending state, having a degree of \\u201cfairness,\\u201d being robust to errors, and always be ava\", \"ilable.\\n\\u2022 Orchestrators. Platforms extend life-cycle management capabilities to complex, multi\\u0002conta\", \"iner workloads deployed on a cluster of hosts. By abstracting the host infrastructure, \\norchestratio\", \"n tools give users a way to treat the entire cluster as a single deployment target.\\nThe process of o\", \"rchestration involves tooling and a platform that can automate all aspects of \\napplication managemen\", \"t from initial placement or deployment per container; moving \\ncontainers to different hosts dependin\", \"g on its host\\u2019s health or performance; versioning and \\nrolling updates and health monitoring functio\", \"ns that support scaling and failover; and many \\nmore.\\nOrchestration is a broad term that refers to c\", \"ontainer scheduling, cluster management, and \\npossibly the provisioning of additional hosts.\\nThe cap\", \"abilities provided by orchestrators and schedulers are complex to develop and create from \\nscratch, \", \"therefore you usually would want to use orchestration solutions offered by vendors.\\nManage productio\", \"n Docker environments\\nCluster management and orchestration is the process of controlling a group of \", \"hosts. This can involve \\nadding and removing hosts from a cluster, getting information about the cur\", \"rent state of hosts and \\ncontainers, and starting and stopping processes. Cluster management and orc\", \"hestration are closely \\ntied to scheduling because the scheduler must have access to each host in th\", \"e cluster in order to \\nschedule services. For this reason, the same tool is often used for both purp\", \"oses.\\nContainer Service and management tools\\nContainer Service provides rapid deployment of popular \", \"open-source container clustering and \\norchestration solutions. It uses Docker images to ensure that \", \"your application containers are fully \\nportable. By using Container Service, you can deploy DC/OS (p\", \"owered by Mesosphere and Apache \\nMesos) and Docker Swarm clusters with Azure Resource Manager templa\", \"tes or the Azure portal to \\nensure that you can scale these applications to thousands\\u2014even tens of t\", \"housands\\u2014of containers.\\nYou deploy these clusters by using Azure Virtual Machine Scale Sets, and the\", \" clusters take advantage \\nof Azure networking and storage offerings. To access Container Service, yo\", \"u need an Azure 95 CHAPTER 6 | Run, manage, and monitor Docker production environments\\nsubscription.\", \" With Container Service, you can take advantage of the enterprise-grade features of \\nAzure while sti\", \"ll maintaining application portability, including at the orchestration layers.\\nTable 6-1 lists commo\", \"n management tools related to their orchestrators, schedulers, and clustering \\nplatform.\\nTable 6-1. \", \"Docker management tools\\nManagement tools Description Related orchestrators\\nAzure Monitor for Contain\", \"ers Azure dedicated \\nKubernetes \\nmanagement tool\\nAzure Kubernetes Services (AKS)\\nKubernetes Web UI \\n\", \"(dashboard)\\nKubernetes \\nmanagement tool, \\ncan monitor and \\nmanage local \\nKubernetes cluster\\nAzure Ku\", \"bernetes Service (AKS)\\nLocal Kubernetes\\nAzure portal for Service Fabric\\nAzure Service Fabric Explore\", \"r\\nOnline and desktop \\nversion for managing \\nService Fabric \\nclusters, on Azure, on \\npremises, local \", \"\\ndevelopment, and \\nother clouds\\nAzure Service Fabric\\nContainer Monitoring (Azure \\nMonitor)\\nGeneral c\", \"ontainer \\nmanagement y \\nmonitoring solution. \\nCan manage \\nKubernetes clusters \\nthrough Azure \\nMonito\", \"r for \\nContainers.\\nAzure Service Fabric\\nAzure Kubernetes Service (AKS)\\nMesosphere DC/OS and others.\\n\", \"Azure Service Fabric\\nAnother choice for cluster-deployment and management is Azure Service Fabric. S\", \"ervice Fabric is a \\nMicrosoft microservices platform that includes container orchestration as well a\", \"s developer \\nprogramming models to build highly scalable microservices applications. Service Fabric \", \"supports \\nDocker in Linux and Windows Containers and can run in Windows and Linux servers.\\nThe follo\", \"wing are Service Fabric management tools:\\n\\u2022 Azure portal for Service Fabric cluster-related operatio\", \"ns (create/update/delete) a cluster or \\nconfigure its infrastructure (VMs, load balancer, networking\", \", etc.)\\n\\u2022 Azure Service Fabric Explorer is a specialized web UI and desktop multi-platform tool that\", \" \\nprovides insights and certain operations on the Service Fabric cluster, from the nodes/VMs \\npoint \", \"of view and from the application and services point of view.96 CHAPTER 6 | Run, manage, and monitor \", \"Docker production environments\\nMonitor containerized application services\\nIt\\u2019s critical for applicat\", \"ions split into multiple containers and microservices to have a way to monitor \\nand analyze the beha\", \"vior of the whole application.\\nAzure Monitor\\nAzure Monitor is an extensible analytics service that m\", \"onitors your live application. It helps you to \\ndetect and diagnose performance issues and to unders\", \"tand what users actually do with your app. It\\u2019s \\ndesigned for developers, with the intent of helping\", \" you to continuously improve the performance and \\nusability of your services or applications. Azure \", \"Monitor works with both web/services and standalone \\napps on a wide variety of platforms like .NET, \", \"Java, Node.js and many other platforms, hosted on\\u0002premises or in the cloud.\\nAdditional resources\\n\\u2022 O\", \"verview of Azure Monitor\\nhttps://learn.microsoft.com/azure/azure-monitor/overview\\n\\u2022 What is Applicat\", \"ion Insights?\\nhttps://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview\\n\\u2022 What is Az\", \"ure Monitor Metrics?\\nhttps://learn.microsoft.com/azure/azure-monitor/platform/data-platform-metrics\\n\", \"\\u2022 Container Monitoring solution in Azure Monitor\\nhttps://learn.microsoft.com/azure/azure-monitor/ins\", \"ights/containers\\nSecurity and backup services\\nThere are many support chores with lots of details tha\", \"t you have to handle to ensure your applications \\nand infrastructure are in top notch condition to s\", \"upport business needs, and the situation becomes \\nmore complicated in the microservices realm, so yo\", \"u need a way to have both high-level and detailed \\nviews when you need to take action.\\nAzure has the\", \" tools to manage and provide a unified view of four critical aspects of both your cloud \\nand on-prem\", \"ises resources:\\n\\u2022 Security. With Azure Security Center.\\n\\u2013 Get full visibility and control over the s\", \"ecurity of your virtual machines, apps, and \\nworkloads.\\n\\u2013 Centralize the management of your security\", \" policies and integrate existing processes \\nand tools.\\n\\u2013 Detect real threats with advanced analytics\", \".\\n\\u2022 Backup. With Azure Backup.\\n\\u2013 Avoid costly business disruptions, meet compliance goals, and prote\", \"ct your data \\nagainst ransomware and human errors.\\n\\u2013 Keep your backup data encrypted in transit and \", \"at rest.97 CHAPTER 6 | Run, manage, and monitor Docker production environments\\n\\u2013 Ensure access based\", \" on multifactor authentication to prevent unauthorized use.\\n\\u2022 On-premises resources. With hybrid clo\", \"ud solutions.98 CHAPTER 7 | Containerized Docker Application Lifecycle key takeaways\\nCHAPTER 7\\nConta\", \"inerized Docker \\nApplication Lifecycle key \\ntakeaways\\n\\u2022 Container-based solutions provide important \", \"cost-saving benefits because containers solve \\ndeployment problems caused by dependency failures in \", \"production environments, thereby \\nimproving DevOps and production operations significantly.\\n\\u2022 Docker\", \" has become the de facto standard in the container industry and is supported by the \\nmost significan\", \"t vendors in the Linux and Windows ecosystems, including Microsoft. In the \\nfuture, Docker will be u\", \"biquitous in any datacenter in the cloud or on-premises.\\n\\u2022 A Docker container is becoming the standa\", \"rd unit of deployment for any server-based \\napplication or service.\\n\\u2022 Docker orchestrators like the \", \"ones provided in Azure Kubernetes Service (AKS) and Azure \\nService Fabric are fundamental and indisp\", \"ensable for any microservices-based or multi\\u0002container applications that have significant complexity\", \" and scalability needs.\\n\\u2022 An end-to-end DevOps environment that supports Continuous Integration/Cont\", \"inuous \\nDeployment (CI/CD) and connects to the production Docker environments can provide agility \\na\", \"nd ultimately improve the time to market of your applications.\\n\\u2022 Azure DevOps Services greatly simpl\", \"ifies your DevOps environment by deploying to Docker \\nenvironments from your CI/CD pipelines. This s\", \"tatement applies to simple Docker \\nenvironments as well as to advanced microservice and container or\", \"chestrators based on \\nAzure.\"]"