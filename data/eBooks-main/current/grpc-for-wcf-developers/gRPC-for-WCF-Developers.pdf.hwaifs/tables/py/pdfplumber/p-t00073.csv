,0
0,public class GrpcStreamSubscription<T> : IDisposable
1,{
2,private readonly IAsyncStreamReader<T> _reader;
3,private readonly IObserver<T> _observer;
4,
5,private readonly CancellationTokenSource _tokenSource;
6,
7,private readonly Task _task;
8,
9,private bool _completed;
10,
11,"public GrpcStreamSubscription(IAsyncStreamReader<T> reader, IObserver<T> observer,"
12,CancellationToken token = default)
13,{
14,_reader = reader ?? throw new ArgumentNullException(nameof(reader));
15,_observer = observer ?? throw new ArgumentNullException(nameof(observer));
16,
17,_tokenSource = new CancellationTokenSource();
18,token.Register(_tokenSource.Cancel);
19,
20,_task = Run(_tokenSource.Token);
21,}
22,
23,private async Task Run(CancellationToken token)
24,{
25,while (!token.IsCancellationRequested)
26,{
27,try
28,{
29,if (!await _reader.MoveNext(token)) break;
30,}
31,catch (RpcException e) when (e.StatusCode == Grpc.Core.StatusCode.NotFound)
32,{
33,break;
34,}
35,catch (OperationCanceledException)
36,{
37,break;
38,}
39,catch (Exception e)
40,{
41,_observer.OnError(e);
42,_completed = true;
43,return;
44,}
45,
46,_observer.OnNext(_reader.Current);
47,}
48,
49,_completed = true;
