,0
0,"public override async Task Subscribe(IAsyncStreamReader<ActionMessage> requestStream,"
1,"IServerStreamWriter<StockTickerUpdate> responseStream, ServerCallContext context)"
2,{
3,using var subscriber = _subscriberFactory.GetSubscriber();
4,
5,"subscriber.Update += async (sender, args) =>"
6,"await WriteUpdateAsync(responseStream, args.Symbol, args.Price);"
7,
8,"var actionsTask = HandleActions(requestStream, subscriber, context.CancellationToken);"
9,
10,"_logger.LogInformation(""Subscription started."");"
11,await AwaitCancellation(context.CancellationToken);
12,
13,try { await actionsTask; } catch { /* Ignored */ }
14,
15,"_logger.LogInformation(""Subscription finished."");"
16,}
17,
18,"private async Task WriteUpdateAsync(IServerStreamWriter<StockTickerUpdate> stream, string"
19,"symbol, decimal price)"
20,{
21,try
22,{
23,await stream.WriteAsync(new StockTickerUpdate
24,{
25,"Symbol = symbol,"
26,"PriceCents = (int)(price * 100),"
27,Time = Timestamp.FromDateTimeOffset(DateTimeOffset.UtcNow)
28,});
29,}
30,catch (Exception e)
31,{
32,"// Handle any errors caused by broken connection, etc."
33,"_logger.LogError($""Failed to write message: {e.Message}"");"
34,}
35,}
36,
37,private static Task AwaitCancellation(CancellationToken token)
38,{
39,var completion = new TaskCompletionSource<object>();
40,token.Register(() => completion.SetResult(null));
41,return completion.Task;
42,}
