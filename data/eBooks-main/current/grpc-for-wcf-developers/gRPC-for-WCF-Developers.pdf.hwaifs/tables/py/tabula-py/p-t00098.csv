,public class GrpcStreamSubscription<T> : IDisposable
0,{
1,private readonly IAsyncStreamReader<T> _reader;
2,private readonly IObserver<T> _observer;
3,
4,private readonly CancellationTokenSource _tokenSource;
5,
6,private readonly Task _task;
7,
8,private bool _completed;
9,
10,"public GrpcStreamSubscription(IAsyncStreamReader<T> reader, IObserver<T> observer,"
11,CancellationToken token = default)
12,{
13,_reader = reader ?? throw new ArgumentNullException(nameof(reader));
14,_observer = observer ?? throw new ArgumentNullException(nameof(observer));
15,
16,_tokenSource = new CancellationTokenSource();
17,token.Register(_tokenSource.Cancel);
18,
19,_task = Run(_tokenSource.Token);
20,}
21,
22,private async Task Run(CancellationToken token)
23,{
24,while (!token.IsCancellationRequested)
25,{
26,try
27,{
28,if (!await _reader.MoveNext(token)) break;
29,}
30,catch (RpcException e) when (e.StatusCode == Grpc.Core.StatusCode.NotFound)
31,{
32,break;
33,}
34,catch (OperationCanceledException)
35,{
36,break;
37,}
38,catch (Exception e)
39,{
40,_observer.OnError(e);
41,_completed = true;
42,return;
43,}
44,
45,_observer.OnNext(_reader.Current);
46,}
47,
48,_completed = true;
