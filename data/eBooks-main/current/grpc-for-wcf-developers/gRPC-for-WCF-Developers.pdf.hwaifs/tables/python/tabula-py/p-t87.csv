,"public override async Task Subscribe(IAsyncStreamReader<ActionMessage> requestStream,"
0,"IServerStreamWriter<StockTickerUpdate> responseStream, ServerCallContext context)"
1,{
2,using var subscriber = _subscriberFactory.GetSubscriber();
3,
4,"subscriber.Update += async (sender, args) =>"
5,"await WriteUpdateAsync(responseStream, args.Symbol, args.Price);"
6,
7,"var actionsTask = HandleActions(requestStream, subscriber, context.CancellationToken);"
8,
9,"_logger.LogInformation(""Subscription started."");"
10,await AwaitCancellation(context.CancellationToken);
11,
12,try { await actionsTask; } catch { /* Ignored */ }
13,
14,"_logger.LogInformation(""Subscription finished."");"
15,}
16,
17,"private async Task WriteUpdateAsync(IServerStreamWriter<StockTickerUpdate> stream, string"
18,"symbol, decimal price)"
19,{
20,try
21,{
22,await stream.WriteAsync(new StockTickerUpdate
23,{
24,"Symbol = symbol,"
25,"PriceCents = (int)(price * 100),"
26,Time = Timestamp.FromDateTimeOffset(DateTimeOffset.UtcNow)
27,});
28,}
29,catch (Exception e)
30,{
31,"// Handle any errors caused by broken connection, etc."
32,"_logger.LogError($""Failed to write message: {e.Message}"");"
33,}
34,}
35,
36,private static Task AwaitCancellation(CancellationToken token)
37,{
38,var completion = new TaskCompletionSource<object>();
39,token.Register(() => completion.SetResult(null));
40,return completion.Task;
41,}
