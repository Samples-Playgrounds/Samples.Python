,namespace Grpc.Core;
0,
1,public class GrpcStreamObservable<T> : IObservable<T>
2,{
3,private readonly IAsyncStreamReader<T> _reader;
4,private readonly CancellationToken _token;
5,private int _used;
6,
7,"public GrpcStreamObservable(IAsyncStreamReader<T> reader, CancellationToken token ="
8,default)
9,{
10,_reader = reader ?? throw new ArgumentNullException(nameof(reader));
11,_token = token;
12,_used = 0;
13,}
14,
15,public IDisposable Subscribe(IObserver<T> observer) =>
16,"Interlocked.Exchange(ref _used, 1) == 0"
17,"? new GrpcStreamSubscription<T>(_reader, observer, _token)"
18,": throw new InvalidOperationException(""Subscribe can only be called once."");"
19,
20,}
21,
22,
