|    | public class StockTickerService : Protos.SimpleStockTicker.SimpleStockTickerBase   |
|---:|:-----------------------------------------------------------------------------------|
|  0 | {                                                                                  |
|  1 | private readonly IStockPriceSubscriberFactory _subscriberFactory;                  |
|  2 |                                                                                    |
|  3 | public StockTickerService(IStockPriceSubscriberFactory subscriberFactory)          |
|  4 | {                                                                                  |
|  5 | _subscriberFactory = subscriberFactory;                                            |
|  6 | }                                                                                  |
|  7 |                                                                                    |
|  8 | public override async Task Subscribe(SubscribeRequest request,                     |
|  9 | IServerStreamWriter<StockTickerUpdate> responseStream, ServerCallContext context)  |
| 10 | {                                                                                  |
| 11 | var subscriber = _subscriberFactory.GetSubscriber(request.Symbols.ToArray());      |
| 12 |                                                                                    |
| 13 | subscriber.Update += async (sender, args) =>                                       |
| 14 | await WriteUpdateAsync(responseStream, args.Symbol, args.Price);                   |
| 15 |                                                                                    |
| 16 | await AwaitCancellation(context.CancellationToken);                                |
| 17 | }                                                                                  |
| 18 |                                                                                    |
| 19 | private async Task WriteUpdateAsync(IServerStreamWriter<StockTickerUpdate> stream, |
| 20 | string symbol, decimal price)                                                      |
| 21 | {                                                                                  |
| 22 | try                                                                                |
| 23 | {                                                                                  |
| 24 | await stream.WriteAsync(new StockTickerUpdate                                      |
| 25 | {                                                                                  |
| 26 | Symbol = symbol,                                                                   |
| 27 | PriceCents = (int)(price * 100),                                                   |
| 28 | Time = Timestamp.FromDateTimeOffset(DateTimeOffset.UtcNow)                         |
| 29 | });                                                                                |
| 30 | }                                                                                  |
| 31 | catch (Exception e)                                                                |
| 32 | {                                                                                  |
| 33 | // Handle any errors caused by broken connection, etc.                             |
| 34 | _logger.LogError($"Failed to write message: {e.Message}");                         |
| 35 | }                                                                                  |
| 36 | }                                                                                  |
| 37 |                                                                                    |
| 38 | private static Task AwaitCancellation(CancellationToken token)                     |
| 39 | {                                                                                  |
| 40 | var completion = new TaskCompletionSource<object>();                               |
| 41 | token.Register(() => completion.SetResult(null));                                  |
| 42 | return completion.Task;                                                            |
| 43 | }                                                                                  |
| 44 | }                                                                                  |