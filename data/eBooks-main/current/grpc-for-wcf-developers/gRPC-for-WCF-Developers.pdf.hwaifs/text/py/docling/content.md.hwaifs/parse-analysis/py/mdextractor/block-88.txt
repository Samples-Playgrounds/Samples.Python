public class StockTickerService : Protos.SimpleStockTicker.SimpleStockTickerBase { private readonly IStockPriceSubscriberFactory _subscriberFactory; public StockTickerService(IStockPriceSubscriberFactory subscriberFactory) { _subscriberFactory = subscriberFactory; } public override async Task Subscribe(SubscribeRequest request, IServerStreamWriter<StockTickerUpdate> responseStream, ServerCallContext context) { var subscriber = _subscriberFactory.GetSubscriber(request.Symbols.ToArray()); subscriber.Update += async (sender, args) => await WriteUpdateAsync(responseStream, args.Symbol, args.Price); await AwaitCancellation(context.CancellationToken); } private async Task WriteUpdateAsync(IServerStreamWriter<StockTickerUpdate> stream, string symbol, decimal price) { try { await stream.WriteAsync( new StockTickerUpdate { Symbol = symbol, PriceCents = (int)(price * 100), Time = Timestamp.FromDateTimeOffset(DateTimeOffset.UtcNow) }); } catch (Exception e) { // Handle any errors caused by broken connection, etc. _logger.LogError($"Failed to write message: {e.Message}"); } } private static Task AwaitCancellation(CancellationToken token) { var completion = new TaskCompletionSource<object>(); token.Register(() => completion.SetResult( null )); return completion.Task; } }