public class Chat : IAsyncDisposable { private readonly Chatter . ChatterClient _client; private readonly AsyncDuplexStreamingCall<MessageRequest , MessageResponse> _stream; private readonly CancellationTokenSource _cancellationTokenSource; private readonly Task _readTask; public Chat(Chatter . ChatterClient client) { _client = client; _stream = _client . Connect(); _cancellationTokenSource = new CancellationTokenSource(); _readTask = ReadAsync(_cancellationTokenSource . Token); } public async Task SendAsync(string message) { await _stream . RequestStream . WriteAsync(new MessageRequest {Text = message}); } private async Task ReadAsync(CancellationToken token) { while (await _stream . ResponseStream . MoveNext(token)) { Console . WriteLine(_stream . ResponseStream . Current . Text); } } public async ValueTask DisposeAsync() { await _stream . RequestStream . CompleteAsync(); await _readTask; _stream . Dispose(); } }