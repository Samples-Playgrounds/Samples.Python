public override async Task Subscribe(IAsyncStreamReader<ActionMessage> requestStream, IServerStreamWriter<StockTickerUpdate> responseStream, ServerCallContext context) { using var subscriber = _subscriberFactory.GetSubscriber(); subscriber.Update += async (sender, args) => await WriteUpdateAsync(responseStream, args.Symbol, args.Price); var actionsTask = HandleActions(requestStream, subscriber, context.CancellationToken); _logger.LogInformation("Subscription started."); await AwaitCancellation(context.CancellationToken); try { await actionsTask; } catch { /* Ignored */ } _logger.LogInformation("Subscription finished."); } private async Task WriteUpdateAsync(IServerStreamWriter<StockTickerUpdate> stream, string symbol, decimal price) { try { await stream.WriteAsync( new StockTickerUpdate { Symbol = symbol, PriceCents = (int)(price * 100), Time = Timestamp.FromDateTimeOffset(DateTimeOffset.UtcNow) }); } catch (Exception e) { // Handle any errors caused by broken connection, etc. _logger.LogError($"Failed to write message: {e.Message}"); } } private static Task AwaitCancellation(CancellationToken token) { var completion = new TaskCompletionSource<object>(); token.Register(() => completion.SetResult( null )); return completion.Task; }