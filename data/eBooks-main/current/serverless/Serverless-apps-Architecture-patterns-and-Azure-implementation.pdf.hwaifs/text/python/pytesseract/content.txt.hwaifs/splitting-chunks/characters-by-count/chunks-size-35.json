"[\"=\\u00ae Microsoft\\n\\nServerless apps:\\nArchitecture, patterns,\\nand Azure\\nimplementation\\n\\nJeremy Likness\\nCeci\", \"l Phillip\\n\\nmE Microsoft\\n\\nEDITION v4.0 - Updated to Azure Functions v4\\n\\nDOWNLOAD available at: https:\", \"//aka.ms/serverlessbookpdf\\nPUBLISHED BY\\n\\nMicrosoft Developer Division, .NET, and Visual Studio produ\", \"ct teams\\nA division of Microsoft Corporation\\n\\nOne Microsoft Way\\n\\nRedmond, Washington 98052-6399\\n\\nCop\", \"yright \\u00a9 2018-2023 by Microsoft Corporation\\n\\nAll rights reserved. No part of the contents of this bo\", \"ok may be reproduced or transmitted in any\\nform or by any means without the written permission of th\", \"e publisher.\\n\\nThis book is provided \\u201cas-is\\u201d and expresses the author's views and opinions. The views\", \", opinions and\\ninformation expressed in this book, including URL and other Internet website referenc\", \"es, may change\\nwithout notice.\\n\\nSome examples depicted herein are provided for illustration only and\", \" are fictitious. No real association\\nor connection is intended or should be inferred.\\n\\nMicrosoft and\", \" the trademarks listed at https://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are\\ntrademarks of th\", \"e Microsoft group of companies.\\n\\nMac and macOS are trademarks of Apple Inc.\\nAll other marks and logo\", \"s are property of their respective owners.\\nAuthor:\\n\\nJeremy Likness, Senior .NET Data Program Manager\", \", Microsoft Corp.\\nContributor:\\n\\nCecil Phillip, Senior Cloud Advocate, Microsoft Corp.\\n\\nEditors:\\n\\nBil\", \"l Wagner, Senior Content Developer, Microsoft Corp.\\n\\nMaira Wenzel, Senior Content Developer, Microso\", \"ft Corp.\\n\\nParticipants and reviewers:\\n\\nSteve Smith, Architect/Trainer, NimblePros.\\n\\nIntroduction\\n\\nSe\", \"rverless is the evolution of cloud platforms in the direction of pure cloud native code. Serverless\\n\", \"brings developers closer to business logic while insulating them from infrastructure concerns. It's \", \"a\\npattern that doesn\\u2019t imply \\u201cno server\\u201d but rather, \\u201cless server.\\u201d Serverless code is event-driven.\", \" Code\\nmE Microsoft\\n\\nmay be triggered by anything from a traditional HTTP web request to a timer or t\", \"he result of\\nuploading a file. The infrastructure behind serverless allows for instant scale to meet\", \" elastic demands\\nand offers micro-billing to truly \\u201cpay for what you use.\\u201d Serverless requires a new\", \" way of thinking and\\napproach to building applications and isn\\u2019t the right solution for every proble\", \"m. As a developer, you\\nmust decide:\\n\\n. What are the pros and cons of serverless?\\n. Why should you co\", \"nsider serverless for your own applications?\\n. How can you build, test, deploy, and maintain your se\", \"rverless code?\\n\\n. Where does it make sense to migrate code to serverless in existing applications, a\", \"nd what is the\\nbest way to accomplish this transformation?\\n\\nAbout this guide\\n\\nThis guide focuses on \", \"cloud native development of applications that use serverless. The book\\nhighlights the benefits and e\", \"xposes the potential drawbacks of developing serverless apps and\\nprovides a survey of serverless arc\", \"hitectures. Many examples of how serverless can be used are\\nillustrated along with various serverles\", \"s design patterns.\\n\\nThis guide explains the components of the Azure serverless platform and focuses \", \"specifically on\\nimplementation of serverless using Azure Functions. You'll learn about triggers and \", \"bindings as well as\\nhow to implement serverless apps that rely on state using durable functions. Fin\", \"ally, business\\nexamples and case studies will help provide context and a frame of reference to deter\", \"mine whether\\nserverless is the right approach for your projects.\\n\\nEvolution of cloud platforms\\n\\nServ\", \"erless is the culmination of several iterations of cloud platforms. The evolution began with\\nphysica\", \"l metal in the data center and progressed through Infrastructure as a Service (laaS) and\\n\\nPlatform a\", \"s a Service (PaaS).\\n= x\\n[\\u20141-]\\n\\nOn-Premises laaS PaaS Serverless\\n\\nBefore the cloud, a discernible bou\", \"ndary existed between development and operations. Deploying an\\n\\napplication meant answering myriad q\", \"uestions like:\\n\\n\\u00b0 What hardware should be installed?\\n\\n. How is physical access to the machine secure\", \"d?\\nm= Microsoft\\n\\n. Does the data center require an Uninterruptible Power Supply (UPS)?\\n. Where are s\", \"torage backups sent?\\n\\n. Should there be redundant power?\\n\\nThe list goes on and the overhead was enor\", \"mous. In many situations, IT departments were forced to\\ndeal with incredible waste. The waste was du\", \"e to over-allocation of servers as backup machines for\\ndisaster recovery and standby servers to enab\", \"le scale-out. Fortunately, the introduction of\\nvirtualization technology (like Hyper-V) with Virtual\", \" Machines (VMs) gave rise to Infrastructure as a\\nService (laaS). Virtualized infrastructure allowed \", \"operations to set up a standard set of servers as the\\nbackbone, leading to a flexible environment ca\", \"pable of provisioning unique servers \\u201con demand.\\u201d\\nMore important, virtualization set the stage for u\", \"sing the cloud to provide virtual machines \\u201cas a\\nservice.\\u201d Companies could easily get out of the bus\", \"iness of worrying about redundant power or\\nphysical machines. Instead, they focused on the virtual e\", \"nvironment.\\n\\nlaaS still requires heavy overhead because operations is still resoonsible for various \", \"tasks. These tasks\\n\\ninclude:\\n. Patching and backing up servers.\\n. Installing packages.\\n\\n. Keeping th\", \"e operating system up-to-date.\\n\\n. Monitoring the application.\\n\\nThe next evolution reduced the overhe\", \"ad by providing Platform as a Service (PaaS). With PaaS, the\\ncloud provider handles operating system\", \"s, security patches, and even the required packages to\\nsupport a specific platform. Instead of build\", \"ing a VM then configuring .NET and standing up Internet\\nInformation Services (IIS) servers, develope\", \"rs simply choose a \\u201cplatform target\\u201d such as \\u201cweb\\napplication\\u201d or \\u201cAPI endpoint\\u201d and deploy code dir\", \"ectly. The infrastructure questions are reduced to:\\n\\n\\u00b0 What size services are needed?\\n\\u00b0 How do the s\", \"ervices scale out (add more servers or nodes)?\\n\\n. How do the services scale up (increase the capacit\", \"y of hosting servers or nodes)?\\n\\nServerless further abstracts servers by focusing on event-driven co\", \"de. Instead of a platform,\\ndevelopers can focus on a microservice that does one thing. The two key q\", \"uestions for building the\\nserverless code are:\\n\\n. What triggers the code?\\n\\u00b0 What does the code do?\\n\\n\", \"With serverless, infrastructure is abstracted. In some cases, the developer no longer worries about \", \"the\\nhost at all. Whether or not an instance of IIS, Kestrel, Apache, or some other web server is run\", \"ning to\\nmanage web requests, the developer focuses on an HTTP trigger. The trigger provides the stan\", \"dard,\\ncross-platform payload for the request. The payload not only simplifies the development proces\", \"s, but\\nfacilitates testing and in some cases, makes the code easily portable across platforms.\\n\\nAnot\", \"her feature of serverless is micro-billing. It's common for web applications to host Web API\\nendpoin\", \"ts. In traditional bare metal, laaS and even PaaS implementations, the resources to host the\\nAPIs ar\", \"e paid for continuously. That means you pay to host the endpoints even when they aren't\\nbeing access\", \"ed. Often you'll find one API is called more than others, so the entire system is scaled\\nmE Microsof\", \"t\\n\\nbased on supporting the popular endpoints. Serverless enables you to scale each endpoint\\nindepend\", \"ently and pay for usage, so no costs are incurred when the APIs aren't being called.\\nMigration may i\", \"n many circumstances dramatically reduce the ongoing cost to support the endpoints.\\n\\nWhat this guide\", \" doesn't cover\\n\\nThis guide specifically emphasizes architecture approaches and design patterns and i\", \"sn\\u2019t a deep dive\\ninto the implementation details of Azure Functions, Logic Apps, or other serverless\", \" platforms. This\\nguide doesn't cover, for example, advanced workflows with Logic Apps or features of\", \" Azure Functions\\nsuch as configuring Cross-Origin Resource Sharing (CORS), applying custom domains, \", \"or uploading\\nSSL certificates. These details are available through the online Azure Functions docume\", \"ntation.\\n\\nAdditional resources\\n\\n\\u00b0 Azure Architecture center\\n\\n\\u00b0 Best practices for cloud applications\", \"\\n\\nWho should use the guide\\n\\nThis guide was written for developers and solution architects who want t\", \"o build enterprise\\napplications with .NET that may use serverless components either on premises or i\", \"n the cloud. It's\\nuseful to developers, architects, and technical decision makers interested in:\\n\\n. \", \"Understanding the pros and cons of serverless development\\n\\u00b0 Learning how to approach serverless arch\", \"itecture\\n\\u00b0 Example implementations of serverless apps\\n\\nHow to use the guide\\n\\nThe first part of this \", \"guide examines why serverless is a viable option by comparing several different\\narchitecture approac\", \"hes. It examines both the technology and development lifecycle, because all\\naspects of software deve\", \"lopment are impacted by architecture decisions. The guide then examines\\nuse cases and design pattern\", \"s and includes reference implementations using Azure Functions. Each\\nsection contains additional res\", \"ources to learn more about a particular area. The guide concludes with\\nresources for walkthroughs an\", \"d hands-on exploration of serverless implementation.\\n\\nSend your feedback\\n\\nThe guide and related samp\", \"les are constantly evolving, so your feedback is welcomed! If you have\\ncomments about how this guide\", \" can be improved, use the feedback section at the bottom of any\\npage built on GitHub issues.\\nContent\", \"s\\n\\nArchitecture APPrOaCNES.......e.cesesssssssesssssssssssessssessssesessesesussesssesecseseenesesss\", \"sesessesessssesussesuesesessssesueseeessesesseseeseseaeenees 1\\nArchitecture Patterns... ccccsessesss\", \"sessssessssesssssssssessssssssessssessssesssssssesussesussesussesssesssssessesussesssesessesessesess\", \"esessesesseseesesesseseeseess 1\\nMOMOIIth oo... eceesesseseseesessessesscsessecucsscsecucsucsecsesucs\", \"ecsessesucsscsesucaucsesuesucsscsesucsucsesuesucaesuecucsecsesuesucsesnecuescsecuesucsessecucsesaeen\", \"eaueaeeneeneesens 1\\nN-Layer APPLICATIONS... ee eesesesssssssessssesscsessesesscsesussessesecsssesuss\", \"ecsesecsesecsssesussesussecussessesessesessesessssesseseesesessesessssessesesseaeeseaseneens 2\\nMICFO\", \"SEIVICES .....cesesessessessesscsssecsecuesecsecucsucscsesucsscsecuesucsscsecucsucsesuesuesecsecuese\", \"csecuesucsecnecucsucsesuecucaesuecuesucsecnesueaeenecucsesaeeneaueaeeneeneesens 3\\nArchitecture deplo\", \"yment APproache ou... cecessesessessssesessessssesessesessesessesessesssessssessssesessessssesessese\", \"ssesesseseesesessesesseseeseeeeseess 4\\n\\nN-Tier APPLICATIONS oo. esesessesessesessesessesssecsssecuss\", \"esussesussesussescssesussesussesussesussecussecsssesussecussecsssecusseenssesuesecussecnsseensseeess\", \"eenees 5\\nOn-premises and Infrastructure aS a Service (lAAS) we ccecessessessssessesesessessessssesse\", \"ssesessessecussesseeussesseeseesseeseeneseeaes 6\\nPlatform aS a Service (PAAS) ve sessssssscsssccssss\", \"cscscssscscssssescscscscsccsscscssscscscssvscsvacacsesecscscavacsssescacavacacseseeaeacacaceeeesaeae\", \"ass 7\\nSoftware aS a Service (SAAS) wc sssssssssscscscscsssssscscscscscsssscscscscscsesscsvsvavscscse\", \"susvscacacsessseacacacsesesavacscasecsesenaacasaceesenes 7\\nContainers and FUNCTIONS aS a Service (FA\", \"AS) wesc cscscsscscsssscscsssscscscsscscsssscscscsscscsssscscsssscsssssscssessacsseceaeaees 8\\nSEPVEL\", \"lOSS ...ececsececsessessessesessessessesscsessessescsesucsucsecsesucscsessesscsesnesuesscsesucsucses\", \"sesucsusscuecucsessecuesucsecsesucsessecuesucsecsecueaeeaeeneeeaeeneeneaeens 9\\nSUIMIMALSY ue cesscss\", \"sessesssecsessscsesesscsesessssesesscsesesscsesesucsesesscsesesesuesesessesesessssesesussesesscueses\", \"csesesesuesesesuesesesucecsesecsesesecueseseceseseaneeeseess 10\\nRECOMMENCET FESOUICES .......ecsesse\", \"ssesseseesessecsesessecsesscsessecscsessecucsucsessecuesecsessesucsecsecuesucsessecucaessecuesecsecs\", \"eseaeeaesenteneeneeneaees 11\\n\\nServer less ArchiteCtUre.......cccccesscsssssssssssssessesssesesessese\", \"ssessssssssssssesssesssessssesessssesessesesseseesssesseseeesseseseseesseaesseseenss 12\\nFull serverl\", \"ess Dack C1... cecessesssssssssssssesesessessescseesecucscsessesuesecsecsessssessesucsessesussucsess\", \"esucsessecucsssecsesusaeesecncsesaeenessaeeneeneaeees 13\\nMonoliths and \\u201cstarving the beast\\u201d oc cesse\", \"ssssessssessssessssesessesessessssesessesessesessessssesessesessesessesessesessesessesessesesseseese\", \"seeneens 13\\nWED ADDS wu. .ececcccessssessesessesssesussecsssessssesussesussesussecussecussesussesuss\", \"ecussesussesussesussesussesussecussecussecussesussesussecessesussecusseenesecusseeusseeneaeenees 14\\n\", \"Mobile Back CNS... ececcesessssssssssessesesessecsssussessesucsecsecucsscsessesucsessecsesuesessesuc\", \"sessesussucsessesucaessecueaucsecsecucaecaecucaessecnessaeeneeneneens 14\\nInternet OF THINGS (lOT) wc\", \". ccecsessessesesssssesssesssssessssssecucssssssssucsessesussussecsesussessecussussecsssussessecusse\", \"ssecsssussessecucsessecnssessseseeneaeess 15\\nServerless architecture CONSIGELFAtTIONS ue. cecessesse\", \"ssesessessessesessecsessesecsecsescsecnesscsessecuesscsecsesucaessesucsucsessecueaeeneeueateaeeneene\", \"ass 16\\n\\nMAanaGING State oo. cccccessessssessssessssessssesessessssesessesesssssssesessesessssesssses\", \"ssssssssessssessssessssessssessssessssecessesuesecessesesseensseeeeseensaeenees 16\\nLONG-FUNNING PLOC\", \"ESSES.......ccssesessesessesessesessesessesessesessesessesessesessesessssessesesssssssssessesesseses\", \"ussesussecussecsesecessesuesecessecesseensseeneas 16\\nStArtUP TIME... ceecccessssssesessessssssessese\", \"ssesessesussesussesussesussesussesussesussesussesussessesesusseaussessesesussesucsesussesussecussece\", \"sseaueseessseeeeseeneaeenees 17\\nDatabase UPCates ANd MIGKAtiONS ou... .eessssessessssesssesessessssc\", \"sessesessessssssessssessesessssessssessesessssecessessssesesseeesseeesseensseenees 17\\nSCALING .o.ces\", \"esesessessesesscsessesesscsessesssesussesussesussesucsesussessssesussesussesussesussesussesussessese\", \"sussesussessssesuesesucsesussesussecsssesessesussecesseeueseeesseeneas 17\\nMONItOFING, traACING, ANG \", \"IOGGING........cecessssssssessesessesessesessesessesesscsessesessesessesessesessesessesesuesecessecs\", \"esesessesesseeesseeesseeneseenees 18\\nINTELr-SEPVICE CEPENCEN CIES .......esessessssessesessesssseses\", \"sesessesessesessesesscssscsssesssesussesessesessesessssesussecnssessesecessesesseensseeesseensseenee\", \"s 18\\n\\nContents\\nManaging failure ANd Providing Fe@SHI@NCY uo... ececccsessessesssessessececsessesscse\", \"ssessecussessssscsssessecessesseesesesseeseeeseeseeneeeesee 18\\n\\nVersioning and green/blue GeployMe n\", \"t........ccescsessessssessssessssesessessssessssesessesessessssesessessssesessesessesesseeessesessee\", \"eeseeess 19\\nServer less GESIGN OXAMPIES ......c.cccssessssessesessssessesessecssecsssessssessssecuss\", \"essssesussessssessssecsesecussesussesussessesessseesseaesaesesseessseeesseeess 19\\nSCHECUIING o..e.es\", \"escessssessssesesessesessesessesessesssesussesussesscsesussesussesussesussesussessssessesesuesesusse\", \"sussesussesussesussesussecussecussecusseessseeseseansseenees 19\\nCommand and Query Responsibility Seg\", \"regation (CQRS) ...cecesssssssssessesssessssesessesessessssesessesesssseeseseeseseeseees 19\\nEV@Nt-Da\", \"Sed PrOoCeSSiNG o....cccssscssssesessesessessssessssesessesessesessesessesessesessssessssessssessese\", \"ssssessssessssecussecsssessesecesseseesecesseeesseensseenees 20\\nFile triggers ANd tranSfOrMatiONS...\", \"......cccceccssessecsesessessecessessesscsssssssecccsessssssssseesecessesseescsussesseceesesseeseses\", \"sesseeteseeseeneeeesee 20\\nAsynchronous background processing ANd MESSAGING .......sessssessssesssses\", \"essesessesessesessecsssesessesessesessesessesesseeesseeess 21\\nWeb Apps And APIS ......ceccssesessese\", \"ssessssessssesessesssesssesussesussesussessesesussesussesussesussessssesussesussessesesussesussesuss\", \"esussessseeesaeeesseaeeseeess 21\\nData PIPELINE... eesesessessssessssesessesessesessesessssessesesses\", \"ssesessssessssssssessssessesssssssesessssessssesussesussecessecessesessesessesnsseensaeensseenees 22\", \"\\nStrEAM PLOCESSING ...ecececcessssessssessesessesessesessesessesussessssesussesussesussessssesussess\", \"esessssesussessssessssesucsesussesusseaussecesseceeseansseeseseensaeenees 22\\nAPI Gateway uu... eeecs\", \"cssssssssssssssesesesessssssesesesssessssesesesesssesnesesesesesusuesesesesesesssussesesesesesususse\", \"sesesesesussesesesesesecueseseseseseseeneaeseseneaeenens 23\\nRECOMMENCET FESOUICES .......ecsessesses\", \"seseesessecsesessecsesscsessecscsessecucsucsessecuesecsessesucsecsecuesucsessecucaessecuesecsecsesea\", \"eeaesenteneeneeneaees 23\\nAZUre Serverless PlatfOriM .....cccccscssssessesssessessssessssessessssesse\", \"sssessssessesussessessssessssessesussessesessecsssessesusaesneseeseessseenees 24\\nAZULE FUNCTIONS ou.\", \" .ceseseesessessesseseesessesscsessecnecucsessecucsscsecsesucsscsesucsucsesuesucsecsesucsucsessesucs\", \"essecuesuesecnesucaessecuesecsesnesueaesseeeneeaeeneaeaes 24\\nPrograMMING lANGUAGE SUPPOSE ou... .eee\", \"scssessesessessssesessesessesessesessssessesessesessesessssessesessesecsesecessecsssesesseseeseeesse\", \"eesseeneseenees 25\\nAPP SEPVICE PLANS .....eescesessesessessssesessesessesssesussessssessesesussesuss\", \"esussesussessssesussessssesussesussesussessssesussesussesessesussesesseeessesesseeeeseeess 25\\nCreate\", \" YOU FIPSt FUNCTION oo. cececcessessessssessessssessessecucsessessssussecsscussessecussussessssusses\", \"secussussesuesussessesussessecuesusseeseaessesseensaneass 25\\nUnderstand triggers And DININGS .......\", \"ccecessssesssssssesssessssssesscsesscsessesessesesscsessssessesesussessssecussecsesecessesessecussee\", \"nsseensseenees 26\\nTelemetry with Application INSIGNHS oc ccsessesessesessesessessssssessscssecsssese\", \"ssecsssecessecessesessecessecessesessecessecessecusseeesseensaeenees 2/7\\nAZULE LOGIC APPS .u...esess\", \"esessessssssessesssessesesussesucsesussecussesussecussesussesussesussesussesussesussecussesussesusse\", \"sussecussecussecussecessesnesecusseeueseeseaeeneas 29\\nEVONt Grid ane.ceseecessessessssessessesesesse\", \"cscsssecsesusssssecucsucsecsesucsscsesuesucaecsesuesecsecuesucsessesucsessesucsucsessesucsssecuesscs\", \"ecuesucaesaeeucsesseeneseaeeneeneseens 31\\nSCOMAL IOS... ecessessssessessecsesesessesscsessecscsscscn\", \"esucsscsesucsucsesnesucsecsesuesucsessesucsecsesuesucsecsesueascsecsesussecsesucsucsecuesucsessesucs\", \"esaesneseeaeeneeneasens 32\\nEvent Grid vs. other AZUre MESSAGING SEFVICES ......csesessessssessssesse\", \"sessesessesessesessesesscsessesecussecsesesessesussecnsseensseensaeenees 33\\nPerformance tarets......\", \".ccccccecsessssssssssesssessessesessssssssssessessecussessssussusssssscussessecussussessecussssesscs\", \"ussessecussesseesesesseeseaneseeseeneaeeaess 34\\nEVent Grid SCHEMA Qu... eeeecessessessesssseesessess\", \"csessecscsesecuecucsessesucsucsesuesuesessecuesucsessesucsesnecucsussessecussessecucsesaecnesueaesae\", \"eeneeaeeneeeaees 34\\nAZULE FESOUICES oo... eeeeesesssssesesececsescscsesesscscscscscsescucucucssscses\", \"esucusucacsesesecucucucscaesesusecucasscaesesusucucasscaeaesecucusscacseeesecececseacaeeeeeees 35\\nCO\", \"NCIUSION oo. eeeeseesessessessesseseesessesscsecsecscsecsecscsscsecuesucsecsecucsucsesuesussessecues\", \"scsesuesuessnecucassecuesucsesuesuesecsecuesucsecuesucsesnecueneeneeneaneass 36\\nRECOMMENCET FESOUICE\", \"S .......ecsessessesseseesessecsesessecsesscsessecscsessecucsucsessecuesecsessesucsecsecuesucsessecu\", \"caessecuesecsecseseaeeaesenteneeneeneaees 36\\nDurable AZUre FUNCTIONS uu... eeecececsssessesesesessss\", \"essssesssecucsesesuesessssesussessssessssssesusseeucaesessesecsssesuesesessssesusseessaeeseaeasens 3\", \"7\\nTriggering a StatefUl WOrKIOW...... ec ccecsesssssesessessecscsessessesssessecscsussessesucsessseu\", \"ssussessecussessesussucsessecussesseencausseeseeneseeaeeneaeesess 37\\nWorking with the Orchestration \", \"CHEN... cceesessesessessssesessesessesessesessesessesessesssesessecessesessesesseeessesessesessesess\", \"eeeeseeess 37\\n\\nii Contents\\nThe Orchestrator FUNCTION .....cccccccccccsscsceccsceccsceccsccscsscscesc\", \"scescscescscescsecscsccscsccscsccsecscsscscsscsesscseescsecscsecsesecaesacaeeacaecseaeeacess 38\\n\\nThe\", \" ACtiVity FUNCTIONS... ececcccesesesessessesscsessessesessessssucssssecsesussessecussussessscussssse\", \"eussusseenssussesseausseeseescsussessesessesseensseeseeneeesaees 39\\nRECOMMENCE FESOUICES ......ccccs\", \"essssssesesssesesscscscsesescssescscscssscssssesescscscsessessscssscscsssssescssscsesssussescscacscs\", \"esssesescacseseseeeesescacseseaes 39\\nOrchestration Patterns 0... cccecsccessessssessssessssessssesss\", \"sesessessssesessesssesessessssssessesesseseesesssessssessssesssesesecesseseesessesesesseeesseeeeseee\", \"ss 39\\n\\nFUNCTION CHAINING......e.cecessesessesessesessesessesessesessesussesessesussesussesussesssess\", \"ssesessesussesussssucsesssesesussesuesecussecuesesussesussesneseensseensaeenees 40\\n\\nASYNCHLONOUS HTT\", \"P APIS uuu. .ecesscsessesessesessesessesessesssesussesussesussesussesussessssesussesussessssesussesu\", \"ssesussesussesussesessesesseeesseeesseeesseeess 40\\n\\nMOMNICOSING .....eesesscsessesesscssssesessessse\", \"sessesssesussessssesussesussesussesussessssesussesscsssucsesucsssussssucsesussesesuesecussecusseenes\", \"esussesuesecesseeusseensseenees 41\\n\\nRECOMMENCEA LFESOUICES ...c.ccccsssssesessssescsesesesssscscscse\", \"sescssescscscscscssssescscscsesssssescscscscsesessscscscscsesessescacscacseseeseseacacscseseeseess A\", \"2\\n\\nServerless DUSINESS SCENALIOS ANC USE CASES ......ccescssssesescsesssssssscsescscsescssssescsescs\", \"escscssescscscsescseseseseacsescseaeees 43\\nBig. data PrOCESSING........sessssessssesessessssesessess\", \"ssesessesssesussesussessssesussessssessssessssesussessssessssessssesessesussesussesussesssesessesess\", \"esesseaeeseseeneess 43\\nCreate serverless applications: NANAS-ON lab uu... esesesesessesessesessesess\", \"esessesessesessesssesssesessesessesesseseeseeesseessseeesseeess 43\\nCUSTOMED FOVIQWS......cccccsscsss\", \"sscsescsssscscscsesessscsescscsesesssssscscscssssssscscacscssasssescssscsssssesescscscsssssssescscac\", \"sesssssscacacacseseseesesescscseseeeeess 43\\nFil\\u20ac PrOCESSING ANC VALIDATION ou... eeessesessesesseses\", \"sessssecssesssesssesussessssesussessssessssessssesussesussesussesssesessesessesessesesseaeeseseeneen\", \"s 44\\nGaMe Cata VISUALIZATION oo... eeeccscssesesesesessssescsesesesesscscscsesesesssscscscsescsssses\", \"cscscsescssssescscscscsussesescscscsesseescscscacseseseesescscseseseeeeees 44\\n(CT) 0) | \\u00a9) Rete ee e\", \"ee 44\\nInternet of Things (IOT) reliable Cdge relay oo... cccececsssessessessssssssesesessssseesssess\", \"eesssessessesussesseesssesseeseenssesseesssesseeseeneseess 44\\nMicroservices reference ALChiteCtUre .\", \"..ccccccccccsessscssssssesssscsesssscsesssssscsesscscsesscsesesscsesesssscsesecscsesesssscseeesseses\", \"eeseseseesesesess 44\\nServer less fOr MODINE wo... cccesecsssessssesessescsesssscsescssesesesscsesssc\", \"scsesscscscsssscsesesscssssscsesesecsssesecacsesscscsssesscsesesscscsesecsesesecscseseesees 45\\nSErVE\", \"rl@SS MESSAGING ...sssessssesssssesssessesesesscsecsesesscsesussecussecussesussecussesussesussesusse\", \"sussessesecussecsssesussesussesueseausseeusseeessesesseeesaeensseeess 45\\nRECOMMENCE FESOUICES ......\", \"ccccsessssssesesssesesscscscsesescssescscscssscssssesescscscsessessscssscscsssssescssscsesssussescsc\", \"acscsesssesescacseseseeeesescacseseaes 45\\n\\nCONCIUSION....c.ccccsescssssesescscsesesssscscscsescscsss\", \"scscscsescscssssesesssescscsuscesssenessscssssessscssssacsessecssssescacsescsesssseseasseacsesessese\", \"aeaeacseaeees 46\\n\\nContents\\nCHAPTER\\n\\nArchitecture approacnes\\n\\nUnderstanding existing approaches to ar\", \"chitecting enterprise apps helps clarify the role played by\\nserverless. There are many approaches an\", \"d patterns that evolved over decades of software\\ndevelopment, and all have their own pros and cons. \", \"In many cases, the ultimate solution may not\\ninvolve deciding on a single approach but may integrate\", \" several approaches. Migration scenarios\\noften involve shifting from one architecture approach to an\", \"other through a hybrid approach.\\n\\nThis chapter provides an overview of both logical and physical arc\", \"hitecture patterns for enterprise\\napplications.\\n\\nArchitecture patterns\\n\\nModern business applications\", \" follow a variety of architecture patterns. This section represents a survey\\nof common patterns. The\", \" patterns listed here aren't necessarily all best practices, but illustrate\\ndifferent approaches.\\n\\nF\", \"or more information, see Azure application architecture guide.\\n\\nMonoliths\\n\\nMany business application\", \"s follow a monolith pattern. Legacy applications are often implemented as\\nmonoliths. In the monolith\", \" pattern, all application concerns are contained in a single deployment.\\nEverything from user interf\", \"ace to database calls is included in the same codebase.\\n\\n1 CHAPTER 1 | Architecture approaches\\nMonol\", \"ith\\n\\nThere are several advantages to the monolith approach. It\\u2019s often easy to pull down a single co\", \"de\\nbase and start working. Ramp up time may be less, and creating test environments is as simple as\\n\", \"providing a new copy. The monolith may be designed to include multiple components and\\napplications.\\n\", \"\\nUnfortunately, the monolith pattern tends to break down at scale. Major disadvantages of the\\nmonoli\", \"th approach include:\\n\\n. Difficult to work in parallel in the same code base.\\n\\n. Any change, no matte\", \"r how trivial, requires deploying a new version of the entire application.\\n\\n. Refactoring potentiall\", \"y impacts the entire application.\\n\\n. Often the only solution to scale is to create multiple, resourc\", \"e-intensive copies of the monolith.\\n. As systems expand or other systems are acquired, integration c\", \"an be difficult.\\n\\n. It may be difficult to test due to the need to configure the entire monolith.\\n\\n.\", \" Code reuse is challenging and often other apps end up having their own copies of code.\\n\\nMany busine\", \"sses look to the cloud as an opportunity to migrate monolith applications and at the\\n\\nsame time refa\", \"ctor them to more usable patterns. It\\u2019s common to break out the individual\\napplications and componen\", \"ts to allow them to be maintained, deployed, and scaled separately.\\n\\nN-Layer applications\\nN-layer ap\", \"plication partition application logic into specific layers. The most common layers include:\\n\\n\\u00b0 User \", \"interface\\n. Business logic\\ne Data access\\n\\n2 CHAPTER 1 | Architecture approaches\\nOther layers may inc\", \"lude middleware, batch processing, and API. It's important to note the layers are\\nlogical. Although \", \"they're developed in isolation, they may all be deployed to the same target platform.\\n\\nUl Layer\\n\\n\\u00a2 W\", \"eb Pages\\n\\u00a2 Mobile App\\n\\nBusiness Logic Layer\\n\\n\\u00a2 APIs\\n\\u00a2 Validations\\n\\nData Access Layer\\n\\n\\u00a2 Cache\\n\\u00a2 Data\", \"base access\\n\\nThere are several advantages to the N-Layer approach, including:\\n\\n. Refactoring is isol\", \"ated to a layer.\\n\\n. Teams can independently build, test, deploy, and maintain separate layers.\\n\\n. La\", \"yers can be swapped out, for example the data layer may access multiple databases without\\nrequiring \", \"changes to the UI layer.\\n\\nServerless may be used to implement one or more layers.\\n\\nMicroservices\\n\\nMi\", \"croservices architectures contain common characteristics that include:\\n\\n. Applications are composed \", \"of several small services.\\n\\n. Each service runs in its own process.\\n\\n. Services are aligned around b\", \"usiness domains.\\n\\n. Services communicate over lightweight APIs, typically using HTTP as the transpor\", \"t.\\n\\n. Services can be deployed and upgraded independently.\\n\\n. Services aren't dependent on a single \", \"data store.\\n\\n. The system is designed with failure in mind, and the app may still run even when cert\", \"ain services\\nfail.\\n\\nMicroservices don't have to be mutually exclusive to other architecture approach\", \"es. For example, an\\nN-Tier architecture may use microservices for the middle tier. It's also possibl\", \"e to implement\\n\\n3 CHAPTER 1 | Architecture approaches\\nmicroservices in a variety of ways, from virtu\", \"al directories on IIS hosts to containers. The characteristics\\nof microservices make them especially\", \" ideal for serverless implementations.\\n\\nBrowser Web Server API Gate a\\n\\nThe pros of microservices arc\", \"hitectures include:\\n\\n\\u00b0 Refactoring is often isolated to a single service.\\n\\n. Services can be upgrade\", \"d independently of each other.\\n\\n\\u00b0 Resiliency and elasticity can be tuned to the demands of individua\", \"l services.\\n\\u00b0 Development can happen in parallel across disparate teams and platforms.\\n. It's easier\", \" to write comprehensive tests for isolated services.\\n\\nMicroservices come with their own challenges, \", \"including:\\n\\n\\u00b0 Determining what services are available and how to call them.\\n\\n\\u00b0 Managing the lifecycl\", \"e of services.\\n\\n. Understanding how services fit together in the overall application.\\n. Full system \", \"testing of calls made across disparate services.\\n\\nUltimately there are solutions to address all of t\", \"hese challenges, including tapping into the benefits of\\nserverless that are discussed later.\\n\\nArchit\", \"ecture deployment approaches\\n\\nRegardless of the architecture approach used to design a business appl\", \"ication, the implementation, or\\ndeployment of those applications may vary. Businesses host applicati\", \"ons on everything from physical\\nhardware to serverless functions.\\n\\n4 CHAPTER 1 | Architecture approa\", \"ches\\nN-Tier applications\\n\\nThe N-Tier architecture pattern is a mature architecture and simply refers\", \" to applications that separate\\nvarious logical layers into separate physical tiers. N-Tier architect\", \"ure is a physical implementation of\\nN-Layer architecture. The most common implementation of this arc\", \"hitecture includes:\\n\\n. A presentation tier, for example a web app.\\n\\u00b0 An API or data access tier, suc\", \"h as a REST API.\\n\\u00b0 A data tier, such as a SQL database.\\n\\nDatabase\\nServer / Backend\\n\\nWeb\\nBrowser\\n\\nN-t\", \"ier solutions have the following characteristics:\\n\\n. Projects are typically aligned with tiers.\\n\\u00b0 Te\", \"sting may be approached differently by tier.\\n\\n. Tiers provide layers of abstraction, for example the\", \" presentation tier is typically ignorant of the\\nimplementation details of the data tier.\\n\\n\\u00b0 Typicall\", \"y, layers only interact with adjacent layers.\\n. Releases are often managed at the project, and there\", \"fore tier, level. A simple API change may\\nrequire a new release of an entire middle tier.\\n\\nThis appr\", \"oach provides several benefits, including:\\n\\n. Isolation of the database (often the front end doesn't\", \" have direct access to the database back\\nend).\\n. Reuse of the API (for example, mobile, desktop, and\", \" web app clients can all reuse the same APIs).\\n\\n5 CHAPTER 1 | Architecture approaches\\n. Ability to s\", \"cale out tiers independent of each other.\\n\\n. Refactoring isolation: one tier may be refactored witho\", \"ut impacting other tiers.\\n\\nOn-premises and Infrastructure as a Service (laaS)\\n\\nThe traditional appro\", \"ach to hosting applications requires buying hardware and managing all of the\\nsoftware installations,\", \" including the operating system. Originally this involved expensive data centers\\nand physical hardwa\", \"re. The challenges that come with operating physical hardware are many,\\nincluding:\\n\\n. The need to bu\", \"y excess for \\u201cjust in case\\u201d or peak demand scenarios.\\n. Securing physical access to the hardware.\\n\\n.\", \" Responsibility for hardware failure (such as disk failure).\\n\\n. Cooling.\\n\\n. Configuring routers and \", \"load balancers.\\n\\n. Power redundancy.\\n\\n\\u00b0 Securing software access.\\n\\nWeb\\nserver\\n\\nAPI\\nserver\\n\\nLoad Load\", \" Database\\n\\nbalancer balancer\\n\\ncluster\\n\\nBrowser\\n\\nWeb\\nserver\\n\\nAP|\\nserver\\n\\nVirtualization of hardware, \", \"via \\u201cvirtual machines\\u201d enables Infrastructure as a Service (laaS). Host\\nmachines are effectively par\", \"titioned to provide resources to instances with allocations for their own\\nmemory, CPU, and storage. \", \"The team provisions the necessary VMs and configures the associated\\nnetworks and access to storage.\\n\", \"\\nFor more information, see virtual machine N-tier reference architecture.\\n\\nAlthough virtualization a\", \"nd Infrastructure as a Service (laaS) address many concerns, it still leaves\\nmuch responsibility in \", \"the hands of the infrastructure team. The team maintains operating system\\nversions, applies security\", \" patches, and installs third-party dependencies on the target machines. Apps\\noften behave differentl\", \"y on production machines compared to the test environment. Issues arise due\\nto different dependency \", \"versions and/or OS SKU levels. Although many organizations deploy N-Tier\\napplications to these targe\", \"ts, many companies benefit from deploying to a more cloud native model\\n\\n6 CHAPTER 1 | Architecture a\", \"pproaches\\nsuch as Platform as a Service. Architectures with microservices are more challenging becau\", \"se of the\\nrequirements to scale out for elasticity and resiliency.\\n\\nFor more information, see virtua\", \"l machines.\\n\\nPlatform as a Service (PaaS)\\n\\nPlatform as a Service (PaaS) offers configured solutions \", \"that developers can plug into directly. PaaS is\\nanother term for managed hosting. It eliminates the \", \"need to manage the base operating system,\\nsecurity patches and in many cases any third-party depende\", \"ncies. Examples of platforms include web\\napplications, databases, and mobile back ends.\\n\\nPaaS addres\", \"ses the challenges common to laaS. PaaS allows the developer to focus on the code or\\ndatabase schema\", \" rather than how it gets deployed. Benefits of PaaS include:\\n\\n. Pay for use models that eliminate th\", \"e overhead of investing in idle machines.\\n\\n\\u00b0 Direct deployment and improved DevOps, continuous integ\", \"ration (Cl), and continuous delivery\\n(CD) pipelines.\\n\\n. Automatic upgrades, updates, and security pa\", \"tches.\\n\\n. Push-button scale out and scale up (elastic scale).\\n\\nThe main disadvantage of PaaS traditi\", \"onally has been vendor lock-in. For example, some PaaS\\n\\nproviders only support ASP.NET, Node.js, or \", \"other specific languages and platforms. Products like\\n\\nAzure App Service have evolved to address mul\", \"tiple platforms and support a variety of languages and\\n\\nframeworks for hosting web apps.\\n\\nGoetet\\n\\nBr\", \"owser Static Website REST API Database\\nService \\\\, / Service Service\\n\\nService Infrastucture Database \", \"Infrastucture\\n\\nManaged by Host / Transparent to Consumer\\n\\nSoftware as a Service (SaaS)\\n\\nSoftware as \", \"a Service or SaaS is centrally hosted and available without local installation or\\nprovisioning. SaaS\", \" often is hosted on top of PaaS as a platform for deploying software. SaaS provides\\nservices to run \", \"and connect with existing software. SaaS is often industry and vertical specific. SaaS is\\noften lice\", \"nsed and typically provides a client/server model. Most modern SaaS offerings use web-\\n\\n7 CHAPTER 1 \", \"| Architecture approaches\\nbased apps for the client. Companies typically consider SaaS as a business\", \" solution to license\\nofferings. It isn\\u2019t often implemented as architecture consideration for scalabi\", \"lity and maintainability of\\nan application. Indeed, most SaaS solutions are built on laaS, PaaS, and\", \"/or serverless back ends.\\n\\nLearn more about SaaS through a sample application.\\n\\nContainers and Funct\", \"ions as a Service (FaaS)\\n\\nContainers are an interesting solution that enables PaaS-like benefits wit\", \"hout the laaS overhead. A\\ncontainer is essentially a runtime that contains the bare essentials neede\", \"d to run a unique application.\\nThe kernel or core part of the host operating system and services suc\", \"h as storage are shared across a\\nhost. The shared kernel enables containers to be lightweight (some \", \"are mere megabytes in size,\\ncompared to the gigabyte size of typical virtual machines). With hosts a\", \"lready running, containers can\\nbe started quickly, facilitating high availability. The ability to sp\", \"in up containers quickly also provides\\nextra layers of resiliency. Docker is one of the more popular\", \" implementations of containers.\\n\\nBenefits of containers include:\\n\\n. Lightweight and portable\\n\\n\\u00b0 Self\", \"-contained so no need to install dependencies\\n\\n. Provide a consistent environment regardless of the \", \"host (runs exactly same on a laptop as ona\\ncloud server)\\n\\n. Can be provisioned quickly for scale-out\", \"\\n\\n. Can be restarted quickly to recover from failure\\n\\nA container runs on a container host (that in \", \"turn may run on a bare metal machine or a virtual\\nmachine). Multiple containers or instances of the \", \"same containers may run on a single host. For true\\nfailover and resiliency, containers must be scale\", \"d across hosts.\\n\\nFor more information about Docker containers, see What is Docker.\\n\\nManaging contain\", \"ers across hosts typically requires an orchestration tool such as Kubernetes.\\nConfiguring and managi\", \"ng orchestration solutions may add additional overhead and complexity to\\nprojects. Fortunately, many\", \" cloud providers provide orchestration services through PaaS solutions to\\nsimplify the management of\", \" containers.\\n\\nThe following image illustrates an example Kubernetes installation. Nodes in the insta\", \"llation address\\nscale out and failover. They run Docker container instances that are managed by the \", \"primary server.\\nThe kubelet is the client that relays commands from Kubernetes to Docker.\\n\\n8 CHAPTER\", \" 1 | Architecture approaches\\nKubernetes Master Server\\n\\nScheduler Controller\\n\\nKubernetes Node Kuberne\", \"tes Node\\n\\nDocker Docker\\n\\nKubelet Kubelet\\n\\nFor more information about orchestration, see Kubernetes o\", \"n Azure.\\n\\nFunctions as a Service (FaaS) is a specialized container service that is similar to server\", \"less. A specific\\nimplementation of FaaS, called OpenFaa&, sits on top of containers to provide serve\", \"rless capabilities.\\nOpenFaaS provides templates that package all of the container dependencies neces\", \"sary to run a piece\\nof code. Using templates simplifies the process of deploying code as a functiona\", \"l unit. OpenFaaS\\ntargets architectures that already include containers and orchestrators because it \", \"can use the existing\\ninfrastructure. Although it provides serverless functionality, it specifically \", \"requires you to use Docker\\nand an orchestrator.\\n\\nServerless\\n\\nA serverless architecture provides a cl\", \"ear separation between the code and its hosting environment.\\nYou implement code in a function that i\", \"s invoked by a trigger. After that function exits, all its needed\\nresources may be freed. The trigge\", \"r might be manual, a timed process, an HTTP request, or a file\\nupload. The result of the trigger is \", \"the execution of code. Although serverless platforms vary, most\\nprovide access to pre-defined APIs a\", \"nd bindings to streamline tasks such as writing to a database or\\nqueueing results.\\n\\nServerless is an\", \" architecture that relies heavily on abstracting away the host environment to focus on\\ncode. It can \", \"be thought of as less server.\\n\\nContainer solutions provide developers existing build scripts to publ\", \"ish code to serverless-ready\\nimages. Other implementations use existing PaaS solutions to provide a \", \"scalable architecture.\\n\\nThe abstraction means the DevOps team doesn't have to provision or manage se\", \"rvers, nor specific\\ncontainers. The serverless platform hosts code, either as script or packaged exe\", \"cutables built with a\\nrelated SDK, and allocates the necessary resources for the code to scale.\\n\\nThe\", \" following diagram illustrates four serverless components. An HTTP request causes the Checkout\\nAPI c\", \"ode to run. The Checkout API inserts code into a database, and the insert triggers several other\\nfun\", \"ctions to run to perform tasks like computing tasks and fulfilling the order.\\n\\n9 CHAPTER 1 | Archite\", \"cture approaches\\n\\u2014)\\u2014 BF\\n\\nHTTP Trigger | Checkout AP| | Database w/\\n\\n<2 b\\n\\nTax Computation Payment Pr\", \"ocessing Order Fulfillment\\n\\nThe advantages of serverless include:\\n\\n\\u00b0 High density. Many instances of\", \" the same serverless code can run on the same host compared\\nto containers or virtual machines. The i\", \"nstances scale across multiple hosts addressing scale out\\nand resiliency.\\n\\n. Micro-billing. Most ser\", \"verless providers bill based on serverless executions, enabling massive\\ncost savings in certain scen\", \"arios.\\n\\n. Instant scale. Serverless can scale to match workloads automatically and quickly.\\n\\n. Faste\", \"r time to market. Developers focus on code and deploy directly to the serverless platform.\\n\\nComponen\", \"ts can be released independently of each other.\\n\\nServerless is most often discussed in the context o\", \"f compute, but can also apply to data. For example,\\nAzure SQL and Cosmos DB both provide cloud datab\", \"ases that don\\u2019t require you to configure host\\nmachines or clusters. This book focuses on serverless \", \"compute.\\n\\nSummary\\n\\nThere's a broad spectrum of available choices for architecture, including a hybri\", \"d approach. Serverless\\nsimplifies the approach, management, and cost of application features at the \", \"expense of control and\\nportability. However, many serverless platforms do expose configuration to he\", \"lp fine-tune the\\nsolution. Good programming practices can also lead to more portable code and less s\", \"erverless\\nplatform lock-in. The following table illustrates the architecture approaches side by side\", \". Choose\\nserverless based on your scale needs, whether or not you want to manage the runtime, and ho\", \"w well\\nyou can break your workloads into small components. You'll learn about potential challenges w\", \"ith\\nserverless and other decision points in the next chapter.\\n\\n[sae [ww sone [acon\\n[abeacts [Hardwar\", \"e [Ration [os ost | Runtime\\n[une [vw [reer [age [code\\n\\n10 CHAPTER 1 | Architecture approaches\\n\\n[cont\", \"ainer [Serves\\nMilliseconds\\nto Minutes\\n\\nResponsibility | Applications, Applications and _ | Applicati\", \"ons, Function\\ndependencies, runtime, | dependencies dependencies, and\\nand operating system runtime\\n\\n\", \". Scale refers to the unit that is used to scale the application\\n\\n. Abstracts refers to the layer th\", \"at is abstracted by the implementation\\n. Unit refers to the scope of what is deployed\\n\\n. Lifetime re\", \"fers to the typical runtime of a specific instance\\n\\n\\u00b0 Responsibility refers to the overhead to build\", \", deploy, and maintain the application\\n\\nThe next chapter will focus on serverless architecture, use \", \"cases, and design patterns.\\n\\nRecommended resources\\n\\n\\u00b0 Azure application architecture guide\\n\\u00b0 Azure C\", \"osmos DB\\n\\n\\u00b0 Azure SQL\\n\\n: N-Tier architecture pattern\\n. Kubernetes on Azure\\n\\n. Microservices\\n\\n\\u00b0 Virtu\", \"al machine N-tier reference architecture\\n\\u00b0 Virtual machines\\n\\u00b0 What is Docker?\\n\\n\\u00b0 Wingtip Tickets Saa\", \"S application\\n\\n11 CHAPTER 1 | Architecture approaches\\nCHAPTER\\n\\nServerless architecture\\n\\nThere are ma\", \"ny approaches to using serverless architectures. This chapter explores examples of\\ncommon architectu\", \"res that integrate serverless. It also covers concerns that may pose additional\\nchallenges or requir\", \"e extra consideration when implementing serverless. Finally, several design\\nexamples are provided th\", \"at illustrate various serverless use cases.\\n\\nServerless hosts often use an existing container-based \", \"or PaaS layer to manage the serverless\\ninstances. For example, Azure Functions is based on Azure App\", \" Service. The App Service is used to\\nscale out instances and manage the runtime that executes Azure \", \"Functions code. For Windows-based\\nfunctions, the host runs as PaaS and scales out the .NET runtime. \", \"For Linux-based functions, the host\\nleverages containers.\\n\\nFunction\\n\\nFunction Code Configuration\\n\\nLa\", \"nguage Runtime\\n\\nWebJobs Core\\n\\nApp Service\\n\\nThe WebJobs Core provides an execution context for the fu\", \"nction. The Language Runtime runs scripts,\\nexecutes libraries and hosts the framework for the target\", \" language. For example, Node.js is used to\\nrun JavaScript functions and the .NET Framework is used t\", \"o run C# functions. You'll learn more about\\nlanguage and platform options later in this chapter.\\n\\nSo\", \"me projects may benefit from taking an \\u201call-in\\u201d approach to serverless. Applications that rely heavi\", \"ly\\non microservices may implement all microservices using serverless technology. The majority of app\", \"s\\nare hybrid, following an N-tier design and using serverless for the components that make sense\\n\\n12\", \" CHAPTER 2 | Serverless architecture\\nbecause the components are modular and independently scalable. \", \"To help make sense of these\\nscenarios, this section walks through some common architecture examples \", \"that use serverless.\\n\\nFull serverless back end\\n\\nThe full serverless back end is ideal for several ty\", \"pes of scenarios, especially when building new or\\n\\u201cgreen field\\u201d applications. An application with a \", \"large surface area of APIs may benefit from\\nimplementing each API as a serverless function. Apps tha\", \"t are based on microservices architecture are\\nanother example that could be implemented as a full se\", \"rverless back end. The microservices\\ncommunicate over various protocols with each other. Specific sc\", \"enarios include:\\n\\n. API-based SaaS products (example: financial payments processor).\\n\\n\\u00b0 Message-driv\", \"en applications (example: device monitoring solution).\\n\\n. Apps focused on integration between servic\", \"es (example: airline booking application).\\n. Processes that run periodically (example: timer-based d\", \"atabase clean-up).\\n\\n. Apps focused on data transformation (example: import triggered by file upload)\", \".\\n\\n\\u00b0 Extract Transform and Load (ETL) processes.\\n\\nThere are other, more specific use cases that are \", \"covered later in this document.\\n\\nMonoliths and \\u201cstarving the beast\\u201d\\n\\nA common challenge is migrating\", \" an existing monolithic application to the cloud. The least risky\\napproach is to \\u201clift and shift\\u201d en\", \"tirely onto virtual machines. Many shops prefer to use the migration as\\nan opportunity to modernize \", \"their code base. A practical approach to migration Is called \\u201cstarving the\\nbeast.\\u201d In this scenario,\", \" the monolith is migrated \\u201cas is\\u201d to start with. Then, selected services are\\nmodernized. In some cas\", \"es, the signature of the service is identical to the original: it simply is hosted\\nas a function. Cl\", \"ients are updated to use the new service rather than the monolith endpoint. In the\\ninterim, steps su\", \"ch as database replication enable microservices to host their own storage even when\\ntransactions are\", \" still handled by the monolith. Eventually, all clients are migrated onto the new\\nservices. The mono\", \"lith is \\u201cstarved\\u201d (its services no longer called) until all functionality has been\\nreplaced. The com\", \"bination of serverless and proxies can facilitate much of this migration.\\n\\n13 CHAPTER 2 | Serverless\", \" architecture\\n=\\n\\nLegacy\\nWeb API\\n\\nTo learn more about this approach, watch the video: Bring your app \", \"to the cloud with serverless Azure\\nFunctions.\\n\\nWeb apps\\n\\nWeb apps are great candidates for serverles\", \"s applications. There are two common approaches to web\\napps today: server-driven, and client-driven \", \"(such as Single Page Application or SPA). Server-driven\\nweb apps typically use a middleware layer to\", \" issue API calls to render the web UI. SPA applications\\nmake REST API calls directly from the browse\", \"r. In both scenarios, serverless can accommodate the\\nmiddleware or REST API request by providing the\", \" necessary business logic. A common architecture is\\nto stand up a lightweight static web server. The\", \" Single Page Application (SPA) serves HTML, CSS,\\nJavaScript, and other browser assets. The web app t\", \"hen connects to a microservices back end.\\n\\nMobile back ends\\n\\nThe event-driven paradigm of serverless\", \" apps makes them ideal as mobile back ends. The mobile\\ndevice triggers the events and the serverless\", \" code executes to satisfy requests. Taking advantage of a\\nserverless model enables developers to enh\", \"ance business logic without having to deploy a full\\napplication update. The serverless approach also\", \" enables teams to share endpoints and work in\\nparallel.\\n\\nMobile developers can build business logic \", \"without becoming experts on the server side. Traditionally,\\nmobile apps connected to on-premises ser\", \"vices. Building the service layer required understanding the\\nserver platform and programming paradig\", \"m. Developers worked with operations to provision servers\\n\\n14 CHAPTER 2 | Serverless architecture\\nan\", \"d configure them appropriately. Sometimes days or even weeks were spent on building a\\ndeployment pip\", \"eline. All of these challenges are addressed by serverless.\\n\\nServerless abstracts the server-side de\", \"pendencies and enables the developer to focus on business\\nlogic. For example, a mobile developer who\", \" builds apps using a JavaScript framework can build\\nserverless functions with JavaScript as well. Th\", \"e serverless host manages the operating system, a\\nNode.js instance to host the code, package depende\", \"ncies, and more. The developer is provided a\\nsimple set of inputs and a standard template for output\", \"s. They then can focus on building and testing\\nthe business logic. They're therefore able to use exi\", \"sting skills to build the back-end logic for the\\nmobile app without having to learn new platforms or\", \" become a \\u201cserver-side developer.\\u201d\\n\\nS&S\\n\\n(Pp i> we\\n\\nWebHook called Stores in blob storage Produces s\", \"caled images\\n\\nPhoto taken and\\n\\nMost cloud providers offer mobile-based serverless products that simp\", \"lify the entire mobile\\ndevelopment lifecycle. The products may automate the provisioning of database\", \"s to persist data,\\nhandle DevOps concerns, provide cloud-based builds and testing frameworks and the\", \" ability to script\\nbusiness processes using the developer's preferred language. Following a mobile-c\", \"entric serverless\\napproach can streamline the process. Serverless removes the tremendous overhead of\", \" provisioning,\\nconfiguring, and maintaining servers for the mobile back end.\\n\\nInternet of Things (lo\", \"T)\\n\\nloT refers to physical objects that are networked together. They're sometimes referred to as\\n\\u201cco\", \"nnected devices\\u201d or \\u201csmart devices.\\u201d Everything from cars and vending machines may be\\nconnected and \", \"send information ranging from inventory to sensor data such as temperature and\\nhumidity. In the ente\", \"rprise, loT provides business process improvements through monitoring and\\nautomation. loT data may b\", \"e used to regulate the climate in a large warehouse or track inventory\\nthrough the supply chain. loT\", \" can sense chemical spills and call the fire department when smoke is\\ndetected.\\n\\nThe sheer volume of\", \" devices and information often dictates an event-driven architecture to route and\\nprocess messages. \", \"Serverless is an ideal solution for several reasons:\\n\\n. Enables scale as the volume of devices and d\", \"ata increases.\\n. Accommodates adding new endpoints to support new devices and sensors.\\n\\n\\u00b0 Facilitate\", \"s independent versioning so developers can update the business logic for a specific\\ndevice without h\", \"aving to deploy the entire system.\\n\\n\\u00b0 Resiliency and less downtime.\\n\\n15 CHAPTER 2 | Serverless archi\", \"tecture\\nThe pervasiveness of loT has resulted in several serverless products that focus specifically\", \" on loT\\nconcerns, such as Azure loT Hub. Serverless automates tasks such as device registration, pol\", \"icy\\nenforcement, tracking, and even deployment of code to devices at the edge. The edge refers to\\nde\", \"vices like sensors and actuators that are connected to, but not an active part of, the Internet.\\n\\nSe\", \"rverless architecture considerations\\n\\nAdopting a serverless architecture does come with certain chal\", \"lenges. This section explores some of\\nthe more common considerations to be aware of. All of these ch\", \"allenges have solutions. As with all\\narchitecture choices, the decision to go serverless should be m\", \"ade only after carefully considering the\\npros and cons. Depending on the needs of your application, \", \"you may decide a serverless\\nimplementation isn't the right solution for certain components.\\n\\nManagin\", \"g state\\n\\nServerless functions, as with microservices in general, are stateless by default. Avoiding \", \"state enables\\nserverless to be ephemeral, to scale out, and to provide resiliency without a central \", \"point of failure. In\\nsome circumstances, business processes require state. If your process requires \", \"state, you have two\\noptions. You can adopt a model other than serverless, or interact with a separat\", \"e service that provides\\nstate. Adding state can complicate the solution and make it harder to scale,\", \" and potentially create a\\nsingle point of failure. Carefully consider whether your function absolute\", \"ly requires state. If the answer\\nis \\u201cyes,\\u201d determine whether it still makes sense to implement it wi\", \"th serverless.\\n\\nThere are several solutions to adopt state without compromising the benefits of serv\", \"erless. Some of\\nthe more popular solutions include:\\n\\n. Use a temporary data store or distributed cac\", \"he, like Redis\\n\\u00b0 Store state in a database, like SQL or CosmosDB\\n\\n. Handle state through a workflow \", \"engine like durable functions\\n\\nThe bottom line is that you should be aware of the need for any state\", \" management within processes\\nyou're considering to implement with serverless.\\n\\nLong-running processe\", \"s\\n\\nMany benefits of serverless rely on the processes being ephemeral. Short run times make it easier\", \" for\\nthe serverless provider to free up resources as functions end and share functions across hosts.\", \" Most\\ncloud providers limit the total time your function can run to around 10 minutes. If your proce\", \"ss may\\ntake longer, you might consider an alternative implementation.\\n\\nThere are a few exceptions an\", \"d solutions. One solution may be to break your process into smaller\\ncomponents that individually tak\", \"e less time to run. If your process runs long because of dependencies,\\nyou can also consider an asyn\", \"chronous workflow using a solution like durable functions. Durable\\nfunctions pause and maintain the \", \"state of your process while it's waiting on an external process to\\nfinish. Asynchronous handling red\", \"uces the time the actual process runs.\\n\\n16 CHAPTER 2 | Serverless architecture\\nStartup time\\n\\nOne pot\", \"ential concern with serverless implementations is startup time. To conserve resources, many\\nserverle\", \"ss providers create infrastructure \\u201con demand.\\u201d When a serverless function is triggered after a\\nperi\", \"od of time, the resources to host the function may need to be created or restarted. In some\\nsituatio\", \"ns, cold starts may result in delays of several seconds. Startup time varies across providers and\\nse\", \"rvice levels. There are a few approaches to address startup time if it\\u2019s important to minimize for t\", \"he\\nsuccess of the app.\\n\\n. Some providers allow users to pay for service levels that guarantee infras\", \"tructure is \\u201calways on\\u201d.\\n. Implement a keep-alive mechanism (ping the endpoint to keep it \\u201cawake\\u2019\\u201d).\", \"\\n\\n. Use orchestration like Kubernetes with a containerized function approach (the host is already\\nru\", \"nning so spinning up new instances is extremely fast).\\n\\nDatabase updates and migrations\\n\\nAn advantag\", \"e of serverless code is that you can release new functions without having to redeploy the\\nentire app\", \"lication. This advantage can become a disadvantage when there's a relational database\\ninvolved. Chan\", \"ges to database schemas are difficult to synchronize with serverless updates. Additional\\nchallenges \", \"are posed when things go wrong and the changes must be rolled back. Data integrity is\\none reason tha\", \"t a best practice for microservices and serverless functions is that they own their own\\ndata. It is \", \"possible to deploy changes as a single unit of compute and data. The reality is that many\\nlegacy sys\", \"tems feature a large back-end database that must be reconciled with the serverless\\narchitecture.\\n\\nA \", \"popular approach to solve schema versioning is to never modify existing properties and columns,\\nbut \", \"instead add new information. For example, consider a change to move from a Boolean\\n\\u201ccompleted\\u201d flag \", \"for a todo list to a \\u201ccompleted date.\\u201d Instead of removing the old field, the database\\nchange will:\\n\", \"\\n1. Add anew \\u201ccompleted date\\u201d field.\\n\\n2. Transform the \\u201ccompleted\\u201d Boolean field to a computed funct\", \"ion that evaluates whether the\\ncompleted date is after the current date.\\n\\n3. Add a trigger to set th\", \"e completed date to the current date when the completed Boolean is set\\nto true.\\n\\nThe sequence of cha\", \"nges ensures that legacy code continues to run \\u201cas is\\u201d while newer serverless\\nfunctions can take adv\", \"antage of the new field.\\n\\nFor more information about data in serverless architectures, see Challenge\", \"s and solutions for\\ndistributed data management.\\n\\nScaling\\n\\nIt's a common misconception that serverle\", \"ss means \\u201cno server.\\\" It's in fact \\u201cless server.\\u201d The fact there\\nis a backing infrastructure is impo\", \"rtant to understand when it comes to scaling. Most serverless\\nplatforms provide a set of controls to\", \" handle how the infrastructure should scale when event density\\nincreases. You can choose from a vari\", \"ety of options, but your strategy may vary depending on the\\n\\n17 CHAPTER 2 | Serverless architecture\\n\", \"function. Furthermore, functions are typically run under a related host, so that functions on the sa\", \"me\\nhost have the same scale options. Therefore it is necessary to organize and strategize which func\", \"tions\\nare hosted together based on scale requirements.\\n\\nRules often specify how to scale-up (increas\", \"e the host resources) and scale-out (increase the number\\nof host instances) based on varying paramet\", \"ers. Triggers for scales may include schedule, request\\nrates, CPU utilization, and memory usage. Hig\", \"her performance often comes at a greater cost. The less\\nexpensive, consumption-based approaches may \", \"not scale as quickly when the request rate suddenly\\nincreases. There is a trade-off between paying u\", \"p front \\u201cinsurance cost\\u201d versus paying strictly \\u201cas you\\ngo\\u201d and risking slower responses due to sudd\", \"en increases in demand.\\n\\nMonitoring, tracing, and logging\\n\\nAn often overlooked aspect of DevOps Is m\", \"onitoring applications once deployed. It's important to\\nhave a strategy for monitoring serverless fu\", \"nctions. The biggest challenge is often correlation, or\\nrecognizing when a user calls multiple funct\", \"ions as part of the same interaction. Most serverless\\nplatforms allow console logging that can be im\", \"ported into third-party tools. There are also options to\\nautomate collection of telemetry, generate \", \"and track correlation IDs, and monitor specific actions to\\nprovide detailed insights. Azure provides\", \" the advanced Application Insights platform for monitoring\\nand analytics.\\n\\nInter-service dependencie\", \"s\\n\\nA serverless architecture may include functions that rely on other functions. In fact, it isn't u\", \"ncommon\\nin a serverless architecture to have multiple services call each other as part of an interac\", \"tion or\\ndistributed transaction. To avoid strong coupling, it\\u2019s recommended that services don\\u2019t refe\", \"rence each\\nother directly. When the endpoint for a service needs to change, direct references could \", \"result in\\nmajor refactoring. A suggested solution is to provide a service discovery mechanism, such \", \"as a\\nregistry, that provides the appropriate end point for a request type. Another solution is to le\", \"verage\\nmessaging services like queues or topics for communication between services.\\n\\nManaging failur\", \"e and providing resiliency\\n\\nIt's also important to consider the circuit-breaker pattern: |f, for som\", \"e reason, a service continues to\\nfail, it isn't advisable to call that service repeatedly. Instead, \", \"an alternative service is called or a\\nmessage returned until the health of the dependent service is \", \"re-established. The serverless\\narchitecture needs to take into account the strategy for resolving an\", \"d managing inter-service\\ndependencies.\\n\\nTo continue the circuit-breaker pattern, services need to be\", \" fault tolerant and resilient. Fault tolerance\\nrefers to the ability of your application to continue\", \" running even after unexpected exceptions or\\ninvalid states are encountered. Fault tolerance Is typi\", \"cally a function of the code itself and how it's\\nwritten to handle exceptions. Resiliency refers to \", \"how capable the app is at recovering from failures.\\nResiliency is often managed by the serverless pl\", \"atform. The platform should be able to spin up a new\\nserverless function instance when the existing \", \"one fails. The platform should also be intelligent\\nenough to stop spinning up new instances when eve\", \"ry new instance fails.\\n\\n18 CHAPTER 2 | Serverless architecture\\nFor more information, see Implementin\", \"g the Circuit Breaker pattern.\\n\\nVersioning and green/blue deployments\\n\\nA major benefit of serverless\", \" is the ability to upgrade a specific function without having to redeploy\\nthe entire application. Fo\", \"r upgrades to be successful, functions must be versioned so that services\\ncalling them are routed to\", \" the correct version of code. A strategy for deploying new versions is also\\nimportant. A common appr\", \"oach is to use \\u201cgreen/blue deployments.\\u201d The green deployment is the\\ncurrent function. A new \\u201cblue\\u201d \", \"version is deployed to production and tested. When testing passes, the\\ngreen and blue versions are s\", \"wapped so the new version comes live. If any issues are encountered,\\nthey can be swapped back. Suppo\", \"rting versioning and green/blue deployments requires a\\ncombination of authoring the functions to acc\", \"ommodate version changes and working with the\\nserverless platform to handle deployments.\\n\\nServerless\", \" design examples\\n\\nThere are many design patterns that exist for serverless. This section captures so\", \"me common\\nscenarios that use serverless. What all of the examples have in common is the fundamental\\n\", \"combination of an event trigger and business logic.\\n\\nScheduling\\n\\nScheduling tasks is a common functi\", \"on. The following diagram shows a legacy database that doesn't\\nhave appropriate integrity checks. Th\", \"e database must be scrubbed periodically. The serverless\\nfunction finds invalid data and cleans it. \", \"The trigger is a timer that runs the code on a schedule.\\n\\n>\\n\\nEvery 15 minutes Find and clean invalid\", \" data Clean table\\n\\nCommand and Query Responsibility Segregation (CQRS)\\n\\nCommand and Query Responsibi\", \"lity Segregation (CQRS) is a pattern that provides different interfaces\\nfor reading (or querying) da\", \"ta and operations that modify data. It addresses several common\\nproblems. In traditional Create Read\", \" Update Delete (CRUD) based systems, conflicts can arise from\\nhigh volume of both reads and writes t\", \"o the same data store. Locking may frequently occur and\\ndramatically slow down reads. Often, data is\", \" presented as a composite of several domain objects and\\nread operations must combine data from diffe\", \"rent entities.\\n\\nUsing CQRS, a read might involve a special \\u201cflattened\\u201d entity that models data the w\", \"ay it's consumed.\\nThe read is handled differently than how it's stored. For example, although the da\", \"tabase may store a\\ncontact as a header record with a child address record, the read could involve an\", \" entity with both\\n\\n19 CHAPTER 2 | Serverless architecture\\nheader and address properties. There are m\", \"yriad approaches to creating the read model. It might be\\nmaterialized from views. Update operations \", \"could be encapsulated as isolated events that then trigger\\nupdates to two different models. Separate\", \" models exist for reading and writing.\\n\\nFlat Table Read ===\\n6\\n\\nEvent \\u2014 Update to Transactional DB\\n\\u2014\\n\", \")\\n\\nServerless can accommodate the CQRS pattern by providing the segregated endpoints. One serverless\", \"\\nfunction accommodates queries or reads, and a different serverless function or set of functions\\nhan\", \"dles update operations. A serverless function may also be responsible for keeping the read model\\nup-\", \"to-date, and can be triggered by the database\\u2019s change feed. Front-end development is simplified\\nto \", \"connecting to the necessary endpoints. Processing of events is handled on the back end. This\\nmodel a\", \"lso scales well for large projects because different teams may work on different operations.\\n\\nEvent-\", \"based processing\\n\\nIn message-based systems, events are often collected in queues or publisher/subscr\", \"iber topics to be\\nacted upon. These events can trigger serverless functions to execute a piece of bu\", \"siness logic. An\\nexample of event-based processing is event-sourced systems. An \\u201cevent\\u201d is raised to\", \" mark a task as\\ncomplete. A serverless function triggered by the event updates the appropriate datab\", \"ase document. A\\nsecond serverless function may use the event to update the read model for the system\", \". Azure Event\\nGrid provides a way to integrate events with functions as subscribers.\\n\\nEvents are inf\", \"ormational messages. For more information, see Event Sourcing pattern.\\n\\nFile triggers and transforma\", \"tions\\n\\nExtract, Transform, and Load (ETL) is a common business function. Serverless is a great solut\", \"ion for ETL\\nbecause it allows code to be triggered as part of a pipeline. Individual code components\", \" can address\\nvarious aspects. One serverless function may download the file, another applies the tra\", \"nsformation,\\nand another loads the data. The code can be tested and deployed independently, making i\", \"t easier to\\nmaintain and scale where needed.\\n\\n20 CHAPTER 2 | Serverless architecture\\nAbnormal\\nbehavi\", \"or\\n\\nFTP Download\\nManager Function\\n\\n~~\\nCAs\\nSingle Folder Single Folder Single Folder Blob Replication\", \"\\n\\n|\\n\\nIn the diagram, \\u201ccool storage\\u201d provides data that is parsed in Azure Stream Analytics. Any issu\", \"es\\nencountered in the data stream trigger an Azure Function to address the anomaly.\\n\\nAsynchronous ba\", \"ckground processing and messaging\\n\\nAsynchronous messaging and background processing allow applicatio\", \"ns to kick off processes without\\nhaving to wait. An example of asynchronous processing is an OCR app\", \". An image is submitted and\\nqueued for processing. Scanning the image to extract text may take time,\", \" and once it\\u2019s finished a\\nnotification is sent. Serverless can handle both the invocation and the re\", \"sult in this scenario.\\n\\nWeb apps and APIs\\n\\nA popular scenario for serverless is N-tier applications,\", \" most commonly ones where the UI layer is a\\nweb app. The popularity of Single Page Applications (SPA\", \") has surged recently. SPA apps render a\\nsingle page, then rely on API calls and the returned data t\", \"o dynamically render new UI without\\nreloading a full page. Client-side rendering provides a much fas\", \"ter, more responsive application to the\\nend user.\\n\\nServerless endpoints triggered by HTTP calls can \", \"be used to handle the API requests. For example, an\\nad services company may call a serverless functi\", \"on with user profile information to request custom\\nadvertising. The serverless function returns the \", \"custom ad and the web page renders it.\\n\\n21 CHAPTER 2 | Serverless architecture\\nLoaded web page Creat\", \"e ad based on user profile Completed page\\ncalls WebHook\\n\\nData pipeline\\nServerless functions can be u\", \"sed to facilitate a data pipeline. In this example, a file triggers a function\\nto translate data in \", \"a CSV file to data rows in a table. The organized table allows a Power BI dashboard\\n\\nto present anal\", \"ytics to the end user.\\n\\n=\\n\\n<>\\ne ES in\\n\\nFile added to Transform CSV to data rows Power BI\\nBlob Storag\", \"e Chart graphic\\n\\nStream processing\\n\\nDevices and sensors often generate streams of data that must be \", \"processed in real time. There are a\\nnumber of technologies that can capture messages and streams fro\", \"m Event Hubs and loT Hub to\\nService Bus. Regardless of transport, serverless is an ideal mechanism f\", \"or processing the messages\\nand streams of data as they come in. Serverless can scale quickly to meet\", \" the demand of large\\nvolumes of data. The serverless code can apply business logic to parse the data\", \" and output in a\\nstructured format for action and analytics.\\n\\n22 CHAPTER 2 | Serverless architecture\", \"\\n+e}\\n\\n[B\\n%\\n\\ns\\n\\n- EEE\\n= 8 ae88\\n\\nMillions of devices feed Transform to structured data Store data in\\n\\n\", \"into Stream Analytics SQL Online\\n\\nAPI gateway\\n\\nAn API gateway provides a single point of entry for c\", \"lients and then intelligently routes requests to\\nback-end services. It's useful to manage large sets\", \" of services. It can also handle versioning and\\n\\nsimplify development by easily connecting clients t\", \"o disparate environments. Serverless can handle\\nback-end scaling of individual microservices while p\", \"resenting a single front end via an API gateway.\\n\\nU4 meee\\n\\nRecommended resources\\n\\n\\u00b0 Azure Event Grid\", \"\\n\\n\\u00b0 Azure loT Hub\\n\\n. Challenges and solutions for distributed data management\\n\\n\\u00b0 Designing microserv\", \"ices: identifying microservice boundaries\\n\\u00b0 Event Hubs\\n\\n\\u00b0 Event Sourcing pattern\\n\\n\\u00b0 Implementing the\", \" Circuit Breaker pattern\\n\\u00b0 lol Hub\\n\\n\\u00b0 Service Bus\\n\\n\\u00b0 Working with the change feed support in Azure C\", \"osmos DB\\n\\n23 CHAPTER 2 | Serverless architecture\\nCHAPTER\\n\\nAzure serverless plattorm\\n\\nThe Azure serve\", \"rless platform includes Azure Functions, Logic Apps, and Event Grid. These services\\nwork together an\", \"d connect with myriad other resources. The serverless platform works with\\neverything from databases \", \"and storage to analytics and machine learning/artificial intelligence.\\n\\nYou can also use Application\", \" Insights, a serverless platform for capturing diagnostic traces and\\ntelemetry. Application Insights\", \" are available to applications of all types (desktop, mobile, or web) as\\nwell as serverless implemen\", \"tations. The platform is visualized in the following diagram:\\n\\nEvent Grid Logic Apps Functions\\n\\nMana\", \"ge all events that can Design workflows and Execute your code based\\ntrigger code or logic orchestrat\", \"e processes on events you specify\\n\\nDatabase Storage Security Analytics Intelligence\\n\\ns ff \\u00a2 at &\\u00ae\\n\\nT\", \"his chapter breaks down the fundamentals of each component.\\n\\nAzure Functions\\n\\nAzure Functions provid\", \"e a serverless compute experience. A function is invoked by a trigger (such as\\naccess to an HTTP end\", \"point or a timer) and executes a block of code or business logic. Functions also\\nsupport specialized\", \" bindings that connect to resources like storage and queues.\\n\\n24 CHAPTER 3 | Azure serverless platfo\", \"rm\\ni?\\n\\nThe current runtime version 4.0 supports cross-platform .NET 7.0 applications. Additional lan\", \"guages\\nbesides C# such as JavaScript, F#, and Java are supported. Functions created in the portal pr\", \"ovide a\\nrich scripting syntax. Functions created as standalone projects can be deployed with full pl\", \"atform\\nsupport and capabilities.\\n\\nFor more information, see Azure Functions documentation.\\n\\nProgramm\", \"ing language support\\nThe following languages are all supported in general availability (GA).\\n\\nSuppor\", \"ted runtimes for 4.x\\n\\n-NET 6.0, 7.0, .NET Framework 4.8\\n\\nrs Node 14,16, 18\\nfee | NET6O,70\\n\\nfie paw\\n\\n\", \"For more information on other runtime versions, see Supported languages.\\n\\nApp service plans\\n\\nFunctio\", \"ns are backed by an app service plan. The plan defines the resources used by the functions\\napp. You \", \"can assign plans to a region, determine the size and number of virtual machines that will be\\nused, a\", \"nd pick a pricing tier. For a true serverless approach, function apps may use the consumption\\nplan. \", \"The consumption plan will scale the back end automatically based on load.\\n\\nAnother hosting option fo\", \"r function apps is the Premium plan. This plan provides an \\u201calways on\\u201d\\ninstance to avoid cold start,\", \" supports advanced features like VNet connectivity, and runs on premium\\nhardware.\\n\\nFor more informat\", \"ion, see App service plans.\\n\\nCreate your first function\\n\\nThere are three common ways you can create \", \"function apps.\\n\\n. Script functions in the portal.\\n. Create the necessary resources using the Azure C\", \"LI.\\n\\n\\u00b0 Build functions locally using your favorite IDE and publish them to Azure.\\n\\n25 CHAPTER 3 | Az\", \"ure serverless platform\\nFor more information on creating a scripted function in the portal, see Crea\", \"te your first function in the\\nAzure portal.\\n\\nTo build from the Azure CLI, see Create your first func\", \"tion using the Azure CLI.\\nTo create a function from Visual Studio, see Create your first function us\", \"ing Visual Studio.\\n\\nUnderstand triggers and bindings\\n\\nFunctions are invoked by a trigger and can hav\", \"e exactly one. In addition to invoking the function,\\ncertain triggers also serve as bindings. You ma\", \"y also define multiple bindings in addition to the\\ntrigger. Bindings provide a declarative way to co\", \"nnect data to your code. They can be passed in (input)\\nor receive data (output). Triggers and bindin\", \"gs make functions easy to work with. Bindings remove the\\noverhead of manually creating database or f\", \"ile system connections. All of the information needed for\\nthe bindings is contained in a special fun\", \"ctionsjson file for scripts or declared with attributes in code.\\n\\nSome common triggers include:\\n\\n. B\", \"lob Storage: invoke your function when a file or folder is uploaded or changed in storage.\\n\\u00b0 HTTP: i\", \"nvoke your function like a REST API.\\n. Queue: invoke your function when items exist in a queue.\\n\\n. T\", \"imer: invoke your function on a regular cadence.\\nExamples of bindings include:\\n. CosmosDB: easily co\", \"nnect to the database to load or save files.\\n\\n. Table Storage: work with key/value storage from your\", \" function app.\\n\\n. Queue Storage: easily retrieve items from a queue, or place new items on the queue\", \".\\n\\nThe following example functionsjson file defines a trigger and a binding:\\n\\n{\\n\\n\\\"bindings\\\": [\\n{\\n\\u201cna\", \"me\\\": \\\"myBlob\\\",\\n\\\"type\\\": \\\"\\u201cblobTrigger\\\",\\n\\\"direction\\\": \\\"in\\\",\\n\\\"path\\\": \\\"\\u201cimages/{name}\\\",\\n\\\"connection\\\": \\\"A\", \"zureWebJobsStorage\\\"\\n\\n\\\"name\\\": \\\"$return\\\",\\n\\\"type\\\": \\\"queue\\\",\\n\\\"direction\\\": \\\"out\\\",\\n\\u201cqueueName\\\": \\\"images\\\",\\n\", \"\\\"connection\\\": \\\"AzureWebJobsStorage\\\"\\n}\\n],\\n\\\"disabled\\\": false\\n\\n}\\n\\nIn this example, the function is trig\", \"gered by a change to blob storage in the images container. The\\ninformation for the file is passed in\", \", so the trigger also acts as a binding. Another binding exists to put\\ninformation onto a queue name\", \"d images.\\n\\n26 CHAPTER 3 | Azure serverless platform\\nHere is the C# script for the function:\\n\\npublic \", \"static string Run(Stream myBlob, string name, TraceWriter log)\\n\\nt\\n\\n{myBlob.Length} Bytes\\\");\\nreturn n\", \"ame;\\n\\nlog.Info($\\\"C# Blob trigger function Processed blob\\\\n Name:{name} \\\\n Size:\\n\\n}\\n\\nThe example is a\", \" simple function that takes the name of the file that was modified or uploaded to\\nblob storage, and \", \"places it on a queue for later processing.\\n\\nFor a full list of triggers and bindings, see Azure Func\", \"tions triggers and bindings concepts.\\n\\nTelemetry with Application Insights\\n\\nApplication Insights is \", \"a serverless diagnostics platform that enables developers to detect, triage, and\\ndiagnose issues in \", \"web apps, mobile apps, desktop apps, and microservices. You can turn on\\nApplication Insights for fun\", \"ction apps simply by flipping a switch in the portal. Application Insights\\nprovides all of these cap\", \"abilities without you having to configure a server or set up your own\\ndatabase. All of Application I\", \"nsights\\u2019 capabilities are provided as a service that automatically\\nintegrates with your apps.\\n\\n|\\n.\\n\\n\", \"Adding Application Insights to existing apps is as easy as adding an instrumentation key to your\\napp\", \"lication\\u2019s settings. With Application Insights you can:\\n\\n\\u00b0 Create custom charts and alerts based on \", \"metrics such as number of function invocations, the\\ntime it takes to run a function, and exceptions\\n\", \"\\u00b0 Analyze failures and server exceptions\\n\\n. Drill into performance by operation and measure the time\", \" it takes to call third-party\\ndependencies\\n\\n. Monitor CPU usage, memory, and rates across all server\", \"s that host your function apps\\n. View a live stream of metrics including request count and latency f\", \"or your function apps\\n\\n. Use Analytics to search, query, and create custom charts over your function\", \" data\\n\\n27 CHAPTER 3 | Azure serverless platform\\nfunctionapp0915 - Metrics Explorer\\n7\\n\\n2 Search (Ctri\", \"+/) + Add chart \\u00a9 Time range T Filters e) Refresh a Alert rules\\n\\n9 Oveniew\\nI Activity log\\nsila Acces\", \"s control (IAM)\\n\\nA Tags\\n\\nINVESTIGATE\\n\\n= Application map\\n\\n\\u2018@ Smart Detection\\n\\n\\u201c- Live Metrics Stream\\n\", \"\\nP Search\\n\\n\\u00ae availability\\n\\ntt Failures\\n\\n% Performance\\n\\nB Servers TIMERFUNCTION MA...\\n\\n5.95\\n\\nWW Brows\", \"er TIMERFUNCTION CO...\\n\\n3.21\\n\\nTIMERFUNCTION MIL...\\nUSAGE (PREVIEW) ; 4.02\\n\\nAdd new chart (+)\\n\\noy Use\", \"rs\\nIn addition to built-in telemetry, it's also possible to generate custom telemetry. The following\", \" code\\nSnippet creates a custom telemetry client using the instrumentation key set for the function a\", \"pp:\\npublic static TelemetryClient telemetry = new TelemetryClient()\\n\\n{\\nInstrumentationKey =\\nEnvironm\", \"ent.GetEnvironmentVariable(\\\"APPINSIGHTS_INSTRUMENTATIONKEY\\\" )\\n\\n}3\\n\\nThe following code measures how l\", \"ong it takes to insert a new row into an Azure Table Storage\\ninstance:\\n\\nvar startTime = DateTime.Utc\", \"Now;\\nvar timer = System.Diagnostics.Stopwatch.StartNew() ;\\n\\nawait tableClient.AddEntityAsync(entry) \", \";\\ntelemetry. TrackDependency(\\\"AzureTableStorageInsert\\\", \\\"Insert\\\", startTime, timer.Elapsed,\\ntrue) ;\\n\", \"\\nThe resulting performance graph is shown:\\n\\n28 CHAPTER 3 | Azure serverless platform\\nss View in Anal\", \"ytics v [7 Feedback v b @ 3 Profiler \\u00a9 Refresh\\n\\nDependencies\\n\\nDependency response time m | gon Other\", \": AzureTableStoragelnsert\\n100 ms\\n\\nDistribution of durations: zoom into arange Scale 111000 |\\n\\n6\\n\\n0.0\", \"ms\\n\\nRequest count\\n\\nDependency count\\n\\nDuration 1.0ms\\n\\nSelect operation [A searchtofiteritems. Insight\", \"s\\n\\nDEPENDENCY NAME DURATION (AVG) \\\\ COUNT PIN No insights were found\\n\\nOverall -49. 25.8 ms 129\\n\\nThe \", \"custom telemetry reveals the average time to insert a new row Is 32.6 milliseconds.\\n\\nApplication Ins\", \"ights provides a powerful, convenient way to log detailed telemetry about your\\nserverless applicatio\", \"ns. You have full control over the level of tracing and logging that is provided.\\nYou can track cust\", \"om statistics such as events, dependencies, and page view. Finally, the powerful\\nanalytics enable yo\", \"u to write queries that ask important questions and generate charts and advanced\\ninsights.\\n\\nFor more\", \" information, see Monitor Azure Functions.\\n\\nAzure Logic Apps\\n\\nAzure Logic Apps provides a serverless\", \" engine to build automated workflows to integrate apps and\\ndata between cloud services and on-premis\", \"es systems. You build workflows using a visual designer.\\nYou can trigger workflows based on events o\", \"r timers and leverage connectors to integration\\napplications and facilitate business-to-business (B2\", \"B) communication. Logic Apps integrates\\nseamlessly with Azure Functions.\\n\\nay\\n\\nLogic Apps can do more\", \" than just connect your cloud services (like functions) with cloud resources\\n(like queues and databa\", \"ses). You can also orchestrate on-premises workflows with the on-premises\\ngateway. For example, you \", \"can use the Logic App to trigger an on-premises SQL stored procedure in\\nresponse to a cloud-based ev\", \"ent or conditional logic in your workflow. Learn more about Connecting\\n\\nto on-premises data sources \", \"with Azure On-premises Data Gateway.\\n\\n29 CHAPTER 3 | Azure serverless platform\\nLike Azure Functions,\", \" you kick off Logic App workflows with a trigger. There are many triggers for you\\nto choose from. Th\", \"e following capture shows just a few of the more popular ones out of hundreds\\nthat are available.\\n\\nS\", \"tart with a common trigger\\n\\nPick from one of the most commonly used triggers, then orchestrate any n\", \"umber of actions using the rich collection of connectors\\n\\nWhen a message is When a HTTP When a new t\", \"weet is When a Event Grid\\nreceived in a Service request is received posted event occurs\\nBus queue\\n\\nR\", \"ecurrence When a new email is When a new file is When a file is added\\nreceived in created on OneDriv\", \"e [ia to FTP server\\nOutlook.com\\n\\n,\\n\\nOnce the app is triggered, you can use the visual designer to bu\", \"ild out steps, loops, conditions, and\\nactions. Any data ingested in a previous step is available for\", \" you to use in subsequent steps. The\\nfollowing workflow loads URLs from a CosmosDB database. It find\", \"s the ones with a host of t.co then\\nsearches for them on Twitter. If it finds corresponding tweets, \", \"it updates the documents with the\\nrelated tweets by calling a function.\\n8 | Recurrence\\n\\nInitialize v\", \"ariable\\n{3} Initialize variable 2\\n{3} Initialize variable 3\\n\\nQuery documents (Pr:\\n* Database ID\\n\\nuri\", \"-tracking Vv\\n\\nKe & & &\\n\\nuri-stats Vv\\n\\nselect c.id,c.referrerUri from c where c.twitter = 1 and c.ref\", \"errerHost = \\u2018tco\\n\\nand not(is_defined(c.referralTweet)) order by c._ts desc\\nThe partition key value f\", \"or the requested document or attachment operation\\nShow advanced options \\u201c\\n\\nts. Change connection.\\n\\n|\", \" Condition\\nfe | length(...) x s greater than 0\\n\\nEdit in advanced mode Collapse condition\\n\\nIf true If\", \" false\\n\\njm For each am L Add an action *** More\\n\\n| Documents x\\n\\n>\\n\\nL Add an action iz Add a conditio\", \"n\\n\\nL Add an action *\\u00b0* More\\n\\nThe Logic Apps dashboard shows the history of running your workflows an\", \"d whether each run\\ncompleted successfully or not. You can navigate into any given run and inspect th\", \"e data used by each\\nstep for troubleshooting. Logic Apps also provides existing templates you can ed\", \"it and are well suited\\nfor complex enterprise workflows.\\n\\nTo learn more, see Azure Logic Apps.\\n\\nEven\", \"t Grid\\n\\nAzure Event Grid provides serverless infrastructure for event-based applications. You can pu\", \"blish to\\nEvent Grid from any source and consume messages from any platform. Event Grid also has buil\", \"t-in\\nsupport for events from Azure resources to streamline integration with your applications. For e\", \"xample,\\nyou can subscribe to blob storage events to notify your app when a file is uploaded. Your ap\", \"plication\\ncan then publish a custom event grid message that is consumed by other cloud or on-premise\", \"s\\napplications. Event Grid was built to reliably handle massive scale. You get the benefits of publi\", \"shing\\nand subscribing to messages without the overhead of setting up the necessary infrastructure.\\n\\n\", \"31 CHAPTER 3 | Azure serverless platform\\nLn]\\n\\nThe major features of event grid include:\\n\\n. Fully man\", \"aged event routing.\\n\\n. Near real-time event delivery at scale.\\n\\n. Broad coverage both inside and out\", \"side of Azure.\\nScenarios\\n\\nEvent Grid addresses several different scenarios. This section covers thre\", \"e of the most common ones.\\n\\nOps automation\\n\\nA. he\\n\\ni\\nmo _\\n\\nEvent Grid can help speed automation and \", \"simplify policy enforcement by notifying Azure\\nAutomation when infrastructure Is provisioned.\\n\\n\\u2014\\u2014\\u2014\\n\\n\", \"32 CHAPTER 3 | Azure serverless platform\\nApplication integration\\n\\nYou can use Event Grid to connect \", \"your app to other services. Using standard HTTP protocols, even\\nlegacy apps can be easily modified t\", \"o publish Event Grid messages. Web hooks are available for other\\nservices and platforms to consume E\", \"vent Grid messages.\\n\\nServerless apps\\n\\noF\\n~~?\\n\\n~~\\n\\nSa\\ni =\\n= --\\ni\\n\\nEvent Grid can trigger Azure Functi\", \"ons, Logic Apps, or your own custom code. A major benefit of\\nusing Event Grid is that it uses a push\", \" mechanism to send messages when events occur. The push\\narchitecture consumes fewer resources and sc\", \"ales better than polling mechanisms. Polling must check\\nfor updates on a regular interval.\\n\\nEvent Gr\", \"id vs. other Azure messaging services\\n\\nAzure provides several messaging services, including Event Hu\", \"bs and Service Bus. Each is designed to\\naddress a specific set of use cases. The following diagram p\", \"rovides a high-level overview of the\\ndifferences between the services.\\n\\n33 CHAPTER 3 | Azure serverl\", \"ess platform\\n(. wo\\nae =\\n\\nEvent Hubs Event Grid Service Bus\\n\\n* \\u201cPoint in time\\u201d data * Business logic \", \"* Queue for critical items\\n\\u00a2 Fast pull \\u00a2 Push, not poll * Routing\\n\\n* Replay / strict ordering * Hand\", \"lers * Workflow\\n\\n* Big data streams * Ordering * Transactional\\n\\nee EE ES Eee\\n\\nFor a more in-depth co\", \"mparison, see Compare messaging services.\\n\\nPerformance targets\\n\\nUsing Event Grid you can take advant\", \"age of the following performance guarantees:\\n\\n\\u00b0 Subsecond end-to-end latency in the 99th percentile.\", \"\\n\\u00b0 99.99% availability.\\n\\n\\u00b0 10 million events per second per region.\\n\\u00b0 100 million subscriptions per \", \"region.\\n. 50-ms publisher latency.\\n\\n. 24-hour retry with exponential back-off for guaranteed deliver\", \"y in the 1-day window.\\n\\n\\u00b0 Transparent regional failover.\\n\\nEvent Grid schema\\n\\nEvent Grid uses a stand\", \"ard schema to wrap custom events. The schema is like an envelope that wraps\\nyour custom data element\", \". Here is an example Event Grid message:\\n\\n\\\"id\\\": \\\"Q@3e24f21-a955-43cc-8921-1f61a6081cee\\\",\\n\\u201ceventType\\\"\", \": \\\"\\u201cmyCustomEvent\\\",\\n\\\"subject\\\": \\\"foo/bar/12\\\",\\n\\\"eventTime\\\": \\\"2018-09-22T10:36:01+00:00\\\",\\n\\\"data\\\": {\\n\\\"fa\", \"voriteColor\\\": \\\"blue\\\",\\n\\u201cfavoriteAnimal\\\": \\\"panther\\\",\\n\\u201cfavoritePlanet\\\": \\\"Jupiter\\\"\\n\\nbs\\n\\n\\\"dataVersion\\\": \\\"\", \"1.0\\\"\\n\\nEverything about the message is standard except the data property. You can inspect the message\", \" and\\nuse the eventType and dataVersion to de-serialize the custom portion of the payload.\\n\\n34 CHAPTE\", \"R 3 | Azure serverless platform\\nAzure resources\\n\\nA major benefit of using Event Grid is the automati\", \"c messages produced by Azure. In Azure, resources\\nautomatically publish to a topic that allows you t\", \"o subscribe for various events. The following table\\nlists the resource types, message types, and eve\", \"nts that are available automatically.\\n\\nAzure\\nresource Event type Description\\nAzure Microsoft.Resourc\", \"es.ResourceWriteSuccess Raised when a resource create or\\nsubscription update operation succeeds.\\nMic\", \"rosoft.Resources.ResourceWriteFailure Raised when a resource create or\\nupdate operation fails.\\nMicro\", \"soft.Resources.ResourceWriteCancel Raised when a resource create or\\nupdate operation is canceled.\\nMi\", \"crosoft.Resources.ResourceDeleteSuccess | Raised when a resource delete\\noperation succeeds.\\nMicrosof\", \"t.Resources.ResourceDeleteFailure Raised when a resource delete\\noperation fails.\\n\\nMicrosoft.Resource\", \"s.ResourceDeleteCancel | Raised when a resource delete\\noperation is canceled. This event\\nhappens whe\", \"n a template deployment\\nis canceled.\\n\\nBlob storage | Microsoft.Storage.BlobCreated Raised when a blo\", \"b is created\\nBP Microsoft.Storage.BlobDeleted Raised when a blob is deleted\\nEvent hubs Microsoft.Eve\", \"ntHub.CaptureFileCreated Raised when a capture file is created\\n\\nResource Microsoft.Resources.Resourc\", \"eWriteSuccess Raised when a resource create or\\ngroups update operation succeeds\\nMicrosoft.Resources.\", \"ResourceWriteFailure Raised when a resource create or\\nupdate operation fails\\nMicrosoft.Resources.Res\", \"ourceWriteCancel Raised when a resource create or\\nupdate operation is canceled\\n\\nloT Hub Microsoft.De\", \"vices.DeviceCreated Published when a device is registered\\nto an loT hub.\\nMicrosoft.Devices.DeviceDel\", \"eted Published when a device is deleted\\nfrom an loT hub\\n\\nMicrosoft.Resources.ResourceDeleteSuccess |\", \" Raised when a resource delete\\noperation succeeds\\n\\nMicrosoft.Resources.ResourceDeleteFailure Raised \", \"when a resource delete\\noperation fails.\\n\\n35 CHAPTER 3 | Azure serverless platform\\n\\nAzure\\nresource Ev\", \"ent type Description\\n\\nMicrosoft.Resources.ResourceDeleteCancel Raised when a resource delete\\n\\noperat\", \"ion is canceled. This event\\nhappens when a template deployment\\nis canceled.\\n\\nFor more information, s\", \"ee Azure Event Grid event schema.\\n\\nYou can access Event Grid from any type of application, even one \", \"that runs on-premises.\\n\\nConclusion\\n\\nIn this chapter you learned about the Azure serverless platform \", \"that is composed of Azure Functions,\\nLogic Apps, and Event Grid. You can use these resources to buil\", \"d an entirely serverless app\\narchitecture, or create a hybrid solution that interacts with other clo\", \"ud resources and on-premises\\nservers. Combined with a serverless data platform such as Azure SQL or \", \"CosmosDB, you can build fully\\nmanaged cloud native applications.\\n\\nRecommended resources\\n\\n\\u00b0 App servi\", \"ce plans\\n\\u00b0 Application Insights\\n\\u00b0 Application Insights Analytics\\n\\n\\u00b0 Azure: Bring your app to the clo\", \"ud with serverless Azure Functions\\n\\u00b0 Azure Event Grid\\n\\n\\u00b0 Azure Event Grid event schema\\n\\u00b0 Azure Event\", \" Hubs\\n\\n\\u00b0 Azure Functions documentation\\n\\n: Azure Functions triggers and bindings concepts\\n\\n: Azure Lo\", \"gic Apps\\n\\n: Azure Service Bus\\n\\n. Azure Table Storage\\n\\n: Connecting to on-premises data sources with \", \"Azure On-premises Data Gateway\\n. Create your first function in the Azure portal\\n\\n. Create your first\", \" function using the Azure CLI\\n\\n. Create your first function using Visual Studio\\n\\n\\u00b0 Functions support\", \"ed languages\\n\\u00b0 Monitor Azure Functions\\n\\n36 CHAPTER 3 | Azure serverless platform\\nCHAPTER\\n\\nDurable Az\", \"ure Functions\\n\\nWhen creating serverless applications with Azure Functions, your operations will typi\", \"cally be designed\\nto run in a stateless manner. The reason for this design choice is because as the \", \"platform scales, it\\nbecomes difficult to know what servers the code is running on. It also becomes d\", \"ifficult to know how\\nmany instances are active at any given point. However, there are classes of app\", \"lications that require\\nthe current state of a process to be known. Consider the process of submittin\", \"g an order to an online\\nstore. The checkout operation might be a workflow that is composed of multip\", \"le operations that need\\nto know the state of the process. Such information may include the product i\", \"nventory, if the customer\\nhas any credits on their account, and also the results of processing the c\", \"redit card. These operations\\ncould easily be their own internal workflows or even services from thir\", \"d-party systems.\\n\\nVarious patterns exist today that assist with the coordination of application stat\", \"e between internal and\\nexternal systems. It's common to come across solutions that rely on centraliz\", \"ed queuing systems,\\ndistributed key-value stores, or shared databases to manage that state. However,\", \" these are all\\nadditional resources that now need to be provisioned and managed. In a serverless env\", \"ironment, your\\ncode could become cumbersome trying to coordinate with these resources manually. Azur\", \"e Functions\\noffers an alternative for creating stateful functions called Durable Functions.\\n\\nDurable\", \" Functions is an extension to the Azure Functions runtime that enables the definition of\\nstateful wo\", \"rkflows in code. By breaking down workflows into activities, the Durable Functions\\nextension can man\", \"age state, create progress checkpoints, and handle the distribution of function calls\\nacross servers\", \". In the background, it makes use of an Azure Storage account to persist execution\\nhistory, schedule\", \" activity functions and retrieve responses. Your serverless code should never interact\\nwith persiste\", \"d information in that storage account, and is typically not something with which\\ndevelopers need to \", \"interact.\\n\\nTriggering a stateful workflow\\n\\nStateful workflows in Durable Functions can be broken dow\", \"n into two intrinsic components;\\norchestration and activity triggers. Triggers and bindings are core\", \" components used by Azure\\nFunctions to enable your serverless functions to be notified when to start\", \", receive input, and return\\nresults.\\n\\nWorking with the Orchestration client\\n\\nOrchestrations are uniq\", \"ue when compared to other styles of triggered operations in Azure Functions.\\nDurable Functions enabl\", \"es the execution of functions that may take hours or even days to complete.\\nThat type of behavior co\", \"mes with the need to able to check the status of a running orchestration,\\npreemptively terminate, or\", \" send notifications of external events.\\n\\n37 CHAPTER 4 | Durable Azure Functions\\nFor such cases, the \", \"Durable Functions extension provides the DurableOrchestrationClient class that\\nallows you to interac\", \"t with orchestrated functions. You get access to the orchestration client by using\\nthe Orchestration\", \"ClientAttribute binding. Generally, you would include this attribute with another\\ntrigger type, such\", \" as an HttpTrigger or ServiceBusTrigger. Once the source function has been\\ntriggered, the orchestrat\", \"ion client can be used to start an orchestrator function.\\n\\n[ FunctionName(\\\"KickOfFf\\\" ) ]\\n\\npublic sta\", \"tic async Task<HttpResponseMessage> Run(\\n[HttpTrigger(AuthorizationLevel.Function, \\\"POST\\\") ]HttpRequ\", \"estMessage req,\\n[OrchestrationClient ] DurableOrchestrationClient<orchestrationClient>)\\n\\nOrderReques\", \"tData data = await req.Content.ReadAsAsync<OrderRequestData>();\\nstring instanceId = await orchestrat\", \"ionClient.StartNewAsync(\\\"PlaceOrder\\\", data) ;\\n\\nreturn orchestrationClient.CreateCheckStatusResponse(\", \"req, instanceld) ;\\n\\nThe orchestrator function\\n\\nAnnotating a function with the OrchestrationTriggerAt\", \"tribute in Azure Functions marks that function\\nas an orchestrator function. It\\u2019s responsible for man\", \"aging the various activities that make up your\\nstateful workflow.\\n\\nOrchestrator functions are unable\", \" to make use of bindings other than the\\nOrchestrationTriggerAttribute. This attribute can only be us\", \"ed with a parameter type of\\nDurableOrchestrationContext. No other inputs can be used since deseriali\", \"zation of inputs in the\\nfunction signature isn't supported. To get inputs provided by the orchestrat\", \"ion client, the\\nGetInput<T> method must be used.\\n\\nAlso, the return types of orchestration functions \", \"must be either void, Task, or a JSON serializable\\nvalue.\\n\\nError handling code has been left out for \", \"brevity\\n\\n[ FunctionName(\\\"PlaceOrder\\\") ]\\npublic static async Task<string> PlaceOrder([OrchestrationTr\", \"igger |\\nDurableOrchestrationContext context)\\n\\nt\\nOrderRequestData orderData = context.GetInput<OrderR\", \"equestData>() ;\\n\\nawait context.CallActivityAsync<bool>(\\\"CheckAndReserveInventory\\\", orderData) ;\\nawai\", \"t context.CallActivityAsync<string>(\\\"ProcessPayment\\\", orderData) ;\\n\\nstring trackingNumber = await co\", \"ntext.CallActivityAsync<string>(\\\"ScheduleShipping\\\",\\norderData) ;\\nawait context.CallActivityAsync<str\", \"ing>(\\\"EmailCustomer\\\", trackingNumber) ;\\n\\nreturn trackingNumber ;\\n\\nMultiple instances of an orchestra\", \"tion can be started and running at the same time. Calling the\\nStartNewAsync method on the DurableOrc\", \"hestrationClient launches a new instance of the\\norchestration. The method returns a Task<string> tha\", \"t completes when the orchestration has started.\\n\\n38 CHAPTER 4 | Durable Azure Functions\\nAn exception\", \" of type TimeoutException gets thrown if the orchestration hasn't started within 30\\nseconds.\\n\\nThe co\", \"mpleted Task<string> from StartNewAsync should contain the unique ID of the orchestration\\ninstance. \", \"This instance ID can be used to invoke operations on that specific orchestration. The\\norchestration \", \"can be queried for the status or sent event notifications.\\n\\nThe activity functions\\n\\nActivity functio\", \"ns are the discrete operations that get composed together within an orchestration\\nfunction to create\", \" the workflow. Here is where most of actual work would take place. They represent\\nthe business logic\", \", long running processes, and the puzzle pieces to a larger solution.\\n\\nThe ActivityTriggerAttribute \", \"is used to annotate a function parameter of type\\nDurableActivityContext. Using the annotation inform\", \"s the runtime that the function is intended to\\nbe used as an activity function. Input values to acti\", \"vity functions are retrieved using the GetInput<T>\\nmethod of the DurableActivityContext parameter.\\n\\n\", \"Similar to orchestration functions, the return types of activity functions must be either void, Task\", \", or a\\nJSON serializable value.\\n\\nAny unhandled exceptions that get thrown within activity functions \", \"will get sent up to the calling\\norchestrator function and presented as a TaskFailedException. At thi\", \"s point, the error can be caught\\nand logged in the orchestrator, and the activity can be retried.\\n\\n[\", \" FunctionName(\\\"CheckAndReservelInventory\\\" ) |\\npublic static bool CheckAndReservelInventory([Activity\", \"Trigger] DurableActivityContext\\ncontext)\\n\\nt\\n\\nOrderRequestData orderData = context.GetInput<OrderRequ\", \"estData>() ;\\n\\n// Connect to inventory system and try to reserve items\\nreturn true;\\n\\nRecommended reso\", \"urces\\n\\n\\u00b0 Durable Functions\\n\\n\\u00b0 Bindings for Durable Functions\\n\\u00b0 Manage instances in Durable Functions\", \"\\n\\nOrchestration patterns\\n\\nDurable Functions makes it easier to create stateful workflows that are co\", \"mposed of discrete, long\\nrunning activities in a serverless environment. Since Durable Functions can\", \" track the progress of your\\nworkflows and periodically checkpoints the execution history, it lends i\", \"tself to implementing some\\ninteresting patterns.\\n\\n39 CHAPTER 4 | Durable Azure Functions\\nFunction ch\", \"aining\\n\\nIn a typical sequential process, activities need to execute one after the other in a particu\", \"lar order.\\nOptionally, the upcoming activity may require some output from the previous function. Thi\", \"s\\ndependency on the ordering of activities creates a function chain of execution.\\n\\nThe benefit of us\", \"ing Durable Functions to implement this workflow pattern comes from its ability to\\ndo checkpointing.\", \" If the server crashes, the network times out or some other issue occurs, Durable\\nfunctions can resu\", \"me from the last known state and continue running your workflow even if it\\u2019s on\\nanother server.\\n\\n[ F\", \"unctionName(\\\"PlaceOrder\\\") ]\\n\\npublic static async Task<string> PlaceOrder([OrchestrationTrigger |\\nDur\", \"ableOrchestrationContext context)\\n\\nOrderRequestData orderData = context.GetInput<OrderRequestData>()\", \" ;\\n\\nawait context.CallActivityAsync<bool>(\\\"CheckAndReserveInventory\\\", orderData) ;\\nawait context.Cal\", \"lActivityAsync<bool>(\\\"ProcessPayment\\\", orderData) ;\\n\\nstring trackingNumber = await context.CallActiv\", \"ityAsync<string>(\\\"ScheduleShipping\\\",\\norderData) ;\\nawait context.CallActivityAsync<string>(\\\"EmailCust\", \"omer\\\", trackingNumber) ;\\n\\nreturn trackingNumber ;\\n\\nIn the preceding code sample, the CallActivityAsy\", \"nc function Is responsible for running a given\\nactivity on a virtual machine in the data center. Whe\", \"n the await returns and the underlying Task\\ncompletes, the execution will be recorded to the history\", \" table. The code in the orchestrator function\\ncan make use of any of the familiar constructs of the \", \"Task Parallel Library and the async/await\\nkeywords.\\n\\nThe following code is a simplified example of w\", \"hat the ProcessPayment method may look like:\\n\\n[ FunctionName(\\\"ProcessPayment\\\" ) ]\\npublic static bool\", \" ProcessPayment([ActivityTrigger] DurableActivityContext context)\\n\\nt\\nOrderRequestData orderData = co\", \"ntext.GetInput<OrderRequestData>() ;\\n\\nApplyCoupons(orderData) ;\\n\\nif (IssuePaymentRequest(orderData))\", \" {\\nreturn true;\\n\\n5\\n\\nreturn false;\\n\\nAsynchronous HTTP APIs\\n\\nIn some cases, workflows may contain acti\", \"vities that take a relatively long period of time to complete.\\nImagine a process that kicks off the \", \"backup of media files into blob storage. Depending on the size\\nand quantity of the media files, this\", \" backup process may take hours to complete.\\n\\n40 CHAPTER 4 | Durable Azure Functions\\nIn this scenario\", \", the DurableOrchestrationClient\\u2019s ability to check the status of a running workflow\\nbecomes useful.\", \" When using an HttpTrigger to start a workflow, the CreateCheckStatusResponse\\nmethod can be used to \", \"return an instance of HttpResponseMessage. This response provides the client\\nwith a URI in the paylo\", \"ad that can be used to check the status of the running process.\\n\\n[ FunctionName(\\\"OrderWorkflow\\\" ) ]\\n\", \"\\npublic static async Task<HttpResponseMessage> Run(\\n[HttpTrigger(AuthorizationLevel.Function, \\\"POST\\\"\", \") ]HttpRequestMessage req,\\n[OrchestrationClient ] DurableOrchestrationClient orchestrationClient)\\n\\nO\", \"rderRequestData data = await req.Content.ReadAsAsync<OrderRequestData>();\\nstring instanceId = await \", \"orchestrationClient.StartNewAsync(\\\"PlaceOrder\\\", data) ;\\n\\nreturn orchestrationClient.CreateCheckStatu\", \"sResponse(req, instanceld) ;\\n\\nThe sample result below shows the structure of the response payload.\\n\\n\", \"\\\"id\\\": \\u201cinstancelId\\\",\\n\\n\\u201cstatusQueryGetUri\\\": \\\"http://host/statusUri\\\",\\n\\u201csendEventPostUri\\\": \\\"http://host\", \"/eventUri\\\",\\n\\u201cterminatePostuUri\\\": \\\"http://host/terminateUri\\\"\\n\\nUsing your preferred HTTP client, GET r\", \"equests can be made to the URI in statusQueryGetUri to\\ninspect the status of the running workflow. T\", \"he returned status response should resemble the\\nfollowing code.\\n\\n\\u201cruntimeStatus\\\": \\\"Running\\\",\\n\\\"input\\\"\", \": {\\n\\\"$type\\\": \\\"DurableFunctionsDemos.OrderRequestData, DurableFunctionsDemos\\\"\\n\\nhs\\n\\n\\\"output\\\": null,\\n\\n\\u201c\", \"createdTime\\\": \\\"2018-01-01T0@:22:05Z\\\",\\n\\u201clastUpdatedTime\\\": \\\"2018-@1-01T@0:22:09Z\\\"\\n\\nAs the process cont\", \"inues, the status response will change to either Failed or Completed. On\\nsuccessful completion, the \", \"output property in the payload will contain any returned data.\\n\\nMonitoring\\n\\nFor simple recurring tas\", \"ks, Azure Functions provides the TimerTrigger that can be scheduled based\\non a CRON expression. The \", \"timer works well for simple, short-lived tasks, but there might be scenarios\\nwhere more flexible sch\", \"eduling is needed. This scenario is when the monitoring pattern and Durable\\nFunctions can help.\\n\\nDur\", \"able Functions allows for flexible scheduling intervals, lifetime management, and the creation of\\nmu\", \"ltiple monitor processes from a single orchestration function. One use case for this functionality\\nm\", \"ight be to create watchers for stock price changes that complete once a certain threshold is met.\\n\\nA\", \"l CHAPTER 4 | Durable Azure Functions\\n[ FunctionName(\\\"CheckStockPrice\\u201d\\\" ) ]\\npublic static async Task\", \" CheckStockPrice([OrchestrationTrigger] DurableOrchestrationContext\\ncontext)\\n\\nt\\n\\nStockWatcherInfo st\", \"ockInfo = context.GetInput<StockwWatcherInfo>();\\nconst int checkIntervalSeconds = 120;\\nStockPrice in\", \"itialStockPrice = null;\\n\\nDateTime fireAt;\\nDateTime exitTime = context.CurrentUtcDateTime.Add(stockIn\", \"fo.TimeLimit) ;\\n\\nwhile (context.CurrentUtcDateTime < exitTime)\\n\\nt\\n\\nStockPrice currentStockPrice = aw\", \"ait\\ncontext.CallActivityAsync<StockPrice>(\\\"GetStockPrice\\\", stockInfo) ;\\n\\nif (initialStockPrice == nu\", \"ll)\\n\\n{\\ninitialStockPrice = currentStockPrice;\\nfireAt = context.CurrentUtcDateTime.AddSeconds(checkIn\", \"tervalSeconds) ;\\nawait context.CreateTimer(fireAt, CancellationToken.None) ;\\ncontinue;\\n}\\n\\ndecimal pe\", \"rcentageChange = (initialStockPrice.Price - currentStockPrice.Price) /\\n((initialStockPrice.Price + c\", \"urrentStockPrice.Price) / 2);\\n\\nif (Math.Abs(percentageChange) >= stockInfo.PercentageChange)\\n\\n// Cha\", \"nge threshold detected\\n\\nawait context.CallActivityAsync(\\\"NotifyStockPercentageChange\\\",\\ncurrentStockP\", \"rice) ;\\n\\nbreak;\\n\\n5\\n\\n// Sleep til next polling interval\\nfireAt = context.CurrentUtcDateTime.AddSecond\", \"s(checkIntervalSeconds ) ;\\nawait context.CreateTimer(fireAt, CancellationToken.None) ;\\n\\nDurableOrche\", \"strationContext's CreateTimer method sets up the schedule for the next invocation\\nof the loop to che\", \"ck for stock price changes. DurableOrchestrationContext also has a\\nCurrentUtcDateTime property to ge\", \"t the current DateTime value in UTC. It\\u2019s better to use this\\nproperty instead of DateTime .UtcNow be\", \"cause it's easily mocked for testing.\\n\\nRecommended resources\\n\\n\\u00b0 Azure Durable Functions\\n\\n\\u00b0 Unit Test\", \"ing in .NET Core and .NET Standard\\n\\n42 CHAPTER 4 | Durable Azure Functions\\nCHAPTER 5\\n\\nServerless bus\", \"iness\\nscenarios and use cases\\n\\nThere are many use cases and scenarios for serverless applications. T\", \"his chapter includes samples that\\nillustrate the different scenarios. The scenarios include links to\", \" related documentation and public\\nsource code repositories. The samples in this chapter enable you t\", \"o get started on your own building\\nand implementing serverless solutions.\\n\\nBig data processing\\n\\nThis\", \" example uses serverless to do a map/reduce operation on a big data set. It determines the\\naverage s\", \"peed of New York Yellow taxi trips per day in 2017.\\n\\nBig Data Processing: Serverless MapReduce on Az\", \"ure\\n\\nCreate serverless applications: hands-on lab\\nLearn how to use functions to execute server-side \", \"logic and build serverless architectures.\\n\\n. Choosing the best Azure service for your business\\n. Cre\", \"ating Azure Functions\\n\\n. Using triggers\\n\\n. Chaining functions\\n\\n. Long-running workflows\\n\\n\\u00b0 Monitorin\", \"g\\n\\n. Development, testing, and deployment\\n\\nCreate serverless applications\\n\\nCustomer reviews\\n\\nThis sa\", \"mple showcases the new Azure Functions tooling for C# Class Libraries in Visual Studio. Create\\na web\", \"site where customers submit product reviews that are stored in Azure storage blobs and\\n\\n43 CHAPTER 5\", \" | Serverless business scenarios and use cases\\nCosmosDB. Add an Azure Function to perform automated \", \"moderation of the customer reviews using\\nAzure Cognitive Services. Use an Azure storage queue to dec\", \"ouple the website from the function.\\n\\nCustomer Reviews App with Cognitive Services\\n\\nFile processing \", \"and validation\\n\\nThis example parses a set of CSV files from hypothetical customers. It ensures that \", \"all files required for\\na customer \\u201cbatch\\u201d are ready, then validates the structure of each file. Diff\", \"erent solutions are\\npresented using Azure Functions, Logic Apps, and Durable Functions.\\n\\nFile proces\", \"sing and validation using Azure Functions, Logic Apps, and Durable Functions\\n\\nGame data visualizatio\", \"n\\n\\nAn example of how a developer could implement an in-editor data visualization solution for their\\n\", \"game. In fact, an Unreal Engine 4 Plugin and Unity Plugin were developed using this sample as its\\nba\", \"ckend. The service component is game engine agnostic.\\n\\nIn-editor game telemetry visualization\\n\\nGraph\", \"QL\\n\\nCreate a serverless function that exposes a GraphQL API.\\n\\nServerless functions for GraphQL\\n\\nInte\", \"rnet of Things (loT) reliable edge relay\\n\\nThis sample implements a new communication protocol to ena\", \"ble reliable upstream communication\\nfrom loT devices. It automates data gap detection and backfill.\\n\", \"\\nloT Reliable Edge Relay\\n\\nMicroservices reference architecture\\n\\nA reference architecture that walks \", \"you through the decision-making process involved in designing,\\ndeveloping, and delivering the Ridesh\", \"are by Relecloud application (a fictitious company). It includes\\nhands-on instructions for configuri\", \"ng and deploying all of the architecture\\u2019s components.\\n\\n44 CHAPTER 5 | Serverless business scenarios\", \" and use cases\\nServerless Microservices reference architecture\\n\\nServerless for mobile\\n\\nAzure Functio\", \"ns are easy to implement and maintain, and accessible through HTTP. They are a great\\nway to implemen\", \"t an API for a mobile application. Microsoft offers great cross-platform tools for iOS,\\nAndroid, and\", \" Windows with Xamarin. As such, Xamarin and Azure Functions are working great\\ntogether. This article\", \" shows how to implement an Azure Function in the Azure portal or in Visual\\nStudio at first, and buil\", \"d a cross-platform client with Xamarin.Forms running on Android, iOS, and\\nWindows.\\n\\nImplementing a s\", \"imple Azure Function with a Xamarin.Forms client\\n\\nServerless messaging\\n\\nThis sample shows how to uti\", \"lize Durable Functions\\u2019 fan-out pattern to load an arbitrary number of\\nmessages across any number of\", \" sessions/partitions. It targets Service Bus, Event Hubs, or Storage\\nQueues. The sample also adds th\", \"e ability to consume those messages with another Azure Function\\nand load the resulting timing data i\", \"n to another Event Hub. The data is then ingested into analytics\\nservices like Azure Data Explorer.\\n\", \"\\nProduce and Consume messages through Service Bus, Event Hubs, and Storage Queues with Azure\\n\\nFuncti\", \"ons\\n\\nRecommended resources\\n\\n: Big Data Processing: Serverless MapReduce on Azure\\n\\n. Create serverles\", \"s applications\\n\\n: Customer Reviews App with Cognitive Services\\n\\n: File processing and validation usi\", \"ng Azure Functions, Logic Apps, and Durable Functions\\n\\n. Implementing a simple Azure Function with a\", \" Xamarin.Forms client\\n\\n: In-editor game telemetry visualization\\n\\n: loT Reliable Edge Relay\\n\\n. Produc\", \"e and Consume messages through Service Bus, Event Hubs, and Storage Queues with\\n\\nAzure Functions\\n\\n\\u00b0 \", \"Serverless functions for GraphQL\\n\\n\\u00b0 Serverless Microservices reference architecture\\n\\n45 CHAPTER 5 | \", \"Serverless business scenarios and use cases\\nCHAPTER\\n\\nConclusion\\n\\nThe following key takeaways are the\", \" most important conclusions from this guide.\\n\\nBenefits of using serverless. Serverless solutions pro\", \"vide the important benefit of cost savings\\nbecause serverless is implemented in a pay-per-use model.\", \" Serverless makes it possible to\\nindependently scale, test, and deploy individual components of your\", \" application. Serverless is uniquely\\nsuited to implement microservices architectures and integrates \", \"fully into a DevOps pipeline.\\n\\nCode as a unit of deployment. Serverless abstracts the hardware, OS, \", \"and runtime away from the\\napplication. Serverless enables focusing on business logic in code as the \", \"unit of deployment.\\n\\nTriggers and bindings. Serverless eases integration with storage, APIs, and oth\", \"er cloud resources.\\nAzure Functions provides triggers to execute code and bindings to interact with \", \"resources.\\n\\nMicroservices. The microservices architecture is becoming the preferred approach for dis\", \"tributed and\\nlarge or complex mission-critical applications that are based on multiple independent s\", \"ubsystems in\\nthe form of autonomous services. In a microservice-based architecture, the application \", \"is built as a\\ncollection of services that can be developed, tested, versioned, deployed, and scaled \", \"independently.\\nServerless is an architecture well-suited for building these services.\\n\\nServerless pl\", \"atforms. Serverless isn't just about the code. Platforms that support serverless\\narchitectures inclu\", \"de serverless workflows and orchestration, serverless messaging and event services,\\nand serverless d\", \"atabases.\\n\\nServerless challenges. Serverless introduces challenges related to distributed applicatio\", \"n\\ndevelopment, such as fragmented and independent data models, resiliency, versioning, and service\\nd\", \"iscovery. Serverless may not be ideally suited to long running processes or components that benefit\\n\", \"from tighter coupling.\\n\\nServerless as a tool, not the toolbox. Serverless is not the exclusive solut\", \"ion to application\\narchitecture. It is a tool that can be leveraged as part of a hybrid application \", \"that may contain\\ntraditional tiers, monolith back ends, and containers. Serverless can be used to en\", \"hance existing\\nsolutions and is not an all-or-nothing approach to application development.\\n\\n46 CHAPT\", \"ER 6 | Conclusion\\n\"]"