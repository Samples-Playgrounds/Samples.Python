,"[FunctionName(""CheckStockPrice"")]"
0,public static async Task CheckStockPrice([OrchestrationTrigger] DurableOrchestrationContext
1,context)
2,{
3,StockWatcherInfo stockInfo = context.GetInput<StockWatcherInfo>();
4,const int checkIntervalSeconds = 120;
5,StockPrice initialStockPrice = null;
6,
7,DateTime fireAt;
8,DateTime exitTime = context.CurrentUtcDateTime.Add(stockInfo.TimeLimit);
9,
10,while (context.CurrentUtcDateTime < exitTime)
11,{
12,StockPrice currentStockPrice = await
13,"context.CallActivityAsync<StockPrice>(""GetStockPrice"", stockInfo);"
14,
15,if (initialStockPrice == null)
16,{
17,initialStockPrice = currentStockPrice;
18,fireAt = context.CurrentUtcDateTime.AddSeconds(checkIntervalSeconds);
19,"await context.CreateTimer(fireAt, CancellationToken.None);"
20,continue;
21,}
22,
23,decimal percentageChange = (initialStockPrice.Price - currentStockPrice.Price) /
24,((initialStockPrice.Price + currentStockPrice.Price) / 2);
25,
26,if (Math.Abs(percentageChange) >= stockInfo.PercentageChange)
27,{
28,// Change threshold detected
29,"await context.CallActivityAsync(""NotifyStockPercentageChange"","
30,currentStockPrice);
31,break;
32,}
33,
34,// Sleep til next polling interval
35,fireAt = context.CurrentUtcDateTime.AddSeconds(checkIntervalSeconds);
36,"await context.CreateTimer(fireAt, CancellationToken.None);"
37,}
38,}
