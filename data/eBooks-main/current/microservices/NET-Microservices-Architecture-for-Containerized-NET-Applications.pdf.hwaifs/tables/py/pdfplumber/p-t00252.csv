,0
0,_logger = logger ?? throw new ArgumentNullException(nameof(logger));
1,}
2,
3,public async Task Handle(
4,"OrderStartedDomainEvent domainEvent, CancellationToken cancellationToken)"
5,{
6,var cardTypeId = domainEvent.CardTypeId != 0 ? domainEvent.CardTypeId : 1;
7,var buyer = await _buyerRepository.FindAsync(domainEvent.UserId);
8,var buyerExisted = buyer is not null;
9,
10,if (!buyerExisted)
11,{
12,"buyer = new Buyer(domainEvent.UserId, domainEvent.UserName);"
13,}
14,
15,buyer.VerifyOrAddPaymentMethod(
16,"cardTypeId,"
17,"$""Payment Method on {DateTime.UtcNow}"","
18,"domainEvent.CardNumber,"
19,"domainEvent.CardSecurityNumber,"
20,"domainEvent.CardHolderName,"
21,"domainEvent.CardExpiration,"
22,domainEvent.Order.Id);
23,
24,var buyerUpdated = buyerExisted ?
25,_buyerRepository.Update(buyer) :
26,_buyerRepository.Add(buyer);
27,
28,await _buyerRepository.UnitOfWork
29,.SaveEntitiesAsync(cancellationToken);
30,
31,var integrationEvent = new OrderStatusChangedToSubmittedIntegrationEvent(
32,"domainEvent.Order.Id, domainEvent.Order.OrderStatus.Name, buyer.Name);"
33,await _orderingIntegrationEventService.AddAndSaveEventAsync(integrationEvent);
34,
35,OrderingApiTrace.LogOrderBuyerAndPaymentValidatedOrUpdated(
36,"_logger, buyerUpdated.Id, domainEvent.Order.Id);"
37,}
38,}
