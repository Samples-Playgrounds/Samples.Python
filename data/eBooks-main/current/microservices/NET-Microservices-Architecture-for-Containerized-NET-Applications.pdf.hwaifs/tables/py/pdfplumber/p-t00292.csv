,0
0,"IIdentityService identityService,"
1,ILogger<CreateOrderCommandHandler> logger)
2,{
3,_orderRepository = orderRepository ?? throw new
4,ArgumentNullException(nameof(orderRepository));
5,_identityService = identityService ?? throw new
6,ArgumentNullException(nameof(identityService));
7,_mediator = mediator ?? throw new ArgumentNullException(nameof(mediator));
8,_orderingIntegrationEventService = orderingIntegrationEventService ?? throw new
9,ArgumentNullException(nameof(orderingIntegrationEventService));
10,_logger = logger ?? throw new ArgumentNullException(nameof(logger));
11,}
12,
13,"public async Task<bool> Handle(CreateOrderCommand message, CancellationToken"
14,cancellationToken)
15,{
16,// Add Integration event to clean the basket
17,var orderStartedIntegrationEvent = new
18,OrderStartedIntegrationEvent(message.UserId);
19,await
20,_orderingIntegrationEventService.AddAndSaveEventAsync(orderStartedIntegrationEvent);
21,
22,// Add/Update the Buyer AggregateRoot
23,// DDD patterns comment: Add child entities and value-objects through the Order
24,Aggregate-Root
25,"// methods and constructor so validations, invariants and business logic"
26,// make sure that consistency is preserved across the whole aggregate
27,"var address = new Address(message.Street, message.City, message.State,"
28,"message.Country, message.ZipCode);"
29,"var order = new Order(message.UserId, message.UserName, address,"
30,"message.CardTypeId, message.CardNumber, message.CardSecurityNumber, message.CardHolderName,"
31,message.CardExpiration);
32,
33,foreach (var item in message.OrderItems)
34,{
35,"order.AddOrderItem(item.ProductId, item.ProductName, item.UnitPrice,"
36,"item.Discount, item.PictureUrl, item.Units);"
37,}
38,
39,"_logger.LogInformation(""----- Creating Order - Order: {@Order}"", order);"
40,
41,_orderRepository.Add(order);
42,
43,return await _orderRepository.UnitOfWork
44,.SaveEntitiesAsync(cancellationToken);
45,}
46,}
