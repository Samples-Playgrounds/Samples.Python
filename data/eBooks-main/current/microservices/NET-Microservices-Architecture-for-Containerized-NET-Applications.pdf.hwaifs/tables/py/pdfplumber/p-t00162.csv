,0
0,if (catalogItem == null) return NotFound();
1,
2,bool raiseProductPriceChangedEvent = false;
3,IntegrationEvent priceChangedEvent = null;
4,
5,if (catalogItem.Price != productToUpdate.Price)
6,raiseProductPriceChangedEvent = true;
7,
8,if (raiseProductPriceChangedEvent) // Create event if price has changed
9,{
10,var oldPrice = catalogItem.Price;
11,"priceChangedEvent = new ProductPriceChangedIntegrationEvent(catalogItem.Id,"
12,"productToUpdate.Price,"
13,oldPrice);
14,}
15,// Update current product
16,catalogItem = productToUpdate;
17,
18,// Just save the updated product if the Product's Price hasn't changed.
19,if (!raiseProductPriceChangedEvent)
20,{
21,await _catalogContext.SaveChangesAsync();
22,}
23,else // Publish to event bus only if product price changed
24,{
25,// Achieving atomicity between original DB and the IntegrationEventLog
26,// with a local transaction
27,using (var transaction = _catalogContext.Database.BeginTransaction())
28,{
29,_catalogContext.CatalogItems.Update(catalogItem);
30,await _catalogContext.SaveChangesAsync();
31,
32,await _integrationEventLogService.SaveEventAsync(priceChangedEvent);
33,
34,transaction.Commit();
35,}
36,
37,// Publish the integration event through the event bus
38,_eventBus.Publish(priceChangedEvent);
39,
40,_integrationEventLogService.MarkEventAsPublishedAsync(
41,priceChangedEvent);
42,}
43,
44,return Ok();
45,}
