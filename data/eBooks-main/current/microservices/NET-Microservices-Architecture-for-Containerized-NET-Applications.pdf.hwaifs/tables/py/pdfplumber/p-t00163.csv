,0
0,namespace Microsoft.eShopOnContainers.Services.Basket.API.IntegrationEvents.EventHandling
1,{
2,public class ProductPriceChangedIntegrationEventHandler :
3,IIntegrationEventHandler<ProductPriceChangedIntegrationEvent>
4,{
5,private readonly IBasketRepository _repository;
6,
7,public ProductPriceChangedIntegrationEventHandler(
8,IBasketRepository repository)
9,{
10,_repository = repository;
11,}
12,
13,public async Task Handle(ProductPriceChangedIntegrationEvent @event)
14,{
15,var userIds = await _repository.GetUsers();
16,foreach (var id in userIds)
17,{
18,var basket = await _repository.GetBasket(id);
19,"await UpdatePriceInBasketItems(@event.ProductId, @event.NewPrice, basket);"
20,}
21,}
22,
23,"private async Task UpdatePriceInBasketItems(int productId, decimal newPrice,"
24,CustomerBasket basket)
25,{
26,var itemsToUpdate = basket?.Items?.Where(x => int.Parse(x.ProductId) ==
27,productId).ToList();
28,if (itemsToUpdate != null)
29,{
30,foreach (var item in itemsToUpdate)
31,{
32,if(item.UnitPrice != newPrice)
33,{
34,var originalPrice = item.UnitPrice;
35,item.UnitPrice = newPrice;
36,item.OldUnitPrice = originalPrice;
37,}
38,}
39,await _repository.UpdateBasket(basket);
40,}
41,}
42,}
43,}
