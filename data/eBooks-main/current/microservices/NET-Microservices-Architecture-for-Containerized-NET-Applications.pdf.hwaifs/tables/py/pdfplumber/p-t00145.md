|    | 0                                                                           |
|---:|:----------------------------------------------------------------------------|
|  0 | public static IWebHost MigrateDbContext<TContext>(                          |
|  1 | this IWebHost host,                                                         |
|  2 | Action<TContext,                                                            |
|  3 | IServiceProvider> seeder)                                                   |
|  4 | where TContext : DbContext                                                  |
|  5 | {                                                                           |
|  6 | var underK8s = host.IsInKubernetes();                                       |
|  7 |                                                                             |
|  8 | using (var scope = host.Services.CreateScope())                             |
|  9 | {                                                                           |
| 10 | var services = scope.ServiceProvider;                                       |
| 11 |                                                                             |
| 12 | var logger = services.GetRequiredService<ILogger<TContext>>();              |
| 13 |                                                                             |
| 14 | var context = services.GetService<TContext>();                              |
| 15 |                                                                             |
| 16 | try                                                                         |
| 17 | {                                                                           |
| 18 | logger.LogInformation("Migrating database associated with context           |
| 19 | {DbContextName}", typeof(TContext).Name);                                   |
| 20 |                                                                             |
| 21 | if (underK8s)                                                               |
| 22 | {                                                                           |
| 23 | InvokeSeeder(seeder, context, services);                                    |
| 24 | }                                                                           |
| 25 | else                                                                        |
| 26 | {                                                                           |
| 27 | var retry = Policy.Handle<SqlException>()                                   |
| 28 | .WaitAndRetry(new TimeSpan[]                                                |
| 29 | {                                                                           |
| 30 | TimeSpan.FromSeconds(3),                                                    |
| 31 | TimeSpan.FromSeconds(5),                                                    |
| 32 | TimeSpan.FromSeconds(8),                                                    |
| 33 | });                                                                         |
| 34 |                                                                             |
| 35 | //if the sql server container is not created on run docker compose this     |
| 36 | //migration can't fail for network related exception. The retry options for |
| 37 | DbContext only                                                              |
| 38 | //apply to transient exceptions                                             |
| 39 | // Note that this is NOT applied when running some orchestrators (let the   |
| 40 | orchestrator to recreate the failing service)                               |
| 41 | retry.Execute(() => InvokeSeeder(seeder, context, services));               |
| 42 | }                                                                           |
| 43 |                                                                             |
| 44 | logger.LogInformation("Migrated database associated with context            |
| 45 | {DbContextName}", typeof(TContext).Name);                                   |
| 46 | }                                                                           |
| 47 | catch (Exception ex)                                                        |
| 48 | {                                                                           |
| 49 | logger.LogError(ex, "An error occurred while migrating the database used on |
| 50 | context {DbContextName}", typeof(TContext).Name);                           |
| 51 | if (underK8s)                                                               |
| 52 | {                                                                           |
| 53 | throw; // Rethrow under k8s because we rely on k8s to re-run the            |