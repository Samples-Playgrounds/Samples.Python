,0
0,// Sample SQL Connection Health Check
1,public class SqlConnectionHealthCheck : IHealthCheck
2,{
3,"private const string DefaultTestQuery = ""Select 1"";"
4,
5,public string ConnectionString { get; }
6,
7,public string TestQuery { get; }
8,
9,public SqlConnectionHealthCheck(string connectionString)
10,": this(connectionString, testQuery: DefaultTestQuery)"
11,{
12,}
13,
14,"public SqlConnectionHealthCheck(string connectionString, string testQuery)"
15,{
16,ConnectionString = connectionString ?? throw new
17,ArgumentNullException(nameof(connectionString));
18,TestQuery = testQuery;
19,}
20,
21,"public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context,"
22,CancellationToken cancellationToken = default(CancellationToken))
23,{
24,using (var connection = new SqlConnection(ConnectionString))
25,{
26,try
27,{
28,await connection.OpenAsync(cancellationToken);
29,
30,if (TestQuery != null)
31,{
32,var command = connection.CreateCommand();
33,command.CommandText = TestQuery;
34,
35,await command.ExecuteNonQueryAsync(cancellationToken);
36,}
37,}
38,catch (DbException ex)
39,{
40,"return new HealthCheckResult(status: context.Registration.FailureStatus,"
41,exception: ex);
42,}
43,}
44,
45,return HealthCheckResult.Healthy();
46,}
47,}
