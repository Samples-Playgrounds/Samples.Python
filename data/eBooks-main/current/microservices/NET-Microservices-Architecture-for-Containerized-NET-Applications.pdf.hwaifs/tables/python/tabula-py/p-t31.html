<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>public static IWebHost MigrateDbContext&lt;TContext&gt;(</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>this IWebHost host,</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Action&lt;TContext,</td>
    </tr>
    <tr>
      <th>2</th>
      <td>IServiceProvider&gt; seeder)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>where TContext : DbContext</td>
    </tr>
    <tr>
      <th>4</th>
      <td>{</td>
    </tr>
    <tr>
      <th>5</th>
      <td>var underK8s = host.IsInKubernetes();</td>
    </tr>
    <tr>
      <th>6</th>
      <td></td>
    </tr>
    <tr>
      <th>7</th>
      <td>using (var scope = host.Services.CreateScope())</td>
    </tr>
    <tr>
      <th>8</th>
      <td>{</td>
    </tr>
    <tr>
      <th>9</th>
      <td>var services = scope.ServiceProvider;</td>
    </tr>
    <tr>
      <th>10</th>
      <td></td>
    </tr>
    <tr>
      <th>11</th>
      <td>var logger = services.GetRequiredService&lt;ILogger&lt;TContext&gt;&gt;();</td>
    </tr>
    <tr>
      <th>12</th>
      <td></td>
    </tr>
    <tr>
      <th>13</th>
      <td>var context = services.GetService&lt;TContext&gt;();</td>
    </tr>
    <tr>
      <th>14</th>
      <td></td>
    </tr>
    <tr>
      <th>15</th>
      <td>try</td>
    </tr>
    <tr>
      <th>16</th>
      <td>{</td>
    </tr>
    <tr>
      <th>17</th>
      <td>logger.LogInformation("Migrating database associated with context</td>
    </tr>
    <tr>
      <th>18</th>
      <td>{DbContextName}", typeof(TContext).Name);</td>
    </tr>
    <tr>
      <th>19</th>
      <td></td>
    </tr>
    <tr>
      <th>20</th>
      <td>if (underK8s)</td>
    </tr>
    <tr>
      <th>21</th>
      <td>{</td>
    </tr>
    <tr>
      <th>22</th>
      <td>InvokeSeeder(seeder, context, services);</td>
    </tr>
    <tr>
      <th>23</th>
      <td>}</td>
    </tr>
    <tr>
      <th>24</th>
      <td>else</td>
    </tr>
    <tr>
      <th>25</th>
      <td>{</td>
    </tr>
    <tr>
      <th>26</th>
      <td>var retry = Policy.Handle&lt;SqlException&gt;()</td>
    </tr>
    <tr>
      <th>27</th>
      <td>.WaitAndRetry(new TimeSpan[]</td>
    </tr>
    <tr>
      <th>28</th>
      <td>{</td>
    </tr>
    <tr>
      <th>29</th>
      <td>TimeSpan.FromSeconds(3),</td>
    </tr>
    <tr>
      <th>30</th>
      <td>TimeSpan.FromSeconds(5),</td>
    </tr>
    <tr>
      <th>31</th>
      <td>TimeSpan.FromSeconds(8),</td>
    </tr>
    <tr>
      <th>32</th>
      <td>});</td>
    </tr>
    <tr>
      <th>33</th>
      <td></td>
    </tr>
    <tr>
      <th>34</th>
      <td>//if the sql server container is not created on run docker compose this</td>
    </tr>
    <tr>
      <th>35</th>
      <td>//migration can't fail for network related exception. The retry options for</td>
    </tr>
    <tr>
      <th>36</th>
      <td>DbContext only</td>
    </tr>
    <tr>
      <th>37</th>
      <td>//apply to transient exceptions</td>
    </tr>
    <tr>
      <th>38</th>
      <td>// Note that this is NOT applied when running some orchestrators (let the</td>
    </tr>
    <tr>
      <th>39</th>
      <td>orchestrator to recreate the failing service)</td>
    </tr>
    <tr>
      <th>40</th>
      <td>retry.Execute(() =&gt; InvokeSeeder(seeder, context, services));</td>
    </tr>
    <tr>
      <th>41</th>
      <td>}</td>
    </tr>
    <tr>
      <th>42</th>
      <td></td>
    </tr>
    <tr>
      <th>43</th>
      <td>logger.LogInformation("Migrated database associated with context</td>
    </tr>
    <tr>
      <th>44</th>
      <td>{DbContextName}", typeof(TContext).Name);</td>
    </tr>
    <tr>
      <th>45</th>
      <td>}</td>
    </tr>
    <tr>
      <th>46</th>
      <td>catch (Exception ex)</td>
    </tr>
    <tr>
      <th>47</th>
      <td>{</td>
    </tr>
    <tr>
      <th>48</th>
      <td>logger.LogError(ex, "An error occurred while migrating the database used on</td>
    </tr>
    <tr>
      <th>49</th>
      <td>context {DbContextName}", typeof(TContext).Name);</td>
    </tr>
    <tr>
      <th>50</th>
      <td>if (underK8s)</td>
    </tr>
    <tr>
      <th>51</th>
      <td>{</td>
    </tr>
    <tr>
      <th>52</th>
      <td>throw;          // Rethrow under k8s because we rely on k8s to re-run the</td>
    </tr>
  </tbody>
</table>