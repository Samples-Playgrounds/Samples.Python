|    | namespace Microsoft.eShopOnContainers.Services.Basket.API.IntegrationEvents.EventHandling   |
|---:|:--------------------------------------------------------------------------------------------|
|  0 | {                                                                                           |
|  1 | public class ProductPriceChangedIntegrationEventHandler :                                   |
|  2 | IIntegrationEventHandler<ProductPriceChangedIntegrationEvent>                               |
|  3 | {                                                                                           |
|  4 | private readonly IBasketRepository _repository;                                             |
|  5 |                                                                                             |
|  6 | public ProductPriceChangedIntegrationEventHandler(                                          |
|  7 | IBasketRepository repository)                                                               |
|  8 | {                                                                                           |
|  9 | _repository = repository;                                                                   |
| 10 | }                                                                                           |
| 11 |                                                                                             |
| 12 | public async Task Handle(ProductPriceChangedIntegrationEvent @event)                        |
| 13 | {                                                                                           |
| 14 | var userIds = await _repository.GetUsers();                                                 |
| 15 | foreach (var id in userIds)                                                                 |
| 16 | {                                                                                           |
| 17 | var basket = await _repository.GetBasket(id);                                               |
| 18 | await UpdatePriceInBasketItems(@event.ProductId, @event.NewPrice, basket);                  |
| 19 | }                                                                                           |
| 20 | }                                                                                           |
| 21 |                                                                                             |
| 22 | private async Task UpdatePriceInBasketItems(int productId, decimal newPrice,                |
| 23 | CustomerBasket basket)                                                                      |
| 24 | {                                                                                           |
| 25 | var itemsToUpdate = basket?.Items?.Where(x => int.Parse(x.ProductId) ==                     |
| 26 | productId).ToList();                                                                        |
| 27 | if (itemsToUpdate != null)                                                                  |
| 28 | {                                                                                           |
| 29 | foreach (var item in itemsToUpdate)                                                         |
| 30 | {                                                                                           |
| 31 | if(item.UnitPrice != newPrice)                                                              |
| 32 | {                                                                                           |
| 33 | var originalPrice = item.UnitPrice;                                                         |
| 34 | item.UnitPrice = newPrice;                                                                  |
| 35 | item.OldUnitPrice = originalPrice;                                                          |
| 36 | }                                                                                           |
| 37 | }                                                                                           |
| 38 | await _repository.UpdateBasket(basket);                                                     |
| 39 | }                                                                                           |
| 40 | }                                                                                           |
| 41 | }                                                                                           |
| 42 | }                                                                                           |