,"IIdentityService identityService,"
0,ILogger<CreateOrderCommandHandler> logger)
1,{
2,_orderRepository = orderRepository ?? throw new
3,ArgumentNullException(nameof(orderRepository));
4,_identityService = identityService ?? throw new
5,ArgumentNullException(nameof(identityService));
6,_mediator = mediator ?? throw new ArgumentNullException(nameof(mediator));
7,_orderingIntegrationEventService = orderingIntegrationEventService ?? throw new
8,ArgumentNullException(nameof(orderingIntegrationEventService));
9,_logger = logger ?? throw new ArgumentNullException(nameof(logger));
10,}
11,
12,"public async Task<bool> Handle(CreateOrderCommand message, CancellationToken"
13,cancellationToken)
14,{
15,// Add Integration event to clean the basket
16,var orderStartedIntegrationEvent = new
17,OrderStartedIntegrationEvent(message.UserId);
18,await
19,_orderingIntegrationEventService.AddAndSaveEventAsync(orderStartedIntegrationEvent);
20,
21,// Add/Update the Buyer AggregateRoot
22,// DDD patterns comment: Add child entities and value-objects through the Order
23,Aggregate-Root
24,"// methods and constructor so validations, invariants and business logic"
25,// make sure that consistency is preserved across the whole aggregate
26,"var address = new Address(message.Street, message.City, message.State,"
27,"message.Country, message.ZipCode);"
28,"var order = new Order(message.UserId, message.UserName, address,"
29,"message.CardTypeId, message.CardNumber, message.CardSecurityNumber, message.CardHolderName,"
30,message.CardExpiration);
31,
32,foreach (var item in message.OrderItems)
33,{
34,"order.AddOrderItem(item.ProductId, item.ProductName, item.UnitPrice,"
35,"item.Discount, item.PictureUrl, item.Units);"
36,}
37,
38,"_logger.LogInformation(""----- Creating Order - Order: {@Order}"", order);"
39,
40,_orderRepository.Add(order);
41,
42,return await _orderRepository.UnitOfWork
43,.SaveEntitiesAsync(cancellationToken);
44,}
45,}
