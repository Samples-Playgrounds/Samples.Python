|    | public static IWebHost MigrateDbContext<TContext>(                          |
|---:|:----------------------------------------------------------------------------|
|  0 | this IWebHost host,                                                         |
|  1 | Action<TContext,                                                            |
|  2 | IServiceProvider> seeder)                                                   |
|  3 | where TContext : DbContext                                                  |
|  4 | {                                                                           |
|  5 | var underK8s = host.IsInKubernetes();                                       |
|  6 |                                                                             |
|  7 | using (var scope = host.Services.CreateScope())                             |
|  8 | {                                                                           |
|  9 | var services = scope.ServiceProvider;                                       |
| 10 |                                                                             |
| 11 | var logger = services.GetRequiredService<ILogger<TContext>>();              |
| 12 |                                                                             |
| 13 | var context = services.GetService<TContext>();                              |
| 14 |                                                                             |
| 15 | try                                                                         |
| 16 | {                                                                           |
| 17 | logger.LogInformation("Migrating database associated with context           |
| 18 | {DbContextName}", typeof(TContext).Name);                                   |
| 19 |                                                                             |
| 20 | if (underK8s)                                                               |
| 21 | {                                                                           |
| 22 | InvokeSeeder(seeder, context, services);                                    |
| 23 | }                                                                           |
| 24 | else                                                                        |
| 25 | {                                                                           |
| 26 | var retry = Policy.Handle<SqlException>()                                   |
| 27 | .WaitAndRetry(new TimeSpan[]                                                |
| 28 | {                                                                           |
| 29 | TimeSpan.FromSeconds(3),                                                    |
| 30 | TimeSpan.FromSeconds(5),                                                    |
| 31 | TimeSpan.FromSeconds(8),                                                    |
| 32 | });                                                                         |
| 33 |                                                                             |
| 34 | //if the sql server container is not created on run docker compose this     |
| 35 | //migration can't fail for network related exception. The retry options for |
| 36 | DbContext only                                                              |
| 37 | //apply to transient exceptions                                             |
| 38 | // Note that this is NOT applied when running some orchestrators (let the   |
| 39 | orchestrator to recreate the failing service)                               |
| 40 | retry.Execute(() => InvokeSeeder(seeder, context, services));               |
| 41 | }                                                                           |
| 42 |                                                                             |
| 43 | logger.LogInformation("Migrated database associated with context            |
| 44 | {DbContextName}", typeof(TContext).Name);                                   |
| 45 | }                                                                           |
| 46 | catch (Exception ex)                                                        |
| 47 | {                                                                           |
| 48 | logger.LogError(ex, "An error occurred while migrating the database used on |
| 49 | context {DbContextName}", typeof(TContext).Name);                           |
| 50 | if (underK8s)                                                               |
| 51 | {                                                                           |
| 52 | throw;          // Rethrow under k8s because we rely on k8s to re-run the   |