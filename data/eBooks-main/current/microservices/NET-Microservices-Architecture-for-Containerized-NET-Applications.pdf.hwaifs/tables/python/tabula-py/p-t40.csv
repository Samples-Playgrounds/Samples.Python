,if (catalogItem == null) return NotFound();
0,
1,bool raiseProductPriceChangedEvent = false;
2,IntegrationEvent priceChangedEvent = null;
3,
4,if (catalogItem.Price != productToUpdate.Price)
5,raiseProductPriceChangedEvent = true;
6,
7,if (raiseProductPriceChangedEvent) // Create event if price has changed
8,{
9,var oldPrice = catalogItem.Price;
10,"priceChangedEvent = new ProductPriceChangedIntegrationEvent(catalogItem.Id,"
11,"productToUpdate.Price,"
12,oldPrice);
13,}
14,// Update current product
15,catalogItem = productToUpdate;
16,
17,// Just save the updated product if the Product's Price hasn't changed.
18,if (!raiseProductPriceChangedEvent)
19,{
20,await _catalogContext.SaveChangesAsync();
21,}
22,else  // Publish to event bus only if product price changed
23,{
24,// Achieving atomicity between original DB and the IntegrationEventLog
25,// with a local transaction
26,using (var transaction = _catalogContext.Database.BeginTransaction())
27,{
28,_catalogContext.CatalogItems.Update(catalogItem);
29,await _catalogContext.SaveChangesAsync();
30,
31,await _integrationEventLogService.SaveEventAsync(priceChangedEvent);
32,
33,transaction.Commit();
34,}
35,
36,// Publish the integration event through the event bus
37,_eventBus.Publish(priceChangedEvent);
38,
39,_integrationEventLogService.MarkEventAsPublishedAsync(
40,priceChangedEvent);
41,}
42,
43,return Ok();
44,}
