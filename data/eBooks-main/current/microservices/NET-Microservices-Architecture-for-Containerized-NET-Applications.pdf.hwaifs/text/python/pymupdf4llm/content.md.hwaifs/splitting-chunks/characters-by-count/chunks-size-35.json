"[\"**EDITION v7.0** - Updated to ASP.NET Core 7.0\\n\\n\\n[Refer changelog](https://aka.ms/MicroservicesEbook\", \"Changelog) for the book updates and community contributions.\\n\\n\\nThis guide is an introduction to deve\", \"loping microservices-based applications and managing them\\nusing containers. It discusses architectur\", \"al design and implementation approaches using .NET and\\nDocker containers.\\n\\n\\nTo make it easier to get\", \" started, the guide focuses on a reference containerized and microservicebased application that you \", \"can explore. The reference application is available at the\\n[eShopOnContainers](https://github.com/do\", \"tnet-architecture/eShopOnContainers) GitHub repo.\\n### Action links\\n\\n\\n  - [This e-book is also availa\", \"ble in a PDF format (English version only) Download](https://aka.ms/microservicesebook)\\n\\n\\n  - [Clone\", \"/Fork the reference application eShopOnContainers on GitHub](https://github.com/dotnet-architecture/\", \"eShopOnContainers)\\n\\n\\n  - [Watch the introductory video](https://aka.ms/microservices-video)\\n\\n\\n  - [G\", \"et to know the Microservices Architecture right away](https://aka.ms/MicroservicesArchitecture)\\n### \", \"Introduction\\n\\n\\nEnterprises are increasingly realizing cost savings, solving deployment problems, and\", \" improving\\nDevOps and production operations by using containers. Microsoft has been releasing contai\", \"ner\\ninnovations for Windows and Linux by creating products like Azure Kubernetes Service and Azure\\nS\", \"ervice Fabric, and by partnering with industry leaders like Docker, Mesosphere, and Kubernetes.\\nThes\", \"e products deliver container solutions that help companies build and deploy applications at cloud\\nsp\", \"eed and scale, whatever their choice of platform or tools.\\n\\n\\nDocker is becoming the de facto standar\", \"d in the container industry, supported by the most significant\\nvendors in the Windows and Linux ecos\", \"ystems. (Microsoft is one of the main cloud vendors\\nsupporting Docker). In the future, Docker will p\", \"robably be ubiquitous in any datacenter in the cloud or\\non-premises.\\n\\n\\n[In addition, the microservic\", \"es architecture is emerging as an important approach for distributed](https://martinfowler.com/artic\", \"les/microservices.html)\\nmission-critical applications. In a microservice-based architecture, the app\", \"lication is built on a\\ncollection of services that can be developed, tested, deployed, and versioned\", \" independently.\\n### About this guide\\n\\n\\nThis guide is an introduction to developing microservices-bas\", \"ed applications and managing them\\nusing containers. It discusses architectural design and implementa\", \"tion approaches using .NET and\\nDocker containers. To make it easier to get started with containers a\", \"nd microservices, the guide\\nfocuses on a reference containerized and microservice-based application \", \"that you can explore. The\\n[sample application is available at the eShopOnContainers](https://github.\", \"com/dotnet-architecture/eShopOnContainers) GitHub repo.\\n\\n\\nThis guide provides foundational developme\", \"nt and architectural guidance primarily at a development\\nenvironment level with a focus on two techn\", \"ologies: Docker and .NET. Our intention is that you read\\nthis guide when thinking about your applica\", \"tion design without focusing on the infrastructure (cloud\\nor on-premises) of your production environ\", \"ment. You will make decisions about your infrastructure\\nlater, when you create your production-ready\", \" applications. Therefore, this guide is intended to be\\ninfrastructure agnostic and more development-\", \"environment-centric.\\n\\n\\nAfter you have studied this guide, your next step would be to learn about pro\", \"duction-ready\\nmicroservices on Microsoft Azure.\\n### Version\\n\\n\\nThis guide has been revised to cover *\", \"*.NET 7** version along with many additional updates related to\\nthe same \\u201cwave\\u201d of technologies (tha\", \"t is, Azure and additional third-party technologies) coinciding in\\ntime with the .NET 7 release. Tha\", \"t\\u2019s why the book version has also been updated to version **7.0** .\\n### What this guide does not cov\", \"er\\n\\n\\nThis guide does not focus on the application lifecycle, DevOps, CI/CD pipelines, or team work. \", \"The\\n[complementary guide Containerized Docker Application Lifecycle with Microsoft Platform and Tool\", \"s](https://aka.ms/dockerlifecycleebook)\\nfocuses on that subject. The current guide also does not pro\", \"vide implementation details on Azure\\ninfrastructure, such as information on specific orchestrators.\\n\", \"#### **Additional resources**\\n\\n\\n  - Containerized Docker Application Lifecycle with Microsoft Platfo\", \"rm and Tools (downloadable\\ne-book)\\n[https://aka.ms/dockerlifecycleebook](https://aka.ms/dockerlifecy\", \"cleebook)\\n### Who should use this guide\\n\\n\\nWe wrote this guide for developers and solution architects\", \" who are new to Docker-based application\\ndevelopment and to microservices-based architecture. This g\", \"uide is for you if you want to learn how\\nto architect, design, and implement proof-of-concept applic\", \"ations with Microsoft development\\ntechnologies (with special focus on .NET) and with Docker containe\", \"rs.\\n\\n\\nYou will also find this guide useful if you are a technical decision maker, such as an enterpr\", \"ise\\narchitect, who wants an architecture and technology overview before you decide on what approach \", \"to\\nselect for new and modern distributed applications.\\n#### **How to use this guide**\\n\\n\\nThe first pa\", \"rt of this guide introduces Docker containers, discusses how to choose between .NET 7 and\\nthe .NET F\", \"ramework as a development framework, and provides an overview of microservices. This\\ncontent is for \", \"architects and technical decision makers who want an overview but don\\u2019t need to focus\\non code implem\", \"entation details.\\n\\n\\nThe second part of the guide starts with the Development process for Docker base\", \"d applications\\nsection. It focuses on the development and microservice patterns for implementing app\", \"lications using\\n.NET and Docker. This section will be of most interest to developers and architects \", \"who want to focus\\non code and on patterns and implementation details.\\n### Related microservice and c\", \"ontainer-based reference application: eShopOnContainers\\n\\n\\nThe eShopOnContainers application is an op\", \"en-source reference app for .NET and microservices that\\nis designed to be deployed using Docker cont\", \"ainers. The application consists of multiple subsystems,\\nincluding several e-store UI front-ends (a \", \"Web MVC app, a Web SPA, and a native mobile app). It also\\nincludes the back-end microservices and co\", \"ntainers for all required server-side operations.\\n\\n\\nThe purpose of the application is to showcase ar\", \"chitectural patterns. **IT IS NOT A PRODUCTION-**\\n**READY TEMPLATE** to start real-world application\", \"s. In fact, the application is in a permanent beta\\nstate, as it\\u2019s also used to test new potentially \", \"interesting technologies as they show up.\\n### Credits\\n\\n\\nCo-Authors:\\n\\n\\n**Cesar de la Torre**, Sr. PM,\", \" .NET product team, Microsoft Corp.\\n\\n\\n**Bill Wagner**, Sr. Content Developer, C+E, Microsoft Corp.\\n\\n\", \"\\n**Mike Rousos**, Principal Software Engineer, DevDiv CAT team, Microsoft\\n\\n\\nEditors:\\n\\n\\n**Mike Pope**\", \"\\n\\n\\n**Steve Hoag**\\n\\n\\nParticipants and reviewers:\\n\\n\\n**Jeffrey Richter**, Partner Software Eng, Azure t\", \"eam, Microsoft\\n\\n\\n**Jimmy Bogard**, Chief Architect at Headspring\\n\\n\\n**Udi Dahan**, Founder & CEO, Par\", \"ticular Software\\n\\n\\n**Jimmy Nilsson**, Co-founder and CEO of Factor10\\n\\n\\n**Glenn Condron**, Sr. Progra\", \"m Manager, ASP.NET team\\n\\n\\n**Mark Fussell**, Principal PM Lead, Azure Service Fabric team, Microsoft\\n\", \"\\n\\n**Diego Vega**, PM Lead, Entity Framework team, Microsoft\\n\\n\\n**Barry Dorrans**, Sr. Security Progra\", \"m Manager\\n\\n\\n**Rowan Miller**, Sr. Program Manager, Microsoft\\n\\n\\n**Ankit Asthana**, Principal PM Manag\", \"er, .NET team, Microsoft\\n\\n\\n**Scott Hunter**, Partner Director PM, .NET team, Microsoft\\n\\n\\n**Nish Anil\", \"**, Sr. Program Manager, .NET team, Microsoft\\n\\n\\n**Dylan Reisenberger**, Architect and Dev Lead at Po\", \"lly\\n\\n\\n**Steve \\u201cardalis\\u201d Smith** [- Software Architect and Trainer - Ardalis.com](https://ardalis.com\", \"/)\\n\\n\\n**Ian Cooper**, Coding Architect at Brighter\\n\\n\\n**Unai Zorrilla**, Architect and Dev Lead at Pla\", \"in Concepts\\n\\n\\n**Eduard Tomas**, Dev Lead at Plain Concepts\\n\\n\\n**Ramon Tomas**, Developer at Plain Con\", \"cepts\\n\\n\\n**David Sanz**, Developer at Plain Concepts\\n\\n\\n**Javier Valero**, Chief Operating Officer at \", \"Grupo Solutio\\n\\n\\n**Pierre Millet**, Sr. Consultant, Microsoft\\n\\n\\n**Michael Friis**, Product Manager, D\", \"ocker Inc\\n\\n\\n**Charles Lowell**, Software Engineer, VS CAT team, Microsoft\\n\\n\\n**Miguel Veloso**, Softw\", \"are Development Engineer at Plain Concepts\\n\\n\\n**Sumit Ghosh**, Principal Consultant at Neudesic\\n### C\", \"opyright\\n\\n\\nPUBLISHED BY\\n\\n\\nMicrosoft Developer Division, .NET and Visual Studio product teams\\n\\n\\nA div\", \"ision of Microsoft Corporation\\n\\n\\nOne Microsoft Way\\n\\n\\nRedmond, Washington 98052-6399\\n\\n\\nCopyright \\u00a9 20\", \"23 by Microsoft Corporation\\n\\n\\nAll rights reserved. No part of the contents of this book may be repro\", \"duced or transmitted in any\\nform or by any means without the written permission of the publisher.\\n\\n\\n\", \"This book is provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The views, opinions and\", \"\\ninformation expressed in this book, including URL and other Internet website references, may change\", \"\\nwithout notice.\\n\\n\\nSome examples depicted herein are provided for illustration only and are fictitio\", \"us. No real association\\nor connection is intended or should be inferred.\\n\\n\\n[Microsoft and the tradem\", \"arks listed at https://www.microsoft.com](https://www.microsoft.com/) on the \\u201cTrademarks\\u201d webpage ar\", \"e\\ntrademarks of the Microsoft group of companies.\\n\\n\\nMac and macOS are trademarks of Apple Inc.\\n\\n\\nThe\", \" Docker whale logo is a registered trademark of Docker, Inc. Used by permission.\\n\\n\\nAll other marks a\", \"nd logos are property of their respective owners.\\n\\n\\n## Contents\\n\\n**Introduction to Containers and Do\", \"cker ................................................................................ 1**\\n\\n\\nWhat is \", \"Docker? ............................................................................................\", \"............................................................................ 2\\n\\n\\nComparing Docker co\", \"ntainers with virtual machines .....................................................................\", \"...................... 3\\n\\n\\nA simple analogy ........................................................\", \"....................................................................................................\", \"..... 4\\n\\n\\nDocker terminology .......................................................................\", \"......................................................................................... 5\\n\\n\\nDocker\", \" containers, images, and registries ................................................................\", \"..................................................... 7\\n\\n\\n**Choosing Between .NET and .NET Framework\", \" for Docker Containers .............................. 9**\\n\\n\\nGeneral guidance .......................\", \"....................................................................................................\", \".......................................... 9\\n\\n\\nWhen to choose .NET for Docker containers ...........\", \".................................................................................................. 1\", \"0\\n\\n\\nDeveloping and deploying cross platform ........................................................\", \".................................................... 10\\n\\n\\nUsing containers for new (\\u201cgreen-field\\u201d) p\", \"rojects ............................................................................................\", \"... 11\\n\\n\\nCreate and deploy microservices on containers .............................................\", \"..................................................... 11\\n\\n\\nDeploying high density in scalable system\", \"s ..................................................................................................\", \"........ 11\\n\\n\\nWhen to choose .NET Framework for Docker containers ..................................\", \"................................................... 12\\n\\n\\nMigrating existing applications directly to\", \" a Windows Server container .................................................. 12\\n\\n\\nUsing third-part\", \"y .NET libraries or NuGet packages not available for .NET 7 ........................................\", \". 12\\n\\n\\nUsing .NET technologies not available for .NET 7 ............................................\", \"................................................... 12\\n\\n\\nUsing a platform or API that doesn\\u2019t suppor\", \"t .NET 7 ........................................................................................ 13\", \"\\n\\n\\nPorting existing ASP.NET application to .NET 7 ..................................................\", \"................................................. 13\\n\\n\\nDecision table: .NET implementations to use f\", \"or Docker ..................................................................................... 13\\n\\n\", \"\\nWhat OS to target with .NET containers ............................................................\", \".......................................................... 14\\n\\n\\nOfficial .NET Docker images ........\", \"....................................................................................................\", \"................................. 16\\n\\n\\n.NET and Docker image optimizations for development versus pr\", \"oduction ........................................... 16\\n\\n\\n**Architecting container and microservice-\", \"based applications .......................................... 18**\\n\\n\\nContainer design principles ...\", \"....................................................................................................\", \"....................................... 18\\n\\n\\nContainerizing monolithic applications ................\", \"....................................................................................................\", \"... 19\\n\\n\\nDeploying a monolithic application as a container .........................................\", \"................................................... 21\\n\\n\\nPublishing a single-container-based applica\", \"tion to Azure App Service .................................................... 21\\n\\n\\ni Contents\\n\\n\\nMan\", \"age state and data in Docker applications ..........................................................\", \".............................................. 22\\n\\n\\nService-oriented architecture ..................\", \"....................................................................................................\", \"..................... 25\\n\\n\\nMicroservices architecture ..............................................\", \"................................................................................................... \", \"25\\n\\n\\nAdditional resources ..........................................................................\", \"............................................................................. 27\\n\\n\\nData sovereignty \", \"per microservice ...................................................................................\", \"............................................. 27\\n\\n\\nThe relationship between microservices and the Bo\", \"unded Context pattern ........................................... 29\\n\\n\\nLogical architecture versus p\", \"hysical architecture ...............................................................................\", \"...................... 30\\n\\n\\nChallenges and solutions for distributed data management ...............\", \"............................................................... 31\\n\\n\\nChallenge #1: How to define the\", \" boundaries of each microservice ............................................................ 31\\n\\n\\nC\", \"hallenge #2: How to create queries that retrieve data from several microservices ...................\", \"......... 32\\n\\n\\nChallenge #3: How to achieve consistency across multiple microservices ..............\", \"................................. 33\\n\\n\\nChallenge #4: How to design communication across microservice\", \" boundaries .................................... 35\\n\\n\\nAdditional resources .........................\", \"....................................................................................................\", \".......................... 36\\n\\n\\nIdentify domain-model boundaries for each microservice .............\", \"..................................................................... 36\\n\\n\\nThe API gateway pattern v\", \"ersus the Direct client-to-microservice communication .................................. 40\\n\\n\\nDirect\", \" client-to-microservice communication ..............................................................\", \"........................................ 40\\n\\n\\nWhy consider API Gateways instead of direct client-to-\", \"microservice communication ....................... 41\\n\\n\\nWhat is the API Gateway pattern? ...........\", \"....................................................................................................\", \".............. 42\\n\\n\\nMain features in the API Gateway pattern .......................................\", \"...................................................................... 44\\n\\n\\nUsing products with API \", \"Gateway features ...................................................................................\", \"......................... 45\\n\\n\\nDrawbacks of the API Gateway pattern ................................\", \"................................................................................... 47\\n\\n\\nAdditional \", \"resources ..........................................................................................\", \"............................................................. 48\\n\\n\\nCommunication in a microservice a\", \"rchitecture ........................................................................................\", \"................ 48\\n\\n\\nCommunication types ..........................................................\", \".......................................................................................... 49\\n\\n\\nAsyn\", \"chronous microservice integration enforces microservice\\u2019s autonomy .................................\", \".......... 50\\n\\n\\nCommunication styles ...............................................................\", \"..................................................................................... 52\\n\\n\\nAsynchron\", \"ous message-based communication ....................................................................\", \"................................... 54\\n\\n\\nSingle-receiver message-based communication ...............\", \"................................................................................. 55\\n\\n\\nMultiple-rece\", \"ivers message-based communication ..................................................................\", \"........................ 56\\n\\n\\nAsynchronous event-driven communication ..............................\", \".......................................................................... 56\\n\\n\\nA note about messagi\", \"ng technologies for production systems .............................................................\", \"...... 57\\n\\n\\nResiliently publishing to the event bus ................................................\", \"................................................................... 58\\n\\n\\nii Contents\\n\\n\\nAdditional re\", \"sources ............................................................................................\", \"........................................................... 58\\n\\n\\nCreating, evolving, and versioning \", \"microservice APIs and contracts ............................................................... 59\\n\\n\", \"\\nAdditional resources ..............................................................................\", \"......................................................................... 59\\n\\n\\nMicroservices address\", \"ability and the service registry ...................................................................\", \"......................... 60\\n\\n\\nAdditional resources ................................................\", \"....................................................................................................\", \"... 60\\n\\n\\nCreating composite UI based on microservices ..............................................\", \"......................................................... 60\\n\\n\\nAdditional resources ................\", \"....................................................................................................\", \"................................... 62\\n\\n\\nResiliency and high availability in microservices .........\", \"............................................................................................. 63\\n\\n\\nH\", \"ealth management and diagnostics in microservices ..................................................\", \".................................. 63\\n\\n\\nAdditional resources .......................................\", \"....................................................................................................\", \"............ 65\\n\\n\\nOrchestrate microservices and multi-container applications for high scalability an\", \"d availability ....... 66\\n\\n\\nSoftware platforms for container clustering, orchestration, and scheduli\", \"ng ........................................... 68\\n\\n\\nUsing container-based orchestrators in Microsoft\", \" Azure ................................................................................ 68\\n\\n\\nUsing A\", \"zure Kubernetes Service ............................................................................\", \".................................................... 69\\n\\n\\nDevelopment environment for Kubernetes ...\", \"....................................................................................................\", \".... 70\\n\\n\\nGetting started with Azure Kubernetes Service (AKS) ......................................\", \"................................................. 70\\n\\n\\nDeploy with Helm charts into Kubernetes clust\", \"ers ............................................................................................. 71\", \"\\n\\n\\nAdditional resources ............................................................................\", \"........................................................................... 71\\n\\n\\n**Development proce\", \"ss for Docker-based applications ....................................................... 72**\\n\\n\\nDeve\", \"lopment environment for Docker apps ................................................................\", \"............................................. 72\\n\\n\\nDevelopment tool choices: IDE or editor .........\", \"....................................................................................................\", \"... 72\\n\\n\\nAdditional resources ......................................................................\", \"................................................................................. 73\\n\\n\\n.NET language\", \"s and frameworks for Docker containers .............................................................\", \".......................... 73\\n\\n\\nDevelopment workflow for Docker apps ...............................\", \"...................................................................................... 73\\n\\n\\nWorkflow\", \" for developing Docker container-based applications ................................................\", \".................. 73\\n\\n\\nStep 1. Start coding and create your initial application or service baseline\", \" ............................................. 75\\n\\n\\nStep 2. Create a Dockerfile related to an existi\", \"ng .NET base image ............................................................ 76\\n\\n\\nStep 3. Create \", \"your custom Docker images and embed your application or service in them .......... 83\\n\\n\\nStep 4. Defi\", \"ne your services in docker-compose.yml when building a multi-container Docker\\napplication ..........\", \"....................................................................................................\", \"............................................................ 84\\n\\n\\nStep 5. Build and run your Docker \", \"application ........................................................................................\", \"............ 87\\n\\n\\nStep 6. Test your Docker application using your local Docker host ................\", \"............................................ 89\\n\\n\\niii Contents\\n\\n\\nSimplified workflow when developing\", \" containers with Visual Studio ........................................................ 90\\n\\n\\nUsing P\", \"owerShell commands in a Dockerfile to set up Windows Containers ....................................\", \"..... 91\\n\\n\\n**Designing and Developing Multi-Container and Microservice-Based .NET Applications**\\n**.\", \"....................................................................................................\", \"............................................ 93**\\n\\n\\nDesign a microservice-oriented application .....\", \"....................................................................................................\", \"..... 93\\n\\n\\nApplication specifications ..............................................................\", \"............................................................................... 93\\n\\n\\nDevelopment tea\", \"m context ..........................................................................................\", \"............................................... 94\\n\\n\\nChoosing an architecture ......................\", \"....................................................................................................\", \".................... 94\\n\\n\\nBenefits of a microservice-based solution ................................\", \"............................................................................. 97\\n\\n\\nDownsides of a mi\", \"croservice-based solution ..........................................................................\", \"............................. 98\\n\\n\\nExternal versus internal architecture and design patterns........\", \"....................................................................... 99\\n\\n\\nThe new world: multiple\", \" architectural patterns and polyglot microservices .......................................... 100\\n\\n\\n\", \"Creating a simple data-driven CRUD microservice ....................................................\", \"........................................... 102\\n\\n\\nDesigning a simple CRUD microservice .............\", \"................................................................................................... \", \"102\\n\\n\\nImplementing a simple CRUD microservice with ASP.NET Core ....................................\", \"............................. 103\\n\\n\\nThe DB connection string and environment variables used by Docke\", \"r containers ............................. 109\\n\\n\\nGenerating Swagger description metadata from your A\", \"SP.NET Core Web API ................................... 111\\n\\n\\nDefining your multi-container applicat\", \"ion with docker-compose.yml ......................................................... 116\\n\\n\\nUse a da\", \"tabase server running as a container ...............................................................\", \"......................................... 127\\n\\n\\nSQL Server running as a container with a microservic\", \"e-related database .............................................. 128\\n\\n\\nSeeding with test data on We\", \"b application startup ..............................................................................\", \"........... 129\\n\\n\\nEF Core InMemory database versus SQL Server running as a container ...............\", \".................................. 132\\n\\n\\nUsing a Redis cache service running in a container ........\", \"................................................................................. 132\\n\\n\\nImplementing\", \" event-based communication between microservices (integration events) ................... 133\\n\\n\\nUsin\", \"g message brokers and service buses for production systems .........................................\", \"................. 134\\n\\n\\nIntegration events .........................................................\", \"................................................................................................. 13\", \"5\\n\\n\\nThe event bus ..................................................................................\", \"................................................................................ 136\\n\\n\\nAdditional re\", \"sources ............................................................................................\", \"......................................................... 138\\n\\n\\nImplementing an event bus with Rabbi\", \"tMQ for the development or test environment ....................... 138\\n\\n\\nImplementing a simple publ\", \"ish method with RabbitMQ ...........................................................................\", \".... 139\\n\\n\\nImplementing the subscription code with the RabbitMQ API ................................\", \"..................................... 140\\n\\n\\nAdditional resources ...................................\", \"....................................................................................................\", \".............. 141\\n\\n\\niv Contents\\n\\n\\nSubscribing to events ...........................................\", \"....................................................................................................\", \"......... 141\\n\\n\\nPublishing events through the event bus.............................................\", \"................................................................ 142\\n\\n\\nIdempotency in update message\", \" events ............................................................................................\", \".................. 149\\n\\n\\nDeduplicating integration event messages ..................................\", \"....................................................................... 150\\n\\n\\nTesting ASP.NET Core s\", \"ervices and web apps ...............................................................................\", \"......................... 152\\n\\n\\nTesting in eShopOnContainers .......................................\", \".......................................................................................... 155\\n\\n\\nImp\", \"lement background tasks in microservices with IHostedService and the BackgroundService class\\n.......\", \"....................................................................................................\", \"......................................................................................... 157\\n\\n\\nRegi\", \"stering hosted services in your WebHost or Host ....................................................\", \"............................... 159\\n\\n\\nThe IHostedService interface .................................\", \"....................................................................................................\", \" 159\\n\\n\\nImplementing IHostedService with a custom hosted service class deriving from the\\nBackgroundSe\", \"rvice base class....................................................................................\", \"............................................... 160\\n\\n\\nAdditional resources .........................\", \"....................................................................................................\", \"........................ 163\\n\\n\\nImplement API Gateways with Ocelot ..................................\", \"...................................................................................... 163\\n\\n\\nArchite\", \"ct and design your API Gateways ....................................................................\", \".......................................... 163\\n\\n\\nImplementing your API Gateways with Ocelot ........\", \".......................................................................................... 168\\n\\n\\nUsi\", \"ng Kubernetes Ingress plus Ocelot API Gateways .....................................................\", \"................................. 180\\n\\n\\nAdditional cross-cutting features in an Ocelot API Gateway .\", \"...................................................................... 181\\n\\n\\n**Tackle Business Compl\", \"exity in a Microservice with DDD and CQRS Patterns .............. 182**\\n\\n\\nApply simplified CQRS and \", \"DDD patterns in a microservice......................................................................\", \"....... 184\\n\\n\\nAdditional resources .................................................................\", \".................................................................................... 186\\n\\n\\nApply CQR\", \"S and CQS approaches in a DDD microservice in eShopOnContainers ................................. 18\", \"6\\n\\n\\nCQRS and DDD patterns are not top-level architectures ..........................................\", \"..................................... 187\\n\\n\\nImplement reads/queries in a CQRS microservice .........\", \"....................................................................................... 188\\n\\n\\nUse Vi\", \"ewModels specifically made for client apps, independent from domain model constraints\\n..............\", \"....................................................................................................\", \"............................................................................. 189\\n\\n\\nUse Dapper as a \", \"micro ORM to perform queries .......................................................................\", \"....................... 189\\n\\n\\nDynamic versus static ViewModels .....................................\", \".................................................................................... 190\\n\\n\\nAdditiona\", \"l resources ........................................................................................\", \"............................................................. 193\\n\\n\\nDesign a DDD-oriented microservi\", \"ce .................................................................................................\", \"........................ 194\\n\\n\\nKeep the microservice context boundaries relatively small ...........\", \"............................................................... 194\\n\\n\\nLayers in DDD microservices ..\", \"....................................................................................................\", \"............................... 195\\n\\n\\nv Contents\\n\\n\\nDesign a microservice domain model ..............\", \"....................................................................................................\", \"...... 199\\n\\n\\nThe Domain Entity pattern .............................................................\", \"............................................................................ 199\\n\\n\\nImplement a micro\", \"service domain model with .NET .....................................................................\", \"....................... 204\\n\\n\\nDomain model structure in a custom .NET Standard Library .............\", \".......................................................... 204\\n\\n\\nStructure aggregates in a custom .N\", \"ET Standard library ............................................................................... \", \"205\\n\\n\\nImplement domain entities as POCO classes ....................................................\", \"................................................. 206\\n\\n\\nEncapsulate data in the Domain Entities ....\", \"....................................................................................................\", \"...... 207\\n\\n\\nSeedwork (reusable base classes and interfaces for your domain model) .................\", \"................................. 210\\n\\n\\nThe custom Entity base class ...............................\", \"....................................................................................................\", \".. 211\\n\\n\\nRepository contracts (interfaces) in the domain model layer ...............................\", \"....................................... 212\\n\\n\\nAdditional resources .................................\", \"....................................................................................................\", \"................ 213\\n\\n\\nImplement value objects .....................................................\", \"............................................................................................. 213\\n\\n\\n\", \"Important characteristics of value objects .........................................................\", \".................................................. 214\\n\\n\\nValue object implementation in C# .........\", \"....................................................................................................\", \"........... 215\\n\\n\\nHow to persist value objects in the database with EF Core 2.0 and later ..........\", \"...................................... 217\\n\\n\\nPersist value objects as owned entity types in EF Core \", \"2.0 and later ........................................................ 218\\n\\n\\nAdditional resources ..\", \"....................................................................................................\", \"............................................... 221\\n\\n\\nUse enumeration classes instead of enum types \", \"................................................................................................... \", \"221\\n\\n\\nImplement an Enumeration base class ..........................................................\", \"........................................................ 222\\n\\n\\nAdditional resources ................\", \"....................................................................................................\", \"................................. 223\\n\\n\\nDesign validations in the domain model layer ...............\", \"........................................................................................ 223\\n\\n\\nImple\", \"ment validations in the domain model layer .........................................................\", \".................................. 224\\n\\n\\nAdditional resources ......................................\", \"....................................................................................................\", \"........... 225\\n\\n\\nClient-side validation (validation in the presentation layers) ...................\", \"......................................................... 226\\n\\n\\nAdditional resources ...............\", \"....................................................................................................\", \".................................. 227\\n\\n\\nDomain events: Design and implementation ..................\", \"........................................................................................ 227\\n\\n\\nWhat \", \"is a domain event? .................................................................................\", \"............................................................ 228\\n\\n\\nDomain events versus integration \", \"events .............................................................................................\", \"............... 228\\n\\n\\nDomain events as a preferred way to trigger side effects across multiple aggre\", \"gates within the\\nsame domain .......................................................................\", \"............................................................................................ 229\\n\\n\\nI\", \"mplement domain events .............................................................................\", \"............................................................. 231\\n\\n\\nConclusions on domain events ...\", \"....................................................................................................\", \".......................... 237\\n\\n\\nvi Contents\\n\\n\\nAdditional resources ................................\", \"....................................................................................................\", \"................. 238\\n\\n\\nDesign the infrastructure persistence layer ................................\", \".............................................................................. 238\\n\\n\\nThe Repository \", \"pattern ............................................................................................\", \".................................................... 238\\n\\n\\nAdditional resources ....................\", \"....................................................................................................\", \"............................. 243\\n\\n\\nImplement the infrastructure persistence layer with Entity Frame\", \"work Core ............................................ 243\\n\\n\\nIntroduction to Entity Framework Core .\", \"....................................................................................................\", \"............ 244\\n\\n\\nInfrastructure in Entity Framework Core from a DDD perspective ..................\", \"........................................... 244\\n\\n\\nImplement custom repositories with Entity Framewor\", \"k Core ...................................................................... 246\\n\\n\\nEF DbContext and\", \" IUnitOfWork instance lifetime in your IoC container ...............................................\", \".. 248\\n\\n\\nThe repository instance lifetime in your IoC container ....................................\", \"............................................... 249\\n\\n\\nTable mapping ................................\", \"....................................................................................................\", \"............................ 250\\n\\n\\nImplement the Query Specification pattern .......................\", \"................................................................................. 253\\n\\n\\nUse NoSQL da\", \"tabases as a persistence infrastructure ............................................................\", \"............................. 255\\n\\n\\nIntroduction to Azure Cosmos DB and the native Cosmos DB API ...\", \"........................................................ 256\\n\\n\\nImplement .NET code targeting MongoDB\", \" and Azure Cosmos DB .......................................................... 258\\n\\n\\nDesign the mic\", \"roservice application layer and Web API ............................................................\", \"........................ 266\\n\\n\\nUse SOLID principles and Dependency Injection .......................\", \"....................................................................... 266\\n\\n\\nImplement the microser\", \"vice application layer using the Web API ...........................................................\", \"...... 267\\n\\n\\nUse Dependency Injection to inject infrastructure objects into your application layer .\", \".................... 267\\n\\n\\nImplement the Command and Command Handler patterns ......................\", \"................................................. 271\\n\\n\\nThe Command process pipeline: how to trigger\", \" a command handler ..................................................... 278\\n\\n\\nImplement the command\", \" process pipeline with a mediator pattern (MediatR) .................................. 281\\n\\n\\nApply c\", \"ross-cutting concerns when processing commands with the Behaviors in MediatR .......... 287\\n\\n\\n**Impl\", \"ement resilient applications .......................................................................\", \"................ 291**\\n\\n\\nHandle partial failure ....................................................\", \"....................................................................................................\", \". 292\\n\\n\\nStrategies to handle partial failure .......................................................\", \"........................................................................ 294\\n\\n\\nAdditional resources \", \"....................................................................................................\", \"................................................. 295\\n\\n\\nImplement retries with exponential backoff .\", \"....................................................................................................\", \"....... 295\\n\\n\\nImplement resilient Entity Framework Core SQL connections.............................\", \"............................................. 295\\n\\n\\nExecution strategies and explicit transactions u\", \"sing BeginTransaction and multiple DbContexts296\\n\\n\\nAdditional resources ............................\", \"....................................................................................................\", \"..................... 298\\n\\n\\nUse IHttpClientFactory to implement resilient HTTP requests ............\", \"............................................................. 298\\n\\n\\nvii Contents\\n\\n\\nIssues with the o\", \"riginal HttpClient class available in .NET .........................................................\", \".................... 298\\n\\n\\nBenefits of using IHttpClientFactory ....................................\", \"................................................................................... 299\\n\\n\\nMultiple w\", \"ays to use IHttpClientFactory ......................................................................\", \"......................................... 300\\n\\n\\nHow to use Typed Clients with IHttpClientFactory ...\", \"........................................................................................ 300\\n\\n\\nAddit\", \"ional resources ....................................................................................\", \"................................................................. 304\\n\\n\\nImplement HTTP call retries \", \"with exponential backoff with IHttpClientFactory and Polly policies ... 304\\n\\n\\nAdd a jitter strategy \", \"to the retry policy ................................................................................\", \"................................. 305\\n\\n\\nAdditional resources .......................................\", \"....................................................................................................\", \".......... 306\\n\\n\\nImplement the Circuit Breaker pattern .............................................\", \".......................................................................... 306\\n\\n\\nImplement Circuit B\", \"reaker pattern with IHttpClientFactory and Polly ...................................................\", \".. 307\\n\\n\\nTest Http retries and circuit breakers in eShopOnContainers ...............................\", \"....................................... 308\\n\\n\\nAdditional resources .................................\", \"....................................................................................................\", \"................ 310\\n\\n\\nHealth monitoring ...........................................................\", \"................................................................................................... \", \"310\\n\\n\\nImplement health checks in ASP.NET Core services .............................................\", \"........................................... 311\\n\\n\\nUse watchdogs ....................................\", \"....................................................................................................\", \"........................ 315\\n\\n\\nHealth checks when using orchestrators ..............................\", \"................................................................................ 317\\n\\n\\nAdvanced moni\", \"toring: visualization, analysis, and alerts ........................................................\", \"....................... 317\\n\\n\\nAdditional resources .................................................\", \"....................................................................................................\", \" 318\\n\\n\\n**Make secure .NET Microservices and Web Applications .......................................\", \".......... 319**\\n\\n\\nImplement authentication in .NET microservices and web applications .............\", \"......................................... 319\\n\\n\\nAuthenticate with ASP.NET Core Identity ............\", \"................................................................................................. 32\", \"0\\n\\n\\nAuthenticate with external providers ...........................................................\", \".......................................................... 321\\n\\n\\nAuthenticate with bearer tokens ...\", \"....................................................................................................\", \"....................... 323\\n\\n\\nAuthenticate with an OpenID Connect or OAuth 2.0 Identity provider ...\", \"................................................ 324\\n\\n\\nIssue security tokens from an ASP.NET Core se\", \"rvice ....................................................................................... 325\\n\\n\\n\", \"Consume security tokens ............................................................................\", \"................................................................ 326\\n\\n\\nAdditional resources ........\", \"....................................................................................................\", \".............................................. 327\\n\\n\\nAbout authorization in .NET microservices and w\", \"eb applications .................................................................. 327\\n\\n\\nImplement r\", \"ole-based authorization ............................................................................\", \"......................................... 328\\n\\n\\nImplement policy-based authorization ...............\", \".................................................................................................. 3\", \"29\\n\\n\\nAuthorization and minimal apis ................................................................\", \"............................................................... 330\\n\\n\\nAdditional resources .........\", \"....................................................................................................\", \"........................................ 330\\n\\n\\nviii Contents\\n\\n\\nStore application secrets safely duri\", \"ng development .....................................................................................\", \"..... 330\\n\\n\\nStore secrets in environment variables .................................................\", \"................................................................ 331\\n\\n\\nStore secrets with the ASP.NE\", \"T Core Secret Manager ..............................................................................\", \"...... 331\\n\\n\\nUse Azure Key Vault to protect secrets at production time .............................\", \"................................................. 332\\n\\n\\nAdditional resources .......................\", \"....................................................................................................\", \".......................... 333\\n\\n\\n**.NET Microservices Architecture key takeaways ...................\", \"........................................... 334**\\n\\n\\nix Contents\\n\\n\\n**CHAPTER**\\n# 1\\n\\n## Introduction t\", \"o Containers and Docker\\n\\n\\nContainerization is an approach to software development in which an applic\", \"ation or service, its\\ndependencies, and its configuration (abstracted as deployment manifest files) \", \"are packaged together\\nas a container image. The containerized application can be tested as a unit an\", \"d deployed as a\\ncontainer image instance to the host operating system (OS).\\n\\n\\nJust as shipping conta\", \"iners allow goods to be transported by ship, train, or truck regardless of the\\ncargo inside, softwar\", \"e containers act as a standard unit of software deployment that can contain\\ndifferent code and depen\", \"dencies. Containerizing software this way enables developers and IT\\nprofessionals to deploy them acr\", \"oss environments with little or no modification.\\n\\n\\nContainers also isolate applications from each ot\", \"her on a shared OS. Containerized applications run\\non top of a container host that in turn runs on t\", \"he OS (Linux or Windows). Containers therefore have a\\nsignificantly smaller footprint than virtual m\", \"achine (VM) images.\\n\\n\\nEach container can run a whole web application or a service, as shown in Figur\", \"e 2-1. In this example,\\nDocker host is a container host, and App1, App2, Svc 1, and Svc 2 are contai\", \"nerized applications or\\nservices.\\n\\n\\n_Figure 2-1. Multiple containers running on a container host_\\n\\n\\n\", \"1 CHAPTER 1 | Introduction to Containers and Docker\\n\\n\\nAnother benefit of containerization is scalabi\", \"lity. You can scale out quickly by creating new containers\\nfor short-term tasks. From an application\", \" point of view, instantiating an image (creating a container) is\\nsimilar to instantiating a process \", \"like a service or a web app. For reliability, however, when you run\\nmultiple instances of the same i\", \"mage across multiple host servers, you typically want each container\\n(image instance) to run in a di\", \"fferent host server or VM in different fault domains.\\n\\n\\nIn short, containers offer the benefits of i\", \"solation, portability, agility, scalability, and control across the\\nwhole application lifecycle work\", \"flow. The most important benefit is the environment\\u2019s isolation\\nprovided between Dev and Ops.\\n\\n### W\", \"hat is Docker?\\n\\n\\n[Docker](https://www.docker.com/) [is an open-source project for automating the dep\", \"loyment of applications as portable, self-](https://github.com/docker/docker)\\n[sufficient containers\", \" that can run on the cloud or on-premises. Docker is also a company that](https://www.docker.com/)\\np\", \"romotes and evolves this technology, working in collaboration with cloud, Linux, and Windows\\nvendors\", \", including Microsoft.\\n\\n\\n_Figure 2-2. Docker deploys containers at all layers of the hybrid cloud._\\n\", \"\\n\\nDocker containers can run anywhere, on-premises in the customer datacenter, in an external service\", \"\\nprovider or in the cloud, on Azure. Docker image containers can run natively on Linux and Windows.\\n\", \"However, Windows images can run only on Windows hosts and Linux images can run on Linux hosts\\nand Wi\", \"ndows hosts (using a Hyper-V Linux VM, so far), where host means a server or a VM.\\n\\n\\nDevelopers can \", \"use development environments on Windows, Linux, or macOS. On the development\\ncomputer, the developer\", \" runs a Docker host where Docker images are deployed, including the app\\nand its dependencies. Develo\", \"pers who work on Linux or on macOS use a Docker host that is Linux\\nbased, and they can create images\", \" only for Linux containers. (Developers working on macOS can edit\\ncode or run the Docker CLI from ma\", \"cOS, but as of the time of this writing, containers don\\u2019t run\\n\\n\\n2 CHAPTER 1 | Introduction to Contai\", \"ners and Docker\\n\\n\\ndirectly on macOS.) Developers who work on Windows can create images for either Li\", \"nux or Windows\\nContainers.\\n\\n\\nTo host containers in development environments and provide additional d\", \"eveloper tools, Docker\\n[ships Docker Desktop for Windows](https://hub.docker.com/editions/community/\", \"docker-ce-desktop-windows) [or for macOS. These products install the necessary VM (the Docker](https\", \"://hub.docker.com/editions/community/docker-ce-desktop-mac)\\nhost) to host the containers.\\n\\n\\n[To run \", \"Windows Containers, there are two types of runtimes:](https://docs.microsoft.com/virtualization/wind\", \"owscontainers/about/)\\n\\n\\n  - Windows Server Containers provide application isolation through process \", \"and namespace\\nisolation technology. A Windows Server Container shares a kernel with the container ho\", \"st and\\nwith all containers running on the host.\\n\\n\\n  - Hyper-V Containers expand on the isolation pro\", \"vided by Windows Server Containers by\\nrunning each container in a highly optimized virtual machine. \", \"In this configuration, the kernel\\nof the container host isn\\u2019t shared with the Hyper-V Containers, pr\", \"oviding better isolation.\\n\\n\\nThe images for these containers are created the same way and function th\", \"e same. The difference is in\\nhow the container is created from the image running a Hyper-V Container\", \" requires an extra\\n[parameter. For details, see Hyper-V Containers.](https://docs.microsoft.com/virt\", \"ualization/windowscontainers/manage-containers/hyperv-container)\\n\\n#### **Comparing Docker containers\", \" with virtual machines**\\n\\n\\nFigure 2-3 shows a comparison between VMs and Docker containers.\\n\\n|Virtua\", \"l Machines|Docker Containers|\\n|---|---|\\n|||\\n\\n\\n\\n3 CHAPTER 1 | Introduction to Containers and Docker\\n\\n\", \"\\n|Virtual Machines|Docker Containers|\\n|---|---|\\n|Virtual machines include the application, the<br>re\", \"quired libraries or binaries, and a full guest<br>operating system. Full virtualization requires<br>\", \"more resources than containerization.|Containers include the application and all its<br>dependencies\", \". However, they share the OS kernel<br>with other containers, running as isolated<br>processes in us\", \"er space on the host operating<br>system. (Except in Hyper-V containers, where<br>each container run\", \"s inside of a special virtual<br>machine per container.)|\\n\\n\\n\\n_Figure 2-3. Comparison of traditional \", \"virtual machines to Docker containers_\\n\\n\\nFor VMs, there are three base layers in the host server, fr\", \"om the bottom-up: infrastructure, Host\\nOperating System and a Hypervisor and on top of all that each\", \" VM has its own OS and all necessary\\nlibraries. For Docker, the host server only has the infrastruct\", \"ure and the OS and on top of that, the\\ncontainer engine, that keeps container isolated but sharing t\", \"he base OS services.\\n\\n\\nBecause containers require far fewer resources (for example, they don\\u2019t need \", \"a full OS), they\\u2019re easy to\\ndeploy and they start fast. This allows you to have higher density, mean\", \"ing that it allows you to run\\nmore services on the same hardware unit, thereby reducing costs.\\n\\n\\nAs \", \"a side effect of running on the same kernel, you get less isolation than VMs.\\n\\n\\nThe main goal of an \", \"image is that it makes the environment (dependencies) the same across different\\ndeployments. This me\", \"ans that you can debug it on your machine and then deploy it to another\\nmachine with the same enviro\", \"nment guaranteed.\\n\\n\\nA container image is a way to package an app or service and deploy it in a relia\", \"ble and reproducible\\nway. You could say that Docker isn\\u2019t only a technology but also a philosophy an\", \"d a process.\\n\\n\\nWhen using Docker, you won\\u2019t hear developers say, \\u201cIt works on my machine, why not in\", \" production?\\u201d\\nThey can simply say, \\u201cIt runs on Docker\\u201d, because the packaged Docker application can \", \"be executed\\non any supported Docker environment, and it runs the way it was intended to on all deplo\", \"yment\\ntargets (such as Dev, QA, staging, and production).\\n\\n#### **A simple analogy**\\n\\n\\nPerhaps a sim\", \"ple analogy can help getting the grasp of the core concept of Docker.\\n\\n\\nLet\\u2019s go back in time to the\", \" 1950s for a moment. There were no word processors, and the\\nphotocopiers were used everywhere (kind \", \"of).\\n\\n\\nImagine you\\u2019re responsible for quickly issuing batches of letters as required, to mail them t\", \"o\\ncustomers, using real paper and envelopes, to be delivered physically to each customer\\u2019s address\\n(\", \"there was no email back then).\\n\\n\\nAt some point, you realize the letters are just a composition of a \", \"large set of paragraphs, which are\\npicked and arranged as needed, according to the purpose of the le\", \"tter, so you devise a system to\\nissue letters quickly, expecting to get a hefty raise.\\n\\n\\nThe system \", \"is simple:\\n\\n\\n1. You begin with a deck of transparent sheets containing one paragraph each.\\n\\n\\n4 CHAPT\", \"ER 1 | Introduction to Containers and Docker\\n\\n\\n2. To issue a set of letters, you pick the sheets wit\", \"h the paragraphs you need, then you stack and\\nalign them so they look and read fine.\\n\\n\\n3. Finally, y\", \"ou place the set in the photocopier and press start to produce as many letters as\\nrequired.\\n\\n\\nSo, si\", \"mplifying, that\\u2019s the core idea of Docker.\\n\\n\\nIn Docker, each layer is the resulting set of changes t\", \"hat happen to the filesystem after executing a\\ncommand, such as, installing a program.\\n\\n\\nSo, when yo\", \"u \\u201clook\\u201d at the filesystem after the layer has been copied, you see all the files, included in\\nthe l\", \"ayer when the program was installed.\\n\\n\\nYou can think of an image as an auxiliary read-only hard disk\", \" ready to be installed in a \\u201ccomputer\\u201d\\nwhere the operating system is already installed.\\n\\n\\nSimilarly,\", \" you can think of a container as the \\u201ccomputer\\u201d with the image hard disk installed. The\\ncontainer, j\", \"ust like a computer, can be powered on or off.\\n\\n### Docker terminology\\n\\n\\nThis section lists terms an\", \"d definitions you should be familiar with before getting deeper into Docker.\\n[For further definition\", \"s, see the extensive glossary](https://docs.docker.com/glossary/) provided by Docker.\\n\\n\\n**Container \", \"image** : A package with all the dependencies and information needed to create a container.\\nAn image\", \" includes all the dependencies (such as frameworks) plus deployment and execution\\nconfiguration to b\", \"e used by a container runtime. Usually, an image derives from multiple base images\\nthat are layers s\", \"tacked on top of each other to form the container\\u2019s filesystem. An image is immutable\\nonce it has be\", \"en created.\\n\\n\\n**Dockerfile** : A text file that contains instructions for building a Docker image. I\", \"t\\u2019s like a batch script,\\nthe first line states the base image to begin with and then follow the inst\", \"ructions to install required\\nprograms, copy files, and so on, until you get the working environment \", \"you need.\\n\\n\\n**Build** : The action of building a container image based on the information and contex\", \"t provided by its\\nDockerfile, plus additional files in the folder where the image is built. You can \", \"build images with the\\nfollowing Docker command:\\n\\n```\\ndocker build\\n\\n```\\n\\n**Container** : An instance \", \"of a Docker image. A container represents the execution of a single\\napplication, process, or service\", \". It consists of the contents of a Docker image, an execution\\nenvironment, and a standard set of ins\", \"tructions. When scaling a service, you create multiple instances\\nof a container from the same image.\", \" Or a batch job can create multiple containers from the same\\nimage, passing different parameters to \", \"each instance.\\n\\n\\n**Volumes** : Offer a writable filesystem that the container can use. Since images \", \"are read-only but most\\nprograms need to write to the filesystem, volumes add a writable layer, on to\", \"p of the container image,\\nso the programs have access to a writable filesystem. The program doesn\\u2019t \", \"know it\\u2019s accessing a\\n\\n\\n5 CHAPTER 1 | Introduction to Containers and Docker\\n\\n\\nlayered filesystem, it\", \"\\u2019s just the filesystem as usual. Volumes live in the host system and are managed\\nby Docker.\\n\\n\\n**Tag*\", \"* : A mark or label you can apply to images so that different images or versions of the same image\\n(\", \"depending on the version number or the target environment) can be identified.\\n\\n\\n**Multi-stage Build*\", \"* : Is a feature, since Docker 17.05 or higher, that helps to reduce the size of the final\\nimages. F\", \"or example, a large base image, containing the SDK can be used for compiling and\\npublishing and then\", \" a small runtime-only base image can be used to host the application.\\n\\n\\n**Repository (repo)** : A co\", \"llection of related Docker images, labeled with a tag that indicates the image\\nversion. Some repos c\", \"ontain multiple variants of a specific image, such as an image containing SDKs\\n(heavier), an image c\", \"ontaining only runtimes (lighter), etc. Those variants can be marked with tags. A\\nsingle repo can co\", \"ntain platform variants, such as a Linux image and a Windows image.\\n\\n\\n**Registry** : A service that \", \"provides access to repositories. The default registry for most public images is\\n[Docker Hub](https:/\", \"/hub.docker.com/) (owned by Docker as an organization). A registry usually contains repositories fro\", \"m\\nmultiple teams. Companies often have private registries to store and manage images they\\u2019ve created\", \".\\nAzure Container Registry is another example.\\n\\n\\n**Multi-arch image** [: For multi-architecture (or \", \"multi-platform), it\\u2019s a Docker feature that simplifies the](https://docs.docker.com/build/building/m\", \"ulti-platform/)\\nselection of the appropriate image, according to the platform where Docker is runnin\", \"g. For example,\\nwhen a Dockerfile requests a base image **FROM mcr.microsoft.com/dotnet/sdk:7.0** fr\", \"om the\\nregistry, it actually gets **7.0-nanoserver-ltsc2022**, **7.0-nanoserver-1809** or **7.0-bull\", \"seye-slim**,\\ndepending on the operating system and version where Docker is running.\\n\\n\\n**Docker Hub**\", \" : A public registry to upload images and work with them. Docker Hub provides Docker\\nimage hosting, \", \"public or private registries, build triggers and web hooks, and integration with GitHub\\nand Bitbucke\", \"t.\\n\\n\\n**Azure Container Registry** : A public resource for working with Docker images and its compone\", \"nts in\\nAzure. This provides a registry that\\u2019s close to your deployments in Azure and that gives you \", \"control\\nover access, making it possible to use your Azure Active Directory groups and permissions.\\n\\n\", \"\\n**Docker Trusted Registry (DTR)** : A Docker registry service (from Docker) that can be installed o\", \"npremises so it lives within the organization\\u2019s datacenter and network. It\\u2019s convenient for private\\n\", \"images that should be managed within the enterprise. Docker Trusted Registry is included as part of\\n\", \"the Docker Datacenter product.\\n\\n\\n**Docker Desktop** : Development tools for Windows and macOS for bu\", \"ilding, running, and testing\\ncontainers locally. Docker Desktop for Windows provides development env\", \"ironments for both Linux\\n[and Windows Containers. The Linux Docker host on Windows is based on a Hyp\", \"er-V virtual machine.](https://www.microsoft.com/cloud-platform/server-virtualization)\\nThe host for \", \"Windows Containers is directly based on Windows. Docker Desktop for Mac is based on\\n[the Apple Hyper\", \"visor framework and the xhyve hypervisor, which provides a Linux Docker host virtual](https://github\", \".com/mist64/xhyve)\\nmachine on macOS. Docker Desktop for Windows and for Mac replaces Docker Toolbox,\", \" which was\\nbased on Oracle VirtualBox.\\n\\n\\n**Compose** : A command-line tool and YAML file format with\", \" metadata for defining and running multicontainer applications. You define a single application base\", \"d on multiple images with one or more\\n.yml files that can override values depending on the environme\", \"nt. After you\\u2019ve created the definitions,\\n\\n\\n6 CHAPTER 1 | Introduction to Containers and Docker\\n\\n\\nyo\", \"u can deploy the whole multi-container application with a single command (docker-compose up)\\nthat cr\", \"eates a container per image on the Docker host.\\n\\n\\n**Cluster** : A collection of Docker hosts exposed\", \" as if it were a single virtual Docker host, so that the\\napplication can scale to multiple instances\", \" of the services spread across multiple hosts within the\\ncluster. Docker clusters can be created wit\", \"h Kubernetes, Azure Service Fabric, Docker Swarm and\\nMesosphere DC/OS.\\n\\n\\n**Orchestrator** : A tool t\", \"hat simplifies the management of clusters and Docker hosts. Orchestrators\\nenable you to manage their\", \" images, containers, and hosts through a command-line interface (CLI) or a\\ngraphical UI. You can man\", \"age container networking, configurations, load balancing, service discovery,\\nhigh availability, Dock\", \"er host configuration, and more. An orchestrator is responsible for running,\\ndistributing, scaling, \", \"and healing workloads across a collection of nodes. Typically, orchestrator\\nproducts are the same pr\", \"oducts that provide cluster infrastructure, like Kubernetes and Azure Service\\nFabric, among other of\", \"ferings in the market.\\n\\n### Docker containers, images, and registries\\n\\n\\nWhen using Docker, a develop\", \"er creates an app or service and packages it and its dependencies into\\na container image. An image i\", \"s a static representation of the app or service and its configuration and\\ndependencies.\\n\\n\\nTo run the\", \" app or service, the app\\u2019s image is instantiated to create a container, which will be running\\non the\", \" Docker host. Containers are initially tested in a development environment or PC.\\n\\n\\nDevelopers shoul\", \"d store images in a registry, which acts as a library of images and is needed when\\n[deploying to pro\", \"duction orchestrators. Docker maintains a public registry via Docker Hub; other](https://hub.docker.\", \"com/)\\n[vendors provide registries for different collections of images, including Azure Container Reg\", \"istry.](https://azure.microsoft.com/services/container-registry/)\\nAlternatively, enterprises can hav\", \"e a private registry on-premises for their own Docker images.\\n\\n\\nFigure 2-4 shows how images and regi\", \"stries in Docker relate to other components. It also shows the\\nmultiple registry offerings from vend\", \"ors.\\n\\n\\n7 CHAPTER 1 | Introduction to Containers and Docker\\n\\n\\n_Figure 2-4. Taxonomy of Docker terms a\", \"nd concepts_\\n\\n\\nThe registry is like a bookshelf where images are stored and available to be pulled f\", \"or building\\ncontainers to run services or web apps. There are private Docker registries on-premises \", \"and on the\\npublic cloud. Docker Hub is a public registry maintained by Docker, along the Docker Trus\", \"ted Registry\\nan enterprise-grade solution, Azure offers the Azure Container Registry. AWS, Google, a\", \"nd others also\\nhave container registries.\\n\\n\\nPutting images in a registry lets you store static and i\", \"mmutable application bits, including all their\\ndependencies at a framework level. Those images can t\", \"hen be versioned and deployed in multiple\\nenvironments and therefore provide a consistent deployment\", \" unit.\\n\\n\\nPrivate image registries, either hosted on-premises or in the cloud, are recommended when:\\n\", \"\\n\\n  - Your images must not be shared publicly due to confidentiality.\\n\\n\\n  - You want to have minimum\", \" network latency between your images and your chosen\\ndeployment environment. For example, if your pr\", \"oduction environment is Azure cloud, you\\n[probably want to store your images in Azure Container Regi\", \"stry](https://azure.microsoft.com/services/container-registry/) so that network latency will\\nbe mini\", \"mal. In a similar way, if your production environment is on-premises, you might want\\nto have an on-p\", \"remises Docker Trusted Registry available within the same local network.\\n\\n\\n8 CHAPTER 1 | Introductio\", \"n to Containers and Docker\\n\\n\\n**CHAPTER**\\n# 2\\n\\n## Choosing Between .NET and .NET Framework for Docker\", \" Containers\\n\\n\\nThere are two supported frameworks for building server-side containerized Docker appli\", \"cations with\\n[.NET: .NET Framework and .NET 7. They share many .NET platform components, and you can\", \" share](https://dotnet.microsoft.com/download)\\ncode across the two. However, there are fundamental d\", \"ifferences between them, and which\\nframework you use will depend on what you want to accomplish. Thi\", \"s section provides guidance on\\nwhen to choose each framework.\\n\\n### General guidance\\n\\n\\nThis section p\", \"rovides a summary of when to choose .NET 7 or .NET Framework. We provide more\\ndetails about these ch\", \"oices in the sections that follow.\\n\\n\\nUse .NET 7, with Linux or Windows Containers, for your containe\", \"rized Docker server application when:\\n\\n\\n  - You have cross-platform needs. For example, you want to \", \"use both Linux and Windows\\nContainers.\\n\\n\\n  - Your application architecture is based on microservices\", \".\\n\\n\\n  - You need to start containers fast and want a small footprint per container to achieve better\", \"\\ndensity or more containers per hardware unit in order to lower your costs.\\n\\n\\nIn short, when you cre\", \"ate new containerized .NET applications, you should consider .NET 7 as the\\ndefault choice. It has ma\", \"ny benefits and fits best with the containers philosophy and style of working.\\n\\n\\nAn extra benefit of\", \" using .NET 7 is that you can run side-by-side .NET versions for applications within\\nthe same machin\", \"e. This benefit is more important for servers or VMs that do not use containers,\\nbecause containers \", \"isolate the versions of .NET that the app needs. (As long as they are compatible\\nwith the underlying\", \" OS.)\\n\\n\\nUse .NET Framework for your containerized Docker server application when:\\n\\n\\n  - Your applica\", \"tion currently uses .NET Framework and has strong dependencies on Windows.\\n\\n\\n9 CHAPTER 2 | Choosing \", \"Between .NET and .NET Framework for Docker Containers\\n\\n\\n  - You need to use Windows APIs that are no\", \"t supported by .NET 7.\\n\\n\\n  - You need to use third-party .NET libraries or NuGet packages that are n\", \"ot available for .NET 7.\\n\\n\\nUsing .NET Framework on Docker can improve your deployment experiences by\", \" minimizing\\n[deployment issues. This \\u201clift and shift\\u201d scenario is important for containerizing legac\", \"y applications that](https://aka.ms/liftandshiftwithcontainersebook)\\nwere originally developed with \", \"the traditional .NET Framework, like ASP.NET WebForms, MVC web\\napps, or WCF (Windows Communication F\", \"oundation) services.\\n\\n\\n**Additional resources**\\n\\n\\n  - **E-book: Modernize existing .NET Framework ap\", \"plications with Azure and Windows**\\n**Containers**\\n[https://aka.ms/liftandshiftwithcontainersebook](\", \"https://aka.ms/liftandshiftwithcontainersebook)\\n\\n\\n  - **Sample apps: Modernization of legacy ASP.NET\", \" web apps by using Windows Containers**\\n[https://aka.ms/eshopmodernizing](https://aka.ms/eshopmodern\", \"izing)\\n\\n### When to choose .NET for Docker containers\\n\\n\\nThe modularity and lightweight nature of .NE\", \"T 7 makes it perfect for containers. When you deploy\\nand start a container, its image is far smaller\", \" with .NET 7 than with .NET Framework. In contrast, to use\\n.NET Framework for a container, you must \", \"base your image on the Windows Server Core image, which\\nis a lot heavier than the Windows Nano Serve\", \"r or Linux images that you use for .NET 7.\\n\\n\\nAdditionally, .NET 7 is cross-platform, so you can depl\", \"oy server apps with Linux or Windows container\\nimages. However, if you are using the traditional .NE\", \"T Framework, you can only deploy images based\\non Windows Server Core.\\n\\n\\nThe following is a more deta\", \"iled explanation of why to choose .NET 7.\\n\\n#### **Developing and deploying cross platform**\\n\\n\\nClearl\", \"y, if your goal is to have an application (web app or service) that can run on multiple platforms\\nsu\", \"pported by Docker (Linux and Windows), the right choice is .NET 7, because .NET Framework only\\nsuppo\", \"rts Windows.\\n\\n\\n.NET 7 also supports macOS as a development platform. However, when you deploy contai\", \"ners to a\\nDocker host, that host must (currently) be based on Linux or Windows. For example, in a de\", \"velopment\\nenvironment, you could use a Linux VM running on a Mac.\\n\\n\\n[Visual Studio](https://www.visu\", \"alstudio.com/vs/) provides an integrated development environment (IDE) for Windows and supports\\nDock\", \"er development.\\n\\n\\n[Visual Studio for Mac](https://www.visualstudio.com/vs/visual-studio-mac/) is an \", \"IDE, evolution of Xamarin Studio, that runs on macOS and supports\\nDocker-based application developme\", \"nt. This tool should be the preferred choice for developers\\nworking in Mac machines who also want to\", \" use a powerful IDE.\\n\\n\\n[You can also use Visual Studio Code on macOS, Linux, and Windows. Visual Stu\", \"dio Code fully](https://code.visualstudio.com/)\\nsupports .NET 7, including IntelliSense and debuggin\", \"g. Because VS Code is a lightweight editor, you\\n\\n\\n10 CHAPTER 2 | Choosing Between .NET and .NET Fram\", \"ework for Docker Containers\\n\\n\\ncan use it to develop containerized apps on the machine in conjunction\", \" with the Docker CLI and the\\n[.NET CLI. You can also target .NET 7 with most third-party editors lik\", \"e Sublime, Emacs, vi, and the](https://docs.microsoft.com/dotnet/core/tools/)\\nopen-source OmniSharp \", \"project, which also provides IntelliSense support.\\n\\n\\n[In addition to the IDEs and editors, you can u\", \"se the .NET CLI](https://docs.microsoft.com/dotnet/core/tools/) for all supported platforms.\\n\\n#### *\", \"*Using containers for new (\\u201cgreen-field\\u201d) projects**\\n\\n\\nContainers are commonly used in conjunction w\", \"ith a microservices architecture, although they can\\nalso be used to containerize web apps or service\", \"s that follow any architectural pattern. You can use\\n.NET Framework on Windows Containers, but the m\", \"odularity and lightweight nature of .NET 7 makes\\nit perfect for containers and microservices archite\", \"ctures. When you create and deploy a container, its\\nimage is far smaller with .NET 7 than with .NET \", \"Framework.\\n\\n#### **Create and deploy microservices on containers**\\n\\n\\nYou could use the traditional .\", \"NET Framework for building microservices-based applications (without\\ncontainers) by using plain proc\", \"esses. That way, because the .NET Framework is already installed and\\nshared across processes, proces\", \"ses are light and fast to start. However, if you are using containers, the\\nimage for the traditional\", \" .NET Framework is also based on Windows Server Core and that makes it too\\nheavy for a microservices\", \"-on-containers approach. However, teams have been looking for\\nopportunities to improve the experienc\", \"e for .NET Framework users as well. Recently, size of the\\n[Windows Server Core container images have\", \" been reduced to >40% smaller.](https://devblogs.microsoft.com/dotnet/we-made-windows-server-core-co\", \"ntainer-images-40-smaller)\\n\\n\\nOn the other hand, .NET 7 is the best candidate if you\\u2019re embracing a m\", \"icroservices-oriented system\\nthat is based on containers because .NET 7 is lightweight. In addition,\", \" its related container images, for\\neither Linux or Windows Nano Server, are lean and small, making c\", \"ontainers light and fast to start.\\n\\n\\nA microservice is meant to be as small as possible: to be light\", \" when spinning up, to have a small\\n[footprint, to have a small Bounded Context (check DDD, Domain-Dr\", \"iven Design), to represent a small](https://en.wikipedia.org/wiki/Domain-driven_design)\\narea of conc\", \"erns, and to be able to start and stop fast. For those requirements, you will want to use\\nsmall and \", \"fast-to-instantiate container images like the .NET 7 container image.\\n\\n\\nA microservices architecture\", \" also allows you to mix technologies across a service boundary. This\\napproach enables a gradual migr\", \"ation to .NET 7 for new microservices that work in conjunction with\\nother microservices or with serv\", \"ices developed with Node.js, Python, Java, GoLang, or other\\ntechnologies.\\n\\n#### **Deploying high den\", \"sity in scalable systems**\\n\\n\\nWhen your container-based system needs the best possible density, granu\", \"larity, and performance,\\n.NET and ASP.NET Core are your best options. ASP.NET Core is up to 10 times\", \" faster than ASP.NET in\\nthe traditional .NET Framework, and it leads to other popular industry techn\", \"ologies for microservices,\\nsuch as Java servlets, Go, and Node.js.\\n\\n\\nThis approach is especially rel\", \"evant for microservices architectures, where you could have hundreds of\\nmicroservices (containers) r\", \"unning. With ASP.NET Core images (based on the .NET runtime) on Linux\\nor Windows Nano, you can run y\", \"our system with a much lower number of servers or VMs, ultimately\\nsaving costs in infrastructure and\", \" hosting.\\n\\n\\n11 CHAPTER 2 | Choosing Between .NET and .NET Framework for Docker Containers\\n\\n\\n### When\", \" to choose .NET Framework for Docker containers\\n\\nWhile .NET 7 offers significant benefits for new ap\", \"plications and application patterns, .NET Framework\\nwill continue to be a good choice for many exist\", \"ing scenarios.\\n\\n#### **Migrating existing applications directly to a Windows Server container**\\n\\n\\nYo\", \"u might want to use Docker containers just to simplify deployment, even if you are not creating\\nmicr\", \"oservices. For example, perhaps you want to improve your DevOps workflow with Docker\\u2014\\ncontainers can\", \" give you better isolated test environments and can also eliminate deployment issues\\ncaused by missi\", \"ng dependencies when you move to a production environment. In cases like these,\\neven if you are depl\", \"oying a monolithic application, it makes sense to use Docker and Windows\\nContainers for your current\", \" .NET Framework applications.\\n\\n\\nIn most cases for this scenario, you will not need to migrate your e\", \"xisting applications to .NET 7; you\\ncan use Docker containers that include the traditional .NET Fram\", \"ework. However, a recommended\\napproach is to use .NET 7 as you extend an existing application, such \", \"as writing a new service in\\nASP.NET Core.\\n\\n#### **Using third-party .NET libraries or NuGet packages\", \" not available for** **.NET 7**\\n\\n\\n[Third-party libraries are quickly embracing .NET Standard, which \", \"enables code sharing across all .NET](https://docs.microsoft.com/dotnet/standard/net-standard)\\nflavo\", \"rs, including .NET 7. With .NET Standard 2.0 and later, the API surface compatibility across\\ndiffere\", \"nt frameworks has become significantly larger. Even more, .NET Core 2.x and newer applications\\n[can \", \"also directly reference existing .NET Framework libraries (see .NET Framework 4.6.1 supporting](http\", \"s://github.com/dotnet/standard/blob/v2.1.0/docs/planning/netstandard-2.0/README.md#net-framework-461\", \"-supporting-net-standard-20)\\n[.NET Standard 2.0).](https://github.com/dotnet/standard/blob/v2.1.0/do\", \"cs/planning/netstandard-2.0/README.md#net-framework-461-supporting-net-standard-20)\\n\\n\\n[In addition, \", \"the Windows Compatibility Pack extends the API surface available for .NET Standard 2.0](https://docs\", \".microsoft.com/dotnet/core/porting/windows-compat-pack)\\non Windows. This pack allows recompiling mos\", \"t existing code to .NET Standard 2.x with little or no\\nmodification, to run on Windows.\\n\\n\\nHowever, e\", \"ven with that exceptional progression since .NET Standard 2.0 and .NET Core 2.1 or later,\\nthere migh\", \"t be cases where certain NuGet packages need Windows to run and might not support\\n.NET Core or later\", \". If those packages are critical for your application, then you will need to use .NET\\nFramework on W\", \"indows Containers.\\n\\n#### **Using .NET technologies not available for .NET 7**\\n\\n\\nSome .NET Framework \", \"technologies aren\\u2019t available in .NET 7. Some of them might become available\\nin later releases, but \", \"others don\\u2019t fit the new application patterns targeted by .NET Core and might\\nnever be available.\\n\\n\\n\", \"The following list shows most of the technologies that aren\\u2019t available in .NET 7:\\n\\n\\n12 CHAPTER 2 | \", \"Choosing Between .NET and .NET Framework for Docker Containers\\n\\n\\n  - ASP.NET Web Forms. This technol\", \"ogy is only available on .NET Framework. Currently there are\\nno plans to bring ASP.NET Web Forms to \", \".NET or later.\\n\\n\\n  - Workflow-related services. Windows Workflow Foundation (WF), Workflow Services \", \"(WCF +\\nWF in a single service), and WCF Data Services (formerly known as ADO.NET Data Services)\\nare \", \"only available on .NET Framework. There are currently no plans to bring them to .NET 7.\\n\\n\\n[In additi\", \"on to the technologies listed in the official .NET roadmap, other features might be ported to](https\", \"://github.com/dotnet/core/blob/main/roadmap.md)\\n[the new unified .NET platform. You might consider p\", \"articipating in the discussions on GitHub so that](https://devblogs.microsoft.com/dotnet/introducing\", \"-net-5/)\\n[your voice can be heard. And if you think something is missing, file a new issue in the do\", \"tnet/runtime](https://github.com/dotnet/runtime/issues/new)\\nGitHub repository.\\n\\n#### **Using a platf\", \"orm or API that doesn\\u2019t support .NET 7**\\n\\n\\nSome Microsoft and third-party platforms don\\u2019t support .N\", \"ET 7. For example, some Azure services\\nprovide an SDK that isn\\u2019t yet available for consumption on .N\", \"ET 7 yet. Most Azure SDK should\\neventually be ported to .NET 7/.NET Standard, but some might not for\", \" several reasons. You can see\\n[the available Azure SDKs in the Azure SDK Latest Releases](https://az\", \"ure.github.io/azure-sdk/releases/latest/index.html) page.\\n\\n\\nIn the meantime, if any platform or serv\", \"ice in Azure still doesn\\u2019t support .NET 7 with its client API, you\\ncan use the equivalent REST API f\", \"rom the Azure service or the client SDK on .NET Framework.\\n\\n#### **Porting existing ASP.NET applicat\", \"ion to .NET 7**\\n\\n\\n.NET Core is a revolutionary step forward from .NET Framework. It offers a host of\", \" advantages over\\n.NET Framework across the board from productivity to performance, and from cross-pl\", \"atform support\\nto developer satisfaction. If you are using .NET Framework and planning to migrate yo\", \"ur application\\n[to .NET Core or .NET 5+, see Porting Existing ASP.NET Apps to .NET Core.](https://do\", \"cs.microsoft.com/dotnet/architecture/porting-existing-aspnet-apps/)\\n\\n\\n**Additional resources**\\n\\n\\n  -\", \" **.NET fundamentals**\\n[https://learn.microsoft.com/dotnet/fundamentals](https://docs.microsoft.com/\", \"dotnet/fundamentals/index.yml)\\n\\n\\n  - **Porting Projects to .NET 5**\\n[https://learn.microsoft.com/eve\", \"nts/dotnetconf-2020/porting-projects-to-net-5](https://docs.microsoft.com/Events/dotnetConf/2020/Por\", \"ting-Projects-to-NET-5)\\n\\n\\n  - **.NET on Docker Guide**\\n[https://learn.microsoft.com/dotnet/core/dock\", \"er/introduction](https://docs.microsoft.com/dotnet/core/docker/introduction)\\n\\n### Decision table: .N\", \"ET implementations to use for Docker\\n\\n\\nThe following decision table summarizes whether to use .NET F\", \"ramework or .NET 7. Remember that\\nfor Linux containers, you need Linux-based Docker hosts (VMs or se\", \"rvers), and that for Windows\\nContainers, you need Windows Server-based Docker hosts (VMs or servers)\", \".\\n\\n\\n13 CHAPTER 2 | Choosing Between .NET and .NET Framework for Docker Containers\\n\\n\\n|Architecture / \", \"App Type|Linux containers|Windows Containers|\\n|---|---|---|\\n|Microservices on containers|.NET 7|.NET\", \" 7|\\n|Monolithic app|.NET 7|.NET Framework<br>.NET 7|\\n|Best-in-class performance and<br>scalability|.\", \"NET 7|.NET 7|\\n|Windows Server legacy app (\\u201cbrown-<br>field\\u201d) migration to containers|\\u2013|.NET Framewor\", \"k|\\n|New container-based development<br>(\\u201cgreen-field\\u201d)|.NET 7|.NET 7|\\n|ASP.NET Core|.NET 7|.NET 7 (r\", \"ecommended)<br>.NET Framework|\\n|ASP.NET 4 (MVC 5, Web API 2, and<br>Web Forms)|\\u2013|.NET Framework|\\n|Si\", \"gnalR services|.NET Core 2.1 or higher<br>version|.NET Framework<br>.NET Core 2.1 or higher<br>versi\", \"on|\\n|WCF, WF, and other legacy<br>frameworks|WCF in .NET Core (client<br>library only) orCoreWCF|.NE\", \"T Framework<br>WCF in .NET 7 (client library<br>only) orCoreWCF|\\n|Consumption of Azure services|.NET\", \" 7<br>(eventually most Azure<br>services will provide client<br>SDKs for .NET 7)|.NET Framework<br>.\", \"NET 7<br>(eventually most Azure<br>services will provide client<br>SDKs for .NET 7)|\\n\\n\\n### What OS t\", \"o target with .NET containers\\n\\nGiven the diversity of operating systems supported by Docker and the \", \"differences between .NET\\nFramework and .NET 7, you should target a specific OS and specific versions\", \" depending on the\\nframework you are using.\\n\\n\\nFor Windows, you can use Windows Server Core or Windows\", \" Nano Server. These Windows versions\\nprovide different characteristics (IIS in Windows Server Core v\", \"ersus a self-hosted web server like\\nKestrel in Nano Server) that might be needed by .NET Framework o\", \"r .NET 7, respectively.\\n\\n\\nFor Linux, multiple distros are available and supported in official .NET D\", \"ocker images (like Debian).\\n\\n\\n14 CHAPTER 2 | Choosing Between .NET and .NET Framework for Docker Con\", \"tainers\\n\\n\\nIn Figure 3-1, you can see the possible OS version depending on the .NET framework used.\\n\\n\", \"\\n_Figure 3-1. Operating systems to target depending on versions of the .NET framework_\\n\\n\\nWhen deploy\", \"ing legacy .NET Framework applications you have to target Windows Server Core,\\ncompatible with legac\", \"y apps and IIS, but it has a larger image. When deploying .NET 7 applications,\\nyou can target Window\", \"s Nano Server, which is cloud optimized, uses Kestrel and is smaller and starts\\nfaster. You can also\", \" target Linux, supporting Debian, Alpine, and others.\\n\\n\\nYou can also create your own Docker image in\", \" cases where you want to use a different Linux distro or\\nwhere you want an image with versions not p\", \"rovided by Microsoft. For example, you might create an\\nimage with ASP.NET Core running on the tradit\", \"ional .NET Framework and Windows Server Core, which\\nis a not-so-common scenario for Docker.\\n\\n\\nWhen y\", \"ou add the image name to your Dockerfile file, you can select the operating system and\\nversion depen\", \"ding on the tag you use, as in the following examples:\\n\\n\\n\\n\\n\\n\\n|Image|Comments|\\n|---|---|\\n|mcr.microso\", \"ft.com/dotnet/runtime:7.0|.NET 7 multi-architecture: Supports Linux and Windows<br>Nano Server depen\", \"ding on the Docker host.|\\n|mcr.microsoft.com/dotnet/aspnet:7.0|ASP.NET Core 7.0 multi-architecture: \", \"Supports Linux and<br>Windows Nano Server depending on the Docker host.<br>The aspnetcore image has \", \"a few optimizations for<br>ASP.NET Core.|\\n|mcr.microsoft.com/dotnet/aspnet:7.0-<br>bullseye-slim|.NE\", \"T 7 runtime-only on Linux Debian distro|\\n|mcr.microsoft.com/dotnet/aspnet:7.0-<br>nanoserver-1809|.N\", \"ET 7 runtime-only on Windows Nano Server (Windows<br>Server version 1809)|\\n\\n\\n\\n15 CHAPTER 2 | Choosin\", \"g Between .NET and .NET Framework for Docker Containers\\n\\n\\n### Official .NET Docker images\\n\\nThe Offic\", \"ial .NET Docker images are Docker images created and optimized by Microsoft. They\\u2019re\\n[publicly avail\", \"able on Microsoft Artifact Registry. You can search over the catalog to find all .NET image](https:/\", \"/mcr.microsoft.com/)\\n[repositories, for example .NET SDK](https://mcr.microsoft.com/product/dotnet/s\", \"dk/about) repository.\\n\\n\\nEach repository can contain multiple images, depending on .NET versions, and\", \" depending on the OS\\nand versions (Linux Debian, Linux Alpine, Windows Nano Server, Windows Server C\", \"ore, and so on).\\nImage repositories provide extensive tagging to help you select not just a specific\", \" framework version,\\nbut also to choose an OS (Linux distribution or Windows version).\\n\\n#### **.NET a\", \"nd Docker image optimizations for development versus** **production**\\n\\n\\nWhen building Docker images \", \"for developers, Microsoft focused on the following main scenarios:\\n\\n\\n  - Images used to _develop_ an\", \"d build .NET apps.\\n\\n\\n  - Images used to _run_ .NET apps.\\n\\n\\nWhy multiple images? When developing, bui\", \"lding, and running containerized applications, you usually\\nhave different priorities. By providing d\", \"ifferent images for these separate tasks, Microsoft helps\\noptimize the separate processes of develop\", \"ing, building, and deploying apps.\\n\\n\\n**During development and build**\\n\\n\\nDuring development, what is \", \"important is how fast you can iterate changes, and the ability to debug\\nthe changes. The size of the\", \" image isn\\u2019t as important as the ability to make changes to your code and\\nsee the changes quickly. S\", \"ome tools and \\u201cbuild-agent containers\\u201d, use the development .NET image\\n( _mcr.microsoft.com/dotnet/s\", \"dk:7.0_ ) during development and build process. When building inside a\\nDocker container, the importa\", \"nt aspects are the elements that are needed to compile your app. This\\nincludes the compiler and any \", \"other .NET dependencies.\\n\\n\\nWhy is this type of build image important? You don\\u2019t deploy this image to\", \" production. Instead, it\\u2019s an\\nimage that you use to build the content you place into a production im\", \"age. This image would be used\\nin your continuous integration (CI) environment or build environment w\", \"hen using Docker multi-stage\\nbuilds.\\n\\n\\n**In production**\\n\\n\\nWhat is important in production is how fa\", \"st you can deploy and start your containers based on a\\nproduction .NET image. Therefore, the runtime\", \"-only image based on\\n_mcr.microsoft.com/dotnet/aspnet:7.0_ is small so that it can travel quickly ac\", \"ross the network from your\\nDocker registry to your Docker hosts. The contents are ready to run, enab\", \"ling the fastest time from\\nstarting the container to processing results. In the Docker model, there \", \"is no need for compilation\\nfrom C# code, as there\\u2019s when you run dotnet build or dotnet publish when\", \" using the build container.\\n\\n\\n16 CHAPTER 2 | Choosing Between .NET and .NET Framework for Docker Con\", \"tainers\\n\\n\\nIn this optimized image, you put only the binaries and other content needed to run the app\", \"lication.\\nFor example, the content created by dotnet publish contains only the compiled .NET binarie\", \"s, images,\\n.js, and .css files. Over time, you\\u2019ll see images that contain pre-jitted (the compilatio\", \"n from IL to native\\nthat occurs at run time) packages.\\n\\n\\nAlthough there are multiple versions of the\", \" .NET and ASP.NET Core images, they all share one or more\\nlayers, including the base layer. Therefor\", \"e, the amount of disk space needed to store an image is\\nsmall; it consists only of the delta between\", \" your custom image and its base image. The result is that\\nit\\u2019s quick to pull the image from your reg\", \"istry.\\n\\n\\nWhen you explore the .NET image repositories at Microsoft Artifact Registry, you\\u2019ll find mu\", \"ltiple image\\nversions classified or marked with tags. These tags help to decide which one to use, de\", \"pending on the\\nversion you need, like those in the following table:\\n\\n|Image|Comments|\\n|---|---|\\n|mcr\", \".microsoft.com/dotnet/aspnet:**7.0**|ASP.NET Core, with runtime only and ASP.NET Core<br>optimizatio\", \"ns, on Linux and Windows (multi-arch)|\\n|mcr.microsoft.com/dotnet/sdk:**7.0**|.NET 7, with SDKs inclu\", \"ded, on Linux and Windows<br>(multi-arch)|\\n\\n\\n\\n[You can find all the available docker images in dotne\", \"t-docker](https://github.com/dotnet/dotnet-docker) and also refer to the latest preview\\nreleases by \", \"using nightly build mcr.microsoft.com/dotnet/nightly/*\\n\\n\\n17 CHAPTER 2 | Choosing Between .NET and .N\", \"ET Framework for Docker Containers\\n\\n\\n**CHAPTER**\\n# 3\\n\\n## Architecting container and microservice-bas\", \"ed applications\\n\\n\\n_Microservices offer great benefits but also raise huge new challenges. Microservi\", \"ce architecture patterns_\\n_are fundamental pillars when creating a microservice-based application._\\n\", \"\\n\\nEarlier in this guide, you learned basic concepts about containers and Docker. That information wa\", \"s\\nthe minimum you needed to get started with containers. Even though containers are enablers of, and\", \"\\na great fit for microservices, they aren\\u2019t mandatory for a microservice architecture. Many architec\", \"tural\\nconcepts in this architecture section could be applied without containers. However, this guide\", \" focuses\\non the intersection of both due to the already introduced importance of containers.\\n\\n\\nEnter\", \"prise applications can be complex and are often composed of multiple services instead of a\\nsingle se\", \"rvice-based application. For those cases, you need to understand other architectural\\napproaches, suc\", \"h as the microservices and certain Domain-Driven Design (DDD) patterns plus\\ncontainer orchestration \", \"concepts. Note that this chapter describes not just microservices on\\ncontainers, but any containeriz\", \"ed application, as well.\\n\\n### Container design principles\\n\\n\\nIn the container model, a container imag\", \"e instance represents a single process. By defining a\\ncontainer image as a process boundary, you can\", \" create primitives that can be used to scale or batch\\nthe process.\\n\\n\\n[When you design a container im\", \"age, you\\u2019ll see an ENTRYPOINT](https://docs.docker.com/engine/reference/builder/#entrypoint) definit\", \"ion in the Dockerfile. This\\ndefinition defines the process whose lifetime controls the lifetime of t\", \"he container. When the process\\ncompletes, the container lifecycle ends. Containers might represent l\", \"ong-running processes like web\\nservers, but can also represent short-lived processes like batch jobs\", \", which formerly might have been\\n[implemented as Azure WebJobs.](https://github.com/Azure/azure-webj\", \"obs-sdk/wiki)\\n\\n\\nIf the process fails, the container ends, and the orchestrator takes over. If the or\", \"chestrator was\\nconfigured to keep five instances running and one fails, the orchestrator will create\", \" another container\\ninstance to replace the failed process. In a batch job, the process is started wi\", \"th parameters. When the\\nprocess completes, the work is complete. This guidance drills-down on orches\", \"trators, later on.\\n\\n\\n18 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\nYou\", \" might find a scenario where you want multiple processes running in a single container. For that\\nsce\", \"nario, since there can be only one entry point per container, you could run a script within the\\n[con\", \"tainer that launches as many programs as needed. For example, you can use Supervisor or a](http://su\", \"pervisord.org/)\\nsimilar tool to take care of launching multiple processes inside a single container.\", \" However, even\\nthough you can find architectures that hold multiple processes per container, that ap\", \"proach isn\\u2019t very\\ncommon.\\n\\n### Containerizing monolithic applications\\n\\n\\nYou might want to build a si\", \"ngle, monolithically deployed web application or service and deploy it as\\na container. The applicati\", \"on itself might not be internally monolithic, but structured as several\\nlibraries, components, or ev\", \"en layers (application layer, domain layer, data-access layer, etc.).\\nExternally, however, it\\u2019s a si\", \"ngle container\\u2014a single process, a single web application, or a single\\nservice.\\n\\n\\nTo manage this mod\", \"el, you deploy a single container to represent the application. To increase\\ncapacity, you scale out,\", \" that is, just add more copies with a load balancer in front. The simplicity\\ncomes from managing a s\", \"ingle deployment in a single container or VM.\\n\\n\\n_Figure 4-1. Example of the architecture of a contai\", \"nerized monolithic application_\\n\\n\\nYou can include multiple components, libraries, or internal layers\", \" in each container, as illustrated in\\nFigure 4-1. A monolithic containerized application has most of\", \" its functionality within a single\\ncontainer, with internal layers or libraries, and scales out by c\", \"loning the container on multiple\\nservers/VMs. However, this monolithic pattern might conflict with t\", \"he container principle \\u201ca container\\ndoes one thing, and does it in one process\\u201d, but might be ok for\", \" some cases.\\n\\n\\nThe downside of this approach becomes evident if the application grows, requiring it \", \"to scale. If the\\nentire application can scale, it isn\\u2019t really a problem. However, in most cases, ju\", \"st a few parts of the\\napplication are the choke points that require scaling, while other components \", \"are used less.\\n\\n\\nFor example, in a typical e-commerce application, you likely need to scale the prod\", \"uct information\\nsubsystem, because many more customers browse products than purchase them. More cust\", \"omers use\\n\\n\\n19 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\ntheir basket\", \" than use the payment pipeline. Fewer customers add comments or view their purchase\\nhistory. And you\", \" might have only a handful of employees that need to manage the content and\\nmarketing campaigns. If \", \"you scale the monolithic design, all the code for these different tasks is\\ndeployed multiple times a\", \"nd scaled at the same grade.\\n\\n\\nThere are multiple ways to scale an application-horizontal duplicatio\", \"n, splitting different areas of the\\napplication, and partitioning similar business concepts or data.\", \" But, in addition to the problem of\\nscaling all components, changes to a single component require co\", \"mplete retesting of the entire\\napplication, and a complete redeployment of all the instances.\\n\\n\\nHowe\", \"ver, the monolithic approach is common, because the development of the application is initially\\neasi\", \"er than for microservices approaches. Thus, many organizations develop using this architectural\\nappr\", \"oach. While some organizations have had good enough results, others are hitting limits. Many\\norganiz\", \"ations designed their applications using this model because tools and infrastructure made it\\ntoo dif\", \"ficult to build service-oriented architectures (SOA) years ago, and they did not see the needuntil t\", \"he application grew.\\n\\n\\nFrom an infrastructure perspective, each server can run many applications wit\", \"hin the same host and\\nhave an acceptable ratio of efficiency in resources usage, as shown in Figure \", \"4-2.\\n\\n\\n_Figure 4-2. Monolithic approach: Host running multiple apps, each app running as a container\", \"_\\n\\n\\nMonolithic applications in Microsoft Azure can be deployed using dedicated VMs for each instance\", \".\\n[Additionally, using Azure virtual machine scale sets, you can easily scale the VMs. Azure App Ser\", \"vice](https://azure.microsoft.com/documentation/services/virtual-machine-scale-sets/)\\ncan also run m\", \"onolithic applications and easily scale instances without requiring you to manage the\\nVMs. Since 201\", \"6, Azure App Services can run single instances of Docker containers as well, simplifying\\ndeployment.\", \"\\n\\n\\nAs a QA environment or a limited production environment, you can deploy multiple Docker host VMs\\n\", \"and balance them using the Azure balancer, as shown in Figure 4-3. This lets you manage scaling with\", \"\\na coarse-grain approach, because the whole application lives within a single container.\\n\\n\\n20 CHAPTE\", \"R 3 | Architecting container and microservice-based applications\\n\\n\\n_Figure 4-3. Example of multiple \", \"hosts scaling up a single container application_\\n\\n\\nDeployment to the various hosts can be managed wi\", \"th traditional deployment techniques. Docker\\nhosts can be managed with commands like docker run or d\", \"ocker-compose performed manually, or\\nthrough automation such as continuous delivery (CD) pipelines.\\n\", \"\\n#### **Deploying a monolithic application as a container**\\n\\n\\nThere are benefits to using containers\", \" to manage monolithic application deployments. Scaling\\ncontainer instances is far faster and easier \", \"than deploying additional VMs. Even if you use virtual\\nmachine scale sets, VMs take time to start. W\", \"hen deployed as traditional application instances instead\\nof containers, the configuration of the ap\", \"plication is managed as part of the VM, which isn\\u2019t ideal.\\n\\n\\nDeploying updates as Docker images is f\", \"ar faster and network efficient. Docker images typically start\\nin seconds, which speeds rollouts. Te\", \"aring down a Docker image instance is as easy as issuing a\\ndocker stop command, and typically comple\", \"tes in less than a second.\\n\\n\\nBecause containers are immutable by design, you never need to worry abo\", \"ut corrupted VMs. In\\ncontrast, update scripts for a VM might forget to account for some specific con\", \"figuration or file left on\\ndisk.\\n\\n\\nWhile monolithic applications can benefit from Docker, we\\u2019re touc\", \"hing only on the benefits.\\nAdditional benefits of managing containers come from deploying with conta\", \"iner orchestrators, which\\nmanage the various instances and lifecycle of each container instance. Bre\", \"aking up the monolithic\\napplication into subsystems that can be scaled, developed, and deployed indi\", \"vidually is your entry\\npoint into the realm of microservices.\\n\\n#### **Publishing a single-container-\", \"based application to Azure App Service**\\n\\n\\nWhether you want to get validation of a container deploye\", \"d to Azure or when an application is simply\\na single-container application, Azure App Service provid\", \"es a great way to provide scalable singlecontainer-based services. Using Azure App Service is simple\", \". It provides great integration with Git to\\nmake it easy to take your code, build it in Visual Studi\", \"o, and deploy it directly to Azure.\\n\\n\\n21 CHAPTER 3 | Architecting container and microservice-based a\", \"pplications\\n\\n\\n_Figure 4-4. Publishing a single-container application to Azure App Service from Visua\", \"l Studio 2022_\\n\\n\\nWithout Docker, if you needed other capabilities, frameworks, or dependencies that \", \"aren\\u2019t supported\\nin Azure App Service, you had to wait until the Azure team updated those dependenci\", \"es in App\\nService. Or you had to switch to other services like Azure Cloud Services or VMs, where yo\", \"u had\\nfurther control and you could install a required component or framework for your application.\\n\", \"\\n\\nContainer support in Visual Studio 2017 and later gives you the ability to include whatever you wa\", \"nt\\nin your application environment, as shown in Figure 4-4. Since you\\u2019re running it in a container, \", \"if you\\nadd a dependency to your application, you can include the dependency in your Dockerfile or Do\", \"cker\\nimage.\\n\\n\\nAs also shown in Figure 4-4, the publish flow pushes an image through a container regi\", \"stry. This can\\nbe the Azure Container Registry (a registry close to your deployments in Azure and se\", \"cured by Azure\\nActive Directory groups and accounts), or any other Docker registry, like Docker Hub \", \"or an onpremises registry.\\n\\n### Manage state and data in Docker applications\\n\\n\\nIn most cases, you ca\", \"n think of a container as an instance of a process. A process doesn\\u2019t maintain\\npersistent state. Whi\", \"le a container can write to its local storage, assuming that an instance will be\\naround indefinitely\", \" would be like assuming that a single location in memory will be durable. You\\n\\n\\n22 CHAPTER 3 | Archi\", \"tecting container and microservice-based applications\\n\\n\\nshould assume that container images, like pr\", \"ocesses, have multiple instances or will eventually be\\nkilled. If they\\u2019re managed with a container o\", \"rchestrator, you should assume that they might get\\nmoved from one node or VM to another.\\n\\n\\nThe follo\", \"wing solutions are used to manage data in Docker applications:\\n\\n\\n[From the Docker host, as Docker Vo\", \"lumes:](https://docs.docker.com/engine/admin/volumes/)\\n\\n\\n  - **Volumes** are stored in an area of th\", \"e host filesystem that\\u2019s managed by Docker.\\n\\n\\n  - **Bind mounts** can map to any folder in the host \", \"filesystem, so access can\\u2019t be controlled from\\nDocker process and can pose a security risk as a cont\", \"ainer could access sensitive OS folders.\\n\\n\\n  - **tmpfs mounts** are like virtual folders that only e\", \"xist in the host\\u2019s memory and are never\\nwritten to the filesystem.\\n\\n\\nFrom remote storage:\\n\\n\\n  - [Azu\", \"re Storage, which provides geo-distributable storage, providing a good long-term](https://azure.micr\", \"osoft.com/documentation/services/storage/)\\npersistence solution for containers.\\n\\n\\n  - [Remote relati\", \"onal databases like Azure SQL Database](https://azure.microsoft.com/services/sql-database/) [or NoSQ\", \"L databases like Azure Cosmos](https://docs.microsoft.com/azure/cosmos-db/introduction)\\n[DB, or cach\", \"e services like Redis.](https://redis.io/)\\n\\n\\nFrom the Docker container:\\n\\n\\n  - **Overlay File System*\", \"* . This Docker feature implements a copy-on-write task that stores\\nupdated information to the root \", \"file system of the container. That information is \\u201con top\\u201d of\\nthe original image on which the contai\", \"ner is based. If the container is deleted from the\\nsystem, those changes are lost. Therefore, while \", \"it\\u2019s possible to save the state of a container\\nwithin its local storage, designing a system around t\", \"his would conflict with the premise of\\ncontainer design, which by default is stateless.\\n\\n\\nHowever, u\", \"sing Docker Volumes is now the preferred way to handle local data in Docker. If you need\\n[more infor\", \"mation about storage in containers check on Docker storage drivers and About storage](https://docs.d\", \"ocker.com/storage/storagedriver/select-storage-driver/)\\n[drivers.](https://docs.docker.com/storage/s\", \"toragedriver/)\\n\\n\\nThe following provides more detail about these options:\\n\\n\\n**Volumes** are directori\", \"es mapped from the host OS to directories in containers. When code in the\\ncontainer has access to th\", \"e directory, that access is actually to a directory on the host OS. This\\ndirectory is not tied to th\", \"e lifetime of the container itself, and the directory is managed by Docker and\\nisolated from the cor\", \"e functionality of the host machine. Thus, data volumes are designed to persist\\ndata independently o\", \"f the life of the container. If you delete a container or an image from the Docker\\nhost, the data pe\", \"rsisted in the data volume isn\\u2019t deleted.\\n\\n\\nVolumes can be named or anonymous (the default). Named v\", \"olumes are the evolution of **Data**\\n**Volume Containers** and make it easy to share data between co\", \"ntainers. Volumes also support\\nvolume drivers that allow you to store data on remote hosts, among ot\", \"her options.\\n\\n\\n**Bind mounts** are available since a long time ago and allow the mapping of any fold\", \"er to a mount\\npoint in a container. Bind mounts have more limitations than volumes and some importan\", \"t security\\nissues, so volumes are the recommended option.\\n\\n\\n23 CHAPTER 3 | Architecting container an\", \"d microservice-based applications\\n\\n\\n**tmpfs mounts** are basically virtual folders that live only in\", \" the host\\u2019s memory and are never written to\\nthe filesystem. They are fast and secure but use memory \", \"and are only meant for temporary, nonpersistent data.\\n\\n\\nAs shown in Figure 4-5, regular Docker volum\", \"es can be stored outside of the containers themselves\\nbut within the physical boundaries of the host\", \" server or VM. However, Docker containers can\\u2019t access\\na volume from one host server or VM to anothe\", \"r. In other words, with these volumes, it isn\\u2019t possible\\nto manage data shared between containers th\", \"at run on different Docker hosts, although it could be\\nachieved with a volume driver that supports r\", \"emote hosts.\\n\\n\\n_Figure 4-5. Volumes and external data sources for container-based applications_\\n\\n\\nVo\", \"lumes can be shared between containers, but only in the same host, unless you use a remote driver\\nth\", \"at supports remote hosts. In addition, when Docker containers are managed by an orchestrator,\\ncontai\", \"ners might \\u201cmove\\u201d between hosts, depending on the optimizations performed by the cluster.\\nTherefore,\", \" it isn\\u2019t recommended that you use data volumes for business data. But they\\u2019re a good\\nmechanism to w\", \"ork with trace files, temporal files, or similar that will not impact business data\\nconsistency.\\n\\n\\n*\", \"*Remote data sources and cache** tools like Azure SQL Database, Azure Cosmos DB, or a remote cache\\nl\", \"ike Redis can be used in containerized applications the same way they are used when developing\\nwitho\", \"ut containers. This is a proven way to store business application data.\\n\\n\\n**Azure Storage.** Busines\", \"s data usually will need to be placed in external resources or databases, like\\nAzure Storage. Azure \", \"Storage, in concrete, provides the following services in the cloud:\\n\\n\\n  - Blob storage stores unstru\", \"ctured object data. A blob can be any type of text or binary data,\\nsuch as document or media files (\", \"images, audio, and video files). Blob storage is also referred\\nto as Object storage.\\n\\n\\n24 CHAPTER 3 \", \"| Architecting container and microservice-based applications\\n\\n\\n  - File storage offers shared storag\", \"e for legacy applications using standard SMB protocol. Azure\\nvirtual machines and cloud services can\", \" share file data across application components via\\nmounted shares. On-premises applications can acce\", \"ss file data in a share via the File service\\nREST API.\\n\\n\\n  - Table storage stores structured dataset\", \"s. Table storage is a NoSQL key-attribute data store,\\nwhich allows rapid development and fast access\", \" to large quantities of data.\\n\\n\\n**Relational databases and NoSQL databases.** There are many choices\", \" for external databases, from\\nrelational databases like SQL Server, PostgreSQL, Oracle, or NoSQL dat\", \"abases like Azure Cosmos DB,\\nMongoDB, etc. These databases are not going to be explained as part of \", \"this guide since they are in a\\ncompletely different subject.\\n\\n### Service-oriented architecture\\n\\n\\nSe\", \"rvice-oriented architecture (SOA) was an overused term and has meant different things to different\\np\", \"eople. But as a common denominator, SOA means that you structure your application by\\ndecomposing it \", \"into multiple services (most commonly as HTTP services) that can be classified as\\ndifferent types li\", \"ke subsystems or tiers.\\n\\n\\nThose services can now be deployed as Docker containers, which solves depl\", \"oyment issues, because\\nall the dependencies are included in the container image. However, when you n\", \"eed to scale up SOA\\napplications, you might have scalability and availability challenges if you\\u2019re d\", \"eploying based on single\\nDocker hosts. This is where Docker clustering software or an orchestrator c\", \"an help you, as explained in\\nlater sections where deployment approaches for microservices are descri\", \"bed.\\n\\n\\nDocker containers are useful (but not required) for both traditional service-oriented archite\", \"ctures and\\nthe more advanced microservices architectures.\\n\\n\\nMicroservices derive from SOA, but SOA i\", \"s different from microservices architecture. Features like\\n[large central brokers, central orchestra\", \"tors at the organization level, and the Enterprise Service Bus](https://en.wikipedia.org/wiki/Enterp\", \"rise_service_bus)\\n[(ESB)](https://en.wikipedia.org/wiki/Enterprise_service_bus) are typical in SOA. \", \"But in most cases, these are anti-patterns in the microservice community. In\\nfact, some people argue\", \" that \\u201cThe microservice architecture is SOA done right.\\u201d\\n\\n\\nThis guide focuses on microservices, beca\", \"use a SOA approach is less prescriptive than the\\nrequirements and techniques used in a microservice \", \"architecture. If you know how to build a\\nmicroservice-based application, you also know how to build \", \"a simpler service-oriented application.\\n\\n### Microservices architecture\\n\\n\\nAs the name implies, a mic\", \"roservices architecture is an approach to building a server application as a\\nset of small services. \", \"That means a microservices architecture is mainly oriented to the back-end,\\nalthough the approach is\", \" also being used for the front end. Each service runs in its own process and\\n[communicates with othe\", \"r processes using protocols such as HTTP/HTTPS, WebSockets, or AMQP.](https://en.wikipedia.org/wiki/\", \"Advanced_Message_Queuing_Protocol)\\nEach microservice implements a specific end-to-end domain or busi\", \"ness capability within a certain\\ncontext boundary, and each must be developed autonomously and be de\", \"ployable independently.\\nFinally, each microservice should own its related domain data model and doma\", \"in logic (sovereignty\\n\\n\\n25 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n\", \"and decentralized data management) and could be based on different data storage technologies\\n(SQL, N\", \"oSQL) and different programming languages.\\n\\n\\nWhat size should a microservice be? When developing a m\", \"icroservice, size shouldn\\u2019t be the important\\npoint. Instead, the important point should be to create\", \" loosely coupled services so you have\\nautonomy of development, deployment, and scale, for each servi\", \"ce. Of course, when identifying and\\ndesigning microservices, you should try to make them as small as\", \" possible as long as you don\\u2019t have\\ntoo many direct dependencies with other microservices. More impo\", \"rtant than the size of the\\nmicroservice is the internal cohesion it must have and its independence f\", \"rom other services.\\n\\n\\nWhy a microservices architecture? In short, it provides long-term agility. Mic\", \"roservices enable better\\nmaintainability in complex, large, and highly-scalable systems by letting y\", \"ou create applications based\\non many independently deployable services that each have granular and a\", \"utonomous lifecycles.\\n\\n\\nAs an additional benefit, microservices can scale out independently. Instead\", \" of having a single\\nmonolithic application that you must scale out as a unit, you can instead scale \", \"out specific\\nmicroservices. That way, you can scale just the functional area that needs more process\", \"ing power or\\nnetwork bandwidth to support demand, rather than scaling out other areas of the applica\", \"tion that\\ndon\\u2019t need to be scaled. That means cost savings because you need less hardware.\\n\\n\\n_Figure\", \" 4-6. Monolithic deployment versus the microservices approach_\\n\\n\\nAs Figure 4-6 shows, in the traditi\", \"onal monolithic approach, the application scales by cloning the\\nwhole app in several servers/VM. In \", \"the microservices approach, functionality is segregated in smaller\\nservices, so each service can sca\", \"le independently. The microservices approach allows agile changes\\nand rapid iteration of each micros\", \"ervice, because you can change specific, small areas of complex,\\nlarge, and scalable applications.\\n\\n\", \"\\nArchitecting fine-grained microservices-based applications enables continuous integration and\\nconti\", \"nuous delivery practices. It also accelerates delivery of new functions into the application. Finegr\", \"ained composition of applications also allows you to run and test microservices in isolation, and to\", \"\\n\\n\\n26 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\nevolve them autonomou\", \"sly while maintaining clear contracts between them. As long as you don\\u2019t\\nchange the interfaces or co\", \"ntracts, you can change the internal implementation of any microservice or\\nadd new functionality wit\", \"hout breaking other microservices.\\n\\n\\nThe following are important aspects to enable success in going \", \"into production with a microservicesbased system:\\n\\n\\n  - Monitoring and health checks of the services\", \" and infrastructure.\\n\\n\\n  - Scalable infrastructure for the services (that is, cloud and orchestrator\", \"s).\\n\\n\\n  - Security design and implementation at multiple levels: authentication, authorization, secr\", \"ets\\nmanagement, secure communication, etc.\\n\\n\\n  - Rapid application delivery, usually with different \", \"teams focusing on different microservices.\\n\\n\\n  - DevOps and CI/CD practices and infrastructure.\\n\\n\\nOf\", \" these, only the first three are covered or introduced in this guide. The last two points, which are\", \"\\n[related to application lifecycle, are covered in the additional Containerized Docker Application](\", \"https://aka.ms/dockerlifecycleebook)\\n[Lifecycle with Microsoft Platform and Tools e-book.](https://a\", \"ka.ms/dockerlifecycleebook)\\n\\n#### **Additional resources**\\n\\n\\n  - **Mark Russinovich. Microservices: \", \"An application revolution powered by the cloud**\\n[https://azure.microsoft.com/blog/microservices-an-\", \"application-revolution-powered-by-the-](https://azure.microsoft.com/blog/microservices-an-applicatio\", \"n-revolution-powered-by-the-cloud/)\\ncloud/\\n\\n\\n  - **Martin Fowler. Microservices**\\n[https://www.marti\", \"nfowler.com/articles/microservices.html](https://www.martinfowler.com/articles/microservices.html)\\n\\n\", \"\\n  - **Martin Fowler. Microservice Prerequisites**\\n[https://martinfowler.com/bliki/MicroservicePrere\", \"quisites.html](https://martinfowler.com/bliki/MicroservicePrerequisites.html)\\n\\n\\n  - **Jimmy Nilsson.\", \" Chunk Cloud Computing**\\n[https://www.infoq.com/articles/CCC-Jimmy-Nilsson](https://www.infoq.com/ar\", \"ticles/CCC-Jimmy-Nilsson)\\n\\n\\n  - **Cesar de la Torre. Containerized Docker Application Lifecycle with\", \" Microsoft Platform**\\n**and Tools** (downloadable e-book)\\n[https://aka.ms/dockerlifecycleebook](http\", \"s://aka.ms/dockerlifecycleebook)\\n\\n### Data sovereignty per microservice\\n\\n\\nAn important rule for micr\", \"oservices architecture is that each microservice must own its domain data\\nand logic. Just as a full \", \"application owns its logic and data, so must each microservice own its logic\\nand data under an auton\", \"omous lifecycle, with independent deployment per microservice.\\n\\n\\nThis means that the conceptual mode\", \"l of the domain will differ between subsystems or microservices.\\nConsider enterprise applications, w\", \"here customer relationship management (CRM) applications,\\n\\n\\n27 CHAPTER 3 | Architecting container an\", \"d microservice-based applications\\n\\n\\ntransactional purchase subsystems, and customer support subsyste\", \"ms each call on unique customer\\nentity attributes and data, and where each employs a different Bound\", \"ed Context (BC).\\n\\n\\n[This principle is similar in Domain-driven design (DDD), where each Bounded Cont\", \"ext or autonomous](https://en.wikipedia.org/wiki/Domain-driven_design)\\nsubsystem or service must own\", \" its domain model (data plus logic and behavior). Each DDD Bounded\\nContext correlates to one busines\", \"s microservice (one or several services). This point about the\\nBounded Context pattern is expanded i\", \"n the next section.\\n\\n\\nOn the other hand, the traditional (monolithic data) approach used in many app\", \"lications is to have a\\nsingle centralized database or just a few databases. This is often a normaliz\", \"ed SQL database that\\u2019s\\nused for the whole application and all its internal subsystems, as shown in F\", \"igure 4-7.\\n\\n\\n_Figure 4-7. Data sovereignty comparison: monolithic database versus microservices_\\n\\n\\nI\", \"n the traditional approach, there\\u2019s a single database shared across all services, typically in a tie\", \"red\\narchitecture. In the microservices approach, each microservice owns its model/data. The centrali\", \"zed\\ndatabase approach initially looks simpler and seems to enable reuse of entities in different sub\", \"systems\\nto make everything consistent. But the reality is you end up with huge tables that serve man\", \"y different\\nsubsystems, and that include attributes and columns that aren\\u2019t needed in most cases. It\", \"\\u2019s like trying\\nto use the same physical map for hiking a short trail, taking a day-long car trip, an\", \"d learning\\ngeography.\\n\\n\\n[A monolithic application with typically a single relational database has tw\", \"o important benefits: ACID](https://en.wikipedia.org/wiki/ACID)\\n[transactions](https://en.wikipedia.\", \"org/wiki/ACID) and the SQL language, both working across all the tables and data related to your\\napp\", \"lication. This approach provides a way to easily write a query that combines data from multiple\\ntabl\", \"es.\\n\\n\\nHowever, data access becomes much more complicated when you move to a microservices\\narchitectu\", \"re. Even when using ACID transactions within a microservice or Bounded Context, it is crucial\\nto con\", \"sider that the data owned by each microservice is private to that microservice and should only\\n\\n\\n28 \", \"CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\nbe accessed either synchron\", \"ously through its API endpoints(REST, gRPC, SOAP, etc) or asynchronously\\nvia messaging(AMQP or simil\", \"ar).\\n\\n\\nEncapsulating the data ensures that the microservices are loosely coupled and can evolve\\ninde\", \"pendently of one another. If multiple services were accessing the same data, schema updates\\nwould re\", \"quire coordinated updates to all the services. This would break the microservice lifecycle\\nautonomy.\", \" But distributed data structures mean that you can\\u2019t make a single ACID transaction across\\nmicroserv\", \"ices. This in turn means you must use eventual consistency when a business process spans\\nmultiple mi\", \"croservices. This is much harder to implement than simple SQL joins, because you can\\u2019t\\ncreate integr\", \"ity constraints or use distributed transactions between separate databases, as we\\u2019ll\\nexplain later o\", \"n. Similarly, many other relational database features aren\\u2019t available across multiple\\nmicroservices\", \".\\n\\n\\nGoing even further, different microservices often use different _kinds_ of databases. Modern\\napp\", \"lications store and process diverse kinds of data, and a relational database isn\\u2019t always the best\\nc\", \"hoice. For some use cases, a NoSQL database such as Azure CosmosDB or MongoDB might have a\\nmore conv\", \"enient data model and offer better performance and scalability than a SQL database like\\nSQL Server o\", \"r Azure SQL Database. In other cases, a relational database is still the best approach.\\nTherefore, m\", \"icroservices-based applications often use a mixture of SQL and NoSQL databases, which\\n[is sometimes \", \"called the polyglot persistence approach.](https://martinfowler.com/bliki/PolyglotPersistence.html)\\n\", \"\\n\\nA partitioned, polyglot-persistent architecture for data storage has many benefits. These include\\n\", \"loosely coupled services and better performance, scalability, costs, and manageability. However, it \", \"can\\nintroduce some distributed data management challenges, as explained in \\u201cIdentifying domain-model\", \"\\nboundaries\\u201d later in this chapter.\\n\\n#### **The relationship between microservices and the Bounded C\", \"ontext** **pattern**\\n\\n\\n[The concept of microservice derives from the Bounded Context (BC) pattern](h\", \"ttps://martinfowler.com/bliki/BoundedContext.html) [in domain-driven design](https://en.wikipedia.or\", \"g/wiki/Domain-driven_design)\\n[(DDD). DDD deals with large models by dividing them into multiple BCs \", \"and being explicit about their](https://en.wikipedia.org/wiki/Domain-driven_design)\\nboundaries. Each\", \" BC must have its own model and database; likewise, each microservice owns its\\n[related data. In add\", \"ition, each BC usually has its own ubiquitous language](https://martinfowler.com/bliki/UbiquitousLan\", \"guage.html) to help communication\\nbetween software developers and domain experts.\\n\\n\\nThose terms (mai\", \"nly domain entities) in the ubiquitous language can have different names in different\\nBounded Contex\", \"ts, even when different domain entities share the same identity (that is, the unique ID\\nthat\\u2019s used \", \"to read the entity from storage). For instance, in a user-profile Bounded Context, the User\\ndomain e\", \"ntity might share identity with the Buyer domain entity in the ordering Bounded Context.\\n\\n\\nA microse\", \"rvice is therefore like a Bounded Context, but it also specifies that it\\u2019s a distributed service.\\nIt\", \"\\u2019s built as a separate process for each Bounded Context, and it must use the distributed protocols\\n[\", \"noted earlier, like HTTP/HTTPS, WebSockets, or AMQP. The Bounded Context pattern, however,](https://\", \"en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol)\\ndoesn\\u2019t specify whether the Bounded Context\", \" is a distributed service or if it\\u2019s simply a logical\\nboundary (such as a generic subsystem) within \", \"a monolithic-deployment application.\\n\\n\\nIt\\u2019s important to highlight that defining a service for each \", \"Bounded Context is a good place to start.\\nBut you don\\u2019t have to constrain your design to it. Sometim\", \"es you must design a Bounded Context or\\n\\n\\n29 CHAPTER 3 | Architecting container and microservice-bas\", \"ed applications\\n\\n\\nbusiness microservice composed of several physical services. But ultimately, both \", \"patterns -Bounded\\nContext and microservice- are closely related.\\n\\n\\nDDD benefits from microservices b\", \"y getting real boundaries in the form of distributed microservices.\\nBut ideas like not sharing the m\", \"odel between microservices are what you also want in a Bounded\\nContext.\\n\\n\\n**Additional resources**\\n\\n\", \"\\n  - **Chris Richardson. Pattern: Database per service**\\n[https://microservices.io/patterns/data/dat\", \"abase-per-service.html](https://microservices.io/patterns/data/database-per-service.html)\\n\\n\\n  - **Ma\", \"rtin Fowler. BoundedContext**\\n[https://martinfowler.com/bliki/BoundedContext.html](https://martinfow\", \"ler.com/bliki/BoundedContext.html)\\n\\n\\n  - **Martin Fowler. PolyglotPersistence**\\n[https://martinfowle\", \"r.com/bliki/PolyglotPersistence.html](https://martinfowler.com/bliki/PolyglotPersistence.html)\\n\\n\\n  -\", \" **Alberto Brandolini. Strategic Domain Driven Design with Context Mapping**\\n[https://www.infoq.com/\", \"articles/ddd-contextmapping](https://www.infoq.com/articles/ddd-contextmapping)\\n\\n### Logical archite\", \"cture versus physical architecture\\n\\n\\nIt\\u2019s useful at this point to stop and discuss the distinction b\", \"etween logical architecture and physical\\narchitecture, and how this applies to the design of microse\", \"rvice-based applications.\\n\\n\\nTo begin, building microservices doesn\\u2019t require the use of any specific\", \" technology. For instance,\\nDocker containers aren\\u2019t mandatory to create a microservice-based archite\", \"cture. Those microservices\\ncould also be run as plain processes. Microservices is a logical architec\", \"ture.\\n\\n\\nMoreover, even when a microservice could be physically implemented as a single service, proc\", \"ess, or\\n[container (for simplicity\\u2019s sake, that\\u2019s the approach taken in the initial version of eShop\", \"OnContainers),](https://aka.ms/MicroservicesArchitecture)\\nthis parity between business microservice \", \"and physical service or container isn\\u2019t necessarily required in\\nall cases when you build a large and\", \" complex application composed of many dozens or even\\nhundreds of services.\\n\\n\\nThis is where there\\u2019s a\", \" difference between an application\\u2019s logical architecture and physical\\narchitecture. The logical arc\", \"hitecture and logical boundaries of a system do not necessarily map oneto-one to the physical or dep\", \"loyment architecture. It can happen, but it often doesn\\u2019t.\\n\\n\\nAlthough you might have identified cert\", \"ain business microservices or Bounded Contexts, it doesn\\u2019t\\nmean that the best way to implement them \", \"is always by creating a single service (such as an ASP.NET\\nWeb API) or single Docker container for e\", \"ach business microservice. Having a rule saying each\\nbusiness microservice has to be implemented usi\", \"ng a single service or container is too rigid.\\n\\n\\nTherefore, a business microservice or Bounded Conte\", \"xt is a logical architecture that might coincide (or\\nnot) with physical architecture. The important \", \"point is that a business microservice or Bounded\\nContext must be autonomous by allowing code and sta\", \"te to be independently versioned, deployed,\\nand scaled.\\n\\n\\n30 CHAPTER 3 | Architecting container and \", \"microservice-based applications\\n\\n\\nAs Figure 4-8 shows, the catalog business microservice could be co\", \"mposed of several services or\\nprocesses. These could be multiple ASP.NET Web API services or any oth\", \"er kind of services using\\nHTTP or any other protocol. More importantly, the services could share the\", \" same data, as long as\\nthese services are cohesive with respect to the same business domain.\\n\\n\\n_Figu\", \"re 4-8. Business microservice with several physical services_\\n\\n\\nThe services in the example share th\", \"e same data model because the Web API service targets the same\\ndata as the Search service. So, in th\", \"e physical implementation of the business microservice, you\\u2019re\\nsplitting that functionality so you c\", \"an scale each of those internal services up or down as needed.\\nMaybe the Web API service usually nee\", \"ds more instances than the Search service, or vice versa.\\n\\n\\nIn short, the logical architecture of mi\", \"croservices doesn\\u2019t always have to coincide with the physical\\ndeployment architecture. In this guide\", \", whenever we mention a microservice, we mean a business or\\nlogical microservice that could map to o\", \"ne or more (physical) services. In most cases, this will be a\\nsingle service, but it might be more.\\n\", \"\\n### Challenges and solutions for distributed data management\\n\\n#### **Challenge #1: How to define th\", \"e boundaries of each microservice**\\n\\n\\nDefining microservice boundaries is probably the first challen\", \"ge anyone encounters. Each microservice\\nhas to be a piece of your application and each microservice \", \"should be autonomous with all the\\nbenefits and challenges that it conveys. But how do you identify t\", \"hose boundaries?\\n\\n\\nFirst, you need to focus on the application\\u2019s logical domain models and related d\", \"ata. Try to identify\\ndecoupled islands of data and different contexts within the same application. E\", \"ach context could have\\na different business language (different business terms). The contexts should\", \" be defined and managed\\nindependently. The terms and entities that are used in those different conte\", \"xts might sound similar,\\nbut you might discover that in a particular context, a business concept wit\", \"h one is used for a different\\n\\n\\n31 CHAPTER 3 | Architecting container and microservice-based applica\", \"tions\\n\\n\\npurpose in another context, and might even have a different name. For instance, a user can b\", \"e\\nreferred as a user in the identity or membership context, as a customer in a CRM context, as a buy\", \"er in\\nan ordering context, and so forth.\\n\\n\\nThe way you identify boundaries between multiple applicat\", \"ion contexts with a different domain for\\neach context is exactly how you can identify the boundaries\", \" for each business microservice and its\\nrelated domain model and data. You always attempt to minimiz\", \"e the coupling between those\\nmicroservices. This guide goes into more detail about this identificati\", \"on and domain model design in\\nthe section Identifying domain-model boundaries for each microservice \", \"later.\\n\\n#### **Challenge #2: How to create queries that retrieve data from several** **microservices\", \"**\\n\\n\\nA second challenge is how to implement queries that retrieve data from several microservices, w\", \"hile\\navoiding chatty communication to the microservices from remote client apps. An example could be\", \" a\\nsingle screen from a mobile app that needs to show user information that\\u2019s owned by the basket,\\nc\", \"atalog, and user identity microservices. Another example would be a complex report involving many\\nta\", \"bles located in multiple microservices. The right solution depends on the complexity of the queries.\", \"\\nBut in any case, you\\u2019ll need a way to aggregate information if you want to improve the efficiency i\", \"n\\nthe communications of your system. The most popular solutions are the following.\\n\\n\\n**API Gateway.*\", \"* For simple data aggregation from multiple microservices that own different databases,\\nthe recommen\", \"ded approach is an aggregation microservice referred to as an API Gateway. However,\\nyou need to be c\", \"areful about implementing this pattern, because it can be a choke point in your\\nsystem, and it can v\", \"iolate the principle of microservice autonomy. To mitigate this possibility, you can\\nhave multiple f\", \"ined-grained API Gateways each one focusing on a vertical \\u201cslice\\u201d or business area of\\nthe system. Th\", \"e API Gateway pattern is explained in more detail in the API Gateway section later.\\n\\n\\n**GraphQL Fede\", \"ration** One option to consider if your microservices are already using GraphQL is\\n[GraphQL Federati\", \"on. Federation allows you to define \\u201csubgraphs\\u201d from other services and compose](https://www.apollog\", \"raphql.com/docs/federation/)\\nthem into an aggregate \\u201csupergraph\\u201d that acts as a standalone schema.\\n\\n\", \"\\n**CQRS with query/reads tables.** Another solution for aggregating data from multiple microservices\", \" is\\n[the Materialized View pattern. In this approach, you generate, in advance (prepare denormalized\", \" data](https://docs.microsoft.com/azure/architecture/patterns/materialized-view)\\nbefore the actual q\", \"ueries happen), a read-only table with the data that\\u2019s owned by multiple\\nmicroservices. The table ha\", \"s a format suited to the client app\\u2019s needs.\\n\\n\\nConsider something like the screen for a mobile app. \", \"If you have a single database, you might pull\\ntogether the data for that screen using a SQL query th\", \"at performs a complex join involving multiple\\ntables. However, when you have multiple databases, and\", \" each database is owned by a different\\nmicroservice, you cannot query those databases and create a S\", \"QL join. Your complex query becomes\\na challenge. You can address the requirement using a CQRS approa\", \"ch\\u2014you create a denormalized\\ntable in a different database that\\u2019s used just for queries. The table c\", \"an be designed specifically for the\\ndata you need for the complex query, with a one-to-one relations\", \"hip between fields needed by your\\napplication\\u2019s screen and the columns in the query table. It could \", \"also serve for reporting purposes.\\n\\n\\nThis approach not only solves the original problem (how to quer\", \"y and join across microservices), but it\\nalso improves performance considerably when compared with a\", \" complex join, because you already\\n\\n\\n32 CHAPTER 3 | Architecting container and microservice-based ap\", \"plications\\n\\n\\nhave the data that the application needs in the query table. Of course, using Command a\", \"nd Query\\nResponsibility Segregation (CQRS) with query/reads tables means additional development work\", \", and\\nyou\\u2019ll need to embrace eventual consistency. Nonetheless, requirements on performance and high\", \"\\n[scalability in collaborative scenarios (or competitive scenarios, depending on the point of view) \", \"are](http://udidahan.com/2011/10/02/why-you-should-be-using-cqrs-almost-everywhere/)\\nwhere you shoul\", \"d apply CQRS with multiple databases.\\n\\n\\n**\\u201cCold data\\u201d in central databases.** For complex reports an\", \"d queries that might not require real-time\\ndata, a common approach is to export your \\u201chot data\\u201d (tra\", \"nsactional data from the microservices) as\\n\\u201ccold data\\u201d into large databases that are used only for r\", \"eporting. That central database system can be\\na Big Data-based system, like Hadoop; a data warehouse\", \" like one based on Azure SQL Data\\nWarehouse; or even a single SQL database that\\u2019s used just for repo\", \"rts (if size won\\u2019t be an issue).\\n\\n\\nKeep in mind that this centralized database would be used only fo\", \"r queries and reports that do not\\nneed real-time data. The original updates and transactions, as you\", \"r source of truth, have to be in your\\nmicroservices data. The way you would synchronize data would b\", \"e either by using event-driven\\ncommunication (covered in the next sections) or by using other databa\", \"se infrastructure import/export\\ntools. If you use event-driven communication, that integration proce\", \"ss would be similar to the way\\nyou propagate data as described earlier for CQRS query tables.\\n\\n\\nHowe\", \"ver, if your application design involves constantly aggregating information from multiple\\nmicroservi\", \"ces for complex queries, it might be a symptom of a bad design -a microservice should be\\nas isolated\", \" as possible from other microservices. (This excludes reports/analytics that always should\\nuse cold-\", \"data central databases.) Having this problem often might be a reason to merge\\nmicroservices. You nee\", \"d to balance the autonomy of evolution and deployment of each microservice\\nwith strong dependencies,\", \" cohesion, and data aggregation.\\n\\n#### **Challenge #3: How to achieve consistency across multiple** \", \"**microservices**\\n\\n\\nAs stated previously, the data owned by each microservice is private to that mic\", \"roservice and can only\\nbe accessed using its microservice API. Therefore, a challenge presented is h\", \"ow to implement end-toend business processes while keeping consistency across multiple microservices\", \".\\n\\n\\n[To analyze this problem, let\\u2019s look at an example from the eShopOnContainers reference applicat\", \"ion.](https://aka.ms/eshoponcontainers)\\nThe Catalog microservice maintains information about all the\", \" products, including the product price.\\nThe Basket microservice manages temporal data about product \", \"items that users are adding to their\\nshopping baskets, which includes the price of the items at the \", \"time they were added to the basket.\\nWhen a product\\u2019s price is updated in the catalog, that price sho\", \"uld also be updated in the active\\nbaskets that hold that same product, plus the system should probab\", \"ly warn the user saying that a\\nparticular item\\u2019s price has changed since they added it to their bask\", \"et.\\n\\n\\nIn a hypothetical monolithic version of this application, when the price changes in the produc\", \"ts table,\\nthe catalog subsystem could simply use an ACID transaction to update the current price in \", \"the Basket\\ntable.\\n\\n\\nHowever, in a microservices-based application, the Product and Basket tables are\", \" owned by their\\nrespective microservices. No microservice should ever include tables/storage owned b\", \"y another\\nmicroservice in its own transactions, not even in direct queries, as shown in Figure 4-9.\\n\", \"\\n\\n33 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n_Figure 4-9. A microse\", \"rvice can\\u2019t directly access a table in another microservice_\\n\\n\\nThe Catalog microservice shouldn\\u2019t up\", \"date the Basket table directly, because the Basket table is\\nowned by the Basket microservice. To mak\", \"e an update to the Basket microservice, the Catalog\\nmicroservice should use eventual consistency pro\", \"bably based on asynchronous communication such\\n[as integration events (message and event-based commu\", \"nication). This is how the eShopOnContainers](https://aka.ms/eshoponcontainers)\\nreference applicatio\", \"n performs this type of consistency across microservices.\\n\\n\\n[As stated by the CAP theorem, you need \", \"to choose between availability and ACID strong consistency.](https://en.wikipedia.org/wiki/CAP_theor\", \"em)\\nMost microservice-based scenarios demand availability and high scalability as opposed to strong\\n\", \"consistency. Mission-critical applications must remain up and running, and developers can work\\naroun\", \"d strong consistency by using techniques for working with weak or eventual consistency. This is\\nthe \", \"approach taken by most microservice-based architectures.\\n\\n\\nMoreover, ACID-style or two-phase commit \", \"transactions are not just against microservices principles;\\nmost NoSQL databases (like Azure Cosmos \", \"DB, MongoDB, etc.) do not support two-phase commit\\ntransactions, typical in distributed databases sc\", \"enarios. However, maintaining data consistency across\\nservices and databases is essential. This chal\", \"lenge is also related to the question of how to propagate\\nchanges across multiple microservices when\", \" certain data needs to be redundant\\u2014for example, when\\nyou need to have the product\\u2019s name or descrip\", \"tion in the Catalog microservice and the Basket\\nmicroservice.\\n\\n\\nA good solution for this problem is \", \"to use eventual consistency between microservices articulated\\nthrough event-driven communication and\", \" a publish-and-subscribe system. These topics are covered\\nin the section Asynchronous event-driven c\", \"ommunication later in this guide.\\n\\n\\n34 CHAPTER 3 | Architecting container and microservice-based app\", \"lications\\n\\n\\n#### **Challenge #4: How to design communication across microservice** **boundaries**\\n\\nC\", \"ommunicating across microservice boundaries is a real challenge. In this context, communication\\ndoes\", \"n\\u2019t refer to what protocol you should use (HTTP and REST, AMQP, messaging, and so on). Instead,\\nit a\", \"ddresses what communication style you should use, and especially how coupled your\\nmicroservices shou\", \"ld be. Depending on the level of coupling, when failure occurs, the impact of that\\nfailure on your s\", \"ystem will vary significantly.\\n\\n\\nIn a distributed system like a microservices-based application, wit\", \"h so many artifacts moving around\\nand with distributed services across many servers or hosts, compon\", \"ents will eventually fail. Partial\\nfailure and even larger outages will occur, so you need to design\", \" your microservices and the\\ncommunication across them considering the common risks in this type of d\", \"istributed system.\\n\\n\\nA popular approach is to implement HTTP (REST)-based microservices, due to thei\", \"r simplicity. An\\nHTTP-based approach is perfectly acceptable; the issue here is related to how you u\", \"se it. If you use\\nHTTP requests and responses just to interact with your microservices from client a\", \"pplications or from\\nAPI Gateways, that\\u2019s fine. But if you create long chains of synchronous HTTP cal\", \"ls across microservices,\\ncommunicating across their boundaries as if the microservices were objects \", \"in a monolithic\\napplication, your application will eventually run into problems.\\n\\n\\nFor instance, ima\", \"gine that your client application makes an HTTP API call to an individual microservice\\nlike the Orde\", \"ring microservice. If the Ordering microservice in turn calls additional microservices using\\nHTTP wi\", \"thin the same request/response cycle, you\\u2019re creating a chain of HTTP calls. It might sound\\nreasonab\", \"le initially. However, there are important points to consider when going down this path:\\n\\n\\n  - Block\", \"ing and low performance. Due to the synchronous nature of HTTP, the original request\\ndoesn\\u2019t get a r\", \"esponse until all the internal HTTP calls are finished. Imagine if the number of\\nthese calls increas\", \"es significantly and at the same time one of the intermediate HTTP calls to a\\nmicroservice is blocke\", \"d. The result is that performance is impacted, and the overall scalability\\nwill be exponentially aff\", \"ected as additional HTTP requests increase.\\n\\n\\n  - Coupling microservices with HTTP. Business microse\", \"rvices shouldn\\u2019t be coupled with other\\nbusiness microservices. Ideally, they shouldn\\u2019t \\u201cknow\\u201d about \", \"the existence of other\\nmicroservices. If your application relies on coupling microservices as in the\", \" example, achieving\\nautonomy per microservice will be almost impossible.\\n\\n\\n  - Failure in any one mi\", \"croservice. If you implemented a chain of microservices linked by HTTP\\ncalls, when any of the micros\", \"ervices fails (and eventually they will fail) the whole chain of\\nmicroservices will fail. A microser\", \"vice-based system should be designed to continue to work\\nas well as possible during partial failures\", \". Even if you implement client logic that uses retries\\nwith exponential backoff or circuit breaker m\", \"echanisms, the more complex the HTTP call\\nchains are, the more complex it is to implement a failure \", \"strategy based on HTTP.\\n\\n\\nIn fact, if your internal microservices are communicating by creating chai\", \"ns of HTTP requests as\\ndescribed, it could be argued that you have a monolithic application, but one\", \" based on HTTP between\\nprocesses instead of intra-process communication mechanisms.\\n\\n\\n35 CHAPTER 3 |\", \" Architecting container and microservice-based applications\\n\\n\\nTherefore, in order to enforce microse\", \"rvice autonomy and have better resiliency, you should minimize\\nthe use of chains of request/response\", \" communication across microservices. It\\u2019s recommended that\\nyou use only asynchronous interaction for\", \" inter-microservice communication, either by using\\nasynchronous message- and event-based communicati\", \"on, or by using (asynchronous) HTTP polling\\nindependently of the original HTTP request/response cycl\", \"e.\\n\\n\\nThe use of asynchronous communication is explained with additional details later in this guide \", \"in the\\nsections Asynchronous microservice integration enforces microservice\\u2019s autonomy and Asynchron\", \"ous\\nmessage-based communication.\\n\\n#### **Additional resources**\\n\\n\\n  - **CAP theorem**\\n[https://en.wi\", \"kipedia.org/wiki/CAP_theorem](https://en.wikipedia.org/wiki/CAP_theorem)\\n\\n\\n  - **Eventual consistenc\", \"y**\\n[https://en.wikipedia.org/wiki/Eventual_consistency](https://en.wikipedia.org/wiki/Eventual_cons\", \"istency)\\n\\n\\n  - **Data Consistency Primer**\\n[https://learn.microsoft.com/previous-versions/msp-n-p/dn\", \"589800(v=pandp.10)](https://docs.microsoft.com/previous-versions/msp-n-p/dn589800(v=pandp.10))\\n\\n\\n  -\", \" **Martin Fowler. CQRS (Command and Query Responsibility Segregation)**\\n[https://martinfowler.com/bl\", \"iki/CQRS.html](https://martinfowler.com/bliki/CQRS.html)\\n\\n\\n  - **Materialized View**\\n[https://learn.\", \"microsoft.com/azure/architecture/patterns/materialized-view](https://docs.microsoft.com/azure/archit\", \"ecture/patterns/materialized-view)\\n\\n\\n  - **Charles Row. ACID vs. BASE: The Shifting pH of Database T\", \"ransaction Processing**\\n[https://www.dataversity.net/acid-vs-base-the-shifting-ph-of-database-transa\", \"ction-](https://www.dataversity.net/acid-vs-base-the-shifting-ph-of-database-transaction-processing/\", \")\\n[processing/](https://www.dataversity.net/acid-vs-base-the-shifting-ph-of-database-transaction-pro\", \"cessing/)\\n\\n\\n  - **Compensating Transaction**\\n[https://learn.microsoft.com/azure/architecture/pattern\", \"s/compensating-transaction](https://docs.microsoft.com/azure/architecture/patterns/compensating-tran\", \"saction)\\n\\n\\n  - **Udi Dahan. Service Oriented Composition**\\n[https://udidahan.com/2014/07/30/service-\", \"oriented-composition-with-video/](https://udidahan.com/2014/07/30/service-oriented-composition-with-\", \"video/)\\n\\n### Identify domain-model boundaries for each microservice\\n\\n\\nThe goal when identifying mode\", \"l boundaries and size for each microservice isn\\u2019t to get to the most\\ngranular separation possible, a\", \"lthough you should tend toward small microservices if possible.\\nInstead, your goal should be to get \", \"to the most meaningful separation guided by your domain\\nknowledge. The emphasis isn\\u2019t on the size, b\", \"ut instead on business capabilities. In addition, if there\\u2019s\\nclear cohesion needed for a certain are\", \"a of the application based on a high number of dependencies,\\nthat indicates the need for a single mi\", \"croservice, too. Cohesion is a way to identify how to break apart\\n\\n\\n36 CHAPTER 3 | Architecting cont\", \"ainer and microservice-based applications\\n\\n\\nor group together microservices. Ultimately, while you g\", \"ain more knowledge about the domain, you\\nshould adapt the size of your microservice, iteratively. Fi\", \"nding the right size isn\\u2019t a one-shot process.\\n\\n\\n[Sam Newman, a recognized promoter of microservices\", \" and author of the book Building Microservices,](https://samnewman.io/)\\nhighlights that you should d\", \"esign your microservices based on the Bounded Context (BC) pattern\\n(part of domain-driven design), a\", \"s introduced earlier. Sometimes, a BC could be composed of several\\nphysical services, but not vice v\", \"ersa.\\n\\n\\nA domain model with specific domain entities applies within a concrete BC or microservice. A\", \" BC\\ndelimits the applicability of a domain model and gives developer team members a clear and shared\", \"\\nunderstanding of what must be cohesive and what can be developed independently. These are the\\nsame \", \"goals for microservices.\\n\\n\\n[Another tool that informs your design choice is Conway\\u2019s law, which stat\", \"es that an application will](https://en.wikipedia.org/wiki/Conway%27s_law)\\nreflect the social bounda\", \"ries of the organization that produced it. But sometimes the opposite is true the company\\u2019s organiza\", \"tion is formed by the software. You might need to reverse Conway\\u2019s law and\\nbuild the boundaries the \", \"way you want the company to be organized, leaning toward business\\nprocess consulting.\\n\\n\\n[To identify\", \" bounded contexts, you can use a DDD pattern called the Context Mapping pattern. With](https://www.i\", \"nfoq.com/articles/ddd-contextmapping)\\nContext Mapping, you identify the various contexts in the appl\", \"ication and their boundaries. It\\u2019s\\ncommon to have a different context and boundary for each small su\", \"bsystem, for instance. The Context\\nMap is a way to define and make explicit those boundaries between\", \" domains. A BC is autonomous\\nand includes the details of a single domain -details like the domain en\", \"tities- and defines integration\\ncontracts with other BCs. This is similar to the definition of a mic\", \"roservice: it\\u2019s autonomous, it\\nimplements certain domain capability, and it must provide interfaces.\", \" This is why Context Mapping\\nand the Bounded Context pattern are good approaches for identifying the\", \" domain model boundaries\\nof your microservices.\\n\\n\\nWhen designing a large application, you\\u2019ll see how\", \" its domain model can be fragmented - a domain\\nexpert from the catalog domain will name entities dif\", \"ferently in the catalog and inventory domains\\nthan a shipping domain expert, for instance. Or the us\", \"er domain entity might be different in size and\\nnumber of attributes when dealing with a CRM expert \", \"who wants to store every detail about the\\ncustomer than for an ordering domain expert who just needs\", \" partial data about the customer. It\\u2019s very\\nhard to disambiguate all domain terms across all the dom\", \"ains related to a large application. But the\\nmost important thing is that you shouldn\\u2019t try to unify\", \" the terms. Instead, accept the differences and\\nrichness provided by each domain. If you try to have\", \" a unified database for the whole application,\\nattempts at a unified vocabulary will be awkward and \", \"won\\u2019t sound right to any of the multiple domain\\nexperts. Therefore, BCs (implemented as microservice\", \"s) will help you to clarify where you can use\\ncertain domain terms and where you\\u2019ll need to split th\", \"e system and create additional BCs with\\ndifferent domains.\\n\\n\\nYou\\u2019ll know that you got the right boun\", \"daries and sizes of each BC and domain model if you have few\\nstrong relationships between domain mod\", \"els, and you do not usually need to merge information\\nfrom multiple domain models when performing ty\", \"pical application operations.\\n\\n\\nPerhaps the best answer to the question of how large a domain model \", \"for each microservice should\\nbe is the following: it should have an autonomous BC, as isolated as po\", \"ssible, that enables you to\\nwork without having to constantly switch to other contexts (other micros\", \"ervice\\u2019s models). In Figure 4\\n\\n37 CHAPTER 3 | Architecting container and microservice-based applicat\", \"ions\\n\\n\\n10, you can see how multiple microservices (multiple BCs) each has their own model and how th\", \"eir\\nentities can be defined, depending on the specific requirements for each of the identified domai\", \"ns in\\nyour application.\\n\\n\\n_Figure 4-10. Identifying entities and microservice model boundaries_\\n\\n\\nFi\", \"gure 4-10 illustrates a sample scenario related to an online conference management system. The\\nsame \", \"entity appears as \\u201cUsers\\u201d, \\u201cBuyers\\u201d, \\u201cPayers\\u201d, and \\u201cCustomers\\u201d depending on the bounded\\ncontext. You\", \"\\u2019ve identified several BCs that could be implemented as microservices, based on domains\\nthat domain \", \"experts defined for you. As you can see, there are entities that are present just in a single\\nmicros\", \"ervice model, like Payments in the Payment microservice. Those will be easy to implement.\\n\\n\\nHowever,\", \" you might also have entities that have a different shape but share the same identity across\\nthe mul\", \"tiple domain models from the multiple microservices. For example, the User entity is identified\\nin t\", \"he Conferences Management microservice. That same user, with the same identity, is the one\\nnamed Buy\", \"ers in the Ordering microservice, or the one named Payer in the Payment microservice, and\\neven the o\", \"ne named Customer in the Customer Service microservice. This is because, depending on\\n[the ubiquitou\", \"s language](https://martinfowler.com/bliki/UbiquitousLanguage.html) that each domain expert is using\", \", a user might have a different perspective\\neven with different attributes. The user entity in the m\", \"icroservice model named Conferences\\nManagement might have most of its personal data attributes. Howe\", \"ver, that same user in the shape of\\nPayer in the microservice Payment or in the shape of Customer in\", \" the microservice Customer Service\\nmight not need the same list of attributes.\\n\\n\\nA similar approach \", \"is illustrated in Figure 4-11.\\n\\n\\n38 CHAPTER 3 | Architecting container and microservice-based applic\", \"ations\\n\\n\\n_Figure 4-11. Decomposing traditional data models into multiple domain models_\\n\\n\\nWhen decom\", \"posing a traditional data model between bounded contexts, you can have different\\nentities that share\", \" the same identity (a buyer is also a user) with different attributes in each bounded\\ncontext. You c\", \"an see how the user is present in the Conferences Management microservice model as\\nthe User entity a\", \"nd is also present in the form of the Buyer entity in the Pricing microservice, with\\nalternate attri\", \"butes or details about the user when it\\u2019s actually a buyer. Each microservice or BC might\\nnot need a\", \"ll the data related to a User entity, just part of it, depending on the problem to solve or the\\ncont\", \"ext. For instance, in the Pricing microservice model, you do not need the address or the name of\\nthe\", \" user, just the ID (as identity) and Status, which will have an impact on discounts when pricing the\", \"\\nseats per buyer.\\n\\n\\nThe Seat entity has the same name but different attributes in each domain model.\", \" However, Seat\\nshares identity based on the same ID, as happens with User and Buyer.\\n\\n\\nBasically, th\", \"ere\\u2019s a shared concept of a user that exists in multiple services (domains), which all share\\nthe ide\", \"ntity of that user. But in each domain model there might be additional or different details\\nabout th\", \"e user entity. Therefore, there needs to be a way to map a user entity from one domain\\n(microservice\", \") to another.\\n\\n\\nThere are several benefits to not sharing the same user entity with the same number \", \"of attributes\\nacross domains. One benefit is to reduce duplication, so that microservice models do n\", \"ot have any\\ndata that they do not need. Another benefit is having a primary microservice that owns a\", \" certain type\\nof data per entity so that updates and queries for that type of data are driven only b\", \"y that\\nmicroservice.\\n\\n\\n39 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n#\", \"## The API gateway pattern versus the Direct client-to- microservice communication\\n\\nIn a microservic\", \"es architecture, each microservice exposes a set of (typically) fine-grained endpoints.\\nThis fact ca\", \"n impact the client-to-microservice communication, as explained in this section.\\n\\n#### **Direct clie\", \"nt-to-microservice communication**\\n\\n\\nA possible approach is to use a direct client-to-microservice c\", \"ommunication architecture. In this\\napproach, a client app can make requests directly to some of the \", \"microservices, as shown in Figure 412.\\n\\n\\n_Figure 4-12. Using a direct client-to-microservice communi\", \"cation architecture_\\n\\n\\nIn this approach, each microservice has a public endpoint, sometimes with a d\", \"ifferent TCP port for\\neach microservice. An example of a URL for a particular service could be the f\", \"ollowing URL in Azure:\\n\\n\\nhttp://eshoponcontainers.westus.cloudapp.azure.com:88/\\n\\n\\nIn a production en\", \"vironment based on a cluster, that URL would map to the load balancer used in the\\ncluster, which in \", \"turn distributes the requests across the microservices. In production environments,\\n[you could have \", \"an Application Delivery Controller (ADC) like Azure Application Gateway between your](https://docs.m\", \"icrosoft.com/azure/application-gateway/application-gateway-introduction)\\nmicroservices and the Inter\", \"net. This layer acts as a transparent tier that not only performs load\\nbalancing, but secures your s\", \"ervices by offering SSL termination. This approach improves the load of\\nyour hosts by offloading CPU\", \"-intensive SSL termination and other routing duties to the Azure\\nApplication Gateway. In any case, a\", \" load balancer and ADC are transparent from a logical application\\narchitecture point of view.\\n\\n\\nA di\", \"rect client-to-microservice communication architecture could be good enough for a small\\nmicroservice\", \"-based application, especially if the client app is a server-side web application like an\\nASP.NET MV\", \"C app. However, when you build large and complex microservice-based applications (for\\nexample, when \", \"handling dozens of microservice types), and especially when the client apps are\\nremote mobile apps o\", \"r SPA web applications, that approach faces a few issues.\\n\\n\\n40 CHAPTER 3 | Architecting container an\", \"d microservice-based applications\\n\\n\\nConsider the following questions when developing a large applica\", \"tion based on microservices:\\n\\n\\n  - _How can client apps minimize the number of requests to the back \", \"end and reduce chatty_\\n_communication to multiple microservices?_\\n\\n\\nInteracting with multiple micros\", \"ervices to build a single UI screen increases the number of round trips\\nacross the Internet. This ap\", \"proach increases latency and complexity on the UI side. Ideally, responses\\nshould be efficiently agg\", \"regated in the server side. This approach reduces latency, since multiple\\npieces of data come back i\", \"n parallel and some UI can show data as soon as it\\u2019s ready.\\n\\n\\n  - _How can you handle cross-cutting \", \"concerns such as authorization, data transformations, and_\\n_dynamic request dispatching?_\\n\\n\\nImplemen\", \"ting security and cross-cutting concerns like security and authorization on every\\nmicroservice can r\", \"equire significant development effort. A possible approach is to have those services\\nwithin the Dock\", \"er host or internal cluster to restrict direct access to them from the outside, and to\\nimplement tho\", \"se cross-cutting concerns in a centralized place, like an API Gateway.\\n\\n\\n  - _How can client apps co\", \"mmunicate with services that use non-Internet-friendly protocols?_\\n\\n\\nProtocols used on the server si\", \"de (like AMQP or binary protocols) are not supported in client apps.\\nTherefore, requests must be per\", \"formed through protocols like HTTP/HTTPS and translated to the\\nother protocols afterwards. A _man-in\", \"-the-middle_ approach can help in this situation.\\n\\n\\n  - _How can you shape a facade especially made \", \"for mobile apps?_\\n\\nThe API of multiple microservices might not be well designed for the needs of dif\", \"ferent client\\napplications. For instance, the needs of a mobile app might be different than the need\", \"s of a web app.\\nFor mobile apps, you might need to optimize even further so that data responses can \", \"be more\\nefficient. You might do this functionality by aggregating data from multiple microservices a\", \"nd\\nreturning a single set of data, and sometimes eliminating any data in the response that isn\\u2019t nee\", \"ded\\nby the mobile app. And, of course, you might compress that data. Again, a facade or API in betwe\", \"en\\nthe mobile app and the microservices can be convenient for this scenario.\\n\\n#### **Why consider AP\", \"I Gateways instead of direct client-to-microservice** **communication**\\n\\n\\nIn a microservices archite\", \"cture, the client apps usually need to consume functionality from more than\\none microservice. If tha\", \"t consumption is performed directly, the client needs to handle multiple calls\\nto microservice endpo\", \"ints. What happens when the application evolves and new microservices are\\nintroduced or existing mic\", \"roservices are updated? If your application has many microservices,\\nhandling so many endpoints from \", \"the client apps can be a nightmare. Since the client app would be\\ncoupled to those internal endpoint\", \"s, evolving the microservices in the future can cause high impact\\nfor the client apps.\\n\\n\\nTherefore, \", \"having an intermediate level or tier of indirection (Gateway) can be convenient for\\nmicroservice-bas\", \"ed applications. If you don\\u2019t have API Gateways, the client apps must send requests\\ndirectly to the \", \"microservices and that raises problems, such as the following issues:\\n\\n\\n41 CHAPTER 3 | Architecting \", \"container and microservice-based applications\\n\\n\\n  - **Coupling** : Without the API Gateway pattern, \", \"the client apps are coupled to the internal\\nmicroservices. The client apps need to know how the mult\", \"iple areas of the application are\\ndecomposed in microservices. When evolving and refactoring the int\", \"ernal microservices,\\nthose actions impact maintenance because they cause breaking changes to the cli\", \"ent apps\\ndue to the direct reference to the internal microservices from the client apps. Client apps\", \" need\\nto be updated frequently, making the solution harder to evolve.\\n\\n\\n  - **Too many round trips**\", \" : A single page/screen in the client app might require several calls to\\nmultiple services. That app\", \"roach can result in multiple network round trips between the client\\nand the server, adding significa\", \"nt latency. Aggregation handled in an intermediate level could\\nimprove the performance and user expe\", \"rience for the client app.\\n\\n\\n  - **Security issues** : Without a gateway, all the microservices must\", \" be exposed to the \\u201cexternal\\nworld\\u201d, making the attack surface larger than if you hide internal micr\", \"oservices that aren\\u2019t\\ndirectly used by the client apps. The smaller the attack surface is, the more \", \"secure your\\napplication can be.\\n\\n\\n  - **Cross-cutting concerns** : Each publicly published microserv\", \"ice must handle concerns such as\\nauthorization and SSL. In many situations, those concerns could be \", \"handled in a single tier so\\nthe internal microservices are simplified.\\n\\n#### **What is the API Gatew\", \"ay pattern?**\\n\\n\\nWhen you design and build large or complex microservice-based applications with mult\", \"iple client\\n[apps, a good approach to consider can be an API Gateway. This pattern is a service that\", \" provides a](https://microservices.io/patterns/apigateway.html)\\n[single-entry point for certain grou\", \"ps of microservices. It\\u2019s similar to the Facade pattern from object-](https://en.wikipedia.org/wiki/\", \"Facade_pattern)\\noriented design, but in this case, it\\u2019s part of a distributed system. The API Gatewa\", \"y pattern is also\\n[sometimes known as the \\u201cbackend for frontend\\u201d (BFF) because you build it while th\", \"inking about the](https://samnewman.io/patterns/architectural/bff/)\\nneeds of the client app.\\n\\n\\nThere\", \"fore, the API gateway sits between the client apps and the microservices. It acts as a reverse\\nproxy\", \", routing requests from clients to services. It can also provide other cross-cutting features such\\na\", \"s authentication, SSL termination, and cache.\\n\\n\\nFigure 4-13 shows how a custom API Gateway can fit i\", \"nto a simplified microservice-based architecture\\nwith just a few microservices.\\n\\n\\n42 CHAPTER 3 | Arc\", \"hitecting container and microservice-based applications\\n\\n\\n_Figure 4-13. Using an API Gateway impleme\", \"nted as a custom service_\\n\\n\\nApps connect to a single endpoint, the API Gateway, that\\u2019s configured to\", \" forward requests to\\nindividual microservices. In this example, the API Gateway would be implemented\", \" as a custom\\nASP.NET Core WebHost service running as a container.\\n\\n\\nIt\\u2019s important to highlight that\", \" in that diagram, you would be using a single custom API Gateway\\nservice facing multiple and differe\", \"nt client apps. That fact can be an important risk because your API\\nGateway service will be growing \", \"and evolving based on many different requirements from the client\\napps. Eventually, it will be bloat\", \"ed because of those different needs and effectively it could be similar\\nto a monolithic application \", \"or monolithic service. That\\u2019s why it\\u2019s very much recommended to split the\\nAPI Gateway in multiple se\", \"rvices or multiple smaller API Gateways, one per client app form-factor\\ntype, for instance.\\n\\n\\nYou ne\", \"ed to be careful when implementing the API Gateway pattern. Usually it isn\\u2019t a good idea to\\nhave a s\", \"ingle API Gateway aggregating all the internal microservices of your application. If it does, it\\nact\", \"s as a monolithic aggregator or orchestrator and violates microservice autonomy by coupling all\\nthe \", \"microservices.\\n\\n\\nTherefore, the API Gateways should be segregated based on business boundaries and t\", \"he client apps\\nand not act as a single aggregator for all the internal microservices.\\n\\n\\nWhen splitti\", \"ng the API Gateway tier into multiple API Gateways, if your application has multiple client\\napps, th\", \"at can be a primary pivot when identifying the multiple API Gateways types, so that you can\\nhave a d\", \"ifferent facade for the needs of each client app. This case is a pattern named \\u201cBackend for\\n[Fronten\", \"d\\u201d (BFF) where each API Gateway can provide a different API tailored for each client app type,](http\", \"s://samnewman.io/patterns/architectural/bff/)\\npossibly even based on the client form factor by imple\", \"menting specific adapter code which\\nunderneath calls multiple internal microservices, as shown in th\", \"e following image:\\n\\n\\n43 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n_Fi\", \"gure 4-13.1. Using multiple custom API Gateways_\\n\\n\\nFigure 4-13.1 shows API Gateways that are segrega\", \"ted by client type; one for mobile clients and one\\nfor web clients. A traditional web app connects t\", \"o an MVC microservice that uses the web API\\nGateway. The example depicts a simplified architecture w\", \"ith multiple fine-grained API Gateways. In\\nthis case, the boundaries identified for each API Gateway\", \" are based purely on the \\u201cBackend for\\n[Frontend\\u201d (BFF) pattern, hence based just on the API needed p\", \"er client app. But in larger applications](https://samnewman.io/patterns/architectural/bff/)\\nyou sho\", \"uld also go further and create other API Gateways based on business boundaries as a second\\ndesign pi\", \"vot.\\n\\n#### **Main features in the API Gateway pattern**\\n\\n\\nAn API Gateway can offer multiple features\", \". Depending on the product it might offer richer or simpler\\nfeatures, however, the most important an\", \"d foundational features for any API Gateway are the\\nfollowing design patterns:\\n\\n\\n**Reverse proxy or \", \"gateway routing.** The API Gateway offers a reverse proxy to redirect or route\\nrequests (layer 7 rou\", \"ting, usually HTTP requests) to the endpoints of the internal microservices. The\\ngateway provides a \", \"single endpoint or URL for the client apps and then internally maps the requests\\nto a group of inter\", \"nal microservices. This routing feature helps to decouple the client apps from the\\nmicroservices but\", \" it\\u2019s also convenient when modernizing a monolithic API by sitting the API Gateway\\nin between the mo\", \"nolithic API and the client apps, then you can add new APIs as new microservices\\nwhile still using t\", \"he legacy monolithic API until it\\u2019s split into many microservices in the future. Because\\nof the API \", \"Gateway, the client apps won\\u2019t notice if the APIs being used are implemented as internal\\nmicroservic\", \"es or a monolithic API and more importantly, when evolving and refactoring the\\nmonolithic API into m\", \"icroservices, thanks to the API Gateway routing, client apps won\\u2019t be impacted\\nwith any URI change.\\n\", \"\\n\\n44 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n[For more information,\", \" see Gateway routing pattern.](https://docs.microsoft.com/azure/architecture/patterns/gateway-routin\", \"g)\\n\\n\\n**Requests aggregation.** As part of the gateway pattern you can aggregate multiple client requ\", \"ests\\n(usually HTTP requests) targeting multiple internal microservices into a single client request.\", \" This\\npattern is especially convenient when a client page/screen needs information from several\\nmicr\", \"oservices. With this approach, the client app sends a single request to the API Gateway that\\ndispatc\", \"hes several requests to the internal microservices and then aggregates the results and sends\\neveryth\", \"ing back to the client app. The main benefit and goal of this design pattern is to reduce\\nchattiness\", \" between the client apps and the backend API, which is especially important for remote\\napps out of t\", \"he datacenter where the microservices live, like mobile apps or requests coming from\\nSPA apps that c\", \"ome from JavaScript in client remote browsers. For regular web apps performing the\\nrequests in the s\", \"erver environment (like an ASP.NET Core MVC web app), this pattern is not so\\nimportant as the latenc\", \"y is very much smaller than for remote client apps.\\n\\n\\nDepending on the API Gateway product you use, \", \"it might be able to perform this aggregation.\\nHowever, in many cases it\\u2019s more flexible to create ag\", \"gregation microservices under the scope of the\\nAPI Gateway, so you define the aggregation in code (t\", \"hat is, C# code):\\n\\n\\n[For more information, see Gateway aggregation pattern.](https://docs.microsoft.\", \"com/azure/architecture/patterns/gateway-aggregation)\\n\\n\\n**Cross-cutting concerns or gateway offloadin\", \"g.** Depending on the features offered by each API\\nGateway product, you can offload functionality fr\", \"om individual microservices to the gateway, which\\nsimplifies the implementation of each microservice\", \" by consolidating cross-cutting concerns into one\\ntier. This approach is especially convenient for s\", \"pecialized features that can be complex to implement\\nproperly in every internal microservice, such a\", \"s the following functionality:\\n\\n\\n  - Authentication and authorization\\n\\n  - Service discovery integra\", \"tion\\n\\n  - Response caching\\n\\n  - Retry policies, circuit breaker, and QoS\\n\\n  - Rate limiting and thro\", \"ttling\\n\\n  - Load balancing\\n\\n  - Logging, tracing, correlation\\n\\n  - Headers, query strings, and claim\", \"s transformation\\n\\n  - IP allowlisting\\n\\n[For more information, see Gateway offloading pattern.](https\", \"://docs.microsoft.com/azure/architecture/patterns/gateway-offloading)\\n\\n#### **Using products with AP\", \"I Gateway features**\\n\\n\\nThere can be many more cross-cutting concerns offered by the API Gateways pro\", \"ducts depending on\\neach implementation. We\\u2019ll explore here:\\n\\n\\n  - [Azure API Management](https://azu\", \"re.microsoft.com/services/api-management/)\\n\\n  - [Ocelot](https://github.com/ThreeMammals/Ocelot)\\n\\n\\n4\", \"5 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n**Azure API Management**\\n\", \"\\n\\n[Azure API Management](https://azure.microsoft.com/services/api-management/) (as shown in Figure 4\", \"-14) not only solves your API Gateway needs but\\nprovides features like gathering insights from your \", \"APIs. If you\\u2019re using an API management solution,\\nan API Gateway is only a component within that ful\", \"l API management solution.\\n\\n\\n_Figure 4-14. Using Azure API Management for your API Gateway_\\n\\n\\nAzure \", \"API Management solves both your API Gateway and Management needs like logging, security,\\nmetering, e\", \"tc. In this case, when using a product like Azure API Management, the fact that you might\\nhave a sin\", \"gle API Gateway is not so risky because these kinds of API Gateways are \\u201cthinner\\u201d, meaning\\nthat you \", \"don\\u2019t implement custom C# code that could evolve towards a monolithic component.\\n\\n\\nThe API Gateway p\", \"roducts usually act like a reverse proxy for ingress communication, where you can\\nalso filter the AP\", \"Is from the internal microservices plus apply authorization to the published APIs in\\nthis single tie\", \"r.\\n\\n\\nThe insights available from an API Management system help you get an understanding of how your\\n\", \"APIs are being used and how they are performing. They do this activity by letting you view near real\", \"time analytics reports and identifying trends that might impact your business. Plus, you can have lo\", \"gs\\nabout request and response activity for further online and offline analysis.\\n\\n\\nWith Azure API Man\", \"agement, you can secure your APIs using a key, a token, and IP filtering. These\\nfeatures let you enf\", \"orce flexible and fine-grained quotas and rate limits, modify the shape and\\nbehavior of your APIs us\", \"ing policies, and improve performance with response caching.\\n\\n\\nIn this guide and the reference sampl\", \"e application (eShopOnContainers), the architecture is limited to\\na simpler and custom-made containe\", \"rized architecture in order to focus on plain containers without\\n\\n\\n46 CHAPTER 3 | Architecting conta\", \"iner and microservice-based applications\\n\\n\\nusing PaaS products like Azure API Management. But for la\", \"rge microservice-based applications that\\nare deployed into Microsoft Azure, we encourage you to eval\", \"uate Azure API Management as the base\\nfor your API Gateways in production.\\n\\n\\n**Ocelot**\\n\\n\\n[Ocelot](h\", \"ttps://github.com/ThreeMammals/Ocelot) is a lightweight API Gateway, recommended for simpler approac\", \"hes. Ocelot is an Open Source\\n.NET Core-based API Gateway especially made for microservices architec\", \"tures that need unified points\\nof entry into their systems. It\\u2019s lightweight, fast, and scalable and\", \" provides routing and authentication\\namong many other features.\\n\\n\\n[The main reason to choose Ocelot \", \"for the eShopOnContainers reference application 2.0](https://github.com/dotnet-architecture/eShopOnC\", \"ontainers/releases/tag/2.0) is because\\nOcelot is a .NET Core lightweight API Gateway that you can de\", \"ploy into the same application\\ndeployment environment where you\\u2019re deploying your microservices/cont\", \"ainers, such as a Docker\\nHost, Kubernetes, etc. And since it\\u2019s based on .NET Core, it\\u2019s cross-platfo\", \"rm allowing you to deploy on\\nLinux or Windows.\\n\\n\\nThe previous diagrams showing custom API Gateways r\", \"unning in containers are precisely how you can\\nalso run Ocelot in a container and microservice-based\", \" application.\\n\\n\\nIn addition, there are many other products in the market offering API Gateways featu\", \"res, such as\\nApigee, Kong, MuleSoft, WSO2, and other products like Linkerd and Istio for service mes\", \"h ingress\\ncontroller features.\\n\\n\\nAfter the initial architecture and patterns explanation sections, t\", \"he next sections explain how to\\n[implement API Gateways with Ocelot.](https://github.com/ThreeMammal\", \"s/Ocelot)\\n\\n#### **Drawbacks of the API Gateway pattern**\\n\\n\\n  - The most important drawback is that w\", \"hen you implement an API Gateway, you\\u2019re coupling\\nthat tier with the internal microservices. Couplin\", \"g like this might introduce serious difficulties\\nfor your application. Clemens Vaster, architect at \", \"the Azure Service Bus team, refers to this\\n[potential difficulty as \\u201cthe new ESB\\u201d in the \\u201cMessaging \", \"and Microservices\\u201d session at GOTO](https://www.youtube.com/watch?v=rXi5CLjIQ9k)\\n2016.\\n\\n\\n  - Using a\", \" microservices API Gateway creates an additional possible single point of failure.\\n\\n\\n  - An API Gate\", \"way can introduce increased response time due to the additional network call.\\nHowever, this extra ca\", \"ll usually has less impact than having a client interface that\\u2019s too chatty\\ndirectly calling the int\", \"ernal microservices.\\n\\n\\n  - If not scaled out properly, the API Gateway can become a bottleneck.\\n\\n\\n  \", \"- An API Gateway requires additional development cost and future maintenance if it includes\\ncustom l\", \"ogic and data aggregation. Developers must update the API Gateway in order to\\nexpose each microservi\", \"ce\\u2019s endpoints. Moreover, implementation changes in the internal\\nmicroservices might cause code chan\", \"ges at the API Gateway level. However, if the API\\nGateway is just applying security, logging, and ve\", \"rsioning (as when using Azure API\\nManagement), this additional development cost might not apply.\\n\\n\\n4\", \"7 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n  - If the API Gateway is\", \" developed by a single team, there can be a development bottleneck. This\\naspect is another reason wh\", \"y a better approach is to have several fined-grained API Gateways\\nthat respond to different client n\", \"eeds. You could also segregate the API Gateway internally\\ninto multiple areas or layers that are own\", \"ed by the different teams working on the internal\\nmicroservices.\\n\\n#### **Additional resources**\\n\\n\\n  \", \"- **Chris Richardson. Pattern: API Gateway / Backend for Front-End**\\n[https://microservices.io/patte\", \"rns/apigateway.html](https://microservices.io/patterns/apigateway.html)\\n\\n\\n  - **API Gateway pattern*\", \"*\\n[https://learn.microsoft.com/azure/architecture/microservices/gateway](https://docs.microsoft.com/\", \"azure/architecture/microservices/gateway)\\n\\n\\n  - **Aggregation and composition pattern**\\n[https://mic\", \"roservices.io/patterns/data/api-composition.html](https://microservices.io/patterns/data/api-composi\", \"tion.html)\\n\\n\\n  - **Azure API Management**\\n[https://azure.microsoft.com/services/api-management/](htt\", \"ps://azure.microsoft.com/services/api-management/)\\n\\n\\n  - **Udi Dahan. Service Oriented Composition**\", \"\\n[https://udidahan.com/2014/07/30/service-oriented-composition-with-video/](https://udidahan.com/201\", \"4/07/30/service-oriented-composition-with-video/)\\n\\n\\n  - **Clemens Vasters. Messaging and Microservic\", \"es at GOTO 2016 (video)**\\n[https://www.youtube.com/watch?v=rXi5CLjIQ9k](https://www.youtube.com/watc\", \"h?v=rXi5CLjIQ9k)\\n\\n\\n  - **API Gateway in a Nutshell** (ASP.NET Core API Gateway Tutorial Series)\\n[htt\", \"ps://www.pogsdotnet.com/2018/08/api-gateway-in-nutshell.html](https://www.pogsdotnet.com/2018/08/api\", \"-gateway-in-nutshell.html)\\n\\n### Communication in a microservice architecture\\n\\n\\nIn a monolithic appli\", \"cation running on a single process, components invoke one another using\\nlanguage-level method or fun\", \"ction calls. These can be strongly coupled if you\\u2019re creating objects with\\ncode (for example, new Cl\", \"assName()), or can be invoked in a decoupled way if you\\u2019re using\\nDependency Injection by referencing\", \" abstractions rather than concrete object instances. Either way,\\nthe objects are running within the \", \"same process. The biggest challenge when changing from a\\nmonolithic application to a microservices-b\", \"ased application lies in changing the communication\\nmechanism. A direct conversion from in-process m\", \"ethod calls into RPC calls to services will cause a\\nchatty and not efficient communication that won\\u2019\", \"t perform well in distributed environments. The\\nchallenges of designing distributed system properly \", \"are well enough known that there\\u2019s even a canon\\n[known as the Fallacies of distributed computing tha\", \"t lists assumptions that developers often make](https://en.wikipedia.org/wiki/Fallacies_of_distribut\", \"ed_computing)\\nwhen moving from monolithic to distributed designs.\\n\\n\\nThere isn\\u2019t one solution, but se\", \"veral. One solution involves isolating the business microservices as\\nmuch as possible. You then use \", \"asynchronous communication between the internal microservices and\\nreplace fine-grained communication\", \" that\\u2019s typical in intra-process communication between objects\\nwith coarser-grained communication. Y\", \"ou can do this by grouping calls, and by returning data that\\naggregates the results of multiple inte\", \"rnal calls, to the client.\\n\\n\\n48 CHAPTER 3 | Architecting container and microservice-based applicatio\", \"ns\\n\\n\\nA microservices-based application is a distributed system running on multiple processes or serv\", \"ices,\\nusually even across multiple servers or hosts. Each service instance is typically a process. T\", \"herefore,\\nservices must interact using an inter-process communication protocol such as HTTP, AMQP, o\", \"r a\\nbinary protocol like TCP, depending on the nature of each service.\\n\\n\\n[The microservice community\", \" promotes the philosophy of \\u201csmart endpoints and dumb pipes\\u201d. This](https://simplicable.com/new/smar\", \"t-endpoints-and-dumb-pipes)\\nslogan encourages a design that\\u2019s as decoupled as possible between micro\", \"services, and as cohesive\\nas possible within a single microservice. As explained earlier, each micro\", \"service owns its own data and\\nits own domain logic. But the microservices composing an end-to-end ap\", \"plication are usually simply\\nchoreographed by using REST communications rather than complex protocol\", \"s such as WS-* and\\nflexible event-driven communications instead of centralized business-process-orch\", \"estrators.\\n\\n\\nThe two commonly used protocols are HTTP request/response with resource APIs (when quer\", \"ying\\nmost of all), and lightweight asynchronous messaging when communicating updates across multiple\", \"\\nmicroservices. These are explained in more detail in the following sections.\\n\\n#### **Communication \", \"types**\\n\\n\\nClient and services can communicate through many different types of communication, each on\", \"e\\ntargeting a different scenario and goals. Initially, those types of communications can be classifi\", \"ed in\\ntwo axes.\\n\\n\\nThe first axis defines if the protocol is synchronous or asynchronous:\\n\\n\\n  - Synch\", \"ronous protocol. HTTP is a synchronous protocol. The client sends a request and waits\\nfor a response\", \" from the service. That\\u2019s independent of the client code execution that could be\\nsynchronous (thread\", \" is blocked) or asynchronous (thread isn\\u2019t blocked, and the response will\\nreach a callback eventuall\", \"y). The important point here is that the protocol (HTTP/HTTPS) is\\nsynchronous and the client code ca\", \"n only continue its task when it receives the HTTP server\\nresponse.\\n\\n\\n  - Asynchronous protocol. Oth\", \"er protocols like AMQP (a protocol supported by many operating\\nsystems and cloud environments) use a\", \"synchronous messages. The client code or message\\nsender usually doesn\\u2019t wait for a response. It just\", \" sends the message as when sending a\\nmessage to a RabbitMQ queue or any other message broker.\\n\\n\\nThe \", \"second axis defines if the communication has a single receiver or multiple receivers:\\n\\n\\n  - Single r\", \"eceiver. Each request must be processed by exactly one receiver or service. An\\n[example of this comm\", \"unication is the Command pattern.](https://en.wikipedia.org/wiki/Command_pattern)\\n\\n\\n  - Multiple rec\", \"eivers. Each request can be processed by zero to multiple receivers. This type of\\n[communication mus\", \"t be asynchronous. An example is the publish/subscribe mechanism used](https://en.wikipedia.org/wiki\", \"/Publish%E2%80%93subscribe_pattern)\\n[in patterns like Event-driven architecture. This is based on an\", \" event-bus interface or message](https://microservices.io/patterns/data/event-driven-architecture.ht\", \"ml)\\nbroker when propagating data updates between multiple microservices through events; it\\u2019s\\n[usuall\", \"y implemented through a service bus or similar artifact like Azure Service Bus by using](https://azu\", \"re.microsoft.com/services/service-bus/)\\n[topics and subscriptions.](https://docs.microsoft.com/azure\", \"/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions)\\n\\n\\n49 CHAPTER 3 | Architec\", \"ting container and microservice-based applications\\n\\n\\nA microservice-based application will often use\", \" a combination of these communication styles. The\\nmost common type is single-receiver communication \", \"with a synchronous protocol like HTTP/HTTPS\\nwhen invoking a regular Web API HTTP service. Microservi\", \"ces also typically use messaging protocols\\nfor asynchronous communication between microservices.\\n\\n\\nT\", \"hese axes are good to know so you have clarity on the possible communication mechanisms, but\\nthey\\u2019re\", \" not the important concerns when building microservices. Neither the asynchronous nature of\\nclient t\", \"hread execution nor the asynchronous nature of the selected protocol are the important points\\nwhen i\", \"ntegrating microservices. What _is_ important is being able to integrate your microservices\\nasynchro\", \"nously while maintaining the independence of microservices, as explained in the following\\nsection.\\n\\n\", \"#### **Asynchronous microservice integration enforces microservice\\u2019s** **autonomy**\\n\\n\\nAs mentioned, \", \"the important point when building a microservices-based application is the way you\\nintegrate your mi\", \"croservices. Ideally, you should try to minimize the communication between the\\ninternal microservice\", \"s. The fewer communications between microservices, the better. But in many\\ncases, you\\u2019ll have to som\", \"ehow integrate the microservices. When you need to do that, the critical rule\\nhere is that the commu\", \"nication between the microservices should be asynchronous. That doesn\\u2019t\\nmean that you have to use a \", \"specific protocol (for example, asynchronous messaging versus\\nsynchronous HTTP). It just means that \", \"the communication between microservices should be done only\\nby propagating data asynchronously, but \", \"try not to depend on other internal microservices as part of\\nthe initial service\\u2019s HTTP request/resp\", \"onse operation.\\n\\n\\nIf possible, never depend on synchronous communication (request/response) between \", \"multiple\\nmicroservices, not even for queries. The goal of each microservice is to be autonomous and \", \"available\\nto the client consumer, even if the other services that are part of the end-to-end applica\", \"tion are down\\nor unhealthy. If you think you need to make a call from one microservice to other micr\", \"oservices (like\\nperforming an HTTP request for a data query) to be able to provide a response to a c\", \"lient application,\\nyou have an architecture that won\\u2019t be resilient when some microservices fail.\\n\\n\\n\", \"Moreover, having HTTP dependencies between microservices, like when creating long\\nrequest/response c\", \"ycles with HTTP request chains, as shown in the first part of the Figure 4-15, not\\nonly makes your m\", \"icroservices not autonomous but also their performance is impacted as soon as\\none of the services in\", \" that chain isn\\u2019t performing well.\\n\\n\\nThe more you add synchronous dependencies between microservices\", \", such as query requests, the\\nworse the overall response time gets for the client apps.\\n\\n\\n50 CHAPTER\", \" 3 | Architecting container and microservice-based applications\\n\\n\\n_Figure 4-15. Anti-patterns and pa\", \"tterns in communication between microservices_\\n\\n\\nAs shown in the above diagram, in synchronous commu\", \"nication a \\u201cchain\\u201d of requests is created\\nbetween microservices while serving the client request. Th\", \"is is an anti-pattern. In asynchronous\\ncommunication microservices use asynchronous messages or http\", \" polling to communicate with other\\nmicroservices, but the client request is served right away.\\n\\n\\nIf \", \"your microservice needs to raise an additional action in another microservice, if possible, do not\\np\", \"erform that action synchronously and as part of the original microservice request and reply\\noperatio\", \"n. Instead, do it asynchronously (using asynchronous messaging or integration events,\\nqueues, etc.).\", \" But, as much as possible, do not invoke the action synchronously as part of the original\\nsynchronou\", \"s request and reply operation.\\n\\n\\nAnd finally (and this is where most of the issues arise when buildi\", \"ng microservices), if your initial\\nmicroservice needs data that\\u2019s originally owned by other microser\", \"vices, do not rely on making\\nsynchronous requests for that data. Instead, replicate or propagate tha\", \"t data (only the attributes you\\nneed) into the initial service\\u2019s database by using eventual consiste\", \"ncy (typically by using integration\\nevents, as explained in upcoming sections).\\n\\n\\nAs noted earlier i\", \"n the Identifying domain-model boundaries for each microservice section,\\nduplicating some data acros\", \"s several microservices isn\\u2019t an incorrect design\\u2014on the contrary, when\\ndoing that you can translate\", \" the data into the specific language or terms of that additional domain or\\n[Bounded Context. For ins\", \"tance, in the eShopOnContainers application](https://github.com/dotnet-architecture/eShopOnContainer\", \"s) you have a microservice named\\nidentity-api that\\u2019s in charge of most of the user\\u2019s data with an en\", \"tity named User. However, when you\\nneed to store data about the user within the Ordering microservic\", \"e, you store it as a different entity\\nnamed Buyer. The Buyer entity shares the same identity with th\", \"e original User entity, but it might have\\nonly the few attributes needed by the Ordering domain, and\", \" not the whole user profile.\\n\\n\\n51 CHAPTER 3 | Architecting container and microservice-based applicat\", \"ions\\n\\n\\nYou might use any protocol to communicate and propagate data asynchronously across microservi\", \"ces\\nin order to have eventual consistency. As mentioned, you could use integration events using an e\", \"vent\\nbus or message broker or you could even use HTTP by polling the other services instead. It does\", \"n\\u2019t\\nmatter. The important rule is to not create synchronous dependencies between your microservices.\", \"\\n\\n\\nThe following sections explain the multiple communication styles you can consider using in a\\nmicr\", \"oservice-based application.\\n\\n#### **Communication styles**\\n\\n\\nThere are many protocols and choices yo\", \"u can use for communication, depending on the\\ncommunication type you want to use. If you\\u2019re using a \", \"synchronous request/response-based\\ncommunication mechanism, protocols such as HTTP and REST approach\", \"es are the most common,\\nespecially if you\\u2019re publishing your services outside the Docker host or mic\", \"roservice cluster. If you\\u2019re\\ncommunicating between services internally (within your Docker host or m\", \"icroservices cluster), you\\nmight also want to use binary format communication mechanisms (like WCF u\", \"sing TCP and binary\\nformat). Alternatively, you can use asynchronous, message-based communication me\", \"chanisms such as\\nAMQP.\\n\\n\\nThere are also multiple message formats like JSON or XML, or even binary fo\", \"rmats, which can be more\\nefficient. If your chosen binary format isn\\u2019t a standard, it\\u2019s probably not\", \" a good idea to publicly\\npublish your services using that format. You could use a non-standard forma\", \"t for internal\\ncommunication between your microservices. You might do this when communicating betwee\", \"n\\nmicroservices within your Docker host or microservice cluster (for example, Docker orchestrators),\", \" or\\nfor proprietary client applications that talk to the microservices.\\n\\n\\n**Request/response communi\", \"cation with HTTP and REST**\\n\\n\\nWhen a client uses request/response communication, it sends a request \", \"to a service, then the service\\nprocesses the request and sends back a response. Request/response com\", \"munication is especially well\\nsuited for querying data for a real-time UI (a live user interface) fr\", \"om client apps. Therefore, in a\\nmicroservice architecture you\\u2019ll probably use this communication mec\", \"hanism for most queries, as\\nshown in Figure 4-16.\\n\\n\\n_Figure 4-16. Using HTTP request/response commun\", \"ication (synchronous or asynchronous)_\\n\\n\\n52 CHAPTER 3 | Architecting container and microservice-base\", \"d applications\\n\\n\\nWhen a client uses request/response communication, it assumes that the response wil\", \"l arrive in a\\nshort time, typically less than a second, or a few seconds at most. For delayed respon\", \"ses, you need to\\n[implement asynchronous communication based on messaging patterns](https://docs.mic\", \"rosoft.com/azure/architecture/patterns/category/messaging) [and messaging technologies,](https://en.\", \"wikipedia.org/wiki/Message-oriented_middleware)\\nwhich is a different approach that we explain in the\", \" next section.\\n\\n\\n[A popular architectural style for request/response communication is REST. This app\", \"roach is based on,](https://en.wikipedia.org/wiki/Representational_state_transfer)\\n[and tightly coup\", \"led to, the HTTP](https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol) protocol, embracing HTT\", \"P verbs like GET, POST, and PUT. REST is the\\nmost commonly used architectural communication approach\", \" when creating services. You can\\nimplement REST services when you develop ASP.NET Core Web API servi\", \"ces.\\n\\n\\nThere\\u2019s additional value when using HTTP REST services as your interface definition language.\", \" For\\n[instance, if you use Swagger metadata to describe your service API, you can use tools that gen\", \"erate](https://swagger.io/)\\nclient stubs that can directly discover and consume your services.\\n\\n\\n**A\", \"dditional resources**\\n\\n\\n  - **Martin Fowler. Richardson Maturity Model** A description of the REST m\", \"odel.\\n[https://martinfowler.com/articles/richardsonMaturityModel.html](https://martinfowler.com/arti\", \"cles/richardsonMaturityModel.html)\\n\\n\\n  - **Swagger** The official site.\\n[https://swagger.io/](https:\", \"//swagger.io/)\\n\\n\\n**Push and real-time communication based on HTTP**\\n\\n\\nAnother possibility (usually f\", \"or different purposes than REST) is a real-time and one-to-many\\n[communication with higher-level fra\", \"meworks such as ASP.NET SignalR](https://www.asp.net/signalr) and protocols such as\\n[WebSockets.](ht\", \"tps://en.wikipedia.org/wiki/WebSocket)\\n\\n\\nAs Figure 4-17 shows, real-time HTTP communication means th\", \"at you can have server code pushing\\ncontent to connected clients as the data becomes available, rath\", \"er than having the server wait for a\\nclient to request new data.\\n\\n\\n53 CHAPTER 3 | Architecting conta\", \"iner and microservice-based applications\\n\\n\\n_Figure 4-17. One-to-many real-time asynchronous message \", \"communication_\\n\\n\\nSignalR is a good way to achieve real-time communication for pushing content to the\", \" clients from a\\nback-end server. Since communication is in real time, client apps show the changes a\", \"lmost instantly.\\nThis is usually handled by a protocol such as WebSockets, using many WebSockets con\", \"nections (one\\nper client). A typical example is when a service communicates a change in the score of\", \" a sports game\\nto many client web apps simultaneously.\\n\\n### Asynchronous message-based communication\", \"\\n\\n\\nAsynchronous messaging and event-driven communication are critical when propagating changes\\nacros\", \"s multiple microservices and their related domain models. As mentioned earlier in the discussion\\nmic\", \"roservices and Bounded Contexts (BCs), models (User, Customer, Product, Account, etc.) can mean\\ndiff\", \"erent things to different microservices or BCs. That means that when changes occur, you need\\nsome wa\", \"y to reconcile changes across the different models. A solution is eventual consistency and\\nevent-dri\", \"ven communication based on asynchronous messaging.\\n\\n\\nWhen using messaging, processes communicate by \", \"exchanging messages asynchronously. A client\\nmakes a command or a request to a service by sending it\", \" a message. If the service needs to reply, it\\nsends a different message back to the client. Since it\", \"\\u2019s a message-based communication, the client\\nassumes that the reply won\\u2019t be received immediately, a\", \"nd that there might be no response at all.\\n\\n\\nA message is composed by a header (metadata such as ide\", \"ntification or security information) and a\\nbody. Messages are usually sent through asynchronous prot\", \"ocols like AMQP.\\n\\n\\nThe preferred infrastructure for this type of communication in the microservices \", \"community is a\\nlightweight message broker, which is different than the large brokers and orchestrato\", \"rs used in SOA.\\nIn a lightweight message broker, the infrastructure is typically \\u201cdumb,\\u201d acting only\", \" as a message\\nbroker, with simple implementations such as RabbitMQ or a scalable service bus in the \", \"cloud like\\n\\n\\n54 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\nAzure Servi\", \"ce Bus. In this scenario, most of the \\u201csmart\\u201d thinking still lives in the endpoints that are\\nproduci\", \"ng and consuming messages-that is, in the microservices.\\n\\n\\nAnother rule you should try to follow, as\", \" much as possible, is to use only asynchronous messaging\\nbetween the internal services, and to use s\", \"ynchronous communication (such as HTTP) only from the\\nclient apps to the front-end services (API Gat\", \"eways plus the first level of microservices).\\n\\n\\nThere are two kinds of asynchronous messaging commun\", \"ication: single receiver message-based\\ncommunication, and multiple receivers message-based communica\", \"tion. The following sections\\nprovide details about them.\\n\\n#### **Single-receiver message-based commu\", \"nication**\\n\\n\\nMessage-based asynchronous communication with a single receiver means there\\u2019s point-to-\", \"point\\ncommunication that delivers a message to exactly one of the consumers that\\u2019s reading from the\\n\", \"channel, and that the message is processed just once. However, there are special situations. For\\nins\", \"tance, in a cloud system that tries to automatically recover from failures, the same message could\\nb\", \"e sent multiple times. Due to network or other failures, the client has to be able to retry sending\\n\", \"messages, and the server has to implement an operation to be idempotent in order to process a\\npartic\", \"ular message just once.\\n\\n\\nSingle-receiver message-based communication is especially well suited for \", \"sending asynchronous\\ncommands from one microservice to another as shown in Figure 4-18 that illustra\", \"tes this approach.\\n\\n\\nOnce you start sending message-based communication (either with commands or eve\", \"nts), you should\\navoid mixing message-based communication with synchronous HTTP communication.\\n\\n\\n_Fi\", \"gure 4-18. A single microservice receiving an asynchronous message_\\n\\n\\n55 CHAPTER 3 | Architecting co\", \"ntainer and microservice-based applications\\n\\n\\nWhen the commands come from client applications, they \", \"can be implemented as HTTP synchronous\\ncommands. Use message-based commands when you need higher sca\", \"lability or when you\\u2019re already\\nin a message-based business process.\\n\\n#### **Multiple-receivers mess\", \"age-based communication**\\n\\n\\nAs a more flexible approach, you might also want to use a publish/subscr\", \"ibe mechanism so that your\\ncommunication from the sender will be available to additional subscriber \", \"microservices or to external\\n[applications. Thus, it helps you to follow the open/closed principle](\", \"https://en.wikipedia.org/wiki/Open/closed_principle) in the sending service. That way,\\nadditional su\", \"bscribers can be added in the future without the need to modify the sender service.\\n\\n\\nWhen you use a\", \" publish/subscribe communication, you might be using an event bus interface to\\npublish events to any\", \" subscriber.\\n\\n#### **Asynchronous event-driven communication**\\n\\n\\nWhen using asynchronous event-drive\", \"n communication, a microservice publishes an integration event\\nwhen something happens within its dom\", \"ain and another microservice needs to be aware of it, like a\\nprice change in a product catalog micro\", \"service. Additional microservices subscribe to the events so\\nthey can receive them asynchronously. W\", \"hen that happens, the receivers might update their own\\ndomain entities, which can cause more integra\", \"tion events to be published. This publish/subscribe\\nsystem is performed by using an implementation o\", \"f an event bus. The event bus can be designed as\\nan abstraction or interface, with the API that\\u2019s ne\", \"eded to subscribe or unsubscribe to events and to\\npublish events. The event bus can also have one or\", \" more implementations based on any inter-process\\nand messaging broker, like a messaging queue or ser\", \"vice bus that supports asynchronous\\ncommunication and a publish/subscribe model.\\n\\n\\nIf a system uses \", \"eventual consistency driven by integration events, it\\u2019s recommended that this\\napproach is made clear\", \" to the end user. The system shouldn\\u2019t use an approach that mimics\\nintegration events, like SignalR \", \"or polling systems from the client. The end user and the business\\nowner have to explicitly embrace e\", \"ventual consistency in the system and realize that in many cases\\nthe business doesn\\u2019t have any probl\", \"em with this approach, as long as it\\u2019s explicit. This approach is\\nimportant because users might expe\", \"ct to see some results immediately and this aspect might not\\nhappen with eventual consistency.\\n\\n\\nAs \", \"noted earlier in the Challenges and solutions for distributed data management section, you can use\\ni\", \"ntegration events to implement business tasks that span multiple microservices. Thus, you\\u2019ll have\\nev\", \"entual consistency between those services. An eventually consistent transaction is made up of a\\ncoll\", \"ection of distributed actions. At each action, the related microservice updates a domain entity and\\n\", \"publishes another integration event that raises the next action within the same end-to-end business\\n\", \"task.\\n\\n\\nAn important point is that you might want to communicate to multiple microservices that are\\n\", \"subscribed to the same event. To do so, you can use publish/subscribe messaging based on eventdriven\", \" communication, as shown in Figure 4-19. This publish/subscribe mechanism isn\\u2019t exclusive to\\n[the mi\", \"croservice architecture. It\\u2019s similar to the way Bounded Contexts](https://martinfowler.com/bliki/Bo\", \"undedContext.html) in DDD should communicate,\\n[or to the way you propagate updates from the write da\", \"tabase to the read database in the Command](https://martinfowler.com/bliki/CQRS.html)\\n\\n\\n56 CHAPTER 3\", \" | Architecting container and microservice-based applications\\n\\n\\n[and Query Responsibility Segregatio\", \"n (CQRS) architecture pattern. The goal is to have eventual](https://martinfowler.com/bliki/CQRS.htm\", \"l)\\nconsistency between multiple data sources across your distributed system.\\n\\n\\n_Figure 4-19. Asynchr\", \"onous event-driven message communication_\\n\\n\\nIn asynchronous event-driven communication, one microser\", \"vice publishes events to an event bus and\\nmany microservices can subscribe to it, to get notified an\", \"d act on it. Your implementation will\\n[determine what protocol to use for event-driven, message-base\", \"d communications. AMQP can help](https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol)\\nac\", \"hieve reliable queued communication.\\n\\n\\nWhen you use an event bus, you might want to use an abstracti\", \"on level (like an event bus interface)\\nbased on a related implementation in classes with code using \", \"the API from a message broker like\\n[RabbitMQ](https://www.rabbitmq.com/) [or a service bus like Azur\", \"e Service Bus with Topics. Alternatively, you might want to use a](https://docs.microsoft.com/azure/\", \"service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions)\\n[higher-level service bus \", \"like NServiceBus,](https://particular.net/nservicebus) [MassTransit, or Brighter](https://masstransi\", \"t.io/) to articulate your event bus and\\npublish/subscribe system.\\n\\n#### **A note about messaging tec\", \"hnologies for production systems**\\n\\n\\nThe messaging technologies available for implementing your abst\", \"ract event bus are at different levels.\\nFor instance, products like RabbitMQ (a messaging broker tra\", \"nsport) and Azure Service Bus sit at a\\n[lower level than other products like NServiceBus,](https://p\", \"articular.net/nservicebus) [MassTransit, or Brighter, which can work on top of](https://masstransit.\", \"io/)\\nRabbitMQ and Azure Service Bus. Your choice depends on how many rich features at the applicatio\", \"n\\nlevel and out-of-the-box scalability you need for your application. For implementing just a proof-\", \"ofconcept event bus for your development environment, as it was done in the eShopOnContainers\\nsample\", \", a simple implementation on top of RabbitMQ running on a Docker container might be\\nenough.\\n\\n\\nHoweve\", \"r, for mission-critical and production systems that need hyper-scalability, you might want to\\nevalua\", \"te Azure Service Bus. For high-level abstractions and features that make the development of\\ndistribu\", \"ted applications easier, we recommend that you evaluate other commercial and open-source\\n[service bu\", \"ses, such as NServiceBus, MassTransit, and Brighter. Of course, you can build your own](https://part\", \"icular.net/nservicebus)\\n\\n\\n57 CHAPTER 3 | Architecting container and microservice-based applications\\n\", \"\\n\\nservice-bus features on top of lower-level technologies like RabbitMQ and Docker. But that plumbin\", \"g\\nwork might cost too much for a custom enterprise application.\\n\\n#### **Resiliently publishing to th\", \"e event bus**\\n\\n\\nA challenge when implementing an event-driven architecture across multiple microserv\", \"ices is how to\\natomically update state in the original microservice while resiliently publishing its\", \" related integration\\nevent into the event bus, somehow based on transactions. The following are a fe\", \"w ways to accomplish\\nthis functionality, although there could be additional approaches as well.\\n\\n\\n  \", \"- Using a transactional (DTC-based) queue like MSMQ. (However, this is a legacy approach.)\\n\\n\\n  - Usi\", \"ng transaction log mining.\\n\\n\\n  - [Using full Event Sourcing pattern.](https://docs.microsoft.com/azu\", \"re/architecture/patterns/event-sourcing)\\n\\n\\n  - [Using the Outbox pattern: a transactional database t\", \"able as a message queue that will be the](https://www.kamilgrzybek.com/design/the-outbox-pattern/)\\nb\", \"ase for an event-creator component that would create the event and publish it.\\n\\n\\nFor a more complete\", \" description of the challenges in this space, including how messages with\\n[potentially incorrect dat\", \"a can end up being published, see Data platform for mission-critical](https://docs.microsoft.com/azu\", \"re/architecture/reference-architectures/containers/aks-mission-critical/mission-critical-data-platfo\", \"rm#every-message-must-be-processed)\\n[workloads on Azure: Every message must be processed.](https://d\", \"ocs.microsoft.com/azure/architecture/reference-architectures/containers/aks-mission-critical/mission\", \"-critical-data-platform#every-message-must-be-processed)\\n\\n\\nAdditional topics to consider when using \", \"asynchronous communication are message idempotence\\nand message deduplication. These topics are cover\", \"ed in the section Implementing event-based\\ncommunication between microservices (integration events) \", \"later in this guide.\\n\\n#### **Additional resources**\\n\\n\\n  - **Event Driven Messaging**\\n[https://patter\", \"ns.arcitura.com/soa-patterns/design_patterns/event_driven_messaging](https://patterns.arcitura.com/s\", \"oa-patterns/design_patterns/event_driven_messaging)\\n\\n\\n  - **Publish/Subscribe Channel**\\n[https://www\", \".enterpriseintegrationpatterns.com/patterns/messaging/PublishSubscribeChannel.](https://www.enterpri\", \"seintegrationpatterns.com/patterns/messaging/PublishSubscribeChannel.html)\\nhtml\\n\\n\\n  - **Udi Dahan. C\", \"larified CQRS**\\n[https://udidahan.com/2009/12/09/clarified-cqrs/](https://udidahan.com/2009/12/09/cl\", \"arified-cqrs/)\\n\\n\\n  - **Command and Query Responsibility Segregation (CQRS)**\\n[https://learn.microsof\", \"t.com/azure/architecture/patterns/cqrs](https://docs.microsoft.com/azure/architecture/patterns/cqrs)\", \"\\n\\n\\n  - **Communicating Between Bounded Contexts**\\n[https://learn.microsoft.com/previous-versions/msp\", \"-n-p/jj591572(v=pandp.10)](https://docs.microsoft.com/previous-versions/msp-n-p/jj591572(v=pandp.10)\", \")\\n\\n\\n  - **Eventual consistency**\\n[https://en.wikipedia.org/wiki/Eventual_consistency](https://en.wik\", \"ipedia.org/wiki/Eventual_consistency)\\n\\n\\n  - **Jimmy Bogard. Refactoring Towards Resilience: Evaluati\", \"ng Coupling**\\n[https://jimmybogard.com/refactoring-towards-resilience-evaluating-coupling/](https://\", \"jimmybogard.com/refactoring-towards-resilience-evaluating-coupling/)\\n\\n\\n58 CHAPTER 3 | Architecting c\", \"ontainer and microservice-based applications\\n\\n\\n### Creating, evolving, and versioning microservice A\", \"PIs and contracts\\n\\nA microservice API is a contract between the service and its clients. You\\u2019ll be a\", \"ble to evolve a\\nmicroservice independently only if you do not break its API contract, which is why t\", \"he contract is so\\nimportant. If you change the contract, it will impact your client applications or \", \"your API Gateway.\\n\\n\\nThe nature of the API definition depends on which protocol you\\u2019re using. For ins\", \"tance, if you\\u2019re using\\nmessaging, like AMQP, the API consists of the message types. If you\\u2019re using \", \"HTTP and RESTful\\nservices, the API consists of the URLs and the request and response JSON formats.\\n\\n\", \"\\nHowever, even if you\\u2019re thoughtful about your initial contract, a service API will need to change o\", \"ver\\ntime. When that happens\\u2014and especially if your API is a public API consumed by multiple client\\na\", \"pplications \\u2014 you typically can\\u2019t force all clients to upgrade to your new API contract. You usually\", \"\\nneed to incrementally deploy new versions of a service in a way that both old and new versions of a\", \"\\nservice contract are running simultaneously. Therefore, it\\u2019s important to have a strategy for your\\n\", \"service versioning.\\n\\n\\nWhen the API changes are small, like if you add attributes or parameters to yo\", \"ur API, clients that use\\nan older API should switch and work with the new version of the service. Yo\", \"u might be able to provide\\ndefault values for any missing attributes that are required, and the clie\", \"nts might be able to ignore any\\nextra response attributes.\\n\\n\\nHowever, sometimes you need to make maj\", \"or and incompatible changes to a service API. Because\\nyou might not be able to force client applicat\", \"ions or services to upgrade immediately to the new\\nversion, a service must support older versions of\", \" the API for some period. If you\\u2019re using an HTTPbased mechanism such as REST, one approach is to em\", \"bed the API version number in the URL or into\\nan HTTP header. Then you can decide between implementi\", \"ng both versions of the service\\nsimultaneously within the same service instance, or deploying differ\", \"ent instances that each handle a\\n[version of the API. A good approach for this functionality is the \", \"Mediator pattern (for example,](https://en.wikipedia.org/wiki/Mediator_pattern)\\n[MediatR library) to\", \" decouple the different implementation versions into independent handlers.](https://github.com/jboga\", \"rd/MediatR)\\n\\n\\n[Finally, if you\\u2019re using a REST architecture, Hypermedia](https://www.infoq.com/artic\", \"les/mark-baker-hypermedia) is the best solution for versioning your services\\nand allowing evolvable \", \"APIs.\\n\\n#### **Additional resources**\\n\\n\\n  - **Scott Hanselman. ASP.NET Core RESTful Web API versionin\", \"g made easy**\\n[https://www.hanselman.com/blog/ASPNETCoreRESTfulWebAPIVersioningMadeEasy.aspx](https:\", \"//www.hanselman.com/blog/ASPNETCoreRESTfulWebAPIVersioningMadeEasy.aspx)\\n\\n\\n  - **Versioning a RESTfu\", \"l web API**\\n[https://learn.microsoft.com/azure/architecture/best-practices/api-design#versioning-a-]\", \"(https://docs.microsoft.com/azure/architecture/best-practices/api-design#versioning-a-restful-web-ap\", \"i)\\n[restful-web-api](https://docs.microsoft.com/azure/architecture/best-practices/api-design#version\", \"ing-a-restful-web-api)\\n\\n\\n  - **Roy Fielding. Versioning, Hypermedia, and REST**\\n[https://www.infoq.c\", \"om/articles/roy-fielding-on-versioning](https://www.infoq.com/articles/roy-fielding-on-versioning)\\n\\n\", \"\\n59 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n### Microservices addre\", \"ssability and the service registry\\n\\nEach microservice has a unique name (URL) that\\u2019s used to resolve\", \" its location. Your microservice needs\\nto be addressable wherever it\\u2019s running. If you have to think\", \" about which computer is running a\\nparticular microservice, things can go bad quickly. In the same w\", \"ay that DNS resolves a URL to a\\nparticular computer, your microservice needs to have a unique name s\", \"o that its current location is\\ndiscoverable. Microservices need addressable names that make them ind\", \"ependent from the\\ninfrastructure that they\\u2019re running on. This approach implies that there\\u2019s an inte\", \"raction between how\\n[your service is deployed and how it\\u2019s discovered, because there needs to be a s\", \"ervice registry. In the](https://microservices.io/patterns/service-registry.html)\\nsame vein, when a \", \"computer fails, the registry service must be able to indicate where the service is\\nnow running.\\n\\n\\n[T\", \"he service registry pattern is a key part of service discovery. The registry is a database containin\", \"g the](https://microservices.io/patterns/service-registry.html)\\nnetwork locations of service instanc\", \"es. A service registry needs to be highly available and up-to-date.\\nClients could cache network loca\", \"tions obtained from the service registry. However, that information\\neventually goes out of date and \", \"clients can no longer discover service instances. So, a service registry\\nconsists of a cluster of se\", \"rvers that use a replication protocol to maintain consistency.\\n\\n\\nIn some microservice deployment env\", \"ironments (called clusters, to be covered in a later section),\\nservice discovery is built in. For ex\", \"ample, an Azure Kubernetes Service (AKS) environment can handle\\nservice instance registration and de\", \"registration. It also runs a proxy on each cluster host that plays the\\nrole of server-side discovery\", \" router.\\n\\n#### **Additional resources**\\n\\n\\n  - **Chris Richardson. Pattern: Service registry**\\n[https\", \"://microservices.io/patterns/service-registry.html](https://microservices.io/patterns/service-regist\", \"ry.html)\\n\\n\\n  - **Auth0. The Service Registry**\\n[https://auth0.com/blog/an-introduction-to-microservi\", \"ces-part-3-the-service-registry/](https://auth0.com/blog/an-introduction-to-microservices-part-3-the\", \"-service-registry/)\\n\\n\\n  - **Gabriel Schenker. Service discovery**\\n[https://lostechies.com/gabrielsch\", \"enker/2016/01/27/service-discovery/](https://lostechies.com/gabrielschenker/2016/01/27/service-disco\", \"very/)\\n\\n### Creating composite UI based on microservices\\n\\n\\nMicroservices architecture often starts w\", \"ith the server-side handling data and logic, but, in many\\ncases, the UI is still handled as a monoli\", \"th. However, a more advanced approach, called micro\\n[frontends, is to design your application UI bas\", \"ed on microservices as well. That means having a](https://martinfowler.com/articles/micro-frontends.\", \"html)\\ncomposite UI produced by the microservices, instead of having microservices on the server and \", \"just a\\nmonolithic client app consuming the microservices. With this approach, the microservices you \", \"build\\ncan be complete with both logic and visual representation.\\n\\n\\nFigure 4-20 shows the simpler app\", \"roach of just consuming microservices from a monolithic client\\napplication. Of course, you could hav\", \"e an ASP.NET MVC service in between producing the HTML and\\nJavaScript. The figure is a simplificatio\", \"n that highlights that you have a single (monolithic) client UI\\n\\n\\n60 CHAPTER 3 | Architecting contai\", \"ner and microservice-based applications\\n\\n\\nconsuming the microservices, which just focus on logic and\", \" data and not on the UI shape (HTML and\\nJavaScript).\\n\\n\\n_Figure 4-20. A monolithic UI application con\", \"suming back-end microservices_\\n\\n\\nIn contrast, a composite UI is precisely generated and composed by \", \"the microservices themselves.\\nSome of the microservices drive the visual shape of specific areas of \", \"the UI. The key difference is that\\nyou have client UI components (TypeScript classes, for example) b\", \"ased on templates, and the datashaping-UI ViewModel for those templates comes from each microservice\", \".\\n\\n\\nAt client application start-up time, each of the client UI components (TypeScript classes, for e\", \"xample)\\nregisters itself with an infrastructure microservice capable of providing ViewModels for a g\", \"iven\\nscenario. If the microservice changes the shape, the UI changes also.\\n\\n\\nFigure 4-21 shows a ver\", \"sion of this composite UI approach. This approach is simplified because you\\nmight have other microse\", \"rvices that are aggregating granular parts that are based on different\\ntechniques. It depends on whe\", \"ther you\\u2019re building a traditional web approach (ASP.NET MVC) or an\\nSPA (Single Page Application).\\n\\n\", \"\\n61 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n_Figure 4-21. Example o\", \"f a composite UI application shaped by back-end microservices_\\n\\n\\nEach of those UI composition micros\", \"ervices would be similar to a small API Gateway. But in this case,\\neach one is responsible for a sma\", \"ll UI area.\\n\\n\\nA composite UI approach that\\u2019s driven by microservices can be more challenging or less\", \" so,\\ndepending on what UI technologies you\\u2019re using. For instance, you won\\u2019t use the same techniques\", \" for\\nbuilding a traditional web application that you use for building an SPA or for native mobile ap\", \"p (as\\nwhen developing Xamarin apps, which can be more challenging for this approach).\\n\\n\\n[The eShopOn\", \"Containers](https://aka.ms/MicroservicesArchitecture) sample application uses the monolithic UI appr\", \"oach for multiple reasons.\\nFirst, it\\u2019s an introduction to microservices and containers. A composite \", \"UI is more advanced but also\\nrequires further complexity when designing and developing the UI. Secon\", \"d, eShopOnContainers also\\nprovides a native mobile app based on Xamarin, which would make it more co\", \"mplex on the client C#\\nside.\\n\\n\\nHowever, we encourage you to use the following references to learn mo\", \"re about composite UI based\\non microservices.\\n\\n#### **Additional resources**\\n\\n\\n  - **Micro Frontends\", \" (Martin Fowler\\u2019s blog)**\\n[https://martinfowler.com/articles/micro-frontends.html](https://martinfow\", \"ler.com/articles/micro-frontends.html)\\n\\n\\n  - **Micro Frontends (Michael Geers site)**\\n[https://micro\", \"-frontends.org/](https://micro-frontends.org/)\\n\\n\\n  - **Composite UI using ASP.NET (Particular\\u2019s Work\", \"shop)**\\n[https://github.com/Particular/Workshop/tree/master/demos/asp-net-core](https://github.com/P\", \"articular/Workshop/tree/master/demos/asp-net-core)\\n\\n\\n  - **Ruben Oostinga. The Monolithic Frontend i\", \"n the Microservices Architecture**\\n[https://xebia.com/blog/the-monolithic-frontend-in-the-microservi\", \"ces-architecture/](https://xebia.com/blog/the-monolithic-frontend-in-the-microservices-architecture/\", \")\\n\\n\\n62 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n  - **Mauro Servient\", \"i. The secret of better UI composition**\\n[https://particular.net/blog/secret-of-better-ui-compositio\", \"n](https://particular.net/blog/secret-of-better-ui-composition)\\n\\n\\n  - **Viktor Farcic. Including Fro\", \"nt-End Web Components Into Microservices**\\n[https://technologyconversations.com/2015/08/09/including\", \"-front-end-web-components-](https://technologyconversations.com/2015/08/09/including-front-end-web-c\", \"omponents-into-microservices/)\\n[into-microservices/](https://technologyconversations.com/2015/08/09/\", \"including-front-end-web-components-into-microservices/)\\n\\n\\n  - **Managing Frontend in the Microservic\", \"es Architecture**\\n[https://allegro.tech/2016/03/Managing-Frontend-in-the-microservices-architecture.\", \"html](https://allegro.tech/2016/03/Managing-Frontend-in-the-microservices-architecture.html)\\n\\n### Re\", \"siliency and high availability in microservices\\n\\n\\nDealing with unexpected failures is one of the har\", \"dest problems to solve, especially in a distributed\\nsystem. Much of the code that developers write i\", \"nvolves handling exceptions, and this is also where\\nthe most time is spent in testing. The problem i\", \"s more involved than writing code to handle failures.\\nWhat happens when the machine where the micros\", \"ervice is running fails? Not only do you need to\\ndetect this microservice failure (a hard problem on\", \" its own), but you also need something to restart\\nyour microservice.\\n\\n\\nA microservice needs to be re\", \"silient to failures and to be able to restart often on another machine for\\navailability. This resili\", \"ency also comes down to the state that was saved on behalf of the microservice,\\nwhere the microservi\", \"ce can recover this state from, and whether the microservice can restart\\nsuccessfully. In other word\", \"s, there needs to be resiliency in the compute capability (the process can\\nrestart at any time) as w\", \"ell as resilience in the state or data (no data loss, and the data remains\\nconsistent).\\n\\n\\nThe proble\", \"ms of resiliency are compounded during other scenarios, such as when failures occur\\nduring an applic\", \"ation upgrade. The microservice, working with the deployment system, needs to\\ndetermine whether it c\", \"an continue to move forward to the newer version or instead roll back to a\\nprevious version to maint\", \"ain a consistent state. Questions such as whether enough machines are\\navailable to keep moving forwa\", \"rd and how to recover previous versions of the microservice need to\\nbe considered. This approach req\", \"uires the microservice to emit health information so that the overall\\napplication and orchestrator c\", \"an make these decisions.\\n\\n\\nIn addition, resiliency is related to how cloud-based systems must behave\", \". As mentioned, a cloudbased system must embrace failures and must try to automatically recover from\", \" them. For instance, in\\ncase of network or container failures, client apps or client services must h\", \"ave a strategy to retry\\nsending messages or to retry requests, since in many cases failures in the c\", \"loud are partial. The\\nImplementing Resilient Applications section in this guide addresses how to han\", \"dle partial failure. It\\ndescribes techniques like retries with exponential backoff or the Circuit Br\", \"eaker pattern in .NET by\\n[using libraries like Polly, which offers a large variety of policies to ha\", \"ndle this subject.](https://github.com/App-vNext/Polly)\\n\\n#### **Health management and diagnostics in\", \" microservices**\\n\\n\\nIt may seem obvious, and it\\u2019s often overlooked, but a microservice must report it\", \"s health and\\ndiagnostics. Otherwise, there\\u2019s little insight from an operations perspective. Correlat\", \"ing diagnostic\\nevents across a set of independent services and dealing with machine clock skews to m\", \"ake sense of\\n\\n\\n63 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\nthe event\", \" order is challenging. In the same way that you interact with a microservice over agreedupon protoco\", \"ls and data formats, there\\u2019s a need for standardization in how to log health and\\ndiagnostic events t\", \"hat ultimately end up in an event store for querying and viewing. In a microservices\\napproach, it\\u2019s \", \"key that different teams agree on a single logging format. There needs to be a\\nconsistent approach t\", \"o viewing diagnostic events in the application.\\n\\n\\n**Health checks**\\n\\n\\nHealth is different from diagn\", \"ostics. Health is about the microservice reporting its current state to take\\nappropriate actions. A \", \"good example is working with upgrade and deployment mechanisms to\\nmaintain availability. Although a \", \"service might currently be unhealthy due to a process crash or\\nmachine reboot, the service might sti\", \"ll be operational. The last thing you need is to make this worse\\nby performing an upgrade. The best \", \"approach is to do an investigation first or allow time for the\\nmicroservice to recover. Health event\", \"s from a microservice help us make informed decisions and, in\\neffect, help create self-healing servi\", \"ces.\\n\\n\\nIn the Implementing health checks in ASP.NET Core services section of this guide, we explain \", \"how to\\nuse a new ASP.NET HealthChecks library in your microservices so they can report their state t\", \"o a\\nmonitoring service to take appropriate actions.\\n\\n\\nYou also have the option of using an excellent\", \" open-source library called\\n[AspNetCore.Diagnostics.HealthChecks, available on GitHub](https://githu\", \"b.com/Xabaril/AspNetCore.Diagnostics.HealthChecks) [and as a NuGet package. This library also](https\", \"://www.nuget.org/packages/Microsoft.AspNetCore.Diagnostics.HealthChecks/)\\ndoes health checks, with a\", \" twist, it handles two types of checks:\\n\\n\\n  - **Liveness** : Checks if the microservice is alive, th\", \"at is, if it\\u2019s able to accept requests and respond.\\n\\n  - **Readiness** : Checks if the microservice\\u2019\", \"s dependencies (Database, queue services, etc.) are\\nthemselves ready, so the microservice can do wha\", \"t it\\u2019s supposed to do.\\n\\n\\n**Using diagnostics and logs event streams**\\n\\n\\nLogs provide information abo\", \"ut how an application or service is running, including exceptions,\\nwarnings, and simple informationa\", \"l messages. Usually, each log is in a text format with one line per\\nevent, although exceptions also \", \"often show the stack trace across multiple lines.\\n\\n\\nIn monolithic server-based applications, you can\", \" write logs to a file on disk (a logfile) and then analyze\\nit with any tool. Since application execu\", \"tion is limited to a fixed server or VM, it generally isn\\u2019t too\\ncomplex to analyze the flow of event\", \"s. However, in a distributed application where multiple services\\nare executed across many nodes in a\", \"n orchestrator cluster, being able to correlate distributed events\\nis a challenge.\\n\\n\\nA microservice-\", \"based application should not try to store the output stream of events or logfiles by\\nitself, and not\", \" even try to manage the routing of the events to a central place. It should be\\ntransparent, meaning \", \"that each process should just write its event stream to a standard output that\\nunderneath will be co\", \"llected by the execution environment infrastructure where it\\u2019s running. An\\n[example of these event s\", \"tream routers is Microsoft.Diagnostic.EventFlow, which collects event streams](https://github.com/Az\", \"ure/diagnostics-eventflow)\\nfrom multiple sources and publishes it to output systems. These can inclu\", \"de simple standard output\\n[for a development environment or cloud systems like Azure Monitor](https:\", \"//azure.microsoft.com/services/monitor/) [and Azure Diagnostics. There are](https://docs.microsoft.c\", \"om/azure/azure-monitor/platform/diagnostics-extension-overview)\\nalso good third-party log analysis p\", \"latforms and tools that can search, alert, report, and monitor logs,\\n[even in real time, like Splunk\", \".](https://www.splunk.com/goto/Splunk_Log_Management?ac=ga_usa_log_analysis_phrase_Mar17&_kk=logs%20\", \"analysis&gclid=CNzkzIrex9MCFYGHfgodW5YOtA)\\n\\n\\n64 CHAPTER 3 | Architecting container and microservice-\", \"based applications\\n\\n\\n**Orchestrators managing health and diagnostics information**\\n\\n\\nWhen you create\", \" a microservice-based application, you need to deal with complexity. Of course, a\\nsingle microservic\", \"e is simple to deal with, but dozens or hundreds of types and thousands of\\ninstances of microservice\", \"s is a complex problem. It isn\\u2019t just about building your microservice\\narchitecture\\u2014you also need hi\", \"gh availability, addressability, resiliency, health, and diagnostics if you\\nintend to have a stable \", \"and cohesive system.\\n\\n\\n_Figure 4-22. A Microservice Platform is fundamental for an application\\u2019s hea\", \"lth management_\\n\\n\\nThe complex problems shown in Figure 4-22 are hard to solve by yourself. Developme\", \"nt teams should\\nfocus on solving business problems and building custom applications with microservic\", \"e-based\\napproaches. They should not focus on solving complex infrastructure problems; if they did, t\", \"he cost of\\nany microservice-based application would be huge. Therefore, there are microservice-orien\", \"ted\\nplatforms, referred to as orchestrators or microservice clusters, that try to solve the hard pro\", \"blems of\\nbuilding and running a service and using infrastructure resources efficiently. This approac\", \"h reduces\\nthe complexities of building applications that use a microservices approach.\\n\\n\\nDifferent o\", \"rchestrators might sound similar, but the diagnostics and health checks offered by each of\\nthem diff\", \"er in features and state of maturity, sometimes depending on the OS platform, as explained\\nin the ne\", \"xt section.\\n\\n#### **Additional resources**\\n\\n\\n  - **The Twelve-Factor App. XI. Logs: Treat logs as ev\", \"ent streams**\\n[https://12factor.net/logs](https://12factor.net/logs)\\n\\n\\n  - **Microsoft Diagnostic Ev\", \"entFlow Library** GitHub repo.\\n[https://github.com/Azure/diagnostics-eventflow](https://github.com/A\", \"zure/diagnostics-eventflow)\\n\\n\\n  - **What is Azure Diagnostics**\\n[https://learn.microsoft.com/azure/a\", \"zure-diagnostics](https://docs.microsoft.com/azure/azure-diagnostics)\\n\\n\\n65 CHAPTER 3 | Architecting \", \"container and microservice-based applications\\n\\n\\n  - **Connect Windows computers to the Azure Monitor\", \" service**\\n[https://learn.microsoft.com/azure/azure-monitor/platform/agent-windows](https://docs.mic\", \"rosoft.com/azure/azure-monitor/platform/agent-windows)\\n\\n\\n  - **Logging What You Mean: Using the Sema\", \"ntic Logging Application Block**\\n[https://learn.microsoft.com/previous-versions/msp-n-p/dn440729(v=p\", \"andp.60)](https://docs.microsoft.com/previous-versions/msp-n-p/dn440729(v=pandp.60))\\n\\n\\n  - **Splunk*\", \"* Official site.\\n[https://www.splunk.com/](https://www.splunk.com/)\\n\\n\\n  - **EventSource Class** API \", \"for events tracing for Windows (ETW)\\n[https://learn.microsoft.com/dotnet/api/system.diagnostics.trac\", \"ing.eventsource](https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource)\\n\\n### \", \"Orchestrate microservices and multi-container applications for high scalability and availability\\n\\n\\nU\", \"sing orchestrators for production-ready applications is essential if your application is based on\\nmi\", \"croservices or simply split across multiple containers. As introduced previously, in a microserviceb\", \"ased approach, each microservice owns its model and data so that it will be autonomous from a\\ndevelo\", \"pment and deployment point of view. But even if you have a more traditional application that\\u2019s\\ncompo\", \"sed of multiple services (like SOA), you\\u2019ll also have multiple containers or services comprising a\\ns\", \"ingle business application that need to be deployed as a distributed system. These kinds of systems\\n\", \"are complex to scale out and manage; therefore, you absolutely need an orchestrator if you want to\\nh\", \"ave a production-ready and scalable multi-container application.\\n\\n\\nFigure 4-23 illustrates deploymen\", \"t into a cluster of an application composed of multiple microservices\\n(containers).\\n\\n\\n66 CHAPTER 3 |\", \" Architecting container and microservice-based applications\\n\\n\\n_Figure 4-23. A cluster of containers_\", \"\\n\\n\\nYou use one container for each service instance. Docker containers are \\u201cunits of deployment\\u201d and \", \"a\\ncontainer is an instance of a Docker. A host handles many containers. It looks like a logical appr\", \"oach.\\nBut how are you handling load-balancing, routing, and orchestrating these composed application\", \"s?\\n\\n\\nThe plain Docker Engine in single Docker hosts meets the needs of managing single image instanc\", \"es\\non one host, but it falls short when it comes to managing multiple containers deployed on multipl\", \"e\\nhosts for more complex distributed applications. In most cases, you need a management platform\\ntha\", \"t will automatically start containers, scale out containers with multiple instances per image,\\nsuspe\", \"nd them or shut them down when needed, and ideally also control how they access resources\\nlike the n\", \"etwork and data storage.\\n\\n\\nTo go beyond the management of individual containers or simple composed a\", \"pps and move toward\\nlarger enterprise applications with microservices, you must turn to orchestratio\", \"n and clustering\\nplatforms.\\n\\n\\nFrom an architecture and development point of view, if you\\u2019re building\", \" large enterprise composed of\\nmicroservices-based applications, it\\u2019s important to understand the fol\", \"lowing platforms and products\\nthat support advanced scenarios:\\n\\n\\n**Clusters and orchestrators.** Whe\", \"n you need to scale out applications across many Docker hosts, as\\nwhen a large microservice-based ap\", \"plication, it\\u2019s critical to be able to manage all those hosts as a\\nsingle cluster by abstracting the\", \" complexity of the underlying platform. That\\u2019s what the container\\nclusters and orchestrators provide\", \". Kubernetes is an example of an orchestrator, and is available in\\nAzure through Azure Kubernetes Se\", \"rvice.\\n\\n\\n**Schedulers.** _Scheduling_ means to have the capability for an administrator to launch co\", \"ntainers in a\\ncluster so they also provide a UI. A cluster scheduler has several responsibilities: t\", \"o use the cluster\\u2019s\\n\\n\\n67 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\nre\", \"sources efficiently, to set the constraints provided by the user, to efficiently load-balance contai\", \"ners\\nacross nodes or hosts, and to be robust against errors while providing high availability.\\n\\n\\nThe\", \" concepts of a cluster and a scheduler are closely related, so the products provided by different\\nve\", \"ndors often provide both sets of capabilities. The following list shows the most important platform\\n\", \"and software choices you have for clusters and schedulers. These orchestrators are generally offered\", \"\\nin public clouds like Azure.\\n\\n#### **Software platforms for container clustering, orchestration, an\", \"d**\\n\\n\\n\\n\\n\\n\\n|scheduling|Col2|\\n|---|---|\\n|**Platform**|**Description**|\\n|**Kubernetes** <br>|_Kubernete\", \"s_ is an open-source<br>product that provides functionality<br>that ranges from cluster<br>infrastru\", \"cture and container<br>scheduling to orchestrating<br>capabilities. It lets you automate<br>deployme\", \"nt, scaling, and<br>operations of application<br>containers across clusters of hosts.<br> <br>_Kuber\", \"netes_ provides a container-<br>centric infrastructure that groups<br>application containers into lo\", \"gical<br>units for easy management and<br>discovery.<br> <br>_Kubernetes_ is mature in Linux, less<b\", \"r>mature in Windows.|\\n|**Azure Kubernetes Service (AKS)** <br>|AKS is a managed Kubernetes<br>contai\", \"ner orchestration service in<br>Azure that simplifies Kubernetes<br>cluster\\u2019s management, deployment\", \",<br>and operations.|\\n|**Azure Container Apps** <br>|Azure Container Apps is a managed<br>serverless\", \" container service for<br>building and deploying modern<br>apps at scale.|\\n\\n\\n#### **Using container-\", \"based orchestrators in Microsoft Azure**\\n\\nSeveral cloud vendors offer Docker containers support plus\", \" Docker clusters and orchestration support,\\nincluding Microsoft Azure, Amazon EC2 Container Service,\", \" and Google Container Engine. Microsoft\\nAzure provides Docker cluster and orchestrator support throu\", \"gh Azure Kubernetes Service (AKS).\\n\\n\\n68 CHAPTER 3 | Architecting container and microservice-based ap\", \"plications\\n\\n\\n#### **Using Azure Kubernetes Service**\\n\\nA Kubernetes cluster pools multiple Docker hos\", \"ts and exposes them as a single virtual Docker host, so\\nyou can deploy multiple containers into the \", \"cluster and scale-out with any number of container\\ninstances. The cluster will handle all the comple\", \"x management plumbing, like scalability, health, and\\nso forth.\\n\\n\\nAKS provides a way to simplify the \", \"creation, configuration, and management of a cluster of virtual\\nmachines in Azure that are preconfig\", \"ured to run containerized applications. Using an optimized\\nconfiguration of popular open-source sche\", \"duling and orchestration tools, AKS enables you to use\\nyour existing skills or draw on a large and g\", \"rowing body of community expertise to deploy and\\nmanage container-based applications on Microsoft Az\", \"ure.\\n\\n\\nAzure Kubernetes Service optimizes the configuration of popular Docker clustering open-source\", \" tools\\nand technologies specifically for Azure. You get an open solution that offers portability for\", \" both your\\ncontainers and your application configuration. You select the size, the number of hosts, \", \"and the\\norchestrator tools, and AKS handles everything else.\\n\\n\\n_Figure 4-24. Kubernetes cluster\\u2019s si\", \"mplified structure and topology_\\n\\n\\n69 CHAPTER 3 | Architecting container and microservice-based appl\", \"ications\\n\\n\\nIn figure 4-24, you can see the structure of a Kubernetes cluster where a master node (VM\", \") controls\\nmost of the coordination of the cluster and you can deploy containers to the rest of the \", \"nodes, which\\nare managed as a single pool from an application point of view and allows you to scale \", \"to thousands\\nor even tens of thousands of containers.\\n\\n#### **Development environment for Kubernetes\", \"**\\n\\n\\nIn the development environment, Docker announced in July 2018 that Kubernetes can also run in a\", \"\\n[single development machine (Windows 10 or macOS) by installing Docker Desktop. You can later](http\", \"s://docs.docker.com/install/)\\ndeploy to the cloud (AKS) for further integration tests, as shown in f\", \"igure 4-25.\\n\\n\\n_Figure 4-25. Running Kubernetes in dev machine and the cloud_\\n\\n#### **Getting started\", \" with Azure Kubernetes Service (AKS)**\\n\\n\\nTo begin using AKS, you deploy an AKS cluster from the Azur\", \"e portal or by using the CLI. For more\\n[information on deploying a Kubernetes cluster in Azure, see \", \"Deploy an Azure Kubernetes Service](https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-port\", \"al)\\n[(AKS) cluster.](https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-portal)\\n\\n\\nThere are\", \" no fees for any of the software installed by default as part of AKS. All default options are\\nimplem\", \"ented with open-source software. AKS is available for multiple virtual machines in Azure.\\nYou\\u2019re cha\", \"rged only for the compute instances you choose, and the other underlying infrastructure\\nresources co\", \"nsumed, such as storage and networking. There are no incremental charges for AKS itself.\\n\\n\\nThe defau\", \"lt production deployment option for Kubernetes is to use Helm charts, which are introduced\\nin the ne\", \"xt section.\\n\\n\\n70 CHAPTER 3 | Architecting container and microservice-based applications\\n\\n\\n#### **Dep\", \"loy with Helm charts into Kubernetes clusters**\\n\\nWhen deploying an application to a Kubernetes clust\", \"er, you can use the original kubectl.exe CLI tool\\nusing deployment files based on the native format \", \"(.yaml files), as already mentioned in the previous\\nsection. However, for more complex Kubernetes ap\", \"plications such as when deploying complex\\n[microservice-based applications, it\\u2019s recommended to use \", \"Helm.](https://helm.sh/)\\n\\n\\nHelm Charts helps you define, version, install, share, upgrade, or rollba\", \"ck even the most complex\\nKubernetes application.\\n\\n\\nGoing further, Helm usage is also recommended bec\", \"ause other Kubernetes environments in Azure,\\n[such as Azure Dev Spaces are also based on Helm charts\", \".](https://docs.microsoft.com/azure/dev-spaces/azure-dev-spaces)\\n\\n\\n[Helm is maintained by the Cloud \", \"Native Computing Foundation (CNCF)](https://www.cncf.io/) - in collaboration with\\nMicrosoft, Google,\", \" Bitnami, and the Helm contributor community.\\n\\n\\n[For more implementation information on Helm charts \", \"and Kubernetes, see the Using Helm Charts to](https://github.com/dotnet-architecture/eShopOnContaine\", \"rs/wiki/Deploy-to-Azure-Kubernetes-Service-(AKS))\\n[deploy eShopOnContainers to AKS post.](https://gi\", \"thub.com/dotnet-architecture/eShopOnContainers/wiki/Deploy-to-Azure-Kubernetes-Service-(AKS))\\n\\n#### \", \"**Additional resources**\\n\\n\\n  - **Getting started with Azure Kubernetes Service (AKS)**\\n[https://lear\", \"n.microsoft.com/azure/aks/kubernetes-walkthrough-portal](https://docs.microsoft.com/azure/aks/kubern\", \"etes-walkthrough-portal)\\n\\n\\n  - **Azure Dev Spaces**\\n[https://learn.microsoft.com/azure/dev-spaces/az\", \"ure-dev-spaces](https://docs.microsoft.com/azure/dev-spaces/azure-dev-spaces)\\n\\n\\n  - **Kubernetes** T\", \"he official site.\\n[https://kubernetes.io/](https://kubernetes.io/)\\n\\n\\n71 CHAPTER 3 | Architecting con\", \"tainer and microservice-based applications\\n\\n\\n**CHAPTER**\\n# 4\\n\\n## Development process for Docker-base\", \"d applications\\n\\n\\n_Develop containerized .NET applications the way you like, either Integrated Develo\", \"pment Environment_\\n_(IDE) focused with Visual Studio and Visual Studio tools for Docker or CLI/Edito\", \"r focused with Docker CLI_\\n_and Visual Studio Code._\\n\\n### Development environment for Docker apps\\n\\n#\", \"### **Development tool choices: IDE or editor**\\n\\n\\nWhether you prefer a full and powerful IDE or a li\", \"ghtweight and agile editor, Microsoft has tools that\\nyou can use for developing Docker applications.\", \"\\n\\n\\n**Visual Studio (for Windows).** Docker-based .NET 7 application development with Visual Studio\\nr\", \"equires Visual Studio 2022 version 17.0 or later. Visual Studio 2022 comes with tools for Docker\\nalr\", \"eady built in. The tools for Docker let you develop, run, and validate your applications directly in\", \" the\\ntarget Docker environment. You can press F5 to run and debug your application (single container\", \" or\\nmultiple containers) directly into a Docker host, or press CTRL + F5 to edit and refresh your\\nap\", \"plication without having to rebuild the container. This IDE is the most powerful development choice\\n\", \"for Docker-based apps.\\n\\n\\n**Visual Studio for Mac.** It\\u2019s an IDE, evolution of Xamarin Studio, runnin\", \"g in macOS. This tool should\\nbe the preferred choice for developers working in macOS machines who al\", \"so want to use a powerful\\nIDE.\\n\\n\\n**Visual Studio Code and Docker CLI** . If you prefer a lightweight\", \" and cross-platform editor that\\nsupports any development language, you can use Visual Studio Code an\", \"d the Docker CLI. This IDE is a\\ncross-platform development approach for macOS, Linux, and Windows. A\", \"dditionally, Visual Studio\\nCode supports extensions for Docker such as IntelliSense for Dockerfiles \", \"and shortcut tasks to run\\nDocker commands from the editor.\\n\\n\\n[By installing Docker Desktop, you can \", \"use a single Docker CLI to build apps for both Windows and](https://hub.docker.com/search/?type=edit\", \"ion&offering=community)\\nLinux.\\n\\n\\n72 CHAPTER 4 | Development process for Docker-based applications\\n\\n\\n\", \"#### **Additional resources**\\n\\n\\n  - **Visual Studio** . Official site.\\n[https://visualstudio.microso\", \"ft.com/vs/](https://visualstudio.microsoft.com/vs/?utm_medium=microsoft&utm_source=learn.microsoft.c\", \"om&utm_campaign=inline+link)\\n\\n\\n  - **Visual Studio Code** . Official site.\\n[https://code.visualstudi\", \"o.com/download](https://code.visualstudio.com/download)\\n\\n\\n  - **Docker Desktop for Windows**\\n[https:\", \"//hub.docker.com/editions/community/docker-ce-desktop-windows](https://hub.docker.com/editions/commu\", \"nity/docker-ce-desktop-windows)\\n\\n\\n  - **Docker Desktop for Mac**\\n[https://hub.docker.com/editions/co\", \"mmunity/docker-ce-desktop-mac](https://hub.docker.com/editions/community/docker-ce-desktop-mac)\\n\\n###\", \" .NET languages and frameworks for Docker containers\\n\\n\\nAs mentioned in earlier sections of this guid\", \"e, you can use .NET Framework, .NET 7, or the opensource Mono project when developing Docker contain\", \"erized .NET applications. You can develop in\\nC#, F#, or Visual Basic when targeting Linux or Windows\", \" Containers, depending on which .NET\\n[framework is in use. For more details about.NET languages, see\", \" the blog post The .NET Language](https://devblogs.microsoft.com/dotnet/the-net-language-strategy/)\\n\", \"[Strategy.](https://devblogs.microsoft.com/dotnet/the-net-language-strategy/)\\n\\n### Development workf\", \"low for Docker apps\\n\\n\\nThe application development life cycle starts at your computer, as a developer\", \", where you code the\\napplication using your preferred language and test it locally. With this workfl\", \"ow, no matter which\\nlanguage, framework, and platform you choose, you\\u2019re always developing and testi\", \"ng Docker\\ncontainers, but doing so locally.\\n\\n\\nEach container (an instance of a Docker image) include\", \"s the following components:\\n\\n\\n  - An operating system selection, for example, a Linux distribution, \", \"Windows Nano Server, or\\nWindows Server Core.\\n\\n\\n  - Files added during development, for example, sour\", \"ce code and application binaries.\\n\\n\\n  - Configuration information, such as environment settings and \", \"dependencies.\\n\\n#### **Workflow for developing Docker container-based applications**\\n\\n\\nThis section d\", \"escribes the _inner-loop_ development workflow for Docker container-based applications.\\nThe inner-lo\", \"op workflow means it\\u2019s not considering the broader DevOps workflow, which can include\\nup to producti\", \"on deployment, and just focuses on the development work done on the developer\\u2019s\\ncomputer. The initia\", \"l steps to set up the environment aren\\u2019t included, since those steps are done only\\nonce.\\n\\n\\n73 CHAPTE\", \"R 4 | Development process for Docker-based applications\\n\\n\\nAn application is composed of your own ser\", \"vices plus additional libraries (dependencies). The\\nfollowing are the basic steps you usually take w\", \"hen building a Docker application, as illustrated in\\nFigure 5-1.\\n\\n\\n_Figure 5-1. Step-by-step workflo\", \"w for developing Docker containerized apps_\\n\\n\\nIn this section, this whole process is detailed and ev\", \"ery major step is explained by focusing on a Visual\\nStudio environment.\\n\\n\\nWhen you\\u2019re using an edito\", \"r/CLI development approach (for example, Visual Studio Code plus Docker\\nCLI on macOS or Windows), yo\", \"u need to know every step, generally in more detail than if you\\u2019re using\\nVisual Studio. For more inf\", \"ormation about working in a CLI environment, see the e-book\\n[Containerized Docker Application lifecy\", \"cle with Microsoft Platforms and Tools.](https://aka.ms/dockerlifecycleebook/)\\n\\n\\nWhen you\\u2019re using V\", \"isual Studio 2022, many of those steps are handled for you, which dramatically\\nimproves your product\", \"ivity. This is especially true when you\\u2019re using Visual Studio 2022 and targeting\\nmulti-container ap\", \"plications. For instance, with just one mouse click, Visual Studio adds the Dockerfile\\nand docker-co\", \"mpose.yml file to your projects with the configuration for your application. When you\\nrun the applic\", \"ation in Visual Studio, it builds the Docker image and runs the multi-container\\napplication directly\", \" in Docker; it even allows you to debug several containers at once. These features\\nwill boost your d\", \"evelopment speed.\\n\\n\\nHowever, just because Visual Studio makes those steps automatic doesn\\u2019t mean tha\", \"t you don\\u2019t need\\nto know what\\u2019s going on underneath with Docker. Therefore, the following guidance d\", \"etails every\\nstep.\\n\\n\\n74 CHAPTER 4 | Development process for Docker-based applications\\n\\n\\n#### **Step \", \"1. Start coding and create your initial application or service** **baseline**\\n\\nDeveloping a Docker a\", \"pplication is similar to the way you develop an application without Docker. The\\ndifference is that w\", \"hile developing for Docker, you\\u2019re deploying and testing your application or\\nservices running within\", \" Docker containers in your local environment (either a Linux VM setup by\\nDocker or directly Windows \", \"if using Windows Containers).\\n\\n\\n**Set up your local environment with Visual Studio**\\n\\n\\n[To begin, ma\", \"ke sure you have Docker Desktop for Windows for Windows installed, as explained in the](https://docs\", \".docker.com/docker-for-windows/)\\nfollowing instructions:\\n\\n\\n[Get started with Docker Desktop for Wind\", \"ows](https://docs.docker.com/docker-for-windows/)\\n\\n\\nIn addition, you need Visual Studio 2022 version\", \" 17.0, with the **.ASP.NET and web development**\\nworkload installed, as shown in Figure 5-2.\\n\\n\\n_Figu\", \"re 5-2. Selecting the ASP.NET and web development workload during Visual Studio 2022 setup_\\n\\n\\nYou ca\", \"n start coding your application in plain .NET (usually in .NET Core or later if you\\u2019re planning to\\nu\", \"se containers) even before enabling Docker in your application and deploying and testing in Docker.\\n\", \"However, it is recommended that you start working on Docker as soon as possible, because that will\\nb\", \"e the real environment and any issues can be discovered as soon as possible. This is encouraged\\n\\n\\n75\", \" CHAPTER 4 | Development process for Docker-based applications\\n\\n\\nbecause Visual Studio makes it so e\", \"asy to work with Docker that it almost feels transparent\\u2014the best\\nexample when debugging multi-conta\", \"iner applications from Visual Studio.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Get started with Docker Des\", \"ktop for Windows**\\n[https://docs.docker.com/docker-for-windows/](https://docs.docker.com/docker-for-\", \"windows/)\\n\\n\\n  - **Visual Studio 2022**\\n[https://visualstudio.microsoft.com/downloads/](https://visua\", \"lstudio.microsoft.com/downloads/)\\n\\n#### **Step 2. Create a Dockerfile related to an existing .NET ba\", \"se image**\\n\\n\\nYou need a Dockerfile for each custom image you want to build; you also need a Dockerfi\", \"le for each\\ncontainer to be deployed, whether you deploy automatically from Visual Studio or manuall\", \"y using the\\nDocker CLI (docker run and docker-compose commands). If your application contains a sing\", \"le custom\\nservice, you need a single Dockerfile. If your application contains multiple services (as \", \"in a\\nmicroservices architecture), you need one Dockerfile for each service.\\n\\n\\nThe Dockerfile is plac\", \"ed in the root folder of your application or service. It contains the commands\\nthat tell Docker how \", \"to set up and run your application or service in a container. You can manually\\ncreate a Dockerfile i\", \"n code and add it to your project along with your .NET dependencies.\\n\\n\\nWith Visual Studio and its to\", \"ols for Docker, this task requires only a few mouse clicks. When you\\ncreate a new project in Visual \", \"Studio 2022, there\\u2019s an option named **Enable Docker Support**, as\\nshown in Figure 5-3.\\n\\n\\n76 CHAPTER\", \" 4 | Development process for Docker-based applications\\n\\n\\n_Figure 5-3. Enabling Docker Support when c\", \"reating a new ASP.NET Core project in Visual Studio 2022_\\n\\n\\nYou can also enable Docker support on an\", \" existing ASP.NET Core web app project by right-clicking\\nthe project in **Solution Explorer** and se\", \"lecting **Add** - **Docker Support\\u2026**, as shown in Figure 5-4.\\n\\n\\n_Figure 5-4. Enabling Docker suppor\", \"t in an existing Visual Studio 2022 project_\\n\\n\\n77 CHAPTER 4 | Development process for Docker-based a\", \"pplications\\n\\n\\nThis action adds a _Dockerfile_ to the project with the required configuration, and is\", \" only available on\\nASP.NET Core projects.\\n\\n\\nIn a similar fashion, Visual Studio can also add a docke\", \"r-compose.yml file for the whole solution with\\nthe option **Add > Container Orchestrator Support\\u2026** \", \". In step 4, we\\u2019ll explore this option in greater\\ndetail.\\n\\n\\n**Using an existing official .NET Docker\", \" image**\\n\\n\\nYou usually build a custom image for your container on top of a base image you get from a\", \"n official\\n[repository like the Docker Hub registry. That is precisely what happens under the covers\", \" when you](https://hub.docker.com/)\\nenable Docker support in Visual Studio. Your Dockerfile will use\", \" an existing dotnet/core/aspnet image.\\n\\n\\nEarlier we explained which Docker images and repos you can \", \"use, depending on the framework and\\nOS you have chosen. For instance, if you want to use ASP.NET Cor\", \"e (Linux or Windows), the image to\\nuse is mcr.microsoft.com/dotnet/aspnet:7.0. Therefore, you just n\", \"eed to specify what base Docker\\nimage you will use for your container. You do that by adding FROM\\nmc\", \"r.microsoft.com/dotnet/aspnet:7.0 to your Dockerfile. This will be automatically performed by\\nVisual\", \" Studio, but if you were to update the version, you update this value.\\n\\n\\nUsing an official .NET imag\", \"e repository from Docker Hub with a version number ensures that the same\\nlanguage features are avail\", \"able on all machines (including development, testing, and production).\\n\\n\\nThe following example shows\", \" a sample Dockerfile for an ASP.NET Core container.\\n\\n\\nIn this case, the image is based on version 7.\", \"0 of the official ASP.NET Core Docker image (multi-arch\\nfor Linux and Windows). This is the setting \", \"FROM mcr.microsoft.com/dotnet/aspnet:7.0. (For more\\n[information about this base image, see the ASP.\", \"NET Core Docker Image](https://hub.docker.com/_/microsoft-dotnet-aspnet/) page.) In the Dockerfile, \", \"you\\nalso need to instruct Docker to listen on the TCP port you will use at runtime (in this case, po\", \"rt 80, as\\nconfigured with the EXPOSE setting).\\n\\n\\nYou can specify additional configuration settings i\", \"n the Dockerfile, depending on the language and\\nframework you\\u2019re using. For instance, the ENTRYPOINT\", \" line with [\\\"dotnet\\\",\\n\\\"MySingleContainerWebApp.dll\\\"] tells Docker to run a .NET application. If you\\u2019\", \"re using the SDK and\\nthe .NET CLI (dotnet CLI) to build and run the .NET application, this setting w\", \"ould be different. The\\nbottom line is that the ENTRYPOINT line and other settings will be different \", \"depending on the\\nlanguage and platform you choose for your application.\\n\\n\\n**Additional resources**\\n\\n\", \"\\n  - **Building Docker Images for ASP.NET Core Applications**\\n[https://learn.microsoft.com/dotnet/co\", \"re/docker/building-net-docker-images](https://docs.microsoft.com/aspnet/core/host-and-deploy/docker/\", \"building-net-docker-images)\\n\\n\\n78 CHAPTER 4 | Development process for Docker-based applications\\n\\n\\n  -\", \" **Build your own image** . In the official Docker documentation.\\n[https://docs.docker.com/engine/tu\", \"torials/dockerimages/](https://docs.docker.com/engine/tutorials/dockerimages/)\\n\\n\\n  - **Staying up-to\", \"-date with .NET Container Images**\\n[https://devblogs.microsoft.com/dotnet/staying-up-to-date-with-ne\", \"t-container-images/](https://devblogs.microsoft.com/dotnet/staying-up-to-date-with-net-container-ima\", \"ges/)\\n\\n\\n  - **Using .NET and Docker Together - DockerCon 2018 Update**\\n[https://devblogs.microsoft.c\", \"om/dotnet/using-net-and-docker-together-dockercon-2018-](https://devblogs.microsoft.com/dotnet/using\", \"-net-and-docker-together-dockercon-2018-update/)\\nupdate/\\n\\n\\n**Using multi-arch image repositories**\\n\\n\", \"\\nA single repo can contain platform variants, such as a Linux image and a Windows image. This featur\", \"e\\nallows vendors like Microsoft (base image creators) to create a single repo to cover multiple plat\", \"forms\\n[(that is Linux and Windows). For example, the .NET](https://hub.docker.com/_/microsoft-dotnet\", \"/) repository available in the Docker Hub registry\\nprovides support for Linux and Windows Nano Serve\", \"r by using the same repo name.\\n\\n\\nIf you specify a tag, targeting a platform that is explicit like in\", \" the following cases:\\n\\n\\n  - mcr.microsoft.com/dotnet/aspnet:7.0-bullseye-slim\\nTargets: .NET 7 runtim\", \"e-only on Linux\\n\\n\\n  - mcr.microsoft.com/dotnet/aspnet:7.0-nanoserver-ltsc2022\\nTargets: .NET 7 runtim\", \"e-only on Windows Nano Server\\n\\n\\nBut, if you specify the same image name, even with the same tag, the\", \" multi-arch images (like the\\naspnet image) will use the Linux or Windows version depending on the Do\", \"cker host OS you\\u2019re\\ndeploying, as shown in the following example:\\n\\n\\n  - mcr.microsoft.com/dotnet/asp\", \"net:7.0\\nMulti-arch: .NET 7 runtime-only on Linux or Windows Nano Server depending on the Docker\\nhost\", \" OS\\n\\n\\nThis way, when you pull an image from a Windows host, it will pull the Windows variant, and pu\", \"lling\\nthe same image name from a Linux host will pull the Linux variant.\\n\\n\\n**Multi-stage builds in D\", \"ockerfile**\\n\\n\\nThe Dockerfile is similar to a batch script. Similar to what you would do if you had t\", \"o set up the\\nmachine from the command line.\\n\\n\\nIt starts with a base image that sets up the initial c\", \"ontext, it\\u2019s like the startup filesystem, that sits on\\ntop of the host OS. It\\u2019s not an OS, but you c\", \"an think of it like \\u201cthe\\u201d OS inside the container.\\n\\n\\nThe execution of every command line creates a n\", \"ew layer on the filesystem with the changes from the\\nprevious one, so that, when combined, produce t\", \"he resulting filesystem.\\n\\n\\nSince every new layer \\u201crests\\u201d on top of the previous one and the resultin\", \"g image size increases with\\nevery command, images can get very large if they have to include, for ex\", \"ample, the SDK needed to\\nbuild and publish an application.\\n\\n\\nThis is where multi-stage builds get in\", \"to the plot (from Docker 17.05 and higher) to do their magic.\\n\\n\\n79 CHAPTER 4 | Development process f\", \"or Docker-based applications\\n\\n\\nThe core idea is that you can separate the Dockerfile execution proce\", \"ss in stages, where a stage is an\\ninitial image followed by one or more commands, and the last stage\", \" determines the final image size.\\n\\n\\nIn short, multi-stage builds allow splitting the creation in dif\", \"ferent \\u201cphases\\u201d and then assemble the\\nfinal image taking only the relevant directories from the inte\", \"rmediate stages. The general strategy to\\nuse this feature is:\\n\\n\\n1. Use a base SDK image (doesn\\u2019t mat\", \"ter how large), with everything needed to build and\\npublish the application to a folder and then\\n\\n\\n2\", \". Use a base, small, runtime-only image and copy the publishing folder from the previous stage\\nto pr\", \"oduce a small final image.\\n\\n\\nProbably the best way to understand multi-stage is going through a Dock\", \"erfile in detail, line by line,\\nso let\\u2019s begin with the initial Dockerfile created by Visual Studio \", \"when adding Docker support to a\\nproject and will get into some optimizations later.\\n\\n\\nThe initial Do\", \"ckerfile might look something like this:\\n\\n\\nAnd these are the details, line by line:\\n\\n\\n  - **Line #1:\", \"** Begin a stage with a \\u201csmall\\u201d runtime-only base image, call it **base** for reference.\\n\\n\\n  - **Lin\", \"e #2:** Create the **/app** directory in the image.\\n\\n\\n  - **Line #3:** Expose port **80** .\\n\\n\\n80 CHA\", \"PTER 4 | Development process for Docker-based applications\\n\\n\\n  - **Line #5:** Begin a new stage with\", \" the \\u201clarge\\u201d image for building/publishing. Call it **build** for\\nreference.\\n\\n\\n  - **Line #6:** Crea\", \"te directory **/src** in the image.\\n\\n\\n  - **Line #7:** Up to line 16, copy referenced **.csproj** pr\", \"oject files to be able to restore packages\\nlater.\\n\\n\\n  - **Line #17:** Restore packages for the **Cat\", \"alog.API** project and the referenced projects.\\n\\n\\n  - **Line #18:** Copy **all directory tree for th\", \"e solution** (except the files/directories included in the\\n**.dockerignore** file) to the **/src** d\", \"irectory in the image.\\n\\n\\n  - **Line #19:** Change the current folder to the **Catalog.API** project.\", \"\\n\\n\\n  - **Line #20:** Build the project (and other project dependencies) and output to the **/app**\\nd\", \"irectory in the image.\\n\\n\\n  - **Line #22:** Begin a new stage continuing from the build. Call it **pu\", \"blish** for reference.\\n\\n\\n  - **Line #23:** Publish the project (and dependencies) and output to the \", \"**/app** directory in the\\nimage.\\n\\n\\n  - **Line #25:** Begin a new stage continuing from **base** and \", \"call it **final** .\\n\\n\\n  - **Line #26:** Change the current directory to **/app** .\\n\\n\\n  - **Line #27:\", \"** Copy the **/app** directory from stage **publish** to the current directory.\\n\\n\\n  - **Line #28:** \", \"Define the command to run when the container is started.\\n\\n\\nNow let\\u2019s explore some optimizations to i\", \"mprove the whole process performance that, in the case of\\neShopOnContainers, means about 22 minutes \", \"or more to build the complete solution in Linux\\ncontainers.\\n\\n\\nYou\\u2019ll take advantage of Docker\\u2019s laye\", \"r cache feature, which is quite simple: if the base image and the\\ncommands are the same as some prev\", \"iously executed, it can just use the resulting layer without the\\nneed to execute the commands, thus \", \"saving some time.\\n\\n\\nSo, let\\u2019s focus on the **build** stage, lines 5-6 are mostly the same, but lines\", \" 7-17 are different for every\\nservice from eShopOnContainers, so they have to execute every single t\", \"ime, however if you changed\\nlines 7-16 to:\\n\\n```\\nCOPY . .\\n\\n```\\n\\nThen it would be just the same for ev\", \"ery service, it would copy the whole solution and would create a\\nlarger layer but:\\n\\n\\n1. The copy pro\", \"cess would only be executed the first time (and when rebuilding if a file is\\nchanged) and would use \", \"the cache for all other services and\\n\\n\\n2. Since the larger image occurs in an intermediate stage, it\", \" doesn\\u2019t affect the final image size.\\n\\n\\n81 CHAPTER 4 | Development process for Docker-based applicat\", \"ions\\n\\n\\nThe next significant optimization involves the restore command executed in line 17, which is \", \"also\\ndifferent for every service of eShopOnContainers. If you change that line to just:\\n\\n```\\nRUN dot\", \"net restore\\n\\n```\\n\\nIt would restore the packages for the whole solution, but then again, it would do \", \"it just once, instead\\nof the 15 times with the current strategy.\\n\\n\\nHowever, dotnet restore only runs\", \" if there\\u2019s a single project or solution file in the folder, so achieving\\nthis is a bit more complic\", \"ated and the way to solve it, without getting into too many details, is this:\\n\\n\\n1. Add the following\", \" lines to **.dockerignore** :\\n\\n\\n     - *.sln, to ignore all solution files in the main folder tree\\n\\n\", \"\\n     - !eShopOnContainers-ServicesAndWebApps.sln, to include only this solution file.\\n\\n\\n2. Include \", \"the /ignoreprojectextensions:.dcproj argument to dotnet restore, so it also ignores the\\ndocker-compo\", \"se project and only restores the packages for the eShopOnContainersServicesAndWebApps solution.\\n\\n\\nFo\", \"r the final optimization, it just happens that line 20 is redundant, as line 23 also builds the\\nappl\", \"ication and comes, in essence, right after line 20, so there goes another time-consuming\\ncommand.\\n\\n\\n\", \"The resulting file is then:\\n\\n\\n**Creating your base image from scratch**\\n\\n\\nYou can create your own Do\", \"cker base image from scratch. This scenario is not recommended for\\nsomeone who is starting with Dock\", \"er, but if you want to set the specific bits of your own base image,\\nyou can do so.\\n\\n\\n**Additional r\", \"esources**\\n\\n\\n  - **Multi-arch .NET Core images** .\\n[https://github.com/dotnet/announcements/issues/1\", \"4](https://github.com/dotnet/announcements/issues/14)\\n\\n\\n82 CHAPTER 4 | Development process for Docke\", \"r-based applications\\n\\n\\n  - **Create a base image** . Official Docker documentation.\\n[https://docs.do\", \"cker.com/develop/develop-images/baseimages/](https://docs.docker.com/develop/develop-images/baseimag\", \"es/)\\n\\n#### **Step 3. Create your custom Docker images and embed your** **application or service in t\", \"hem**\\n\\n\\nFor each service in your application, you need to create a related image. If your applicatio\", \"n is made up\\nof a single service or web application, you just need a single image.\\n\\n\\nNote that the D\", \"ocker images are built automatically for you in Visual Studio. The following steps are\\nonly needed f\", \"or the editor/CLI workflow and explained for clarity about what happens underneath.\\n\\n\\nYou, as a deve\", \"loper, need to develop and test locally until you push a completed feature or change to\\nyour source \", \"control system (for example, to GitHub). This means that you need to create the Docker\\nimages and de\", \"ploy containers to a local Docker host (Windows or Linux VM) and run, test, and debug\\nagainst those \", \"local containers.\\n\\n\\nTo create a custom image in your local environment by using Docker CLI and your \", \"Dockerfile, you can\\nuse the docker build command, as in Figure 5-5.\\n\\n\\n_Figure 5-5. Creating a custom\", \" Docker image_\\n\\n\\nOptionally, instead of directly running docker build from the project folder, you c\", \"an first generate a\\ndeployable folder with the required .NET libraries and binaries by running dotne\", \"t publish, and then\\nuse the docker build command.\\n\\n\\nThis will create a Docker image with the name ce\", \"sardl/netcore-webapi-microservice-docker:first. In\\nthis case, :first is a tag that represents a spec\", \"ific version. You can repeat this step for each custom\\nimage you need to create for your composed Do\", \"cker application.\\n\\n\\nWhen an application is made of multiple containers (that is, it is a multi-conta\", \"iner application), you\\ncan also use the docker-compose up --build command to build all the related i\", \"mages with a single\\ncommand by using the metadata exposed in the related docker-compose.yml files.\\n\\n\", \"\\nYou can find the existing images in your local repository by using the docker images command, as\\nsh\", \"own in Figure 5-6.\\n\\n\\n83 CHAPTER 4 | Development process for Docker-based applications\\n\\n\\n_Figure 5-6.\", \" Viewing existing images using the docker images command_\\n\\n\\n**Creating Docker images with Visual Stu\", \"dio**\\n\\n\\nWhen you use Visual Studio to create a project with Docker support, you don\\u2019t explicitly cre\", \"ate an\\nimage. Instead, the image is created for you when you press F5 (or Ctrl+F5) to run the docker\", \"ized\\napplication or service. This step is automatic in Visual Studio and you won\\u2019t see it happen, bu\", \"t it\\u2019s\\nimportant that you know what\\u2019s going on underneath.\\n\\n#### **Step 4. Define your services in d\", \"ocker-compose.yml when building a** **multi-container Docker application**\\n\\n\\n[The docker-compose.yml\", \" file lets you define a set of related services to be deployed as a composed](https://docs.docker.co\", \"m/compose/compose-file/)\\napplication with deployment commands. It also configures its dependency rel\", \"ations and runtime\\nconfiguration.\\n\\n\\nTo use a docker-compose.yml file, you need to create the file in\", \" your main or root solution folder, with\\ncontent similar to that in the following example:\\n\\n\\n84 CHAP\", \"TER 4 | Development process for Docker-based applications\\n\\n\\nThis docker-compose.yml file is a simpli\", \"fied and merged version. It contains static configuration data\\nfor each container (like the name of \", \"the custom image), which is always required, and configuration\\ninformation that might depend on the \", \"deployment environment, like the connection string. In later\\nsections, you will learn how to split t\", \"he docker-compose.yml configuration into multiple dockercompose files and override values depending \", \"on the environment and execution type (debug or\\nrelease).\\n\\n\\nThe docker-compose.yml file example defi\", \"nes four services: the webmvc service (a web application),\\ntwo microservices (ordering-api and baske\", \"t-api), and one data source container, sqldata, based on\\nSQL Server for Linux running as a container\", \". Each service will be deployed as a container, so a Docker\\nimage is required for each.\\n\\n\\nThe docker\", \"-compose.yml file specifies not only what containers are being used, but how they are\\nindividually c\", \"onfigured. For instance, the webmvc container definition in the .yml file:\\n\\n\\n  - Uses a pre-built es\", \"hop/web:latest image. However, you could also configure the image to be\\nbuilt as part of the docker-\", \"compose execution with an additional configuration based on a\\nbuild: section in the docker-compose f\", \"ile.\\n\\n\\n  - Initializes two environment variables (CatalogUrl and OrderingUrl).\\n\\n\\n  - Forwards the ex\", \"posed port 80 on the container to the external port 80 on the host machine.\\n\\n\\n  - Links the web app \", \"to the catalog and ordering service with the depends_on setting. This\\ncauses the service to wait unt\", \"il those services are started.\\n\\n\\nWe will revisit the docker-compose.yml file in a later section when\", \" we cover how to implement\\nmicroservices and multi-container apps.\\n\\n\\n**Working with docker-compose.y\", \"ml in Visual Studio 2022**\\n\\n\\nBesides adding a Dockerfile to a project, as we mentioned before, Visua\", \"l Studio 2017 (from version\\n15.8 on) can add orchestrator support for Docker Compose to a solution.\\n\", \"\\n\\nWhen you add container orchestrator support, as shown in Figure 5-7, for the first time, Visual St\", \"udio\\ncreates the Dockerfile for the project and creates a new (service section) project in your solu\", \"tion with\\n\\n\\n85 CHAPTER 4 | Development process for Docker-based applications\\n\\n\\nseveral global docker\", \"-compose*.yml files, and then adds the project to those files. You can then open\\nthe docker-compose.\", \"yml files and update them with additional features.\\n\\n\\nRepeat this operation for every project you wa\", \"nt to include in the docker-compose.yml file.\\n\\n\\nAt the time of this writing, Visual Studio supports \", \"**Docker Compose** orchestrators.\\n\\n\\n_Figure 5-7. Adding Docker support in Visual Studio 2022 by righ\", \"t-clicking an ASP.NET Core project_\\n\\n\\nAfter you add orchestrator support to your solution in Visual \", \"Studio, you will also see a new node (in\\nthe docker-compose.dcproj project file) in Solution Explore\", \"r that contains the added dockercompose.yml files, as shown in Figure 5-8.\\n\\n\\n_Figure 5-8. The docker\", \"-compose tree node added in Visual Studio 2022 Solution Explorer_\\n\\n\\nYou could deploy a multi-contain\", \"er application with a single docker-compose.yml file by using the\\ndocker-compose up command. However\", \", Visual Studio adds a group of them so you can override\\nvalues depending on the environment (develo\", \"pment or production) and execution type (release or\\ndebug). This capability will be explained in lat\", \"er sections.\\n\\n\\n86 CHAPTER 4 | Development process for Docker-based applications\\n\\n\\n#### **Step 5. Bui\", \"ld and run your Docker application**\\n\\nIf your application only has a single container, you can run i\", \"t by deploying it to your Docker host (VM\\nor physical server). However, if your application contains\", \" multiple services, you can deploy it as a\\ncomposed application, either using a single CLI command (\", \"docker-compose up), or with Visual Studio,\\nwhich will use that command under the covers. Let\\u2019s look \", \"at the different options.\\n\\n\\n**Option A: Running a single-container application**\\n\\n\\n**Using Docker CL\", \"I**\\n\\n\\nYou can run a Docker container using the docker run command, as shown in Figure 5-9:\\n\\n```\\ndock\", \"er run -t -d -p 80:5000 cesardl/netcore-webapi-microservice-docker:first\\n\\n```\\n\\nThe above command wil\", \"l create a new container instance from the specified image, every time it\\u2019s run.\\nYou can use the --n\", \"ame parameter to give a name to the container and then use docker start {name}\\n(or use the container\", \" ID or automatic name) to run an existing container instance.\\n\\n\\n_Figure 5-9. Running a Docker contai\", \"ner using the docker run command_\\n\\n\\nIn this case, the command binds the internal port 5000 of the co\", \"ntainer to port 80 of the host\\nmachine. This means that the host is listening on port 80 and forward\", \"ing to port 5000 on the\\ncontainer.\\n\\n\\nThe hash shown is the container ID and it\\u2019s also assigned a ran\", \"dom readable name if the --name\\noption is not used.\\n\\n\\n**Using Visual Studio**\\n\\n\\nIf you haven\\u2019t added\", \" container orchestrator support, you can also run a single container app in Visual\\nStudio by pressin\", \"g Ctrl+F5 and you can also use F5 to debug the application within the container. The\\ncontainer runs \", \"locally using docker run.\\n\\n\\n**Option B: Running a multi-container application**\\n\\n\\nIn most enterprise\", \" scenarios, a Docker application will be composed of multiple services, which means\\nyou need to run \", \"a multi-container application, as shown in Figure 5-10.\\n\\n\\n87 CHAPTER 4 | Development process for Doc\", \"ker-based applications\\n\\n\\n_Figure 5-10. VM with Docker containers deployed_\\n\\n\\n**Using Docker CLI**\\n\\n\\n\", \"To run a multi-container application with the Docker CLI, you use the docker-compose up command.\\nThi\", \"s command uses the **docker-compose.yml** file that you have at the solution level to deploy a\\nmulti\", \"-container application. Figure 5-11 shows the results when running the command from your\\nmain soluti\", \"on directory, which contains the docker-compose.yml file.\\n\\n\\n_Figure 5-11. Example results when runni\", \"ng the docker-compose up command_\\n\\n\\nAfter the docker-compose up command runs, the application and it\", \"s related containers are deployed\\ninto your Docker host, as depicted in Figure 5-10.\\n\\n\\n**Using Visua\", \"l Studio**\\n\\nRunning a multi-container application using Visual Studio 2019 can\\u2019t get any simpler. Yo\", \"u just press\\nCtrl+F5 to run or F5 to debug, as usual, setting up the **docker-compose** project as t\", \"he startup project.\\nVisual Studio handles all needed setup, so you can create breakpoints as usual a\", \"nd debug what finally\\nbecome independent processes running in \\u201cremote servers\\u201d, with the debugger al\", \"ready attached, just\\nlike that.\\n\\n\\nAs mentioned before, each time you add Docker solution support to \", \"a project within a solution, that\\nproject is configured in the global (solution-level) docker-compos\", \"e.yml file, which lets you run or\\ndebug the whole solution at once. Visual Studio will start one con\", \"tainer for each project that has\\nDocker solution support enabled, and perform all the internal steps\", \" for you (dotnet publish, docker\\nbuild, etc.).\\n\\n\\nIf you want to take a peek at all the drudgery, tak\", \"e a look at the file:\\n\\n\\n{root solution folder}\\\\obj\\\\Docker\\\\docker-compose.vs.debug.g.yml\\n\\n\\n88 CHAPTER\", \" 4 | Development process for Docker-based applications\\n\\n\\nThe important point here is that, as shown \", \"in Figure 5-12, in Visual Studio 2019 there is an additional\\n**Docker** command for the F5 key actio\", \"n. This option lets you run or debug a multi-container\\napplication by running all the containers tha\", \"t are defined in the docker-compose.yml files at the\\nsolution level. The ability to debug multiple-c\", \"ontainer solutions means that you can set several\\nbreakpoints, each breakpoint in a different projec\", \"t (container), and while debugging from Visual\\nStudio you will stop at breakpoints defined in differ\", \"ent projects and running on different containers.\\n\\n\\n_Figure 5-12. Running multi-container apps in Vi\", \"sual Studio 2022_\\n\\n\\n**Additional resources**\\n\\n\\n  - **Deploy an ASP.NET container to a remote Docker \", \"host**\\n[https://learn.microsoft.com/visualstudio/containers/hosting-web-apps-in-docker](https://docs\", \".microsoft.com/visualstudio/containers/hosting-web-apps-in-docker)\\n\\n\\n**A note about testing and depl\", \"oying with orchestrators**\\n\\n\\nThe docker-compose up and docker run commands (or running and debugging\", \" the containers in\\nVisual Studio) are adequate for testing containers in your development environmen\", \"t. But you should\\nnot use this approach for production deployments, where you should target orchestr\", \"ators like\\n[Kubernetes](https://kubernetes.io/) [or Service Fabric. If you\\u2019re using Kubernetes, you \", \"have to use pods](https://azure.microsoft.com/services/service-fabric/) to organize containers\\n[and \", \"services](https://kubernetes.io/docs/concepts/services-networking/service/) [to network them. You al\", \"so use deployments](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/) to organi\", \"ze pod creation and modification.\\n\\n#### **Step 6. Test your Docker application using your local Dock\", \"er host**\\n\\n\\nThis step will vary depending on what your application is doing. In a simple .NET Web ap\", \"plication that\\nis deployed as a single container or service, you can access the service by opening a\", \" browser on the\\nDocker host and navigating to that site, as shown in Figure 5-13. (If the configurat\", \"ion in the Dockerfile\\nmaps the container to a port on the host that is anything other than 80, inclu\", \"de the host port in the\\nURL.)\\n\\n\\n_Figure 5-13. Example of testing your Docker application locally usi\", \"ng localhost_\\n\\n\\n89 CHAPTER 4 | Development process for Docker-based applications\\n\\n\\nIf localhost is n\", \"ot pointing to the Docker host IP (by default, when using Docker CE, it should), to\\nnavigate to your\", \" service, use the IP address of your machine\\u2019s network card.\\n\\n\\nThis URL in the browser uses port 80 \", \"for the particular container example being discussed. However,\\ninternally the requests are being red\", \"irected to port 5000, because that was how it was deployed with\\nthe docker run command, as explained\", \" in a previous step.\\n\\n\\nYou can also test the application using curl from the terminal, as shown in F\", \"igure 5-14. In a Docker\\ninstallation on Windows, the default Docker Host IP is always 10.0.75.1 in a\", \"ddition to your machine\\u2019s\\nactual IP address.\\n\\n\\n_Figure 5-14. Example of testing your Docker applicat\", \"ion locally using curl_\\n\\n\\n**Testing and debugging containers with Visual Studio 2022**\\n\\n\\nWhen runnin\", \"g and debugging the containers with Visual Studio 2022, you can debug the .NET\\napplication in much t\", \"he same way as you would when running without containers.\\n\\n\\n**Testing and debugging without Visual S\", \"tudio**\\n\\n\\nIf you\\u2019re developing using the editor/CLI approach, debugging containers is more difficult\", \" and you\\u2019ll\\nprobably want to debug by generating traces.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Quicksta\", \"rt: Docker in Visual Studio.**\\n[https://learn.microsoft.com/visualstudio/containers/container-tools]\", \"(https://docs.microsoft.com/visualstudio/containers/container-tools)\\n\\n\\n  - **Debugging apps in a loc\", \"al Docker container**\\n[https://learn.microsoft.com/visualstudio/containers/edit-and-refresh](https:/\", \"/docs.microsoft.com/visualstudio/containers/edit-and-refresh)\\n\\n#### **Simplified workflow when devel\", \"oping containers with Visual Studio**\\n\\n\\nEffectively, the workflow when using Visual Studio is a lot \", \"simpler than if you use the editor/CLI\\napproach. Most of the steps required by Docker related to the\", \" Dockerfile and docker-compose.yml\\nfiles are hidden or simplified by Visual Studio, as shown in Figu\", \"re 5-15.\\n\\n\\n90 CHAPTER 4 | Development process for Docker-based applications\\n\\n\\n_Figure 5-15. Simplifi\", \"ed workflow when developing with Visual Studio_\\n\\n\\nIn addition, you need to perform step 2 (adding Do\", \"cker support to your projects) just once. Therefore,\\nthe workflow is similar to your usual developme\", \"nt tasks when using .NET for any other development.\\nYou need to know what is going on under the cove\", \"rs (the image build process, what base images\\nyou\\u2019re using, deployment of containers, etc.) and some\", \"times you will also need to edit the Dockerfile\\nor docker-compose.yml file to customize behaviors. B\", \"ut most of the work is greatly simplified by using\\nVisual Studio, making you a lot more productive.\\n\", \"\\n#### **Using PowerShell commands in a Dockerfile to set up Windows** **Containers**\\n\\n\\n[Windows Cont\", \"ainers](https://docs.microsoft.com/virtualization/windowscontainers/about/index) allow you to conver\", \"t your existing Windows applications into Docker images and\\ndeploy them with the same tools as the r\", \"est of the Docker ecosystem. To use Windows Containers,\\nyou run PowerShell commands in the Dockerfil\", \"e, as shown in the following example:\\n\\n\\nIn this case, we are using a Windows Server Core base image \", \"(the FROM setting) and installing IIS with\\na PowerShell command (the RUN setting). In a similar way,\", \" you could also use PowerShell commands\\nto set up additional components like ASP.NET 4.x, .NET Frame\", \"work 4.6, or any other Windows\\nsoftware. For example, the following command in a Dockerfile sets up \", \"ASP.NET 4.5:\\n\\n```\\nRUN powershell add-windowsfeature web-asp-net45\\n\\n```\\n\\n**Additional resources**\\n\\n\\n \", \" - **aspnet-docker/Dockerfile.** Example PowerShell commands to run from dockerfiles to\\ninclude Wind\", \"ows features.\\n\\n\\n91 CHAPTER 4 | Development process for Docker-based applications\\n\\n\\n[https://github.c\", \"om/Microsoft/aspnet-docker/blob/master/4.7.1-windowsservercore-](https://github.com/Microsoft/aspnet\", \"-docker/blob/master/4.7.1-windowsservercore-ltsc2016/runtime/Dockerfile)\\n[ltsc2016/runtime/Dockerfil\", \"e](https://github.com/Microsoft/aspnet-docker/blob/master/4.7.1-windowsservercore-ltsc2016/runtime/D\", \"ockerfile)\\n\\n\\n92 CHAPTER 4 | Development process for Docker-based applications\\n\\n\\n**CHAPTER**\\n# 5\\n\\n## \", \"Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n_Developing cont\", \"ainerized microservice applications means you are building multi-container_\\n_applications. However, \", \"a multi-container application could also be simpler\\u2014for example, a three-tier_\\n_application\\u2014and migh\", \"t not be built using a microservice architecture._\\n\\n\\nEarlier we raised the question \\u201cIs Docker neces\", \"sary when building a microservice architecture?\\u201d The\\nanswer is a clear no. Docker is an enabler and \", \"can provide significant benefits, but containers and\\nDocker are not a hard requirement for microserv\", \"ices. As an example, you could create a\\nmicroservices-based application with or without Docker when \", \"using Azure Service Fabric, which\\nsupports microservices running as simple processes or as Docker co\", \"ntainers.\\n\\n\\nHowever, if you know how to design and develop a microservices-based application that is\", \" also based\\non Docker containers, you will be able to design and develop any other, simpler applicat\", \"ion model.\\nFor example, you might design a three-tier application that also requires a multi-contain\", \"er approach.\\nBecause of that, and because microservice architectures are an important trend within t\", \"he container\\nworld, this section focuses on a microservice architecture implementation using Docker \", \"containers.\\n\\n### Design a microservice-oriented application\\n\\n\\nThis section focuses on developing a h\", \"ypothetical server-side enterprise application.\\n\\n#### **Application specifications**\\n\\n\\nThe hypotheti\", \"cal application handles requests by executing business logic, accessing databases, and\\nthen returnin\", \"g HTML, JSON, or XML responses. We will say that the application must support various\\nclients, inclu\", \"ding desktop browsers running Single Page Applications (SPAs), traditional web apps,\\nmobile web apps\", \", and native mobile apps. The application might also expose an API for third parties\\n\\n\\n93 CHAPTER 5 \", \"| Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nto consume. It\", \" should also be able to integrate its microservices or external applications\\nasynchronously, so that\", \" approach will help resiliency of the microservices in the case of partial failures.\\n\\n\\nThe applicati\", \"on will consist of these types of components:\\n\\n\\n  - Presentation components. These components are re\", \"sponsible for handling the UI and\\nconsuming remote services.\\n\\n\\n  - Domain or business logic. This co\", \"mponent is the application\\u2019s domain logic.\\n\\n\\n  - Database access logic. This component consists of d\", \"ata access components responsible for\\naccessing databases (SQL or NoSQL).\\n\\n\\n  - Application integrat\", \"ion logic. This component includes a messaging channel, based on\\nmessage brokers.\\n\\n\\nThe application \", \"will require high scalability, while allowing its vertical subsystems to scale out\\nautonomously, bec\", \"ause certain subsystems will require more scalability than others.\\n\\n\\nThe application must be able to\", \" be deployed in multiple infrastructure environments (multiple public\\nclouds and on-premises) and id\", \"eally should be cross-platform, able to move from Linux to Windows\\n(or vice versa) easily.\\n\\n#### **D\", \"evelopment team context**\\n\\n\\nWe also assume the following about the development process for the appli\", \"cation:\\n\\n\\n  - You have multiple dev teams focusing on different business areas of the application.\\n\\n\", \"\\n  - New team members must become productive quickly, and the application must be easy to\\nunderstand\", \" and modify.\\n\\n\\n  - The application will have a long-term evolution and ever-changing business rules.\", \"\\n\\n\\n  - You need good long-term maintainability, which means having agility when implementing\\nnew cha\", \"nges in the future while being able to update multiple subsystems with minimum\\nimpact on the other s\", \"ubsystems.\\n\\n\\n  - You want to practice continuous integration and continuous deployment of the applic\", \"ation.\\n\\n\\n  - You want to take advantage of emerging technologies (frameworks, programming languages,\", \"\\netc.) while evolving the application. You do not want to make full migrations of the\\napplication wh\", \"en moving to new technologies, because that would result in high costs and\\nimpact the predictability\", \" and stability of the application.\\n\\n#### **Choosing an architecture**\\n\\n\\nWhat should the application \", \"deployment architecture be? The specifications for the application, along\\nwith the development conte\", \"xt, strongly suggest that you should architect the application by\\ndecomposing it into autonomous sub\", \"systems in the form of collaborating microservices and\\ncontainers, where a microservice is a contain\", \"er.\\n\\n\\n94 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applicatio\", \"ns\\n\\n\\nIn this approach, each service (container) implements a set of cohesive and narrowly related fu\", \"nctions.\\nFor example, an application might consist of services such as the catalog service, ordering\", \" service,\\nbasket service, user profile service, etc.\\n\\n\\nMicroservices communicate using protocols suc\", \"h as HTTP (REST), but also asynchronously (for\\nexample, using AMQP) whenever possible, especially wh\", \"en propagating updates with integration\\nevents.\\n\\n\\nMicroservices are developed and deployed as contai\", \"ners independently of one another. This approach\\nmeans that a development team can be developing and\", \" deploying a certain microservice without\\nimpacting other subsystems.\\n\\n\\nEach microservice has its ow\", \"n database, allowing it to be fully decoupled from other microservices.\\nWhen necessary, consistency \", \"between databases from different microservices is achieved using\\napplication-level integration event\", \"s (through a logical event bus), as handled in Command and Query\\nResponsibility Segregation (CQRS). \", \"Because of that, the business constraints must embrace eventual\\nconsistency between the multiple mic\", \"roservices and related databases.\\n\\n\\n**eShopOnContainers: A reference application for .NET and micros\", \"ervices deployed**\\n**using containers**\\n\\n\\nSo that you can focus on the architecture and technologies\", \" instead of thinking about a hypothetical\\nbusiness domain that you might not know, we have selected \", \"a well-known business domain\\u2014namely,\\na simplified e-commerce (e-shop) application that presents a ca\", \"talog of products, takes orders from\\ncustomers, verifies inventory, and performs other business func\", \"tions. This container-based application\\n[source code is available in the eShopOnContainers](https://\", \"aka.ms/MicroservicesArchitecture) GitHub repo.\\n\\n\\nThe application consists of multiple subsystems, in\", \"cluding several store UI front ends (a Web\\napplication and a native mobile app), along with the back\", \"-end microservices and containers for all the\\nrequired server-side operations with several API Gatew\", \"ays as consolidated entry points to the internal\\nmicroservices. Figure 6-1 shows the architecture of\", \" the reference application.\\n\\n\\n95 CHAPTER 5 | Designing and Developing Multi-Container and Microservi\", \"ce-Based .NET Applications\\n\\n\\n_Figure 6-1. The eShopOnContainers reference application architecture f\", \"or development environment_\\n\\n\\nThe above diagram shows that Mobile and SPA clients communicate to sin\", \"gle API gateway endpoints,\\nthat then communicate to microservices. Traditional web clients communica\", \"te to MVC microservice,\\nthat communicates to microservices through the API gateway.\\n\\n\\n**Hosting envi\", \"ronment** . In Figure 6-1, you see several containers deployed within a single Docker host.\\nThat wou\", \"ld be the case when deploying to a single Docker host with the docker-compose up\\ncommand. However, i\", \"f you are using an orchestrator or container cluster, each container could be\\nrunning in a different\", \" host (node), and any node could be running any number of containers, as we\\nexplained earlier in the\", \" architecture section.\\n\\n\\n**Communication architecture** . The eShopOnContainers application uses two\", \" communication types,\\ndepending on the kind of the functional action (queries versus updates and tra\", \"nsactions):\\n\\n\\n  - Http client-to-microservice communication through API Gateways. This approach is u\", \"sed for\\nqueries and when accepting update or transactional commands from the client apps. The\\napproa\", \"ch using API Gateways is explained in detail in later sections.\\n\\n\\n  - Asynchronous event-based commu\", \"nication. This communication occurs through an event bus\\nto propagate updates across microservices o\", \"r to integrate with external applications. The\\nevent bus can be implemented with any messaging-broke\", \"r infrastructure technology like\\nRabbitMQ, or using higher-level (abstraction-level) service buses l\", \"ike Azure Service Bus,\\nNServiceBus, MassTransit, or Brighter.\\n\\n\\nThe application is deployed as a set\", \" of microservices in the form of containers. Client apps can\\ncommunicate with those microservices ru\", \"nning as containers through the public URLs published by\\nthe API Gateways.\\n\\n\\n96 CHAPTER 5 | Designin\", \"g and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n**Data sovereignty per m\", \"icroservice**\\n\\n\\nIn the sample application, each microservice owns its own database or data source, a\", \"lthough all SQL\\nServer databases are deployed as a single container. This design decision was made o\", \"nly to make it\\neasy for a developer to get the code from GitHub, clone it, and open it in Visual Stu\", \"dio or Visual\\nStudio Code. Or alternatively, it makes it easy to compile the custom Docker images us\", \"ing the .NET\\nCLI and the Docker CLI, and then deploy and run them in a Docker development environmen\", \"t. Either\\nway, using containers for data sources lets developers build and deploy in a matter of min\", \"utes without\\nhaving to provision an external database or any other data source with hard dependencie\", \"s on\\ninfrastructure (cloud or on-premises).\\n\\n\\nIn a real production environment, for high availabilit\", \"y and for scalability, the databases should be\\nbased on database servers in the cloud or on-premises\", \", but not in containers.\\n\\n\\nTherefore, the units of deployment for microservices (and even for databa\", \"ses in this application) are\\nDocker containers, and the reference application is a multi-container a\", \"pplication that embraces\\nmicroservices principles.\\n\\n\\n**Additional resources**\\n\\n\\n  - **eShopOnContain\", \"ers GitHub repo. Source code for the reference application**\\n[https://aka.ms/eShopOnContainers/](htt\", \"ps://aka.ms/eShopOnContainers/)\\n\\n#### **Benefits of a microservice-based solution**\\n\\n\\nA microservice\", \"-based solution like this has many benefits:\\n\\n\\n**Each microservice is relatively small\\u2014easy to manag\", \"e and evolve** . Specifically:\\n\\n\\n  - It is easy for a developer to understand and get started quickl\", \"y with good productivity.\\n\\n\\n  - Containers start fast, which makes developers more productive.\\n\\n\\n  -\", \" An IDE like Visual Studio can load smaller projects fast, making developers productive.\\n\\n\\n  - Each \", \"microservice can be designed, developed, and deployed independently of other\\nmicroservices, which pr\", \"ovide agility because it is easier to deploy new versions of\\nmicroservices frequently.\\n\\n\\n**It is pos\", \"sible to scale out individual areas of the application** . For instance, the catalog service or\\nthe \", \"basket service might need to be scaled out, but not the ordering process. A microservices\\ninfrastruc\", \"ture will be much more efficient with regard to the resources used when scaling out than a\\nmonolithi\", \"c architecture would be.\\n\\n\\n**You can divide the development work between multiple teams** . Each ser\", \"vice can be owned by a\\nsingle development team. Each team can manage, develop, deploy, and scale the\", \"ir service\\nindependently of the rest of the teams.\\n\\n\\n**Issues are more isolated** . If there is an i\", \"ssue in one service, only that service is initially impacted\\n(except when the wrong design is used, \", \"with direct dependencies between microservices), and other\\nservices can continue to handle requests.\", \" In contrast, one malfunctioning component in a monolithic\\n\\n\\n97 CHAPTER 5 | Designing and Developing\", \" Multi-Container and Microservice-Based .NET Applications\\n\\n\\ndeployment architecture can bring down t\", \"he entire system, especially when it involves resources, such\\nas a memory leak. Additionally, when a\", \"n issue in a microservice is resolved, you can deploy just the\\naffected microservice without impacti\", \"ng the rest of the application.\\n\\n\\n**You can use the latest technologies** . Because you can start de\", \"veloping services independently and\\nrun them side by side (thanks to containers and .NET), you can s\", \"tart using the latest technologies and\\nframeworks expediently instead of being stuck on an older sta\", \"ck or framework for the whole\\napplication.\\n\\n#### **Downsides of a microservice-based solution**\\n\\n\\nA \", \"microservice-based solution like this also has some drawbacks:\\n\\n\\n**Distributed application** . Distr\", \"ibuting the application adds complexity for developers when they are\\ndesigning and building the serv\", \"ices. For example, developers must implement inter-service\\ncommunication using protocols like HTTP o\", \"r AMQP, which adds complexity for testing and exception\\nhandling. It also adds latency to the system\", \".\\n\\n\\n**Deployment complexity** . An application that has dozens of microservices types and needs high\", \"\\nscalability (it needs to be able to create many instances per service and balance those services ac\", \"ross\\nmany hosts) means a high degree of deployment complexity for IT operations and management. If\\ny\", \"ou are not using a microservice-oriented infrastructure (like an orchestrator and scheduler), that\\na\", \"dditional complexity can require far more development efforts than the business application itself.\\n\", \"\\n\\n**Atomic transactions** . Atomic transactions between multiple microservices usually are not possi\", \"ble.\\nThe business requirements have to embrace eventual consistency between multiple microservices.\\n\", \"\\n\\n**Increased global resource needs** (total memory, drives, and network resources for all the serve\", \"rs or\\nhosts). In many cases, when you replace a monolithic application with a microservices approach\", \", the\\namount of initial global resources needed by the new microservice-based application will be la\", \"rger\\nthan the infrastructure needs of the original monolithic application. This approach is because \", \"the\\nhigher degree of granularity and distributed services requires more global resources. However, g\", \"iven\\nthe low cost of resources in general and the benefit of being able to scale out certain areas o\", \"f the\\napplication compared to long-term costs when evolving monolithic applications, the increased u\", \"se of\\nresources is usually a good tradeoff for large, long-term applications.\\n\\n\\n**Issues with direct\", \" client-to-microservice communication** . When the application is large, with\\ndozens of microservice\", \"s, there are challenges and limitations if the application requires direct clientto-microservice com\", \"munications. One problem is a potential mismatch between the needs of the\\nclient and the APIs expose\", \"d by each of the microservices. In certain cases, the client application might\\nneed to make many sep\", \"arate requests to compose the UI, which can be inefficient over the Internet\\nand would be impractica\", \"l over a mobile network. Therefore, requests from the client application to the\\nback-end system shou\", \"ld be minimized.\\n\\n\\nAnother problem with direct client-to-microservice communications is that some mi\", \"croservices might\\nbe using protocols that are not Web-friendly. One service might use a binary proto\", \"col, while another\\nservice might use AMQP messaging. Those protocols are not firewall-friendly and a\", \"re best used\\ninternally. Usually, an application should use protocols such as HTTP and WebSockets fo\", \"r\\ncommunication outside of the firewall.\\n\\n\\n98 CHAPTER 5 | Designing and Developing Multi-Container a\", \"nd Microservice-Based .NET Applications\\n\\n\\nYet another drawback with this direct client-to-service ap\", \"proach is that it makes it difficult to refactor\\nthe contracts for those microservices. Over time de\", \"velopers might want to change how the system is\\npartitioned into services. For example, they might m\", \"erge two services or split a service into two or\\nmore services. However, if clients communicate dire\", \"ctly with the services, performing this kind of\\nrefactoring can break compatibility with client apps\", \".\\n\\n\\nAs mentioned in the architecture section, when designing and building a complex application base\", \"d\\non microservices, you might consider the use of multiple fine-grained API Gateways instead of the\\n\", \"simpler direct client-to-microservice communication approach.\\n\\n\\n**Partitioning the microservices** .\", \" Finally, no matter, which approach you take for your microservice\\narchitecture, another challenge i\", \"s deciding how to partition an end-to-end application into multiple\\nmicroservices. As noted in the a\", \"rchitecture section of the guide, there are several techniques and\\napproaches you can take. Basicall\", \"y, you need to identify areas of the application that are decoupled\\nfrom the other areas and that ha\", \"ve a low number of hard dependencies. In many cases, this approach\\nis aligned to partitioning servic\", \"es by use case. For example, in our e-shop application, we have an\\nordering service that is responsi\", \"ble for all the business logic related to the order process. We also\\nhave the catalog service and th\", \"e basket service that implement other capabilities. Ideally, each service\\nshould have only a small s\", \"et of responsibilities. This approach is similar to the single responsibility\\nprinciple (SRP) applie\", \"d to classes, which states that a class should only have one reason to change. But\\nin this case, it \", \"is about microservices, so the scope will be larger than a single class. Most of all, a\\nmicroservice\", \" has to be autonomous, end to end, including responsibility for its own data sources.\\n\\n#### **Extern\", \"al versus internal architecture and design patterns**\\n\\n\\nThe external architecture is the microservic\", \"e architecture composed by multiple services, following the\\nprinciples described in the architecture\", \" section of this guide. However, depending on the nature of\\neach microservice, and independently of \", \"high-level microservice architecture you choose, it is\\ncommon and sometimes advisable to have differ\", \"ent internal architectures, each based on different\\npatterns, for different microservices. The micro\", \"services can even use different technologies and\\nprogramming languages. Figure 6-2 illustrates this \", \"diversity.\\n\\n\\n99 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET App\", \"lications\\n\\n\\n_Figure 6-2. External versus internal architecture and design_\\n\\n\\nFor instance, in our _e\", \"ShopOnContainers_ sample, the catalog, basket, and user profile microservices are\\nsimple (basically,\", \" CRUD subsystems). Therefore, their internal architecture and design is\\nstraightforward. However, yo\", \"u might have other microservices, such as the ordering microservice,\\nwhich is more complex and repre\", \"sents ever-changing business rules with a high degree of domain\\ncomplexity. In cases like these, you\", \" might want to implement more advanced patterns within a\\nparticular microservice, like the ones defi\", \"ned with domain-driven design (DDD) approaches, as we are\\ndoing in the _eShopOnContainers_ ordering \", \"microservice. (We will review these DDD patterns in the\\nsection later that explains the implementati\", \"on of the _eShopOnContainers_ ordering microservice.)\\n\\n\\nAnother reason for a different technology pe\", \"r microservice might be the nature of each microservice.\\nFor example, it might be better to use a fu\", \"nctional programming language like F#, or even a language\\nlike R if you are targeting AI and machine\", \" learning domains, instead of a more object-oriented\\nprogramming language like C#.\\n\\n\\nThe bottom line\", \" is that each microservice can have a different internal architecture based on different\\ndesign patt\", \"erns. Not all microservices should be implemented using advanced DDD patterns, because\\nthat would be\", \" over-engineering them. Similarly, complex microservices with ever-changing business\\nlogic should no\", \"t be implemented as CRUD components, or you can end up with low-quality code.\\n\\n#### **The new world:\", \" multiple architectural patterns and polyglot** **microservices**\\n\\n\\nThere are many architectural pat\", \"terns used by software architects and developers. The following are a\\nfew (mixing architecture style\", \"s and architecture patterns):\\n\\n\\n  - Simple CRUD, single-tier, single-layer.\\n\\n\\n100 CHAPTER 5 | Design\", \"ing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n  - [Traditional N-Lay\", \"ered.](https://docs.microsoft.com/previous-versions/msp-n-p/ee658109(v=pandp.10))\\n\\n\\n  - [Domain-Driv\", \"en Design N-layered.](https://devblogs.microsoft.com/cesardelatorre/published-first-alpha-version-of\", \"-domain-oriented-n-layered-architecture-v2-0/)\\n\\n\\n  - [Clean Architecture (as used with eShopOnWeb)](\", \"https://docs.microsoft.com/dotnet/architecture/modern-web-apps-azure/common-web-application-architec\", \"tures#clean-architecture)\\n\\n\\n  - [Command and Query Responsibility Segregation](https://martinfowler.\", \"com/bliki/CQRS.html) (CQRS).\\n\\n\\n  - [Event-Driven Architecture (EDA).](https://en.wikipedia.org/wiki/\", \"Event-driven_architecture)\\n\\n\\nYou can also build microservices with many technologies and languages, \", \"such as ASP.NET Core Web\\nAPIs, NancyFx, ASP.NET Core SignalR (available with .NET Core 2 or later), \", \"F#, Node.js, Python, Java,\\nC++, GoLang, and more.\\n\\n\\nThe important point is that no particular archit\", \"ecture pattern or style, nor any particular technology, is\\nright for all situations. Figure 6-3 show\", \"s some approaches and technologies (although not in any\\nparticular order) that could be used in diff\", \"erent microservices.\\n\\n\\n_Figure 6-3. Multi-architectural patterns and the polyglot microservices worl\", \"d_\\n\\n\\nMulti-architectural pattern and polyglot microservices means you can mix and match languages an\", \"d\\ntechnologies to the needs of each microservice and still have them talking to each other. As shown\", \" in\\nFigure 6-3, in applications composed of many microservices (Bounded Contexts in domain-driven\\nde\", \"sign terminology, or simply \\u201csubsystems\\u201d as autonomous microservices), you might implement\\neach micr\", \"oservice in a different way. Each might have a different architecture pattern and use different\\nlang\", \"uages and databases depending on the application\\u2019s nature, business requirements, and\\npriorities. In\", \" some cases, the microservices might be similar. But that is not usually the case, because\\neach subs\", \"ystem\\u2019s context boundary and requirements are usually different.\\n\\n\\n101 CHAPTER 5 | Designing and Dev\", \"eloping Multi-Container and Microservice-Based .NET Applications\\n\\n\\nFor instance, for a simple CRUD m\", \"aintenance application, it might not make sense to design and\\nimplement DDD patterns. But for your c\", \"ore domain or core business, you might need to apply more\\nadvanced patterns to tackle business compl\", \"exity with ever-changing business rules.\\n\\n\\nEspecially when you deal with large applications composed\", \" by multiple subsystems, you should not\\napply a single top-level architecture based on a single arch\", \"itecture pattern. For instance, CQRS should\\nnot be applied as a top-level architecture for a whole a\", \"pplication, but might be useful for a specific set\\nof services.\\n\\n\\nThere is no silver bullet or a rig\", \"ht architecture pattern for every given case. You cannot have \\u201cone\\narchitecture pattern to rule them\", \" all.\\u201d Depending on the priorities of each microservice, you must\\nchoose a different approach for ea\", \"ch, as explained in the following sections.\\n\\n### Creating a simple data-driven CRUD microservice\\n\\n\\nT\", \"his section outlines how to create a simple microservice that performs create, read, update, and\\ndel\", \"ete (CRUD) operations on a data source.\\n\\n#### **Designing a simple CRUD microservice**\\n\\n\\nFrom a desi\", \"gn point of view, this type of containerized microservice is very simple. Perhaps the\\nproblem to sol\", \"ve is simple, or perhaps the implementation is only a proof of concept.\\n\\n\\n_Figure 6-4. Internal desi\", \"gn for simple CRUD microservices_\\n\\n\\nAn example of this kind of simple data-drive service is the cata\", \"log microservice from the\\neShopOnContainers sample application. This type of service implements all \", \"its functionality in a single\\nASP.NET Core Web API project that includes classes for its data model,\", \" its business logic, and its data\\naccess code. It also stores its related data in a database running\", \" in SQL Server (as another container\\nfor dev/test purposes), but could also be any regular SQL Serve\", \"r host, as shown in Figure 6-5.\\n\\n\\n102 CHAPTER 5 | Designing and Developing Multi-Container and Micro\", \"service-Based .NET Applications\\n\\n\\n_Figure 6-5. Simple data-driven/CRUD microservice design_\\n\\n\\nThe pr\", \"evious diagram shows the logical Catalog microservice, that includes its Catalog database,\\nwhich can\", \" be or not in the same Docker host. Having the database in the same Docker host might be\\ngood for de\", \"velopment, but not for production. When you are developing this kind of service, you only\\n[need ASP.\", \"NET Core](https://docs.microsoft.com/aspnet/core/) [and a data-access API or ORM like Entity Framewo\", \"rk Core. You could also](https://docs.microsoft.com/ef/core/index)\\n[generate Swagger](https://swagge\", \"r.io/) [metadata automatically through Swashbuckle](https://github.com/domaindrivendev/Swashbuckle.A\", \"spNetCore) to provide a description of what your\\nservice offers, as explained in the next section.\\n\\n\", \"\\nNote that running a database server like SQL Server within a Docker container is great for\\ndevelopm\", \"ent environments, because you can have all your dependencies up and running without\\nneeding to provi\", \"sion a database in the cloud or on-premises. This approach is convenient when\\nrunning integration te\", \"sts. However, for production environments, running a database server in a\\ncontainer is not recommend\", \"ed, because you usually do not get high availability with that approach.\\nFor a production environmen\", \"t in Azure, it is recommended that you use Azure SQL DB or any other\\ndatabase technology that can pr\", \"ovide high availability and high scalability. For example, for a NoSQL\\napproach, you might choose Co\", \"smosDB.\\n\\n\\nFinally, by editing the Dockerfile and docker-compose.yml metadata files, you can configur\", \"e how the\\nimage of this container will be created\\u2014what base image it will use, plus design settings \", \"such as\\ninternal and external names and TCP ports.\\n\\n#### **Implementing a simple CRUD microservice w\", \"ith ASP.NET Core**\\n\\n\\nTo implement a simple CRUD microservice using .NET and Visual Studio, you start\", \" by creating a\\nsimple ASP.NET Core Web API project (running on .NET so it can run on a Linux Docker \", \"host), as\\nshown in Figure 6-6.\\n\\n\\n103 CHAPTER 5 | Designing and Developing Multi-Container and Micros\", \"ervice-Based .NET Applications\\n\\n\\n_Figure 6-6. Creating an ASP.NET Core Web API project in Visual Stu\", \"dio 2019_\\n\\n\\nTo create an ASP.NET Core Web API Project, first select an ASP.NET Core Web Application \", \"and then\\nselect the API type. After creating the project, you can implement your MVC controllers as \", \"you would\\nin any other Web API project, using the Entity Framework API or other API. In a new Web AP\", \"I project,\\nyou can see that the only dependency you have in that microservice is on ASP.NET Core its\", \"elf.\\nInternally, within the _Microsoft.AspNetCore.All_ dependency, it is referencing Entity Framewor\", \"k and\\nmany other .NET NuGet packages, as shown in Figure 6-7.\\n\\n\\n104 CHAPTER 5 | Designing and Develo\", \"ping Multi-Container and Microservice-Based .NET Applications\\n\\n\\n_Figure 6-7. Dependencies in a simpl\", \"e CRUD Web API microservice_\\n\\n\\nThe API project includes references to Microsoft.AspNetCore.App NuGet\", \" package, that includes\\nreferences to all essential packages. It could include some other packages a\", \"s well.\\n\\n\\n**Implementing CRUD Web API services with Entity Framework Core**\\n\\n\\nEntity Framework (EF) \", \"Core is a lightweight, extensible, and cross-platform version of the popular\\nEntity Framework data a\", \"ccess technology. EF Core is an object-relational mapper (ORM) that enables\\n.NET developers to work \", \"with a database using .NET objects.\\n\\n\\nThe catalog microservice uses EF and the SQL Server provider b\", \"ecause its database is running in a\\ncontainer with the SQL Server for Linux Docker image. However, t\", \"he database could be deployed into\\n\\n\\n105 CHAPTER 5 | Designing and Developing Multi-Container and Mi\", \"croservice-Based .NET Applications\\n\\n\\nany SQL Server, such as Windows on-premises or Azure SQL DB. Th\", \"e only thing you would need to\\nchange is the connection string in the ASP.NET Web API microservice.\\n\", \"\\n\\n**The data model**\\n\\n\\nWith EF Core, data access is performed by using a model. A model is made up o\", \"f (domain model)\\nentity classes and a derived context (DbContext) that represents a session with the\", \" database, allowing\\nyou to query and save data. You can generate a model from an existing database, \", \"manually code a\\nmodel to match your database, or use EF migrations technique to create a database fr\", \"om your model,\\nusing the code-first approach (that makes it easy to evolve the database as your mode\", \"l changes over\\ntime). For the catalog microservice, the last approach has been used. You can see an \", \"example of the\\nCatalogItem entity class in the following code example, which is a simple Plain Old C\", \"lass Object\\n[(POCO) entity class.](https://docs.microsoft.com/dotnet/standard/glossary#poco)\\n\\n\\nYou a\", \"lso need a DbContext that represents a session with the database. For the catalog microservice,\\nthe \", \"CatalogContext class derives from the DbContext base class, as shown in the following example:\\n\\n\\nYou\", \" can have additional DbContext implementations. For example, in the sample Catalog.API\\nmicroservice,\", \" there\\u2019s a second DbContext named CatalogContextSeed where it automatically\\npopulates the sample dat\", \"a the first time it tries to access the database. This method is useful for demo\\ndata and for automa\", \"ted testing scenarios, as well.\\n\\n\\n106 CHAPTER 5 | Designing and Developing Multi-Container and Micro\", \"service-Based .NET Applications\\n\\n\\nWithin the DbContext, you use the OnModelCreating method to custom\", \"ize object/database entity\\n[mappings and other EF extensibility points.](https://devblogs.microsoft.\", \"com/dotnet/implementing-seeding-custom-conventions-and-interceptors-in-ef-core-1-0/)\\n\\n\\nQuerying data\", \" from Web API controllers\\n\\n\\nInstances of your entity classes are typically retrieved from the databa\", \"se using Language-Integrated\\nQuery (LINQ), as shown in the following example:\\n\\n\\n107 CHAPTER 5 | Desi\", \"gning and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nSaving data\\n\\n\\nData i\", \"s created, deleted, and modified in the database using instances of your entity classes. You\\ncould a\", \"dd code like the following hard-coded example (mock data, in this case) to your Web API\\ncontrollers.\", \"\\n\\n\\nDependency Injection in ASP.NET Core and Web API controllers\\n\\n\\nIn ASP.NET Core, you can use Depen\", \"dency Injection (DI) out of the box. You do not need to set up a\\nthird-party Inversion of Control (I\", \"oC) container, although you can plug your preferred IoC container\\ninto the ASP.NET Core infrastructu\", \"re if you want. In this case, it means that you can directly inject the\\nrequired EF DBContext or add\", \"itional repositories through the controller constructor.\\n\\n\\nIn the CatalogController class mentioned \", \"earlier, CatalogContext (which inherits from DbContext) type\\nis injected along with the other requir\", \"ed objects in the CatalogController() constructor.\\n\\n\\nAn important configuration to set up in the Web\", \" API project is the DbContext class registration into\\nthe service\\u2019s IoC container. You typically do \", \"so in the _Program.cs_ file by calling the\\nbuilder.Services.AddDbContext<CatalogContext>() method, a\", \"s shown in the following **simplified**\\nexample:\\n\\n\\n108 CHAPTER 5 | Designing and Developing Multi-Co\", \"ntainer and Microservice-Based .NET Applications\\n\\n\\n**Additional resources**\\n\\n\\n  - **Querying Data**\\n\", \"[https://learn.microsoft.com/ef/core/querying/index](https://docs.microsoft.com/ef/core/querying/ind\", \"ex)\\n\\n\\n  - **Saving Data**\\n[https://learn.microsoft.com/ef/core/saving/index](https://docs.microsoft.\", \"com/ef/core/saving/index)\\n\\n#### **The DB connection string and environment variables used by Docker*\", \"* **containers**\\n\\n\\nYou can use the ASP.NET Core settings and add a ConnectionString property to your\", \" settings.json file\\nas shown in the following example:\\n\\n\\nThe settings.json file can have default val\", \"ues for the ConnectionString property or for any other\\nproperty. However, those properties will be o\", \"verridden by the values of environment variables that\\nyou specify in the docker-compose.override.yml\", \" file, when using Docker.\\n\\n\\nFrom your docker-compose.yml or docker-compose.override.yml files, you c\", \"an initialize those\\nenvironment variables so that Docker will set them up as OS environment variable\", \"s for you, as shown\\nin the following docker-compose.override.yml file (the connection string and oth\", \"er lines wrap in this\\nexample, but it would not wrap in your own file).\\n\\n\\n109 CHAPTER 5 | Designing \", \"and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nThe docker-compose.yml fil\", \"es at the solution level are not only more flexible than configuration files\\nat the project or micro\", \"service level, but also more secure if you override the environment variables\\ndeclared at the docker\", \"-compose files with values set from your deployment tools, like from Azure\\nDevOps Services Docker de\", \"ployment tasks.\\n\\n\\nFinally, you can get that value from your code by using builder.Configuration\\\\[\\\"Co\", \"nnectionString\\\"\\\\], as\\nshown in an earlier code example.\\n\\n\\nHowever, for production environments, you \", \"might want to explore additional ways on how to store\\n[secrets like the connection strings. An excel\", \"lent way to manage application secrets is using Azure Key](https://azure.microsoft.com/services/key-\", \"vault/)\\n[Vault.](https://azure.microsoft.com/services/key-vault/)\\n\\n\\nAzure Key Vault helps to store a\", \"nd safeguard cryptographic keys and secrets used by your cloud\\napplications and services. A secret i\", \"s anything you want to keep strict control of, like API keys,\\nconnection strings, passwords, etc. an\", \"d strict control includes usage logging, setting expiration,\\nmanaging access, _among others_ .\\n\\n\\nAzu\", \"re Key Vault allows a detailed control level of the application secrets usage without the need to le\", \"t\\nanyone know them. The secrets can even be rotated for enhanced security without disrupting\\ndevelop\", \"ment or operations.\\n\\n\\nApplications have to be registered in the organization\\u2019s Active Directory, so \", \"they can use the Key\\nVault.\\n\\n\\nYou can check the _Key Vault Concepts documentation_ for more details.\", \"\\n\\n\\n**Implementing versioning in ASP.NET Web APIs**\\n\\n\\nAs business requirements change, new collection\", \"s of resources may be added, the relationships\\nbetween resources might change, and the structure of \", \"the data in resources might be amended.\\nUpdating a Web API to handle new requirements is a relativel\", \"y straightforward process, but you must\\nconsider the effects that such changes will have on client a\", \"pplications consuming the Web API.\\nAlthough the developer designing and implementing a Web API has f\", \"ull control over that API, the\\ndeveloper does not have the same degree of control over client applic\", \"ations that might be built by\\nthird-party organizations operating remotely.\\n\\n\\nVersioning enables a W\", \"eb API to indicate the features and resources that it exposes. A client\\napplication can then submit \", \"requests to a specific version of a feature or resource. There are several\\napproaches to implement v\", \"ersioning:\\n\\n\\n  - URI versioning\\n\\n\\n  - Query string versioning\\n\\n\\n  - Header versioning\\n\\n\\nQuery string\", \" and URI versioning are the simplest to implement. Header versioning is a good\\napproach. However, he\", \"ader versioning is not as explicit and straightforward as URI versioning.\\nBecause URL versioning is \", \"the simplest and most explicit, the eShopOnContainers sample application\\nuses URI versioning.\\n\\n\\n110 \", \"CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nWith\", \" URI versioning, as in the eShopOnContainers sample application, each time you modify the Web\\nAPI or\", \" change the schema of resources, you add a version number to the URI for each resource.\\nExisting URI\", \"s should continue to operate as before, returning resources that conform to the schema\\nthat matches \", \"the requested version.\\n\\n\\nAs shown in the following code example, the version can be set by using the\", \" Route attribute in the\\nWeb API controller, which makes the version explicit in the URI (v1 in this \", \"case).\\n\\n\\nThis versioning mechanism is simple and depends on the server routing the request to the\\nap\", \"propriate endpoint. However, for a more sophisticated versioning and the best method when using\\n[RES\", \"T, you should use hypermedia and implement HATEOAS (Hypertext as the Engine of Application](https://\", \"docs.microsoft.com/azure/architecture/best-practices/api-design#use-hateoas-to-enable-navigation-to-\", \"related-resources)\\n[State).](https://docs.microsoft.com/azure/architecture/best-practices/api-design\", \"#use-hateoas-to-enable-navigation-to-related-resources)\\n\\n\\n**Additional resources**\\n\\n\\n  - **ASP.NET A\", \"PI Versioning** [https://github.com/dotnet/aspnet-api-versioning](https://github.com/dotnet/aspnet-a\", \"pi-versioning)\\n\\n\\n  - **Scott Hanselman. ASP.NET Core RESTful Web API versioning made easy**\\n[https:/\", \"/www.hanselman.com/blog/ASPNETCoreRESTfulWebAPIVersioningMadeEasy.aspx](https://www.hanselman.com/bl\", \"og/ASPNETCoreRESTfulWebAPIVersioningMadeEasy.aspx)\\n\\n\\n  - **Versioning a RESTful web API**\\n[https://l\", \"earn.microsoft.com/azure/architecture/best-practices/api-design#versioning-a-](https://docs.microsof\", \"t.com/azure/architecture/best-practices/api-design#versioning-a-restful-web-api)\\n[restful-web-api](h\", \"ttps://docs.microsoft.com/azure/architecture/best-practices/api-design#versioning-a-restful-web-api)\", \"\\n\\n\\n  - **Roy Fielding. Versioning, Hypermedia, and REST**\\n[https://www.infoq.com/articles/roy-fieldi\", \"ng-on-versioning](https://www.infoq.com/articles/roy-fielding-on-versioning)\\n\\n#### **Generating Swag\", \"ger description metadata from your ASP.NET Core** **Web API**\\n\\n\\n[Swagger](https://swagger.io/) is a \", \"commonly used open source framework backed by a large ecosystem of tools that helps\\nyou design, buil\", \"d, document, and consume your RESTful APIs. It is becoming the standard for the APIs\\ndescription met\", \"adata domain. You should include Swagger description metadata with any kind of\\nmicroservice, either \", \"data-driven microservices or more advanced domain-driven microservices (as\\nexplained in the followin\", \"g section).\\n\\n\\nThe heart of Swagger is the Swagger specification, which is API description metadata i\", \"n a JSON or\\nYAML file. The specification creates the RESTful contract for your API, detailing all it\", \"s resources and\\noperations in both a human- and machine-readable format for easy development, discov\", \"ery, and\\nintegration.\\n\\n\\nThe specification is the basis of the OpenAPI Specification (OAS) and is dev\", \"eloped in an open,\\ntransparent, and collaborative community to standardize the way RESTful interface\", \"s are defined.\\n\\n\\n111 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NE\", \"T Applications\\n\\n\\nThe specification defines the structure for how a service can be discovered and how\", \" its capabilities\\nunderstood. For more information, including a web editor and examples of Swagger s\", \"pecifications\\n[from companies like Spotify, Uber, Slack, and Microsoft, see the Swagger site (https:\", \"//swagger.io).](https://swagger.io/)\\n\\n\\n**Why use Swagger?**\\n\\n\\nThe main reasons to generate Swagger m\", \"etadata for your APIs are the following.\\n\\n\\n**Ability for other products to automatically consume and\", \" integrate your APIs** . Dozens of products\\n[and commercial tools](https://swagger.io/commercial-too\", \"ls/) [and many libraries and frameworks](https://swagger.io/open-source-integrations/) support Swagg\", \"er. Microsoft has high-level\\nproducts and tools that can automatically consume Swagger-based APIs, s\", \"uch as the following:\\n\\n\\n  - [AutoRest. You can automatically generate .NET client classes for callin\", \"g Swagger. This tool can](https://github.com/Azure/AutoRest)\\nbe used from the CLI and it also integr\", \"ates with Visual Studio for easy use through the GUI.\\n\\n\\n  - [Microsoft Flow. You can automatically u\", \"se and integrate your API](https://flow.microsoft.com/) into a high-level Microsoft\\nFlow workflow, w\", \"ith no programming skills required.\\n\\n\\n  - [Microsoft PowerApps. You can automatically consume your A\", \"PI from PowerApps mobile apps](https://powerapps.microsoft.com/)\\n[built with PowerApps Studio, with \", \"no programming skills required.](https://powerapps.microsoft.com/build-powerapps/)\\n\\n\\n  - [Azure App \", \"Service Logic Apps. You can automatically use and integrate your API into an Azure](https://docs.mic\", \"rosoft.com/azure/app-service-logic/app-service-logic-what-are-logic-apps)\\n[App Service Logic App, wi\", \"th no programming skills required.](https://docs.microsoft.com/azure/app-service-logic/app-service-l\", \"ogic-custom-hosted-api)\\n\\n\\n**Ability to automatically generate API documentation** . When you create \", \"large-scale RESTful APIs,\\nsuch as complex microservice-based applications, you need to handle many e\", \"ndpoints with different\\ndata models used in the request and response payloads. Having proper documen\", \"tation and having a\\nsolid API explorer, as you get with Swagger, is key for the success of your API \", \"and adoption by\\ndevelopers.\\n\\n\\nSwagger\\u2019s metadata is what Microsoft Flow, PowerApps, and Azure Logic \", \"Apps use to understand how\\nto use APIs and connect to them.\\n\\n\\nThere are several options to automate \", \"Swagger metadata generation for ASP.NET Core REST API\\napplications, in the form of functional API he\", \"lp pages, based on _swagger-ui_ .\\n\\n\\n[Probably the best know is Swashbuckle, which is currently used \", \"in eShopOnContainers and we\\u2019ll cover](https://github.com/domaindrivendev/Swashbuckle.AspNetCore)\\n[in\", \" some detail in this guide but there\\u2019s also the option to use NSwag, which can generate Typescript](\", \"https://github.com/RSuter/NSwag)\\nand C# API clients, as well as C# controllers, from a Swagger or Op\", \"enAPI specification and even by\\n[scanning the .dll that contains the controllers, using NSwagStudio.\", \"](https://github.com/RSuter/NSwag/wiki/NSwagStudio)\\n\\n\\n**How to automate API Swagger metadata generat\", \"ion with the Swashbuckle NuGet**\\n**package**\\n\\n\\nGenerating Swagger metadata manually (in a JSON or YA\", \"ML file) can be tedious work. However, you\\n[can automate API discovery of ASP.NET Web API services b\", \"y using the Swashbuckle NuGet package to](https://aka.ms/swashbuckledotnetcore)\\ndynamically generate\", \" Swagger API metadata.\\n\\n\\nSwashbuckle automatically generates Swagger metadata for your ASP.NET Web A\", \"PI projects. It\\nsupports ASP.NET Core Web API projects and the traditional ASP.NET Web API and any o\", \"ther flavor,\\n\\n\\n112 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET \", \"Applications\\n\\n\\nsuch as Azure API App, Azure Mobile App, Azure Service Fabric microservices based on \", \"ASP.NET. It\\nalso supports plain Web API deployed on containers, as in for the reference application.\", \"\\n\\n\\n[Swashbuckle combines API Explorer and Swagger or swagger-ui](https://github.com/swagger-api/swag\", \"ger-ui) to provide a rich discovery and\\ndocumentation experience for your API consumers. In addition\", \" to its Swagger metadata generator\\nengine, Swashbuckle also contains an embedded version of swagger-\", \"ui, which it will automatically\\nserve up once Swashbuckle is installed.\\n\\n\\nThis means you can complem\", \"ent your API with a nice discovery UI to help developers to use your API.\\nIt requires a small amount\", \" of code and maintenance because it is automatically generated, allowing\\nyou to focus on building yo\", \"ur API. The result for the API Explorer looks like Figure 6-8.\\n\\n\\n_Figure 6-8. Swashbuckle API Explor\", \"er based on Swagger metadata\\u2014eShopOnContainers catalog microservice_\\n\\n\\nThe Swashbuckle generated Swa\", \"gger UI API documentation includes all published actions. The API\\nexplorer is not the most important\", \" thing here. Once you have a Web API that can describe itself in\\nSwagger metadata, your API can be u\", \"sed seamlessly from Swagger-based tools, including client\\n[proxy-class code generators that can targ\", \"et many platforms. For example, as mentioned, AutoRest](https://github.com/Azure/AutoRest)\\n[automati\", \"cally generates .NET client classes. But additional tools like swagger-codegen are also](https://git\", \"hub.com/swagger-api/swagger-codegen)\\navailable, which allow code generation of API client libraries,\", \" server stubs, and documentation\\nautomatically.\\n\\n\\nCurrently, Swashbuckle consists of five internal N\", \"uGet packages under the high-level metapackage\\n[Swashbuckle.AspNetCore for ASP.NET Core applications\", \".](https://www.nuget.org/packages/Swashbuckle.AspNetCore)\\n\\n\\nAfter you have installed these NuGet pac\", \"kages in your Web API project, you need to configure\\nSwagger in the _Program.cs_ class, as in the fo\", \"llowing **simplified** code:\\n\\n\\n113 CHAPTER 5 | Designing and Developing Multi-Container and Microser\", \"vice-Based .NET Applications\\n\\n\\nYou previously saw the generated UI created by Swashbuckle for a URL \", \"like http://<your-rooturl>/swagger. In Figure 6-9, you can also see how you can test any API method.\", \"\\n\\n\\n114 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\", \"\\n\\n\\n_Figure 6-9. Swashbuckle UI testing the Catalog/Items API method_\\n\\n\\nThe Swagger UI API detail sho\", \"ws a sample of the response and can be used to execute the real API,\\nwhich is great for developer di\", \"scovery. Figure 6-10 shows the Swagger JSON metadata generated\\nfrom the eShopOnContainers microservi\", \"ce (which is what the tools use underneath) when you request\\n[http://<your-root-url>/swagger/v1/swag\", \"ger.json using Postman.](https://www.getpostman.com/)\\n\\n\\n115 CHAPTER 5 | Designing and Developing Mul\", \"ti-Container and Microservice-Based .NET Applications\\n\\n\\n_Figure 6-10. Swagger JSON metadata_\\n\\n\\nIt is\", \" that simple. And because it is automatically generated, the Swagger metadata will grow when you\\nadd\", \" more functionality to your API.\\n\\n\\n**Additional resources**\\n\\n\\n  - **ASP.NET Web API Help Pages using\", \" Swagger**\\n[https://learn.microsoft.com/aspnet/core/tutorials/web-api-help-pages-using-swagger](http\", \"s://docs.microsoft.com/aspnet/core/tutorials/web-api-help-pages-using-swagger)\\n\\n\\n  - **Get started w\", \"ith Swashbuckle and ASP.NET Core**\\n[https://learn.microsoft.com/aspnet/core/tutorials/getting-starte\", \"d-with-swashbuckle](https://docs.microsoft.com/aspnet/core/tutorials/getting-started-with-swashbuckl\", \"e)\\n\\n\\n  - **Get started with NSwag and ASP.NET Core**\\n[https://learn.microsoft.com/aspnet/core/tutori\", \"als/getting-started-with-nswag](https://docs.microsoft.com/aspnet/core/tutorials/getting-started-wit\", \"h-nswag)\\n\\n### Defining your multi-container application with docker-compose.yml\\n\\n\\n[In this guide, th\", \"e docker-compose.yml file was introduced in the section Step 4. Define your services](https://docs.d\", \"ocker.com/compose/compose-file/)\\nin docker-compose.yml when building a multi-container Docker applic\", \"ation. However, there are\\nadditional ways to use the docker-compose files that are worth exploring i\", \"n further detail.\\n\\n\\nFor example, you can explicitly describe how you want to deploy your multi-conta\", \"iner application in\\nthe docker-compose.yml file. Optionally, you can also describe how you are going\", \" to build your\\ncustom Docker images. (Custom Docker images can also be built with the Docker CLI.)\\n\\n\", \"\\n116 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\", \"\\nBasically, you define each of the containers you want to deploy plus certain characteristics for ea\", \"ch\\ncontainer deployment. Once you have a multi-container deployment description file, you can deploy\", \"\\n[the whole solution in a single action orchestrated by the docker-compose up](https://docs.docker.c\", \"om/compose/overview/) CLI command, or you\\ncan deploy it transparently from Visual Studio. Otherwise,\", \" you would need to use the Docker CLI to\\ndeploy container-by-container in multiple steps by using th\", \"e docker run command from the\\ncommand line. Therefore, each service defined in docker-compose.yml mu\", \"st specify exactly one\\nimage or build. Other keys are optional, and are analogous to their docker ru\", \"n command-line\\ncounterparts.\\n\\n\\nThe following YAML code is the definition of a possible global but si\", \"ngle docker-compose.yml file for\\nthe eShopOnContainers sample. This code is not the actual docker-co\", \"mpose file from\\neShopOnContainers. Instead, it is a simplified and consolidated version in a single \", \"file, which is not the\\nbest way to work with docker-compose files, as will be explained later.\\n\\n\\n117\", \" CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nThe\", \" root key in this file is services. Under that key, you define the services you want to deploy and r\", \"un\\nwhen you execute the docker-compose up command or when you deploy from Visual Studio by using\\nthi\", \"s docker-compose.yml file. In this case, the docker-compose.yml file has multiple services defined,\\n\", \"as described in the following table.\\n\\n|Service name|Description|\\n|---|---|\\n|webmvc|Container includi\", \"ng the ASP.NET Core MVC<br>application consuming the microservices from<br>server-side C#|\\n|catalog-\", \"api|Container including the Catalog ASP.NET Core<br>Web API microservice|\\n|ordering-api|Container in\", \"cluding the Ordering ASP.NET<br>Core Web API microservice|\\n|sqldata|Container running SQL Server for\", \" Linux,<br>holding the microservices databases|\\n|basket-api|Container with the Basket ASP.NET Core W\", \"eb<br>API microservice|\\n|basketdata|Container running the REDIS cache service,<br>with the basket da\", \"tabase as a REDIS cache|\\n\\n\\n\\n**A simple Web Service API container**\\n\\n\\nFocusing on a single container,\", \" the catalog-api container-microservice has a straightforward\\ndefinition:\\n\\n\\n118 CHAPTER 5 | Designin\", \"g and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nThis containerized servi\", \"ce has the following basic configuration:\\n\\n\\n  - It is based on the custom **eshop/catalog-api** imag\", \"e. For simplicity\\u2019s sake, there is no\\nbuild: key setting in the file. This means that the image must\", \" have been previously built (with\\ndocker build) or have been downloaded (with the docker pull comman\", \"d) from any Docker\\nregistry.\\n\\n\\n  - It defines an environment variable named ConnectionString with th\", \"e connection string to be\\nused by Entity Framework to access the SQL Server instance that contains t\", \"he catalog data\\nmodel. In this case, the same SQL Server container is holding multiple databases. Th\", \"erefore,\\nyou need less memory in your development machine for Docker. However, you could also\\ndeploy\", \" one SQL Server container for each microservice database.\\n\\n\\n  - The SQL Server name is **sqldata**, \", \"which is the same name used for the container that is\\nrunning the SQL Server instance for Linux. Thi\", \"s is convenient; being able to use this name\\nresolution (internal to the Docker host) will resolve t\", \"he network address so you don\\u2019t need to\\nknow the internal IP for the containers you are accessing fr\", \"om other containers.\\n\\n\\nBecause the connection string is defined by an environment variable, you coul\", \"d set that variable\\nthrough a different mechanism and at a different time. For example, you could se\", \"t a different\\nconnection string when deploying to production in the final hosts, or by doing it from\", \" your CI/CD\\npipelines in Azure DevOps Services or your preferred DevOps system.\\n\\n\\n  - It exposes por\", \"t 80 for internal access to the **catalog-api** service within the Docker host. The\\nhost is currentl\", \"y a Linux VM because it is based on a Docker image for Linux, but you could\\nconfigure the container \", \"to run on a Windows image instead.\\n\\n\\n  - It forwards the exposed port 80 on the container to port 51\", \"01 on the Docker host machine\\n(the Linux VM).\\n\\n\\n  - It links the web service to the **sqldata** serv\", \"ice (the SQL Server instance for Linux database\\nrunning in a container). When you specify this depen\", \"dency, the catalog-api container will not\\nstart until the sqldata container has already started; thi\", \"s aspect is important because catalogapi needs to have the SQL Server database up and running first.\", \" However, this kind of\\ncontainer dependency is not enough in many cases, because Docker checks only \", \"at the\\ncontainer level. Sometimes the service (in this case SQL Server) might still not be ready, so\", \" it is\\nadvisable to implement retry logic with exponential backoff in your client microservices. Tha\", \"t\\nway, if a dependency container is not ready for a short time, the application will still be\\nresili\", \"ent.\\n\\n\\n  - It is configured to allow access to external servers: the extra_hosts setting allows you \", \"to access\\nexternal servers or machines outside of the Docker host (that is, outside the default Linu\", \"x VM,\\n\\n\\n119 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applica\", \"tions\\n\\n\\nwhich is a development Docker host), such as a local SQL Server instance on your\\ndevelopment\", \" PC.\\n\\n\\nThere are also other, more advanced docker-compose.yml settings that we\\u2019ll discuss in the fol\", \"lowing\\nsections.\\n\\n\\n**Using docker-compose files to target multiple environments**\\n\\n\\nThe docker-compo\", \"se.*.yml files are definition files and can be used by multiple infrastructures that\\nunderstand that\", \" format. The most straightforward tool is the docker-compose command.\\n\\n\\nTherefore, by using the dock\", \"er-compose command you can target the following main scenarios.\\n\\n\\n**Development environments**\\n\\n\\nWhe\", \"n you develop applications, it is important to be able to run an application in an isolated\\ndevelopm\", \"ent environment. You can use the docker-compose CLI command to create that\\nenvironment or Visual Stu\", \"dio, which uses docker-compose under the covers.\\n\\n\\nThe docker-compose.yml file allows you to configu\", \"re and document all your application\\u2019s service\\ndependencies (other services, cache, databases, queue\", \"s, etc.). Using the docker-compose CLI\\ncommand, you can create and start one or more containers for \", \"each dependency with a single\\ncommand (docker-compose up).\\n\\n\\nThe docker-compose.yml files are config\", \"uration files interpreted by Docker engine but also serve as\\nconvenient documentation files about th\", \"e composition of your multi-container application.\\n\\n\\n**Testing environments**\\n\\n\\nAn important part of\", \" any continuous deployment (CD) or continuous integration (CI) process are the\\nunit tests and integr\", \"ation tests. These automated tests require an isolated environment so they are\\nnot impacted by the u\", \"sers or any other change in the application\\u2019s data.\\n\\n\\nWith Docker Compose, you can create and destro\", \"y that isolated environment very easily in a few\\ncommands from your command prompt or scripts, like \", \"the following commands:\\n\\n```\\ndocker-compose -f docker-compose.yml -f docker-compose-test.override.ym\", \"l up -d\\n./run_unit_tests\\ndocker-compose -f docker-compose.yml -f docker-compose-test.override.yml do\", \"wn\\n\\n```\\n\\n**Production deployments**\\n\\n\\nYou can also use Compose to deploy to a remote Docker Engine. \", \"A typical case is to deploy to a\\n[single Docker host instance (like a production VM or server provis\", \"ioned with Docker Machine).](https://docs.docker.com/machine/overview/)\\n\\n\\nIf you are using any other\", \" orchestrator (Azure Service Fabric, Kubernetes, etc.), you might need to add\\nsetup and metadata con\", \"figuration settings like those in docker-compose.yml, but in the format\\nrequired by the other orches\", \"trator.\\n\\n\\nIn any case, docker-compose is a convenient tool and metadata format for development, test\", \"ing and\\nproduction workflows, although the production workflow might vary on the orchestrator you ar\", \"e\\nusing.\\n\\n\\n120 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Appl\", \"ications\\n\\n\\n**Using multiple docker-compose files to handle several environments**\\n\\n\\nWhen targeting d\", \"ifferent environments, you should use multiple compose files. This approach lets you\\ncreate multiple\", \" configuration variants depending on the environment.\\n\\n\\n**Overriding the base docker-compose file**\\n\", \"\\n\\nYou could use a single docker-compose.yml file as in the simplified examples shown in previous\\nsec\", \"tions. However, that is not recommended for most applications.\\n\\n\\nBy default, Compose reads two files\", \", a docker-compose.yml and an optional dockercompose.override.yml file. As shown in Figure 6-11, whe\", \"n you are using Visual Studio and enabling\\nDocker support, Visual Studio also creates an additional \", \"docker-compose.vs.debug.g.yml file for\\ndebugging the application, you can take a look at this file i\", \"n folder obj\\\\Docker\\\\ in the main solution\\nfolder.\\n\\n\\n_Figure 6-11. docker-compose files in Visual Stu\", \"dio 2019_\\n\\n\\n**docker-compose** project file structure:\\n\\n\\n  - _.dockerignore_  - used to ignore files\", \"\\n\\n  - _docker-compose.yml_  - used to compose microservices\\n\\n  - _docker-compose.override.yml_  - us\", \"ed to configure microservices environment\\n\\n\\nYou can edit the docker-compose files with any editor, l\", \"ike Visual Studio Code or Sublime, and run the\\napplication with the docker-compose up command.\\n\\n\\nBy \", \"convention, the docker-compose.yml file contains your base configuration and other static\\nsettings. \", \"That means that the service configuration should not change depending on the deployment\\nenvironment \", \"you are targeting.\\n\\n\\nThe docker-compose.override.yml file, as its name suggests, contains configurat\", \"ion settings that\\noverride the base configuration, such as configuration that depends on the deploym\", \"ent environment.\\nYou can have multiple override files with different names also. The override files \", \"usually contain\\nadditional information needed by the application but specific to an environment or t\", \"o a deployment.\\n\\n\\n**Targeting multiple environments**\\n\\n\\nA typical use case is when you define multip\", \"le compose files so you can target multiple environments,\\nlike production, staging, CI, or developme\", \"nt. To support these differences, you can split your\\nCompose configuration into multiple files, as s\", \"hown in Figure 6-12.\\n\\n\\n121 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Bas\", \"ed .NET Applications\\n\\n\\n_Figure 6-12. Multiple docker-compose files overriding values in the base doc\", \"ker-compose.yml file_\\n\\n\\nYou can combine multiple docker-compose*.yml files to handle different envir\", \"onments. You start with\\nthe base docker-compose.yml file. This base file contains the base or static\", \" configuration settings that\\ndo not change depending on the environment. For example, the eShopOnCon\", \"tainers app has the\\nfollowing docker-compose.yml file (simplified with fewer services) as the base f\", \"ile.\\n\\n\\n122 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applicat\", \"ions\\n\\n\\nThe values in the base docker-compose.yml file should not change because of different target\\n\", \"deployment environments.\\n\\n\\nIf you focus on the webmvc service definition, for instance, you can see \", \"how that information is much\\nthe same no matter what environment you might be targeting. You have th\", \"e following information:\\n\\n\\n  - The service name: webmvc.\\n\\n\\n  - The container\\u2019s custom image: eshop/w\", \"ebmvc.\\n\\n\\n  - The command to build the custom Docker image, indicating which Dockerfile to use.\\n\\n\\n  -\", \" Dependencies on other services, so this container does not start until the other dependency\\ncontain\", \"ers have started.\\n\\n\\nYou can have additional configuration, but the important point is that in the ba\", \"se dockercompose.yml file, you just want to set the information that is common across environments. \", \"Then in\\nthe docker-compose.override.yml or similar files for production or staging, you should place\", \"\\nconfiguration that is specific for each environment.\\n\\n\\nUsually, the docker-compose.override.yml is \", \"used for your development environment, as in the\\nfollowing example from eShopOnContainers:\\n\\n\\n123 CHA\", \"PTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n124 CHA\", \"PTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nIn this\", \" example, the development override configuration exposes some ports to the host, defines\\nenvironment\", \" variables with redirect URLs, and specifies connection strings for the development\\nenvironment. The\", \"se settings are all just for the development environment.\\n\\n\\nWhen you run docker-compose up (or launc\", \"h it from Visual Studio), the command reads the overrides\\nautomatically as if it were merging both f\", \"iles.\\n\\n\\nSuppose that you want another Compose file for the production environment, with different\\nco\", \"nfiguration values, ports, or connection strings. You can create another override file, like file na\", \"med\\ndocker-compose.prod.yml with different settings and environment variables. That file might be st\", \"ored\\nin a different Git repo or managed and secured by a different team.\\n\\n\\n**How to deploy with a sp\", \"ecific override file**\\n\\n\\nTo use multiple override files, or an override file with a different name, \", \"you can use the -f option with\\nthe docker-compose command and specify the files. Compose merges file\", \"s in the order they are\\nspecified on the command line. The following example shows how to deploy wit\", \"h override files.\\n\\n```\\ndocker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d\\n\\n```\\n\\n1\", \"25 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n*\", \"*Using environment variables in docker-compose files**\\n\\n\\nIt is convenient, especially in production \", \"environments, to be able to get configuration information\\nfrom environment variables, as we have sho\", \"wn in previous examples. You can reference an\\nenvironment variable in your docker-compose files usin\", \"g the syntax ${MY_VAR}. The following line\\nfrom a docker-compose.prod.yml file shows how to referenc\", \"e the value of an environment variable.\\n\\n```\\nIdentityUrl=http://${ESHOP_PROD_EXTERNAL_DNS_NAME_OR_IP\", \"}:5105\\n\\n```\\n\\nEnvironment variables are created and initialized in different ways, depending on your \", \"host\\nenvironment (Linux, Windows, Cloud cluster, etc.). However, a convenient approach is to use an \", \".env\\nfile. The docker-compose files support declaring default environment variables in the .env file\", \". These\\nvalues for the environment variables are the default values. But they can be overridden by t\", \"he values\\nyou might have defined in each of your environments (host OS or environment variables from\", \" your\\ncluster). You place this .env file in the folder where the docker-compose command is executed \", \"from.\\n\\n\\n[The following example shows an .env file like the .env](https://github.com/dotnet-architect\", \"ure/eShopOnContainers/blob/main/src/.env) file for the eShopOnContainers application.\\n\\n\\nDocker-compo\", \"se expects each line in an .env file to be in the format <variable>=<value>.\\n\\n\\nThe values set in the\", \" run-time environment always override the values defined inside the .env file. In a\\nsimilar way, val\", \"ues passed via command-line arguments also override the default values set in the .env\\nfile.\\n\\n\\n**Add\", \"itional resources**\\n\\n\\n  - **Overview of Docker Compose**\\n[https://docs.docker.com/compose/overview/]\", \"(https://docs.docker.com/compose/overview/)\\n\\n\\n  - **Multiple Compose files**\\n[https://docs.docker.co\", \"m/compose/multiple-compose-files/](https://docs.docker.com/compose/multiple-compose-files/)\\n\\n\\n**Buil\", \"ding optimized ASP.NET Core Docker images**\\n\\n\\nIf you are exploring Docker and .NET on sources on the\", \" Internet, you will find Dockerfiles that\\ndemonstrate the simplicity of building a Docker image by c\", \"opying your source into a container. These\\nexamples suggest that by using a simple configuration, yo\", \"u can have a Docker image with the\\nenvironment packaged with your application. The following example\", \" shows a simple Dockerfile in this\\nvein.\\n\\n\\n126 CHAPTER 5 | Designing and Developing Multi-Container \", \"and Microservice-Based .NET Applications\\n\\n\\nA Dockerfile like this will work. However, you can substa\", \"ntially optimize your images, especially your\\nproduction images.\\n\\n\\nIn the container and microservice\", \"s model, you are constantly starting containers. The typical way of\\nusing containers does not restar\", \"t a sleeping container, because the container is disposable.\\nOrchestrators (like Kubernetes and Azur\", \"e Service Fabric) create new instances of images. What this\\nmeans is that you would need to optimize\", \" by precompiling the application when it is built so the\\ninstantiation process will be faster. When \", \"the container is started, it should be ready to run. Don\\u2019t\\nrestore and compile at run time using the\", \" dotnet restore and dotnet build CLI commands as you may\\nsee in blog posts about .NET and Docker.\\n\\n\\n\", \"The .NET team has been doing important work to make .NET and ASP.NET Core a container-optimized\\nfram\", \"ework. Not only is .NET a lightweight framework with a small memory footprint; the team has\\nfocused \", \"on optimized Docker images for three main scenarios and published them in the Docker Hub\\nregistry at\", \" _dotnet/_, beginning with version 2.1:\\n\\n\\n1. **Development** : The priority is the ability to quickl\", \"y iterate and debug changes, and where size\\nis secondary.\\n\\n\\n2. **Build** : The priority is compiling\", \" the application, and the image includes binaries and other\\ndependencies to optimize binaries.\\n\\n\\n3. \", \"**Production** : The focus is fast deploying and starting of containers, so these images are\\nlimited\", \" to the binaries and content needed to run the application.\\n\\n\\n[The .NET team provides four basic var\", \"iants in dotnet/ (at Docker Hub):](https://hub.docker.com/_/microsoft-dotnet/)\\n\\n\\n1. **sdk** : for de\", \"velopment and build scenarios\\n\\n2. **aspnet** : for ASP.NET production scenarios\\n\\n3. **runtime** : fo\", \"r .NET production scenarios\\n\\n4. **runtime-deps** [: for production scenarios of self-contained appli\", \"cations](https://docs.microsoft.com/dotnet/core/deploying/index#publish-self-contained)\\n\\n\\nFor faster\", \" startup, runtime images also automatically set aspnetcore_urls to port 80 and use Ngen to\\ncreate a \", \"native image cache of assemblies.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Building Optimized Docker Image\", \"s with ASP.NET Core**\\n[https://learn.microsoft.com/archive/blogs/stevelasker/building-optimized-dock\", \"er-images-](https://docs.microsoft.com/archive/blogs/stevelasker/building-optimized-docker-images-wi\", \"th-asp-net-core)\\n[with-asp-net-core](https://docs.microsoft.com/archive/blogs/stevelasker/building-o\", \"ptimized-docker-images-with-asp-net-core)\\n\\n\\n  - **Building Docker Images for .NET Applications**\\n[ht\", \"tps://learn.microsoft.com/dotnet/core/docker/building-net-docker-images](https://docs.microsoft.com/\", \"aspnet/core/host-and-deploy/docker/building-net-docker-images)\\n\\n### Use a database server running as\", \" a container\\n\\n\\nYou can have your databases (SQL Server, PostgreSQL, MySQL, etc.) on regular standalo\", \"ne servers, in\\non-premises clusters, or in PaaS services in the cloud like Azure SQL DB. However, fo\", \"r development\\nand test environments, having your databases running as containers is convenient, beca\", \"use you don\\u2019t\\n\\n\\n127 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET\", \" Applications\\n\\n\\nhave any external dependency and simply running the docker-compose up command starts\", \" the whole\\napplication. Having those databases as containers is also great for integration tests, be\", \"cause the\\ndatabase is started in the container and is always populated with the same sample data, so\", \" tests can\\nbe more predictable.\\n\\n#### **SQL Server running as a container with a microservice-relate\", \"d** **database**\\n\\n\\n[In eShopOnContainers, there\\u2019s a container named sqldata, as defined in the docke\", \"r-compose.yml file,](https://github.com/dotnet-architecture/eShopOnContainers/blob/main/src/docker-c\", \"ompose.yml)\\nthat runs a SQL Server for Linux instance with the SQL databases for all microservices t\", \"hat need one.\\n\\n\\nA key point in microservices is that each microservice owns its related data, so it \", \"should have its own\\ndatabase. However, the databases can be anywhere. In this case, they are all in \", \"the same container to\\nkeep Docker memory requirements as low as possible. Keep in mind that this is \", \"a good-enough\\nsolution for development and, perhaps, testing but not for production.\\n\\n\\nThe SQL Serve\", \"r container in the sample application is configured with the following YAML code in the\\ndocker-compo\", \"se.yml file, which is executed when you run docker-compose up. Note that the YAML\\ncode has consolida\", \"ted configuration information from the generic docker-compose.yml file and the\\ndocker-compose.overri\", \"de.yml file. (Usually you would separate the environment settings from the\\nbase or static informatio\", \"n related to the SQL Server image.)\\n\\n\\nIn a similar way, instead of using docker-compose, the followi\", \"ng docker run command can run that\\ncontainer:\\n\\n\\nHowever, if you are deploying a multi-container appl\", \"ication like eShopOnContainers, it is more\\nconvenient to use the docker-compose up command so that i\", \"t deploys all the required containers for\\nthe application.\\n\\n\\nWhen you start this SQL Server containe\", \"r for the first time, the container initializes SQL Server with the\\npassword that you provide. Once \", \"SQL Server is running as a container, you can update the database\\nby connecting through any regular \", \"SQL connection, such as from SQL Server Management Studio,\\nVisual Studio, or C# code.\\n\\n\\nThe eShopOnC\", \"ontainers application initializes each microservice database with sample data by\\nseeding it with dat\", \"a on startup, as explained in the following section.\\n\\n\\nHaving SQL Server running as a container is n\", \"ot just useful for a demo where you might not have\\naccess to an instance of SQL Server. As noted, it\", \" is also great for development and testing\\n\\n\\n128 CHAPTER 5 | Designing and Developing Multi-Containe\", \"r and Microservice-Based .NET Applications\\n\\n\\nenvironments so that you can easily run integration tes\", \"ts starting from a clean SQL Server image and\\nknown data by seeding new sample data.\\n\\n\\n**Additional \", \"resources**\\n\\n\\n  - **Run the SQL Server Docker image on Linux, Mac, or Windows**\\n[https://learn.micro\", \"soft.com/sql/linux/sql-server-linux-setup-docker](https://docs.microsoft.com/sql/linux/sql-server-li\", \"nux-setup-docker)\\n\\n\\n  - **Connect and query SQL Server on Linux with sqlcmd**\\n[https://learn.microso\", \"ft.com/sql/linux/sql-server-linux-connect-and-query-sqlcmd](https://docs.microsoft.com/sql/linux/sql\", \"-server-linux-connect-and-query-sqlcmd)\\n\\n#### **Seeding with test data on Web application startup**\\n\", \"\\n\\nTo add data to the database when the application starts up, you can add code like the following to\", \"\\nthe Main method in the Program class of the Web API project:\\n\\n\\n129 CHAPTER 5 | Designing and Develo\", \"ping Multi-Container and Microservice-Based .NET Applications\\n\\n\\nThere\\u2019s an important caveat when app\", \"lying migrations and seeding a database during container\\nstartup. Since the database server might no\", \"t be available for whatever reason, you must handle retries\\nwhile waiting for the server to be avail\", \"able. This retry logic is handled by the MigrateDbContext()\\nextension method, as shown in the follow\", \"ing code:\\n\\n\\n130 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET App\", \"lications\\n\\n\\nThe following code in the custom CatalogContextSeed class populates the data.\\n\\n\\nWhen you\", \" run integration tests, having a way to generate data consistent with your integration tests is\\nusef\", \"ul. Being able to create everything from scratch, including an instance of SQL Server running on a\\nc\", \"ontainer, is great for test environments.\\n\\n\\n131 CHAPTER 5 | Designing and Developing Multi-Container\", \" and Microservice-Based .NET Applications\\n\\n\\n#### **EF Core InMemory database versus SQL Server runni\", \"ng as a container**\\n\\nAnother good choice when running tests is to use the Entity Framework InMemory \", \"database provider.\\nYou can specify that configuration in the ConfigureServices method of the Startup\", \" class in your Web\\nAPI project:\\n\\n\\nThere is an important catch, though. The in-memory database does n\", \"ot support many constraints that\\nare specific to a particular database. For instance, you might add \", \"a unique index on a column in your\\nEF Core model and write a test against your in-memory database to\", \" check that it does not let you add\\na duplicate value. But when you are using the in-memory database\", \", you cannot handle unique indexes\\non a column. Therefore, the in-memory database does not behave ex\", \"actly the same as a real SQL\\nServer database\\u2014it does not emulate database-specific constraints.\\n\\n\\nEv\", \"en so, an in-memory database is still useful for testing and prototyping. But if you want to create\\n\", \"accurate integration tests that take into account the behavior of a specific database implementation\", \",\\nyou need to use a real database like SQL Server. For that purpose, running SQL Server in a contain\", \"er is\\na great choice and more accurate than the EF Core InMemory database provider.\\n\\n#### **Using a \", \"Redis cache service running in a container**\\n\\n\\nYou can run Redis on a container, especially for deve\", \"lopment and testing and for proof-of-concept\\nscenarios. This scenario is convenient, because you can\", \" have all your dependencies running on\\ncontainers\\u2014not just for your local development machines, but \", \"for your testing environments in your\\nCI/CD pipelines.\\n\\n\\nHowever, when you run Redis in production, \", \"it is better to look for a high-availability solution like\\nRedis Microsoft Azure, which runs as a Pa\", \"aS (Platform as a Service). In your code, you just need to\\nchange your connection strings.\\n\\n\\nRedis p\", \"rovides a Docker image with Redis. That image is available from Docker Hub at this URL:\\n\\n\\n[https://h\", \"ub.docker.com/_/redis/](https://hub.docker.com/_/redis/)\\n\\n\\n132 CHAPTER 5 | Designing and Developing \", \"Multi-Container and Microservice-Based .NET Applications\\n\\n\\nYou can directly run a Docker Redis conta\", \"iner by executing the following Docker CLI command in your\\ncommand prompt:\\n\\n```\\ndocker run --name so\", \"me-redis -d redis\\n\\n```\\n\\nThe Redis image includes expose:6379 (the port used by Redis), so standard c\", \"ontainer linking will\\nmake it automatically available to the linked containers.\\n\\n\\nIn eShopOnContaine\", \"rs, the basket-api microservice uses a Redis cache running as a container. That\\nbasketdata container\", \" is defined as part of the multi-container _docker-compose.yml_ file, as shown in the\\nfollowing exam\", \"ple:\\n\\n\\nThis code in the docker-compose.yml defines a container named basketdata based on the redis i\", \"mage\\nand publishing the port 6379 internally. This configuration means that it will only be accessib\", \"le from\\nother containers running within the Docker host.\\n\\n\\nFinally, in the _docker-compose.override.\", \"yml_ file, the basket-api microservice for the\\neShopOnContainers sample defines the connection strin\", \"g to use for that Redis container:\\n\\n\\nAs mentioned before, the name of the microservice basketdata is\", \" resolved by Docker\\u2019s internal\\nnetwork DNS.\\n\\n### Implementing event-based communication between micr\", \"oservices (integration events)\\n\\n\\nAs described earlier, when you use event-based communication, a mic\", \"roservice publishes an event\\nwhen something notable happens, such as when it updates a business enti\", \"ty. Other microservices\\nsubscribe to those events. When a microservice receives an event, it can upd\", \"ate its own business\\nentities, which might lead to more events being published. This is the essence \", \"of the eventual\\nconsistency concept. This publish/subscribe system is usually performed by using an \", \"implementation\\nof an event bus. The event bus can be designed as an interface with the API needed to\", \" subscribe and\\nunsubscribe to events and to publish events. It can also have one or more implementat\", \"ions based on\\nany inter-process or messaging communication, such as a messaging queue or a service b\", \"us that\\nsupports asynchronous communication and a publish/subscribe model.\\n\\n\\nYou can use events to i\", \"mplement business transactions that span multiple services, which give you\\neventual consistency betw\", \"een those services. An eventually consistent transaction consists of a series\\n\\n\\n133 CHAPTER 5 | Desi\", \"gning and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nof distributed actio\", \"ns. At each action, the microservice updates a business entity and publishes an\\nevent that triggers \", \"the next action. Figure 6-18 below, shows a PriceUpdated event published through\\nan event bus, so th\", \"e price update is propagated to the Basket and other microservices.\\n\\n\\n_Figure 6-18. Event-driven com\", \"munication based on an event bus_\\n\\n\\nThis section describes how you can implement this type of commun\", \"ication with .NET by using a\\ngeneric event bus interface, as shown in Figure 6-18. There are multipl\", \"e potential implementations,\\neach using a different technology or infrastructure such as RabbitMQ, A\", \"zure Service Bus, or any other\\nthird-party open-source or commercial service bus.\\n\\n#### **Using mess\", \"age brokers and service buses for production systems**\\n\\n\\nAs noted in the architecture section, you c\", \"an choose from multiple messaging technologies for\\nimplementing your abstract event bus. But these t\", \"echnologies are at different levels. For instance,\\nRabbitMQ, a messaging broker transport, is at a l\", \"ower level than commercial products like Azure\\nService Bus, NServiceBus, MassTransit, or Brighter. M\", \"ost of these products can work on top of either\\nRabbitMQ or Azure Service Bus. Your choice of produc\", \"t depends on how many features and how\\nmuch out-of-the-box scalability you need for your application\", \".\\n\\n\\nFor implementing just an event bus proof-of-concept for your development environment, as in the\\n\", \"eShopOnContainers sample, a simple implementation on top of RabbitMQ running as a container\\nmight be\", \" enough. But for mission-critical and production systems that need high scalability, you\\nmight want \", \"to evaluate and use Azure Service Bus.\\n\\n\\n[If you require high-level abstractions and richer features\", \" like Sagas for long-running processes that](https://docs.particular.net/nservicebus/sagas/)\\nmake di\", \"stributed development easier, other commercial and open-source service buses like\\nNServiceBus, MassT\", \"ransit, and Brighter are worth evaluating. In this case, the abstractions and API to\\nuse would usual\", \"ly be directly the ones provided by those high-level service buses instead of your own\\n[abstractions\", \" (like the simple event bus abstractions provided at eShopOnContainers). For that matter,](https://g\", \"ithub.com/dotnet-architecture/eShopOnContainers/blob/dev/src/BuildingBlocks/EventBus/EventBus/Abstra\", \"ctions/IEventBus.cs)\\n\\n\\n134 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Bas\", \"ed .NET Applications\\n\\n\\n[you can research the forked eShopOnContainers using NServiceBus](https://go.\", \"particular.net/eShopOnContainers) (additional derived sample\\nimplemented by Particular Software).\\n\\n\\n\", \"Of course, you could always build your own service bus features on top of lower-level technologies\\nl\", \"ike RabbitMQ and Docker, but the work needed to \\u201creinvent the wheel\\u201d might be too costly for a\\ncusto\", \"m enterprise application.\\n\\n\\nTo reiterate: the sample event bus abstractions and implementation showc\", \"ased in the\\neShopOnContainers sample are intended to be used only as a proof of concept. Once you ha\", \"ve\\ndecided that you want to have asynchronous and event-driven communication, as explained in the\\ncu\", \"rrent section, you should choose the service bus product that best fits your needs for production.\\n\\n\", \"#### **Integration events**\\n\\n\\nIntegration events are used for bringing domain state in sync across m\", \"ultiple microservices or external\\nsystems. This functionality is done by publishing integration even\", \"ts outside the microservice. When an\\nevent is published to multiple receiver microservices (to as ma\", \"ny microservices as are subscribed to\\nthe integration event), the appropriate event handler in each \", \"receiver microservice handles the event.\\n\\n\\nAn integration event is basically a data-holding class, a\", \"s in the following example:\\n\\n\\nThe integration events can be defined at the application level of each\", \" microservice, so they are\\ndecoupled from other microservices, in a way comparable to how ViewModels\", \" are defined in the\\nserver and client. What is not recommended is sharing a common integration event\", \"s library across\\nmultiple microservices; doing that would be coupling those microservices with a sin\", \"gle event\\ndefinition data library. You do not want to do that for the same reasons that you do not w\", \"ant to share\\na common domain model across multiple microservices: microservices must be completely\\n[\", \"autonomous. For more information, see this blog post on the amount of data to put in events. Be](htt\", \"ps://particular.net/blog/putting-your-events-on-a-diet)\\n[careful not to take this too far, as this o\", \"ther blog post describes the problem data deficient messages](https://ardalis.com/data-deficient-mes\", \"sages/)\\n[can produce. Your design of your events should aim to be \\u201cjust right\\u201d for the needs of thei\", \"r](https://ardalis.com/data-deficient-messages/)\\nconsumers.\\n\\n\\nThere are only a few kinds of librarie\", \"s you should share across microservices. One is libraries that are\\n[final application blocks, like t\", \"he Event Bus client API, as in eShopOnContainers. Another is libraries](https://github.com/dotnet-ar\", \"chitecture/eShopOnContainers/tree/main/src/BuildingBlocks/EventBus)\\nthat constitute tools that could\", \" also be shared as NuGet components, like JSON serializers.\\n\\n\\n135 CHAPTER 5 | Designing and Developi\", \"ng Multi-Container and Microservice-Based .NET Applications\\n\\n\\n#### **The event bus**\\n\\nAn event bus a\", \"llows publish/subscribe-style communication between microservices without requiring\\nthe components t\", \"o explicitly be aware of each other, as shown in Figure 6-19.\\n\\n\\n_Figure 6-19. Publish/subscribe basi\", \"cs with an event bus_\\n\\n\\nThe above diagram shows that microservice A publishes to Event Bus, which di\", \"stributes to subscribing\\nmicroservices B and C, without the publisher needing to know the subscriber\", \"s. The event bus is\\nrelated to the Observer pattern and the publish-subscribe pattern.\\n\\n\\n**Observer \", \"pattern**\\n\\n\\n[In the Observer pattern, your primary object (known as the Observable) notifies other i\", \"nterested](https://en.wikipedia.org/wiki/Observer_pattern)\\nobjects (known as Observers) with relevan\", \"t information (events).\\n\\n\\n**Publish/Subscribe (Pub/Sub) pattern**\\n\\n\\n[The purpose of the Publish/Subs\", \"cribe pattern is the same as the Observer pattern: you want to notify](https://docs.microsoft.com/pr\", \"evious-versions/msp-n-p/ff649664(v=pandp.10))\\nother services when certain events take place. But the\", \"re is an important difference between the\\nObserver and Pub/Sub patterns. In the observer pattern, th\", \"e broadcast is performed directly from the\\nobservable to the observers, so they \\u201cknow\\u201d each other. B\", \"ut when using a Pub/Sub pattern, there is a\\nthird component, called broker, or message broker or eve\", \"nt bus, which is known by both the\\npublisher and subscriber. Therefore, when using the Pub/Sub patte\", \"rn the publisher and the\\nsubscribers are precisely decoupled thanks to the mentioned event bus or me\", \"ssage broker.\\n\\n\\n**The middleman or event bus**\\n\\n\\nHow do you achieve anonymity between publisher and \", \"subscriber? An easy way is let a middleman\\ntake care of all the communication. An event bus is one s\", \"uch middleman.\\n\\n\\nAn event bus is typically composed of two parts:\\n\\n\\n  - The abstraction or interface\", \".\\n\\n\\n  - One or more implementations.\\n\\n\\n136 CHAPTER 5 | Designing and Developing Multi-Container and \", \"Microservice-Based .NET Applications\\n\\n\\nIn Figure 6-19 you can see how, from an application point of \", \"view, the event bus is nothing more than\\na Pub/Sub channel. The way you implement this asynchronous \", \"communication can vary. It can have\\nmultiple implementations so that you can swap between them, depe\", \"nding on the environment\\nrequirements (for example, production versus development environments).\\n\\n\\nI\", \"n Figure 6-20, you can see an abstraction of an event bus with multiple implementations based on\\ninf\", \"rastructure messaging technologies like RabbitMQ, Azure Service Bus, or another event/message\\nbroker\", \".\\n\\n\\n_Figure 6- 20. Multiple implementations of an event bus_\\n\\n\\nIt\\u2019s good to have the event bus defin\", \"ed through an interface so it can be implemented with several\\ntechnologies, like RabbitMQ, Azure Ser\", \"vice bus or others. However, and as mentioned previously,\\nusing your own abstractions (the event bus\", \" interface) is good only if you need basic event bus\\nfeatures supported by your abstractions. If you\", \" need richer service bus features, you should probably\\nuse the API and abstractions provided by your\", \" preferred commercial service bus instead of your own\\nabstractions.\\n\\n\\n**Defining an event bus interf\", \"ace**\\n\\n\\nLet\\u2019s start with some implementation code for the event bus interface and possible implement\", \"ations\\nfor exploration purposes. The interface should be generic and straightforward, as in the foll\", \"owing\\ninterface.\\n\\n\\n137 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .\", \"NET Applications\\n\\n\\nThe Publish method is straightforward. The event bus will broadcast the integrati\", \"on event passed to it\\nto any microservice, or even an external application, subscribed to that event\", \". This method is used by\\nthe microservice that is publishing the event.\\n\\n\\nThe Subscribe methods (you\", \" can have several implementations depending on the arguments) are\\nused by the microservices that wan\", \"t to receive events. This method has two arguments. The first is the\\nintegration event to subscribe \", \"to (IntegrationEvent). The second argument is the integration event\\nhandler (or callback method), na\", \"med IIntegrationEventHandler<T>, to be executed when the receiver\\nmicroservice gets that integration\", \" event message.\\n\\n#### **Additional resources**\\n\\n\\nSome production-ready messaging solutions:\\n\\n\\n  - **\", \"Azure Service Bus**\\n[https://learn.microsoft.com/azure/service-bus-messaging/](https://docs.microsof\", \"t.com/azure/service-bus-messaging/)\\n\\n\\n  - **NServiceBus**\\n[https://particular.net/nservicebus](https\", \"://particular.net/nservicebus)\\n\\n\\n  - **MassTransit**\\n[https://masstransit-project.com/](https://mass\", \"transit-project.com/)\\n\\n### Implementing an event bus with RabbitMQ for the development or test envir\", \"onment\\n\\n\\n[We should start by saying that if you create your custom event bus based on RabbitMQ runni\", \"ng in a](https://www.rabbitmq.com/)\\ncontainer, as the eShopOnContainers application does, it should \", \"be used only for your development\\nand test environments. Don\\u2019t use it for your production environmen\", \"t, unless you are building it as a\\npart of a production-ready service bus as described in the Additi\", \"onal resources section below. A\\nsimple custom event bus might be missing many production-ready criti\", \"cal features that a commercial\\nservice bus has.\\n\\n\\nOne of the event bus custom implementations in eSh\", \"opOnContainers is basically a library using the\\nRabbitMQ API. (There\\u2019s another implementation based \", \"on Azure Service Bus.)\\n\\n\\nThe event bus implementation with RabbitMQ lets microservices subscribe to \", \"events, publish events,\\nand receive events, as shown in Figure 6-21.\\n\\n\\n138 CHAPTER 5 | Designing and\", \" Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n_Figure 6-21. RabbitMQ implem\", \"entation of an event bus_\\n\\n\\nRabbitMQ functions as an intermediary between message publisher and subs\", \"cribers, to handle\\ndistribution. In the code, the EventBusRabbitMQ class implements the generic IEve\", \"ntBus interface.\\nThis implementation is based on Dependency Injection so that you can swap from this\", \" dev/test\\nversion to a production version.\\n\\n\\nThe RabbitMQ implementation of a sample dev/test event \", \"bus is boilerplate code. It has to handle the\\nconnection to the RabbitMQ server and provide code for\", \" publishing a message event to the queues. It\\nalso has to implement a dictionary of collections of i\", \"ntegration event handlers for each event type;\\nthese event types can have a different instantiation \", \"and different subscriptions for each receiver\\nmicroservice, as shown in Figure 6-21.\\n\\n#### **Impleme\", \"nting a simple publish method with RabbitMQ**\\n\\n\\nThe following code is a _**simplified**_ version of \", \"an event bus implementation for RabbitMQ, to\\nshowcase the whole scenario. You don\\u2019t really handle th\", \"e connection this way. To see the full\\n[implementation, see the actual code in the dotnet-architectu\", \"re/eShopOnContainers](https://github.com/dotnet-architecture/eShopOnContainers/blob/main/src/Buildin\", \"gBlocks/EventBus/EventBusRabbitMQ/EventBusRabbitMQ.cs) repository.\\n\\n\\n139 CHAPTER 5 | Designing and D\", \"eveloping Multi-Container and Microservice-Based .NET Applications\\n\\n\\n[The actual code](https://githu\", \"b.com/dotnet-architecture/eShopOnContainers/blob/main/src/BuildingBlocks/EventBus/EventBusRabbitMQ/E\", \"ventBusRabbitMQ.cs) of the Publish method in the eShopOnContainers application is improved by using \", \"a\\n[Polly](https://github.com/App-vNext/Polly) retry policy, which retries the task some times in cas\", \"e the RabbitMQ container is not ready. This\\nscenario can occur when docker-compose is starting the c\", \"ontainers; for example, the RabbitMQ\\ncontainer might start more slowly than the other containers.\\n\\n\\n\", \"As mentioned earlier, there are many possible configurations in RabbitMQ, so this code should be\\nuse\", \"d only for dev/test environments.\\n\\n#### **Implementing the subscription code with the RabbitMQ API**\", \"\\n\\n\\nAs with the publish code, the following code is a simplification of part of the event bus\\nimpleme\", \"ntation for RabbitMQ. Again, you usually do not need to change it unless you are improving\\nit.\\n\\n\\n140\", \" CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nEac\", \"h event type has a related channel to get events from RabbitMQ. You can then have as many event\\nhand\", \"lers per channel and event type as needed.\\n\\n\\nThe Subscribe method accepts an IIntegrationEventHandle\", \"r object, which is like a callback method in\\nthe current microservice, plus its related IntegrationE\", \"vent object. The code then adds that event\\nhandler to the list of event handlers that each integrati\", \"on event type can have per client microservice.\\nIf the client code has not already been subscribed t\", \"o the event, the code creates a channel for the\\nevent type so it can receive events in a push style \", \"from RabbitMQ when that event is published from\\nany other service.\\n\\n\\nAs mentioned above, the event b\", \"us implemented in eShopOnContainers has only an educational\\npurpose, since it only handles the main \", \"scenarios, so it\\u2019s not ready for production.\\n\\n\\nFor production scenarios check the additional resourc\", \"es below, specific for RabbitMQ, and the\\nImplementing event-based communication between microservice\", \"s section.\\n\\n#### **Additional resources**\\n\\n\\nA production-ready solution with support for RabbitMQ.\\n\\n\", \"\\n  - **NServiceBus**  - Fully-supported commercial service bus with advanced management and\\nmonitori\", \"ng tooling for .NET\\n[https://particular.net/](https://particular.net/)\\n\\n\\n  - **EasyNetQ**  - Open So\", \"urce .NET API client for RabbitMQ\\n[https://easynetq.com/](https://easynetq.com/)\\n\\n\\n  - **MassTransit\", \"**  - Free, open-source distributed application framework for .NET\\n[https://masstransit-project.com/\", \"](https://masstransit-project.com/)\\n\\n\\n  - **Rebus**  - Open source .NET Service Bus\\n[https://github.\", \"com/rebus-org/Rebus](https://github.com/rebus-org/Rebus)\\n\\n### Subscribing to events\\n\\n\\nThe first step\", \" for using the event bus is to subscribe the microservices to the events they want to\\nreceive. That \", \"functionality should be done in the receiver microservices.\\n\\n\\nThe following simple code shows what e\", \"ach receiver microservice needs to implement when starting\\nthe service (that is, in the Startup clas\", \"s) so it subscribes to the events it needs. In this case, the basketapi microservice needs to subscr\", \"ibe to ProductPriceChangedIntegrationEvent and the\\nOrderStartedIntegrationEvent messages.\\n\\n\\nFor inst\", \"ance, when subscribing to the ProductPriceChangedIntegrationEvent event, that makes the\\nbasket micro\", \"service aware of any changes to the product price and lets it warn the user about the\\nchange if that\", \" product is in the user\\u2019s basket.\\n\\n\\n141 CHAPTER 5 | Designing and Developing Multi-Container and Mic\", \"roservice-Based .NET Applications\\n\\n\\nAfter this code runs, the subscriber microservice will be listen\", \"ing through RabbitMQ channels. When\\nany message of type ProductPriceChangedIntegrationEvent arrives,\", \" the code invokes the event\\nhandler that is passed to it and processes the event.\\n\\n#### **Publishing\", \" events through the event bus**\\n\\n\\nFinally, the message sender (origin microservice) publishes the in\", \"tegration events with code similar to\\nthe following example. (This approach is a simplified example \", \"that does not take atomicity into\\naccount.) You would implement similar code whenever an event must \", \"be propagated across multiple\\nmicroservices, usually right after committing data or transactions fro\", \"m the origin microservice.\\n\\n\\nFirst, the event bus implementation object (based on RabbitMQ or based \", \"on a service bus) would be\\ninjected at the controller constructor, as in the following code:\\n\\n\\nThen \", \"you use it from your controller\\u2019s methods, like in the UpdateProduct method:\\n\\n\\n142 CHAPTER 5 | Desig\", \"ning and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nIn this case, since t\", \"he origin microservice is a simple CRUD microservice, that code is placed right into\\na Web API contr\", \"oller.\\n\\n\\nIn more advanced microservices, like when using CQRS approaches, it can be implemented in t\", \"he\\nCommandHandler class, within the Handle() method.\\n\\n\\n**Designing atomicity and resiliency when pub\", \"lishing to the event bus**\\n\\n\\nWhen you publish integration events through a distributed messaging sys\", \"tem like your event bus, you\\nhave the problem of atomically updating the original database and publi\", \"shing an event (that is, either\\nboth operations complete or none of them). For instance, in the simp\", \"lified example shown earlier, the\\ncode commits data to the database when the product price is change\", \"d and then publishes a\\nProductPriceChangedIntegrationEvent message. Initially, it might look essenti\", \"al that these two\\noperations be performed atomically. However, if you are using a distributed transa\", \"ction involving the\\n[database and the message broker, as you do in older systems like Microsoft Mess\", \"age Queuing](https://docs.microsoft.com/previous-versions/windows/desktop/legacy/ms711472(v=vs.85))\\n\", \"[(MSMQ), this approach is not recommended for the reasons described by the CAP theorem.](https://doc\", \"s.microsoft.com/previous-versions/windows/desktop/legacy/ms711472(v=vs.85))\\n\\n\\nBasically, you use mic\", \"roservices to build scalable and highly available systems. Simplifying somewhat,\\nthe CAP theorem say\", \"s that you cannot build a (distributed) database (or a microservice that owns its\\nmodel) that\\u2019s cont\", \"inually available, strongly consistent, _and_ tolerant to any partition. You must choose\\ntwo of thes\", \"e three properties.\\n\\n\\nIn microservices-based architectures, you should choose availability and toler\", \"ance, and you should\\nde-emphasize strong consistency. Therefore, in most modern microservice-based a\", \"pplications, you\\nusually do not want to use distributed transactions in messaging, as you do when yo\", \"u implement\\n[distributed transactions](https://docs.microsoft.com/previous-versions/windows/desktop/\", \"ms681205(v=vs.85)) based on the Windows Distributed Transaction Coordinator (DTC) with\\n[MSMQ.](https\", \"://docs.microsoft.com/previous-versions/windows/desktop/legacy/ms711472(v=vs.85))\\n\\n\\nLet\\u2019s go back to\", \" the initial issue and its example. If the service crashes after the database is updated\\n(in this ca\", \"se, right after the line of code with _context.SaveChangesAsync()), but before the integration\\nevent\", \" is published, the overall system could become inconsistent. This approach might be business\\ncritica\", \"l, depending on the specific business operation you are dealing with.\\n\\n\\nAs mentioned earlier in the \", \"architecture section, you can have several approaches for dealing with this\\nissue:\\n\\n\\n  - [Using the \", \"full Event Sourcing pattern.](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing)\", \"\\n\\n\\n  - Using transaction log mining.\\n\\n\\n  - [Using the Outbox pattern. This is a transactional table \", \"to store the integration events](https://www.kamilgrzybek.com/design/the-outbox-pattern/)\\n(extending\", \" the local transaction).\\n\\n\\nFor this scenario, using the full Event Sourcing (ES) pattern is one of t\", \"he best approaches, if not _the_\\nbest. However, in many application scenarios, you might not be able\", \" to implement a full ES system. ES\\nmeans storing only domain events in your transactional database, \", \"instead of storing current state\\n\\n\\n143 CHAPTER 5 | Designing and Developing Multi-Container and Micr\", \"oservice-Based .NET Applications\\n\\n\\ndata. Storing only domain events can have great benefits, such as\", \" having the history of your system\\navailable and being able to determine the state of your system at\", \" any moment in the past. However,\\nimplementing a full ES system requires you to rearchitect most of \", \"your system and introduces many\\nother complexities and requirements. For example, you would want to \", \"use a database specifically\\n[made for event sourcing, such as Event Store, or a document-oriented da\", \"tabase such as Azure](https://eventstore.org/)\\nCosmos DB, MongoDB, Cassandra, CouchDB, or RavenDB. E\", \"S is a great approach for this problem, but\\nnot the easiest solution unless you are already familiar\", \" with event sourcing.\\n\\n\\nThe option to use transaction log mining initially looks transparent. Howeve\", \"r, to use this approach,\\nthe microservice has to be coupled to your RDBMS transaction log, such as t\", \"he SQL Server transaction\\nlog. This approach is probably not desirable. Another drawback is that the\", \" low-level updates recorded\\nin the transaction log might not be at the same level as your high-level\", \" integration events. If so, the\\nprocess of reverse-engineering those transaction log operations can \", \"be difficult.\\n\\n\\nA balanced approach is a mix of a transactional database table and a simplified ES p\", \"attern. You can\\nuse a state such as \\u201cready to publish the event,\\u201d which you set in the original even\", \"t when you commit\\nit to the integration events table. You then try to publish the event to the event\", \" bus. If the publishevent action succeeds, you start another transaction in the origin service and m\", \"ove the state from\\n\\u201cready to publish the event\\u201d to \\u201cevent already published.\\u201d\\n\\n\\nIf the publish-event\", \" action in the event bus fails, the data still will not be inconsistent within the origin\\nmicroservi\", \"ce\\u2014it is still marked as \\u201cready to publish the event,\\u201d and with respect to the rest of the\\nservices,\", \" it will eventually be consistent. You can always have background jobs checking the state of\\nthe tra\", \"nsactions or integration events. If the job finds an event in the \\u201cready to publish the event\\u201d\\nstate\", \", it can try to republish that event to the event bus.\\n\\n\\nNotice that with this approach, you are per\", \"sisting only the integration events for each origin\\nmicroservice, and only the events that you want \", \"to communicate to other microservices or external\\nsystems. In contrast, in a full ES system, you sto\", \"re all domain events as well.\\n\\n\\nTherefore, this balanced approach is a simplified ES system. You nee\", \"d a list of integration events with\\ntheir current state (\\u201cready to publish\\u201d versus \\u201cpublished\\u201d). But\", \" you only need to implement these\\nstates for the integration events. And in this approach, you do no\", \"t need to store all your domain data\\nas events in the transactional database, as you would in a full\", \" ES system.\\n\\n\\nIf you are already using a relational database, you can use a transactional table to s\", \"tore integration\\nevents. To achieve atomicity in your application, you use a two-step process based \", \"on local\\ntransactions. Basically, you have an IntegrationEvent table in the same database where you \", \"have your\\ndomain entities. That table works as an insurance for achieving atomicity so that you incl\", \"ude persisted\\nintegration events into the same transactions that are committing your domain data.\\n\\n\\n\", \"Step by step, the process goes like this:\\n\\n\\n1. The application begins a local database transaction.\\n\", \"\\n\\n2. It then updates the state of your domain entities and inserts an event into the integration\\neve\", \"nt table.\\n\\n\\n3. Finally, it commits the transaction, so you get the desired atomicity and then\\n\\n\\n144 \", \"CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n4. Y\", \"ou publish the event somehow (next).\\n\\n\\nWhen implementing the steps of publishing the events, you hav\", \"e these choices:\\n\\n\\n  - Publish the integration event right after committing the transaction and use \", \"another local\\ntransaction to mark the events in the table as being published. Then, use the table ju\", \"st as an\\nartifact to track the integration events in case of issues in the remote microservices, and\", \"\\nperform compensatory actions based on the stored integration events.\\n\\n\\n  - Use the table as a kind \", \"of queue. A separate application thread or process queries the\\nintegration event table, publishes th\", \"e events to the event bus, and then uses a local\\ntransaction to mark the events as published.\\n\\n\\nFigu\", \"re 6-22 shows the architecture for the first of these approaches.\\n\\n\\n_Figure 6-22. Atomicity when pub\", \"lishing events to the event bus_\\n\\n\\nThe approach illustrated in Figure 6-22 is missing an additional \", \"worker microservice that is in charge\\nof checking and confirming the success of the published integr\", \"ation events. In case of failure, that\\nadditional checker worker microservice can read events from t\", \"he table and republish them, that is,\\nrepeat step number 2.\\n\\n\\nAbout the second approach: you use the\", \" EventLog table as a queue and always use a worker\\nmicroservice to publish the messages. In that cas\", \"e, the process is like that shown in Figure 6-23. This\\nshows an additional microservice, and the tab\", \"le is the single source when publishing events.\\n\\n\\n145 CHAPTER 5 | Designing and Developing Multi-Con\", \"tainer and Microservice-Based .NET Applications\\n\\n\\n_Figure 6-23. Atomicity when publishing events to \", \"the event bus with a worker microservice_\\n\\n\\nFor simplicity, the eShopOnContainers sample uses the fi\", \"rst approach (with no additional processes or\\nchecker microservices) plus the event bus. However, th\", \"e eShopOnContainers sample is not handling\\nall possible failure cases. In a real application deploye\", \"d to the cloud, you must embrace the fact that\\nissues will arise eventually, and you must implement \", \"that check and resend logic. Using the table as a\\nqueue can be more effective than the first approac\", \"h if you have that table as a single source of events\\nwhen publishing them (with the worker) through\", \" the event bus.\\n\\n\\n**Implementing atomicity when publishing integration events through the event**\\n**\", \"bus**\\n\\n\\nThe following code shows how you can create a single transaction involving multiple DbContex\", \"t\\nobjects\\u2014one context related to the original data being updated, and the second context related to\\n\", \"the IntegrationEventLog table.\\n\\n\\nThe transaction in the example code below will not be resilient if \", \"connections to the database have\\nany issue at the time when the code is running. This can happen in \", \"cloud-based systems like Azure\\nSQL DB, which might move databases across servers. For implementing r\", \"esilient transactions across\\nmultiple contexts, see the Implementing resilient Entity Framework Core\", \" SQL connections section later\\nin this guide.\\n\\n\\nFor clarity, the following example shows the whole p\", \"rocess in a single piece of code. However, the\\neShopOnContainers implementation is refactored and sp\", \"lits this logic into multiple classes so it\\u2019s\\neasier to maintain.\\n\\n\\n146 CHAPTER 5 | Designing and De\", \"veloping Multi-Container and Microservice-Based .NET Applications\\n\\n\\nAfter the ProductPriceChangedInt\", \"egrationEvent integration event is created, the transaction that\\nstores the original domain operatio\", \"n (update the catalog item) also includes the persistence of the\\nevent in the EventLog table. This m\", \"akes it a single transaction, and you will always be able to check\\nwhether event messages were sent.\", \"\\n\\n\\nThe event log table is updated atomically with the original database operation, using a local\\ntra\", \"nsaction against the same database. If any of the operations fail, an exception is thrown and the\\ntr\", \"ansaction rolls back any completed operation, thus maintaining consistency between the domain\\noperat\", \"ions and the event messages saved to the table.\\n\\n\\n147 CHAPTER 5 | Designing and Developing Multi-Con\", \"tainer and Microservice-Based .NET Applications\\n\\n\\n**Receiving messages from subscriptions: event han\", \"dlers in receiver microservices**\\n\\n\\nIn addition to the event subscription logic, you need to impleme\", \"nt the internal code for the\\nintegration event handlers (like a callback method). The event handler \", \"is where you specify where the\\nevent messages of a certain type will be received and processed.\\n\\n\\nAn\", \" event handler first receives an event instance from the event bus. Then it locates the component to\", \"\\nbe processed related to that integration event, propagating and persisting the event as a change in\", \"\\nstate in the receiver microservice. For example, if a ProductPriceChanged event originates in the\\nc\", \"atalog microservice, it is handled in the basket microservice and changes the state in this receiver\", \"\\nbasket microservice as well, as shown in the following code.\\n\\n\\n148 CHAPTER 5 | Designing and Develo\", \"ping Multi-Container and Microservice-Based .NET Applications\\n\\n\\nThe event handler needs to verify wh\", \"ether the product exists in any of the basket instances. It also\\nupdates the item price for each rel\", \"ated basket line item. Finally, it creates an alert to be displayed to\\nthe user about the price chan\", \"ge, as shown in Figure 6-24.\\n\\n\\n_Figure 6-24. Displaying an item price change in a basket, as communi\", \"cated by integration events_\\n\\n#### **Idempotency in update message events**\\n\\n\\nAn important aspect of\", \" update message events is that a failure at any point in the communication\\nshould cause the message \", \"to be retried. Otherwise a background task might try to publish an event\\nthat has already been publi\", \"shed, creating a race condition. Make sure that the updates are either\\nidempotent or that they provi\", \"de enough information to ensure that you can detect a duplicate,\\ndiscard it, and send back only one \", \"response.\\n\\n\\nAs noted earlier, idempotency means that an operation can be performed multiple times wi\", \"thout\\nchanging the result. In a messaging environment, as when communicating events, an event is\\nide\", \"mpotent if it can be delivered multiple times without changing the result for the receiver\\nmicroserv\", \"ice. This may be necessary because of the nature of the event itself, or because of the way\\nthe syst\", \"em handles the event. Message idempotency is important in any application that uses\\nmessaging, not j\", \"ust in applications that implement the event bus pattern.\\n\\n\\nAn example of an idempotent operation is\", \" a SQL statement that inserts data into a table only if that\\ndata is not already in the table. It do\", \"es not matter how many times you run that insert SQL statement;\\nthe result will be the same\\u2014the tabl\", \"e will contain that data. Idempotency like this can also be\\nnecessary when dealing with messages if \", \"the messages could potentially be sent and therefore\\n\\n\\n149 CHAPTER 5 | Designing and Developing Mult\", \"i-Container and Microservice-Based .NET Applications\\n\\n\\nprocessed more than once. For instance, if re\", \"try logic causes a sender to send exactly the same\\nmessage more than once, you need to make sure tha\", \"t it is idempotent.\\n\\n\\nIt is possible to design idempotent messages. For example, you can create an e\", \"vent that says \\u201cset the\\nproduct price to $25\\u201d instead of \\u201cadd $5 to the product price.\\u201d You could sa\", \"fely process the first\\nmessage any number of times and the result will be the same. That is not true\", \" for the second\\nmessage. But even in the first case, you might not want to process the first event, \", \"because the system\\ncould also have sent a newer price-change event and you would be overwriting the \", \"new price.\\n\\n\\nAnother example might be an order-completed event that\\u2019s propagated to multiple subscri\", \"bers. The\\napp has to make sure that order information is updated in other systems only once, even if\", \" there are\\nduplicated message events for the same order-completed event.\\n\\n\\nIt is convenient to have \", \"some kind of identity per event so that you can create logic that enforces that\\neach event is proces\", \"sed only once per receiver.\\n\\n\\nSome message processing is inherently idempotent. For example, if a sy\", \"stem generates image\\nthumbnails, it might not matter how many times the message about the generated \", \"thumbnail is\\nprocessed; the outcome is that the thumbnails are generated and they are the same every\", \" time. On\\nthe other hand, operations such as calling a payment gateway to charge a credit card may n\", \"ot be\\nidempotent at all. In these cases, you need to ensure that processing a message multiple times\", \" has\\nthe effect that you expect.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Honoring message idempotency**\\n[\", \"https://learn.microsoft.com/previous-versions/msp-n-p/jj591565(v=pandp.10)#honoring-](https://docs.m\", \"icrosoft.com/previous-versions/msp-n-p/jj591565(v=pandp.10)#honoring-message-idempotency)\\n[message-i\", \"dempotency](https://docs.microsoft.com/previous-versions/msp-n-p/jj591565(v=pandp.10)#honoring-messa\", \"ge-idempotency)\\n\\n#### **Deduplicating integration event messages**\\n\\n\\nYou can make sure that message \", \"events are sent and processed only once per subscriber at different\\nlevels. One way is to use a dedu\", \"plication feature offered by the messaging infrastructure you are\\nusing. Another is to implement cus\", \"tom logic in your destination microservice. Having validations at\\nboth the transport level and the a\", \"pplication level is your best bet.\\n\\n\\n**Deduplicating message events at the EventHandler level**\\n\\n\\nOn\", \"e way to make sure that an event is processed only once by any receiver is by implementing certain\\nl\", \"ogic when processing the message events in event handlers. For example, that is the approach used\\nin\", \" the eShopOnContainers application, as you can see in the source code of the\\n[UserCheckoutAcceptedIn\", \"tegrationEventHandler class when it receives a](https://github.com/dotnet-architecture/eShopOnContai\", \"ners/blob/main/src/Services/Ordering/Ordering.API/Application/IntegrationEvents/EventHandling/UserCh\", \"eckoutAcceptedIntegrationEventHandler.cs)\\nUserCheckoutAcceptedIntegrationEvent integration event. (I\", \"n this case, the CreateOrderCommand is\\nwrapped with an IdentifiedCommand, using the eventMsg.Request\", \"Id as an identifier, before sending it\\nto the command handler).\\n\\n\\n150 CHAPTER 5 | Designing and Deve\", \"loping Multi-Container and Microservice-Based .NET Applications\\n\\n\\n**Deduplicating messages when usin\", \"g RabbitMQ**\\n\\n\\nWhen intermittent network failures happen, messages can be duplicated, and the messag\", \"e receiver\\nmust be ready to handle these duplicated messages. If possible, receivers should handle m\", \"essages in\\nan idempotent way, which is better than explicitly handling them with deduplication.\\n\\n\\n[A\", \"ccording to the RabbitMQ documentation, \\u201cIf a message is delivered to a consumer and then](https://w\", \"ww.rabbitmq.com/reliability.html#consumer)\\nrequeued (because it was not acknowledged before the cons\", \"umer connection dropped, for example)\\nthen RabbitMQ will set the redelivered flag on it when it is d\", \"elivered again (whether to the same\\nconsumer or a different one).\\n\\n\\nIf the \\u201credelivered\\u201d flag is set\", \", the receiver must take that into account, because the message might\\nalready have been processed. B\", \"ut that is not guaranteed; the message might never have reached the\\nreceiver after it left the messa\", \"ge broker, perhaps because of network issues. On the other hand, if the\\n\\u201credelivered\\u201d flag is not se\", \"t, it is guaranteed that the message has not been sent more than once.\\nTherefore, the receiver needs\", \" to deduplicate messages or process messages in an idempotent way\\nonly if the \\u201credelivered\\u201d flag is \", \"set in the message.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Forked eShopOnContainers using NServiceBus (P\", \"articular Software)**\\n[https://go.particular.net/eShopOnContainers](https://go.particular.net/eShopO\", \"nContainers)\\n\\n\\n  - **Event Driven Messaging**\\n[https://patterns.arcitura.com/soa-patterns/design_pat\", \"terns/event_driven_messaging](https://patterns.arcitura.com/soa-patterns/design_patterns/event_drive\", \"n_messaging)\\n\\n\\n  - **Jimmy Bogard. Refactoring Towards Resilience: Evaluating Coupling**\\n[https://ji\", \"mmybogard.com/refactoring-towards-resilience-evaluating-coupling/](https://jimmybogard.com/refactori\", \"ng-towards-resilience-evaluating-coupling/)\\n\\n\\n  - **Publish-Subscribe channel**\\n[https://www.enterpr\", \"iseintegrationpatterns.com/patterns/messaging/PublishSubscribeChannel.](https://www.enterpriseintegr\", \"ationpatterns.com/patterns/messaging/PublishSubscribeChannel.html)\\nhtml\\n\\n\\n  - **Communicating Betwee\", \"n Bounded Contexts**\\n[https://learn.microsoft.com/previous-versions/msp-n-p/jj591572(v=pandp.10)](ht\", \"tps://docs.microsoft.com/previous-versions/msp-n-p/jj591572(v=pandp.10))\\n\\n\\n  - **Eventual Consistenc\", \"y**\\n[https://en.wikipedia.org/wiki/Eventual_consistency](https://en.wikipedia.org/wiki/Eventual_cons\", \"istency)\\n\\n\\n  - **Philip Brown. Strategies for Integrating Bounded Contexts**\\n[https://www.culttt.com\", \"/2014/11/26/strategies-integrating-bounded-contexts/](https://www.culttt.com/2014/11/26/strategies-i\", \"ntegrating-bounded-contexts/)\\n\\n\\n  - **Chris Richardson. Developing Transactional Microservices Using\", \" Aggregates, Event**\\n**Sourcing and CQRS - Part 2**\\n[https://www.infoq.com/articles/microservices-ag\", \"gregates-events-cqrs-part-2-richardson](https://www.infoq.com/articles/microservices-aggregates-even\", \"ts-cqrs-part-2-richardson)\\n\\n\\n  - **Chris Richardson. Event Sourcing pattern**\\n[https://microservices\", \".io/patterns/data/event-sourcing.html](https://microservices.io/patterns/data/event-sourcing.html)\\n\\n\", \"\\n  - **Introducing Event Sourcing**\\n[https://learn.microsoft.com/previous-versions/msp-n-p/jj591559(\", \"v=pandp.10)](https://docs.microsoft.com/previous-versions/msp-n-p/jj591559(v=pandp.10))\\n\\n\\n151 CHAPTE\", \"R 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n  - **Even\", \"t Store database** . Official site.\\n[https://geteventstore.com/](https://geteventstore.com/)\\n\\n\\n  - *\", \"*Patrick Nommensen. Event-Driven Data Management for Microservices**\\n[https://dzone.com/articles/eve\", \"nt-driven-data-management-for-microservices-1](https://dzone.com/articles/event-driven-data-manageme\", \"nt-for-microservices-1)\\n\\n\\n  - **The CAP Theorem**\\n[https://en.wikipedia.org/wiki/CAP_theorem](https:\", \"//en.wikipedia.org/wiki/CAP_theorem)\\n\\n\\n  - **What is CAP Theorem?**\\n[https://www.quora.com/What-Is-C\", \"AP-Theorem-1](https://www.quora.com/What-Is-CAP-Theorem-1)\\n\\n\\n  - **Data Consistency Primer**\\n[https:\", \"//learn.microsoft.com/previous-versions/msp-n-p/dn589800(v=pandp.10)](https://docs.microsoft.com/pre\", \"vious-versions/msp-n-p/dn589800(v=pandp.10))\\n\\n\\n  - **Rick Saling. The CAP Theorem: Why \\u201cEverything i\", \"s Different\\u201d with the Cloud and**\\n**Internet**\\n[https://learn.microsoft.com/archive/blogs/rickatmicr\", \"osoft/the-cap-theorem-why-everything-](https://docs.microsoft.com/archive/blogs/rickatmicrosoft/the-\", \"cap-theorem-why-everything-is-different-with-the-cloud-and-internet/)\\n[is-different-with-the-cloud-a\", \"nd-internet/](https://docs.microsoft.com/archive/blogs/rickatmicrosoft/the-cap-theorem-why-everythin\", \"g-is-different-with-the-cloud-and-internet/)\\n\\n\\n  - **Eric Brewer. CAP Twelve Years Later: How the \\u201cR\", \"ules\\u201d Have Changed**\\n[https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-chang\", \"ed](https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed)\\n\\n\\n  - **CAP, P\", \"ACELC, and Microservices**\\n[https://ardalis.com/cap-pacelc-and-microservices/](https://ardalis.com/c\", \"ap-pacelc-and-microservices/)\\n\\n\\n  - **Azure Service Bus. Brokered Messaging: Duplicate Detection**\\n[\", \"https://github.com/microsoftarchive/msdn-code-gallery-](https://github.com/microsoftarchive/msdn-cod\", \"e-gallery-microsoft/tree/master/Windows%20Azure%20Product%20Team/Brokered%20Messaging%20Duplicate%20\", \"Detection)\\n[microsoft/tree/master/Windows%20Azure%20Product%20Team/Brokered%20Messaging%20](https://\", \"github.com/microsoftarchive/msdn-code-gallery-microsoft/tree/master/Windows%20Azure%20Product%20Team\", \"/Brokered%20Messaging%20Duplicate%20Detection)\\n[Duplicate%20Detection](https://github.com/microsofta\", \"rchive/msdn-code-gallery-microsoft/tree/master/Windows%20Azure%20Product%20Team/Brokered%20Messaging\", \"%20Duplicate%20Detection)\\n\\n\\n  - **Reliability Guide** (RabbitMQ documentation)\\n[https://www.rabbitmq\", \".com/reliability.html#consumer](https://www.rabbitmq.com/reliability.html#consumer)\\n\\n### Testing ASP\", \".NET Core services and web apps\\n\\n\\nControllers are a central part of any ASP.NET Core API service and\", \" ASP.NET MVC Web application. As\\nsuch, you should have confidence they behave as intended for your a\", \"pplication. Automated tests can\\nprovide you with this confidence and can detect errors before they r\", \"each production.\\n\\n\\nYou need to test how the controller behaves based on valid or invalid inputs, and\", \" test controller\\nresponses based on the result of the business operation it performs. However, you s\", \"hould have these\\ntypes of tests for your microservices:\\n\\n\\n  - Unit tests. These tests ensure that in\", \"dividual components of the application work as expected.\\nAssertions test the component API.\\n\\n\\n  - In\", \"tegration tests. These tests ensure that component interactions work as expected against\\nexternal ar\", \"tifacts like databases. Assertions can test component API, UI, or the side effects of\\nactions like d\", \"atabase I/O, logging, etc.\\n\\n\\n152 CHAPTER 5 | Designing and Developing Multi-Container and Microservi\", \"ce-Based .NET Applications\\n\\n\\n  - Functional tests for each microservice. These tests ensure that the\", \" application works as\\nexpected from the user\\u2019s perspective.\\n\\n\\n  - Service tests. These tests ensure \", \"that end-to-end service use cases, including testing multiple\\nservices at the same time, are tested.\", \" For this type of testing, you need to prepare the\\nenvironment first. In this case, it means startin\", \"g the services (for example, by using dockercompose up).\\n\\n\\n**Implementing unit tests for ASP.NET Cor\", \"e Web APIs**\\n\\n\\nUnit testing involves testing a part of an application in isolation from its infrastr\", \"ucture and\\ndependencies. When you unit test controller logic, only the content of a single action or\", \" method is\\ntested, not the behavior of its dependencies or of the framework itself. Unit tests do no\", \"t detect issues\\nin the interaction between components\\u2014that is the purpose of integration testing.\\n\\n\\n\", \"As you unit test your controller actions, make sure you focus only on their behavior. A controller u\", \"nit\\ntest avoids things like filters, routing, or model binding (the mapping of request data to a Vie\", \"wModel\\nor DTO). Because they focus on testing just one thing, unit tests are generally simple to wri\", \"te and\\nquick to run. A well-written set of unit tests can be run frequently without much overhead.\\n\\n\", \"\\nUnit tests are implemented based on test frameworks like xUnit.net, MSTest, Moq, or NUnit. For the\\n\", \"eShopOnContainers sample application, we are using xUnit.\\n\\n\\nWhen you write a unit test for a Web API\", \" controller, you instantiate the controller class directly using\\nthe new keyword in C#, so that the \", \"test will run as fast as possible. The following example shows how\\n[to do this when using xUnit as t\", \"he Test framework.](https://xunit.net/)\\n\\n\\n153 CHAPTER 5 | Designing and Developing Multi-Container a\", \"nd Microservice-Based .NET Applications\\n\\n\\n**Implementing integration and functional tests for each m\", \"icroservice**\\n\\n\\nAs noted, integration tests and functional tests have different purposes and goals. \", \"However, the way\\nyou implement both when testing ASP.NET Core controllers is similar, so in this sec\", \"tion we\\nconcentrate on integration tests.\\n\\n\\nIntegration testing ensures that an application\\u2019s compon\", \"ents function correctly when assembled.\\nASP.NET Core supports integration testing using unit test fr\", \"ameworks and a built-in test web host that\\ncan be used to handle requests without network overhead.\\n\", \"\\n\\nUnlike unit testing, integration tests frequently involve application infrastructure concerns, suc\", \"h as a\\ndatabase, file system, network resources, or web requests and responses. Unit tests use fakes\", \" or mock\\nobjects in place of these concerns. But the purpose of integration tests is to confirm that\", \" the system\\nworks as expected with these systems, so for integration testing you do not use fakes or\", \" mock objects.\\nInstead, you include the infrastructure, like database access or service invocation f\", \"rom other services.\\n\\n\\nBecause integration tests exercise larger segments of code than unit tests, an\", \"d because integration\\ntests rely on infrastructure elements, they tend to be orders of magnitude slo\", \"wer than unit tests. Thus,\\nit is a good idea to limit how many integration tests you write and run.\\n\", \"\\n\\nASP.NET Core includes a built-in test web host that can be used to handle HTTP requests without\\nne\", \"twork overhead, meaning that you can run those tests faster than when using a real web host. The\\ntes\", \"t web host (TestServer) is available in a NuGet component as Microsoft.AspNetCore.TestHost. It can\\nb\", \"e added to integration test projects and used to host ASP.NET Core applications.\\n\\n\\nAs you can see in\", \" the following code, when you create integration tests for ASP.NET Core controllers,\\nyou instantiate\", \" the controllers through the test host. This functionality is comparable to an HTTP\\nrequest, but it \", \"runs faster.\\n\\n\\n154 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET \", \"Applications\\n\\n\\n**Additional resources**\\n\\n\\n  - **Steve Smith. Testing controllers** (ASP.NET Core)\\n[h\", \"ttps://learn.microsoft.com/aspnet/core/mvc/controllers/testing](https://docs.microsoft.com/aspnet/co\", \"re/mvc/controllers/testing)\\n\\n\\n  - **Steve Smith. Integration testing** (ASP.NET Core)\\n[https://learn\", \".microsoft.com/aspnet/core/test/integration-tests](https://docs.microsoft.com/aspnet/core/test/integ\", \"ration-tests)\\n\\n\\n  - **Unit testing in .NET using dotnet test**\\n[https://learn.microsoft.com/dotnet/c\", \"ore/testing/unit-testing-with-dotnet-test](https://docs.microsoft.com/dotnet/core/testing/unit-testi\", \"ng-with-dotnet-test)\\n\\n\\n  - **xUnit.net** . Official site.\\n[https://xunit.net/](https://xunit.net/)\\n\\n\", \"\\n  - **Unit Test Basics.**\\n[https://learn.microsoft.com/visualstudio/test/unit-test-basics](https://\", \"docs.microsoft.com/visualstudio/test/unit-test-basics)\\n\\n\\n  - **Moq** . GitHub repo.\\n[https://github.\", \"com/moq/moq](https://github.com/moq/moq)\\n\\n\\n  - **NUnit** . Official site.\\n[https://nunit.org/](https\", \"://nunit.org/)\\n\\n\\n**Implementing service tests on a multi-container application**\\n\\n\\nAs noted earlier,\", \" when you test multi-container applications, all the microservices need to be running\\nwithin the Doc\", \"ker host or container cluster. End-to-end service tests that include multiple operations\\ninvolving s\", \"everal microservices require you to deploy and start the whole application in the Docker\\nhost by run\", \"ning docker-compose up (or a comparable mechanism if you are using an orchestrator).\\nOnce the whole \", \"application and all its services is running, you can execute end-to-end integration and\\nfunctional t\", \"ests.\\n\\n\\nThere are a few approaches you can use. In the docker-compose.yml file that you use to deplo\", \"y the\\n[application at the solution level you can expand the entry point to use dotnet test. You can \", \"also use](https://docs.microsoft.com/dotnet/core/tools/dotnet-test)\\nanother compose file that would \", \"run your tests in the image you are targeting. By using another\\ncompose file for integration tests t\", \"hat includes your microservices and databases on containers, you\\ncan make sure that the related data\", \" is always reset to its original state before running the tests.\\n\\n\\nOnce the compose application is u\", \"p and running, you can take advantage of breakpoints and\\nexceptions if you are running Visual Studio\", \". Or you can run the integration tests automatically in your\\nCI pipeline in Azure DevOps Services or\", \" any other CI/CD system that supports Docker containers.\\n\\n#### **Testing in eShopOnContainers**\\n\\n\\nTh\", \"e reference application (eShopOnContainers) tests were recently restructured and now there are\\nfour \", \"categories:\\n\\n\\n1. **Unit** tests, just plain old regular unit tests, contained in the **{Microservice\", \"Name}.UnitTests**\\nprojects\\n\\n\\n155 CHAPTER 5 | Designing and Developing Multi-Container and Microservi\", \"ce-Based .NET Applications\\n\\n\\n2. **Microservice functional/integration tests**, with test cases invol\", \"ving the infrastructure for\\neach microservice but isolated from the others and are contained in the\\n\", \"**{MicroserviceName}.FunctionalTests** projects.\\n\\n\\n3. **Application functional/integration tests**, \", \"which focus on microservices integration, with test\\ncases that exert several microservices. These te\", \"sts are located in project\\n**Application.FunctionalTests** .\\n\\n\\nWhile unit and integration tests are \", \"organized in a test folder within the microservice project,\\napplication and load tests are managed s\", \"eparately under the root folder, as shown in Figure 6-25.\\n\\n\\n_Figure 6-25. Test folder structure in e\", \"ShopOnContainers_\\n\\n\\nMicroservice and Application functional/integration tests are run from Visual St\", \"udio, using the regular\\ntests runner, but first you need to start the required infrastructure servic\", \"es, with a set of dockercompose files contained in the solution test folder:\\n\\n\\n**docker-compose-test\", \".yml**\\n\\n\\n156 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applic\", \"ations\\n\\n\\n**docker-compose-test.override.yml**\\n\\n\\nSo, to run the functional/integration tests you must\", \" first run this command, from the solution test\\nfolder:\\n\\n```\\ndocker-compose -f docker-compose-test.y\", \"ml -f docker-compose-test.override.yml up\\n\\n```\\n\\nAs you can see, these docker-compose files only star\", \"t the Redis, RabbitMQ, SQL Server, and MongoDB\\nmicroservices.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Uni\", \"t & Integration testing** on the eShopOnContainers\\n[https://github.com/dotnet-architecture/eShopOnCo\", \"ntainers/wiki/Unit-and-integration-](https://github.com/dotnet-architecture/eShopOnContainers/wiki/U\", \"nit-and-integration-testing)\\ntesting\\n\\n\\n  - **Load testing** on the eShopOnContainers\\n[https://github\", \".com/dotnet-architecture/eShopOnContainers/wiki/Load-testing](https://github.com/dotnet-architecture\", \"/eShopOnContainers/wiki/Load-testing)\\n\\n### Implement background tasks in microservices with IHostedS\", \"ervice and the BackgroundService class\\n\\n\\nBackground tasks and scheduled jobs are something you might\", \" need to use in any application,\\nwhether or not it follows the microservices architecture pattern. T\", \"he difference when using a\\nmicroservices architecture is that you can implement the background task \", \"in a separate\\nprocess/container for hosting so you can scale it down/up based on your need.\\n\\n\\n157 CH\", \"APTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nFrom a\", \" generic point of view, in .NET we called these type of tasks _Hosted Services_, because they are\\nse\", \"rvices/logic that you host within your host/application/microservice. Note that in this case, the\\nho\", \"sted service simply means a class with the background task logic.\\n\\n\\n[Since .NET Core 2.0, the framew\", \"ork provides a new interface named IHostedService helping you to](https://docs.microsoft.com/dotnet/\", \"api/microsoft.extensions.hosting.ihostedservice)\\neasily implement hosted services. The basic idea is\", \" that you can register multiple background tasks\\n(hosted services) that run in the background while \", \"your web host or host is running, as shown in the\\nimage 6-26.\\n\\n\\n_Figure 6-26. Using IHostedService i\", \"n a WebHost vs. a Host_\\n\\n\\nASP.NET Core 1.x and 2.x support IWebHost for background processes in web \", \"apps. .NET Core 2.1 and\\nlater versions support IHost for background processes with plain console app\", \"s. Note the difference\\nmade between WebHost and Host.\\n\\n\\nA WebHost (base class implementing IWebHost)\", \" in ASP.NET Core 2.0 is the infrastructure artifact you\\nuse to provide HTTP server features to your \", \"process, such as when you\\u2019re implementing an MVC web\\napp or Web API service. It provides all the new\", \" infrastructure goodness in ASP.NET Core, enabling you\\nto use dependency injection, insert middlewar\", \"es in the request pipeline, and similar. The WebHost\\nuses these very same IHostedServices for backgr\", \"ound tasks.\\n\\n\\nA Host (base class implementing IHost) was introduced in .NET Core 2.1. Basically, a H\", \"ost allows you\\nto have a similar infrastructure than what you have with WebHost (dependency injectio\", \"n, hosted\\nservices, etc.), but in this case, you just want to have a simple and lighter process as t\", \"he host, with\\nnothing related to MVC, Web API or HTTP server features.\\n\\n\\nTherefore, you can choose a\", \"nd either create a specialized host-process with IHost to handle the\\nhosted services and nothing els\", \"e, such a microservice made just for hosting the IHostedServices, or\\nyou can alternatively extend an\", \" existing ASP.NET Core WebHost, such as an existing ASP.NET Core\\nWeb API or MVC app.\\n\\n\\n158 CHAPTER 5\", \" | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nEach approach\", \" has pros and cons depending on your business and scalability needs. The bottom line\\nis basically th\", \"at if your background tasks have nothing to do with HTTP (IWebHost) you should use\\nIHost.\\n\\n#### **Re\", \"gistering hosted services in your WebHost or Host**\\n\\n\\nLet\\u2019s drill down further on the IHostedService\", \" interface since its usage is pretty similar in a WebHost or\\nin a Host.\\n\\n\\nSignalR is one example of \", \"an artifact using hosted services, but you can also use it for much simpler\\nthings like:\\n\\n\\n  - A bac\", \"kground task polling a database looking for changes.\\n\\n  - A scheduled task updating some cache perio\", \"dically.\\n\\n  - An implementation of QueueBackgroundWorkItem that allows a task to be executed on a\\nba\", \"ckground thread.\\n\\n  - Processing messages from a message queue in the background of a web app while \", \"sharing\\ncommon services such as ILogger.\\n\\n  - A background task started with Task.Run().\\n\\n\\nYou can b\", \"asically offload any of those actions to a background task that implements IHostedService.\\n\\n\\nThe way\", \" you add one or multiple IHostedServices into your WebHost or Host is by registering them\\n[up throug\", \"h the AddHostedService extension method in an ASP.NET Core WebHost (or in a Host in](https://docs.mi\", \"crosoft.com/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectionhostedserviceextens\", \"ions.addhostedservice)\\n.NET Core 2.1 and above). Basically, you have to register the hosted services\", \" within application startup\\nin _Program.cs_ .\\n\\n\\nIn that code, the GracePeriodManagerService hosted s\", \"ervice is real code from the Ordering business\\nmicroservice in eShopOnContainers, while the other tw\", \"o are just two additional samples.\\n\\n\\nThe IHostedService background task execution is coordinated wit\", \"h the lifetime of the application (host\\nor microservice, for that matter). You register tasks when t\", \"he application starts and you have the\\nopportunity to do some graceful action or clean-up when the a\", \"pplication is shutting down.\\n\\n\\nWithout using IHostedService, you could always start a background thr\", \"ead to run any task. The\\ndifference is precisely at the app\\u2019s shutdown time when that thread would s\", \"imply be killed without\\nhaving the opportunity to run graceful clean-up actions.\\n\\n#### **The IHosted\", \"Service interface**\\n\\n\\nWhen you register an IHostedService, .NET calls the StartAsync() and StopAsync\", \"() methods of your\\nIHostedService type during application start and stop respectively. For more deta\", \"ils, see\\n[IHostedService interface.](https://docs.microsoft.com/aspnet/core/fundamentals/host/hosted\", \"-services#ihostedservice-interface)\\n\\n\\n159 CHAPTER 5 | Designing and Developing Multi-Container and M\", \"icroservice-Based .NET Applications\\n\\n\\nAs you can imagine, you can create multiple implementations of\", \" IHostedService and register each of\\nthem in _Program.cs_, as shown previously. All those hosted ser\", \"vices will be started and stopped along\\nwith the application/microservice.\\n\\n\\nAs a developer, you are\", \" responsible for handling the stopping action of your services when\\nStopAsync() method is triggered \", \"by the host.\\n\\n#### **Implementing IHostedService with a custom hosted service class** **deriving fro\", \"m the BackgroundService base class**\\n\\n\\nYou could go ahead and create your custom hosted service clas\", \"s from scratch and implement the\\nIHostedService, as you need to do when using .NET Core 2.0 and late\", \"r.\\n\\n\\nHowever, since most background tasks will have similar needs in regard to the cancellation toke\", \"ns\\nmanagement and other typical operations, there is a convenient abstract base class you can derive\", \"\\nfrom, named BackgroundService (available since .NET Core 2.1).\\n\\n\\nThat class provides the main work \", \"needed to set up the background task.\\n\\n\\nThe next code is the abstract BackgroundService base class a\", \"s implemented in .NET.\\n\\n\\n160 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-B\", \"ased .NET Applications\\n\\n\\nWhen deriving from the previous abstract base class, thanks to that inherit\", \"ed implementation, you just\\nneed to implement the ExecuteAsync() method in your own custom hosted se\", \"rvice class, as in the\\nfollowing simplified code from eShopOnContainers which is polling a database \", \"and publishing\\nintegration events into the Event Bus when needed.\\n\\n\\n161 CHAPTER 5 | Designing and De\", \"veloping Multi-Container and Microservice-Based .NET Applications\\n\\n\\nIn this specific case for eShopO\", \"nContainers, it\\u2019s executing an application method that\\u2019s querying a\\ndatabase table looking for order\", \"s with a specific state and when applying changes, it is publishing\\nintegration events through the e\", \"vent bus (underneath it can be using RabbitMQ or Azure Service Bus).\\n\\n\\nOf course, you could run any \", \"other business background task, instead.\\n\\n\\nBy default, the cancellation token is set with a 5 second\", \"s timeout, although you can change that value\\nwhen building your WebHost using the UseShutdownTimeou\", \"t extension of the IWebHostBuilder. This\\nmeans that our service is expected to cancel within 5 secon\", \"ds otherwise it will be more abruptly killed.\\n\\n\\nThe following code would be changing that time to 10\", \" seconds.\\n\\n```\\nWebHost.CreateDefaultBuilder(args)\\n  .UseShutdownTimeout(TimeSpan.FromSeconds(10))\\n  \", \"...\\n\\n```\\n\\n**Summary class diagram**\\n\\n\\nThe following image shows a visual summary of the classes and \", \"interfaces involved when\\nimplementing IHostedServices.\\n\\n\\n_Figure 6-27. Class diagram showing the mul\", \"tiple classes and interfaces related to IHostedService_\\n\\n\\nClass diagram: IWebHost and IHost can host\", \" many services, which inherit from BackgroundService,\\nwhich implements IHostedService.\\n\\n\\n162 CHAPTER\", \" 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n**Deploymen\", \"t considerations and takeaways**\\n\\n\\nIt is important to note that the way you deploy your ASP.NET Core\", \" WebHost or .NET Host might\\nimpact the final solution. For instance, if you deploy your WebHost on I\", \"IS or a regular Azure App\\nService, your host can be shut down because of app pool recycles. But if y\", \"ou are deploying your host\\nas a container into an orchestrator like Kubernetes, you can control the \", \"assured number of live\\ninstances of your host. In addition, you could consider other approaches in t\", \"he cloud especially made\\nfor these scenarios, like Azure Functions. Finally, if you need the service\", \" to be running all the time and\\nare deploying on a Windows Server you could use a Windows Service.\\n\\n\", \"\\nBut even for a WebHost deployed into an app pool, there are scenarios like repopulating or flushing\", \"\\napplication\\u2019s in-memory cache that would be still applicable.\\n\\n\\nThe IHostedService interface provid\", \"es a convenient way to start background tasks in an ASP.NET Core\\nweb application (in .NET Core 2.0 a\", \"nd later versions) or in any process/host (starting in .NET Core 2.1\\nwith IHost). Its main benefit i\", \"s the opportunity you get with the graceful cancellation to clean-up the\\ncode of your background tas\", \"ks when the host itself is shutting down.\\n\\n#### **Additional resources**\\n\\n\\n  - **Building a schedule\", \"d task in ASP.NET Core/Standard 2.0**\\n[https://blog.maartenballiauw.be/post/2017/08/01/building-a-sc\", \"heduled-cache-updater-in-](https://blog.maartenballiauw.be/post/2017/08/01/building-a-scheduled-cach\", \"e-updater-in-aspnet-core-2.html)\\n[aspnet-core-2.html](https://blog.maartenballiauw.be/post/2017/08/0\", \"1/building-a-scheduled-cache-updater-in-aspnet-core-2.html)\\n\\n\\n  - **Implementing IHostedService in A\", \"SP.NET Core 2.0**\\n[https://www.stevejgordon.co.uk/asp-net-core-2-ihostedservice](https://www.stevejg\", \"ordon.co.uk/asp-net-core-2-ihostedservice)\\n\\n\\n  - **GenericHost Sample using ASP.NET Core 2.1**\\n[http\", \"s://github.com/aspnet/Hosting/tree/release/2.1/samples/GenericHostSample](https://github.com/aspnet/\", \"Hosting/tree/release/2.1/samples/GenericHostSample)\\n\\n### Implement API Gateways with Ocelot\\n\\n\\n\\n\\n####\", \" **Architect and design your API Gateways**\\n\\nThe following architecture diagram shows how API Gatewa\", \"ys were implemented with Ocelot in\\neShopOnContainers.\\n\\n\\n163 CHAPTER 5 | Designing and Developing Mul\", \"ti-Container and Microservice-Based .NET Applications\\n\\n\\n_Figure 6-28. eShopOnContainers architecture\", \" with API Gateways_\\n\\n\\nThat diagram shows how the whole application is deployed into a single Docker \", \"host or development\\nPC with \\u201cDocker for Windows\\u201d or \\u201cDocker for Mac\\u201d. However, deploying into any or\", \"chestrator would\\nbe similar, but any container in the diagram could be scaled out in the orchestrato\", \"r.\\n\\n\\nIn addition, the infrastructure assets such as databases, cache, and message brokers should be\\n\", \"offloaded from the orchestrator and deployed into high available systems for infrastructure, like Az\", \"ure\\nSQL Database, Azure Cosmos DB, Azure Redis, Azure Service Bus, or any HA clustering solution onp\", \"remises.\\n\\n\\nAs you can also notice in the diagram, having several API Gateways allows multiple develo\", \"pment\\nteams to be autonomous (in this case Marketing features vs. Shopping features) when developing\", \" and\\ndeploying their microservices plus their own related API Gateways.\\n\\n\\nIf you had a single monoli\", \"thic API Gateway that would mean a single point to be updated by several\\ndevelopment teams, which co\", \"uld couple all the microservices with a single part of the application.\\n\\n\\nGoing much further in the \", \"design, sometimes a fine-grained API Gateway can also be limited to a\\nsingle business microservice d\", \"epending on the chosen architecture. Having the API Gateway\\u2019s\\nboundaries dictated by the business or\", \" domain will help you to get a better design.\\n\\n\\nFor instance, fine granularity in the API Gateway ti\", \"er can be especially useful for more advanced\\ncomposite UI applications that are based on microservi\", \"ces, because the concept of a fine-grained API\\nGateway is similar to a UI composition service.\\n\\n\\nWe \", \"delve into more details in the previous section Creating composite UI based on microservices.\\n\\n\\nAs a\", \" key takeaway, for many medium- and large-size applications, using a custom-built API Gateway\\nproduc\", \"t is usually a good approach, but not as a single monolithic aggregator or unique central\\ncustom API\", \" Gateway unless that API Gateway allows multiple independent configuration areas for the\\nseveral dev\", \"elopment teams creating autonomous microservices.\\n\\n\\n164 CHAPTER 5 | Designing and Developing Multi-C\", \"ontainer and Microservice-Based .NET Applications\\n\\n\\n**Sample microservices/containers to reroute thr\", \"ough the API Gateways**\\n\\n\\nAs an example, eShopOnContainers has around six internal microservice-type\", \"s that have to be\\npublished through the API Gateways, as shown in the following image.\\n\\n\\n_Figure 6-2\", \"9. Microservice folders in eShopOnContainers solution in Visual Studio_\\n\\n\\nAbout the Identity service\", \", in the design it\\u2019s left out of the API Gateway routing because it\\u2019s the only\\ncross-cutting concern\", \" in the system, although with Ocelot it\\u2019s also possible to include it as part of the\\nrerouting lists\", \".\\n\\n\\nAll those services are currently implemented as ASP.NET Core Web API services, as you can tell f\", \"rom\\nthe code. Let\\u2019s focus on one of the microservices like the Catalog microservice code.\\n\\n\\n_Figure \", \"6-30. Sample Web API microservice (Catalog microservice)_\\n\\n\\n165 CHAPTER 5 | Designing and Developing\", \" Multi-Container and Microservice-Based .NET Applications\\n\\n\\nYou can see that the Catalog microservic\", \"e is a typical ASP.NET Core Web API project with several\\ncontrollers and methods like in the followi\", \"ng code.\\n\\n\\nThe HTTP request will end up running that kind of C# code accessing the microservice data\", \"base and\\nany additional required action.\\n\\n\\nRegarding the microservice URL, when the containers are d\", \"eployed in your local development PC\\n(local Docker host), each microservice\\u2019s container always has a\", \"n internal port (usually port 80)\\nspecified in its dockerfile, as in the following dockerfile:\\n\\n\\nThe\", \" port 80 shown in the code is internal within the Docker host, so it can\\u2019t be reached by client apps\", \".\\n\\n\\nClient apps can access only the external ports (if any) published when deploying with dockercomp\", \"ose.\\n\\n\\nThose external ports shouldn\\u2019t be published when deploying to a production environment. For t\", \"his\\nspecific reason, why you want to use the API Gateway, to avoid the direct communication between \", \"the\\nclient apps and the microservices.\\n\\n\\nHowever, when developing, you want to access the microservi\", \"ce/container directly and run it through\\nSwagger. That\\u2019s why in eShopOnContainers, the external port\", \"s are still specified even when they won\\u2019t\\nbe used by the API Gateway or the client apps.\\n\\n\\nHere\\u2019s a\", \"n example of the docker-compose.override.yml file for the Catalog microservice:\\n\\n\\n166 CHAPTER 5 | De\", \"signing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nYou can see how in\", \" the docker-compose.override.yml configuration the internal port for the Catalog\\ncontainer is port 8\", \"0, but the port for external access is 5101. But this port shouldn\\u2019t be used by the\\napplication when\", \" using an API Gateway, only to debug, run, and test just the Catalog microservice.\\n\\n\\nNormally, you w\", \"on\\u2019t be deploying with docker-compose into a production environment because the\\nright production dep\", \"loyment environment for microservices is an orchestrator like Kubernetes or\\nService Fabric. When dep\", \"loying to those environments you use different configuration files where you\\nwon\\u2019t publish directly \", \"any external port for the microservices but, you\\u2019ll always use the reverse proxy\\nfrom the API Gatewa\", \"y.\\n\\n\\nRun the catalog microservice in your local Docker host. Either run the full eShopOnContainers s\", \"olution\\nfrom Visual Studio (it runs all the services in the docker-compose files), or start the Cata\", \"log\\nmicroservice with the following docker-compose command in CMD or PowerShell positioned at the\\nfo\", \"lder where the docker-compose.yml and docker-compose.override.yml are placed.\\n\\n```\\ndocker-compose ru\", \"n --service-ports catalog-api\\n\\n```\\n\\nThis command only runs the catalog-api service container plus de\", \"pendencies that are specified in the\\ndocker-compose.yml. In this case, the SQL Server container and \", \"RabbitMQ container.\\n\\n\\nThen, you can directly access the Catalog microservice and see its methods thr\", \"ough the Swagger UI\\naccessing directly through that \\u201cexternal\\u201d port, in this case http://host.docker\", \".internal:5101/swagger:\\n\\n\\n167 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-\", \"Based .NET Applications\\n\\n\\n_Figure 6-31. Testing the Catalog microservice with its Swagger UI_\\n\\n\\nAt t\", \"his point, you could set a breakpoint in C# code in Visual Studio, test the microservice with the\\nme\", \"thods exposed in Swagger UI, and finally clean-up everything with the docker-compose down\\ncommand.\\n\\n\", \"\\nHowever, direct-access communication to the microservice, in this case through the external port\\n51\", \"01, is precisely what you want to avoid in your application. And you can avoid that by setting the\\na\", \"dditional level of indirection of the API Gateway (Ocelot, in this case). That way, the client app w\", \"on\\u2019t\\ndirectly access the microservice.\\n\\n#### **Implementing your API Gateways with Ocelot**\\n\\n\\nOcelot\", \" is basically a set of middleware that you can apply in a specific order.\\n\\n\\nOcelot is designed to wo\", \"rk with ASP.NET Core only. The latest version of the package is 18.0 which\\ntargets .NET 6 and hence \", \"is not suitable for .NET Framework applications.\\n\\n\\n168 CHAPTER 5 | Designing and Developing Multi-Co\", \"ntainer and Microservice-Based .NET Applications\\n\\n\\n[You install Ocelot and its dependencies in your \", \"ASP.NET Core project with Ocelot\\u2019s NuGet package,](https://www.nuget.org/packages/Ocelot/)\\nfrom Visu\", \"al Studio.\\n\\n```\\nInstall-Package Ocelot\\n\\n```\\n\\nIn eShopOnContainers, its API Gateway implementation is\", \" a simple ASP.NET Core WebHost project,\\nand Ocelot\\u2019s middleware handles all the API Gateway features\", \", as shown in the following image:\\n\\n\\n_Figure 6-32. The OcelotApiGw base project in eShopOnContainers\", \"_\\n\\n\\nThis ASP.NET Core WebHost project is built with two simple files: Program.cs and Startup.cs.\\n\\n\\nT\", \"he Program.cs just needs to create and configure the typical ASP.NET Core BuildWebHost.\\n\\n\\n169 CHAPTE\", \"R 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nThe import\", \"ant point here for Ocelot is the configuration.json file that you must provide to the builder\\nthroug\", \"h the AddJsonFile() method. That configuration.json is where you specify all the API Gateway\\nReRoute\", \"s, meaning the external endpoints with specific ports and the correlated internal endpoints,\\nusually\", \" using different ports.\\n\\n\\nThere are two sections to the configuration. An array of ReRoutes and a Gl\", \"obalConfiguration. The\\nReRoutes are the objects that tell Ocelot how to treat an upstream request. T\", \"he Global configuration\\nallows overrides of ReRoute specific settings. It\\u2019s useful if you don\\u2019t want\", \" to manage lots of ReRoute\\nspecific settings.\\n\\n\\n[Here\\u2019s a simplified example of ReRoute configuratio\", \"n file](https://github.com/dotnet-architecture/eShopOnContainers/blob/main/src/ApiGateways/Mobile.Bf\", \"f.Shopping/apigw/configuration.json) from one of the API Gateways from\\neShopOnContainers.\\n\\n\\n170 CHAP\", \"TER 5 | Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nThe main\", \" functionality of an Ocelot API Gateway is to take incoming HTTP requests and forward them\\non to a d\", \"ownstream service, currently as another HTTP request. Ocelot\\u2019s describes the routing of one\\nrequest \", \"to another as a ReRoute.\\n\\n\\nFor instance, let\\u2019s focus on one of the ReRoutes in the configuration.jso\", \"n from above, the\\nconfiguration for the Basket microservice.\\n\\n\\nThe DownstreamPathTemplate, Scheme, a\", \"nd DownstreamHostAndPorts make the internal\\nmicroservice URL that this request will be forwarded to.\", \"\\n\\n\\nThe port is the internal port used by the service. When using containers, the port specified at i\", \"ts\\ndockerfile.\\n\\n\\nThe Host is a service name that depends on the service name resolution you are usin\", \"g. When using\\ndocker-compose, the services names are provided by the Docker Host, which is using the\", \" service\\nnames provided in the docker-compose files. If using an orchestrator like Kubernetes or Ser\", \"vice\\nFabric, that name should be resolved by the DNS or name resolution provided by each orchestrato\", \"r.\\n\\n\\nDownstreamHostAndPorts is an array that contains the host and port of any downstream services t\", \"hat\\nyou wish to forward requests to. Usually this configuration will just contain one entry but some\", \"times\\nyou might want to load balance requests to your downstream services and Ocelot lets you add mo\", \"re\\nthan one entry and then select a load balancer. But if using Azure and any orchestrator it is pro\", \"bably a\\nbetter idea to load balance with the cloud and orchestrator infrastructure.\\n\\n\\nThe UpstreamPa\", \"thTemplate is the URL that Ocelot will use to identify which\\nDownstreamPathTemplate to use for a giv\", \"en request from the client. Finally, the\\nUpstreamHttpMethod is used so Ocelot can distinguish betwee\", \"n different requests (GET, POST, PUT)\\nto the same URL.\\n\\n\\nAt this point, you could have a single Ocel\", \"ot API Gateway (ASP.NET Core WebHost) using one or\\n[multiple merged configuration.json files or you \", \"can also store the configuration in a Consul KV store.](https://ocelot.readthedocs.io/en/latest/feat\", \"ures/configuration.html#merging-configuration-files)\\n\\n\\nBut as introduced in the architecture and des\", \"ign sections, if you really want to have autonomous\\nmicroservices, it might be better to split that \", \"single monolithic API Gateway into multiple API\\nGateways and/or BFF (Backend for Frontend). For that\", \" purpose, let\\u2019s see how to implement that\\napproach with Docker containers.\\n\\n\\n171 CHAPTER 5 | Designi\", \"ng and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n**Using a single Docker\", \" container image to run multiple different API Gateway / BFF**\\n**container types**\\n\\n\\nIn eShopOnConta\", \"iners, we\\u2019re using a single Docker container image with the Ocelot API Gateway but\\nthen, at run time\", \", we create different services/containers for each type of API-Gateway/BFF by\\nproviding a different \", \"configuration.json file, using a docker volume to access a different PC folder for\\neach service.\\n\\n\\n_\", \"Figure 6-33. Reusing a single Ocelot Docker image across multiple API Gateway types_\\n\\n\\nIn eShopOnCon\", \"tainers, the \\u201cGeneric Ocelot API Gateway Docker Image\\u201d is created with the project\\nnamed \\u2018OcelotApiG\", \"w\\u2019 and the image name \\u201ceshop/ocelotapigw\\u201d that is specified in the dockercompose.yml file. Then, whe\", \"n deploying to Docker, there will be four API-Gateway containers created\\nfrom that same Docker image\", \", as shown in the following extract from the docker-compose.yml file.\\n\\n\\n172 CHAPTER 5 | Designing an\", \"d Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\nAdditionally, as you can see\", \" in the following docker-compose.override.yml file, the only difference\\nbetween those API Gateway co\", \"ntainers is the Ocelot configuration file, which is different for each\\nservice container and it\\u2019s sp\", \"ecified at run time through a Docker volume.\\n\\n\\n173 CHAPTER 5 | Designing and Developing Multi-Contai\", \"ner and Microservice-Based .NET Applications\\n\\n\\nBecause of that previous code, and as shown in the Vi\", \"sual Studio Explorer below, the only file needed\\nto define each specific business/BFF API Gateway is\", \" just a configuration.json file, because the four API\\nGateways are based on the same Docker image.\\n\\n\", \"\\n_Figure 6-34. The only file needed to define each API Gateway / BFF with Ocelot is a configuration \", \"file_\\n\\n\\nBy splitting the API Gateway into multiple API Gateways, different development teams focusin\", \"g on\\ndifferent subsets of microservices can manage their own API Gateways by using independent Ocelo\", \"t\\nconfiguration files. Plus, at the same time they can reuse the same Ocelot Docker image.\\n\\n\\nNow, if\", \" you run eShopOnContainers with the API Gateways (included by default in VS when opening\\neShopOnCont\", \"ainers-ServicesAndWebApps.sln solution or if running \\u201cdocker-compose up\\u201d), the\\nfollowing sample rout\", \"es will be performed.\\n\\n\\nFor instance, when visiting the upstream URL\\nhttp://host.docker.internal:520\", \"2/api/v1/c/catalog/items/2/ served by the webshoppingapigw API\\nGateway, you get the same result from\", \" the internal Downstream URL http://catalog-api/api/v1/2\\nwithin the Docker host, as in the following\", \" browser.\\n\\n\\n_Figure 6-35. Accessing a microservice through a URL provided by the API Gateway_\\n\\n\\nBeca\", \"use of testing or debugging reasons, if you wanted to directly access to the Catalog Docker\\ncontaine\", \"r (only at the development environment) without passing through the API Gateway, since\\n\\u2018catalog-api\\u2019\", \" is a DNS resolution internal to the Docker host (service discovery handled by dockercompose service\", \" names), the only way to directly access the container is through the external port\\npublished in the\", \" docker-compose.override.yml, which is provided only for development tests, such as\\nhttp://host.dock\", \"er.internal:5101/api/v1/Catalog/items/1 in the following browser.\\n\\n\\n174 CHAPTER 5 | Designing and De\", \"veloping Multi-Container and Microservice-Based .NET Applications\\n\\n\\n_Figure 6-36. Direct access to a\", \" microservice for testing purposes_\\n\\n\\nBut the application is configured so it accesses all the micro\", \"services through the API Gateways, not\\nthrough the direct port \\u201cshortcuts\\u201d.\\n\\n\\n**The Gateway aggregat\", \"ion pattern in eShopOnContainers**\\n\\n\\nAs introduced previously, a flexible way to implement requests \", \"aggregation is with custom services, by\\n[code. You could also implement request aggregation with the\", \" Request Aggregation feature in Ocelot,](https://ocelot.readthedocs.io/en/latest/features/requestagg\", \"regation.html#request-aggregation)\\nbut it might not be as flexible as you need. Therefore, the selec\", \"ted way to implement aggregation in\\neShopOnContainers is with an explicit ASP.NET Core Web API servi\", \"ce for each aggregator.\\n\\n\\nAccording to that approach, the API Gateway composition diagram is in real\", \"ity a bit more extended\\nwhen considering the aggregator services that are not shown in the simplifie\", \"d global architecture\\ndiagram shown previously.\\n\\n\\nIn the following diagram, you can also see how the\", \" aggregator services work with their related API\\nGateways.\\n\\n\\n_Figure 6-37. eShopOnContainers archite\", \"cture with aggregator services_\\n\\n\\nZooming in further, on the \\u201cShopping\\u201d business area in the followi\", \"ng image, you can see that\\nchattiness between the client apps and the microservices is reduced when \", \"using the aggregator\\nservices in the API Gateways.\\n\\n\\n175 CHAPTER 5 | Designing and Developing Multi-\", \"Container and Microservice-Based .NET Applications\\n\\n\\n_Figure 6-38. Zoom in vision of the Aggregator \", \"services_\\n\\n\\nYou can notice how when the diagram shows the possible requests coming from the API Gate\", \"ways it\\ncan get complex. On the other hand, when you use the aggregator pattern, you can see how the\", \"\\narrows in blue would simplify the communication from a client app perspective. This pattern not onl\", \"y\\nhelps to reduce the chattiness and latency in the communication, it also improves the user experie\", \"nce\\nsignificantly for the remote apps (mobile and SPA apps).\\n\\n\\nIn the case of the \\u201cMarketing\\u201d busine\", \"ss area and microservices, it is a simple use case so there was no\\nneed to use aggregators, but it c\", \"ould also be possible, if needed.\\n\\n\\n**Authentication and authorization in Ocelot API Gateways**\\n\\n\\nIn\", \" an Ocelot API Gateway, you can sit the authentication service, such as an ASP.NET Core Web API\\n[ser\", \"vice using IdentityServer providing the auth token, either out or inside the API Gateway.](https://d\", \"ocs.microsoft.com/dotnet/architecture/cloud-native/identity-server)\\n\\n\\nSince eShopOnContainers is usi\", \"ng multiple API Gateways with boundaries based on BFF and business\\nareas, the Identity/Auth service \", \"is left out of the API Gateways, as highlighted in yellow in the\\nfollowing diagram.\\n\\n\\n176 CHAPTER 5 \", \"| Designing and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n_Figure 6-39. \", \"Position of the Identity service in eShopOnContainers_\\n\\n\\nHowever, Ocelot also supports sitting the I\", \"dentity/Auth microservice within the API Gateway\\nboundary, as in this other diagram.\\n\\n\\n_Figure 6-40.\", \" Authentication in Ocelot_\\n\\n\\nAs the previous diagram shows, when the Identity microservice is beneat\", \"h the API gateway (AG): 1) AG\\nrequests an auth token from identity microservice, 2) The identity mic\", \"roservice returns token to AG, 34) AG requests from microservices using the auth token. Because eSho\", \"pOnContainers application has\\nsplit the API Gateway into multiple BFF (Backend for Frontend) and bus\", \"iness areas API Gateways,\\nanother option would have been to create an additional API Gateway for cro\", \"ss-cutting concerns. That\\nchoice would be fair in a more complex microservice based architecture wit\", \"h multiple cross-cutting\\nconcerns microservices. Since there\\u2019s only one cross-cutting concern in eSh\", \"opOnContainers, it was\\ndecided to just handle the security service out of the API Gateway realm, for\", \" simplicity\\u2019s sake.\\n\\n\\n177 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Base\", \"d .NET Applications\\n\\n\\nIn any case, if the app is secured at the API Gateway level, the authenticatio\", \"n module of the Ocelot\\nAPI Gateway is visited at first when trying to use any secured microservice. \", \"That redirects the HTTP\\nrequest to visit the Identity or auth microservice to get the access token s\", \"o you can visit the protected\\nservices with the access_token.\\n\\n\\nThe way you secure with authenticati\", \"on any service at the API Gateway level is by setting the\\nAuthenticationProviderKey in its related s\", \"ettings at the configuration.json.\\n\\n\\nWhen Ocelot runs, it will look at the ReRoutes AuthenticationOp\", \"tions.AuthenticationProviderKey and\\ncheck that there is an Authentication Provider registered with t\", \"he given key. If there isn\\u2019t, then Ocelot\\nwill not start up. If there is, then the ReRoute will use \", \"that provider when it executes.\\n\\n\\nBecause the Ocelot WebHost is configured with the authenticationPr\", \"oviderKey = \\\"IdentityApiKey\\\",\\nthat will require authentication whenever that service has any request\", \"s without any auth token.\\n\\n\\n178 CHAPTER 5 | Designing and Developing Multi-Container and Microservic\", \"e-Based .NET Applications\\n\\n\\nThen, you also need to set authorization with the [Authorize] attribute \", \"on any resource to be accessed\\nlike the microservices, such as in the following Basket microservice \", \"controller.\\n\\n\\nThe ValidAudiences such as \\u201cbasket\\u201d are correlated with the audience defined in each m\", \"icroservice\\nwith AddJwtBearer() at the ConfigureServices() of the Startup class, such as in the code\", \" below.\\n\\n\\nIf you try to access any secured microservice, like the Basket microservice with a ReRoute\", \" URL based\\non the API Gateway like http://host.docker.internal:5202/api/v1/b/basket/1, then you\\u2019ll g\", \"et a 401\\nUnauthorized unless you provide a valid token. On the other hand, if a ReRoute URL is authe\", \"nticated,\\nOcelot will invoke whatever downstream scheme is associated with it (the internal microser\", \"vice URL).\\n\\n\\n**Authorization at Ocelot\\u2019s ReRoutes tier.** Ocelot supports claims-based authorization\", \" evaluated after\\nthe authentication. You set the authorization at a route level by adding the follow\", \"ing lines to the\\nReRoute configuration.\\n\\n\\nIn that example, when the authorization middleware is call\", \"ed, Ocelot will find if the user has the claim\\ntype \\u2018UserType\\u2019 in the token and if the value of that\", \" claim is \\u2018employee\\u2019. If it isn\\u2019t, then the user will not\\nbe authorized and the response will be 403\", \" forbidden.\\n\\n\\n179 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Based .NET A\", \"pplications\\n\\n\\n#### **Using Kubernetes Ingress plus Ocelot API Gateways**\\n\\nWhen using Kubernetes (lik\", \"e in an Azure Kubernetes Service cluster), you usually unify all the HTTP\\n[requests through the Kube\", \"rnetes Ingress tier based on](https://kubernetes.io/docs/concepts/services-networking/ingress/) _Ngi\", \"nx_ .\\n\\n\\nIn Kubernetes, if you don\\u2019t use any ingress approach, then your services and pods have IPs o\", \"nly\\nroutable by the cluster network.\\n\\n\\nBut if you use an ingress approach, you\\u2019ll have a middle tier\", \" between the Internet and your services\\n(including your API Gateways), acting as a reverse proxy.\\n\\n\\n\", \"As a definition, an Ingress is a collection of rules that allow inbound connections to reach the clu\", \"ster\\nservices. An ingress is configured to provide services externally reachable URLs, load balance \", \"traffic,\\nSSL termination and more. Users request ingress by POSTing the Ingress resource to the API \", \"server.\\n\\n\\nIn eShopOnContainers, when developing locally and using just your development machine as t\", \"he\\nDocker host, you are not using any ingress but only the multiple API Gateways.\\n\\n\\nHowever, when ta\", \"rgeting a \\u201cproduction\\u201d environment based on Kubernetes, eShopOnContainers is\\nusing an ingress in fro\", \"nt of the API gateways. That way, the clients still call the same base URL but the\\nrequests are rout\", \"ed to multiple API Gateways or BFF.\\n\\n\\nAPI Gateways are front-ends or fa\\u00e7ades surfacing only the serv\", \"ices but not the web applications that\\nare usually out of their scope. In addition, the API Gateways\", \" might hide certain internal microservices.\\n\\n\\nThe ingress, however, is just redirecting HTTP request\", \"s but not trying to hide any microservice or web\\napp.\\n\\n\\nHaving an ingress Nginx tier in Kubernetes i\", \"n front of the web applications plus the several Ocelot API\\nGateways / BFF is the ideal architecture\", \", as shown in the following diagram.\\n\\n\\n_Figure 6-41. The ingress tier in eShopOnContainers when depl\", \"oyed into Kubernetes_\\n\\n\\nA Kubernetes Ingress acts as a reverse proxy for all traffic to the app, inc\", \"luding the web applications,\\nthat are out of the Api gateway scope. When you deploy eShopOnContainer\", \"s into Kubernetes, it\\n\\n\\n180 CHAPTER 5 | Designing and Developing Multi-Container and Microservice-Ba\", \"sed .NET Applications\\n\\n\\nexposes just a few services or endpoints via _ingress_, basically the follow\", \"ing list of postfixes on the\\nURLs:\\n\\n\\n  - / for the client SPA web application\\n\\n  - /webmvc for the c\", \"lient MVC web application\\n\\n  - /webstatus for the client web app showing the status/healthchecks\\n\\n  \", \"- /webshoppingapigw for the web BFF and shopping business processes\\n\\n  - /webmarketingapigw for the \", \"web BFF and marketing business processes\\n\\n  - /mobileshoppingapigw for the mobile BFF and shopping b\", \"usiness processes\\n\\n  - /mobilemarketingapigw for the mobile BFF and marketing business processes\\n\\n\\nW\", \"hen deploying to Kubernetes, each Ocelot API Gateway is using a different \\u201cconfiguration.json\\u201d file\\n\", \"for each _pod_ running the API Gateways. Those \\u201cconfiguration.json\\u201d files are provided by mounting\\n(\", \"originally with the deploy.ps1 script) a volume created based on a Kubernetes _config map_ named\\n\\u2018oc\", \"elot\\u2019. Each container mounts its related configuration file in the container\\u2019s folder named\\n/app/con\", \"figuration.\\n\\n\\nIn the source code files of eShopOnContainers, the original \\u201cconfiguration.json\\u201d files\", \" can be found\\nwithin the k8s/ocelot/ folder. There\\u2019s one file for each BFF/APIGateway.\\n\\n#### **Addit\", \"ional cross-cutting features in an Ocelot API Gateway**\\n\\n\\nThere are other important features to rese\", \"arch and use, when using an Ocelot API Gateway, described\\nin the following links.\\n\\n\\n  - **Service di\", \"scovery in the client side integrating Ocelot with Consul or Eureka**\\n[https://ocelot.readthedocs.io\", \"/en/latest/features/servicediscovery.html](https://ocelot.readthedocs.io/en/latest/features/serviced\", \"iscovery.html)\\n\\n\\n  - **Caching at the API Gateway tier**\\n[https://ocelot.readthedocs.io/en/latest/fe\", \"atures/caching.html](https://ocelot.readthedocs.io/en/latest/features/caching.html)\\n\\n\\n  - **Logging \", \"at the API Gateway tier**\\n[https://ocelot.readthedocs.io/en/latest/features/logging.html](https://oc\", \"elot.readthedocs.io/en/latest/features/logging.html)\\n\\n\\n  - **Quality of Service (Retries and Circuit\", \" breakers) at the API Gateway tier**\\n[https://ocelot.readthedocs.io/en/latest/features/qualityofserv\", \"ice.html](https://ocelot.readthedocs.io/en/latest/features/qualityofservice.html)\\n\\n\\n  - **Rate limit\", \"ing**\\n[https://ocelot.readthedocs.io/en/latest/features/ratelimiting.html](https://ocelot.readthedoc\", \"s.io/en/latest/features/ratelimiting.html)\\n\\n\\n  - **Swagger for Ocelot**\\n[https://github.com/Burgyn/M\", \"MLib.SwaggerForOcelot](https://github.com/Burgyn/MMLib.SwaggerForOcelot)\\n\\n\\n181 CHAPTER 5 | Designing\", \" and Developing Multi-Container and Microservice-Based .NET Applications\\n\\n\\n**CHAPTER**\\n# 6\\n\\n## Tackl\", \"e Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n_Design a domain model for each\", \" microservice or Bounded Context that reflects understanding of the_\\n_business domain._\\n\\n\\nThis secti\", \"on focuses on more advanced microservices that you implement when you need to tackle\\ncomplex subsyst\", \"ems, or microservices derived from the knowledge of domain experts with everchanging business rules.\", \" The architecture patterns used in this section are based on domain-driven\\ndesign (DDD) and Command \", \"and Query Responsibility Segregation (CQRS) approaches, as illustrated\\nin Figure 7-1.\\n\\n\\n182 CHAPTER \", \"6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n_Figure 7-1. External \", \"microservice architecture versus internal architecture patterns for each microservice_\\n\\n\\nHowever, mo\", \"st of the techniques for data driven microservices, such as how to implement an ASP.NET\\nCore Web API\", \" service or how to expose Swagger metadata with Swashbuckle or NSwag, are also\\napplicable to the mor\", \"e advanced microservices implemented internally with DDD patterns. This\\nsection is an extension of t\", \"he previous sections, because most of the practices explained earlier also\\napply here or for any kin\", \"d of microservice.\\n\\n\\nThis section first provides details on the simplified CQRS patterns used in the\", \" eShopOnContainers\\nreference application. Later, you will get an overview of the DDD techniques that\", \" enable you to find\\ncommon patterns that you can reuse in your applications.\\n\\n\\n[DDD is a large topic\", \" with a rich set of resources for learning. You can start with books like Domain-](https://domainlan\", \"guage.com/ddd/)\\n[Driven Design](https://domainlanguage.com/ddd/) by Eric Evans and additional materi\", \"als from Vaughn Vernon, Jimmy Nilsson, Greg\\nYoung, Udi Dahan, Jimmy Bogard, and many other DDD/CQRS \", \"experts. But most of all you need to try\\nto learn how to apply DDD techniques from the conversations\", \", whiteboarding, and domain modeling\\nsessions with the experts in your concrete business domain.\\n\\n\\n*\", \"*Additional resources**\\n\\n\\n**DDD (Domain-Driven Design)**\\n\\n\\n  - **Eric Evans. Domain Language**\\n[http\", \"s://domainlanguage.com/](https://domainlanguage.com/)\\n\\n\\n  - **Martin Fowler. Domain-Driven Design**\\n\", \"[https://martinfowler.com/tags/domain%20driven%20design.html](https://martinfowler.com/tags/domain%2\", \"0driven%20design.html)\\n\\n\\n  - **Jimmy Bogard. Strengthening your domain: a primer**\\n[https://lostechi\", \"es.com/jimmybogard/2010/02/04/strengthening-your-domain-a-primer/](https://lostechies.com/jimmybogar\", \"d/2010/02/04/strengthening-your-domain-a-primer/)\\n\\n\\n183 CHAPTER 6 | Tackle Business Complexity in a \", \"Microservice with DDD and CQRS Patterns\\n\\n\\n**DDD books**\\n\\n\\n  - **Eric Evans. Domain-Driven Design: Ta\", \"ckling Complexity in the Heart of Software**\\n[https://www.amazon.com/Domain-Driven-Design-Tackling-C\", \"omplexity-](https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215/)\", \"\\n[Software/dp/0321125215/](https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/\", \"dp/0321125215/)\\n\\n\\n  - **Eric Evans. Domain-Driven Design Reference: Definitions and Pattern Summarie\", \"s**\\n[https://www.amazon.com/Domain-Driven-Design-Reference-Definitions-2014-09-](https://www.amazon.\", \"com/Domain-Driven-Design-Reference-Definitions-2014-09-22/dp/B01N8YB4ZO/)\\n[22/dp/B01N8YB4ZO/](https:\", \"//www.amazon.com/Domain-Driven-Design-Reference-Definitions-2014-09-22/dp/B01N8YB4ZO/)\\n\\n\\n  - **Vaugh\", \"n Vernon. Implementing Domain-Driven Design**\\n[https://www.amazon.com/Implementing-Domain-Driven-Des\", \"ign-Vaughn-](https://www.amazon.com/Implementing-Domain-Driven-Design-Vaughn-Vernon/dp/0321834577/)\\n\", \"[Vernon/dp/0321834577/](https://www.amazon.com/Implementing-Domain-Driven-Design-Vaughn-Vernon/dp/03\", \"21834577/)\\n\\n\\n  - **Vaughn Vernon. Domain-Driven Design Distilled**\\n[https://www.amazon.com/Domain-Dr\", \"iven-Design-Distilled-Vaughn-Vernon/dp/0134434420/](https://www.amazon.com/Domain-Driven-Design-Dist\", \"illed-Vaughn-Vernon/dp/0134434420/)\\n\\n\\n  - **Jimmy Nilsson. Applying Domain-Driven Design and Pattern\", \"s**\\n[https://www.amazon.com/Applying-Domain-Driven-Design-Patterns-](https://www.amazon.com/Applying\", \"-Domain-Driven-Design-Patterns-Examples/dp/0321268202/)\\n[Examples/dp/0321268202/](https://www.amazon\", \".com/Applying-Domain-Driven-Design-Patterns-Examples/dp/0321268202/)\\n\\n\\n  - **Cesar de la Torre. N-La\", \"yered Domain-Oriented Architecture Guide with .NET**\\n[https://www.amazon.com/N-Layered-Domain-Orient\", \"ed-Architecture-Guide-](https://www.amazon.com/N-Layered-Domain-Oriented-Architecture-Guide-NET/dp/8\", \"493903612/)\\n[NET/dp/8493903612/](https://www.amazon.com/N-Layered-Domain-Oriented-Architecture-Guide\", \"-NET/dp/8493903612/)\\n\\n\\n  - **Abel Avram and Floyd Marinescu. Domain-Driven Design Quickly**\\n[https:/\", \"/www.amazon.com/Domain-Driven-Design-Quickly-Abel-Avram/dp/1411609255/](https://www.amazon.com/Domai\", \"n-Driven-Design-Quickly-Abel-Avram/dp/1411609255/)\\n\\n\\n  - **Scott Millett, Nick Tune - Patterns, Prin\", \"ciples, and Practices of Domain-Driven Design**\\n[https://www.wiley.com/Patterns%2C+Principles%2C+and\", \"+Practices+of+Domain+Driven+Des](https://www.wiley.com/Patterns%2C+Principles%2C+and+Practices+of+Do\", \"main+Driven+Design-p-9781118714706)\\n[ign-p-9781118714706](https://www.wiley.com/Patterns%2C+Principl\", \"es%2C+and+Practices+of+Domain+Driven+Design-p-9781118714706)\\n\\n\\n**DDD training**\\n\\n\\n  - **Julie Lerman\", \" and Steve Smith. Domain-Driven Design Fundamentals**\\n[https://www.pluralsight.com/courses/fundament\", \"als-domain-driven-design](https://www.pluralsight.com/courses/fundamentals-domain-driven-design)\\n\\n##\", \"# Apply simplified CQRS and DDD patterns in a microservice\\n\\n\\nCQRS is an architectural pattern that s\", \"eparates the models for reading and writing data. The related\\n[term Command Query Separation (CQS) w\", \"as originally defined by Bertrand Meyer in his book](https://martinfowler.com/bliki/CommandQuerySepa\", \"ration.html) _Object-_\\n_Oriented Software Construction_ . The basic idea is that you can divide a sy\", \"stem\\u2019s operations into two\\nsharply separated categories:\\n\\n\\n  - Queries. These queries return a resul\", \"t and don\\u2019t change the state of the system, and they\\u2019re\\nfree of side effects.\\n\\n\\n  - Commands. These \", \"commands change the state of a system.\\n\\n\\n184 CHAPTER 6 | Tackle Business Complexity in a Microservic\", \"e with DDD and CQRS Patterns\\n\\n\\nCQS is a simple concept: it is about methods within the same object b\", \"eing either queries or\\ncommands. Each method either returns state or mutates state, but not both. Ev\", \"en a single repository\\npattern object can comply with CQS. CQS can be considered a foundational prin\", \"ciple for CQRS.\\n\\n\\n[Command and Query Responsibility Segregation (CQRS)](https://martinfowler.com/bli\", \"ki/CQRS.html) was introduced by Greg Young and strongly\\npromoted by Udi Dahan and others. It\\u2019s based\", \" on the CQS principle, although it\\u2019s more detailed. It can\\nbe considered a pattern based on commands\", \" and events plus optionally on asynchronous messages.\\nIn many cases, CQRS is related to more advance\", \"d scenarios, like having a different physical database\\nfor reads (queries) than for writes (updates)\", \". Moreover, a more evolved CQRS system might\\n[implement Event-Sourcing (ES) for your updates databas\", \"e, so you would only store events in the](https://martinfowler.com/eaaDev/EventSourcing.html)\\ndomain\", \" model instead of storing the current-state data. However, this approach is not used in this\\nguide. \", \"This guide uses the simplest CQRS approach, which consists of just separating the queries from\\nthe c\", \"ommands.\\n\\n\\nThe separation aspect of CQRS is achieved by grouping query operations in one layer and c\", \"ommands\\nin another layer. Each layer has its own data model (note that we say model, not necessarily\", \" a different\\ndatabase) and is built using its own combination of patterns and technologies. More imp\", \"ortantly, the\\ntwo layers can be within the same tier or microservice, as in the example (ordering mi\", \"croservice) used\\nfor this guide. Or they could be implemented on different microservices or processe\", \"s so they can be\\noptimized and scaled out separately without affecting one another.\\n\\n\\nCQRS means hav\", \"ing two objects for a read/write operation where in other contexts there\\u2019s one. There\\nare reasons to\", \" have a denormalized reads database, which you can learn about in more advanced\\nCQRS literature. But\", \" we aren\\u2019t using that approach here, where the goal is to have more flexibility in\\nthe queries inste\", \"ad of limiting the queries with constraints from DDD patterns like aggregates.\\n\\n\\nAn example of this \", \"kind of service is the ordering microservice from the eShopOnContainers reference\\napplication. This \", \"service implements a microservice based on a simplified CQRS approach. It uses a\\nsingle data source \", \"or database, but two logical models plus DDD patterns for the transactional\\ndomain, as shown in Figu\", \"re 7-2.\\n\\n\\n185 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n\", \"_Figure 7-2. Simplified CQRS- and DDD-based microservice_\\n\\n\\nThe Logical \\u201cOrdering\\u201d Microservice incl\", \"udes its Ordering database, which can be, but doesn\\u2019t have to\\nbe, the same Docker host. Having the d\", \"atabase in the same Docker host is good for development, but\\nnot for production.\\n\\n\\nThe application l\", \"ayer can be the Web API itself. The important design aspect here is that the\\nmicroservice has split \", \"the queries and ViewModels (data models especially created for the client\\napplications) from the com\", \"mands, domain model, and transactions following the CQRS pattern. This\\napproach keeps the queries in\", \"dependent from restrictions and constraints coming from DDD patterns\\nthat only make sense for transa\", \"ctions and updates, as explained in later sections.\\n\\n#### **Additional resources**\\n\\n\\n  - **Greg Youn\", \"g. Versioning in an Event Sourced System** (Free to read online e-book)\\n[https://leanpub.com/esversi\", \"oning/read](https://leanpub.com/esversioning/read)\\n\\n### Apply CQRS and CQS approaches in a DDD micro\", \"service in eShopOnContainers\\n\\n\\nThe design of the ordering microservice at the eShopOnContainers refe\", \"rence application is based on\\nCQRS principles. However, it uses the simplest approach, which is just\", \" separating the queries from the\\ncommands and using the same database for both actions.\\n\\n\\nThe essenc\", \"e of those patterns, and the important point here, is that queries are idempotent: no matter\\nhow man\", \"y times you query a system, the state of that system won\\u2019t change. In other words, queries\\nare side-\", \"effect free.\\n\\n\\n186 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patter\", \"ns\\n\\n\\nTherefore, you could use a different \\u201creads\\u201d data model than the transactional logic \\u201cwrites\\u201d d\", \"omain\\nmodel, even though the ordering microservices are using the same database. Hence, this is a\\nsi\", \"mplified CQRS approach.\\n\\n\\nOn the other hand, commands, which trigger transactions and data updates, \", \"change state in the\\nsystem. With commands, you need to be careful when dealing with complexity and e\", \"ver-changing\\nbusiness rules. This is where you want to apply DDD techniques to have a better modeled\", \" system.\\n\\n\\nThe DDD patterns presented in this guide should not be applied universally. They introduc\", \"e\\nconstraints on your design. Those constraints provide benefits such as higher quality over time,\\ne\", \"specially in commands and other code that modifies system state. However, those constraints add\\ncomp\", \"lexity with fewer benefits for reading and querying data.\\n\\n\\nOne such pattern is the Aggregate patter\", \"n, which we examine more in later sections. Briefly, in the\\nAggregate pattern, you treat many domain\", \" objects as a single unit as a result of their relationship in\\nthe domain. You might not always gain\", \" advantages from this pattern in queries; it can increase the\\ncomplexity of query logic. For read-on\", \"ly queries, you do not get the advantages of treating multiple\\nobjects as a single Aggregate. You on\", \"ly get the complexity.\\n\\n\\nAs shown in Figure 7-2 in the previous section, this guide suggests using D\", \"DD patterns only in the\\ntransactional/updates area of your microservice (that is, as triggered by co\", \"mmands). Queries can\\nfollow a simpler approach and should be separated from commands, following a CQ\", \"RS approach.\\n\\n\\nFor implementing the \\u201cqueries side\\u201d, you can choose between many approaches, from you\", \"r full-blown\\nORM like EF Core, AutoMapper projections, stored procedures, views, materialized views \", \"or a micro\\nORM.\\n\\n\\nIn this guide and in eShopOnContainers (specifically the ordering microservice) we\", \" chose to\\n[implement straight queries using a micro ORM like Dapper. This guide lets you implement a\", \"ny query](https://github.com/StackExchange/dapper-dot-net)\\nbased on SQL statements to get the best p\", \"erformance, thanks to a light framework with little\\noverhead.\\n\\n\\nWhen you use this approach, any upda\", \"tes to your model that impact how entities are persisted to a\\nSQL database also need separate update\", \"s to SQL queries used by Dapper or any other separate (nonEF) approaches to querying.\\n\\n#### **CQRS a\", \"nd DDD patterns are not top-level architectures**\\n\\n\\nIt\\u2019s important to understand that CQRS and most \", \"DDD patterns (like DDD layers or a domain model\\nwith aggregates) are not architectural styles, but o\", \"nly architecture patterns. Microservices, SOA, and\\nevent-driven architecture (EDA) are examples of a\", \"rchitectural styles. They describe a system of many\\ncomponents, such as many microservices. CQRS and\", \" DDD patterns describe something inside a single\\nsystem or component; in this case, something inside\", \" a microservice.\\n\\n\\nDifferent Bounded Contexts (BCs) will employ different patterns. They have differ\", \"ent responsibilities,\\nand that leads to different solutions. It is worth emphasizing that forcing th\", \"e same pattern everywhere\\nleads to failure. Do not use CQRS and DDD patterns everywhere. Many subsys\", \"tems, BCs, or\\nmicroservices are simpler and can be implemented more easily using simple CRUD service\", \"s or using\\nanother approach.\\n\\n\\n187 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD\", \" and CQRS Patterns\\n\\n\\nThere is only one application architecture: the architecture of the system or e\", \"nd-to-end application\\nyou are designing (for example, the microservices architecture). However, the \", \"design of each Bounded\\nContext or microservice within that application reflects its own tradeoffs an\", \"d internal design decisions\\nat an architecture patterns level. Do not try to apply the same architec\", \"tural patterns as CQRS or DDD\\neverywhere.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Martin Fowler. CQRS**\\n[\", \"https://martinfowler.com/bliki/CQRS.html](https://martinfowler.com/bliki/CQRS.html)\\n\\n\\n  - **Greg You\", \"ng. CQRS Documents**\\n[https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf](https://cqrs.file\", \"s.wordpress.com/2010/11/cqrs_documents.pdf)\\n\\n\\n  - **Udi Dahan. Clarified CQRS**\\n[https://udidahan.co\", \"m/2009/12/09/clarified-cqrs/](https://udidahan.com/2009/12/09/clarified-cqrs/)\\n\\n### Implement reads/\", \"queries in a CQRS microservice\\n\\n\\nFor reads/queries, the ordering microservice from the eShopOnContai\", \"ners reference application\\nimplements the queries independently from the DDD model and transactional\", \" area. This\\nimplementation was done primarily because the demands for queries and for transactions a\", \"re\\ndrastically different. Writes execute transactions that must be compliant with the domain logic.\\n\", \"Queries, on the other hand, are idempotent and can be segregated from the domain rules.\\n\\n\\nThe approa\", \"ch is simple, as shown in Figure 7-3. The API interface is implemented by the Web API\\ncontrollers us\", \"ing any infrastructure, such as a micro Object Relational Mapper (ORM) like Dapper, and\\nreturning dy\", \"namic ViewModels depending on the needs of the UI applications.\\n\\n\\n_Figure 7-3. The simplest approach\", \" for queries in a CQRS microservice_\\n\\n\\nThe simplest approach for the queries-side in a simplified CQ\", \"RS approach can be implemented by\\nquerying the database with a Micro-ORM like Dapper, returning dyna\", \"mic ViewModels. The query\\n\\n\\n188 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD an\", \"d CQRS Patterns\\n\\n\\ndefinitions query the database and return a dynamic ViewModel built on the fly for\", \" each query. Since\\nthe queries are idempotent, they won\\u2019t change the data no matter how many times y\", \"ou run a query.\\nTherefore, you don\\u2019t need to be restricted by any DDD pattern used in the transactio\", \"nal side, like\\naggregates and other patterns, and that is why queries are separated from the transac\", \"tional area. You\\nquery the database for the data that the UI needs and return a dynamic ViewModel th\", \"at does not\\nneed to be statically defined anywhere (no classes for the ViewModels) except in the SQL\", \" statements\\nthemselves.\\n\\n\\nSince this approach is simple, the code required for the queries side (suc\", \"h as code using a micro ORM\\n[like Dapper) can be implemented within the same Web API project. Figure\", \" 7-4 shows this approach.](https://github.com/StackExchange/Dapper)\\nThe queries are defined in the *\", \"*Ordering.API** microservice project within the eShopOnContainers\\nsolution.\\n\\n\\n_Figure 7-4. Queries i\", \"n the Ordering microservice in eShopOnContainers_\\n\\n#### **Use ViewModels specifically made for clien\", \"t apps, independent from** **domain model constraints**\\n\\n\\nSince the queries are performed to obtain \", \"the data needed by the client applications, the returned\\ntype can be specifically made for the clien\", \"ts, based on the data returned by the queries. These models,\\nor Data Transfer Objects (DTOs), are ca\", \"lled ViewModels.\\n\\n\\nThe returned data (ViewModel) can be the result of joining data from multiple ent\", \"ities or tables in the\\ndatabase, or even across multiple aggregates defined in the domain model for \", \"the transactional area.\\nIn this case, because you are creating queries independent of the domain mod\", \"el, the aggregates\\nboundaries and constraints are ignored and you\\u2019re free to query any table and col\", \"umn you might\\nneed. This approach provides great flexibility and productivity for the developers cre\", \"ating or updating\\nthe queries.\\n\\n\\nThe ViewModels can be static types defined in classes (as is implem\", \"ented in the ordering\\nmicroservice). Or they can be created dynamically based on the queries perform\", \"ed, which is agile for\\ndevelopers.\\n\\n#### **Use Dapper as a micro ORM to perform queries**\\n\\n\\nYou can \", \"use any micro ORM, Entity Framework Core, or even plain ADO.NET for querying. In the\\nsample applicat\", \"ion, Dapper was selected for the ordering microservice in eShopOnContainers as a\\ngood example of a p\", \"opular micro ORM. It can run plain SQL queries with great performance, because\\nit\\u2019s a light framewor\", \"k. Using Dapper, you can write a SQL query that can access and join multiple\\ntables.\\n\\n\\n189 CHAPTER 6\", \" | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nDapper is an open-sourc\", \"e project (original created by Sam Saffron), and is part of the building blocks\\n[used in Stack Overf\", \"low. To use Dapper, you just need to install it through the Dapper NuGet package,](https://stackover\", \"flow.com/)\\nas shown in the following figure:\\n\\n\\nYou also need to add a using directive so your code h\", \"as access to the Dapper extension methods.\\n\\n\\n[When you use Dapper in your code, you directly use the\", \" SqlConnection](https://learn.microsoft.com/dotnet/api/microsoft.data.sqlclient.sqlconnection) class\", \" available in the\\n[Microsoft.Data.SqlClient](https://learn.microsoft.com/dotnet/api/microsoft.data.s\", \"qlclient) namespace. Through the QueryAsync method and other extension methods\\n[that extend the SqlC\", \"onnection class, you can run queries in a straightforward and performant way.](https://learn.microso\", \"ft.com/dotnet/api/microsoft.data.sqlclient.sqlconnection)\\n\\n#### **Dynamic versus static ViewModels**\", \"\\n\\n\\nWhen returning ViewModels from the server-side to client apps, you can think about those\\nViewMode\", \"ls as DTOs (Data Transfer Objects) that can be different to the internal domain entities of\\nyour ent\", \"ity model because the ViewModels hold the data the way the client app needs. Therefore, in\\nmany case\", \"s, you can aggregate data coming from multiple domain entities and compose the\\nViewModels precisely \", \"according to how the client app needs that data.\\n\\n\\nThose ViewModels or DTOs can be defined explicitl\", \"y (as data holder classes), like the OrderSummary\\nclass shown in a later code snippet. Or, you could\", \" just return dynamic ViewModels or dynamic DTOs\\nbased on the attributes returned by your queries as \", \"a dynamic type.\\n\\n\\n**ViewModel as dynamic type**\\n\\n\\nAs shown in the following code, a ViewModel can be\", \" directly returned by the queries by just returning\\na _dynamic_ type that internally is based on the\", \" attributes returned by a query. That means that the\\nsubset of attributes to be returned is based on\", \" the query itself. Therefore, if you add a new column to\\nthe query or join, that data is dynamically\", \" added to the returned ViewModel.\\n\\n\\n190 CHAPTER 6 | Tackle Business Complexity in a Microservice wit\", \"h DDD and CQRS Patterns\\n\\n\\nThe important point is that by using a dynamic type, the returned collecti\", \"on of data is dynamically\\nassembled as the ViewModel.\\n\\n\\n**Pros:** This approach reduces the need to \", \"modify static ViewModel classes whenever you update the\\nSQL sentence of a query, making this design \", \"approach agile when coding, straightforward, and quick\\nto evolve in regard to future changes.\\n\\n\\n**Co\", \"ns:** In the long term, dynamic types can negatively impact the clarity and the compatibility of a\\ns\", \"ervice with client apps. In addition, middleware software like Swashbuckle cannot provide the same\\nl\", \"evel of documentation on returned types if using dynamic types.\\n\\n\\n**ViewModel as predefined DTO clas\", \"ses**\\n\\n\\n**Pros** : Having static, predefined ViewModel classes, like \\u201ccontracts\\u201d based on explicit D\", \"TO classes, is\\ndefinitely better for public APIs but also for long-term microservices, even if they \", \"are only used by the\\nsame application.\\n\\n\\nIf you want to specify response types for Swagger, you need\", \" to use explicit DTO classes as the return\\ntype. Therefore, predefined DTO classes allow you to offe\", \"r richer information from Swagger. That\\nimproves the API documentation and compatibility when consum\", \"ing an API.\\n\\n\\n**Cons** : As mentioned earlier, when updating the code, it takes some more steps to u\", \"pdate the DTO\\nclasses.\\n\\n\\n_Tip based on our experience_ : In the queries implemented at the Ordering \", \"microservice in\\neShopOnContainers, we started developing by using dynamic ViewModels as it was strai\", \"ghtforward\\nand agile on the early development stages. But, once the development was stabilized, we c\", \"hose to\\nrefactor the APIs and use static or pre-defined DTOs for the ViewModels, because it is clear\", \"er for the\\nmicroservice\\u2019s consumers to know explicit DTO types, used as \\u201ccontracts\\u201d.\\n\\n\\nIn the follow\", \"ing example, you can see how the query is returning data by using an explicit ViewModel\\nDTO class: t\", \"he OrderSummary class.\\n\\n\\n191 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and C\", \"QRS Patterns\\n\\n\\n**Describe response types of Web APIs**\\n\\n\\nDevelopers consuming web APIs and microserv\", \"ices are most concerned with what is returned\\u2014\\nspecifically response types and error codes (if not s\", \"tandard). The response types are handled in the\\nXML comments and data annotations.\\n\\n\\nWithout proper \", \"documentation in the Swagger UI, the consumer lacks knowledge of what types are\\nbeing returned or wh\", \"at HTTP codes can be returned. That problem is fixed by adding the\\n[Microsoft.AspNetCore.Mvc.Produce\", \"sResponseTypeAttribute, so Swashbuckle can generate richer](https://docs.microsoft.com/dotnet/api/mi\", \"crosoft.aspnetcore.mvc.producesresponsetypeattribute)\\ninformation about the API return model and val\", \"ues, as shown in the following code:\\n\\n\\nHowever, the ProducesResponseType attribute cannot use dynami\", \"c as a type but requires to use\\nexplicit types, like the OrderSummary ViewModel DTO, shown in the fo\", \"llowing example:\\n\\n\\n192 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Pa\", \"tterns\\n\\n\\nThis is another reason why explicit returned types are better than dynamic types, in the lo\", \"ng term.\\nWhen using the ProducesResponseType attribute, you can also specify what is the expected ou\", \"tcome\\nregarding possible HTTP errors/codes, like 200, 400, etc.\\n\\n\\nIn the following image, you can se\", \"e how Swagger UI shows the ResponseType information.\\n\\n\\n_Figure 7-5. Swagger UI showing response type\", \"s and possible HTTP status codes from a Web API_\\n\\n\\nThe image shows some example values based on the \", \"ViewModel types and the possible HTTP status\\ncodes that can be returned.\\n\\n#### **Additional resource\", \"s**\\n\\n\\n  - **Dapper**\\n[https://github.com/StackExchange/dapper-dot-net](https://github.com/StackExcha\", \"nge/dapper-dot-net)\\n\\n\\n  - **Julie Lerman. Data Points - Dapper, Entity Framework and Hybrid Apps (MS\", \"DN**\\n**magazine article)**\\n\\n\\n193 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD a\", \"nd CQRS Patterns\\n\\n\\n[https://learn.microsoft.com/archive/msdn-magazine/2016/may/data-points-dapper-en\", \"tity-](https://docs.microsoft.com/archive/msdn-magazine/2016/may/data-points-dapper-entity-framework\", \"-and-hybrid-apps)\\n[framework-and-hybrid-apps](https://docs.microsoft.com/archive/msdn-magazine/2016/\", \"may/data-points-dapper-entity-framework-and-hybrid-apps)\\n\\n\\n  - **ASP.NET Core Web API Help Pages usi\", \"ng Swagger**\\n[https://learn.microsoft.com/aspnet/core/tutorials/web-api-help-pages-using-](https://d\", \"ocs.microsoft.com/aspnet/core/tutorials/web-api-help-pages-using-swagger?tabs=visual-studio)\\n[swagge\", \"r?tabs=visual-studio](https://docs.microsoft.com/aspnet/core/tutorials/web-api-help-pages-using-swag\", \"ger?tabs=visual-studio)\\n\\n\\n  - **Create record types** [https://learn.microsoft.com/dotnet/csharp/wha\", \"ts-new/tutorials/records](https://docs.microsoft.com/dotnet/csharp/tutorials/records)\\n\\n### Design a \", \"DDD-oriented microservice\\n\\n\\nDomain-driven design (DDD) advocates modeling based on the reality of bu\", \"siness as relevant to your\\nuse cases. In the context of building applications, DDD talks about probl\", \"ems as domains. It describes\\nindependent problem areas as Bounded Contexts (each Bounded Context cor\", \"relates to a\\nmicroservice), and emphasizes a common language to talk about these problems. It also s\", \"uggests\\n[many technical concepts and patterns, like domain entities with rich models (no anemic-doma\", \"in](https://martinfowler.com/bliki/AnemicDomainModel.html)\\n[model), value objects, aggregates, and a\", \"ggregate root (or root entity) rules to support the internal](https://martinfowler.com/bliki/AnemicD\", \"omainModel.html)\\nimplementation. This section introduces the design and implementation of those inte\", \"rnal patterns.\\n\\n\\nSometimes these DDD technical rules and patterns are perceived as obstacles that ha\", \"ve a steep\\nlearning curve for implementing DDD approaches. But the important part is not the pattern\", \"s\\nthemselves, but organizing the code so it is aligned to the business problems, and using the same\\n\", \"business terms (ubiquitous language). In addition, DDD approaches should be applied only if you are\\n\", \"implementing complex microservices with significant business rules. Simpler responsibilities, like a\", \"\\nCRUD service, can be managed with simpler approaches.\\n\\n\\nWhere to draw the boundaries is the key tas\", \"k when designing and defining a microservice. DDD\\npatterns help you understand the complexity in the\", \" domain. For the domain model for each Bounded\\nContext, you identify and define the entities, value \", \"objects, and aggregates that model your domain.\\nYou build and refine a domain model that is containe\", \"d within a boundary that defines your context.\\nAnd that is explicit in the form of a microservice. T\", \"he components within those boundaries end up\\nbeing your microservices, although in some cases a BC o\", \"r business microservices can be composed of\\nseveral physical services. DDD is about boundaries and s\", \"o are microservices.\\n\\n#### **Keep the microservice context boundaries relatively small**\\n\\n\\nDetermini\", \"ng where to place boundaries between Bounded Contexts balances two competing goals.\\nFirst, you want \", \"to initially create the smallest possible microservices, although that should not be the\\nmain driver\", \"; you should create a boundary around things that need cohesion. Second, you want to\\navoid chatty co\", \"mmunications between microservices. These goals can contradict one another. You\\nshould balance them \", \"by decomposing the system into as many small microservices as you can until\\nyou see communication bo\", \"undaries growing quickly with each additional attempt to separate a new\\nBounded Context. Cohesion is\", \" key within a single bounded context.\\n\\n\\n[It is similar to the Inappropriate Intimacy code smell when\", \" implementing classes. If two microservices](https://sourcemaking.com/refactoring/smells/inappropria\", \"te-intimacy)\\nneed to collaborate a lot with each other, they should probably be the same microservic\", \"e.\\n\\n\\n194 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nAnoth\", \"er way to look at this aspect is autonomy. If a microservice must rely on another service to\\ndirectl\", \"y service a request, it is not truly autonomous.\\n\\n#### **Layers in DDD microservices**\\n\\n\\nMost enterp\", \"rise applications with significant business and technical complexity are defined by\\nmultiple layers.\", \" The layers are a logical artifact, and are not related to the deployment of the service.\\nThey exist\", \" to help developers manage the complexity in the code. Different layers (like the domain\\nmodel layer\", \" versus the presentation layer, etc.) might have different types, which mandate translations\\nbetween\", \" those types.\\n\\n\\nFor example, an entity could be loaded from the database. Then part of that informat\", \"ion, or an\\naggregation of information including additional data from other entities, can be sent to \", \"the client UI\\nthrough a REST Web API. The point here is that the domain entity is contained within t\", \"he domain\\nmodel layer and should not be propagated to other areas that it does not belong to, like t\", \"o the\\npresentation layer.\\n\\n\\nAdditionally, you need to have always-valid entities (see the Designing \", \"validations in the domain\\nmodel layer section) controlled by aggregate roots (root entities). Theref\", \"ore, entities should not be\\nbound to client views, because at the UI level some data might still not\", \" be validated. This reason is\\nwhat the ViewModel is for. The ViewModel is a data model exclusively f\", \"or presentation layer needs.\\nThe domain entities do not belong directly to the ViewModel. Instead, y\", \"ou need to translate between\\nViewModels and domain entities and vice versa.\\n\\n\\nWhen tackling complexi\", \"ty, it is important to have a domain model controlled by aggregate roots that\\nmake sure that all the\", \" invariants and rules related to that group of entities (aggregate) are performed\\nthrough a single e\", \"ntry-point or gate, the aggregate root.\\n\\n\\nFigure 7-5 shows how a layered design is implemented in th\", \"e eShopOnContainers application.\\n\\n\\n195 CHAPTER 6 | Tackle Business Complexity in a Microservice with\", \" DDD and CQRS Patterns\\n\\n\\n_Figure 7-5. DDD layers in the ordering microservice in eShopOnContainers_\\n\", \"\\n\\nThe three layers in a DDD microservice like Ordering. Each layer is a VS project: Application laye\", \"r is\\nOrdering.API, Domain layer is Ordering.Domain and the Infrastructure layer is Ordering.Infrastr\", \"ucture.\\nYou want to design the system so that each layer communicates only with certain other layers\", \". That\\napproach may be easier to enforce if layers are implemented as different class libraries, bec\", \"ause you\\ncan clearly identify what dependencies are set between libraries. For instance, the domain \", \"model layer\\nshould not take a dependency on any other layer (the domain model classes should be Plai\", \"n Old Class\\n[Objects, or POCO, classes). As shown in Figure 7-6, the](https://docs.microsoft.com/dot\", \"net/standard/glossary#poco) **Ordering.Domain** layer library has\\ndependencies only on the .NET libr\", \"aries or NuGet packages, but not on any other custom library, such\\nas data library or persistence li\", \"brary.\\n\\n\\n_Figure 7-6. Layers implemented as libraries allow better control of dependencies between l\", \"ayers_\\n\\n\\n**The domain model layer**\\n\\n\\n[Eric Evans\\u2019s excellent book Domain Driven Design](https://dom\", \"ainlanguage.com/ddd/) says the following about the domain model layer\\nand the application layer.\\n\\n\\n*\", \"*Domain Model Layer** : Responsible for representing concepts of the business, information about the\", \"\\nbusiness situation, and business rules. State that reflects the business situation is controlled an\", \"d used\\nhere, even though the technical details of storing it are delegated to the infrastructure. Th\", \"is layer is\\nthe heart of business software.\\n\\n\\n196 CHAPTER 6 | Tackle Business Complexity in a Micros\", \"ervice with DDD and CQRS Patterns\\n\\n\\nThe domain model layer is where the business is expressed. When \", \"you implement a microservice\\ndomain model layer in .NET, that layer is coded as a class library with\", \" the domain entities that capture\\ndata plus behavior (methods with logic).\\n\\n\\n[Following the Persiste\", \"nce Ignorance and the Infrastructure Ignorance](https://deviq.com/persistence-ignorance/) principles\", \", this layer must\\ncompletely ignore data persistence details. These persistence tasks should be perf\", \"ormed by the\\ninfrastructure layer. Therefore, this layer should not take direct dependencies on the \", \"infrastructure,\\nwhich means that an important rule is that your domain model entity classes should b\", \"e POCOs.\\n\\n\\nDomain entities should not have any direct dependency (like deriving from a base class) o\", \"n any data\\naccess infrastructure framework like Entity Framework or NHibernate. Ideally, your domain\", \" entities\\nshould not derive from or implement any type defined in any infrastructure framework.\\n\\n\\nMo\", \"st modern ORM frameworks like Entity Framework Core allow this approach, so that your domain\\nmodel c\", \"lasses are not coupled to the infrastructure. However, having POCO entities is not always\\npossible w\", \"hen using certain NoSQL databases and frameworks, like Actors and Reliable Collections in\\nAzure Serv\", \"ice Fabric.\\n\\n\\nEven when it is important to follow the Persistence Ignorance principle for your Domai\", \"n model, you\\nshould not ignore persistence concerns. It is still important to understand the physica\", \"l data model and\\nhow it maps to your entity object model. Otherwise you can create impossible design\", \"s.\\n\\n\\nAlso, this aspect does not mean you can take a model designed for a relational database and dir\", \"ectly\\nmove it to a NoSQL or document-oriented database. In some entity models, the model might fit, \", \"but\\nusually it does not. There are still constraints that your entity model must adhere to, based bo\", \"th on\\nthe storage technology and ORM technology.\\n\\n\\n**The application layer**\\n\\n\\n[Moving on to the app\", \"lication layer, we can again cite Eric Evans\\u2019s book Domain Driven Design:](https://domainlanguage.co\", \"m/ddd/)\\n\\n\\n**Application Layer:** Defines the jobs the software is supposed to do and directs the exp\", \"ressive domain\\nobjects to work out problems. The tasks this layer is responsible for are meaningful \", \"to the business or\\nnecessary for interaction with the application layers of other systems. This laye\", \"r is kept thin. It does\\nnot contain business rules or knowledge, but only coordinates tasks and dele\", \"gates work to\\ncollaborations of domain objects in the next layer down. It does not have state reflec\", \"ting the business\\nsituation, but it can have state that reflects the progress of a task for the user\", \" or the program.\\n\\n\\nA microservice\\u2019s application layer in .NET is commonly coded as an ASP.NET Core W\", \"eb API project.\\nThe project implements the microservice\\u2019s interaction, remote network access, and th\", \"e external Web\\nAPIs used from the UI or client apps. It includes queries if using a CQRS approach, c\", \"ommands\\naccepted by the microservice, and even the event-driven communication between microservices\\n\", \"(integration events). The ASP.NET Core Web API that represents the application layer must not contai\", \"n\\nbusiness rules or domain knowledge (especially domain rules for transactions or updates); these\\nsh\", \"ould be owned by the domain model class library. The application layer must only coordinate tasks\\nan\", \"d must not hold or define any domain state (domain model). It delegates the execution of business\\nru\", \"les to the domain model classes themselves (aggregate roots and domain entities), which will\\nultimat\", \"ely update the data within those domain entities.\\n\\n\\n197 CHAPTER 6 | Tackle Business Complexity in a \", \"Microservice with DDD and CQRS Patterns\\n\\n\\nBasically, the application logic is where you implement al\", \"l use cases that depend on a given front end.\\nFor example, the implementation related to a Web API s\", \"ervice.\\n\\n\\nThe goal is that the domain logic in the domain model layer, its invariants, the data mode\", \"l, and\\nrelated business rules must be completely independent from the presentation and application l\", \"ayers.\\nMost of all, the domain model layer must not directly depend on any infrastructure framework.\", \"\\n\\n\\n**The infrastructure layer**\\n\\n\\nThe infrastructure layer is how the data that is initially held in\", \" domain entities (in memory) is persisted\\nin databases or another persistent store. An example is us\", \"ing Entity Framework Core code to\\nimplement the Repository pattern classes that use a DBContext to p\", \"ersist data in a relational\\ndatabase.\\n\\n\\n[In accordance with the previously mentioned Persistence Ign\", \"orance](https://deviq.com/persistence-ignorance/) [and Infrastructure Ignorance](https://ayende.com/\", \"blog/3137/infrastructure-ignorance)\\nprinciples, the infrastructure layer must not \\u201ccontaminate\\u201d the \", \"domain model layer. You must keep the\\ndomain model entity classes agnostic from the infrastructure t\", \"hat you use to persist data (EF or any\\nother framework) by not taking hard dependencies on framework\", \"s. Your domain model layer class\\nlibrary should have only your domain code, just POCO entity classes\", \" implementing the heart of your\\nsoftware and completely decoupled from infrastructure technologies.\\n\", \"\\n\\nThus, your layers or class libraries and projects should ultimately depend on your domain model la\", \"yer\\n(library), not vice versa, as shown in Figure 7-7.\\n\\n\\n_Figure 7-7. Dependencies between layers in\", \" DDD_\\n\\n\\nDependencies in a DDD Service, the Application layer depends on Domain and Infrastructure, a\", \"nd\\nInfrastructure depends on Domain, but Domain doesn\\u2019t depend on any layer. This layer design shoul\", \"d\\nbe independent for each microservice. As noted earlier, you can implement the most complex\\nmicrose\", \"rvices following DDD patterns, while implementing simpler data-driven microservices (simple\\nCRUD in \", \"a single layer) in a simpler way.\\n\\n\\n198 CHAPTER 6 | Tackle Business Complexity in a Microservice wit\", \"h DDD and CQRS Patterns\\n\\n\\n**Additional resources**\\n\\n\\n  - **DevIQ. Persistence Ignorance principle**\\n\", \"[https://deviq.com/persistence-ignorance/](https://deviq.com/persistence-ignorance/)\\n\\n\\n  - **Oren Ei\", \"ni. Infrastructure Ignorance**\\n[https://ayende.com/blog/3137/infrastructure-ignorance](https://ayend\", \"e.com/blog/3137/infrastructure-ignorance)\\n\\n\\n  - **Angel Lopez. Layered Architecture In Domain-Driven\", \" Design**\\n[https://ajlopez.wordpress.com/2008/09/12/layered-architecture-in-domain-driven-design/](h\", \"ttps://ajlopez.wordpress.com/2008/09/12/layered-architecture-in-domain-driven-design/)\\n\\n### Design a\", \" microservice domain model\\n\\n\\n_Define one rich domain model for each business microservice or Bounded\", \" Context._\\n\\n\\nYour goal is to create a single cohesive domain model for each business microservice or\", \" Bounded\\nContext (BC). Keep in mind, however, that a BC or business microservice could sometimes be\\n\", \"composed of several physical services that share a single domain model. The domain model must\\ncaptur\", \"e the rules, behavior, business language, and constraints of the single Bounded Context or\\nbusiness \", \"microservice that it represents.\\n\\n#### **The Domain Entity pattern**\\n\\n\\nEntities represent domain obj\", \"ects and are primarily defined by their identity, continuity, and\\npersistence over time, and not onl\", \"y by the attributes that comprise them. As Eric Evans says, \\u201can\\nobject primarily defined by its iden\", \"tity is called an Entity.\\u201d Entities are very important in the domain\\nmodel, since they are the base \", \"for a model. Therefore, you should identify and design them carefully.\\n\\n\\n_An entity\\u2019s identity can c\", \"ross multiple microservices or Bounded Contexts._\\n\\n\\nThe same identity (that is, the same Id value, a\", \"lthough perhaps not the same domain entity) can be\\nmodeled across multiple Bounded Contexts or micro\", \"services. However, that does not imply that the\\nsame entity, with the same attributes and logic woul\", \"d be implemented in multiple Bounded Contexts.\\nInstead, entities in each Bounded Context limit their\", \" attributes and behaviors to those required in that\\nBounded Context\\u2019s domain.\\n\\n\\nFor instance, the bu\", \"yer entity might have most of a person\\u2019s attributes that are defined in the user\\nentity in the profi\", \"le or identity microservice, including the identity. But the buyer entity in the ordering\\nmicroservi\", \"ce might have fewer attributes, because only certain buyer data is related to the order\\nprocess. The\", \" context of each microservice or Bounded Context impacts its domain model.\\n\\n\\n_Domain entities must i\", \"mplement behavior in addition to implementing data attributes._\\n\\n\\nA domain entity in DDD must implem\", \"ent the domain logic or behavior related to the entity data (the\\nobject accessed in memory). For exa\", \"mple, as part of an order entity class you must have business logic\\nand operations implemented as me\", \"thods for tasks such as adding an order item, data validation, and\\ntotal calculation. The entity\\u2019s m\", \"ethods take care of the invariants and rules of the entity instead of\\nhaving those rules spread acro\", \"ss the application layer.\\n\\n\\n199 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD an\", \"d CQRS Patterns\\n\\n\\nFigure 7-8 shows a domain entity that implements not only data attributes but oper\", \"ations or methods\\nwith related domain logic.\\n\\n\\n_Figure 7-8. Example of a domain entity design implem\", \"enting data plus behavior_\\n\\n\\nA domain model entity implements behaviors through methods, that is, it\", \"\\u2019s not an \\u201canemic\\u201d model. Of\\ncourse, sometimes you can have entities that do not implement any logic\", \" as part of the entity class.\\nThis can happen in child entities within an aggregate if the child ent\", \"ity does not have any special logic\\nbecause most of the logic is defined in the aggregate root. If y\", \"ou have a complex microservice that\\nhas logic implemented in the service classes instead of in the d\", \"omain entities, you could be falling\\ninto the anemic domain model, explained in the following sectio\", \"n.\\n\\n\\n**Rich domain model versus anemic domain model**\\n\\n\\n[In his post AnemicDomainModel, Martin Fowle\", \"r describes an anemic domain model this way:](https://martinfowler.com/bliki/AnemicDomainModel.html)\", \"\\n\\n\\nThe basic symptom of an Anemic Domain Model is that at first blush it looks like the real thing. \", \"There\\nare objects, many named after the nouns in the domain space, and these objects are connected w\", \"ith\\nthe rich relationships and structure that true domain models have. The catch comes when you look\", \" at\\nthe behavior, and you realize that there is hardly any behavior on these objects, making them li\", \"ttle\\nmore than bags of getters and setters.\\n\\n\\nOf course, when you use an anemic domain model, those \", \"data models will be used from a set of\\nservice objects (traditionally named the _business layer_ ) w\", \"hich capture all the domain or business logic.\\nThe business layer sits on top of the data model and \", \"uses the data model just as data.\\n\\n\\nThe anemic domain model is just a procedural style design. Anemi\", \"c entity objects are not real objects\\nbecause they lack behavior (methods). They only hold data prop\", \"erties and thus it is not objectoriented design. By putting all the behavior out into service object\", \"s (the business layer), you\\n[essentially end up with spaghetti code or transaction scripts, and ther\", \"efore you lose the advantages](https://en.wikipedia.org/wiki/Spaghetti_code)\\nthat a domain model pro\", \"vides.\\n\\n\\nRegardless, if your microservice or Bounded Context is very simple (a CRUD service), the an\", \"emic\\ndomain model in the form of entity objects with just data properties might be good enough, and \", \"it\\nmight not be worth implementing more complex DDD patterns. In that case, it will be simply a\\npers\", \"istence model, because you have intentionally created an entity with only data for CRUD\\npurposes.\\n\\n\\n\", \"200 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nThat is wh\", \"y microservices architectures are perfect for a multi-architectural approach depending on\\neach Bound\", \"ed Context. For instance, in eShopOnContainers, the ordering microservice implements\\nDDD patterns, b\", \"ut the catalog microservice, which is a simple CRUD service, does not.\\n\\n\\nSome people say that the an\", \"emic domain model is an anti-pattern. It really depends on what you are\\nimplementing. If the microse\", \"rvice you are creating is simple enough (for example, a CRUD service),\\nfollowing the anemic domain m\", \"odel it is not an anti-pattern. However, if you need to tackle the\\ncomplexity of a microservice\\u2019s do\", \"main that has a lot of ever-changing business rules, the anemic\\ndomain model might be an anti-patter\", \"n for that microservice or Bounded Context. In that case,\\ndesigning it as a rich model with entities\", \" containing data plus behavior as well as implementing\\nadditional DDD patterns (aggregates, value ob\", \"jects, etc.) might have huge benefits for the long-term\\nsuccess of such a microservice.\\n\\n\\n**Addition\", \"al resources**\\n\\n\\n  - **DevIQ. Domain Entity**\\n[https://deviq.com/entity/](https://deviq.com/entity/)\", \"\\n\\n\\n  - **Martin Fowler. The Domain Model**\\n[https://martinfowler.com/eaaCatalog/domainModel.html](ht\", \"tps://martinfowler.com/eaaCatalog/domainModel.html)\\n\\n\\n  - **Martin Fowler. The Anemic Domain Model**\", \"\\n[https://martinfowler.com/bliki/AnemicDomainModel.html](https://martinfowler.com/bliki/AnemicDomain\", \"Model.html)\\n\\n\\n**The Value Object pattern**\\n\\n\\nAs Eric Evans has noted, \\u201cMany objects do not have conc\", \"eptual identity. These objects describe\\ncertain characteristics of a thing.\\u201d\\n\\n\\nAn entity requires an\", \" identity, but there are many objects in a system that do not, like the Value\\nObject pattern. A valu\", \"e object is an object with no conceptual identity that describes a domain aspect.\\nThese are objects \", \"that you instantiate to represent design elements that only concern you temporarily.\\nYou care about \", \"_what_ they are, not _who_ they are. Examples include numbers and strings, but can also\\nbe higher-le\", \"vel concepts like groups of attributes.\\n\\n\\nSomething that is an entity in a microservice might not be\", \" an entity in another microservice, because\\nin the second case, the Bounded Context might have a dif\", \"ferent meaning. For example, an address in\\nan e-commerce application might not have an identity at a\", \"ll, since it might only represent a group of\\nattributes of the customer\\u2019s profile for a person or co\", \"mpany. In this case, the address should be\\nclassified as a value object. However, in an application \", \"for an electric power utility company, the\\ncustomer address could be important for the business doma\", \"in. Therefore, the address must have an\\nidentity so the billing system can be directly linked to the\", \" address. In that case, an address should be\\nclassified as a domain entity.\\n\\n\\nA person with a name a\", \"nd surname is usually an entity because a person has identity, even if the\\nname and surname coincide\", \" with another set of values, such as if those names also refer to a different\\nperson.\\n\\n\\nValue object\", \"s are hard to manage in relational databases and ORMs like Entity Framework (EF),\\nwhereas in documen\", \"t-oriented databases they are easier to implement and use.\\n\\n\\n201 CHAPTER 6 | Tackle Business Complex\", \"ity in a Microservice with DDD and CQRS Patterns\\n\\n\\n[EF Core 2.0 and later versions include the Owned\", \" Entities](https://devblogs.microsoft.com/dotnet/announcing-entity-framework-core-2-0/#owned-entitie\", \"s-and-table-splitting) feature that makes it easier to handle value\\nobjects, as we\\u2019ll see in detail \", \"later on.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Martin Fowler. Value Object pattern**\\n[https://martinfo\", \"wler.com/bliki/ValueObject.html](https://martinfowler.com/bliki/ValueObject.html)\\n\\n\\n  - **Value Obje\", \"ct**\\n[https://deviq.com/value-object/](https://deviq.com/value-object/)\\n\\n\\n  - **Value Objects in Tes\", \"t-Driven Development**\\n[https://leanpub.com/tdd-ebook/read#leanpub-auto-value-objects](https://leanp\", \"ub.com/tdd-ebook/read#leanpub-auto-value-objects)\\n\\n\\n  - **Eric Evans. Domain-Driven Design: Tackling\", \" Complexity in the Heart of Software.** (Book;\\nincludes a discussion of value objects)\\n[https://www.\", \"amazon.com/Domain-Driven-Design-Tackling-Complexity-](https://www.amazon.com/Domain-Driven-Design-Ta\", \"ckling-Complexity-Software/dp/0321125215/)\\n[Software/dp/0321125215/](https://www.amazon.com/Domain-D\", \"riven-Design-Tackling-Complexity-Software/dp/0321125215/)\\n\\n\\n**The Aggregate pattern**\\n\\n\\nA domain mod\", \"el contains clusters of different data entities and processes that can control a\\nsignificant area of\", \" functionality, such as order fulfillment or inventory. A more fine-grained DDD unit is\\nthe aggregat\", \"e, which describes a cluster or group of entities and behaviors that can be treated as a\\ncohesive un\", \"it.\\n\\n\\nYou usually define an aggregate based on the transactions that you need. A classic example is \", \"an\\norder that also contains a list of order items. An order item will usually be an entity. But it w\", \"ill be a\\nchild entity within the order aggregate, which will also contain the order entity as its ro\", \"ot entity,\\ntypically called an aggregate root.\\n\\n\\nIdentifying aggregates can be hard. An aggregate is\", \" a group of objects that must be consistent\\ntogether, but you cannot just pick a group of objects an\", \"d label them an aggregate. You must start\\nwith a domain concept and think about the entities that ar\", \"e used in the most common transactions\\nrelated to that concept. Those entities that need to be trans\", \"actionally consistent are what forms an\\naggregate. Thinking about transaction operations is probably\", \" the best way to identify aggregates.\\n\\n\\n**The Aggregate Root or Root Entity pattern**\\n\\n\\nAn aggregate\", \" is composed of at least one entity: the aggregate root, also called root entity or primary\\nentity. \", \"Additionally, it can have multiple child entities and value objects, with all entities and objects\\nw\", \"orking together to implement required behavior and transactions.\\n\\n\\nThe purpose of an aggregate root \", \"is to ensure the consistency of the aggregate; it should be the only\\nentry point for updates to the \", \"aggregate through methods or operations in the aggregate root class.\\nYou should make changes to enti\", \"ties within the aggregate only via the aggregate root. It is the\\naggregate\\u2019s consistency guardian, c\", \"onsidering all the invariants and consistency rules you might need\\nto comply with in your aggregate.\", \" If you change a child entity or value object independently, the\\n\\n\\n202 CHAPTER 6 | Tackle Business C\", \"omplexity in a Microservice with DDD and CQRS Patterns\\n\\n\\naggregate root cannot ensure that the aggre\", \"gate is in a valid state. It would be like a table with a\\nloose leg. Maintaining consistency is the \", \"main purpose of the aggregate root.\\n\\n\\nIn Figure 7-9, you can see sample aggregates like the buyer ag\", \"gregate, which contains a single entity\\n(the aggregate root Buyer). The order aggregate contains mul\", \"tiple entities and a value object.\\n\\n\\n_Figure 7-9. Example of aggregates with multiple or single enti\", \"ties_\\n\\n\\nA DDD domain model is composed from aggregates, an aggregate can have just one entity or mor\", \"e,\\nand can include value objects as well. Note that the Buyer aggregate could have additional child\\n\", \"entities, depending on your domain, as it does in the ordering microservice in the eShopOnContainers\", \"\\nreference application. Figure 7-9 just illustrates a case in which the buyer has a single entity, a\", \"s an\\nexample of an aggregate that contains only an aggregate root.\\n\\n\\nIn order to maintain separation\", \" of aggregates and keep clear boundaries between them, it is a good\\npractice in a DDD domain model t\", \"o disallow direct navigation between aggregates and only having\\n[the foreign key (FK) field, as impl\", \"emented in the Ordering microservice domain model](https://github.com/dotnet-architecture/eShopOnCon\", \"tainers/blob/main/src/Services/Ordering/Ordering.Domain/AggregatesModel/OrderAggregate/Order.cs) in\\n\", \"eShopOnContainers. The Order entity only has a foreign key field for the buyer, but not an EF Core\\nn\", \"avigation property, as shown in the following code:\\n\\n\\n203 CHAPTER 6 | Tackle Business Complexity in \", \"a Microservice with DDD and CQRS Patterns\\n\\n\\nIdentifying and working with aggregates requires researc\", \"h and experience. For more information, see\\nthe following Additional resources list.\\n\\n\\n**Additional \", \"resources**\\n\\n\\n  - **Vaughn Vernon. Effective Aggregate Design - Part I: Modeling a Single Aggregate*\", \"* (from\\n[https://dddcommunity.org/)](https://dddcommunity.org/)\\n[https://dddcommunity.org/wp-content\", \"/uploads/files/pdf_articles/Vernon_2011_1.pdf](https://dddcommunity.org/wp-content/uploads/files/pdf\", \"_articles/Vernon_2011_1.pdf)\\n\\n\\n  - **Vaughn Vernon. Effective Aggregate Design - Part II: Making Agg\", \"regates Work**\\n**Together** [(from https://dddcommunity.org/)](https://dddcommunity.org/)\\n[https://d\", \"ddcommunity.org/wp-content/uploads/files/pdf_articles/Vernon_2011_2.pdf](https://dddcommunity.org/wp\", \"-content/uploads/files/pdf_articles/Vernon_2011_2.pdf)\\n\\n\\n  - **Vaughn Vernon. Effective Aggregate De\", \"sign - Part III: Gaining Insight Through**\\n**Discovery** [(from https://dddcommunity.org/)](https://\", \"dddcommunity.org/)\\n[https://dddcommunity.org/wp-content/uploads/files/pdf_articles/Vernon_2011_3.pdf\", \"](https://dddcommunity.org/wp-content/uploads/files/pdf_articles/Vernon_2011_3.pdf)\\n\\n\\n  - **Sergey G\", \"rybniak. DDD Tactical Design Patterns**\\n[https://www.codeproject.com/Articles/1164363/Domain-Driven-\", \"Design-Tactical-Design-](https://www.codeproject.com/Articles/1164363/Domain-Driven-Design-Tactical-\", \"Design-Patterns-Part)\\n[Patterns-Part](https://www.codeproject.com/Articles/1164363/Domain-Driven-Des\", \"ign-Tactical-Design-Patterns-Part)\\n\\n\\n  - **Chris Richardson. Developing Transactional Microservices \", \"Using Aggregates**\\n[https://www.infoq.com/articles/microservices-aggregates-events-cqrs-part-1-richa\", \"rdson](https://www.infoq.com/articles/microservices-aggregates-events-cqrs-part-1-richardson)\\n\\n\\n  - \", \"**DevIQ. The Aggregate pattern**\\n[https://deviq.com/aggregate-pattern/](https://deviq.com/aggregate-\", \"pattern/)\\n\\n### Implement a microservice domain model with .NET\\n\\n\\nIn the previous section, the fundam\", \"ental design principles and patterns for designing a domain model\\nwere explained. Now it\\u2019s time to e\", \"xplore possible ways to implement the domain model by using .NET\\n(plain C# code) and EF Core. Your d\", \"omain model will be composed simply of your code. It will have\\njust the EF Core model requirements, \", \"but not real dependencies on EF. You shouldn\\u2019t have hard\\ndependencies or references to EF Core or an\", \"y other ORM in your domain model.\\n\\n#### **Domain model structure in a custom .NET Standard Library**\", \"\\n\\n\\nThe folder organization used for the eShopOnContainers reference application demonstrates the DDD\", \"\\nmodel for the application. You might find that a different folder organization more clearly\\ncommuni\", \"cates the design choices made for your application. As you can see in Figure 7-10, in the\\nordering d\", \"omain model there are two aggregates, the order aggregate and the buyer aggregate. Each\\naggregate is\", \" a group of domain entities and value objects, although you could have an aggregate\\ncomposed of a si\", \"ngle domain entity (the aggregate root or root entity) as well.\\n\\n\\n204 CHAPTER 6 | Tackle Business Co\", \"mplexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n_Figure 7-10. Domain model structure for the\", \" ordering microservice in eShopOnContainers_\\n\\n\\nAdditionally, the domain model layer includes the rep\", \"ository contracts (interfaces) that are the\\ninfrastructure requirements of your domain model. In oth\", \"er words, these interfaces express what\\nrepositories and the methods the infrastructure layer must i\", \"mplement. It\\u2019s critical that the\\nimplementation of the repositories be placed outside of the domain \", \"model layer, in the infrastructure\\nlayer library, so the domain model layer isn\\u2019t \\u201ccontaminated\\u201d by \", \"API or classes from infrastructure\\ntechnologies, like Entity Framework.\\n\\n\\n[You can also see a SeedWo\", \"rk folder that contains custom base classes that you can use as a base for](https://martinfowler.com\", \"/bliki/Seedwork.html)\\nyour domain entities and value objects, so you don\\u2019t have redundant code in ea\", \"ch domain\\u2019s object\\nclass.\\n\\n#### **Structure aggregates in a custom .NET Standard library**\\n\\n\\nAn aggr\", \"egate refers to a cluster of domain objects grouped together to match transactional\\nconsistency. Tho\", \"se objects could be instances of entities (one of which is the aggregate root or root\\nentity) plus a\", \"ny additional value objects.\\n\\n\\nTransactional consistency means that an aggregate is guaranteed to be\", \" consistent and up to date at\\nthe end of a business action. For example, the order aggregate from th\", \"e eShopOnContainers ordering\\nmicroservice domain model is composed as shown in Figure 7-11.\\n\\n\\n205 CH\", \"APTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n_Figure 7-11. Th\", \"e order aggregate in Visual Studio solution_\\n\\n\\nIf you open any of the files in an aggregate folder, \", \"you can see how it\\u2019s marked as either a custom\\n[base class or interface, like entity or value object\", \", as implemented in the SeedWork folder.](https://github.com/dotnet-architecture/eShopOnContainers/t\", \"ree/main/src/Services/Ordering/Ordering.Domain/SeedWork)\\n\\n#### **Implement domain entities as POCO c\", \"lasses**\\n\\n\\nYou implement a domain model in .NET by creating POCO classes that implement your domain\\n\", \"entities. In the following example, the Order class is defined as an entity and also as an aggregate\", \"\\nroot. Because the Order class derives from the Entity base class, it can reuse common code related \", \"to\\nentities. Bear in mind that these base classes and interfaces are defined by you in the domain mo\", \"del\\nproject, so it is your code, not infrastructure code from an ORM like EF.\\n\\n\\n206 CHAPTER 6 | Tack\", \"le Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nIt\\u2019s important to note that th\", \"is is a domain entity implemented as a POCO class. It doesn\\u2019t have any\\ndirect dependency on Entity F\", \"ramework Core or any other infrastructure framework. This\\nimplementation is as it should be in DDD, \", \"just C# code implementing a domain model.\\n\\n\\nIn addition, the class is decorated with an interface na\", \"med IAggregateRoot. That interface is an empty\\ninterface, sometimes called a _marker interface_, tha\", \"t\\u2019s used just to indicate that this entity class is also\\nan aggregate root.\\n\\n\\nA marker interface is \", \"sometimes considered as an anti-pattern; however, it\\u2019s also a clean way to mark\\na class, especially \", \"when that interface might be evolving. An attribute could be the other choice for\\nthe marker, but it\", \"\\u2019s quicker to see the base class (Entity) next to the IAggregate interface instead of\\nputting an Agg\", \"regate attribute marker above the class. It\\u2019s a matter of preferences, in any case.\\n\\n\\nHaving an aggr\", \"egate root means that most of the code related to consistency and business rules of\\nthe aggregate\\u2019s \", \"entities should be implemented as methods in the Order aggregate root class (for\\nexample, AddOrderIt\", \"em when adding an OrderItem object to the aggregate). You should not create\\nor update OrderItems obj\", \"ects independently or directly; the AggregateRoot class must keep control\\nand consistency of any upd\", \"ate operation against its child entities.\\n\\n#### **Encapsulate data in the Domain Entities**\\n\\n\\nA comm\", \"on problem in entity models is that they expose collection navigation properties as publicly\\naccessi\", \"ble list types. This allows any collaborator developer to manipulate the contents of these\\ncollectio\", \"n types, which may bypass important business rules related to the collection, possibly leaving\\nthe o\", \"bject in an invalid state. The solution to this is to expose read-only access to related collections\", \"\\nand explicitly provide methods that define ways in which clients can manipulate them.\\n\\n\\nIn the prev\", \"ious code, note that many attributes are read-only or private and are only updatable by the\\nclass me\", \"thods, so any update considers business domain invariants and logic specified within the class\\nmetho\", \"ds.\\n\\n\\n207 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nFor \", \"example, following DDD patterns, **you should** _**not**_ **do the following** from any command hand\", \"ler\\nmethod or application layer class (actually, it should be impossible for you to do so):\\n\\n\\nIn thi\", \"s case, the Add method is purely an operation to add data, with direct access to the OrderItems\\ncoll\", \"ection. Therefore, most of the domain logic, rules, or validations related to that operation with th\", \"e\\nchild entities will be spread across the application layer (command handlers and Web API controlle\", \"rs).\\n\\n\\nIf you go around the aggregate root, the aggregate root cannot guarantee its invariants, its \", \"validity, or\\nits consistency. Eventually you\\u2019ll have spaghetti code or transactional script code.\\n\\n\\n\", \"To follow DDD patterns, entities must not have public setters in any entity property. Changes in an\\n\", \"entity should be driven by explicit methods with explicit ubiquitous language about the change\\nthey\\u2019\", \"re performing in the entity.\\n\\n\\nFurthermore, collections within the entity (like the order items) sho\", \"uld be read-only properties (the\\nAsReadOnly method explained later). You should be able to update it\", \" only from within the aggregate\\nroot class methods or the child entity methods.\\n\\n\\nAs you can see in \", \"the code for the Order aggregate root, all setters should be private or at least readonly externally\", \", so that any operation against the entity\\u2019s data or its child entities has to be performed\\nthrough \", \"methods in the entity class. This maintains consistency in a controlled and object-oriented\\nway inst\", \"ead of implementing transactional script code.\\n\\n\\nThe following code snippet shows the proper way to \", \"code the task of adding an OrderItem object to\\nthe Order aggregate.\\n\\n\\nIn this snippet, most of the v\", \"alidations or logic related to the creation of an OrderItem object will be\\nunder the control of the \", \"Order aggregate root\\u2014in the AddOrderItem method\\u2014especially validations\\nand logic related to other el\", \"ements in the aggregate. For instance, you might get the same product\\nitem as the result of multiple\", \" calls to AddOrderItem. In that method, you could examine the product\\nitems and consolidate the same\", \" product items into a single OrderItem object with several units.\\n\\n\\n208 CHAPTER 6 | Tackle Business \", \"Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nAdditionally, if there are different disco\", \"unt amounts but the product ID is the same, you would likely\\napply the higher discount. This princip\", \"le applies to any other domain logic for the OrderItem object.\\n\\n\\nIn addition, the new OrderItem(para\", \"ms) operation will also be controlled and performed by the\\nAddOrderItem method from the Order aggreg\", \"ate root. Therefore, most of the logic or validations\\nrelated to that operation (especially anything\", \" that impacts the consistency between other child\\nentities) will be in a single place within the agg\", \"regate root. That is the ultimate purpose of the\\naggregate root pattern.\\n\\n\\nWhen you use Entity Frame\", \"work Core 1.1 or later, a DDD entity can be better expressed because it\\n[allows mapping to fields](h\", \"ttps://docs.microsoft.com/ef/core/modeling/backing-field) in addition to properties. This is useful \", \"when protecting collections of child\\nentities or value objects. With this enhancement, you can use s\", \"imple private fields instead of\\nproperties and you can implement any update to the field collection \", \"in public methods and provide\\nread-only access through the AsReadOnly method.\\n\\n\\nIn DDD, you want to \", \"update the entity only through methods in the entity (or the constructor) in order\\nto control any in\", \"variant and the consistency of the data, so properties are defined only with a get\\naccessor. The pro\", \"perties are backed by private fields. Private members can only be accessed from\\nwithin the class. Ho\", \"wever, there is one exception: EF Core needs to set these fields as well (so it can\\nreturn the objec\", \"t with the proper values).\\n\\n\\n**Map properties with only get accessors to the fields in the database \", \"table**\\n\\n\\nMapping properties to database table columns is not a domain responsibility but part of th\", \"e\\ninfrastructure and persistence layer. We mention this here just so you\\u2019re aware of the new capabil\", \"ities\\nin EF Core 1.1 or later related to how you can model entities. Additional details on this topi\", \"c are\\nexplained in the infrastructure and persistence section.\\n\\n\\nWhen you use EF Core 1.0 or later, \", \"within the DbContext you need to map the properties that are\\ndefined only with getters to the actual\", \" fields in the database table. This is done with the HasField\\nmethod of the PropertyBuilder class.\\n\\n\", \"\\n**Map fields without properties**\\n\\n\\nWith the feature in EF Core 1.1 or later to map columns to fiel\", \"ds, it\\u2019s also possible to not use\\nproperties. Instead, you can just map columns from a table to fiel\", \"ds. A common use case for this is\\nprivate fields for an internal state that doesn\\u2019t need to be acces\", \"sed from outside the entity.\\n\\n\\nFor example, in the preceding OrderAggregate code example, there are \", \"several private fields, like the\\n_paymentMethodId field, that have no related property for either a \", \"setter or getter. That field could\\nalso be calculated within the order\\u2019s business logic and used fro\", \"m the order\\u2019s methods, but it needs\\nto be persisted in the database as well. So in EF Core (since v1\", \".1), there\\u2019s a way to map a field without\\na related property to a column in the database. This is al\", \"so explained in the Infrastructure layer section\\nof this guide.\\n\\n\\n209 CHAPTER 6 | Tackle Business Co\", \"mplexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n**Additional resources**\\n\\n\\n  - **Vaughn Vern\", \"on. Modeling Aggregates with DDD and Entity Framework.** Note that this is\\n_not_ Entity Framework Co\", \"re.\\n[https://kalele.io/blog-posts/modeling-aggregates-with-ddd-and-entity-framework/](https://kalele\", \".io/blog-posts/modeling-aggregates-with-ddd-and-entity-framework/)\\n\\n\\n  - **Julie Lerman. Data Points\", \" - Coding for Domain-Driven Design: Tips for Data-Focused**\\n**Devs**\\n[https://learn.microsoft.com/ar\", \"chive/msdn-magazine/2013/august/data-points-coding-for-](https://docs.microsoft.com/archive/msdn-mag\", \"azine/2013/august/data-points-coding-for-domain-driven-design-tips-for-data-focused-devs)\\n[domain-dr\", \"iven-design-tips-for-data-focused-devs](https://docs.microsoft.com/archive/msdn-magazine/2013/august\", \"/data-points-coding-for-domain-driven-design-tips-for-data-focused-devs)\\n\\n\\n  - **Udi Dahan. How to c\", \"reate fully encapsulated Domain Models**\\n[https://udidahan.com/2008/02/29/how-to-create-fully-encaps\", \"ulated-domain-models/](https://udidahan.com/2008/02/29/how-to-create-fully-encapsulated-domain-model\", \"s/)\\n\\n\\n  - **Steve Smith. What is the difference between a DTO and a POCO?** [https://ardalis.com/dto\", \"-](https://ardalis.com/dto-or-poco/)\\n[or-poco/](https://ardalis.com/dto-or-poco/)\\n\\n### Seedwork (reu\", \"sable base classes and interfaces for your domain model)\\n\\n\\nThe solution folder contains a _SeedWork_\", \" folder. This folder contains custom base classes that you can\\nuse as a base for your domain entitie\", \"s and value objects. Use these base classes so you don\\u2019t have\\nredundant code in each domain\\u2019s object\", \" class. The folder for these types of classes is called _SeedWork_\\nand not something like _Framework\", \"_ . It\\u2019s called _SeedWork_ because the folder contains just a small\\nsubset of reusable classes that \", \"cannot really be considered a framework. _Seedwork_ is a term\\n[introduced by Michael Feathers and po\", \"pularized by Martin Fowler](https://www.artima.com/forums/flat.jsp?forum=106&thread=8826) but you co\", \"uld also name that\\nfolder Common, SharedKernel, or similar.\\n\\n\\nFigure 7-12 shows the classes that for\", \"m the seedwork of the domain model in the ordering\\nmicroservice. It has a few custom base classes li\", \"ke Entity, ValueObject, and Enumeration, plus a few\\ninterfaces. These interfaces (IRepository and IU\", \"nitOfWork) inform the infrastructure layer about what\\nneeds to be implemented. Those interfaces are \", \"also used through Dependency Injection from the\\napplication layer.\\n\\n\\n_Figure 7-12. A sample set of d\", \"omain model \\u201cseedwork\\u201d base classes and interfaces_\\n\\n\\nThis is the type of copy and paste reuse that \", \"many developers share between projects, not a formal\\nframework. You can have seedworks in any layer \", \"or library. However, if the set of classes and\\ninterfaces gets large enough, you might want to creat\", \"e a single class library.\\n\\n\\n210 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD an\", \"d CQRS Patterns\\n\\n\\n#### **The custom Entity base class**\\n\\nThe following code is an example of an Enti\", \"ty base class where you can place code that can be used\\n[the same way by any domain entity, such as \", \"the entity ID, equality operators, a domain event list per](https://docs.microsoft.com/dotnet/csharp\", \"/language-reference/operators/equality-operators)\\nentity, etc.\\n\\n\\n211 CHAPTER 6 | Tackle Business Com\", \"plexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nThe previous code using a domain event list p\", \"er entity will be explained in the next sections when\\nfocusing on domain events.\\n\\n#### **Repository \", \"contracts (interfaces) in the domain model layer**\\n\\n\\nRepository contracts are simply .NET interfaces\", \" that express the contract requirements of the\\nrepositories to be used for each aggregate.\\n\\n\\nThe rep\", \"ositories themselves, with EF Core code or any other infrastructure dependencies and code\\n(Linq, SQL\", \", etc.), must not be implemented within the domain model; the repositories should only\\nimplement the\", \" interfaces you define in the domain model.\\n\\n\\nA pattern related to this practice (placing the reposi\", \"tory interfaces in the domain model layer) is the\\n[Separated Interface pattern. As explained by Mart\", \"in Fowler, \\u201cUse Separated Interface to define an](https://www.martinfowler.com/eaaCatalog/separatedI\", \"nterface.html)\\ninterface in one package but implement it in another. This way a client that needs th\", \"e dependency to\\nthe interface can be completely unaware of the implementation.\\u201d\\n\\n\\nFollowing the Sepa\", \"rated Interface pattern enables the application layer (in this case, the Web API\\nproject for the mic\", \"roservice) to have a dependency on the requirements defined in the domain model,\\nbut not a direct de\", \"pendency to the infrastructure/persistence layer. In addition, you can use\\nDependency Injection to i\", \"solate the implementation, which is implemented in the infrastructure/\\npersistence layer using repos\", \"itories.\\n\\n\\nFor example, the following example with the IOrderRepository interface defines what opera\", \"tions the\\nOrderRepository class will need to implement at the infrastructure layer. In the current\\ni\", \"mplementation of the application, the code just needs to add or update orders to the database, since\", \"\\nqueries are split following the simplified CQRS approach.\\n\\n\\n212 CHAPTER 6 | Tackle Business Complex\", \"ity in a Microservice with DDD and CQRS Patterns\\n\\n\\n#### **Additional resources**\\n\\n\\n  - **Martin Fowl\", \"er. Separated Interface.**\\n[https://www.martinfowler.com/eaaCatalog/separatedInterface.html](https:/\", \"/www.martinfowler.com/eaaCatalog/separatedInterface.html)\\n\\n### Implement value objects\\n\\n\\nAs discusse\", \"d in earlier sections about entities and aggregates, identity is fundamental for entities.\\nHowever, \", \"there are many objects and data items in a system that do not require an identity and\\nidentity track\", \"ing, such as value objects.\\n\\n\\nA value object can reference other entities. For example, in an applic\", \"ation that generates a route that\\ndescribes how to get from one point to another, that route would b\", \"e a value object. It would be a\\nsnapshot of points on a specific route, but this suggested route wou\", \"ld not have an identity, even\\nthough internally it might refer to entities like City, Road, etc.\\n\\n\\nF\", \"igure 7-13 shows the Address value object within the Order aggregate.\\n\\n\\n213 CHAPTER 6 | Tackle Busin\", \"ess Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n_Figure 7-13. Address value object wit\", \"hin the Order aggregate_\\n\\n\\nAs shown in Figure 7-13, an entity is usually composed of multiple attrib\", \"utes. For example, the Order\\nentity can be modeled as an entity with an identity and composed intern\", \"ally of a set of attributes such\\nas OrderId, OrderDate, OrderItems, etc. But the address, which is s\", \"imply a complex-value composed of\\ncountry/region, street, city, etc., and has no identity in this do\", \"main, must be modeled and treated as a\\nvalue object.\\n\\n#### **Important characteristics of value obje\", \"cts**\\n\\n\\nThere are two main characteristics for value objects:\\n\\n\\n  - They have no identity.\\n\\n\\n  - The\", \"y are immutable.\\n\\n\\nThe first characteristic was already discussed. Immutability is an important requ\", \"irement. The values of\\na value object must be immutable once the object is created. Therefore, when \", \"the object is\\n\\n\\n214 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patte\", \"rns\\n\\n\\nconstructed, you must provide the required values, but you must not allow them to change durin\", \"g the\\nobject\\u2019s lifetime.\\n\\n\\nValue objects allow you to perform certain tricks for performance, thanks\", \" to their immutable nature.\\nThis is especially true in systems where there may be thousands of value\", \" object instances, many of\\nwhich have the same values. Their immutable nature allows them to be reus\", \"ed; they can be\\ninterchangeable objects, since their values are the same and they have no identity. \", \"This type of\\noptimization can sometimes make a difference between software that runs slowly and soft\", \"ware with\\ngood performance. Of course, all these cases depend on the application environment and dep\", \"loyment\\ncontext.\\n\\n#### **Value object implementation in C#**\\n\\n\\nIn terms of implementation, you can h\", \"ave a value object base class that has basic utility methods like\\nequality based on the comparison b\", \"etween all the attributes (since a value object must not be based\\non identity) and other fundamental\", \" characteristics. The following example shows a value object base\\nclass used in the ordering microse\", \"rvice from eShopOnContainers.\\n\\n\\n215 CHAPTER 6 | Tackle Business Complexity in a Microservice with DD\", \"D and CQRS Patterns\\n\\n\\nThe ValueObject is an abstract class type, but in this example, it doesn\\u2019t ove\", \"rload the == and !=\\noperators. You could choose to do so, making comparisons delegate to the Equals \", \"override. For\\nexample, consider the following operator overloads to the ValueObject type:\\n\\n\\nThis val\", \"ue object implementation of Address has no identity, and therefore no ID field is defined for it,\\nei\", \"ther in the Address class definition or the ValueObject class definition.\\n\\n\\nHaving no ID field in a \", \"class to be used by Entity Framework (EF) was not possible until EF Core 2.0,\\nwhich greatly helps to\", \" implement better value objects with no ID. That is precisely the explanation of\\nthe next section.\\n\\n\", \"\\nIt could be argued that value objects, being immutable, should be read-only (that is, have get-only\", \"\\nproperties), and that\\u2019s indeed true. However, value objects are usually serialized and deserialized\", \" to go\\n\\n\\n216 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nt\", \"hrough message queues, and being read-only stops the deserializer from assigning values, so you\\njust\", \" leave them as private set, which is read-only enough to be practical.\\n\\n\\n**Value object comparison s\", \"emantics**\\n\\n\\nTwo instances of the Address type can be compared using all the following methods:\\n\\n\\nWh\", \"en all the values are the same, the comparisons are correctly evaluated as true. If you didn\\u2019t choos\", \"e\\nto overload the == and != operators, then the last comparison of one == two would evaluate as fals\", \"e.\\nFor more information, see Overload ValueObject equality operators.\\n\\n#### **How to persist value o\", \"bjects in the database with EF Core 2.0 and later**\\n\\n\\nYou just saw how to define a value object in y\", \"our domain model. But how can you actually persist it\\ninto the database using Entity Framework Core \", \"since it usually targets entities with identity?\\n\\n\\n**Background and older approaches using EF Core 1\", \".1**\\n\\n\\n[As background, a limitation when using EF Core 1.0 and 1.1 was that you could not use comple\", \"x types](https://docs.microsoft.com/dotnet/api/system.componentmodel.dataannotations.schema.complext\", \"ypeattribute)\\nas defined in EF 6.x in the traditional .NET Framework. Therefore, if using EF Core 1.\", \"0 or 1.1, you\\nneeded to store your value object as an EF entity with an ID field. Then, so it looked\", \" more like a value\\nobject with no identity, you could hide its ID so you make clear that the identit\", \"y of a value object is\\n[not important in the domain model. You could hide that ID by using the ID as\", \" a shadow property.](https://docs.microsoft.com/ef/core/modeling/shadow-properties)\\nSince that confi\", \"guration for hiding the ID in the model is set up in the EF infrastructure level, it would\\nbe kind o\", \"f transparent for your domain model.\\n\\n\\nIn the initial version of eShopOnContainers (.NET Core 1.1), \", \"the hidden ID needed by EF Core\\ninfrastructure was implemented in the following way in the DbContext\", \" level, using Fluent API at the\\ninfrastructure project. Therefore, the ID was hidden from the domain\", \" model point of view, but still\\npresent in the infrastructure.\\n\\n\\nHowever, the persistence of that va\", \"lue object into the database was performed like a regular entity in\\na different table.\\n\\n\\n217 CHAPTER\", \" 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nWith EF Core 2.0 and \", \"later, there are new and better ways to persist value objects.\\n\\n#### **Persist value objects as owne\", \"d entity types in EF Core 2.0 and later**\\n\\n\\nEven with some gaps between the canonical value object p\", \"attern in DDD and the owned entity type in\\nEF Core, it\\u2019s currently the best way to persist value obj\", \"ects with EF Core 2.0 and later. You can see\\nlimitations at the end of this section.\\n\\n\\nThe owned ent\", \"ity type feature was added to EF Core since version 2.0.\\n\\n\\nAn owned entity type allows you to map ty\", \"pes that do not have their own identity explicitly defined in\\nthe domain model and are used as prope\", \"rties, such as a value object, within any of your entities. An\\nowned entity type shares the same CLR\", \" type with another entity type (that is, it\\u2019s just a regular class).\\nThe entity containing the defin\", \"ing navigation is the owner entity. When querying the owner, the\\nowned types are included by default\", \".\\n\\n\\nJust by looking at the domain model, an owned type looks like it doesn\\u2019t have any identity. Howe\", \"ver,\\nunder the covers, owned types do have the identity, but the owner navigation property is part o\", \"f this\\nidentity.\\n\\n\\nThe identity of instances of owned types is not completely their own. It consists\", \" of three components:\\n\\n\\n  - The identity of the owner\\n\\n\\n  - The navigation property pointing to them\", \"\\n\\n\\n  - In the case of collections of owned types, an independent component (supported in EF Core\\n2.2\", \" and later).\\n\\n\\nFor example, in the Ordering domain model at eShopOnContainers, as part of the Order \", \"entity, the\\nAddress value object is implemented as an owned entity type within the owner entity, whi\", \"ch is the\\nOrder entity. Address is a type with no identity property defined in the domain model. It \", \"is used as a\\nproperty of the Order type to specify the shipping address for a particular order.\\n\\n\\nBy\", \" convention, a shadow primary key is created for the owned type and it will be mapped to the same\\nta\", \"ble as the owner by using table splitting. This allows to use owned types similarly to how complex\\nt\", \"ypes are used in EF6 in the traditional .NET Framework.\\n\\n\\nIt is important to note that owned types a\", \"re never discovered by convention in EF Core, so you have\\nto declare them explicitly.\\n\\n\\nIn eShopOnCo\", \"ntainers, in the OrderingContext.cs file, within the OnModelCreating() method, multiple\\ninfrastructu\", \"re configurations are applied. One of them is related to the Order entity.\\n\\n\\n218 CHAPTER 6 | Tackle \", \"Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nIn the following code, the persis\", \"tence infrastructure is defined for the Order entity:\\n\\n\\nIn the previous code, the orderConfiguration\", \".OwnsOne(o => o.Address) method specifies that the\\nAddress property is an owned entity of the Order \", \"type.\\n\\n\\nBy default, EF Core conventions name the database columns for the properties of the owned en\", \"tity\\ntype as EntityProperty_OwnedEntityProperty. Therefore, the internal properties of Address will \", \"appear\\nin the Orders table with the names Address_Street, Address_City (and so on for State, Country\", \", and\\nZipCode).\\n\\n\\nYou can append the Property().HasColumnName() fluent method to rename those column\", \"s. In the\\ncase where Address is a public property, the mappings would be like the following:\\n\\n\\nIt\\u2019s \", \"possible to chain the OwnsOne method in a fluent mapping. In the following hypothetical\\nexample, Ord\", \"erDetails owns BillingAddress and ShippingAddress, which are both Address types. Then\\nOrderDetails i\", \"s owned by the Order type.\\n\\n\\n219 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD a\", \"nd CQRS Patterns\\n\\n\\n**Additional details on owned entity types**\\n\\n\\n  - Owned types are defined when y\", \"ou configure a navigation property to a particular type using\\nthe OwnsOne fluent API.\\n\\n\\n  - The defi\", \"nition of an owned type in our metadata model is a composite of: the owner type, the\\nnavigation prop\", \"erty, and the CLR type of the owned type.\\n\\n\\n  - The identity (key) of an owned type instance in our \", \"stack is a composite of the identity of the\\nowner type and the definition of the owned type.\\n\\n\\n**Own\", \"ed entities capabilities**\\n\\n\\n  - Owned types can reference other entities, either owned (nested owne\", \"d types) or non-owned\\n(regular reference navigation properties to other entities).\\n\\n\\n  - You can map\", \" the same CLR type as different owned types in the same owner entity through\\nseparate navigation pro\", \"perties.\\n\\n\\n  - Table splitting is set up by convention, but you can opt out by mapping the owned typ\", \"e to a\\ndifferent table using ToTable.\\n\\n\\n  - Eager loading is performed automatically on owned types,\", \" that is, there\\u2019s no need to call\\n.Include() on the query.\\n\\n\\n  - Can be configured with attribute [O\", \"wned], using EF Core 2.1 and later.\\n\\n\\n  - Can handle collections of owned types (using version 2.2 a\", \"nd later).\\n\\n\\n**Owned entities limitations**\\n\\n\\n  - You can\\u2019t create a DbSet<T> of an owned type (by d\", \"esign).\\n\\n\\n  - You can\\u2019t call ModelBuilder.Entity<T>() on owned types (currently by design).\\n\\n\\n  - No\", \" support for optional (that is, nullable) owned types that are mapped with the owner in the\\nsame tab\", \"le (that is, using table splitting). This is because mapping is done for each property,\\nthere is no \", \"separate sentinel for the null complex value as a whole.\\n\\n\\n  - No inheritance-mapping support for ow\", \"ned types, but you should be able to map two leaf\\ntypes of the same inheritance hierarchies as diffe\", \"rent owned types. EF Core will not reason\\nabout the fact that they are part of the same hierarchy.\\n\\n\", \"\\n220 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n**Main di\", \"fferences with EF6\\u2019s complex types**\\n\\n\\n  - Table splitting is optional, that is, they can optionally\", \" be mapped to a separate table and still\\nbe owned types.\\n\\n#### **Additional resources**\\n\\n\\n  - **Mart\", \"in Fowler. ValueObject pattern**\\n[https://martinfowler.com/bliki/ValueObject.html](https://martinfow\", \"ler.com/bliki/ValueObject.html)\\n\\n\\n  - **Eric Evans. Domain-Driven Design: Tackling Complexity in the\", \" Heart of Software.** (Book;\\nincludes a discussion of value objects)\\n[https://www.amazon.com/Domain-\", \"Driven-Design-Tackling-Complexity-](https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-\", \"Software/dp/0321125215/)\\n[Software/dp/0321125215/](https://www.amazon.com/Domain-Driven-Design-Tackl\", \"ing-Complexity-Software/dp/0321125215/)\\n\\n\\n  - **Vaughn Vernon. Implementing Domain-Driven Design.** \", \"(Book; includes a discussion of\\nvalue objects)\\n[https://www.amazon.com/Implementing-Domain-Driven-De\", \"sign-Vaughn-](https://www.amazon.com/Implementing-Domain-Driven-Design-Vaughn-Vernon/dp/0321834577/)\", \"\\n[Vernon/dp/0321834577/](https://www.amazon.com/Implementing-Domain-Driven-Design-Vaughn-Vernon/dp/0\", \"321834577/)\\n\\n\\n  - **Owned Entity Types**\\n[https://learn.microsoft.com/ef/core/modeling/owned-entitie\", \"s](https://docs.microsoft.com/ef/core/modeling/owned-entities)\\n\\n\\n  - **Shadow Properties**\\n[https://\", \"learn.microsoft.com/ef/core/modeling/shadow-properties](https://docs.microsoft.com/ef/core/modeling/\", \"shadow-properties)\\n\\n\\n  - **Complex types and/or value objects** . Discussion in the EF Core GitHub r\", \"epo (Issues tab)\\n[https://github.com/dotnet/efcore/issues/246](https://github.com/dotnet/efcore/issu\", \"es/246)\\n\\n\\n  - **ValueObject.cs.** Base value object class in eShopOnContainers.\\nhttps://github.com/d\", \"otnet[architecture/eShopOnContainers/blob/dev/src/Services/Ordering/Ordering.Domain/SeedWor](https:/\", \"/github.com/dotnet-architecture/eShopOnContainers/blob/dev/src/Services/Ordering/Ordering.Domain/See\", \"dWork/ValueObject.cs)\\n[k/ValueObject.cs](https://github.com/dotnet-architecture/eShopOnContainers/bl\", \"ob/dev/src/Services/Ordering/Ordering.Domain/SeedWork/ValueObject.cs)\\n\\n\\n  - **ValueObject.cs.** Base\", \" value object class in CSharpFunctionalExtensions.\\n[https://github.com/vkhorikov/CSharpFunctionalExt\", \"ensions/blob/master/CSharpFunctionalExte](https://github.com/vkhorikov/CSharpFunctionalExtensions/bl\", \"ob/master/CSharpFunctionalExtensions/ValueObject/ValueObject.cs)\\n[nsions/ValueObject/ValueObject.cs]\", \"(https://github.com/vkhorikov/CSharpFunctionalExtensions/blob/master/CSharpFunctionalExtensions/Valu\", \"eObject/ValueObject.cs)\\n\\n\\n  - **Address class.** Sample value object class in eShopOnContainers.\\nhtt\", \"ps://github.com/dotnet[architecture/eShopOnContainers/blob/dev/src/Services/Ordering/Ordering.Domain\", \"/Aggregat](https://github.com/dotnet-architecture/eShopOnContainers/blob/dev/src/Services/Ordering/O\", \"rdering.Domain/AggregatesModel/OrderAggregate/Address.cs)\\n[esModel/OrderAggregate/Address.cs](https:\", \"//github.com/dotnet-architecture/eShopOnContainers/blob/dev/src/Services/Ordering/Ordering.Domain/Ag\", \"gregatesModel/OrderAggregate/Address.cs)\\n\\n```\\nUse enumeration classes instead of enum types\\n\\n```\\n\\n[E\", \"numerations](https://docs.microsoft.com/dotnet/csharp/language-reference/builtin-types/enum) (or _en\", \"um types_ for short) are a thin language wrapper around an integral type. You\\nmight want to limit th\", \"eir use to when you are storing one value from a closed set of values.\\nClassification based on sizes\", \" (small, medium, large) is a good example. Using enums for control flow\\n[or more robust abstractions\", \" can be a code smell. This type of usage leads to fragile code with many](https://deviq.com/antipatt\", \"erns/code-smells)\\ncontrol flow statements checking values of the enum.\\n\\n\\n221 CHAPTER 6 | Tackle Busi\", \"ness Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nInstead, you can create Enumeration c\", \"lasses that enable all the rich features of an object-oriented\\nlanguage.\\n\\n\\n[However, this isn\\u2019t a cr\", \"itical topic and in many cases, for simplicity, you can still use regular enum](https://docs.microso\", \"ft.com/dotnet/csharp/language-reference/builtin-types/enum)\\n[types](https://docs.microsoft.com/dotne\", \"t/csharp/language-reference/builtin-types/enum) if that\\u2019s your preference. The use of enumeration cl\", \"asses is more related to business-related\\nconcepts.\\n\\n#### **Implement an Enumeration base class**\\n\\n\\n\", \"The ordering microservice in eShopOnContainers provides a sample Enumeration base class\\nimplementati\", \"on, as shown in the following example:\\n\\n\\n222 CHAPTER 6 | Tackle Business Complexity in a Microservic\", \"e with DDD and CQRS Patterns\\n\\n\\n#### **Additional resources**\\n\\n\\n  - **Jimmy Bogard. Enumeration class\", \"es**\\n[https://lostechies.com/jimmybogard/2008/08/12/enumeration-classes/](https://lostechies.com/jim\", \"mybogard/2008/08/12/enumeration-classes/)\\n\\n\\n  - **Steve Smith. Enum Alternatives in C#**\\n[https://ar\", \"dalis.com/enum-alternatives-in-c](https://ardalis.com/enum-alternatives-in-c)\\n\\n\\n  - **Enumeration.cs\", \".** Base Enumeration class in eShopOnContainers\\nhttps://github.com/dotnet[architecture/eShopOnContai\", \"ners/blob/dev/src/Services/Ordering/Ordering.Domain/SeedWor](https://github.com/dotnet-architecture/\", \"eShopOnContainers/blob/dev/src/Services/Ordering/Ordering.Domain/SeedWork/Enumeration.cs)\\n[k/Enumera\", \"tion.cs](https://github.com/dotnet-architecture/eShopOnContainers/blob/dev/src/Services/Ordering/Ord\", \"ering.Domain/SeedWork/Enumeration.cs)\\n\\n\\n  - **CardType.cs** . Sample Enumeration class in eShopOnCon\", \"tainers.\\nhttps://github.com/dotnet[architecture/eShopOnContainers/blob/dev/src/Services/Ordering/Ord\", \"ering.Domain/Aggregat](https://github.com/dotnet-architecture/eShopOnContainers/blob/dev/src/Service\", \"s/Ordering/Ordering.Domain/AggregatesModel/BuyerAggregate/CardType.cs)\\n[esModel/BuyerAggregate/CardT\", \"ype.cs](https://github.com/dotnet-architecture/eShopOnContainers/blob/dev/src/Services/Ordering/Orde\", \"ring.Domain/AggregatesModel/BuyerAggregate/CardType.cs)\\n\\n\\n  - **SmartEnum** . Ardalis - Classes to h\", \"elp produce strongly typed smarter enums in .NET.\\n[https://www.nuget.org/packages/Ardalis.SmartEnum/\", \"](https://www.nuget.org/packages/Ardalis.SmartEnum/)\\n\\n### Design validations in the domain model lay\", \"er\\n\\n\\nIn DDD, validation rules can be thought as invariants. The main responsibility of an aggregate \", \"is to\\nenforce invariants across state changes for all the entities within that aggregate.\\n\\n\\nDomain e\", \"ntities should always be valid entities. There are a certain number of invariants for an object\\nthat\", \" should always be true. For example, an order item object always has to have a quantity that must\\nbe\", \" a positive integer, plus an article name and price. Therefore, invariants enforcement is the\\nrespon\", \"sibility of the domain entities (especially of the aggregate root) and an entity object should not\\nb\", \"e able to exist without being valid. Invariant rules are simply expressed as contracts, and exceptio\", \"ns\\nor notifications are raised when they are violated.\\n\\n\\nThe reasoning behind this is that many bugs\", \" occur because objects are in a state they should never\\nhave been in.\\n\\n\\nLet\\u2019s propose we now have a \", \"SendUserCreationEmailService that takes a UserProfile \\u2026 how can we\\nrationalize in that service that \", \"Name is not null? Do we check it again? Or more likely \\u2026 you just don\\u2019t\\nbother to check and \\u201chope fo\", \"r the best\\u201d\\u2014you hope that someone bothered to validate it before\\nsending it to you. Of course, using\", \" TDD one of the first tests we should be writing is that if I send a\\ncustomer with a null name that \", \"it should raise an error. But once we start writing these kinds of tests\\nover and over again we real\", \"ize \\u2026 \\u201cwhat if we never allowed name to become null? we wouldn\\u2019t have\\nall of these tests!\\u201d.\\n\\n\\n223 CH\", \"APTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n#### **Implement\", \" validations in the domain model layer**\\n\\nValidations are usually implemented in domain entity const\", \"ructors or in methods that can update the\\nentity. There are multiple ways to implement validations, \", \"such as verifying data and raising exceptions\\nif the validation fails. There are also more advanced \", \"patterns such as using the Specification pattern\\nfor validations, and the Notification pattern to re\", \"turn a collection of errors instead of returning an\\nexception for each validation as it occurs.\\n\\n\\n**\", \"Validate conditions and throw exceptions**\\n\\n\\nThe following code example shows the simplest approach \", \"to validation in a domain entity by raising\\nan exception. In the references table at the end of this\", \" section you can see links to more advanced\\nimplementations based on the patterns we have discussed \", \"previously.\\n\\n\\nIf the value of the state is invalid, the first address line and the city have already\", \" been changed. That\\nmight make the address invalid.\\n\\n\\nA similar approach can be used in the entity\\u2019s\", \" constructor, raising an exception to make sure that the\\nentity is valid once it is created.\\n\\n\\n**Use\", \" validation attributes in the model based on data annotations**\\n\\n\\nData annotations, like the Require\", \"d or MaxLength attributes, can be used to configure EF Core\\ndatabase field properties, as explained \", \"in detail in the Table mapping [section, but they no longer work](https://github.com/dotnet/efcore/i\", \"ssues/3680)\\n[for entity validation in EF Core (neither does the IValidatableObject.Validate](https:/\", \"/github.com/dotnet/efcore/issues/3680) method), as they have\\ndone since EF 4.x in .NET Framework.\\n\\n\\n\", \"[Data annotations and the IValidatableObject](https://docs.microsoft.com/dotnet/api/system.component\", \"model.dataannotations.ivalidatableobject) interface can still be used for model validation during\\nmo\", \"del binding, prior to the controller\\u2019s actions invocation as usual, but that model is meant to be a\\n\", \"ViewModel or DTO and that\\u2019s an MVC or API concern not a domain model concern.\\n\\n\\nHaving made the conc\", \"eptual difference clear, you can still use data annotations and\\nIValidatableObject in the entity cla\", \"ss for validation, if your actions receive an entity class object\\nparameter, which is not recommende\", \"d. In that case, validation will occur upon model binding, just\\nbefore invoking the action and you c\", \"an check the controller\\u2019s ModelState.IsValid property to check\\n\\n\\n224 CHAPTER 6 | Tackle Business Com\", \"plexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nthe result, but then again, it happens in the\", \" controller, not before persisting the entity object in the\\nDbContext, as it had done since EF 4.x.\\n\", \"\\n\\nYou can still implement custom validation in the entity class using data annotations and the\\nIVali\", \"datableObject.Validate method, by overriding the DbContext\\u2019s SaveChanges method.\\n\\n\\n[You can see a sa\", \"mple implementation for validating IValidatableObject entities in this comment on](https://github.co\", \"m/dotnet/efcore/issues/3680#issuecomment-155502539)\\n[GitHub. That sample doesn\\u2019t do attribute-based \", \"validations, but they should be easy to implement](https://github.com/dotnet/efcore/issues/3680#issu\", \"ecomment-155502539)\\nusing reflection in the same override.\\n\\n\\nHowever, from a DDD point of view, the \", \"domain model is best kept lean with the use of exceptions in\\nyour entity\\u2019s behavior methods, or by i\", \"mplementing the Specification and Notification patterns to\\nenforce validation rules.\\n\\n\\nIt can make s\", \"ense to use data annotations at the application layer in ViewModel classes (instead of\\ndomain entiti\", \"es) that will accept input, to allow for model validation within the UI layer. However, this\\nshould \", \"not be done at the exclusion of validation within the domain model.\\n\\n\\n**Validate entities by impleme\", \"nting the Specification pattern and the Notification**\\n**pattern**\\n\\n\\nFinally, a more elaborate appro\", \"ach to implementing validations in the domain model is by\\nimplementing the Specification pattern in \", \"conjunction with the Notification pattern, as explained in\\nsome of the additional resources listed l\", \"ater.\\n\\n\\nIt is worth mentioning that you can also use just one of those patterns\\u2014for example, validat\", \"ing\\nmanually with control statements, but using the Notification pattern to stack and return a list \", \"of\\nvalidation errors.\\n\\n\\n**Use deferred validation in the domain**\\n\\n\\nThere are various approaches to \", \"deal with deferred validations in the domain. In his book\\n[Implementing Domain-Driven Design, Vaughn\", \" Vernon discusses these in the section on validation.](https://www.amazon.com/Implementing-Domain-Dr\", \"iven-Design-Vaughn-Vernon/dp/0321834577)\\n\\n\\n**Two-step validation**\\n\\n\\nAlso consider two-step validati\", \"on. Use field-level validation on your command Data Transfer Objects\\n(DTOs) and domain-level validat\", \"ion inside your entities. You can do this by returning a result object\\ninstead of exceptions in orde\", \"r to make it easier to deal with the validation errors.\\n\\n\\nUsing field validation with data annotatio\", \"ns, for example, you do not duplicate the validation\\ndefinition. The execution, though, can be both \", \"server-side and client-side in the case of DTOs\\n(commands and ViewModels, for instance).\\n\\n#### **Add\", \"itional resources**\\n\\n\\n  - **Rachel Appel. Introduction to model validation in ASP.NET Core MVC**\\n[ht\", \"tps://learn.microsoft.com/aspnet/core/mvc/models/validation](https://docs.microsoft.com/aspnet/core/\", \"mvc/models/validation)\\n\\n\\n  - **Rick Anderson. Adding validation**\\n[https://learn.microsoft.com/aspne\", \"t/core/tutorials/first-mvc-app/validation](https://docs.microsoft.com/aspnet/core/tutorials/first-mv\", \"c-app/validation)\\n\\n\\n225 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS P\", \"atterns\\n\\n\\n  - **Martin Fowler. Replacing Throwing Exceptions with Notification in Validations**\\n[htt\", \"ps://martinfowler.com/articles/replaceThrowWithNotification.html](https://martinfowler.com/articles/\", \"replaceThrowWithNotification.html)\\n\\n\\n  - **Specification and Notification Patterns**\\n[https://www.co\", \"deproject.com/Tips/790758/Specification-and-Notification-Patterns](https://www.codeproject.com/Tips/\", \"790758/Specification-and-Notification-Patterns)\\n\\n\\n  - **Lev Gorodinski. Validation in Domain-Driven \", \"Design (DDD)**\\n[http://gorodinski.com/blog/2012/05/19/validation-in-domain-driven-design-ddd/](http:\", \"//gorodinski.com/blog/2012/05/19/validation-in-domain-driven-design-ddd/)\\n\\n\\n  - **Colin Jack. Domain\", \" Model Validation**\\n[https://colinjack.blogspot.com/2008/03/domain-model-validation.html](https://co\", \"linjack.blogspot.com/2008/03/domain-model-validation.html)\\n\\n\\n  - **Jimmy Bogard. Validation in a DDD\", \" world**\\n[https://lostechies.com/jimmybogard/2009/02/15/validation-in-a-ddd-world/](https://lostechi\", \"es.com/jimmybogard/2009/02/15/validation-in-a-ddd-world/)\\n\\n### Client-side validation (validation in\", \" the presentation layers)\\n\\n\\nEven when the source of truth is the domain model and ultimately you mus\", \"t have validation at the\\ndomain model level, validation can still be handled at both the domain mode\", \"l level (server side) and\\nthe UI (client side).\\n\\n\\nClient-side validation is a great convenience for \", \"users. It saves time they would otherwise spend\\nwaiting for a round trip to the server that might re\", \"turn validation errors. In business terms, even a few\\nfractions of seconds multiplied hundreds of ti\", \"mes each day adds up to a lot of time, expense, and\\nfrustration. Straightforward and immediate valid\", \"ation enables users to work more efficiently and\\nproduce better quality input and output.\\n\\n\\nJust as \", \"the view model and the domain model are different, view model validation and domain model\\nvalidation\", \" might be similar but serve a different purpose. If you are concerned about DRY (the Don\\u2019t\\nRepeat Yo\", \"urself principle), consider that in this case code reuse might also mean coupling, and in\\nenterprise\", \" applications it is more important not to couple the server side to the client side than to\\nfollow t\", \"he DRY principle.\\n\\n\\nEven when using client-side validation, you should always validate your commands\", \" or input DTOs in\\nserver code, because the server APIs are a possible attack vector. Usually, doing \", \"both is your best bet\\nbecause if you have a client application, from a UX perspective, it is best to\", \" be proactive and not allow\\nthe user to enter invalid information.\\n\\n\\nTherefore, in client-side code \", \"you typically validate the ViewModels. You could also validate the client\\noutput DTOs or commands be\", \"fore you send them to the services.\\n\\n\\nThe implementation of client-side validation depends on what k\", \"ind of client application you are\\nbuilding. It will be different if you are validating data in a web\", \" MVC web application with most of the\\ncode in .NET, a SPA web application with that validation being\", \" coded in JavaScript or TypeScript, or a\\nmobile app coded with Xamarin and C#.\\n\\n\\n226 CHAPTER 6 | Tac\", \"kle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n#### **Additional resources**\", \"\\n\\n**Validation in Xamarin mobile apps**\\n\\n\\n  - **Validate Text Input and Show Errors**\\n[https://devel\", \"oper.xamarin.com/recipes/ios/standard_controls/text_field/validate_input/](https://developer.xamarin\", \".com/recipes/ios/standard_controls/text_field/validate_input/)\\n\\n\\n  - **Validation Callback**\\n[https:\", \"//developer.xamarin.com/samples/xamarin-forms/XAML/ValidationCallback/](https://developer.xamarin.co\", \"m/samples/xamarin-forms/XAML/ValidationCallback/)\\n\\n\\n**Validation in ASP.NET Core apps**\\n\\n\\n  - **Rick\", \" Anderson. Adding validation**\\n[https://learn.microsoft.com/aspnet/core/tutorials/first-mvc-app/vali\", \"dation](https://docs.microsoft.com/aspnet/core/tutorials/first-mvc-app/validation)\\n\\n\\n**Validation in\", \" SPA Web apps (Angular 2, TypeScript, JavaScript, Blazor**\\n**WebAssembly)**\\n\\n\\n  - **Form Validation*\", \"*\\n[https://angular.io/guide/form-validation](https://angular.io/guide/form-validation)\\n\\n\\n  - **Valid\", \"ation.** Breeze documentation.\\n[https://breeze.github.io/doc-js/validation.html](https://breeze.gith\", \"ub.io/doc-js/validation.html)\\n\\n\\n  - **ASP.NET Core Blazor forms and input components**\\n\\n\\nIn summary,\", \" these are the most important concepts in regards to validation:\\n\\n\\n  - Entities and aggregates shoul\", \"d enforce their own consistency and be \\u201calways valid\\u201d.\\nAggregate roots are responsible for multi-ent\", \"ity consistency within the same aggregate.\\n\\n\\n  - If you think that an entity needs to enter an inval\", \"id state, consider using a different object\\nmodel\\u2014for example, using a temporary DTO until you creat\", \"e the final domain entity.\\n\\n\\n  - If you need to create several related objects, such as an aggregate\", \", and they are only valid\\nonce all of them have been created, consider using the Factory pattern.\\n\\n\\n\", \"  - In most of the cases, having redundant validation in the client side is good, because the\\napplic\", \"ation can be proactive.\\n\\n### Domain events: Design and implementation\\n\\n\\nUse domain events to explici\", \"tly implement side effects of changes within your domain. In other words,\\nand using DDD terminology,\", \" use domain events to explicitly implement side effects across multiple\\naggregates. Optionally, for \", \"better scalability and less impact in database locks, use eventual\\nconsistency between aggregates wi\", \"thin the same domain.\\n\\n\\n227 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQ\", \"RS Patterns\\n\\n\\n#### **What is a domain event?**\\n\\nAn event is something that has happened in the past.\", \" A domain event is, something that happened in\\nthe domain that you want other parts of the same doma\", \"in (in-process) to be aware of. The notified\\nparts usually react somehow to the events.\\n\\n\\nAn importa\", \"nt benefit of domain events is that side effects can be expressed explicitly.\\n\\n\\nFor example, if you\\u2019\", \"re just using Entity Framework and there has to be a reaction to some event, you\\nwould probably code\", \" whatever you need close to what triggers the event. So the rule gets coupled,\\nimplicitly, to the co\", \"de, and you have to look into the code to, hopefully, realize the rule is\\nimplemented there.\\n\\n\\nOn th\", \"e other hand, using domain events makes the concept explicit, because there\\u2019s a DomainEvent\\nand at l\", \"east one DomainEventHandler involved.\\n\\n\\nFor example, in the eShopOnContainers application, when an o\", \"rder is created, the user becomes a\\nbuyer, so an OrderStartedDomainEvent is raised and handled in th\", \"e\\nValidateOrAddBuyerAggregateWhenOrderStartedDomainEventHandler, so the underlying concept is\\neviden\", \"t.\\n\\n\\nIn short, domain events help you to express, explicitly, the domain rules, based in the ubiquit\", \"ous\\nlanguage provided by the domain experts. Domain events also enable a better separation of concer\", \"ns\\namong classes within the same domain.\\n\\n\\nIt\\u2019s important to ensure that, just like a database trans\", \"action, either all the operations related to a\\ndomain event finish successfully or none of them do.\\n\", \"\\n\\nDomain events are similar to messaging-style events, with one important difference. With real\\nmess\", \"aging, message queuing, message brokers, or a service bus using AMQP, a message is always\\nsent async\", \"hronously and communicated across processes and machines. This is useful for integrating\\nmultiple Bo\", \"unded Contexts, microservices, or even different applications. However, with domain\\nevents, you want\", \" to raise an event from the domain operation you\\u2019re currently running, but you want\\nany side effects\", \" to occur within the same domain.\\n\\n\\nThe domain events and their side effects (the actions triggered \", \"afterwards that are managed by event\\nhandlers) should occur almost immediately, usually in-process, \", \"and within the same domain. Thus,\\ndomain events could be synchronous or asynchronous. Integration ev\", \"ents, however, should always be\\nasynchronous.\\n\\n#### **Domain events versus integration events**\\n\\n\\nSe\", \"mantically, domain and integration events are the same thing: notifications about something that\\njus\", \"t happened. However, their implementation must be different. Domain events are just messages\\npushed \", \"to a domain event dispatcher, which could be implemented as an in-memory mediator based\\non an IoC co\", \"ntainer or any other method.\\n\\n\\nOn the other hand, the purpose of integration events is to propagate \", \"committed transactions and\\nupdates to additional subsystems, whether they are other microservices, B\", \"ounded Contexts or even\\n\\n\\n228 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and \", \"CQRS Patterns\\n\\n\\nexternal applications. Hence, they should occur only if the entity is successfully p\", \"ersisted, otherwise it\\u2019s\\nas if the entire operation never happened.\\n\\n\\nAs mentioned before, integrati\", \"on events must be based on asynchronous communication between\\nmultiple microservices (other Bounded \", \"Contexts) or even external systems/applications.\\n\\n\\nThus, the event bus interface needs some infrastr\", \"ucture that allows inter-process and distributed\\ncommunication between potentially remote services. \", \"It can be based on a commercial service bus,\\nqueues, a shared database used as a mailbox, or any oth\", \"er distributed and ideally push based\\nmessaging system.\\n\\n#### **Domain events as a preferred way to \", \"trigger side effects across** **multiple aggregates within the same domain**\\n\\n\\nIf executing a comman\", \"d related to one aggregate instance requires additional domain rules to be run\\non one or more additi\", \"onal aggregates, you should design and implement those side effects to be\\ntriggered by domain events\", \". As shown in Figure 7-14, and as one of the most important use cases, a\\ndomain event should be used\", \" to propagate state changes across multiple aggregates within the same\\ndomain model.\\n\\n\\n_Figure 7-14.\", \" Domain events to enforce consistency between multiple aggregates within the same domain_\\n\\n\\nFigure 7\", \"-14 shows how consistency between aggregates is achieved by domain events. When the user\\ninitiates a\", \"n order, the Order Aggregate sends an OrderStarted domain event. The OrderStarted\\ndomain event is ha\", \"ndled by the Buyer Aggregate to create a Buyer object in the ordering\\nmicroservice, based on the ori\", \"ginal user info from the identity microservice (with information provided\\nin the CreateOrder command\", \").\\n\\n\\nAlternately, you can have the aggregate root subscribed for events raised by members of its\\nagg\", \"regates (child entities). For instance, each OrderItem child entity can raise an event when the item\", \"\\nprice is higher than a specific amount, or when the product item amount is too high. The aggregate\\n\", \"root can then receive those events and perform a global calculation or aggregation.\\n\\n\\n229 CHAPTER 6 \", \"| Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nIt\\u2019s important to unders\", \"tand that this event-based communication is not implemented directly within\\nthe aggregates; you need\", \" to implement domain event handlers.\\n\\n\\nHandling the domain events is an application concern. The dom\", \"ain model layer should only focus on\\nthe domain logic\\u2014things that a domain expert would understand, \", \"not application infrastructure like\\nhandlers and side-effect persistence actions using repositories.\", \" Therefore, the application layer level is\\nwhere you should have domain event handlers triggering ac\", \"tions when a domain event is raised.\\n\\n\\nDomain events can also be used to trigger any number of appli\", \"cation actions, and what is more\\nimportant, must be open to increase that number in the future in a \", \"decoupled way. For instance, when\\nthe order is started, you might want to publish a domain event to \", \"propagate that info to other\\naggregates or even to raise application actions like notifications.\\n\\n\\nT\", \"he key point is the open number of actions to be executed when a domain event occurs. Eventually,\\nth\", \"e actions and rules in the domain and application will grow. The complexity or number of sideeffect \", \"actions when something happens will grow, but if your code were coupled with \\u201cglue\\u201d (that is,\\ncreati\", \"ng specific objects with new), then every time you needed to add a new action you would also\\nneed to\", \" change working and tested code.\\n\\n\\n[This change could result in new bugs and this approach also goes\", \" against the Open/Closed principle](https://en.wikipedia.org/wiki/Open/closed_principle)\\n[from SOLID\", \". Not only that, the original class that was orchestrating the operations would grow and](https://en\", \".wikipedia.org/wiki/SOLID)\\n[grow, which goes against the Single Responsibility Principle (SRP).](htt\", \"ps://en.wikipedia.org/wiki/Single_responsibility_principle)\\n\\n\\nOn the other hand, if you use domain e\", \"vents, you can create a fine-grained and decoupled\\nimplementation by segregating responsibilities us\", \"ing this approach:\\n\\n\\n1. Send a command (for example, CreateOrder).\\n\\n2. Receive the command in a comm\", \"and handler.\\n\\n     - Execute a single aggregate\\u2019s transaction.\\n\\n     - (Optional) Raise domain event\", \"s for side effects (for example,\\nOrderStartedDomainEvent).\\n\\n3. Handle domain events (within the curr\", \"ent process) that will execute an open number of side\\neffects in multiple aggregates or application \", \"actions. For example:\\n\\n     - Verify or create buyer and payment method.\\n\\n     - Create and send a r\", \"elated integration event to the event bus to propagate states\\nacross microservices or trigger extern\", \"al actions like sending an email to the buyer.\\n\\n     - Handle other side effects.\\n\\n\\nAs shown in Figu\", \"re 7-15, starting from the same domain event, you can handle multiple actions\\nrelated to other aggre\", \"gates in the domain or additional application actions you need to perform\\nacross microservices conne\", \"cting with integration events and the event bus.\\n\\n\\n230 CHAPTER 6 | Tackle Business Complexity in a M\", \"icroservice with DDD and CQRS Patterns\\n\\n\\n_Figure 7-15. Handling multiple actions per domain_\\n\\n\\nThere\", \" can be several handlers for the same domain event in the Application Layer, one handler can\\nsolve c\", \"onsistency between aggregates and another handler can publish an integration event, so other\\nmicrose\", \"rvices can do something with it. The event handlers are typically in the application layer,\\nbecause \", \"you\\u2019ll use infrastructure objects like repositories or an application API for the microservice\\u2019s\\nbeh\", \"avior. In that sense, event handlers are similar to command handlers, so both are part of the\\napplic\", \"ation layer. The important difference is that a command should be processed only once. A\\ndomain even\", \"t could be processed zero or _n_ times, because it can be received by multiple receivers or\\nevent ha\", \"ndlers with a different purpose for each handler.\\n\\n\\nHaving an open number of handlers per domain eve\", \"nt allows you to add as many domain rules as\\nneeded, without affecting current code. For instance, i\", \"mplementing the following business rule might\\nbe as easy as adding a few event handlers (or even jus\", \"t one):\\n\\n\\nWhen the total amount purchased by a customer in the store, across any number of orders, e\", \"xceeds\\n$6,000, apply a 10% off discount to every new order and notify the customer with an email abo\", \"ut that\\ndiscount for future orders.\\n\\n#### **Implement domain events**\\n\\n\\nIn C#, a domain event is sim\", \"ply a data-holding structure or class, like a DTO, with all the information\\nrelated to what just hap\", \"pened in the domain, as shown in the following example:\\n\\n\\n231 CHAPTER 6 | Tackle Business Complexity\", \" in a Microservice with DDD and CQRS Patterns\\n\\n\\nThis is essentially a class that holds all the data \", \"related to the OrderStarted event.\\n\\n\\nIn terms of the ubiquitous language of the domain, since an eve\", \"nt is something that happened in the\\npast, the class name of the event should be represented as a pa\", \"st-tense verb, like\\nOrderStartedDomainEvent or OrderShippedDomainEvent. That\\u2019s how the domain event \", \"is\\nimplemented in the ordering microservice in eShopOnContainers.\\n\\n\\nAs noted earlier, an important c\", \"haracteristic of events is that since an event is something that\\nhappened in the past, it shouldn\\u2019t \", \"change. Therefore, it must be an immutable class. You can see in\\nthe previous code that the properti\", \"es are read-only. There\\u2019s no way to update the object, you can only\\nset values when you create it.\\n\\n\", \"\\nIt\\u2019s important to highlight here that if domain events were to be handled asynchronously, using a\\nq\", \"ueue that required serializing and deserializing the event objects, the properties would have to be\\n\", \"\\u201cprivate set\\u201d instead of read-only, so the deserializer would be able to assign the values upon\\ndequ\", \"euing. This is not an issue in the Ordering microservice, as the domain event pub/sub is\\nimplemented\", \" synchronously using MediatR.\\n\\n\\n**Raise domain events**\\n\\n\\nThe next question is how to raise a domain\", \" event so it reaches its related event handlers. You can use\\nmultiple approaches.\\n\\n\\n[Udi Dahan origi\", \"nally proposed (for example, in several related posts, such as Domain Events \\u2013 Take 2)](https://udid\", \"ahan.com/2008/08/25/domain-events-take-2/)\\nusing a static class for managing and raising the events.\", \" This might include a static class named\\nDomainEvents that would raise domain events immediately whe\", \"n it\\u2019s called, using syntax like\\n[DomainEvents.Raise(Event myEvent). Jimmy Bogard wrote a blog post \", \"(Strengthening your domain:](https://lostechies.com/jimmybogard/2010/04/08/strengthening-your-domain\", \"-domain-events/)\\n[Domain Events) that recommends a similar approach.](https://lostechies.com/jimmybo\", \"gard/2010/04/08/strengthening-your-domain-domain-events/)\\n\\n\\nHowever, when the domain events class is\", \" static, it also dispatches to handlers immediately. This\\nmakes testing and debugging more difficult\", \", because the event handlers with side-effects logic are\\nexecuted immediately after the event is rai\", \"sed. When you\\u2019re testing and debugging, you just want to\\nfocus on what is happening in the current a\", \"ggregate classes; you don\\u2019t want to suddenly be\\n\\n\\n232 CHAPTER 6 | Tackle Business Complexity in a Mi\", \"croservice with DDD and CQRS Patterns\\n\\n\\nredirected to other event handlers for side effects related \", \"to other aggregates or application logic.\\nThis is why other approaches have evolved, as explained in\", \" the next section.\\n\\n\\n**The deferred approach to raise and dispatch events**\\n\\n\\nInstead of dispatching\", \" to a domain event handler immediately, a better approach is to add the\\ndomain events to a collectio\", \"n and then to dispatch those domain events _right before_ or _right_ _after_\\ncommitting the transact\", \"ion (as with SaveChanges in EF). (This approach was described by Jimmy\\n[Bogard in this post A better\", \" domain events pattern.)](https://lostechies.com/jimmybogard/2014/05/13/a-better-domain-events-patte\", \"rn/)\\n\\n\\nDeciding if you send the domain events right before or right after committing the transaction\", \" is\\nimportant, since it determines whether you will include the side effects as part of the same tra\", \"nsaction\\nor in different transactions. In the latter case, you need to deal with eventual consistenc\", \"y across\\nmultiple aggregates. This topic is discussed in the next section.\\n\\n\\nThe deferred approach i\", \"s what eShopOnContainers uses. First, you add the events happening in your\\nentities into a collectio\", \"n or list of events per entity. That list should be part of the entity object, or\\neven better, part \", \"of your base entity class, as shown in the following example of the Entity base class:\\n\\n\\nWhen you wa\", \"nt to raise an event, you just add it to the event collection from code at any method of\\nthe aggrega\", \"te-root entity.\\n\\n\\n[The following code, part of the Order aggregate-root at eShopOnContainers, shows \", \"an example:](https://github.com/dotnet-architecture/eShopOnContainers/blob/dev/src/Services/Ordering\", \"/Ordering.Domain/AggregatesModel/OrderAggregate/Order.cs)\\n\\n\\nNotice that the only thing that the AddD\", \"omainEvent method is doing is adding an event to the list.\\nNo event is dispatched yet, and no event \", \"handler is invoked yet.\\n\\n\\n233 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and \", \"CQRS Patterns\\n\\n\\nYou actually want to dispatch the events later on, when you commit the transaction t\", \"o the database. If\\nyou are using Entity Framework Core, that means in the SaveChanges method of your\", \" EF DbContext,\\nas in the following code:\\n\\n\\nWith this code, you dispatch the entity events to their r\", \"espective event handlers.\\n\\n\\nThe overall result is that you\\u2019ve decoupled the raising of a domain even\", \"t (a simple add into a list in\\nmemory) from dispatching it to an event handler. In addition, dependi\", \"ng on what kind of dispatcher\\nyou are using, you could dispatch the events synchronously or asynchro\", \"nously.\\n\\n\\nBe aware that transactional boundaries come into significant play here. If your unit of wo\", \"rk and\\ntransaction can span more than one aggregate (as when using EF Core and a relational database\", \"), this\\ncan work well. But if the transaction cannot span aggregates, you have to implement addition\", \"al steps\\nto achieve consistency. This is another reason why persistence ignorance is not universal; \", \"it depends\\non the storage system you use.\\n\\n\\n**Single transaction across aggregates versus eventual c\", \"onsistency across**\\n**aggregates**\\n\\n\\nThe question of whether to perform a single transaction across \", \"aggregates versus relying on eventual\\nconsistency across those aggregates is a controversial one. Ma\", \"ny DDD authors like Eric Evans and\\nVaughn Vernon advocate the rule that one transaction = one aggreg\", \"ate and therefore argue for\\neventual consistency across aggregates. For example, in his book _Domain\", \"-Driven Design_, Eric Evans\\nsays this:\\n\\n\\nAny rule that spans Aggregates will not be expected to be u\", \"p-to-date at all times. Through event\\nprocessing, batch processing, or other update mechanisms, othe\", \"r dependencies can be resolved\\nwithin some specific time. (page 128)\\n\\n\\n[Vaughn Vernon says the follo\", \"wing in Effective Aggregate Design. Part II: Making Aggregates Work](https://dddcommunity.org/wp-con\", \"tent/uploads/files/pdf_articles/Vernon_2011_2.pdf)\\n[Together:](https://dddcommunity.org/wp-content/u\", \"ploads/files/pdf_articles/Vernon_2011_2.pdf)\\n\\n\\n234 CHAPTER 6 | Tackle Business Complexity in a Micro\", \"service with DDD and CQRS Patterns\\n\\n\\nThus, if executing a command on one aggregate instance requires\", \" that additional business rules\\nexecute on one or more aggregates, use eventual consistency [\\u2026] Ther\", \"e is a practical way to support\\neventual consistency in a DDD model. An aggregate method publishes a\", \" domain event that is in time\\ndelivered to one or more asynchronous subscribers.\\n\\n\\nThis rationale is\", \" based on embracing fine-grained transactions instead of transactions spanning many\\naggregates or en\", \"tities. The idea is that in the second case, the number of database locks will be\\nsubstantial in lar\", \"ge-scale applications with high scalability needs. Embracing the fact that highly\\nscalable applicati\", \"ons need not have instant transactional consistency between multiple aggregates\\nhelps with accepting\", \" the concept of eventual consistency. Atomic changes are often not needed by\\nthe business, and it is\", \" in any case the responsibility of the domain experts to say whether particular\\noperations need atom\", \"ic transactions or not. If an operation always needs an atomic transaction\\nbetween multiple aggregat\", \"es, you might ask whether your aggregate should be larger or wasn\\u2019t\\ncorrectly designed.\\n\\n\\nHowever, o\", \"ther developers and architects like Jimmy Bogard are okay with spanning a single\\ntransaction across \", \"several aggregates\\u2014but only when those additional aggregates are related to side\\n[effects for the sa\", \"me original command. For instance, in A better domain events pattern, Bogard says](https://lostechie\", \"s.com/jimmybogard/2014/05/13/a-better-domain-events-pattern/)\\nthis:\\n\\n\\nTypically, I want the side eff\", \"ects of a domain event to occur within the same logical transaction, but\\nnot necessarily in the same\", \" scope of raising the domain event [\\u2026] Just before we commit our\\ntransaction, we dispatch our events\", \" to their respective handlers.\\n\\n\\nIf you dispatch the domain events right _before_ committing the ori\", \"ginal transaction, it is because you\\nwant the side effects of those events to be included in the sam\", \"e transaction. For example, if the EF\\nDbContext SaveChanges method fails, the transaction will roll \", \"back all changes, including the result of\\nany side effect operations implemented by the related doma\", \"in event handlers. This is because the\\nDbContext life scope is by default defined as \\u201cscoped.\\u201d There\", \"fore, the DbContext object is shared\\nacross multiple repository objects being instantiated within th\", \"e same scope or object graph. This\\ncoincides with the HttpRequest scope when developing Web API or M\", \"VC apps.\\n\\n\\nActually, both approaches (single atomic transaction and eventual consistency) can be rig\", \"ht. It really\\ndepends on your domain or business requirements and what the domain experts tell you. \", \"It also\\ndepends on how scalable you need the service to be (more granular transactions have less imp\", \"act\\nwith regard to database locks). And it depends on how much investment you\\u2019re willing to make in\\n\", \"your code, since eventual consistency requires more complex code in order to detect possible\\ninconsi\", \"stencies across aggregates and the need to implement compensatory actions. Consider that if\\nyou comm\", \"it changes to the original aggregate and afterwards, when the events are being dispatched,\\nif there\\u2019\", \"s an issue and the event handlers cannot commit their side effects, you\\u2019ll have inconsistencies\\nbetw\", \"een aggregates.\\n\\n\\nA way to allow compensatory actions would be to store the domain events in additio\", \"nal database\\ntables so they can be part of the original transaction. Afterwards, you could have a ba\", \"tch process that\\ndetects inconsistencies and runs compensatory actions by comparing the list of even\", \"ts with the\\ncurrent state of the aggregates. The compensatory actions are part of a complex topic th\", \"at will require\\ndeep analysis from your side, which includes discussing it with the business user an\", \"d domain experts.\\n\\n\\n235 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS P\", \"atterns\\n\\n\\nIn any case, you can choose the approach you need. But the initial deferred approach\\u2014raisi\", \"ng the\\nevents before committing, so you use a single transaction\\u2014is the simplest approach when using\", \" EF\\nCore and a relational database. It\\u2019s easier to implement and valid in many business cases. It\\u2019s \", \"also the\\napproach used in the ordering microservice in eShopOnContainers.\\n\\n\\nBut how do you actually \", \"dispatch those events to their respective event handlers? What\\u2019s the\\n_mediator object you see in the\", \" previous example? It has to do with the techniques and artifacts you\\nuse to map between events and \", \"their event handlers.\\n\\n\\n**The domain event dispatcher: mapping from events to event handlers**\\n\\n\\nOnc\", \"e you\\u2019re able to dispatch or publish the events, you need some kind of artifact that will publish th\", \"e\\nevent, so that every related handler can get it and process side effects based on that event.\\n\\n\\nOn\", \"e approach is a real messaging system or even an event bus, possibly based on a service bus as\\noppos\", \"ed to in-memory events. However, for the first case, real messaging would be overkill for\\nprocessing\", \" domain events, since you just need to process those events within the same process (that\\nis, within\", \" the same domain and application layer).\\n\\n\\n**How to subscribe to domain events**\\n\\n\\nWhen you use Medi\", \"atR, each event handler must use an event type that is provided on the generic\\nparameter of the INot\", \"ificationHandler interface, as you can see in the following code:\\n\\n\\nBased on the relationship betwee\", \"n event and event handler, which can be considered the\\nsubscription, the MediatR artifact can discov\", \"er all the event handlers for each event and trigger each\\none of those event handlers.\\n\\n\\n**How to ha\", \"ndle domain events**\\n\\n\\nFinally, the event handler usually implements application layer code that use\", \"s infrastructure\\nrepositories to obtain the required additional aggregates and to execute side-effec\", \"t domain logic. The\\n[following domain event handler code at eShopOnContainers, shows an implementati\", \"on example.](https://github.com/dotnet-architecture/eShopOnContainers/blob/dev/src/Services/Ordering\", \"/Ordering.API/Application/DomainEventHandlers/ValidateOrAddBuyerAggregateWhenOrderStartedDomainEvent\", \"Handler.cs)\\n\\n\\n236 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Pattern\", \"s\\n\\n\\nThe previous domain event handler code is considered application layer code because it uses\\ninfr\", \"astructure repositories, as explained in the next section on the infrastructure-persistence layer.\\nE\", \"vent handlers could also use other infrastructure components.\\n\\n\\n**Domain events can generate integra\", \"tion events to be published outside of the**\\n**microservice boundaries**\\n\\n\\nFinally, it\\u2019s important t\", \"o mention that you might sometimes want to propagate events across multiple\\nmicroservices. That prop\", \"agation is an integration event, and it could be published through an event\\nbus from any specific do\", \"main event handler.\\n\\n#### **Conclusions on domain events**\\n\\n\\nAs stated, use domain events to explici\", \"tly implement side effects of changes within your domain. To\\nuse DDD terminology, use domain events \", \"to explicitly implement side effects across one or multiple\\naggregates. Additionally, and for better\", \" scalability and less impact on database locks, use eventual\\nconsistency between aggregates within t\", \"he same domain.\\n\\n\\n237 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Pat\", \"terns\\n\\n\\n[The reference app uses MediatR to propagate domain events synchronously across aggregates, \", \"within](https://github.com/jbogard/MediatR)\\n[a single transaction. However, you could also use some \", \"AMQP implementation like RabbitMQ or](https://www.rabbitmq.com/)\\n[Azure Service Bus](https://docs.mi\", \"crosoft.com/azure/service-bus-messaging/service-bus-messaging-overview) to propagate domain events a\", \"synchronously, using eventual consistency but, as\\nmentioned above, you have to consider the need for\", \" compensatory actions in case of failures.\\n\\n#### **Additional resources**\\n\\n\\n  - **Greg Young. What i\", \"s a Domain Event?**\\n[https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf#page=25](https://cq\", \"rs.files.wordpress.com/2010/11/cqrs_documents.pdf#page=25)\\n\\n\\n  - **Jan Stenberg. Domain Events and E\", \"ventual Consistency**\\n[https://www.infoq.com/news/2015/09/domain-events-consistency](https://www.inf\", \"oq.com/news/2015/09/domain-events-consistency)\\n\\n\\n  - **Jimmy Bogard. A better domain events pattern*\", \"*\\n[https://lostechies.com/jimmybogard/2014/05/13/a-better-domain-events-pattern/](https://lostechies\", \".com/jimmybogard/2014/05/13/a-better-domain-events-pattern/)\\n\\n\\n  - **Vaughn Vernon. Effective Aggreg\", \"ate Design Part II: Making Aggregates Work Together**\\n[https://dddcommunity.org/wp-content/uploads/f\", \"iles/pdf_articles/Vernon_2011_2.pdf](https://dddcommunity.org/wp-content/uploads/files/pdf_articles/\", \"Vernon_2011_2.pdf)\\n\\n\\n  - **Jimmy Bogard. Strengthening your domain: Domain Events**\\n[https://lostech\", \"ies.com/jimmybogard/2010/04/08/strengthening-your-domain-domain-](https://lostechies.com/jimmybogard\", \"/2010/04/08/strengthening-your-domain-domain-events/)\\nevents/\\n\\n\\n  - **Udi Dahan. How to create fully\", \" encapsulated Domain Models**\\n[https://udidahan.com/2008/02/29/how-to-create-fully-encapsulated-doma\", \"in-models/](https://udidahan.com/2008/02/29/how-to-create-fully-encapsulated-domain-models/)\\n\\n\\n  - *\", \"*Udi Dahan. Domain Events \\u2013 Take 2**\\n[https://udidahan.com/2008/08/25/domain-events-take-2/](https:/\", \"/udidahan.com/2008/08/25/domain-events-take-2/)\\n\\n\\n  - **Udi Dahan. Domain Events \\u2013 Salvation**\\n[http\", \"s://udidahan.com/2009/06/14/domain-events-salvation/](https://udidahan.com/2009/06/14/domain-events-\", \"salvation/)\\n\\n\\n  - **Cesar de la Torre. Domain Events vs. Integration Events in DDD and microservices\", \"**\\n**architectures**\\n[https://devblogs.microsoft.com/cesardelatorre/domain-events-vs-integration-eve\", \"nts-in-](https://devblogs.microsoft.com/cesardelatorre/domain-events-vs-integration-events-in-domain\", \"-driven-design-and-microservices-architectures/)\\n[domain-driven-design-and-microservices-architectur\", \"es/](https://devblogs.microsoft.com/cesardelatorre/domain-events-vs-integration-events-in-domain-dri\", \"ven-design-and-microservices-architectures/)\\n\\n### Design the infrastructure persistence layer\\n\\n\\nData\", \" persistence components provide access to the data hosted within the boundaries of a\\nmicroservice (t\", \"hat is, a microservice\\u2019s database). They contain the actual implementation of\\n[components such as re\", \"positories and Unit of Work](https://martinfowler.com/eaaCatalog/unitOfWork.html) classes, like cust\", \"om Entity Framework (EF)\\n[DbContext](https://docs.microsoft.com/dotnet/api/microsoft.entityframework\", \"core.dbcontext) objects. EF DbContext implements both the Repository and the Unit of Work patterns.\\n\", \"\\n#### **The Repository pattern**\\n\\n\\nThe Repository pattern is a Domain-Driven Design pattern intended\", \" to keep persistence concerns\\noutside of the system\\u2019s domain model. One or more persistence abstract\", \"ions - interfaces - are defined\\n\\n\\n238 CHAPTER 6 | Tackle Business Complexity in a Microservice with \", \"DDD and CQRS Patterns\\n\\n\\nin the domain model, and these abstractions have implementations in the form\", \" of persistence-specific\\nadapters defined elsewhere in the application.\\n\\n\\nRepository implementations\", \" are classes that encapsulate the logic required to access data sources.\\nThey centralize common data\", \" access functionality, providing better maintainability and decoupling\\nthe infrastructure or technol\", \"ogy used to access databases from the domain model. If you use an\\nObject-Relational Mapper (ORM) lik\", \"e Entity Framework, the code that must be implemented is\\nsimplified, thanks to LINQ and strong typin\", \"g. This lets you focus on the data persistence logic rather\\nthan on data access plumbing.\\n\\n\\n[The Rep\", \"ository pattern is a well-documented way of working with a data source. In the book Patterns](https:\", \"//www.amazon.com/Patterns-Enterprise-Application-Architecture-Martin/dp/0321127420/)\\n[of Enterprise \", \"Application Architecture, Martin Fowler describes a repository as follows:](https://www.amazon.com/P\", \"atterns-Enterprise-Application-Architecture-Martin/dp/0321127420/)\\n\\n\\nA repository performs the tasks\", \" of an intermediary between the domain model layers and data\\nmapping, acting in a similar way to a s\", \"et of domain objects in memory. Client objects declaratively\\nbuild queries and send them to the repo\", \"sitories for answers. Conceptually, a repository encapsulates a\\nset of objects stored in the databas\", \"e and operations that can be performed on them, providing a way\\nthat is closer to the persistence la\", \"yer. Repositories, also, support the purpose of separating, clearly\\nand in one direction, the depend\", \"ency between the work domain and the data allocation or mapping.\\n\\n\\n**Define one repository per aggre\", \"gate**\\n\\n\\nFor each aggregate or aggregate root, you should create one repository class. You may be ab\", \"le to\\nleverage C# Generics to reduce the total number concrete classes you need to maintain (as\\ndemo\", \"nstrated later in this chapter). In a microservice based on Domain-Driven Design (DDD) patterns,\\nthe\", \" only channel you should use to update the database should be the repositories. This is because\\nthey\", \" have a one-to-one relationship with the aggregate root, which controls the aggregate\\u2019s\\ninvariants a\", \"nd transactional consistency. It\\u2019s okay to query the database through other channels (as\\nyou can do \", \"following a CQRS approach), because queries don\\u2019t change the state of the database.\\nHowever, the tra\", \"nsactional area (that is, the updates) must always be controlled by the repositories\\nand the aggrega\", \"te roots.\\n\\n\\nBasically, a repository allows you to populate data in memory that comes from the databa\", \"se in the\\nform of the domain entities. Once the entities are in memory, they can be changed and then\", \" persisted\\nback to the database through transactions.\\n\\n\\nAs noted earlier, if you\\u2019re using the CQS/CQ\", \"RS architectural pattern, the initial queries are performed\\nby side queries out of the domain model,\", \" performed by simple SQL statements using Dapper. This\\napproach is much more flexible than repositor\", \"ies because you can query and join any tables you\\nneed, and these queries aren\\u2019t restricted by rules\", \" from the aggregates. That data goes to the\\npresentation layer or client app.\\n\\n\\nIf the user makes ch\", \"anges, the data to be updated comes from the client app or presentation layer to\\nthe application lay\", \"er (such as a Web API service). When you receive a command in a command\\nhandler, you use repositorie\", \"s to get the data you want to update from the database. You update it in\\nmemory with the data passed\", \" with the commands, and you then add or update the data (domain\\nentities) in the database through a \", \"transaction.\\n\\n\\n239 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patter\", \"ns\\n\\n\\nIt\\u2019s important to emphasize again that you should only define one repository for each aggregate\", \" root,\\nas shown in Figure 7-17. To achieve the goal of the aggregate root to maintain transactional\\n\", \"consistency between all the objects within the aggregate, you should never create a repository for\\ne\", \"ach table in the database.\\n\\n\\n_Figure 7-17. The relationship between repositories, aggregates, and da\", \"tabase tables_\\n\\n\\nThe above diagram shows the relationships between Domain and Infrastructure layers:\", \" Buyer\\nAggregate depends on the IBuyerRepository and Order Aggregate depends on the IOrderRepository\", \"\\ninterfaces, these interfaces are implemented in the Infrastructure layer by the corresponding\\nrepos\", \"itories that depend on UnitOfWork, also implemented there, that accesses the tables in the Data\\ntier\", \".\\n\\n\\n**Enforce one aggregate root per repository**\\n\\n\\nIt can be valuable to implement your repository \", \"design in such a way that it enforces the rule that only\\naggregate roots should have repositories. Y\", \"ou can create a generic or base repository type that\\nconstrains the type of entities it works with t\", \"o ensure they have the IAggregateRoot marker interface.\\n\\n\\nThus, each repository class implemented at\", \" the infrastructure layer implements its own contract or\\ninterface, as shown in the following code:\\n\", \"\\n\\n240 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nEach spe\", \"cific repository interface implements the generic IRepository interface:\\n\\n\\nHowever, a better way to \", \"have the code enforce the convention that each repository is related to a\\nsingle aggregate is to imp\", \"lement a generic repository type. That way, it\\u2019s explicit that you\\u2019re using a\\nrepository to target a\", \" specific aggregate. That can be easily done by implementing a generic\\nIRepository base interface, a\", \"s in the following code:\\n\\n\\n**The Repository pattern makes it easier to test your application logic**\", \"\\n\\n\\nThe Repository pattern allows you to easily test your application with unit tests. Remember that \", \"unit\\ntests only test your code, not infrastructure, so the repository abstractions make it easier to\", \" achieve\\nthat goal.\\n\\n\\nAs noted in an earlier section, it\\u2019s recommended that you define and place the\", \" repository interfaces in\\nthe domain model layer so the application layer, such as your Web API micr\", \"oservice, doesn\\u2019t depend\\ndirectly on the infrastructure layer where you\\u2019ve implemented the actual re\", \"pository classes. By doing\\nthis and using Dependency Injection in the controllers of your Web API, y\", \"ou can implement mock\\nrepositories that return fake data instead of data from the database. This dec\", \"oupled approach allows\\nyou to create and run unit tests that focus the logic of your application wit\", \"hout requiring connectivity\\nto the database.\\n\\n\\nConnections to databases can fail and, more important\", \"ly, running hundreds of tests against a\\ndatabase is bad for two reasons. First, it can take a long t\", \"ime because of the large number of tests.\\nSecond, the database records might change and impact the r\", \"esults of your tests, especially if your\\ntests are running in parallel, so that they might not be co\", \"nsistent. Unit tests typically can run in\\nparallel; integration tests may not support parallel execu\", \"tion depending on their implementation.\\nTesting against the database isn\\u2019t a unit test but an integr\", \"ation test. You should have many unit tests\\nrunning fast, but fewer integration tests against the da\", \"tabases.\\n\\n\\nIn terms of separation of concerns for unit tests, your logic operates on domain entities\", \" in memory. It\\nassumes the repository class has delivered those. Once your logic modifies the domain\", \" entities, it\\nassumes the repository class will store them correctly. The important point here is to\", \" create unit tests\\nagainst your domain model and its domain logic. Aggregate roots are the main cons\", \"istency\\nboundaries in DDD.\\n\\n\\nThe repositories implemented in eShopOnContainers rely on EF Core\\u2019s DbC\", \"ontext implementation of\\nthe Repository and Unit of Work patterns using its change tracker, so they \", \"don\\u2019t duplicate this\\nfunctionality.\\n\\n\\n241 CHAPTER 6 | Tackle Business Complexity in a Microservice w\", \"ith DDD and CQRS Patterns\\n\\n\\n**The difference between the Repository pattern and the legacy Data Acce\", \"ss class**\\n**(DAL class) pattern**\\n\\n\\nA typical DAL object directly performs data access and persiste\", \"nce operations against storage, often\\nat the level of a single table and row. Simple CRUD operations\", \" implemented with a set of DAL classes\\nfrequently do not support transactions (though this is not al\", \"ways the case). Most DAL class\\napproaches make minimal use of abstractions, resulting in tight coupl\", \"ing between application or\\nBusiness Logic Layer (BLL) classes that call the DAL objects.\\n\\n\\nWhen usin\", \"g repository, the implementation details of persistence are encapsulated away from the\\ndomain model.\", \" The use of an abstraction provides ease of extending behavior through patterns like\\n[Decorators or \", \"Proxies. For instance, cross-cutting concerns like caching, logging, and error handling](https://ard\", \"alis.com/building-a-cachedrepository-in-aspnet-core/)\\ncan all be applied using these patterns rather\", \" than hard-coded in the data access code itself. It\\u2019s also\\ntrivial to support multiple repository ad\", \"apters which may be used in different environments, from\\nlocal development to shared staging environ\", \"ments to production.\\n\\n\\n**Implementing Unit of Work**\\n\\n\\n[A unit of work](https://martinfowler.com/eaa\", \"Catalog/unitOfWork.html) refers to a single transaction that involves multiple insert, update, or de\", \"lete operations.\\nIn simple terms, it means that for a specific user action, such as a registration o\", \"n a website, all the\\ninsert, update, and delete operations are handled in a single transaction. This\", \" is more efficient than\\nhandling multiple database operations in a chattier way.\\n\\n\\nThese multiple pe\", \"rsistence operations are performed later in a single action when your code from the\\napplication laye\", \"r commands it. The decision about applying the in-memory changes to the actual\\ndatabase storage is t\", \"ypically based on the Unit of Work pattern. In EF, the Unit of Work pattern is\\n[implemented by a DbC\", \"ontext and is executed when a call is made to SaveChanges.](https://docs.microsoft.com/dotnet/api/mi\", \"crosoft.entityframeworkcore.dbcontext)\\n\\n\\nIn many cases, this pattern or way of applying operations a\", \"gainst the storage can increase application\\nperformance and reduce the possibility of inconsistencie\", \"s. It also reduces transaction blocking in the\\ndatabase tables, because all the intended operations \", \"are committed as part of one transaction. This is\\nmore efficient in comparison to executing many iso\", \"lated operations against the database. Therefore,\\nthe selected ORM can optimize the execution agains\", \"t the database by grouping several update\\nactions within the same transaction, as opposed to many sm\", \"all and separate transaction executions.\\n\\n\\nThe Unit of Work pattern can be implemented with or witho\", \"ut using the Repository pattern.\\n\\n\\n**Repositories shouldn\\u2019t be mandatory**\\n\\n\\nCustom repositories are\", \" useful for the reasons cited earlier, and that is the approach for the ordering\\nmicroservice in eSh\", \"opOnContainers. However, it isn\\u2019t an essential pattern to implement in a DDD\\ndesign or even in gener\", \"al .NET development.\\n\\n\\nFor instance, Jimmy Bogard, when providing direct feedback for this guide, sa\", \"id the following:\\n\\n\\nThis\\u2019ll probably be my biggest feedback. I\\u2019m really not a fan of repositories, m\", \"ainly because they hide\\nthe important details of the underlying persistence mechanism. It\\u2019s why I go\", \" for MediatR for\\ncommands, too. I can use the full power of the persistence layer, and push all that\", \" domain behavior\\ninto my aggregate roots. I don\\u2019t usually want to mock my repositories \\u2013 I still nee\", \"d to have that\\n\\n\\n242 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patt\", \"erns\\n\\n\\nintegration test with the real thing. Going CQRS meant that we didn\\u2019t really have a need for\\n\", \"repositories any more.\\n\\n\\nRepositories might be useful, but they are not critical for your DDD design\", \" in the way that the\\nAggregate pattern and a rich domain model are. Therefore, use the Repository pa\", \"ttern or not, as you\\nsee fit.\\n\\n#### **Additional resources**\\n\\n\\n**Repository pattern**\\n\\n\\n  - **Edward\", \" Hieatt and Rob Mee. Repository pattern.**\\n[https://martinfowler.com/eaaCatalog/repository.html](htt\", \"ps://martinfowler.com/eaaCatalog/repository.html)\\n\\n\\n  - **The Repository pattern**\\n[https://learn.mi\", \"crosoft.com/previous-versions/msp-n-p/ff649690(v=pandp.10)](https://docs.microsoft.com/previous-vers\", \"ions/msp-n-p/ff649690(v=pandp.10))\\n\\n\\n  - **Eric Evans. Domain-Driven Design: Tackling Complexity in \", \"the Heart of Software.** (Book;\\nincludes a discussion of the Repository pattern)\\n[https://www.amazon\", \".com/Domain-Driven-Design-Tackling-Complexity-](https://www.amazon.com/Domain-Driven-Design-Tackling\", \"-Complexity-Software/dp/0321125215/)\\n[Software/dp/0321125215/](https://www.amazon.com/Domain-Driven-\", \"Design-Tackling-Complexity-Software/dp/0321125215/)\\n\\n\\n**Unit of Work pattern**\\n\\n\\n  - **Martin Fowler\", \". Unit of Work pattern.**\\n[https://martinfowler.com/eaaCatalog/unitOfWork.html](https://martinfowler\", \".com/eaaCatalog/unitOfWork.html)\\n\\n\\n  - **Implementing the Repository and Unit of Work Patterns in an\", \" ASP.NET MVC**\\n**Application**\\n[https://learn.microsoft.com/aspnet/mvc/overview/older-versions/getti\", \"ng-started-with-ef-5-](https://docs.microsoft.com/aspnet/mvc/overview/older-versions/getting-started\", \"-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-appli\", \"cation)\\n[using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-](https\", \"://docs.microsoft.com/aspnet/mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/imple\", \"menting-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application)\\n[application](https:\", \"//docs.microsoft.com/aspnet/mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implem\", \"enting-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application)\\n\\n### Implement the in\", \"frastructure persistence layer with Entity Framework Core\\n\\n\\nWhen you use relational databases such a\", \"s SQL Server, Oracle, or PostgreSQL, a recommended\\napproach is to implement the persistence layer ba\", \"sed on Entity Framework (EF). EF supports LINQ and\\nprovides strongly typed objects for your model, a\", \"s well as simplified persistence into your database.\\n\\n\\nEntity Framework has a long history as part o\", \"f the .NET Framework. When you use .NET, you should\\nalso use Entity Framework Core, which runs on Wi\", \"ndows or Linux in the same way as .NET. EF Core is a\\ncomplete rewrite of Entity Framework that\\u2019s imp\", \"lemented with a much smaller footprint and\\nimportant improvements in performance.\\n\\n\\n243 CHAPTER 6 | \", \"Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n#### **Introduction to Ent\", \"ity Framework Core**\\n\\nEntity Framework (EF) Core is a lightweight, extensible, and cross-platform ve\", \"rsion of the popular\\nEntity Framework data access technology. It was introduced with .NET Core in mi\", \"d-2016.\\n\\n\\nSince an introduction to EF Core is already available in Microsoft documentation, here we \", \"simply\\nprovide links to that information.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Entity Framework Core**\", \"\\n[https://learn.microsoft.com/ef/core/](https://docs.microsoft.com/ef/core/)\\n\\n\\n  - **Getting started\", \" with ASP.NET Core and Entity Framework Core using Visual Studio**\\n[https://learn.microsoft.com/aspn\", \"et/core/data/ef-mvc/](https://docs.microsoft.com/aspnet/core/data/ef-mvc/)\\n\\n\\n  - **DbContext Class**\", \"\\n[https://learn.microsoft.com/dotnet/api/microsoft.entityframeworkcore.dbcontext](https://docs.micro\", \"soft.com/dotnet/api/microsoft.entityframeworkcore.dbcontext)\\n\\n\\n  - **Compare EF Core & EF6.x**\\n[http\", \"s://learn.microsoft.com/ef/efcore-and-ef6/index](https://docs.microsoft.com/ef/efcore-and-ef6/index)\", \"\\n\\n#### **Infrastructure in Entity Framework Core from a DDD perspective**\\n\\n\\nFrom a DDD point of view\", \", an important capability of EF is the ability to use POCO domain entities,\\nalso known in EF termino\", \"logy as POCO _code-first entities_ . If you use POCO domain entities, your\\n[domain model classes are\", \" persistence-ignorant, following the Persistence Ignorance and the](https://deviq.com/persistence-ig\", \"norance/)\\n[Infrastructure Ignorance](https://ayende.com/blog/3137/infrastructure-ignorance) principl\", \"es.\\n\\n\\nPer DDD patterns, you should encapsulate domain behavior and rules within the entity class its\", \"elf, so\\nit can control invariants, validations, and rules when accessing any collection. Therefore, \", \"it is not a\\ngood practice in DDD to allow public access to collections of child entities or value ob\", \"jects. Instead,\\nyou want to expose methods that control how and when your fields and property collec\", \"tions can be\\nupdated, and what behavior and actions should occur when that happens.\\n\\n\\nSince EF Core \", \"1.1, to satisfy those DDD requirements, you can have plain fields in your entities instead\\nof public\", \" properties. If you do not want an entity field to be externally accessible, you can just create\\nthe\", \" attribute or field instead of a property. You can also use private property setters.\\n\\n\\nIn a similar\", \" way, you can now have read-only access to collections by using a public property typed as\\nIReadOnly\", \"Collection<T>, which is backed by a private field member for the collection (like a List<T>)\\nin your\", \" entity that relies on EF for persistence. Previous versions of Entity Framework required\\ncollection\", \" properties to support ICollection<T>, which meant that any developer using the parent\\nentity class \", \"could add or remove items through its property collections. That possibility would be\\nagainst the re\", \"commended patterns in DDD.\\n\\n\\nYou can use a private collection while exposing a read-only IReadOnlyCo\", \"llection<T> object, as shown\\nin the following code example:\\n\\n\\n244 CHAPTER 6 | Tackle Business Comple\", \"xity in a Microservice with DDD and CQRS Patterns\\n\\n\\nThe OrderItems property can only be accessed as \", \"read-only using IReadOnlyCollection<OrderItem>.\\nThis type is read-only so it is protected against re\", \"gular external updates.\\n\\n\\nEF Core provides a way to map the domain model to the physical database wi\", \"thout \\u201ccontaminating\\u201d\\nthe domain model. It is pure .NET POCO code, because the mapping action is imp\", \"lemented in the\\npersistence layer. In that mapping action, you need to configure the fields-to-datab\", \"ase mapping. In\\nthe following example of the OnModelCreating method from OrderingContext and the\\nOrd\", \"erEntityTypeConfiguration class, the call to SetPropertyAccessMode tells EF Core to access the\\nOrder\", \"Items property through its field.\\n\\n\\n245 CHAPTER 6 | Tackle Business Complexity in a Microservice wit\", \"h DDD and CQRS Patterns\\n\\n\\nWhen you use fields instead of properties, the OrderItem entity is persist\", \"ed as if it had a\\nList<OrderItem> property. However, it exposes a single accessor, the AddOrderItem \", \"method, for\\nadding new items to the order. As a result, behavior and data are tied together and will\", \" be consistent\\nthroughout any application code that uses the domain model.\\n\\n#### **Implement custom \", \"repositories with Entity Framework Core**\\n\\n\\nAt the implementation level, a repository is simply a cl\", \"ass with data persistence code coordinated by a\\nunit of work (DBContext in EF Core) when performing \", \"updates, as shown in the following class:\\n\\n\\nThe IBuyerRepository interface comes from the domain mod\", \"el layer as a contract. However, the\\nrepository implementation is done at the persistence and infras\", \"tructure layer.\\n\\n\\nThe EF DbContext comes through the constructor through Dependency Injection. It is\", \" shared between\\nmultiple repositories within the same HTTP request scope, thanks to its default life\", \"time\\n(ServiceLifetime.Scoped) in the IoC container (which can also be explicitly set with\\nservices.A\", \"ddDbContext<>).\\n\\n\\n246 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Pat\", \"terns\\n\\n\\n**Methods to implement in a repository (updates or transactions versus queries)**\\n\\n\\nWithin e\", \"ach repository class, you should put the persistence methods that update the state of entities\\nconta\", \"ined by its related aggregate. Remember there is one-to-one relationship between an aggregate\\nand it\", \"s related repository. Consider that an aggregate root entity object might have embedded child\\nentiti\", \"es within its EF graph. For example, a buyer might have multiple payment methods as related\\nchild en\", \"tities.\\n\\n\\nSince the approach for the ordering microservice in eShopOnContainers is also based on CQS\", \"/CQRS,\\nmost of the queries are not implemented in custom repositories. Developers have the freedom t\", \"o\\ncreate the queries and joins they need for the presentation layer without the restrictions imposed\", \" by\\naggregates, custom repositories per aggregate, and DDD in general. Most of the custom repositori\", \"es\\nsuggested by this guide have several update or transactional methods but just the query methods\\nn\", \"eeded to get data to be updated. For example, the BuyerRepository repository implements a\\nFindAsync \", \"method, because the application needs to know whether a particular buyer exists before\\ncreating a ne\", \"w buyer related to the order.\\n\\n\\nHowever, the real query methods to get data to send to the presentat\", \"ion layer or client apps are\\nimplemented, as mentioned, in the CQRS queries based on flexible querie\", \"s using Dapper.\\n\\n\\n**Using a custom repository versus using EF DbContext directly**\\n\\n\\nThe Entity Fram\", \"ework DbContext class is based on the Unit of Work and Repository patterns and can\\nbe used directly \", \"from your code, such as from an ASP.NET Core MVC controller. The Unit of Work and\\nRepository pattern\", \"s result in the simplest code, as in the CRUD catalog microservice in\\neShopOnContainers. In cases wh\", \"ere you want the simplest code possible, you might want to directly\\nuse the DbContext class, as many\", \" developers do.\\n\\n\\nHowever, implementing custom repositories provides several benefits when implement\", \"ing more\\ncomplex microservices or applications. The Unit of Work and Repository patterns are intende\", \"d to\\nencapsulate the infrastructure persistence layer so it is decoupled from the application and do\", \"mainmodel layers. Implementing these patterns can facilitate the use of mock repositories simulating\", \"\\naccess to the database.\\n\\n\\nIn Figure 7-18, you can see the differences between not using repositorie\", \"s (directly using the EF\\nDbContext) versus using repositories, which makes it easier to mock those r\", \"epositories.\\n\\n\\n247 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patter\", \"ns\\n\\n\\n_Figure 7-18. Using custom repositories versus a plain DbContext_\\n\\n\\nFigure 7-18 shows that usin\", \"g a custom repository adds an abstraction layer that can be used to ease\\ntesting by mocking the repo\", \"sitory. There are multiple alternatives when mocking. You could mock just\\nrepositories or you could \", \"mock a whole unit of work. Usually mocking just the repositories is enough,\\nand the complexity to ab\", \"stract and mock a whole unit of work is usually not needed.\\n\\n\\nLater, when we focus on the applicatio\", \"n layer, you will see how Dependency Injection works in\\nASP.NET Core and how it is implemented when \", \"using repositories.\\n\\n\\nIn short, custom repositories allow you to test code more easily with unit tes\", \"ts that are not impacted\\nby the data tier state. If you run tests that also access the actual databa\", \"se through the Entity\\nFramework, they are not unit tests but integration tests, which are a lot slow\", \"er.\\n\\n\\nIf you were using DbContext directly, you would have to mock it or to run unit tests by using \", \"an inmemory SQL Server with predictable data for unit tests. But mocking the DbContext or controllin\", \"g\\nfake data requires more work than mocking at the repository level. Of course, you could always tes\", \"t\\nthe MVC controllers.\\n\\n#### **EF DbContext and IUnitOfWork instance lifetime in your IoC container*\", \"*\\n\\n\\nThe DbContext object (exposed as an IUnitOfWork object) should be shared among multiple\\nreposito\", \"ries within the same HTTP request scope. For example, this is true when the operation being\\nexecuted\", \" must deal with multiple aggregates, or simply because you are using multiple repository\\ninstances. \", \"It is also important to mention that the IUnitOfWork interface is part of your domain layer,\\nnot an \", \"EF Core type.\\n\\n\\nIn order to do that, the instance of the DbContext object has to have its service li\", \"fetime set to\\nServiceLifetime.Scoped. This is the default lifetime when registering a DbContext with\", \"\\nbuilder.Services.AddDbContext in your IoC container from the _Program.cs_ file in your ASP.NET Core\", \"\\nWeb API project. The following code illustrates this.\\n\\n\\n248 CHAPTER 6 | Tackle Business Complexity \", \"in a Microservice with DDD and CQRS Patterns\\n\\n\\nThe DbContext instantiation mode should not be config\", \"ured as ServiceLifetime.Transient or\\nServiceLifetime.Singleton.\\n\\n#### **The repository instance life\", \"time in your IoC container**\\n\\n\\nIn a similar way, repository\\u2019s lifetime should usually be set as scop\", \"ed (InstancePerLifetimeScope in\\nAutofac). It could also be transient (InstancePerDependency in Autof\", \"ac), but your service will be more\\nefficient in regards to memory when using the scoped lifetime.\\n\\n\\n\", \"Using the singleton lifetime for the repository could cause you serious concurrency problems when\\nyo\", \"ur DbContext is set to scoped (InstancePerLifetimeScope) lifetime (the default lifetimes for a\\nDBCon\", \"text). As long as your service lifetimes for your repositories and your DbContext are both\\nScoped, y\", \"ou\\u2019ll avoid these issues.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Implementing the Repository and Unit of\", \" Work Patterns in an ASP.NET MVC**\\n**Application**\\n[https://www.asp.net/mvc/overview/older-versions/\", \"getting-started-with-ef-5-using-mvc-](https://www.asp.net/mvc/overview/older-versions/getting-starte\", \"d-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-appl\", \"ication)\\n[4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application](htt\", \"ps://www.asp.net/mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-\", \"repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application)\\n\\n\\n  - **Jonathan Allen. Implemen\", \"tation Strategies for the Repository Pattern with Entity**\\n**Framework, Dapper, and Chain**\\n[https:/\", \"/www.infoq.com/articles/repository-implementation-strategies](https://www.infoq.com/articles/reposit\", \"ory-implementation-strategies)\\n\\n\\n  - **Cesar de la Torre. Comparing ASP.NET Core IoC container servi\", \"ce lifetimes with Autofac**\\n**IoC container instance scopes**\\n[https://devblogs.microsoft.com/cesard\", \"elatorre/comparing-asp-net-core-ioc-service-life-](https://devblogs.microsoft.com/cesardelatorre/com\", \"paring-asp-net-core-ioc-service-life-times-and-autofac-ioc-instance-scopes/)\\n[times-and-autofac-ioc-\", \"instance-scopes/](https://devblogs.microsoft.com/cesardelatorre/comparing-asp-net-core-ioc-service-l\", \"ife-times-and-autofac-ioc-instance-scopes/)\\n\\n\\n249 CHAPTER 6 | Tackle Business Complexity in a Micros\", \"ervice with DDD and CQRS Patterns\\n\\n\\n#### **Table mapping**\\n\\nTable mapping identifies the table data \", \"to be queried from and saved to the database. Previously you\\nsaw how domain entities (for example, a\", \" product or order domain) can be used to generate a related\\ndatabase schema. EF is strongly designed\", \" around the concept of _conventions_ . Conventions address\\nquestions like \\u201cWhat will the name of a t\", \"able be?\\u201d or \\u201cWhat property is the primary key?\\u201d Conventions\\nare typically based on conventional nam\", \"es. For example, it is typical for the primary key to be a\\nproperty that ends with Id.\\n\\n\\nBy conventi\", \"on, each entity will be set up to map to a table with the same name as the DbSet<TEntity>\\nproperty t\", \"hat exposes the entity on the derived context. If no DbSet<TEntity> value is provided for\\nthe given \", \"entity, the class name is used.\\n\\n\\n**Data Annotations versus Fluent API**\\n\\n\\nThere are many additional\", \" EF Core conventions, and most of them can be changed by using either\\ndata annotations or Fluent API\", \", implemented within the OnModelCreating method.\\n\\n\\nData annotations must be used on the entity model\", \" classes themselves, which is a more intrusive way\\nfrom a DDD point of view. This is because you are\", \" contaminating your model with data annotations\\nrelated to the infrastructure database. On the other\", \" hand, Fluent API is a convenient way to change\\nmost conventions and mappings within your data persi\", \"stence infrastructure layer, so the entity model\\nwill be clean and decoupled from the persistence in\", \"frastructure.\\n\\n\\n**Fluent API and the OnModelCreating method**\\n\\n\\nAs mentioned, in order to change con\", \"ventions and mappings, you can use the OnModelCreating\\nmethod in the DbContext class.\\n\\n\\nThe ordering\", \" microservice in eShopOnContainers implements explicit mapping and configuration,\\nwhen needed, as sh\", \"own in the following code.\\n\\n\\n250 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD a\", \"nd CQRS Patterns\\n\\n\\nYou could set all the Fluent API mappings within the same OnModelCreating method,\", \" but it\\u2019s\\nadvisable to partition that code and have multiple configuration classes, one per entity, \", \"as shown in\\n\\n\\n251 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Pattern\", \"s\\n\\n\\nthe example. Especially for large models, it is advisable to have separate configuration classes\", \" for\\nconfiguring different entity types.\\n\\n\\nThe code in the example shows a few explicit declarations\", \" and mapping. However, EF Core\\nconventions do many of those mappings automatically, so the actual co\", \"de you would need in your\\ncase might be smaller.\\n\\n\\n**The Hi/Lo algorithm in EF Core**\\n\\n\\n[An interest\", \"ing aspect of code in the preceding example is that it uses the Hi/Lo algorithm as the key](https://\", \"vladmihalcea.com/the-hilo-algorithm/)\\ngeneration strategy.\\n\\n\\nThe Hi/Lo algorithm is useful when you \", \"need unique keys before committing changes. As a summary,\\nthe Hi-Lo algorithm assigns unique identif\", \"iers to table rows while not depending on storing the row in\\nthe database immediately. This lets you\", \" start using the identifiers right away, as happens with regular\\nsequential database IDs.\\n\\n\\nThe Hi/L\", \"o algorithm describes a mechanism for getting a batch of unique IDs from a related database\\nsequence\", \". These IDs are safe to use because the database guarantees the uniqueness, so there will be\\nno coll\", \"isions between users. This algorithm is interesting for these reasons:\\n\\n\\n  - It does not break the U\", \"nit of Work pattern.\\n\\n\\n  - It gets sequence IDs in batches, to minimize round trips to the database.\", \"\\n\\n\\n  - It generates a human readable identifier, unlike techniques that use GUIDs.\\n\\n\\n[EF Core suppor\", \"ts HiLo](https://stackoverflow.com/questions/282099/whats-the-hi-lo-algorithm) with the UseHiLo meth\", \"od, as shown in the preceding example.\\n\\n\\n**Map fields instead of properties**\\n\\n\\nWith this feature, a\", \"vailable since EF Core 1.1, you can directly map columns to fields. It is possible to\\nnot use proper\", \"ties in the entity class, and just to map columns from a table to fields. A common use\\nfor that woul\", \"d be private fields for any internal state that do not need to be accessed from outside the\\nentity.\\n\", \"\\n\\nYou can do this with single fields or also with collections, like a List<> field. This point was m\", \"entioned\\nearlier when we discussed modeling the domain model classes, but here you can see how that\\n\", \"mapping is performed with the PropertyAccessMode.Field configuration highlighted in the previous\\ncod\", \"e.\\n\\n\\n**Use shadow properties in EF Core, hidden at the infrastructure level**\\n\\n\\nShadow properties in\", \" EF Core are properties that do not exist in your entity class model. The values\\n[and states of thes\", \"e properties are maintained purely in the ChangeTracker](https://docs.microsoft.com/ef/core/api/micr\", \"osoft.entityframeworkcore.changetracking.changetracker) class at the infrastructure\\nlevel.\\n\\n\\n252 CHA\", \"PTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n#### **Implement \", \"the Query Specification pattern**\\n\\nAs introduced earlier in the design section, the Query Specificat\", \"ion pattern is a Domain-Driven Design\\npattern designed as the place where you can put the definition\", \" of a query with optional sorting and\\npaging logic.\\n\\n\\nThe Query Specification pattern defines a quer\", \"y in an object. For example, in order to encapsulate a\\npaged query that searches for some products y\", \"ou can create a PagedProduct specification that takes\\nthe necessary input parameters (pageNumber, pa\", \"geSize, filter, etc.). Then, within any Repository\\nmethod (usually a List() overload) it would accep\", \"t an IQuerySpecification and run the expected query\\nbased on that specification.\\n\\n\\nAn example of a g\", \"eneric Specification interface is the following code, which is similar to code used in\\n[the eShopOnW\", \"eb](https://github.com/dotnet-architecture/eShopOnWeb) reference application.\\n\\n\\nThen, the implementa\", \"tion of a generic specification base class is the following.\\n\\n\\n253 CHAPTER 6 | Tackle Business Compl\", \"exity in a Microservice with DDD and CQRS Patterns\\n\\n\\nThe following specification loads a single bask\", \"et entity given either the basket\\u2019s ID or the ID of the\\n[buyer to whom the basket belongs. It will e\", \"agerly load](https://docs.microsoft.com/ef/core/querying/related-data) the basket\\u2019s Items collection\", \".\\n\\n\\nAnd finally, you can see below how a generic EF Repository can use such a specification to filte\", \"r and\\neager-load data related to a given entity type T.\\n\\n\\nIn addition to encapsulating filtering log\", \"ic, the specification can specify the shape of the data to be\\nreturned, including which properties t\", \"o populate.\\n\\n\\nAlthough we don\\u2019t recommend returning IQueryable from a repository, it\\u2019s perfectly fin\", \"e to use them\\nwithin the repository to build up a set of results. You can see this approach used in \", \"the List method\\nabove, which uses intermediate IQueryable expressions to build up the query\\u2019s list o\", \"f includes before\\nexecuting the query with the specification\\u2019s criteria on the last line.\\n\\n\\n[Learn h\", \"ow the specification pattern is applied in the eShopOnWeb sample.](https://github.com/dotnet-archite\", \"cture/eShopOnWeb/wiki/Patterns#specification)\\n\\n\\n254 CHAPTER 6 | Tackle Business Complexity in a Micr\", \"oservice with DDD and CQRS Patterns\\n\\n\\n**Additional resources**\\n\\n\\n  - **Table Mapping**\\n[https://lear\", \"n.microsoft.com/ef/core/modeling/relational/tables](https://docs.microsoft.com/ef/core/modeling/rela\", \"tional/tables)\\n\\n\\n  - **Use HiLo to generate keys with Entity Framework Core**\\n[https://www.talkingdo\", \"tnet.com/use-hilo-to-generate-keys-with-entity-framework-core/](https://www.talkingdotnet.com/use-hi\", \"lo-to-generate-keys-with-entity-framework-core/)\\n\\n\\n  - **Backing Fields**\\n[https://learn.microsoft.c\", \"om/ef/core/modeling/backing-field](https://docs.microsoft.com/ef/core/modeling/backing-field)\\n\\n\\n  - \", \"**Steve Smith. Encapsulated Collections in Entity Framework Core**\\n[https://ardalis.com/encapsulated\", \"-collections-in-entity-framework-core](https://ardalis.com/encapsulated-collections-in-entity-framew\", \"ork-core)\\n\\n\\n  - **Shadow Properties**\\n[https://learn.microsoft.com/ef/core/modeling/shadow-propertie\", \"s](https://docs.microsoft.com/ef/core/modeling/shadow-properties)\\n\\n\\n  - **The Specification pattern*\", \"*\\n[https://deviq.com/specification-pattern/](https://deviq.com/specification-pattern/)\\n\\n\\n**Ardalis.S\", \"pecification NuGet Package** Used by\\n[eShopOnWeb. https://www.nuget.org/packages/Ardalis.Specificati\", \"on](https://www.nuget.org/packages/Ardalis.Specification)\\n\\n### Use NoSQL databases as a persistence \", \"infrastructure\\n\\n\\nWhen you use NoSQL databases for your infrastructure data tier, you typically do no\", \"t use an ORM like\\nEntity Framework Core. Instead you use the API provided by the NoSQL engine, such \", \"as Azure Cosmos\\nDB, MongoDB, Cassandra, RavenDB, CouchDB, or Azure Storage Tables.\\n\\n\\nHowever, when y\", \"ou use a NoSQL database, especially a document-oriented database like Azure\\nCosmos DB, CouchDB, or R\", \"avenDB, the way you design your model with DDD aggregates is partially\\nsimilar to how you can do it \", \"in EF Core, in regards to the identification of aggregate roots, child entity\\nclasses, and value obj\", \"ect classes. But, ultimately, the database selection will impact in your design.\\n\\n\\nWhen you use a do\", \"cument-oriented database, you implement an aggregate as a single document,\\nserialized in JSON or ano\", \"ther format. However, the use of the database is transparent from a domain\\nmodel code point of view.\", \" When using a NoSQL database, you still are using entity classes and\\naggregate root classes, but wit\", \"h more flexibility than when using EF Core because the persistence is\\nnot relational.\\n\\n\\nThe differen\", \"ce is in how you persist that model. If you implemented your domain model based on\\nPOCO entity class\", \"es, agnostic to the infrastructure persistence, it might look like you could move to a\\ndifferent per\", \"sistence infrastructure, even from relational to NoSQL. However, that should not be your\\ngoal. There\", \" are always constraints and trade-offs in the different database technologies, so you will\\nnot be ab\", \"le to have the same model for relational or NoSQL databases. Changing persistence models\\nis not a tr\", \"ivial task, because transactions and persistence operations will be very different.\\n\\n\\nFor example, i\", \"n a document-oriented database, it is okay for an aggregate root to have multiple child\\ncollection p\", \"roperties. In a relational database, querying multiple child collection properties is not\\n\\n\\n255 CHAP\", \"TER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\neasily optimized, \", \"because you get a UNION ALL SQL statement back from EF. Having the same\\ndomain model for relational \", \"databases or NoSQL databases is not simple, and you should not try to\\ndo it. You really have to desi\", \"gn your model with an understanding of how the data is going to be\\nused in each particular database.\", \"\\n\\n\\nA benefit when using NoSQL databases is that the entities are more denormalized, so you do not se\", \"t a\\ntable mapping. Your domain model can be more flexible than when using a relational database.\\n\\n\\nW\", \"hen you design your domain model based on aggregates, moving to NoSQL and documentoriented databases\", \" might be even easier than using a relational database, because the aggregates\\nyou design are simila\", \"r to serialized documents in a document-oriented database. Then you can\\ninclude in those \\u201cbags\\u201d all \", \"the information you might need for that aggregate.\\n\\n\\nFor instance, the following JSON code is a samp\", \"le implementation of an order aggregate when using\\na document-oriented database. It is similar to th\", \"e order aggregate we implemented in the\\neShopOnContainers sample, but without using EF Core undernea\", \"th.\\n\\n#### **Introduction to Azure Cosmos DB and the native Cosmos DB API**\\n\\n\\n[Azure Cosmos DB](https\", \"://docs.microsoft.com/azure/cosmos-db/introduction) is Microsoft\\u2019s globally distributed database ser\", \"vice for mission-critical applications.\\n[Azure Cosmos DB provides turn-key global distribution,](htt\", \"ps://docs.microsoft.com/azure/cosmos-db/distribute-data-globally) [elastic scaling of throughput and\", \" storage](https://docs.microsoft.com/azure/cosmos-db/partition-data)\\n[worldwide, single-digit millis\", \"econd latencies at the 99th percentile, five well-defined consistency](https://docs.microsoft.com/az\", \"ure/cosmos-db/consistency-levels)\\n[levels, and guaranteed high availability, all backed by industry-\", \"leading SLAs. Azure Cosmos DB](https://docs.microsoft.com/azure/cosmos-db/consistency-levels)\\n[autom\", \"atically indexes data without requiring you to deal with schema and index management. It is](https:/\", \"/www.vldb.org/pvldb/vol8/p1668-shukla.pdf)\\nmulti-model and supports document, key-value, graph, and \", \"columnar data models.\\n\\n\\n256 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQ\", \"RS Patterns\\n\\n\\n_Figure 7-19. Azure Cosmos DB global distribution_\\n\\n\\nWhen you use a C# model to implem\", \"ent the aggregate to be used by the Azure Cosmos DB API, the\\naggregate can be similar to the C# POCO\", \" classes used with EF Core. The difference is in the way to\\nuse them from the application and infras\", \"tructure layers, as in the following code:\\n\\n\\n257 CHAPTER 6 | Tackle Business Complexity in a Microse\", \"rvice with DDD and CQRS Patterns\\n\\n\\nYou can see that the way you work with your domain model can be s\", \"imilar to the way you use it in\\nyour domain model layer when the infrastructure is EF. You still use\", \" the same aggregate root methods\\nto ensure consistency, invariants, and validations within the aggre\", \"gate.\\n\\n\\nHowever, when you persist your model into the NoSQL database, the code and API change\\ndramat\", \"ically compared to EF Core code or any other code related to relational databases.\\n\\n#### **Implement\", \" .NET code targeting MongoDB and Azure Cosmos DB**\\n\\n\\n**Use Azure Cosmos DB from .NET containers**\\n\\n\\n\", \"You can access Azure Cosmos DB databases from .NET code running in containers, like from any other\\n.\", \"NET application. For instance, the Locations.API and Marketing.API microservices in\\neShopOnContainer\", \"s are implemented so they can consume Azure Cosmos DB databases.\\n\\n\\nHowever, there\\u2019s a limitation in \", \"Azure Cosmos DB from a Docker development environment point of\\n[view. Even though there\\u2019s an on-prem\", \"ises Azure Cosmos DB Emulator](https://docs.microsoft.com/azure/cosmos-db/local-emulator) that can r\", \"un in a local\\ndevelopment machine, it only supports Windows. Linux and macOS aren\\u2019t supported.\\n\\n\\nThe\", \"re\\u2019s also the possibility to run this emulator on Docker, but just on Windows Containers, not with\\nL\", \"inux Containers. That\\u2019s an initial handicap for the development environment if your application is\\nd\", \"eployed as Linux containers, since, currently, you can\\u2019t deploy Linux and Windows Containers on\\nDock\", \"er for Windows at the same time. Either all containers being deployed have to be for Linux or for\\nWi\", \"ndows.\\n\\n\\nThe ideal and more straightforward deployment for a dev/test solution is to be able to depl\", \"oy your\\ndatabase systems as containers along with your custom containers so your dev/test environmen\", \"ts are\\nalways consistent.\\n\\n\\n258 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD an\", \"d CQRS Patterns\\n\\n\\n**Use MongoDB API for local dev/test Linux/Windows containers plus Azure Cosmos**\\n\", \"**DB**\\n\\n\\nCosmos DB databases support MongoDB API for .NET as well as the native MongoDB wire protoco\", \"l.\\nThis means that by using existing drivers, your application written for MongoDB can now\\ncommunica\", \"te with Cosmos DB and use Cosmos DB databases instead of MongoDB databases, as\\nshown in Figure 7-20.\", \"\\n\\n\\n_Figure 7-20. Using MongoDB API and protocol to access Azure Cosmos DB_\\n\\n\\nThis is a very convenie\", \"nt approach for proof of concepts in Docker environments with Linux\\n[containers because the MongoDB \", \"Docker image is a multi-arch image that supports Docker Linux](https://hub.docker.com/r/_/mongo/)\\nco\", \"ntainers and Docker Windows containers.\\n\\n\\nAs shown in the following image, by using the MongoDB API,\", \" eShopOnContainers supports MongoDB\\nLinux and Windows containers for the local development environme\", \"nt but then, you can move to a\\n[scalable, PaaS cloud solution as Azure Cosmos DB by simply changing \", \"the MongoDB connection](https://docs.microsoft.com/azure/cosmos-db/connect-mongodb-account)\\n[string \", \"to point to Azure Cosmos DB.](https://docs.microsoft.com/azure/cosmos-db/connect-mongodb-account)\\n\\n\\n\", \"259 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n_Figure 7-\", \"21. eShopOnContainers using MongoDB containers for dev-env or Azure Cosmos DB for production_\\n\\n\\nThe \", \"production Azure Cosmos DB would be running in Azure\\u2019s cloud as a PaaS and scalable service.\\n\\n\\nYour \", \"custom .NET containers can run on a local development Docker host (that is using Docker for\\nWindows \", \"in a Windows 10 machine) or be deployed into a production environment, like Kubernetes in\\nAzure AKS \", \"or Azure Service Fabric. In this second environment, you would deploy only the .NET\\ncustom container\", \"s but not the MongoDB container since you\\u2019d be using Azure Cosmos DB in the\\ncloud for handling the d\", \"ata in production.\\n\\n\\nA clear benefit of using the MongoDB API is that your solution could run in bot\", \"h database engines,\\nMongoDB or Azure Cosmos DB, so migrations to different environments should be ea\", \"sy. However,\\nsometimes it is worthwhile to use a native API (that is the native Cosmos DB API) in or\", \"der to take full\\nadvantage of the capabilities of a specific database engine.\\n\\n\\nFor further comparis\", \"on between simply using MongoDB versus Cosmos DB in the cloud, see the\\n[Benefits of using Azure Cosm\", \"os DB in this page.](https://docs.microsoft.com/azure/cosmos-db/mongodb-introduction)\\n\\n\\n**Analyze yo\", \"ur approach for production applications: MongoDB API vs. Cosmos DB**\\n**API**\\n\\n\\nIn eShopOnContainers,\", \" we\\u2019re using MongoDB API because our priority was fundamentally to have a\\nconsistent dev/test enviro\", \"nment using a NoSQL database that could also work with Azure Cosmos DB.\\n\\n\\n260 CHAPTER 6 | Tackle Bus\", \"iness Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nHowever, if you are planning to use \", \"MongoDB API to access Azure Cosmos DB in Azure for\\nproduction applications, you should analyze the d\", \"ifferences in capabilities and performance when\\nusing MongoDB API to access Azure Cosmos DB database\", \"s compared to using the native Azure\\nCosmos DB API. If it is similar you can use MongoDB API and you\", \" get the benefit of supporting two\\nNoSQL database engines at the same time.\\n\\n\\nYou could also use Mon\", \"goDB clusters as the production database in Azure\\u2019s cloud, too, with\\n[MongoDB Azure Service. But tha\", \"t is not a PaaS service provided by Microsoft. In this case, Azure is just](https://www.mongodb.com/\", \"scale/mongodb-azure-service)\\nhosting that solution coming from MongoDB.\\n\\n\\nBasically, this is just a \", \"disclaimer stating that you shouldn\\u2019t always use MongoDB API against Azure\\nCosmos DB, as we did in e\", \"ShopOnContainers because it was a convenient choice for Linux containers.\\nThe decision should be bas\", \"ed on the specific needs and tests you need to do for your production\\napplication.\\n\\n\\n**The code: Use\", \" MongoDB API in .NET applications**\\n\\n\\nMongoDB API for .NET is based on NuGet packages that you need \", \"to add to your projects, like in the\\nLocations.API project shown in the following figure.\\n\\n\\n261 CHAP\", \"TER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n_Figure 7-22. Mong\", \"oDB API NuGet packages references in a .NET project_\\n\\n\\nLet\\u2019s investigate the code in the following s\", \"ections.\\n\\n\\n**A Model used by MongoDB API**\\n\\n\\nFirst, you need to define a model that will hold the da\", \"ta coming from the database in your\\napplication\\u2019s memory space. Here\\u2019s an example of the model used \", \"for Locations at\\neShopOnContainers.\\n\\n\\n262 CHAPTER 6 | Tackle Business Complexity in a Microservice w\", \"ith DDD and CQRS Patterns\\n\\n\\nYou can see there are a few attributes and types coming from the MongoDB\", \" NuGet packages.\\n\\n\\nNoSQL databases are usually very well suited for working with non-relational hier\", \"archical data. In this\\nexample, we are using MongoDB types especially made for geo-locations, like\\nG\", \"eoJson2DGeographicCoordinates.\\n\\n\\n**Retrieve the database and the collection**\\n\\n\\nIn eShopOnContainers\", \", we have created a custom database context where we implement the code to\\nretrieve the database and\", \" the MongoCollections, as in the following code.\\n\\n\\n263 CHAPTER 6 | Tackle Business Complexity in a M\", \"icroservice with DDD and CQRS Patterns\\n\\n\\n**Retrieve the data**\\n\\n\\nIn C# code, like Web API controller\", \"s or custom Repositories implementation, you can write similar\\ncode to the following when querying t\", \"hrough the MongoDB API. Note that the _context object is an\\ninstance of the previous LocationsContex\", \"t class.\\n\\n\\n**Use an env-var in the docker-compose.override.yml file for the MongoDB connection**\\n**s\", \"tring**\\n\\n\\nWhen creating a MongoClient object, it needs a fundamental parameter which is precisely th\", \"e\\nConnectionString parameter pointing to the right database. In the case of eShopOnContainers, the\\nc\", \"onnection string can point to a local MongoDB Docker container or to a \\u201cproduction\\u201d Azure Cosmos\\nDB \", \"database. That connection string comes from the environment variables defined in the dockercompose.o\", \"verride.yml files used when deploying with docker-compose or Visual Studio, as in the\\nfollowing yml \", \"code.\\n\\n\\nThe ConnectionString environment variable is resolved this way: If the ESHOP_AZURE_COSMOSDB\\n\", \"global variable is defined in the .env file with the Azure Cosmos DB connection string, it will use \", \"it to\\naccess the Azure Cosmos DB database in the cloud. If it\\u2019s not defined, it will take the\\nmongod\", \"b://nosqldata value and use the development MongoDB container.\\n\\n\\nThe following code shows the .env f\", \"ile with the Azure Cosmos DB connection string global\\nenvironment variable, as implemented in eShopO\", \"nContainers:\\n\\n\\n264 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patter\", \"ns\\n\\n\\nUncomment the ESHOP_AZURE_COSMOSDB line and update it with your Azure Cosmos DB\\n[connection str\", \"ing obtained from the Azure portal as explained in Connect a MongoDB application to](https://docs.mi\", \"crosoft.com/azure/cosmos-db/connect-mongodb-account)\\n[Azure Cosmos DB.](https://docs.microsoft.com/a\", \"zure/cosmos-db/connect-mongodb-account)\\n\\n\\nIf the ESHOP_AZURE_COSMOSDB global variable is empty, mean\", \"ing it\\u2019s commented out in the .env\\nfile, then the container uses a default MongoDB connection string\", \". This connection string points to\\nthe local MongoDB container deployed in eShopOnContainers that is\", \" named nosqldata and was\\ndefined at the docker-compose file, as shown in the following .yml code:\\n\\n\\n\", \"**Additional resources**\\n\\n\\n  - **Modeling document data for NoSQL databases**\\n[https://learn.microso\", \"ft.com/azure/cosmos-db/modeling-data](https://docs.microsoft.com/azure/cosmos-db/modeling-data)\\n\\n\\n  \", \"- **Vaughn Vernon. The Ideal Domain-Driven Design Aggregate Store?**\\n[https://kalele.io/blog-posts/t\", \"he-ideal-domain-driven-design-aggregate-store/](https://kalele.io/blog-posts/the-ideal-domain-driven\", \"-design-aggregate-store/)\\n\\n\\n  - **Introduction to Azure Cosmos DB: API for MongoDB**\\n[https://learn.\", \"microsoft.com/azure/cosmos-db/mongodb-introduction](https://docs.microsoft.com/azure/cosmos-db/mongo\", \"db-introduction)\\n\\n\\n  - **Azure Cosmos DB: Build a MongoDB API web app with .NET and the Azure portal\", \"**\\n[https://learn.microsoft.com/azure/cosmos-db/create-mongodb-dotnet](https://docs.microsoft.com/az\", \"ure/cosmos-db/create-mongodb-dotnet)\\n\\n\\n  - **Use the Azure Cosmos DB Emulator for local development \", \"and testing**\\n[https://learn.microsoft.com/azure/cosmos-db/local-emulator](https://docs.microsoft.co\", \"m/azure/cosmos-db/local-emulator)\\n\\n\\n  - **Connect a MongoDB application to Azure Cosmos DB**\\n[https:\", \"//learn.microsoft.com/azure/cosmos-db/connect-mongodb-account](https://docs.microsoft.com/azure/cosm\", \"os-db/connect-mongodb-account)\\n\\n\\n  - **The Cosmos DB Emulator Docker image (Windows Container)**\\n[ht\", \"tps://hub.docker.com/r/microsoft/azure-cosmosdb-emulator/](https://hub.docker.com/r/microsoft/azure-\", \"cosmosdb-emulator/)\\n\\n\\n  - **The MongoDB Docker image (Linux and Windows Container)**\\n[https://hub.do\", \"cker.com/_/mongo/](https://hub.docker.com/_/mongo/)\\n\\n\\n  - **Use MongoChef (Studio 3T) with an Azure \", \"Cosmos DB: API for MongoDB account**\\n[https://learn.microsoft.com/azure/cosmos-db/mongodb-mongochef]\", \"(https://docs.microsoft.com/azure/cosmos-db/mongodb-mongochef)\\n\\n\\n265 CHAPTER 6 | Tackle Business Com\", \"plexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n### Design the microservice application layer\", \" and Web API\\n\\n#### **Use SOLID principles and Dependency Injection**\\n\\nSOLID principles are critical \", \"techniques to be used in any modern and mission-critical application,\\nsuch as developing a microserv\", \"ice with DDD patterns. SOLID is an acronym that groups five\\nfundamental principles:\\n\\n\\n  - Single Res\", \"ponsibility principle\\n\\n\\n  - Open/closed principle\\n\\n\\n  - Liskov substitution principle\\n\\n\\n  - Interfac\", \"e Segregation principle\\n\\n\\n  - Dependency Inversion principle\\n\\n\\nSOLID is more about how you design yo\", \"ur application or microservice internal layers and about\\ndecoupling dependencies between them. It is\", \" not related to the domain, but to the application\\u2019s\\ntechnical design. The final principle, the Depe\", \"ndency Inversion principle, allows you to decouple the\\ninfrastructure layer from the rest of the lay\", \"ers, which allows a better decoupled implementation of the\\nDDD layers.\\n\\n\\nDependency Injection (DI) i\", \"s one way to implement the Dependency Inversion principle. It is a\\ntechnique for achieving loose cou\", \"pling between objects and their dependencies. Rather than directly\\ninstantiating collaborators, or u\", \"sing static references (that is, using new\\u2026), the objects that a class\\nneeds in order to perform its\", \" actions are provided to (or \\u201cinjected into\\u201d) the class. Most often, classes\\nwill declare their depe\", \"ndencies via their constructor, allowing them to follow the Explicit\\nDependencies principle. Depende\", \"ncy Injection is usually based on specific Inversion of Control (IoC)\\ncontainers. ASP.NET Core provi\", \"des a simple built-in IoC container, but you can also use your favorite\\nIoC container, like Autofac \", \"or Ninject.\\n\\n\\nBy following the SOLID principles, your classes will tend naturally to be small, well-\", \"factored, and easily\\ntested. But how can you know if too many dependencies are being injected into y\", \"our classes? If you\\nuse DI through the constructor, it will be easy to detect that by just looking a\", \"t the number of\\n[parameters for your constructor. If there are too many dependencies, this is genera\", \"lly a sign (a code](https://deviq.com/code-smells/)\\n[smell) that your class is trying to do too much\", \", and is probably violating the Single Responsibility](https://deviq.com/code-smells/)\\nprinciple.\\n\\n\\n\", \"It would take another guide to cover SOLID in detail. Therefore, this guide requires you to have onl\", \"y a\\nminimum knowledge of these topics.\\n\\n\\n**Additional resources**\\n\\n\\n  - **SOLID: Fundamental OOP Pri\", \"nciples**\\n[https://deviq.com/solid/](https://deviq.com/solid/)\\n\\n\\n266 CHAPTER 6 | Tackle Business Com\", \"plexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n  - **Inversion of Control Containers and the\", \" Dependency Injection pattern**\\n[https://martinfowler.com/articles/injection.html](https://martinfow\", \"ler.com/articles/injection.html)\\n\\n\\n  - **Steve Smith. New is Glue**\\n[https://ardalis.com/new-is-glue\", \"](https://ardalis.com/new-is-glue)\\n\\n### Implement the microservice application layer using the Web A\", \"PI\\n\\n#### **Use Dependency Injection to inject infrastructure objects into your** **application layer\", \"**\\n\\n\\nAs mentioned previously, the application layer can be implemented as part of the artifact (asse\", \"mbly)\\nyou are building, such as within a Web API project or an MVC web app project. In the case of a\", \"\\nmicroservice built with ASP.NET Core, the application layer will usually be your Web API library. I\", \"f you\\nwant to separate what is coming from ASP.NET Core (its infrastructure plus your controllers) f\", \"rom your\\ncustom application layer code, you could also place your application layer in a separate cl\", \"ass library,\\nbut that is optional.\\n\\n\\nFor instance, the application layer code of the ordering micros\", \"ervice is directly implemented as part of\\nthe **Ordering.API** project (an ASP.NET Core Web API proj\", \"ect), as shown in Figure 7-23.\\n\\n\\n_Figure 7-23. The application layer in the Ordering.API ASP.NET Cor\", \"e Web API project_\\n\\n\\n[ASP.NET Core includes a simple built-in IoC container](https://docs.microsoft.\", \"com/aspnet/core/fundamentals/dependency-injection) (represented by the IServiceProvider interface)\\nt\", \"hat supports constructor injection by default, and ASP.NET makes certain services available through\\n\", \"DI. ASP.NET Core uses the term _service_ for any of the types you register that will be injected thr\", \"ough\\nDI. You configure the built-in container\\u2019s services in your application\\u2019s _Program.cs_ file. Yo\", \"ur\\n\\n\\n267 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\ndepen\", \"dencies are implemented in the services that a type needs and that you register in the IoC\\ncontainer\", \".\\n\\n\\nTypically, you want to inject dependencies that implement infrastructure objects. A typical\\ndepe\", \"ndency to inject is a repository. But you could inject any other infrastructure dependency that\\nyou \", \"may have. For simpler implementations, you could directly inject your Unit of Work pattern object\\n(t\", \"he EF DbContext object), because the DBContext is also the implementation of your infrastructure\\nper\", \"sistence objects.\\n\\n\\nIn the following example, you can see how .NET is injecting the required reposit\", \"ory objects through\\nthe constructor. The class is a command handler, which will get covered in the n\", \"ext section.\\n\\n\\n268 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patter\", \"ns\\n\\n\\nThe class uses the injected repositories to execute the transaction and persist the state chang\", \"es. It\\ndoes not matter whether that class is a command handler, an ASP.NET Core Web API controller\\n[\", \"method, or a DDD Application Service. It is ultimately a simple class that uses repositories, domain\", \"](https://lostechies.com/jimmybogard/2008/08/21/services-in-domain-driven-design/)\\nentities, and oth\", \"er application coordination in a fashion similar to a command handler. Dependency\\nInjection works th\", \"e same way for all the mentioned classes, as in the example using DI based on the\\nconstructor.\\n\\n\\n**R\", \"egister the dependency implementation types and interfaces or abstractions**\\n\\n\\nBefore you use the ob\", \"jects injected through constructors, you need to know where to register the\\ninterfaces and classes t\", \"hat produce the objects injected into your application classes through DI. (Like\\nDI based on the con\", \"structor, as shown previously.)\\n\\n\\n**Use the built-in IoC container provided by ASP.NET Core**\\n\\n\\nWhen\", \" you use the built-in IoC container provided by ASP.NET Core, you register the types you want\\nto inj\", \"ect in the _Program.cs_ file, as in the following code:\\n\\n\\nThe most common pattern when registering t\", \"ypes in an IoC container is to register a pair of types\\u2014an\\ninterface and its related implementation \", \"class. Then when you request an object from the IoC\\ncontainer through any constructor, you request a\", \"n object of a certain type of interface. For instance, in\\nthe previous example, the last line states\", \" that when any of your constructors have a dependency on\\nIMyCustomRepository (interface or abstracti\", \"on), the IoC container will inject an instance of the\\nMyCustomSQLServerRepository implementation cla\", \"ss.\\n\\n\\n**Use the Scrutor library for automatic types registration**\\n\\n\\nWhen using DI in .NET, you migh\", \"t want to be able to scan an assembly and automatically register its\\ntypes by convention. This featu\", \"re is not currently available in ASP.NET Core. However, you can use the\\n\\n\\n269 CHAPTER 6 | Tackle Bus\", \"iness Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n[Scrutor](https://github.com/khellan\", \"g/Scrutor) library for that. This approach is convenient when you have dozens of types that need to \", \"be\\nregistered in your IoC container.\\n\\n\\n**Additional resources**\\n\\n\\n  - **Matthew King. Registering se\", \"rvices with Scrutor**\\n[https://www.mking.net/blog/registering-services-with-scrutor](https://www.mki\", \"ng.net/blog/registering-services-with-scrutor)\\n\\n\\n  - **Kristian Hellang. Scrutor.** GitHub repo.\\n[ht\", \"tps://github.com/khellang/Scrutor](https://github.com/khellang/Scrutor)\\n\\n\\n**Use Autofac as an IoC co\", \"ntainer**\\n\\n\\nYou can also use additional IoC containers and plug them into the ASP.NET Core pipeline,\", \" as in the\\n[ordering microservice in eShopOnContainers, which uses Autofac. When using Autofac you t\", \"ypically](https://autofac.org/)\\nregister the types via modules, which allow you to split the registr\", \"ation types between multiple files\\ndepending on where your types are, just as you could have the app\", \"lication types distributed across\\nmultiple class libraries.\\n\\n\\n[For example, the following is the Aut\", \"ofac application module](https://github.com/dotnet-architecture/eShopOnContainers/blob/main/src/Serv\", \"ices/Ordering/Ordering.API/Infrastructure/AutofacModules/ApplicationModule.cs) [for the Ordering.API\", \" Web API project](https://github.com/dotnet-architecture/eShopOnContainers/tree/main/src/Services/Or\", \"dering/Ordering.API)\\nwith the types you will want to inject.\\n\\n\\n[Autofac also has a feature to scan a\", \"ssemblies and register types by name conventions.](https://autofac.readthedocs.io/en/latest/register\", \"/scanning.html)\\n\\n\\nThe registration process and concepts are very similar to the way you can register\", \" types with the builtin ASP.NET Core IoC container, but the syntax when using Autofac is a bit diffe\", \"rent.\\n\\n\\nIn the example code, the abstraction IOrderRepository is registered along with the implement\", \"ation\\nclass OrderRepository. This means that whenever a constructor is declaring a dependency throug\", \"h the\\n\\n\\n270 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nIO\", \"rderRepository abstraction or interface, the IoC container will inject an instance of the\\nOrderRepos\", \"itory class.\\n\\n\\nThe instance scope type determines how an instance is shared between requests for the\", \" same service\\nor dependency. When a request is made for a dependency, the IoC container can return t\", \"he following:\\n\\n\\n  - A single instance per lifetime scope (referred to in the ASP.NET Core IoC contai\", \"ner as _scoped_ ).\\n\\n\\n  - A new instance per dependency (referred to in the ASP.NET Core IoC containe\", \"r as _transient_ ).\\n\\n\\n  - A single instance shared across all objects using the IoC container (refer\", \"red to in the ASP.NET\\nCore IoC container as _singleton_ ).\\n\\n\\n**Additional resources**\\n\\n\\n  - **Introd\", \"uction to Dependency Injection in ASP.NET Core**\\n[https://learn.microsoft.com/aspnet/core/fundamenta\", \"ls/dependency-injection](https://docs.microsoft.com/aspnet/core/fundamentals/dependency-injection)\\n\\n\", \"\\n  - **Autofac.** Official documentation.\\n[https://docs.autofac.org/en/latest/](https://docs.autofac\", \".org/en/latest/)\\n\\n\\n  - **Comparing ASP.NET Core IoC container service lifetimes with Autofac IoC con\", \"tainer**\\n**instance scopes - Cesar de la Torre.**\\n[https://devblogs.microsoft.com/cesardelatorre/com\", \"paring-asp-net-core-ioc-service-life-](https://devblogs.microsoft.com/cesardelatorre/comparing-asp-n\", \"et-core-ioc-service-life-times-and-autofac-ioc-instance-scopes/)\\n[times-and-autofac-ioc-instance-sco\", \"pes/](https://devblogs.microsoft.com/cesardelatorre/comparing-asp-net-core-ioc-service-life-times-an\", \"d-autofac-ioc-instance-scopes/)\\n\\n#### **Implement the Command and Command Handler patterns**\\n\\n\\nIn th\", \"e DI-through-constructor example shown in the previous section, the IoC container was injecting\\nrepo\", \"sitories through a constructor in a class. But exactly where were they injected? In a simple Web\\nAPI\", \" (for example, the catalog microservice in eShopOnContainers), you inject them at the MVC\\ncontroller\", \"s\\u2019 level, in a controller constructor, as part of the request pipeline of ASP.NET Core. However,\\n[in\", \" the initial code of this section (the CreateOrderCommandHandler](https://github.com/dotnet-architec\", \"ture/eShopOnContainers/blob/main/src/Services/Ordering/Ordering.API/Application/Commands/CreateOrder\", \"CommandHandler.cs) class from the Ordering.API\\nservice in eShopOnContainers), the injection of depen\", \"dencies is done through the constructor of a\\nparticular command handler. Let us explain what a comma\", \"nd handler is and why you would want to\\nuse it.\\n\\n\\nThe Command pattern is intrinsically related to th\", \"e CQRS pattern that was introduced earlier in this\\n[guide. CQRS has two sides. The first area is que\", \"ries, using simplified queries with the Dapper](https://github.com/StackExchange/dapper-dot-net) mic\", \"ro\\nORM, which was explained previously. The second area is commands, which are the starting point fo\", \"r\\ntransactions, and the input channel from outside the service.\\n\\n\\nAs shown in Figure 7-24, the patte\", \"rn is based on accepting commands from the client-side,\\nprocessing them based on the domain model ru\", \"les, and finally persisting the states with transactions.\\n\\n\\n271 CHAPTER 6 | Tackle Business Complexi\", \"ty in a Microservice with DDD and CQRS Patterns\\n\\n\\n_Figure 7-24. High-level view of the commands or \\u201c\", \"transactional side\\u201d in a CQRS pattern_\\n\\n\\nFigure 7-24 shows that the UI app sends a command through t\", \"he API that gets to a\\nCommandHandler, that depends on the Domain model and the Infrastructure, to up\", \"date the\\ndatabase.\\n\\n\\n**The command class**\\n\\n\\nA command is a request for the system to perform an act\", \"ion that changes the state of the system.\\nCommands are imperative, and should be processed just once\", \".\\n\\n\\nSince commands are imperatives, they are typically named with a verb in the imperative mood (for\", \"\\nexample, \\u201ccreate\\u201d or \\u201cupdate\\u201d), and they might include the aggregate type, such as\\nCreateOrderComma\", \"nd. Unlike an event, a command is not a fact from the past; it is only a request,\\nand thus may be re\", \"fused.\\n\\n\\nCommands can originate from the UI as a result of a user initiating a request, or from a pr\", \"ocess\\nmanager when the process manager is directing an aggregate to perform an action.\\n\\n\\nAn importan\", \"t characteristic of a command is that it should be processed just once by a single receiver.\\nThis is\", \" because a command is a single action or transaction you want to perform in the application.\\nFor exa\", \"mple, the same order creation command should not be processed more than once. This is an\\nimportant d\", \"ifference between commands and events. Events may be processed multiple times,\\nbecause many systems \", \"or microservices might be interested in the event.\\n\\n\\nIn addition, it is important that a command be \", \"processed only once in case the command is not\\nidempotent. A command is idempotent if it can be exec\", \"uted multiple times without changing the\\nresult, either because of the nature of the command, or bec\", \"ause of the way the system handles the\\ncommand.\\n\\n\\nIt is a good practice to make your commands and up\", \"dates idempotent when it makes sense under\\nyour domain\\u2019s business rules and invariants. For instance\", \", to use the same example, if for any reason\\n(retry logic, hacking, etc.) the same CreateOrder comma\", \"nd reaches your system multiple times, you\\nshould be able to identify it and ensure that you do not \", \"create multiple orders. To do so, you need to\\n\\n\\n272 CHAPTER 6 | Tackle Business Complexity in a Micr\", \"oservice with DDD and CQRS Patterns\\n\\n\\nattach some kind of identity in the operations and identify wh\", \"ether the command or update was\\nalready processed.\\n\\n\\nYou send a command to a single receiver; you do\", \" not publish a command. Publishing is for events\\nthat state a fact\\u2014that something has happened and m\", \"ight be interesting for event receivers. In the\\ncase of events, the publisher has no concerns about \", \"which receivers get the event or what they do it.\\nBut domain or integration events are a different s\", \"tory already introduced in previous sections.\\n\\n\\nA command is implemented with a class that contains \", \"data fields or collections with all the\\ninformation that is needed in order to execute that command.\", \" A command is a special kind of Data\\nTransfer Object (DTO), one that is specifically used to request\", \" changes or transactions. The command\\nitself is based on exactly the information that is needed for \", \"processing the command, and nothing\\nmore.\\n\\n\\nThe following example shows the simplified CreateOrderCo\", \"mmand class. This is an immutable\\ncommand that is used in the ordering microservice in eShopOnContai\", \"ners.\\n\\n\\n273 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n27\", \"4 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nBasically, t\", \"he command class contains all the data you need for performing a business transaction by\\nusing the d\", \"omain model objects. Thus, commands are simply data structures that contain read-only\\ndata, and no b\", \"ehavior. The command\\u2019s name indicates its purpose. In many languages like C#,\\ncommands are represent\", \"ed as classes, but they are not true classes in the real object-oriented sense.\\n\\n\\nAs an additional c\", \"haracteristic, commands are immutable, because the expected usage is that they are\\nprocessed directl\", \"y by the domain model. They do not need to change during their projected lifetime.\\nIn a C# class, im\", \"mutability can be achieved by not having any setters or other methods that change\\nthe internal state\", \".\\n\\n\\nKeep in mind that if you intend or expect commands to go through a serializing/deserializing pro\", \"cess,\\nthe properties must have a private setter, and the [DataMember] (or [JsonProperty]) attribute.\", \"\\nOtherwise, the deserializer won\\u2019t be able to reconstruct the object at the destination with the req\", \"uired\\nvalues. You can also use truly read-only properties if the class has a constructor with parame\", \"ters for all\\nproperties, with the usual camelCase naming convention, and annotate the constructor as\", \"\\n\\n[JsonConstructor]. However, this option requires more code.\\n\\n\\nFor example, the command class for c\", \"reating an order is probably similar in terms of data to the order\\nyou want to create, but you proba\", \"bly do not need the same attributes. For instance,\\nCreateOrderCommand does not have an order ID, bec\", \"ause the order has not been created yet.\\n\\n\\nMany command classes can be simple, requiring only a few \", \"fields about some state that needs to be\\nchanged. That would be the case if you are just changing th\", \"e status of an order from \\u201cin process\\u201d to\\n\\u201cpaid\\u201d or \\u201cshipped\\u201d by using a command similar to the foll\", \"owing:\\n\\n\\nSome developers make their UI request objects separate from their command DTOs, but that is\", \" just a\\nmatter of preference. It is a tedious separation with not much additional value, and the obj\", \"ects are\\nalmost exactly the same shape. For instance, in eShopOnContainers, some commands come direc\", \"tly\\nfrom the client-side.\\n\\n\\n**The Command handler class**\\n\\n\\nYou should implement a specific command \", \"handler class for each command. That is how the pattern\\nworks, and it\\u2019s where you\\u2019ll use the command\", \" object, the domain objects, and the infrastructure\\nrepository objects. The command handler is in fa\", \"ct the heart of the application layer in terms of CQRS\\nand DDD. However, all the domain logic should\", \" be contained in the domain classes\\u2014within the\\n[aggregate roots (root entities), child entities, or \", \"domain services, but not within the command handler,](https://lostechies.com/jimmybogard/2008/08/21/\", \"services-in-domain-driven-design/)\\nwhich is a class from the application layer.\\n\\n\\n275 CHAPTER 6 | Ta\", \"ckle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nThe command handler class of\", \"fers a strong stepping stone in the way to achieve the Single\\nResponsibility Principle (SRP) mention\", \"ed in a previous section.\\n\\n\\nA command handler receives a command and obtains a result from the aggre\", \"gate that is used. The\\nresult should be either successful execution of the command, or an exception.\", \" In the case of an\\nexception, the system state should be unchanged.\\n\\n\\nThe command handler usually ta\", \"kes the following steps:\\n\\n\\n  - [It receives the command object, like a DTO (from the mediator](https\", \"://en.wikipedia.org/wiki/Mediator_pattern) or other infrastructure object).\\n\\n\\n  - It validates that \", \"the command is valid (if not validated by the mediator).\\n\\n\\n  - It instantiates the aggregate root in\", \"stance that is the target of the current command.\\n\\n\\n  - It executes the method on the aggregate root\", \" instance, getting the required data from the\\ncommand.\\n\\n\\n  - It persists the new state of the aggreg\", \"ate to its related database. This last operation is the\\nactual transaction.\\n\\n\\nTypically, a command h\", \"andler deals with a single aggregate driven by its aggregate root (root entity).\\nIf multiple aggrega\", \"tes should be impacted by the reception of a single command, you could use\\ndomain events to propagat\", \"e states or actions across multiple aggregates.\\n\\n\\nThe important point here is that when a command is\", \" being processed, all the domain logic should be\\ninside the domain model (the aggregates), fully enc\", \"apsulated and ready for unit testing. The\\ncommand handler just acts as a way to get the domain model\", \" from the database, and as the final\\nstep, to tell the infrastructure layer (repositories) to persis\", \"t the changes when the model is changed.\\nThe advantage of this approach is that you can refactor the\", \" domain logic in an isolated, fully\\nencapsulated, rich, behavioral domain model without changing cod\", \"e in the application or\\ninfrastructure layers, which are the plumbing level (command handlers, Web A\", \"PI, repositories, etc.).\\n\\n\\nWhen command handlers get complex, with too much logic, that can be a cod\", \"e smell. Review them,\\nand if you find domain logic, refactor the code to move that domain behavior t\", \"o the methods of the\\ndomain objects (the aggregate root and child entity).\\n\\n\\nAs an example of a comm\", \"and handler class, the following code shows the same\\nCreateOrderCommandHandler class that you saw at\", \" the beginning of this chapter. In this case, it also\\nhighlights the Handle method and the operation\", \"s with the domain model objects/aggregates.\\n\\n\\n276 CHAPTER 6 | Tackle Business Complexity in a Micros\", \"ervice with DDD and CQRS Patterns\\n\\n\\nThese are additional steps a command handler should take:\\n\\n\\n  - \", \"Use the command\\u2019s data to operate with the aggregate root\\u2019s methods and behavior.\\n\\n\\n  - Internally w\", \"ithin the domain objects, raise domain events while the transaction is executed,\\nbut that is transpa\", \"rent from a command handler point of view.\\n\\n\\n  - If the aggregate\\u2019s operation result is successful a\", \"nd after the transaction is finished, raise\\nintegration events. (These might also be raised by infra\", \"structure classes like repositories.)\\n\\n\\n277 CHAPTER 6 | Tackle Business Complexity in a Microservice\", \" with DDD and CQRS Patterns\\n\\n\\n**Additional resources**\\n\\n\\n  - **Mark Seemann. At the Boundaries, Appl\", \"ications are Not Object-Oriented**\\n[https://blog.ploeh.dk/2011/05/31/AttheBoundaries,Applicationsare\", \"NotObject-Oriented/](https://blog.ploeh.dk/2011/05/31/AttheBoundaries,ApplicationsareNotObject-Orien\", \"ted/)\\n\\n\\n  - **Commands and events**\\n[https://cqrs.nu/faq/Command%20and%20Events](https://cqrs.nu/faq\", \"/Command%20and%20Events)\\n\\n\\n  - **What does a command handler do?**\\n[https://cqrs.nu/faq/Command%20Ha\", \"ndlers](https://cqrs.nu/faq/Command%20Handlers)\\n\\n\\n  - **Jimmy Bogard. Domain Command Patterns \\u2013 Hand\", \"lers**\\n[https://jimmybogard.com/domain-command-patterns-handlers/](https://jimmybogard.com/domain-co\", \"mmand-patterns-handlers/)\\n\\n\\n  - **Jimmy Bogard. Domain Command Patterns \\u2013 Validation**\\n[https://jimm\", \"ybogard.com/domain-command-patterns-validation/](https://jimmybogard.com/domain-command-patterns-val\", \"idation/)\\n\\n#### **The Command process pipeline: how to trigger a command handler**\\n\\n\\nThe next questi\", \"on is how to invoke a command handler. You could manually call it from each related\\nASP.NET Core con\", \"troller. However, that approach would be too coupled and is not ideal.\\n\\n\\nThe other two main options,\", \" which are the recommended options, are:\\n\\n\\n  - Through an in-memory Mediator pattern artifact.\\n\\n\\n  -\", \" With an asynchronous message queue, in between controllers and handlers.\\n\\n\\n**Use the Mediator patte\", \"rn (in-memory) in the command pipeline**\\n\\n\\nAs shown in Figure 7-25, in a CQRS approach you use an in\", \"telligent mediator, similar to an in-memory\\nbus, which is smart enough to redirect to the right comm\", \"and handler based on the type of the\\ncommand or DTO being received. The single black arrows between \", \"components represent the\\ndependencies between objects (in many cases, injected through DI) with thei\", \"r related interactions.\\n\\n\\n278 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and \", \"CQRS Patterns\\n\\n\\n_Figure 7-25. Using the Mediator pattern in process in a single CQRS microservice_\\n\\n\", \"\\nThe above diagram shows a zoom-in from image 7-24: the ASP.NET Core controller sends the\\ncommand to\", \" MediatR\\u2019s command pipeline, so they get to the appropriate handler.\\n\\n\\nThe reason that using the Med\", \"iator pattern makes sense is that in enterprise applications, the\\nprocessing requests can get compli\", \"cated. You want to be able to add an open number of crosscutting concerns like logging, validations,\", \" audit, and security. In these cases, you can rely on a\\n[mediator pipeline (see Mediator pattern) to\", \" provide a means for these extra behaviors or cross-](https://en.wikipedia.org/wiki/Mediator_pattern\", \")\\ncutting concerns.\\n\\n\\nA mediator is an object that encapsulates the \\u201chow\\u201d of this process: it coordi\", \"nates execution based on\\nstate, the way a command handler is invoked, or the payload you provide to \", \"the handler. With a\\nmediator component, you can apply cross-cutting concerns in a centralized and tr\", \"ansparent way by\\n[applying decorators (or pipeline behaviors since MediatR 3). For more information,\", \" see the Decorator](https://github.com/jbogard/MediatR/wiki/Behaviors)\\n[pattern.](https://en.wikiped\", \"ia.org/wiki/Decorator_pattern)\\n\\n\\n[Decorators and behaviors are similar to Aspect Oriented Programmin\", \"g (AOP), only applied to a](https://en.wikipedia.org/wiki/Aspect-oriented_programming)\\nspecific proc\", \"ess pipeline managed by the mediator component. Aspects in AOP that implement crosscutting concerns \", \"are applied based on _aspect weavers_ injected at compilation time or based on object\\ncall intercept\", \"ion. Both typical AOP approaches are sometimes said to work \\u201clike magic,\\u201d because it is\\nnot easy to \", \"see how AOP does its work. When dealing with serious issues or bugs, AOP can be difficult\\nto debug. \", \"On the other hand, these decorators/behaviors are explicit and applied only in the context\\nof the me\", \"diator, so debugging is much more predictable and easy.\\n\\n\\nFor example, in the eShopOnContainers orde\", \"ring microservice, has an implementation of two sample\\n[behaviors, a LogBehavior class and a Validat\", \"orBehavior](https://github.com/dotnet-architecture/eShopOnContainers/blob/dev/src/Services/Ordering/\", \"Ordering.API/Application/Behaviors/LoggingBehavior.cs) class. The implementation of the behaviors is\", \"\\n[explained in the next section by showing how eShopOnContainers uses MediatR](https://www.nuget.org\", \"/packages/MediatR) [behaviors.](https://github.com/jbogard/MediatR/wiki/Behaviors)\\n\\n\\n279 CHAPTER 6 |\", \" Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n**Use message queues (out\", \"-of-proc) in the command\\u2019s pipeline**\\n\\n\\nAnother choice is to use asynchronous messages based on brok\", \"ers or message queues, as shown in\\nFigure 7-26. That option could also be combined with the mediator\", \" component right before the\\ncommand handler.\\n\\n\\n_Figure 7-26. Using message queues (out of the proces\", \"s and inter-process communication) with CQRS commands_\\n\\n\\nCommand\\u2019s pipeline can also be handled by a\", \" high availability message queue to deliver the\\ncommands to the appropriate handler. Using message q\", \"ueues to accept the commands can further\\ncomplicate your command\\u2019s pipeline, because you will probab\", \"ly need to split the pipeline into two\\nprocesses connected through the external message queue. Still\", \", it should be used if you need to have\\nimproved scalability and performance based on asynchronous m\", \"essaging. Consider that in the case of\\nFigure 7-26, the controller just posts the command message in\", \"to the queue and returns. Then the\\ncommand handlers process the messages at their own pace. That is \", \"a great benefit of queues: the\\nmessage queue can act as a buffer in cases when hyper scalability is \", \"needed, such as for stocks or any\\nother scenario with a high volume of ingress data.\\n\\n\\nHowever, beca\", \"use of the asynchronous nature of message queues, you need to figure out how to\\ncommunicate with the\", \" client application about the success or failure of the command\\u2019s process. As a\\nrule, you should nev\", \"er use \\u201cfire and forget\\u201d commands. Every business application needs to know if a\\ncommand was process\", \"ed successfully, or at least validated and accepted.\\n\\n\\nThus, being able to respond to the client aft\", \"er validating a command message that was submitted to\\nan asynchronous queue adds complexity to your \", \"system, as compared to an in-process command\\nprocess that returns the operation\\u2019s result after runni\", \"ng the transaction. Using queues, you might\\nneed to return the result of the command process through\", \" other operation result messages, which will\\nrequire additional components and custom communication \", \"in your system.\\n\\n\\n280 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Pat\", \"terns\\n\\n\\nAdditionally, async commands are one-way commands, which in many cases might not be needed, \", \"as\\nis explained in the following interesting exchange between Burtsev Alexey and Greg Young in an\\n[o\", \"nline conversation:](https://groups.google.com/forum/#!msg/dddcqrs/xhJHVxDx2pM/WP9qP8ifYCwJ)\\n\\n\\n[Burt\", \"sev Alexey] I find lots of code where people use async command handling or one-way command\\nmessaging\", \" without any reason to do so (they are not doing some long operation, they are not\\nexecuting externa\", \"l async code, they do not even cross-application boundary to be using message\\nbus). Why do they intr\", \"oduce this unnecessary complexity? And actually, I haven\\u2019t seen a CQRS code\\nexample with blocking co\", \"mmand handlers so far, though it will work just fine in most cases.\\n\\n\\n[Greg Young] [\\u2026] an asynchrono\", \"us command doesn\\u2019t exist; it\\u2019s actually another event. If I must accept\\nwhat you send me and raise a\", \"n event if I disagree, it\\u2019s no longer you telling me to do something [that\\nis, it\\u2019s not a command]. \", \"It\\u2019s you telling me something has been done. This seems like a slight\\ndifference at first, but it ha\", \"s many implications.\\n\\n\\nAsynchronous commands greatly increase the complexity of a system, because th\", \"ere is no simple way\\nto indicate failures. Therefore, asynchronous commands are not recommended othe\", \"r than when\\nscaling requirements are needed or in special cases when communicating the internal micr\", \"oservices\\nthrough messaging. In those cases, you must design a separate reporting and recovery syste\", \"m for\\nfailures.\\n\\n\\nIn the initial version of eShopOnContainers, it was decided to use synchronous com\", \"mand processing,\\nstarted from HTTP requests and driven by the Mediator pattern. That easily allows y\", \"ou to return the\\n[success or failure of the process, as in the CreateOrderCommandHandler implementat\", \"ion.](https://github.com/dotnet-architecture/eShopOnContainers/blob/netcore1.1/src/Services/Ordering\", \"/Ordering.API/Application/Commands/CreateOrderCommandHandler.cs)\\n\\n\\nIn any case, this should be a dec\", \"ision based on your application\\u2019s or microservice\\u2019s business\\nrequirements.\\n\\n#### **Implement the com\", \"mand process pipeline with a mediator pattern** **(MediatR)**\\n\\n\\nAs a sample implementation, this gui\", \"de proposes using the in-process pipeline based on the Mediator\\npattern to drive command ingestion a\", \"nd route commands, in memory, to the right command\\n[handlers. The guide also proposes applying behav\", \"iors](https://github.com/jbogard/MediatR/wiki/Behaviors) in order to separate cross-cutting concerns\", \".\\n\\n\\nFor implementation in .NET, there are multiple open-source libraries available that implement th\", \"e\\n[Mediator pattern. The library used in this guide is the MediatR](https://github.com/jbogard/Media\", \"tR) open-source library (created by Jimmy\\nBogard), but you could use another approach. MediatR is a \", \"small and simple library that allows you to\\nprocess in-memory messages like a command, while applyin\", \"g decorators or behaviors.\\n\\n\\nUsing the Mediator pattern helps you to reduce coupling and to isolate \", \"the concerns of the requested\\nwork, while automatically connecting to the handler that performs that\", \" work\\u2014in this case, to\\ncommand handlers.\\n\\n\\nAnother good reason to use the Mediator pattern was expla\", \"ined by Jimmy Bogard when reviewing\\nthis guide:\\n\\n\\n281 CHAPTER 6 | Tackle Business Complexity in a Mi\", \"croservice with DDD and CQRS Patterns\\n\\n\\nI think it might be worth mentioning testing here \\u2013 it provi\", \"des a nice consistent window into the\\nbehavior of your system. Request-in, response-out. We\\u2019ve found\", \" that aspect quite valuable in building\\nconsistently behaving tests.\\n\\n\\nFirst, let\\u2019s look at a sample\", \" WebAPI controller where you actually would use the mediator object. If\\nyou weren\\u2019t using the mediat\", \"or object, you\\u2019d need to inject all the dependencies for that controller,\\nthings like a logger objec\", \"t and others. Therefore, the constructor would be complicated. On the other\\nhand, if you use the med\", \"iator object, the constructor of your controller can be a lot simpler, with just a\\nfew dependencies \", \"instead of many dependencies if you had one per cross-cutting operation, as in the\\nfollowing example\", \":\\n\\n\\nYou can see that the mediator provides a clean and lean Web API controller constructor. In addit\", \"ion,\\nwithin the controller methods, the code to send a command to the mediator object is almost one \", \"line:\\n\\n\\n**Implement idempotent Commands**\\n\\n\\nIn **eShopOnContainers**, a more advanced example than t\", \"he above is submitting a\\nCreateOrderCommand object from the Ordering microservice. But since the Ord\", \"ering business\\nprocess is a bit more complex and, in our case, it actually starts in the Basket micr\", \"oservice, this action\\nof submitting the CreateOrderCommand object is performed from an integration-e\", \"vent handler\\n[named UserCheckoutAcceptedIntegrationEventHandler](https://github.com/dotnet-architect\", \"ure/eShopOnContainers/blob/dev/src/Services/Ordering/Ordering.API/Application/IntegrationEvents/Even\", \"tHandling/UserCheckoutAcceptedIntegrationEventHandler.cs) instead of a simple WebAPI controller call\", \"ed\\nfrom the client App as in the previous simpler example.\\n\\n\\nNevertheless, the action of submitting \", \"the Command to MediatR is pretty similar, as shown in the\\nfollowing code.\\n\\n\\n282 CHAPTER 6 | Tackle B\", \"usiness Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nHowever, this case is also slightl\", \"y more advanced because we\\u2019re also implementing idempotent\\ncommands. The CreateOrderCommand process \", \"should be idempotent, so if the same message comes\\nduplicated through the network, because of any re\", \"ason, like retries, the same business order will be\\nprocessed just once.\\n\\n\\nThis is implemented by wr\", \"apping the business command (in this case CreateOrderCommand) and\\nembedding it into a generic Identi\", \"fiedCommand, which is tracked by an ID of every message coming\\nthrough the network that has to be id\", \"empotent.\\n\\n\\nIn the code below, you can see that the IdentifiedCommand is nothing more than a DTO wit\", \"h and ID\\nplus the wrapped business command object.\\n\\n\\n[Then the CommandHandler for the IdentifiedComm\", \"and named IdentifiedCommandHandler.cs will](https://github.com/dotnet-architecture/eShopOnContainers\", \"/blob/dev/src/Services/Ordering/Ordering.API/Application/Commands/IdentifiedCommandHandler.cs)\\nbasic\", \"ally check if the ID coming as part of the message already exists in a table. If it already exists, \", \"that\\ncommand won\\u2019t be processed again, so it behaves as an idempotent command. That infrastructure\\nc\", \"ode is performed by the _requestManager.ExistAsync method call below.\\n\\n\\n283 CHAPTER 6 | Tackle Busin\", \"ess Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\n284 CHAPTER 6 | Tackle Business Comple\", \"xity in a Microservice with DDD and CQRS Patterns\\n\\n\\nSince the IdentifiedCommand acts like a business\", \" command\\u2019s envelope, when the business command\\nneeds to be processed because it is not a repeated ID\", \", then it takes that inner business command and\\nresubmits it to Mediator, as in the last part of the\", \" code shown above when running\\n[_mediator.Send(message.Command), from the IdentifiedCommandHandler.c\", \"s.](https://github.com/dotnet-architecture/eShopOnContainers/blob/dev/src/Services/Ordering/Ordering\", \".API/Application/Commands/IdentifiedCommandHandler.cs)\\n\\n\\nWhen doing that, it will link and run the b\", \"usiness command handler, in this case, the\\n[CreateOrderCommandHandler, which is running transactions\", \" against the Ordering database, as shown](https://github.com/dotnet-architecture/eShopOnContainers/b\", \"lob/dev/src/Services/Ordering/Ordering.API/Application/Commands/CreateOrderCommandHandler.cs)\\nin the\", \" following code.\\n\\n\\n285 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Pa\", \"tterns\\n\\n\\n**Register the types used by MediatR**\\n\\n\\nIn order for MediatR to be aware of your command h\", \"andler classes, you need to register the mediator\\nclasses and the command handler classes in your Io\", \"C container. By default, MediatR uses Autofac as\\nthe IoC container, but you can also use the built-i\", \"n ASP.NET Core IoC container or any other container\\nsupported by MediatR.\\n\\n\\nThe following code shows\", \" how to register Mediator\\u2019s types and commands when using Autofac\\nmodules.\\n\\n\\n286 CHAPTER 6 | Tackle \", \"Business Complexity in a Microservice with DDD and CQRS Patterns\\n\\n\\nThis is where \\u201cthe magic happens\\u201d\", \" with MediatR.\\n\\n\\nAs each command handler implements the generic IRequestHandler<T> interface, when y\", \"ou register\\nthe assemblies using RegisteredAssemblyTypes method all the types marked as IRequestHand\", \"ler also\\ngets registered with their Commands. For example:\\n\\n\\nThat is the code that correlates comman\", \"ds with command handlers. The handler is just a simple class,\\nbut it inherits from RequestHandler<T>\", \", where T is the command type, and MediatR makes sure it is\\ninvoked with the correct payload (the co\", \"mmand).\\n\\n#### **Apply cross-cutting concerns when processing commands with the** **Behaviors in Medi\", \"atR**\\n\\n\\nThere is one more thing: being able to apply cross-cutting concerns to the mediator pipeline\", \". You can\\nalso see at the end of the Autofac registration module code how it registers a behavior ty\", \"pe,\\nspecifically, a custom LoggingBehavior class and a ValidatorBehavior class. But you could add ot\", \"her\\ncustom behaviors, too.\\n\\n\\n[That LoggingBehavior](https://github.com/dotnet-architecture/eShopOnCo\", \"ntainers/blob/dev/src/Services/Ordering/Ordering.API/Application/Behaviors/LoggingBehavior.cs) class\", \" can be implemented as the following code, which logs information about\\nthe command handler being ex\", \"ecuted and whether it was successful or not.\\n\\n\\n287 CHAPTER 6 | Tackle Business Complexity in a Micro\", \"service with DDD and CQRS Patterns\\n\\n\\nJust by implementing this behavior class and by registering it \", \"in the pipeline (in the MediatorModule\\nabove), all the commands processed through MediatR will be lo\", \"gging information about the\\nexecution.\\n\\n\\nThe eShopOnContainers ordering microservice also applies a \", \"second behavior for basic validations,\\n[the ValidatorBehavior](https://github.com/dotnet-architectur\", \"e/eShopOnContainers/blob/dev/src/Services/Ordering/Ordering.API/Application/Behaviors/ValidatorBehav\", \"ior.cs) [class that relies on the FluentValidation](https://github.com/JeremySkinner/FluentValidatio\", \"n) library, as shown in the following code:\\n\\n\\nHere the behavior is raising an exception if validatio\", \"n fails, but you could also return a result object,\\ncontaining the command result if it succeeded or\", \" the validation messages in case it didn\\u2019t. This would\\nprobably make it easier to display validation\", \" results to the user.\\n\\n\\n[Then, based on the FluentValidation library, you would create validation fo\", \"r the data passed with](https://github.com/JeremySkinner/FluentValidation)\\nCreateOrderCommand, as in\", \" the following code:\\n\\n\\n288 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQR\", \"S Patterns\\n\\n\\nYou could create additional validations. This is a very clean and elegant way to implem\", \"ent your\\ncommand validations.\\n\\n\\nIn a similar way, you could implement other behaviors for additional\", \" aspects or cross-cutting concerns\\nthat you want to apply to commands when handling them.\\n\\n\\n**Additi\", \"onal resources**\\n\\n\\nThe mediator pattern\\n\\n\\n  - **Mediator pattern**\\n[https://en.wikipedia.org/wiki/Me\", \"diator_pattern](https://en.wikipedia.org/wiki/Mediator_pattern)\\n\\n\\nThe decorator pattern\\n\\n\\n  - **Deco\", \"rator pattern**\\n[https://en.wikipedia.org/wiki/Decorator_pattern](https://en.wikipedia.org/wiki/Deco\", \"rator_pattern)\\n\\n\\nMediatR (Jimmy Bogard)\\n\\n\\n  - **MediatR.** GitHub repo.\\n[https://github.com/jbogard/\", \"MediatR](https://github.com/jbogard/MediatR)\\n\\n\\n  - **CQRS with MediatR and AutoMapper**\\n[https://los\", \"techies.com/jimmybogard/2015/05/05/cqrs-with-mediatr-and-automapper/](https://lostechies.com/jimmybo\", \"gard/2015/05/05/cqrs-with-mediatr-and-automapper/)\\n\\n\\n  - **Put your controllers on a diet: POSTs and\", \" commands.**\\n[https://lostechies.com/jimmybogard/2013/12/19/put-your-controllers-on-a-diet-posts-and\", \"-](https://lostechies.com/jimmybogard/2013/12/19/put-your-controllers-on-a-diet-posts-and-commands/)\", \"\\n[commands/](https://lostechies.com/jimmybogard/2013/12/19/put-your-controllers-on-a-diet-posts-and-\", \"commands/)\\n\\n\\n289 CHAPTER 6 | Tackle Business Complexity in a Microservice with DDD and CQRS Patterns\", \"\\n\\n\\n  - **Tackling cross-cutting concerns with a mediator pipeline**\\n[https://lostechies.com/jimmybog\", \"ard/2014/09/09/tackling-cross-cutting-concerns-with-a-](https://lostechies.com/jimmybogard/2014/09/0\", \"9/tackling-cross-cutting-concerns-with-a-mediator-pipeline/)\\n[mediator-pipeline/](https://lostechies\", \".com/jimmybogard/2014/09/09/tackling-cross-cutting-concerns-with-a-mediator-pipeline/)\\n\\n\\n  - **CQRS \", \"and REST: the perfect match**\\n[https://lostechies.com/jimmybogard/2016/06/01/cqrs-and-rest-the-perfe\", \"ct-match/](https://lostechies.com/jimmybogard/2016/06/01/cqrs-and-rest-the-perfect-match/)\\n\\n\\n  - **M\", \"ediatR Pipeline Examples**\\n[https://lostechies.com/jimmybogard/2016/10/13/mediatr-pipeline-examples/\", \"](https://lostechies.com/jimmybogard/2016/10/13/mediatr-pipeline-examples/)\\n\\n\\n  - **Vertical Slice T\", \"est Fixtures for MediatR and ASP.NET Core**\\n[https://lostechies.com/jimmybogard/2016/10/24/vertical-\", \"slice-test-fixtures-for-mediatr-and-](https://lostechies.com/jimmybogard/2016/10/24/vertical-slice-t\", \"est-fixtures-for-mediatr-and-asp-net-core/)\\n[asp-net-core/](https://lostechies.com/jimmybogard/2016/\", \"10/24/vertical-slice-test-fixtures-for-mediatr-and-asp-net-core/)\\n\\n\\n  - **MediatR Extensions for Mic\", \"rosoft Dependency Injection Released**\\n[https://lostechies.com/jimmybogard/2016/07/19/mediatr-extens\", \"ions-for-microsoft-](https://lostechies.com/jimmybogard/2016/07/19/mediatr-extensions-for-microsoft-\", \"dependency-injection-released/)\\n[dependency-injection-released/](https://lostechies.com/jimmybogard/\", \"2016/07/19/mediatr-extensions-for-microsoft-dependency-injection-released/)\\n\\n\\nFluent validation\\n\\n\\n  \", \"- **Jeremy Skinner. FluentValidation.** GitHub repo.\\n[https://github.com/JeremySkinner/FluentValidat\", \"ion](https://github.com/JeremySkinner/FluentValidation)\\n\\n\\n290 CHAPTER 6 | Tackle Business Complexity\", \" in a Microservice with DDD and CQRS Patterns\\n\\n\\n_**CHAPTER**_\\n# 7\\n\\n## Implement resilient applicatio\", \"ns\\n\\n\\n_Your microservice and cloud-based applications must embrace the partial failures that will cer\", \"tainly_\\n_occur eventually. You must design your application to be resilient to those partial failure\", \"s._\\n\\n\\nResiliency is the ability to recover from failures and continue to function. It isn\\u2019t about av\", \"oiding\\nfailures but accepting the fact that failures will happen and responding to them in a way tha\", \"t avoids\\ndowntime or data loss. The goal of resiliency is to return the application to a fully funct\", \"ioning state\\nafter a failure.\\n\\n\\nIt\\u2019s challenging enough to design and deploy a microservices-based a\", \"pplication. But you also need to\\nkeep your application running in an environment where some sort of \", \"failure is certain. Therefore, your\\napplication should be resilient. It should be designed to cope w\", \"ith partial failures, like network\\noutages or nodes or VMs crashing in the cloud. Even microservices\", \" (containers) being moved to a\\ndifferent node within a cluster can cause intermittent short failures\", \" within the application.\\n\\n\\nThe many individual components of your application should also incorporat\", \"e health monitoring\\nfeatures. By following the guidelines in this chapter, you can create an applica\", \"tion that can work\\nsmoothly in spite of transient downtime or the normal hiccups that occur in compl\", \"ex and cloud-based\\ndeployments.\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n291 CHAPTER 7 | Implement resilient applications\\n\\n\\n### Hand\", \"le partial failure\\n\\nIn distributed systems like microservices-based applications, there\\u2019s an ever-pr\", \"esent risk of partial\\nfailure. For instance, a single microservice/container can fail or might not b\", \"e available to respond for a\\nshort time, or a single VM or server can crash. Since clients and servi\", \"ces are separate processes, a\\nservice might not be able to respond in a timely way to a client\\u2019s req\", \"uest. The service might be\\noverloaded and responding very slowly to requests or might simply not be \", \"accessible for a short time\\nbecause of network issues.\\n\\n\\nFor example, consider the Order details pag\", \"e from the eShopOnContainers sample application. If the\\nordering microservice is unresponsive when t\", \"he user tries to submit an order, a bad implementation\\nof the client process (the MVC web applicatio\", \"n)\\u2014for example, if the client code were to use\\nsynchronous RPCs with no timeout\\u2014would block threads \", \"indefinitely waiting for a response. Besides\\ncreating a bad user experience, every unresponsive wait\", \" consumes or blocks a thread, and threads are\\nextremely valuable in highly scalable applications. If\", \" there are many blocked threads, eventually the\\napplication\\u2019s runtime can run out of threads. In tha\", \"t case, the application can become globally\\nunresponsive instead of just partially unresponsive, as \", \"shown in Figure 8-1.\\n\\n\\n_Figure 8-1. Partial failures because of dependencies that impact service thr\", \"ead availability_\\n\\n\\nIn a large microservices-based application, any partial failure can be amplified\", \", especially if most of\\nthe internal microservices interaction is based on synchronous HTTP calls (w\", \"hich is considered an antipattern). Think about a system that receives millions of incoming calls pe\", \"r day. If your system has a\\nbad design that\\u2019s based on long chains of synchronous HTTP calls, these \", \"incoming calls might result in\\nmany more millions of outgoing calls (let\\u2019s suppose a ratio of 1:4) t\", \"o dozens of internal microservices\\nas synchronous dependencies. This situation is shown in Figure 8-\", \"2, especially dependency #3, that\\nstarts a chain, calling dependency #4, which then calls #5.\\n\\n\\n292 \", \"CHAPTER 7 | Implement resilient applications\\n\\n\\n_Figure 8-2. The impact of having an incorrect design\", \" featuring long chains of HTTP requests_\\n\\n\\nIntermittent failure is guaranteed in a distributed and c\", \"loud-based system, even if every dependency\\nitself has excellent availability. It\\u2019s a fact you need \", \"to consider.\\n\\n\\nIf you do not design and implement techniques to ensure fault tolerance, even small d\", \"owntimes can\\nbe amplified. As an example, 50 dependencies each with 99.99% of availability would res\", \"ult in several\\nhours of downtime each month because of this ripple effect. When a microservice depen\", \"dency fails\\nwhile handling a high volume of requests, that failure can quickly saturate all availabl\", \"e request threads\\nin each service and crash the whole application.\\n\\n\\n_Figure 8-3. Partial failure am\", \"plified by microservices with long chains of synchronous HTTP calls_\\n\\n\\n293 CHAPTER 7 | Implement res\", \"ilient applications\\n\\n\\nTo minimize this problem, in the section Asynchronous microservice integration\", \" enforce microservice\\u2019s\\nautonomy, this guide encourages you to use asynchronous communication across\", \" the internal\\nmicroservices.\\n\\n\\nIn addition, it\\u2019s essential that you design your microservices and cl\", \"ient applications to handle partial\\nfailures\\u2014that is, to build resilient microservices and client ap\", \"plications.\\n\\n### Strategies to handle partial failure\\n\\n\\nTo deal with partial failures, use one of th\", \"e strategies described here.\\n\\n\\n**Use asynchronous communication (for example, message-based communic\", \"ation) across**\\n**internal microservices** . It\\u2019s highly advisable not to create long chains of sync\", \"hronous HTTP calls\\nacross the internal microservices because that incorrect design will eventually b\", \"ecome the main cause\\nof bad outages. On the contrary, except for the front-end communications betwee\", \"n the client\\napplications and the first level of microservices or fine-grained API Gateways, it\\u2019s re\", \"commended to use\\nonly asynchronous (message-based) communication once past the initial request/respo\", \"nse cycle,\\nacross the internal microservices. Eventual consistency and event-driven architectures wi\", \"ll help to\\nminimize ripple effects. These approaches enforce a higher level of microservice autonomy\", \" and\\ntherefore prevent against the problem noted here.\\n\\n\\n**Use retries with exponential backoff** . \", \"This technique helps to avoid short and intermittent failures\\nby performing call retries a certain n\", \"umber of times, in case the service was not available only for a\\nshort time. This might occur due to\", \" intermittent network issues or when a microservice/container is\\nmoved to a different node in a clus\", \"ter. However, if these retries are not designed properly with circuit\\n[breakers, it can aggravate th\", \"e ripple effects, ultimately even causing a Denial of Service (DoS).](https://en.wikipedia.org/wiki/\", \"Denial-of-service_attack)\\n\\n\\n**Work around network timeouts** . In general, clients should be designe\", \"d not to block indefinitely and\\nto always use timeouts when waiting for a response. Using timeouts e\", \"nsures that resources are never\\ntied up indefinitely.\\n\\n\\n**Use the Circuit Breaker pattern** . In thi\", \"s approach, the client process tracks the number of failed\\nrequests. If the error rate exceeds a con\", \"figured limit, a \\u201ccircuit breaker\\u201d trips so that further attempts\\nfail immediately. (If a large numb\", \"er of requests are failing, that suggests the service is unavailable and\\nthat sending requests is po\", \"intless.) After a timeout period, the client should try again and, if the new\\nrequests are successfu\", \"l, close the circuit breaker.\\n\\n\\n**Provide fallbacks** . In this approach, the client process perform\", \"s fallback logic when a request fails,\\nsuch as returning cached data or a default value. This is an \", \"approach suitable for queries, and is more\\ncomplex for updates or commands.\\n\\n\\n**Limit the number of \", \"queued requests** . Clients should also impose an upper bound on the number\\nof outstanding requests \", \"that a client microservice can send to a particular service. If the limit has been\\nreached, it\\u2019s pro\", \"bably pointless to make additional requests, and those attempts should fail\\n[immediately. In terms o\", \"f implementation, the Polly Bulkhead Isolation](https://github.com/App-vNext/Polly/wiki/Bulkhead) po\", \"licy can be used to fulfill this\\n[requirement. This approach is essentially a parallelization thrott\", \"le with SemaphoreSlim as the](https://docs.microsoft.com/dotnet/api/system.threading.semaphoreslim)\\n\", \"implementation. It also permits a \\u201cqueue\\u201d outside the bulkhead. You can proactively shed excess load\", \"\\neven before execution (for example, because capacity is deemed full). This makes its response to\\n\\n\\n\", \"294 CHAPTER 7 | Implement resilient applications\\n\\n\\ncertain failure scenarios faster than a circuit b\", \"reaker would be, since the circuit breaker waits for the\\n[failures. The BulkheadPolicy object in Pol\", \"ly](https://thepollyproject.azurewebsites.net/) exposes how full the bulkhead and queue are, and off\", \"ers\\nevents on overflow so can also be used to drive automated horizontal scaling.\\n\\n#### **Additional\", \" resources**\\n\\n\\n  - **Resiliency patterns**\\n[https://learn.microsoft.com/azure/architecture/framework\", \"/resiliency/reliability-patterns](https://docs.microsoft.com/azure/architecture/framework/resiliency\", \"/reliability-patterns)\\n\\n\\n  - **Adding Resilience and Optimizing Performance**\\n[https://learn.microso\", \"ft.com/previous-versions/msp-n-p/jj591574(v=pandp.10)](https://docs.microsoft.com/previous-versions/\", \"msp-n-p/jj591574(v=pandp.10))\\n\\n\\n  - **Bulkhead.** GitHub repo. Implementation with Polly policy.\\n[ht\", \"tps://github.com/App-vNext/Polly/wiki/Bulkhead](https://github.com/App-vNext/Polly/wiki/Bulkhead)\\n\\n\\n\", \"  - **Designing resilient applications for Azure**\\n[https://learn.microsoft.com/azure/architecture/f\", \"ramework/resiliency/app-design](https://docs.microsoft.com/azure/architecture/framework/resiliency/a\", \"pp-design)\\n\\n\\n  - **Transient fault handling**\\n[https://learn.microsoft.com/azure/architecture/best-p\", \"ractices/transient-faults](https://docs.microsoft.com/azure/architecture/best-practices/transient-fa\", \"ults)\\n\\n### Implement retries with exponential backoff\\n\\n\\n_[Retries with exponential backoff](https://\", \"docs.microsoft.com/azure/architecture/patterns/retry)_ is a technique that retries an operation, wit\", \"h an exponentially\\n[increasing wait time, up to a maximum retry count has been reached (the exponent\", \"ial backoff). This](https://en.wikipedia.org/wiki/Exponential_backoff)\\ntechnique embraces the fact t\", \"hat cloud resources might intermittently be unavailable for more than a\\nfew seconds for any reason. \", \"For example, an orchestrator might be moving a container to another\\nnode in a cluster for load balan\", \"cing. During that time, some requests might fail. Another example\\ncould be a database like SQL Azure\", \", where a database can be moved to another server for load\\nbalancing, causing the database to be una\", \"vailable for a few seconds.\\n\\n\\nThere are many approaches to implement retries logic with exponential \", \"backoff.\\n\\n### Implement resilient Entity Framework Core SQL connections\\n\\n\\nFor Azure SQL DB, Entity F\", \"ramework (EF) Core already provides internal database connection resiliency\\n[and retry logic. But yo\", \"u need to enable the Entity Framework execution strategy for each DbContext](https://docs.microsoft.\", \"com/dotnet/api/microsoft.entityframeworkcore.dbcontext)\\n[connection if you want to have resilient EF\", \" Core connections.](https://docs.microsoft.com/ef/core/miscellaneous/connection-resiliency)\\n\\n\\nFor in\", \"stance, the following code at the EF Core connection level enables resilient SQL connections that\\nar\", \"e retried if the connection fails.\\n\\n\\n295 CHAPTER 7 | Implement resilient applications\\n\\n\\n#### **Execu\", \"tion strategies and explicit transactions using BeginTransaction** **and multiple DbContexts**\\n\\nWhen\", \" retries are enabled in EF Core connections, each operation you perform using EF Core becomes\\nits ow\", \"n retryable operation. Each query and each call to SaveChanges will be retried as a unit if a\\ntransi\", \"ent failure occurs.\\n\\n\\nHowever, if your code initiates a transaction using BeginTransaction, you\\u2019re d\", \"efining your own group\\nof operations that need to be treated as a unit. Everything inside the transa\", \"ction has to be rolled back\\nif a failure occurs.\\n\\n\\nIf you try to execute that transaction when using\", \" an EF execution strategy (retry policy) and you call\\nSaveChanges from multiple DbContexts, you\\u2019ll g\", \"et an exception like this one:\\n\\n\\nSystem.InvalidOperationException: The configured execution strategy\", \"\\n\\u2018SqlServerRetryingExecutionStrategy\\u2019 does not support user initiated transactions. Use the executio\", \"n\\nstrategy returned by \\u2018DbContext.Database.CreateExecutionStrategy()\\u2019 to execute all the operations \", \"in\\nthe transaction as a retriable unit.\\n\\n\\nThe solution is to manually invoke the EF execution strate\", \"gy with a delegate representing everything\\nthat needs to be executed. If a transient failure occurs,\", \" the execution strategy will invoke the delegate\\nagain. For example, the following code shows how it\", \"\\u2019s implemented in eShopOnContainers with two\\nmultiple DbContexts (_catalogContext and the Integratio\", \"nEventLogContext) when updating a product\\nand then saving the ProductPriceChangedIntegrationEvent ob\", \"ject, which needs to use a different\\nDbContext.\\n\\n\\n296 CHAPTER 7 | Implement resilient applications\\n\\n\", \"\\n[The first DbContext](https://docs.microsoft.com/dotnet/api/microsoft.entityframeworkcore.dbcontext\", \") is _catalogContext and the second DbContext is within the\\n_catalogIntegrationEventService object. \", \"The Commit action is performed across all DbContext objects\\nusing an EF execution strategy.\\n\\n\\nTo ach\", \"ieve this multiple DbContext commit, the SaveEventAndCatalogContextChangesAsync uses a\\nResilientTran\", \"saction class, as shown in the following code:\\n\\n\\nThe ResilientTransaction.ExecuteAsync method basica\", \"lly begins a transaction from the passed\\nDbContext (_catalogContext) and then makes the EventLogServ\", \"ice use that transaction to save\\nchanges from the IntegrationEventLogContext and then commits the wh\", \"ole transaction.\\n\\n\\n297 CHAPTER 7 | Implement resilient applications\\n\\n\\n#### **Additional resources**\\n\", \"\\n\\n  - **Connection Resiliency and Command Interception with EF in an ASP.NET MVC**\\n**Application**\\n[\", \"https://learn.microsoft.com/aspnet/mvc/overview/getting-started/getting-started-with-ef-](https://do\", \"cs.microsoft.com/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-re\", \"siliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)\\n[using-mv\", \"c/connection-resiliency-and-command-interception-with-the-entity-framework-in-](https://docs.microso\", \"ft.com/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-a\", \"nd-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)\\n[an-asp-net-mvc-app\", \"lication](https://docs.microsoft.com/aspnet/mvc/overview/getting-started/getting-started-with-ef-usi\", \"ng-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-ap\", \"plication)\\n\\n\\n  - **Cesar de la Torre. Using Resilient Entity Framework Core SQL Connections and**\\n**\", \"Transactions**\\n[https://devblogs.microsoft.com/cesardelatorre/using-resilient-entity-framework-core-\", \"sql-](https://devblogs.microsoft.com/cesardelatorre/using-resilient-entity-framework-core-sql-connec\", \"tions-and-transactions-retries-with-exponential-backoff/)\\n[connections-and-transactions-retries-with\", \"-exponential-backoff/](https://devblogs.microsoft.com/cesardelatorre/using-resilient-entity-framewor\", \"k-core-sql-connections-and-transactions-retries-with-exponential-backoff/)\\n\\n### Use IHttpClientFacto\", \"ry to implement resilient HTTP requests\\n\\n\\n[IHttpClientFactory](https://docs.microsoft.com/dotnet/api\", \"/system.net.http.ihttpclientfactory) is a contract implemented by DefaultHttpClientFactory, an opini\", \"onated factory,\\n[available since .NET Core 2.1, for creating HttpClient](https://docs.microsoft.com/\", \"dotnet/api/system.net.http.httpclient) instances to be used in your applications.\\n\\n#### **Issues wit\", \"h the original HttpClient class available in .NET**\\n\\n\\n[The original and well-known HttpClient](https\", \"://docs.microsoft.com/dotnet/api/system.net.http.httpclient) class can be easily used, but in some c\", \"ases, it isn\\u2019t being\\nproperly used by many developers.\\n\\n\\nThough this class implements IDisposable, d\", \"eclaring and instantiating it within a using statement is\\nnot preferred because when the HttpClient \", \"object gets disposed of, the underlying socket is not\\nimmediately released, which can lead to a _soc\", \"ket exhaustion_ problem. For more information about this\\n[issue, see the blog post You\\u2019re using Http\", \"Client wrong and it\\u2019s destabilizing your software.](https://aspnetmonsters.com/2016/08/2016-08-27-ht\", \"tpclientwrong/)\\n\\n\\nTherefore, HttpClient is intended to be instantiated once and reused throughout th\", \"e life of an\\napplication. Instantiating an HttpClient class for every request will exhaust the numbe\", \"r of sockets\\navailable under heavy loads. That issue will result in SocketException errors. Possible\", \" approaches to\\nsolve that problem are based on the creation of the HttpClient object as singleton or\", \" static, as\\n[explained in this Microsoft article on HttpClient usage. This can be a good solution fo\", \"r short-lived](https://docs.microsoft.com/dotnet/csharp/tutorials/console-webapiclient)\\nconsole apps\", \" or similar, that run a few times a day.\\n\\n\\n298 CHAPTER 7 | Implement resilient applications\\n\\n\\nAnothe\", \"r issue that developers run into is when using a shared instance of HttpClient in long-running\\nproce\", \"sses. In a situation where the HttpClient is instantiated as a singleton or a static object, it fail\", \"s to\\n[handle the DNS changes as described in this issue](https://github.com/dotnet/runtime/issues/18\", \"348) of the dotnet/runtime GitHub repository.\\n\\n\\n[However, the issue isn\\u2019t really with HttpClient per\", \" se, but with the default constructor for HttpClient,](https://docs.microsoft.com/dotnet/api/system.\", \"net.http.httpclient.-ctor#system-net-http-httpclient-ctor)\\n[because it creates a new concrete instan\", \"ce of HttpMessageHandler, which is the one that has](https://docs.microsoft.com/dotnet/api/system.ne\", \"t.http.httpmessagehandler) _sockets_\\n_exhaustion_ and DNS changes issues mentioned above.\\n\\n\\nTo addre\", \"ss the issues mentioned above and to make HttpClient instances manageable, .NET Core 2.1\\n[introduced\", \" two approaches, one of them being IHttpClientFactory. It\\u2019s an interface that\\u2019s used to](https://doc\", \"s.microsoft.com/dotnet/api/system.net.http.ihttpclientfactory)\\nconfigure and create HttpClient insta\", \"nces in an app through Dependency Injection (DI). It also\\nprovides extensions for Polly-based middle\", \"ware to take advantage of delegating handlers in\\nHttpClient.\\n\\n\\nThe alternative is to use SocketsHttp\", \"Handler with configured PooledConnectionLifetime. This\\napproach is applied to long-lived, static or \", \"singleton HttpClient instances. To learn more about\\n[different strategies, see HttpClient guidelines\", \" for .NET.](https://docs.microsoft.com/dotnet/fundamentals/networking/http/httpclient-guidelines)\\n\\n\\n\", \"[Polly](https://thepollyproject.azurewebsites.net/) is a transient-fault-handling library that helps\", \" developers add resiliency to their applications, by\\nusing some pre-defined policies in a fluent and\", \" thread-safe manner.\\n\\n#### **Benefits of using IHttpClientFactory**\\n\\n\\n[The current implementation of\", \" IHttpClientFactory, that also implements IHttpMessageHandlerFactory,](https://docs.microsoft.com/do\", \"tnet/api/system.net.http.ihttpclientfactory)\\noffers the following benefits:\\n\\n\\n  - Provides a central\", \" location for naming and configuring logical HttpClient objects. For\\nexample, you may configure a cl\", \"ient (Service Agent) that\\u2019s pre-configured to access a specific\\nmicroservice.\\n\\n  - Codify the concep\", \"t of outgoing middleware via delegating handlers in HttpClient and\\nimplementing Polly-based middlewa\", \"re to take advantage of Polly\\u2019s policies for resiliency.\\n\\n  - HttpClient already has the concept of \", \"delegating handlers that could be linked together for\\noutgoing HTTP requests. You can register HTTP \", \"clients into the factory and you can use a\\nPolly handler to use Polly policies for Retry, CircuitBre\", \"akers, and so on.\\n\\n  - [Manage the lifetime of HttpMessageHandler](https://docs.microsoft.com/dotnet\", \"/api/system.net.http.httpmessagehandler) to avoid the mentioned problems/issues that\\ncan occur when \", \"managing HttpClient lifetimes yourself.\\n\\n\\n\\n\\n\\n299 CHAPTER 7 | Implement resilient applications\\n\\n\\n####\", \" **Multiple ways to use IHttpClientFactory**\\n\\nThere are several ways that you can use IHttpClientFac\", \"tory in your application:\\n\\n\\n  - Basic usage\\n\\n  - Use Named Clients\\n\\n  - Use Typed Clients\\n\\n  - Use G\", \"enerated Clients\\n\\n\\nFor the sake of brevity, this guidance shows the most structured way to use IHttp\", \"ClientFactory, which\\nis to use Typed Clients (Service Agent pattern). However, all options are docum\", \"ented and are currently\\n[listed in this article covering the IHttpClientFactory usage.](https://docs\", \".microsoft.com/aspnet/core/fundamentals/http-requests#consumption-patterns)\\n\\n\\n\\n\\n#### **How to use Ty\", \"ped Clients with IHttpClientFactory**\\n\\nSo, what\\u2019s a \\u201cTyped Client\\u201d? It\\u2019s just an HttpClient that\\u2019s p\", \"re-configured for some specific use. This\\nconfiguration can include specific values such as the base\", \" server, HTTP headers or time outs.\\n\\n\\nThe following diagram shows how Typed Clients are used with IH\", \"ttpClientFactory:\\n\\n\\n300 CHAPTER 7 | Implement resilient applications\\n\\n\\n_Figure 8-4. Using IHttpClien\", \"tFactory with Typed Client classes._\\n\\n\\nIn the above image, a ClientService (used by a controller or \", \"client code) uses an HttpClient created by\\nthe registered IHttpClientFactory. This factory assigns a\", \"n HttpMessageHandler from a pool to the\\nHttpClient. The HttpClient can be configured with Polly\\u2019s po\", \"licies when registering the\\n[IHttpClientFactory in the DI container with the extension method AddHtt\", \"pClient.](https://docs.microsoft.com/dotnet/api/microsoft.extensions.dependencyinjection.httpclientf\", \"actoryservicecollectionextensions.addhttpclient)\\n\\n\\n[To configure the above structure, add IHttpClien\", \"tFactory](https://docs.microsoft.com/dotnet/api/system.net.http.ihttpclientfactory) in your applicat\", \"ion by installing the\\n[Microsoft.Extensions.Http NuGet package that includes the AddHttpClient](http\", \"s://docs.microsoft.com/dotnet/api/microsoft.extensions.dependencyinjection.httpclientfactoryservicec\", \"ollectionextensions.addhttpclient) extension method for\\n[IServiceCollection. This extension method r\", \"egisters the internal DefaultHttpClientFactory class to be](https://docs.microsoft.com/dotnet/api/mi\", \"crosoft.extensions.dependencyinjection.iservicecollection)\\nused as a singleton for the interface IHt\", \"tpClientFactory. It defines a transient configuration for the\\n[HttpMessageHandlerBuilder. This messa\", \"ge handler (HttpMessageHandler](https://docs.microsoft.com/dotnet/api/microsoft.extensions.http.http\", \"messagehandlerbuilder) object), taken from a pool,\\nis used by the HttpClient returned from the facto\", \"ry.\\n\\n\\nIn the next snippet, you can see how AddHttpClient() can be used to register Typed Clients (Se\", \"rvice\\nAgents) that need to use HttpClient.\\n\\n\\n301 CHAPTER 7 | Implement resilient applications\\n\\n\\nRegi\", \"stering the client services as shown in the previous snippet, makes the DefaultClientFactory create\\n\", \"a standard HttpClient for each service. The typed client is registered as transient with DI containe\", \"r. In\\nthe preceding code, AddHttpClient() registers _CatalogService_, _BasketService_, _OrderingServ\", \"ice_ as\\ntransient services so they can be injected and consumed directly without any need for additi\", \"onal\\nregistrations.\\n\\n\\nYou could also add instance-specific configuration in the registration to, for\", \" example, configure the\\nbase address, and add some resiliency policies, as shown in the following:\\n\\n\", \"\\nIn this next example, you can see the configuration of one of the above policies:\\n\\n\\nYou can find mo\", \"re details about using Polly in the Next article.\\n\\n\\n**HttpClient lifetimes**\\n\\n\\nEach time you get an \", \"HttpClient object from the IHttpClientFactory, a new instance is returned. But\\neach HttpClient uses \", \"an HttpMessageHandler that\\u2019s pooled and reused by the IHttpClientFactory to\\nreduce resource consumpt\", \"ion, as long as the HttpMessageHandler\\u2019s lifetime hasn\\u2019t expired.\\n\\n\\nPooling of handlers is desirable\", \" as each handler typically manages its own underlying HTTP\\nconnections; creating more handlers than \", \"necessary can result in connection delays. Some handlers\\nalso keep connections open indefinitely, wh\", \"ich can prevent the handler from reacting to DNS\\nchanges.\\n\\n\\nThe HttpMessageHandler objects in the po\", \"ol have a lifetime that\\u2019s the length of time that an\\nHttpMessageHandler instance in the pool can be \", \"reused. The default value is two minutes, but it can\\n[be overridden per Typed Client. To override it\", \", call SetHandlerLifetime() on the IHttpClientBuilder](https://docs.microsoft.com/dotnet/api/microso\", \"ft.extensions.dependencyinjection.ihttpclientbuilder)\\nthat\\u2019s returned when creating the client, as s\", \"hown in the following code:\\n\\n\\nEach Typed Client can have its own configured handler lifetime value. \", \"Set the lifetime to\\nInfiniteTimeSpan to disable handler expiry.\\n\\n\\n302 CHAPTER 7 | Implement resilien\", \"t applications\\n\\n\\n**Implement your Typed Client classes that use the injected and configured**\\n**Http\", \"Client**\\n\\n\\nAs a previous step, you need to have your Typed Client classes defined, such as the class\", \"es in the\\nsample code, like \\u2018BasketService\\u2019, \\u2018CatalogService\\u2019, \\u2018OrderingService\\u2019, etc. \\u2013 A Typed Cli\", \"ent is a class\\nthat accepts an HttpClient object (injected through its constructor) and uses it to c\", \"all some remote\\nHTTP service. For example:\\n\\n\\nThe Typed Client (CatalogService in the example) is act\", \"ivated by DI (Dependency Injection), which\\nmeans it can accept any registered service in its constru\", \"ctor, in addition to HttpClient.\\n\\n\\nA Typed Client is effectively a transient object, that means a ne\", \"w instance is created each time one is\\nneeded. It receives a new HttpClient instance each time it\\u2019s \", \"constructed. However, the\\nHttpMessageHandler objects in the pool are the objects that are reused by \", \"multiple HttpClient\\ninstances.\\n\\n\\n**Use your Typed Client classes**\\n\\n\\nFinally, once you have your typ\", \"ed classes implemented, you can have them registered and configured\\nwith AddHttpClient(). After that\", \" you can use them wherever services are injected by DI, such as in\\nRazor page code or an MVC web app\", \" controller, shown in the below code from eShopOnContainers:\\n\\n\\n303 CHAPTER 7 | Implement resilient a\", \"pplications\\n\\n\\nUp to this point, the above code snippet only shows the example of performing regular \", \"HTTP\\nrequests. But the \\u2018magic\\u2019 comes in the following sections where it shows how all the HTTP reque\", \"sts\\nmade by HttpClient can have resilient policies such as retries with exponential backoff, circuit\", \"\\nbreakers, security features using auth tokens, or even any other custom feature. And all of these c\", \"an\\nbe done just by adding policies and delegating handlers to your registered Typed Clients.\\n\\n#### *\", \"*Additional resources**\\n\\n\\n  - **HttpClient guidelines for .NET**\\n[https://learn.microsoft.com/en-us/\", \"dotnet/fundamentals/networking/http/httpclient-](https://docs.microsoft.com/dotnet/fundamentals/netw\", \"orking/http/httpclient-guidelines)\\n[guidelines](https://docs.microsoft.com/dotnet/fundamentals/netwo\", \"rking/http/httpclient-guidelines)\\n\\n\\n  - **Using HttpClientFactory in .NET**\\n[https://learn.microsoft\", \".com/en-us/dotnet/core/extensions/httpclient-factory](https://docs.microsoft.com/dotnet/core/extensi\", \"ons/httpclient-factory)\\n\\n\\n  - **Using HttpClientFactory in ASP.NET Core**\\n[https://learn.microsoft.c\", \"om/aspnet/core/fundamentals/http-requests](https://docs.microsoft.com/aspnet/core/fundamentals/http-\", \"requests)\\n\\n\\n  - **HttpClientFactory source code in the dotnet/runtime GitHub repository**\\n[https://g\", \"ithub.com/dotnet/runtime/tree/release/7.0/src/libraries/Microsoft.Extensions.Http/](https://github.c\", \"om/dotnet/runtime/tree/release/7.0/src/libraries/Microsoft.Extensions.Http/)\\n\\n\\n  - **Polly (.NET res\", \"ilience and transient-fault-handling library)**\\n[https://thepollyproject.azurewebsites.net/](https:/\", \"/thepollyproject.azurewebsites.net/)\\n\\n### Implement HTTP call retries with exponential backoff with \", \"IHttpClientFactory and Polly policies\\n\\n\\nThe recommended approach for retries with exponential backof\", \"f is to take advantage of more\\n[advanced .NET libraries like the open-source Polly library.](https:/\", \"/github.com/App-vNext/Polly)\\n\\n\\nPolly is a .NET library that provides resilience and transient-fault \", \"handling capabilities. You can\\nimplement those capabilities by applying Polly policies such as Retry\", \", Circuit Breaker, Bulkhead\\nIsolation, Timeout, and Fallback. Polly targets .NET Framework 4.x and .\", \"NET Standard 1.0, 1.1, and 2.0\\n(which supports .NET Core and later).\\n\\n\\n304 CHAPTER 7 | Implement res\", \"ilient applications\\n\\n\\nThe following steps show how you can use Http retries with Polly integrated in\", \"to IHttpClientFactory,\\nwhich is explained in the previous section.\\n\\n\\n**Install .NET packages**\\n\\n\\nFir\", \"st, you will need to install the Microsoft.Extensions.Http.Polly package.\\n\\n\\n  - [Install with Visual\", \" Studio](https://docs.microsoft.com/nuget/consume-packages/install-use-packages-visual-studio)\\n\\n  - \", \"[Install with dotnet CLI](https://docs.microsoft.com/nuget/consume-packages/install-use-packages-dot\", \"net-cli)\\n\\n  - [Install with nuget.exe CLI](https://docs.microsoft.com/nuget/consume-packages/install\", \"-use-packages-nuget-cli)\\n\\n  - [Install with Package Manager Console (PowerShell)](https://docs.micro\", \"soft.com/nuget/consume-packages/install-use-packages-powershell)\\n\\n\\n**Reference the .NET 7 packages**\", \"\\n\\n\\nIHttpClientFactory is available since .NET Core 2.1, however, we recommend you use the latest .NE\", \"T 7\\npackages from NuGet in your project. You typically also need to reference the extension package\\n\", \"Microsoft.Extensions.Http.Polly.\\n\\n\\n**Configure a client with Polly\\u2019s Retry policy, in app startup**\\n\", \"\\n\\nThe **AddPolicyHandler()** method is what adds policies to the HttpClient objects you\\u2019ll use. In t\", \"his\\ncase, it\\u2019s adding a Polly\\u2019s policy for Http Retries with exponential backoff.\\n\\n\\nTo have a more m\", \"odular approach, the Http Retry Policy can be defined in a separate method within\\nthe _Program.cs_ f\", \"ile, as shown in the following code:\\n\\n\\nAs shown in previous sections, you need to define a named or \", \"typed client HttpClient configuration in\\nyour standard _Program.cs_ app configuration. Now you add i\", \"ncremental code specifying the policy for\\nthe Http retries with exponential backoff, as follows:\\n\\n\\nW\", \"ith Polly, you can define a Retry policy with the number of retries, the exponential backoff\\nconfigu\", \"ration, and the actions to take when there\\u2019s an HTTP exception, such as logging the error. In\\nthis c\", \"ase, the policy is configured to try six times with an exponential retry, starting at two seconds.\\n\\n\", \"#### **Add a jitter strategy to the retry policy**\\n\\n\\nA regular Retry policy can affect your system i\", \"n cases of high concurrency and scalability and under\\nhigh contention. To overcome peaks of similar \", \"retries coming from many clients in partial outages, a\\ngood workaround is to add a jitter strategy t\", \"o the retry algorithm/policy. This strategy can improve\\n[the overall performance of the end-to-end s\", \"ystem. As recommended in Polly: Retry with Jitter, a good](https://github.com/App-vNext/Polly/wiki/R\", \"etry-with-jitter)\\n\\n\\n305 CHAPTER 7 | Implement resilient applications\\n\\n\\njitter strategy can be implem\", \"ented by smooth and evenly distributed retry intervals applied with a\\nwell-controlled median initial\", \" retry delay on an exponential backoff. This approach helps to spread out\\nthe spikes when the issue \", \"arises. The principle is illustrated by the following example:\\n\\n#### **Additional resources**\\n\\n\\n  - \", \"**Retry pattern** [https://learn.microsoft.com/azure/architecture/patterns/retry](https://docs.micro\", \"soft.com/azure/architecture/patterns/retry)\\n\\n\\n  - **Polly and IHttpClientFactory** [https://github.c\", \"om/App-vNext/Polly/wiki/Polly-and-](https://github.com/App-vNext/Polly/wiki/Polly-and-HttpClientFact\", \"ory)\\n[HttpClientFactory](https://github.com/App-vNext/Polly/wiki/Polly-and-HttpClientFactory)\\n\\n\\n  - \", \"**Polly (.NET resilience and transient-fault-handling library)** [https://github.com/App-](https://g\", \"ithub.com/App-vNext/Polly)\\n[vNext/Polly](https://github.com/App-vNext/Polly)\\n\\n\\n  - **Polly: Retry wi\", \"th Jitter** [https://github.com/App-vNext/Polly/wiki/Retry-with-jitter](https://github.com/App-vNext\", \"/Polly/wiki/Retry-with-jitter)\\n\\n\\n  - **Marc Brooker. Jitter: Making Things Better With Randomness**\\n\", \"[https://brooker.co.za/blog/2015/03/21/backoff.html](https://brooker.co.za/blog/2015/03/21/backoff.h\", \"tml)\\n\\n### Implement the Circuit Breaker pattern\\n\\n\\nAs noted earlier, you should handle faults that mi\", \"ght take a variable amount of time to recover from,\\nas might happen when you try to connect to a rem\", \"ote service or resource. Handling this type of fault\\ncan improve the stability and resiliency of an \", \"application.\\n\\n\\nIn a distributed environment, calls to remote resources and services can fail due to \", \"transient faults,\\nsuch as slow network connections and timeouts, or if resources are responding slow\", \"ly or are\\ntemporarily unavailable. These faults typically correct themselves after a short time, and\", \" a robust cloud\\napplication should be prepared to handle them by using a strategy like the \\u201cRetry pa\", \"ttern\\u201d.\\n\\n\\nHowever, there can also be situations where faults are due to unanticipated events that mi\", \"ght take\\nmuch longer to fix. These faults can range in severity from a partial loss of connectivity \", \"to the\\ncomplete failure of a service. In these situations, it might be pointless for an application \", \"to continually\\nretry an operation that\\u2019s unlikely to succeed.\\n\\n\\nInstead, the application should be c\", \"oded to accept that the operation has failed and handle the failure\\naccordingly.\\n\\n\\n[Using Http retri\", \"es carelessly could result in creating a Denial of Service (DoS) attack within your own](https://en.\", \"wikipedia.org/wiki/Denial-of-service_attack)\\nsoftware. As a microservice fails or performs slowly, m\", \"ultiple clients might repeatedly retry failed\\nrequests. That creates a dangerous risk of exponential\", \"ly increasing traffic targeted at the failing\\nservice.\\n\\n\\n306 CHAPTER 7 | Implement resilient applica\", \"tions\\n\\n\\nTherefore, you need some kind of defense barrier so that excessive requests stop when it isn\", \"\\u2019t worth\\nto keep trying. That defense barrier is precisely the circuit breaker.\\n\\n\\nThe Circuit Breake\", \"r pattern has a different purpose than the \\u201cRetry pattern\\u201d. The \\u201cRetry pattern\\u201d\\nenables an applicati\", \"on to retry an operation in the expectation that the operation will eventually\\nsucceed. The Circuit \", \"Breaker pattern prevents an application from performing an operation that\\u2019s\\nlikely to fail. An appli\", \"cation can combine these two patterns. However, the retry logic should be\\nsensitive to any exception\", \" returned by the circuit breaker, and it should abandon retry attempts if the\\ncircuit breaker indica\", \"tes that a fault is not transient.\\n\\n#### **Implement Circuit Breaker pattern with IHttpClientFactory\", \" and Polly**\\n\\n\\nAs when implementing retries, the recommended approach for circuit breakers is to tak\", \"e advantage of\\nproven .NET libraries like Polly and its native integration with IHttpClientFactory.\\n\", \"\\n\\nAdding a circuit breaker policy into your IHttpClientFactory outgoing middleware pipeline is as si\", \"mple\\nas adding a single incremental piece of code to what you already have when using IHttpClientFac\", \"tory.\\n\\n\\nThe only addition here to the code used for HTTP call retries is the code where you add the \", \"Circuit\\nBreaker policy to the list of policies to use, as shown in the following incremental code.\\n\\n\", \"\\nThe AddPolicyHandler() method is what adds policies to the HttpClient objects you\\u2019ll use. In this c\", \"ase,\\nit\\u2019s adding a Polly policy for a circuit breaker.\\n\\n\\nTo have a more modular approach, the Circui\", \"t Breaker Policy is defined in a separate method called\\nGetCircuitBreakerPolicy(), as shown in the f\", \"ollowing code:\\n\\n\\nIn the code example above, the circuit breaker policy is configured so it breaks or\", \" opens the circuit\\nwhen there have been five consecutive faults when retrying the Http requests. Whe\", \"n that happens,\\nthe circuit will break for 30 seconds: in that period, calls will be failed immediat\", \"ely by the circuit[breaker rather than actually be placed. The policy automatically interprets relev\", \"ant exceptions and](https://docs.microsoft.com/aspnet/core/fundamentals/http-requests#handle-transie\", \"nt-faults)\\n[HTTP status codes](https://docs.microsoft.com/aspnet/core/fundamentals/http-requests#han\", \"dle-transient-faults) as faults.\\n\\n\\nCircuit breakers should also be used to redirect requests to a fa\", \"llback infrastructure if you had issues\\nin a particular resource that\\u2019s deployed in a different envi\", \"ronment than the client application or\\n\\n\\n307 CHAPTER 7 | Implement resilient applications\\n\\n\\nservice \", \"that\\u2019s performing the HTTP call. That way, if there\\u2019s an outage in the datacenter that impacts\\nonly \", \"your backend microservices but not your client applications, the client applications can redirect\\n[t\", \"o the fallback services. Polly is planning a new policy to automate this failover policy scenario.](\", \"https://github.com/App-vNext/Polly/wiki/Polly-Roadmap#failover-policy)\\n\\n\\nAll those features are for \", \"cases where you\\u2019re managing the failover from within the .NET code, as\\nopposed to having it managed \", \"automatically for you by Azure, with location transparency.\\n\\n\\nFrom a usage point of view, when using\", \" HttpClient, there\\u2019s no need to add anything new here\\nbecause the code is the same than when using H\", \"ttpClient with IHttpClientFactory, as shown in\\nprevious sections.\\n\\n#### **Test Http retries and circ\", \"uit breakers in eShopOnContainers**\\n\\n\\nWhenever you start the eShopOnContainers solution in a Docker \", \"host, it needs to start multiple\\ncontainers. Some of the containers are slower to start and initiali\", \"ze, like the SQL Server container. This\\nis especially true the first time you deploy the eShopOnCont\", \"ainers application into Docker because it\\nneeds to set up the images and the database. The fact that\", \" some containers start slower than others\\ncan cause the rest of the services to initially throw HTTP\", \" exceptions, even if you set dependencies\\nbetween containers at the docker-compose level, as explain\", \"ed in previous sections. Those dockercompose dependencies between containers are just at the process\", \" level. The container\\u2019s entry point\\nprocess might be started, but SQL Server might not be ready for \", \"queries. The result can be a cascade\\nof errors, and the application can get an exception when trying\", \" to consume that particular container.\\n\\n\\nYou might also see this type of error on startup when the a\", \"pplication is deploying to the cloud. In that\\ncase, orchestrators might be moving containers from on\", \"e node or VM to another (that is, starting new\\ninstances) when balancing the number of containers ac\", \"ross the cluster\\u2019s nodes.\\n\\n\\nThe way \\u2018eShopOnContainers\\u2019 solves those issues when starting all the co\", \"ntainers is by using the Retry\\npattern illustrated earlier.\\n\\n\\n**Test the circuit breaker in eShopOnC\", \"ontainers**\\n\\n\\nThere are a few ways you can break/open the circuit and test it with eShopOnContainers\", \".\\n\\n\\nOne option is to lower the allowed number of retries to 1 in the circuit breaker policy and rede\", \"ploy\\nthe whole solution into Docker. With a single retry, there\\u2019s a good chance that an HTTP request\", \" will\\nfail during deployment, the circuit breaker will open, and you get an error.\\n\\n\\nAnother option \", \"is to use custom middleware that\\u2019s implemented in the **Basket** microservice. When\\nthis middleware \", \"is enabled, it catches all HTTP requests and returns status code 500. You can enable\\nthe middleware \", \"by making a GET request to the failing URI, like the following:\\n\\n\\n  - GET http://localhost:5103/fail\", \"ing\\nThis request returns the current state of the middleware. If the middleware is enabled, the\\nrequ\", \"est return status code 500. If the middleware is disabled, there\\u2019s no response.\\n\\n\\n  - GET http://loc\", \"alhost:5103/failing?enable\\nThis request enables the middleware.\\n\\n\\n308 CHAPTER 7 | Implement resilien\", \"t applications\\n\\n\\n  - GET http://localhost:5103/failing?disable\\nThis request disables the middleware.\", \"\\n\\n\\nFor instance, once the application is running, you can enable the middleware by making a request\\n\", \"using the following URI in any browser. Note that the ordering microservice uses port 5103.\\n\\n\\nhttp:/\", \"/localhost:5103/failing?enable\\n\\n\\nYou can then check the status using the URI http://localhost:5103/f\", \"ailing, as shown in Figure 8-5.\\n\\n\\n_Figure 8-5. Checking the state of the \\u201cFailing\\u201d ASP.NET middlewar\", \"e \\u2013 In this case, disabled._\\n\\n\\nAt this point, the Basket microservice responds with status code 500 \", \"whenever you call invoke it.\\n\\n\\nOnce the middleware is running, you can try making an order from the \", \"MVC web application. Because\\nthe requests fail, the circuit will open.\\n\\n\\nIn the following example, y\", \"ou can see that the MVC web application has a catch block in the logic for\\nplacing an order. If the \", \"code catches an open-circuit exception, it shows the user a friendly message\\ntelling them to wait.\\n\\n\", \"\\nHere\\u2019s a summary. The Retry policy tries several times to make the HTTP request and gets HTTP error\", \"s.\\nWhen the number of retries reaches the maximum number set for the Circuit Breaker policy (in this\", \"\\ncase, 5), the application throws a BrokenCircuitException. The result is a friendly message, as sho\", \"wn in\\nFigure 8-6.\\n\\n\\n309 CHAPTER 7 | Implement resilient applications\\n\\n\\n_Figure 8-6. Circuit breaker \", \"returning an error to the UI_\\n\\n\\nYou can implement different logic for when to open/break the circuit\", \". Or you can try an HTTP request\\nagainst a different back-end microservice if there\\u2019s a fallback dat\", \"acenter or redundant back-end\\nsystem.\\n\\n\\nFinally, another possibility for the CircuitBreakerPolicy is\", \" to use Isolate (which forces open and holds\\nopen the circuit) and Reset (which closes it again). Th\", \"ese could be used to build a utility HTTP\\nendpoint that invokes Isolate and Reset directly on the po\", \"licy. Such an HTTP endpoint could also be\\nused, suitably secured, in production for temporarily isol\", \"ating a downstream system, such as when\\nyou want to upgrade it. Or it could trip the circuit manuall\", \"y to protect a downstream system you\\nsuspect to be faulting.\\n\\n#### **Additional resources**\\n\\n\\n  - **\", \"Circuit Breaker pattern**\\n[https://learn.microsoft.com/azure/architecture/patterns/circuit-breaker](\", \"https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker)\\n\\n### Health monitoring\\n\\n\\nHea\", \"lth monitoring can allow near-real-time information about the state of your containers and\\nmicroserv\", \"ices. Health monitoring is critical to multiple aspects of operating microservices and is\\nespecially\", \" important when orchestrators perform partial application upgrades in phases, as explained\\nlater.\\n\\n\\n\", \"Microservices-based applications often use heartbeats or health checks to enable their performance\\nm\", \"onitors, schedulers, and orchestrators to keep track of the multitude of services. If services canno\", \"t\\nsend some sort of \\u201cI\\u2019m alive\\u201d signal, either on demand or on a schedule, your application might fa\", \"ce\\nrisks when you deploy updates, or it might just detect failures too late and not be able to stop\\n\", \"cascading failures that can end up in major outages.\\n\\n\\nIn the typical model, services send reports a\", \"bout their status, and that information is aggregated to\\nprovide an overall view of the state of hea\", \"lth of your application. If you\\u2019re using an orchestrator, you\\ncan provide health information to your\", \" orchestrator\\u2019s cluster, so that the cluster can act accordingly. If\\nyou invest in high-quality heal\", \"th reporting that\\u2019s customized for your application, you can detect and\\nfix issues for your running \", \"application much more easily.\\n\\n\\n310 CHAPTER 7 | Implement resilient applications\\n\\n\\n#### **Implement \", \"health checks in ASP.NET Core services**\\n\\nWhen developing an ASP.NET Core microservice or web applic\", \"ation, you can use the built-in health\\nchecks feature that was released in ASP .NET Core 2.2\\n[(Micro\", \"soft.Extensions.Diagnostics.HealthChecks). Like many ASP.NET Core features, health checks](https://w\", \"ww.nuget.org/packages/Microsoft.Extensions.Diagnostics.HealthChecks)\\ncome with a set of services and\", \" a middleware.\\n\\n\\nHealth check services and middleware are easy to use and provide capabilities that \", \"let you validate if\\nany external resource needed for your application (like a SQL Server database or\", \" a remote API) is\\nworking properly. When you use this feature, you can also decide what it means tha\", \"t the resource is\\nhealthy, as we explain later.\\n\\n\\nTo use this feature effectively, you need to first\", \" configure services in your microservices. Second, you\\nneed a front-end application that queries for\", \" the health reports. That front-end application could be a\\ncustom reporting application, or it could\", \" be an orchestrator itself that can react accordingly to the\\nhealth states.\\n\\n\\n**Use the HealthChecks\", \" feature in your back-end ASP.NET microservices**\\n\\n\\nIn this section, you\\u2019ll learn how to implement t\", \"he HealthChecks feature in a sample ASP.NET Core 7.0\\n[Web API application when using the Microsoft.E\", \"xtensions.Diagnostics.HealthChecks](https://www.nuget.org/packages/Microsoft.Extensions.Diagnostics.\", \"HealthChecks) package. The\\nImplementation of this feature in a large-scale microservices like the eS\", \"hopOnContainers is explained\\nin the next section.\\n\\n\\nTo begin, you need to define what constitutes a \", \"healthy status for each microservice. In the sample\\napplication, we define the microservice is healt\", \"hy if its API is accessible via HTTP and its related SQL\\nServer database is also available.\\n\\n\\nIn .NE\", \"T 7, with the built-in APIs, you can configure the services, add a Health Check for the\\nmicroservice\", \" and its dependent SQL Server database in this way:\\n\\n\\nIn the previous code, the services.AddHealthCh\", \"ecks() method configures a basic HTTP check that\\nreturns a status code **200** with \\u201cHealthy\\u201d. Furth\", \"er, the AddCheck() extension method configures a\\ncustom SqlConnectionHealthCheck that checks the rel\", \"ated SQL Database\\u2019s health.\\n\\n\\nThe AddCheck() method adds a new health check with a specified name an\", \"d the implementation of\\ntype IHealthCheck. You can add multiple Health Checks using AddCheck method,\", \" so a microservice\\nwon\\u2019t provide a \\u201chealthy\\u201d status until all its checks are healthy.\\n\\n\\n311 CHAPTER \", \"7 | Implement resilient applications\\n\\n\\nSqlConnectionHealthCheck is a custom class that implements IH\", \"ealthCheck, which takes a connection\\nstring as a constructor parameter and executes a simple query t\", \"o check if the connection to the SQL\\ndatabase is successful. It returns HealthCheckResult.Healthy() \", \"if the query was executed successfully\\nand a FailureStatus with the actual exception when it fails.\\n\", \"\\n\\nNote that in the previous code, Select 1 is the query used to check the Health of the database. To\", \"\\nmonitor the availability of your microservices, orchestrators like Kubernetes periodically perform\\n\", \"health checks by sending requests to test the microservices. It\\u2019s important to keep your database\\nqu\", \"eries efficient so that these operations are quick and don\\u2019t result in a higher utilization of resou\", \"rces.\\n\\n\\n312 CHAPTER 7 | Implement resilient applications\\n\\n\\nFinally, add a middleware that responds t\", \"o the url path /hc:\\n\\n\\nWhen the endpoint <yourmicroservice>/hc is invoked, it runs all the health che\", \"cks that are configured\\nin the AddHealthChecks() method in the Startup class and shows the result.\\n\\n\", \"\\n**HealthChecks implementation in eShopOnContainers**\\n\\n\\nMicroservices in eShopOnContainers rely on m\", \"ultiple services to perform its task. For example, the\\nCatalog.API microservice from eShopOnContaine\", \"rs depends on many services, such as Azure Blob\\nStorage, SQL Server, and RabbitMQ. Therefore, it has\", \" several health checks added using the\\nAddCheck() method. For every dependent service, a custom IHea\", \"lthCheck implementation that\\ndefines its respective health status would need to be added.\\n\\n\\n[The ope\", \"n-source project AspNetCore.Diagnostics.HealthChecks](https://github.com/Xabaril/AspNetCore.Diagnost\", \"ics.HealthChecks) solves this problem by providing\\ncustom health check implementations for each of t\", \"hese enterprise services, that are built on top of\\n.NET 7. Each health check is available as an indi\", \"vidual NuGet package that can be easily added to the\\nproject. eShopOnContainers uses them extensivel\", \"y in all its microservices.\\n\\n\\nFor instance, in the Catalog.API microservice, the following NuGet pac\", \"kages were added:\\n\\n\\n_Figure 8-7. Custom Health Checks implemented in Catalog.API using AspNetCore.Di\", \"agnostics.HealthChecks_\\n\\n\\nIn the following code, the health check implementations are added for each\", \" dependent service and\\nthen the middleware is configured:\\n\\n\\n313 CHAPTER 7 | Implement resilient appl\", \"ications\\n\\n\\nFinally, add the HealthCheck middleware to listen to \\u201c/hc\\u201d endpoint:\\n\\n\\n**Query your micro\", \"services to report about their health status**\\n\\n\\nWhen you\\u2019ve configured health checks as described i\", \"n this article and you have the microservice\\nrunning in Docker, you can directly check from a browse\", \"r if it\\u2019s healthy. You have to publish the\\ncontainer port in the Docker host, so you can access the \", \"container through the external Docker host IP\\nor through host.docker.internal, as shown in figure 8-\", \"8.\\n\\n\\n314 CHAPTER 7 | Implement resilient applications\\n\\n\\n_Figure 8-8. Checking health status of a sin\", \"gle service from a browser_\\n\\n\\nIn that test, you can see that the Catalog.API microservice (running o\", \"n port 5101) is healthy, returning\\nHTTP status 200 and status information in JSON. The service also \", \"checked the health of its SQL Server\\ndatabase dependency and RabbitMQ, so the health check reported \", \"itself as healthy.\\n\\n#### **Use watchdogs**\\n\\n\\nA watchdog is a separate service that can watch health \", \"and load across services, and report health\\nabout the microservices by querying with the HealthCheck\", \"s library introduced earlier. This can help\\nprevent errors that would not be detected based on the v\", \"iew of a single service. Watchdogs also are a\\ngood place to host code that can perform remediation a\", \"ctions for known conditions without user\\ninteraction.\\n\\n\\nThe eShopOnContainers sample contains a web \", \"page that displays sample health check reports, as\\nshown in Figure 8-9. This is the simplest watchdo\", \"g you could have since it only shows the state of the\\nmicroservices and web applications in eShopOnC\", \"ontainers. Usually a watchdog also takes actions\\nwhen it detects unhealthy states.\\n\\n\\n[Fortunately, A\", \"spNetCore.Diagnostics.HealthChecks also provides AspNetCore.HealthChecks.UI NuGet](https://github.co\", \"m/Xabaril/AspNetCore.Diagnostics.HealthChecks)\\npackage that can be used to display the health check \", \"results from the configured URIs.\\n\\n\\n315 CHAPTER 7 | Implement resilient applications\\n\\n\\n_Figure 8-9. \", \"Sample health check report in eShopOnContainers_\\n\\n\\nIn summary, this watchdog service queries each mi\", \"croservice\\u2019s \\u201c/hc\\u201d endpoint. This will execute all the\\nhealth checks defined within it and return an\", \" overall health state depending on all those checks. The\\nHealthChecksUI is easy to consume with a fe\", \"w configuration entries and two lines of code that needs\\nto be added into the _Startup.cs_ of the wa\", \"tchdog service.\\n\\n\\nSample configuration file for health check UI:\\n\\n\\n_Program.cs_ file that adds Healt\", \"hChecksUI:\\n\\n\\n316 CHAPTER 7 | Implement resilient applications\\n\\n\\n#### **Health checks when using orch\", \"estrators**\\n\\nTo monitor the availability of your microservices, orchestrators like Kubernetes and Se\", \"rvice Fabric\\nperiodically perform health checks by sending requests to test the microservices. When \", \"an\\norchestrator determines that a service/container is unhealthy, it stops routing requests to that\\n\", \"instance. It also usually creates a new instance of that container.\\n\\n\\nFor instance, most orchestrato\", \"rs can use health checks to manage zero-downtime deployments. Only\\nwhen the status of a service/cont\", \"ainer changes to healthy will the orchestrator start routing traffic to\\nservice/container instances.\", \"\\n\\n\\nHealth monitoring is especially important when an orchestrator performs an application upgrade.\\nS\", \"ome orchestrators (like Azure Service Fabric) update services in phases\\u2014for example, they might\\nupda\", \"te one-fifth of the cluster surface for each application upgrade. The set of nodes that\\u2019s upgraded\\na\", \"t the same time is referred to as an _upgrade domain_ . After each upgrade domain has been upgraded\\n\", \"and is available to users, that upgrade domain must pass health checks before the deployment moves\\nt\", \"o the next upgrade domain.\\n\\n\\nAnother aspect of service health is reporting metrics from the service.\", \" This is an advanced capability of\\nthe health model of some orchestrators, like Service Fabric. Metr\", \"ics are important when using an\\norchestrator because they are used to balance resource usage. Metric\", \"s also can be an indicator of\\nsystem health. For example, you might have an application that has man\", \"y microservices, and each\\ninstance reports a requests-per-second (RPS) metric. If one service is usi\", \"ng more resources (memory,\\nprocessor, etc.) than another service, the orchestrator could move servic\", \"e instances around in the\\ncluster to try to maintain even resource utilization.\\n\\n\\n[Note that Azure S\", \"ervice Fabric provides its own Health Monitoring model, which is more advanced](https://docs.microso\", \"ft.com/azure/service-fabric/service-fabric-health-introduction)\\nthan simple health checks.\\n\\n#### **A\", \"dvanced monitoring: visualization, analysis, and alerts**\\n\\n\\nThe final part of monitoring is visualiz\", \"ing the event stream, reporting on service performance, and\\nalerting when an issue is detected. You \", \"can use different solutions for this aspect of monitoring.\\n\\n\\nYou can use simple custom applications \", \"showing the state of your services, like the custom page\\n[shown when explaining the AspNetCore.Diagn\", \"ostics.HealthChecks. Or you could use more advanced](https://github.com/Xabaril/AspNetCore.Diagnosti\", \"cs.HealthChecks)\\n[tools like Azure Monitor](https://azure.microsoft.com/services/monitor/) to raise \", \"alerts based on the stream of events.\\n\\n\\nFinally, if you\\u2019re storing all the event streams, you can us\", \"e Microsoft Power BI or other solutions like\\nKibana or Splunk to visualize the data.\\n\\n\\n317 CHAPTER 7\", \" | Implement resilient applications\\n\\n\\n#### **Additional resources**\\n\\n\\n  - **HealthChecks and HealthC\", \"hecks UI for ASP.NET Core**\\n[https://github.com/Xabaril/AspNetCore.Diagnostics.HealthChecks](https:/\", \"/github.com/Xabaril/AspNetCore.Diagnostics.HealthChecks)\\n\\n\\n  - **Introduction to Service Fabric heal\", \"th monitoring**\\n[https://learn.microsoft.com/azure/service-fabric/service-fabric-health-introduction\", \"](https://docs.microsoft.com/azure/service-fabric/service-fabric-health-introduction)\\n\\n\\n  - **Azure \", \"Monitor**\\n[https://azure.microsoft.com/services/monitor/](https://azure.microsoft.com/services/monit\", \"or/)\\n\\n\\n318 CHAPTER 7 | Implement resilient applications\\n\\n\\n**CHAPTER**\\n# 8\\n\\n## Make secure .NET Micro\", \"services and Web Applications\\n\\n\\nThere are so many aspects about security in microservices and web ap\", \"plications that the topic could\\neasily take several books like this one. So, in this section, we\\u2019ll \", \"focus on authentication, authorization,\\nand application secrets.\\n\\n### Implement authentication in .N\", \"ET microservices and web applications\\n\\n\\nIt\\u2019s often necessary for resources and APIs published by a s\", \"ervice to be limited to certain trusted users\\nor clients. The first step to making these sorts of AP\", \"I-level trust decisions is authentication.\\nAuthentication is the process of reliably verifying a use\", \"r\\u2019s identity.\\n\\n\\nIn microservice scenarios, authentication is typically handled centrally. If you\\u2019re \", \"using an API Gateway,\\nthe gateway is a good place to authenticate, as shown in Figure 9-1. If you us\", \"e this approach, make\\nsure that the individual microservices cannot be reached directly (without the\", \" API Gateway) unless\\nadditional security is in place to authenticate messages whether they come from\", \" the gateway or not.\\n\\n\\n_Figure 9-1. Centralized authentication with an API Gateway_\\n\\n\\nWhen the API G\", \"ateway centralizes authentication, it adds user information when forwarding requests\\nto the microser\", \"vices. If services can be accessed directly, an authentication service like Azure Active\\n\\n\\n319 CHAPT\", \"ER 8 | Make secure .NET Microservices and Web Applications\\n\\n\\nDirectory or a dedicated authentication\", \" microservice acting as a security token service (STS) can be\\nused to authenticate users. Trust deci\", \"sions are shared between services with security tokens or\\ncookies. (These tokens can be shared betwe\", \"en ASP.NET Core applications, if needed, by implementing\\n[cookie sharing.) This pattern is illustrat\", \"ed in Figure 9-2.](https://docs.microsoft.com/aspnet/core/security/cookie-sharing)\\n\\n\\n_Figure 9-2. Au\", \"thentication by identity microservice; trust is shared using an authorization token_\\n\\n\\nWhen microser\", \"vices are accessed directly, trust, that includes authentication and authorization, is\\nhandled by a \", \"security token issued by a dedicated microservice, shared between microservices.\\n\\n#### **Authenticat\", \"e with ASP.NET Core Identity**\\n\\n\\n[The primary mechanism in ASP.NET Core for identifying an applicati\", \"on\\u2019s users is the ASP.NET Core](https://docs.microsoft.com/aspnet/core/security/authentication/ident\", \"ity)\\n[Identity](https://docs.microsoft.com/aspnet/core/security/authentication/identity) membership \", \"system. ASP.NET Core Identity stores user information (including sign-in\\ninformation, roles, and cla\", \"ims) in a data store configured by the developer. Typically, the ASP.NET\\nCore Identity data store is\", \" an Entity Framework store provided in the\\nMicrosoft.AspNetCore.Identity.EntityFrameworkCore package\", \". However, custom stores or other thirdparty packages can be used to store identity information in A\", \"zure Table Storage, CosmosDB, or other\\nlocations.\\n\\n\\n\\n\\n\\nThe following code is taken from the ASP.NET \", \"Core Web Application MVC 3.1 project template with\\nindividual user account authentication selected. \", \"It shows how to configure ASP.NET Core Identity\\nusing Entity Framework Core in the _Program.cs_ file\", \".\\n\\n\\n320 CHAPTER 8 | Make secure .NET Microservices and Web Applications\\n\\n\\nUsing ASP.NET Core Identit\", \"y enables several scenarios:\\n\\n\\n  - Create new user information using the UserManager type (userManag\", \"er.CreateAsync).\\n\\n\\n  - Authenticate users using the SignInManager type. You can use signInManager.Si\", \"gnInAsync to\\nsign in directly, or signInManager.PasswordSignInAsync to confirm the user\\u2019s password i\", \"s\\ncorrect and then sign them in.\\n\\n\\n  - Identify a user based on information stored in a cookie (whic\", \"h is read by ASP.NET Core\\nIdentity middleware) so that subsequent requests from a browser will inclu\", \"de a signed-in\\nuser\\u2019s identity and claims.\\n\\n\\n[ASP.NET Core Identity also supports two-factor authent\", \"ication.](https://docs.microsoft.com/aspnet/core/security/authentication/2fa)\\n\\n\\nFor authentication s\", \"cenarios that make use of a local user data store and that persist identity between\\nrequests using c\", \"ookies (as is typical for MVC web applications), ASP.NET Core Identity is a\\nrecommended solution.\\n\\n#\", \"### **Authenticate with external providers**\\n\\n\\n[ASP.NET Core also supports using external authentica\", \"tion providers](https://docs.microsoft.com/aspnet/core/security/authentication/social/) [to let user\", \"s sign in via OAuth 2.0](https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2\", \")\\nflows. This means that users can sign in using existing authentication processes from providers li\", \"ke\\nMicrosoft, Google, Facebook, or Twitter and associate those identities with an ASP.NET Core ident\", \"ity\\nin your application.\\n\\n\\nTo use external authentication, besides including the authentication midd\", \"leware as mentioned before,\\nusing the app.UseAuthentication() method, you also have to register the \", \"external provider in\\n_Program.cs_ as shown in the following example:\\n\\n\\n321 CHAPTER 8 | Make secure .\", \"NET Microservices and Web Applications\\n\\n\\nPopular external authentication providers and their associa\", \"ted NuGet packages are shown in the\\nfollowing table:\\n\\n|Provider|Package|\\n|---|---|\\n|**Microsoft**|**\", \"Microsoft.AspNetCore.Authentication.MicrosoftAccount**|\\n|**Google**|**Microsoft.AspNetCore.Authentic\", \"ation.Google**|\\n|**Facebook**|**Microsoft.AspNetCore.Authentication.Facebook**|\\n|**Twitter**|**Micro\", \"soft.AspNetCore.Authentication.Twitter**|\\n\\n\\n\\nIn all cases, you must complete an application registra\", \"tion procedure that is vendor dependent and\\nthat usually involves:\\n\\n\\n1. Getting a Client Application\", \" ID.\\n\\n2. Getting a Client Application Secret.\\n\\n3. Configuring a redirection URL, that\\u2019s handled by t\", \"he authorization middleware and the\\nregistered provider\\n\\n4. Optionally, configuring a sign-out URL t\", \"o properly handle sign out in a Single Sign On (SSO)\\nscenario.\\n\\n\\n[For details on configuring your ap\", \"p for an external provider, see the External provider authentication](https://docs.microsoft.com/asp\", \"net/core/security/authentication/social/)\\n[in the ASP.NET Core documentation).](https://docs.microso\", \"ft.com/aspnet/core/security/authentication/social/)\\n\\n\\n\\n\\n\\n322 CHAPTER 8 | Make secure .NET Microservi\", \"ces and Web Applications\\n\\n\\n_Figure 9-3. Selecting the Individual User Accounts option, for using ext\", \"ernal authentication, when creating a web_\\n_application project in Visual Studio 2019._\\n\\n\\nIn additio\", \"n to the external authentication providers listed previously, third-party packages are\\navailable tha\", \"t provide middleware for using many more external authentication providers. For a list,\\n[see the Asp\", \"Net.Security.OAuth.Providers repository on GitHub.](https://github.com/aspnet-contrib/AspNet.Securit\", \"y.OAuth.Providers/tree/dev/src)\\n\\n\\nYou can also create your own external authentication middleware to\", \" solve some special need.\\n\\n#### **Authenticate with bearer tokens**\\n\\n\\nAuthenticating with ASP.NET Co\", \"re Identity (or Identity plus external authentication providers) works\\nwell for many web application\", \" scenarios in which storing user information in a cookie is appropriate.\\nIn other scenarios, though,\", \" cookies are not a natural means of persisting and transmitting data.\\n\\n\\nFor example, in an ASP.NET C\", \"ore Web API that exposes RESTful endpoints that might be accessed by\\nSingle Page Applications (SPAs)\", \", by native clients, or even by other Web APIs, you typically want to\\nuse bearer token authenticatio\", \"n instead. These types of applications do not work with cookies, but\\ncan easily retrieve a bearer to\", \"ken and include it in the authorization header of subsequent requests.\\n[To enable token authenticati\", \"on, ASP.NET Core supports several options for using OAuth 2.0 and](https://oauth.net/2/)\\n[OpenID Con\", \"nect.](https://openid.net/connect/)\\n\\n\\n323 CHAPTER 8 | Make secure .NET Microservices and Web Applica\", \"tions\\n\\n\\n#### **Authenticate with an OpenID Connect or OAuth 2.0 Identity provider**\\n\\nIf user informa\", \"tion is stored in Azure Active Directory or another identity solution that supports\\nOpenID Connect o\", \"r OAuth 2.0, you can use the\\n**Microsoft.AspNetCore.Authentication.OpenIdConnect** package to authen\", \"ticate using the OpenID\\nConnect workflow. For example, to authenticate to the Identity.Api microserv\", \"ice in\\neShopOnContainers, an ASP.NET Core web application can use middleware from that package as\\nsh\", \"own in the following simplified example in _Program.cs_ :\\n\\n\\nWhen you use this workflow, the ASP.NET \", \"Core Identity middleware is not needed, because all user\\ninformation storage and authentication is h\", \"andled by the Identity service.\\n\\n\\n324 CHAPTER 8 | Make secure .NET Microservices and Web Application\", \"s\\n\\n\\n#### **Issue security tokens from an ASP.NET Core service**\\n\\nIf you prefer to issue security tok\", \"ens for local ASP.NET Core Identity users rather than using an\\nexternal identity provider, you can t\", \"ake advantage of some good third-party libraries.\\n\\n\\n[IdentityServer4](https://github.com/IdentitySer\", \"ver/IdentityServer4) [and OpenIddict are OpenID Connect providers that integrate easily with ASP.NET\", \" Core](https://github.com/openiddict/openiddict-core)\\n[Identity to let you issue security tokens fro\", \"m an ASP.NET Core service. The IdentityServer4](https://identityserver4.readthedocs.io/en/latest/)\\n[\", \"documentation](https://identityserver4.readthedocs.io/en/latest/) has in-depth instructions for usin\", \"g the library. However, the basic steps to using\\nIdentityServer4 to issue tokens are as follows.\\n\\n\\n1\", \". You configure IdentityServer4 in _Program.cs_ by making a call to\\nbuilder.Services.AddIdentityServ\", \"er.\\n\\n\\n2. You call app.UseIdentityServer in _Program.cs_ to add IdentityServer4 to the application\\u2019s \", \"HTTP\\nrequest processing pipeline. This lets the library serve requests to OpenID Connect and\\nOAuth2 \", \"endpoints like /connect/token.\\n\\n\\n3. You configure identity server by setting the following data:\\n\\n\\n \", \"    - [The credentials to use for signing.](https://identityserver4.readthedocs.io/en/latest/topics/\", \"crypto.html)\\n\\n\\n     - [The Identity and API resources that users might request access to:](https://i\", \"dentityserver4.readthedocs.io/en/latest/topics/resources.html)\\n\\n\\n           - API resources represen\", \"t protected data or functionality that a user can access\\nwith an access token. An example of an API \", \"resource would be a web API (or\\nset of APIs) that requires authorization.\\n\\n\\n           - Identity re\", \"sources represent information (claims) that are given to a client to\\nidentify a user. The claims mig\", \"ht include the user name, email address, and so\\non.\\n\\n\\n     - [The clients that will be connecting in\", \" order to request tokens.](https://identityserver4.readthedocs.io/en/latest/topics/clients.html)\\n\\n\\n \", \"    - [The storage mechanism for user information, such as ASP.NET Core Identity or an](https://iden\", \"tityserver4.readthedocs.io/en/latest/quickstarts/0_overview.html)\\nalternative.\\n\\n\\n[When you specify c\", \"lients and resources for IdentityServer4 to use, you can pass an IEnumerable](https://docs.microsoft\", \".com/dotnet/api/system.collections.generic.ienumerable-1)\\ncollection of the appropriate type to meth\", \"ods that take in-memory client or resource stores. Or for\\nmore complex scenarios, you can provide cl\", \"ient or resource provider types via Dependency Injection.\\n\\n\\nA sample configuration for IdentityServe\", \"r4 to use in-memory resources and clients provided by a\\ncustom IClientStore type might look like the\", \" following example:\\n\\n\\n325 CHAPTER 8 | Make secure .NET Microservices and Web Applications\\n\\n\\n#### **C\", \"onsume security tokens**\\n\\nAuthenticating against an OpenID Connect endpoint or issuing your own secu\", \"rity tokens covers some\\nscenarios. But what about a service that simply needs to limit access to tho\", \"se users who have valid\\nsecurity tokens that were provided by a different service?\\n\\n\\nFor that scenar\", \"io, authentication middleware that handles JWT tokens is available in the\\n**Microsoft.AspNetCore.Aut\", \"hentication.JwtBearer** [package. JWT stands for \\u201cJSON Web Token\\u201d and](https://tools.ietf.org/html/r\", \"fc7519)\\nis a common security token format (defined by RFC 7519) for communicating security claims. A\", \"\\nsimplified example of how to use middleware to consume such tokens might look like this code\\nfragme\", \"nt, taken from the Ordering.Api microservice of eShopOnContainers.\\n\\n\\nThe parameters in this usage ar\", \"e:\\n\\n\\n  - Audience represents the receiver of the incoming token or the resource that the token grant\", \"s\\naccess to. If the value specified in this parameter does not match the parameter in the token,\\nthe\", \" token will be rejected.\\n\\n\\n  - Authority is the address of the token-issuing authentication server. \", \"The JWT bearer\\nauthentication middleware uses this URI to get the public key that can be used to val\", \"idate the\\ntoken\\u2019s signature. The middleware also confirms that the iss parameter in the token matche\", \"s\\nthis URI.\\n\\n\\nAnother parameter, RequireHttpsMetadata, is useful for testing purposes; you set this \", \"parameter to\\nfalse so you can test in environments where you don\\u2019t have certificates. In real-world \", \"deployments,\\nJWT bearer tokens should always be passed only over HTTPS.\\n\\n\\n326 CHAPTER 8 | Make secur\", \"e .NET Microservices and Web Applications\\n\\n\\nWith this middleware in place, JWT tokens are automatica\", \"lly extracted from authorization headers.\\nThey are then deserialized, validated (using the values in\", \" the Audience and Authority parameters), and\\nstored as user information to be referenced later by MV\", \"C actions or authorization filters.\\n\\n\\nThe JWT bearer authentication middleware can also support more\", \" advanced scenarios, such as using a\\nlocal certificate to validate a token if the authority is not a\", \"vailable. For this scenario, you can specify a\\nTokenValidationParameters object in the JwtBearerOpti\", \"ons object.\\n\\n### Additional resources\\n\\n\\n  - **Sharing cookies between applications**\\n[https://learn.\", \"microsoft.com/aspnet/core/security/cookie-sharing](https://docs.microsoft.com/aspnet/core/security/c\", \"ookie-sharing)\\n\\n\\n  - **Introduction to Identity**\\n[https://learn.microsoft.com/aspnet/core/security/\", \"authentication/identity](https://docs.microsoft.com/aspnet/core/security/authentication/identity)\\n\\n\\n\", \"  - **Rick Anderson. Two-factor authentication with SMS**\\n[https://learn.microsoft.com/aspnet/core/s\", \"ecurity/authentication/2fa](https://docs.microsoft.com/aspnet/core/security/authentication/2fa)\\n\\n\\n  \", \"- **Enabling authentication using Facebook, Google and other external providers**\\n[https://learn.mic\", \"rosoft.com/aspnet/core/security/authentication/social/](https://docs.microsoft.com/aspnet/core/secur\", \"ity/authentication/social/)\\n\\n\\n  - **Michell Anicas. An Introduction to OAuth 2**\\n[https://www.digita\", \"locean.com/community/tutorials/an-introduction-to-oauth-2](https://www.digitalocean.com/community/tu\", \"torials/an-introduction-to-oauth-2)\\n\\n\\n  - **AspNet.Security.OAuth.Providers** (GitHub repo for ASP.N\", \"ET OAuth providers)\\n[https://github.com/aspnet-contrib/AspNet.Security.OAuth.Providers/tree/dev/src]\", \"(https://github.com/aspnet-contrib/AspNet.Security.OAuth.Providers/tree/dev/src)\\n\\n\\n  - **IdentitySer\", \"ver4. Official documentation**\\n[https://identityserver4.readthedocs.io/en/latest/](https://identitys\", \"erver4.readthedocs.io/en/latest/)\\n\\n### About authorization in .NET microservices and web application\", \"s\\n\\n\\nAfter authentication, ASP.NET Core Web APIs need to authorize access. This process allows a serv\", \"ice\\n[to make APIs available to some authenticated users, but not to all. Authorization](https://docs\", \".microsoft.com/aspnet/core/security/authorization/introduction) can be done based\\non users\\u2019 roles or\", \" based on custom policy, which might include inspecting claims or other heuristics.\\n\\n\\nRestricting ac\", \"cess to an ASP.NET Core MVC route is as easy as applying an Authorize attribute to the\\naction method\", \" (or to the controller\\u2019s class if all the controller\\u2019s actions require authorization), as\\nshown in f\", \"ollowing example:\\n\\n\\n327 CHAPTER 8 | Make secure .NET Microservices and Web Applications\\n\\n\\nBy default\", \", adding an Authorize attribute without parameters will limit access to authenticated users\\nfor that\", \" controller or action. To further restrict an API to be available for only specific users, the\\nattri\", \"bute can be expanded to specify required roles or policies that users must satisfy.\\n\\n#### **Implemen\", \"t role-based authorization**\\n\\n\\nASP.NET Core Identity has a built-in concept of roles. In addition to\", \" users, ASP.NET Core Identity\\nstores information about different roles used by the application and k\", \"eeps track of which users are\\nassigned to which roles. These assignments can be changed programmatic\", \"ally with the RoleManager\\ntype that updates roles in persisted storage, and the UserManager type tha\", \"t can grant or revoke roles\\nfrom users.\\n\\n\\nIf you\\u2019re authenticating with JWT bearer tokens, the ASP.N\", \"ET Core JWT bearer authentication\\nmiddleware will populate a user\\u2019s roles based on role claims found\", \" in the token. To limit access to an\\nMVC action or controller to users in specific roles, you can in\", \"clude a Roles parameter in the Authorize\\nannotation (attribute), as shown in the following code frag\", \"ment:\\n\\n\\nIn this example, only users in the Administrator or PowerUser roles can access APIs in the\\nC\", \"ontrolPanel controller (such as executing the SetTime action). The ShutDown API is further restricte\", \"d\\nto allow access only to users in the Administrator role.\\n\\n\\nTo require a user be in multiple roles,\", \" you use multiple Authorize attributes, as shown in the following\\nexample:\\n\\n\\nIn this example, to cal\", \"l API1, a user must:\\n\\n\\n  - Be in the Administrator _or_ PowerUser role, _and_\\n\\n\\n  - Be in the Remote\", \"Employee role, _and_\\n\\n\\n328 CHAPTER 8 | Make secure .NET Microservices and Web Applications\\n\\n\\n  - Sat\", \"isfy a custom handler for CustomPolicy authorization.\\n\\n#### **Implement policy-based authorization**\", \"\\n\\n\\n[Custom authorization rules can also be written using authorization policies. This section provid\", \"es an](https://docs.asp.net/en/latest/security/authorization/policies.html)\\n[overview. For more info\", \"rmation, see the ASP.NET Authorization Workshop.](https://github.com/blowdart/AspNetAuthorizationWor\", \"kshop)\\n\\n\\nCustom authorization policies are registered in the Startup.ConfigureServices method using \", \"the\\nservice.AddAuthorization method. This method takes a delegate that configures an\\nAuthorizationOp\", \"tions argument.\\n\\n\\nAs shown in the example, policies can be associated with different types of requir\", \"ements. After the\\npolicies are registered, they can be applied to an action or controller by passing\", \" the policy\\u2019s name as\\nthe Policy argument of the Authorize attribute (for example, [Authorize(Policy\", \"=\\\"EmployeesOnly\\\")])\\nPolicies can have multiple requirements, not just one (as shown in these example\", \"s).\\n\\n\\nIn the previous example, the first AddPolicy call is just an alternative way of authorizing by\", \" role. If\\n\\n[Authorize(Policy=\\\"AdministratorsOnly\\\")] is applied to an API, only users in the Administ\", \"rator role will\\nbe able to access it.\\n\\n\\n[The second AddPolicy](https://docs.microsoft.com/dotnet/api\", \"/microsoft.aspnetcore.authorization.authorizationoptions.addpolicy) call demonstrates an easy way to\", \" require that a particular claim should be\\n[present for the user. The RequireClaim](https://docs.mic\", \"rosoft.com/dotnet/api/microsoft.aspnetcore.authorization.authorizationpolicybuilder.requireclaim) me\", \"thod also optionally takes expected values for the claim. If\\nvalues are specified, the requirement i\", \"s met only if the user has both a claim of the correct type and\\none of the specified values. If you\\u2019\", \"re using the JWT bearer authentication middleware, all JWT\\nproperties will be available as user clai\", \"ms.\\n\\n\\nThe most interesting policy shown here is in the third AddPolicy method, because it uses a cus\", \"tom\\nauthorization requirement. By using custom authorization requirements, you can have a great deal\", \" of\\ncontrol over how authorization is performed. For this to work, you must implement these types:\\n\\n\", \"\\n  - [A Requirements type that derives from IAuthorizationRequirement](https://docs.microsoft.com/do\", \"tnet/api/microsoft.aspnetcore.authorization.iauthorizationrequirement) and that contains fields\\nspec\", \"ifying the details of the requirement. In the example, this is an age field for the sample\\nMinimumAg\", \"eRequirement type.\\n\\n\\n  - [A handler that implements AuthorizationHandler, where T is the type of](ht\", \"tps://docs.microsoft.com/dotnet/api/microsoft.aspnetcore.authorization.authorizationhandler-1)\\n[IAut\", \"horizationRequirement that the handler can satisfy. The handler must implement the](https://docs.mic\", \"rosoft.com/dotnet/api/microsoft.aspnetcore.authorization.iauthorizationrequirement)\\n[HandleRequireme\", \"ntAsync method, which checks whether a specified context that contains](https://docs.microsoft.com/d\", \"otnet/api/microsoft.aspnetcore.authorization.authorizationhandler-1.handlerequirementasync)\\ninformat\", \"ion about the user satisfies the requirement.\\n\\n\\n329 CHAPTER 8 | Make secure .NET Microservices and W\", \"eb Applications\\n\\n\\nIf the user meets the requirement, a call to context.Succeed will indicate that th\", \"e user is authorized. If\\nthere are multiple ways that a user might satisfy an authorization requirem\", \"ent, multiple handlers can\\nbe created.\\n\\n\\nIn addition to registering custom policy requirements with \", \"AddPolicy calls, you also need to register\\ncustom requirement handlers via Dependency Injection (ser\", \"vices.AddTransient<IAuthorizationHandler,\\nMinimumAgeHandler>()).\\n\\n\\nAn example of a custom authorizat\", \"ion requirement and handler for checking a user\\u2019s age (based on a\\n[DateOfBirth claim) is available i\", \"n the ASP.NET Core authorization documentation.](https://docs.asp.net/en/latest/security/authorizati\", \"on/policies.html)\\n\\n#### **Authorization and minimal apis**\\n\\n\\nASP.NET supports minimal APIs as an alt\", \"ernative to controller-based APIs. Authorization policies are\\nthe recommended way to configure autho\", \"rization for minimal APIs, as this example demonstrates:\\n\\n#### **Additional resources**\\n\\n\\n  - **ASP.\", \"NET Core Authentication**\\n[https://learn.microsoft.com/aspnet/core/security/authentication/identity]\", \"(https://docs.microsoft.com/aspnet/core/security/authentication/identity)\\n\\n\\n  - **ASP.NET Core Autho\", \"rization**\\n[https://learn.microsoft.com/aspnet/core/security/authorization/introduction](https://doc\", \"s.microsoft.com/aspnet/core/security/authorization/introduction)\\n\\n\\n  - **Role-based Authorization**\\n\", \"[https://learn.microsoft.com/aspnet/core/security/authorization/roles](https://docs.microsoft.com/as\", \"pnet/core/security/authorization/roles)\\n\\n\\n  - **Custom Policy-Based Authorization**\\n[https://learn.m\", \"icrosoft.com/aspnet/core/security/authorization/policies](https://docs.microsoft.com/aspnet/core/sec\", \"urity/authorization/policies)\\n\\n\\n  - **Authentication and authorization in minimal**\\n**APIs** [https:\", \"//learn.microsoft.com/aspnet/core/fundamentals/minimal-apis/security](https://docs.microsoft.com/asp\", \"net/core/fundamentals/minimal-apis/security)\\n\\n### Store application secrets safely during developmen\", \"t\\n\\n\\nTo connect with protected resources and other services, ASP.NET Core applications typically need\", \" to\\nuse connection strings, passwords, or other credentials that contain sensitive information. Thes\", \"e\\nsensitive pieces of information are called _secrets_ . It\\u2019s a best practice to not include secrets\", \" in source\\n\\n\\n330 CHAPTER 8 | Make secure .NET Microservices and Web Applications\\n\\n\\ncode and making s\", \"ure not to store secrets in source control. Instead, you should use the ASP.NET\\nCore configuration m\", \"odel to read the secrets from more secure locations.\\n\\n\\nYou must separate the secrets for accessing d\", \"evelopment and staging resources from the ones used\\nfor accessing production resources, because diff\", \"erent individuals will need access to those different\\nsets of secrets. To store secrets used during \", \"development, common approaches are to either store\\nsecrets in environment variables or by using the \", \"ASP.NET Core Secret Manager tool. For more secure\\nstorage in production environments, microservices \", \"can store secrets in an Azure Key Vault.\\n\\n#### **Store secrets in environment variables**\\n\\n\\nOne way \", \"to keep secrets out of source code is for developers to set string-based secrets as\\n[environment var\", \"iables](https://docs.microsoft.com/aspnet/core/security/app-secrets#environment-variables) on their \", \"development machines. When you use environment variables to store\\nsecrets with hierarchical names, s\", \"uch as the ones nested in configuration sections, you must name the\\nvariables to include the complet\", \"e hierarchy of its sections, delimited with colons (:).\\n\\n\\nFor example, setting an environment variab\", \"le Logging:LogLevel:Default to Debug value would be\\nequivalent to a configuration value from the fol\", \"lowing JSON file:\\n\\n\\nTo access these values from environment variables, the application just needs to\", \" call\\nAddEnvironmentVariables on its ConfigurationBuilder when constructing an IConfigurationRoot\\nob\", \"ject.\\n\\n\\n\\n\\n#### **Store secrets with the ASP.NET Core Secret Manager**\\n\\n[The ASP.NET Core Secret Mana\", \"ger tool provides another method of keeping secrets out of source](https://docs.microsoft.com/aspnet\", \"/core/security/app-secrets#secret-manager)\\ncode **during development** . To use the Secret Manager t\", \"ool, install the package\\n**Microsoft.Extensions.Configuration.SecretManager** in your project file. \", \"Once that dependency is\\npresent and has been restored, the dotnet user-secrets command can be used t\", \"o set the value of\\nsecrets from the command line. These secrets will be stored in a JSON file in the\", \" user\\u2019s profile\\ndirectory (details vary by OS), away from source code.\\n\\n\\nSecrets set by the Secret M\", \"anager tool are organized by the UserSecretsId property of the project\\nthat\\u2019s using the secrets. The\", \"refore, you must be sure to set the UserSecretsId property in your project\\nfile, as shown in the sni\", \"ppet below. The default value is a GUID assigned by Visual Studio, but the\\nactual string is not impo\", \"rtant as long as it\\u2019s unique in your computer.\\n\\n\\n331 CHAPTER 8 | Make secure .NET Microservices and \", \"Web Applications\\n\\n\\nUsing secrets stored with Secret Manager in an application is accomplished by cal\", \"ling\\nAddUserSecrets<T> on the ConfigurationBuilder instance to include secrets for the application i\", \"n its\\nconfiguration. The generic parameter T should be a type from the assembly that the UserSecretI\", \"d was\\napplied to. Usually, using AddUserSecrets<Startup> is fine.\\n\\n\\nThe AddUserSecrets<Startup>() is\", \" included in the default options for the Development environment\\nwhen using the CreateDefaultBuilder\", \" method in _Program.cs_ .\\n\\n### Use Azure Key Vault to protect secrets at production time\\n\\n\\nSecrets s\", \"tored as environment variables or stored by the Secret Manager tool are still stored locally\\n[and un\", \"encrypted on the machine. A more secure option for storing secrets is Azure Key Vault, which](https:\", \"//azure.microsoft.com/services/key-vault/)\\nprovides a secure, central location for storing keys and \", \"secrets.\\n\\n\\nThe **Azure.Extensions.AspNetCore.Configuration.Secrets** package allows an ASP.NET Core\\n\", \"application to read configuration information from Azure Key Vault. To start using secrets from an\\nA\", \"zure Key Vault, you follow these steps:\\n\\n\\n1. Register your application as an Azure AD application. (\", \"Access to key vaults is managed by\\nAzure AD.) This can be done through the Azure management portal.\\n\", \"\\n\\nAlternatively, if you want your application to authenticate using a certificate instead of a\\n[pass\", \"word or client secret, you can use the New-AzADApplication](https://docs.microsoft.com/powershell/mo\", \"dule/az.resources/new-azadapplication) PowerShell cmdlet. The\\ncertificate that you register with Azu\", \"re Key Vault needs only your public key. Your application\\nwill use the private key.\\n\\n\\n2. Give the re\", \"gistered application access to the key vault by creating a new service principal. You\\ncan do this us\", \"ing the following PowerShell commands:\\n\\n\\n3. Include the key vault as a configuration source in your \", \"application by calling the\\nAzureKeyVaultConfigurationExtensions.AddAzureKeyVault extension method wh\", \"en you create\\n[an IConfigurationRoot instance.](https://docs.microsoft.com/dotnet/api/microsoft.exte\", \"nsions.configuration.iconfigurationroot)\\n\\n\\nNote that calling AddAzureKeyVault requires the applicati\", \"on ID that was registered and given access\\nto the key vault in the previous steps. Or you can firstl\", \"y running the Azure CLI command: az login,\\nthen using an overload of AddAzureKeyVault that takes a D\", \"efaultAzureCredential in place of the\\nclient.\\n\\n\\n332 CHAPTER 8 | Make secure .NET Microservices and W\", \"eb Applications\\n\\n\\n#### **Additional resources**\\n\\n\\n  - **Using Azure Key Vault to protect application\", \" secrets**\\n[https://learn.microsoft.com/azure/architecture/multitenant-identity](https://docs.micros\", \"oft.com/azure/architecture/multitenant-identity)\\n\\n\\n  - **Safe storage of app secrets during developm\", \"ent**\\n[https://learn.microsoft.com/aspnet/core/security/app-secrets](https://docs.microsoft.com/aspn\", \"et/core/security/app-secrets)\\n\\n\\n  - **Configuring data protection**\\n[https://learn.microsoft.com/asp\", \"net/core/security/data-protection/configuration/overview](https://docs.microsoft.com/aspnet/core/sec\", \"urity/data-protection/configuration/overview)\\n\\n\\n  - **Data Protection key management and lifetime in\", \" ASP.NET Core**\\n[https://learn.microsoft.com/aspnet/core/security/data-protection/configuration/defa\", \"ult-](https://docs.microsoft.com/aspnet/core/security/data-protection/configuration/default-settings\", \")\\nsettings\\n\\n\\n333 CHAPTER 8 | Make secure .NET Microservices and Web Applications\\n\\n\\n**CHAPTER**\\n# 9\\n\\n\", \"## .NET Microservices Architecture key takeaways\\n\\n\\nAs a summary and key takeaways, the following are\", \" the most important conclusions from this guide.\\n\\n\\n**Benefits of using containers.** Container-based\", \" solutions provide important cost savings because\\nthey help reduce deployment problems caused by fai\", \"ling dependencies in production environments.\\nContainers significantly improve DevOps and production\", \" operations.\\n\\n\\n**Containers will be ubiquitous.** Docker-based containers are becoming the de facto \", \"standard in the\\nindustry, supported by key vendors in the Windows and Linux ecosystems, such as Micr\", \"osoft, Amazon\\nAWS, Google, and IBM. Docker will probably soon be ubiquitous in both the cloud and on\", \"-premises\\ndatacenters.\\n\\n\\n**Containers as a unit of deployment.** A Docker container is becoming the \", \"standard unit of\\ndeployment for any server-based application or service.\\n\\n\\n**Microservices.** The mi\", \"croservices architecture is becoming the preferred approach for distributed and\\nlarge or complex mis\", \"sion-critical applications based on many independent subsystems in the form of\\nautonomous services. \", \"In a microservice-based architecture, the application is built as a collection of\\nservices that are \", \"developed, tested, versioned, deployed, and scaled independently. Each service can\\ninclude any relat\", \"ed autonomous database.\\n\\n\\n**Domain-driven design and SOA.** The microservices architecture patterns \", \"derive from serviceoriented architecture (SOA) and domain-driven design (DDD). When you design and d\", \"evelop\\nmicroservices for environments with evolving business needs and rules, it\\u2019s important to cons\", \"ider DDD\\napproaches and patterns.\\n\\n\\n**Microservices challenges.** Microservices offer many powerful \", \"capabilities, like independent\\ndeployment, strong subsystem boundaries, and technology diversity. Ho\", \"wever, they also raise many\\nnew challenges related to distributed application development, such as f\", \"ragmented and independent\\ndata models, resilient communication between microservices, eventual consi\", \"stency, and operational\\ncomplexity that results from aggregating logging and monitoring information \", \"from multiple\\nmicroservices. These aspects introduce a much higher complexity level than a tradition\", \"al monolithic\\napplication. As a result, only specific scenarios are suitable for microservice-based \", \"applications. These\\ninclude large and complex applications with multiple evolving subsystems. In the\", \"se cases, it\\u2019s worth\\ninvesting in a more complex software architecture, because it will provide bett\", \"er long-term agility and\\napplication maintenance.\\n\\n\\n334 CHAPTER 9 | .NET Microservices Architecture \", \"key takeaways\\n\\n\\n**Containers for any application.** Containers are convenient for microservices, but\", \" can also be useful\\nfor monolithic applications based on the traditional .NET Framework, when using \", \"Windows\\nContainers. The benefits of using Docker, such as solving many deployment-to-production issu\", \"es and\\nproviding state-of-the-art Dev and Test environments, apply to many different types of applic\", \"ations.\\n\\n\\n**CLI versus IDE.** With Microsoft tools, you can develop containerized .NET applications \", \"using your\\npreferred approach. You can develop with a CLI and an editor-based environment by using t\", \"he Docker\\nCLI and Visual Studio Code. Or you can use an IDE-focused approach with Visual Studio and \", \"its unique\\nfeatures for Docker, such as multi-container debugging.\\n\\n\\n**Resilient cloud applications.\", \"** In cloud-based systems and distributed systems in general, there is\\nalways the risk of partial fa\", \"ilure. Since clients and services are separate processes (containers), a\\nservice might not be able t\", \"o respond in a timely way to a client\\u2019s request. For example, a service might\\nbe down because of a p\", \"artial failure or for maintenance; the service might be overloaded and\\nresponding slowly to requests\", \"; or it might not be accessible for a short time because of network\\nissues. Therefore, a cloud-based\", \" application must embrace those failures and have a strategy in place\\nto respond to those failures. \", \"These strategies can include retry policies (resending messages or\\nretrying requests) and implementi\", \"ng circuit-breaker patterns to avoid exponential load of repeated\\nrequests. Basically, cloud-based a\", \"pplications must have resilient mechanisms\\u2014either based on cloud\\ninfrastructure or custom, as the hi\", \"gh-level ones provided by orchestrators or service buses.\\n\\n\\n**Security.** Our modern world of contai\", \"ners and microservices can expose new vulnerabilities. There are\\nseveral ways to implement basic app\", \"lication security, based on authentication and authorization.\\nHowever, container security must consi\", \"der additional key components that result in inherently safer\\napplications. A critical element of bu\", \"ilding safer apps is having a secure way of communicating with\\nother apps and systems, something tha\", \"t often requires credentials, tokens, passwords, and the like,\\ncommonly referred to as application s\", \"ecrets. Any secure solution must follow security best practices,\\nsuch as encrypting secrets while in\", \" transit and at rest, and preventing secrets from leaking when\\nconsumed by the final application. Th\", \"ose secrets need to be stored and kept safely, as when using\\nAzure Key Vault.\\n\\n\\n**Orchestrators.** C\", \"ontainer-based orchestrators, such as Azure Kubernetes Service and Azure Service\\nFabric are key part\", \" of any significant microservice and container-based application. These applications\\ncarry with them\", \" high complexity, scalability needs, and go through constant evolution. This guide has\\nintroduced or\", \"chestrators and their role in microservice-based and container-based solutions. If your\\napplication \", \"needs are moving you toward complex containerized apps, you will find it useful to seek\\nout addition\", \"al resources for learning more about orchestrators.\\n\\n\\n335 CHAPTER 9 | .NET Microservices Architectur\", \"e key takeaways\\n\\n\\n\"]"