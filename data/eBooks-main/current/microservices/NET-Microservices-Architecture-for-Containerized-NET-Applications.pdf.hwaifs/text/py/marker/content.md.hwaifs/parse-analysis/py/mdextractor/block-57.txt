if (catalogItem == null) return NotFound();
 bool raiseProductPriceChangedEvent = false;
 IntegrationEvent priceChangedEvent = null;
 if (catalogItem.Price != productToUpdate.Price)
 raiseProductPriceChangedEvent = true;
 if (raiseProductPriceChangedEvent) // Create event if price has changed
 {
 var oldPrice = catalogItem.Price;
 priceChangedEvent = new ProductPriceChangedIntegrationEvent(catalogItem.Id,
 productToUpdate.Price,
 oldPrice);
 }
 // Update current product
 catalogItem = productToUpdate;
 // Just save the updated product if the Product's Price hasn't changed.
 if (!raiseProductPriceChangedEvent)
 {
 await _catalogContext.SaveChangesAsync();
 }
 else // Publish to event bus only if product price changed
 {
 // Achieving atomicity between original DB and the IntegrationEventLog
 // with a local transaction
 using (var transaction = _catalogContext.Database.BeginTransaction())
 {
 _catalogContext.CatalogItems.Update(catalogItem);
 await _catalogContext.SaveChangesAsync();
 await _integrationEventLogService.SaveEventAsync(priceChangedEvent);
 transaction.Commit();
 }
 // Publish the integration event through the event bus
 _eventBus.Publish(priceChangedEvent);
 _integrationEventLogService.MarkEventAsPublishedAsync(
 priceChangedEvent);
 }
 return Ok();
}