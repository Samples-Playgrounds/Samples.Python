|    | 0                                                                               |
|---:|:--------------------------------------------------------------------------------|
|  0 | public async Task<bool> CancelAsync()                                           |
|  1 | {                                                                               |
|  2 | var orderStatus = await                                                         |
|  3 | StateManager.TryGetStateAsync<OrderStatus>(OrderStatusStateName);               |
|  4 | if (!orderStatus.HasValue)                                                      |
|  5 | {                                                                               |
|  6 | _logger.LogWarning(                                                             |
|  7 | "Order with Id: {OrderId} cannot be cancelled because it doesn't exist",        |
|  8 | OrderId);                                                                       |
|  9 |                                                                                 |
| 10 | return false;                                                                   |
| 11 | }                                                                               |
| 12 |                                                                                 |
| 13 | if (orderStatus.Value.Id == OrderStatus.Paid.Id || orderStatus.Value.Id ==      |
| 14 | OrderStatus.Shipped.Id)                                                         |
| 15 | {                                                                               |
| 16 | _logger.LogWarning(                                                             |
| 17 | "Order with Id: {OrderId} cannot be cancelled because it's in status {Status}", |
| 18 | OrderId, orderStatus.Value.Name);                                               |
| 19 |                                                                                 |
| 20 | return false;                                                                   |
| 21 | }                                                                               |
| 22 |                                                                                 |
| 23 | await StateManager.SetStateAsync(OrderStatusStateName, OrderStatus.Cancelled);  |
| 24 |                                                                                 |
| 25 | var order = await StateManager.GetStateAsync<Order>(OrderDetailsStateName);     |
| 26 |                                                                                 |
| 27 | await _eventBus.PublishAsync(new OrderStatusChangedToCancelledIntegrationEvent( |
| 28 | OrderId,                                                                        |
| 29 | OrderStatus.Cancelled.Name,                                                     |
| 30 | $"The order was cancelled by buyer.",                                           |
| 31 | order.UserName));                                                               |
| 32 |                                                                                 |
| 33 | return true;                                                                    |
| 34 | }                                                                               |