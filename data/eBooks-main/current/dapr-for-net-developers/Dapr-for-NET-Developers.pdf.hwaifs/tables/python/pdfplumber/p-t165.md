|    | 0                                                                                     |
|---:|:--------------------------------------------------------------------------------------|
|  0 | [HttpPost("OrderStatusChangedToSubmitted")]                                           |
|  1 | [Topic(DaprPubSubName, nameof(OrderStatusChangedToSubmittedIntegrationEvent))]        |
|  2 | public async Task HandleAsync(                                                        |
|  3 | OrderStatusChangedToSubmittedIntegrationEvent integrationEvent,                       |
|  4 | [FromServices] IOptions<OrderingSettings> settings,                                   |
|  5 | [FromServices] IEmailService emailService)                                            |
|  6 | {                                                                                     |
|  7 | // Gets the order details from Actor state.                                           |
|  8 | var actorId = new ActorId(integrationEvent.OrderId.ToString());                       |
|  9 | var orderingProcess = _actorProxyFactory.CreateActorProxy<IOrderingProcessActor>(     |
| 10 | actorId,                                                                              |
| 11 | nameof(OrderingProcessActor));                                                        |
| 12 | //                                                                                    |
| 13 | var actorOrder = await orderingProcess.GetOrderDetailsAsync();                        |
| 14 | var readModelOrder = new Order(integrationEvent.OrderId, actorOrder);                 |
| 15 |                                                                                       |
| 16 | // Add the order to the read model so it can be queried from the API.                 |
| 17 | // It may already exist if this event has been handled before (at-least-once          |
| 18 | semantics).                                                                           |
| 19 | readModelOrder = await _orderRepository.AddOrGetOrderAsync(readModelOrder);           |
| 20 |                                                                                       |
| 21 | // Send a SignalR notification to the client.                                         |
| 22 | await SendNotificationAsync(readModelOrder.OrderNumber, integrationEvent.OrderStatus, |
| 23 | integrationEvent.BuyerId);                                                            |
| 24 |                                                                                       |
| 25 | // Send a confirmation e-mail if enabled.                                             |
| 26 | if (settings.Value.SendConfirmationEmail)                                             |
| 27 | {                                                                                     |
| 28 | await emailService.SendOrderConfirmationAsync(readModelOrder);                        |
| 29 | }                                                                                     |
| 30 | }                                                                                     |