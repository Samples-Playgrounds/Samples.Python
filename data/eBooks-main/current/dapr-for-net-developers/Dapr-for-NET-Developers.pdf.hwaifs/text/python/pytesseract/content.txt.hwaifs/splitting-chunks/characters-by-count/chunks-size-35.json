"[\"== Microsoft\\n\\nDapr for\\n.NET Developers\\n\\nForeword by Mark Russinovich, Microsoft Azure CTO\\nand Techni\", \"cal Fellow\\n\\nRobert Vettor\\nSander Molenkamp\\nEdwin van Wijk\\nEDITION v1.2\\n\\nPUBLISHED BY\\n\\nMicrosoft Deve\", \"loper Division, .NET, and Azure Incubations teams\\nA division of Microsoft Corporation\\n\\nOne Microsoft\", \" Way\\n\\nRedmond, Washington 98052-6399\\n\\nCopyright \\u00a9 2023 by Microsoft Corporation\\n\\nAll rights reserved\", \". No part of the contents of this book may be reproduced or transmitted in any\\nform or by any means \", \"without the written permission of the publisher.\\n\\nThis book is provided \\u201cas-is\\u201d and expresses the au\", \"thor's views and opinions. The views, opinions, and\\ninformation expressed in this book, including UR\", \"L and other Internet website references, may change\\nwithout notice.\\n\\nSome examples depicted herein a\", \"re provided for illustration only and are fictitious. No real association\\nor connection is intended \", \"or should be inferred.\\n\\nMicrosoft and the trademarks listed at https://www.microsoft.com on the \\u201cTra\", \"demarks\\u201d webpage are\\ntrademarks of the Microsoft group of companies.\\n\\nMac and macOS are trademarks o\", \"f Apple Inc.\\n\\nThe Docker whale logo is a registered trademark of Docker, Inc. Used by permission.\\nAl\", \"l other marks and logos are property of their respective owners.\\n\\nAuthors:\\n\\nRob Vettor, Principal Cl\", \"oud Solution Architect - thinkingincloudnative.com, Microsoft\\nSander Molenkamp, Principal Cloud Arch\", \"itect/Microsoft MVP - sandermolenkamp.com, Info Support\\n\\nEdwin van Wijk, Principal Solution Architec\", \"t/Microsoft MVP - defaultconstructor.com, Info Support\\n\\nParticipants and Reviewers:\\n\\nMark Russinovic\", \"h, Azure CTO and Technical Fellow, Azure Office of CTO, Microsoft\\nNish Anil, Senior Program Manager,\", \" .NET team, Microsoft\\n\\nMark Fussell, Principal Program Manager, Azure Incubations, Microsoft\\n\\nYaron \", \"Schneider, Principal Software Engineer, Azure Incubations, Microsoft\\n\\nOri Zohar, Senior Program Mana\", \"ger, Azure Incubations, Microsoft\\n\\nEditors:\\n\\nDavid Pine, Senior Content Developer, .NET team, Micros\", \"oft\\n\\nMaira Wenzel, Senior Program Manager, .NET team, Microsoft\\nSteve \\u201cardalis\\u201d Smith, Senior Archit\", \"ect and Trainer, NimblePros\\n\\nVersion\\n\\nThis guide has been written to cover the Dapr 1.9 version. .NE\", \"T samples are based on .NET 7.\\n\\nWho should use this guide\\n\\nThe audience for this guide is mainly dev\", \"elopers, development leads, and architects who are\\ninterested in learning how to build applications \", \"designed for the cloud.\\n\\nA secondary audience is technical decision-makers who plan to choose whethe\", \"r to build their\\napplications using a cloud-native approach.\\n\\nHow you can use this guide\\n\\nThis guide\", \" Is available both in PDF form and online. Feel free to forward this document or links to its\\nonline\", \" version to your team to help ensure common understanding of these topics. Most of these\\ntopics bene\", \"fit from a consistent understanding of the underlying principles and patterns, as well as\\nthe trade-\", \"offs involved in decisions related to these topics. Our goal with this document is to equip\\nteams an\", \"d their leaders with the information they need to make well-informed decisions for their\\napplication\", \"s\\u2019 architecture, development, and hosting.\\nContents\\n\\nForeword - Dapr for .NET Developetre...........\", \".....sssssssssssssssssssscssccccccsssssssssssssssssssssssssssccsccsssses 1\\nThe world is distributed.\", \"................cccccccccsccccsccccssscsssssssssssssssssssssssssssssssssssssssssssssssssssssssscccce\", \"ccoecs 3\\nSUIMIM ALY ..eeeesesessssesssesessssesesesesssscuesesesesescuesesesesesesucuesesesesessases\", \"esesesesesssuesesesesesesssusuesesesescsasesesesesesecusseseseseseseeeeneaeseseseseeneueseseaeeees 7\", \"\\nDapr at 20,000 feet ....................ccccccccccssssssssssssssssscssssssssccccccssccccsssssssssss\", \"sssssssscsssssssssssssssssees 8\\nDapr And the problem It SOIVES..... ce cesessssssssssssssesssesssses\", \"sssessssecscsessesessssessssessssessssessesesscsessesessesessesessssesseseesesessesesseaeeneens 8\\nDa\", \"pr APCHIt@CtUre oo. ecescesessesessesessesessesssessssesscsessesesussessesesussesussesuesesussesssse\", \"cussecussesuesecsssessesessesssusaessesessesessssessssessesesseaesneaeeneess 9\\nBUINICGING DIOCKS wee\", \" essesessesessesessesessesssesussessssecussecsesecucsesussecsssecussecsssecussessssesussesussesusses\", \"ussecussecsesecussesussesussecusseceesecesseeneseenees 9\\nCOMPONENNS.......eeeesesessssssesscsesescse\", \"sesscsesessesesesssscsesucsesesucuesescuesesessesesessesesecucuesesauesesecuesesessesesesueseseseeue\", \"seseeneseseeneseseanseseaeeess 11\\nSIDECAr APCHITSCKULE ne. eeecesessesesseesecsessesessecsesscsessec\", \"scsecsecuesscsessesscsscsesuesscsecsesucasesecuesucsessecucscsecuesucaessesucaeenecneceaeeneenensens\", \" 13\\nHOSTING ENVIFONMENTS .......c.cccesscsessessssesessesessessssesessessssesessesessssessesssssssss\", \"esessesssssessesessesecsssesessecessecsssecesseceesecnsseensseensseenees 14\\nDapr Performance CONSICE\", \"LATIONS ........cecessessssessessesscsessessesscsessecucsssecsesucsessecussussessesussessecussussecs\", \"esussesseeucsessecnesesseeseensaeees 15\\nDapr ANC SEFVICE MESHES .......cecessesessesessessssesessess\", \"sescsesuesesussesussesussessssesussessssesucsessesesussesessesussesussesssesessesessesessesesseseese\", \"seeneens 16\\nSUIMIMALSY ...eessssssssesssscsecsscsesessesesesucscsesssscsesussesesucsesesscuesesesues\", \"esesuesesesussesesucsesesscsesessuesesessesesesucsssescueseseenesesesueseseceneseseeeeseneeneaees 18\", \"\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecue\", \"cuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 18\\nGet started with D\", \"ar .......................sssssssssssssssscsssssccsscccscccccsccccccccccccccccccscccessccscscessesss\", \"sssssseees 19\\nInstall Dapr Into your local ENVIFONMENL.........ccesessesessesessesessesessesessessss\", \"esessesessesessesessesessecessesessssessesessesessesessesseseseeneess 19\\nBuild your first Dapr ADPli\", \"CAatiONn ......ccecessessesessessesscsessessesessessecsssessessesussessecusssseesesussesseeussessecu\", \"ssussesseeussesseenssesseeseeneseess 19\\nCreate the APPliCAatiOn ou... cceccccessessssesesesesesessss\", \"essesesssssssesesscsessssessesessssessssessesessesecsesessesesseseeseseesesessesesseseeseseessseesea\", \"eeneens 19\\nAdd Dap State ManageMe nt... ecesessessssessssessssessssessssessssesessesssessssesussesss\", \"sessssesussessssesussesussesssesessesesseeesaeensseseeseeess 20\\nCOMPONENt CONFIGUIATION FILES oo. ec\", \"eecessessssessessecscsessecscsessessecussessecussussessecussucsessssussessecussucseesesussessecusses\", \"seenesusseeseensseeaes 21\\nBuild a multi-container Dapr Application uu... ccessesessessssessssesssses\", \"sssessssessssesessesessesessesessesesseseesesessesessesessesessessesesseseees 23\\nCreate the APPliCAa\", \"tiOn ou... cceccccessessssesesesesesessssessesesssssssesesscsessssessesessssessssessesessesecsesesse\", \"sesseseeseseesesessesesseseeseseessseeseaeeneens 23\\nAdd Dapr SErvice INVOCATION... ecessesessesesses\", \"essessssesssesssessssesussesussessssesussessesesussesussesussesussesussesussesuesecussesesseaesseses\", \"seeesseeess 2/7\\nAdd CONTAINEF SUPPOSFT.... ee eecesessesessesessesessesssesssesussesussesussessssesu\", \"ssesussesussessssesussecussesussesussesussesussesueseassesessesessesesseeeeseeess 29\\nSUIMIMALY ..cee\", \"esesessssesssssesecsesesesesesscscsesesesessuesesesesesesscussesesesesesussesesesesessusuesesesesess\", \"ausuesesesesesessesescsesesesesuesesesesesesesesseeeseseseaeeneseeeees 35\\nREFEPENCES....esessessesse\", \"ssssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussus\", \"sucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 35\\nTraffic Control sample application ..........\", \"............cccccccccssccsssssssssssssscsssssssssssccccsccsscccccssssscssees 36\\nUsing Dapr DUIIGING \", \"DIOCKS 0... esesessesessessssesessesessessssesssessssesussessssesussesussesessessssesssesussesussesc\", \"sesessesessesessesesseseeseseeneens 39\\n\\ni Contents\\nHOSTING .....esecessesessesessesssessssesussesuss\", \"esussessssesussesussesussessesesussesussesussesussesussesussesussessssessssesessesussesussesussesuss\", \"esussesessesessesessesesseseeseaeeneens 40\\n\\nSelf-HOStEd MOE ou. eeceesessesssssesseeseeseesessscsecs\", \"scsecsesseesessessessecsecsecsecsscuecuccuccucsussussucsucaucsucsucsucsucsucsucsesseeseeaeeseeseeaee\", \"neeaeeneeneens 40\\nKUDOrNeteS on. eceecessessesecsessecsesesecsessesscsecsesucscsecucsucsesuesucsesse\", \"cucsscsesnesucsssecussessessesucsecnecucsussecuesucsessecucscsecuesueaeeaeenenteaeeneeneaees 41\\nSUIM\", \"IMALSY ...eessssssssesssscsecsscsesessesesesucscsesssscsesussesesucsesesscuesesesuesesesuesesesusses\", \"esucsesesscsesessuesesessesesesucsssescueseseenesesesueseseceneseseeeeseneeneaees 41\\nREFEPENCES....e\", \"sessessessessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussuss\", \"ucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 41\\nThe Dapr state management building\", \" block..........................sssccssssssssssssssssssssssssssssssscsceeees 42\\nWhaat It SOIVES oo..\", \". eeessesesssssessessesessessessesessecncsucsesscsucsessecuesucsessesucsucsesuesucsessesuesucsecuesu\", \"csessesucsucsesnesucaesseeueseesecueeusaesaeeeateaeeneeneaes 42\\nHOW It WOFKS .o..eseseessssessessess\", \"esessecsccucsecsccucsscsesucsucsscsesucsucsecuesucaesnecucsscsecsesucsecnesucsscsecuesucaeenesucsecs\", \"esuesucsecnesussesaecuesucaecneeusaeeneeneaseas 43\\nCONSISTENCY ....ccesecsessssessesessssesscsessese\", \"sscsssscsussesussessssesussesucsesucsesussssussesucsesussesucsesucsesucsesussescsesessesuesesesseses\", \"sesessssesseseeseaeeneaeeseens 43\\nCONCUITENCY ou. eeesesessssesesesesesecscsesesesessssescsesesesscs\", \"esesesesesusussesesesesesseuesesesenesessesesesesesesesueseseseseseaesuesesesesesecesueseseseseseses\", \"enesenenees 45\\nTLAMSACTIONS oo..eesesecsessessessestesecsessesecsecscsscsessecucsscsecuesscsesuesucs\", \"ecsesucsecsecuesucsessesuesecsesuesscsesuesucsessesuesucsecsecueseeseseneeaeeneeeeaeeneeneaees 45\\nUs\", \"e the Dapr .NET SDK... ceccescssssessssesessesessessssesssesussesussesussesussesussesussesussesusses\", \"ussesussesussesussesuesesessesessesessesesseaesseaeeneess 46\\nASP.NET Core INteGration .....cccccsess\", \"esessssessessssessssessssesessesessesessesssesssesussesussesussesussesussesussesussesussesessecssese\", \"ssesessesesseeeeseeess 47\\nState STOPE COMPONENMS ....... ce ecccecsssssesessssesesesssssescscseseses\", \"ssessesesesesesessssesesesesesesuesesesesesesesuesesesesesesesueeeseseseseeesseeseseseeeeneneneess 4\", \"7\\nCONFIQUFATION .....ecesessessesessessecscsessecsesussessecusssssecussucsucsecussussesussussucsesus\", \"sussecucsussesuesussssecussussesuesucseesecussesseeucsusseeueausseeseeneaneass 48\\nK@Y Prefix StrATEG\", \"IOS ....cccesessssessessesssessessecsssessecsssesssssecussessesussussessecussessesussussessecussusse\", \"escsussessecussesseenesesseeseeneseeseeneeeeaes 49\\nSample application: Dapr Traffic COMO] occ eccese\", \"ssessssessessssessessecucsessesscsucsessecussesseescsssessececsessecucssseeseesseeseeneseeaes 50\\nSUI\", \"MIMALSY ...eessssssssesssscsecsscsesessesesesucscsesssscsesussesesucsesesscuesesesuesesesuesesesusse\", \"sesucsesesscsesessuesesessesesesucsssescueseseenesesesueseseceneseseeeeseneeneaees 51\\nREFEPENCES....\", \"esessessessessssssssesscsnssussucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussus\", \"sucsucsussussucsussucsueseesueseeseeaeeseeaeeaeeaeeaeeneeneenee 52\\nThe Dapr service invocation build\", \"ing block..........................sssscsssssssssssssssssssssssssssssssssccesees 53\\nWhaat It SOIVES \", \"oo... eeessesesssssessessesessessessesessecncsucsesscsucsessecuesucsessesucsucsesuesucsessesuesucsec\", \"uesucsessesucsucsesnesucaesseeueseesecueeusaesaeeeateaeeneeneaes 53\\nHOW It WOFKS .o..eseseessssesses\", \"sessesessecsccucsecsccucsscsesucsucsscsesucsucsecuesucaesnecucsscsecsesucsecnesucsscsecuesucaeenesuc\", \"secsesuesucsecnesussesaecuesucaecneeusaeeneeneaseas 53\\nUse the Dapr .NET SDK... ceccescssssesssseses\", \"sesessessssesssesussesussesussesussesussesussesussesussesussesussesussesussesuesesessesessesessesess\", \"eaesseaeeneess 55\\nINVoke HTTP Services USING HttO Client... eccssessssessssesessssessessssssesssssss\", \"ssessssessssessssecsssessssesessecesseeesseeesseessseenees 55\\nINVOke HTTP Services USING DaprCli@nt \", \"ou... csecsessesesssesesesssessssessssssscsessssessssessssesessecesseesssesesseseeseensseensseeessee\", \"nees 5/7\\nINVoke GRPC services USING DaprCliQnt.......eceecesssssssesessessssssssessssssesscsesscsess\", \"esesssseseesecessecsesecsssesesseenssesesseensseenees 58\\nName resolUtion COMPONENMS .......ccesseses\", \"sesessesessessssesessessssesessesessesssessesesessessssesessessssesessesssesessesessesessesessesesse\", \"sessesesseseeneees 58\\nCONFIQUFATION .....ecesessessesessessecscsessecsesussessecusssssecussucsucsecu\", \"ssussesussussucsesussussecucsussesuesussssecussussesuesucseesecussesseeucsusseeueausseeseeneaneass 5\", \"8\\nSample application: Dapr Traffic COMO] occ eccesessessssessessssessessecucsessesscsucsessecussesse\", \"escsssessececsessecucssseeseesseeseeneseeaes 59\\nSUIMIMALY ..ceeesesessssesssssesecsesesesesesscscses\", \"esesessuesesesesesesscussesesesesesussesesesesessusuesesesesessausuesesesesesessesescsesesesesuesese\", \"sesesesesesseeeseseseaeeneseeeees 60\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsucsscsscs\", \"scsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeeseeaeeaeea\", \"eeaeeneeneenee 60\\n\\nii Contents\\nThe Dapr publish & subscribe building block..........................\", \"..sssssssssssssssssssssssssssssssssssscecs 61\\n\\nWhaat It SOIVES oo... eeessesesssssessessesessessesse\", \"sessecncsucsesscsucsessecuesucsessesucsucsesuesucsessesuesucsecuesucsessesucsucsesnesucaesseeueseese\", \"cueeusaesaeeeateaeeneeneaes 61\\nHOW It WOFKS .o..eseseessssessessessesessecsccucsecsccucsscsesucsucss\", \"csesucsucsecuesucaesnecucsscsecsesucsecnesucsscsecuesucaeenesucsecsesuesucsecnesussesaecuesucaecneeu\", \"saeeneeneaseas 62\\nCOMPETING CONSUMETS .......cccesessessssessesessssessesessssessesessesessssesscsss\", \"ssssssussescsesucsescsesessesucsesesseseesesessesessesesseseessseeseseeneaeeneess 66\\nUse the Dapr .N\", \"ET SDK... ceccescssssessssesessesessessssesssesussesussesussesussesussesussesussesussesussesussesuss\", \"esussesuesesessesessesessesesseaesseaeeneess 66\\nPUD/SUD COMPONENNMS.......eesecessesessessssessssecs\", \"ssesscsessssesucsesussesussessssessssessssessssessssessssesussesucsessssesussesussesussesessesessese\", \"ssesesseseeseseeneens 68\\nCONFIQUFATION .....ecesessessesessessecscsessecsesussessecusssssecussucsucs\", \"ecussussesussussucsesussussecucsussesuesussssecussussesuesucseesecussesseeucsusseeueausseeseeneaneas\", \"s 68\\nSample application: Dapr Traffic CONtKrON we ecesessessssessesscsessessesscsessesucsscsessecuss\", \"essecsssussessecussessecucsesseeseeesseeseeseseeses 69\\nSUIMIMALSY ...eessssssssesssscsecsscsesessese\", \"sesucscsesssscsesussesesucsesesscuesesesuesesesuesesesussesesucsesesscsesessuesesessesesesucsssescue\", \"seseenesesesueseseceneseseeeeseneeneaees 71\\nREFEPENCES....esessessessessssssssesscsnssussucsucsucsuc\", \"sscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseeseeaeesee\", \"aeeaeeaeeaeeneeneenee 71\\nThe Dapr bindings building DIOCK ...............cccccccccccccccccccccccessc\", \"cescccsssscsssssssssssssssssssssssssssessssss 72\\nWhaat It SOIVES oo... eeessesesssssessessesessesses\", \"sesessecncsucsesscsucsessecuesucsessesucsucsesuesucsessesuesucsecuesucsessesucsucsesnesucaesseeuesee\", \"secueeusaesaeeeateaeeneeneaes 72\\nHOW It WOFKS .o..eseseessssessessessesessecsccucsecsccucsscsesucsuc\", \"sscsesucsucsecuesucaesnecucsscsecsesucsecnesucsscsecuesucaeenesucsecsesuesucsecnesussesaecuesucaecne\", \"eusaeeneeneaseas 73\\nINP Ut DINCGINGS oo... eeeessesessesessesessesessesessesessessssesussesessesssse\", \"sussesssesussesscscsessesucsesussesucsssecsssecsssecessecussecsssecessesussecneseeusseensaeenees 73\\n\", \"OUTPUT DINGINGS oo... ee ececessssessesessesesscsessssessesessesessesessesessssussesssssussssussesuc\", \"sesussesssesucsesessesesseseeseseesesessesesseaeeneseeseaesneaeeneess 74\\nUse the Dapr .NET SDK... ce\", \"ccescssssessssesessesessessssesssesussesussesussesussesussesussesussesussesussesussesussesussesueses\", \"essesessesessesesseaesseaeeneess 76\\nBINGING COMPONENES .......ceesesessessssesessesessecssesscsesscs\", \"essssesussesussesussesussessssessssessssessssessssesussesessesussesessesussesessesesnesessesessesees\", \"eaeeneens 76\\nCLON DINING ......eecesesessssessssesscsessesesscsessesessesessesessesussesussesssssuss\", \"ssucsssussesucsessesesussesucsesucsesussesesseseesesessesessesesseaeesesesseaeeneaneneens 77\\nSample \", \"application: Dapr Traffic COMO] occ eccesessessssessessssessessecucsessesscsucsessecussesseescsssess\", \"ececsessecucssseeseesseeseeneseeaes 78\\nMOTT Input DINING... eececceseessssessesesessessecscsessecses\", \"sesessecucsecsesucsscsessecuesecsessesucsesnecucsussesnesucsessecucscsecneseaeeseenenteaeeneeneaees \", \"79\\nSMTP OUtPUt DINING ou... eecessssessesessesessesessesessesssessssesussesussesussesussesuesesusses\", \"ussessssessssesussesussecussecussesusseaussecssseessseensaeenees 81\\nSUIMIMALY ..ceeesesessssessssses\", \"ecsesesesesesscscsesesesessuesesesesesesscussesesesesesussesesesesessusuesesesesessausuesesesesesess\", \"esescsesesesesuesesesesesesesesseeeseseseaeeneseeeees 83\\nREFEPENCES....esessessessessssssssesscsnssu\", \"ssucsucsucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesu\", \"eseeseeaeeseeaeeaeeaeeaeeneeneenee 83\\nThe Dapr actors building DIOCK.................cccccccccccccsc\", \"ccccsccccssscssccsscscssscsssssssssssssssssssssssssssssssees 84\\nWhaat It SOIVES oo... eeessesessssse\", \"ssessesessessessesessecncsucsesscsucsessecuesucsessesucsucsesuesucsessesuesucsecuesucsessesucsucsesn\", \"esucaesseeueseesecueeusaesaeeeateaeeneeneaes 84\\nHOW It WOFKS .o..eseseessssessessessesessecsccucsecs\", \"ccucsscsesucsucsscsesucsucsecuesucaesnecucsscsecsesucsecnesucsscsecuesucaeenesucsecsesuesucsecnesuss\", \"esaecuesucaecneeusaeeneeneaseas 85\\nTUPN-DaSEC ACCESS MOE] ou... seceesessessessessesessessesecsesses\", \"scsessessesecsecsesscsessesuesessesuesscsessesuesecsesucscsesuesuesessessseeseeeeeeeaeeneenenees 88\\n\", \"TIMES ANC FEMINGELS.......ececsessessesessessessescsesscsecsecsecsesscsessesuesessecsesucsessesseses\", \"sesucsucsessesuesesnecuesecsecuesuesessesueseeneeueeeeaeeneenenee 89\\nState PELSISTENCE ....eeecccess\", \"essssesessesessessssesessesessessssessssesussesussesussesussesussessesesussesussessesessssesussesuss\", \"esussecsssesessesussesnsseeesseeneaeenees 89\\nUse the Dapr .NET SDK... ceccescssssessssesessesessesss\", \"sesssesussesussesussesussesussesussesussesussesussesussesussesussesuesesessesessesessesesseaesseaeen\", \"eess 90\\nCall actors from ASP.NET Core CIONtS oo... eeessessessessessseseessssecsessecsecsecsesuccssc\", \"sscuscuscussucsucsucsussucsesseeaeeaeeseeaeeseeseeaeeneenss 93\\n\\niil Contents\\nCall NON-.NET ACtOMS...\", \"..cececccsscsccccecceccescssccccccesceccscesecscecceccsccsccsscscescccsecsecsecscesesscsecsecsecsess\", \"csccsccsecaecscessacsecaecacescscaseasaes 94\\n\\nTIMES ANC FEMINGELS.......ececsessessesessessessescses\", \"scsecsecsecsesscsessesuesessecsesucsessessesessesucsucsessesuesesnecuesecsecuesuesessesueseeneeueeee\", \"aeeneenenee 95\\nSample application: Dapr Traffic COMO] occ eccesessessssessessssessessecucsessesscsuc\", \"sessecussesseescsssessececsessecucssseeseesseeseeneseeaes 97\\nSUIMIMALY ..ceeesesessssesssssesecseses\", \"esesesscscsesesesessuesesesesesesscussesesesesesussesesesesessusuesesesesessausuesesesesesessesescse\", \"sesesesuesesesesesesesesseeeseseseaeeneseeeees 98\\n\\nREFEPENCES....esessessessessssssssesscsnssussucsu\", \"csucsucsscsscsscsucscsecsecsecsecsecsecsecsesuecuecuscuseucsussussucsucsussussucsussucsueseesueseese\", \"eaeeseeaeeaeeaeeaeeneeneenee 99\\n\\nThe Dapr observability building block............................ss\", \"cccssssssssssssssssssssssssssssssscssccssscceees 100\\nWhaat It SOIVES oo... eeeceesessessesseseesesse\", \"ssesssecsesnesscsesnesucsecsesucsussesnecussessecucsucsecsesussessecucsucsesuesucsessesucsucsesnecue\", \"aessecuesucaeenecucaeeneeneasens 101\\nHOW It WOFKS .o.eeeseesessessessessesessecucsscsecsccucscsecscs\", \"ucsessesucsscsecucsucsesnesucsessecucsucsesuesucsecnecucsecsecucsussessesuesesnecucsucsesnesueaeenec\", \"ueaeeneeneaseass 101\\n\\nDIStriDUTE\\u201d TrACING ......cecessesessesessecessesessecsssessssesussecsssecssse\", \"ssssessssecsssescssecsssesussesussecussecussecsssecusseeussecussesussecessecesseeesseeneseenees 102\\n\", \"\\nMEtIICS ...c.seesesesesessessessesscsessecucscsecsesucscsesuesucsessesucsucsecuesucsecuesucsecsesue\", \"sucsecuesuesecsesuesucsecuesuesessesuesucsecuesucaessecucseesesneaueneeneenensens 109\\n\\nLOGGING ..ces\", \"essessssesessesessesssesussesussesussesussesussesussesussesussesussecussesussesussecussesussecussesu\", \"ssecucsesusseenssecussesuesecuesecussecuesecseseessseeesseeeeseenees 111\\n\\nHealth Status ...ecceccess\", \"essesssssesesesessessesseseesecscsussessecnssssessesussessesucsucsesnesussessesussucsessesussessesec\", \"secsessecucaessecucaeeseceeaueaeeneeneaseas 113\\n\\nDapr CaSNDOAMrA ou... eecesessesessesessesessesssse\", \"ssssessssesussecussecuesecussesussecussecussecussesussessesesussecussecussecuesesussecessecssseessse\", \"eusseensseeneseenees 114\\nUse the Dapr .NET SDK... cccesessesessesessescsesscsessssesscsessssecsesesu\", \"ssessssessssesuesesussucussesussesussesuesesseseesesesscseseesessssesseaeeseaeeeeass 115\\nSample appl\", \"ication: Dapr Traffic CONtKrOL wc ceeesessessssessessssessecscsessessecucsessecsssesssesscussesseens\", \"sesseeseeessesseesseeseeneeeses 115\\nSUIMIMALSY .n.escessssessssesesessesesesscsesessesesecsesesesues\", \"esesuesesessesesesucuesesucuesesscussesessesesesuesesesussesesscsesesscuesesecussesesuesesesueeesese\", \"eeeseseseeseneeneaees 117\\nREFEFENCES o...ceesessessessessesseesessecsessecsecsecsccuecuecuccussucsuc\", \"suscussussussussucsucsucsucsucsscscsecsecseeseesecuecuceuccucsucsucsussucsussueseeseeaeeaeeaeeseeaee\", \"seeneenss 118\\n\\nThe Dapr secrets management building block ...........................sssssssssssssss\", \"sssssssscssssseseesees 119\\nWhaat It SOIVES oo... eeeceesessessesseseesessessesssecsesnesscsesnesucse\", \"csesucsussesnecussessecucsucsecsesussessecucsucsesuesucsessesucsucsesnecueaessecuesucaeenecucaeeneen\", \"easens 119\\nHOW It WOFKS .o.eeeseesessessessessesessecucsscsecsccucscsecscsucsessesucsscsecucsucsesne\", \"sucsessecucsucsesuesucsecnecucsecsecucsussessesuesesnecucsucsesnesueaeenecueaeeneeneaseass 120\\nUse t\", \"he Dapr .NET SDK... cccesessesessesessescsesscsessssesscsessssecsesesussessssessssesuesesussucussesu\", \"ssesussesuesesseseesesesscseseesessssesseaeeseaeeeeass 121\\nSecret STOFE COMPONENKS.......eecccsessss\", \"sssessesesesesessssesesesesesnsssscsesesesessesesesesesesesusscsesesesessueseseseseseseseueseseseses\", \"eseeeseseseeeenseeeeess 122\\n\\nCONFIQUFATION ....eececesessesscsessessesscsessecscsussessecucsucsesses\", \"ussucsesussussesussussussssucsussussesussussecussussessecussussecuesusseesecussesseeneausseeseenease\", \"ass 123\\n\\nIndirectly CONSUME Dapr SECIEtS ......eeccessesessecessesessesessesssessssescssecsssesscsec\", \"sesesussecussecussecsesesussecussecussecusseeesseeesseensseenees 123\\n\\nLOCAL FIC ee. eceecessesseeses\", \"sessssscsusssssucsucsucsucsucsucsucsscsessussecsessecsecsecsecsecsesuscuecuecuscuccussucsussussucsus\", \"sucsussussussucsessesseeseeaesaeeneeaeeneeneeneens 124\\n\\nKUDErNeteS SOCIET on... eeeceesessessesseses\", \"sessessesecsecsessesessecuesucsecsecuesessesucsucsecsesussessessesscsesuesussessesussucsessecucaesse\", \"cucsesesnesueaeeneeneasees 126\\n\\nAZULE K@Y VaUI to... eececesscsessessssesessesessesessesessssesseses\", \"sesssesussesucsssussesussesucsesessssusssssesesssssecsssecussesussesuesecussesesseeessesesseeneaeene\", \"as 126\\n\\nSCOPE SOCKETS ....eeecsssssessssesesescsesessssessssesessesesesesscsesesscsesesscuesesesuese\", \"sessssesesuesesesecussesecuesesesusseseseeeseseseeseseeneseseensseseaneeeseaeess 129\\nSample applicat\", \"ion: Dapr Traffic CONtKrOL wc ceeesessessssessessssessecscsessessecucsessecsssesssesscussesseenssess\", \"eeseeessesseesseeseeneeeses 129\\n\\nSQCIEtS .o.ceeeeessssessssessesessesessesessesecsescsesessesessessc\", \"sesscucssssesscsesscsesessesscsesscuesecsesssessssessenesesnesessesscsesecsesesnecesuesecsesessesess\", \"eeesneaeeneens 131\\n\\nSMTP Server Credential .......cecesessessssssssssesessessecscsecsessesussessesss\", \"sussessecussesseenssuesessecuesessecuesucsessecucseesecuecessessesecaeeneenenseass 132\\n\\nReis Server \", \"CreCeNtials .......ceceesessessssesssssessesessessecussessecsesuesessesucsssecsesucsessesuesussecses\", \"ussessesucsucsesnecucaessecucseeaesseaueaeeneeneasens 133\\n\\niV Contents\\nFineCalculator COMpPONENt LIC\", \"ENSE KEY uo... eeeecessessesseseesesseseseesecsesscsessecsescsecnesucsecsecucsecsesnesuesecsecucsees\", \"ecnesteneeneeneasens 134\\n\\nSUIMIMALSY .n.escessssessssesesessesesesscsesessesesecsesesesuesesesuesese\", \"ssesesesucuesesucuesesscussesessesesesuesesesussesesscsesesscuesesecussesesuesesesueeeseseeeesesesee\", \"seneeneaees 135\\nREFEFENCES o...ceesessessessessesseesessecsessecsecsecsccuecuecuccussucsucsuscussuss\", \"ussussucsucsucsucsucsscscsecsecseeseesecuecuceuccucsucsucsussucsussueseeseeaeeaeeaeeseeaeeseeneenss \", \"135\\nDapr reference application...................cccccccssssssssssccssssssssssssccccccssssssssssssss\", \"sssscsssssscsscsssssssscees 137\\nPSNOPONCONAAINETS ......eeesecsesssssssesessesessesessesessesesseses\", \"sesssesscscsussessssesesussessesesussesussessssessesecsssesussecuesecueseesssesueseceeseceeseessseen\", \"ees 137\\nPSNOPONDANS. uu... eeessssessssessesessesessesessesessesessesssescsesussessssssucsessssesucs\", \"esscsessscsessesesussessssessesecuesesseseceesecseseseesesessecesseeeeseeeeseeeees 138\\nApplication o\", \"f Dapr building DIOCKS.... ce cscsssssssessssessesscsssessessssesssssecussessscucsessessecussessecuc\", \"sesseesecussesseeneaesseeseeneaeens 139\\nState MANAGEMENL un... eeeececesessessssssesessssesesssseses\", \"ssesesscscsesessesesessesesessesesesuesesescuesesecsesesesussesesueseseseeueseseeueseaeensseseansese\", \"aneess 140\\nSEPVICE INVOCATION .....eeessesessessessecsesecsecsesscsecsessesscsecuesscaecsecucsscsecu\", \"ecucscsecucsussesnecucsessecucsscsecuesucsecsecuesecaesuecusaeenecucateneeneaneass 142\\nPUDIISH BL SU\", \"DSCIIDE LA... eceeessesssseeseesessesessecsesucsecsecucsscsecsccucsscnecuesscsesuesuesecsessesucsecu\", \"esuesessesucsucsesuesucaessecucsecsecseaueneeneeneasens 147\\nBiIMCIINGS ..ceesesessssessecessessssess\", \"secussesussecussesussesussesussesussessssesussesussesussecussecussesussesussesuesesussecussesussesue\", \"sesussecueseeuesecueseeesseensseeeeseesees 150\\nACEOIS ..eseesessesessesessessesessesesscsessesesscse\", \"sscsecsesesscsesscsessenesscsesscsesscsesscsessesessssesecuesscsesecsesscuesscsesecsesecuesecuenecue\", \"aesneaesuenesueaeeeeaeeneneenens 152\\nODSErVADIILY oo. ee ececessssessssessesecscsesucsessesesucsesss\", \"sesussesussesussecussecussecussecussesussesussesussecussesussesuesecusseeuesecusseeusaeeesaeaneseane\", \"aeenss 158\\nSQCIEtS .o.ceeeeessssessssessesessesessesessesecsescsesessesessesscsesscucssssesscsesscse\", \"sessesscsesscuesecsesssessssessenesesnesessesscsesecsesesnecesuesecsesessesesseeesneaeeneens 159\\nBen\", \"efits Of applying Dapr to CSNODP uu... ccecessessessssessessesessessessssessecucsessessesussessecuss\", \"ussecsesussessecucsessessesuesessecessesseeneaneaes 160\\nSUIMIMALSY .n.escessssessssesesessesesesscse\", \"sessesesecsesesesuesesesuesesessesesesucuesesucuesesscussesessesesesuesesesussesesscsesesscuesesecus\", \"sesesuesesesueeeseseeeeseseseeseneeneaees 161\\nREFEPENCES.....ececsessessssssssssesussussscsussucsucs\", \"ucsscsscscscsucsecsussessecsecsecsesuecucsuscuccuccuceuseussucaussucsusaucsucsucsussuesecaeeseeneeae\", \"eseeaeeaeeaeeneeneens 161\\nSummary and the road ahead...................ccscscccssssccssccccecccccccc\", \"ccccccccccccsccsscccesccscsssssssssssssseees 162\\nTHE FOAM ANCA... eeeecessessessesseseesessessesesse\", \"snesscsesnesucsessecucsucsesnecussessesucsucsessesuesessecuesscsessesucsessesucsussecsecuesessecucse\", \"eaeeneceeaeeneeneasens 165\\n\\nV Contents\\nCHAPTER\\n\\nForeword - Dapr tor .NET\\nDevelopers\\n\\nWith the wave o\", \"f cloud adoption underway, there is a major shift happening towards \\u201ccloud native\\u201d\\ndevelopment, ofte\", \"n built with microservice-architectures. These microservices are both stateless and\\nstateful, and ru\", \"n on the cloud and edge, embracing the diversity of languages and frameworks\\navailable today. This e\", \"nterprise shift is driven by both the market forces of faster time to market, and\\nthe scale and effi\", \"ciencies of building services for the cloud. Even before COVID-19, cloud adoption\\nwas accelerating f\", \"or enterprises, and developers were being asked to do even more to deliver on\\nbuilding these distrib\", \"uted system applications. That has only accelerated since COVID-19. Developers\\nin enterprises seek t\", \"o focus on business logic, while leaning on platforms to imbue their applications\\nwith scale, resili\", \"ency, maintainability, elasticity, and the other attributes of cloud-native architectures,\\nwhich is \", \"why there is also shift towards serverless platforms that hide the underlying infrastructure.\\nDevelo\", \"pers should not be expected to become distributed systems experts. This is where Dapr steps\\nin to he\", \"lp you, whether you are building on infrastructure such as Kubernetes, or on a serverless\\nplatform.\\n\", \"\\nDapr is designed as an enterprise, developer-focused, microservices programming model platform\\nwith\", \" the mantra \\u201cany language, any framework, run anywhere\\u201d. It makes building distributed\\napplications \", \"easy and portable across any infrastructure, from public-cloud, through hierarchical edge,\\nand even \", \"down to single node loT devices. It emerged from both our experiences building services in\\nAzure and\", \" time spent working with customers building applications on Azure Kubernetes Service and\\nAzure Servi\", \"ce Fabric. Over and over, we saw common problems that they had to address. It became\\nclear that ther\", \"e was a need to provide a \\u201clibrary\\u201d of common microservice best practices that\\ndevelopers could use,\", \" not only in new green field applications, but also to aid in the modernization of\\nexisting applicat\", \"ions. In the containerized, distributed, and networked cloud native world, the sidecar\\nmodel has eme\", \"rged as the preferred approach, in the same way DLLs are preferred in the client/server\\ngeneration. \", \"Using Dapr\\u2019s sidecar and APIs give you, as a developer, all the power of distributed\\nsystems functio\", \"nality, with the ease of a single HTTP or gRPC local call.\\n\\nTo address the wide range of scenarios t\", \"hat developers face, Dapr provides features such as state\\nmanagement, service-to-service invocation,\", \" pub/sub, and integration to external systems with |/O\\nbindings, which are based on the triggers and\", \" bindings of Azure Functions. These in turn take\\nadvantage of Dapr\\u2019s component model, which allows y\", \"ou to \\u201cswap out\\\", say different underlying state\\nstores, without having to change any code. This com\", \"ponent model makes code more portable, more\\nflexible, and allows for experimentation of what best su\", \"its your needs. Developers don\\u2019t need to learn\\n\\n1 CHAPTER 1 | Foreword - Dapr for .NET Developers\\nan\", \"d incorporate service SDKs into their code, or worry about authentication, secret management,\\nretrie\", \"s, or conditional code that targets specific deployment environments.\\n\\nThis book shows how Dapr redu\", \"ces your development time and overall code maintenance by\\nincrementally \\u201cDaperizing\\u201d the canonical .\", \"NET reference application, eShop. For example, in the\\noriginal eShop implementation, significant amo\", \"unts of code were written to abstract between Azure\\nService Bus and RabbitMQ for publishing events b\", \"etween services. All this code can be discarded and\\nsimply replaced with Dapr\\u2019s pub/sub API and comp\", \"onent model, which had an even wider range of\\npub/sub brokers, rather than just two. Dapr\\u2019s actor mo\", \"del, when used in the reworked eShop\\napplication, shows the ease of building long running, stateful,\", \" event driven, workflow applications with\\nall the difficulties of concurrency and multi-threading re\", \"moved. By the end of this book, you will see\\nthe drastic simplification that Dapr brings to your app\", \"lication development, and | firmly believe all\\ndevelopers embarking on a cloud native app building j\", \"ourney should use Dapr.\\n\\nWe publicly announced Dapr with the v0.1 release in Oct 2019 and now, a yea\", \"r and half later, | am\\nthrilled to say that Dapr is ready for production usage with the v1.0 release\", \". Getting Dapr to v1.0 has\\ntruly been a community effort. It has been amazing to see the open-source\", \" community coalesce\\naround Dapr and grow since it was first announced \\u2014 from 114 contributors in Oct\", \"ober 2019 to over\\n700 in early 2021 - a six-fold increase in 16 months! Contributions to the project\", \" have gone to every\\nDapr repo and have ranged from opening issues, commenting on feature proposals, \", \"providing\\nsamples, and, of course, contributing code. The parts of the project community members hav\", \"e\\ncontributed to the most include the Dapr runtime, docs, CLI, SDKs, and the creation of a rich\\necos\", \"ystem of components. Maintaining this openness is critical to Dapr\\u2019s future.\\n\\nDapr is just getting s\", \"tarted, though, and you should expect to see more Dapr capabilities and more\\nsupport for Dapr in Azu\", \"re services. | hope that you will take advantage of Dapr to enable you to focus\\non your core busines\", \"s logic and accelerate your microservices development. | am excited to have you\\njoin us in the Dapr \", \"community on this journey at https://github.com/dapr/ and on Discord\\n\\nhttps://aka.ms/dapr-discord.\\n\\n\", \"Modern distributed systems are complex. You start with small, loosely coupled, independently\\ndeploya\", \"ble services. These services cross process and server boundaries. They then consume different\\nkinds \", \"of infrastructure backing services (databases, message brokers, key vaults). Finally, these\\ndisparat\", \"e pieces compose together to form an application.\\n\\nMark Russinovich Azure CTO and Technical Fellow M\", \"icrosoft\\n\\n2 CHAPTER 1 | Foreword - Dapr for .NET Developers\\nCHAPTER\\n\\nThe world is distriouted\\n\\nJust \", \"ask any \\u2018cool kid\\u2019: Modern, distributed systems are in, and monolithic apps are out!\\n\\nBut, it\\u2019s not \", \"just \\u201ccool kids.\\u201d Progressive IT Leaders, corporate architects, and astute developers are\\n\\nechoing t\", \"hese same thoughts as they explore and evaluate modern distributed applications. Many\\n\\nhave bought i\", \"n. They\\u2019re designing new and replatforming existing enterprise applications following\\nthe principles\", \", patterns, and practices of distributed microservice applications.\\n\\nBut, this evolution raises many\", \" questions...\\n\\nWhat exactly is a distributed application?\\nWhy are they gaining popularity?\\nWhat are \", \"the costs?\\n\\nAnd, importantly, what are the tradeoffs?\\n\\nTo start, let\\u2019s rewind and look at the past 1\", \"5 years. During this period, we typically constructed\\napplications as a single, monolithic unit. Fig\", \"ure 1-1 shows the architecture.\\n\\nClient app\\n\\nFS 2888888 SSO Sees ee eeeococoooe sense seasSSsssssssu\", \"ssry\\n\\nPa\\n\\n!\\n\\nServer app H Infrastructure\\n\\n_ Seaawwoowomnmnnnn nnn nee Fry\\n>\\n\\nModules\\n\\n\\\"\\nIdentity cat\", \" | not\\n\\ni]\\n\\ni\\nAPIS ME y |\\n\\nSe ey i i il, li, lt, il, i\\n<< eee n\\n\\nwo\\n\\nRelational\\ndatabase\\n\\n+ \\\\\\ne-Gess\", \"ae Seeww ween wee ee ee\\n\\n\\u201cSeeccceec---eeeeene\\n\\no*\\n\\n~\\n\\nSh\\n\\nen\\n\\nFigure 1-1. Monolithic architecture.\\n\\n\", \"Note how the modules for Ordering, Identity, and Marketing execute in a single-server process.\\nAppli\", \"cation data is stored in a shared database. Business functionality is exposed via HTML and\\nRESTful i\", \"nterfaces.\\n\\nIn many ways, monolithic apps are straightforward. They're straightforward to:\\n\\nBuild\\n\\nC\", \"HAPTER 2 | The world is distributed\\n\\na me ee ee ee ee ee ae ee ee ee ee ee ru Fret ee erm mes eeeese\", \"eooceses\\n\\u00b0 Test\\n\\u00b0 Deploy\\n\\u00b0 Troubleshoot\\n\\n. Scale vertically (scale up)\\n\\nHowever, monolithic architec\", \"tures can present significant challenges.\\n\\nOver time, you may reach a point where you begin to lose \", \"control...\\n\\n\\u00b0 The monolith has become so overwhelmingly complicated that no single person understand\", \"s it.\\n\\n\\u00b0 You fear making changes as each brings unintended and costly side effects.\\n\\n. New features/\", \"fixes become time-consuming and expensive to implement.\\n. Even the smallest change requires full dep\", \"loyment of the entire application - expensive and\\nrisky.\\n\\n. One unstable component can crash the ent\", \"ire system.\\n\\n. Adding new technologies and frameworks aren't an option.\\n\\n. Implementing agile delive\", \"ry methodologies are difficult.\\n\\n. Architectural erosion sets in as the code base deteriorates with \", \"never-ending \\u201cspecial cases.\\u201d\\n\\n\\u00b0 Eventually the consultants come in and tell you to rewrite it.\\n\\nIT \", \"practitioners call this condition the Fear Cycle. If you've been in the technology business for any\\n\", \"\\nlength of time, good chance you've experienced it. It\\u2019s stressful and exhausts your IT budget. Inst\", \"ead\\nof building new and innovative solutions, most of your budget is spent maintaining legacy apps.\\n\", \"\\nInstead of fear, businesses require speed and agility. They seek an architectural style with which\\n\", \"they can rapidly respond to market conditions. They need to instantaneously update and individually\\n\", \"scale small areas of a live application.\\n\\nAn early attempt to gain speed and agility came in the for\", \"m of Service Oriented Architecture, or SOA.\\nIn this model, service consumers and service providers c\", \"ollaborated via middleware messaging\\ncomponents, often referred to as an Enterprise Service Bus, or \", \"ESB. Figure 1-2 shows the architecture.\\n\\n4 CHAPTER 2 | The world is distributed\\nConsumers\\n\\n\\u2014e\\n\\neee\\nV\", \" LLL LULL,\\n\\ng\\n\\nV7) EE\\nGay\\n\\n\\u2014 UZIZTEZIZ AE\\n\\nTE MT ee G\\n4\\n\\n|\\n\\u2018\\n\\nEnterprise service bus\\n\\n\\u201c\\u00a2 \\u201c\\u00a2\\n\\nService\", \" Service Service\\nprovider provider provider\\n\\nFigure 1-2. SOA architecture.\\n\\nWith SOA, centralized se\", \"rvice providers registered with the ESB. Business logic would be built into the\\nESB to integrate pro\", \"viders and consumers. Service consumers could then find and communicate with\\nthese providers using t\", \"he ESB.\\n\\nDespite the promises of SOA, implementing this approach often increased complexity and intr\", \"oduced\\nbottlenecks. Maintenance costs became high and ESB middleware expensive. Services tended to b\", \"e\\nlarge. They often shared dependencies and data storage. In the end, SOAs often resulted in a\\n\\u2018dist\", \"ributed monolithic\\u2019 structure with centralized services that were resistant to change.\\n\\nNowadays, ma\", \"ny organizations have realized speed and agility by adopting a distributed microservice\\narchitectura\", \"l approach to building systems. Figure 1-3 shows the same system built using distributed\\ntechniques \", \"and practices.\\n\\n5 CHAPTER 2 | The world is distributed\\nConsumers\\n\\nCOC\\n_\\u2014\\u2014\\nsa  _\\u2014\\n\\nLod i\\n\\nBasket micr\", \"oservice\\n\\nOrdering microservice\\n\\nme ee eee er rr ee ee ee ee\\n\\nPee\\n\\n,\\n,\\n'\\n!\\n:\\n:\\n!\\n|\\n'\\nane\\n|\\n|\\n|\\n7\\n!\\n7\", \"\\n\\nie ed\\nnse ch cnn Sens en hh mh iSO ts ete\\n\\nEvent bus (pub/sub)\\n\\nFigure 1-3. Distributed architectu\", \"re.\\n\\nNote how the same application is decomposed across a set of distributed services. Each is self-\", \"\\ncontained and encapsulates its own code, data, and dependencies. Each is deployed in a software\\ncon\", \"tainer and managed by a container orchestrator. Instead of a single database shared by multiple\\nserv\", \"ices, each service owns a private database. Other services can't access this database directly and\\nc\", \"an only get to data that is exposed through the public API of the service that owns it. Note how\\nsom\", \"e services require a full relational database, but others, a NoSQL datastore. The basket service\\nSto\", \"res Its state in a distributed key/value cache. Note how inbound traffic routes through an API\\nGatew\", \"ay service. It\\u2019s responsible for directing calls to services and enforcing cross-cutting concerns.\\nM\", \"ost importantly, the application takes full advantage of the scalability, availability, and resilien\", \"cy\\nfeatures found in modern cloud platforms.\\n\\nBut, while distributed services can provide agility an\", \"d speed, they present a different set of challenges.\\nConsider the following...\\n\\n. How can distribute\", \"d services discover each other and communicate synchronously?\\n\\n6 CHAPTER 2 | The world is distribute\", \"d\\n. How can they implement asynchronous messaging?\\n\\n. How can they maintain contextual information a\", \"cross a transaction?\\n. How can they become resilient to failure?\\n\\n. How can they scale to meet fluct\", \"uating demand?\\n\\n. How are they monitored and observed?\\n\\nFor each of these challenges, multiple produ\", \"cts are often available. But, shielding your application\\nfrom product differences and keeping code m\", \"aintainable and portable become a challenge.\\n\\nThis book introduces Dapr. Dapr is a distributed appli\", \"cation runtime. It directly addresses many of the\\nchallenges found that come along with distributed \", \"applications. Looking ahead, Dapr has the\\npotential to have a profound impact on distributed applica\", \"tion development.\\n\\nSummary\\n\\nIn this chapter, we discussed the adoption of distributed applications. \", \"We contrasted a monolithic\\nsystem approach with that of distributed services. We pointed out many of\", \" the common challenges\\nwhen considering a distributed approach.\\n\\nNow, sit back, relax, and let us in\", \"troduce you the new world of Dapr.\\n\\n7 CHAPTER 2 | The world is distributed\\nCHAPTER\\n\\nDapr at 20,000 t\", \"eet\\n\\nIn chapter 1, we discussed the appeal of distributed microservice applications. But, we also po\", \"inted\\nout that they dramatically increase architectural and operational complexity. With that in min\", \"d, the\\nquestion becomes, how can you \\u201chave your cake\\u201d and \\u201ceat it too?\\u201d. That is, how can you take\\na\", \"dvantage of the agility of distributed architecture, and minimize its complexity?\\n\\nDapr, or Distribu\", \"ted Application Runtime, is a new way to build modern distributed applications.\\n\\nWhat started as a p\", \"rototype has evolved into a highly successful open-source project. Its sponsor,\\nMicrosoft, has close\", \"ly partnered with customers and the open-source community to design and build\\nDapr. The Dapr project\", \" brings together developers from all backgrounds to solve some of the\\ntoughest challenges of develop\", \"ing distributed applications.\\n\\nThis book looks at Dapr from the viewpoint of a .NET developer. In th\", \"is chapter, you'll build a\\nconceptual understanding of Dapr and how it works. Later on, we present p\", \"ractical, hands-on\\ninstruction on how you can use Dapr in your applications.\\n\\nImagine flying in a je\", \"t at 20,000 feet. You look out the window and see the landscape below from a\\nwide perspective. Let's\", \" do the same for Dapr. Visualize yourself flying over Dapr at 20,000 feet. What\\nwould you see?\\n\\nDapr\", \" and the problem it solves\\n\\nDapr addresses a large challenge inherent in modern distributed applicat\", \"ions: Complexity.\\n\\nThrough an architecture of pluggable components, Dapr greatly simplifies the plum\", \"bing behind\\ndistributed applications. It provides a dynamic glue that binds your application with in\", \"frastructure\\ncapabilities from the Dapr runtime.\\n\\nConsider a requirement to make one of your service\", \"s stateful? What would be your design. You could\\nwrite custom code that targets a state store such a\", \"s Redis Cache. However, Dapr provides state\\nmanagement capabilities out-of-the-box. Your service inv\", \"okes the Dapr state management building\\nblock that dynamically binds to a state store component via \", \"a Dapr component configuration yam|\\nfile. Dapr ships with several pre-built state store components, \", \"including Redis. With this model, your\\nservice delegates state management to the Dapr runtime. Your \", \"service has no SDK, library, or direct\\nreference to the underlying component. You can even change st\", \"ate stores, say, from Redis to MySQL\\nor Cassandra, with no code changes.\\n\\nFigure 2-1 shows Dapr from\", \" 20,000 feet.\\n\\n8 CHAPTER 3 | Dapr at 20,000 feet\\nApplication code\\n\\nMicroservices written in\\n\\nAny cod\", \"e or framework... =GO ne d en al python .NET & Java GS\\nHTTP API QRPC API\\n\\nd : i \\u2018\\napr Service- State\", \" Publish Resource Actors Observability Secrets Extensible\\n\\nto-service management and bindings\\ninvoca\", \"tion subscribe and triggers\\n\\nAny cloud or edge infrastructure\\n\\nB\\u00ae Microsoft Azure aws & \\u00a9) Alibaba C\", \"loud YY os ea\\n\\nFigure 2-1. Dapr at 20,000 feet.\\n\\nIn the top row of the figure, note how Dapr provide\", \"s language-specific SDKs for popular development\\nplatforms. Dapr v1.0 includes support for Go, Node,\", \"js, Python, .NET, Java, and JavaScript. This book\\nfocuses on the Dapr .NET SDK, which also provides \", \"direct support for ASP.NET Core integration.\\n\\nWhile language-specific SDKs enhance the developer exp\", \"erience, Dapr is platform agnostic. Under the\\nhood, Dapr\\u2019's programming model exposes capabilities t\", \"hrough standard HTTP/gRPC communication\\nprotocols. Any programming platform can call Dapr via its na\", \"tive HTTP and gRPC APIs.\\n\\nThe blue boxes across the center of the figure represent the Dapr building\", \" blocks. Each exposes a\\ndistributed application capability that your application can consume.\\n\\nThe b\", \"ottom row highlights the portability of Dapr and the diverse environments across which it can\\nrun.\\n\\n\", \"Dapr architecture\\n\\nAt this point, the jet turns around and flies back over Dapr, descending in altit\", \"ude, giving you a closer\\nlook at how Dapr works.\\n\\nBuilding blocks\\n\\nFrom the new perspective, you see\", \" a more detailed view of the Dapr building blocks.\\n\\nA building block encapsulates a distributed infr\", \"astructure capability. You can access the functionality\\nthrough the HTTP or gRPC APIs. Figure 2-2 sh\", \"ows the available blocks for Dapr v 1.0.\\n\\n9 CHAPTER 3 | Dapr at 20,000 feet\\nService\\ninvocation\\n\\nStat\", \"e\\nmanagement\\n\\nco\\n\\nExtensibility\\n\\nPublish &\\nsubscribe\\nDistributed\\n\\nBindings \\\\ Observability\\n\\nPd\\nActor\", \"s\\n\\nFigure 2-2. Dapr building blocks.\\n\\nSecrets\\n\\n55\\n\\nThe following table describes the infrastructure \", \"services provided by each block.\\n\\nBuilding block Description\\n\\nState management | Support contextual \", \"information for long running stateful services.\\n\\nPublish and Implement secure, scalable pub/sub mess\", \"aging between services.\\nsubscribe\\n\\nService invocation | Invoke direct, secure service-to-service cal\", \"ls using platform agnostic protocols\\nand well-known endpoints.\\n\\n10 CHAPTER 3 | Dapr at 20,000 feet\\nB\", \"indings Trigger code from events raised by external resources with bi-directional\\ncommunication.\\n\\nOb\", \"servabilit Monitor and measure message calls across networked services.\\nSecrets Securely access exte\", \"rnal secret stores.\\nActors Encapsulate logic and data in reusable actor objects.\\n\\nBuilding blocks ab\", \"stract the implementation of distributed application capabilities from your services.\\nFigure 2-3 sho\", \"ws this interaction.\\n\\nDapr API\\n\\nYour\\nservice\\n\\nHM Building\\ndapr blocks\\n\\nComponent\\n(Redis Cache)\\n\\nComp\", \"onent\\n(Azure Service Bus)\\n\\nFigure 2-3. Dapr building block integration.\\n\\nBuilding blocks invoke Dapr\", \" components that provide the concrete implementation for each resource.\\nThe code for your service is\", \" only aware of the building block. It takes no dependencies on external\\nSDKs or libraries - Dapr han\", \"dles the plumbing for you. Each building block is independent. You can\\nuse one, some, or all of them\", \" in your application. As a value-add, Dapr building blocks bake in\\nindustry best practices including\", \" comprehensive observability.\\n\\nWe provide detailed explanation and code samples for each Dapr buildi\", \"ng block in the upcoming\\nchapters. At this point, the jet descends even more. From the new perspecti\", \"ve, you now have a closer\\nlook at the Dapr components layer.\\n\\nComponents\\n\\nWhile building blocks expo\", \"se an API to invoke distributed application capabilities, Dapr components\\nprovide the concrete imple\", \"mentation to make it happen.\\n\\n11 CHAPTER 3 | Dapr at 20,000 feet\\nConsider, the Dapr state store comp\", \"onent. It provides a uniform way to manage state for CRUD\\noperations. Without any change to your ser\", \"vice code, you could switch between any of the following\\nDapr state components:\\n\\n\\u00b0 AWS DynamoDB\\n\\n. A\", \"erospike\\n\\n. Azure Blob Storage\\n\\n\\u00b0 Azure CosmosDB\\n\\n. Azure Table Storage\\n\\n\\u00b0 Cassandra\\n\\n\\u00b0 Cloud Firest\", \"ore (Datastore mode)\\n\\n. CloudState\\n\\n\\u00b0 Couchbase\\n\\n. Etcd\\n\\n. HashiCorp Consul\\n\\n: Hazelcast\\n\\n. Memcache\", \"d\\n\\u00b0 MongoDB\\n\\n\\u00b0 PostgreSQL\\n. Redis\\n\\n. RethinkDB\\n\\n\\u00b0 SQL Server\\n\\n. Zookeeper\\n\\nEach component provides t\", \"he necessary implementation through a common state management\\ninterface:\\n\\ntype Store interface {\\nIni\", \"t(metadata Metadata) error\\nDelete(req *DeleteRequest) error\\nBulkDelete(req [ ]DeleteRequest) error\\nG\", \"et(req *GetRequest) (*GetResponse, error)\\nSet(req *SetRequest) error\\nBulkSet(req [ ]SetRequest) erro\", \"r\\n\\nTip\\n\\nThe Dapr runtime as well as all of the Dapr components have been written in the Golang, or G\", \"o,\\nlanguage. Go is a popular language across the open source community and attests to cross-platform\", \"\\ncommitment of Dapr.\\n\\nPerhaps you start with Azure Redis Cache as your state store. You specify it w\", \"ith the following\\nconfiguration:\\n\\n12 CHAPTER 3 | Dapr at 20,000 feet\\n:{custom-style=CodeBox} yaml ap\", \"iVersion: dapr.io/vlalpha1 kind: Component metadata: name:\\n\\nstatestore namespace: default spec: type\", \": state.redis version:v1 metadata: - name: redisHost\\nvalue: <HOST> -name:redisPassword value: <PASSW\", \"ORD> -name:enableTLS _ value:\\n<bool> # Optional. Allowed: true, false. - name: failover value: <bool\", \"> # Optional. Allowed: true,\\nfalse. :::\\n\\nIn the spec section, you configure Dapr to use the Redis Ca\", \"che for state management. The section\\nalso contains component-specific metadata. In this case, you c\", \"an use it to configure additional Redis\\nsettings.\\n\\nAt a later time, the application is ready to go t\", \"o production. For the production environment, you may\\nwant to change your state management to Azure \", \"Table Storage. Azure Table Storage provides state\\nmanagement capabilities that are affordable and hi\", \"ghly durable.\\n\\nAt the time of this writing, the following component types are provided by Dapr:\\n\\nSer\", \"vice Used by the service invocation building block to integrate with the hosting\\ndiscovery environme\", \"nt to provide service-to-service discovery.\\n\\nState Provides a uniform interface to interact with a w\", \"ide variety of state store\\nimplementations.\\nPub/sub Provides a uniform interface to interact with a \", \"wide variety of message bus\\nimplementations.\\n\\nBindings Provides a uniform interface to trigger appli\", \"cation events from external systems and\\ninvoke external systems with optional data payloads.\\n\\nMiddle\", \"ware Allows custom middleware to plug into the request processing pipeline and invoke\\nadditional act\", \"ions on a request or response.\\n\\nSecret stores Provides a uniform interface to interact with external\", \" secret stores, including cloud,\\nedge, commercial, open-source services.\\n\\nAs the jet completes its f\", \"ly over of Dapr, you look back once more and can see how it connects\\ntogether.\\n\\nSidecar architecture\", \"\\n\\nDapr exposes its building blocks and components through a sidecar architecture. A sidecar enables\\n\", \"Dapr to run in a separate memory process or separate container alongside your service. Sidecars\\nprov\", \"ide isolation and encapsulation as they aren't part of the service, but connected to it. This\\nsepara\", \"tion enables each to have its own runtime environment and be built upon different\\nprogramming platfo\", \"rms. Figure 2-4 shows a sidecar pattern.\\n\\n13 CHAPTER 3 | Dapr at 20,000 feet\\nSidecar Primary service\", \"\\n\\nDapr API\\n\\nYour\\nservice\\n\\ngRPC\\n\\nBuilding\\nblocks\\n\\nComponent\\n{Redis Cache)\\n\\nComponent\\n(Azure Service B\", \"us)\\n\\nFigure 2-4. Sidecar architecture.\\n\\nThis pattern is named Sidecar because it resembles a sidecar\", \" attached to a motorcycle. In the previous\\nfigure, note how the Dapr sidecar is attached to your ser\", \"vice to provide distributed application\\ncapabilities.\\n\\nHosting environments\\n\\nDapr has cross-platform\", \" support and can run in many different environments. These environments\\ninclude Kubernetes, a group \", \"of VMs, or edge environments such as Azure loT Edge.\\n\\nFor local development, the easiest way to get \", \"started is with self-hosted mode. In self-hosted mode,\\nthe microservices and Dapr sidecars run in se\", \"parate local processes without a container orchestrator\\nsuch as Kubernetes. For more information, se\", \"e download and install the Dapr CLI.\\n\\nFigure 2-5 shows an application and Dapr hosted in two separat\", \"e memory processes communicating\\nvia HTTP or gRPC.\\n\\n14 CHAPTER 3 | Dapr at 20,000 feet\\n| Service Sta\", \"te |\\nInvocation Management\\n\\nActor\\nRuntime\\n\\n) Observability | Extensible ...\\n\\nBy default, Dapr instal\", \"ls Docker containers for Redis and Zipkin to provide default state management\\n\\no}\\n\\nApplication\\nCode\\n\", \"\\nHTTP / gRPC\\nBindings & Triggers\\n\\nFigure 2-5. Self-hosted Dapr sidecar.\\n\\nand observability. If you d\", \"on\\u2019t want to install Docker on your local machine, you can even run Dapr in\\nself-hosted mode without\", \" any Docker containers. However, you must install default components such\\nas Redis for state managem\", \"ent and pub/sub manually.\\n\\nDapr also runs in containerized environments, such as Kubernetes. Figure \", \"2-6 shows Dapr running in a\\nseparate side-car container along with the application container in the \", \"same Kubernetes pod.\\n\\nService State\\nInvocation Management\\n\\nHTTP / gRPC\\nApplication\\nCode\\n\\nActor\\nRunti\", \"me\\n\\nObservability Extensible ...\\n\\n| Bindings & Triggers\\n\\nFigure 2-6. Kubernetes-hosted Dapr sidecar.\", \"\\n\\nDapr performance considerations\\n\\nAs you've seen, Dapr exposes a sidecar architecture to decouple y\", \"our application from distributed\\napplication capabilities. Invoking a Dapr operation requires at lea\", \"st one out-of-process network call.\\nFigure 2-7 presents an example of a Dapr traffic pattern.\\n\\n15 CH\", \"APTER 3 | Dapr at 20,000 feet\\nApp\\n\\ndapr\\n\\n\\u201cfrontend\\u201d .\\nSidecar\\n\\ndapr\\n\\nComponents\\n\\n\\u201cbackend\\u201d 4\\n\\n\\u2122 Side\", \"car\\n\\nFigure 2-7. Dapr traffic patterns.\\nLooking at the previous figure, one might question the laten\", \"cy and overhead incurred for each call.\\n\\nThe Dapr team has invested heavily in performance. A tremen\", \"dous amount of engineering effort has\\ngone into making Dapr efficient. Calls between Dapr sidecars a\", \"re always made with gRPC, which\\ndelivers high performance and small binary payloads. In most cases, \", \"the additional overhead should\\nbe sub-millisecond.\\n\\nTo increase performance, developers can call the\", \" Dapr building blocks with gRPC.\\n\\ngRPC is a modern, high-performance framework that evolves the age-\", \"old remote procedure call (RPC)\\nprotocol. gRPC uses HTTP/2 for its transport protocol, which provide\", \"s significant performance\\nenhancements over HTTP RESTFul service, including:\\n\\n. Multiplexing support\", \" for sending multiple parallel requests over the same connection - HTTP 1.1\\nlimits processing to one\", \" request/response message at a time.\\n\\n. Bidirectional full-duplex communication for sending both cli\", \"ent requests and server responses\\nsimultaneously.\\n\\n. Built-in streaming enabling requests and respon\", \"ses to asynchronously stream large data sets.\\n\\nTo learn more, check out the gRPC overview from the A\", \"rchitecting Cloud-Native .NET Apps for Azure\\neBook.\\n\\nDapr and service meshes\\n\\nService mesh is anothe\", \"r rapidly evolving technology for distributed applications.\\n\\nA service mesh is a configurable infras\", \"tructure layer with built-in capabilities to handle service-to-\\nservice Communication, resiliency, l\", \"oad balancing, and telemetry capture. It moves the responsibility\\nfor these concerns out of the serv\", \"ices and into the service mesh layer. Like Dapr, a service mesh also\\nfollows a sidecar architecture.\", \"\\n\\nFigure 2-8 shows an application that implements service mesh technology.\\n\\n16 CHAPTER 3 | Dapr at 2\", \"0,000 feet\\n) ) >)\\n\\nmicroservice microservice microservice\\n\\n) )\\n\\nmicroservice microservice microservi\", \"ce\\n\\nFigure 2-8. Service mesh with a side car.\\n\\nThe previous figure shows how messages are intercepte\", \"d by a sidecar proxy that runs alongside each\\nservice. Each proxy can be configured with traffic rul\", \"es specific to the service. It understands messages\\nand can route them across your services and the \", \"outside world.\\n\\nSo the question becomes, \\u201cIs Dapr a service mesh?\\\".\\n\\nWhile both use a sidecar archit\", \"ecture, each technology has a different purpose. Dapr provides\\ndistributed application features. A s\", \"ervice mesh provides a dedicated network infrastructure layer.\\n\\nAs each works at a different level, \", \"both can work together in the same application. For example, a\\nservice mesh could provide networking\", \" communication between services. Dapr could provide\\napplication services such as state management or\", \" actor services.\\n\\nFigure 2-9 shows an application that implements both Dapr and service mesh technol\", \"ogy.\\n\\n17 CHAPTER 3 | Dapr at 20,000 feet\\nService B\\n\\nApplication\\nConcerns\\n\\nDapr\\n\\n| , Dapr\\ndapr sideca\", \"r\\n\\ns hE\\ndapr sidecar\\n\\nNetworking\\nConcerns\\n\\niS Service mesh\\n\\nlinkerd payin\\n\\nService mesh\\n\\n2 Se\\nlinker\", \"d sidecar\\n\\nFigure 2-9. Dapr and service mesh together.\\n\\nThe Dapr online documentation cover Dapr and\", \" service mesh integration.\\n\\nSummary\\n\\nThis chapter introduced you to Dapr, a Distributed Application \", \"Runtime.\\n\\nDapr is an open-source project sponsored by Microsoft with close collaboration from custom\", \"ers and\\nthe open-source community.\\n\\nAt its core, Dapr helps reduce the inherent complexity of distri\", \"buted microservice applications. It's\\nbuilt upon a concept of building block APIs. Dapr building blo\", \"cks expose common distributed\\napplication capabilities, such as state management, service-to-service\", \" invocation, and pub/sub\\nmessaging. Dapr components lie beneath the building blocks and provide the \", \"concrete\\nimplementation for each capability. Applications bind to various components through configu\", \"ration\\nfiles.\\n\\nIn the next chapters, we present practical, hands-on instruction on how to use Dapr i\", \"n your\\napplications.\\n\\nReferences\\n\\n: Dapr documentation\\n\\n. Learning Dapr\\n\\n: .NET Microservices: Archi\", \"tecture for Containerized .NET applications\\n: Architecting Cloud-Native .NET Apps for Azure\\n\\n18 CHAP\", \"TER 3 | Dapr at 20,000 feet\\nCHAPTER |\\n\\nGet started witn Dapr\\n\\nIn the first two chapters, you learned\", \" basic concepts about Dapr. It's time to take it for a test drive. This\\n\\nchapter will guide you thro\", \"ugh preparing your local development environment and building two Dapr\\n.NET applications.\\n\\nInstall D\", \"apr into your local environment\\n\\nYou'll start by installing Dapr on your development computer. Once \", \"complete, you can build and run\\nDapr applications in self-hosted mode.\\n\\n1. Install the Dapr CLI. It \", \"enables you to launch, run, and manage Dapr instances. It also provides\\ndebugging support.\\n\\n2. \\u2014 Ins\", \"tall Docker Desktop. If you're running on Windows, make sure that Docker Desktop for\\nWindows is conf\", \"igured to use Linux containers.\\n\\n['NOTE] By default, Dapr uses Docker containers to provide you the \", \"best out-of-the-box\\nexperience. To run Dapr outside of Docker, you can skip this step and execute a \", \"slim\\ninitialization. The examples in this chapter require you use Docker containers.\\n\\n3. \\u2014 Initializ\", \"e Dapr. This step sets up your development environment by installing the latest Dapr\\nbinaries and co\", \"ntainer images.\\n\\n4. Install the .NET 7 SDK.\\n\\nNow that Dapr is installed, it\\u2019s time to build your fir\", \"st Dapr application!\\n\\nBuild your first Dapr application\\n\\nYou'll start by building a simple .NET Cons\", \"ole application that consumes the Dapr state management\\nbuilding block.\\n\\nCreate the application\\n\\n1. \", \"Open up the command shell or terminal of your choice. You might consider the terminal\\ncapabilities i\", \"n Visual Studio Code. Navigate to the root folder in which you want to build your\\napplication. Once \", \"there, enter the following command to create a new .NET Console application:\\n\\ndotnet new console -o \", \"DaprCounter\\n\\nThe command scaffolds a simple \\\"Hello World\\\" .NET application.\\n\\n19 CHAPTER 4 | Get star\", \"ted with Dapr\\n1. Then, navigate into the new directory created by the previous command:\\n\\ncd DaprCoun\", \"ter\\n\\n1. | Run the newly created application using the dotnet run command. Doing so writes \\u201cHello\\nWor\", \"ld!\\u201d to the console screen:\\n\\ndotnet run\\n\\nAdd Dapr State Management\\n\\nNext, you'll use the Dapr state \", \"management building block to implement a stateful counter in the\\nprogram.\\n\\nYou can invoke Dapr APIs \", \"across any development platform using Dapr\\u2019s native support for HTTP and\\ngRPC. However, .NET Develop\", \"ers will find the Dapr .NET SDK more natural and intuitive. It provides a\\nstrongly typed .NET client\", \" to call the Dapr APls. The .NET SDK also tightly integrates with ASP.NET\\nCore.\\n\\n1. From the termina\", \"l window, add the Dapr.Client NuGet package to your application:\\n\\ndotnet add package Dapr.Client\\n\\n1.\", \" Open the Program.cs file in your favorite editor and update its contents to the following code:\\n\\nus\", \"ing Dapr.Client\\n\\nconst string storeName = \\\"statestore\\\";\\n\\nconst string key = \\\"counter\\\"\\n\\nvar daprClien\", \"t = new DaprClientBuilder().Build();\\n\\nvar counter = await daprClient.GetStateAsync<int>(storeName, k\", \"ey)\\nwhile (true)\\n\\nConsole.WriteLine($\\\"Counter = {counter++}\\\")\\nawait daprClient.SaveStateAsync(storeN\", \"ame, key, counter) ;\\nawait Task.Delay(10@@) ;\\n\\nThe updated code implements the following steps:\\n\\n- F\", \"irst a new [ DaprClient\\u2019 ]{custom-style=Code} instance is instantiated. This class\\nenables you to in\", \"teract with the Dapr sidecar.\\n\\n- From the state store, [\\u00b0 DaprClient.GetStateAsync ]{custom-style=Co\", \"de} fetches the\\nvalue for the [\\u00b0 counter\\u2019 ]{custom-style=Code} key. If the key doesn't exist, the\\nde\", \"fault value for [> int\\u2019 ]{custom-style=Code} (which is [\\u00b0@ ]{custom-style=Code}) is\\nreturned.\\n\\n- The\", \" code then iterates, writing the [\\u00b0 counter\\u2019 |{custom-style=Code} value to the\\nconsole and saving an\", \" incremented value to the state store.\\n\\n1. | The Dapr CLI run command starts the application. It inv\", \"okes the underlying Dapr runtime and\\nenables both the application and Dapr sidecar to run together. \", \"If you omit the app-id, Dapr will\\ngenerate a unique name for the application. The final segment of t\", \"he command, dotnet run,\\ninstructs the Dapr runtime to run the .NET application.\\n\\n[IMPORTANT] Care mu\", \"st be taken to always pass an explicit app-id parameter when consuming\\nthe state management building\", \" block. The block uses the application id value as a prefix for its\\n\\n20 CHAPTER 4 | Get started with\", \" Dapr\\nstate key for each key/value pair. If the application id changes, you can no longer access the\", \"\\npreviously stored state.\\n\\nNow run the application with the following command:\\n\\ndapr run --app-id Da\", \"prCounter dotnet run\\n\\nTry stopping and restarting the application. You'll see that the counter doesn\", \"'t\\nreset. Instead it continues from the previously saved state. The Dapr building block\\nmakes the ap\", \"plication stateful.\\n\\nImportant\\n\\nIt's important to understand your sample application communicates wi\", \"th a pre-configured state\\n\\ncomponent, but has no direct dependency on it. Dapr abstracts away the de\", \"pendency. As you'll\\nshortly see, the underlying state store component can be changed with a simple c\", \"onfiguration update.\\n\\nYou might be wondering, where exactly is the state stored?\\n\\nComponent configur\", \"ation files\\n\\nWhen you first initialized Dapr for your local environment, it automatically provisione\", \"d a Redis\\ncontainer. Dapr then configured the Redis container as the default state store component w\", \"ith a\\ncomponent configuration file, entitled statestore.yaml. Here's a look at its contents:\\n\\napiVer\", \"sion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: statestore\\nspec:\\ntype: state.redis\\nversion: v\", \"1\\nmetadata:\\nname: redisHost\\nvalue: localhost:6379\\nname: redisPassword\\nvalue: \\\"\\\"\\nname: actorStateStor\", \"e\\nvalue: \\\"true\\\"\\n\\nNote\\n\\nDefault component configuration files are stored in the $HOME/.dapr/component\", \"s folder on\\nLinux/macOS, and in the %USERPROFILE%\\\\.dapr\\\\components folder on Windows.\\n\\nNote the form\", \"at of the previous component configuration file:\\n\\n. Each component has a name. In the sample above, \", \"the component is named statestore. We\\nused that name in our first code example to tell the Dapr side\", \"car which component to use.\\n\\n. Each component configuration file has a spec section. It contains a t\", \"ype field that specifies the\\ncomponent type. The version field specifies the component version. The \", \"metadata field\\n\\n21 CHAPTER 4 | Get started with Dapr\\ncontains information that the component require\", \"s, such as connection details and other settings.\\nThe metadata values will vary for the different ty\", \"pes of components.\\n\\nA Dapr sidecar can consume any Dapr component configured in your application. Bu\", \"t, what if you had\\nan architectural justification to limit the accessibility of a component? How cou\", \"ld you restrict the Redis\\ncomponent to Dapr sidecars running only in a production environment?\\n\\nTo d\", \"o so, you could define a namespace for the production environment. You might name it\\nproduction. In \", \"self-hosted mode, you specify the namespace of a Dapr sidecar by setting the\\nNAMESPACE environment v\", \"ariable. When configured, the Dapr sidecar will only load the components\\nthat match the namespace. F\", \"or Kubernetes deployments, the Kubernetes namespace determines the\\ncomponents that are loaded. The f\", \"ollowing sample shows the Redis component placed in a\\nproduction namespace. Note the namespace decla\", \"ration in the metadata element:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: states\", \"tore\\nnamespace: production\\nspec:\\ntype: state.redis\\nversion: v1\\nmetadata:\\nname: redisHost\\nvalue: loca\", \"lhost:6379\\nname: redisPassword\\nvalue: \\\"\\\"\\nname: actorStateStore\\nvalue: \\\"true\\\"\\n\\nImportant\\n\\nA namespace\", \"d component is only accessible to applications running in the same namespace. If your\\nDapr applicati\", \"on fails to load a component, make sure that the application namespace matches the\\ncomponent namespa\", \"ce. This can be especially tricky in self-hosted mode where the application\\nnamespace is stored in a\", \" NAMESPACE environment variable.\\n\\nIf needed, you could further restrict a component to a particular \", \"application. Within the production\\nnamespace, you may want to limit access of the Redis cache to onl\", \"y the DaprCounter application. You\\ndo so by specifying scopes in the component configuration. The fo\", \"llowing example shows how to\\nrestrict access to the Redis statestore component to the application Da\", \"prCounter in the production\\nnamespace:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\n\\nname\", \": statestore\\n\\nnamespace: production\\nspec:\\n\\ntype: state.redis\\n\\nversion: v1\\n\\nmetadata:\\n\\n- name: redisH\", \"ost\\n\\n22 CHAPTER 4 | Get started with Dapr\\nvalue: localhost:6379\\n\\n- name: redisPassword\\nvalue: \\\"\\\"\\n\\n- \", \"name: actorStateStore\\nvalue: \\\"true\\\"\\n\\nscopes:\\n\\n- DaprCounter\\n\\nBuild a multi-container Dapr applicatio\", \"n\\n\\nIn the first example, you created a simple .NET console application that ran side-by-side with a \", \"Dapr\\nsidecar. Modern distributed applications, however, often consist of many moving parts. They can\", \"\\nsimultaneously run independent microservices. These modern applications are typically containerized\", \"\\nand require container orchestration tools such as Docker Compose or Kubernetes.\\n\\nIn the next exampl\", \"e, you'll create a multi-container application. You'll also use the Dapr service\\ninvocation building\", \" block to communicate between services. The solution will consist of a web\\napplication that retrieve\", \"s weather forecasts from a web API. They will each run in a Docker container.\\nYou'll use Docker Comp\", \"ose to run the container locally and enable debugging capabilities.\\n\\nMake sure you've configured you\", \"r local environment for Dapr and installed the .NET 7 Development\\nTools (instructions are available \", \"at the beginning of this chapter).\\n\\nAdditionally, you'll need to complete this sample using Visual S\", \"tudio 2022 with the ASP.NET and web\\ndevelopment workload installed.\\n\\nCreate the application\\n1. In Vi\", \"sual Studio 2022, create an ASP.NET Core Web App project:\\n\\n23 CHAPTER 4 | Get started with Dapr\\n24\\n\\n\", \"C reate a n ew p ro} ect Search for templates (Alt+S) P -\\n\\nRecent project templates All languages * \", \"All platforms * All project types .\\n\\n\\u2014 aa your recently accessed templates will be macs Console App\\n\", \"em A project for creating a command-line application that can run on .NET Core on\\nWindows, Linux and\", \" macOS\\n\\nc+ Linux macOS Windows Console\\n\\nfen Console App\\nA project for creating a command-line applic\", \"ation that can run on .NET Core on\\nWindows, Linux and macOS\\n\\nVisual Basic Linux macOS Windows Consol\", \"e\\n\\nASP.NET Core Web App\\nA project template for creating an ASP.NET Core application with example ASP\", \".NET\\n\\nRazor Pages content.\\n\\nc+ Linux macOS Windows Cloud Service Web\\n\\na, Blazor WebAssembly App\\n\\nA p\", \"roject template for creating a Blazor app that runs on WebAssembly and is\\noptionally hosted by an AS\", \"P.NET Core app. This template can be used for web apps\\nwith rich dynamic user interfaces (Uls).\\n\\nc+ \", \"Linux macOS Windows Cloud Web\\n\\nness Class Library\\n\\na\\n\\nName your project MyFrontEnd and your solution\", \" DaprMultiContainer:\\n\\nCHAPTER 4 | Get started with Dapr\\nConfigure your new project\\n\\nASP.NET Core Web\", \" App c# Linux = macOS Windows Cloud Service Web\\n\\nProject name\\n\\nMyFrontEnd |\\n\\nLocation\\n\\nCAGit\\\\ - | ws\", \" |\\n\\nSolution\\n\\nCreate new solution .\\n\\nSolution name @\\n\\nDaprMultiContainer |\\n\\nCJ Place solution and pr\", \"oject in the same directory\\n\\n1. \\u2014 In the final dialog, keep the defaults. Don't select Enable Docker\", \" Support. You'll add Docker\\nsupport later.\\n\\n25 CHAPTER 4 | Get started with Dapr\\n1.\\n\\n26\\n\\nAdditional \", \"information\\n\\nASP.NET Core Web App C_\\u2014 linux = macOS = Windows = Cloud \\u2014 Service. = Web\\n\\nFramework @\\n\", \"\\n-NET 6.0 (Long-term support)\\n\\nAuthentication type @\\n\\nNone bd\\n\\n[\\u00a5| Configure for HTTPS @\\n|_| Enable \", \"Docker @\\nDocker OS @\\n\\nLinux\\n\\nFor the backend, add an ASP.NET Core Web API project to the same soluti\", \"on:\\n\\nCHAPTER 4 | Get started with Dapr\\nAd d a n ew p ro} ect Search for templates (Alt+S) Pp\\n\\nRecent\", \" project templates All languages ~ All platforms * All project types .\\n\\n= A project template for cre\", \"ating a Blazor server app that runs server-side inside an\\n\\u00ae) ASP.NET Core Web App c# ASP.NET Core ap\", \"p and handles user interactions over a SignalR connection. This\\ntemplate can be used for web apps wi\", \"th rich dynamic user interfaces (Uls).\\n\\nc+ Linux macOS Windows Cloud Web\\n\\nASP.NET Core Web API\\n\\nA pr\", \"oject template for creating an ASP.NET Core application with an example\\nController for a RESTful HTT\", \"P service. This template can also be used for ASP.NET\\n\\nCore MVC Views and Controllers.\\n\\nc+ Linux mac\", \"OS Windows Cloud Service Web\\n\\nASP.NET Core gRPC Service\\nA project template for creating a gRPC ASP.N\", \"ET Core service.\\n\\nc+ Linux macOS Windows Cloud Service Web\\n\\ncS Worker Service\\nAn empty project templ\", \"ate for creating a worker service.\\n\\nC# Linux macOS Windows Cloud Service\\n\\nLA} ASP.NET Core with Angu\", \"lar\\nA project template for creating an ASP.NET Core application with Angular\\n\\nC# Linux macOS Windows\", \" Cloud Service Web\\n\\nNext\\n\\n1. Name the project MyBackEnd:\\n\\n1. By default, a Dapr sidecar relies on th\", \"e network boundary to limit access to its public API. So,\\nclear the checkbox for Configure for HTTPS\", \":\\n\\n> [! IMPORTANT]\\n\\n> If you leave the **Configure for HTTPS** checkbox checked, the generated ASP.N\", \"ET\\nCore API project includes middleware to redirect client requests to the HTTPS\\nendpoint. This brea\", \"ks communication between the Dapr sidecar and your application,\\nunless you explicitly configure the \", \"use of HTTPS when running your Dapr application.\\nTo enable the Dapr sidecar to communicate over HTTP\", \"S, include the [\\u00b0 --app-\\n\\nssl\\u00b0 ]{custom-style=Code} flag in the Dapr command to start the applicatio\", \"n. Also\\nspecify the HTTPS port using the [\\u00b0 --app-port> ]{custom-style=Code} parameter. The\\nremainde\", \"r of this walkthrough uses plain HTTP communication between the sidecar and\\nthe application, and req\", \"uires you to clear the **Configure for HTTPS** checkbox.\\n\\nAdd Dapr service invocation\\n\\nNow, you'll c\", \"onfigure communication between the services using Dapr service invocation building\\nblock. You'll ena\", \"ble the web app to retrieve weather forecasts from the web API. The service\\ninvocation building bloc\", \"k features many benefits. It includes service discovery, automatic retries,\\nmessage encryption (usin\", \"g mTLS), and improved observability. You'll use the Dapr .NET SDK to invoke\\nthe service invocation A\", \"PI on the Dapr sidecar.\\n\\n27 CHAPTER 4 | Get started with Dapr\\n1. In Visual Studio, open the Package \", \"Manager Console (Tools > NuGet Package Manager >\\nPackage Manager Console) and make sure that MyFront\", \"End is the default project. From the\\nconsole, add the Dapr.AspNetCore NuGet package to the project:\\n\", \"\\nInstall-Package Dapr.AspNetCore\\n\\n1. In the MyFrontEnd project, open the Program.cs file and add a c\", \"all to\\nbuilder.Services.AddDaprClient:\\n\\nvar builder = WebApplication.CreateBuilder (args)\\n// Add ser\", \"vices to the container.\\n\\nbuilder.Services.AddDaprClient() ;\\nbuilder.Services.AddRazorPages()\\n\\nHi occ\", \"\\n\\nThe [\\u00b0 AddDaprClient\\u2122 |{custom-style=Code} call registers the [ DaprClient\\u2122 |]{custom-\\nstyle=Code}\", \" class with the ASP.NET Core dependency injection system. With the client\\nregistered, you can now in\", \"ject an instance of [ DaprClient\\u2019 |{custom-style=Code} into\\nyour service code to communicate with th\", \"e Dapr sidecar, building blocks, and\\ncomponents.\\n\\n1. Add anew C# class file named WeatherForecast to\", \" the MyFrontEnd project:\\n\\nnamespace MyFrontEnd\\npublic class WeatherForecast\\n{\\npublic DateTime Date {\", \" get; set;\\npublic int TemperatureC { get; set;\\npublic int TemperatureF { get; set;\\npublic string Sum\", \"mary { get; set; } = string.Empty;\\n\\n1. Open the Index.cshtml.cs file in the Pages folder, and replac\", \"e its contents with the following\\ncode:\\n\\nusing Dapr.Client;\\nusing Microsoft.AspNetCore.Mvc.RazorPage\", \"s\\nnamespace MyFrontEnd.Pages\\npublic class IndexModel : PageModel\\n{\\nprivate readonly DaprClient _dapr\", \"Client\\npublic IndexModel(DaprClient daprClient)\\n\\n{\\n_daprClient = daprClient;\\n\\npublic async Task OnGe\", \"t()\\n{\\n\\nvar forecasts = await _daprClient.InvokeMethodAsync<IEnumerable<WeatherForecast>>(\\nHttpMethod\", \".Get,\\n\\u201cMyBackEnd\\\",\\n\\\"weatherforecast\\\" )\\n\\nViewData[\\\"WeatherForecastData\\\"] = forecasts;\\n\\nYou add Dapr c\", \"apabilities into the web app by injecting the [ DaprClient\\u2019 ]{custom-\\nstyle=Code} class into [\\u00b0 Inde\", \"xModel\\u201d ]{custom-style=Code} constructor. In the\\n\\n[~ OnGet> ]{custom-style=Code} method, you call th\", \"e backend API service with the Dapr\\nservice invocation building block. The [\\u00b0 OnGet> ]{custom-style=\", \"Code} method is invoked\\n\\n28 CHAPTER 4 | Get started with Dapr\\nwhenever a user visits the home page. \", \"You use the\\n\\n[\\u00b0 DaprClient.InvokeMethodAsync\\u2019 |{custom-style=Code} method to invoke the\\n\\n[ weatherfo\", \"recast\\u2019 |{custom-style=Code} method of the [~MyBackEnd ]{custom-style=Code }\\nservice. You'll configu\", \"re the web API to use [\\u00b0MyBackEnd ]{custom-style=Code} as its\\napplication ID later on when configuri\", \"ng it to run with Dapr. Finally, the service\\nresponse is saved in view data.\\n\\n1. Replace the content\", \"s of the /ndex.cshtml file in the Pages folder, with the following code. It\\ndisplays the weather for\", \"ecasts stored in the view data to the user:\\n\\n@page\\n@model IndexModel\\n\\n@t\\nViewData[\\\"Title\\\"] = \\\"Home p\", \"age\\\";\\n\\n<div class=\\\"text-center\\\">\\n\\n<h1 class=\\\"display-4\\\">Welcome</h1>\\n\\n<p>Learn about <a href=\\\"https:\", \"//learn.microsoft.com/aspnet/core\\\">building Web apps with\\nASP .NECore</a>.</p>\\n\\n@foreach (var foreca\", \"st in\\n(IEnumerable<WeatherForecast>)ViewData[ \\\"WeatherForecastData\\\" |! )\\n\\nt\\n}\\n\\n</div>\\n\\n<p>The foreca\", \"st for @forecast.Date is @forecast.Summary!</p>\\n\\nAdd container support\\n\\nIn the final part of this ex\", \"ample, you'll add container support and run the solution using Docker\\nCompose.\\n\\n1. \\u2014 Right-click the\", \" MyFrontEnd project, and choose Add > Container Orchestrator Support.... The\\nAdd Container Orchestra\", \"tor Support dialog appears:\\n\\nAdd Container Orchestrator Support\\n\\nContainer orchestrator:\\n\\nChoose **D\", \"ocker Compose**.\\n\\n1. Inthe next dialog, select Linux as the Target OS:\\n\\n29 CHAPTER 4 | Get started w\", \"ith Dapr\\nDocker Support Options\\n\\nTarget OS:\\n(\\u00ae) Linux\\n\\n() Windows\\n\\nVisual Studio creates a *docker-c\", \"ompose.yml*file and a *.dockerignore* file in the\\n**docker-compose** folder in the solution:\\n\\n30 CHA\", \"PTER 4 | Get started with Dapr\\nSolution Explorer\\n\\na@ e-Cae@ |s)-| \\u00a3/=\\n\\nSearch Solution Explorer (Ctr\", \"l+:) Ply\\n\\n[) .dockerignore\\n\\nfa docker-composeyml\\n\\ncao Connected Services\\ndo Dependencies\\n\\na_] Proper\", \"ties\\n\\nF) Controllers\\nappsettings.json\\n\\u20ac# Program.cs\\n\\nC# WeatherForecast.cs\\nai ro My FrontEnd\\n\\ncao Co\", \"nnected Services\\nfo Dependencies\\n\\na_] Properties\\n\\n@ www root\\n\\nPI] Pages\\nappsettings,json\\n\\n[ ) Docker\", \"file\\n\\nC# Program.cs\\n\\nC# WeatherForecast.cs\\n\\ni i a a a a eee\\n\\nSe RF NF RF BF Br MF\\n\\nThe *docker-compo\", \"se.yml* file has the following content:\\n\\nversion: '3.4\\nservices:\\nmyfrontend:\\n\\nimage: ${DOCKER_REGIST\", \"RY- }myfrontend\\nbuild:\\n\\ncontext: .\\n\\ndockerfile: MyFrontEnd/Dockerfile\\n\\nThe *.dockerignore* file cont\", \"ains file types and extensions that you don't want Docker\\nto include in the container. These files a\", \"re associated with the development\\nenvironment and source control and not the app or service you're \", \"deploying.\\n\\n31 CHAPTER 4 | Get started with Dapr\\nIn the root of the *MyFrontEnd* project directory, \", \"a new *Dockerfile* was created. A\\n*Dockerfile* is a sequence of commands that are used to build an i\", \"mage. For more\\ninformation, see [Dockerfile\\n\\nreference ]|(https://docs.docker.com/engine/reference/b\", \"uilder).\\n\\nThe *Dockerfile* contains the following commands:\\n\\nFROM mcr.microsoft.com/dotnet/aspnet:7.\", \"@ AS base\\n\\nWORKDIR /app\\n\\nEXPOSE 80\\n\\nEXPOSE 44\\n\\nFROM mcr.microsoft.com/dotnet/sdk:7.@ AS build\\n\\nWORKD\", \"IR /src\\n\\nCOPY [\\\"MyFrontEnd/MyFrontEnd.csproj\\\", \\\"MyFrontEnd/\\\" |\\n\\nRUN dotnet restore \\\"MyFrontEnd/MyFro\", \"ntEnd.csproj\\\"\\n\\nCOPY .\\n\\nWORKDIR \\\"/src/MyFrontEnd\\\"\\n\\nRUN dotnet build \\\"MyFrontEnd.csproj\\\" -c Release -o\", \" /app/buil\\nFROM build AS publish\\n\\nRUN dotnet publish \\\"MyFrontEnd.csproj\\\" -c Release -o /app/publis\\nF\", \"ROM base AS final\\n\\nWORKDIR /app\\n\\nCOPY --from=publish /app/publish .\\n\\nENTRYPOINT [\\\"dotnet\\\", \\\"MyFrontE\", \"nd.d1l\\\" |\\n\\nThe preceding *Dockerfile* sequentially performs the following steps when invoked:\\n\\n1. Pu\", \"lls the [ mcr.microsoft.com/dotnet/aspnet:7.0 |{custom-style=Code} image and\\nnames it [ base |{custo\", \"m-style=Code}.\\n2. Sets the working directory to */app*.\\n3. Exposes port [ 80 |{custom-style=Code} an\", \"d [ 443\\u00b0 ]{custom-style=Code}.\\n4. Pulls the [ mcr.microsoft.com/dotnet/sdk:7.0 ]{custom-style=Code} \", \"image and names\\nit [\\u00b0 build\\u2019 ]{custom-style=Code}.\\n5. Sets the working directory to */src*.\\n6. Copie\", \"s the _MyFrontEnd/MyFrontEnd.csproj_ to a new directory named *MyFrontEnd/*.\\n7. Calls [[\\u00b0 dotnet res\", \"tore ]{custom-style=Code}](https://docs.microsoft.com/en-\\nus/dotnet/core/tools/dotnet-restore) on th\", \"e project.\\n8. Copies everything from the root directory into the image's root.\\n9. Sets the working d\", \"irectory to _/src/MyFrontEnd_.\\n18. Calls [[\\u00b0 dotnet build ]{custom-style=Code}](https://docs.microso\", \"ft.com/en-\\nus/dotnet/core/tools/dotnet-build) on the project.\\n\\n- Targeting the **Release** configura\", \"tion and outputs to */app/build*.\\n11. Initializes a new build stage from the existing [> build ]{cus\", \"tom-style=Code} base\\nimage and names it [ publish ]{custom-style=Code}.\\n12. Calls [\\u00b0 dotnet publish \", \"]{custom-style=Code} on the project.\\n\\n- Targeting the **Release** configuration and outputs to */app\", \"/publish*.\\n13. Initializes a new build stage from the existing [> publish ]{custom-style=Code}\\nbase \", \"image and names it [\\u00b0 final\\u201d ]|{custom-style=Code}.\\n14. Sets the working directory to */app*.\\n15. Co\", \"pies the [> /app/publish ]{custom-style=Code} directory from the\\n[- publish ]{custom-style=Code} ima\", \"ge into the root of the [\\u00b0 final\\u201d ]{custom-style=Code}\\nimage.\\n16. Sets the entry point as the image \", \"to [ dotnet ]{custom-style=Code} and passes the\\n[~\\u201cMyFrontEnd.dll~> ]{custom-style=Code} as an arg.\\n\", \"\\n32 CHAPTER 4 | Get started with Dapr\\n1. In the MyBackEnd web API project, right-click on the projec\", \"t node, and choose Add > Container\\nOrchestrator Support.... Choose Docker Compose, and then select L\", \"inux again as the target\\nOS.\\n\\nIn the root of the MyBackEnd project directory, a new Dockerfile was c\", \"reated. The Dockerfile\\ncontains the following commands:\\n\\nFROM mcr.microsoft.com/dotnet/aspnet:7.@ AS\", \" base\\n\\nWORKDIR /app\\n\\nEXPOSE 8\\n\\nFROM mcr.microsoft.com/dotnet/sdk:7.0 AS build\\n\\nWORKDIR /src\\n\\nCOPY [\\\"\", \"MyBackEnd/MyBackEnd.csproj\\\", \\\"\\u201cMyBackEnd/\\\" |\\n\\nRUN dotnet restore \\\"MyBackEnd/MyBackEnd.csproj\\\"\\n\\nCOPY \", \".\\n\\nWORKDIR \\\"/src/MyBackEnd\\\"\\n\\nRUN dotnet build \\\"MyBackEnd.csproj\\\" -c Release -o /app/buil\\nFROM build \", \"AS publish\\n\\nRUN dotnet publish \\\"MyBackEnd.csproj\\\" -c Release -o /app/publis\\nFROM base AS final\\n\\nWORK\", \"DIR /app\\n\\nCOPY --from=publish /app/publish .\\n\\nENTRYPOINT [\\\"dotnet\\\", \\\"MyBackEnd.d1l\\\" |\\n\\nOpen the *doc\", \"ker-compose.yml* file again and examine its contents. Visual Studio has\\nupdated the **Docker Compose\", \"** file. Now both services are included:\\n\\nversion: '3.4\\nservices:\\nmyfrontend:\\nimage: ${DOCKER_REGIST\", \"RY- }myfrontend\\nbuild:\\ncontext:\\ndockerfile: MyFrontEnd/Dockerfil\\nmybackend:\\nimage: ${DOCKER_REGISTRY\", \"- }mybackend\\nbuild:\\ncontext:\\ndockerfile: MyBackEnd/Dockerfile\\n\\n1. | To use Dapr building blocks from\", \" inside a containerized application, you'll need to add the Dapr\\nsidecars containers to your Compose\", \" file. Carefully update the content of the docker-\\ncompose.yml file to match the following example. \", \"Pay close attention to the formatting and\\nSpacing and don't use tabs.\\n\\nversion: '3.4\\n\\nservices:\\nmyfr\", \"ontend:\\nimage: ${DOCKER_REGISTRY- }myfrontend\\nbuild:\\ncontext:\\ndockerfile: MyFrontEnd/Dockerfile\\nport\", \"s:\\n\\n- \\\"51000@:50001\\nmyfrontend-dapr:\\nimage: \\\"daprio/daprd: latest\\\"\\ncommand: [ \\\"./daprd\\\", \\\"-app-id\\\", \", \"\\\"MyFrontEnd\\\", \\\"-app-port\\\", \\\"80\\\" ]\\ndepends_on:\\n\\n33 CHAPTER 4 | Get started with Dapr\\n- myfrontend\\nnet\", \"work_mode: \\\"service:myfrontend\\nmybackend:\\nimage: ${DOCKER_REGISTRY- }mybackend\\nbuild:\\ncontext: .\\ndoc\", \"kerfile: MyBackEnd/Dockerfile\\nports:\\n- \\\"52000:50001\\nmybackend-dapr:\\nimage: \\\"daprio/daprd: latest\\\"\\nco\", \"mmand: [ \\\"./daprd\\\", \\\"-app-id\\\", \\\"MyBackEnd\\\", \\\"-app-port\\\", \\\"8e@\\\" |\\ndepends_on:\\n- mybackend\\nnetwork_mod\", \"e: \\\"service:mybackend\\\"\\n\\nIn the updated file, we've added [\\u00b0 myfrontend-dapr\\u2019 |{custom-style=Code} an\", \"d\\n\\n[~ mybackend-dapr\\u2019 ]{custom-style=Code} sidecars for the [> myfrontend\\u2019 ]{custom-\\nstyle=Code} and\", \" [ mybackend\\u2019 |{custom-style=Code} services respectively. In the updated\\nfile, pay close attention t\", \"o the following changes:\\n\\n- The sidecars use the [ daprio/daprd:latest\\u2019 ]{custom-style=Code} contain\", \"er image. The\\nuse of the [\\u00b0 latest\\u2019 ]{custom-style=Code} tag isn't recommended for production\\nscenar\", \"ios. For production, it's better to use a specific version number.\\n\\n- Each service defined in the Co\", \"mpose file has its own network namespace for network\\nisolation purposes. The sidecars use [ network \", \"_mode: \\\"service:...\\\"  |{custom-\\nstyle=Code} to ensure they run in the same network namespace as the \", \"application. Doing\\nso allows the sidecar and the application to communicate using [> localhost\\u2122 |{cu\", \"stom-\\nstyle=Code}.\\n\\n- The ports on which the Dapr sidecars are listening for gRPC communication (by\\n\", \"default 50001) must be exposed to allow the sidecars to communicate with each other.\\n\\n1. Run the sol\", \"ution (F5 or Ctrl+F5) to verify that it works as expected. If everything is configured\\ncorrectly, yo\", \"u should see the weather forecast data:\\n\\n34 CHAPTER 4 | Get started with Dapr\\n| Home page - MyFrontE\", \"nd x + \\u00b0\\n\\nCc @ localhost:59782 w \\u00ab6\\n\\nMyFrontEnd Home Privacy\\n\\nWelcome\\n\\nLearn about building Web apps\", \" with ASP.NET Core.\\n\\nThe forecast for 11/18/2021 16:42:41 is Mild!\\nThe forecast for 11/19/2021 16:42\", \":41 is Sweltering!\\nThe forecast for 11/20/2021 16:42:41 is Sweltering!\\nThe forecast for 11/21/2021 1\", \"6:42:41 is Sweltering!\\n\\nThe forecast for 11/22/2021 16:42:41 is Sweltering!\\n\\n\\u00a9 2021 - MyFrontEnd - P\", \"rivacy\\n\\nRunning locally with Docker Compose and Visual Studio, you can set breakpoints and\\ndebug int\", \"o the application. For production scenarios, it's recommended to host your\\napplication in Kubernetes\", \". This book includes an accompanying reference application,\\n[eShopOnDapr ] (https://github.com/dotne\", \"t-architecture/eShopOnDapr), that contains\\nscripts to deploy to Kubernetes.\\n\\nTo learn more about the\", \" Dapr service invocation building block used in this\\nwalkthrough, refer to [chapter 6](#the-dapr-ser\", \"vice-invocation-building-blo).\\n\\nSummary\\n\\nIn this chapter, you had an opportunity to test drive Dapr.\", \" Using the Dapr .NET SDK, you saw how\\nDapr integrates with the .NET application platform.\\n\\nThe first\", \" example was a simple, stateful, .NET Console application that used the Dapr state\\nmanagement buildi\", \"ng block.\\n\\nThe second example involved a multi-container application running in Docker. By using Vis\", \"ual Studio\\nwith Docker Compose, you experienced the familiar F5 debugging experience available acros\", \"s all .NET\\n\\napps.\\n\\nYou also got a closer look at Dapr component configuration files. They configure \", \"the actual\\ninfrastructure implementation used by the Dapr building blocks. You can use namespaces an\", \"d scopes\\nto restrict component access to particular environments and applications.\\n\\nIn the upcoming \", \"chapters, you'll dive deep into the building blocks offered by Dapr.\\n\\nReferences\\n\\n\\u00b0 Dapr documentati\", \"on - Getting started\\n\\u00b0 eShopOnDapr\\n\\n35 CHAPTER 4 | Get started with Dapr\\nCHAPTER\\n\\nTrattic Control sa\", \"mple\\napplication\\n\\nIn the first chapters, you've learned about basic Dapr concepts. You saw how Dapr \", \"can help you and\\nyour team construct distributed applications while reducing architectural and opera\", \"tional complexity.\\nThis chapter introduces the sample application that you'll use to explore the Dap\", \"r building blocks. The\\napplication targets .NET 7 and uses the latest C# 11 language features.\\n\\nNote\", \"\\n\\nDownload the sample application code from the Dapr Traffic Control GitHub repo. This repository\\nco\", \"ntains a detailed description on how you can run the sample application on your machine.\\n\\nThe Traffi\", \"c Control sample application simulates a highway traffic control system. Its purpose is to\\ndetect sp\", \"eeding vehicles and send the offending driver a fine notice. These systems actually exist in\\nreal li\", \"fe and here's how they work. A set of cameras (one above each lane) is placed at the beginning\\nand e\", \"nd of a highway stretch (say 10 kilometers) without on- or off-ramps. As a vehicle passes\\nunderneath\", \" a camera, it takes a photograph of the vehicle. Using Optical Character Recognition (OCR)\\nsoftware,\", \" it extracts the license number of the vehicle from the photo. Using the entry- and exit-\\ntimestamp \", \"of each vehicle, the system calculates the average speed of that vehicle. If the average\\nspeed is ab\", \"ove the maximum speed limit for that highway stretch, the system retrieves the driver\\ninformation an\", \"d automatically sends a fine notice.\\n\\nAlthough the simulation is simple, responsibilities within the\", \" system are separated into several\\nmicroservices. Figure 4.1 shows an overview of the services that \", \"are part of the application:\\n\\n36 CHAPTER 5 | Traffic Control sample application\\nCamera\\nSimulation\\nSe\", \"rvice\\n\\n/exitcam\\n\\n/entrycam\\n\\nTrafficControl\\nService\\n\\n/collectfine\\n\\nFineCollection\\nService\\n\\n/vehiclein\", \"fo\\n\\nVehicleRegistration\\n\\nService\\n\\n37 CHAPTER 5 | Traffic Control sample application\\nFigure 4-1. The \", \"services in the sample application.\\n\\nThe Camera Simulation is a console application that simulates v\", \"ehicles and sends messages to\\nthe TrafficControl service. Every simulated car invokes both the entry\", \" and exit service endpoints.\\n\\nThe TrafficControl service is an ASP.NET Core Web API application that\", \" exposes the /entrycam\\nand /exitcam endpoints. Invoking an endpoint simulates a car passing under on\", \"e of the entry-\\nor exit-cameras respectively. The request message payload simply contains the licens\", \"e plate of\\nthe car (no actual OCR is implemented).\\n\\nThe FineCollection service is an ASP.NET Core We\", \"b API application that offers 1 endpoint:\\n/collectfine. Invoking this endpoint will send a fine noti\", \"ce to the driver of the speeding\\nvehicle. The payload of the request contains all the information ab\", \"out the speeding violation.\\n\\nThe VehicleRegistration service is an ASP.NET Core Web API application \", \"that offers 1 endpoint:\\n/vehicleinfo/{licensenumber}. It's used for obtaining vehicle- and owner-inf\", \"ormation for a\\nspeeding vehicle based on the license number sent in the URL (for example, /vehiclein\", \"fo/RV-\\n752-S).\\n\\nThe sequence diagram in figure 4.2 shows the simulation flow:\\n\\nRandom\\nInterval\\n\\nTraf\", \"fic Control Vehicle Registration\\nService Service |\\n\\nVehicle\\nState\\n\\nFine Collection\\nService\\n\\nPOST /en\", \"trycam\\n\\nPOST /exitcam\\n\\nGet\\nVehicle\\nState\\n\\nCalculate\\nAverage\\nSpeed\\n\\n[Average speed over limit]\\nPOST /\", \"collectfine\\n\\nCalculate\\nFine\\n\\nGET /vehicleinfo/KL-714-V\\n\\nSend email\\n\\nFigure 4-2. Sequence diagram of \", \"the simulation flow.\\n\\nThe services communicate by directly invoking each other's APls. This design w\", \"orks fine, but it has\\n\\nsome drawbacks.\\n\\n38\\n\\nCHAPTER 5 | Traffic Control sample application\\nThe bigge\", \"st challenge is that the call-chain will break if one of the services is off-line. Decoupling\\nservic\", \"es by replacing direct calls with asynchronous messaging would solve this issue. Asynchronous\\nmessag\", \"ing Is typically implemented with a message broker like RabbitMQ or Azure Service Bus.\\n\\nAnother draw\", \"back is that the vehicle state for every vehicle is stored in memory in the TrafficControl\\nservice. \", \"This state is lost when the service is restarted after an update or a crash. To increase system\\ndura\", \"bility, state should be stored outside the service.\\n\\nUsing Dapr building blocks\\n\\nOne of the goals of\", \" Dapr is to provide cloud-native capabilities for microservices applications. The\\nTraffic Control ap\", \"plication uses Dapr building blocks to increase robustness and mitigate the design\\ndrawbacks describ\", \"ed in the previous paragraph. Figure 4.shows a Dapr-enabled version of the traffic\\ncontrol applicati\", \"on:\\n\\nFigure 4-3. Traffic Control application with Dapr building blocks.\\n\\n1. Service invocation The D\", \"apr service invocation building block handles request/response\\ncommunication between the FineCollect\", \"ionService and the VehicleRegistrationService. Because\\nthe call is a query to retrieve required data\", \" to complete the operation, a synchronous call is\\nacceptable here. The service invocation building b\", \"lock provides service discovery. The\\nFineCollection service no longer has to know where the VehicleR\", \"egistration service lives. It also\\nimplements automatic retries if the VehicleRegistration service i\", \"s off-line.\\n\\n2. Publish & subscribe The publish and subscribe building block handles asynchronous me\", \"ssaging\\nfor sending speeding violations from the TrafficControl service to the FineCollectionService\", \". This\\nimplementation decouples the TrafficControl and FineCollection service. If the\\nFineCollection\", \"Service were to become temporarily unavailable, data would accumulate in the\\nqueue and resume proces\", \"sing at a later time. RabbitMQ is the current message broker that\\ntransports messages from the produ\", \"cers to the consumers. As the Dapr pub/sub building block\\nabstracts the message broker, developers d\", \"on\\u2019t need to learn the details of the RabbitMQ client\\nlibrary. Switching to another message broker d\", \"oesn\\u2019t require code changes, only configuration.\\n\\n3. State management The TrafficControl service use\", \"s the state management building block to\\npersist vehicle state outside of the service in a Redis cac\", \"he. As with pub/sub, developers don't\\nneed to learn Redis specific APIs. Switching to another data s\", \"tore requires no code changes.\\n\\n4. Output binding The FineCollection service sends fines to the owne\", \"rs of speeding vehicles by\\nemail. The Dapr output binding for SMTP abstracts the email transmission \", \"using the SMTP\\nprotocol.\\n\\n5. Input binding The CameraSimulation sends messages with simulated car in\", \"fo to the\\nTrafficControl service using the MQTT protocol. It uses a .NET MQTT library for sending\\nme\", \"ssages to Mosquitto - a lightweight MQTT broker. The TrafficControl service uses the Dapr\\ninput bind\", \"ing for MQTT to subscribe to the MQTT broker and receive messages.\\n\\n6. Secrets management The FineCo\", \"llectionService needs credentials for connecting to the smtp\\nserver and a license-key for a fine cal\", \"culator component it uses internally. It uses the secrets\\nmanagement building block to obtain the cr\", \"edentials and the license-key.\\n\\n39 CHAPTER 5 | Traffic Control sample application\\n7. Actors The Traf\", \"ficControlService has an alternative implementation based on Dapr actors. In this\\nimplementation, th\", \"e TrafficControl service creates a new actor for every vehicle that is registered\\nby the entry camer\", \"a. The license number of the vehicle forms the unique actor Id. The actor\\nencapsulates the vehicle s\", \"tate, which it persists in the Redis cache. When a vehicle is registered\\nby the exit camera, it invo\", \"kes the actor. The actor then calculate the average speed and possibly\\nissue a speeding violation.\\n\\n\", \"Figure 4.4 shows a sequence diagram of the flow of the simulation with all the Dapr building blocks \", \"in\\nplace:\\n\\n= { Fine } = F; e |\\ndapr | Collection | dapr |\\nSidecar \\\\__ Service \\u2014\\n\\nVehic\\nRegistration\\n\", \"Service\\n\\nEl)\\n\\nSS. fo) oes ee\\n= || \\u2018S| ie |\\n\\nRedis_ Rabbit >\\nPOST /entrycam\\nStore vehicle state\\n\\nStor\", \"e vehicle state\\n\\nice | J | Sideca {\\n\\nba yon\\n\\u2018collectfine\\n\\u2014 Calculate\\nFine\\ninvoke vehicieinfo/KL-714-\", \"V\\n\\nInvoke vehicleinfo/KL-714-V\\n\\nGET vehicleinfo/KL-7 14-V\\n\\ninvoke email bindin:\\n\\\"ll email\\n\\nFigure 4-\", \"4. Sequence diagram of simulation flow with Dapr building blocks.\\n\\nThe rest of this book features a \", \"chapter for each of the Dapr building blocks. Each chapter explains in\\ndetail how the building block\", \" works, its configuration, and how to use it. Each chapter explains how\\nthe Traffic Control sample a\", \"pplication uses the building block.\\n\\nHosting\\n\\nThe Traffic Control sample application can run in self\", \"-hosted mode or in Kubernetes.\\n\\nSelf-hosted mode\\n\\nThe sample repository contains PowerShell scripts \", \"to start the infrastructure services (Redis,\\nRabbitMQ, and Mosquitto) as Docker containers on your m\", \"achine. They're located in the\\nsrc/Infrastructure folder. For every application service in the solut\", \"ion, the repository contains a\\nseparate folder. Each of these folders contains a start-selfhosted.ps\", \"1 PowerShell script to start the\\nservice with Dapr.\\n\\n40 CHAPTER 5 | Traffic Control sample applicati\", \"on\\nKubernetes\\n\\nThe src/k8s folder in the sample repository contains the Kubernetes manifest files to\", \" run the\\napplication (including the infrastructure services) with Dapr in Kubernetes. This folder al\", \"so contains a\\nstart.ps1 and stop.psi1 PowerShell script to start and stop the solution in Kubernetes\", \". All services\\nwill run in the dapr-trafficcontrol namespace.\\n\\nSummary\\n\\nThe Traffic Control sample a\", \"pplication is a microservices application that simulates a highway speed\\ntrap.\\n\\nThe application uses\", \" several Dapr building blocks to make it robust and cloud-native. The domain is\\nkept simple to keep \", \"the focus on Dapr.\\n\\nThe application will be used in the following chapters that focus on Dapr buildi\", \"ng block.\\n\\nReferences\\n\\n\\u00b0 Dapr Traffic Control Sample\\n\\n41 CHAPTER 5 | Traffic Control sample applicat\", \"ion\\nCHAPTER\\n\\nTne Dapr state\\nmanagement building\\n\\nlleva\\n\\nDistributed applications are composed of ind\", \"ependent services. While each service should be\\nstateless, some services must track state to complet\", \"e business operations. Consider a shopping basket\\nservice for an e-Commerce site. If the service can\", \"\\u2019t track state, the customer could lose the shopping\\nbasket content by leaving the website, resultin\", \"g in a lost sale and an unhappy customer experience.\\nFor these scenarios, state needs to be persiste\", \"d to a distributed state store. The Dapr state\\nmanagement building block simplifies state tracking a\", \"nd offers advanced features across various data\\nstores.\\n\\nTo try out the state management building bl\", \"ock, have a look at the counter application sample in\\nchapter 3.\\n\\nWhat it solves\\n\\nTracking state in \", \"a distributed application can be challenging. For example:\\n\\n. The application may require different \", \"types of data stores.\\n\\n. Different consistency levels may be required for accessing and updating dat\", \"a.\\n\\n. Multiple users may update data at the same time, requiring conflict resolution.\\n\\n. Services mu\", \"st retry any short-lived transient errors that occur while interacting with the data\\nstore.\\n\\nThe Dap\", \"r state management building block addresses these challenges. It streamlines tracking state\\nwithout \", \"dependencies or a learning curve on third-party storage SDKs.\\n\\nImportant\\n\\nDapr state management offe\", \"rs a key/value API. The feature doesn't support relational or graph data\\n\\nstorage.\\n\\n42 CHAPTER 6 | T\", \"he Dapr state management building block\\nHow it works\\n\\nThe application interacts with a Dapr sidecar \", \"to store and retrieve key/value data. Under the hood, the\\nsidecar API consumes a configurable state \", \"store component to persist data. Developers can choose\\nfrom a growing collection of supported state \", \"stores that include Azure Cosmos DB, SQL Server, and\\nCassandra.\\n\\nThe API can be called with either H\", \"TTP or gRPC. Use the following URL to call the HTTP API:\\n\\nhttp://localhost:<dapr-port>/v1.0/state/<s\", \"tore-name>/\\n\\n. <dapr-port>: the HTTP port that Dapr listens on.\\n\\u00b0 <store-name>: the name of the stat\", \"e store component to use.\\n\\nFigure 5-1 shows how a Dapr-enabled shopping basket service stores a key/\", \"value pair using the Dapr\\nstate store component named statestore.\\n\\nsimage type=\\\"content\\u201d source=\\\"./m\", \"edia/state-management/state-management-flow.png\\u201d alt-\\ntext=\\\"Diagram of storing a key/value pair in a\", \" Dapr state store.\\u201d:::\\n\\nFigure 5-1. Storing a key/value pair in a Dapr state store.\\nNote the steps i\", \"n the previous figure:\\n1. The basket service calls the state management API on the Dapr sidecar. The\", \" body of the request\\n\\nencloses a JSON array that can contain multiple key/value pairs.\\n\\n2. The Dapr \", \"sidecar determines the state store based on the component configuration file. In this\\ncase, it's a R\", \"edis cache state store.\\n\\n3. The sidecar persists the data to the Redis cache.\\n\\nRetrieving the stored\", \" data is a similar API call. In the example below, a curl command retrieves the\\ndata by calling the \", \"Dapr sidecar API:\\n\\ncurl http://localhost: 3500/v1.0/state/statestore/basket1\\n\\nThe command returns th\", \"e stored state in the response body:\\n{\\n\\\"items\\\": [\\n\\n\\\"\\u201citemId\\\": \\\"\\u201cDaprHoodie\\\",\\n\\\"quantity\\\": 1\\n}\\n\\n],\\n\\n\\\"c\", \"ustomerId\\\": 1\\n\\n}\\n\\nThe following sections explain how to use the more advanced features of the state \", \"management\\nbuilding block.\\n\\nConsistency\\n\\nThe CAP theorem is a set of principles that apply to distri\", \"buted systems that store state. Figure 5-2\\nshows the three properties of the CAP theorem.\\n\\n43 CHAPTE\", \"R 6 | The Dapr state management building block\\nsImage type=\\\"content\\u201d source=\\\"./media/state-managemen\", \"t/cap-theorem.png\\\" alt-text=\\\"The CAP\\ntheorem.\\\":::\\n\\nFigure 5-2. The CAP theorem.\\n\\nThe theorem states \", \"that distributed data systems offer a trade-off between consistency, availability,\\nand partition tol\", \"erance. And, that any datastore can only guarantee two of the three properties:\\n\\n. Consistency (C). \", \"Every node in the cluster responds with the most recent data, even if the system\\nmust block the requ\", \"est until all replicas update. If you query a \\u201cconsistent system\\u201d for an item\\nthat is currently upda\", \"ting, you won't get a response until all replicas successfully update.\\nHowever, you'll always receiv\", \"e the most current data.\\n\\n\\u00b0 Availability (A). Every node returns an immediate response, even if that\", \" response isn't the most\\nrecent data. If you query an \\u201cavailable system\\u201d for an item that is updatin\", \"g, you'll get the best\\npossible answer the service can provide at that moment.\\n\\n. Partition Toleranc\", \"e (P). Guarantees the system continues to operate even if a replicated data\\nnode fails or loses conn\", \"ectivity with other replicated data nodes.\\n\\nDistributed applications must handle the P property. As \", \"services communicate among each other with\\nnetwork calls, network disruptions (P) will occur. With t\", \"hat in mind, distributed applications must\\neither be AP or CP.\\n\\nAP applications choose availability \", \"over consistency. Dapr supports this choice with its eventual\\nconsistency strategy. Consider an unde\", \"rlying data store, such as Azure CosmosDB, which stores\\nredundant data on multiple replicas. With ev\", \"entual consistency, the state store writes the update to\\none replica and completes the write request\", \" with the client. After this time, the store will\\nasynchronously update its replicas. Read requests \", \"can return data from any of the replicas, including\\nthose replicas that haven't yet received the lat\", \"est update.\\n\\nCP applications choose consistency over availability. Dapr supports this choice with it\", \"s strong\\nconsistency strategy. In this scenario, the state store will synchronously update all (or, \", \"in some cases,\\na guorum of) required replicas before completing the write request. Read operations w\", \"ill return the\\nmost up-to-date data consistently across replicas.\\n\\nThe consistency level for a state\", \" operation is specified by attaching a consistency hint to the operation.\\nThe following curl command\", \" writes a Hello=World key/value pair to a state store using a strong\\nconsistency hint:\\n\\ncurl -X POST\", \" http://localhost:3500/v1.0/state/<store-name> \\\\\\n-H \\\"Content-Type: application/json\\\" \\\\\\n-d'[\\n\\nt\\n\\\"key\\\"\", \": \\\"Hello\\\",\\n\\\"value\\\": \\\"World\\\",\\n\\\"options\\\": {\\n\\\"consistency\\\": \\\"strong\\\"\\n\\n44 CHAPTER 6 | The Dapr state man\", \"agement building block\\nImportant\\n\\nIt is up to the Dapr state store component to fulfill the consiste\", \"ncy hint attached to the operation. Not\\n\\nall data stores support both consistency levels. If no cons\", \"istency hint is set, the default behavior is\\neventual.\\n\\nConcurrency\\n\\nIn a multi-user application, th\", \"ere\\u2019s a chance that multiple users will update the same data concurrently\\n(at the same time). Dapr s\", \"upports optimistic concurrency control (OCC) to manage conflicts. OCC is\\nbased on an assumption that\", \" update conflicts are uncommon because users work on different parts of\\nthe data. It\\u2019s more efficien\", \"t to assume an update will succeed and retry if it doesn't. The alternative,\\nimplementing pessimisti\", \"c locking, can affect performance with long-running locking causing data\\ncontention.\\n\\nDapr supports \", \"optimistic concurrency control (OCC) using ETags. An ETag is a value associated with a\\nspecific vers\", \"ion of a stored key/value pair. Each time a key/value pair updates, the ETag value updates\\nas well. \", \"When a client retrieves a key/value pair, the response includes the current ETag value. When a\\nclien\", \"t updates or deletes a key/value pair, it must send that ETag value back in the request body. If\\nano\", \"ther client has updated the data in the meantime, the ETags won't match and the request will fail.\\nA\", \"t this point, the client must retrieve the updated data, make the change again, and resubmit the\\nupd\", \"ate. This strategy Is called first-write-wins.\\n\\nDapr also supports a last-write-wins strategy. With \", \"this approach, the client doesn't attach an ETag\\nto the write request. The state store component wil\", \"l always allow the update, even if the underlying\\nvalue has changed during the session. Last-write-w\", \"ins is useful for high-throughput write scenarios\\nwith low data contention. As well, overwriting an \", \"occasional user update can be tolerated.\\n\\nTransactions\\n\\nDapr can write multi-item changes to a data \", \"store as a single operation implemented as a transaction.\\nThis functionality is only available for d\", \"ata stores that support ACID transactions. At the time of this\\nwriting, these stores include Redis, \", \"MongoDB, PostgreSQL, SQL Server, and Azure CosmosDB.\\n\\nIn the example below, a multi-item operation i\", \"s sent to the state store in a single transaction. All\\noperations must succeed for the transaction t\", \"o commit. If one or more of the operations fail, the\\nentire transaction rolls back.\\n\\ncurl -X POST ht\", \"tp://localhost:3500/v1.0/state/<store-name>/transaction \\\\\\n-H \\\"Content-Type: application/json\\\" \\\\\\n\\n-d \", \"'{\\n\\\"operations\\\": [\\n\\nt\\n\\\"operation\\\": \\\"\\u201cupsert\\\",\\n\\\"request\\\": { \\\"key\\\": \\\"Key1\\\", \\\"value\\\": \\\"Value1\\\"\\n}\\n\\n}5\\n\\nt\", \"\\n\\\"operation\\\": \\\"delete\\\",\\n\\u201c\\\"rpequest\\\": { \\\"key\\\": \\\"Key2\\\" }\\n\\n}\\n\\n45 CHAPTER 6 | The Dapr state management \", \"building block\\n]\\n}'\\nFor data stores that don\\u2019t support transactions, multiple keys can still be sent\", \" as a single request. The\\nfollowing example shows a bulk write operation:\\n\\ncurl -X POST http://local\", \"host:3500/v1.0/state/<store-name> \\\\\\n-H \\\"Content-Type: application/json\\\" \\\\\\n-d'[\\n\\n{ \\\"key\\\": \\\"Key1i\\\", \\\"v\", \"alue\\\": \\\"Valuei\\\" },\\n{ \\\"key\\\": \\\"Key2\\\", \\\"value\\\": \\\"Value2\\\" }\\n] T\\n\\nFor bulk operations, Dapr will submit e\", \"ach key/value pair update as a separate request to the data\\nstore.\\n\\nUse the Dapr .NET SDK\\n\\nThe Dapr \", \".NET SDK provides language-specific support for the .NET platform. Developers can use the\\nDaprClient\", \" class introduced in chapter 3 to read and write data. The following example shows how to\\nuse the Da\", \"prClient.GetStateAsync<TValue> method to read data from a state store. The method\\nexpects the store \", \"name, statestore, and key, AMS, as parameters:\\n\\nvar weatherForecast = await daprClient.GetStateAsync\", \"<WeatherForecast>(\\\"statestore\\\", \\\"AMS\\\") ;\\n\\nIf the state store contains no data for key AMS, the resul\", \"t will be default (WeatherForecast).\\nTo write data to the data store, use the DaprClient.SaveStateAs\", \"ync<TValue> method:\\ndaprClient.SaveStateAsync(\\\"statestore\\\", \\\"AMS\\\", weatherForecast) ;\\n\\nThe example u\", \"ses the last-write-wins strategy as an ETag value isn't passed to the state store\\ncomponent. To use \", \"optimistic concurrency control (OCC) with a first-write-wins strategy, first retrieve\\nthe current ET\", \"ag using the DaprClient.GetStateAndETagAsync method. Then write the updated\\nvalue and pass along the\", \" retrieved ETag using the DaprClient.TrySaveStateAsync method.\\n\\nvar (weatherForecast, etag) = await\\n\", \"daprClient.GetStateAndETagAsync<WeatherForecast>(\\\"statestore\\\", city);\\n\\n// ... make some changes to t\", \"he retrieved weather forecast\\n\\nvar result = await daprClient.TrySaveStateAsync(\\\"statestore\\\", city, w\", \"eatherForecast, etag);\\n\\nThe DaprClient.TrySaveStateAsync method fails when the data (and associated \", \"ETag) has been\\nchanged in the state store after the data was retrieved. The method returns a boolean\", \" value to\\nindicate whether the call succeeded. A strategy to handle the failure is to simply reload \", \"the updated\\ndata from the state store, make the change again, and resubmit the update.\\n\\nIf you alway\", \"s want a write to succeed regardless of other changes to the data, use the last-write-wins\\nstrategy.\", \"\\n\\nThe SDK provides other methods to retrieve data in bulk, delete data, and execute transactions. Fo\", \"r\\nmore information, see the Dapr .NET SDK repository.\\n\\n46 CHAPTER 6 | The Dapr state management buil\", \"ding block\\nASP.NET Core integration\\n\\nDapr also supports ASP.NET Core, a cross-platform framework for\", \" building modern cloud-based web\\n\\napplications. The Dapr SDK integrates state management capabilitie\", \"s directly into the ASP.NET Core\\nmodel binding capabilities. Configuration is simple. In the Program\", \".cs file, call the following extension\\nmethod on the WebApplication builder:\\n\\nOnce configured, Dapr \", \"can inject a key/value pair directly into a controller action using the ASP.NET\\nCore FromState attri\", \"bute. Referencing the DaprClient object is no longer necessary. The next\\nexample shows a Web API tha\", \"t returns the weather forecast for a given city:\\n\\n[HttpGet(\\\"{city}\\\") ]\\npublic ActionResult<WeatherFo\", \"recast> Get([FromState(\\\"statestore\\\", \\\"city\\\") ]\\nStateEntry<WeatherForecast> forecast)\\n\\nif (forecast.V\", \"alue == null)\\n\\nt\\n\\nreturn NotFound();\\n\\n5\\n\\nreturn forecast.Value;\\n\\nIn the example, the controller load\", \"s the weather forecast using the FromState attribute. The first\\nattribute parameter is the state sto\", \"re, statestore. The second attribute parameter, city, is the name\\nof the route template variable to \", \"get the state key. If you omit the second parameter, the name of the\\nbound method parameter (forecas\", \"t) is used to look up the route template variable.\\n\\nThe StateEntry class contains properties for all\", \" the information that is retrieved for a single key/value\\npair: StoreName, Key, Value, and ETag. The\", \" ETag Is useful for implementing optimistic concurrency\\ncontrol (OCC) strategy. The class also provi\", \"des methods to delete or update retrieved key/value data\\nwithout requiring a DaprClient instance. In\", \" the next example, the TrySaveAsync method is used to\\nupdate the retrieved weather forecast using OC\", \"C.\\n\\n[HttpPut(\\\"{city}\\\") ]\\n\\npublic async Task Put(WeatherForecast updatedForecast, [FromState(\\\"statest\", \"ore\\\", \\\"city\\\") ]\\nStateEntry<WeatherForecast> currentForecast)\\n\\nt\\n\\n// update cached current forecast w\", \"ith updated forecast passed into service endpoint\\ncurrentForecast.Value = updatedForecast;\\n\\n// updat\", \"e state store\\nvar success = await currentForecast.TrySaveAsync() ;\\n\\n// ... check result\\n\\nState store\", \" components\\n\\nAt the time of this writing, Dapr provides support for the following transactional stat\", \"e stores:\\n\\n47 CHAPTER 6 | The Dapr state management building block\\n\\u00b0 Azure CosmosDB\\n\\u00b0 Azure SQL Serv\", \"er\\n\\u00b0 CockroachDB\\n\\n\\u00b0 In Memory\\n\\u00b0 MongoDB\\n. MySQL\\n\\n. Oracle Database\\n\\u00b0 PostgreSQL\\n\\n: Redis\\n\\n. RethinkD\", \"B\\n\\nDapr also includes support for state stores that support CRUD operations, but not transactional\\nc\", \"apabilities:\\n\\n. Aerospike\\n\\n. Apache Cassandra\\n\\n\\u00b0 AWS DynamoDB\\n\\n. Azure Blob Storage\\n\\n. Azure Table S\", \"torage\\n\\n\\u00b0 Couchbase\\n\\n. GCP Firestore\\n\\n. Hashicorp Consul\\n: Hazelcast\\n\\n\\u00b0 JetStream KV\\n\\n. Memcached\\n\\n.\", \" Oracle Object Storage\\n\\n. Zookeeper\\n\\nConfiguration\\n\\nWhen initialized for local, self-hosted developm\", \"ent, Dapr registers Redis as the default state store.\\nHere's an example of the default state store c\", \"onfiguration. Note the default name, statestore:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nmetad\", \"ata:\\nname: statestore\\nspec:\\ntype: state.redis\\nversion: v1\\n\\nmetadata:\\nname: redisHost\\nvalue: localhos\", \"t:6379\\nname: redisPassword\\nvalue: \\\"\\\"\\nname: actorStateStore\\nvalue: \\\"true\\\"\\n\\n48 CHAPTER 6 | The Dapr st\", \"ate management building block\\n[INOTE] Many state stores can be registered to a single application ea\", \"ch with a different name.\\n\\nThe Redis state store requires redisHost and redisPassword metadata to co\", \"nnect to the Redis\\ninstance. In the example above, the Redis password (which is an empty string by d\", \"efault) is stored as a\\nplain string. The best practice is to avoid clear-text strings and always use\", \" secret references. To learn\\nmore about secret management, see chapter 10.\\n\\nThe other metadata field\", \", actorStateStore, indicates whether the state store can be consumed by\\n\\nthe actors building block.\\n\", \"\\nKey prefix strategies\\n\\nState store components enable different strategies to store key/value pairs \", \"in the underlying store.\\nRecall the earlier example of a shopping basket service storing items a cus\", \"tomer wishes to purchase:\\n\\ncurl -X POST http://localhost:3500/v1.0/state/statestore \\\\\\n-H \\\"Content-Ty\", \"pe: application/json\\\" \\\\\\n\\n\\\": \\\"basket1i\\\",\\n\\\"4\\n\\\"customerId\\\": 1,\\n\\\"items\\\": [\\n{ \\\"itemId\\\": \\\"DaprHoodie\\\", \\\"qu\", \"antity\\\": 1 }\\n]\\n}\\ntI]\\n\\nUsing the Redis Console tool, look inside the Redis cache to see how the Redis\", \" state store component\\n\\npersisted the data:\\n\\n127.0.0.1:6379> KEYS *\\n1) \\\"basketservice| |basket1\\\"\\n\\n12\", \"7.0.0.1:6379> HGETALL basketservice| |basket1\\n\\n1) \\\"data\\\"\\n\\n2) \\\"{\\\\\\\"items\\\\\\\":[{\\\\\\\"itemId\\\\\\\":\\\\\\\"DaprHoodie\\\\\\\"\", \", \\\\\\\"quantity\\\\\\\":1}],\\\\\\\"customerId\\\\\\\":1}\\\"\\n3) \\\"version\\\"\\n\\nThe output shows the full Redis key for the data\", \" as basketservice| |basket1. By default, Dapr uses\\nthe application id of the Dapr instance (basketse\", \"rvice) as a prefix for the key. This naming\\nconvention enables multiple Dapr instances to share the \", \"same data store without key name collisions.\\nFor the developer, it's critical always to specify the \", \"same application id when running the\\napplication with Dapr. If omitted, Dapr will generate a unique \", \"application ID. If the application id\\nchanges, the application can no longer access the state stored\", \" with the previous key prefix.\\n\\nThat said, it\\u2019s possible to configure a constant value for the key p\", \"refix in the keyPrefix metadata field\\nin the state store component file. Consider the following exam\", \"ple:\\n\\nspec:\\nmetadata:\\n\\n- name: keyPrefix\\n- value: MyPrefix\\n\\n49 CHAPTER 6 | The Dapr state management\", \" building block\\nA constant key prefix enables the state store to be accessed across multiple Dapr ap\", \"plications. What's\\nmore, setting the keyPrefix to none omits the prefix completely.\\n\\nSample applicat\", \"ion: Dapr Traffic Control\\n\\nIn the Dapr Traffic Control sample app, the TrafficControl service uses t\", \"he Dapr state management\\nbuilding block to persist the entry and exit timestamps of each passing veh\", \"icle. Figure 5-3 shows the\\nconceptual architecture of the Dapr Traffic Control sample application. T\", \"he Dapr state management\\nbuilding block is used in flows marked with number 3 in the diagram:\\n\\nsimag\", \"e type=\\\"content\\u201d source=\\\"./media/state-management/dapr-solution-state-management.png\\u201d\\nalt-text=\\\"Conc\", \"eptual architecture of the Dapr Traffic Control sample application.\\u201d:::\\n\\nFigure 5-3. Conceptual arch\", \"itecture of the Dapr Traffic Control sample application.\\nEntry and exit event logic is handled by th\", \"e TrafficController class, an ordinary ASP.NET Controller.\\n\\nThe TrafficController.VehicleEntry metho\", \"d accepts an incoming VehicleRegistered message\\nand saves the enclosed vehicle state:\\n\\n// store vehi\", \"cle state\\nvar vehicleState = new VehicleState\\n\\nt\\n\\nLicenseNumber = msg.LicenseNumber,\\nEntryTimestamp \", \"= msg.Timestamp\\n}3\\n\\nawait _vehicleStateRepository.SaveVehicleStateAsync(vehicleState) ;\\n\\nIn the prec\", \"eding code snippet, the abstraction _vehicleStateRepository is responsible for saving\\nstate to the d\", \"ata store. Its concrete implementation, DaprVehicleStateRepository, is shown below:\\n\\npublic class Da\", \"prVehicleStateRepository : IVehicleStateRepository\\n\\nt\\nprivate const string DAPR_STORE_NAME = \\\"states\", \"tore\\\";\\n\\nprivate readonly DaprClient _daprClient;\\n\\npublic DaprVehicleStateRepository(DaprClient daprC\", \"lient)\\nt\\n\\n5\\n\\n_daprClient = daprClient;\\n\\npublic async Task SaveVehicleStateAsync(VehicleState vehicle\", \"State)\\n\\nt\\nawait _daprClient.SaveStateAsync<VehicleState> (\\n\\nDAPR_STORE_NAME, vehicleState.LicenseNum\", \"ber, vehicleState) ;\\n}\\n\\npublic async Task<VehicleState> GetVehicleStateAsync(string licenseNumber )\\n\", \"\\nt\\n\\nreturn await _daprClient.GetStateAsync<VehicleState>(\\nDAPR_STORE_NAME, licenseNumber) ;\\n\\nAs the \", \"preceding code snippet shows, the implementation of the DaprVehicleStateRepository class\\nis pretty s\", \"traightforward. The SaveVehicleStateAsync method uses the injected DaprClient object\\n\\n50 CHAPTER 6 |\", \" The Dapr state management building block\\nto save the state to the configured Dapr state store. It u\", \"ses the vehicle's license number as the key.\\nThe application can retrieve the saved state by calling\", \" the GetVehicleStateAsync method.\\n\\nThe TrafficControl service uses Redis as its underlying data stor\", \"e. Looking at the code, you'd never\\nknow it. A service consuming the Dapr state management building \", \"block doesn't directly reference\\nany state components. Instead, a Dapr component configuration file \", \"specifies the store:\\n\\napiVersion: dapr.io/vialpha1l\\nkind: Component\\nmetadata:\\n\\nname: statestore\\nname\", \"space: dapr-trafficcontrol\\nspec:\\ntype: state.redis\\nversion: v1\\nmetadata:\\n- name: redisHost\\nvalue: lo\", \"calhost:6379\\n- name: redisPassword\\nsecretKeyRef:\\nname: state.redisPassword\\nkey: state.redisPassword\\n\", \"scopes:\\n- trafficcontrolservice\\n\\nNote\\n\\nThe component configuration file includes an element secretKe\", \"yRef. The application uses it to\\nreference the Redis password value from the Dapr secrets building b\", \"lock. See chapter 10 to learn\\nmore about managing secrets with Dapr.\\n\\nThe type element in the config\", \"uration, state. redis instructs the building block to manage state with\\nDapr Redis component.\\n\\nThe s\", \"copes element in the configuration constrains application access to the state store component.\\nOnly \", \"the TrafficControl service can access the state store.\\n\\nSummary\\n\\nThe Dapr state management building \", \"block offers an API for storing key/value data across various\\ndata stores. The API provides support \", \"for:\\n\\n. Bulk operations\\n\\n\\u00b0 Strong and eventual consistency\\n. Optimistic concurrency control\\n\\n. Multi\", \"-item transactions\\n\\nThe .NET SDK provides language-specific support for .NET and ASP.NET Core. Model\", \" binding\\nintegration simplifies accessing and updating state from ASP.NET Core controller action met\", \"hods.\\n\\nIn the Dapr Traffic Control sample application, the benefits of using Dapr state management a\", \"re clear:\\n\\n51 CHAPTER 6 | The Dapr state management building block\\n1. It abstracts away the complexi\", \"ty of using third-party SDKs, such as StackExchange. Redis.\\n\\n2. Replacing the underlying Redis cache\", \" with a different type of data store only requires changes to\\nthe component configuration file.\\n\\nRef\", \"erences\\n\\u00b0 Dapr supported state stores\\n\\n52 CHAPTER 6 | The Dapr state management building block\\nCHAPT\", \"ER\\n\\nTne Dapr service\\nInvocation building block\\n\\nAcross a distributed system, one service often needs\", \" to communicate with another to complete a\\nbusiness operation. The Dapr service invocation building \", \"block can help streamline the\\ncommunication between services.\\n\\nWhat it solves\\n\\nMaking calls between \", \"services in a distributed application may appear easy, but there are many\\nchallenges involved. For e\", \"xample:\\n\\n\\u00b0 Where the other services are located.\\n. How to call a service securely, given the service\", \" address.\\n\\u00b0 How to handle retries when short-lived transient errors occur.\\n\\nLastly, as distributed a\", \"pplications compose many different services, capturing insights across service\\ncall graphs are criti\", \"cal to diagnosing production issues.\\n\\nThe service invocation building block addresses these challeng\", \"es by using a Dapr sidecar as a reverse\\nproxy for your service.\\n\\nHow it works\\n\\nLet\\u2019s start with an e\", \"xample. Consider two services, \\u201cService A\\u201d and \\u201cService B\\\". Service A needs to call\\nthe catalog/item\", \"s API on Service B. While Service A could take a dependency on Service B and make\\na direct call to i\", \"t, Service A instead invokes the service invocation API on the Dapr sidecar. Figure 6-1\\nshows the op\", \"eration.\\n\\n53 CHAPTER 7 | The Dapr service invocation building block\\n| GET http://localhost:3500/v1.0\", \"/invoke/serviceb/method/catalog/items\\n\\n\\u2014-\\n\\n|\\n\\na\\n|__| 4\\n7 6\\n\\nMM service A\\napr sidecar\\n\\n2 5\\n\\nGET http:\", \"//localhost:3500/catalog/items\\n\\n~<- \\u2014\\u2014\\u2014\\u2014\\u2014EE EE :\\n\\u2018 Service B\\n| 4 : P sidecar\\n\\nFigure 6-1. How Dapr s\", \"ervice invocation works.\\n\\nNote the steps from the previous figure:\\n\\n1.\\n\\n5.\\n\\n6.\\n\\nService A makes a ca\", \"ll to the catalog/items endpoint in Service B by invoking the service\\ninvocation API on the Service \", \"A sidecar.\\n\\n[INOTE] The sidecar uses a pluggable name resolution component to resolve the address of\", \"\\nService B. In self-hosted mode, Dapr uses mDNS to find it. When running in Kubernetes mode,\\nthe Kub\", \"ernetes DNS service determines the address.\\n\\nThe Service A sidecar forwards the request to the Servi\", \"ce B sidecar.\\n\\nThe Service B sidecar makes the actual catalog/items request against the Service B AP\", \"I.\\nService B executes the request and returns a response back to its sidecar.\\n\\nThe Service B sidecar\", \" forwards the response back to the Service A sidecar.\\n\\nThe Service A sidecar returns the response ba\", \"ck to Service A.\\n\\nBecause the calls flow through sidecars, Dapr can inject some useful cross-cutting\", \" behaviors:\\n\\n54\\n\\nAutomatically retry calls upon failure.\\n\\nMake calls between services secure with mu\", \"tual (mTLS) authentication, including automatic\\ncertificate rollover.\\n\\nControl what operations clien\", \"ts can do using access control policies.\\n\\nCapture traces and metrics for all calls between services \", \"to provide insights and diagnostics.\\n\\nCHAPTER 7 | The Dapr service invocation building block\\nAny app\", \"lication can invoke a Dapr sidecar by using the native invoke API built into Dapr. The API can\\nbe ca\", \"lled with either HTTP or gRPC. Use the following URL to call the HTTP API:\\n\\nhttp: //localhost:<dapr-\", \"port>/v1.0/invoke/<application-id>/method/<method-name>\\n\\n\\u00b0 <dapr-port> the HTTP port that Dapr is li\", \"stening on.\\n\\u00b0 <application-id> application ID of the service to call.\\n\\n\\u00b0 <method-name> name of the m\", \"ethod to invoke on the remote service.\\n\\nIn the following example, a curl call is made to the catalog\", \"/items \\u2018GET\\u2019 endpoint of Service B:\\n\\ncurl http://localhost:3500/v1.0/invoke/serviceb/method/catalog/\", \"items\\n\\nNote\\n\\nThe Dapr APIs enable any application stack that supports HTTP or gRPC to use Dapr build\", \"ing blocks.\\n\\nTherefore, the service invocation building block can act as a bridge between protocols.\", \" Services can\\ncommunicate with each other using HTTP, gRPC or a combination of both.\\n\\nIn the next se\", \"ction, you'll learn how to use the .NET SDK to simplify service invocation calls.\\n\\nUse the Dapr .NET\", \" SDK\\n\\nThe Dapr .NET SDK provides .NET developers with an intuitive and language-specific way to inte\", \"ract\\nwith Dapr. The SDK offers developers three ways of making remote service invocation calls:\\n\\n1. \", \"Invoke HTTP services using HttpClient\\n2. Invoke HTTP services using DaprClient\\n\\n3. Invoke gRPC servi\", \"ces using DaprClient\\n\\nInvoke HTTP services using HttpClient\\n\\nThe preferred way to call an HTTP endpo\", \"int is to use Dapr\\u2019s rich integration with HttpClient. The\\nfollowing example submits an order by cal\", \"ling the submit method of the orderservice application:\\n\\nvar httpClient = DaprClient.CreateInvokeHtt\", \"pClient() ;\\n\\nawait httpClient.PostAsJsonAsync(\\\"http://orderservice/submit\\\", order);\\n\\nIn the example,\", \" DaprClient.CreateInvokeHttpClient returns an HttpClient instance that is used to\\nperform Dapr servi\", \"ce invocation. The returned HttpClient uses a special Dapr message handler that\\nrewrites URIs of out\", \"going requests. The host name Is interpreted as the application ID of the service to\\ncall. The rewri\", \"tten request that's actually being called is:\\n\\nhttp: //127.0.0.1:3500/v1/invoke/orderservice/method/\", \"submit\\n\\nThis example uses the default value for the Dapr HTTP endpoint, which is http: //127.0.@.1:<\", \"dapr-\\nhttp-port>/. The value of dapr-http-port is taken from the DAPR_HTTP_PORT environment variable\", \".\\nIf it's not set, the default port number 35@@ is used.\\n\\n55 CHAPTER 7 | The Dapr service invocation\", \" building block\\nAlternatively, you can configure a custom endpoint in the call to\\nDaprClient.CreateI\", \"nvokeHttpClient:\\n\\nvar httpClient = DaprClient.CreateInvokeHttpClient(daprEndpoint: \\\"localhost: 40@Q\\\"\", \") ;\\n\\nYou can also directly set the base address by specifying the application ID. Doing so enables r\", \"elative\\nURIs when making a call:\\n\\nvar httpClient = DaprClient.CreateInvokeHttpClient(\\\"orderservice\\\")\", \" ;\\nawait httpClient.PostAsJsonAsync(\\\"/submit\\\" ) ;\\n\\nThe HttpClient object is intended to be long-live\", \"d. A single HttpClient instance can be reused for\\nthe lifetime of the application. The next scenario\", \" demonstrates how an OrderServiceClient class\\nreuses a Dapr HttpClient instance:\\n\\nvar builder = WebA\", \"pplication.CreateBuilder(args) ;\\nbuilder.Services.AddSingleton<IOrderServiceClient, OrderServiceClie\", \"nt>(\\n_ => new OrderServiceClient (DaprClient.CreateInvokeHttpClient(\\\"orderservice\\\")));\\n\\nIn the snipp\", \"et above, the OrderServiceClient is registered as a singleton with the ASP.NET Core\\ndependency injec\", \"tion system. An implementation factory creates a new HttpClient instance by\\ncalling DaprClient.Creat\", \"eInvokeHttpClient. It then uses the newly created HttpClient to\\ninstantiate the OrderServiceClient o\", \"bject. By registering the OrderServiceClient as a singleton, it\\nwill be reused for the lifetime of t\", \"he application.\\n\\nThe OrderServiceClient itself has no Dapr-specific code. Even though Dapr service i\", \"nvocation is\\nused under the hood, you can treat the Dapr HttpClient like any other HttpClient:\\npubli\", \"c class OrderServiceClient : IOrderServiceClient\\nprivate readonly HttpClient _httpClient;\\npublic Ord\", \"erServiceClient(HttpClient httpClient)\\n\\n_httpClient = httpClient ?? throw new ArgumentNullException(\", \"nameof(httpClient) );\\n}\\n\\npublic async Task SubmitOrder(Order order)\\n{\\n\\nvar response = await _httpCli\", \"ent.PostAsJsonAsync(\\\"submit\\\", order) ;\\nresponse. EnsureSuccessStatusCode() ;\\n\\nUsing the HttpClient c\", \"lass with Dapr service invocation has many benefits:\\n\\n. HttpClient is a well-known class that many d\", \"evelopers already use in their code. Using HttpClient\\nfor Dapr service invocation allows developers \", \"to reuse their existing skills.\\n\\n. HttpClient supports advanced scenarios, such as custom headers, a\", \"nd full control over request\\nand response messages.\\n\\n\\u00b0 In .NET 5, HttpClient supports automatic seri\", \"alization and deserialization using System.TextJson.\\n. HttpClient integrates with many existing fram\", \"eworks and libraries, such as Refit, RestSharp, and\\nPolly.\\n\\n56 CHAPTER 7 | The Dapr service invocati\", \"on building block\\nInvoke HTTP services using DaprClient\\n\\nWhile HttpClient is the preferred way to in\", \"voke services using HTTP semantics, you can also use the\\nDaprClient.InvokeMethodAsync family of meth\", \"ods. The following example submits an order by\\ncalling the submit method of the orderservice applica\", \"tion:\\n\\nvar daprClient = new DaprClientBuilder().Build();\\ntry\\nt\\n\\nvar confirmation =\\nawait daprClient.\", \"InvokeMethodAsync<Order, OrderConfirmation> (\\n\\n\\u201corderservice\\\", \\\"submit\\\", order);\\ncatch (InvocationEx\", \"ception ex)\\n\\n// Handle error\\n\\nThe third argument, an order object, is serialized internally (with Sy\", \"stem. Text. JsonSerializer) and\\nsent as the request payload. The .NET SDK takes care of the call to \", \"the sidecar. It also deserializes the\\nresponse to an OrderConfirmation object. Because no HTTP metho\", \"d Is specified, the request is\\nexecuted as an HTTP POST.\\n\\nThe next example demonstrates how you can \", \"make an HTTP GET request by specifying the\\nHttpMethod:\\n\\nvar catalogiItems = await\\n\\ndaprClient.Invoke\", \"MethodAsync<IEnumerable<CatalogItem>>(HttpMethod.Get, \\\"\\u201ccatalogservice\\\",\\n\\\"items\\\");\\n\\nFor some scenari\", \"os, you may require more control over the request message. For example, when you\\nneed to specify req\", \"uest headers, or you want to use a custom serializer for the payload.\\nDaprClient.CreateInvokeMethodR\", \"equest creates an HttpRequestMessage. The following example\\ndemonstrates how to add an HTTP authoriz\", \"ation header to a request message:\\n\\nvar request = daprClient.CreateInvokeMethodRequest(\\\"orderservice\", \"\\\", \\\"submit\\\", order);\\n\\nrequest.Headers.Authorization = new AuthenticationHeaderValue(\\\"bearer\\\", token)\", \" ;\\n\\nThe HttpRequestMessage now has the following properties set:\\n\\n\\u00b0 Url = http://127.0.0.1:3500/v1.0\", \"/invoke/orderservice/method/submit\\n. HttpMethod = POST\\n. Content = JsonContent object containing the\", \" JSON-serialized order\\n\\n\\u00b0 Headers.Authorization = \\u201cbearer <token>\\\"\\n\\nOnce you've got the request set \", \"up the way you want, use DaprClient.InvokeMethodAsync to send it:\\n\\nvar orderConfirmation = await dap\", \"rClient.InvokeMethodAsync<OrderConfirmation>(request) ;\\n\\nDaprClient .InvokeMethodAsync deserializes \", \"the response to an OrderConfirmation object if the\\nrequest is successful. Alternatively, you can use\", \" DaprClient.InvokeMethodWithResponseAsync to get\\nfull access to the underlying HttpResponseMessage:\\n\", \"\\n57 CHAPTER 7 | The Dapr service invocation building block\\nvar response = await daprClient.InvokeMet\", \"hodwWithResponseAsync(request) ;\\nresponse. EnsureSuccessStatusCode() ;\\n\\nvar orderConfirmation = resp\", \"onse.Content.ReadFromJsonAsync<OrderConfirmation>() ;\\n\\nNote\\n\\nFor service invocation calls using HTTP\", \", it's worth considering using the Dapr HttpClient integration\\npresented in the previous section. Us\", \"ing HttpClient gives you additional benefits such as integration\\nwith existing frameworks and librar\", \"ies.\\n\\nInvoke gRPC services using DaprClient\\n\\nDaprClient provides a family of InvokeMethodGrpcAsync m\", \"ethods for calling gRPC endpoints. The\\nmain difference with the HTTP methods is the use of a Protobu\", \"f serializer instead of JSON. The\\nfollowing example invokes the submitOrder method of the orderservi\", \"ce over gRPC.\\n\\nvar daprClient = new DaprClientBuilder().Build();\\ntry\\n{\\nvar confirmation = await dapr\", \"Client.InvokeMethodGrpcAsync<Order,\\nOrderConfirmation>(\\\"orderservice\\\", \\\"\\u201csubmitOrder\\\", order);\\n\\n5\\n\\nc\", \"atch (InvocationException ex)\\n\\n// Handle error\\n\\nIn the example above, DaprClient serializes the give\", \"n order object using Protobuf and uses the result\\nas the gRPC request body. Likewise, the response b\", \"ody is Protobuf deserialized and returned to the\\ncaller. Protobuf typically provides better performa\", \"nce than the JSON payloads used in HTTP service\\ninvocation.\\n\\nName resolution components\\n\\nAt the time\", \" of writing, Dapr provides support for the following name resolution components:\\n\\n. mDNS (default wh\", \"en running self-hosted)\\n\\u00b0 Kubernetes Name Resolution (default when running in Kubernetes)\\n\\n. HashiCo\", \"rp Consul\\n\\nConfiguration\\n\\nTo use a non-default name resolution component, add a nameResolution spec \", \"to the application's\\nDapr configuration file. Here\\u2019s an example of a Dapr configuration file that en\", \"ables HashiCorp Consul\\nname resolution:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Configuration\\nmetadata:\\n\", \"\\n58 CHAPTER 7 | The Dapr service invocation building block\\nname: dapr-config\\nspec:\\nnameResolution:\\nc\", \"omponent: \\\"consul\\\"\\nconfiguration:\\nselfRegister: true\\n\\nSample application: Dapr Traffic Control\\n\\nIn D\", \"apr Traffic Control sample app, the FineCollection service uses the Dapr service invocation\\nbuilding\", \" block to retrieve vehicle and owner information from the VehicleRegistration service. Figure\\n6-2 sh\", \"ows the conceptual architecture of the Dapr Traffic Control sample application. The Dapr service\\ninv\", \"ocation building block is used in flows marked with number 1 in the diagram:\\n\\nImage type=\\\"content\\u201d s\", \"ource=\\\"./media/service-invocation/dapr-solution-service-invocation.png\\u201d\\nalt-text=\\\"Conceptual archite\", \"cture of the Dapr Traffic Control sample application.\\u201d:::\\n\\nFigure 6-2. Conceptual architecture of th\", \"e Dapr Traffic Control sample application.\\n\\nInformation is retrieved by the ASP.NET CollectionContro\", \"ller class in the FineCollection service.\\nThe CollectFine method expects an incoming SpeedingViolati\", \"on parameter. It invokes a Dapr\\nservice invocation building block to call to the VehicleRegistration\", \" service. The code snippet is\\npresented below.\\n\\nW ul\\n\\n{custom-style=CodeBox} \\u201ccsharp [Topic(\\u201cpubsub\\u201d\", \"\\\", \\u201cspeedingviolations\\u201d)] [Route(\\u201ccollectfine\\u2019)]\\n[HttpPost] public async Task CollectFine(SpeedingVi\", \"olation speedingViolation, [FromServices]\\nDaprClient daprClient) { // ...\\n\\n// get owner info (Dapr s\", \"ervice invocation)\\n\\nvar vehicleInfo =\\n_vehicleRegistrationService.GetVehicleInfo(speedingViolation.V\", \"ehiclelId).Result;\\n\\n// we\\nThe code uses a proxy of type VehicleRegistrationService to call the Vehic\", \"leRegistration service.\\nASP.NET Core injects an instance of the service proxy using constructor inje\", \"ction:\\n\\n::{custom-style=CodeBox} csharp public CollectionController( = l!Logger<CollectionController\", \">\\nlogger, __|FineCalculator fineCalculator, | VehicleRegistrationService vehicleRegistrationService,\", \"\\nDaprClient daprClient) { //... }:\\n\\nThe VehicleRegistrationService class contains a single method: G\", \"etVehicleInfo. It uses the\\nASP.NET Core HttpClient to call the VehicleRegistration service:\\n\\n::{cust\", \"om-style=CodeBox} \\u201ccsharp public class VehicleRegistrationService { private HttpClient\\n_httpClient; \", \"public VehicleRegistrationService(HttpClient httpClient) { _httpClient = httpClient; }\\n\\npublic async\", \" Task<VehicleInfo> GetVehicleInfo(string licenseNumber )\\n\\n{\\n\\nreturn await _httpClient.GetFromJsonAsy\", \"nc<VehicleInfo>(\\n\\n59 CHAPTER 7 | The Dapr service invocation building block\\n$\\\"vehicleinfo/{licenseNu\", \"mber}\\\") ;\\n\\nNNN\\neee\\n} eee\\n\\nThe code doesn't depend on any Dapr classes directly. It instead leverages\", \" the Dapr ASP.NET Core\\nintegration as described in the Invoke HTTP services using HttpClient section\", \" of this module. The\\nfollowing code in the ConfigureService method of the Startup class registers th\", \"e\\nVehicleRegistrationService proxy:\\n\\nvar builder = WebApplication.CreateBuilder(args) ;\\nbuilder.Serv\", \"ices.AddSingleton<VehicleRegistrationService>(_ =>\\nnew VehicleRegistrationService(DaprClient.CreateI\", \"nvokeHttpClient (\\n\\\"\\u201cvehicleregistrationservice\\\", $\\\"http://localhost:{daprHttpPort}\\\"\\n)))3\\n\\nThe DaprCl\", \"ient.CreateInvokeHttpClient creates an HttpClient instance that calls the\\nVehicleRegistration servic\", \"e using the service invocation building block under the covers. It expects\\nboth the Dapr app-id of t\", \"he target service and the URL of its Dapr sidecar. At start time, the\\ndaprHttpPort argument contains\", \" the port number used for HTTP communication with the Dapr\\nsidecar.\\n\\nUsing Dapr service invocation i\", \"n the Traffic Control sample application provides several benefits:\\n\\n1. | Decouples the location of \", \"the target service.\\n2. Adds resiliency with automatic retry features.\\n\\n3. Ability to reuse an existi\", \"ng HttpClient based proxy (offered by the ASP.NET Core integration).\\n\\nSummary\\n\\nIn this chapter, you \", \"learned about the service invocation building block. You saw how to invoke\\nremote methods both by ma\", \"king direct HTTP calls to the Dapr sidecar, and by using the Dapr .NET\\nSDK.\\n\\nThe Dapr .NET SDK provi\", \"des multiple ways to invoke remote methods. HttpClient support is great for\\ndevelopers wanting to re\", \"use existing skills and is compatible with many existing frameworks and\\nlibraries. DaprClient offers\", \" support for directly using the Dapr service invocation API using either HTTP\\nor gRPC semantics.\\n\\nRe\", \"ferences\\n\\n. Dapr service invocation building block\\n\\n\\u00b0 Monitoring distributed cloud-native applicatio\", \"ns\\n\\n60 CHAPTER 7 | The Dapr service invocation building block\\nCHAPTER\\n\\nThe Dapr publish &\\nsubscribe \", \"building block\\n\\nThe Publish-Subscribe pattern (often referred to as \\u201cpub/sub\\u201d\\\") is a well-known and \", \"widely used\\nmessaging pattern. Architects commonly embrace it in distributed applications. However, \", \"the\\nplumbing to implement it can be complex. There are often subtle feature differences across diffe\", \"rent\\nmessaging products. Dapr offers a building block that significantly simplifies implementing pub\", \"/sub\\n\\nfunctionality.\\n\\nWhat it solves\\n\\nThe primary advantage of the Publish-Subscribe pattern is loos\", \"e coupling, sometimes referred to as\\ntemporal decoupling. The pattern decouples services that send m\", \"essages (the publishers) from\\nservices that consume messages (the subscribers). Both publishers and \", \"subscribers are unaware of\\neach other - both are dependent on a centralized message broker that dist\", \"ributes the messages.\\n\\nFigure 7-1 shows the high-level architecture of the pub/sub pattern.\\n\\nL3]\\n\\u2014 B\", \"i\\noO M\\na = essage\\nVS | broker \\u20ac\\n4)\\n6\\nSAF \\u2014> Ss Consumer B\\n\\nFigure 7-1. The pub/sub pattern.\\nFrom the\", \" previous figure, note the steps of the pattern:\\n\\n1. Publishers send messages to the message broker.\", \"\\n\\n2. Subscribers bind to a subscription on the message broker.\\n\\n61 CHAPTER 8 | The Dapr publish & su\", \"bscribe building block\\n3. | The message broker forwards a copy of the message to interested subscrip\", \"tions.\\n\\n4. Subscribers consume messages from their subscriptions.\\n\\nMost message brokers encapsulate \", \"a queueing mechanism that can persist messages once received.\\nWith it, the message broker guarantees\", \" durability by storing the message. Subscribers don't need to\\nbe immediately available or even onlin\", \"e when a publisher sends a message. Once available, the\\nsubscriber receives and processes the messag\", \"e. Dapr guarantees At-Least-Once semantics for\\nmessage delivery. Once a message is published, it wil\", \"l be delivered at least once to any interested\\nsubscriber.\\n\\nTip\\n\\nIf your service can only process a \", \"message once, you'll need to provide an idempotency check to\\nensure that the same message is not pro\", \"cessed multiple times. While such logic can be coded, some\\nmessage brokers, such as Azure Service Bu\", \"s, provide built-in duplicate detection messaging\\ncapabilities.\\n\\nThere are several message broker pr\", \"oducts available - both commercially and open-source. Each has\\nadvantages and drawbacks. Your job is\", \" to match your system requirements to the appropriate broker.\\nOnce selected, it's a best practice to\", \" decouple your application from message broker plumbing. You\\nachieve this functionality by wrapping \", \"the broker inside an abstraction. The abstraction encapsulates\\nthe message plumbing and exposes gene\", \"ric pub/sub operations to your code. Your code\\ncommunicates with the abstraction, not the actual mes\", \"sage broker. While a wise decision, you'll have\\nto write and maintain the abstraction and its underl\", \"ying implementation. This approach requires\\ncustom code that can be complex, repetitive, and error-p\", \"rone.\\n\\nThe Dapr publish & subscribe building block provides the messaging abstraction and implementa\", \"tion\\nout-of-the-box. The custom code you would have had to write is prebuilt and encapsulated inside\", \" the\\nDapr building block. You bind to it and consume it. Instead of writing messaging plumbing code,\", \" you\\nand your team focus on creating business functionality that adds value to your customers.\\n\\nHow \", \"it works\\n\\nThe Dapr publish & subscribe building block provides a platform-agnostic API framework to \", \"send and\\nreceive messages. Your services publish messages to a named topic. Your services subscribe \", \"to a topic\\nto consume messages.\\n\\nThe service calls the pub/sub API on the Dapr sidecar. The sidecar \", \"then makes calls into a pre-defined\\nDapr pub/sub component that encapsulates a specific message brok\", \"er product. Figure 7-2 shows the\\nDapr pub/sub messaging stack.\\n\\n62 CHAPTER 8 | The Dapr publish & su\", \"bscribe building block\\n| i ne]\\n\\nYour\\nservice\\n\\ng\\u2014sOPub/sub\\ndapr building\\nblock\\n\\nComponent\\nconfigurati\", \"on\\n\\nAzure\\nService Bus\\ncomponent\\n\\nProcess Process\\n\\nFigure 7-2. The Dapr pub/sub stack.\\n\\nThe Dapr publ\", \"ish & subscribe building block can be invoked in many ways.\\n\\nAt the lowest level, any programming pl\", \"atform can invoke the building block over HTTP or gRPC\\nusing the Dapr native API. To publish a messa\", \"ge, you make the following API call:\\n\\nhttp: //localhost:<dapr-port>/v1.0/publish/<pub-sub-name>/<top\", \"ic>\\n\\nThere are several Dapr specific URL segments in the above call:\\n\\n. <dapr-port> provides the por\", \"t number upon which the Dapr sidecar is listening.\\n. <pub-sub-name> provides the name of the selecte\", \"d Dapr pub/sub component.\\n\\n. <topic> provides the name of the topic to which the message is publishe\", \"d.\\n\\nUsing the curl command-line tool to publish a message, you can try it out:\\n\\ncurl -X POST http://\", \"localhost:3500/v1.@/publish/pubsub/newOrder \\\\\\n\\n-H \\\"Content-Type: application/json\\\" \\\\\\n-d '{ \\\"orderId\\\"\", \": \\\"1234\\\", \\\"productId\\\": \\\"5678\\\", \\\"amount\\\": 2 }'\\n\\nYou receive messages by subscribing to a topic. At st\", \"artup, the Dapr runtime will call the application\\non a well-known endpoint to identify and create th\", \"e required subscriptions:\\n\\nhttp: //localhost:<appPort>/dapr/subscribe\\n\\n63 CHAPTER 8 | The Dapr publi\", \"sh & subscribe building block\\n. <appPort> informs the Dapr sidecar of the port upon which the applic\", \"ation is listening.\\n\\nYou can implement this endpoint yourself. But Dapr provides more intuitive ways\", \" of implementing it.\\nWe'll address this functionality later in this chapter.\\n\\nThe response from the \", \"call contains a list of topics to which the applications will subscribe. Each\\nincludes an endpoint t\", \"o call when the topic receives a message. Here\\u2019s an example of a response:\\n\\n\\u201cpubsubname\\\": \\\"pubsub\\\",\\n\", \"\\\"topic\\\": \\\"\\u201cnewOrder\\\",\\n\\\"route\\\": \\\"/orders\\\"\\n\\n\\u201cpubsubname\\\": \\\"pubsub\\\",\\n\\\"topic\\\": \\\"\\u201cnewProduct\\\",\\n\\\"route\\\": \\\"\", \"/productCatalog/products\\\"\\n\\nIn the JSON response, you can see the application wants to subscribe to t\", \"opics newOrder and\\nnewProduct. It registers the endpoints /orders and /productCatalog/products for e\", \"ach,\\nrespectively. For both subscriptions, the application is binding to the Dapr component named pu\", \"bsub.\\n\\nFigure 7-3 presents the flow of the example.\\n\\n64 CHAPTER 8 | The Dapr publish & subscribe bui\", \"lding block\\nPOST http://localhost:3500/v1.0/publish/pubsub/newOrder\\n\\nML Service A\\n\\na ' dapr sidecar\\n\", \"<| O\\nMessage\\nbroker\\nGET http://localhost:50001/dapr/subscribe\\n2 YA! \\u00a9\\n\\nML Service B\\nre |\\n\\nService B\\n\", \"\\nPOST http://localhost:6000/orders\\n\\napr sidecar\\n\\nFigure 7-3. Pub/sub flow with Dapr.\\n\\nFrom the previ\", \"ous figure, note the flow:\\n\\n1.\\n\\nThe Dapr sidecar for Service B calls the /dapr/subscribe endpoint fr\", \"om Service B (the\\nconsumer). The service responds with the subscriptions it wants to create.\\n\\nThe Da\", \"pr sidecar for Service B creates the requested subscriptions on the message broker.\\n\\nService A publi\", \"shes a message at the /v1.0/publish/<pub-sub-name>/<topic> endpoint on\\nthe Dapr Service A sidecar.\\n\\n\", \"The Service A sidecar publishes the message to the message broker.\\nThe message broker sends a copy o\", \"f the message to the Service B sidecar.\\n\\nThe Service B sidecar calls the endpoint corresponding to t\", \"he subscription (in this case /orders)\\non Service B. The service responds with an HTTP status-code 2\", \"@@ OK so the sidecar will consider\\nthe message as being handled successfully.\\n\\nIn the example, the m\", \"essage is handled successfully. But if something goes wrong while Service B is\\n\\nhandling the request\", \", it can use the response to specify what needs to happen with the message.\\nWhen it returns an HTTP \", \"status-code 404, an error is logged and the message Is dropped. With any\\nother status-code than 208 \", \"or 404, a warning is logged and the message is retried. Alternatively,\\n\\n65\\n\\nCHAPTER 8 | The Dapr pub\", \"lish & subscribe building block\\nService B can explicitly specify what needs to happen with the messa\", \"ge by including a JSON payload\\nin the body of the response:\\n\\n{\\n\\n\\\"status\\\": \\\"<status>\\\"\\n\\n}\\n\\nThe followi\", \"ng table shows the available status values:\\n\\nSUCCESS The message Is considered as processed successf\", \"ully and dropped.\\n\\nRETRY The message is retried.\\n\\nA warning is logged and the message is dropped.\\n\\nA\", \"ny other status | The message is retried.\\n\\nCompeting consumers\\n\\nWhen scaling out an application that\", \" subscribes to a topic, you have to deal with competing\\nconsumers. Only one application instance sho\", \"uld handle a message sent to the topic. Luckily, Dapr\\nhandles that problem. When multiple instances \", \"of a service with the same application-id subscribe to\\na topic, Dapr delivers each message to only o\", \"ne of them.\\n\\nUse the Dapr .NET SDK\\n\\nFor .NET Developers, the Dapr .NET SDK provides a more productiv\", \"e way of working with Dapr. The\\n\\nSDK exposes a DaprClient class through which you can directly invok\", \"e Dapr functionality. It\\u2019s intuitive\\nand easy to use.\\n\\nTo publish a message, the DaprClient exposes \", \"a PublishEventAsync method.\\n\\nvar data = new OrderData\\n\\norderlId = \\\"123456\\\",\\nproductId = \\\"67890\\\",\\namo\", \"unt = 2\\n\\nIre\\n\\nvar daprClient = new DaprClientBuilder().Build();\\n\\nawait daprClient.PublishEventAsync<\", \"OrderData>(\\\"pubsub\\\", \\\"\\u201cnewOrder\\\", data);\\n\\n. The first argument pubsub is the name of the Dapr compon\", \"ent that provides the message broker\\nimplementation. We'll address components later in this chapter.\", \"\\n\\n. The second argument neworder provides the name of the topic to send the message to.\\n. The third \", \"argument is the payload of the message.\\n\\n. You can specify the .NET type of the message using the ge\", \"neric type parameter of the method.\\n\\n66 CHAPTER 8 | The Dapr publish & subscribe building block\\nTo r\", \"eceive messages, you bind an endpoint to a subscription for a registered topic. The AsoNetCore\\nlibra\", \"ry for Dapr makes this trivial. Assume, for example, that you have an existing ASP.NET WebAPI\\naction\", \" method entitled CreateOrder:\\n\\n[HttpPost(\\\"/orders\\\") ]\\npublic async Task<ActionResult> CreateOrder(Or\", \"der order)\\n\\nImportant\\n\\nYou must add a reference to the Dapr.AspNetCore NuGet package in your project\", \" to consume the\\nDapr ASP.NET Core integration.\\n\\nTo bind this action method to a topic, you decorate \", \"it with the Topic attribute:\\n\\n[Topic(\\\"pubsub\\\", \\u201cnewOrder\\\") |\\n[HttpPost(\\\"/orders\\\") ]\\n\\npublic async Ta\", \"sk<ActionResult> CreateOrder(Order order)\\n\\nYou specify two key elements with this attribute:\\n\\n\\u00b0 The \", \"Dapr pub/sub component to target (in this case pubsub).\\n\\n\\u00b0 The topic to subscribe to (in this case n\", \"ewOrder).\\n\\nDapr then invokes that action method as it receives messages for that topic.\\n\\nYou'll also\", \" need to enable ASP.NET Core to use Dapr. The Dapr .NET SDK provides several extension\\nmethods that \", \"can be used to do this.\\n\\nIn the Program.cs file, you must call the following extension method on the\", \" WebApplication builder\\nto register Dapr:\\n\\nAppending the AddDapr extension method to the AddControll\", \"ers extension method registers the\\nnecessary services to integrate Dapr into the MVC pipeline. It al\", \"so registers a DaprClient instance\\ninto the dependency injection container, which then can be inject\", \"ed anywhere into your service.\\n\\nAfter the WebApplication has been created, you must add the followin\", \"g middleware components to\\nenable Dapr:\\n\\nvar builder = WebApplication.CreateBuilder(args) ;\\nvar app \", \"= builder.Build();\\n\\napp.UseCloudEvents();\\napp.MapControllers();\\napp.MapSubscribeHandler() ;\\n\\nThe cal\", \"l to UseCloudEvents adds CloudEvents middleware into to the ASP.NET Core middleware\\npipeline. This m\", \"iddleware will unwrap requests that use the CloudEvents structured format, so the\\nreceiving method c\", \"an read the event payload directly.\\n\\n67 CHAPTER 8 | The Dapr publish & subscribe building block\\nNote\", \"\\n\\nCloudEvents is a standardized messaging format, providing a common way to describe event\\n\\ninformat\", \"ion across platforms. Dapr embraces CloudEvents. For more information about CloudEvents,\\nsee the clo\", \"udevents specification.\\n\\nThe call to MapSubscribeHandler in the endpoint routing configuration will \", \"add a Dapr subscribe\\nendpoint to the application. This endpoint will resoond to requests on /dapr/su\", \"bscribe. When this\\nendpoint is called, it will automatically find all WebAPI action methods decorate\", \"d with the Topic\\nattribute and instruct Dapr to create subscriptions for them.\\n\\nPub/sub components\\n\\n\", \"Dapr pub/sub components handle the actual transport of the messages. Several are available. Each\\nenc\", \"apsulates a specific message broker product to implement the pub/sub functionality. At the time\\nof w\", \"riting, the following pub/sub components were available:\\n\\n. Apache Kafka\\n\\n. AWS SNS/SQS\\n\\n. Azure Eve\", \"nt Hubs\\n. Azure Service Bus\\n: GCP Pub/Sub\\n\\n: Hazelcast\\n\\n\\u00b0 In Memory\\n\\n\\u00b0 JetStream\\n\\n. MQTT\\n\\n\\u00b0 NATS Str\", \"eaming\\n\\u00b0 Pulsar\\n\\n. RabbitMQ\\n\\n: Redis Streams\\n\\nNote\\n\\nThe Azure cloud stack has both messaging functio\", \"nality (Azure Service Bus) and event streaming\\n(Azure Event Hub) availability.\\n\\nThese components are\", \" created by the community in a component-contrib repository on GitHub.\\nYou're encouraged to write yo\", \"ur own Dapr component for a message broker that isn\\u2019t yet supported.\\n\\nConfiguration\\n\\nUsing a Dapr co\", \"nfiguration file, you can specify the pub/sub component(s) to use. This configuration\\ncontains sever\", \"al fields. The name field specifies the pub/sub component that you want to use. When\\nsending or rece\", \"iving a message, you need to specify this name (as you saw earlier in the\\nPublishEventAsync method s\", \"ignature).\\n\\n68 CHAPTER 8 | The Dapr publish & subscribe building block\\nBelow you see an example of a\", \" Dapr configuration file for configuring a RabbitMQ message broker\\ncomponent:\\n\\napiVersion: dapr.io/v\", \"ialpha1\\nkind: Component\\nmetadata:\\nname: pubsub-rq\\nspec:\\ntype: pubsub.rabbitmq\\n\\nversion: v1\\n\\nmetadata\", \":\\n\\n- name: host\\nvalue: \\\"amqp://localhost:5672\\\"\\nname: durable\\nvalue: true\\n\\nIn this example, you can s\", \"ee that you can specify any message broker-specific configuration in the\\nmetadata block. In this cas\", \"e, RabbitMQ is configured to create durable queues. But the RabbitMQ\\ncomponent has more configuratio\", \"n options. Each of the components\\u2019 configuration will have its own\\nset of possible fields. You can r\", \"ead which fields are available in the documentation of each pub/sub\\n\\ncomponent.\\n\\nNext to the program\", \"matic way of subscribing to a topic from code, Dapr pub/sub also provides a\\ndeclarative way of subsc\", \"ribing to a topic. This approach removes the Dapr dependency from the\\napplication code. Therefore, i\", \"t also enables an existing application to subscribe to topics without any\\nchanges to the code. The f\", \"ollowing example shows a Dapr configuration file for configuring a\\nsubscription:\\n\\napiVersion: dapr.i\", \"o/vialpha1\\nkind: Subscription\\nmetadata:\\n\\nname: newOrder-subscription\\nspec:\\n\\npubsubname: pubsub\\ntopic\", \": newOrder\\nroute: /orders\\n\\nscopes:\\n- ServiceB\\n- ServiceC\\n\\nYou have to specify several elements with \", \"every subscription:\\n\\n. The name of the Dapr pub/sub component you want to use (in this case pubsub).\", \"\\n\\u00b0 The name of the topic to subscribe to (in this case newOrder).\\n\\u00b0 The API operation that needs to \", \"be called for this topic (in this case /orders).\\n\\n\\u00b0 The scope can specify which services can publish\", \" and subscribe to a topic.\\n\\nSample application: Dapr Traffic Control\\n\\nIn Dapr Traffic Control sample\", \" app, the TrafficControl service uses the Dapr pub/sub building block to\\nsend speeding violations to\", \" the FineCollection service. Figure 7-4 shows the conceptual architecture\\n\\n69 CHAPTER 8 | The Dapr p\", \"ublish & subscribe building block\\nof the Dapr Traffic Control sample application. The Dapr pub/sub b\", \"uilding block is used in flows\\nmarked with number 2 in the diagram:\\n\\nimage type=\\\"content\\u201d source=\\\"./\", \"media/publish-subscribe/dapr-solution-pub-sub.png\\u201d alt-\\ntext=\\\"Conceptual architecture of the Dapr Tr\", \"affic Control sample application.\\u201d:::\\n\\nFigure 7-4. Conceptual architecture of the Dapr Traffic Contr\", \"ol sample application.\\n\\nSpeeding violations are handled by the CollectionController, an ordinary ASP\", \".NET Core Controller.\\n\\nThe CollectionController.CollectFine method subscribes to and handles Speedin\", \"gViolation\\nevent messages:\\n\\n[Topic(\\\"pubsub\\\", \\\"\\u201cspeedingviolations\\\") ]\\n[Route(\\\"collectfine\\\" ) |\\n\\n[Htt\", \"pPost |\\n\\npublic async Task<ActionResult> CollectFine(\\n\\nSpeedingViolation speedingViolation, [FromSer\", \"vices] DaprClient daprClient)\\n\\nt\\n}\\n\\nHi coc\\n\\nThe method is decorated with the Dapr Topic attribute. I\", \"t specifies that the pub/sub component\\nnamed pubsub should be used to subscribe to messages sent to \", \"the speedingviolations topic.\\n\\nThe TrafficControl service sends speeding violations. Near the end of\", \" the VehicleExit method in the\\nTrafficController class, the DaprClient object is used to publish Spe\", \"edingViolation messages\\nusing the pub/sub building block:\\n\\n[ff ...\\n\\nvar speedingViolation = new Spee\", \"dingViolation\\n{\\n\\nVehicleId = msg.LicenseNumber,\\n\\nRoadiId = _roadId,\\n\\nViolationiInkmh = violation,\\n\\nT\", \"imestamp = msg.Timestamp\\n\\nIre\\n\\n// publish speedingviolation (Dapr publish / subscribe)\\nawait daprCli\", \"ent.PublishEventAsync(\\\"pubsub\\\", \\\"\\u201cspeedingviolations\\\", speedingViolation) ;\\n\\n[Tf ss\\n\\nNote how the Da\", \"prClient object reduces the call to a single line of code, again, binding to the\\nspeedingviolations \", \"topic and the Dapr pubsub component.\\n\\nWhile the Traffic Control app uses RabbitMQ as the message bro\", \"ker, it never directly references\\nRabbitMQ. Instead, the accompanying Dapr component configuration f\", \"ile named pubsub. yaml in the\\n/dapr/components folder specifies the message broker:\\n\\napiVersion: dap\", \"r.io/vialpha1\\nkind: Component\\nmetadata:\\n\\nname: pubsub\\n\\nnamespace: dapr-trafficcontrol\\nspec:\\n\\ntype: p\", \"ubsub.rabbitmq\\n\\n70 CHAPTER 8 | The Dapr publish & subscribe building block\\nversion: v1\\nmetadata:\\n- n\", \"ame: host\\nvalue: \\\"amqp://localhost:5672\\\"\\n- name: durable\\nvalue: \\\"false\\\"\\n- name: deletedwWhenUnused\\nv\", \"alue: \\\"false\\\"\\n- name: autoAck\\nvalue: \\\"false\\\"\\n- name: reconnectWait\\nvalue: \\\"@\\\"\\n\\n- name: concurrency\\nv\", \"alue: parallel\\nscopes:\\n- trafficcontrolservice\\n- finecollectionservice\\n\\nThe type element in the conf\", \"iguration, pubsub. rabbitmg instructs the building block to use the Dapr\\nRabbitMQ component.\\n\\nThe sc\", \"opes element in the configuration constrains application access to the RabbitMQ component.\\nOnly the \", \"TrafficControl and FineCollection services can consume it.\\n\\nUsing Dapr pub/sub in the Traffic Contro\", \"l sample application offers the following benefits:\\n\\n1. No infrastructural abstraction of a message \", \"broker to maintain.\\n2. Services are temporally decoupled, which increases robustness.\\n\\n3. Publisher \", \"and subscribers are unaware of each other. This means that additional services could\\nbe introduced t\", \"hat will react to speeding violations in the future, without the need to change the\\nTrafficControl s\", \"ervice.\\n\\nSummary\\n\\nThe pub/sub pattern helps you decouple services in a distributed application. The \", \"Dapr publish &\\nsubscribe building block simplifies implementing this behavior in your application.\\n\\n\", \"Through Dapr pub/sub, you can publish messages to a specific topic. As well, the building block will\", \"\\nquery your service to determine which topic(s) to subscribe to.\\n\\nYou can use Dapr pub/sub natively \", \"over HTTP or by using one of the language-specific SDKs, such as\\nthe .NET SDK for Dapr. The .NET SDK\", \" tightly integrates with the ASP.NET core platform.\\n\\nWith Dapr, you can plug a supported message bro\", \"ker product into your application. You can then\\nswap message brokers without requiring code changes \", \"to your application.\\n\\nReferences\\n\\u00b0 Dapr supported pub/sub brokers\\n\\n71 CHAPTER 8 | The Dapr publish &\", \" subscribe building block\\nCHAPTER\\n\\nTne Dapr bindings\\nbuilding block\\n\\nCloud-based serverless offering\", \"s, such as Azure Functions and AWS Lambda, have gained wide\\nadoption across the distributed architec\", \"ture space. Among many benefits, they enable a microservice\\nto handle events from or invoke events i\", \"n an external system - abstracting away the underlying\\ncomplexity and plumbing concerns. External re\", \"sources are many: They include datastores, message\\nsystems, and web resources, across different plat\", \"forms and vendors. The Dapr bindings building block\\nbrings these same resource binding capabilities \", \"to the doorstep of your Dapr applications.\\n\\nWhat it solves\\n\\nDapr resource bindings enable your servi\", \"ces to integrate business operations across external\\nresources outside of the immediate application.\", \" An event from an external system could trigger an\\noperation in your service passing in contextual i\", \"nformation. Your service could then expand the\\noperation by triggering an event in another external \", \"system, passing in contextual payload\\ninformation. Your service communicates without coupling or awa\", \"reness of the external resource. The\\nplumbing is encapsulated inside pre-defined Dapr components. Th\", \"e Dapr component to use can be\\neasily swapped at run time without code changes.\\n\\nConsider, for examp\", \"le, a Twitter account that triggers an event whenever a user tweets a keyword.\\nYour service exposes \", \"an event handler that receives and processes the tweet. Once complete, your\\nservice triggers an even\", \"t that invokes an external Twilio service. Twilio sends an SMS message that\\nincludes the tweet. Figu\", \"re 8-1 show the conceptual architecture of this operation:\\n\\nTwitter service Twilio SMS\\n\\nmame See SSS\", \"eeSeSSEESBEis ge eeweweereeeeacecaasss 7 Dee ee ee SSsSsrtrst cases Seeeeeeene = it\\n' \\\" \\\" 1 4 i!\\nExt\", \"ernal X Dapr i f Dapr External ,\\nU\\n' Resource ; H ' Resource }\\n|\\nt ;\\n' ' \\u00a2 \\u00bb a i\\nry\\n' ' \\u00b0} a i!\\n: \\u2018 \", \"Hy\\n: ; Your s | \\u2018\\n\\u2019 \\u2018 M \\\\\\n' \\u2018 i\\n' \\u2019 an\\n} A \\\"\\n\\nFigure 8-1. Conceptual architecture of a Dapr resource\", \" binding.\\n\\nAt first glance, resource binding behavior may appear similar to the Publish/Subscribe pa\", \"ttern\\ndescribed earlier in this book. While they share similarities, there are differences. Publish/\", \"subscribe\\n\\n72 CHAPTER 9 | The Dapr bindings building block\\nfocuses on asynchronous communication bet\", \"ween Dapr services. Resource binding has a much wider\\nscope. It focuses on system interoperability a\", \"cross software platforms. Exchanging information\\nbetween disparate applications, datastores, and ser\", \"vices outside your microservice application.\\n\\nHow it works\\n\\nDapr resource binding starts with a comp\", \"onent configuration file. This YAML file describes the type of\\nresource to which you'll bind along w\", \"ith its configuration settings. Once configured, your service can\\nreceive events from the resource o\", \"r trigger events on it.\\n\\nNote\\n\\nBinding configurations are presented in detail later in the Component\", \"s section.\\n\\nInput bindings\\n\\nInput bindings trigger your code with incoming events from external reso\", \"urces. To receive events and\\ndata, you register a public endpoint from your service that becomes the\", \" event handler. Figure 8-2\\nshows the flow:\\n\\nPOST http://localhost:6000/tweet\\n\\nponeneesnsnsnensneey 0\", \" ceeneeee\\nExternal Dapr\\nResource <o>\\nEF =\\nYour\\n, service\\n\\nTwitter Bindings\\nbuildingblock\\n|\\nBinding\\nf\", \" configuration\\nen tern nnn nnn nnn nr +\\n\\nFigure 8-2. Dapr input binding flow.\\n\\nFigure 8.2 describes \", \"the steps for receiving events from an external Twitter account:\\n\\n73 CHAPTER 9 | The Dapr bindings b\", \"uilding block\\n1. The Dapr sidecar reads the binding configuration file and subscribes to the event s\", \"pecified for\\nthe external resource. In the example, the event source is a Twitter account.\\n\\n2. When \", \"a matching Tweet is published on Twitter, the binding component running in the Dapr\\nsidecar picks it\", \" up and triggers an event.\\n\\n3. | The Dapr sidecar invokes the endpoint (that is, event handler) conf\", \"igured for the binding. In the\\nexample, the service listens for an HTTP POST on the /tweet endpoint \", \"on port 6000. Because it\\u2019s\\nan HTTP POST operation, the JSON payload for the event is passed in the r\", \"equest body.\\n\\n4. After handling the event, the service returns an HTTP status code 20@ OK.\\n\\nThe foll\", \"owing ASP.NET Core controller provides an example of handling an event triggered by the\\nTwitter bind\", \"ing:\\n\\n| [ApiController |\\npublic class SomeController : ControllerBase\\n{\\npublic class TwitterTweet\\n{\\n\", \"[JsonPropertyName(\\\"id_ str\\\") ]\\npublic string ID {get; set; }\\n[JsonPropertyName(\\\"text\\\") ]\\npublic stri\", \"ng Text {get; set; }\\n}\\n\\n[HttpPost(\\\"/tweet\\\") |\\npublic ActionResult Post(TwitterTweet tweet)\\n{\\n// Hand\", \"le tweet\\nConsole.WriteLine(\\\"Tweet received: {@}: {1}\\\", tweet.ID, tweet.Text);\\n\\nHi coc\\n\\n// Acknowledg\", \"e message\\nreturn Ok();\\n\\nIf the operation should error, you would return the appropriate 400 or 500 l\", \"evel HTTP status code. For\\nbindings that feature at-least-once delivery guarantees, the Dapr sidecar\", \" will retry the trigger. Check\\nout Dapr documentation for resource bindings to see whether they offe\", \"r at-least-once or exactly-once\\ndelivery guarantees.\\n\\nOutput bindings\\n\\nDapr also includes output bin\", \"ding capabilities. They enable your service to trigger an event that\\ninvokes an external resource. A\", \"gain, you start by configuring a binding configuration YAML file that\\ndescribes the output binding. \", \"Once in place, you trigger an event that invokes the bindings API on the\\nDapr sidecar of your applic\", \"ation. Figure 8-3 shows the flow of an output binding:\\n\\n74 CHAPTER 9 | The Dapr bindings building bl\", \"ock\\nPOST http://localhost:3500/v1.0/bindings/sms\\n\\nExternal\\nResource\\n\\nee |\\n\\nDapr API\\nhttp / grpc \\u2014\\u2014* \", \"@\\n\\nservice\\n\\ndapr Sidecar\\n\\nBindings he\\n| buildingblock Twilio SMS\\n8 1 Twilio SMS ;\\n|\\nBinding |\\nconfig\", \"uration\\n\\ne+ + wees eeeeseeensaeeeauanwaaaaaaseaeasaasaawenJt\\n\\n@eoeeeeeeee SSSSSSSSSESSFSSVSSSSBSVSSV\", \"BVESSVSISVSVSOVOF222222F\\nA A A a i a lle\\n\\nPee FS ST SS SS SSS\\n\\nFigure 8-3. Dapr output binding flow.\", \"\\n\\n1. The Dapr sidecar reads the binding configuration file with the information on how to connect to\", \"\\nthe external resource. In the example, the external resource is a Twilio SMS account.\\n\\n2. Your appl\", \"ication invokes the /v1.@/bindings/sms endpoint on the Dapr sidecar. In this case, it\\nuses an HTTP P\", \"OST to invoke the API. It's also possible to use gRPC.\\n\\n3. The binding component running in the Dapr\", \" sidecar calls the external messaging system to send\\nthe message. The message will contain the paylo\", \"ad passed in the POST request.\\n\\nAs an example, you can invoke an output binding by invoking the Dapr\", \" API using curl:\\n\\ncurl -X POST http://localhost:3500/v1.0/bindings/sms \\\\\\n-H \\\"Content-Type: applicati\", \"on/json\\\" \\\\\\n-d '{\\n\\n\\\"data\\\": \\\"Welcome to this awesome service\\\",\\n\\\"metadata\\\": {\\n\\\"toNumber\\\": \\\"555-3277\\\"\\n\\nb\", \"s\\n\\n\\\"operation\\\": \\\"create\\\"\\n\\n}'\\nNote that the HTTP port is the same as used by the Dapr sidecar (in thi\", \"s case, the default Dapr HTTP\\nport 35@@).\\n\\nThe structure of the payload (that is, message sent) will\", \" vary per binding. In the example above, the\\npayload contains a data element with a message. Binding\", \"s to other types of external resources can be\\ndifferent, especially for the metadata that is sent. E\", \"ach payload must also contain an operation field,\\n\\n15 CHAPTER 9 | The Dapr bindings building block\\nt\", \"hat defines the operation the binding will execute. The above example specifies a create operation\\nt\", \"hat creates the SMS message. Common operations include:\\n\\n\\u00b0 create\\n\\u00b0 get\\n. delete\\n. list\\n\\nIt's up to \", \"the author of the binding which operations the binding supports. The documentation for\\neach binding \", \"describes the available operations and how to invoke them.\\n\\nUse the Dapr .NET SDK\\n\\nThe Dapr .NET SDK\", \" provides language-specific support for .NET developers. In the following example,\\nthe call to the H\", \"ttpClient.PostAsync() is replaced with the DaprClient . InvokeBindingAsync()\\nmethod. This specialize\", \"d method simplifies invoking a configured output binding:\\n\\nprivate async Task SendSMSAsync([FromServ\", \"ices] DaprClient daprClient)\\n{\\n\\nvar message = \\\"Welcome to this awesome service\\\";\\nvar metadata = new \", \"Dictionary<string, string>\\n\\n{\\n{ \\\"toNumber\\\", \\\"555-3277\\\" }\\n\\nIre\\n\\nawait daprClient.InvokeBindingAsync(\\\"\", \"sms\\\", \\\"create\\\", message, metadata);\\n\\nThe method expects the metadata and message values.\\n\\nWhen used \", \"to invoke a binding, the DaprCclient uses gRPC to call the Dapr API on the Dapr sidecar.\\n\\nBinding co\", \"mponents\\n\\nUnder the hood, resource bindings are implemented with Dapr binding components. They're\\nco\", \"ntributed by the community and written in Go. If you need to integrate with an external resource\\nfor\", \" which no Dapr binding exists yet, you can create it yourself. Check out the Dapr components-\\ncontri\", \"b repo to see how you can contribute a binding.\\n\\nNote\\n\\nDapr and all of its components are written in\", \" the Golang (Go) language. Go is considered a modern,\\ncloud-native programming platform.\\n\\nYou config\", \"ure bindings using a YAML configuration file. Here\\u2019s an example configuration for the\\nTwitter bindin\", \"g:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\n\\nname: twitter-mention\\n\\n76 CHAPTER 9 | Th\", \"e Dapr bindings building block\\nnamespace: default\\nspec:\\n\\ntype: bindings.twitter\\nversion: v1\\nmetadata\", \":\\n- name: consumerKey\\n\\nvalue: \\\"****\\\" # twitter api consumer key, required\\n- name: consumerSecret\\n\\nva\", \"lue: \\\"****\\\" # twitter api consumer secret, required\\n- name: accessToken\\n\\nvalue: \\\"****\\\" # twitter api\", \" access token, required\\n- name: accessSecret\\n\\nvalue: \\\"****\\\" # twitter api access secret, required\\n- \", \"name: query\\n\\nvalue: \\\"dapr\\\" # your search query, required\\n\\nEach binding configuration contains a gene\", \"ral metadata element with a name and namespace field.\\nDapr will determine the endpoint to invoke you\", \"r service based upon the configured name field. In the\\nabove example, Dapr will invoke the method an\", \"notated with /twitter-mention in your service when\\nan event occurs.\\n\\nIn the spec element, you specif\", \"y the type of the binding along with binding specific metadata. The\\nexample specifies credentials fo\", \"r accessing a Twitter account using its API. The metadata can differ\\nbetween input and output bindin\", \"gs. For example, to use Twitter as an input binding, you need to\\nspecify the text to search for in t\", \"weets using the query field. Every time a matching tweet is sent, the\\nDapr sidecar will invoke the /\", \"twitter-mention endpoint on the service. It will also deliver the\\ncontents of the tweet.\\n\\nA binding \", \"can be configured for input, output, or both. Interestingly, the binding doesn't explicitly\\nspecify \", \"input or output configuration. Instead, the direction is inferred by the usage of the binding\\nalong \", \"with configuration values.\\n\\nThe Dapr documentation for resource bindings provides a complete list of\", \" the available bindings and\\ntheir specific configuration settings.\\n\\nCron binding\\n\\nPay close attentio\", \"n to Dapr\\u2019s Cron binding. It doesn\\u2019t subscribe to events from an external system.\\nInstead, this bind\", \"ing uses a configurable interval schedule to trigger your application. The binding\\nprovides a simple\", \" way to implement a background worker to wake up and do some work at a regular\\ninterval, without the\", \" need to implement an endless loop with a configurable delay. Here\\u2019s an example\\nof a Cron binding co\", \"nfiguration:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: checkOrderBacklog\\nnamespa\", \"ce: default\\n\\nspec:\\ntype: bindings.cron\\nversion: v1\\nmetadata:\\n- name: schedule\\nvalue: \\\"@every 3m\\\"\\n\\n77\", \" CHAPTER 9 | The Dapr bindings building block\\nIn this example, Dapr triggers a service by invoking t\", \"he /checkOrderBacklog endpoint every 30\\nminutes. There are several patterns available for specifying\", \" the schedule value. For more information,\\n\\nsee the Cron binding documentation.\\n\\nSample application:\", \" Dapr Traffic Control\\n\\nIn the Dapr Traffic Control sample application, the TrafficControl service us\", \"es the MQTT input binding\\nto retrieve messages from the CameraSimulation. Figure 8-4 shows the conce\", \"ptual architecture of the\\nDapr Traffic Control sample application. The Dapr input binding is used in\", \" flows marked with number\\n5 in the diagram:\\n\\nTrafficControl Camera\\nea\\n\\nService\\n\\nSimulation\\n\\njponseca\", \"nsoasscnseesceneaatenscastanseassnnnstcnsaneshaaen . ge\\n\\n: \\u00a2 ; = dia\\n\\n| SendFine Ws (2\\n\\u00a38 ! |\\n\\n! Fin\", \"eCollection\\nService\\n1 |\\n\\ndapr\\n\\nSidecar |} |\\n\\nGetVehiclelnfo\\nVehicleRegistration .\\n\\nService\\n\\n4] Servi\", \"ce invocation [3] State management [5] Input binding Actors\\n[2] Publish / subscribe [4] Output bindi\", \"ng | 6) Secrets management\\n\\nFigure 8-4. Conceptual architecture of the Dapr Traffic Control sample a\", \"pplication.\\n\\n78 CHAPTER 9 | The Dapr bindings building block\\nMQTT input binding\\n\\nMQTT is a lightweig\", \"ht pub/sub messaging protocol, often used in loT scenarios. Producers sent MQTT\\nmessages to a topic;\", \" subscribers then retrieve messages from the topic. There are several MQTT\\nmessage broker products a\", \"vailable. The Traffic Control sample application uses Eclipse Mosquitto.\\n\\nThe CameraSimulation doesn\", \"'t depend on any Dapr building blocks. It uses the System.Net.Matt\\nlibrary to send MQTT messages:\\n\\nH\", \"i aoc\\n\\n// simulate entry\\nDateTime entryTimestamp = DateTime.Now;\\nvar vehicleRegistered = new Vehicle\", \"Registered\\n\\nt\\n\\nLane = _camNumber,\\nLicenseNumber = GenerateRandomLicenseNumber(),\\nTimestamp = entryTi\", \"mestamp\\n\\n}3\\n\\n_trafficControlService.SendVehicleEntry(vehicleRegistered) ;\\n\\nHi occ\\n\\nThe code uses a p\", \"roxy of type ITrafficControlService to call the TrafficControl service. .NET injects\\nan implementati\", \"on of the ITrafficControlService interface using constructor injection:\\n\\n:{custom-style=CodeBox} csh\", \"arp public CameraSimulation(int camNumber, ITrafficControlService\\ntrafficControlService) { _camNumbe\", \"r = camNumber; _trafficControlService = trafficControlService;\\nbon\\n\\nThe MgttTrafficControlService cl\", \"ass implements the ITrafficControlService interface. It\\nexposes two methods: SendVehicleEntryAsync a\", \"nd SendVehicleExitAsync. They both use the\\n\\nMQTT client to send messages to the trafficcontrol/entry\", \"cam and trafficcontrol/exitcam\\ntopics respectively:\\n\\npublic async Task SendVehicleEntryAsync(Vehicle\", \"Registered vehicleRegistered)\\nif\\n\\nvar eventjJson = JsonSerializer.Serialize(vehicleRegistered) ;\\n\\nva\", \"r message = new MqttApplicationMessage(\\\"trafficcontrol/entrycam\\\",\\nEncoding.UTF8.GetBytes(eventJson) \", \") ;\\n\\nawait _client.PublishAsync(message, MqttQualityOfService.AtMostOnce) ;\\n\\n5\\n\\npublic async Task Se\", \"ndVehicleExitAsync(VehicleRegistered vehicleRegistered )\\n{\\n\\nvar eventJson = JsonSerializer.Serialize\", \"(vehicleRegistered) ;\\n\\nvar message = new MqttApplicationMessage(\\\"trafficcontrol/exitcam\\\",\\nEncoding.U\", \"TF8.GetBytes(eventJson) ) ;\\n\\nawait _client.PublishAsync(message, MqttQualityOfService.AtMostOnce) ;\\n\", \"\\n}\\n\\nThe constructor sets up the MQTT client to send messages to the MQTT broker (Mosquitto) running\\n\", \"on port 1883.\\n\\nOn the other end, the TrafficControl service uses the MQTT input binding to receive\\nV\", \"ehicleRegistered messages sent by the CameraSimulation. For each subscribed topic, there\\u2019s a\\n\\n79 CHA\", \"PTER 9 | The Dapr bindings building block\\nseparate component configuration file in the /dapr/compone\", \"nts folder. The first one is\\nentrycam.yamL:\\n\\napiVersion: dapr.io/vialpha1l\\nkind: Component\\nmetadata:\", \"\\n\\nname: entrycam\\n\\nnamespace: dapr-trafficcontrol\\nspec:\\n\\ntype: bindings.mgtt\\n\\nversion: v1\\nmetadata:\\n-\", \" name: url\\nvalue: mqtt://localhost:1883\\n- name: topic\\nvalue: trafficcontrol/entrycam\\nscopes:\\n- traff\", \"iccontrolservice\\n\\nThe configuration specifies the binding type: bindings.maqtt. It also specifies th\", \"at the broker runs on\\nlocalhost :1883, the standard port that Mosquitto uses. It also exposes the to\", \"pic,\\ntrafficcontrol/entrycam. Using scopes, the config file specifies that only the service with app\", \"-id\\ntrafficcontrolservice will have access to the binding.\\n\\nWhen the TrafficControl service starts, \", \"the Dapr sidecar automatically subscribes to the\\ntrafficcontrol/entrycam MQTT topic specified in the\", \" component configuration. When messages\\narrive on the topic, the Dapr sidecar invokes an HTTP endpoi\", \"nt on your service. The sidecar\\ndetermines the URL of the HTTP endpoint to call by looking at the me\", \"tadata.name field in the binding\\nconfiguration. In the example above, the endpoint URL is /entrycam.\", \" Within the TrafficControl service,\\nno code needs to be added to support the endpoint:\\n\\n[HttpPost(\\\"e\", \"ntrycam\\\" ) |\\npublic async Task<ActionResult> VehicleEntry(VehicleRegistered msg)\\n\\nt\\n}\\n\\nHi coc\\n\\nThe e\", \"xitcam.yaml component configuration file configures everything for the exitcam endpoint:\\n\\napiVersion\", \": dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: exitcam\\nnamespace: dapr-trafficcontrol\\nspec:\\ntype\", \": bindings.mgtt\\nversion: v1\\nmetadata:\\n- name: url\\nvalue: mgtt://localhost:1883\\n- name: topic\\nvalue: \", \"trafficcontrol/exitcam\\n\\nscopes:\\n- trafficcontrolservice\\n\\n80 CHAPTER 9 | The Dapr bindings building b\", \"lock\\nSMTP output binding\\n\\nThe FineCollection service uses the Dapr SMTP output binding to send email\", \"s. Figure 8-5 shows the\\nconceptual architecture of the Dapr Traffic Control sample application. The \", \"Dapr input binding is used\\nin flows marked with number 4 in the diagram:\\n\\n4\\n\\nTrafficControl\\nService\\n\", \"\\nExitCam\\n\\nFineCollection\\nService\\n\\u2018 a nee\\n\\neo\\n\\nGetVehiclelnfo 6 ; |\\n| : dapr\\n\\nSidecar | |\\n\\nVehicleReg\", \"istration\\nService\\n\\n(4) Service invocation [3] State management [5] Input binding Actors\\n[2] Publish \", \"/ subscribe [4] Output binding 6 | Secrets management\\n\\nFigure 8-5. Conceptual architecture of the Da\", \"pr Traffic Control sample application.\\n\\nThe CollectFine method on the CollectionController in the Fi\", \"neCollection service contains code that\\nuses the Dapr client to invoke the output binding:\\n\\nHi aoc\\n\\n\", \"// send fine by email (Dapr output binding)\\nvar body = EmailUtils.CreateEmailBody(speedingViolation,\", \" vehicleInfo, fineString) ;\\nvar metadata = new Dictionary<string, string>\\n{\\n[\\\"emailFrom\\\"]| = \\\"\\u201cnorep\", \"ly@cfca.gov\\\",\\n[\\\"\\u201cemailTo\\\"] = vehicleInfo.OwnerEmail,\\n\\n81 CHAPTER 9 | The Dapr bindings building bloc\", \"k\\n[\\\"subject\\\"] = $\\\"Speeding violation on the {speedingViolation.RoadId}\\\"\\n\\nB\\nawait daprClient.InvokeBi\", \"ndingAsync(\\\"sendmail\\\", \\\"create\\\", body, metadata) ;\\n\\nHi aoc\\n\\nThe code uses a simple utility class to \", \"create an HTML email body containing the necessary\\ninformation. It also creates a dictionary with me\", \"tadata specific to the SMTP binding. This binding\\ncomponent interprets the metadata when invoked.\\n\\nT\", \"he following arguments are required to invoke the binding:\\n\\n. The name of the binding component. In \", \"this case sendmail.\\n. The operation the binding needs to perform. In this case create.\\n. The body of\", \" the message to send. In this case, the HTML email body.\\n\\n. The metadata for sending the email.\\n\\nThe\", \" Dapr output binding named sendmail is configured in the email. yaml component configuration\\nfile in\", \" the /dapr/components folder:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: sendmail\", \"\\nnamespace: dapr-trafficcontrol\\nspec:\\ntype: bindings.smtp\\nversion: v1\\nmetadata:\\nname: host\\nvalue: lo\", \"calhost\\nname: port\\nvalue: 4025\\nname: user\\nsecretKeyRef:\\nname: smtp.user\\nkey: smtp.user\\nname: passwor\", \"d\\nsecretKeyRef:\\nname: smtp.password\\nkey: smtp.password\\nname: skipTLSVerify\\nvalue: true\\nauth:\\nsecretS\", \"tore: trafficcontrol-secrets\\nscopes:\\n- finecollectionservice\\n\\nThe configuration specifies the bindin\", \"g type: bindings. smtp.\\n\\nThe metadata section contains the information for connecting to the SMTP se\", \"rver. See the binding\\u2019s\\ndocumentation for specific metadata required for this binding. The username \", \"and password to\\nconnect to the SMTP server are retrieved from a secrets store. See the Secrets manag\", \"ement building\\nblock chapter for more information on how this works.\\n\\nThe scopes element specifies t\", \"hat only the service with app-id finecollectonservice can access this\\nbinding.\\n\\n82 CHAPTER 9 | The D\", \"apr bindings building block\\nThe Traffic Control sample application uses MailDev. MailDev is a develo\", \"pment SMTP server that\\ndoesn't actually send out emails (by default). Instead, it collects emails an\", \"d presents them in an inbox\\nweb application. MailDev is extremely useful for dev/test and demo scena\", \"rios.\\n\\nUsing Dapr bindings in the Traffic Control sample application provides the following benefits\", \":\\n\\n1. | Using MQTT messaging and SMTP without the need to learn this protocol or a specific MQTT\\nAPI\", \".\\n\\n2. | Using SMTP to send an email without the need to learn this protocol or a specific SMTP API.\\n\", \"\\nSummary\\n\\nDapr resource bindings enable you to integrate with different external resources and syste\", \"ms without\\ntaking dependencies on their libraries or SDKs. These external systems don't necessarily \", \"have to be\\nmessaging systems like a service bus or message broker. Bindings also exist for datastore\", \"s and web\\nresources like Twitter or SendGrid.\\n\\nInput bindings (or triggers) react to events occurrin\", \"g in an external system. They invoke the public\\nHTTP endpoints pre-configured in your application. D\", \"apr uses the name of the binding in the\\nconfiguration to determine the endpoint to call in your appl\", \"ication.\\n\\nOutput bindings will send messages to an external system. You trigger an output binding by\", \" doing an\\nHTTP POST on the /v1.0/bindings/<binding-name> endpoint on the Dapr sidecar. You can also \", \"use\\ngRPC to invoke the binding. The .NET SDK offers a InvokeBindingAsync method to invoke Dapr\\nbindi\", \"ngs using gRPC.\\n\\nYou implement a binding with a Dapr component. These components are contributed by \", \"the\\ncommunity. Each binding component's configuration has metadata that is specific for the external\", \"\\nsystem it abstracts. Also, the commands it supports and the structure of the payload will differ pe\", \"r\\nbinding component.\\n\\nReferences\\n\\n\\u00b0 Dapr documentation for resource bindings\\n\\u00b0 Mosquitto MQTT broker\", \"\\n\\u00b0 MailDev development SMTP server\\n\\n83 CHAPTER 9 | The Dapr bindings building block\\nCHAPTER\\n\\nTne Dap\", \"r actors building\\nDIOCK\\n\\nThe actor model originated in 1973. It was proposed by Carl Hewitt as a con\", \"ceptual model of\\nconcurrent computation, a form of computing in which several computations are execu\", \"ted at the\\nsame time. Highly parallel computers weren't yet available at that time, but the more rec\", \"ent\\nadvancements of multi-core CPUs and distributed systems have made the actor model popular.\\n\\nIn t\", \"he actor model, the actor is an independent unit of compute and state. Actors are completely\\nisolate\", \"d from each other and they will never share memory. Actors communicate with each other\\nusing message\", \"s. When an actor receives a message, it can change its internal state, and send\\nmessages to other (p\", \"ossibly new) actors.\\n\\nThe reason why the actor model makes writing concurrent systems easier is that\", \" it provides a turn-\\nbased (or single-threaded) access model. Multiple actors can run at the same ti\", \"me, but each actor will\\nprocess received messages one at a time. This means that you can be sure tha\", \"t at most one thread is\\nactive inside an actor at any time. That makes writing correct concurrent an\", \"d parallel systems much\\neasier.\\n\\nWhat it solves\\n\\nActor model implementations are usually tied to a s\", \"pecific language or platform. With the Dapr actors\\nbuilding block however, you can leverage the acto\", \"r model from any language or platform.\\n\\nDapr\\u2019s implementation is based on the virtual actor pattern \", \"introduced by Project \\u201cOrleans\\u201d. With the\\nvirtual actor pattern, you don't need to explicitly create\", \" actors. Actors are activated implicitly and\\n\\nplaced on a node in the cluster the first time a messa\", \"ge is sent to the actor. When not executing\\noperations, actors are silently unloaded from memory. If\", \" a node fails, Dapr automatically moves\\nactivated actors to healthy nodes. Besides sending messages \", \"between actors, the Dapr actor model\\nalso support scheduling future work using timers and reminders.\", \"\\n\\nWhile the actor model can provide great benefits, it\\u2019s important to carefully consider the actor d\", \"esign.\\nFor example, having many clients call the same actor will result in poor performance because \", \"the actor\\noperations execute serially. Here are some criteria to check if a scenario is a good fit f\", \"or Dapr actors:\\n\\n. Your problem space involves concurrency. Without actors, you'd have to introduce \", \"explicit\\nlocking mechanisms in your code.\\n\\n84 CHAPTER 10 | The Dapr actors building block\\n\\u00b0 Your pro\", \"blem space can be partitioned into small, independent, and isolated units of state and\\nlogic.\\n\\n. You\", \" don't need low-latency reads of the actor state. Low-latency reads cannot be guaranteed\\nbecause act\", \"or operations execute serially.\\n\\n. You don\\u2019t need to query state across a set of actors. Querying ac\", \"ross actors is inefficient because\\neach actor's state needs to be read individually and can introduc\", \"e unpredictable latencies.\\n\\nOne design pattern that fits these criteria quite well is the orchestrat\", \"ion-based saga or process\\nmanager design pattern. A saga manages a sequence of steps that must be ta\", \"ken to reach some\\noutcome. The saga (or process manager) maintains the current state of the sequence\", \" and triggers the\\nnext step. If a step fails, the saga can execute compensating actions. Actors make\", \" it easy to deal with\\nconcurrency in the saga and to keep track of the current state. The eSshopOnDa\", \"pr reference\\napplication uses the saga pattern and Dapr actors to implement the Ordering process.\\n\\nH\", \"ow it works\\n\\nThe Dapr sidecar provides the HTTP/gRPC API to invoke actors. This is the base URL of t\", \"he HTTP API:\\n\\nhttp: //localhost:<daprPort>/v1.0/actors/<actorType>/<actorId>/\\n\\n. <daprPort>: the HTT\", \"P port that Dapr listens on.\\n. <actorType>: the actor type.\\n\\n. <actorId>: the ID of the specific act\", \"or to call.\\n\\nThe sidecar manages how, when and where each actor runs, and also routes messages betwe\", \"en\\nactors. When an actor hasn't been used for a period of time, the runtime deactivates the actor an\", \"d\\nremoves it from memory. Any state managed by the actor is persisted and will be available when the\", \"\\nactor re-activates. Dapr uses an idle timer to determine when an actor can be deactivated. When an\\n\", \"operation is called on the actor (either by a method call or a reminder firing), the idle timer is r\", \"eset\\nand the actor instance will remain activated.\\n\\nThe sidecar API is only one part of the equation\", \". The service itself also needs to implement an API\\nspecification, because the actual code that you \", \"write for the actor will run inside the service itself.\\nFigure 11-1 shows the various API calls betw\", \"een the service and its sidecar:\\n\\n85 CHAPTER 10 | The Dapr actors building block\\nInvoke actor method\", \"\\n\\nGet/persist actor state \\u2014\\u2014\\u2014\\n\\nCreate/Get/Delete reminder\\nCreate/Delete ine -\\u2014\\u2014-\\n\\n. &\\ndapr\\nSidecar\\n\\n\", \"\\u2014\\u2014\\u2014-_ Get registered actors\\n\\nI\\u2014\\\\\\u2014__|nvoke actor method\\n\\n2\\u00b0 \\u2014\\u2014\\u2014| (nvoke reminder\\n= __ [NvoOKe timer\\n\\n\", \"Deactivate actor\\n\\nFigure 11-1. API calls between actor service and Dapr sidecar.\\n\\nTo provide scalabi\", \"lity and reliability, actors are partitioned across all the instances of the actor service.\\nThe Dapr\", \" placement service is responsible for keeping track of the partitioning information. When a\\nnew inst\", \"ance of an actor service Is started, the sidecar registers the supported actor types with the\\nplacem\", \"ent service. The placement service calculates the updated partitioning information for the\\ngiven act\", \"or type and broadcasts it to all instances. Figure 11-2 shows what happens when a service is\\nscaled \", \"out to a second replica:\\n\\nimage type=\\\"content\\u201d source=\\\"./media/actors/placement.png\\u201d alt-text=\\\"Diagr\", \"am of the actor\\nplacement service.\\u201d:::\\n\\nFigure 11-2. Actor placement service.\\n\\n1. On startup, the si\", \"decar makes a call to the actor service to get the registered actor types as well\\nas actor configura\", \"tion settings.\\n\\n2. The sidecar sends the list of registered actor types to the placement service.\\n\\n3\", \". The placement service broadcasts the updated partitioning information to all actor service\\ninstanc\", \"es. Each instance will keep a cached copy of the partitioning information and use it to\\ninvoke actor\", \"s.\\n\\nImportant\\n\\nBecause actors are randomly distributed across service instances, it should be expect\", \"ed that an actor\\noperation always requires a call to a different node in the network.\\n\\n86 CHAPTER 10\", \" | The Dapr actors building block\\nThe next figure shows an ordering service instance running in Pod \", \"1 call the ship method of an\\nOrderActor instance with ID 3. Because the actor with ID 3 is placed in\", \" a different instance, this results\\nin a call to a different node in the cluster:\\n\\nPOST http://local\", \"host:3500/v1.0/actors/OrderActor/3/method/ship\\n\\nOrdering\\nService\\n\\nOrdering\\nService\\n\\nPOST http://loca\", \"lhost/actors/OrderActor/3/method/ship\\n\\nFigure 11-3. Calling an actor method.\\n\\n1. The service calls t\", \"he actor API on the sidecar. The JSON payload in the request body contains the\\ndata to send to the a\", \"ctor.\\n\\n2. The sidecar uses the locally cached partitioning information from the placement service to\", \"\\ndetermine which actor service instance (partition) is responsible for hosting the actor with ID 3.\\n\", \"In this example, it\\u2019s the service instance in pod 2. The call is forwarded to the appropriate\\nsideca\", \"r.\\n\\n3. The sidecar instance in pod 2 calls the service instance to invoke the actor. The service ins\", \"tance\\nactivates the actor (if it hasn't already) and executes the actor method.\\n\\n87 CHAPTER 10 | The\", \" Dapr actors building block\\nTurn-based access model\\n\\nThe turn-based access model ensures that at any\", \" time there's at most one thread active inside an\\nactor instance. To understand why this is useful, \", \"consider the following example of a method that\\n\\nincrements a counter value:\\n\\npublic int Increment()\", \"\\n\\nt\\n\\nvar currentValue = GetValue();\\nvar newValue = currentValue + 1;\\n\\nSaveValue(newValue) ;\\n\\nreturn \", \"newValue;\\nbe\\nLet's assume that the current value returned by the GetValue method is 1. When two thre\", \"ads call the\\nIncrement method at the same time, there's a risk of both of them calling the GetValue \", \"method\\nbefore one of them calls SaveValue. This results in both threads starting with the same initi\", \"al value (1).\\nThe threads then increment the value to 2 and return it to the caller. The resulting v\", \"alue after the two\\ncalls is now 2 instead of 3 which it should be. This is a simple example to illus\", \"trate the kind of issues\\nthat can slip into your code when working with multiple threads, and is eas\", \"y to solve. In real world\\napplications however, concurrent and parallel scenarios can become very co\", \"mplex.\\n\\nIn traditional programming models, you can solve this problem by introducing locking mechani\", \"sms.\\nFor example:\\n\\npublic int Increment()\\n\\nt\\n\\nint newValue;\\n\\nlock (_lockObject)\\nt\\n\\nvar currentValue \", \"= GetValue();\\nnewValue = currentValue + 1;\\n\\nSaveValue(newValue) ;\\n\\n5\\n\\nreturn newValue;\\n\\nUnfortunatel\", \"y, using explicit locking mechanisms is error-prone. They can easily lead to deadlocks and\\ncan have \", \"serious impact on performance.\\n\\nThanks to the turn-based access model, you don\\u2019t need to worry about\", \" multiple threads with actors,\\nmaking it much easier to write concurrent systems. The following acto\", \"r example closely mirrors the\\ncode from the previous sample, but doesn\\u2019t require any locking mechani\", \"sms to be correct:\\n\\npublic async Task<int> IncrementAsync()\\n\\nt\\n\\nvar counterValue = await StateManage\", \"r.TryGetStateAsync<int>(\\\"counter\\\") ;\\n\\nvar currentValue = counterValue.HasValue ? counterValue.Value \", \": 0;\\nvar newValue = currentValue + 1;\\n\\n88 CHAPTER 10 | The Dapr actors building block\\nawait StateMan\", \"ager.SetStateAsync(\\\"counter\\\", newValue) ;\\n\\nreturn newValue;\\n\\nTimers and reminders\\n\\nActors can use ti\", \"mers and reminders to schedule calls to themselves. Both concepts support the\\nconfiguration of a due\", \" time. The difference lies in the lifetime of the callback registrations:\\n\\n. Timers will only stay a\", \"ctive as long as the actor Is activated. Timers will not reset the idle-timer,\\nso they cannot keep a\", \"n actor active on their own.\\n\\n\\u00b0 Reminders outlive actor activations. If an actor is deactivated, a r\", \"eminder will re-activate the\\nactor. Reminders will reset the idle-timer.\\n\\nTimers are registered by m\", \"aking a call to the actor API. In the following example, a timer is registered\\nwith a due time of 0 \", \"and a period of 10 seconds.\\n\\ncurl -X POST http://localhost:3500/v1.0/actors/<actorType>/<actorId>/ti\", \"mers/<name> \\\\\\n-H \\\"Content-Type: application/json\\\" \\\\\\n-d '{\\n\\n\\\"dueTime\\\": \\\"@h@m@sems\\\",\\n\\\"period\\\": \\\"@h@m1@\", \"sems\\\"\\n} '\\n\\nBecause the due time is 0, the timer will fire immediately. After a timer callback has fi\", \"nished, the timer\\nwill wait 10 seconds before firing again.\\n\\nReminders are registered in a similar w\", \"ay. The following example shows a reminder registration with a\\ndue time of 5 minutes, and an empty p\", \"eriod:\\n\\ncurl -X POST http://localhost:3500/v1.0/actors/<actorType>/<actorId>/reminders/<name> \\\\\\n-H \\\"\", \"Content-Type: application/json\\\" \\\\\\n-d '{\\n\\u201cdueTime\\\": \\\"@hSm@sems\\\",\\n\\u201cperiod\\u201d: Th\\n\\n}\\n\\nThis reminder will \", \"fire in 5 minutes. Because the given period is empty, this will be a one-time\\nreminder.\\n\\nNote\\n\\nTimer\", \"s and reminders both respect the turn-based access model. When a timer or reminder fires, the\\n\\ncallb\", \"ack will not be executed until any other method invocation or timer/reminder callback has\\nfinished.\\n\", \"\\nState persistence\\n\\nActor state is persisted using the Dapr state management building block. Because\", \" actors can execute\\nmultiple state operations in a single turn, the state store component must suppo\", \"rt multi-item\\ntransactions. At the time of writing, the following state stores support multi-item tr\", \"ansactions:\\n\\n89 CHAPTER 10 | The Dapr actors building block\\n\\u00b0 Azure Cosmos DB\\n\\n\\u00b0 MongoDB\\n\\n: MySQL\\n\\n\\u00b0\", \" PostgreSQL\\n. Redis\\n\\n\\u00b0 RethinkDB\\n\\n\\u00b0 SQL Server\\n\\nTo configure a state store component for use with ac\", \"tors, you need to append the following metadata\\nto the state store configuration:\\n\\n| - name: actorSt\", \"ateStore\\n| value: \\\"true\\\" |\\n\\nHere\\u2019s a complete example for a Redis state store:\\n\\napiVersion: dapr.io/\", \"vialpha1\\nkind: Component\\nmetadata:\\n\\nname: statestore\\n\\nspec:\\ntype: state.redis\\nversion: v1\\n\\nmetadata:\", \"\\nname: redisHost\\nvalue: localhost:6379\\nname: redisPassword\\nvalue: \\\"\\\"\\nname: actorStateStore\\nvalue: \\\"t\", \"rue\\\"\\n\\nUse the Dapr .NET SDK\\n\\nYou can create an actor model implementation using only HTTP/gRPC calls\", \". However, it's much more\\nconvenient to use the language specific Dapr SDKs. At the time of writing,\", \" the .NET, Java and Python\\nSDKs all provide extensive support for working with actors.\\n\\nTo get start\", \"ed with the .NET Dapr actors SDK, you add a package reference to Dapr.Actors to your\\nservice project\", \". The first step of creating an actual actor is to define an interface that derives from\\n\\nTActor. Cl\", \"ients use the interface to invoke operations on the actor. Here\\u2019s a simple example of an\\n\\nactor inte\", \"rface for keeping scores:\\n\\npublic interface IScoreActor : IActor\\n\\nt\\n\\nTask<int> IncrementScoreAsync()\", \";\\n\\nTask<int> GetScoreAsync();\\n\\n90 CHAPTER 10 | The Dapr actors building block\\nImportant\\n\\nThe return \", \"type of an actor method must be Task or Task<T>. Also, actor methods can have at most\\none argument. \", \"Both the return type and the arguments must be System. Text. Json serializable.\\n\\nNext, implement the\", \" actor by deriving a ScoreActor class from Actor. The ScoreActor class must also\\nimplement the IScor\", \"eActor interface:\\n\\npublic class ScoreActor : Actor, IScoreActor\\n\\n{\\npublic ScoreActor(ActorHost host)\", \" : base(host)\\n\\nt\\n}\\n\\n// TODO Implement interface methods.\\n\\nThe constructor in the snippet above takes\", \" a host argument of type ActorHost. The ActorHost class\\nrepresents the host for an actor type within\", \" the actor runtime. You need to pass this argument to the\\nconstructor of the Actor base class. Actor\", \"s also support dependency injection. Any additional\\narguments that you add to the actor constructor \", \"are resolved using the .NET dependency injection\\ncontainer.\\n\\nLet's now implement the IncrementScoreA\", \"sync method of the interface:\\n\\npublic Task<int> IncrementScoreAsync()\\n{\\nreturn StateManager.AddOrUpd\", \"ateStateAsync(\\n\\\"score\\\",\\n1,\\n(key, currentScore) => currentScore + 1\\n\\n)3\\n\\nIn the snippet above, a sing\", \"le call to StateManager .AddOrUpdateStateAsync provides the full\\nimplementation for the IncrementSco\", \"reAsync method. The AddOrUpdateStateAsync method takes\\nthree arguments:\\n\\n1. The key of the state to \", \"update.\\n\\n2. The value to write if no score is stored in the state store yet.\\n\\n3. A Func to call if t\", \"here already is a score stored in the state store. It takes the state key and\\ncurrent score, and ret\", \"urns the updated score to write back to the state store.\\n\\nThe GetScoreAsync implementation reads the\", \" current score from the state store and returns it to the\\nclient:\\n\\npublic async Task<int> GetScoreAs\", \"ync()\\n\\nt\\n\\nvar scoreValue = await StateManager.TryGetStateAsync<int>(\\\"score\\\") ;\\nif (scoreValue.HasVal\", \"ue)\\n\\nt\\n}\\n\\nreturn scoreValue.Value;\\n\\n91 CHAPTER 10 | The Dapr actors building block\\nreturn 0;\\n| } |\\n\\n\", \"To host actors in an ASP.NET Core service, you must add a reference to the Dapr.Actors.AspNetCore\\npa\", \"ckage and make some changes in the Program file. In the following example, the call to\\nMapActorsHand\", \"lers registers Dapr Actor endpoints in ASP.NET Core routing:\\n\\nvar builder = WebApplication.CreateBui\", \"lder(args) ;\\nvar app = builder.Build();\\n// Actors building block does not support HTTPS redirection.\", \"\\n\\n//app.UseHttpsRedirection();\\napp.MapControllers();\\n\\n// Add actor endpoints.\\napp.MapActorsHandlers(\", \");\\n\\nThe actors endpoints are necessary because the Dapr sidecar calls the application to host and in\", \"teract\\nwith actor instances.\\n\\nImportant\\n\\nMake sure your Program (or Startup) class does not contain \", \"an app.UseHttpsRedirection call to\\nredirect clients to the HTTPS endpoint. This will not work with a\", \"ctors. By design, a Dapr sidecar sends\\nrequests over unencrypted HTTP by default. The HTTPS middlewa\", \"re will block these requests when\\nenabled.\\n\\nThe Program file is also the place to register the speci\", \"fic actor types. The following example registers\\nthe ScoreActor using the AddActors extension method\", \":\\n\\nvar builder = WebApplication.CreateBuilder(args) ;\\nbuilder.Services.AddActors(options =>\\n\\n{\\noptio\", \"ns.Actors.RegisterActor<ScoreActor>() ;\\n\\n})5\\n\\nAt this point, the ASP.NET Core service is ready to ho\", \"st the ScoreActor and accept incoming requests.\\nClient applications use actor proxies to invoke oper\", \"ations on actors. The following example shows\\nhow a console client application invokes the Increment\", \"ScoreAsync operation on a ScoreActor\\ninstance:\\n\\nvar actorId = new ActorId(\\\"scoreActor1\\\") ;\\nvar proxy\", \" = ActorProxy.Create<IScoreActor>(actorId, \\\"ScoreActor\\\") ;\\n\\nvar score = await proxy.IncrementScoreAs\", \"ync() ;\\n\\nConsole.WriteLine($\\\"Current score: {score}\\\");\\n\\nThe above example uses the Dapr.Actors packa\", \"ge to call the actor service. To invoke an operation on\\nan actor, you need to be able to address it.\", \" You'll need two parts for this:\\n\\n1. The actor type uniquely identifies the actor implementation acr\", \"oss the whole application. By\\ndefault, the actor type is the name of the implementation class (witho\", \"ut namespace). You can\\ncustomize the actor type by adding an ActorAttribute to the implementation cl\", \"ass and setting\\nits TypeName property.\\n\\n92 CHAPTER 10 | The Dapr actors building block\\n2. The ActorI\", \"d uniquely identifies an instance of an actor type. You can also use this class to\\ngenerate a random\", \" actor id by calling ActorId.CreateRandom.\\n\\nThe example uses ActorProxy.Create to create a proxy ins\", \"tance for the ScoreActor. The Create\\nmethod takes two arguments: the ActorId identifying the specifi\", \"c actor and the actor type. It also has\\na generic type parameter to specify the actor interface that\", \" the actor type implements. As both the\\nserver and client applications need to use the actor interfa\", \"ces, they're typically stored in a separate\\nshared project.\\n\\nThe final step in the example calls the\", \" IncrementScoreAsync method on the actor and outputs the\\nresult. Remember that the Dapr placement se\", \"rvice distributes the actor instances across the Dapr\\nsidecars. Therefore, expect an actor call to b\", \"e a network call to another node.\\n\\nCall actors from ASP.NET Core clients\\n\\nThe console client example\", \" in the previous section uses the static ActorProxy.Create method directly\\nto get an actor proxy ins\", \"tance. If the client application is an ASP.NET Core application, you should use\\nthe IActorProxyFacto\", \"ry interface to create actor proxies. The main benefit is that it allows you to\\nmanage configuration\", \" in one place. The AddActors extension method on IServiceCollection takes\\na delegate that allows you\", \" to specify actor runtime options, such as the HTTP endpoint of the Dapr\\nsidecar. The following exam\", \"ple specifies custom JsonSerializerOptions to use for actor state\\npersistence and message deserializ\", \"ation:\\n\\nvar builder = WebApplication.CreateBuilder(args) ;\\nbuilder.Services.AddActors(options =>\\n\\nt\\n\", \"\\nvar jsonSerializerOptions = new JsonSerializerOptions()\\n\\nt\\n\\nPropertyNamingPolicy = JsonNamingPolicy\", \".CamelCase,\\n\\nPropertyNameCaseInsensitive = true\\n\\nIre\\n\\noptions.JsonSerializerOptions = jsonSerializer\", \"Options ;\\noptions.Actors.RegisterActor<ScoreActor>() ;\\n\\nThe call to AddActors registers the IActorPr\", \"oxyFactory for .NET dependency injection. This allows\\nASP.NET Core to inject an IActorProxyFactory i\", \"nstance into your controller classes. The following\\nexample calls an actor method from an ASP.NET Co\", \"re controller class:\\n\\n[ApiController |\\n[Route(\\\"[controller]\\\") ]\\npublic class ScoreController : Contr\", \"ollerBase\\n\\nt\\n\\nprivate readonly IActorProxyFactory _actorProxyFactory;\\n\\npublic ScoreController(IActor\", \"ProxyFactory actorProxyFactory )\\n\\nt\\n}\\n\\n[HttpPut(\\\"{scoreId}\\\") ]\\npublic Task<int> IncrementAsync(strin\", \"g scoreId)\\n\\nt\\n\\n_actorProxyFactory = actorProxyFactory ;\\n\\n93 CHAPTER 10 | The Dapr actors building bl\", \"ock\\nvar scoreActor = _actorProxyFactory.CreateActorProxy<IScoreActor>(\\nnew ActorId(scorelId),\\n\\\"Score\", \"Actor\\\") ;\\n\\nreturn scoreActor.IncrementScoreAsync() ;\\n\\nActors can also call other actors directly. Th\", \"e Actor base class exposes an IActorProxyFactory class\\nthrough the ProxyFactory property. To create \", \"an actor proxy from within an actor, use the\\nProxyFactory property of the Actor base class. The foll\", \"owing example shows an OrderActor that\\ninvokes operations on two other actors:\\n\\npublic class OrderAc\", \"tor : Actor, IOrderActor\\n\\n{\\npublic OrderActor(ActorHost host) : base(host)\\n\\nt\\n}\\n\\npublic async Task P\", \"rocessOrderAsync(Order order)\\n\\nt\\n\\nvar stockActor = ProxyFactory.CreateActorProxy<IStockActor>(\\nnew A\", \"ctorId(order.OrderNumber ) ,\\n\\\"StockActor\\\") ;\\nawait stockActor.ReserveStockAsync(order.OrderLines) ;\\n\", \"var paymentActor = ProxyFactory.CreateActorProxy<IPaymentActor> (\\nnew ActorId(order.OrderNumber ) ,\\n\", \"\\u201cPaymentActor\\\") ;\\n\\nawait paymentActor.ProcessPaymentAsync(order.PaymentDetails) ;\\n\\nNote\\n\\nBy default,\", \" Dapr actors aren't reentrant. This means that a Dapr actor cannot be called more than once\\nin the s\", \"ame chain. For example, the call chain Actor A -> Actor B -> Actor Ais not allowed. At the\\ntime of w\", \"riting, there's a preview feature available to support reentrancy. However, there is no SDK\\nsupport \", \"yet. For more details, see the official documentation.\\n\\nCall non-.NET actors\\n\\nSo far, the examples u\", \"sed strongly-typed actor proxies based on .NET interfaces to illustrate actor\\ninvocations. This work\", \"s great when both the actor host and client are .NET applications. However, if\\nthe actor host is not\", \" a .NET application, you don\\u2019t have an actor interface to create a strongly-typed\\nproxy. In these ca\", \"ses, you can use a weakly-typed proxy.\\n\\nYou create weakly-typed proxies in a similar way to strongly\", \"-typed proxies. Instead of relying ona\\n.NET interface, you need to pass in the actor method name as \", \"a string.\\n\\n[HttpPut(\\\"{scoreId}\\\") ]\\npublic Task<int> IncrementAsync(string scoreId)\\n\\n94 CHAPTER 10 | \", \"The Dapr actors building block\\nvar scoreActor = _actorProxyFactory.CreateActorProxy(\\nnew ActorId(sco\", \"reId),\\n\\\"ScoreActor\\\") ;\\n\\nreturn scoreActor(\\\"IncrementScoreAsync\\\") ;\\n\\nTimers and reminders\\n\\nUse the Re\", \"gisterTimerAsync method of the Actor base class to schedule actor timers. In the\\nfollowing example, \", \"a TimerActor exposes a StartTimerAsync method. Clients can call the method to\\nstart a timer that rep\", \"eatedly writes a given text to the log output.\\n\\npublic class TimerActor : Actor, ITimerActor\\n\\n{\\npubl\", \"ic TimerActor(ActorHost host) : base(host)\\n{\\n}\\n\\npublic Task StartTimerAsync(string name, string text\", \")\\n{\\nreturn RegisterTimerAsync(\\n\\nname,\\n\\nnameof (TimerCallback),\\n\\nEncoding.UTF8.GetBytes(text),\\n\\nTimeS\", \"pan.Zero,\\n\\nTimeSpan.FromSeconds(3));\\n\\n5\\n\\npublic Task TimerCallbackAsync(byte[] state)\\n{\\n\\nvar text = \", \"Encoding.UTF8.GetString(state) ;\\nLogger.LogInformation($\\\"Timer fired: {text}\\\");\\n\\nreturn Task.Complet\", \"edTask;\\n\\nThe StartTimerAsync method calls RegisterTimerAsync to schedule the timer. RegisterTimerAsy\", \"nc\\ntakes five arguments:\\n\\nThe name of the timer.\\nThe name of the method to call when the timer fires\", \".\\nThe state to pass to the callback method.\\n\\nThe amount of time to wait before the callback method i\", \"s first invoked.\\n\\nee\\n\\nThe time interval between callback method invocations. You can specify\\nTimeSpa\", \"n.FromMilliseconds(-1) to disable periodic signaling.\\n\\nThe TimerCallbackAsync method receives the us\", \"er state in binary form. In the example, the callback\\ndecodes the state back to a string before writ\", \"ing it to the log.\\n\\nTimers can be stopped by calling UnregisterTimerAsync:\\n\\n95 CHAPTER 10 | The Dapr\", \" actors building block\\npublic class TimerActor : Actor, ITimerActor\\n\\nt\\n\\nHi coc\\n\\npublic Task StopTime\", \"rAsync(string name)\\nt\\n\\n5\\n\\nreturn UnregisterTimerAsync(name) ;\\n\\nRemember that timers do not reset the\", \" actor idle timer. When no other calls are made on the actor, it\\nmay be deactivated and the timer wi\", \"ll be stopped automatically. To schedule work that does reset the\\nidle timer, use reminders which we\", \"'ll look at next.\\n\\nTo use reminders in an actor, your actor class must implement the IRemindable int\", \"erface:\\n\\npublic interface IRemindable\\n\\nt\\n\\nTask ReceiveReminderAsync (\\n\\nstring reminderName, byte[] s\", \"tate,\\nTimeSpan dueTime, TimeSpan period) ;\\n\\nThe ReceiveReminderAsync method is called when a reminde\", \"r is fired. It takes 4 arguments:\\n\\n1 The name of the reminder.\\n\\n2. The user state provided during re\", \"gistration.\\n\\n3. The invocation due time provided during registration.\\n4. The invocation period provi\", \"ded during registration.\\n\\nTo register a reminder, use the RegisterReminderAsync method of the actor \", \"base class. The following\\nexample sets a reminder to fire a single time with a due time of three min\", \"utes.\\n\\npublic class ReminderActor : Actor, IReminderActor, IRemindable\\n\\n{\\n\\npublic ReminderActor(Acto\", \"rHost host) : base(host)\\n\\n{\\n\\n}\\n\\npublic Task SetReminderAsync(string text)\\n\\n{\\n\\nreturn RegisterReminde\", \"rAsync (\\n\\n\\u201cDoNotForget\\\",\\nEncoding.UTF8.GetBytes(text),\\nTimeSpan.FromSeconds(3),\\nTimeSpan.FromMillise\", \"conds(-1));\\n\\n}\\n\\npublic Task ReceiveReminderAsync (\\nstring reminderName, byte[] state,\\nTimeSpan dueTi\", \"me, TimeSpan period)\\n\\nif (reminderName == \\\"DoNotForget\\\" )\\n{\\nvar text = Encoding.UTF8.GetString(state\", \") ;\\n\\nLogger.LogInformation($\\\"Don't forget: {text}\\\");\\n\\n96 CHAPTER 10 | The Dapr actors building block\", \"\\n5\\n\\nreturn Task.CompletedTask;\\n\\nThe RegisterReminderAsync method is similar to RegisterTimerAsync bu\", \"t you don't have to specify\\na callback method explicitly. As the above example shows, you implement\\n\", \"TRemindable.ReceiveReminderAsync to handle fired reminders.\\n\\nReminders both reset the idle timer and\", \" are persistent. Even if your actor is deactivated, it will be\\nreactivated at the moment a reminder \", \"fires. To stop a reminder from firing, call\\nUnregisterReminderAsync.\\n\\nSample application: Dapr Traff\", \"ic Control\\n\\nThe default version of Dapr Traffic Control does not use the actor model. However, it do\", \"es contain an\\nalternative actor-based implementation of the TrafficControl service that you can enab\", \"le. To make use\\nof actors in the TrafficControl service, open up the\\nsrc/TrafficControlService/Contr\", \"ollers/TrafficController.cs file and uncomment the\\nUSE_ACTORMODEL statement at the top of the file:\\n\", \"\\n#define USE ACTORMODEL\\n\\nWhen the actor model is enabled, the application uses actors to represent v\", \"ehicles. The operations\\nthat can be invoked on the vehicle actors are defined in an IVehicleActor in\", \"terface:\\n\\npublic interface IVehicleActor : IActor\\n\\nt\\n\\nTask RegisterEntryAsync(VehicleRegistered msg)\", \" ;\\nTask RegisterExitAsync(VehicleRegistered msg);\\n\\nThe (simulated) entry cameras call the RegisterEn\", \"tryAsync method when a new vehicle is first\\ndetected in the lane. The only responsibility of this me\", \"thod is storing the entry timestamp in the actor\\nState:\\n\\nvar vehicleState = new VehicleState\\n\\nt\\n\\nLic\", \"enseNumber = msg.LicenseNumber,\\nEntryTimestamp = msg.Timestamp\\n\\n}5\\n\\nawait StateManager.SetStateAsync\", \"(\\\"VehicleState\\\", vehicleState) ;\\n\\nWhen the vehicle reaches the end of the speed camera zone, the exi\", \"t camera calls the\\nRegisterExitAsync method. The RegisterExitAsync method first gets the current sta\", \"tes and\\nupdates it to include the exit timestamp:\\n\\nvar vehicleState = await StateManager.GetStateAsy\", \"nc<VehicleState>(\\\"VehicleState\\\") ;\\n\\nvehicleState.ExitTimestamp = msg.Timestamp;\\n\\n97 CHAPTER 10 | The\", \" Dapr actors building block\\nNote\\n\\nThe code above currently assumes that a VehicleState instance has \", \"already been saved by the\\n\\nRegisterEntryAsync method. The code could be improved by first checking t\", \"o make sure the state\\nexists. Thanks to the turn-based access model, no explicit locks are required \", \"in the code.\\n\\nAfter the state is updated, the RegisterExitAsync method checks if the vehicle was dri\", \"ving too fast. If\\nit was, the actor publishes a message to the collectfine pub/sub topic:\\n\\nint viola\", \"tion = _speedingViolationCalculator.DetermineSpeedingViolationInkmh(\\nvehicleState.EntryTimestamp, ve\", \"hicleState.ExitTimestamp) ;\\n\\nif (violation > @)\\n{\\nvar speedingViolation = new SpeedingViolation\\n{\\nVe\", \"hicleId = msg.LicenseNumber,\\nRoadId = _roadId,\\nViolationiInkmh = violation,\\nTimestamp = msg.Timestam\", \"p\\n\\nIre\\n\\nawait _daprClient.PublishEventAsync(\\\"pubsub\\\", \\\"\\u201ccollectfine\\\", speedingViolation) ;\\n\\nThe code\", \" above uses two external dependencies. The _speedingViolationCalculator encapsulates\\nthe business lo\", \"gic for determining whether or not a vehicle has driven too fast. The _daprClient\\nallows the actor t\", \"o publish messages using the Dapr pub/sub building block.\\n\\nBoth dependencies are registered in the P\", \"rogram.cs class and injected into the actor using constructor\\ndependency injection:\\n\\nprivate readonl\", \"y DaprClient _daprClient;\\nprivate readonly ISpeedingViolationCalculator _speedingViolationCalculator\", \";\\nprivate readonly string _roadId;\\n\\npublic VehicleActor(\\nActorHost host, DaprClient daprClient,\\n\\nISp\", \"eedingViolationCalculator speedingViolationCalculator)\\n: base(host)\\n\\n_daprClient = daprClient;\\n_spee\", \"dingViolationCalculator = speedingViolationCalculator;\\n_roadid = _speedingViolationCalculator.GetRoa\", \"dId();\\n\\nThe actor based implementation no longer uses the Dapr state management building block direc\", \"tly.\\nInstead, the state is automatically persisted after each operation is executed.\\n\\nSummary\\n\\nThe D\", \"apr actors building block makes it easier to write correct concurrent systems. Actors are small\\nunit\", \"s of state and logic. They use a turn-based access model which saves you from having to use\\nlocking \", \"mechanisms to write thread-safe code. Actors are created implicitly and are silently unloaded\\n\\n98 CH\", \"APTER 10 | The Dapr actors building block\\nfrom memory when no operations are performed. Any state st\", \"ored in the actor is automatically\\npersisted and loaded when the actor is reactivated. Actor model i\", \"mplementations are typically created\\nfor a specific language or platform. With the Dapr actors build\", \"ing block however, you can leverage the\\nactor model from any language or platform.\\n\\nActors support t\", \"imers and reminders to schedule future work. Timers do not reset the idle timer and\\nwill allow the a\", \"ctor to be deactivated when no other operations are performed. Reminders do reset\\nthe idle timer and\", \" are also persisted automatically. Both timers and reminders respect the turn-based\\naccess model, ma\", \"king sure that no other operations can execute while the timer/reminder events are\\nhandled.\\n\\nActor s\", \"tate is persisted using the Dapr state management building block. Any state store that\\nsupports mult\", \"i-item transactions can be used to store actor state.\\n\\nReferences\\n\\n\\u00b0 Dapr supported state stores\\n\\n99\", \" CHAPTER 10 | The Dapr actors building block\\nCHAPTER\\n\\nTne Dapr observability\\nbuilding block\\n\\nModern \", \"distributed systems are complex. You start with small, loosely coupled, independently\\ndeployable ser\", \"vices. These services cross process and server boundaries. They then consume different\\nkinds of infr\", \"astructure backing services (databases, message brokers, key vaults). Finally, these\\ndisparate piece\", \"s compose together to form an application.\\n\\nWith so many separate, moving parts, how do you make sen\", \"se of what is going on? Unfortunately,\\nlegacy monitoring approaches from the past aren't enough. Ins\", \"tead, the system must be observable\\nfrom end-to-end. Modern observability practices provide visibili\", \"ty and insight into the health of the\\napplication at all times. They enable you to infer the interna\", \"l state by observing the output. Not only is\\nobservability mandatory for monitoring and troubleshoot\", \"ing distributed applications, it needs to be\\nimplemented at the start.\\n\\nThe system information used \", \"to gain observability is referred to as telemetry. It can be divided into\\nfour broad categories:\\n\\n1.\", \" Distributed tracing provides insights into the traffic between services involved in distributed\\nbus\", \"iness transactions.\\n\\n2. Metrics provides insights into the performance of a service and its resource\", \" consumption.\\n3. Logging provides insights into how code is executing and if errors have occurred.\\n\\n\", \"4. Health endpoints provide insight into the availability of a service.\\n\\nThe depth of telemetry is d\", \"etermined by the observability features of an application platform.\\nConsider the Azure cloud. It pro\", \"vides a rich telemetry experience that includes all of the telemetry\\ncategories. With little configu\", \"ration, Azure laaS and PaaS services will propagate and publish\\ntelemetry to the Azure Monitor and A\", \"zure Application Insights services. Application Insights presents\\nsystem logging, tracing, and probl\", \"em areas with highly visual dashboards. It can even render a\\ndiagram showing the dependencies betwee\", \"n services based on their communication.\\n\\nHowever, what if an application can't use Azure PaaS and l\", \"aaS resources? Is it still possible to take\\nadvantage of the rich telemetry experience of Applicatio\", \"n Insights? The answer is yes. A non-Azure\\napplication can import libraries, add configuration, and \", \"instrument code to emit telemetry to Azure\\nApplication Insights. However, this approach tightly coup\", \"les the application to Application Insights.\\nMoving the app to a different monitoring platform could\", \" involve expensive refactoring. Wouldn't it be\\ngreat to avoid tight coupling and consume observabili\", \"ty outside of the code?\\n\\nWith Dapr, you can. Let's look at how Dapr can add observability to our dis\", \"tributed applications.\\n\\n100 CHAPTER 11 | The Dapr observability building block\\nWhat it solves\\n\\nThe D\", \"apr observability building block decouples observability from the application. It automatically\\ncapt\", \"ures traffic generated by Dapr sidecars and Dapr system services that make up the Dapr control\\nplane\", \". The block correlates traffic from a single operation that spans multiple services. It also exposes\", \"\\nperformance metrics, resource utilization, and the health of the system. Telemetry is published in\\n\", \"open-standard formats enabling information to be fed into your monitoring back end of choice.\\nThere,\", \" the information can be visualized, queried, and analyzed.\\n\\nAs Dapr abstracts away the plumbing, the\", \" application is unaware of how observability is implemented.\\nThere's no need to reference libraries \", \"or implement custom instrumentation code. Dapr allows the\\ndeveloper to focus on building business lo\", \"gic instead of observability plumbing. Observability is\\nconfigured at the Dapr system level and is c\", \"onsistent across services, even when created by different\\nteams, and built with different technology\", \" stacks.\\n\\nHow it works\\n\\nDapr\\u2019s sidecar architecture enables built-in observability features. As serv\", \"ices communicate, Dapr\\nsidecars intercept the traffic and extract tracing, metrics, and logging info\", \"rmation. Telemetry is\\npublished in an open standards format. By default, Dapr supports OpenTelemetry\", \" and Zipkin.\\n\\nDapr provides collectors that can publish telemetry to different back-end monitoring t\", \"ools. These\\ntools present Dapr telemetry for analysis and querying. Figure 10-1 shows the Dapr obser\", \"vability\\narchitecture:\\n\\n1\\nServiceA |g | ade Secs A leer | abe py tigi Service B\\n\\n|\\n\\nMonitoring\\nbacke\", \"nd\\n\\nMonitoring\\nbackend\\n\\nFigure 10-7. Dapr observability architecture.\\n\\n1. Service A calls an operati\", \"on on Service B. The call is routed from a Dapr sidecar for Service A to a\\nsidecar for Service B.\\n\\n2\", \". When Service B completes the operation, a response is sent back to Service A through the Dapr\\nside\", \"cars. They gather and publish all available telemetry for every request and response.\\n\\n3. The config\", \"ured collector ingests the telemetry and sends it to the monitoring back end.\\n\\n101 CHAPTER 11 | The \", \"Dapr observability building block\\nAs a developer, keep in mind that adding observability is differen\", \"t from configuring other Dapr\\nbuilding blocks, like pub/sub or state management. Instead of referenc\", \"ing a building block, you add a\\ncollector and a monitoring back end. Figure 10-1 shows it's possible\", \" to configure multiple collectors\\nthat integrate with different monitoring back ends.\\n\\nAt the beginn\", \"ing of this chapter, four categories of telemetry were identified. The following sections\\nwill provi\", \"de detail for each category. They'll include instruction on how to configure collectors that\\nintegra\", \"te with popular monitoring back ends.\\n\\nDistributed tracing\\n\\nDistributed tracing provides insight int\", \"o traffic that flows across services in a distributed application.\\nThe logs of exchanged request and\", \" response messages are a source of invaluable information for\\ntroubleshooting issues. The hard part \", \"is correlating messages that belong to the same business\\ntransaction.\\n\\nDapr uses the W3C Trace Conte\", \"xt to correlate related messages. It injects the same context\\ninformation into requests and response\", \"s that form a unique operation. Figure 10-2 shows how\\ncorrelation works:\\n\\nService B\\n2 4\\n|\\n|\\n| dapr S\", \"ervice A MM Service B \\u201d anne Service C\\nsidecar apr sidecar aol sidecar\\n\\nNote\\n\\nThe trace context is o\", \"ften referred to as a correlation token in microservice terminology.\\n\\nFigure 10-2. W3C Trace Context\", \" example.\\n\\n1. Service A invokes an operation on Service B. As Service A starts the call, Dapr create\", \"s a unique\\ntrace context and injects it into the request.\\n\\n2. Service B receives the request and inv\", \"okes an operation on Service C. Dapr detects that the\\nincoming request contains a trace context and \", \"propagates it by injecting it into the outgoing\\nrequest to Service C.\\n\\n3. Service C receives the req\", \"uest and handles it. Dapr detects that the incoming request contains a\\ntrace context and propagates \", \"it by injecting it into the outgoing response back to Service B.\\n\\n4. Service B receives the response\", \" and handles it. It then creates a new response and propagates\\nthe trace context by injecting it int\", \"o the outgoing response back to Service A.\\n\\nA set of requests and responses that belong together is \", \"called a trace. Figure 10-3 shows a trace:\\n\\n102 CHAPTER 11 | The Dapr observability building block\\n\\u201c\", \"Span A=-~>B\\nSpan We B\\u2014Prc\\n\\nFigure 10-3. Traces and spans.\\n\\nIn the figure, note how the trace represe\", \"nts a unique application transaction that takes place across\\nmany services. A trace is a collection \", \"of spans. Each span represents a single operation or unit of work\\ndone within the trace. Spans are t\", \"he requests and responses that are sent between services that\\nimplement the unique transaction.\\n\\nThe\", \" next sections discuss how to inspect tracing telemetry by publishing it to a monitoring back end.\\n\\n\", \"Use a Zipkin monitoring back end\\n\\nZipkin is an open-source distributed tracing system. It can ingest\", \" and visualize telemetry data. Dapr\\noffers default support for Zipkin. The following example demonst\", \"rates how to configure Zipkin to\\nvisualize Dapr telemetry.\\n\\nEnable and configure tracing\\n\\nTo start, \", \"tracing must be enabled for the Dapr runtime using a Dapr configuration file. Here\\u2019s an\\nexample of a\", \" configuration file named dapr-config.yaml that enables tracing:\\n\\napiVersion: dapr.io/vialpha1\\nkind:\", \" Configuration\\nmetadata:\\nname: dapr-config\\nnamespace: default\\n\\nspec:\\ntracing:\\nsamplingRate: \\\"1\\\"\\nZipk\", \"in:\\nendpointAddress: \\\"http://zipkin.default.svc.cluster.local:9411/api/v2/spans\\\"\\n\\nThe samplingRate a\", \"ttribute specifies the interval used for publishing traces. The value must be\\nbetween @ (tracing dis\", \"abled) and 1 (every trace is published). With a value of @.5, for example, every\\nother trace is publ\", \"ished, significantly reducing published traffic. The endpointAddress points to an\\nendpoint on a Zipk\", \"in server running in a Kubernetes cluster. The default port for Zipkin is 9411. The\\nconfiguration mu\", \"st be applied to the Kubernetes cluster using the Kubernetes CLI:\\n\\nkubectl apply -f dapr-config.yaml\", \"\\n\\n103 CHAPTER 11 | The Dapr observability building block\\nInstall the Zipkin server\\n\\nWhen installing \", \"Dapr in self-hosted mode, a Zipkin server is automatically installed and tracing is\\nenabled in the d\", \"efault configuration file located in $HOME/.dapr/config.yaml or\\n#USERPROFILE%\\\\ .dapr\\\\config.yaml on \", \"Windows.\\n\\nWhen installing Dapr on a Kubernetes cluster, Zipkin must be deployed manually. Use the fo\", \"llowing\\nKubernetes manifest file entitled zipkin. yaml to deploy a standard Zipkin server to a Kuber\", \"netes\\ncluster:\\n\\nkind: Deployment\\napiVersion: apps/v1\\nmetadata:\\nname: zipkin\\nnamespace: dapr-trafficc\", \"ontrol\\nlabels:\\nservice: zipkin\\n\\nspec:\\nreplicas: 1\\nselector:\\nmatchLabels:\\nservice: zipkin\\ntemplate:\\nm\", \"etadata:\\nlabels:\\nservice: zipkin\\nspec:\\ncontainers:\\n- name: zipkin\\nimage: openzipkin/zipkin-slim\\nimag\", \"ePullPolicy: IfNotPresent\\nports:\\n- name: http\\ncontainerPort: 9411\\nprotocol: TCP\\n\\nkind: Service\\n\\napiV\", \"ersion: v1\\n\\nmetadata:\\nname: zipkin\\nnamespace: dapr-trafficcontrol\\nlabels:\\n\\nservice: zipkin\\n\\nspec:\\nty\", \"pe: NodePort\\nports:\\n\\n- port: 9411\\ntargetPort: 9411\\nnodePort: 32411\\nprotocol: TCP\\nname: zipkin\\n\\nselec\", \"tor:\\n\\nservice: zipkin\\n\\nThe deployment uses the standard openzipkin/zipkin-slim container image. The \", \"Zipkin service\\nexposes the Zipkin web front end, which you can use to view the telemetry on port 324\", \"11. Use the\\n\\n104 CHAPTER 11 | The Dapr observability building block\\nKubernetes CLI to apply the Zipk\", \"in manifest file to the Kubernetes cluster and deploy the Zipkin\\nserver:\\n\\nkubectl apply -f zipkin.ya\", \"ml\\n\\nConfigure the services to use the tracing configuration\\n\\nNow everything is set up correctly to s\", \"tart publishing telemetry. Every Dapr sidecar that is deployed as\\npart of the application must be in\", \"structed to emit telemetry when started. To do that, add a\\ndapr.io/config annotation that references\", \" the dapr-config configuration to the deployment of\\neach service. Here\\u2019s an example of the Traffic C\", \"ontrol FineCollection service's manifest file containing\\nthe annotation:\\n\\napiVersion: apps/v1\\nkind: \", \"Deployment\\nmetadata:\\nname: finecollectionservice\\nnamespace: dapr-trafficcontrol\\nlabels:\\napp: finecol\", \"lectionservice\\nspec:\\nreplicas: 1\\nselector:\\nmatchLabels:\\napp: finecollectionservice\\ntemplate:\\nmetadat\", \"a:\\n\\nlabels:\\napp: finecollectionservice\\n\\nannotations:\\ndapr.io/enabled: \\\"true\\\"\\ndapr.io/app-id: \\\"fineco\", \"llectionservice\\\"\\ndapr.io/app-port: \\\"6001\\\"\\ndapr.io/config: \\\"\\u201cdapr-config\\\"\\n\\nspec:\\n\\ncontainers:\\n\\n- name\", \": finecollectionservice\\nimage: dapr-trafficcontrol/finecollectionservice:1.0\\nports:\\n\\n- containerPort\", \": 6001\\n\\nInspect the telemetry in Zipkin\\n\\nOnce the application is started, the Dapr sidecars will emi\", \"t telemetry to the Zipkin server. To inspect\\nthis telemetry, point a web-browser to http: //localhos\", \"t: 32411. You'll see the Zipkin web front end:\\n\\n105 CHAPTER 11 | The Dapr observability building blo\", \"ck\\nZipkin Q. Finda trace\\n\\nSearch Traces\\n\\nPlease s\\u00e9lect criteria in the search bar. Then, click the S\", \"s\\u00e9arch bulten\\n\\nFigure 10-4. Zipkin front end.\\n\\nOn the Find a trace tab, you can query traces. Pressi\", \"ng the RUN QUERY button without specifying any\\nrestrictions will show all the ingested traces:\\n\\nZipk\", \"in Q Find a trace %a ENGLISH v\\n\\nla |\\nKD RUN QUERY mv\\n\\n10 Results EXPAND ALL COLLAPSE ALL Service fil\", \"ters -\\nRoot Start Time Spans \\\\ Duration\\nv trafficcontrolservice: bindings/exitcam a few seconds ago \", \"(05/10 09:56:33:105 8 1.700s SHOW\\nv trafficcontrolservice: bindings/exitcam a few seconds ago (05/10\", \" 09:56:34:634 6 154.051ms SHOW\\nv trafficcontrolservice: bindings/exitcam a few seconds ago (05/10 09\", \":56:34:927 5 137.336ms SHOW\\nv trafficcontrolservice: bindings/exitcam afew seconds ago (05/10 09:56:\", \"34:388 6 60.850ms SHOW\\nv trafficcontrolservice: bindings/entrycam a few seconds ago (05/10 09:56:32:\", \"084 2 5.666ms SHOW\\nv trafficcontrolservice: bindings/exitcam a few seconds ago (05/10 09:56:32:327 3\", \" 3.484ms SHOW\\nv trafficcontrolservice: bindings/entrycam a few seconds ago (05/10 09:56:31:619 2 3.1\", \"42ms SHOW\\n\\nFigure 10-5. Zipkin traces overview.\\n\\nClicking the SHOW button next to a specific trace, \", \"will show the details of that trace:\\n\\n106 CHAPTER 11 | The Dapr observability building block\\n%a ENGL\", \"ISH v t Search by trace ID\\n\\nTRAFFICCONTROLSERVICE: bindings/entrycam\\n\\nDuration: 5.666ms Services: 1 \", \"Depth: 2 Total Spans: 2 Trace ID: 572745da4058a2f8406446420c402657 & DOWNLOAD JSON\\n\\nav \\u00ab\\n\\n|Oms 1.889\", \"ms |3.777ms 5.666ms\\n\\n\\u2014 TRAFFICCONTROLSERVICE\\n\\nFigure 10-6. Zipkin trace details.\\n\\nEach item on the d\", \"etails page, is a span that represents a request that is part of the selected trace.\\n\\nInspect the de\", \"pendencies between services\\n\\nBecause Dapr sidecars handle traffic between services, Zipkin can use t\", \"he trace information to\\ndetermine the dependencies between the services. To see it in action, go to \", \"the Dependencies tab on\\nthe Zipkin web page and select the button with the magnifying glass. Zipkin \", \"will show an overview of\\nthe services and their dependencies:\\n\\n107 CHAPTER 11 | The Dapr observabili\", \"ty building block\\n\\\"5\\\" Dependencies % ENGLISH v st. Search by trace ID\\n\\nStart Time End Time\\n05/09/202\", \"1 09:58:51 ff) - 05/10/2021 09:58:51 (a |\\n\\nSelect\\n\\nFigure 10-7. Zipkin dependencies.\\n\\nThe animated d\", \"ots on the lines between the services represent requests and move from source to\\ndestination. Red do\", \"ts indicate a failed request.\\n\\nUse a Jaeger or New Relic monitoring back end\\n\\nBeyond Zipkin, other m\", \"onitoring back-end software can also ingest telemetry with the Zipkin format.\\nJaeger is an open sour\", \"ce tracing system created by Uber Technologies. It's used to trace transactions\\nbetween distributed \", \"services and troubleshoot complex microservices environments. New Relic is a\\nfull-stack observabilit\", \"y platform. It links relevant data from a distributed application to provide a\\ncomplete picture of y\", \"our system. To try them out, specify an endpointAddress pointing to either a\\nJaeger or New Relic ser\", \"ver in the Dapr configuration file. Here\\u2019s an example of a configuration file that\\nconfigures Dapr t\", \"o send telemetry to a Jaeger server. The URL for Jaeger is identical to the URL for the\\nZipkin. The \", \"only difference is the number of the port on which the server runs:\\n\\n::{custom-style=CodeBox} yaml a\", \"piVersion: dapr.io/vlalpha1 kind: Configuration metadata: name:\\ndapr-config namespace: default spec:\", \" tracing: samplingRate:\\\"1\\\" = zipkin:\\nendpointAddress: \\\"http://localhost:9415/api/v2/spans\\\" :::\\n\\nTo t\", \"ry out New Relic, specify the endpoint of the New Relic API. Here\\u2019s an example of a configuration\\nfi\", \"le for New Relic:\\n\\n{custom-style=CodeBox} yaml apiVersion: dapr.io/vlalpha1 kind: Configuration meta\", \"data: name:\\ndapr-config namespace: default spec: tracing: samplingRate:\\\"1\\\" = zipkin:\\n\\nendpointAddres\", \"s: \\\"https://trace-api.newrelic.com/trace/v1?Api-Key= <NR-API-KEY > &Data-\\nFormat=zipkin&Data-Format-\", \"Version=2\\\" :::\\n\\n108 CHAPTER 11 | The Dapr observability building block\\nCheck out the Jaeger and New \", \"Relic websites for more information on how to use them.\\n\\nMetrics\\n\\nMetrics provide insight into perfo\", \"rmance and resource consumption. Under the hood, Dapr emits a\\nwide collection of system and runtime \", \"metrics. Dapr uses Prometheus as a metric standard. Dapr\\nsidecars and system services, expose a metr\", \"ics endpoint on port 9898. A Prometheus scraper calls this\\nendpoint at a predefined interval to coll\", \"ect metrics. The scraper sends metric values to a monitoring\\n\\nback end. Figure 10-8 shows the scrapi\", \"ng process:\\nsve\\n\\nd apr Sidecar injector\\n\\nservice\\n\\nOperator\\n\\nservice Monitoring\\n\\nbackend\\n\\n\\u2014lemas\\n\\nMet\", \"rics endpoint\\non port 9090 |\\n\\nPrometheus\\nmetrics\\nscraper\\n\\nPlacement\\nservice\\n\\nFigure 10-8. Scraping P\", \"rometheus metrics.\\n\\nEach sidecar and system service exposes a metric endpoint that listens on port 9\", \"090. The Prometheus\\nMetrics Scrapper captures metrics from each endpoint and published the informati\", \"on to the\\nmonitoring back end.\\n\\nService discovery\\n\\nYou might wonder how the metrics scraper knows wh\", \"ere to collect metrics. Prometheus can integrate\\nwith discovery mechanisms built into target deploym\", \"ent environments. For example, when running in\\nKubernetes, Prometheus can integrate with the Kuberne\", \"tes API to find all available Kubernetes\\nresources running in the environment.\\n\\nMetrics list\\n\\nDapr g\", \"enerates a large set of metrics for Dapr system services and Its runtime. Some examples\\ninclude:\\n\\n10\", \"9 CHAPTER 11 | The Dapr observability building block\\n[souee [Deseo\\n\\ndapr_operator_service_created_to\", \"tal System | The total number of Dapr services created\\nby the Dapr Operator service.\\n\\ndapr_injector_\", \"sidecar_injection/requests_total | System | The total number of sidecar injection\\nrequests received \", \"by the Dapr Sidecar-\\n\\nInjector service.\\n\\ndapr_placement_runtimes_total System | The total number of \", \"hosts reported to the\\nDapr Placement service.\\n\\ndapr_sentry_cert_sign_request_received_total | System\", \" | The number of certificate signing requests\\n(CRSs) received by the Dapr Sentry service.\\n\\ndapr_runt\", \"ime_component_loaded Runtime | The number of successfully loaded Dapr\\ncomponents.\\n\\ndapr_grpc_io_serv\", \"er_completed_rpcs Count of gRPC calls by method and status.\\n\\ndapr_http_server_request_count Runtime \", \"| Number of HTTP requests started in an\\nHTTP server.\\n\\ndapr_http/client/sent_bytes Runtime | Total by\", \"tes sent in request body (not\\nincluding headers) by an HTTP client.\\n\\nFor more information on availab\", \"le metrics, see the Dapr metrics documentation.\\n\\nConfigure Dapr metrics\\n\\nAt run time, you can disabl\", \"e the metrics collection endpoint by including the --enable-\\nmetrics=false argument in the Dapr comm\", \"and. Or, you can also change the default port for the\\nendpoint with the --metrics-port 9090 argument\", \".\\n\\nYou can also use a Dapr configuration file to statically enable or disable runtime metrics collec\", \"tion:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Configuration\\nmetadata:\\n\\nname: dapr-config\\n\\nnamespace: dap\", \"r-trafficcontrol\\n\\nspec:\\ntracing:\\nsamplingRate: \\\"1\\\"\\nmetric:\\nenabled: false\\n\\nVisualize Dapr metrics\\n\\nW\", \"ith the Prometheus scraper collecting and publishing metrics into the monitoring back end, how do\\nyo\", \"u make sense of the raw data? A popular visualization tool for analyzing metrics is Grafana. With\\nGr\", \"afana, you can create dashboards from the available metrics. Here\\u2019s an example of a dashboard\\ndispla\", \"ying Dapr system services metrics:\\n\\n110 CHAPTER 11 | The Dapr observability building block\\n88 Dapr S\", \"ystem Services Dashboard vv <\\n\\nv Health & Resource\\n\\nUptime Total CPU usage (kernel and user) Heap Me\", \"mory usage in bytes Number of GO routines\\ndapr-operator 15.0 MB\\n12.5 MB\\n\\ndapr-placement-server 10.0 \", \"MB\\n\\n7.5 MB\\n\\ndapr-sentry 2 \\u2014\\u2014_ 5.0 MB\\n\\n2.5 MB\\n20:19 20-20 20:21 20:22 20:23 20:19 20-20 20:21 20:22 2\", \"0:2 20:19 20-20 20:21 20:22 20:23\\ndapr-sidecar-injector\\nP , dapr-operator-699cd79686-k5gg7 dapr-plac\", \"ement-server-O dapr-operator dapr-placement-server dapr-sentry dapr-operator dapr-placement-server d\", \"apr-sentry\\n\\ndapr-sentry-7c4fbS4fb7-bhchj dapr-sidecar-injector-GbdbcS88fc-tn67w dapr-sidecar-injecto\", \"r dapr-sidecar-injector\\n\\u00bb Sidecar Injector\\n\\n# sidecar injection requests # successful sidecar inject\", \"ed\\n\\n20:18:30 20:19:00 20:19:30 20:20:00 20:20:30 20:21:00 20:21:30 20:22 20:22:30 20:23:00\\n20-18-30 \", \"20-19-00 20:19:30 20:20:00 20:20:30 20:21:00\\n\\nsidecars requests {_name__=\\\"dapr_injector_sidecar_inje\", \"ction_succeeded_total\\u201d, app=\\\"dapr-sidecar-injector\\u2019, app_kubernetes_io_component=\\\"sidecar-injector\\u2019\\n\", \"\\u00bb CA Sentry\\nRoot/Issuer Cettexpirynute Certificate Signing Requests (CSR) from Daprd CSR Failures\\n\\nC\", \"SR Requests\\nCSR Success\\n\\nNo data\\n\\n20:18:30 20:19:00 20-19-30 20:20:00 20:20:30 20:21:00 20:21:30 20:\", \"22:00 20:22:30\\n\\nFigure 10-9. Grafana dashboard.\\n\\nThe Dapr documentation includes a\\n\\nLogging provides\", \" insight into what is happening with a service at run time. When running an\\napplication, Dapr automa\", \"tically emits log entries from Dapr sidecars and Dapr system services.\\nHowever, logging entries inst\", \"rumented in your application code aren\\u2019t automatically included. To\\nemit logging from application co\", \"de, you can import a specific SDK like\\n\\nLogging application code is covered later in this chapter in\", \" the section Using the Dapr .NET SDK.\\n\\nDapr emits structured logging. Each log entry has the followi\", \"ng format:\\n\\nField Description Example\\n\\n2021-@1-10T14:19:31.000Z\\ninfo\\nmsg metrics server started on :\", \"62408/\\nDapr App ID finecollectionservice\\nver Dapr Runtime Version 1.0\\n\\nWhen searching through loggin\", \"g entries in a troubleshooting scenario, the time and level fields are\\nespecially helpful. The time \", \"field orders log entries so that you can pinpoint specific time periods.\\nWhen troubleshooting, log e\", \"ntries at the debug level provide more information on the behavior of the\\ncode.\\n\\nPlain text versus J\", \"SON format\\n\\nBy default, Dapr emits structured logging in plain-text format. Every log entry is forma\", \"tted as a string\\ncontaining key/value pairs. Here\\u2019s an example of logging in plain text:\\n\\n== DAPR ==\", \" time=\\\"2021-01-12T16:11:39.4669323+01:00\\\" level=info msg=\\\"starting Dapr Runtime -\\n- version 1.@ -- c\", \"ommit 196483d\\\" app_id=finecollectionservice instance=TSTSRV@3\\nscope=dapr.runtime type=log ver=1.0\\n\\n=\", \"= DAPR == time=\\\"2021-01-12T16:11:39.467933+01:00\\\" level=info msg=\\\"log level set to: info\\\"\\napp_id=fin\", \"ecollectionservice instance=TSTSRV@3 scope=dapr.runtime type=log ver=1.0\\n\\n== DAPR == time=\\\"2021-01-1\", \"2T16:11:39.467933+01:00\\\" level=info msg=\\\"metrics server started\\non :62408/\\\" app_id=finecollectionser\", \"vice instance=TSTSRV@3 scope=dapr.metrics type=log\\nver=1.0\\n\\nWhile simple, this format is difficult t\", \"o parse. If viewing log entries with a monitoring tool, you'll want\\nto enable JSON formatted logging\", \". With JSON entries, a monitoring tool can index and query\\nindividual fields. Here\\u2019s the same log en\", \"tries in JSON format:\\n\\n{\\\"app_id\\\": \\\"finecollectionservice\\\", \\\"instance\\\": \\\"TSTSRV@3\\\", \\\"level\\\": \\\"info\\\", \", \"\\\"msg\\\":\\n\\u201cstarting Dapr Runtime -- version 1.0 -- commit 196483d\\\", \\\"scope\\\": \\\"dapr.runtime\\\", \\\"time\\\":\\n\\\"2\", \"021-01-12T16:11:39.4669323+01:00\\\", \\\"type\\\": \\\"log\\\", \\\"ver\\\": \\\"1.0\\\"}\\n\\n{\\\"app_id\\\": \\\"finecollectionservice\\\",\", \" \\\"instance\\\": \\\"TSTSRV@3\\\", \\\"level\\\": \\\"info\\\", \\\"msg\\\": \\\"log\\nlevel set to: info\\\", \\\"scope\\\": \\\"dapr.runtime\\\", \", \"\\\"type\\\": \\\"log\\\", \\\"time\\\": \\\"2021-01-\\n12T16:11:39.467933+01:00\\\", \\\"ver\\\": \\\"1.0\\\"}\\n\\n{\\\"app_id\\\": \\\"finecollectio\", \"nservice\\\", \\\"instance\\\": \\\"TSTSRV@3\\\", \\\"level\\\": \\\"info\\\", \\\"msg\\\":\\n\\\"metrics server started on :62408/\\\", \\\"sco\", \"pe\\\": \\\"dapr.metrics\\\", \\\"type\\\": \\\"log\\\", \\\"time\\\": \\\"2021-\\nQ@1-12T16:11:39.467933+01:00\\\", \\\"ver\\\": \\\"1.0\\\"}\\n\\nTo \", \"enable JSON formatting, you need to configure each Dapr sidecar. In self-hosted mode, you can\\nspecif\", \"y the flag --log-as-json on the command line:\\n\\nIn Kubernetes, you can add a dapr.io/log-as-json anno\", \"tation to each deployment for the\\napplication:\\n\\nannotations:\\ndapr.io/enabled: \\\"true\\\"\\ndapr.io/app-id:\", \" \\\"finecollectionservice\\\"\\n\\ndapr.io/app-port: \\\"8e@\\\"\\ndapr.io/config: \\\"\\u201cdapr-config\\\"\\ndapr.io/log-as-json\", \": \\\"true\\\"\\n\\nWhen you install Dapr in a Kubernetes cluster using Helm, you can enable JSON formatted lo\", \"gging for\\nall the Dapr system services:\\n\\n112 CHAPTER 11 | The Dapr observability building block\\nhelm\", \" repo add dapr https://dapr.github.io/helm-charts/\\nhelm repo update\\n\\nkubectl create namespace dapr-s\", \"ystem\\nhelm install dapr dapr/dapr --namespace dapr-system --set global.logAsJson=true\\n\\nCollect logs\\n\", \"\\nThe logs emitted by Dapr can be fed into a monitoring back end for analysis. A log collector is a\\nc\", \"omponent that collects logs from a system and sends them to a monitoring back end. A popular log\\ncol\", \"lector is Fluentd. Check out the How-To: Set up Fluentd, Elastic search and Kibana in Kubernetes in\\n\", \"the Dapr documentation. This article contains instructions for setting up Fluentd as log collector a\", \"nd\\nthe ELK Stack (Elastic Search and Kibana) as a monitoring back end.\\n\\nHealth status\\n\\nThe health st\", \"atus of a service provides insight into its availability. Each Dapr sidecar exposes a health\\nAPI tha\", \"t can be used by the hosting environment to determine the health of the sidecar. The API has\\none ope\", \"ration:\\n\\nGET http://localhost:3500/v1.0/healthz\\n\\nThe operation returns two HTTP status codes:\\n\\n\\u00b0 204\", \": When the sidecar is healthy\\n\\u00b0 500: when the sidecar isn't healthy\\n\\nWhen running in self-hosted mod\", \"e, the health API isn't automatically invoked. You can invoke the API\\nthough from application code o\", \"r a health monitoring tool.\\n\\nWhen running in Kubernetes, the Dapr sidecar-injector automatically con\", \"figures Kubernetes to use the\\nhealth API for executing liveness probes and readiness probes.\\n\\nKubern\", \"etes uses liveness probes to determine whether a container is up and running. If a liveness\\nprobe re\", \"turns a failure code, Kubernetes will assume the container is dead and automatically restart it.\\nThi\", \"s feature increases the overall availability of your application.\\n\\nKubernetes uses readiness probes \", \"to determine whether a container is ready to start accepting traffic.\\nA pod is considered ready when\", \" all of its containers are ready. Readiness determines whether a\\nKubernetes service can direct traff\", \"ic to a pod in a load-balancing scenario. Pods that aren't ready are\\nautomatically removed from the \", \"load-balancer.\\n\\nLiveness and readiness probes have several configurable parameters. Both are configu\", \"red in the\\ncontainer spec section of a pod\\u2019s manifest file. By default, Dapr uses the following conf\", \"iguration for\\neach sidecar container:\\n\\nlivenessProbe:\\nhttpGet:\\npath: v1.0@/healthz\\nport: 3500\\ninitia\", \"lDelaySeconds: 5\\nperiodSeconds: 10\\ntimeoutSeconds : 5\\nfailureThreshold : 3\\n\\n113 CHAPTER 11 | The Dap\", \"r observability building block\\nreadinessProbe:\\n\\nhttpGet:\\npath: v1.0@/healthz\\nport: 3500\\n\\ninitialDela\", \"ySeconds: 5\\nperiodSeconds: 10\\ntimeoutSeconds : 5\\nfailureThreshold: 3\\n\\nThe following parameters are a\", \"vailable for the probes:\\n\\n. The path specifies the Dapr health API endpoint.\\n. The port specifies th\", \"e Dapr health API port.\\n\\n\\u00b0 The initialDelaySecondsspecifies the number of seconds Kubernetes will wa\", \"it before it starts\\nprobing a container for the first time.\\n\\n. The periodSeconds specifies the numbe\", \"r of seconds Kubernetes will wait between each probe.\\n\\n. The timeoutSeconds specifies the number of \", \"seconds Kubernetes will wait on a response from\\nthe API before timing out. A timeout is interpreted \", \"as a failure.\\n\\n. The failureThresholdspecifies the number of failed status code Kubernetes will acce\", \"pt before\\nconsidering the container not alive or not ready.\\n\\nDapr dashboard\\n\\nDapr offers a dashboard\", \" that presents status information on Dapr applications, components, and\\nconfigurations. Use the Dapr\", \" CLI to start the dashboard as a web-application on the local machine on\\nport 8080:\\n\\ndapr dashboard\\n\", \"\\nFor Dapr application running in Kubernetes, use the following command:\\n\\ndapr dashboard -k\\n\\nThe dash\", \"board opens with an overview of all services in your application that have a Dapr sidecar. The\\nfollo\", \"wing screenshot shows the Dapr dashboard for the Traffic Control sample application running in\\nKuber\", \"netes:\\n\\nimage type=\\u201c\\\"content\\u201d source=\\\"./media/observability/dapr-dashboard-overview.png\\\" alt-text=\\\"\\u201c\", \"Dapr\\ndashboard overview\\\":\\n\\nFigure 10-10. Dapr dashboard overview.\\n\\nThe Dapr dashboard is invaluable \", \"when troubleshooting a Dapr application. It provides information\\nabout Dapr sidecars and system serv\", \"ices. You can drill down into the configuration of each service,\\nincluding the logging entries.\\n\\nThe\", \" dashboard also shows the configured components (and their configuration) for an application:\\n\\nimage\", \" type=\\\"content\\u201d source=\\\"./media/observability/dapr-dashboard-components.png\\u201d alt-\\ntext=\\\"Dapr dashboa\", \"rd components\\u201d:\\n\\nFigure 10-11. Dapr dashboard components.\\n\\n114 CHAPTER 11 | The Dapr observability b\", \"uilding block\\nThere's a large amount of information available through the dashboard. You can discove\", \"r it by\\nrunning a Dapr application and browsing the dashboard.\\n\\nCheck out the Dapr dashboard CLI com\", \"mand reference in the Dapr docs for more information on the\\nDapr dashboard commands.\\n\\nUse the Dapr .\", \"NET SDK\\n\\nThe Dapr .NET SDK doesn't contain any specific observability features. All observability fe\", \"atures are\\noffered at the Dapr level.\\n\\nIf you want to emit telemetry from your .NET application code\", \", you should consider the\\nOpenTelemetry SDK for .NET. The Open Telemetry project is cross-platform, \", \"open source, and vendor\\nagnostic. It provides an end-to-end implementation to generate, emit, collec\", \"t, process, and export\\ntelemetry data. There's a single instrumentation library per language that su\", \"pports automatic and\\nmanual instrumentation. Telemetry is published using the Open Telemetry standar\", \"d. The project has\\nbroad industry support and adoption from cloud providers, vendors, and end users.\", \"\\n\\nSample application: Dapr Traffic Control\\n\\nBecause the Traffic Control sample application runs with\", \" Dapr, all the telemetry described in this\\nchapter is available. If you run the application and open\", \" the Zipkin web front end, you'll see end-to-\\nend tracing. Figure 10-12 shows an example:\\n\\n%a ENGLIS\", \"H v\\n\\nTRAFFICCONTROLSERVICE: bindings/exitcam\\n\\nDuration: 1.785s Services: 3 Depth: 3 Total Spans: 8 T\", \"race ID: bO5e9fbd829ac2cd425295dc4c2fdf6a & DOWNLOAD JSON\\nav \\u00ab\\nOms 595.143ms |1.190s 1.785s|\\n| bindi\", \"ngs/exitcam [3.773ms]\\n/dapr.proto.runtime.v1.dapr/getstate [1.085ms]\\n| /dapr.proto.runtime.v1.dapr/s\", \"avestate [514s]\\n\\n\\u2014 | /dapr.proto.runtime.v1.dapr/publishevent\\n\\n_pubsub/speedingwolations (1.782)\\n=| \", \"(ealll6cal/vehicleregistrationservice/vehicleinfo/pl-454-f [102.281ms]\\n[ealllocal/vehicleregistratio\", \"nservice/vehicleinfo/pl-454-f [101.711ms]\\n\\nFINECOLLECTIONSERVICE\\n\\nFigure 10-12. Zipkin end-to-end tr\", \"acing example.\\n\\nThis trace shows the communication that occurs when a speeding violation has been de\", \"tected:\\n\\n115 CHAPTER 11 | The Dapr observability building block\\n1. An exiting vehicle triggers the M\", \"QTT input binding that sends a message containing the vehicle\\nlicense number, lane, and timestamp.\\n\\n\", \"2. The MQTT input binding invokes the TrafficControl service with the message.\\n\\n3. The TrafficContro\", \"l service retrieves the state for the vehicle, appends the entry, and saves the\\nupdated vehicle stat\", \"e back to the state store.\\n\\n4. \\u2014 The TrafficControl service publishes the speeding violation using p\", \"ub/sub to the\\nspeedingviolations topic.\\n\\n5. The FineCollection service receives the speeding violati\", \"on using a pub/sub subscription on the\\nspeedingviolations topic.\\n\\n6. The FineCollection service invo\", \"kes the vehicleinfo endpoint of the VehicleRegistration service\\nusing service invocation.\\n\\n7. The Fi\", \"neCollection service invokes an output binding for sending the email.\\n\\nClick any trace line (span) t\", \"o see more details. If you click on the last line, you'll see the sendmail\\nbinding component invoked\", \" to send the driver a violation notice.\\n\\n116 CHAPTER 11 | The Dapr observability building block\\nFINE\", \"COLLECTIONSERVICE\\n\\n/dapr.proto.runtime.v1.dapr/invokebinding\\nSpan ID: 496eb00901499dd88 Parent ID: e\", \"3785a963afbec45\\n\\nAnnotations\\n\\neC\\u201c eG\\nSHOW ALL ANNOTATIONS\\n\\nTags\\n\\ndapr.api\\n/dapr.proto.runtime.v1.Dap\", \"r/InvokeBinding\\n\\ndapr.protocol\\n\\ngrpe\\n\\ndb.connection_string\\n\\nbindings\\nsendmail\\ndb.statement\\n\\n/dapr.pr\", \"oto.runtime.v1.Dapr/InvokeBinding\\n\\ndb.system\\nbindings\\n\\nrpc.service\\nDapr\\n\\nFigure 10-13. Output bindin\", \"g trace details.\\n\\nSummary\\n\\nDetailed observability is critical to running a distributed system in pro\", \"duction.\\n\\nDapr provides different types of telemetry, including distributed tracing, logging, metric\", \"s, and health\\nStatus.\\n\\nDapr only produces telemetry for the Dapr system services and sidecars. Telem\", \"etry from your\\napplication code isn't automatically included. You can however use a specific SDK lik\", \"e the\\nOpenTelemetry SDK for .NET to emit telemetry from your application code.\\n\\n117 CHAPTER 11 | The\", \" Dapr observability building block\\nDapr telemetry is produced in an open-standards based format so t\", \"hat it can be ingested by a large\\nset of available monitoring tools. Examples include Zipkin, Azure \", \"Application Insights, the ELK Stack,\\nNew Relic, and Grafana. See Monitor your application with Dapr \", \"in the Dapr documentation for\\ntutorials on how to monitor your Dapr applications with specific monit\", \"oring back ends.\\n\\nYou'll need a telemetry scraper that ingests telemetry and publishes it to the mon\", \"itoring back end.\\n\\nDapr can be configured to emit structured logging. Structured logging is favored \", \"as it can be indexed\\nby back-end monitoring tools. Indexed logging enables users to execute rich que\", \"ries when searching\\nthrough the logging.\\n\\nDapr offers a dashboard that presents information about th\", \"e Dapr services and configuration.\\n\\nReferences\\n\\n\\u00b0 Azure Application Insights\\n\\u00b0 Open Telemetry\\n\\n\\u00b0 W3C\", \" Trace Context\\n- Jaeger\\n\\n. New Relic\\n\\n: Prometheus\\n\\n\\u00b0 Grafana\\n\\n\\u00b0 Open Telemetry SDK for .NET\\n\\n: Flue\", \"ntd\\n\\n: ELK stack\\n- Seq\\n\\n- \\u2014\\u2014 Serilog\\n\\n118 CHAPTER 11 | The Dapr observability building block\\nCHAPTER\", \"\\n\\nTne Dapr secrets\\nmanagement building\\n\\nlleva\\n\\nEnterprise applications require secrets. Common examp\", \"les include:\\n\\n. A database connection string that contains a username and password.\\n\\u00b0 An API key for\", \" calling an external web API.\\n\\n. A client certificate for authenticating to an external system.\\n\\nSec\", \"rets must be carefully managed so that they're never disclosed outside of the application.\\n\\nNot long\", \" ago, it was popular to store application secrets in a configuration file inside the application\\ncod\", \"ebase. .NET developers will fondly recall the web.config file. While simple to implement, integratin\", \"g\\nsecrets to along with code was far from secure. A common misstep was to include the file when\\npush\", \"ing to a public GIT repository, exposing the secrets to the world.\\n\\nA widely accepted methodology fo\", \"r constructing modern distributed applications is The Twelve-\\nFactor App. It describes a set of prin\", \"ciples and best practices. Its third factor prescribes that\\nconfiguration and secrets be externalize\", \"d outside of the code base.\\n\\nTo address this concern, the .NET platform includes a Secret Manager fe\", \"ature that stores sensitive\\ndata in a physical folder outside of the project tree. While secrets are\", \" outside of source control, this\\nfeature doesn\\u2019t encrypt data. It's designed for development purpose\", \"s only.\\n\\nA more modern and secure practice is to isolate secrets in a secrets management tool like H\", \"ashicorp\\nVault or Azure Key Vault. These tools enable you to store secrets externally, vary credenti\", \"als across\\nenvironments, and reference them from application code. However, each tool has its comple\", \"xities and\\nlearning curve.\\n\\nDapr offers a building block that simplifies managing secrets.\\n\\nWhat it \", \"solves\\n\\nThe Dapr secrets management building block abstracts away the complexity of working with sec\", \"rets\\nand secret management tools.\\n\\n119 CHAPTER 12 | The Dapr secrets management building block\\n. It \", \"hides the underlying plumbing through a unified interface.\\n\\n. It supports various pluggable secret s\", \"tore components, which can vary between development\\nand production.\\n\\n\\u00b0 Applications don't require di\", \"rect dependencies on secret store libraries.\\n\\n. Developers don\\u2019t require detailed knowledge of each \", \"secret store.\\nDapr handles all of the above concerns.\\nAccess to the secrets is secured through authe\", \"ntication and authorization. Only an application with\\n\\nsufficient rights can access secrets. Applica\", \"tions running in Kubernetes can also use its built-in secrets\\nmanagement mechanism.\\n\\nHow it works\\n\\nA\", \"pplications use the secrets management building block in two ways:\\n\\n. Retrieve a secret directly fro\", \"m the building block.\\n. Reference a secret indirectly from a Dapr component configuration.\\n\\nRetrievi\", \"ng secrets directly is covered first. Referencing a secret from a Dapr component configuration\\nfile \", \"is addressed in a later section.\\n\\nThe application interacts with a Dapr sidecar when using the secre\", \"ts management building block. The\\nsidecar exposes the secrets API. The API can be called with either\", \" HTTP or gRPC. Use the following\\nURL to call the HTTP API:\\n\\nhttp: //localhost:<dapr-port>/v1.0/secre\", \"ts/<store-name>/<name>?<metadata>\\n\\nThe URL contains the following segments:\\n\\n. <dapr-port> specifies\", \" the port number upon which the Dapr sidecar is listening.\\n. <store-name> specifies the name of the \", \"Dapr secret store.\\n. <name> specifies the name of the secret to retrieve.\\n\\n. <metadata> provides add\", \"itional information for the secret. This segment is optional and\\nmetadata properties differ per secr\", \"et store. For more information on metadata properties, see\\n\\nthe [secrets API reference]INTERNAL-LINK\", \":(Secrets API reference | Dapr Docs).\\n\\n[INOTE] The above URL represents the native Dapr API call ava\", \"ilable to any development platform that\\nsupports HTTP or gRPC. Popular platforms like .NET, Java, an\", \"d Go have their own custom APIs.\\n\\nThe JSON response contains the key and value of the secret.\\n\\nFigur\", \"e 11-1 shows how Dapr handles a request for the secrets API:\\n\\n120 CHAPTER 12 | The Dapr secrets mana\", \"gement building block\\nGET http://localhost:3500/v1.0/secrets/secrets-store/redis-password\\n\\nService A\", \"\\n\\n>|\\n| dapr sidecar\\n\\n=\\n\\n2 2\\n\\nSecrets\\n\\n\\u2014\\n\\n{\\n\\u201credis-password': \\\"k6Gt#ja21$ft\\\"\\n\\nJ store\\n\\nFigure 11-1. R\", \"etrieving a secret with the Dapr secrets API.\\n\\n1. The service calls the Dapr secrets API, along with\", \" the name of the secret store, and secret to\\nretrieve.\\n2. The Dapr sidecar retrieves the specified s\", \"ecret from the secret store.\\n\\n3. | The Dapr sidecar returns the secret information back to the servi\", \"ce.\\n\\nSome secret stores support storing multiple key/value pairs in a single secret. For those scena\", \"rios, the\\nresponse would contain multiple key/value pairs in a single JSON response as in the follow\", \"ing\\nexample:\\n\\nGET http://localhost:3500/v1.0/secrets/secret-store/interestRates?metadata.version_id=\", \"3\\n\\n{\\n\\u201ctierl-percentage\\\": \\\"\\n\\u201ctier2-percentage\\\": \\\"\\n\\u201ctier3-percentage\\\": \\\"\\n\\n}\\n\\nThe Dapr secrets API also\", \" offers an operation to retrieve all the secrets the application has access to:\\n\\nhttp://localhost:<d\", \"apr-port>/v1.@/secrets/<store-name>/bulk\\n\\nUse the Dapr .NET SDK\\n\\nFor .NET developers, the Dapr .NET \", \"SDK streamlines Dapr secret management. Consider the\\nDaprClient.GetSecretAsync method. It enables yo\", \"u to retrieve a secret directly from any Dapr secret\\nstore with minimal effort. Here\\u2019s an example of\", \" fetching a connection string secret for a SQL Server\\ndatabase:\\n\\n121 CHAPTER 12 | The Dapr secrets m\", \"anagement building block\\nvar metadata = new Dictionary<string, string> { [\\\"version_id\\\"] = \\\"3\\\" };\\nDic\", \"tionary<string, string> secrets = await daprClient.GetSecretAsync(\\\"secret-store\\\",\\n\\n\\u201ceshopsecrets\\\", m\", \"etadata) ;\\nstring connectionString = secrets[\\\"customerdb\\\" |;\\n\\nArguments for the GetSecretAsync metho\", \"d include:\\n\\n\\u00b0 The name of the Dapr secret store component (\\u2018secret-store\\u2019)\\n\\u00b0 The secret to retrieve \", \"(\\u2018eshopsecrets\\u2019)\\n\\n. Optional metadata key/value pairs (\\u2018version_id=3\\u2019)\\n\\nThe method responds with a d\", \"ictionary object as a secret can contain multiple key/value pairs. In the\\nexample above, the secret \", \"named customerdb Is referenced from the collection to return a connection\\nstring.\\n\\nThe Dapr .NET SDK\", \" also features a .NET configuration provider. It loads specified secrets into the\\nunderlying .NET co\", \"nfiguration API. The running application can then reference secrets from the\\nIConfiguration dictiona\", \"ry that is registered in ASP.NET Core dependency injection.\\n\\nThe secrets configuration provider is a\", \"vailable from the Dapr.Extensions.Configuration NuGet\\npackage. The provider can be registered in the\", \" Program.cs of an ASP.NET Web API application:\\n\\nvar builder = WebApplication.CreateBuilder (args) ;\\n\", \"builder .WebHost.ConfigureAppConfiguration(config =>\\n\\nt\\n\\nvar daprClient = new DaprClientBuilder().Bu\", \"ild();\\nvar secretDescriptors = new List<DaprSecretDescriptor>\\n\\n{\\n}3\\n\\nconfig.AddDaprSecretStore(\\\"secr\", \"et-store\\\", secretDescriptors, daprClient) ;\\n\\nnew DaprSecretDescriptor(\\\"eshopsecrets\\\" )\\n\\nThe above ex\", \"ample loads the eshopsecrets secrets collection into the .NET configuration system at\\nstartup. Regis\", \"tering the provider requires an instance of DaprClient to invoke the secrets API on the\\nDapr sidecar\", \". The other arguments include the name of the secret store and a DaprSecretDescriptor\\nobject with th\", \"e name of the secret.\\n\\nOnce loaded, you can retrieve secrets directly from application code:\\n\\npublic\", \" void GetCustomer(IConfiguration config)\\n\\nt\\n}\\n\\nvar connectionString = config[ \\\"eshopsecrets\\\" |[\\\"cust\", \"omerdb\\\" ];\\n\\nSecret store components\\n\\nThe secrets management building block supports several secret s\", \"tore components. At the time of\\nwriting, the following secret stores are available:\\n\\n\\u00b0 AlibabaCloud \", \"OOS Parameter Store\\n\\u00b0 AWS Secrets Manager\\n\\u00b0 AWS SSM Parameter Store\\n\\n122 CHAPTER 12 | The Dapr secre\", \"ts management building block\\n. Azure Key Vault\\n\\u00b0 GCP Secret Manager\\n. HashiCorp Vault\\n\\n\\u00b0 Kubernetes \", \"secrets\\n\\u00b0 Local environment variables\\n\\u00b0 Local file\\n\\nImportant\\n\\nThe local environment variables and f\", \"ile components are designed for development workloads only.\\n\\nThe following sections show how to conf\", \"igure a secret store.\\n\\nConfiguration\\n\\nYou configure a secret store using a Dapr component configurat\", \"ion file. The typical structure of the\\nfile is shown below:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Comp\", \"onent\\nmetadata:\\nname: [component name]\\nnamespace: [namespace]\\nspec:\\ntype: secretstores.[secret store\", \" type]\\nversion: [secret store version]\\nmetadata:\\n- name: [property name]\\nvalue: [property value]\\n\\nAl\", \"l Dapr component configuration files require a name along with an optional namespace value.\\nAddition\", \"ally, the type field in the spec section specifies the type of secret store component. The\\npropertie\", \"s in the metadata section differ per secret store.\\n\\nIndirectly consume Dapr secrets\\n\\nAs mentioned ea\", \"rlier in this chapter, applications can also consume secrets by referencing them in\\ncomponent config\", \"uration files. Consider a state management component that uses Redis cache for\\nstoring state:\\n\\napiVe\", \"rsion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: eshop-basket-statestore\\nnamespace: eshop\\nspe\", \"c:\\n\\ntype: state.redis\\n\\nversion: v1\\n\\nmetadata:\\n\\n- name: redisHost\\nvalue: localhost:6379\\nname: redisPa\", \"ssword\\nvalue: e$h@p@nD@pr\\n\\n123 CHAPTER 12 | The Dapr secrets management building block\\nThe above con\", \"figuration file contains a clear-text password for connecting to the Redis server.\\nHardcoded passwor\", \"ds are always a bad idea. Pushing this configuration file to a public repository\\nwould expose the pa\", \"ssword. Storing the password in a secret store would dramatically improve this\\nscenario.\\n\\nThe follow\", \"ing examples demonstrate this using several different secret stores.\\n\\nLocal file\\n\\nThe local file com\", \"ponent is designed for development scenarios. It stores secrets on the local\\nfilesystem inside a JSO\", \"N file. Here\\u2019s an example named eshop-secrets. json. It contains a single\\nsecret - a password for Re\", \"dis:\\n\\n\\\"eShopRedisPassword\\\": \\\"\\u201ce$h@p@nD@pr\\\"\\n}\\n\\nYou place this file in a components folder that you sp\", \"ecify when running the Dapr application.\\n\\nThe following secret store configuration file consumes the\", \" JSON file as a secret store. It's also placed\\nin the components folder:\\n\\napiVersion: dapr.io/vialph\", \"a1\\nkind: Component\\nmetadata:\\nname: eshop-local-secret-store\\nnamespace: eshop\\nspec:\\ntype: secretstore\", \"s.local.file\\nversion: v1\\nmetadata:\\n- name: secretsFile\\nvalue: ./components/eshop-secrets. json\\n- nam\", \"e: nestedSeparator\\nvalue: \\\":\\\"\\n\\nThe component type Is secretstore.local.file. The secretsFile metadat\", \"a element specifies the\\npath to the secrets file.\\n\\nImportant\\n\\nThe path to a secrets file can be a ab\", \"solute or relative path. The relative path is based on the folder in\\nwhich the application starts. I\", \"n the example, the components folder is a sub-folder of the directory that\\ncontains the .NET applica\", \"tion.\\n\\nFrom the application folder, start the Dapr application specifying the components path as a c\", \"ommand-\\nline argument:\\n\\ndapr run --app-id basket-api --components-path ./components dotnet run\\n\\n124 \", \"CHAPTER 12 | The Dapr secrets management building block\\nNote\\n\\nThis above example applies to running \", \"Dapr in self-hosted mode. For Kubernetes hosting, consider\\nusing volume mounts.\\n\\nThe nestedSeparator\", \" in a Dapr configuration file specifies a character to flatten a JSON hierarchy.\\nConsider the follow\", \"ing snippet:\\n\\n\\u201credisPassword\\\": \\\"some password\\\",\\n\\u201cconnectionStrings\\\": {\\n\\u201ccustomerdb\\\": \\\"some connectio\", \"n string\\\",\\n\\u201cproductdb\\\": \\\"some connection string\\\"\\n\\nUsing a colon as a separator, you can retrieve the\", \" customerdb connection-string using the key\\nconnectionStrings :customerdb.\\n\\nNote\\n\\nThe colon : is the\", \" default separator value.\\n\\nIn the next example, a state management configuration file references the\", \" local secret store\\ncomponent to obtain the password for connecting to the Redis server:\\n\\napiVersion\", \": dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: eshop-basket-statestore\\nnamespace: eshop\\nspec:\\nty\", \"pe: state.redis\\nversion: v1\\nmetadata:\\n- name: redisHost\\nvalue: localhost:6379\\nname: redisPassword\\nse\", \"cretKeyRef:\\nname: eShopRedisPassword\\nkey: eShopRedisPassword\\n\\nauth:\\nsecretStore: eshop-local-secret-\", \"store\\n\\nThe secretKeyRef element references the secret containing the password. It replaces the earli\", \"er clear-\\ntext value. The secret name and the key name, eShopRedisPassword, reference the secret. Th\", \"e name\\nof the secret management component eshop-local-secret-store is found in the auth metadata\\nele\", \"ment.\\n\\nYou might wonder why eShopRedisPassword is identical for both the name and key in the secret\\n\", \"reference. In the local file secret store, secrets aren't identified with a separate name. The scena\", \"rio will\\nbe different in the next example using Kubernetes secrets.\\n\\n125 CHAPTER 12 | The Dapr secre\", \"ts management building block\\nKubernetes secret\\n\\nThis second example focuses on a Dapr application ru\", \"nning in Kubernetes. It uses the standard secrets\\nmechanism that Kubernetes offers. Use the Kubernet\", \"es CLI (kubect1) to create a secret named eshop-\\nredis-secret that contains the password:\\n\\nOnce crea\", \"ted, you can reference the secret in the component configuration file for state management:\\n\\napiVers\", \"ion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: eshop-basket-statestore\\nnamespace: eshop\\nspec:\", \"\\ntype: state.redis\\nversion: v1\\nmetadata:\\n- name: redisHost\\nvalue: redis:6379\\nname: redisPassword\\nsec\", \"retKeyRef:\\nname: eshopsecrets\\nkey: redisPassword\\nauth:\\nsecretStore: kubernetes\\n\\nThe secretKeyRef ele\", \"ment specifies the name of the Kubernetes secret and the secret's key,\\neshopsecrets, and redisPasswo\", \"rd respectively. The auth metadata section instructs Dapr to use the\\nKubernetes secrets management c\", \"omponent.\\n\\nNote\\n\\nAuth is the default value when using Kubernetes secrets and can be omitted.\\n\\nIn a p\", \"roduction setting, secrets are typically created as part of an automated CI/CD pipeline. Doing so\\nen\", \"sures only people with sufficient permissions can access and change the secrets. Developers create\\nc\", \"onfiguration files without knowing the actual value of the secrets.\\n\\nAzure Key Vault\\n\\nThe next examp\", \"le is geared toward a real-world production scenario. It uses Azure Key Vault as the\\nsecret store. A\", \"zure Key Vault is a managed Azure service that enables secrets to be stored securely in\\nthe cloud.\\n\\n\", \"For this example to work, the following prerequisites must be satisfied:\\n\\n. You've secured administr\", \"ative access to an Azure subscription.\\n\\n\\u00b0 You've provisioned an Azure Key Vault named eshopkv that h\", \"olds a secret named\\nredisPassword that contains the password for connecting to the Redis server.\\n\\n. \", \"You've created service principal in Azure Active Directory.\\n\\n126 CHAPTER 12 | The Dapr secrets manag\", \"ement building block\\n. You've installed an X509 certificate for this service principal (containing b\", \"oth the public and\\nprivate key) on the local filesystem.\\n\\nNote\\n\\nA service principal is an identity t\", \"hat can be used by an application to authenticate an Azure service.\\n\\nThe service principal uses a X5\", \"09 certificate. The application uses this certificate as a credential to\\nauthenticate itself.\\n\\nThe D\", \"apr Azure Key Vault secret store documentation provides step-by-step instructions to create\\nand conf\", \"igure a Key Vault environment.\\n\\nUse Key Vault when running in self-hosted mode\\n\\nUsing Azure Key Vaul\", \"t in Dapr self-hosted mode requires the following component configuration file:\\n\\napiVersion: dapr.io\", \"/vialpha1\\nkind: Component\\nmetadata:\\nname: eshop-azurekv-secret-store\\nnamespace: eshop\\nspec:\\ntype: se\", \"cretstores.azure.keyvault\\nversion: v1\\nmetadata:\\nname: vaultName\\nvalue: eshopkv\\nname: spnTenantId\\nval\", \"ue: \\\"619926af-a7c3-4e95 -93ed-4ecc4e3e652b\\\"\\nname: spnClientId\\nvalue: \\\"6cf48032-6c38-43be-9d6f-2a43ce\", \"736be9\\\"\\nname: spnCertificateFile\\nvalue : \\\"\\u201cazurekv-spn-cert. pfx\\\"\\n\\nThe secret store type is secretst\", \"ores.azure.keyvault. The metadata element provides access to the\\nKey Vault with the following proper\", \"ties:\\n\\n. The vaultName contains the name of the Azure Key Vault.\\n\\n. The spnTenantId contains the ten\", \"ant /D of the service principal used to authenticate against the\\nKey Vault.\\n\\n. The spnClientId conta\", \"ins the app ID of the service principal used to authenticate against the\\nKey Vault.\\n\\n. The spnCertif\", \"icateFile contains the path to the certificate file for the service principal to\\nauthenticate agains\", \"t the Key Vault.\\n\\nTip\\n\\nYou can copy the service principal information from the Azure portal or Azure\", \" CLI .\\n\\nNow the application can retrieve the Redis password from the Azure Key Vault.\\n\\n127 CHAPTER 1\", \"2 | The Dapr secrets management building block\\nUse Key Vault when running on Kubernetes\\n\\nConsuming A\", \"zure Key Vault with Dapr and Kubernetes also requires a service principal to authenticate\\nagainst th\", \"e Azure Key Vault.\\n\\nFirst, create a Kubernetes secret that contains a certificate file using the kub\", \"ectl CLI tool:\\n\\nThe command requires two command-line arguments:\\n\\n. [k8s_spn_secret_name] Is the sec\", \"ret name in Kubernetes secret store.\\n\\n. [pfx_certificate file _local_path] is the path of X509 certi\", \"ficate file.\\n\\nOnce created, you can reference the Kubernetes secret in the secret store component co\", \"nfiguration\\nfile:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: eshop-azurekv-secret\", \"-store\\nnamespace: eshop\\nspec:\\ntype: secretstores.azure.keyvault\\nversion: v1\\nmetadata:\\nname: vaultNam\", \"e\\nvalue: [your_keyvault_name]\\nname: spnTenantId\\nvalue: \\\"619926af-a7c3-4e95-93ed-4ecc4e3e652b\\\"\\nname: \", \"spnClientId\\nvalue: \\\"6cf48032-6c38-43be-9d6Ff -2a43ce736be9\\\"\\nname: spnCertificate\\nsecretKeyRef:\\nname:\", \" [k8s_spn_secret_name]\\nkey: [pfx_certificate file local name]\\nauth:\\nsecretStore: kubernetes\\n\\nAt this\", \" point, an application running in Kubernetes can retrieve the Redis password from the Azure\\nKey Vaul\", \"t.\\n\\nImportant\\n\\nIt's critical to keep the X509 certificate file for the service principal in a safe p\", \"lace. It\\u2019s best to place it in\\na well-known folder outside the source-code repository. The configura\", \"tion file can then reference the\\ncertificate file from this well-known folder. On a local developmen\", \"t machine, you're responsible for\\ncopying the certificate to the folder. For automated deployments, \", \"the pipeline will copy the certificate\\nto the machine where the application is deployed. It's a best\", \" practice to use a different service\\nprincipal per environment. Doing so prevents the service princi\", \"pal from a DEVELOPMENT environment\\nto access secrets ina PRODUCTION environment.\\n\\n128 CHAPTER 12 | T\", \"he Dapr secrets management building block\\nWhen running in Azure Kubernetes Service (AKS), it's prefe\", \"rable to use an Azure Managed Identity for\\nauthenticating against Azure Key Vault. Managed identitie\", \"s are outside of the scope of this book, but\\n\\nexplained in the Azure Key Vault with managed identiti\", \"es documentation.\\n\\nScope secrets\\n\\nSecret scopes allow you to control which secrets your application \", \"can access. You configure scopes in\\na Dapr sidecar configuration file. The Dapr configuration docume\", \"ntation provides instructions for\\nscoping secrets.\\n\\nHere's an example of a Dapr sidecar configuratio\", \"n file that contains secret scopes:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Configuration\\nmetadata:\\nname\", \": dapr-config\\nnamespace: eshop\\nspec:\\n\\ntracing:\\nsamplingRate: \\\"1\\\"\\nsecrets:\\nscopes:\\n- storeName: eshop\", \"-azurekv-secret-store\\ndefaultAccess: allow\\ndeniedSecrets: [\\\"redisPassword\\\", \\\"apikey\\\"]\\n\\nYou specify s\", \"copes per secret store. In the above example, the secret store is named eshop-azurekv-\\nsecret-store.\", \" You configure access to secrets using the following properties:\\n\\ndefaultAccess | allowor Allows or \", \"denies access to all secrets in the specified secret store.\\ndeny This property Is optional with a de\", \"fault value of allow.\\n\\nallowedSecrets | List of Secrets specified in the array will be accessible. T\", \"his property is\\nsecret keys | optional.\\n\\ndeniedSecrets | List of Secrets specified in the array will\", \" NOT be accessible. This property is\\nsecret keys | optional.\\n\\nThe allowedSecrets and deniedSecrets p\", \"roperties take precedence over the defaultAccess\\nproperty. Imagine specifying defaultAccess: allowed\", \" and an allowedSecrets list. In this case, only\\nthe secrets in the allowedSecrets list would be acce\", \"ssible by the application.\\n\\nSample application: Dapr Traffic Control\\n\\nIn Dapr Traffic Control sample\", \" app, the secrets management building block is used in several places.\\nSecrets are retrieved from co\", \"de and referenced by Dapr component configuration files. Figure 10-2\\nshows the conceptual architectu\", \"re of the Dapr Traffic Control sample application. The Dapr secrets\\nmanagement building block is use\", \"d in flows marked with number 6 in the diagram:\\n\\n129 CHAPTER 12 | The Dapr secrets management buildi\", \"ng block\\n4\\n\\nCamera\\n\\nTrafficControl\\nSimulation\\n\\nService\\n\\ni\\n\\n. \\\" moseuitto\\nExitCam\\n\\nFineCollection\\nSer\", \"vice\\n\\u2018 a nee\\n\\nsR ananassae naman manannncecnanahaacocane\\n\\nVehicleRegistration\\n\\nGetVehiclelnfo\\nServic\", \"e \\u00b0\\n\\nSidecar | |\\n\\n(4) Service invocation [3] State management [5] Input binding Actors\\n[2] Publish /\", \" subscribe [4] Output binding 6 | Secrets management\\n\\nFigure 10-2. Conceptual architecture of the Da\", \"pr Traffic Control sample application.\\n\\nThe FineCollection service uses an SMTP output binding for s\", \"ending emails (see the Bindings chapter).\\nThe email component file consumes the secrets management b\", \"uilding block to retrieve credentials to\\nconnect to the SMTP server. To calculate the fine for a spe\", \"eding violation, the service uses a fictitious\\nFineCalculator component that requires a license key.\", \" It retrieves this license key from the secrets\\nmanagement building block.\\n\\nThe TrafficControl servi\", \"ce stores vehicle information in a Redis state store (see the State management\\nchapter). It uses the\", \" secrets management building block for retrieving credentials to connect to the\\nRedis server.\\n\\nBecau\", \"se the Traffic Control sample application can run in self-hosted mode or in Kubernetes, there are\\ntw\", \"o ways for specifying secrets:\\n\\n\\u00b0 A local JSON file\\n\\n\\u00b0 A Kubernetes secret\\n\\n130 CHAPTER 12 | The Dap\", \"r secrets management building block\\nSecrets\\n\\nExamine the secrets-file.yaml component configuration f\", \"ile in the dapr/components folder:\\n\\napiVersion: dapr.io/vialpha1l\\nkind: Component\\nmetadata:\\nname: tr\", \"afficcontrol-secrets\\nnamespace: dapr-trafficcontrol\\nspec:\\ntype: secretstores.local.file\\nversion: v1\\n\", \"\\nmetadata:\\n- name: secretsFile\\nvalue: ../dapr/components/secrets.json\\n- name: nestedSeparator\\nvalue:\", \" \\\".\\\"\\nscopes:\\n\\n- trafficcontrolservice\\n- finecollectionservice\\n\\nThe file describes a secrets manageme\", \"nt component entitled trafficcontrol-secrets. The type\\nelement is set to local. file and the secrets\", \"File to ../dapr/components/secrets. json. For self-\\nhosted mode, use a Local file component. The pat\", \"h must be relatively specified from the folder from\\nwhich the service starts. The secrets file conta\", \"ins a JSON representation of the secrets:\\n\\n\\\"state\\\": {\\n\\\"redisPassword\\\":\\n\\n_username\\\",\\n\\\"password\\\": \\\" pa\", \"ssword\\\"\\nhs\\n\\\"finecalculator\\\": {\\n\\u201clicensekey\\\": \\\"HX783-K2L7V-CRIJ4A-5PN1G\\\"\\n\\n}\\n\\nIn the sample applicatio\", \"n the Redis server is used without a password. To connect to the SMTP server,\\nthe credentials are _u\", \"sername and _password. The license key for the FineCalculator license key is a\\nrandomly generated st\", \"ring.\\n\\nWhile secrets are stored at nested levels, the secrets management building block flattens thi\", \"s\\nhierarchy when the file is read. It uses a period as a level separator (as specified in the\\nnested\", \"Separator field in the component configuration file). This construct enables you to reference\\nsecret\", \"s with a flattened name, for example: smtp.user.\\n\\nWhen running in Kubernetes, the secrets are specif\", \"ied using the built-in Kubernetes secrets store.\\nExamine the following secrets. yaml Kubernetes mani\", \"fest file in the k8s folder:\\n\\napiVersion: v1\\n\\nkind: Secret\\n\\nmetadata:\\nname: trafficcontrol-secrets\\nn\", \"amespace: dapr-trafficcontrol\\n\\n131 CHAPTER 12 | The Dapr secrets management building block\\ntype: Opa\", \"que\\ndata:\\nsmtp.user: X3VzZXJuYWil\\nsmtp.password: X3Bhc3N3b3J)k\\nfinecalculator.licensekey: SFg30DMtSz\", \"JIMN1YtQ1JKNEEtNVBOMUc=\\n\\nThe component is also named trafficcontrol-secrets. Secrets are stored as B\", \"ase64 encoded\\nstrings.\\n\\nImportant\\n\\nBase64 representations encode, but do not encrypt data. Base64 is\", \"n\\u2019t secure for production scenarios.\\n\\nThe following paragraphs describe how secrets are used in the \", \"Traffic Control sample application.\\n\\nSMTP server credentials\\nExamine the email. yaml component confi\", \"guration file located in the dapr/components folder:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nm\", \"etadata:\\nname: sendmail\\nnamespace: dapr-trafficcontrol\\nspec:\\ntype: bindings.smtp\\nversion: v1\\nmetadat\", \"a:\\nname: host\\nvalue: localhost\\nname: port\\nvalue: 4025\\nname: user\\nsecretKeyRef:\\nname: smtp.user\\nkey: \", \"smtp.user\\nname: password\\nsecretKeyRef:\\nname: smtp.password\\nkey: smtp.password\\nname: skipTLSVerify\\nva\", \"lue: true\\nauth:\\nsecretStore: trafficcontrol-secrets\\nscopes:\\n- finecollectionservice\\n\\nThe auth sectio\", \"n references the secrets management component named trafficcontrol-secrets.\\nThe user and password en\", \"tries in the binding metadata reference the secrets: smtp.user and\\nsmtp .password respectively.\\n\\nWhe\", \"n running in Kubernetes, the built-in Kubernetes secrets store is used. The email. yaml manifest\\nfil\", \"e found in the k8s folder references the Kubernetes secret for retrieving the credentials for\\nconnec\", \"ting to the smtp server:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\n\\n132 CHAPTER 12 | The Dapr se\", \"crets management building block\\nmetadata:\\nname: sendmail\\nnamespace: dapr-trafficcontrol\\nspec:\\ntype: \", \"bindings.smtp\\nversion: v1\\nmetadata:\\n- name: host\\nvalue: mailserver\\n- name: port\\nvalue: 25\\n- name: us\", \"er\\nsecretKeyRef:\\nname: trafficcontrol-secrets\\nkey: smtp.user\\n- name: password\\nsecretKeyRef:\\nname: tr\", \"afficcontrol-secrets\\nkey: smtp.password\\n- name: skipTLSVerify\\nvalue: true\\n\\nscopes:\\n- finecollections\", \"ervice\\n\\nUnlike the local secrets store, the Kubernetes store doesn't explicitly specify a secrets ma\", \"nagement\\ncomponent to use with the auth section. Instead, the default is the built-in Kubernetes sec\", \"rets store.\\n\\nRedis server credentials\\n\\nNext, examine the statestore.yaml component configuration fil\", \"e in the dapr/components folder:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: state\", \"store\\nnamespace: dapr-trafficcontrol\\nspec:\\ntype: state.redis\\nversion: v1\\nmetadata:\\n- name: redisHost\", \"\\nvalue: localhost:6379\\nname: redisPassword\\nsecretKeyRef:\\nname: state.redisPassword\\nkey: state.redisP\", \"assword\\n- name: actorStateStore\\nvalue: \\\"true\\\"\\nauth:\\nsecretStore: trafficcontrol-secrets\\nscopes:\\n- tr\", \"afficcontrolservice\\n\\nOnce again, the auth section references the secrets management component named\\n\", \"trafficcontrol-secrets. The redisPassword entries in the binding metadata reference the secret\\nstate\", \".redisPassword.\\n\\n133 CHAPTER 12 | The Dapr secrets management building block\\nFineCalculator componen\", \"t license key\\n\\nThe FineCollection service uses a component that calculates the fine based on the inf\", \"ormation of a\\nspeeding violation. This component is implemented as a domain service and is abstracte\", \"d by the\\nIFineCalculator interface:\\n\\npublic interface IFineCalculator\\n\\nt\\n\\npublic int CalculateFine(s\", \"tring licenseKey, int violationInKmh) ;\\n\\ni\\n\\nThe CalculateFine method expects a string containing a l\", \"icenseKey as its first argument. This key\\nunlocks the third-party component used by the implementati\", \"on. To keep the example simple, the\\nimplementation hard-codes a series of if statements. You can fin\", \"d the implementation in the\\nHardCodedFineCalculator class in the DomainsServices folder:\\npublic clas\", \"s HardCodedFineCalculator : IFineCalculator\\npublic int CalculateFine(string licenseKey, int violatio\", \"nInKmh)\\n{\\nif (licenseKey != \\\"HX783-K2L7V-CRI4A-5PN1G\\\" )\\n{\\n\\n5\\n\\nthrow new InvalidOperationException(\\\"I\", \"nvalid license-key specified.\\\");\\n\\nint fine = 9; // default administration fee\\nif (violationInKmh < 5\", \" )\\n{\\n\\nfine += 18;\\n\\nelse if (violationInKmh >= 5 && violationInkKmh < 12 )\\n{\\n\\n}\\nHi coc\\n\\nfine += 31;\\n\\n\", \"else if (violationInKmh == 35)\\n\\nt\\n\\nfine += 372;\\n}\\n\\nelse\\n\\n// violation above 35 KMh will be determine\", \"d by the prosecutor\\nreturn 0;\\n\\n5\\n\\nreturn fine;\\n\\nThe implementation simulates a check on the licenseK\", \"ey that is passed in. The\\nCollectionController of the FineCollection service must pass in the correc\", \"t license key argument\\nwhen calling the CalculateFine method. It retrieves the license key from the \", \"Dapr secrets\\nmanagement building block that is exposed by the Dapr client in the Dapr SDK for .NET. \", \"If you\\nexamine the constructor of the CollectionController, you can see the call:\\n\\n134 CHAPTER 12 | \", \"The Dapr secrets management building block\\n// set finecalculator component license-key\\nif (_fineCalc\", \"ulatorLicenseKey == null)\\n\\nt\\n\\nbool runningInK8s =\\nConvert. ToBoolean(Environment.GetEnvironmentVaria\", \"ble(\\\"DOTNET_RUNNING_IN CONTAINER\\\") ??\\n\\\"Ffalse\\\");\\n\\nvar metadata = new Dictionary<string, string> { { \", \"\\\"namespace\\\", \\\"dapr-trafficcontrol\\\" }\\n\\nB\\nif (runningInk8s)\\nvar k8sSecrets = daprClient.GetSecretAsync\", \"(\\n\\\"kubernetes\\\", \\\"trafficcontrol-secrets\\\", metadata) .Result;\\n_fineCalculatorLicenseKey = k8sSecrets[\", \"\\\"finecalculator.licensekey\\\" ];\\n\\n}\\n\\nelse\\n\\nt\\n\\nvar secrets = daprClient.GetSecretAsync(\\n\\u201ctrafficcontrol\", \"-secrets\\\", \\\"finecalculator.licensekey\\\", metadata) .Result;\\n_fineCalculatorLicenseKey = secrets[\\\"fine\", \"calculator.licensekey\\\" ];\\n\\nThe code determines whether the service is running in Kubernetes or self-\", \"hosted mode. This check is\\nnecessary because a different secrets management component must be used f\", \"or each situation. The\\nfirst argument of the GetSecretAsync method is the name of the Dapr component\", \". The second\\nargument is the name of the secret. The metadata passed in as the third argument specif\", \"ies the\\nnamespace that contains the secret. The value of the finecalculator.licensekey secret is sto\", \"red in\\na private field for later use.\\n\\nUsing Dapr secrets management offers several benefits:\\n\\n1. No\", \" sensitive information is stored in code or application configuration files.\\n\\n2. No need to learn an\", \"y new API for interacting with a secrets store.\\n\\nSummary\\n\\nThe Dapr secrets management building block\", \" provides capabilities for storing and retrieving sensitive\\nconfiguration settings like passwords an\", \"d connection-strings. It keeps secrets private and prevents\\nthem from being accidentally disclosed.\\n\", \"\\nThe building block supports several different secret stores and hides their complexity with the Dap\", \"r\\nsecrets API.\\n\\nThe Dapr .NET SDK provides a DaprClient object to retrieve secrets. It also includes\", \" a .NET\\nconfiguration provider that adds secrets to the .NET configuration system. Once loaded, you \", \"can\\nconsume these secrets in your .NET code.\\n\\nYou can use secret scopes to control access to specifi\", \"c secrets.\\n\\nReferences\\n\\u00b0 Beyond the Twelve-Factor Application\\n\\n135 CHAPTER 12 | The Dapr secrets man\", \"agement building block\\n\\u00b0 Dapr supported secret stores\\n\\n136 CHAPTER 12 | The Dapr secrets management \", \"building block\\nCHAPTER | 3\\n\\nDapr reference application\\n\\nOver the course of this book, you've learned\", \" about the foundational benefits of Dapr. You saw how\\nDapr can help you and your team construct dist\", \"ributed applications while reducing architectural and\\noperational complexity. Along the way, you've \", \"had the opportunity to build some small Dapr apps.\\nNow, it's time to explore how a more complex appl\", \"ication can benefit from Dapr.\\n\\nBut, first a little history.\\n\\neShopOnContainers\\n\\nSeveral years ago, \", \"Microsoft, in partnership with leading community experts, released a popular\\n\\nguidance book, entitle\", \"d .NET Microservices for Containerized .NET Applications. Figure 12-1 shows the\\nbook:\\n\\nNET Microserv\", \"ices:\\nArchitecture for\\nContainerized .NET\\nApplications\\n\\nCesar de la Torre\\nian Pe ri \\u201cr jm 1\\n\\nFigure \", \"12-1. .NET Microservices: Architecture for Containerized .NET Applications.\\n\\nThe book dove deep into\", \" the principles, patterns, and best practices for building distributed\\napplications. It included a f\", \"ull-featured microservice reference application that showcased the\\narchitectural concepts. Entitled,\", \" eShopOnContainers, the application hosts an e-Commerce storefront\\nthat sells various items, includi\", \"ng clothing and coffee mugs. Built in .NET, the application is cross-\\nplatform and can run in either\", \" Linux or Windows containers. Figure 12-2 shows the original eShop\\narchitecture.\\n\\n137 CHAPTER 13 | D\", \"apr reference application\\neShopOnContainers reference application\\n(Development environment architect\", \"ure)\\n\\nClient apps Docker Host\\n| stop mobi app ry (\\u2018dentty miosenvce (T3-user) I\\nXamarin.Forms ! a\\nbe\", \" ty ao fo I\\nxPlat. OS:\\nio ly (~~~ Catalog microsenvice \\\\\\n__ _/ > RabbitMQ |\\nee Pic . |_| be\\n\\\\\\n| cela\", \"l otal aw denbane a = \\u2014 I\\no>)\\n~\\\\ Rle| 5\\noO\\n| \\\\ Redis eae |\\n| DP ! I\\n| ly \\\"Seq tagging) Wenhooks apt \", \"Min Service |\\n| ly\\n1 TypeScript/Angular 2 | I\\n| ry\\n\\nFigure 12-2. Original ShopOnContainers reference\", \" application.\\n\\nAs you can see, eShopOnContainers includes many moving parts:\\n\\n1 Three different fron\", \"tend clients.\\n\\n2. Anapplication gateway to abstract backend services from the frontend.\\n3. Several b\", \"ackend core microservices.\\n4\\n\\nAn event bus component that enables asynchronous pub/sub messaging.\\n\\nT\", \"he eShopOnContainers reference application has been widely accepted across the .NET community\\nand us\", \"ed to model many large commercial microservice applications.\\n\\neShopOnDapr\\n\\nAn updated version of eSh\", \"op accompanies this book. It\\u2019s called eshopOnDapr. The update evolves\\nthe earlier eshopOnContainers \", \"application by integrating Dapr building blocks. Figure 12-3 shows the\\nnew solution architecture:\\n\\n[\", \"eShopOnDapr reference application architecture](#qg@QOr&lO<OOpOOrg@miz@!c(*@-\\nWOID OO @ >4)\\n\\nFigure \", \"12-3. eShopOnDapr reference application architecture.\\n\\nWhile eShopOnDapr focuses on Dapr, the archit\", \"ecture has also been streamlined and simplified.\\n\\n1. A Single Page Application running on Blazor Web\", \"Assembly sends user requests to an API\\ngateway.\\n\\n2. The API gateway abstracts the backend core micro\", \"services from the frontend client. It's\\nimplemented using Envoy, a high performant, open-source serv\", \"ice proxy. Envoy routes incoming\\n\\n138 CHAPTER 13 | Dapr reference application\\nrequests to backend mi\", \"croservices. Most requests are simple CRUD operations (for example, get\\nthe list of brands from the \", \"catalog) and handled by a direct call to a backend microservice.\\n\\n3. Other requests are more logical\", \"ly complex and require multiple microservice calls to work\\ntogether. For these cases, ShopOnDapr imp\", \"lements an aggregator microservice that\\norchestrates a workflow across those microservices needed to\", \" complete the operation.\\n\\n4. The core backend microservices implement the required functionality for\", \" an e-Commerce store.\\nEach is self-contained and independent of the others. Following widely accepte\", \"d domain\\ndecomposition patterns, each microservice Isolates a specific business capability:\\n\\n\\u2014 The b\", \"asket service manages the customer's shopping basket experience.\\n- The catalog service manages produ\", \"ct items available for sale.\\n\\n\\u2014 The identity service manages authentication and identity.\\n\\n\\u2014 The ord\", \"ering service handles all aspects of placing and managing orders.\\n\\u2014 The payment service transacts th\", \"e customer's payment.\\n\\n5. Adhering to best practices, each microservice maintains its own persistent\", \" storage. The\\napplication doesn't share a single datastore.\\n\\n6. Finally, the event bus wraps the Dap\", \"r publish/subscribe components. It enables asynchronous\\npublish/subscribe messaging across microserv\", \"ices. Developers can plug in any Dapr-supported\\nmessage broker component.\\n\\nApplication of Dapr build\", \"ing blocks\\n\\nIn eShopOnDapr, Dapr building blocks replace a large amount of complex, error-prone plum\", \"bing\\ncode.\\n\\nFigure 12-4 shows the Dapr integration in the application.\\n\\n4\\n\\n7 = LD\\n4 dap |e\\nBlazor 4 \", \"|GGPr API gateway 5 | _, | @P\\\" Web shopping 5 b>\\nFrontend (Envoy) oe aggregator\\n= Xe\\nD \\u00a9 Identity\\nse\", \"rvice\\na 5\\nuf C4 Mm\\naymen < P\\n(1] Actors [2] Bindings [3] Pub/sub y =\\nKZ\\n\\n\\\\4) Secrets | 5 | Service i\", \"nvocation (6 | State management\\n\\nFigure 12-4. Dapr integration in eshopOnDapr.\\n\\n139 CHAPTER 13 | Dap\", \"r reference application\\nThe above figure shows the Dapr building blocks (represented as green number\", \"ed boxes) that each\\neShopOnDapr service consumes.\\n\\n1. |The API gateway and web shopping aggregator s\", \"ervices use the service invocation building\\nblock to invoke methods on the backend services.\\n\\n2. The\", \" backend services communicate asynchronously using the publish & subscribe building\\nblock.\\n\\n3. The b\", \"asket service uses the state management building block to store the state of the\\ncustomer's shopping\", \" basket.\\n\\n4. The original eshopOnContainers demonstrates DDD concepts and patterns in the ordering\\ns\", \"ervice. eshopOnDapr uses the actor building block as an alternative implementation. The turn-\\nbased \", \"access model of actors makes it easy to implement a stateful ordering process with\\nsupport for cance\", \"llation.\\n\\n5. The ordering service sends order confirmation e-mails using the bindings building block\", \".\\n\\n6. Secret management is done by the secrets building block.\\n\\nThe following sections provide more \", \"detail on how the Dapr building blocks are applied in\\neShopOnDapr.\\n\\nState management\\n\\nIn eShopOnDapr\", \", the Basket service uses the state management building block to persist the contents\\nof the custome\", \"r's shopping basket. The original eshopOnContainers architecture used an\\nIBasketRepository interface\", \" to read and write data for the basket service. The\\nRedisBasketRepository class provided the impleme\", \"ntation using Redis as the underlying data store.\\nTo compare and contrast, the original eshopOnConta\", \"iners implementation is presented below:\\n\\npublic class RedisBasketRepository : IBasketRepository\\n{\\np\", \"rivate readonly ConnectionMultiplexer _redis;\\nprivate readonly IDatabase _database;\\n\\npublic RedisBas\", \"ketRepository(ConnectionMultiplexer redis)\\n{\\n\\n_redis = redis;\\n\\n_database = redis.GetDatabase();\\n\\n5\\n\\n\", \"public async Task<CustomerBasket> GetBasketAsync(string customerId)\\n\\nt\\n\\nvar data = await _database.S\", \"tringGetAsync(customerId) ;\\n\\nif (data.IsNullOrEmpty )\\n{\\n\\n5\\n\\nreturn null;\\n\\nreturn JsonConvert.Deseria\", \"lizeObject<CustomerBasket>(data) ;\\n\\n140 CHAPTER 13 | Dapr reference application\\nThis code uses the t\", \"hird party StackExchange.Redis NuGet package. The following steps are required\\nto load the shopping \", \"basket for a given customer:\\n\\n1. Inject a Redis ConnectionMultiplexer into the constructor. The Conn\", \"ectionMultiplexer is\\nregistered with the dependency injection framework in the Program.cs file:\\n\\nser\", \"vices.AddSingleton<ConnectionMultiplexer>(sp =>\\n\\nt\\n\\nvar settings = spGetRequiredService<I0ptions<Bas\", \"ketSettings>>().Value;\\n\\nvar configuration = ConfigurationOptions.Parse(settingsConnectionString, tru\", \"e) ;\\nconfiguration.ResolveDns = true;\\nreturn ConnectionMultiplexer.Connect(configuration) ;\\n\\n1. Use \", \"the ConnectionMultiplexer to create an IDatabase instance in each consuming class.\\n\\n2. Use the IData\", \"base instance to execute a Redis StringGet call using the given customerId as the\\nkey.\\n\\n3. Check if \", \"data is loaded from Redis; if not, return null.\\n4.  Deserialize the data from Redis to a CustomerBas\", \"ket object and return the result.\\n\\nIn the updated eShopOnDapr reference application, a new DaprBaske\", \"tRepository class replaces the\\nRedisBasketRepository class:\\n\\npublic class DaprBasketRepository : IBa\", \"sketRepository\\nt\\nprivate const string StoreName = \\\"eshop-statestore\\\";\\n\\nprivate readonly DaprClient _\", \"daprClient;\\n\\npublic DaprBasketRepository(DaprClient daprClient)\\nt\\n\\n5\\n\\n_daprClient = daprClient;\\n\\npub\", \"lic Task<CustomerBasket> GetBasketAsync(string customerId) =>\\n_daprClient.GetStateAsync<CustomerBask\", \"et>(StoreName, customerlId) ;\\n\\nHi coc\\n\\nThe updated code uses the Dapr .NET SDK to read and write dat\", \"a using the state management\\nbuilding block. The new steps to load the basket for a customer are dra\", \"matically simplified:\\n\\n1. Inject a DaprClient into the constructor. The DaprClient is registered wit\", \"h the dependency\\ninjection framework in the Program.cs _ file.\\n\\n2. Use the DaprClient.GetStateAsync \", \"method to load the customer's shopping basket items from\\nthe configured state store and return the r\", \"esult.\\n\\nThe updated implementation still uses Redis as the underlying data store. But, note how Dapr\", \"\\nabstracts the StackExchange.Redis references and complexity from the application. The application\\nn\", \"o longer requires a direct dependency on Redis. A Dapr configuration file is all that\\u2019s needed:\\n\\n141\", \" CHAPTER 13 | Dapr reference application\\napiVersion: dapr.io/vialpha1l\\nkind: Component\\nmetadata:\\n\\nna\", \"me: eshop-statestore\\nnamespace: eshop\\n\\nspec:\\ntype: state.redis\\nversion: v1\\n\\nmetadata:\\n\\n- name: redis\", \"Host\\nvalue: redis:6379\\nname: redisPassword\\nsecretKeyRef:\\n\\nname: redisPassword\\nauth:\\nsecretStore: esh\", \"op-secretstore\\n\\nThe Dapr implementation also simplifies changing the underlying data store. Switchin\", \"g to Azure Table\\nStorage, for example, requires only changing the contents of the configuration file\", \". No code changes\\nare necessary.\\n\\nService invocation\\n\\nThe original eshopOnContainers used a mix of H\", \"TTP/REST and gRPC services. The use of gRPC was\\nlimited to communication between an aggregator servi\", \"ce and core backend services. Figure 12-5\\n\\nshows the original architecture:\\nif |\\nCatalog\\n\\nAPI gatewa\", \"y\\n(Envoy)\\n\\nWeb shopping\\n\\naggregator cial\\n\\nFigure 12-5. gRPC and HTTP/REST calls in eshopOnContainers\", \".\\nNote the steps from the previous figure:\\n\\n1. The frontend calls the API gateway using HTTP/REST.\\n\\n\", \"142 CHAPTER 13 | Dapr reference application\\n2. The API gateway forwards simple CRUD (Create, Read, U\", \"pdate, Delete) requests directly to a core\\nbackend service using HTTP/REST.\\n\\n3. The API gateway forw\", \"ards complex requests that involve coordinated backend service calls to\\nthe web shopping aggregator \", \"service.\\n\\n4. The aggregator service uses gRPC to call core backend services.\\n\\nIn the updated eShopOn\", \"Dapr implementation, Dapr sidecars are added to the services and API\\ngateway. Figure 12-6 show the u\", \"pdated architecture:\\n\\nBasket\\n\\ngrpc\\n\\nWeb shopping 4 .\\nf f at PILI LEI ED\\n\\nFigure 12-6. Updated eShop \", \"architecture using Dapr.\\n\\nNote the updated steps from the previous figure:\\n\\n1. The frontend still us\", \"es HTTP/REST to call the API gateway.\\n\\n2. The API gateway forwards HTTP requests to its Dapr sidecar\", \".\\n\\n3. The API gateway sidecar sends the request to the sidecar of the aggregator or backend service.\", \"\\n\\n4. The aggregator service uses the Dapr .NET SDK to call backend services through their sidecar\\nar\", \"chitecture.\\n\\nDapr implements calls between sidecars with gRPC. So even if you're invoking a remote s\", \"ervice with\\nHTTP/REST semantics, a part of the transport is implemented using gRPC.\\n\\nThe eShopOnDapr\", \" reference application benefits from the Dapr service invocation building block. The\\nbenefits also i\", \"nclude service discovery, automatic mTLS, and built-in observability.\\n\\nForward HTTP requests using E\", \"nvoy and Dapr\\n\\nBoth the original and updated eShop application leverage the Envoy proxy as an API ga\", \"teway. Envoy\\nis aN Open-source proxy and communication bus that is popular across modern distributed\", \"\\napplications. Originating from Lyft, Envoy is owned and maintained by the Cloud-Native Computing\\nFo\", \"undation.\\n\\n143 CHAPTER 13 | Dapr reference application\\nIn the original eshopOnContainers implementat\", \"ion, the Envoy API gateway forwarded incoming HTTP\\nrequests directly to aggregator or backend servic\", \"es. In the new eShopOnDapr, the Envoy proxy\\nforwards the request to a Dapr sidecar.\\n\\nEnvoy is config\", \"ured using a YAML definition file to control the proxy\\u2019s behavior. To enable Envoy to\\nforward HTTP r\", \"equests to a Dapr sidecar container, a dapr cluster is added to the configuration. The\\ncluster confi\", \"guration contains a host that points to the HTTP port on which the Dapr sidecar is\\nlistening:\\n\\nclust\", \"ers:\\n\\n- name: dapr\\nconnect_timeout: @.25s\\ntype: strict_dns\\n\\nhosts:\\n\\n- socket_address:\\naddress: 127.0\", \".0.1\\nport_value: 3500\\n\\nThe Envoy route configuration is updated to rewrite incoming requests as call\", \"s to the Dapr sidecar\\n(pay close attention to the prefix_rewrite key/value pair):\\n\\n- name: \\\"\\u201cc-short\", \"\\\"\\nmatch:\\nprefix: \\\"/c/\\\"\\nroute:\\nauto _host_rewrite: true\\nprefix_rewrite: \\\"/v1.0/invoke/catalog-api/met\", \"hod/\\\"\\ncluster: dapr\\n\\nConsider a scenario where the frontend client wants to retrieve a list of catal\", \"og items. The Catalog API\\nprovides an endpoint for getting the catalog items:\\n\\n[Route(\\\"api/v1i/[cont\", \"roller]\\\") ]\\n[ApiController |\\npublic class CatalogController : ControllerBase\\n\\nt\\n\\n[HttpGet(\\\"items/by_\", \" page\\\") |\\n[ ProducesResponseType(typeof(PaginatedItemsViewModel), (int)HttpStatusCode.OK) ]\\npublic a\", \"sync Task<PaginatedItemsViewModel> ItemsAsync(\\n[FromQuery] int typelId = -1,\\n[FromQuery] int brandId\", \" = -1,\\n[FromQuery] int pageSize = 10,\\n[FromQuery] int pageIndex = @)\\nt\\n\\ni\\n\\nHi coc\\n\\nFirst, the fronte\", \"nd makes a direct HTTP call to the Envoy API gateway.\\n\\nGET http://<api-gateway>/c/api/v1/catalog/ite\", \"ms\\n\\nThe Envoy proxy matches the route, rewrites the HTTP request, and forwards it to the invoke API \", \"of its\\nDapr sidecar:\\n\\nGET http://127.0.0.1:3500/v1.0/invoke/catalog-api/method/api/v1/catalog/items\\n\", \"\\n144 CHAPTER 13 | Dapr reference application\\nThe sidecar handles service discovery and routes the re\", \"quest to the Catalog API sidecar. Finally, the\\nsidecar calls the Catalog API to execute the request,\", \" fetch catalog items, and return a response:\\n\\nGET http://localhost/api/v1/catalog/items\\n\\nMake aggreg\", \"ated service calls using the .NET SDK\\n\\nMost calls from the eShop frontend are simple CRUD calls. The\", \" API gateway forwards them to a single\\nservice for processing. Some scenarios, however, require mult\", \"iple backend services to work together\\nto complete a request. For the more complex calls, the web sh\", \"opping aggregator service mediates the\\ncross service workflow. Figure 12-7 show the processing seque\", \"nce of adding an item to your\\n\\nshopping basket:\\n| Frontend | | API gateway Yjtlliatiatittay Catalog \", \"API | Basket API\\nget catalog items\\n\\nupdate basket\\n\\n'\\n\\\\\\n4\\nupdate basket \\\\\\n\\nt\\nt\\n4\\n(\\n\\ncatalog items\\n\\nva\", \"lidate basket items |\\nsave basket\\n\\ni\\n-Seeeeeeeuse\\n\\nFigure 12-7. Backend call requiring multiple serv\", \"ices.\\n\\nThe aggregator service first retrieves catalog items from the Catalog API. It then validates \", \"item\\navailability and pricing. Finally, the aggregator service updates the shopping basket by callin\", \"g the\\nBasket API.\\n\\nThe aggregator service contains a BasketController that provides an endpoint for \", \"updating the\\nshopping basket:\\n\\n[Route(\\\"api/v1i/[controller]\\\") ]\\n\\n[Authorize |\\n\\n[ApiController |\\n\\npub\", \"lic class BasketController : ControllerBase\\n\\nt\\n\\nprivate readonly ICatalogService catalog;\\nprivate re\", \"adonly IBasketService _basket;\\n\\n[HttpPost |\\n[HttpPut ]\\n[ ProducesResponseType( (int )HttpStatusCode.\", \"BadRequest) |\\n[ ProducesResponseType(typeof(BasketData), (int)HttpStatusCode.OK) ]\\npublic async Task\", \"<ActionResult<BasketData>> UpdateAllBasketAsync (\\n[FromBody |] UpdateBasketRequest data,\\n[FromHeader\", \"] string authorization)\\n\\nBasketData basket;\\n\\n145 CHAPTER 13 | Dapr reference application\\nif (data.It\", \"ems is null || !data.Items.Any())\\n\\n{\\nbasket = new();\\n}\\nelse\\n{\\n// Get the item details from the catal\", \"og API.\\nvar catalogItems = await _catalog.GetCatalogItemsAsync (\\ndata. Items.Select(x => x.ProductId\", \"));\\nif (catalogItems == null)\\n{\\nreturn BadRequest(\\n\\\"Catalog items were not available for the specifi\", \"ed items in the\\nbasket.\\\");\\n}\\n// Check item availability and prices; store results in basket object.\\n\", \"basket = CreateValidatedBasket(data.Items, catalogItems) ;\\n}\\n\\n// Save the updated shopping basket.\\na\", \"wait _basket.UpdateAsync(basket, authorization.Substring(\\\"Bearer \\\".Length));\\n\\nreturn basket;\\n\\nThe Up\", \"dateAllBasketAsync method gets the Authorization header of the incoming request using a\\nFromHeader a\", \"ttribute. The Authorization header contains the access token that is needed to call\\nprotected backen\", \"d services.\\n\\nAfter receiving a request to update the basket, the aggregator service calls the Catalo\", \"g API to get the\\nitem details. The Basket controller uses an injected ICatalogService object to make\", \" that call and\\ncommunicate with the Catalog API. The original implementation of the interface used g\", \"RPC to make\\nthe call. The updated implementation uses Dapr service invocation with HttpClient suppor\", \"t:\\npublic class CatalogService : ICatalogService\\n{\\n\\nprivate readonly HttpClient _httpClient;\\n\\npublic\", \" CatalogService(HttpClient httpClient)\\nt\\n\\n5\\n\\n_httpClient = httpClient;\\n\\npublic Task<IEnumerable<Cata\", \"logItem>> GetCatalogItemsAsync(IEnumerable<int> ids)\\nt\\n\\nvar requestUri = $\\\"api/v1/catalog/items/by_i\", \"ds?ids={string.Join(\\\",\\\", ids)}\\\";\\n\\nreturn httpClient.GetFromJsonAsync<IEnumerable<CatalogItem>>(reque\", \"stUri) ;\\n\\n146 CHAPTER 13 | Dapr reference application\\nNotice how no Dapr-specific code is required t\", \"o make the service invocation call. All communication is\\ndone using the standard HttpClient object.\\n\", \"\\nThe Dapr HttpClient is configured for the CatalogService class on program startup:\\n\\nThe other call \", \"made by the aggregator service is to the Basket API. It only allows authorized requests.\\nThe access \", \"token is passed along in an Authorization request header to ensure the call succeeds:\\n\\npublic class \", \"BasketService : IBasketService\\n\\nt\\n\\npublic Task UpdateAsync(BasketData currentBasket, string accessTo\", \"ken)\\n\\n{\\nvar request = new HttpRequestMessage(HttpMethod.Post, \\\"\\u201capi/v1/basket\\\" )\\n\\n{\\n}3\\n\\nrequest.Head\", \"ers.Authorization = new AuthenticationHeaderValue(\\\"Bearer\\\",\\naccessToken) ;\\n\\nContent = JsonContent.Cr\", \"eate(currentBasket )\\n\\nvar response = await _httpClient.SendAsync(request) ;\\nresponse. EnsureSuccessS\", \"tatusCode() ;\\n\\nIn this example too, only standard HttpClient functionality is used to call the servi\", \"ce. This allows\\ndevelopers who are already familiar with HttpClient to reuse their existing skills. \", \"It even enables\\nexisting HttpClient code to use Dapr service invocation without making any changes.\\n\", \"\\nPublish & subscribe\\n\\nBoth eShopOnContainers and eSshopOnDapr use the pub/sub pattern for communicat\", \"ing integration\\nevents across microservices. Integration events include:\\n\\n. When a user checks-out a\", \" shopping basket.\\n\\u00b0 When a payment for an order has succeeded.\\n\\n. When the grace-period of a purchas\", \"e has expired.\\n\\nNote\\n\\nThink of an /ntegration Event as an event that takes place across multiple ser\", \"vices.\\n\\nEventing in eSshopOnContainers is based on the following IEventBus interface:\\n\\npublic interf\", \"ace IEventBus\\n\\nt\\n\\nvoid Publish(IntegrationEvent integrationEvent) ;\\n\\nvoid Subscribe<T, THandler>()\\nw\", \"here TEvent : IntegrationEvent\\nwhere THandler : IIntegrationEventHandler<T>;\\n\\n147 CHAPTER 13 | Dapr \", \"reference application\\nConcrete implementations of this interface for both RabbitMQ and Azure Service\", \" Bus are found in\\neShopOnContainers. Each implementation included a large amount of custom plumbing \", \"code that\\nwas complex to understand and difficult to maintain.\\n\\nThe newer eShopOnDapr significantly \", \"simplifies pub/sub behavior by using Dapr. To start, the\\nTEventBus interface was reduced to a single\", \" method:\\n\\npublic interface IEventBus\\n\\nt\\n\\nTask PublishAsync(IntegrationEvent integrationEvent) ;\\n\\ni\\n\\n\", \"Publish events\\n\\nIn eShopOnDapr, a single DaprEventBus implementation can support any Dapr-supported \", \"message\\nbroker. The following code block shows the simplified Publish method. Note how the PublishAs\", \"ync\\nmethod uses the Dapr client to publish an event:\\n\\npublic class DaprEventBus : IEventBus\\n\\n{\\npriva\", \"te const string DAPR_PUBSUB NAME = \\\"pubsub\\\";\\n\\nprivate readonly DaprClient _dapr;\\nprivate readonly IL\", \"ogger _logger;\\n\\npublic DaprEventBus(DaprClient dapr, ILogger<DaprEventBus> logger)\\n\\nt\\n_dapr = dapr;\\n\", \"_logger = logger;\\n\\npublic async Task PublishAsync(IntegrationEvent integrationEvent )\\n\\nt\\n\\nvar topicN\", \"ame = integrationEvent.GetType().Name;\\n\\n_logger.LogInformation (\\n\\\"Publishing event {@Event} to {Pubs\", \"ubName}.{TopicName}\\\",\\nintegrationEvent,\\nDAPR_PUBSUB_NAME,\\ntopicName) ;\\n\\n// We need to make sure that\", \" we pass the concrete type to PublishEventAsync,\\n// which can be accomplished by casting the event t\", \"o dynamic. This ensures\\n// that all event fields are properly serialized.\\nawait _dapr.PublishEventAs\", \"ync(DAPR_PUBSUB NAME, topicName,\\n\\n(object )integrationEvent) ;\\n\\n}\\n\\nAs you can see in the code snippe\", \"t, the topic name is derived from event type\\u2019s name. Because all\\neShop services use the IEventBus ab\", \"straction, retrofitting Dapr required absolutely no change to the\\nmainline application code.\\n\\n148 CH\", \"APTER 13 | Dapr reference application\\nImportant\\n\\nThe Dapr SDK uses System. Text .Json to serialize/d\", \"eserialize messages. However, System. Text.Json\\ndoesn't serialize properties of derived classes by d\", \"efault. In the eShop code, an event is sometimes\\nexplicitly declared as an IntegrationEvent, the bas\", \"e class for integration events. This construct allows\\n\\nthe concrete event type to be determined dyna\", \"mically at run time based on business logic. As a result,\\nthe event is serialized using the type inf\", \"ormation of the base class and not the derived class. To force\\nSystem. Text.Json to serialize the pr\", \"operties of both the base and derived class, the code uses\\nobject as the generic type parameter. For\", \" more information, see the .NET documentation.\\n\\nWith Dapr, pub/sub infrastructure code is dramatical\", \"ly simplified. The application doesn\\u2019t need to\\ndistinguish between message brokers. Dapr provides th\", \"is abstraction for you. If needed, you can easily\\nswap out message brokers or configure multiple mes\", \"sage broker components with no code changes.\\n\\nSubscribe to events\\n\\nThe earlier eshopOnContainers app\", \" contains SubscriptionManagers to handle the subscription\\nimplementation for each message broker. Ea\", \"ch manager contains complex message broker-specific\\ncode for handling subscription events. To receiv\", \"e events, each service has to explicitly register a\\nhandler for each event-type.\\n\\neShopOnDapr stream\", \"lines the plumbing for event subscriptions by using Dapr ASP.NET Core\\nintegration. Each event is han\", \"dled by an action method in a controller. A Topic attribute decorates the\\naction method with the nam\", \"e of the corresponding topic. Here\\u2019s a code snippet taken from the\\nPaymentService:\\n\\n[Route(\\\"api/v1i/\", \"[controller]\\\") ]\\n[ApiController |\\npublic class IntegrationEventController : ControllerBase\\n\\n{\\nprivat\", \"e const string DAPR_PUBSUB NAME = \\\"pubsub\\\";\\n\\n[HttpPost(\\\"OrderStatusChangedToValidated\\\" ) ]\\n[ Topic(D\", \"APR_PUBSUB_ NAME, nameof(OrderStatusChangedToValidatedIntegrationEvent) ) ]\\npublic Task HandleAsync(\", \"\\nOrderStatusChangedToValidatedIntegrationEvent integrationEvent,\\n[FromServices] OrderStatusChangedTo\", \"ValidatedIntegrationEventHandler handler) =>\\nhandler.Handle(integrationEvent) ;\\n\\nIn the Topic attrib\", \"ute, the name of the .NET type of the event is used as the topic name. For handling\\nthe event, an ev\", \"ent handler that already existed in the earlier eshopOnContainers code base is\\nresolved using depend\", \"ency injection and invoked. In the previous example, messages received from\\nthe OrderStatusChangedTo\", \"ValidatedIntegrationEvent topic invoke the existing\\nOrderStatusChangedToValidatedIntegrationEventHan\", \"dler event handler. Because Dapr\\nimplements the underlying plumbing for subscriptions and message br\", \"okers, a large amount of\\noriginal code became obsolete and was removed from the code-base. Much of t\", \"his code was complex\\nto understand and challenging to maintain.\\n\\n149 CHAPTER 13 | Dapr reference app\", \"lication\\nUse pub/sub components\\n\\nWithin the eShopOnDapr repository, a deployment folder contains fil\", \"es for deploying the application\\nusing different deployment modes: Docker Compose and Kubernetes. A \", \"dapr folder exists within each\\nof these folders that holds a components folder. This folder holds a \", \"file eshop- pubsub. yaml. It\\nspecifies the Dapr pub/sub component that the application will use for \", \"pub/sub behavior. As you saw\\nin the earlier code snippets, the name of the pub/sub component used is\", \" pubsub. Here\\u2019s the content\\nof the eshop-pubsub.yaml file in the deployment/compose/dapr/components \", \"folder:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\n\\nname: pubsub\\n\\nnamespace: eshop\\n\\nspe\", \"c:\\ntype: pubsub.rabbitmq\\nversion: v1\\nmetadata:\\n- name: host\\nvalue: \\\"\\u201camqp://rabbitmg:5672\\\"\\n\\nThe conf\", \"iguration specifies RabbitMQ as the underlying infrastructure. To change message brokers,\\nyou need o\", \"nly to configure a different message broker, such as NATS or Azure Service Bus and update\\nthe yaml f\", \"ile. With Dapr, there are no changes to your mainline service code when switching message\\nbrokers.\\n\\n\", \"You can also easily use multiple message brokers in a single application. Many times a system will\\nh\", \"andle workloads with different characteristics. One event may occur 10 times a day, but another\\neven\", \"t occurs 5,000 times per second. You may benefit by partitioning messaging traffic to different\\nmess\", \"age brokers. With Dapr, you can add multiple pub/sub component configurations, each with a\\ndifferent\", \" name.\\n\\nBindings\\n\\neShopOnDapr uses the bindings building block for sending e-mails. When a user plac\", \"es an order, the\\napplication sends an order confirmation e-mail using the SMTP output binding. You c\", \"an find this\\nbinding in the eshop-email.yaml file in the components folder:\\n\\napiVersion: dapr.io/via\", \"lpha1\\nkind: Component\\nmetadata:\\nname: sendmail\\nnamespace: eshop\\nspec:\\ntype: bindings.smtp\\nversion: v\", \"1\\nmetadata:\\n- name: host\\nvalue: maildev\\n- name: port\\nvalue: 25\\n- name: user\\nsecretKeyRef:\\nname: Smtp\", \".User\\n\\n150 CHAPTER 13 | Dapr reference application\\nkey: Smtp.User\\n- name: password\\nsecretKeyRef:\\nnam\", \"e: Smtp.Password\\nkey: Smtp.Password\\n- name: skipTLSVerify\\nvalue: true\\nauth:\\nsecretStore: eshop-secre\", \"tstore\\nscopes:\\n- ordering-api\\n\\nDapr gets the username and password for connecting to the SMTP server\", \" from a secret reference. This\\napproach keeps secrets outside of the configuration file. To learn mo\", \"re about Dapr secrets, read the\\n\\nsecrets building block chapter.\\n\\nThe binding configuration specifie\", \"s a binding component that can be invoked using the /sendmail\\nendpoint on the Dapr sidecar. Here's a\", \" code snippet in which an email is sent whenever an order is\\nstarted:\\n\\npublic Task Handle(OrderStart\", \"edDomainEvent notification, CancellationToken\\ncancellationToken)\\n{\\nvar message = CreateEmailBody(not\", \"ification) ;\\nvar metadata = new Dictionary<string, string>\\n{\\n[\\\"emailFrom\\\"]| = \\\"\\u201ceShopOn@dapr.io\\\",\\n[\\\"\", \"emailTo\\\" = notification.UserName,\\n[\\\"subject\\\"] = $\\\"Your eShopOnDapr order #{notification.Order.Id}\\\"\\n}\", \";\\nreturn daprClient.InvokeBindingAsync(\\\"sendmail\\\", \\\"create\\\", message, metadata,\\ncancellationToken) ;\", \"\\n\\n5\\n\\npublic Task SendOrderConfirmationAsync(Order order)\\n\\nt\\n\\nvar message = CreateEmailBody(order) ;\\n\", \"\\nreturn _daprClient.InvokeBindingAsync(\\n\\\"sendmail\\\",\\n\\\"create\\\",\\nCreateEmailBody(order),\\nnew Dictionary\", \"<string, string>\\n{\\n[\\\"emailFrom\\\"] = \\\"eshopondapr@example.com\\\",\\n[\\\"\\u201cemailTo\\\"] = order.BuyerEmail,\\n[\\\"sub\", \"ject\\\"] = $\\\"Your eShopOnDapr Order #{order.OrderNumber }\\\"\\n\\n})3\\n\\nAs you can see in this example, messa\", \"ge contains the message body. The CreateEmailBody method\\nsimply formats a string with the body text.\", \" The name of the binding to invoke is sendmail and the\\noperation is create. The metadata specifies t\", \"he email sender, recipient, and subject for the email\\nmessage. If these values are static, they can \", \"also be included in the metadata fields in the\\nconfiguration file.\\n\\n151 CHAPTER 13 | Dapr reference \", \"application\\nActors\\n\\nIn the original eshopOnContainers solution, the Ordering service provides a grea\", \"t example of how to\\nuse DDD design patterns in a .NET microservice. As the updated eShopOnDapr focus\", \"es on Dapr, the\\nOrdering service now uses the actors building block to implement its business logic.\", \"\\n\\nThe ordering process consists of the following steps:\\n\\n1. |The customer submits the order. There\\u2019s\", \" a grace period before any further processing occurs.\\nDuring the grace period, the customer can canc\", \"el the order.\\n\\n2. The system checks that there's available stock.\\n\\n3. The system processes the payme\", \"nt.\\n\\n4. The system ships the order.\\n\\nThe process is implemented using a single OrderingProcessActor \", \"actor type. Here\\u2019s the interface for\\nthe actor:\\n\\npublic interface IOrderingProcessActor : IActor\\n\\n{\\n\", \"Task SubmitAsync(\\n\\nstring userId, string userName, string street, string city,\\nstring zipCode, strin\", \"g state, string country, CustomerBasket basket) ;\\n\\nTask NotifyStockConfirmedAsync() ;\\n\\nTask NotifySt\", \"ockRejectedAsync(List<int> rejectedProductIds) ;\\n\\nTask NotifyPaymentSucceededAsync() ;\\nTask NotifyPa\", \"ymentFailedAsync();\\nTask<bool> CancelAsync();\\nTask<bool> ShipAsync();\\n\\nTask<Order> GetOrderDetailsAs\", \"ync();\\n\\nThe process is started when a customer checks out some products. Upon checkout, the Basket s\", \"ervice\\npublishes a UserCheckoutAcceptedIntegrationEvent message using the Dapr pub/sub building\\nbloc\", \"k. The Ordering service handles the message in the OrderingProcessEventController class and\\ncalls th\", \"e SubmitAsync method of the actor:\\n\\n[HttpPost(\\\"UserCheckoutAccepted\\\" ) |\\n[Topic(DaprPubSubName, \\\"Use\", \"rCheckoutAcceptedIntegrationEvent\\\" ) |\\npublic async Task HandleAsync(UserCheckoutAcceptedIntegration\", \"Event integrationEvent )\\n\\nt\\n\\nif (integrationEvent.RequestId != Guid.Empty)\\n\\nt\\nvar actorId = new Acto\", \"rId(integrationEvent.RequestId.ToString() );\\nvar orderingProcess = _actorProxyFactory.CreateActorPro\", \"xy<IOrderingProcessActor>(\\nactorId,\\n\\nnameof (OrderingProcessActor) ) ;\\n\\nawait orderingProcess.Submit\", \"Async(integrationEvent.UserId,\\nintegrationEvent.UserName,\\n\\n152 CHAPTER 13 | Dapr reference applicati\", \"on\\nintegrationEvent.Street, integrationEvent.City, integrationEvent.ZipCode,\\nintegrationEvent.State,\", \" integrationEvent.Country, integrationEvent.Basket) ;\\n\\n_logger.LogWarning(\\n\\\"Invalid IntegrationEvent\", \" - RequestId is missing - {@IntegrationEvent}\\\",\\nintegrationEvent) ;\\n\\nIn the example above, the Order\", \"ing service first uses the original request ID from the\\nUserCheckoutAcceptedIntegrationEvent message\", \" as the actor ID. The handler uses the ActorId to\\ncreate an actor proxy and invokes the SubmitAsync \", \"method. The following snippet shows the\\nimplementation of the SubmitAsync method:\\n\\npublic async Task\", \" SubmitAsync(\\nstring buyerld,\\nstring buyerEmail,\\nstring street,\\nstring city,\\nstring state,\\nstring co\", \"untry,\\nCustomerBasket basket)\\n\\nvar orderState = new OrderState\\n{\\nOrderDate = DateTime.UtcNow,\\nOrderS\", \"tatus = OrderStatus. Submitted,\\nDescription = \\\"Submitted\\\",\\nAddress = new OrderAddressState\\n{\\nStreet \", \"= street,\\nCity = city,\\nState = state,\\nCountry = country\\n}s\\nBuyerId = buyerld,\\nBuyerEmail = buyerEmai\", \"l,\\nOrderItems = basket.Items\\n.Select(item => new OrderItemState\\n{\\nProductId = item.ProductId,\\nProduc\", \"tName = item.ProductName,\\nUnitPrice = item.UnitPrice,\\nUnits = item.Quantity,\\nPictureFileName = item.\", \"PictureFileName\\n\\n})\\n.TOList()\\n\\nIre\\n\\nawait StateManager.SetStateAsync(OrderDetailsStateName, orderSta\", \"te) ;\\nawait StateManager.SetStateAsync(OrderStatusStateName, OrderStatus.Submitted) ;\\n\\nawait Registe\", \"rReminderAsync (\\nGracePeriodElapsedReminder,\\nnull,\\nTimeSpan.FromSeconds(_settings.Value.GracePeriodT\", \"ime) ,\\nTimeSpan.FromMilliseconds(-1));\\n\\n153 CHAPTER 13 | Dapr reference application\\nawait _eventBus.\", \"PublishAsync(new OrderStatusChangedToSubmittedIntegrationEvent (\\nOrderld,\\nOrderStatus.Submitted.Name\", \",\\nbuyerId,\\nbuyerEmail) ) ;\\n\\nThere's a lot going on in the Submit method:\\n\\n1. |The method takes the g\", \"iven arguments to create an OrderState object and saves it in the actor\\nState.\\n\\n2. The method saves \", \"the current status of the process (OrderStatus.Submitted) in the actor state.\\n\\nThe method registers \", \"a reminder to signal the end of the grace period. Order processing is\\ndelayed until the end of the g\", \"race period to deal with customers changing their mind.\\n\\n4. Lastly, the method publishes an OrderSta\", \"tusChangedToSubmittedIntegrationEvent to notify\\nother services of the status change.\\n\\nWhen the remin\", \"der for the grace period ending fires, the actor runtime calls the\\nReceiveReminderAsync method:\\n\\npub\", \"lic Task ReceiveReminderAsync(\\nstring reminderName, byte[] state, TimeSpan dueTime, TimeSpan period)\", \"\\n{\\n\\nreturn reminderName switch\\n\\n{\\nGracePeriodElapsedReminder => OnGracePeriodElapsedAsync(),\\nStockCo\", \"nfirmedReminder => OnStockConfirmedSimulatedwWorkDoneAsync(),\\nStockRejectedReminder => OnStockReject\", \"edSimulatedWorkDoneAsync (\\n\\nJsonConvert.DeserializeObject<List<int>>(Encoding.UTF8.GetString(state))\", \"),\\n\\nPaymentSucceededReminder => OnPaymentSucceededSimulatedWorkDoneAsync(),\\nPaymentFailedReminder =>\", \" OnPaymentFailedSimulatedWorkDoneAsync(),\\n_ => Task.CompletedTask\\n\\n}3\\n\\nAs shown in the snippet above\", \", the ReceiveReminderAsync method handles not just the grace period\\nreminder. The actor also uses re\", \"minders to simulate background work and introduce some delays in\\nthe ordering process. This makes th\", \"e process easier to follow in the eshopOnDapr UI where\\nnotifications are shown for each status updat\", \"e. The ReceiveReminderAsync method uses the\\nreminder name to determine which method handles the remi\", \"nder. The grace period reminder is\\nhandled by the OnGracePeriodElapsedAsync method:\\n\\npublic async Ta\", \"sk OnGracePeriodElapsedAsync()\\n{\\n\\nvar statusChanged = await TryUpdateOrderStatusAsync(\\nOrderStatus.S\", \"ubmitted, OrderStatus.AwaitingStockValidation) ;\\n\\nif (statusChanged )\\n\\nt\\n\\nvar order = await StateMan\", \"ager.GetStateAsync<Order>(OrderDetailsStateName) ;\\n\\nawait _eventBus.PublishAsync (new\\nOrderStatusCha\", \"ngedToAwaitingStockValidationIntegrationEvent (\\nOrderlId,\\nOrderStatus.AwaitingStockValidation.Name,\\n\", \"\\\"Grace period elapsed; waiting for stock validation.\\\",\\n\\n154 CHAPTER 13 | Dapr reference application\\n\", \"order.UserName,\\norder.OrderItems\\n.Select(orderItem => new OrderStockItem(orderItem.ProductId,\\norderI\", \"tem.Units))));\\n\\ni\\n\\nThe OnGracePeriodElapsedAsync method first tries to update the order status to th\", \"e new\\nAwaitingStockValidation status. If that succeeds, it retrieves the order details from state an\", \"d\\npublishes an OrderStatusChangedToAwaitingStockValidationIntegrationEvent to inform other\\nservice o\", \"f the status change. For example, the Category service subscribes to this event to check the\\navailab\", \"le stock.\\n\\nLet's look at the TryUpdateOrderStatusAsync method to see under which circumstances it ma\", \"y fail to\\nupdate the order status:\\n\\nprivate async Task<bool> TryUpdateOrderStatusAsync(OrderStatus e\", \"xpectedOrderStatus,\\nOrderStatus newOrderStatus )\\n{\\nvar orderStatus = await\\nStateManager. TryGetState\", \"Async<OrderStatus>(OrderStatusStateName) ;\\nif (!orderStatus.HasValue)\\n{\\n_logger.LogWarning(\\n\\\"Order w\", \"ith Id: {OrderId} cannot be updated because it doesn't exist\\\",\\nOrderId);\\n\\nreturn false;\\n\\n5\\n\\nif (orde\", \"rStatus.Value.Id != expectedOrderStatus.Id)\\nt\\n\\n_logger.LogWarning(\\n\\u201cOrder with Id: {OrderId} is in s\", \"tatus {Status} instead of expected status\\n{ExpectedStatus}\\\",\\nOrderId, orderStatus.Value.Name, expect\", \"edOrderStatus.Name) ;\\n\\nreturn false;\\n\\n5\\n\\nawait StateManager.SetStateAsync(OrderStatusStateName, newO\", \"rderStatus) ;\\n\\nreturn true;\\n\\nFirst, the TryUpdateOrderStatusAsync method checks whether there even i\", \"s a current order status. If\\nthere isn't, the order doesn't exist. This is a fail-safe that should n\", \"ot happen with normal application\\nusage. Then, the method checks whether the current order status is\", \" the status that we expected.\\nRemember that the ordering process is driven by events using the Dapr \", \"pub/sub building block. Event\\ndelivery uses at-least-once semantics, so a single message could be re\", \"ceived multiple times. The order\\nstatus check ensures that even when the same message Is received mu\", \"ltiple times, it is only processed\\nonce.\\n\\nThe other steps in the ordering process are all implemente\", \"d in a very similar way to the grace period\\nstep. In the next sections, we'll look at some other asp\", \"ects of the ordering process, namely\\ncancellation and viewing order details.\\n\\n155 CHAPTER 13 | Dapr \", \"reference application\\nOrder cancellation\\n\\nCustomers are allowed to cancel any order that has not bee\", \"n paid or shipped yet. The\\nOrdersController class handles incoming order cancellations. It invokes t\", \"he CancelAsync method on\\nthe OrderingProcessActor instance for the given order.\\n\\npublic async Task<b\", \"ool> CancelAsync()\\n{\\n\\nvar orderStatus = await\\nStateManager. TryGetStateAsync<OrderStatus>(OrderStatu\", \"sStateName) ;\\nif (!orderStatus.HasValue)\\n\\nt\\n_logger.LogWarning(\\n\\\"Order with Id: {OrderId} cannot be \", \"cancelled because it doesn't exist\\\",\\nOrderId);\\nreturn false;\\n}\\n\\nif (orderStatus.Value.Id == OrderSta\", \"tus.Paid.Id || orderStatus.Value.Id ==\\nOrderStatus.Shipped.Id)\\n\\n{\\n_logger.LogWarning(\\n\\\"Order with Id\", \": {OrderId} cannot be cancelled because it's in status {Status}\\\",\\nOrderId, orderStatus.Value.Name) ;\", \"\\nreturn false;\\n}\\n\\nawait StateManager.SetStateAsync(OrderStatusStateName, OrderStatus.Cancelled) ;\\nva\", \"r order = await StateManager.GetStateAsync<Order>(OrderDetailsStateName) ;\\n\\nawait _eventBus.PublishA\", \"sync(new OrderStatusChangedToCancelledIntegrationEvent (\\nOrderld,\\nOrderStatus.Cancelled.Name,\\n$\\\"The \", \"order was cancelled by buyer.\\\",\\norder.UserName) ) ;\\n\\nreturn true;\\n\\nThe CancelAsync method consists o\", \"f the following steps:\\n\\n1. First, the method ensures that the order exists by retrieving the current\", \" order status.\\n\\n2. If the order exists, the method checks whether it\\u2019s eligible for cancellation. An\", \"y order not in the\\nPaid or Shipped state can be cancelled.\\n\\nIf the order can be cancelled, the order\", \" status is changed to Cancelled.\\n4. Lastly, the order details are retrieved from state and used to p\", \"ublish an\\nOrderStatusChangedToCancellediIntegrationEvent to inform the other services.\\n\\nThe CancelAs\", \"ync method is a great example of the usefulness of the turn-based access model of\\nactors. Nowhere in\", \" the method do we need to worry about multiple threads running at the same time.\\nTherefore, the meth\", \"od does not require any explicit locking mechanisms to be correct.\\n\\n156 CHAPTER 13 | Dapr reference \", \"application\\nOrder details\\n\\nCustomers can check the status and details of their order in the eshopOnD\", \"apr UI. They can also view\\na complete history of past orders. Directly querying actor instances for \", \"this information is a bad idea\\nbecause of two reasons:\\n\\n1. Low-latency reads cannot be guaranteed be\", \"cause actor operations execute serially.\\n\\n2. Querying across actors is inefficient because each acto\", \"r's state needs to be read individually and\\ncan introduce more unpredictable latencies.\\n\\nTo fix this\", \" issue, eShopOnDapr uses a separate read model for any queries on order data. The read\\nmodel is stor\", \"ed in a separate SQL database. An ASP.NET Core controller class named\\nUpdateOrderStatusEventControll\", \"er subscribes to the order status events and builds up the view\\nmodel. The same UpdateOrderStatusEve\", \"ntController class also sends push notifications to the UI\\nto inform the customer of order status up\", \"dates.\\n\\nThe following snippet shows the code for handling the\\nOrderStatusChangedToSubmittedIntegrati\", \"onEvent message:\\n\\n[HttpPost(\\\"OrderStatusChangedToSubmitted\\\" ) |\\n[Topic(DaprPubSubName, nameof(OrderS\", \"tatusChangedToSubmittedIntegrationEvent) ) |\\npublic async Task HandleAsync(\\nOrderStatusChangedToSubm\", \"ittedIntegrationEvent integrationEvent,\\n[FromServices] IOptions<OrderingSettings> settings,\\n[FromSer\", \"vices] IEmailService emailService)\\n\\n// Gets the order details from Actor state.\\n\\nvar actorId = new A\", \"ctorId(integrationEvent.OrderId.ToString());\\n\\nvar orderingProcess = _actorProxyFactory.CreateActorPr\", \"oxy<I0OrderingProcessActor>(\\nactorId,\\nnameof(OrderingProcessActor) ) ;\\n\\n//\\n\\nvar actorOrder = await o\", \"rderingProcess.GetOrderDetailsAsync();\\n\\nvar readModelOrder = new Order(integrationEvent.OrderId, act\", \"orOrder) ;\\n\\n// Add the order to the read model so it can be queried from the API.\\n\\n// It may already\", \" exist if this event has been handled before (at-least-once\\nsemantics).\\n\\nreadModelOrder = await _ord\", \"erRepository.AddOrGetOrderAsync(readModelOrder) ;\\n\\n// Send a SignalR notification to the client.\\nawa\", \"it SendNotificationAsync(readModelOrder.OrderNumber, integrationEvent.OrderStatus,\\nintegrationEvent.\", \"BuyerId) ;\\n\\n// Send a confirmation e-mail if enabled.\\nif (settings.Value.SendConfirmationEmail )\\n\\nt\\n\", \"}\\n\\nawait emailService.SendOrderConfirmationAsync(readModelOrder) ;\\n\\nThe handler contains the code fo\", \"r all the actions that must occur after an order is submitted\\nsuccessfully. Because the events origi\", \"nate from the OrderingProcessActor, we can be sure that any\\nvalidations performed by the actor have \", \"succeeded.\\n\\nThe handler performs the following steps:\\n\\n157 CHAPTER 13 | Dapr reference application\\n1\", \". First, the method creates an actor proxy and uses it to retrieve the order details from the actor\\n\", \"instance.\\n\\n2. The method maps the order details to the read model and stores it in the database. Due\", \" to the\\nat-least-once semantics of the Dapr pub/sub building block, the order may already exist in t\", \"he\\ndatabase. In that case, it will not be overwritten.\\n\\n3. | The method publishes a push notificatio\", \"n for the status update using SignalR.\\n\\n4. Lastly, if enabled, the method sends a confirmation e-mai\", \"l to the customer.\\n\\nSubsequent order status updates are all handled equally to each other. The follo\", \"wing snippet shows\\nwhat happens when the order status is updated to AwaitingStockValidation:\\n\\n[HttpP\", \"ost(\\\"OrderStatusChangedToAwaitingStockValidation\\u201d ) ]\\n\\n[ Topic(DaprPubSubName,\\n\\nnameof (OrderStatusC\", \"hangedToAwaitingStockValidationIntegrationEvent) ) ]\\n\\npublic Task HandleAsync(\\nOrderStatusChangedToA\", \"waitingStockValidationIntegrationEvent integrationEvent)\\n\\n{\\n// Save the updated status in the read m\", \"odel and notify the client via SignalR.\\nreturn UpdateReadModelAndSendNotificationAsync(integrationEv\", \"ent.OrderId,\\n\\nintegrationEvent.OrderStatus, integrationEvent.Description,\\nintegrationEvent.BuyerlId)\", \" ;\\n\\n5\\n\\nprivate async Task UpdateReadModelAndSendNotificationAsync (\\nGuid orderId, string orderStatus\", \", string description, string buyerId)\\n\\nt\\n\\nvar order = await _orderRepository.GetOrderByIdAsync(order\", \"Id) ;\\nif (order is not null)\\nt\\n\\norder.OrderStatus = orderStatus;\\n\\norder.Description = description;\\n\\n\", \"await _orderRepository.UpdateOrderAsync (order) ;\\nawait SendNotificationAsync(order.OrderNumber, ord\", \"erStatus, buyerId) ;\\n\\nIn the snippet, the handler calls the UpdateReadModelAndSendNotificationAsync \", \"helper method to\\nhandle the status update:\\n\\n1. The helper method first loads the current order from \", \"the database.\\n\\n2. If that succeeds, it updates the OrderStatus and Description fields and saves the \", \"updated\\nmodel back to the database.\\n\\n3. Lastly, it sends a push notification to notify the client UI\", \".\\n\\nObservability\\n\\neShopOnDapr uses Zipkin to visualize distributed traces collected by Dapr. Seq agg\", \"regates the\\neShopOnDapr application logs. The various services emit structured logging using the Ser\", \"iLog logging\\nlibrary. Serilog publishes log events to a construct called a sink. A sink is simply a \", \"target platform to\\nwhich Serilog writes its logging events. Many Serilog sinks are available, includ\", \"ing one for Seq. Seq is\\nthe Serilog sink used in eshopOnDapr.\\n\\n158 CHAPTER 13 | Dapr reference appli\", \"cation\\neShopOnDapr also includes a custom health dashboard that gives insight into the health of the\", \" eShop\\nservices. This dashboard uses the built-in health checks mechanism of ASP.NET Core. The dashb\", \"oard\\nnot only provides the health status of the services, but also the health of the dependencies of\", \" the\\nservices, including the Dapr sidecars.\\n\\nSecrets\\n\\nThe eShopOnDapr reference application uses the\", \" secrets building block for various secrets:\\n\\n\\u00b0 The password for connecting to the Redis cache.\\n\\n. T\", \"he username and password for the SMTP server.\\n\\n. The connection strings for the SQL databases.\\n\\nWhen\", \" running the application using Docker Compose, the local file secret store is used. The\\n\\ncomponent c\", \"onfiguration file eshop-secretstore.yaml is found in the dapr/components folder of\\nthe eShopOnDapr r\", \"epository:\\n\\napiVersion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: eshop-secretstore\\nnamespace\", \": eshop\\nspec:\\n\\ntype: secretstores.local.file\\n\\nversion: v1\\n\\nmetadata:\\n\\n- name: secretsFile\\nvalue: ./c\", \"omponents/eshop-secretstore. json\\nname: nestedSeparator\\nvalue: \\\".\\\"\\n\\nThe configuration file reference\", \"s the local store file eshop-secretstore. json located in the same\\nfolder:\\n\\n\\\"\\u201cConnectionStrings\\\": {\\n\", \"\\\"CatalogDB\\\": \\\"******HEKE\\\" |\\n\\\"IdentityDB\\\": \\\"*******EKKN |\\n\\\"OrderingDB\\\": \\\"********eKN\\n\\nC MES ESE SES S\", \"ES EES ES\\n\\\"Password\\\": \\\"****ERERKEN\\n}s\\n\\\"State\\\": {\\n\\\"RedisPassword\\\": \\\"**********\\\"\\n\\nThe components folde\", \"r is specified in the command-line and mounted as a local folder inside the Dapr\\nsidecar container. \", \"Here's a snippet from the docker-compose. override. yml file in the repository root\\nthat specifies t\", \"he volume mount:\\n\\ncatalog-api-dapr:\\ncommand: [\\\"./daprd\\\",\\n\\n159 CHAPTER 13 | Dapr reference applicatio\", \"n\\n\\\"-app-id\\\", \\\"\\u201ccatalog-api\\\",\\n\\u201c-app-port\\\", \\\"8\\\",\\n\\u201c-components-path\\\", \\\"/components\\\",\\n\\\"-config\\\", \\\"/confi\", \"guration/eshop-config.yaml\\\"\\n]\\nvolumes:\\n- \\\",/dapr/components/:/components\\\"\\n- \\\",/dapr/configuration/:/\", \"configuration\\\"\\n\\nThe /components volume mount and --components-path command-line argument are passed \", \"into\\nthe daprd startup command.\\n\\nOnce configured, other component configuration files can also refer\", \"ence the secrets. Here\\u2019s an\\nexample of the state store component configuration consuming secrets:\\n\\na\", \"piVersion: dapr.io/vialpha1\\nkind: Component\\nmetadata:\\nname: eshop-statestore\\nnamespace: eshop\\nspec:\\n\", \"type: state.redis\\nversion: v1\\nmetadata:\\n- name: redisHost\\nvalue: redis:6379\\nname: redisPassword\\nsecr\", \"etKeyRef:\\nname: State.RedisPassword\\nkey: State.RedisPassword\\n- name: actorStateStore\\nvalue: \\\"true\\\"\\na\", \"uth:\\nsecretStore: eshop-secretstore\\nscopes:\\n- basket-api\\n- ordering-api\\n\\nBenefits of applying Dapr t\", \"o eShop\\nIn general, the use of Dapr building blocks adds observability and flexibility to the applic\", \"ation:\\n\\n1. Observability: By using the Dapr building blocks, you gain rich distributed tracing for c\", \"alls\\nbetween services and to Dapr components without having to write any code. In\\neShopOnContainers,\", \" a large amount of custom logging is used to provide insight.\\n\\n2. Flexibility: You can now swap out \", \"infrastructure simply by changing a component configuration\\nfile. No code changes are necessary.\\n\\nHe\", \"re are some more examples of benefits offered by specific building blocks:\\n\\n\\u00b0 Service Invocation\\n\\u2014 W\", \"ith Dapr\\u2019s support for mTLS, services now communicate through encrypted channels.\\n\\n\\u2014 When transient \", \"errors occur, service calls are automatically retried.\\n\\n160 CHAPTER 13 | Dapr reference application\\n\", \"\\u2014 Automatic service discovery reduces the amount of configuration needed for services to\\nfind each o\", \"ther.\\n\\nPublish/Subscribe\\n\\n\\u2014  eShopOnContainers included a large amount of custom code to support bot\", \"h Azure\\nService Bus and RabbitMQ. Developers used Azure Service Bus for production and\\nRabbitMQ for \", \"local development and testing. An IEventBus abstraction layer was\\ncreated to enable swapping between\", \" these message brokers. This layer consisted of\\napproximately 700 lines of error-prone code. The upd\", \"ated implementation with Dapr\\nrequires only 35 lines of code. That's 5% of the original lines of cod\", \"e! More importantly,\\nthe implementation is straightforward and easy to understand.\\n\\n\\u2014  eShopOnDapr u\", \"ses Dapr\\u2019s rich ASP.NET Core integration to use pub/sub. You add Topic\\nattributes to ASP.NET Core co\", \"ntroller methods to subscribe to messages. Therefore,\\nthere\\u2019s no need to write a separate message ha\", \"ndler loop for each message broker.\\n\\n- Messages routed to the service as HTTP calls enable the use o\", \"f ASP.NET Core\\nmiddleware to add functionality, without introducing new concepts or SDKs to learn.\\n\\n\", \"Bindings\\n\\n\\u2014 The eShopOnContainers solution contained a to-do item for e-mailing an order\\nconfirmatio\", \"n to the customer. With Dapr, implementing email notification was as easy as\\nconfiguring a resource \", \"binding.\\n\\nActors\\n\\n- The actors building block makes it easy to create long running, stateful workflo\", \"ws.\\nThanks to the turn-based access model, there\\u2019s no need for explicit locking mechanisms.\\n\\n\\u2014 The c\", \"omplexity of the grace period implementation is greatly reduced by using actor\\nreminders instead of \", \"polling on the database.\\n\\nSummary\\n\\nIn this chapter, you're introduced to the eshopOnDapr reference a\", \"pplication. It's an evolution of the\\nwidely popular eShopOnContainers microservice reference applica\", \"tion. eshopOnDapr replaces a large\\n\\namount of custom functionality with Dapr building blocks and com\", \"ponents, dramatically simplifying\\n\\nthe complexities required to build a microservices application.\\n\\n\", \"References\\n\\n161\\n\\neShopOnDapr\\neShopOnContainers\\n.NET Microservices for Containerized .NET Application\", \"s\\n\\nArchitecting Cloud-Native .NET Apps for Azure\\n\\nCHAPTER 13 | Dapr reference application\\nCHAPTER | \", \"|\\n\\nSummary and the road\\nanead\\n\\nWe're at the end of our Dapr flight. The jet plane flying at 20,000 f\", \"eet from chapter 2 is on final\\napproach and about to land.\\n\\nAs the plane taxis to the gate, let's ta\", \"ke a minute to review some important conclusions from this\\nguide:\\n\\n. Dapr - Dapr is a Distributed Ap\", \"plication Runtime that streamlines how you build distributed\\napplications. It exposes an architectur\", \"e of building blocks and pluggable components. Dapr\\nprovides a dynamic glue that binds your applicat\", \"ion with infrastructure capabilities that exist in\\nthe Dapr runtime. Instead of building infrastruct\", \"ure plumbing, you and your team focus on\\ndelivering business features to customers.\\n\\n. Open source a\", \"nd cross-platform - The native Dapr API can be consumed by any platform that\\nsupports HTTP or gRPC. \", \"Dapr also provides language-specific SDKs for popular development\\nplatforms. Dapr v1.0 supports Go, \", \"Python, .NET, Java, PHP, and JavaScript.\\n\\n. Building blocks - Dapr building blocks encapsulate distr\", \"ibuted application functionality. At the\\ntime of this writing, Dapr supports the seven building bloc\", \"ks shown in figure 13-1.\\n\\n162 CHAPTER 14 | Summary and the road ahead\\nService\\ninvocation\\n\\nState\\n\\nman\", \"agement Extensibility\\n\\n <SBe |\\n\\nPublish &\\n\\nsubscribe Secrets\\n\\n(>\\n\\nDistributed\\nfh App\\nBindings Observ\", \"ability\\n-\\nActors\\n\\nFigure 13-1. Dapr building blocks.\\n\\n. Components - Dapr components provide the con\", \"crete implementation for each Dapr building\\nblock capability. They expose a common interface that en\", \"ables developers to swap out\\ncomponent implementations without changing application code. Figure 13-\", \"2 shows the\\n\\nrelationship among components, building blocks, and your service.\\n\\n163 CHAPTER 14 | Sum\", \"mary and the road ahead\\nDapr API\\n\\nHM Building\\nblocks\\n\\nComponent\\n(Redis Cache)\\n\\nComponent\\n(Azure Serv\", \"ice Bus)\\n\\nFigure 13-2. Dapr building block integration.\\n\\nYour\\nservice\\n\\n. Sidecars - Dapr runs alongs\", \"ide your application in a sidecar architecture, either as a separate\\nprocess of a container. Your ap\", \"plication communicates with the Dapr APIs over HTTP and gRPC.\\nSidecars provide isolation and encapsu\", \"lation as they aren't part of the service, but connected to\\n\\nit. Figure 13-3 shows a sidecar archite\", \"cture.\\n\\nSidecar\\n\\nDapr API\\n\\nBuilding\\nblocks\\n\\nComponent\\n{Redis Cache)\\n\\nComponent\\n(Azure Service Bus)\\n\\n\", \"Figure 13-3. Sidecar architecture.\\n\\n164\\n\\nPrimary service\\n\\nYour\\nservice\\n\\nee\\n\\nCHAPTER 14 | Summary and\", \" the road ahead\\n\\u00b0 Hosting environments Dapr has cross-platform support and can run in multiple envir\", \"onments.\\n\\nAt the time of this writing, the environments include a local self-hosted mode and Kuberne\", \"tes.\\n\\n\\u00b0 eShopOnDapr - This book includes an accompanying reference application entitled\\neShopOnDapr.\", \" Using a popular e-commerce application domain, the reference application\\ndemonstrates the usage of \", \"each building block. It's an evolution of the widely popular\\neShopOnContainers, released several yea\", \"rs ago.\\n\\nThe road ahead\\n\\nLooking forward, Dapr has the potential to have a profound impact on distri\", \"buted application\\n\\ndevelopment. What can you expect from the Dapr team and its open-source contribut\", \"ors?\\n\\nAt the time of writing, the list of proposed enhancements for Dapr include:\\n\\n. Feature enhance\", \"ments to existing building blocks:\\n\\nQuery capabilities in state management enabling you to retrieve \", \"multiple values.\\nTopic filtering in pub/sub enabling you to filter topics based on their content.\\n\\nA\", \"n application tracing API in observability that provides tracing in the application\\ndirectly without\", \" having to bind to specific libraries.\\n\\nBinding and pub/sub support for actors providing event drive\", \"n capabilities to the actor\\nprogramming model. Bound components will trigger events and messages inv\", \"oke\\nmethods in the actor.\\n\\n. New building blocks:\\n\\nConfiguration API building block for reading and \", \"writing configuration data. The block\\nwill bind to providers that include Azure Configuration Manage\", \"r or GCP Configuration\\nManagement.\\n\\nHttp scale-to-zero autoscale.\\n\\nLeader election building block to\", \" provide singleton instances and locking semantic\\ncapabilities.\\n\\nTransparent proxying building block\", \" for service invocation, enabling you to route\\nmessages based on URLs or DNS addresses at the networ\", \"k level.\\n\\nResiliency building block (circuit breakers, bulkheads & timeouts).\\n\\n. Integration with fr\", \"ameworks and cloud native technologies. Some examples include:\\n\\nDjango\\nNodejs\\nExpress\\nKyma\\nMidway\\n\\n\\u00b0\", \" New language SDKs:\\n\\n165\\n\\nJavaScript\\nRUST\\n\\nC++\\n\\nCHAPTER 14 | Summary and the road ahead\\n. New hostin\", \"g platforms:\\n\\u2014 VMs\\n\\u2014 Azure loT Edge\\n\\u2014 Azure Stack Edge\\n\\u2014 Azure Service Fabric\\n. Developer and operat\", \"or productivity tooling:\\n\\u2014 VS Code extension.\\n- Remote Dev Containers for local debugging a DevOps p\", \"ipeline development.\\n- Dapr operational dashboard enhancements that will provide deeper visibility i\", \"nto the\\n\\noperational concerns of managing Dapr applications.\\n\\nDapr version 1.0 provides developers w\", \"ith a compelling toolbox for building distributed applications.\\nAs the proposed enhancement list sho\", \"ws, Dapr is under active development with many new\\ncapabilities to come. Stay tuned to the Dapr site\", \" and Dapr announcement blog for future updates.\\n\\n166 CHAPTER 14 | Summary and the road ahead\\n\"]"