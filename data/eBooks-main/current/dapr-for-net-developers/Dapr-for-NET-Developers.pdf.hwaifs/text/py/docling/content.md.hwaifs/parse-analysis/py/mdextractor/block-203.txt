[HttpPost("OrderStatusChangedToSubmitted")] [Topic(DaprPubSubName, nameof(OrderStatusChangedToSubmittedIntegrationEvent))] public async Task HandleAsync( OrderStatusChangedToSubmittedIntegrationEvent integrationEvent, [FromServices] IOptions<OrderingSettings> settings, [FromServices] IEmailService emailService) { // Gets the order details from Actor state. var actorId = new ActorId(integrationEvent.OrderId.ToString()); var orderingProcess = _actorProxyFactory.CreateActorProxy<IOrderingProcessActor>( actorId, nameof(OrderingProcessActor)); // var actorOrder = await orderingProcess.GetOrderDetailsAsync(); var readModelOrder = new Order(integrationEvent.OrderId, actorOrder); // Add the order to the read model so it can be queried from the API. // It may already exist if this event has been handled before (at-least-once semantics). readModelOrder = await _orderRepository.AddOrGetOrderAsync(readModelOrder); // Send a SignalR notification to the client. await SendNotificationAsync(readModelOrder.OrderNumber, integrationEvent.OrderStatus, integrationEvent.BuyerId); // Send a confirmation e-mail if enabled. if (settings.Value.SendConfirmationEmail) { await emailService.SendOrderConfirmationAsync(readModelOrder); } }