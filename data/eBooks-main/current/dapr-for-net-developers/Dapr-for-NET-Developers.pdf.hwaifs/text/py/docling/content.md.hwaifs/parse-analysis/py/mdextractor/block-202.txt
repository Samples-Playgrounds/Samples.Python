public async Task<bool> CancelAsync() { var orderStatus = await StateManager.TryGetStateAsync<OrderStatus>(OrderStatusStateName); if (!orderStatus.HasValue) { _logger.LogWarning( "Order with Id: {OrderId} cannot be cancelled because it doesn't exist", OrderId); return false ; } if (orderStatus.Value.Id == OrderStatus.Paid.Id || orderStatus.Value.Id == OrderStatus.Shipped.Id) { _logger.LogWarning( "Order with Id: {OrderId} cannot be cancelled because it's in status {Status}", OrderId, orderStatus.Value.Name); return false ; } await StateManager.SetStateAsync(OrderStatusStateName, OrderStatus.Cancelled); var order = await StateManager.GetStateAsync<Order>(OrderDetailsStateName); await _eventBus.PublishAsync( new OrderStatusChangedToCancelledIntegrationEvent( OrderId, OrderStatus.Cancelled.Name, $"The order was cancelled by buyer.", order.UserName)); return true ; }