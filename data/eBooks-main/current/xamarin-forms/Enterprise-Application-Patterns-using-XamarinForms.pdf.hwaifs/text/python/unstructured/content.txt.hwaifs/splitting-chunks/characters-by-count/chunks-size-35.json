"[\"Book title\\n\\nBook subtitle\\n\\nAuthor Name\\n\\nPUBLISHED BY\\n\\nDevDiv, .NET and Visual Studio produc teams A \", \"division of Microsoft Corporation One Microsoft Way Redmond, Washington 98052-6399\\n\\nCopyright \\u00a9 2017\", \" by Microsoft Corporation\\n\\nAll rights reserved. No part of the contents of this book may be reproduc\", \"ed or transmitted in any form or by any means without the written permission of the publisher.\\n\\nThis\", \" book is provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The views, opinions and inf\", \"ormation expressed in this book, including URL and other Internet website references, may change wit\", \"hout notice.\\n\\nSome examples depicted herein are provided for illustration only and are fictitious. N\", \"o real association or connection is intended or should be inferred.\\n\\nMicrosoft and the trademarks li\", \"sted at http://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are trademarks of the Microsoft group o\", \"f companies. All other marks are property of their respective owners.\\n\\nAuthor: David Britch Develope\", \"r: Javier Suarez Ruiz (Plain Concepts) Participants and reviewers: Craig Dunn, Tom Opgenorth Editor:\", \" John Meade (Populus Group)\\n\\nContents\\n\\nPreface .....................................................\", \"...................................................................... iv Purpose ..................\", \"....................................................................................................\", \"............ iv What's left out of this guide's scope ..............................................\", \"................................................ iv Who should use this guide ......................\", \"....................................................................................... iv How to us\", \"e this guide .......................................................................................\", \"............................... v\\n\\nIntroduction ....................................................\", \"................................................................ 1 Sample application ..............\", \"....................................................................................................\", \". 2 Sample application architecture.................................................................\", \"..................................... 2 Mobile app .................................................\", \"...................................................................................... 4 eShopOnCont\", \"ainers.Core project.................................................................................\", \".................. 5 Platform projects .............................................................\", \"............................................................... 6 Summary ..........................\", \"....................................................................................................\", \"... 6\\n\\nMVVM ........................................................................................\", \"..................................... 7 The MVVM pattern ...........................................\", \"....................................................................... 7 View .....................\", \"....................................................................................................\", \"........................ 8 ViewModel ...............................................................\", \"........................................................................ 8 Model ...................\", \"....................................................................................................\", \"........................ 9 Connecting view models to views .........................................\", \".................................................... 9 Creating a view model declaratively .........\", \"....................................................................................10 Creating a vi\", \"ew model programmatically ..........................................................................\", \"...........10 Creating a view defined as a data template ...........................................\", \".......................................11 Automatically creating a view model with a view model loca\", \"tor .................................................11 Updating views in response to changes in the\", \" underlying view model or model ....................... 12 UI interaction using commands and behavio\", \"rs ........................................................................ 13 Implementing commands\", \" ...................................................................................................\", \"...........14 Implementing behaviors ...............................................................\", \".................................................15 Summary ........................................\", \"....................................................................................... 17\\n\\nDependen\", \"cy injection .......................................................................................\", \"............. 18 Introduction to dependency injection ..............................................\", \"....................................... 18 Registration ............................................\", \"............................................................................... 20 Resolution ......\", \"....................................................................................................\", \".................... 22 Managing the lifetime of resolved objects ..................................\", \"............................................. 22 Summary ...........................................\", \".................................................................................... 23\\n\\ni\\n\\nCommunic\", \"ating between loosely coupled components .................................................. 24 Intro\", \"duction to MessagingCenter .........................................................................\", \"................... 24 Defining a message...........................................................\", \"...................................................... 26 Publishing a message .....................\", \"......................................................................................... 26 Subscri\", \"bing to a message ..................................................................................\", \"...................... 27 Unsubscribing from a message..............................................\", \".................................................. 27 Summary ......................................\", \"......................................................................................... 27\\n\\nNaviga\", \"tion ...............................................................................................\", \"...................... 28 Navigating between pages .................................................\", \"..................................................... 29 Creating the NavigationService instance ...\", \"....................................................................................29 Handling navi\", \"gation requests ....................................................................................\", \"....................30 Navigating when the app is launched .........................................\", \"..................................................32 Passing parameters during navigation ..........\", \"................................................................................33 Invoking navigati\", \"on using behaviors .................................................................................\", \"............34 Confirming or cancelling navigation .................................................\", \".............................................34 Summary ............................................\", \"................................................................................... 35\\n\\nValidation .\", \"....................................................................................................\", \"................. 36 Specifying validation rules ...................................................\", \"................................................... 37 Adding validation rules to a property .......\", \"............................................................................... 38 Triggering valida\", \"tion ...............................................................................................\", \"................ 39 Triggering validation manually .................................................\", \".....................................................39 Triggering validation when properties change\", \"..............................................................................40 Displaying validati\", \"on errors ..........................................................................................\", \".......... 40 Highlighting a control that contains invalid data ....................................\", \"......................................41 Displaying error messages .................................\", \"............................................................................44 Summary .............\", \"....................................................................................................\", \".............. 45\\n\\nConfiguration management ........................................................\", \"................................... 46 Creating a settings class ...................................\", \"....................................................................... 46 Adding a setting ........\", \"....................................................................................................\", \"......... 47 Data binding to user settings .........................................................\", \"......................................... 48 Summary ...............................................\", \"................................................................................ 50\\n\\nContainerized m\", \"icroservices .......................................................................................\", \".... 51 Microservices ..............................................................................\", \"........................................... 52 Containerization ....................................\", \"................................................................................. 53 Communication b\", \"etween client and microservices .................................................................. 5\", \"5 Communication between microservices ..............................................................\", \".................... 56 Summary ....................................................................\", \"........................................................... 58\\n\\nAuthentication and authorization ...\", \"............................................................................... 59 Authentication ..\", \"....................................................................................................\", \"................. 59 Issuing bearer tokens using IdentityServer 4 ..................................\", \"..............................................60 Adding IdentityServer to a web application ........\", \"..........................................................................60 Configuring IdentitySer\", \"ver ................................................................................................\", \"............61\\n\\nii\\n\\nPerforming authentication ......................................................\", \"......................................................64 Authorization .............................\", \"............................................................................................ 69 Conf\", \"iguring IdentityServer to perform authorization ....................................................\", \"...............70 Making access requests to APIs ...................................................\", \"..................................................71 Summary .......................................\", \"........................................................................................ 71\\n\\nAccessi\", \"ng remote data .....................................................................................\", \".............. 73 Introduction to Representational State Transfer...................................\", \"................................... 73 Consuming RESTful APIs ......................................\", \"................................................................... 74 Making web requests .........\", \"....................................................................................................\", \".......74 Caching data .............................................................................\", \"............................................. 81 Managing data expiration ..........................\", \"...................................................................................82 Caching images\", \" ...................................................................................................\", \"...........................82 Increasing resilience ................................................\", \"............................................................... 83 Retry pattern ...................\", \"....................................................................................................\", \"..........83 Circuit breaker pattern ...............................................................\", \"...................................................84 Summary ......................................\", \"......................................................................................... 85\\n\\nUnit t\", \"esting .............................................................................................\", \"....................... 86 Dependency injection and unit testing ...................................\", \"................................................. 86 Testing MVVM applications .....................\", \"............................................................................... 87 Testing asynchron\", \"ous functionality...................................................................................\", \"............88 Testing INotifyPropertyChanged implementations.......................................\", \"................................88 Testing message-based communication .............................\", \"..........................................................89 Testing exception handling ............\", \"................................................................................................89 T\", \"esting validation ..................................................................................\", \"........................................90 Summary .................................................\", \".............................................................................. 91\\n\\niii\\n\\nPreface\\n\\nPur\", \"pose\\n\\nThis eBook provides guidance on building cross-platform enterprise apps using Xamarin.Forms. X\", \"amarin.Forms is a cross-platform UI toolkit that allows developers to easily create native user inte\", \"rface layouts that can be shared across platforms, including iOS, Android, and the Universal Windows\", \" Platform (UWP). It provides a comprehensive solution for Business to Employee (B2E), Business to Bu\", \"siness (B2B), and Business to Consumer (B2C) apps, providing the ability to share code across all ta\", \"rget platforms and helping to lower the total cost of ownership (TCO).\\n\\nThe guide provides architect\", \"ural guidance for developing adaptable, maintainable, and testable Xamarin.Forms enterprise apps. Gu\", \"idance is provided on how to implement MVVM, dependency injection, navigation, validation, and confi\", \"guration management, while maintaining loose coupling. In addition, there's also guidance on perform\", \"ing authentication and authorization with IdentityServer, accessing data from containerized microser\", \"vices, and unit testing.\\n\\nThe guide comes with source code for the eShopOnContainers mobile app, and\", \" source code for the eShopOnContainers reference app. The eShopOnContainers mobile app is a cross-pl\", \"atform enterprise app developed using Xamarin.Forms, which connects to a series of containerized mic\", \"roservices known as the eShopOnContainers reference app. However, the eShopOnContainers mobile app c\", \"an be configured to consume data from mock services for those who wish to avoid deploying the contai\", \"nerized microservices.\\n\\nWhat's left out of this guide's scope\\n\\nThis guide is aimed at readers who ar\", \"e already familiar with Xamarin.Forms. For a detailed introduction to Xamarin.Forms, see the Xamarin\", \".Forms documentation on the Xamarin Developer Center, and Creating Mobile Apps with Xamarin.Forms.\\n\\n\", \"The guide is complementary to .NET Microservices: Architecture for Containerized .NET Applications, \", \"which focuses on developing and deploying containerized microservices. Other guides worth reading in\", \"clude Architecting and Developing Modern Web Applications with ASP.NET Core and Microsoft Azure, Con\", \"tainerized Docker Application Lifecycle with Microsoft Platform and Tools, and Microsoft Platform an\", \"d Tools for Mobile App Development.\\n\\nWho should use this guide\\n\\nThe audience for this guide is mainl\", \"y developers and architects who would like to learn how to architect and implement cross-platform en\", \"terprise apps using Xamarin.Forms.\\n\\niv\\n\\nPreface\\n\\nA secondary audience is technical decision makers w\", \"ho would like to receive an architectural and technology overview before deciding on what approach t\", \"o select for cross-platform enterprise app development using Xamarin.Forms.\\n\\nHow to use this guide\\n\\n\", \"This guide focuses on building cross-platform enterprise apps using Xamarin.Forms. As such, it shoul\", \"d be read in its entirety to provide a foundation of understanding such apps and their technical con\", \"siderations. The guide, along with its sample app, can also serve as a starting point or reference f\", \"or creating a new enterprise app. Use the associated sample app as a template for the new app, or to\", \" see how to organize an app's component parts. Then, refer back to this guide for architectural guid\", \"ance.\\n\\nFeel free to forward this guide to team members to help ensure a common understanding of cros\", \"s- platform enterprise app development using Xamarin.Forms. Having everybody working from a common s\", \"et of terminologies and underlying principles will help ensure a consistent application of architect\", \"ural patterns and practices.\\n\\nv\\n\\nPreface\\n\\nC H A P T E R\\n\\n1\\n\\nIntroduction\\n\\nRegardless of platform, de\", \"velopers of enterprise apps face several challenges:\\n\\nApp requirements that can change over time.\\n\\nN\", \"ew business opportunities and challenges.\\n\\nOngoing feedback during development that can significantl\", \"y affect the scope and requirements of the app.\\n\\nWith these in mind, it's important to build apps th\", \"at can be easily modified or extended over time. Designing for such adaptability can be difficult as\", \" it requires an architecture that allows individual parts of the app to be independently developed a\", \"nd tested in isolation without affecting the rest of the app.\\n\\nMany enterprise apps are sufficiently\", \" complex to require more than one developer. It can be a significant challenge to decide how to desi\", \"gn an app so that multiple developers can work effectively on different pieces of the app independen\", \"tly, while ensuring that the pieces come together seamlessly when integrated into the app.\\n\\nThe trad\", \"itional approach to designing and building an app results in what is referred to as a monolithic app\", \", where components are tightly coupled with no clear separation between them. Typically, this monoli\", \"thic approach leads to apps that are difficult and inefficient to maintain, because it can be diffic\", \"ult to resolve bugs without breaking other components in the app, and it can be difficult to add new\", \" features or to replace existing features.\\n\\nAn effective remedy for these challenges is to partition\", \" an app into discrete, loosely coupled components that can be easily integrated together into an app\", \". Such an approach offers several benefits:\\n\\n\\n\\nIt allows individual functionality to be developed, t\", \"ested, extended, and maintained by different individuals or teams.\\n\\n\\n\\nIt promotes reuse and a clean \", \"separation of concerns between the app's horizontal capabilities, such as authentication and data ac\", \"cess, and the vertical capabilities, such as app specific business functionality. This allows the de\", \"pendencies and interactions between app components to be more easily managed.\\n\\n\\n\\nIt helps maintain a\", \" separation of roles by allowing different individuals, or teams, to focus on a specific task or pie\", \"ce of functionality according to their expertise. In particular, it provides a cleaner separation be\", \"tween the user interface and the app's business logic.\\n\\nHowever, there are many issues that must be \", \"resolved when partitioning an app into discrete, loosely coupled components. These include:\\n\\nDecidin\", \"g how to provide a clean separation of concerns between the user interface controls and their logic.\", \" One of the most important decisions when creating a Xamarin.Forms enterprise app is whether to plac\", \"e business logic in code-behind files, or whether to create a clean separation of concerns between t\", \"he user interface controls and their logic, in order to\\n\\n1\\n\\nC HA PTER 1 | Introduction\\n\\nmake the app\", \" more maintainable and testable. For more information, see Model-View- ViewModel.\\n\\nDetermining wheth\", \"er to use a dependency injection container. Dependency injection containers reduce the dependency co\", \"upling between objects by providing a facility to construct instances of classes with their dependen\", \"cies injected, and manage their lifetime based on the configuration of the container. For more infor\", \"mation, see Dependency injection.\\n\\nChoosing between platform provided eventing and loosely coupled m\", \"essage-based communication between components that are inconvenient to link by object and type refer\", \"ences. For more information, see Introduction to Communicating between loosely coupled components.\\n\\n\", \"Deciding how to navigate between pages, including how to invoke navigation, and where navigation log\", \"ic should reside. For more information, see Navigation.\\n\\nDetermining how to validate user input for \", \"correctness. The decision must include how to validate user input, and how to notify the user about \", \"validation errors. For more information, see Validation.\\n\\nDeciding how to perform authentication, an\", \"d how to protect resources with authorization. For more information, see Authentication and authoriz\", \"ation.\\n\\nDetermining how to access remote data from web services, including how to reliably retrieve \", \"data, and how to cache data. For more information, see Accessing remote data.\\n\\nDeciding how to test \", \"the app. For more information, see Unit testing.\\n\\nThis guide provides guidance on these issues, and \", \"focuses on the core patterns and architecture for building a cross-platform enterprise app using Xam\", \"arin.Forms. The guidance aims to help to produce adaptable, maintainable, and testable code, by addr\", \"essing common Xamarin.Forms enterprise app development scenarios, and by separating the concerns of \", \"presentation, presentation logic, and entities through support for the Model-View-ViewModel (MVVM) p\", \"attern.\\n\\nSample application\\n\\nThis guide includes a sample application, eShopOnContainers, that's an \", \"online store that includes the following functionality:\\n\\nAuthenticating and authorizing against a ba\", \"ckend service.\\n\\nBrowsing a catalog of shirts, coffee mugs, and other marketing items.\\n\\n\\n\\nFiltering t\", \"he catalog.\\n\\nOrdering items from the catalog.\\n\\nViewing the user's order history.\\n\\nConfiguration of s\", \"ettings.\\n\\nSample application architecture\\n\\nFigure 1-1 provides a high-level overview of the architec\", \"ture of the sample application.\\n\\n2\\n\\nC HA PTER 1 | Introduction\\n\\nFigure 1-1: eShopOnContainers high-l\", \"evel architecture\\n\\nThe sample application ships with three client apps:\\n\\nAn MVC application develope\", \"d with ASP.NET Core.\\n\\nA Single Page Application (SPA) developed with Angular 2 and Typescript. This \", \"approach for web applications avoids performing a round-trip to the server with each operation.\\n\\nA m\", \"obile app developed with Xamarin.Forms, which supports iOS, Android, and the Universal Windows Platf\", \"orm (UWP).\\n\\nFor information about the web applications, see Architecting and Developing Modern Web A\", \"pplications with ASP.NET Core and Microsoft Azure.\\n\\nThe sample application includes the following ba\", \"ckend services:\\n\\nAn identity microservice, which uses ASP.NET Core Identity and IdentityServer.\\n\\nA c\", \"atalog microservice, which is a data-driven create, read, update, delete (CRUD) service that consume\", \"s an SQL Server database using EntityFramework Core.\\n\\nAn ordering microservice, which is a domain-dr\", \"iven service that uses domain-driven design patterns.\\n\\nA basket microservice, which is a data-driven\", \" CRUD service that uses Redis Cache.\\n\\nThese backend services are implemented as microservices using \", \"ASP.NET Core MVC, and are deployed as unique containers within a single Docker host. Collectively, t\", \"hese backend services are referred to as the eShopOnContainers reference application. Client apps co\", \"mmunicate with the backend services through a Representational State Transfer (REST) web interface. \", \"For more information about microservices and Docker, see Containerized microservices.\\n\\nFor informati\", \"on about the implementation of the backend services, see .NET Microservices: Architecture for Contai\", \"nerized .NET Applications.\\n\\n3\\n\\nC HA PTER 1 | Introduction\\n\\nMobile app\\n\\nThis guide focuses on buildin\", \"g cross-platform enterprise apps using Xamarin.Forms, and uses the eShopOnContainers mobile app as a\", \"n example. Figure 1-2 shows the pages from the eShopOnContainers mobile app that provide the functio\", \"nality outlined earlier.\\n\\nFigure 1-2: The eShopOnContainers mobile app\\n\\nThe mobile app consumes the \", \"backend services provided by the eShopOnContainers reference application. However, it can be configu\", \"red to consume data from mock services for those who wish to avoid deploying the backend services.\\n\\n\", \"The eShopOnContainers mobile app exercises the following Xamarin.Forms functionality:\\n\\nXAML\\n\\nControl\", \"s\\n\\nBindings\\n\\nConverters\\n\\nStyles\\n\\n4\\n\\nC HA PTER 1 | Introduction\\n\\nAnimations\\n\\nCommands\\n\\nBehaviors\\n\\nTri\", \"ggers\\n\\nEffects\\n\\nCustom Renderers\\n\\nMessagingCenter\\n\\nCustom Controls\\n\\nFor more information about this \", \"functionality, see the Xamarin.Forms documentation on the Xamarin Developer Center, and Creating Mob\", \"ile Apps with Xamarin.Forms.\\n\\nIn addition, unit tests are provided for some of the classes in the eS\", \"hopOnContainers mobile app.\\n\\nMobile app solution\\n\\nThe eShopOnContainers mobile app solution organize\", \"s the source code and other resources into projects. All of the projects use folders to organize the\", \" source code and other resources into categories. The following table outlines the projects that mak\", \"e up the eShopOnContainers mobile app:\\n\\nProject\\n\\nDescription\\n\\neShopOnContainers.Core\\n\\neShopOnContain\", \"ers.Droid\\n\\neShopOnContainers.iOS\\n\\neShopOnContainers.UWP\\n\\neShopOnContainers.TestRunner.Droid\\n\\neShopOn\", \"Containers.TestRunner.iOS\\n\\nThis project is the portable class library (PCL) project that contains th\", \"e shared code and shared UI. This project holds Android specific code and is the entry point for the\", \" Android app. This project holds iOS specific code and is the entry point for the iOS app. This proj\", \"ect holds Universal Windows Platform (UWP) specific code and is the entry point for the Windows app.\", \" This project is the Android test runner for the eShopOnContainers.UnitTests project. This project i\", \"s the iOS test runner for the eShopOnContainers.UnitTests project.\\n\\neShopOnContainers.TestRunner.Win\", \"dows This project is the Universal Windows Platform test\\n\\neShopOnContainers.UnitTests\\n\\nrunner for th\", \"e eShopOnContainers.UnitTests project. This project contains unit tests for the eShopOnContainers.Co\", \"re project.\\n\\nThe classes from the eShopOnContainers mobile app can be re-used in any Xamarin.Forms a\", \"pp with little or no modification.\\n\\neShopOnContainers.Core project\\n\\nThe eShopOnContainers.Core PCL p\", \"roject contains the following folders:\\n\\n5\\n\\nC HA PTER 1 | Introduction\\n\\nFolder\\n\\nDescription\\n\\nAnimatio\", \"ns Behaviors Controls Converters Effects\\n\\nExceptions Extensions Helpers Models Properties Services\\n\\n\", \"Triggers\\n\\nValidations ViewModels Contains the application logic that's exposed to pages. Views\\n\\nCont\", \"ains classes that enable animations to be consumed in XAML. Contains behaviors that are exposed to v\", \"iew classes. Contains custom controls used by the app. Contains value converters that apply custom l\", \"ogic to a binding. Contains the EntryLineColorEffect class, which is used to change the border color\", \" of specific Entry controls. Contains the custom ServiceAuthenticationException. Contains extension \", \"methods for the VisualElement and IEnumerable<T> classes. Contains helper classes for the app. Conta\", \"ins the model classes for the app. Contains AssemblyInfo.cs, a .NET assembly metadata file. Contains\", \" interfaces and classes that implement services that are provided to the app. Contains the BeginAnim\", \"ation trigger, which is used to invoke an animation in XAML. Contains classes involved in validating\", \" data input.\\n\\nContains the pages for the app.\\n\\nPlatform projects\\n\\nThe platform projects contain effe\", \"ct implementations, custom renderer implementations, and other platform-specific resources.\\n\\nSummary\", \"\\n\\nXamarin's cross-platform mobile app development tools and platforms provide a comprehensive soluti\", \"on for B2E, B2B, and B2C mobile client apps, providing the ability to share code across all target p\", \"latforms (iOS, Android, and Windows) and helping to lower the total cost of ownership. Apps can shar\", \"e their user interface and app logic code, while retaining the native platform look and feel.\\n\\nDevel\", \"opers of enterprise apps face several challenges that can alter the architecture of the app during d\", \"evelopment. Therefore, it's important to build an app so that it can be modified or extended over ti\", \"me. Designing for such adaptability can be difficult, but typically involves partitioning an app int\", \"o discrete, loosely coupled components that can be easily integrated together into an app.\\n\\n6\\n\\nC HA \", \"PTER 1 | Introduction\\n\\nC H A P T E R\\n\\n2\\n\\nMVVM\\n\\nThe Xamarin.Forms developer experience typically invo\", \"lves creating a user interface in XAML, and then adding code-behind that operates on the user interf\", \"ace. As apps are modified, and grow in size and scope, complex maintenance issues can arise. These i\", \"ssues include the tight coupling between the UI controls and the business logic, which increases the\", \" cost of making UI modifications, and the difficulty of unit testing such code.\\n\\nThe Model-View-View\", \"Model (MVVM) pattern helps to cleanly separate the business and presentation logic of an application\", \" from its user interface (UI). Maintaining a clean separation between application logic and the UI h\", \"elps to address numerous development issues and can make an application easier to test, maintain, an\", \"d evolve. It can also greatly improve code re-use opportunities and allows developers and UI designe\", \"rs to more easily collaborate when developing their respective parts of an app.\\n\\nThe MVVM pattern\\n\\nT\", \"here are three core components in the MVVM pattern: the model, the view, and the view model. Each se\", \"rves a distinct purpose. Figure 2-1 shows the relationships between the three components.\\n\\nFigure 2-\", \"1: The MVVM pattern\\n\\nIn addition to understanding the responsibilities of each components, it's also\", \" important to understand how they interact with each other. At a high level, the view \\\"knows about\\\" \", \"the view model, and the view model \\\"knows about\\\" the model, but the model is unaware of the view mod\", \"el, and the view model is unaware of the view. Therefore, the view model isolates the view from the \", \"model, and allows the model to evolve independently of the view.\\n\\nThe benefits of using the MVVM pat\", \"tern are as follows:\\n\\n\\n\\nIf there's an existing model implementation that encapsulates existing busin\", \"ess logic, it can be difficult or risky to change it. In this scenario, the view model acts as an ad\", \"apter for the model classes and enables you to avoid making any major changes to the model code.\\n\\n7\\n\", \"\\nC HA PTER 2 | MVVM\\n\\nDevelopers can create unit tests for the view model and the model, without usin\", \"g the view. The unit tests for the view model can exercise exactly the same functionality as used by\", \" the view.\\n\\nThe app UI can be redesigned without touching the code, provided that the view is implem\", \"ented entirely in XAML. Therefore, a new version of the view should work with the existing view mode\", \"l.\\n\\nDesigners and developers can work independently and concurrently on their components during the \", \"development process. Designers can focus on the view, while developers can work on the view model an\", \"d model components.\\n\\nThe key to using MVVM effectively lies in understanding how to factor app code \", \"into the correct classes, and in understanding how the classes interact. The following sections disc\", \"uss the responsibilities of each of the classes in the MVVM pattern.\\n\\nView\\n\\nThe view is responsible \", \"for defining the structure, layout, and appearance of what the user sees on screen. Ideally, each vi\", \"ew is defined in XAML, with a limited code-behind that does not contain business logic. However, in \", \"some cases, the code-behind might contain UI logic that implements visual behavior that is difficult\", \" to express in XAML, such as animations.\\n\\nIn a Xamarin.Forms application, a view is typically a Page\", \"-derived or ContentView-derived class. However, views can also be represented by a data template, wh\", \"ich specifies the UI elements to be used to visually represent an object when it's displayed. A data\", \" template as a view does not have any code-behind, and is designed to bind to a specific view model \", \"type.\\n\\nTip: Avoid enabling and disabling UI elements in the code-behind\\n\\nEnsure that view models are\", \" responsible for defining logical state changes that affect some aspects of the view's display, such\", \" as whether a command is available, or an indication that an operation is pending. Therefore, enable\", \" and disable UI elements by binding to view model properties, rather than enabling and disabling the\", \"m in code-behind.\\n\\nThere are several options for executing code on the view model in response to int\", \"eractions on the view, such as a button click or item selection. If a control supports commands, the\", \" control's Command property can be data-bound to an ICommand property on the view model. When the co\", \"ntrol's command is invoked, the code in the view model will be executed. In addition to commands, be\", \"haviors can be attached to an object in the view and can listen for either a command to be invoked o\", \"r event to be raised. In response, the behavior can then invoke an ICommand on the view model or a m\", \"ethod on the view model.\\n\\nViewModel\\n\\nThe view model implements properties and commands to which the \", \"view can data bind to, and notifies the view of any state changes through change notification events\", \". The properties and commands that the view model provides define the functionality to be offered by\", \" the UI, but the view determines how that functionality is to be displayed.\\n\\nTip: Keep the UI respon\", \"sive with asynchronous operations\\n\\nMobile apps should keep the UI thread unblocked to improve the us\", \"er's perception of performance. Therefore, in the view model, use asynchronous methods for I/O opera\", \"tions and raise events to asynchronously notify views of property changes.\\n\\n8\\n\\nC HA PTER 2 | MVVM\\n\\nT\", \"he view model is also responsible for coordinating the view's interactions with any model classes th\", \"at are required. There's typically a one-to-many relationship between the view model and the model c\", \"lasses. The view model might choose to expose model classes directly to the view so that controls in\", \" the view can data bind directly to them. In this case, the model classes will need to be designed t\", \"o support data binding and change notification events.\\n\\nEach view model provides data from a model i\", \"n a form that the view can easily consume. To accomplish this, the view model sometimes performs dat\", \"a conversion. Placing this data conversion in the view model is a good idea because it provides prop\", \"erties that the view can bind to. For example, the view model might combine the values of two proper\", \"ties to make it easier for display by the view.\\n\\nTip: Centralize data conversions in a conversion la\", \"yer\\n\\nIt's also possible to use converters as a separate data conversion layer that sits between the \", \"view model and the view. This can be necessary, for example, when data requires special formatting t\", \"hat the view model doesn't provide.\\n\\nIn order for the view model to participate in two-way data bind\", \"ing with the view, its properties must raise the PropertyChanged event. View models satisfy this req\", \"uirement by implementing the INotifyPropertyChanged interface, and raising the PropertyChanged event\", \" when a property is changed.\\n\\nFor collections, the view-friendly ObservableCollection<T> is provided\", \". This collection implements collection changed notification, relieving the developer from having to\", \" implement the INotifyCollectionChanged interface on collections.\\n\\nModel\\n\\nModel classes are non-visu\", \"al classes that encapsulate the app's data. Therefore, the model can be thought of as representing t\", \"he app's domain model, which usually includes a data model along with business and validation logic.\", \" Examples of model objects include data transfer objects (DTOs), Plain Old CLR Objects (POCOs), and \", \"generated entity and proxy objects.\\n\\nModel classes are typically used in conjunction with services o\", \"r repositories that encapsulate data access and caching.\\n\\nConnecting view models to views\\n\\nView mode\", \"ls can be connected to views by using the data-binding capabilities of Xamarin.Forms. There are many\", \" approaches that can be used to construct views and view models and associate them at runtime. These\", \" approaches fall into two categories, known as view first composition, and view model first composit\", \"ion. Choosing between view first composition and view model first composition is an issue of prefere\", \"nce and complexity. However, all approaches share the same aim, which is for the view to have a view\", \" model assigned to its BindingContext property.\\n\\nWith view first composition the app is conceptually\", \" composed of views that connect to the view models they depend on. The primary benefit of this appro\", \"ach is that it makes it easy to construct loosely coupled, unit testable apps because the view model\", \"s have no dependence on the views themselves. It's also easy to understand the structure of the app \", \"by following its visual structure, rather than having to track code execution to understand how clas\", \"ses are created and associated. In addition, view first construction aligns with the Xamarin.Forms n\", \"avigation system that's responsible for constructing pages when navigation occurs, which makes a vie\", \"w model first composition complex and misaligned with the platform.\\n\\n9\\n\\nC HA PTER 2 | MVVM\\n\\nWith vie\", \"w model first composition the app is conceptually composed of view models, with a service being resp\", \"onsible for locating the view for a view model. View model first composition feels more natural to s\", \"ome developers, since the view creation can be abstracted away, allowing them to focus on the logica\", \"l non-UI structure of the app. In addition, it allows view models to be created by other view models\", \". However, this approach is often complex and it can become difficult to understand how the various \", \"parts of the app are created and associated.\\n\\nTip: Keep view models and views independent\\n\\nThe bindi\", \"ng of views to a property in a data source should be the view's principal dependency on its correspo\", \"nding view model. Specifically, don't reference view types, such as Button and ListView, from view m\", \"odels. By following the principles outlined here, view models can be tested in isolation, therefore \", \"reducing the likelihood of software defects by limiting scope.\\n\\nThe following sections discuss the m\", \"ain approaches to connecting view models to views.\\n\\nCreating a view model declaratively\\n\\nThe simples\", \"t approach is for the view to declaratively instantiate its corresponding view model in XAML. When t\", \"he view is constructed, the corresponding view model object will also be constructed. This approach \", \"is demonstrated in the following code example:\\n\\n<ContentPage ... xmlns:local=\\\"clr-namespace:eShop\\\"> \", \"<ContentPage.BindingContext> <local:LoginViewModel /> </ContentPage.BindingContext> ... </ContentPag\", \"e>\\n\\nWhen the ContentPage is created, an instance of the LoginViewModel is automatically constructed \", \"and set as the view's BindingContext.\\n\\nThis declarative construction and assignment of the view mode\", \"l by the view has the advantage that it's simple, but has the disadvantage that it requires a defaul\", \"t (parameter-less) constructor in the view model.\\n\\nCreating a view model programmatically\\n\\nA view ca\", \"n have code in the code-behind file that results in the view model being assigned to its BindingCont\", \"ext property. This is often accomplished in the view's constructor, as shown in the following code e\", \"xample:\\n\\npublic LoginView() { InitializeComponent(); BindingContext = new LoginViewModel(navigationS\", \"ervice); }\\n\\nThe programmatic construction and assignment of the view model within the view's code-be\", \"hind has the advantage that it's simple. However, the main disadvantage of this approach is that the\", \" view needs to provide the view model with any required dependencies. Using a dependency injection c\", \"ontainer can help to maintain loose coupling between the view and view model. For more information, \", \"see Dependency injection.\\n\\n10\\n\\nC HA PTER 2 | MVVM\\n\\nCreating a view defined as a data template\\n\\nA vie\", \"w can be defined as a data template and associated with a view model type. Data templates can be def\", \"ined as resources, or they can be defined inline within the control that will display the view model\", \". The content of the control is the view model instance, and the data template is used to visually r\", \"epresent it. This technique is an example of a situation in which the view model is instantiated fir\", \"st, followed by the creation of the view.\\n\\nAutomatically creating a view model with a view model loc\", \"ator\\n\\nA view model locator is a custom class that manages the instantiation of view models and their\", \" association to views. In the eShopOnContainers mobile app, the ViewModelLocator class has an attach\", \"ed property, AutoWireViewModel, that's used to associate view models with views. In the view's XAML,\", \" this attached property is set to true to indicate that the view model should be automatically conne\", \"cted to the view, as shown in the following code example:\\n\\nviewModelBase:ViewModelLocator.AutoWireVi\", \"ewModel=\\\"true\\\"\\n\\nThe AutoWireViewModel property is a bindable property that's initialized to false, a\", \"nd when its value changes the OnAutoWireViewModelChanged event handler is called. This method resolv\", \"es the view model for the view. The following code example shows how this is achieved:\\n\\nprivate stat\", \"ic void OnAutoWireViewModelChanged(BindableObject bindable, object oldValue, object n ewValue) { var\", \" view = bindable as Element; if (view == null) { return; }\\n\\nvar viewType = view.GetType(); var viewN\", \"ame = viewType.FullName.Replace(\\\".Views.\\\", \\\".ViewModels.\\\"); var viewAssemblyName = viewType.GetTypeI\", \"nfo().Assembly.FullName; var viewModelName = string.Format( CultureInfo.InvariantCulture, \\\"{0}Model,\", \" {1}\\\", viewName, viewAssemblyName);\\n\\nvar viewModelType = Type.GetType(viewModelName); if (viewModelT\", \"ype == null) { return; } var viewModel = _container.Resolve(viewModelType); view.BindingContext = vi\", \"ewModel; }\\n\\nThe OnAutoWireViewModelChanged method attempts to resolve the view model using a convent\", \"ion- based approach. This convention assumes that:\\n\\nView models are in the same assembly as view typ\", \"es.\\n\\nViews are in a .Views child namespace.\\n\\nView models are in a .ViewModels child namespace.\\n\\nView\", \" model names correspond with view names and end with \\\"ViewModel\\\".\\n\\n11\\n\\nC HA PTER 2 | MVVM\\n\\nFinally, \", \"the OnAutoWireViewModelChanged method sets the BindingContext of the view type to the resolved view \", \"model type. For more information about resolving the view model type, see Resolution.\\n\\nThis approach\", \" has the advantage that an app has a single class that is responsible for the instantiation of view \", \"models and their connection to views.\\n\\nTip: Use a view model locator for ease of substitution\\n\\nA vie\", \"w model locator can also be used as a point of substitution for alternate implementations of depende\", \"ncies, such as for unit testing or design time data.\\n\\nUpdating views in response to changes in the u\", \"nderlying view model or model\\n\\nAll view model and model classes that are accessible to a view should\", \" implement the INotifyPropertyChanged interface. Implementing this interface in a view model or mode\", \"l class allows the class to provide change notifications to any data-bound controls in the view when\", \" the underlying property value changes.\\n\\nApp's should be architected for the correct use of property\", \" change notification, by meeting the following requirements:\\n\\nAlways raising a PropertyChanged event\", \" if a public property's value changes. Do not assume that raising the PropertyChanged event can be i\", \"gnored because of knowledge of how XAML binding occurs.\\n\\nAlways raising a PropertyChanged event for \", \"any calculated properties whose values are used by other properties in the view model or model.\\n\\nAlw\", \"ays raising the PropertyChanged event at the end of the method that makes a property change, or when\", \" the object is known to be in a safe state. Raising the event interrupts the operation by invoking t\", \"he event's handlers synchronously. If this happens in the middle of an operation, it might expose th\", \"e object to callback functions when it is in an unsafe, partially updated state. In addition, it's p\", \"ossible for cascading changes to be triggered by PropertyChanged events. Cascading changes generally\", \" require updates to be complete before the cascading change is safe to execute.\\n\\nNever raising a Pro\", \"pertyChanged event if the property does not change. This means that you must compare the old and new\", \" values before raising the PropertyChanged event.\\n\\nNever raising the PropertyChanged event during a \", \"view model's constructor if you are initializing a property. Data-bound controls in the view will no\", \"t have subscribed to receive change notifications at this point.\\n\\nNever raising more than one Proper\", \"tyChanged event with the same property name argument within a single synchronous invocation of a pub\", \"lic method of a class. For example, given a NumberOfItems property whose backing store is the _numbe\", \"rOfItems field, if a method increments _numberOfItems fifty times during the execution of a loop, it\", \" should only raise property change notification on the NumberOfItems property once, after all the wo\", \"rk is complete. For asynchronous methods, raise the PropertyChanged event for a given property name \", \"in each synchronous segment of an asynchronous continuation chain.\\n\\nThe eShopOnContainers mobile app\", \" uses the ExtendedBindableObject class to provide change notifications, which is shown in the follow\", \"ing code example:\\n\\n12\\n\\nC HA PTER 2 | MVVM\\n\\npublic abstract class ExtendedBindableObject : BindableOb\", \"ject { public void RaisePropertyChanged<T>(Expression<Func<T>> property) { var name = GetMemberInfo(\", \"property).Name; OnPropertyChanged(name); }\\n\\nprivate MemberInfo GetMemberInfo(Expression expression) \", \"{ ... } }\\n\\nXamarin.Form's BindableObject class implements the INotifyPropertyChanged interface, and \", \"provides an OnPropertyChanged method. The ExtendedBindableObject class provides the RaisePropertyCha\", \"nged method to invoke property change notification, and in doing so uses the functionality provided \", \"by the BindableObject class.\\n\\nEach view model class in the eShopOnContainers mobile app derives from\", \" the ViewModelBase class, which in turn derives from the ExtendedBindableObject class. Therefore, ea\", \"ch view model class uses the RaisePropertyChanged method in the ExtendedBindableObject class to prov\", \"ide property change notification. The following code example shows how the eShopOnContainers mobile \", \"app invokes property change notification by using a lambda expression:\\n\\npublic bool IsLogin { get { \", \"return _isLogin; } set { _isLogin = value; RaisePropertyChanged(() => IsLogin); } }\\n\\nNote that using\", \" a lambda expression in this way involves a small performance cost because the lambda expression has\", \" to be evaluated for each call. Although the performance cost is small and would not normally impact\", \" an app, the costs can accrue when there are many change notifications. However, the benefit of this\", \" approach is that it provides compile-time type safety and refactoring support when renaming propert\", \"ies.\\n\\nUI interaction using commands and behaviors\\n\\nIn mobile apps, actions are typically invoked in \", \"response to a user action, such as a button click, that can be implemented by creating an event hand\", \"ler in the code-behind file. However, in the MVVM pattern, the responsibility for implementing the a\", \"ction lies with the view model, and placing code in the code-behind should be avoided.\\n\\nCommands pro\", \"vide a convenient way to represent actions that can be bound to controls in the UI. They encapsulate\", \" the code that implements the action, and help to keep it decoupled from its visual representation i\", \"n the view. Xamarin.Forms includes controls that can be declaratively connected to a command, and th\", \"ese controls will invoke the command when the user interacts with the control.\\n\\n13\\n\\nC HA PTER 2 | MV\", \"VM\\n\\nBehaviors also allow controls to be declaratively connected to a command. However, behaviors can\", \" be used to invoke an action that's associated with a range of events raised by a control. Therefore\", \", behaviors address many of the same scenarios as command-enabled controls, while providing a greate\", \"r degree of flexibility and control. In addition, behaviors can also be used to associate command ob\", \"jects or methods with controls that were not specifically designed to interact with commands.\\n\\nImple\", \"menting commands\\n\\nView models typically expose command properties, for binding from the view, that a\", \"re object instances that implement the ICommand interface. A number of Xamarin.Forms controls provid\", \"e a Command property, which can be data bound to an ICommand object provided by the view model. The \", \"ICommand interface defines an Execute method, which encapsulates the operation itself, a CanExecute \", \"method, which indicates whether the command can be invoked, and a CanExecuteChanged event that occur\", \"s when changes occur that affect whether the command should execute. The Command and Command<T> clas\", \"ses, provided by Xamarin.Forms, implement the ICommand interface, where T is the type of the argumen\", \"ts to Execute and CanExecute.\\n\\nWithin a view model, there should be an object of type Command or Com\", \"mand<T> for each public property in the view model of type ICommand. The Command or Command<T> const\", \"ructor requires an Action callback object that's called when the ICommand.Execute method is invoked.\", \" The CanExecute method is an optional constructor parameter, and is a Func that returns a bool.\\n\\nThe\", \" following code shows how a Command instance, which represents a register command, is constructed by\", \" specifying a delegate to the Register view model method:\\n\\npublic ICommand RegisterCommand => new Co\", \"mmand(Register);\\n\\nThe command is exposed to the view through a property that returns a reference to \", \"an ICommand. When the Execute method is called on the Command object, it simply forwards the call to\", \" the method in the view model via the delegate that was specified in the Command constructor.\\n\\nAn as\", \"ynchronous method can be invoked by a command by using the async and await keywords when specifying \", \"the command's Execute delegate. This indicates that the callback is a Task and should be awaited. Fo\", \"r example, the following code shows how a Command instance, which represents a sign-in command, is c\", \"onstructed by specifying a delegate to the SignInAsync view model method:\\n\\npublic ICommand SignInCom\", \"mand => new Command(async () => await SignInAsync());\\n\\nParameters can be passed to the Execute and C\", \"anExecute actions by using the Command<T> class to instantiate the command. For example, the followi\", \"ng code shows how a Command<T> instance is used to indicate that the NavigateAsync method will requi\", \"re an argument of type string:\\n\\npublic ICommand NavigateCommand => new Command<string>(NavigateAsync\", \");\\n\\nIn both the Command and Command<T> classes, the delegate to the CanExecute method in each constr\", \"uctor is optional. If a delegate isn't specified, the Command will return true for CanExecute. Howev\", \"er, the view model can indicate a change in the command's CanExecute status by calling the ChangeCan\", \"Execute method on the Command object. This causes the CanExecuteChanged event to be raised. Any cont\", \"rols in the UI that are bound to the command will then update their enabled status to reflect the av\", \"ailability of the data-bound command.\\n\\n14\\n\\nC HA PTER 2 | MVVM\\n\\nInvoking commands from a view\\n\\nThe fo\", \"llowing code example shows how a Grid in the LoginView binds to the RegisterCommand in the LoginView\", \"Model class by using a TapGestureRecognizer instance:\\n\\n<Grid Grid.Column=\\\"1\\\" HorizontalOptions=\\\"Cent\", \"er\\\"> <Label Text=\\\"REGISTER\\\" TextColor=\\\"Gray\\\"/> <Grid.GestureRecognizers> <TapGestureRecognizer Comma\", \"nd=\\\"{Binding RegisterCommand}\\\" NumberOfTapsRequired=\\\"1\\\" /> </Grid.GestureRecognizers> </Grid>\\n\\nA com\", \"mand parameter can also be optionally defined using the CommandParameter property. The type of the e\", \"xpected argument is specified in the Execute and CanExecute target methods. The TapGestureRecognizer\", \" will automatically invoke the target command when the user interacts with the attached control. The\", \" command parameter, if provided, will be passed as the argument to the command's Execute delegate.\\n\\n\", \"Implementing behaviors\\n\\nBehaviors allow functionality to be added to UI controls without having to s\", \"ubclass them. Instead, the functionality is implemented in a behavior class and attached to the cont\", \"rol as if it was part of the control itself. Behaviors enable you to implement code that you would n\", \"ormally have to write as code-behind, because it directly interacts with the API of the control, in \", \"such a way that it can be concisely attached to the control, and packaged for reuse across more than\", \" one view or app. In the context of MVVM, behaviors are a useful approach for connecting controls to\", \" commands.\\n\\nA behavior that's attached to a control through attached properties is known as an attac\", \"hed behavior. The behavior can then use the exposed API of the element to which it is attached to ad\", \"d functionality to that control, or other controls, in the visual tree of the view. The eShopOnConta\", \"iners mobile app contains the LineColorBehavior class, which is an attached behavior. For more infor\", \"mation about this behavior, see Displaying validation errors.\\n\\nA Xamarin.Forms behavior is a class t\", \"hat derives from the Behavior or Behavior<T> class, where T is the type of the control to which the \", \"behavior should apply. These classes provide OnAttachedTo and OnDetachingFrom methods, which should \", \"be overridden to provide logic that will be executed when the behavior is attached to and detached f\", \"rom controls.\\n\\nIn the eShopOnContainers mobile app, the BindableBehavior<T> class derives from the B\", \"ehavior<T> class. The purpose of the BindableBehavior<T> class is to provide a base class for Xamari\", \"n.Forms behaviors that require the BindingContext of the behavior to be set to the attached control.\", \"\\n\\nThe BindableBehavior<T> class provides an overridable OnAttachedTo method that sets the BindingCon\", \"text of the behavior, and an overridable OnDetachingFrom method that cleans up the BindingContext. I\", \"n addition, the class stores a reference to the attached control in the AssociatedObject property.\\n\\n\", \"The eShopOnContainers mobile app includes an EventToCommandBehavior class, which executes a command \", \"in response to an event occurring. This class derives from the BindableBehavior<View> class so that \", \"the behavior can bind to and execute an ICommand specified by a Command property when the behavior i\", \"s consumed. The following code example shows the EventToCommandBehavior class:\\n\\n15\\n\\nC HA PTER 2 | MV\", \"VM\\n\\npublic class EventToCommandBehavior : BindableBehavior<View> { ... protected override void OnAtt\", \"achedTo(View visualElement) { base.OnAttachedTo(visualElement);\\n\\nvar events = AssociatedObject.GetTy\", \"pe().GetRuntimeEvents().ToArray(); if (events.Any()) { _eventInfo = events.FirstOrDefault(e => e.Nam\", \"e == EventName); if (_eventInfo == null) throw new ArgumentException(string.Format( \\\"EventToCommand:\", \" Can't find any event named '{0}' on attached type\\\", EventName));\\n\\nAddEventHandler(_eventInfo, Assoc\", \"iatedObject, OnFired); } }\\n\\nprotected override void OnDetachingFrom(View view) { if (_handler != nul\", \"l) _eventInfo.RemoveEventHandler(AssociatedObject, _handler);\\n\\nbase.OnDetachingFrom(view); }\\n\\nprivat\", \"e void AddEventHandler( EventInfo eventInfo, object item, Action<object, EventArgs> action) { ... }\\n\", \"\\nprivate void OnFired(object sender, EventArgs eventArgs) { ... } }\\n\\nThe OnAttachedTo and OnDetachin\", \"gFrom methods are used to register and deregister an event handler for the event defined in the Even\", \"tName property. Then, when the event fires, the OnFired method is invoked, which executes the comman\", \"d.\\n\\nThe advantage of using the EventToCommandBehavior to execute a command when an event fires, is t\", \"hat commands can be associated with controls that weren't designed to interact with commands. In add\", \"ition, this moves event-handling code to view models, where it can be unit tested.\\n\\nInvoking behavio\", \"rs from a view\\n\\nThe EventToCommandBehavior is particularly useful for attaching a command to a contr\", \"ol that doesn't support commands. For example, the ProfileView uses the EventToCommandBehavior to ex\", \"ecute the OrderDetailCommand when the ItemTapped event fires on the ListView that lists the user's o\", \"rders, as shown in the following code:\\n\\n<ListView> <ListView.Behaviors> <behaviors:EventToCommandBeh\", \"avior EventName=\\\"ItemTapped\\\" Command=\\\"{Binding OrderDetailCommand}\\\" EventArgsConverter=\\\"{StaticResou\", \"rce ItemTappedEventArgsConverter}\\\" />\\n\\n16\\n\\nC HA PTER 2 | MVVM\\n\\n</ListView.Behaviors> ... </ListView>\", \"\\n\\nAt runtime, the EventToCommandBehavior will respond to interaction with the ListView. When an item\", \" is selected in the ListView, the ItemTapped event will fire, which will execute the OrderDetailComm\", \"and in the ProfileViewModel. By default, the event arguments for the event are passed to the command\", \". This data is converted as it's passed between source and target by the converter specified in the \", \"EventArgsConverter property, which returns the Item of the ListView from the ItemTappedEventArgs. Th\", \"erefore, when the OrderDetailCommand is executed, the selected Order is passed as a parameter to the\", \" registered Action.\\n\\nFor more information about behaviors, see Behaviors on the Xamarin Developer Ce\", \"nter.\\n\\nSummary\\n\\nThe Model-View-ViewModel (MVVM) pattern helps to cleanly separate the business and p\", \"resentation logic of an application from its user interface (UI). Maintaining a clean separation bet\", \"ween application logic and the UI helps to address numerous development issues and can make an appli\", \"cation easier to test, maintain, and evolve. It can also greatly improve code re-use opportunities a\", \"nd allows developers and UI designers to more easily collaborate when developing their respective pa\", \"rts of an app.\\n\\nUsing the MVVM pattern, the UI of the app and the underlying presentation and busine\", \"ss logic is separated into three separate classes: the view, which encapsulates the UI and UI logic;\", \" the view model, which encapsulates presentation logic and state; and the model, which encapsulates \", \"the app's business logic and data.\\n\\n17\\n\\nC HA PTER 2 | MVVM\\n\\nC H A P T E R\\n\\n3\\n\\nDependency injection\\n\\n\", \"Typically, a class constructor is invoked when instantiating an object, and any values that the obje\", \"ct needs are passed as arguments to the constructor. This is an example of dependency injection, and\", \" specifically is known as constructor injection. The dependencies the object needs are injected into\", \" the constructor.\\n\\nBy specifying dependencies as interface types, dependency injection enables decou\", \"pling of the concrete types from the code that depends on these types. It generally uses a container\", \" that holds a list of registrations and mappings between interfaces and abstract types, and the conc\", \"rete types that implement or extend these types.\\n\\nThere are also other types of dependency injection\", \", such as property setter injection, and method call injection, but they are less commonly seen. The\", \"refore, this chapter will focus solely on performing constructor injection with a dependency injecti\", \"on container.\\n\\nIntroduction to dependency injection\\n\\nDependency injection is a specialized version o\", \"f the Inversion of Control (IoC) pattern, where the concern being inverted is the process of obtaini\", \"ng the required dependency. With dependency injection, another class is responsible for injecting de\", \"pendencies into an object at runtime. The following code example shows how the ProfileViewModel clas\", \"s is structured when using dependency injection:\\n\\npublic class ProfileViewModel : ViewModelBase { pr\", \"ivate IOrderService _orderService;\\n\\npublic ProfileViewModel(IOrderService orderService) { _orderServ\", \"ice = orderService; } ... }\\n\\nThe ProfileViewModel constructor receives an IOrderService instance as \", \"an argument, injected by another class. The only dependency in the ProfileViewModel class is on the \", \"interface type. Therefore, the ProfileViewModel class doesn't have any knowledge of the class that's\", \" responsible for instantiating the IOrderService object. The class that's responsible for instantiat\", \"ing the\\n\\n18\\n\\nC HA PTER 3 | Dependency injection\\n\\nIOrderService object, and inserting it into the Pro\", \"fileViewModel class, is known as the dependency injection container.\\n\\nDependency injection container\", \"s reduce the coupling between objects by providing a facility to instantiate class instances and man\", \"age their lifetime based on the configuration of the container. During the objects creation, the con\", \"tainer injects any dependencies that the object requires into it. If those dependencies have not yet\", \" been created, the container creates and resolves their dependencies first.\\n\\nNote: Dependency inject\", \"ion can also be implemented manually using factories. However, using a container provides additional\", \" capabilities such as lifetime management, and registration through assembly scanning.\\n\\nThere are se\", \"veral advantages to using a dependency injection container:\\n\\nA container removes the need for a clas\", \"s to locate its dependencies and manage their lifetimes.\\n\\nA container allows mapping of implemented \", \"dependencies without affecting the class.\\n\\nA container facilitates testability by allowing dependenc\", \"ies to be mocked.\\n\\nA container increases maintainability by allowing new classes to be easily added \", \"to the app.\\n\\nIn the context of a Xamarin.Forms app that uses MVVM, a dependency injection container \", \"will typically be used for registering and resolving view models, and for registering services and i\", \"njecting them into view models.\\n\\nThere are many dependency injection containers available, with the \", \"eShopOnContainers mobile app using Autofac to manage the instantiation of view model and service cla\", \"sses in the app. Autofac facilitates building loosely coupled apps, and provides all of the features\", \" commonly found in dependency injection containers, including methods to register type mappings and \", \"object instances, resolve objects, manage object lifetimes, and inject dependent objects into constr\", \"uctors of objects that it resolves. For more information about Autofac, see Autofac on readthedocs.i\", \"o.\\n\\nIn Autofac, the IContainer interface provides the dependency injection container. Figure 3-1 sho\", \"ws the dependencies when using this container, which instantiates an IOrderService object and inject\", \"s it into the ProfileViewModel class.\\n\\nFigure 3-1: Dependencies when using dependency injection\\n\\n19\\n\", \"\\nC HA PTER 3 | Dependency injection\\n\\nAt runtime, the container must know which implementation of the\", \" IOrderService interface it should instantiate, before it can instantiate a ProfileViewModel object.\", \" This involves:\\n\\nThe container deciding how to instantiate an object that implements the IOrderServi\", \"ce interface. This is known as registration.\\n\\nThe container instantiating the object that implements\", \" the IOrderService interface, and the ProfileViewModel object. This is known as resolution.\\n\\nEventua\", \"lly, the app will finish using the ProfileViewModel object and it will become available for garbage \", \"collection. At this point, the garbage collector should dispose of the IOrderService instance if oth\", \"er classes do not share the same instance.\\n\\nTip: Write container-agnostic code\\n\\nAlways try to write \", \"container-agnostic code to decouple the app from the specific dependency container being used.\\n\\nRegi\", \"stration\\n\\nBefore dependencies can be injected into an object, the types of the dependencies must fir\", \"st be registered with the container. Registering a type typically involves passing the container an \", \"interface and a concrete type that implements the interface.\\n\\nThere are two ways of registering type\", \"s and objects in the container through code:\\n\\nRegister a type or mapping with the container. When re\", \"quired, the container will build an instance of the specified type.\\n\\nRegister an existing object in \", \"the container as a singleton. When required, the container will return a reference to the existing o\", \"bject.\\n\\nTip: Dependency injection containers are not always suitable\\n\\nDependency injection introduce\", \"s additional complexity and requirements that might not be appropriate or useful to small apps. If a\", \" class does not have any dependencies, or is not a dependency for other types, it might not make sen\", \"se to put it in the container. In addition, if a class has a single set of dependencies that are int\", \"egral to the type and will never change, it might not make sense to put it in the container.\\n\\nThe re\", \"gistration of types that require dependency injection should be performed in a single method in an a\", \"pp, and this method should be invoked early in the app's lifecycle to ensure that the app is aware o\", \"f the dependencies between its classes. In the eShopOnContainers mobile app this is performed by the\", \" ViewModelLocator class, which builds the IContainer object and is the only class in the app that ho\", \"lds a reference to that object. The following code example shows how the eShopOnContainers mobile ap\", \"p declares the IContainer object in the ViewModelLocator class:\\n\\nprivate static IContainer _containe\", \"r;\\n\\nTypes and instances are registered in the RegisterDependencies method in the ViewModelLocator cl\", \"ass. This is achieved by first creating a ContainerBuilder instance, which is demonstrated in the fo\", \"llowing code example:\\n\\nvar builder = new ContainerBuilder();\\n\\n20\\n\\nC HA PTER 3 | Dependency injection\", \"\\n\\nTypes and instances are then registered with the ContainerBuilder object, and the following code e\", \"xample demonstrates the most common form of type registration:\\n\\nbuilder.RegisterType<RequestProvider\", \">().As<IRequestProvider>();\\n\\nThe RegisterType method shown here maps an interface type to a concrete\", \" type. It tells the container to instantiate a RequestProvider object when it instantiates an object\", \" that requires an injection of an IRequestProvider through a constructor.\\n\\nConcrete types can also b\", \"e registered directly without a mapping from an interface type, as shown in the following code examp\", \"le:\\n\\nbuilder.RegisterType<ProfileViewModel>();\\n\\nWhen the ProfileViewModel type is resolved, the cont\", \"ainer will inject its required dependencies.\\n\\nAutofac also allows instance registration, where the c\", \"ontainer is responsible for maintaining a reference to a singleton instance of a type. For example, \", \"the following code example shows how the eShopOnContainers mobile app registers the concrete type to\", \" use when a ProfileViewModel instance requires an IOrderService instance:\\n\\nbuilder.RegisterType<Orde\", \"rService>().As<IOrderService>().SingleInstance();\\n\\nThe RegisterType method shown here maps an interf\", \"ace type to a concrete type. The SingleInstance method configures the registration so that every dep\", \"endent object receives the same shared instance. Therefore, only a single OrderService instance will\", \" exist in the container, which is shared by objects that require an injection of an IOrderService th\", \"rough a constructor.\\n\\nInstance registration can also be performed with the RegisterInstance method, \", \"which is demonstrated in the following code example:\\n\\nbuilder.RegisterInstance(new OrderMockService(\", \")).As<IOrderService>();\\n\\nThe RegisterInstance method shown here creates a new OrderMockService insta\", \"nce and registers it with the container. Therefore, only a single OrderMockService instance exists i\", \"n the container, which is shared by objects that require an injection of an IOrderService through a \", \"constructor.\\n\\nFollowing type and instance registration, the IContainer object must be built, which i\", \"s demonstrated in the following code example:\\n\\n_container = builder.Build();\\n\\nInvoking the Build met\", \"hod on the ContainerBuilder instance builds a new dependency injection container that contains the r\", \"egistrations that have been made.\\n\\nTip: Consider an IContainer as being immutable\\n\\nWhile Autofac pro\", \"vides an Update method to update registrations in an existing container, calling this method should \", \"be avoided where possible. There are risks to modifying a container after it's been built, particula\", \"rly if the container has been used. For more information, see Consider a Container as Immutable on r\", \"eadthedocs.io.\\n\\n21\\n\\nC HA PTER 3 | Dependency injection\\n\\nResolution\\n\\nAfter a type is registered, it c\", \"an be resolved or injected as a dependency. When a type is being resolved and the container needs to\", \" create a new instance, it injects any dependencies into the instance.\\n\\nGenerally, when a type is re\", \"solved, one of three things happens:\\n\\n1.\\n\\nIf the type hasn't been registered, the container throws a\", \"n exception.\\n\\n2.\\n\\nIf the type has been registered as a singleton, the container returns the singleto\", \"n instance. If this is the first time the type is called for, the container creates it if required, \", \"and maintains a reference to it.\\n\\n3.\\n\\nIf the type hasn't been registered as a singleton, the contain\", \"er returns a new instance, and doesn't maintain a reference to it.\\n\\nThe following code example shows\", \" how the RequestProvider type that was previously registered with Autofac can be resolved:\\n\\nvar requ\", \"estProvider = _container.Resolve<IRequestProvider>();\\n\\nIn this example, Autofac is asked to resolve \", \"the concrete type for the IRequestProvider type, along with any dependencies. Typically, the Resolve\", \" method is called when an instance of a specific type is required. For information about controlling\", \" the lifetime of resolved objects, see Managing the lifetime of resolved objects.\\n\\nThe following cod\", \"e example shows how the eShopOnContainers mobile app instantiates view model types and their depende\", \"ncies:\\n\\nvar viewModel = _container.Resolve(viewModelType);\\n\\nIn this example, Autofac is asked to res\", \"olve the view model type for a requested view model, and the container will also resolve any depende\", \"ncies. When resolving the ProfileViewModel type, the dependency to resolve is an IOrderService objec\", \"t. Therefore, Autofac first constructs an OrderService object and then passes it to the constructor \", \"of the ProfileViewModel class. For more information about how the eShopOnContainers mobile app const\", \"ructs view models and associates them to views, see Automatically creating a view model with a view \", \"model locator.\\n\\nNote: Registering and resolving types with a container has a performance cost becaus\", \"e of the container's use of reflection for creating each type, especially if dependencies are being \", \"reconstructed for each page navigation in the app. If there are many or deep dependencies, the cost \", \"of creation can increase significantly.\\n\\nManaging the lifetime of resolved objects\\n\\nAfter registerin\", \"g a type, the default behavior for Autofac is to create a new instance of the registered type each t\", \"ime the type is resolved, or when the dependency mechanism injects instances into other classes. In \", \"this scenario, the container doesn't hold a reference to the resolved object. However, when register\", \"ing an instance, the default behavior for Autofac is to manage the lifetime of the object as a singl\", \"eton. Therefore, the instance remains in scope while the container is in scope, and is disposed when\", \" the container goes out of scope and is garbage collected, or when code explicitly disposes the cont\", \"ainer.\\n\\n22\\n\\nC HA PTER 3 | Dependency injection\\n\\nAn Autofac instance scope can be used to specify the\", \" singleton behavior for an object that Autofac creates from a registered type. Autofac instance scop\", \"es manage the object lifetimes instantiated by the container. The default instance scope for the Reg\", \"isterType method is the InstancePerDependency scope. However, the SingleInstance scope can be used w\", \"ith the RegisterType method, so that the container creates or returns a singleton instance of a type\", \" when calling the Resolve method. The following code example shows how Autofac is instructed to crea\", \"te a singleton instance of the NavigationService class:\\n\\nbuilder.RegisterType<NavigationService>().A\", \"s<INavigationService>().SingleInstance();\\n\\nThe first time that the INavigationService interface is r\", \"esolved, the container creates a new NavigationService object and maintains a reference to it. On an\", \"y subsequent resolutions of the INavigationService interface, the container returns a reference to t\", \"he NavigationService object that was previously created.\\n\\nNote: The SingleInstance scope disposes cr\", \"eated objects when the container is disposed.\\n\\nAutofac includes additional instance scopes. For more\", \" information, see Instance Scope on readthedocs.io.\\n\\nSummary\\n\\nDependency injection enables decouplin\", \"g of concrete types from the code that depends on these types. It typically uses a container that ho\", \"lds a list of registrations and mappings between interfaces and abstract types, and the concrete typ\", \"es that implement or extend these types.\\n\\nAutofac facilitates building loosely coupled apps, and pro\", \"vides all of the features commonly found in dependency injection containers, including methods to re\", \"gister type mappings and object instances, resolve objects, manage object lifetimes, and inject depe\", \"ndent objects into constructors of objects it resolves.\\n\\n23\\n\\nC HA PTER 3 | Dependency injection\\n\\nC H\", \" A P T E R\\n\\n4\\n\\nCommunicating between loosely coupled components\\n\\nThe publish-subscribe pattern is a \", \"messaging pattern in which publishers send messages without having knowledge of any receivers, known\", \" as subscribers. Similarly, subscribers listen for specific messages, without having knowledge of an\", \"y publishers.\\n\\nEvents in .NET implement the publish-subscribe pattern, and are the most simple and s\", \"traightforward approach for a communication layer between components if loose coupling is not requir\", \"ed, such as a control and the page that contains it. However, the publisher and subscriber lifetimes\", \" are coupled by object references to each other, and the subscriber type must have a reference to th\", \"e publisher type. This can create memory management issues, especially when there are short lived ob\", \"jects that subscribe to an event of a static or long-lived object. If the event handler isn't remove\", \"d, the subscriber will be kept alive by the reference to it in the publisher, and this will prevent \", \"or delay the garbage collection of the subscriber.\\n\\nIntroduction to MessagingCenter\\n\\nThe Xamarin.For\", \"ms MessagingCenter class implements the publish-subscribe pattern, allowing message-based communicat\", \"ion between components that are inconvenient to link by object and type references. This mechanism a\", \"llows publishers and subscribers to communicate without having a reference to each other, helping to\", \" reduce dependencies between components, while also allowing components to be independently develope\", \"d and tested.\\n\\nThe MessagingCenter class provides multicast publish-subscribe functionality. This me\", \"ans that there can be multiple publishers that publish a single message, and there can be multiple s\", \"ubscribers listening for the same message. Figure 4-1 illustrates this relationship:\\n\\n24\\n\\nC HA PTER \", \"4 | Communicating between loosely coupled components\\n\\nFigure 4-1: Multicast publish-subscribe functi\", \"onality\\n\\nPublishers send messages using the MessagingCenter.Send method, while subscribers listen fo\", \"r messages using the MessagingCenter.Subscribe method. In addition, subscribers can also unsubscribe\", \" from message subscriptions, if required, with the MessagingCenter.Unsubscribe method.\\n\\nInternally, \", \"the MessagingCenter class uses weak references. This means that it will not keep objects alive, and \", \"will allow them to be garbage collected. Therefore, it should only be necessary to unsubscribe from \", \"a message when a class no longer wishes to receive the message.\\n\\nThe eShopOnContainers mobile app us\", \"es the MessagingCenter class to communicate between loosely coupled components. The app defines thre\", \"e messages:\\n\\nThe AddProduct message is published by the CatalogViewModel class when an item is added\", \" to the shopping basket. In return, the BasketViewModel class subscribes to the message and incremen\", \"ts the number of items in the shopping basket in response. In addition, the BasketViewModel class al\", \"so unsubscribes from this message.\\n\\nThe Filter message is published by the CatalogViewModel class wh\", \"en the user applies a brand or type filter to the items displayed from the catalogue. In return, the\", \" CatalogView class subscribes to the message and updates the UI so that only items that match the fi\", \"lter criteria are displayed.\\n\\nThe ChangeTab message is published by the MainViewModel class when the\", \" CheckoutViewModel navigates to the MainViewModel following the successful creation and submission o\", \"f a new order. In return, the MainView class subscribes to the message and updates the UI so that th\", \"e My profile tab is active, to show the user's orders.\\n\\nNote: While the MessagingCenter class permit\", \"s communication between loosely-coupled classes, it does not offer the only architectural solution t\", \"o this issue. For example, communication between a view model and a view can also be achieved by the\", \" binding engine and through property change notifications. In addition, communication between two vi\", \"ew models can also be achieved by passing data during navigation.\\n\\nIn the eShopOnContainers mobile a\", \"pp, MessagingCenter is used to update in the UI in response to an action occurring in another class.\", \" Therefore, messages are published on the UI thread, with subscribers receiving the message on the s\", \"ame thread.\\n\\n25\\n\\nC HA PTER 4 | Communicating between loosley coupled components\\n\\nTip: Marshal to the\", \" UI thread when performing UI updates\\n\\nIf a message that's sent from a background thread is required\", \" to update the UI, process the message on the UI thread in the subscriber by invoking the Device.Beg\", \"inInvokeOnMainThread method.\\n\\nFor more information about MessagingCenter, see MessagingCenter on the\", \" Xamarin Developer Center.\\n\\nDefining a message\\n\\nMessagingCenter messages are strings that are used t\", \"o identify messages. The following code example shows the messages defined within the eShopOnContain\", \"ers mobile app:\\n\\npublic class MessengerKeys { // Add product to basket public const string AddProduc\", \"t = \\\"AddProduct\\\";\\n\\n// Filter public const string Filter = \\\"Filter\\\";\\n\\n// Change selected Tab programm\", \"atically public const string ChangeTab = \\\"ChangeTab\\\"; }\\n\\nIn this example, messages are defined using\", \" constants. The advantage of this approach is that it provides compile-time type safety and refactor\", \"ing support.\\n\\nPublishing a message\\n\\nPublishers notify subscribers of a message with one of the Messa\", \"gingCenter.Send overloads. The following code example demonstrates publishing the AddProduct message\", \":\\n\\nMessagingCenter.Send(this, MessengerKeys.AddProduct, catalogItem);\\n\\nIn this example, the Send met\", \"hod specifies three arguments:\\n\\nThe first argument specifies the sender class. The sender class must\", \" be specified by any subscribers who wish to receive the message.\\n\\nThe second argument specifies the\", \" message.\\n\\nThe third argument specifies the payload data to be sent to the subscriber. In this case \", \"the payload data is a CatalogItem instance.\\n\\nThe Send method will publish the message, and its paylo\", \"ad data, using a fire-and-forget approach. Therefore, the message is sent even if there are no subsc\", \"ribers registered to receive the message. In this situation, the sent message is ignored.\\n\\nNote: The\", \" MessagingCenter.Send method can use generic parameters to control how messages are delivered. There\", \"fore, multiple messages that share a message identity but send different payload data types can be r\", \"eceived by different subscribers.\\n\\n26\\n\\nC HA PTER 4 | Communicating between loosley coupled component\", \"s\\n\\nSubscribing to a message\\n\\nSubscribers can register to receive a message using one of the Messagin\", \"gCenter.Subscribe overloads. The following code example demonstrates how the eShopOnContainers mobil\", \"e app subscribes to, and processes, the AddProduct message:\\n\\nMessagingCenter.Subscribe<CatalogViewMo\", \"del, CatalogItem>( this, MessageKeys.AddProduct, async (sender, arg) => { BadgeCount++;\\n\\nawait AddCa\", \"talogItemAsync(arg); });\\n\\nIn this example, the Subscribe method subscribes to the AddProduct message\", \", and executes a callback delegate in response to receiving the message. This callback delegate, spe\", \"cified as a lambda expression, executes code that updates the UI.\\n\\nTip: Consider using immutable pay\", \"load data\\n\\nDon't attempt to modify the payload data from within a callback delegate because several \", \"threads could be accessing the received data simultaneously. In this scenario, the payload data shou\", \"ld be immutable to avoid concurrency errors.\\n\\nA subscriber might not need to handle every instance o\", \"f a published message, and this can be controlled by the generic type arguments that are specified o\", \"n the Subscribe method. In this example, the subscriber will only receive AddProduct messages that a\", \"re sent from the CatalogViewModel class, whose payload data is a CatalogItem instance.\\n\\nUnsubscribin\", \"g from a message\\n\\nSubscribers can unsubscribe from messages they no longer want to receive. This is \", \"achieved with one of the MessagingCenter.Unsubscribe overloads, as demonstrated in the following cod\", \"e example:\\n\\nMessagingCenter.Unsubscribe<CatalogViewModel, CatalogItem>(this, MessengerKeys.AddProduc\", \"t);\\n\\nIn this example, the Unsubscribe method syntax reflects the type arguments specified when subsc\", \"ribing to receive the AddProduct message.\\n\\nSummary\\n\\nThe Xamarin.Forms MessagingCenter class implemen\", \"ts the publish-subscribe pattern, allowing message-based communication between components that are i\", \"nconvenient to link by object and type references. This mechanism allows publishers and subscribers \", \"to communicate without having a reference to each other, helping to reduce dependencies between comp\", \"onents, while also allowing components to be independently developed and tested.\\n\\n27\\n\\nC HA PTER 4 | \", \"Communicating between loosley coupled components\\n\\nC H A P T E R\\n\\n5\\n\\nNavigation\\n\\nXamarin.Forms includ\", \"es support for page navigation, which typically results from the user's interaction with the UI or f\", \"rom the app itself as a result of internal logic-driven state changes. However, navigation can be co\", \"mplex to implement in apps that use the Model-View-ViewModel (MVVM) pattern, as the following challe\", \"nges must be met:\\n\\nHow to identify the view to be navigated to, using an approach that does not intr\", \"oduce tight coupling and dependencies between views.\\n\\nHow to coordinate the process by which the vie\", \"w to be navigated to is instantiated and initialized. When using MVVM, the view and view model need \", \"to be instantiated and associated with each other via the view's binding context. When an app is usi\", \"ng a dependency injection container, the instantiation of views and view models might require a spec\", \"ific construction mechanism.\\n\\nWhether to perform view-first navigation, or view model-first navigati\", \"on. With view-first navigation, the page to navigate to refers to the name of the view type. During \", \"navigation, the specified view is instantiated, along with its corresponding view model and other de\", \"pendent services. An alternative approach is to use view model-first navigation, where the page to n\", \"avigate to refers to the name of the view model type.\\n\\nHow to cleanly separate the navigational beha\", \"vior of the app across the views and view models. The MVVM pattern provides a separation between the\", \" app's UI and its presentation and business logic. However, the navigation behavior of an app will o\", \"ften span the UI and presentations parts of the app. The user will often initiate navigation from a \", \"view, and the view will be replaced as a result of the navigation. However, navigation might often a\", \"lso need to be initiated or coordinated from within the view model.\\n\\nHow to pass parameters during n\", \"avigation for initialization purposes. For example, if the user navigates to a view to update order \", \"details, the order data will have to be passed to the view so that it can display the correct data.\\n\", \"\\nHow to co-ordinate navigation, to ensure that certain business rules are obeyed. For example, users\", \" might be prompted before navigating away from a view so that they can correct any invalid data or b\", \"e prompted to submit or discard any data changes that were made within the view.\\n\\nThis chapter addre\", \"sses these challenges by presenting a NavigationService class that's used to perform view model-firs\", \"t page navigation.\\n\\nNote: The NavigationService used by the app is designed only to perform hierarch\", \"ical navigation between ContentPage instances. Using the service to navigate between other page type\", \"s might result in unexpected behavior.\\n\\n28\\n\\nC HA PTER 5 | Navigation\\n\\nNavigating between pages\\n\\nNavi\", \"gation logic can reside in a view's code-behind, or in a data bound view model. While placing naviga\", \"tion logic in a view might be the simplest approach, it is not easily testable through unit tests. P\", \"lacing navigation logic in view model classes means that the logic can be exercised through unit tes\", \"ts. In addition, the view model can then implement logic to control navigation to ensure that certai\", \"n business rules are enforced. For example, an app might not allow the user to navigate away from a \", \"page without first ensuring that the entered data is valid.\\n\\nA NavigationService class is typically \", \"invoked from view models, in order to promote testability. However, navigating to views from view mo\", \"dels would require the view models to reference views, and particularly views that the active view m\", \"odel isn't associated with, which is not recommended. Therefore, the NavigationService presented her\", \"e specifies the view model type as the target to navigate to.\\n\\nThe eShopOnContainers mobile app uses\", \" the NavigationService class to provide view model-first navigation. This class implements the INavi\", \"gationService interface, which is shown in the following code example:\\n\\npublic interface INavigation\", \"Service { ViewModelBase PreviousPageViewModel { get; } Task InitializeAsync(); Task NavigateToAsync<\", \"TViewModel>() where TViewModel : ViewModelBase; Task NavigateToAsync<TViewModel>(object parameter) w\", \"here TViewModel : ViewModelBase; Task RemoveLastFromBackStackAsync(); Task RemoveBackStackAsync(); }\", \"\\n\\nThis interface specifies that an implementing class must provide the following methods:\\n\\nMethod In\", \"itializeAsync\\n\\nNavigateToAsync<T> NavigateToAsync<T>(parameter) Performs hierarchical navigation to \", \"a specified page, passing\\n\\nPurpose\\n\\nPerforms navigation to one of two pages when the app is launched\", \". Performs hierarchical navigation to a specified page.\\n\\na parameter.\\n\\nRemoveLastFromBackStackAsync \", \"Removes the previous page from the navigation stack. RemoveBackStackAsync\\n\\nRemoves all the previous \", \"pages from the navigation stack.\\n\\nIn addition, the INavigationService interface specifies that an im\", \"plementing class must provide a PreviousPageViewModel property. This property returns the view model\", \" type associated with the previous page in the navigation stack.\\n\\nNote: An INavigationService interf\", \"ace would usually also specify a GoBackAsync method, which is used to programmatically return to the\", \" previous page in the navigation stack. However, this method is missing from the eShopOnContainers m\", \"obile app because it's not required.\\n\\nCreating the NavigationService instance\\n\\nThe NavigationService\", \" class, which implements the INavigationService interface, is registered as a singleton with the Aut\", \"ofac dependency injection container, as demonstrated in the following code example:\\n\\n29\\n\\nC HA PTER 5\", \" | Navigation\\n\\nbuilder.RegisterType<NavigationService>().As<INavigationService>().SingleInstance();\\n\", \"\\nThe INavigationService interface is resolved in the ViewModelBase class constructor, as demonstrate\", \"d in the following code example:\\n\\nNavigationService = ViewModelLocator.Resolve<INavigationService>()\", \";\\n\\nThis returns a reference to the NavigationService object that's stored in the Autofac dependency \", \"injection container, which is created by the InitNavigation method in the App class. For more inform\", \"ation, see Navigating when the app is launched.\\n\\nThe ViewModelBase class stores the NavigationServic\", \"e instance in a NavigationService property, of type INavigationService. Therefore, all view model cl\", \"asses, which derive from the ViewModelBase class, can use the NavigationService property to access t\", \"he methods specified by the INavigationService interface. This avoids the overhead of injecting the \", \"NavigationService object from the Autofac dependency injection container into each view model class.\", \"\\n\\nHandling navigation requests\\n\\nXamarin.Forms provides the NavigationPage class, which implements a \", \"hierarchical navigation experience in which the user is able to navigate through pages, forwards and\", \" backwards, as desired. For more information about hierarchical navigation, see Hierarchical Navigat\", \"ion on the Xamarin Developer Center.\\n\\nRather than use the NavigationPage class directly, the eShopOn\", \"Containers app wraps the NavigationPage class in the CustomNavigationView class, as shown in the fol\", \"lowing code example:\\n\\npublic partial class CustomNavigationView : NavigationPage { public CustomNavi\", \"gationView() : base() { InitializeComponent(); }\\n\\npublic CustomNavigationView(Page root) : base(root\", \") { InitializeComponent(); } }\\n\\nThe purpose of this wrapping is for ease of styling the NavigationPa\", \"ge instance inside the XAML file for the class.\\n\\nNavigation is performed inside view model classes b\", \"y invoking one of the NavigateToAsync methods, specifying the view model type for the page being nav\", \"igated to, as demonstrated in the following code example:\\n\\nawait NavigationService.NavigateToAsync<M\", \"ainViewModel>();\\n\\nThe following code example shows the NavigateToAsync methods provided by the Navig\", \"ationService class:\\n\\n30\\n\\nC HA PTER 5 | Navigation\\n\\npublic Task NavigateToAsync<TViewModel>() where T\", \"ViewModel : ViewModelBase { return InternalNavigateToAsync(typeof(TViewModel), null); }\\n\\npublic Task\", \" NavigateToAsync<TViewModel>(object parameter) where TViewModel : ViewModelBase { return InternalNav\", \"igateToAsync(typeof(TViewModel), parameter); }\\n\\nEach method allows any view model class that derives\", \" from the ViewModelBase class to perform hierarchical navigation by invoking the InternalNavigateToA\", \"sync method. In addition, the second NavigateToAsync method enables navigation data to be specified \", \"as an argument that's passed to the view model being navigated to, where it's typically used to perf\", \"orm initialization. For more information, see Passing parameters during navigation.\\n\\nThe InternalNav\", \"igateToAsync method executes the navigation request, and is shown in the following code example:\\n\\npr\", \"ivate async Task InternalNavigateToAsync(Type viewModelType, object parameter) { Page page = CreateP\", \"age(viewModelType, parameter);\\n\\nif (page is LoginView) { Application.Current.MainPage = new CustomNa\", \"vigationView(page); } else { var navigationPage = Application.Current.MainPage as CustomNavigationVi\", \"ew; if (navigationPage != null) { await navigationPage.PushAsync(page); } else { Application.Current\", \".MainPage = new CustomNavigationView(page); } }\\n\\nawait (page.BindingContext as ViewModelBase).Initia\", \"lizeAsync(parameter); }\\n\\nprivate Type GetPageTypeForViewModel(Type viewModelType) { var viewName = v\", \"iewModelType.FullName.Replace(\\\"Model\\\", string.Empty); var viewModelAssemblyName = viewModelType.GetT\", \"ypeInfo().Assembly.FullName; var viewAssemblyName = string.Format( CultureInfo.InvariantCulture, \\\"{0\", \"}, {1}\\\", viewName, viewModelAssemblyName); var viewType = Type.GetType(viewAssemblyName); return vie\", \"wType; }\\n\\nprivate Page CreatePage(Type viewModelType, object parameter) { Type pageType = GetPageTyp\", \"eForViewModel(viewModelType); if (pageType == null) { throw new Exception($\\\"Cannot locate page type \", \"for {viewModelType}\\\"); }\\n\\n31\\n\\nC HA PTER 5 | Navigation\\n\\nPage page = Activator.CreateInstance(pageTyp\", \"e) as Page; return page; }\\n\\nThe InternalNavigateToAsync method performs navigation to a view model b\", \"y first calling the CreatePage method. This method locates the view that corresponds to the specifie\", \"d view model type, and creates and returns an instance of this view type. Locating the view that cor\", \"responds to the view model type uses a convention-based approach, which assumes that:\\n\\nViews are in \", \"the same assembly as view model types.\\n\\nViews are in a .Views child namespace.\\n\\nView models are in a\", \" .ViewModels child namespace.\\n\\nView names correspond to view model names, with \\\"Model\\\" removed.\\n\\nWhe\", \"n a view is instantiated, it's associated with its corresponding view model. For more information ab\", \"out how this occurs, see Automatically creating a view model with a view model locator.\\n\\nIf the view\", \" being created is a LoginView, it's wrapped inside a new instance of the CustomNavigationView class \", \"and assigned to the Application.Current.MainPage property. Otherwise, the CustomNavigationView insta\", \"nce is retrieved, and provided that it isn't null, the PushAsync method is invoked to push the view \", \"being created onto the navigation stack. However, If the retrieved CustomNavigationView instance is \", \"null, the view being created is wrapped inside a new instance of the CustomNavigationView class and \", \"assigned to the Application.Current.MainPage property. This mechanism ensures that during navigation\", \", pages are added correctly to the navigation stack both when it's empty, and when it contains data.\", \"\\n\\nTip: Consider caching pages\\n\\nPage caching results in memory consumption for views that are not cur\", \"rently displayed. However, without page caching it does mean that XAML parsing and construction of t\", \"he page and its view model will occur every time a new page is navigated to, which can have a perfor\", \"mance impact for a complex page. For a well-designed page that does not use an excessive number of c\", \"ontrols, the performance should be sufficient. However, page caching might help if slow page loading\", \" times are encountered.\\n\\nAfter the view is created and navigated to, the InitializeAsync method of t\", \"he view's associated view model is executed. For more information, see Passing parameters during nav\", \"igation.\\n\\nNavigating when the app is launched\\n\\nWhen the app is launched, the InitNavigation method i\", \"n the App class is invoked. The following code example shows this method:\\n\\nprivate Task InitNavigati\", \"on() { var navigationService = ViewModelLocator.Resolve<INavigationService>(); return navigationServ\", \"ice.InitializeAsync(); }\\n\\nThe method creates a new NavigationService object in the Autofac dependenc\", \"y injection container, and returns a reference to it, before invoking its InitializeAsync method.\\n\\n3\", \"2\\n\\nC HA PTER 5 | Navigation\\n\\nNote: When the INavigationService interface is resolved by the ViewMode\", \"lBase class, the container returns a reference to the NavigationService object that was created when\", \" the InitNavigation method is invoked.\\n\\nThe following code example shows the NavigationService Initi\", \"alizeAsync method:\\n\\npublic Task InitializeAsync() { if (string.IsNullOrEmpty(Settings.AuthAccessToke\", \"n)) return NavigateToAsync<LoginViewModel>(); else return NavigateToAsync<MainViewModel>(); }\\n\\nThe M\", \"ainView is navigated to if the app has a cached access token, which is used for authentication. Othe\", \"rwise, the LoginView is navigated to.\\n\\nFor more information about the Autofac dependency injection c\", \"ontainer, see Introduction to dependency injection.\\n\\nPassing parameters during navigation\\n\\nOne of th\", \"e NavigateToAsync methods, specified by the INavigationService interface, enables navigation data to\", \" be specified as an argument that's passed to the view model being navigated to, where it's typicall\", \"y used to perform initialization.\\n\\nFor example, the ProfileViewModel class contains an OrderDetailCo\", \"mmand that's executed when the user selects an order on the ProfileView page. In turn, this executes\", \" the OrderDetailAsync method, which is shown in the following code example:\\n\\nprivate async Task Orde\", \"rDetailAsync(Order order) { await NavigationService.NavigateToAsync<OrderDetailViewModel>(order); }\\n\", \"\\nThis method invokes navigation to the OrderDetailViewModel, passing an Order instance that represen\", \"ts the order that the user selected on the ProfileView page. When the NavigationService class create\", \"s the OrderDetailView, the OrderDetailViewModel class is instantiated and assigned to the view's Bin\", \"dingContext. After navigating to the OrderDetailView, the InternalNavigateToAsync method executes th\", \"e InitializeAsync method of the view's associated view model.\\n\\nThe InitializeAsync method is defined\", \" in the ViewModelBase class as a method that can be overridden. This method specifies an object argu\", \"ment that represents the data to be passed to a view model during a navigation operation. Therefore,\", \" view model classes that want to receive data from a navigation operation provide their own implemen\", \"tation of the InitializeAsync method to perform the required initialization. The following code exam\", \"ple shows the InitializeAsync method from the OrderDetailViewModel class:\\n\\npublic override async Tas\", \"k InitializeAsync(object navigationData) { if (navigationData is Order) { ... Order = await _ordersS\", \"ervice.GetOrderAsync( Convert.ToInt32(order.OrderNumber), authToken);\\n\\n33\\n\\nC HA PTER 5 | Navigation\\n\", \"\\n... } }\\n\\nThis method retrieves the Order instance that was passed into the view model during the na\", \"vigation operation, and uses it to retrieve the full order details from the OrderService instance.\\n\\n\", \"Invoking navigation using behaviors\\n\\nNavigation is usually triggered from a view by a user interacti\", \"on. For example, the LoginView performs navigation following successful authentication. The followin\", \"g code example shows how the navigation is invoked by a behavior:\\n\\n<WebView ...> <WebView.Behaviors>\", \" <behaviors:EventToCommandBehavior EventName=\\\"Navigating\\\" EventArgsConverter=\\\"{StaticResource WebNav\", \"igatingEventArgsConverter}\\\" Command=\\\"{Binding NavigateCommand}\\\" /> </WebView.Behaviors> </WebView>\\n\\n\", \"At runtime, the EventToCommandBehavior will respond to interaction with the WebView. When the WebVie\", \"w navigates to a web page, the Navigating event will fire, which will execute the NavigateCommand in\", \" the LoginViewModel. By default, the event arguments for the event are passed to the command. This d\", \"ata is converted as it's passed between source and target by the converter specified in the EventArg\", \"sConverter property, which returns the Url from the WebNavigatingEventArgs. Therefore, when the Navi\", \"gationCommand is executed, the Url of the web page is passed as a parameter to the registered Action\", \".\\n\\nIn turn, the NavigationCommand executes the NavigateAsync method, which is shown in the following\", \" code example:\\n\\nprivate async Task NavigateAsync(string url) { ... await NavigationService.NavigateT\", \"oAsync<MainViewModel>(); await NavigationService.RemoveLastFromBackStackAsync(); ... }\\n\\nThis method \", \"invokes navigation to the MainViewModel, and following navigation, removes the LoginView page from t\", \"he navigation stack.\\n\\nConfirming or cancelling navigation\\n\\nAn app might need to interact with the us\", \"er during a navigation operation, so that the user can confirm or cancel navigation. This might be n\", \"ecessary, for example, when the user attempts to navigate before having fully completed a data entry\", \" page. In this situation, an app should provide a notification that allows the user to navigate away\", \" from the page, or to cancel the navigation operation before it occurs. This can be achieved in a vi\", \"ew model class by using the response from a notification to control whether or not navigation is inv\", \"oked.\\n\\n34\\n\\nC HA PTER 5 | Navigation\\n\\nSummary\\n\\nXamarin.Forms includes support for page navigation, wh\", \"ich typically results from the user's interaction with the UI, or from the app itself, as a result o\", \"f internal logic-driven state changes. However, navigation can be complex to implement in apps that \", \"use the MVVM pattern.\\n\\nThis chapter presented a NavigationService class, which is used to perform vi\", \"ew model-first navigation from view models. Placing navigation logic in view model classes means tha\", \"t the logic can be exercised through automated tests. In addition, the view model can then implement\", \" logic to control navigation to ensure that certain business rules are enforced.\\n\\n35\\n\\nC HA PTER 5 | \", \"Navigation\\n\\nC H A P T E R\\n\\n6\\n\\nValidation\\n\\nAny app that accepts input from users should ensure that t\", \"he input is valid. An app could, for example, check for input that contains only characters in a par\", \"ticular range, is of a certain length, or matches a particular format. Without validation, a user ca\", \"n supply data that causes the app to fail. Validation enforces business rules, and prevents an attac\", \"ker from injecting malicious data.\\n\\nIn the context of the Model-ViewModel-Model (MVVM) pattern, a vi\", \"ew model or model will often be required to perform data validation and signal any validation errors\", \" to the view so that the user can correct them. The eShopOnContainers mobile app performs synchronou\", \"s client-side validation of view model properties and notifies the user of any validation errors by \", \"highlighting the control that contains the invalid data, and by displaying error messages that infor\", \"m the user of why the data is invalid. Figure 6-1 shows the classes involved in performing validatio\", \"n in the eShopOnContainers mobile app.\\n\\nFigure 6-1: Validation classes in the eShopOnContainers mobi\", \"le app\\n\\nView model properties that require validation are of type ValidatableObject<T>, and each Val\", \"idatableObject<T> instance has validation rules added to its Validations property. Validation is inv\", \"oked from the view model by calling the Validate method of the ValidatableObject<T>\\n\\n36\\n\\nC HA PTER 6\", \" | Validation\\n\\ninstance, which retrieves the validation rules and executes them against the Validata\", \"bleObject<T> Value property. Any validation errors are placed into the Errors property of the Valida\", \"tableObject<T> instance, and the IsValid property of the ValidatableObject<T> instance is updated to\", \" indicate whether validation succeeded or failed.\\n\\nProperty change notification is provided by the E\", \"xtendedBindableObject class, and so an Entry control can bind to the IsValid property of Validatable\", \"Object<T> instance in the view model class to be notified of whether or not the entered data is vali\", \"d.\\n\\nSpecifying validation rules\\n\\nValidation rules are specified by creating a class that derives fro\", \"m the IValidationRule<T> interface, which is shown in the following code example:\\n\\npublic interface \", \"IValidationRule<T> { string ValidationMessage { get; set; } bool Check(T value); }\\n\\nThis interface s\", \"pecifies that a validation rule class must provide a boolean Check method that is used to perform th\", \"e required validation, and a ValidationMessage property whose value is the validation error message \", \"that will be displayed if validation fails.\\n\\nThe following code example shows the IsNotNullOrEmptyRu\", \"le<T> validation rule, which is used to perform validation of the username and password entered by t\", \"he user on the LoginView when using mock services in the eShopOnContainers mobile app:\\n\\npublic class\", \" IsNotNullOrEmptyRule<T> : IValidationRule<T> { public string ValidationMessage { get; set; }\\n\\npubli\", \"c bool Check(T value) { if (value == null) { return false; }\\n\\nvar str = value as string; return !str\", \"ing.IsNullOrWhiteSpace(str); } }\\n\\nThe Check method returns a boolean indicating whether the value ar\", \"gument is null, empty, or consists only of whitespace characters.\\n\\nAlthough not used by the eShopOnC\", \"ontainers mobile app, the following code example shows a validation rule for validating email addres\", \"ses:\\n\\npublic class EmailRule<T> : IValidationRule<T> { public string ValidationMessage { get; set; }\", \"\\n\\npublic bool Check(T value) { if (value == null)\\n\\n37\\n\\nC HA PTER 6 | Validation\\n\\n{ return false; }\\n\\n\", \"var str = value as string; Regex regex = new Regex(@\\\"^([\\\\w\\\\.\\\\-]+)@([\\\\w\\\\-]+)((\\\\.(\\\\w){2,3})+)$\\\"); Matc\", \"h match = regex.Match(str);\\n\\nreturn match.Success; } }\\n\\nThe Check method returns a boolean indicatin\", \"g whether or not the value argument is a valid email address. This is achieved by searching the valu\", \"e argument for the first occurrence of the regular expression pattern specified in the Regex constru\", \"ctor. Whether the regular expression pattern has been found in the input string can be determined by\", \" checking the value of the Match object's Success property.\\n\\nNote: Property validation can sometimes\", \" involve dependent properties. An example of dependent properties is when the set of valid values fo\", \"r property A depends on the particular value that has been set in property B. To check that the valu\", \"e of property A is one of the allowed values would involve retrieving the value of property B. In ad\", \"dition, when the value of property B changes, property A would need to be revalidated.\\n\\nAdding valid\", \"ation rules to a property\\n\\nIn the eShopOnContainers mobile app, view model properties that require v\", \"alidation are declared to be of type ValidatableObject<T>, where T is the type of the data to be val\", \"idated. The following code example shows an example of two such properties:\\n\\npublic ValidatableObjec\", \"t<string> UserName { get { return _userName; } set { _userName = value; RaisePropertyChanged(() => U\", \"serName); } }\\n\\npublic ValidatableObject<string> Password { get { return _password; } set { _password\", \" = value; RaisePropertyChanged(() => Password); } }\\n\\nFor validation to occur, validation rules must \", \"be added to the Validations collection of each ValidatableObject<T> instance, as demonstrated in the\", \" following code example:\\n\\n38\\n\\nC HA PTER 6 | Validation\\n\\nprivate void AddValidations() { _userName.Va\", \"lidations.Add(new IsNotNullOrEmptyRule<string> { ValidationMessage = \\\"A username is required.\\\" }); _\", \"password.Validations.Add(new IsNotNullOrEmptyRule<string> { ValidationMessage = \\\"A password is requi\", \"red.\\\" }); }\\n\\nThis method adds the IsNotNullOrEmptyRule<T> validation rule to the Validations collect\", \"ion of each ValidatableObject<T> instance, specifying values for the validation rule's ValidationMes\", \"sage property, which specifies the validation error message that will be displayed if validation fai\", \"ls.\\n\\nTriggering validation\\n\\nThe validation approach used in the eShopOnContainers mobile app can man\", \"ually trigger validation of a property, and automatically trigger validation when a property changes\", \".\\n\\nTriggering validation manually\\n\\nValidation can be triggered manually for a view model property. F\", \"or example, this occurs in the eShopOnContainers mobile app when the user taps the Login button on t\", \"he LoginView, when using mock services. The command delegate calls the MockSignInAsync method in the\", \" LoginViewModel, which invokes validation by executing the Validate method, which is shown in the fo\", \"llowing code example:\\n\\nprivate bool Validate() { bool isValidUser = ValidateUserName(); bool isValid\", \"Password = ValidatePassword(); return isValidUser && isValidPassword; }\\n\\nprivate bool ValidateUserNa\", \"me() { return _userName.Validate(); }\\n\\nprivate bool ValidatePassword() { return _password.Validate()\", \"; }\\n\\nThe Validate method performs validation of the username and password entered by the user on the\", \" LoginView, by invoking the Validate method on each ValidatableObject<T> instance. The following cod\", \"e example shows the Validate method from the ValidatableObject<T> class:\\n\\npublic bool Validate() { E\", \"rrors.Clear();\\n\\nIEnumerable<string> errors = _validations .Where(v => !v.Check(Value)) .Select(v => \", \"v.ValidationMessage);\\n\\n39\\n\\nC HA PTER 6 | Validation\\n\\nErrors = errors.ToList(); IsValid = !Errors.Any\", \"();\\n\\nreturn this.IsValid; }\\n\\nThis method clears the Errors collection, and then retrieves any valida\", \"tion rules that were added to the object's Validations collection. The Check method for each retriev\", \"ed validation rule is executed, and the ValidationMessage property value for any validation rule tha\", \"t fails to validate the data is added to the Errors collection of the ValidatableObject<T> instance.\", \" Finally, the IsValid property is set, and its value is returned to the calling method, indicating w\", \"hether validation succeeded or failed.\\n\\nTriggering validation when properties change\\n\\nValidation is \", \"also automatically triggered whenever a bound property changes. For example, when a two-way binding \", \"in the LoginView sets the UserName or Password property, validation is triggered. The following code\", \" example demonstrates how this occurs:\\n\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\"> <Entry.\", \"Behaviors> <behaviors:EventToCommandBehavior EventName=\\\"TextChanged\\\" Command=\\\"{Binding ValidateUserN\", \"ameCommand}\\\" /> </Entry.Behaviors> ... </Entry>\\n\\nThe Entry control binds to the UserName.Value prope\", \"rty of the ValidatableObject<T> instance, and the control's Behaviors collection has an EventToComma\", \"ndBehavior instance added to it. This behavior executes the ValidateUserNameCommand in response to t\", \"he TextChanged event firing on the Entry, which is raised when the text in the Entry changes. In tur\", \"n, the ValidateUserNameCommand delegate executes the ValidateUserName method, which executes the Val\", \"idate method on the ValidatableObject<T> instance. Therefore, every time the user enters a character\", \" in the Entry control for the username, validation of the entered data is performed.\\n\\nFor more infor\", \"mation about behaviors, see Implementing behaviors.\\n\\nDisplaying validation errors\\n\\nThe eShopOnContai\", \"ners mobile app notifies the user of any validation errors by highlighting the control that contains\", \" the invalid data with a red line, and by displaying an error message that informs the user why the \", \"data is invalid below the control containing the invalid data. When the invalid data is corrected, t\", \"he line changes to black and the error message is removed. Figure 6-2 shows the LoginView in the eSh\", \"opOnContainers mobile app when validation errors are present.\\n\\n40\\n\\nC HA PTER 6 | Validation\\n\\nFigure \", \"6-2: Displaying validation errors during login\\n\\nHighlighting a control that contains invalid data\\n\\nT\", \"he LineColorBehavior attached behavior is used to highlight Entry controls where validation errors h\", \"ave occurred. The following code example shows how the LineColorBehavior attached behavior is attach\", \"ed to an Entry control:\\n\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\"> <Entry.Style> <OnPlatf\", \"orm x:TypeArguments=\\\"Style\\\" iOS=\\\"{StaticResource EntryStyle}\\\" Android=\\\"{StaticResource EntryStyle}\\\" \", \"WinPhone=\\\"{StaticResource UwpEntryStyle}\\\"/> </Entry.Style> ... </Entry>\\n\\nThe Entry control consumes \", \"an explicit style, which is shown in the following code example:\\n\\n<Style x:Key=\\\"EntryStyle\\\" TargetTy\", \"pe=\\\"{x:Type Entry}\\\"> ... <Setter Property=\\\"behaviors:LineColorBehavior.ApplyLineColor\\\" Value=\\\"True\\\" \", \"/> <Setter Property=\\\"behaviors:LineColorBehavior.LineColor\\\" Value=\\\"{StaticResource BlackColor}\\\" /> .\", \".. </Style>\\n\\nThis style sets the ApplyLineColor and LineColor attached properties of the LineColorBe\", \"havior attached behavior on the Entry control. For more information about styles, see Styles on the \", \"Xamarin Developer Center.\\n\\nWhen the value of the ApplyLineColor attached property is set, or changes\", \", the LineColorBehavior attached behavior executes the OnApplyLineColorChanged method, which is show\", \"n in the following code example:\\n\\n41\\n\\nC HA PTER 6 | Validation\\n\\npublic static class LineColorBehavio\", \"r { ... private static void OnApplyLineColorChanged( BindableObject bindable, object oldValue, objec\", \"t newValue) { var view = bindable as View; if (view == null) { return; }\\n\\nbool hasLine = (bool)newVa\", \"lue; if (hasLine) { view.Effects.Add(new EntryLineColorEffect()); } else { var entryLineColorEffectT\", \"oRemove = view.Effects.FirstOrDefault(e => e is EntryLineColorEffect); if (entryLineColorEffectToRem\", \"ove != null) { view.Effects.Remove(entryLineColorEffectToRemove); } } } }\\n\\nThe parameters for this m\", \"ethod provide the instance of the control that the behavior is attached to, and the old and new valu\", \"es of the ApplyLineColor attached property. The EntryLineColorEffect class is added to the control's\", \" Effects collection if the ApplyLineColor attached property is true, otherwise it's removed from the\", \" control's Effects collection. For more information about behaviors, see Implementing behaviors.\\n\\nTh\", \"e EntryLineColorEffect subclasses the RoutingEffect class, and is shown in the following code exampl\", \"e:\\n\\npublic class EntryLineColorEffect : RoutingEffect { public EntryLineColorEffect() : base(\\\"eShopO\", \"nContainers.EntryLineColorEffect\\\") { } }\\n\\nThe RoutingEffect class represents a platform-independent \", \"effect that wraps an inner effect that's platform-specific. This simplifies the effect removal proce\", \"ss, since there is no compile-time access to the type information for a platform-specific effect. Th\", \"e EntryLineColorEffect calls the base class constructor, passing in a parameter consisting of a conc\", \"atenation of the resolution group name, and the unique ID that's specified on each platform-specific\", \" effect class.\\n\\nThe following code example shows the eShopOnContainers.EntryLineColorEffect implemen\", \"tation for iOS:\\n\\n[assembly: ResolutionGroupName(\\\"eShopOnContainers\\\")] [assembly: ExportEffect(typeof\", \"(EntryLineColorEffect), \\\"EntryLineColorEffect\\\")] namespace eShopOnContainers.iOS.Effects { public cl\", \"ass EntryLineColorEffect : PlatformEffect\\n\\n42\\n\\nC HA PTER 6 | Validation\\n\\n{ UITextField control;\\n\\npro\", \"tected override void OnAttached() { try { control = Control as UITextField; UpdateLineColor(); } cat\", \"ch (Exception ex) { Console.WriteLine(\\\"Can't set property on attached control. Error: \\\", ex.Message)\", \"; } }\\n\\nprotected override void OnDetached() { control = null; }\\n\\nprotected override void OnElementPr\", \"opertyChanged(PropertyChangedEventArgs args) { base.OnElementPropertyChanged(args);\\n\\nif (args.Proper\", \"tyName == LineColorBehavior.LineColorProperty.PropertyName || args.PropertyName == \\\"Height\\\") { Initi\", \"alize(); UpdateLineColor(); } }\\n\\nprivate void Initialize() { var entry = Element as Entry; if (entry\", \" != null) { Control.Bounds = new CGRect(0, 0, entry.Width, entry.Height); } }\\n\\nprivate void UpdateLi\", \"neColor() { BorderLineLayer lineLayer = control.Layer.Sublayers.OfType<BorderLineLayer>() .FirstOrDe\", \"fault();\\n\\nif (lineLayer == null) { lineLayer = new BorderLineLayer(); lineLayer.MasksToBounds = true\", \"; lineLayer.BorderWidth = 1.0f; control.Layer.AddSublayer(lineLayer); control.BorderStyle = UITextBo\", \"rderStyle.None; }\\n\\nlineLayer.Frame = new CGRect(0f, Control.Frame.Height-1f, Control.Bounds.Width, 1\", \"f); lineLayer.BorderColor = LineColorBehavior.GetLineColor(Element).ToCGColor(); control.TintColor =\", \" control.TextColor; }\\n\\nprivate class BorderLineLayer : CALayer { }\\n\\n43\\n\\nC HA PTER 6 | Validation\\n\\n} \", \"}\\n\\nThe OnAttached method retrieves the native control for the Xamarin.Forms Entry control, and updat\", \"es the line color by calling the UpdateLineColor method. The OnElementPropertyChanged override respo\", \"nds to bindable property changes on the Entry control by updating the line color if the attached Lin\", \"eColor property changes, or the Height property of the Entry changes. For more information about eff\", \"ects, see Effects on the Xamarin Developer Center.\\n\\nWhen valid data is entered in the Entry control,\", \" it will apply a black line to the bottom of the control, to indicate that there is no validation er\", \"ror. Figure 6-3 shows an example of this.\\n\\nFigure 6-3: Black line indicating no validation error\\n\\nTh\", \"e Entry control also has a DataTrigger added to its Triggers collection. The following code example \", \"shows the DataTrigger:\\n\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\"> ... <Entry.Triggers> <D\", \"ataTrigger TargetType=\\\"Entry\\\" Binding=\\\"{Binding UserName.IsValid}\\\" Value=\\\"False\\\"> <Setter Property=\\\"\", \"behaviors:LineColorBehavior.LineColor\\\" Value=\\\"{StaticResource ErrorColor}\\\" /> </DataTrigger> </Entry\", \".Triggers> </Entry>\\n\\nThis DataTrigger monitors the UserName.IsValid property, and if it's value beco\", \"mes false, it executes the Setter, which changes the LineColor attached property of the LineColorBeh\", \"avior attached behavior to red. Figure 6-4 shows an example of this.\\n\\nFigure 6-4: Red line indicatin\", \"g validation error\\n\\nThe line in the Entry control will remain red while the entered data is invalid,\", \" otherwise it will change to black to indicate that the entered data is valid.\\n\\nFor more information\", \" about Triggers, see Triggers on the Xamarin Developer Center.\\n\\nDisplaying error messages\\n\\nThe UI di\", \"splays validation error messages in Label controls below each control whose data failed validation. \", \"The following code example shows the Label that displays a validation error message if the user has \", \"not entered a valid username:\\n\\n44\\n\\nC HA PTER 6 | Validation\\n\\n<Label Text=\\\"{Binding UserName.Errors, \", \"Converter={StaticResource FirstValidationErrorConverter}\\\" Style=\\\"{StaticResource ValidationErrorLabe\", \"lStyle}\\\" />\\n\\nEach Label binds to the Errors property of the view model object that's being validated\", \". The Errors property is provided by the ValidatableObject<T> class, and is of type List<string>. Be\", \"cause the Errors property can contain multiple validation errors, the FirstValidationErrorConverter \", \"instance is used to retrieve the first error from the collection for display.\\n\\nSummary\\n\\nThe eShopOnC\", \"ontainers mobile app performs synchronous client-side validation of view model properties and notifi\", \"es the user of any validation errors by highlighting the control that contains the invalid data, and\", \" by displaying error messages that inform the user why the data is invalid.\\n\\nView model properties t\", \"hat require validation are of type ValidatableObject<T>, and each ValidatableObject<T> instance has \", \"validation rules added to its Validations property. Validation is invoked from the view model by cal\", \"ling the Validate method of the ValidatableObject<T> instance, which retrieves the validation rules \", \"and executes them against the ValidatableObject<T> Value property. Any validation errors are placed \", \"into the Errors property of the ValidatableObject<T> instance, and the IsValid property of the Valid\", \"atableObject<T> instance is updated to indicate whether validation succeeded or failed.\\n\\n45\\n\\nC HA PT\", \"ER 6 | Validation\\n\\nC H A P T E R\\n\\n7\\n\\nConfiguration management\\n\\nSettings allow the separation of data\", \" that configures the behavior of an app from the code, allowing the behavior to be changed without r\", \"ebuilding the app. There are two types of settings: app settings, and user settings.\\n\\nApp settings a\", \"re data that an app creates and manages. It can include data such as fixed web service endpoints, AP\", \"I keys, and runtime state. App settings are tied to the existence of the app and are only meaningful\", \" to that app.\\n\\nUser settings are the customizable settings of an app that affect the behavior of the\", \" app and don't require frequent re-adjustment. For example, an app might let the user specify where \", \"to retrieve data from, and how to display it on the screen.\\n\\nXamarin.Forms includes a persistent dic\", \"tionary that can be used to store settings data. This dictionary can be accessed using the Applicati\", \"on.Current.Properties property, and any data that's placed into it is saved when the app goes into a\", \" sleep state, and is restored when the app resumes or starts up again. In addition, the Application \", \"class also has a SavePropertiesAsync method that allows an app to have its settings saved when requi\", \"red. For more information about this dictionary, see Properties Dictionary on the Xamarin Developer \", \"Center.\\n\\nA downside to storing data using the Xamarin.Forms persistent dictionary is that it's not e\", \"asily data bound to. Therefore, the eShopOnContainers mobile app uses the Xam.Plugins.Settings libra\", \"ry, available from NuGet. This library provides a consistent, type-safe, cross-platform approach for\", \" persisting and retrieving app and user settings, while using the native settings management provide\", \"d by each platform. In addition, it's straightforward to use data binding to access settings data ex\", \"posed by the library.\\n\\nNote: While the Xam.Plugin.Settings library can store both app and user setti\", \"ngs, it makes no distinction between the two.\\n\\nCreating a settings class\\n\\nWhen using the Xam.Plugins\", \".Settings library, a single static class should be created that will contain the app and user settin\", \"gs required by the app. The following code example shows the Settings class in the eShopOnContainers\", \" mobile app:\\n\\n46\\n\\nC HA PTER 7 | Configuration management\\n\\npublic static class Settings { private sta\", \"tic ISettings AppSettings { get { return CrossSettings.Current; } } ... }\\n\\nSettings can be read and \", \"written through the ISettings API, which is provided by the Xam.Plugins.Settings library. This libra\", \"ry provides a singleton that can be used to access the API, CrossSettings.Current, and an app's sett\", \"ings class should expose this singleton via an ISettings property.\\n\\nNote: Using directives for the P\", \"lugin.Settings and Plugin.Settings.Abstractions namespaces should be added to a class that requires \", \"access to the Xam.Plugins.Settings library types.\\n\\nAdding a setting\\n\\nEach setting consists of a key,\", \" a default value, and a property. The following code example shows all three items for a user settin\", \"g that represents the base URL for the online services that the eShopOnContainers mobile app connect\", \"s to:\\n\\npublic static class Settings { ... private const string IdUrlBase = \\\"url_base\\\"; private stati\", \"c readonly string UrlBaseDefault = GlobalSetting.Instance.BaseEndpoint; ...\\n\\npublic static string Ur\", \"lBase { get { return AppSettings.GetValueOrDefault<string>(IdUrlBase, UrlBaseDefault); } set { AppSe\", \"ttings.AddOrUpdateValue<string>(IdUrlBase, value); } } }\\n\\nThe key is always a const string that defi\", \"nes the key name, with the default value for the setting being a static readonly value of the requir\", \"ed type. Providing a default value ensures that a valid value is available if an unset setting is re\", \"trieved.\\n\\nThe UrlBase static property uses two methods from the ISettings API to read or write the s\", \"etting value. The ISettings.GetValueOrDefault method is used to retrieve a setting's value from plat\", \"form-specific storage. If no value is defined for the setting, its default value is retrieved instea\", \"d. Similarly, the ISettings.AddOrUpdateValue method is used to persist a setting's value to platform\", \"- specific storage.\\n\\n47\\n\\nC HA PTER 7 | Configuration management\\n\\nRather that define a default value \", \"inside the Settings class, the UrlBaseDefault string obtains its value from the GlobalSetting class.\", \" The following code example shows the BaseEndpoint property and UpdateEndpoint method in this class:\", \"\\n\\npublic class GlobalSetting { ... public string BaseEndpoint { get { return _baseEndpoint; } set { \", \"_baseEndpoint = value; UpdateEndpoint(_baseEndpoint); } } ...\\n\\nprivate void UpdateEndpoint(string ba\", \"seEndpoint) { RegisterWebsite = string.Format(\\\"{0}:5105/Account/Register\\\", baseEndpoint); CatalogEnd\", \"point = string.Format(\\\"{0}:5101\\\", baseEndpoint); OrdersEndpoint = string.Format(\\\"{0}:5102\\\", baseEndp\", \"oint); BasketEndpoint = string.Format(\\\"{0}:5103\\\", baseEndpoint); IdentityEndpoint = string.Format(\\\"{\", \"0}:5105/connect/authorize\\\", baseEndpoint); UserInfoEndpoint = string.Format(\\\"{0}:5105/connect/userin\", \"fo\\\", baseEndpoint); TokenEndpoint = string.Format(\\\"{0}:5105/connect/token\\\", baseEndpoint); LogoutEnd\", \"point = string.Format(\\\"{0}:5105/connect/endsession\\\", baseEndpoint); IdentityCallback = string.Format\", \"(\\\"{0}:5105/xamarincallback\\\", baseEndpoint); LogoutCallback = string.Format(\\\"{0}:5105/Account/Redirec\", \"ting\\\", baseEndpoint); } }\\n\\nEach time the BaseEndpoint property is set, the UpdateEndpoint method is \", \"called. This method updates a series of properties, all of which are based on the UrlBase user setti\", \"ng that's provided by the Settings class that represent different endpoints that the eShopOnContaine\", \"rs mobile app connects to.\\n\\nData binding to user settings\\n\\nIn the eShopOnContainers mobile app, the \", \"SettingsView exposes two user settings. These settings allow configuration of whether the app should\", \" retrieve data from microservices that are deployed as Docker containers, or whether the app should \", \"retrieve data from mock services that don't require an internet connection. When choosing to retriev\", \"e data from containerized microservices, a base endpoint URL for the microservices must be specified\", \". Figure 7-1 shows the SettingsView when the user has chosen to retrieve data from containerized mic\", \"roservices.\\n\\n48\\n\\nC HA PTER 7 | Configuration management\\n\\nFigure 7-1: User settings exposed by the eS\", \"hopOnContainers mobile app\\n\\nData binding can be used to retrieve and set settings exposed by the Set\", \"tings class. This is achieved by controls on the view binding to view model properties that in turn \", \"access properties in the Settings class, and raising a property changed notification if the settings\", \" value has changed. For information about how the eShopOnContainers mobile app constructs view model\", \"s and associates them to views, see Automatically creating a view model with a view model locator.\\n\\n\", \"The following code example shows the Entry control from the SettingsView that allows the user to ent\", \"er a base endpoint URL for the containerized microservices:\\n\\n<Entry Text=\\\"{Binding Endpoint, Mode=Tw\", \"oWay}\\\" />\\n\\nThis Entry control binds to the Endpoint property of the SettingsViewModel class, using a\", \" two-way binding. The following code example shows the Endpoint property:\\n\\npublic string Endpoint { \", \"get { return _endpoint; } set { _endpoint = value;\\n\\nif(!string.IsNullOrEmpty(_endpoint)) { UpdateEnd\", \"point(_endpoint); }\\n\\nRaisePropertyChanged(() => Endpoint); } }\\n\\nWhen the Endpoint property is set th\", \"e UpdateEndpoint method is called, provided that the supplied value is valid, and property changed n\", \"otification is raised. The following code example shows the UpdateEndpoint method:\\n\\nprivate void Upd\", \"ateEndpoint(string endpoint) { Settings.UrlBase = endpoint; }\\n\\n49\\n\\nC HA PTER 7 | Configuration manag\", \"ement\\n\\nThis method updates the UrlBase property in the Settings class with the base endpoint URL val\", \"ue entered by the user, which causes it to be persisted to platform-specific storage.\\n\\nWhen the Sett\", \"ingsView is navigated to, the InitializeAsync method in the SettingsViewModel class is executed. The\", \" following code example shows this method:\\n\\npublic override Task InitializeAsync(object navigationDa\", \"ta) { ... Endpoint = Settings.UrlBase; ... }\\n\\nThe method sets the Endpoint property to the value of \", \"the UrlBase property in the Settings class. Accessing the UrlBase property causes the Xam.Plugins.Se\", \"ttings library to retrieve the settings value from platform-specific storage. For information about \", \"how the InitializeAsync method is invoked, see Passing parameters during navigation.\\n\\nThis mechanism\", \" ensures that whenever a user navigates to the SettingsView, user settings are retrieved from platfo\", \"rm-specific storage and presented through data binding. Then, if the user changes the settings value\", \"s, data binding ensures that they are immediately persisted back to platform-specific storage.\\n\\nSumm\", \"ary\\n\\nSettings allow the separation of data that configures the behavior of an app from the code, all\", \"owing the behavior to be changed without rebuilding the app. App settings are data that an app creat\", \"es and manages, and user settings are the customizable settings of an app that affect the behavior o\", \"f the app and don't require frequent re-adjustment.\\n\\nThe Xam.Plugins.Settings library provides a con\", \"sistent, type-safe, cross-platform approach for persisting and retrieving app and user settings, and\", \" data binding can be used to access settings created with the library.\\n\\n50\\n\\nC HA PTER 7 | Configurat\", \"ion management\\n\\nC H A P T E R\\n\\n8\\n\\nContainerized microservices\\n\\nDeveloping client-server applications\", \" has resulted in a focus on building tiered applications that use specific technologies in each tier\", \". Such applications are often referred to as monolithic applications, and are packaged onto hardware\", \" pre-scaled for peak loads. The main drawbacks of this development approach are the tight coupling b\", \"etween components within each tier, that individual components can't be easily scaled, and the cost \", \"of testing. A simple update can have unforeseen effects on the rest of the tier, and so a change to \", \"an application component requires its entire tier to be retested and redeployed.\\n\\nParticularly conce\", \"rning in the age of the cloud, is that individual components can't be easily scaled. A monolithic ap\", \"plication contains domain-specific functionality, and is typically divided by functional layers such\", \" as front end, business logic, and data storage. A monolithic application is scaled by cloning the e\", \"ntire application onto multiple machines, as illustrated in Figure 8-1.\\n\\nFigure 8-1: Monolithic appl\", \"ication scaling approach\\n\\n51\\n\\nC HA PTER 8 | Containerized microservices\\n\\nMicroservices\\n\\nMicroservice\", \"s offer a different approach to application development and deployment, an approach that's suited to\", \" the agility, scale, and reliability requirements of modern cloud applications. A microservices appl\", \"ication is decomposed into independent components that work together to deliver the application's ov\", \"erall functionality. The term microservice emphasizes that applications should be composed of servic\", \"es small enough to reflect independent concerns, so that each microservice implements a single funct\", \"ion. In addition, each microservice has well-defined contracts so that other microservices can commu\", \"nicate and share data with it. Typical examples of microservices include shopping carts, inventory p\", \"rocessing, purchase subsystems, and payment processing.\\n\\nMicroservices can scale-out independently, \", \"as compared to giant monolithic applications that scale together. This means that a specific functio\", \"nal area, that requires more processing power or network bandwidth to support demand, can be scaled \", \"rather than unnecessarily scaling-out other areas of the application. Figure 8-2 illustrates this ap\", \"proach, where microservices are deployed and scaled independently, creating instances of services ac\", \"ross machines.\\n\\nFigure 8-2: Microservices application scaling approach\\n\\nMicroservice scale-out can b\", \"e nearly instantaneous, allowing an application to adapt to changing loads. For example, a single mi\", \"croservice in the web-facing functionality of an application might be the only microservice in the a\", \"pplication that needs to scale out to handle additional incoming traffic.\\n\\nThe classic model for app\", \"lication scalability is to have a load-balanced, stateless tier with a shared external datastore to \", \"store persistent data. Stateful microservices manage their own persistent data, usually storing it l\", \"ocally on the servers on which they are placed, to avoid the overhead of network access and complexi\", \"ty of cross-service operations. This enables the fastest possible processing of data and can elimina\", \"te the need for caching systems. In addition, scalable stateful microservices usually partition data\", \" among their instances, in order to manage data size and transfer throughput beyond which a single s\", \"erver can support.\\n\\nMicroservices also support independent updates. This loose coupling between micr\", \"oservices provides a rapid and reliable application evolution. Their independent, distributed nature\", \" supports rolling updates, where only a subset of instances of a single microservice will update at \", \"any given time. Therefore, if a problem is detected, a buggy update can be rolled back, before all i\", \"nstances update with the faulty code or configuration. Similarly, microservices typically use schema\", \" versioning, so that\\n\\n52\\n\\nC HA PTER 8 | Containerized microservices\\n\\nclients see a consistent versio\", \"n when updates are being applied, regardless of which microservice instance is being communicated wi\", \"th.\\n\\nTherefore, microservice applications have many benefits over monolithic applications:\\n\\nEach mic\", \"roservice is relatively small, easy to manage and evolve.\\n\\nEach microservice can be developed and de\", \"ployed independently of other services.\\n\\nEach microservice can be scaled-out independently. For exam\", \"ple, a catalog service or shopping basket service might need to be scaled-out more than an ordering \", \"service. Therefore, the resulting infrastructure will more efficiently consume resources when scalin\", \"g out.\\n\\nEach microservice isolates any issues. For example, if there is an issue in a service it onl\", \"y impacts that service. The other services can continue to handle requests.\\n\\nEach microservice can u\", \"se the latest technologies. Because microservices are autonomous and run side-by-side, the latest te\", \"chnologies and frameworks can be used, rather than being forced to use an older framework that might\", \" be used by a monolithic application.\\n\\nHowever, a microservice based solution also has potential dra\", \"wbacks:\\n\\nChoosing how to partition an application into microservices can be challenging, as each mic\", \"roservice has to be completely autonomous, end-to-end, including responsibility for its data sources\", \".\\n\\nDevelopers must implement inter-service communication, which adds complexity and latency to the a\", \"pplication.\\n\\nAtomic transactions between multiple microservices usually aren't possible. Therefore, \", \"business requirements must embrace eventual consistency between microservices.\\n\\n\\n\\nIn production, the\", \"re is an operational complexity in deploying and managing a system compromised of many independent s\", \"ervices.\\n\\nDirect client-to-microservice communication can make it difficult to refactor the contract\", \"s of microservices. For example, over time how the system is partitioned into services might need to\", \" change. A single service might split into two or more services, and two services might merge. When \", \"clients communicate directly with microservices, this refactoring work can break compatibility with \", \"client apps.\\n\\nContainerization\\n\\nContainerization is an approach to software development in which an \", \"application and its versioned set of dependencies, plus its environment configuration abstracted as \", \"deployment manifest files, are packaged together as a container image, tested as a unit, and deploye\", \"d to a host operating system.\\n\\nA container is an isolated, resource controlled, and portable operati\", \"ng environment, where an application can run without touching the resources of other containers, or \", \"the host. Therefore, a container looks and acts like a newly installed physical computer or a virtua\", \"l machine.\\n\\nThere are many similarities between containers and virtual machines, as illustrated in F\", \"igure 8-3.\\n\\n53\\n\\nC HA PTER 8 | Containerized microservices\\n\\nFigure 8-3: Comparison of virtual machine\", \"s and containers\\n\\nA container runs an operating system, has a file system, and can be accessed over \", \"a network as if it were a physical or virtual machine. However, the technology and concepts used by \", \"containers are very different from virtual machines. Virtual machines include the applications, the \", \"required dependencies, and a full guest operating system. Containers include the application and its\", \" dependencies, but share the operating system with other containers, running as isolated processes o\", \"n the host operating system (aside from Hyper-V containers which run inside of a special virtual mac\", \"hine per container). Therefore, containers share resources and typically require fewer resources tha\", \"n virtual machines.\\n\\nThe advantage of a container-oriented development and deployment approach is th\", \"at it eliminates most of the issues that arise from inconsistent environment setups and the problems\", \" that come with them. In addition, containers permit fast application scale-up functionality by inst\", \"ancing new containers as required.\\n\\nThe key concepts when creating and working with containers are:\\n\", \"\\nContainer Host: The physical or virtual machine configured to host containers. The container host w\", \"ill run one or more containers.\\n\\nContainer Image: An image consists of a union of layered filesystem\", \"s stacked on top of each other, and is the basis of a container. An image does not have state and it\", \" never changes as it's deployed to different environments.\\n\\nContainer: A container is a runtime inst\", \"ance of an image.\\n\\nContainer OS Image: Containers are deployed from images. The container operating \", \"system image is the first layer in potentially many image layers that make up a container. A contain\", \"er operating system is immutable, and can't be modified.\\n\\nContainer Repository: Each time a containe\", \"r image is created, the image and its dependencies are stored in a local repository. These images ca\", \"n be reused many times on the container host. The container images can also be stored in a public or\", \" private registry, such as Docker Hub, so that they can be used across different container hosts.\\n\\n5\", \"4\\n\\nC HA PTER 8 | Containerized microservices\\n\\nEnterprises are increasingly adopting containers when \", \"implementing microservice based applications, and Docker has become the standard container implement\", \"ation that has been adopted by most software platforms and cloud vendors.\\n\\nThe eShopOnContainers ref\", \"erence application uses Docker to host four containerized back-end microservices, as illustrated in \", \"Figure 8-4.\\n\\nFigure 8-4: eShopOnContainers reference application back-end microservices\\n\\nThe archite\", \"cture of the back-end services in the reference application is decomposed into multiple autonomous s\", \"ub-systems in the form of collaborating microservices and containers. Each microservice provides a s\", \"ingle area of functionality: an identity service, a catalog service, an ordering service, and a bask\", \"et service.\\n\\nEach microservice has its own database, allowing it to be fully decoupled from the othe\", \"r microservices. Where necessary, consistency between databases from different microservices is achi\", \"eved using application-level events. For more information, see Communication between microservices.\\n\", \"\\nFor more information about the reference application, see .NET Microservices: Architecture for Cont\", \"ainerized .NET Applications.\\n\\nCommunication between client and microservices\\n\\nThe eShopOnContainers \", \"mobile app communicates with the containerized back-end microservices using direct client-to-microse\", \"rvice communication, which is shown in Figure 8-5.\\n\\n55\\n\\nC HA PTER 8 | Containerized microservices\\n\\nF\", \"igure 8-5: Direct client-to-microservice communication\\n\\nWith direct client-to-microservice communica\", \"tion, the mobile app makes requests to each microservice directly through its public endpoint, with \", \"a different TCP port per microservice. In production, the endpoint would typically map to the micros\", \"ervice's load balancer, which distributes requests across the available instances.\\n\\nTip: Consider us\", \"ing API gateway communication\\n\\nDirect client-to-microservice communication can have drawbacks when b\", \"uilding a large and complex microservice based application, but it's more than adequate for a small \", \"application. When designing a large microservice based application with tens of microservices, consi\", \"der using API gateway communication. For more information, see .NET Microservices: Architecture for \", \"Containerized .NET Applications.\\n\\nCommunication between microservices\\n\\nA microservices based applica\", \"tion is a distributed system, potentially running on multiple machines. Each service instance is typ\", \"ically a process. Therefore, services must interact using an inter-process communication protocol, s\", \"uch as HTTP, TCP, Advanced Message Queuing Protocol (AMQP), or binary protocols, depending on the na\", \"ture of each service.\\n\\nThe two common approaches for microservice-to-microservice communication are \", \"HTTP based REST communication when querying for data, and lightweight asynchronous messaging when co\", \"mmunicating updates across multiple microservices.\\n\\nAsynchronous messaging based event-driven commun\", \"ication is critical when propagating changes across multiple microservices. With this approach, a mi\", \"croservice publishes an event when something notable happens, for example, when it updates a busines\", \"s entity. Other microservices subscribe to these events. Then, when a microservice receives an event\", \", it updates its own business entities, which might in turn lead to more events being published. Thi\", \"s publish-subscribe functionality is usually achieved with an event bus.\\n\\nAn event bus allows publis\", \"h-subscribe communication between microservices, without requiring the components to be explicitly a\", \"ware of each other, as shown in Figure 8-6.\\n\\n56\\n\\nC HA PTER 8 | Containerized microservices\\n\\nFigure 8\", \"-6: Publish-subscribe with an event bus\\n\\nFrom an application perspective, the event bus is simply a \", \"publish-subscribe channel exposed via an interface. However, the way the event bus is implemented ca\", \"n vary. For example, an event bus implementation could use RabbitMQ, Azure Service Bus, or other ser\", \"vice buses such as NServiceBus and MassTransit. Figure 8-7 shows how an event bus is used in the eSh\", \"opOnContainers reference application.\\n\\nFigure 8-7: Asynchronous event-driven communication in the re\", \"ference application\\n\\nThe eShopOnContainers event bus, implemented using RabbitMQ, provides one-to-ma\", \"ny asynchronous publish-subscribe functionality. This means that after publishing an event, there ca\", \"n be multiple subscribers listening for the same event. Figure 8-9 illustrates this relationship.\\n\\n5\", \"7\\n\\nC HA PTER 8 | Containerized microservices\\n\\nFigure 8-9: One-to-many communication\\n\\nThis one-to-man\", \"y communication approach uses events to implement business transactions that span multiple services,\", \" ensuring eventual consistency between the services. An eventual-consistent transaction consists of \", \"a series of distributed steps. Therefore, when the user-profile microservice receives the UpdateUser\", \" command, it updates the user's details in its database and publishes the UserUpdated event to the e\", \"vent bus. Both the basket microservice and the ordering microservice have subscribed to receive this\", \" event, and in response update their buyer information in their respective databases.\\n\\nNote: The eSh\", \"opOnContainers event bus, implemented using RabbitMQ, is intended to be used only as a proof of conc\", \"ept. For production systems, alternative event bus implementations should be considered.\\n\\nFor inform\", \"ation about the event bus implementation, see .NET Microservices: Architecture for Containerized .NE\", \"T Applications.\\n\\nSummary\\n\\nMicroservices offer an approach to application development and deployment \", \"that's suited to the agility, scale, and reliability requirements of modern cloud applications. One \", \"of the main advantages of microservices is that they can be scaled-out independently, which means th\", \"at a specific functional area can be scaled that requires more processing power or network bandwidth\", \" to support demand, without unnecessarily scaling areas of the application that are not experiencing\", \" increased demand.\\n\\nA container is an isolated, resource controlled, and portable operating environm\", \"ent, where an application can run without touching the resources of other containers, or the host. E\", \"nterprises are increasingly adopting containers when implementing microservice based applications, a\", \"nd Docker has become the standard container implementation that has been adopted by most software pl\", \"atforms and cloud vendors.\\n\\n58\\n\\nC HA PTER 8 | Containerized microservices\\n\\nC H A P T E R\\n\\n9\\n\\nAuthent\", \"ication and authorization\\n\\nAuthentication is the process of obtaining identification credentials suc\", \"h as name and password from a user, and validating those credentials against an authority. If the cr\", \"edentials are valid, the entity that submitted the credentials is considered an authenticated identi\", \"ty. Once an identity has been authenticated, an authorization process determines whether that identi\", \"ty has access to a given resource.\\n\\nThere are many approaches to integrating authentication and auth\", \"orization into a Xamarin.Forms app that communicates with an ASP.NET MVC web application, including \", \"using ASP.NET Core Identity, external authentication providers such as Microsoft, Google, Facebook, \", \"or Twitter, and authentication middleware. The eShopOnContainers mobile app performs authentication \", \"and authorization with a containerized identity microservice that uses IdentityServer 4. The mobile \", \"app requests security tokens from IdentityServer, either for authenticating a user or for accessing \", \"a resource. For IdentityServer to issue tokens on behalf of a user, the user must sign-in to Identit\", \"yServer. However, IdentityServer doesn't provide a user interface or database for authentication. Th\", \"erefore, in the eShopOnContainers reference application, ASP.NET Core Identity is used for this purp\", \"ose.\\n\\nAuthentication\\n\\nAuthentication is required when an application needs to know the identity of t\", \"he current user. ASP.NET Core's primary mechanism for identifying users is the ASP.NET Core Identity\", \" membership system, which stores user information in a data store configured by the developer. Typic\", \"ally, this data store will be an EntityFramework store, though custom stores or third party packages\", \" can be used to store identity information in Azure storage, DocumentDB, or other locations.\\n\\nFor au\", \"thentication scenarios that make use of a local user data store, and that persist identity informati\", \"on between requests via cookies (as is typical in ASP.NET MVC web applications), ASP.NET Core Identi\", \"ty is a suitable solution. However, cookies are not always a natural means of persisting and transmi\", \"tting data. For example, an ASP.NET Core web application that exposes RESTful endpoints that are acc\", \"essed from a mobile app will typically need to use bearer token authentication, since cookies can't \", \"be used in this scenario. However, bearer tokens can easily be retrieved and included in the authori\", \"zation header of web requests made from the mobile app.\\n\\n59\\n\\nC HA PTER 9 | Authentication and author\", \"ization\\n\\nIssuing bearer tokens using IdentityServer 4\\n\\nIdentityServer 4 is an open source OpenID Con\", \"nect and OAuth 2.0 framework for ASP.NET Core, which can be used for many authentication and authori\", \"zation scenarios including issuing security tokens for local ASP.NET Core Identity users.\\n\\nNote: Ope\", \"nID Connect and OAuth 2.0 are very similar, while having different responsibilities.\\n\\nOpenID Connect\", \" is an authentication layer on top of the OAuth 2.0 protocol. OAuth 2 is a protocol that allows appl\", \"ications to request access tokens from a security token service and use them to communicate with API\", \"s. This delegation reduces complexity in both client applications and APIs since authentication and \", \"authorization can be centralized.\\n\\nThe combination of OpenID Connect and OAuth 2.0 combine the two f\", \"undamental security concerns of authentication and API access, and IdentityServer 4 is an implementa\", \"tion of these protocols.\\n\\nIn applications that use direct client-to-microservice communication, such\", \" as the eShopOnContainers reference application, a dedicated authentication microservice acting as a\", \" Security Token Service (STS) can be used to authenticate users, as shown in Figure 9-1. For more in\", \"formation about direct client- to-microservice communication, see Communication between client and m\", \"icroservices.\\n\\nFigure 9-1: Authentication by a dedicated authentication microservice\\n\\nThe eShopOnCon\", \"tainers mobile app communicates with the identity microservice, which uses IdentityServer 4 to perfo\", \"rm authentication, and access control for APIs. Therefore, the mobile app requests tokens from Ident\", \"ityServer, either for authenticating a user or for accessing a resource:\\n\\nAuthenticating users with \", \"IdentityServer is achieved by the mobile app requesting an identity token, which represents the outc\", \"ome of an authentication process. At a bare minimum, it contains an identifier for the user, and inf\", \"ormation about how and when the user authenticated. It can also contain additional identity data.\\n\\nA\", \"ccessing a resource with IdentityServer is achieved by the mobile app requesting an access token, wh\", \"ich allows access to an API resource. Clients request access tokens and forward them to the API. Acc\", \"ess tokens contain information about the client, and the user (if present). APIs then use that infor\", \"mation to authorize access to their data.\\n\\nNote: A client must be registered with IdentityServer bef\", \"ore it can request tokens.\\n\\nAdding IdentityServer to a web application\\n\\nIn order for an ASP.NET Core\", \" web application to use IdentityServer 4, it must be added to the web application's Visual Studio so\", \"lution. For more information, see Setup and Overview in the IdentityServer documentation.\\n\\n60\\n\\nC HA \", \"PTER 9 | Authentication and authorization\\n\\nOnce IdentityServer is included in the web application's \", \"Visual Studio solution, it must be added to the web application's HTTP request processing pipeline, \", \"so that it can serve requests to OpenID Connect and OAuth 2.0 endpoints. This is achieved in the Con\", \"figure method in the web application's Startup class, as demonstrated in the following code example:\", \"\\n\\npublic void Configure( IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFact\", \"ory) { ... app.UseIdentity(); ... }\\n\\nOrder matters in the web application's HTTP request processing \", \"pipeline. Therefore, IdentityServer must be added to the pipeline before the UI framework that imple\", \"ments the login screen.\\n\\nConfiguring IdentityServer\\n\\nIdentityServer should be configured in the Conf\", \"igureServices method in the web application's Startup class by calling the services.AddIdentityServe\", \"r method, as demonstrated in the following code example from the eShopOnContainers reference applica\", \"tion:\\n\\npublic void ConfigureServices(IServiceCollection services) { ... services.AddIdentityServer(x\", \" => x.IssuerUri = \\\"null\\\") .AddSigningCredential(Certificate.Get()) .AddAspNetIdentity<ApplicationUse\", \"r>() .AddConfigurationStore(builder => builder.UseSqlServer(connectionString, options => options.Mig\", \"rationsAssembly(migrationsAssembly))) .AddOperationalStore(builder => builder.UseSqlServer(connectio\", \"nString, options => options.MigrationsAssembly(migrationsAssembly))) .Services.AddTransient<IProfile\", \"Service, ProfileService>(); }\\n\\nAfter calling the services.AddIdentityServer method, additional fluen\", \"t APIs are called to configure the following:\\n\\nCredentials used for signing.\\n\\nAPI and identity resou\", \"rces that users might request access to.\\n\\nClients that will be connecting to request tokens.\\n\\nASP.NE\", \"T Core Identity.\\n\\nTip: Dynamically load the IdentityServer 4 configuration\\n\\nIdentityServer 4's APIs \", \"allow for configuring IdentityServer from an in-memory list of configuration objects. In the eShopOn\", \"Containers reference application, these in-memory collections are hard- coded into the application. \", \"However, in production scenarios they can be loaded dynamically from a configuration file or from a \", \"database.\\n\\nFor information about configuring IdentityServer to use ASP.NET Core Identity, see Using \", \"ASP.NET Core Identity in the IdentityServer documentation.\\n\\n61\\n\\nC HA PTER 9 | Authentication and aut\", \"horization\\n\\nConfiguring API resources\\n\\nWhen configuring API resources, the AddInMemoryApiResources m\", \"ethod expects an IEnumerable<ApiResource> collection. The following code example shows the GetApis m\", \"ethod that provides this collection in the eShopOnContainers reference application:\\n\\npublic static I\", \"Enumerable<ApiResource> GetApis() { return new List<ApiResource> { new ApiResource(\\\"orders\\\", \\\"Orders\", \" Service\\\"), new ApiResource(\\\"basket\\\", \\\"Basket Service\\\") }; }\\n\\nThis method specifies that IdentitySer\", \"ver should protect the orders and basket APIs. Therefore, IdentityServer managed access tokens will \", \"be required when making calls to these APIs. For more information about the ApiResource type, see AP\", \"I Resource in the IdentityServer 4 documentation.\\n\\nConfiguring identity resources\\n\\nWhen configuring \", \"identity resources, the AddInMemoryIdentityResources method expects an IEnumerable<IdentityResource>\", \" collection. Identity resources are data such as user ID, name, or email address. Each identity reso\", \"urce has a unique name, and arbitrary claim types can be assigned to it, which will then be included\", \" in the identity token for the user. The following code example shows the GetResources method that p\", \"rovides this collection in the eShopOnContainers reference application:\\n\\npublic static IEnumerable<I\", \"dentityResource> GetResources() { return new List<IdentityResource> { new IdentityResources.OpenId()\", \", new IdentityResources.Profile() }; }\\n\\nThe OpenID Connect specification specifies some standard ide\", \"ntity resources. The minimum requirement is that support is provided for emitting a unique ID for us\", \"ers. This is achieved by exposing the IdentityResources.OpenId identity resource.\\n\\nNote: The Identit\", \"yResources class supports all of the scopes defined in the OpenID Connect specification (openid, ema\", \"il, profile, telephone, and address).\\n\\nIdentityServer also supports defining custom identity resourc\", \"es. For more information, see Defining custom identity resources in the IdentityServer documentation\", \". For more information about the IdentityResource type, see Identity Resource in the IdentityServer \", \"4 documentation.\\n\\nConfiguring clients\\n\\nClients are applications that can request tokens from Identit\", \"yServer. Typically, the following settings must be defined for each client as a minimum:\\n\\nA unique c\", \"lient ID.\\n\\nThe allowed interactions with the token service (known as the grant type).\\n\\nThe location \", \"where identity and access tokens are sent to (known as a redirect URI).\\n\\n62\\n\\nC HA PTER 9 | Authentic\", \"ation and authorization\\n\\nA list of resources that the client is allowed access to (known as scopes).\", \"\\n\\nWhen configuring clients, the AddInMemoryClients method expects an IEnumerable<Client> collection.\", \" The following code example shows the configuration for the eShopOnContainers mobile app in the GetC\", \"lients method that provides this collection in the eShopOnContainers reference application:\\n\\npublic \", \"static IEnumerable<Client> GetClients(Dictionary<string,string> clientsUrl) { return new List<Client\", \"> { ... new Client { ClientId = \\\"xamarin\\\", ClientName = \\\"eShop Xamarin OpenId Client\\\", AllowedGrantT\", \"ypes = GrantTypes.Hybrid, ClientSecrets = { new Secret(\\\"secret\\\".Sha256()) }, RedirectUris = { client\", \"sUrl[\\\"Xamarin\\\"] }, RequireConsent = false, RequirePkce = true, PostLogoutRedirectUris = { $\\\"{clients\", \"Url[\\\"Xamarin\\\"]}/Account/Redirecting\\\" }, AllowedCorsOrigins = { \\\"http://eshopxamarin\\\" }, AllowedScope\", \"s = new List<string> { IdentityServerConstants.StandardScopes.OpenId, IdentityServerConstants.Standa\", \"rdScopes.Profile, IdentityServerConstants.StandardScopes.OfflineAccess, \\\"orders\\\", \\\"basket\\\" }, AllowO\", \"fflineAccess = true, AllowAccessTokensViaBrowser = true }, ... }; }\\n\\nThis configuration specifies da\", \"ta for the following properties:\\n\\nClientId: A unique ID for the client.\\n\\nClientName: The client disp\", \"lay name, which is used for logging and the consent screen.\\n\\nAllowedGrantTypes: Specifies how a clie\", \"nt wants to interact with IdentityServer. For more information see Configuring the authentication fl\", \"ow.\\n\\nClientSecrets: Specifies the client secret credentials that are used when requesting tokens fro\", \"m the token endpoint.\\n\\nRedirectUris: Specifies the allowed URIs to which to return tokens or authori\", \"zation codes.\\n\\nRequireConsent: Specifies whether a consent screen is required.\\n\\nRequirePkce: Specifi\", \"es whether clients using an authorization code must send a proof key.\\n\\nPostLogoutRedirectUris: Speci\", \"fies the allowed URIs to redirect to after logout.\\n\\n63\\n\\nC HA PTER 9 | Authentication and authorizati\", \"on\\n\\nAllowedCorsOrigins: Specifies the origin of the client so that IdentityServer can allow cross- o\", \"rigin calls from the origin.\\n\\nAllowedScopes: Specifies the resources the client has access to. By de\", \"fault, a client has no access to any resources.\\n\\nAllowOfflineAccess: Specifies whether the client ca\", \"n request refresh tokens.\\n\\nConfiguring the authentication flow\\n\\nThe authentication flow between a cl\", \"ient and IdentityServer can be configured by specifying the grant types in the Client.AllowedGrantTy\", \"pes property. The OpenID Connect and OAuth 2.0 specifications define a number of authentication flow\", \"s, including:\\n\\n\\n\\nImplicit. This flow is optimized for browser-based applications and should be used \", \"either for user authentication-only, or authentication and access token requests. All tokens are tra\", \"nsmitted via the browser, and therefore advanced features like refresh tokens are not permitted.\\n\\nAu\", \"thorization code. This flow provides the ability to retrieve tokens on a back channel, as opposed to\", \" the browser front channel, while also supporting client authentication.\\n\\nHybrid. This flow is a com\", \"bination of the implicit and authorization code grant types. The identity token is transmitted via t\", \"he browser channel and contains the signed protocol response along with other artifacts such as the \", \"authorization code. After successful validation of the response, the back channel should be used to \", \"retrieve the access and refresh token.\\n\\nTip: Use the hybrid authentication flow\\n\\nThe hybrid authenti\", \"cation flow mitigates a number of attacks that apply to the browser channel, and is the recommended \", \"flow for native applications that want to retrieve access tokens (and possibly refresh tokens).\\n\\nFor\", \" more information about authentication flows, see Grant Types in the IdentityServer 4 documentation.\", \"\\n\\nPerforming authentication\\n\\nFor IdentityServer to issue tokens on behalf of a user, the user must s\", \"ign-in to IdentityServer. However, IdentityServer doesn't provide a user interface or database for a\", \"uthentication. Therefore, in the eShopOnContainers reference application, ASP.NET Core Identity is u\", \"sed for this purpose.\\n\\nThe eShopOnContainers mobile app authenticates with IdentityServer with the h\", \"ybrid authentication flow, which is illustrated in Figure 9-2.\\n\\nFigure 9-2: High-level overview of t\", \"he sign-in process\\n\\n64\\n\\nC HA PTER 9 | Authentication and authorization\\n\\nA sign-in request is made to\", \" <base endpoint>:5105/connect/authorize. Following successful authentication, IdentityServer returns\", \" an authentication response containing an authorization code and an identity token. The authorizatio\", \"n code is then sent to <base endpoint>:5105/connect/token, which responds with access, identity, and\", \" refresh tokens.\\n\\nThe eShopOnContainers mobile app signs-out of IdentityServer by sending a request \", \"to http://<base endpoint>:5105/connect/endsession, with additional parameters. After sign-out occurs\", \", IdentityServer responds by sending a post logout redirect URI back to the mobile app. Figure 9-3 i\", \"llustrates this process.\\n\\nFigure 9-3: High-level overview of the sign-out process\\n\\nIn the eShopOnCon\", \"tainers mobile app, communication with IdentityServer is performed by the IdentityService class, whi\", \"ch implements the IIdentityService interface. This interface specifies that the implementing class m\", \"ust provide CreateAuthorizationRequest, CreateLogoutRequest, and GetTokenAsync methods.\\n\\nSigning-in\\n\", \"\\nWhen the user taps the LOGIN button on the LoginView, the SignInCommand in the LoginViewModel class\", \" is executed, which in turn executes the SignInAsync method. The following code example shows this m\", \"ethod:\\n\\nprivate async Task SignInAsync() { ... LoginUrl = _identityService.CreateAuthorizationReques\", \"t(); IsLogin = true; ... }\\n\\nThis method invokes the CreateAuthorizationRequest method in the Identit\", \"yService class, which is shown in the following code example:\\n\\npublic string CreateAuthorizationRequ\", \"est() { // Create URI to authorization endpoint var authorizeRequest = new AuthorizeRequest(GlobalSe\", \"tting.Instance.IdentityEndpoint);\\n\\n// Dictionary with values for the authorize request var dic = new\", \" Dictionary<string, string>(); dic.Add(\\\"client_id\\\", GlobalSetting.Instance.ClientId); dic.Add(\\\"clien\", \"t_secret\\\", GlobalSetting.Instance.ClientSecret); dic.Add(\\\"response_type\\\", \\\"code id_token\\\"); dic.Add(\", \"\\\"scope\\\", \\\"openid profile basket orders locations marketing offline_access\\\"); dic.Add(\\\"redirect_uri\\\",\", \" GlobalSetting.Instance.IdentityCallback); dic.Add(\\\"nonce\\\", Guid.NewGuid().ToString(\\\"N\\\")); dic.Add(\\\"\", \"code_challenge\\\", CreateCodeChallenge()); dic.Add(\\\"code_challenge_method\\\", \\\"S256\\\");\\n\\n65\\n\\nC HA PTER 9 \", \"| Authentication and authorization\\n\\n// Add CSRF token to protect against cross-site request forgery \", \"attacks. var currentCSRFToken = Guid.NewGuid().ToString(\\\"N\\\"); dic.Add(\\\"state\\\", currentCSRFToken);\\n\\nv\", \"ar authorizeUri = authorizeRequest.Create(dic); return authorizeUri; }\\n\\nThis method creates the URI \", \"for IdentityServer's authorization endpoint, with the required parameters. The authorization endpoin\", \"t is at /connect/authorize on port 5105 of the base endpoint exposed as a user setting. For more inf\", \"ormation about user settings, see Configuration management.\\n\\nNote: The attack surface of the eShopOn\", \"Containers mobile app is reduced by implementing the Proof Key for Code Exchange (PKCE) extension to\", \" OAuth. PKCE protects the authorization code from being used if it\\u2019s intercepted. This is achieved b\", \"y the client generating a secret verifier, a hash of which is passed in the authorization request, a\", \"nd which is presented unhashed when redeeming the authorization code. For more information about PKC\", \"E, see Proof Key for Code Exchange by OAuth Public Clients on the Internet Engineering Task Force we\", \"b site.\\n\\nThe returned URI is stored in the LoginUrl property of the LoginViewModel class. When the I\", \"sLogin property becomes true, the WebView in the LoginView becomes visible. The WebView data binds i\", \"ts Source property to the LoginUrl property of the LoginViewModel class, and so makes a sign-in requ\", \"est to IdentityServer when the LoginUrl property is set to IdentityServer's authorization endpoint. \", \"When IdentityServer receives this request and the user isn't authenticated, the WebView will be redi\", \"rected to the configured login page, which is shown in Figure 9-4.\\n\\nFigure 9-4: Login page displayed\", \" by the WebView\\n\\nOnce login is completed, the WebView will be redirected to a return URI. This WebVi\", \"ew navigation will cause the NavigateAsync method in the LoginViewModel class to be executed, which \", \"is shown in the following code example:\\n\\n66\\n\\nC HA PTER 9 | Authentication and authorization\\n\\nprivate\", \" async Task NavigateAsync(string url) { ... var authResponse = new AuthorizeResponse(url); if (!stri\", \"ng.IsNullOrWhiteSpace(authResponse.Code)) { var userToken = await _identityService.GetTokenAsync(aut\", \"hResponse.Code); string accessToken = userToken.AccessToken;\\n\\nif (!string.IsNullOrWhiteSpace(accessT\", \"oken)) { Settings.AuthAccessToken = accessToken; Settings.AuthIdToken = authResponse.IdentityToken;\\n\", \"\\nawait NavigationService.NavigateToAsync<MainViewModel>(); await NavigationService.RemoveLastFromBac\", \"kStackAsync(); } } ... }\\n\\nThis method parses the authentication response that's contained in the ret\", \"urn URI, and provided that a valid authorization code is present, it makes a request to IdentityServ\", \"er's token endpoint, passing the authorization code, the PKCE secret verifier, and other required pa\", \"rameters. The token endpoint is at /connect/token on port 5105 of the base endpoint exposed as a use\", \"r setting. For more information about user settings, see Configuration management.\\n\\nTip: Validate re\", \"turn URIs\\n\\nAlthough the eShopOnContainers mobile app doesn't validate the return URI, the best pract\", \"ice is to validate that the return URI refers to a known location in order to prevent open-redirect \", \"attacks.\\n\\nIf the token endpoint receives a valid authorization code and PKCE secret verifier, it res\", \"ponds with an access token, identity token, and refresh token. The access token (which allows access\", \" to API resources) and identity token are then stored as application settings, and page navigation i\", \"s performed. Therefore, the overall effect in the eShopOnContainers mobile app is this: provided tha\", \"t users are able to successfully authenticate with IdentityServer, they are navigated to the MainVie\", \"w page, which is a TabbedPage that displays the CatalogView as its selected tab.\\n\\nFor information ab\", \"out page navigation, see Navigation. For information about how WebView navigation causes a view mode\", \"l method to be executed, see Invoking navigation using behaviors. For information about application \", \"settings, see Configuration management.\\n\\nNote: The eShopOnContainers also allows a mock sign-in when\", \" the app is configured to use mock services in the SettingsView. In this mode, the app doesn't commu\", \"nicate with IdentityServer, instead allowing the user to sign-in using any credentials.\\n\\nSigning-out\", \"\\n\\nWhen the user taps the LOG OUT button in the ProfileView, the LogoutCommand in the ProfileViewMode\", \"l class is executed, which in turn executes the LogoutAsync method. This method performs page naviga\", \"tion to the LoginView page, passing a LogoutParameter instance set to true as a parameter. For more \", \"information about passing parameters during page navigation, see Passing parameters during navigatio\", \"n.\\n\\n67\\n\\nC HA PTER 9 | Authentication and authorization\\n\\nWhen a view is created and navigated to, the\", \" InitializeAsync method of the view's associated view model is executed, which then executes the Log\", \"out method of the LoginViewModel class, which is shown in the following code example:\\n\\nprivate void \", \"Logout() { var authIdToken = Settings.AuthIdToken; var logoutRequest = _identityService.CreateLogout\", \"Request(authIdToken);\\n\\nif (!string.IsNullOrEmpty(logoutRequest)) { // Logout LoginUrl = logoutReques\", \"t; } ... }\\n\\nThis method invokes the CreateLogoutRequest method in the IdentityService class, passing\", \" the identity token retrieved from application settings as a parameter. For more information about a\", \"pplication settings, see Configuration management. The following code example shows the CreateLogout\", \"Request method:\\n\\npublic string CreateLogoutRequest(string token) { ... return string.Format(\\\"{0}?id_\", \"token_hint={1}&post_logout_redirect_uri={2}\\\", GlobalSetting.Instance.LogoutEndpoint, token, GlobalSe\", \"tting.Instance.LogoutCallback); }\\n\\nThis method creates the URI to IdentityServer's end session endpo\", \"int, with the required parameters. The end session endpoint is at /connect/endsession on port 5105 o\", \"f the base endpoint exposed as a user setting. For more information about user settings, see Configu\", \"ration management.\\n\\nThe returned URI is stored in the LoginUrl property of the LoginViewModel class.\", \" While the IsLogin property is true, the WebView in the LoginView is visible. The WebView data binds\", \" its Source property to the LoginUrl property of the LoginViewModel class, and so makes a sign-out r\", \"equest to IdentityServer when the LoginUrl property is set to IdentityServer's end session endpoint.\", \" When IdentityServer receives this request, provided that the user is signed-in, sign-out occurs. Au\", \"thentication is tracked with a cookie managed by the cookie authentication middleware from ASP.NET C\", \"ore. Therefore, signing out of IdentityServer removes the authentication cookie and sends a post log\", \"out redirect URI back to the client.\\n\\nIn the mobile app, the WebView will be redirected to the post \", \"logout redirect URI. This WebView navigation will cause the NavigateAsync method in the LoginViewMod\", \"el class to be executed, which is shown in the following code example:\\n\\nprivate async Task NavigateA\", \"sync(string url) { ... Settings.AuthAccessToken = string.Empty; Settings.AuthIdToken = string.Empty;\", \" IsLogin = false; LoginUrl = _identityService.CreateAuthorizationRequest(); ... }\\n\\n68\\n\\nC HA PTER 9 |\", \" Authentication and authorization\\n\\nThis method clears both the identity token and the access token f\", \"rom application settings, and sets the IsLogin property to false, which causes the WebView on the Lo\", \"ginView page to become invisible. Finally, the LoginUrl property is set to the URI of IdentityServer\", \"'s authorization endpoint, with the required parameters, in preparation for the next time the user i\", \"nitiates a sign-in.\\n\\nFor information about page navigation, see Navigation. For information about ho\", \"w WebView navigation causes a view model method to be executed, see Invoking navigation using behavi\", \"ors. For information about application settings, see Configuration management.\\n\\nNote: The eShopOnCon\", \"tainers also allows a mock sign-out when the app is configured to use mock services in the SettingsV\", \"iew. In this mode, the app doesn't communicate with IdentityServer, and instead clears any stored to\", \"kens from application settings.\\n\\nAuthorization\\n\\nAfter authentication, ASP.NET Core web APIs often ne\", \"ed to authorize access, which allows a service to make APIs available to some authenticated users, b\", \"ut not to all.\\n\\nRestricting access to an ASP.NET Core MVC route can be achieved by applying an Autho\", \"rize attribute to a controller or action, which limits access to the controller or action to authent\", \"icated users, as shown in the following code example:\\n\\n[Authorize] public class BasketController : C\", \"ontroller { ... }\\n\\nIf an unauthorized user attempts to access a controller or action that's marked w\", \"ith the Authorize attribute, the MVC framework returns a 401 (unauthorized) HTTP status code.\\n\\nNote:\", \" Parameters can be specified on the Authorize attribute to restrict an API to specific users. For mo\", \"re information, see Authorization on the Microsoft Documentation Center.\\n\\n69\\n\\nC HA PTER 9 | Authenti\", \"cation and authorization\\n\\nIdentityServer can be integrated into the authorization workflow so that t\", \"he access tokens it provides control authorization. This approach is shown in Figure 9-5.\\n\\nFigure 9-\", \"5: Authorization by access token\\n\\nThe eShopOnContainers mobile app communicates with the identity mi\", \"croservice and requests an access token as part of the authentication process. The access token is t\", \"hen forwarded to the APIs exposed by the ordering and basket microservices as part of the access req\", \"uests. Access tokens contain information about the client, and the user. APIs then use that informat\", \"ion to authorize access to their data. For information about how to configure IdentityServer to prot\", \"ect APIs, see Configuring API resources.\\n\\nConfiguring IdentityServer to perform authorization\\n\\nTo pe\", \"rform authorization with IdentityServer, its authorization middleware must be added to the web appli\", \"cation's HTTP request pipeline. The middleware is added in the ConfigureAuth method in the web appli\", \"cation's Startup class, which is invoked from the Configure method, and is demonstrated in the follo\", \"wing code example from the eShopOnContainers reference application:\\n\\nprotected virtual void Configur\", \"eAuth(IApplicationBuilder app) { var identityUrl = Configuration.GetValue<string>(\\\"IdentityUrl\\\"); ap\", \"p.UseIdentityServerAuthentication(new IdentityServerAuthenticationOptions { Authority = identityUrl.\", \"ToString(), ScopeName = \\\"basket\\\", RequireHttpsMetadata = false }); }\\n\\nThis method ensures that the A\", \"PI can only be accessed with a valid access token. The middleware validates the incoming token to en\", \"sure that it's sent from a trusted issuer, and validates that the token is valid to be used with the\", \" API that receives it. Therefore, browsing to the ordering or basket controller will return a 401 (u\", \"nauthorized) HTTP status code, indicating that an access token is required.\\n\\n70\\n\\nC HA PTER 9 | Authe\", \"ntication and authorization\\n\\nNote: IdentityServer's authorization middleware must be added to the we\", \"b application's HTTP request pipeline before adding MVC with app.UseMvc() or app.UseMvcWithDefaultRo\", \"ute().\\n\\nMaking access requests to APIs\\n\\nWhen making requests to the ordering and basket microservice\", \"s, the access token, obtained from IdentityServer during the authentication process, must be include\", \"d in the request, as shown in the following code example:\\n\\nvar authToken = Settings.AuthAccessToken;\", \" Order = await _ordersService.GetOrderAsync(Convert.ToInt32(order.OrderNumber), authToken);\\n\\nThe acc\", \"ess token is stored as an application setting, and is retrieved from platform-specific storage and i\", \"ncluded in the call to the GetOrderAsync method in the OrderService class.\\n\\nSimilarly, the access to\", \"ken must be included when sending data to an IdentityServer protected API, as shown in the following\", \" code example:\\n\\nvar authToken = Settings.AuthAccessToken; await _basketService.UpdateBasketAsync(new\", \" CustomerBasket { BuyerId = userInfo.UserId, Items = BasketItems.ToList() }, authToken);\\n\\nThe access\", \" token is retrieved from platform-specific storage and included in the call to the UpdateBasketAsync\", \" method in the BasketService class.\\n\\nThe RequestProvider class, in the eShopOnContainers mobile app,\", \" uses the HttpClient class to make requests to the RESTful APIs exposed by the eShopOnContainers ref\", \"erence application. When making requests to the ordering and basket APIs, which require authorizatio\", \"n, a valid access token must be included with the request. This is achieved by adding the access tok\", \"en to the headers of the HttpClient instance, as demonstrated in the following code example:\\n\\nhttpCl\", \"ient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\\\"Bearer\\\", token);\\n\\nThe Defa\", \"ultRequestHeaders property of the HttpClient class exposes the headers that are sent with each reque\", \"st, and the access token is added to the Authorization header prefixed with the string Bearer. When \", \"the request is sent to a RESTful API, the value of the Authorization header is extracted and validat\", \"ed to ensure that it's sent from a trusted issuer, and used to determine whether the user has permis\", \"sion to invoke the API that receives it.\\n\\nFor more information about how the eShopOnContainers mobil\", \"e app makes web requests, see Accessing remote data.\\n\\nSummary\\n\\nThere are many approaches to integrat\", \"ing authentication and authorization into a Xamarin.Forms app that communicates with an ASP.NET MVC \", \"web application. The eShopOnContainers mobile app performs authentication and authorization with a c\", \"ontainerized identity microservice that uses IdentityServer 4. IdentityServer is an open source Open\", \"ID Connect and OAuth 2.0 framework for ASP.NET Core that integrates with ASP.NET Core Identity to pe\", \"rform bearer token authentication.\\n\\n71\\n\\nC HA PTER 9 | Authentication and authorization\\n\\nThe mobile a\", \"pp requests security tokens from IdentityServer, either for authenticating a user or for accessing a\", \" resource. When accessing a resource, an access token must be included in the request to APIs that r\", \"equire authorization. IdentityServer's middleware validates incoming access tokens to ensure that th\", \"ey are sent from a trusted issuer, and that they are valid to be used with the API that receives the\", \"m.\\n\\n72\\n\\nC HA PTER 9 | Authentication and authorization\\n\\nC H A P T E R\\n\\n10\\n\\nAccessing remote data\\n\\nMa\", \"ny modern web-based solutions make use of web services, hosted by web servers, to provide functional\", \"ity for remote client applications. The operations that a web service exposes constitute a web API.\\n\", \"\\nClient apps should be able to utilize the web API without knowing how the data or operations that t\", \"he API exposes are implemented. This requires that the API abides by common standards that enable a \", \"client app and web service to agree on which data formats to use, and the structure of the data that\", \" is exchanged between client apps and the web service.\\n\\nIntroduction to Representational State Trans\", \"fer\\n\\nRepresentational State Transfer (REST) is an architectural style for building distributed syste\", \"ms based on hypermedia. A primary advantage of the REST model is that it's based on open standards a\", \"nd doesn't bind the implementation of the model or the client apps that access it to any specific im\", \"plementation. Therefore, a REST web service could be implemented using Microsoft ASP.NET Core MVC, a\", \"nd client apps could be developing using any language and toolset that can generate HTTP requests an\", \"d parse HTTP responses.\\n\\nThe REST model uses a navigational scheme to represent objects and services\", \" over a network, referred to as resources. Systems that implement REST typically use the HTTP protoc\", \"ol to transmit requests to access these resources. In such systems, a client app submits a request i\", \"n the form of a URI that identifies a resource, and an HTTP method (such as GET, POST, PUT, or DELET\", \"E) that indicates the operation to be performed on that resource. The body of the HTTP request conta\", \"ins any data required to perform the operation.\\n\\nNote: REST defines a stateless request model. There\", \"fore, HTTP requests must be independent and might occur in any order.\\n\\nThe response from a REST requ\", \"est makes use of standard HTTP status codes. For example, a request that returns valid data should i\", \"nclude the HTTP response code 200 (OK), while a request that fails to find or delete a specified res\", \"ource should return a response that includes the HTTP status code 404 (Not Found).\\n\\nA RESTful web AP\", \"I exposes a set of connected resources, and provides the core operations that enable an app to manip\", \"ulate those resources and easily navigate between them. For this reason, the URIs that constitute a \", \"typical RESTful web API are oriented towards the data that it exposes, and use the facilities provid\", \"ed by HTTP to operate on this data.\\n\\n73\\n\\nC HA PTER 10 | Accessing remote data\\n\\nThe data included by \", \"a client app in an HTTP request, and the corresponding response messages from the web server, could \", \"be presented in a variety of formats, known as media types. When a client app sends a request that r\", \"eturns data in the body of a message, it can specify the media types it can handle in the Accept hea\", \"der of the request. If the web server supports this media type, it can reply with a response that in\", \"cludes the Content-Type header that specifies the format of the data in the body of the message. It'\", \"s then the responsibility of the client app to parse the response message and interpret the results \", \"in the message body appropriately.\\n\\nFor more information about REST, see API design and API implemen\", \"tation on Microsoft Docs.\\n\\nConsuming RESTful APIs\\n\\nThe eShopOnContainers mobile app uses the Model-V\", \"iew-ViewModel (MVVM) pattern, and the model elements of the pattern represent the domain entities us\", \"ed in the app. The controller and repository classes in the eShopOnContainers reference application \", \"accept and return many of these model objects. Therefore, they are used as data transfer objects (DT\", \"Os) that hold all the data that is passed between the mobile app and the containerized microservices\", \". The main benefit of using DTOs to pass data to and receive data from a web service is that by tran\", \"smitting more data in a single remote call, the app can reduce the number of remote calls that need \", \"to be made.\\n\\nMaking web requests\\n\\nThe eShopOnContainers mobile app uses the HttpClient class to make\", \" requests over HTTP, with JSON being used as the media type. This class provides functionality for a\", \"synchronously sending HTTP requests and receiving HTTP responses from a URI identified resource. The\", \" HttpResponseMessage class represents an HTTP response message received from a REST API after an HTT\", \"P request has been made. It contains information about the response, including the status code, head\", \"ers, and any body. The HttpContent class represents the HTTP body and content headers, such as Conte\", \"nt-Type and Content-Encoding. The content can be read using any of the ReadAs methods, such as ReadA\", \"sStringAsync and ReadAsByteArrayAsync, depending on the format of the data.\\n\\nMaking a GET request\\n\\nT\", \"he CatalogService class is used to manage the data retrieval process from the catalog microservice. \", \"In the RegisterDependencies method in the ViewModelLocator class, the CatalogService class is regist\", \"ered as a type mapping against the ICatalogService type with the Autofac dependency injection contai\", \"ner. Then, when an instance of the CatalogViewModel class is created, its constructor accepts an ICa\", \"talogService type, which Autofac resolves, returning an instance of the CatalogService class. For mo\", \"re information about dependency injection, see Introduction to dependency injection.\\n\\nFigure 10-1 sh\", \"ows the interaction of classes that read catalog data from the catalog microservice for displaying b\", \"y the CatalogView.\\n\\n74\\n\\nC HA PTER 10 | Accessing remote data\\n\\nFigure 10-1: Retrieving data from the \", \"catalog microservice\\n\\nWhen the CatalogView is navigated to, the OnInitialize method in the CatalogVi\", \"ewModel class is called. This method retrieves catalog data from the catalog microservice, as demons\", \"trated in the following code example:\\n\\npublic override async Task InitializeAsync(object navigationD\", \"ata) { ... Products = await _productsService.GetCatalogAsync(); ... }\\n\\nThis method calls the GetCata\", \"logAsync method of the CatalogService instance that was injected into the CatalogViewModel by Autofa\", \"c. The following code example shows the GetCatalogAsync method:\\n\\npublic async Task<ObservableCollect\", \"ion<CatalogItem>> GetCatalogAsync() { UriBuilder builder = new UriBuilder(GlobalSetting.Instance.Cat\", \"alogEndpoint); builder.Path = \\\"api/v1/catalog/items\\\"; string uri = builder.ToString();\\n\\nCatalogRoot \", \"catalog = await _requestProvider.GetAsync<CatalogRoot>(uri); ...\\n\\n75\\n\\nC HA PTER 10 | Accessing remot\", \"e data\\n\\nreturn catalog?.Data.ToObservableCollection(); }\\n\\nThis method builds the URI that identifies\", \" the resource the request will be sent to, and uses the RequestProvider class to invoke the GET HTTP\", \" method on the resource, before returning the results to the CatalogViewModel. The RequestProvider c\", \"lass contains functionality that submits a request in the form of a URI that identifies a resource, \", \"an HTTP method that indicates the operation to be performed on that resource, and a body that contai\", \"ns any data required to perform the operation. For information about how the RequestProvider class i\", \"s injected into the CatalogService class, see Introduction to dependency injection.\\n\\nThe following c\", \"ode example shows the GetAsync method in the RequestProvider class:\\n\\npublic async Task<TResult> GetA\", \"sync<TResult>(string uri, string token = \\\"\\\") { HttpClient httpClient = CreateHttpClient(token); Http\", \"ResponseMessage response = await httpClient.GetAsync(uri);\\n\\nawait HandleResponse(response); string s\", \"erialized = await response.Content.ReadAsStringAsync();\\n\\nTResult result = await Task.Run(() => JsonC\", \"onvert.DeserializeObject<TResult>(serialized, _serializerSettings));\\n\\nreturn result; }\\n\\nThis method \", \"calls the CreateHttpClient method, which returns an instance of the HttpClient class with the approp\", \"riate headers set. It then submits an asynchronous GET request to the resource identified by the URI\", \", with the response being stored in the HttpResponseMessage instance. The HandleResponse method is t\", \"hen invoked, which throws an exception if the response doesn't include a success HTTP status code. T\", \"hen the response is read as a string, converted from JSON to a CatalogRoot object, and returned to t\", \"he CatalogService.\\n\\nThe CreateHttpClient method is shown in the following code example:\\n\\nprivate Htt\", \"pClient CreateHttpClient(string token = \\\"\\\") { var httpClient = new HttpClient(); httpClient.DefaultR\", \"equestHeaders.Accept.Add( new MediaTypeWithQualityHeaderValue(\\\"application/json\\\"));\\n\\nif (!string.IsN\", \"ullOrEmpty(token)) { httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\", \"\\\"Bearer\\\", token); } return httpClient; }\\n\\nThis method creates a new instance of the HttpClient class\", \", and sets the Accept header of any requests made by the HttpClient instance to application/json, wh\", \"ich indicates that it expects the content of any response to be formatted using JSON. Then, if an ac\", \"cess token was passed as an argument to the CreateHttpClient method, it's added to the Authorization\", \" header of any requests made by the HttpClient instance, prefixed with the string Bearer. For more i\", \"nformation about authorization, see Authorization.\\n\\n76\\n\\nC HA PTER 10 | Accessing remote data\\n\\nWhen t\", \"he GetAsync method in the RequestProvider class calls HttpClient.GetAsync, the Items method in the C\", \"atalogController class in the Catalog.API project is invoked, which is shown in the following code e\", \"xample:\\n\\n[HttpGet] [Route(\\\"[action]\\\")] public async Task<IActionResult> Items( [FromQuery]int pageSi\", \"ze = 10, [FromQuery]int pageIndex = 0) { var totalItems = await _catalogContext.CatalogItems .LongCo\", \"untAsync();\\n\\nvar itemsOnPage = await _catalogContext.CatalogItems .OrderBy(c=>c.Name) .Skip(pageSize\", \" * pageIndex) .Take(pageSize) .ToListAsync();\\n\\nitemsOnPage = ComposePicUri(itemsOnPage); var model =\", \" new PaginatedItemsViewModel<CatalogItem>( pageIndex, pageSize, totalItems, itemsOnPage);\\n\\nreturn Ok\", \"(model); }\\n\\nThis method retrieves the catalog data from the SQL database using EntityFramework, and \", \"returns it as a response message that includes a success HTTP status code, and a collection of JSON \", \"formatted CatalogItem instances.\\n\\nMaking a POST request\\n\\nThe BasketService class is used to manage t\", \"he data retrieval and update process with the basket microservice. In the RegisterDependencies metho\", \"d in the ViewModelLocator class, the BasketService class is registered as a type mapping against the\", \" IBasketService type with the Autofac dependency injection container. Then, when an instance of the \", \"BasketViewModel class is created, its constructor accepts an IBasketService type, which Autofac reso\", \"lves, returning an instance of the BasketService class. For more information about dependency inject\", \"ion, see Introduction to dependency injection.\\n\\nFigure 10-2 shows the interaction of classes that se\", \"nd the basket data displayed by the BasketView, to the basket microservice.\\n\\n77\\n\\nC HA PTER 10 | Acce\", \"ssing remote data\\n\\nFigure 10-2: Sending data to the basket microservice\\n\\nWhen an item is added to th\", \"e shopping basket, the ReCalculateTotalAsync method in the BasketViewModel class is called. This met\", \"hod updates the total value of items in the basket, and sends the basket data to the basket microser\", \"vice, as demonstrated in the following code example:\\n\\nprivate async Task ReCalculateTotalAsync() { .\", \".. await _basketService.UpdateBasketAsync(new CustomerBasket { BuyerId = userInfo.UserId, Items = Ba\", \"sketItems.ToList() }, authToken); }\\n\\nThis method calls the UpdateBasketAsync method of the BasketSer\", \"vice instance that was injected into the BasketViewModel by Autofac. The following method shows the \", \"UpdateBasketAsync method:\\n\\npublic async Task<CustomerBasket> UpdateBasketAsync(CustomerBasket custom\", \"erBasket, string token) { UriBuilder builder = new UriBuilder(GlobalSetting.Instance.BasketEndpoint)\", \"; string uri = builder.ToString();\\n\\n78\\n\\nC HA PTER 10 | Accessing remote data\\n\\nvar result = await _re\", \"questProvider.PostAsync(uri, customerBasket, token); return result; }\\n\\nThis method builds the URI th\", \"at identifies the resource the request will be sent to, and uses the RequestProvider class to invoke\", \" the POST HTTP method on the resource, before returning the results to the BasketViewModel. Note tha\", \"t an access token, obtained from IdentityServer during the authentication process, is required to au\", \"thorize requests to the basket microservice. For more information about authorization, see Authoriza\", \"tion.\\n\\nThe following code example shows one of the PostAsync methods in the RequestProvider class:\\n\\n\", \"public async Task<TResult> PostAsync<TResult>( string uri, TResult data, string token = \\\"\\\", string h\", \"eader = \\\"\\\") { HttpClient httpClient = CreateHttpClient(token); ... var content = new StringContent(J\", \"sonConvert.SerializeObject(data)); content.Headers.ContentType = new MediaTypeHeaderValue(\\\"applicati\", \"on/json\\\"); HttpResponseMessage response = await httpClient.PostAsync(uri, content);\\n\\nawait HandleRes\", \"ponse(response); string serialized = await response.Content.ReadAsStringAsync();\\n\\nTResult result = a\", \"wait Task.Run(() => JsonConvert.DeserializeObject<TResult>(serialized, _serializerSettings));\\n\\nretur\", \"n result; }\\n\\nThis method calls the CreateHttpClient method, which returns an instance of the HttpCli\", \"ent class with the appropriate headers set. It then submits an asynchronous POST request to the reso\", \"urce identified by the URI, with the serialized basket data being sent in JSON format, and the respo\", \"nse being stored in the HttpResponseMessage instance. The HandleResponse method is then invoked, whi\", \"ch throws an exception if the response doesn't include a success HTTP status code. Then, the respons\", \"e is read as a string, converted from JSON to a CustomerBasket object, and returned to the BasketSer\", \"vice. For more information about the CreateHttpClient method, see Making a GET request.\\n\\nWhen the Po\", \"stAsync method in the RequestProvider class calls HttpClient.PostAsync, the Post method in the Baske\", \"tController class in the Basket.API project is invoked, which is shown in the following code example\", \":\\n\\n[HttpPost] public async Task<IActionResult> Post([FromBody]CustomerBasket value) { var basket = a\", \"wait _repository.UpdateBasketAsync(value); return Ok(basket); }\\n\\nThis method uses an instance of the\", \" RedisBasketRepository class to persist the basket data to the Redis cache, and returns it as a resp\", \"onse message that includes a success HTTP status code, and a JSON formatted CustomerBasket instance.\", \"\\n\\nMaking a DELETE request\\n\\nFigure 10-3 shows the interactions of classes that delete basket data fro\", \"m the basket microservice, for the CheckoutView.\\n\\n79\\n\\nC HA PTER 10 | Accessing remote data\\n\\nFigure 1\", \"0-3: Deleting data from the basket microservice\\n\\nWhen the checkout process is invoked, the CheckoutA\", \"sync method in the CheckoutViewModel class is called. This method creates a new order, before cleari\", \"ng the shopping basket, as demonstrated in the following code example:\\n\\nprivate async Task CheckoutA\", \"sync() { ... await _basketService.ClearBasketAsync(_shippingAddress.Id.ToString(), authToken); ... }\", \"\\n\\nThis method calls the ClearBasketAsync method of the BasketService instance that was injected into\", \" the CheckoutViewModel by Autofac. The following method shows the ClearBasketAsync method:\\n\\npublic a\", \"sync Task ClearBasketAsync(string guidUser, string token) { UriBuilder builder = new UriBuilder(Glob\", \"alSetting.Instance.BasketEndpoint); builder.Path = guidUser; string uri = builder.ToString(); await \", \"_requestProvider.DeleteAsync(uri, token); }\\n\\nThis method builds the URI that identifies the resource\", \" that the request will be sent to, and uses the RequestProvider class to invoke the DELETE HTTP meth\", \"od on the resource. Note that an access token, obtained from IdentityServer during the authenticatio\", \"n process, is required to authorize requests to the basket microservice. For more information about \", \"authorization, see Authorization.\\n\\nThe following code example shows the DeleteAsync method in the Re\", \"questProvider class:\\n\\n80\\n\\nC HA PTER 10 | Accessing remote data\\n\\npublic async Task DeleteAsync(string\", \" uri, string token = \\\"\\\") { HttpClient httpClient = CreateHttpClient(token); await httpClient.DeleteA\", \"sync(uri); }\\n\\nThis method calls the CreateHttpClient method, which returns an instance of the HttpCl\", \"ient class with the appropriate headers set. It then submits an asynchronous DELETE request to the r\", \"esource identified by the URI. For more information about the CreateHttpClient method, see Making a \", \"GET request.\\n\\nWhen the DeleteAsync method in the RequestProvider class calls HttpClient.DeleteAsync,\", \" the Delete method in the BasketController class in the Basket.API project is invoked, which is show\", \"n in the following code example:\\n\\n[HttpDelete(\\\"{id}\\\")] public void Delete(string id) { _repository.D\", \"eleteBasketAsync(id); }\\n\\nThis method uses an instance of the RedisBasketRepository class to delete t\", \"he basket data from the Redis cache.\\n\\nCaching data\\n\\nThe performance of an app can be improved by cac\", \"hing frequently accessed data to fast storage that's located close to the app. If the fast storage i\", \"s located closer to the app than the original source, then caching can significantly improve respons\", \"e times when retrieving data.\\n\\nThe most common form of caching is read-through caching, where an app\", \" retrieves data by referencing the cache. If the data isn't in the cache, it's retrieved from the da\", \"ta store and added to the cache. Apps can implement read-through caching with the cache-aside patter\", \"n. This pattern determines whether the item is currently in the cache. If the item isn't in the cach\", \"e, it's read from the data store and added to the cache. For more information, see the Cache-Aside p\", \"attern on Microsoft Docs.\\n\\nTip: Cache data that's read frequently and that changes infrequently\\n\\nThi\", \"s data can be added to the cache on demand the first time it is retrieved by an app. This means that\", \" the app needs to fetch the data only once from the data store, and that subsequent access can be sa\", \"tisfied by using the cache.\\n\\nDistributed applications, such as the eShopOnContainers reference appli\", \"cation, should provide either or both of the following caches:\\n\\nA shared cache, which can be accesse\", \"d by multiple processes or machines.\\n\\nA private cache, where data is held locally on the device runn\", \"ing the app.\\n\\nThe eShopOnContainers mobile app uses a private cache, where data is held locally on t\", \"he device that's running an instance of the app. For information about the cache used by the eShopOn\", \"Containers reference application, see .NET Microservices: Architecture for Containerized .NET Applic\", \"ations.\\n\\n81\\n\\nC HA PTER 10 | Accessing remote data\\n\\nTip: Think of the cache as a transient data store\", \" that could disappear at any time\\n\\nEnsure that data is maintained in the original data store as well\", \" as the cache. The chances of losing data are then minimized if the cache becomes unavailable.\\n\\nMana\", \"ging data expiration\\n\\nIt's impractical to expect that cached data will always be consistent with the\", \" original data. Data in the original data store might change after it's been cached, causing the cac\", \"hed data to become stale. Therefore, apps should implement a strategy that helps to ensure that the \", \"data in the cache is as up- to-date as possible, but can also detect and handle situations that aris\", \"e when the data in the cache has become stale. Most caching mechanisms enable the cache to be config\", \"ured to expire data, and hence reduce the period for which data might be out of date.\\n\\nTip: Set a de\", \"fault expiration time when configuring a cache\\n\\nMany caches implement expiration, which invalidates \", \"data and removes it from the cache if it's not accessed for a specified period. However, care must b\", \"e taken when choosing the expiration period. If it's made too short, data will expire too quickly an\", \"d the benefits of caching will be reduced. If it's made too long, the data risks becoming stale. The\", \"refore, the expiration time should match the pattern of access for apps that use the data.\\n\\nWhen cac\", \"hed data expires, it should be removed from the cache, and the app must retrieve the data from the o\", \"riginal data store and place it back into the cache.\\n\\nIt's also possible that a cache might fill up \", \"if data is allowed to remain for too long a period. Therefore, requests to add new items to the cach\", \"e might be required to remove some items in a process known as eviction. Caching services typically \", \"evict data on a least-recently-used basis. However, there are other eviction policies, including mos\", \"t-recently-used, and first-in-first-out. For more information, see Caching Guidance on Microsoft Doc\", \"s.\\n\\nCaching images\\n\\nThe eShopOnContainers mobile app consumes remote product images that benefit fro\", \"m being cached. These images are displayed by the Image control, and the CachedImage control provide\", \"d by the FFImageLoading library.\\n\\nThe Xamarin.Forms Image control supports caching of downloaded ima\", \"ges. Caching is enabled by default, and will store the image locally for 24 hours. In addition, the \", \"expiration time can be configured with the CacheValidity property. For more information, see Downloa\", \"ded Image Caching on the Xamarin Developer Center.\\n\\nFFImageLoading's CachedImage control is a replac\", \"ement for the Xamarin.Forms Image control, providing additional properties that enable supplementary\", \" functionality. Amongst this functionality, the control provides configurable caching, while support\", \"ing error and loading image placeholders. The following code example shows how the eShopOnContainers\", \" mobile app uses the CachedImage control in the ProductTemplate, which is the data template used by \", \"the ListView control in the CatalogView:\\n\\n<ffimageloading:CachedImage Grid.Row=\\\"0\\\" Source=\\\"{Binding \", \"PictureUri}\\\" Aspect=\\\"AspectFill\\\"> <ffimageloading:CachedImage.LoadingPlaceholder> <OnPlatform x:Type\", \"Arguments=\\\"ImageSource\\\"\\n\\n82\\n\\nC HA PTER 10 | Accessing remote data\\n\\niOS=\\\"default_product\\\" Android=\\\"de\", \"fault_product\\\" WinPhone=\\\"Assets/default_product.png\\\"/> </ffimageloading:CachedImage.LoadingPlacehold\", \"er> <ffimageloading:CachedImage.ErrorPlaceholder> <OnPlatform x:TypeArguments=\\\"ImageSource\\\" iOS=\\\"noi\", \"mage\\\" Android=\\\"noimage\\\" WinPhone=\\\"Assets/noimage.png\\\"/> </ffimageloading:CachedImage.ErrorPlaceholde\", \"r> </ffimageloading:CachedImage>\\n\\nThe CachedImage control sets the LoadingPlaceholder and ErrorPlace\", \"holder properties to platform-specific images. The LoadingPlaceholder property specifies the image t\", \"o be displayed while the image specified by the Source property is retrieved, and the ErrorPlacehold\", \"er property specifies the image to be displayed if an error occurs when attempting to retrieve the i\", \"mage specified by the Source property.\\n\\nAs the name implies, the CachedImage control caches remote i\", \"mages on the device for the time specified by the value of the CacheDuration property. When this pro\", \"perty value isn't explicitly set, the default value of 30 days is applied.\\n\\nIncreasing resilience\\n\\nA\", \"ll apps that communicate with remote services and resources must be sensitive to transient faults. T\", \"ransient faults include the momentary loss of network connectivity to services, the temporary unavai\", \"lability of a service, or timeouts that arise when a service is busy. These faults are often self- c\", \"orrecting, and if the action is repeated after a suitable delay it's likely to succeed.\\n\\nTransient f\", \"aults can have a huge impact on the perceived quality of an app, even if it has been thoroughly test\", \"ed under all foreseeable circumstances. To ensure that an app that communicates with remote services\", \" operates reliably, it must be able to do all of the following:\\n\\nDetect faults when they occur, and \", \"determine if the faults are likely to be transient.\\n\\nRetry the operation if it determines that the f\", \"ault is likely to be transient and keep track of the number of times the operation was retried.\\n\\nUse\", \" an appropriate retry strategy, which specifies the number of retries, the delay between each attemp\", \"t, and the actions to take after a failed attempt.\\n\\nThis transient fault handling can be achieved by\", \" wrapping all attempts to access a remote service in code that implements the retry pattern.\\n\\nRetry \", \"pattern\\n\\nIf an app detects a failure when it tries to send a request to a remote service, it can han\", \"dle the failure in any of the following ways:\\n\\nRetrying the operation. The app could retry the faili\", \"ng request immediately.\\n\\nRetrying the operation after a delay. The app should wait for a suitable am\", \"ount of time before retrying the request.\\n\\nCancelling the operation. The application should cancel t\", \"he operation and report an exception.\\n\\n83\\n\\nC HA PTER 10 | Accessing remote data\\n\\nThe retry strategy \", \"should be tuned to match the business requirements of the app. For example, it's important to optimi\", \"ze the retry count and retry interval to the operation being attempted. If the operation is part of \", \"a user interaction, the retry interval should be short and only a few retries attempted to avoid mak\", \"ing users wait for a response. If the operation is part of a long running workflow, where cancelling\", \" or restarting the workflow is expensive or time-consuming, it's appropriate to wait longer between \", \"attempts and to retry more times.\\n\\nNote: An aggressive retry strategy with minimal delay between att\", \"empts, and a large number of retries, could degrade a remote service that's running close to or at c\", \"apacity. In addition, such a retry strategy could also affect the responsiveness of the app if it's \", \"continually trying to perform a failing operation.\\n\\nIf a request still fails after a number of retri\", \"es, it's better for the app to prevent further requests going to the same resource and to report a f\", \"ailure. Then, after a set period, the app can make one or more requests to the resource to see if th\", \"ey're successful. For more information, see Circuit breaker pattern.\\n\\nTip: Never implement an endles\", \"s retry mechanism\\n\\nUse a finite number of retries, or implement the Circuit Breaker pattern to allow\", \" a service to recover.\\n\\nThe eShopOnContainers mobile app does not currently implement the retry patt\", \"ern when making RESTful web requests. However, the CachedImage control, provided by the FFImageLoadi\", \"ng library supports transient fault handling by retrying image loading. If image loading fails, furt\", \"her attempts will be made. The number of attempts is specified by the RetryCount property, and retri\", \"es will occur after a delay specified by the RetryDelay property. If these property values aren't ex\", \"plicitly set, their default values are applied \\u2013 3 for the RetryCount property, and 250ms for the Re\", \"tryDelay property. For more information about the CachedImage control, see Caching images.\\n\\nThe eSho\", \"pOnContainers reference application does implement the retry pattern. For more information, includin\", \"g a discussion of how to combine the retry pattern with the HttpClient class, see .NET Microservices\", \": Architecture for Containerized .NET Applications.\\n\\nFor more information about the retry pattern, s\", \"ee the Retry pattern on Microsoft Docs.\\n\\nCircuit breaker pattern\\n\\nIn some situations, faults can occ\", \"ur due to anticipated events that take longer to fix. These faults can range from a partial loss of \", \"connectivity to the complete failure of a service. In these situations, it's pointless for an app to\", \" retry an operation that's unlikely to succeed, and instead should accept that the operation has fai\", \"led and handle this failure accordingly.\\n\\nThe circuit breaker pattern can prevent an app from repeat\", \"edly trying to execute an operation that's likely to fail, while also enabling the app to detect whe\", \"ther the fault has been resolved.\\n\\nNote: The purpose of the circuit breaker pattern is different fro\", \"m the retry pattern. The retry pattern enables an app to retry an operation in the expectation that \", \"it'll succeed. The circuit breaker pattern prevents an app from performing an operation that's likel\", \"y to fail.\\n\\nA circuit breaker acts as a proxy for operations that might fail. The proxy should monit\", \"or the number of recent failures that have occurred, and use this information to decide whether to a\", \"llow the operation to proceed, or to return an exception immediately.\\n\\nThe eShopOnContainers mobile \", \"app does not currently implement the circuit breaker pattern. However, the eShopOnContainers does. F\", \"or more information, see .NET Microservices: Architecture for Containerized .NET Applications.\\n\\n84\\n\\n\", \"C HA PTER 10 | Accessing remote data\\n\\nTip: Combine the retry and circuit breaker patterns\\n\\nAn app ca\", \"n combine the retry and circuit breaker patterns by using the retry pattern to invoke an operation t\", \"hrough a circuit breaker. However, the retry logic should be sensitive to any exceptions returned by\", \" the circuit breaker and abandon retry attempts if the circuit breaker indicates that a fault is not\", \" transient.\\n\\nFor more information about the circuit breaker pattern, see the Circuit Breaker pattern\", \" on Microsoft Docs.\\n\\nSummary\\n\\nMany modern web-based solutions make use of web services, hosted by we\", \"b servers, to provide functionality for remote client applications. The operations that a web servic\", \"e exposes constitute a web API, and client apps should be able to utilize the web API without knowin\", \"g how the data or operations that the API exposes are implemented.\\n\\nThe performance of an app can be\", \" improved by caching frequently accessed data to fast storage that's located close to the app. Apps \", \"can implement read-through caching with the cache-aside pattern. This pattern determines whether the\", \" item is currently in the cache. If the item isn't in the cache, it's read from the data store and a\", \"dded to the cache.\\n\\nWhen communicating with web APIs, apps must be sensitive to transient faults. Tr\", \"ansient faults include the momentary loss of network connectivity to services, the temporary unavail\", \"ability of a service, or timeouts that arise when a service is busy. These faults are often self-cor\", \"recting, and if the action is repeated after a suitable delay, then it's likely to succeed. Therefor\", \"e, apps should wrap all attempts to access a web API in code that implements a transient fault handl\", \"ing mechanism.\\n\\n85\\n\\nC HA PTER 10 | Accessing remote data\\n\\nC H A P T E R\\n\\n11\\n\\nUnit testing\\n\\nMobile ap\", \"ps have unique problems that desktop and web-based applications don't have to worry about. Mobile us\", \"ers will differ by the devices that they use, by network connectivity, by the availability of servic\", \"es, and a range of other factors. Therefore, mobile apps should be tested as they will be used in th\", \"e real world in order to improve their quality, reliability, and performance. There are many types o\", \"f testing that should be performed on an app, including unit testing, integration testing, and user \", \"interface testing, with unit testing being the most common form of testing.\\n\\nA unit test takes a sma\", \"ll unit of the app, typically a method, isolates it from the remainder of the code, and verifies tha\", \"t it behaves as expected. Its goal is to check that each unit of functionality performs as expected,\", \" so that errors don't propagate throughout the app. Detecting a bug where it occurs is more efficien\", \"t that observing the effect of a bug indirectly at a secondary point of failure.\\n\\nUnit testing has t\", \"he greatest effect on code quality when it's an integral part of the software development workflow. \", \"As soon as a method has been written, unit tests should be written that verify the behavior of the m\", \"ethod in response to standard, boundary, and incorrect cases of input data, and that check any expli\", \"cit or implicit assumptions made by the code. Alternatively, with test driven development, unit test\", \"s are written before the code. In this scenario, unit tests act as both design documentation and fun\", \"ctional specifications.\\n\\nNote: Unit tests are very effective against regression \\u2013 that is, functiona\", \"lity that used to work but has been disturbed by a faulty update.\\n\\nUnit tests typically use the arra\", \"nge-act-assert pattern:\\n\\nThe arrange section of the unit test method initializes objects and sets th\", \"e value of the data that is passed to the method under test.\\n\\nThe act section invokes the method und\", \"er test with the required arguments.\\n\\nThe assert section verifies that the action of the method unde\", \"r test behaves as expected.\\n\\nFollowing this pattern ensures that unit tests are readable and consist\", \"ent.\\n\\nDependency injection and unit testing\\n\\nOne of the motivations for adopting a loosely-coupled a\", \"rchitecture is that it facilitates unit testing. One of the types registered with Autofac is the Ord\", \"erService class. The following code example shows an outline of this class:\\n\\npublic class OrderDetai\", \"lViewModel : ViewModelBase { private IOrderService _ordersService;\\n\\npublic OrderDetailViewModel(IOrd\", \"erService ordersService)\\n\\n86\\n\\nC HA PTER 11 | Unit testing\\n\\n{ _ordersService = ordersService; } ... }\", \"\\n\\nThe OrderDetailViewModel class has a dependency on the IOrderService type which the container reso\", \"lves when it instantiates a OrderDetailViewModel object. However, rather than create an OrderService\", \" object to unit test the OrderDetailViewModel class, instead, replace the OrderService object with a\", \" mock for the purpose of the tests. Figure 10-1 illustrates this relationship.\\n\\nFigure 10-1: Classes\", \" that implement the IOrderService interface\\n\\nThis approach allows the OrderService object to be pass\", \"ed into the OrderDetailViewModel class at runtime, and in the interests of testability, it allows th\", \"e OrderMockService class to be passed into the OrderDetailViewModel class at test time. The main adv\", \"antage of this approach is that it enables unit tests to be executed without requiring unwieldy reso\", \"urces such as web services, or databases.\\n\\nTesting MVVM applications\\n\\nTesting models and view models\", \" from MVVM applications is identical to testing any other classes, and the same tools and techniques\", \" \\u2013 such as unit testing and mocking, can be used. However, there are some patterns that are typical \", \"to model and view model classes, that can benefit from specific unit testing techniques.\\n\\nTip: Test \", \"one thing with each unit test\\n\\nDon't be tempted to make a unit test exercise more than one aspect of\", \" the unit's behavior. Doing so leads to tests that are difficult to read and update. It can also lea\", \"d to confusion when interpreting a failure.\\n\\nThe eShopOnContainers mobile app uses xUnit to perform \", \"unit testing, which supports two different types of unit tests:\\n\\n\\n\\nFacts are tests that are always t\", \"rue, which test invariant conditions.\\n\\nTheories are tests that are only true for a particular set of\", \" data.\\n\\n87\\n\\nC HA PTER 11 | Unit testing\\n\\nThe unit tests included with the eShopOnContainers mobile a\", \"pp are fact tests, and so each unit test method is decorated with the [Fact] attribute.\\n\\nNote: xUnit\", \" tests are executed by a test runner. To execute the test runner, run the eShopOnContainers.TestRunn\", \"er project for the required platform.\\n\\nTesting asynchronous functionality\\n\\nWhen implementing the MVV\", \"M pattern, view models usually invoke operations on services, often asynchronously. Tests for code t\", \"hat invokes these operations typically use mocks as replacements for the actual services. The follow\", \"ing code example demonstrates testing asynchronous functionality by passing a mock service into a vi\", \"ew model:\\n\\n[Fact] public async Task OrderPropertyIsNotNullAfterViewModelInitializationTest() { var o\", \"rderService = new OrderMockService(); var orderViewModel = new OrderDetailViewModel(orderService);\\n\\n\", \"var order = await orderService.GetOrderAsync(1, GlobalSetting.Instance.AuthToken); await orderViewMo\", \"del.InitializeAsync(order);\\n\\nAssert.NotNull(orderViewModel.Order); }\\n\\nThis unit test checks that the\", \" Order property of the OrderDetailViewModel instance will have a value after the InitializeAsync met\", \"hod has been invoked. The InitializeAsync method is invoked when the view model's corresponding view\", \" is navigated to. For more information about navigation, see Navigation.\\n\\nWhen the OrderDetailViewMo\", \"del instance is created, it expects an OrderService instance to be specified as an argument. However\", \", the OrderService retrieves data from a web service. Therefore, an OrderMockService instance, which\", \" is a mock version of the OrderService class, is specified as the argument to the OrderDetailViewMod\", \"el constructor. Then, when the view model's InitializeAsync method is invoked, which invokes IOrderS\", \"ervice operations, mock data is retrieved rather than communicating with a web service.\\n\\nTesting INo\", \"tifyPropertyChanged implementations\\n\\nImplementing the INotifyPropertyChanged interface allows views \", \"to react to changes that originate from view models and models. These changes are not limited to dat\", \"a shown in controls \\u2013 they are also used to control the view, such as view model states that cause a\", \"nimations to be started or controls to be disabled.\\n\\nProperties that can be updated directly by the \", \"unit test can be tested by attaching an event handler to the PropertyChanged event and checking whet\", \"her the event is raised after setting a new value for the property. The following code example shows\", \" such a test:\\n\\n[Fact] public async Task SettingOrderPropertyShouldRaisePropertyChanged() { bool invo\", \"ked = false; var orderService = new OrderMockService(); var orderViewModel = new OrderDetailViewMode\", \"l(orderService);\\n\\norderViewModel.PropertyChanged += (sender, e) => {\\n\\n88\\n\\nC HA PTER 11 | Unit testin\", \"g\\n\\nif (e.PropertyName.Equals(\\\"Order\\\")) invoked = true; }; var order = await orderService.GetOrderAsy\", \"nc(1, GlobalSetting.Instance.AuthToken); await orderViewModel.InitializeAsync(order);\\n\\nAssert.True(i\", \"nvoked); }\\n\\nThis unit test invokes the InitializeAsync method of the OrderViewModel class, which cau\", \"ses its Order property to be updated. The unit test will pass, provided that the PropertyChanged eve\", \"nt is raised for the Order property.\\n\\nTesting message-based communication\\n\\nView models that use the \", \"MessagingCenter class to communicate between loosely-coupled classes can be unit tested by subscribi\", \"ng to the message being sent by the code under test, as demonstrated in the following code example:\\n\", \"\\n[Fact] public void AddCatalogItemCommandSendsAddProductMessageTest() { bool messageReceived = false\", \"; var catalogService = new CatalogMockService(); var catalogViewModel = new CatalogViewModel(catalog\", \"Service);\\n\\nXamarin.Forms.MessagingCenter.Subscribe<CatalogViewModel, CatalogItem>( this, MessageKeys\", \".AddProduct, (sender, arg) => { messageReceived = true; }); catalogViewModel.AddCatalogItemCommand.E\", \"xecute(null);\\n\\nAssert.True(messageReceived); }\\n\\nThis unit test checks that the CatalogViewModel publ\", \"ishes the AddProduct message in response to its AddCatalogItemCommand being executed. Because the Me\", \"ssagingCenter class supports multicast message subscriptions, the unit test can subscribe to the Add\", \"Product message and execute a callback delegate in response to receiving it. This callback delegate,\", \" specified as a lambda expression, sets a boolean field that's used by the Assert statement to verif\", \"y the behavior of the test.\\n\\nTesting exception handling\\n\\nUnit tests can also be written that check t\", \"hat specific exceptions are thrown for invalid actions or inputs, as demonstrated in the following c\", \"ode example:\\n\\n[Fact] public void InvalidEventNameShouldThrowArgumentExceptionText() { var behavior =\", \" new MockEventToCommandBehavior { EventName = \\\"OnItemTapped\\\" }; var listView = new ListView();\\n\\nAsse\", \"rt.Throws<ArgumentException>(() => listView.Behaviors.Add(behavior)); }\\n\\n89\\n\\nC HA PTER 11 | Unit tes\", \"ting\\n\\nThis unit test will throw an exception, because the ListView control does not have an event na\", \"med OnItemTapped. The Assert.Throws<T> method is a generic method where T is the type of the expecte\", \"d exception. The argument passed to the Assert.Throws<T> method is a lambda expression that will thr\", \"ow the exception. Therefore, the unit test will pass provided that the lambda expression throws an A\", \"rgumentException.\\n\\nTip: Avoid writing unit tests that examine exception message strings\\n\\nException m\", \"essage strings might change over time, and so unit tests that rely on their presence are regarded as\", \" brittle.\\n\\nTesting validation\\n\\nThere are two aspects to testing the validation implementation: testi\", \"ng that any validation rules are correctly implemented, and testing that the ValidatableObject<T> cl\", \"ass performs as expected.\\n\\nValidation logic is usually simple to test, because it is typically a sel\", \"f-contained process where the output depends on the input. There should be tests on the results of i\", \"nvoking the Validate method on each property that has at least one associated validation rule, as de\", \"monstrated in the following code example:\\n\\n[Fact] public void CheckValidationPassesWhenBothPropertie\", \"sHaveDataTest() { var mockViewModel = new MockViewModel(); mockViewModel.Forename.Value = \\\"John\\\"; mo\", \"ckViewModel.Surname.Value = \\\"Smith\\\";\\n\\nbool isValid = mockViewModel.Validate();\\n\\nAssert.True(isValid)\", \"; }\\n\\nThis unit test checks that validation succeeds when the two ValidatableObject<T> properties in \", \"the MockViewModel instance both have data.\\n\\nAs well as checking that validation succeeds, validation\", \" unit tests should also check the values of the Value, IsValid, and Errors property of each Validata\", \"bleObject<T> instance, to verify that the class performs as expected. The following code example dem\", \"onstrates a unit test that does this:\\n\\n[Fact] public void CheckValidationFailsWhenOnlyForenameHasDat\", \"aTest() { var mockViewModel = new MockViewModel(); mockViewModel.Forename.Value = \\\"John\\\";\\n\\nbool isVa\", \"lid = mockViewModel.Validate();\\n\\nAssert.False(isValid); Assert.NotNull(mockViewModel.Forename.Value)\", \"; Assert.Null(mockViewModel.Surname.Value); Assert.True(mockViewModel.Forename.IsValid); Assert.Fals\", \"e(mockViewModel.Surname.IsValid); Assert.Empty(mockViewModel.Forename.Errors); Assert.NotEmpty(mockV\", \"iewModel.Surname.Errors); }\\n\\n90\\n\\nC HA PTER 11 | Unit testing\\n\\nThis unit test checks that validation \", \"fails when the Surname property of the MockViewModel doesn't have any data, and the Value, IsValid, \", \"and Errors property of each ValidatableObject<T> instance are correctly set.\\n\\nSummary\\n\\nA unit test t\", \"akes a small unit of the app, typically a method, isolates it from the remainder of the code, and ve\", \"rifies that it behaves as expected. Its goal is to check that each unit of functionality performs as\", \" expected, so that errors don't propagate throughout the app.\\n\\nThe behavior of an object under test \", \"can be isolated by replacing dependent objects with mock objects that simulate the behavior of the d\", \"ependent objects. This enables unit tests to be executed without requiring unwieldy resources such a\", \"s web services, or databases.\\n\\nTesting models and view models from MVVM applications is identical to\", \" testing any other classes, and the same tools and techniques can be used.\\n\\n91\\n\\nC HA PTER 11 | Unit \", \"testing\\n\\n92\\n\\nC HA PTER 11 | Unit testing\"]"