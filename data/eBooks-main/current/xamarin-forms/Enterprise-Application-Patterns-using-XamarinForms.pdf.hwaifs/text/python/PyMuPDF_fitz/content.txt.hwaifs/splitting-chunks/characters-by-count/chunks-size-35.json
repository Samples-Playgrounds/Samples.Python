"[\" \\n \\n \\nBook title \\nBook subtitle \\nAuthor Name \\n \\n \\n \\n \\nPUBLISHED BY \\n \\nDevDiv, .NET and Visual Studio\", \" produc teams \\nA division of Microsoft Corporation \\nOne Microsoft Way \\nRedmond, Washington 98052-639\", \"9 \\nCopyright \\u00a9 2017 by Microsoft Corporation \\nAll rights reserved. No part of the contents of this b\", \"ook may be reproduced or transmitted in any \\nform or by any means without the written permission of \", \"the publisher. \\nThis book is provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The vie\", \"ws, opinions and \\ninformation expressed in this book, including URL and other Internet website refer\", \"ences, may change \\nwithout notice.  \\nSome examples depicted herein are provided for illustration onl\", \"y and are fictitious. No real association \\nor connection is intended or should be inferred. \\nMicroso\", \"ft and the trademarks listed at http://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are \\ntrademarks\", \" of the Microsoft group of companies. All other marks are property of their respective \\nowners. \\nAut\", \"hor: David Britch \\nDeveloper: Javier Suarez Ruiz (Plain Concepts) \\nParticipants and reviewers: Craig\", \" Dunn, Tom Opgenorth \\nEditor: John Meade (Populus Group) \\n \\n \\n \\ni\\nContents \\nPreface ................\", \"....................................................................................................\", \"....... iv \\nPurpose ................................................................................\", \".................................................. iv \\nWhat's left out of this guide's scope .......\", \"....................................................................................... iv \\nWho shou\", \"ld use this guide ..................................................................................\", \"........................... iv \\nHow to use this guide ..............................................\", \"........................................................................ v \\nIntroduction ...........\", \"....................................................................................................\", \"..... 1 \\nSample application ........................................................................\", \"........................................... 2 \\nSample application architecture......................\", \"................................................................................ 2 \\nMobile app .....\", \"....................................................................................................\", \".............................. 4 \\neShopOnContainers.Core project....................................\", \"............................................................... 5 \\nPlatform projects ...............\", \"....................................................................................................\", \"......... 6 \\nSummary ...............................................................................\", \".................................................. 6 \\nMVVM .........................................\", \".................................................................................... 7 \\nThe MVVM pat\", \"tern ...............................................................................................\", \"................... 7 \\nView ........................................................................\", \"......................................................................... 8 \\nViewModel .............\", \"....................................................................................................\", \"...................... 8 \\nModel ....................................................................\", \"........................................................................... 9 \\nConnecting view model\", \"s to views .........................................................................................\", \".... 9 \\nCreating a view model declaratively ........................................................\", \".....................................10 \\nCreating a view model programmatically ....................\", \".................................................................10 \\nCreating a view defined as a da\", \"ta template ..................................................................................11 \\nAu\", \"tomatically creating a view model with a view model locator ........................................\", \".........11 \\nUpdating views in response to changes in the underlying view model or model ...........\", \"............ 12 \\nUI interaction using commands and behaviors .......................................\", \"................................. 13 \\nImplementing commands ........................................\", \"......................................................................14 \\nImplementing behaviors ...\", \"....................................................................................................\", \".........15 \\nSummary ...............................................................................\", \"................................................ 17 \\nDependency injection ..........................\", \".......................................................................... 18 \\nIntroduction to depen\", \"dency injection ....................................................................................\", \". 18 \\nRegistration .................................................................................\", \".......................................... 20 \\nResolution ..........................................\", \".................................................................................... 22 \\nManaging th\", \"e lifetime of resolved objects .....................................................................\", \".......... 22 \\nSummary .............................................................................\", \".................................................. 23 \\n \\n \\nii\\nCommunicating between loosely coupled \", \"components .................................................. 24 \\nIntroduction to MessagingCenter ..\", \".......................................................................................... 24 \\nDefin\", \"ing a message.......................................................................................\", \".......................... 26 \\nPublishing a message ................................................\", \".............................................................. 26 \\nSubscribing to a message ........\", \"................................................................................................ 27 \", \"\\nUnsubscribing from a message.......................................................................\", \"......................... 27 \\nSummary ..............................................................\", \"................................................................. 27 \\nNavigation ...................\", \".................................................................................................. 2\", \"8 \\nNavigating between pages ........................................................................\", \".............................. 29 \\nCreating the NavigationService instance .........................\", \"..............................................................29 \\nHandling navigation requests .....\", \"...................................................................................................3\", \"0 \\nNavigating when the app is launched .............................................................\", \"..............................32 \\nPassing parameters during navigation .............................\", \".............................................................33 \\nInvoking navigation using behaviors\", \" .............................................................................................34 \\nCo\", \"nfirming or cancelling navigation ..................................................................\", \"............................34 \\nSummary ............................................................\", \"................................................................... 35 \\nValidation .................\", \"....................................................................................................\", \". 36 \\nSpecifying validation rules ..................................................................\", \".................................... 37 \\nAdding validation rules to a property .....................\", \"................................................................. 38 \\nTriggering validation ........\", \"....................................................................................................\", \"... 39 \\nTriggering validation manually .............................................................\", \".........................................39 \\nTriggering validation when properties change...........\", \"...................................................................40 \\nDisplaying validation errors \", \"....................................................................................................\", \" 40 \\nHighlighting a control that contains invalid data .............................................\", \".............................41 \\nDisplaying error messages .........................................\", \"....................................................................44 \\nSummary ....................\", \"....................................................................................................\", \"....... 45 \\nConfiguration management ...............................................................\", \"............................ 46 \\nCreating a settings class .........................................\", \"................................................................. 46 \\nAdding a setting .............\", \"....................................................................................................\", \".... 47 \\nData binding to user settings .............................................................\", \"..................................... 48 \\nSummary ..................................................\", \"............................................................................. 50 \\nContainerized micr\", \"oservices ..........................................................................................\", \". 51 \\nMicroservices ................................................................................\", \"......................................... 52 \\nContainerization .....................................\", \"................................................................................ 53 \\nCommunication b\", \"etween client and microservices .................................................................. 5\", \"5 \\nCommunication between microservices .............................................................\", \"..................... 56 \\nSummary ..................................................................\", \"............................................................. 58 \\nAuthentication and authorization .\", \"................................................................................. 59 \\nAuthentication\", \" ...................................................................................................\", \".................... 59 \\nIssuing bearer tokens using IdentityServer 4 ..............................\", \"..................................................60 \\nAdding IdentityServer to a web application ...\", \"...............................................................................60 \\nConfiguring Ident\", \"ityServer ..........................................................................................\", \"..................61 \\n \\niii\\nPerforming authentication ..............................................\", \"..............................................................64 \\nAuthorization ....................\", \"....................................................................................................\", \". 69 \\nConfiguring IdentityServer to perform authorization ..........................................\", \".........................70 \\nMaking access requests to APIs ........................................\", \".............................................................71 \\nSummary ...........................\", \"....................................................................................................\", \" 71 \\nAccessing remote data .........................................................................\", \".......................... 73 \\nIntroduction to Representational State Transfer......................\", \"................................................ 73 \\nConsuming RESTful APIs ........................\", \"................................................................................. 74 \\nMaking web req\", \"uests ..............................................................................................\", \"......................74 \\nCaching data .............................................................\", \"............................................................. 81 \\nManaging data expiration .........\", \"....................................................................................................\", \"82 \\nCaching images .................................................................................\", \".............................................82 \\nIncreasing resilience .............................\", \".................................................................................. 83 \\nRetry pattern\", \" ...................................................................................................\", \"..............................83 \\nCircuit breaker pattern ..........................................\", \"........................................................................84 \\nSummary ................\", \"....................................................................................................\", \"........... 85 \\nUnit testing .......................................................................\", \"............................................. 86 \\nDependency injection and unit testing ............\", \"........................................................................ 86 \\nTesting MVVM applicatio\", \"ns .................................................................................................\", \"... 87 \\nTesting asynchronous functionality..........................................................\", \".....................................88 \\nTesting INotifyPropertyChanged implementations.............\", \"..........................................................88 \\nTesting message-based communication ..\", \".....................................................................................89 \\nTesting exc\", \"eption handling ....................................................................................\", \"........................89 \\nTesting validation .....................................................\", \".....................................................................90 \\nSummary ...................\", \"....................................................................................................\", \"........ 91 \\n \\n \\n \\n \\n \\niv \\nPreface \\n \\n \\n \\nPreface \\n \\nPurpose \\nThis eBook provides guidance on buildi\", \"ng cross-platform enterprise apps using Xamarin.Forms. \\nXamarin.Forms is a cross-platform UI toolkit\", \" that allows developers to easily create native user \\ninterface layouts that can be shared across pl\", \"atforms, including iOS, Android, and the Universal \\nWindows Platform (UWP). It provides a comprehens\", \"ive solution for Business to Employee (B2E), \\nBusiness to Business (B2B), and Business to Consumer (\", \"B2C) apps, providing the ability to share code \\nacross all target platforms and helping to lower the\", \" total cost of ownership (TCO). \\nThe guide provides architectural guidance for developing adaptable,\", \" maintainable, and testable \\nXamarin.Forms enterprise apps. Guidance is provided on how to implement\", \" MVVM, dependency \\ninjection, navigation, validation, and configuration management, while maintainin\", \"g loose coupling. In \\naddition, there's also guidance on performing authentication and authorization\", \" with IdentityServer, \\naccessing data from containerized microservices, and unit testing. \\nThe guide\", \" comes with source code for the eShopOnContainers mobile app, and source code for the \\neShopOnContai\", \"ners reference app. The eShopOnContainers mobile app is a cross-platform enterprise \\napp developed u\", \"sing Xamarin.Forms, which connects to a series of containerized microservices known \\nas the eShopOnC\", \"ontainers reference app. However, the eShopOnContainers mobile app can be \\nconfigured to consume dat\", \"a from mock services for those who wish to avoid deploying the \\ncontainerized microservices. \\nWhat's\", \" left out of this guide's scope \\nThis guide is aimed at readers who are already familiar with Xamari\", \"n.Forms. For a detailed \\nintroduction to Xamarin.Forms, see the Xamarin.Forms documentation on the X\", \"amarin Developer \\nCenter, and Creating Mobile Apps with Xamarin.Forms. \\nThe guide is complementary t\", \"o .NET Microservices: Architecture for Containerized .NET Applications, \\nwhich focuses on developing\", \" and deploying containerized microservices. Other guides worth reading \\ninclude Architecting and Dev\", \"eloping Modern Web Applications with ASP.NET Core and Microsoft \\nAzure, Containerized Docker Applica\", \"tion Lifecycle with Microsoft Platform and Tools, and Microsoft \\nPlatform and Tools for Mobile App D\", \"evelopment. \\nWho should use this guide \\nThe audience for this guide is mainly developers and archite\", \"cts who would like to learn how to \\narchitect and implement cross-platform enterprise apps using Xam\", \"arin.Forms. \\nv \\nPreface \\n \\nA secondary audience is technical decision makers who would like to recei\", \"ve an architectural and \\ntechnology overview before deciding on what approach to select for cross-pl\", \"atform enterprise app \\ndevelopment using Xamarin.Forms. \\nHow to use this guide \\nThis guide focuses o\", \"n building cross-platform enterprise apps using Xamarin.Forms. As such, it should \\nbe read in its en\", \"tirety to provide a foundation of understanding such apps and their technical \\nconsiderations. The g\", \"uide, along with its sample app, can also serve as a starting point or reference for \\ncreating a new\", \" enterprise app. Use the associated sample app as a template for the new app, or to see \\nhow to orga\", \"nize an app's component parts. Then, refer back to this guide for architectural guidance. \\nFeel free\", \" to forward this guide to team members to help ensure a common understanding of cross-\\nplatform ente\", \"rprise app development using Xamarin.Forms. Having everybody working from a \\ncommon set of terminolo\", \"gies and underlying principles will help ensure a consistent application of \\narchitectural patterns \", \"and practices. \\n \\n \\n \\n \\n1 \\nCHAPTER 1  |  Introduction \\n \\n \\n \\nCHAP TER  1 \\nIntroduction \\nRegardless o\", \"f platform, developers of enterprise apps face several challenges: \\n\\u2022 \\nApp requirements that can cha\", \"nge over time. \\n\\u2022 \\nNew business opportunities and challenges. \\n\\u2022 \\nOngoing feedback during developmen\", \"t that can significantly affect the scope and \\nrequirements of the app. \\nWith these in mind, it's im\", \"portant to build apps that can be easily modified or extended over time. \\nDesigning for such adaptab\", \"ility can be difficult as it requires an architecture that allows individual \\nparts of the app to be\", \" independently developed and tested in isolation without affecting the rest of \\nthe app. \\nMany enter\", \"prise apps are sufficiently complex to require more than one developer. It can be a \\nsignificant cha\", \"llenge to decide how to design an app so that multiple developers can work effectively \\non different\", \" pieces of the app independently, while ensuring that the pieces come together seamlessly \\nwhen inte\", \"grated into the app. \\nThe traditional approach to designing and building an app results in what is r\", \"eferred to as a \\nmonolithic app, where components are tightly coupled with no clear separation betwe\", \"en them. \\nTypically, this monolithic approach leads to apps that are difficult and inefficient to ma\", \"intain, because \\nit can be difficult to resolve bugs without breaking other components in the app, a\", \"nd it can be \\ndifficult to add new features or to replace existing features. \\nAn effective remedy fo\", \"r these challenges is to partition an app into discrete, loosely coupled \\ncomponents that can be eas\", \"ily integrated together into an app. Such an approach offers several \\nbenefits: \\n\\u2022 \\nIt allows indivi\", \"dual functionality to be developed, tested, extended, and maintained by \\ndifferent individuals or te\", \"ams. \\n\\u2022 \\nIt promotes reuse and a clean separation of concerns between the app's horizontal \\ncapabili\", \"ties, such as authentication and data access, and the vertical capabilities, such as app \\nspecific b\", \"usiness functionality. This allows the dependencies and interactions between app \\ncomponents to be m\", \"ore easily managed. \\n\\u2022 \\nIt helps maintain a separation of roles by allowing different individuals, o\", \"r teams, to focus on \\na specific task or piece of functionality according to their expertise. In par\", \"ticular, it provides a \\ncleaner separation between the user interface and the app's business logic. \", \"\\nHowever, there are many issues that must be resolved when partitioning an app into discrete, loosel\", \"y \\ncoupled components. These include: \\n\\u2022 \\nDeciding how to provide a clean separation of concerns bet\", \"ween the user interface controls \\nand their logic. One of the most important decisions when creating\", \" a Xamarin.Forms \\nenterprise app is whether to place business logic in code-behind files, or whether\", \" to create a \\nclean separation of concerns between the user interface controls and their logic, in o\", \"rder to \\n2 \\nCHAPTER 1  |  Introduction \\n \\nmake the app more maintainable and testable. For more info\", \"rmation, see Model-View-\\nViewModel. \\n\\u2022 \\nDetermining whether to use a dependency injection container.\", \" Dependency injection \\ncontainers reduce the dependency coupling between objects by providing a faci\", \"lity to \\nconstruct instances of classes with their dependencies injected, and manage their lifetime \", \"\\nbased on the configuration of the container. For more information, see Dependency injection. \\n\\u2022 \\nCh\", \"oosing between platform provided eventing and loosely coupled message-based \\ncommunication between c\", \"omponents that are inconvenient to link by object and type \\nreferences. For more information, see In\", \"troduction to Communicating between loosely \\ncoupled components. \\n\\u2022 \\nDeciding how to navigate betwee\", \"n pages, including how to invoke navigation, and where \\nnavigation logic should reside. For more inf\", \"ormation, see Navigation. \\n\\u2022 \\nDetermining how to validate user input for correctness. The decision m\", \"ust include how to \\nvalidate user input, and how to notify the user about validation errors. For mor\", \"e information, \\nsee Validation. \\n\\u2022 \\nDeciding how to perform authentication, and how to protect resou\", \"rces with authorization. For \\nmore information, see Authentication and authorization. \\n\\u2022 \\nDeterminin\", \"g how to access remote data from web services, including how to reliably retrieve \\ndata, and how to \", \"cache data. For more information, see Accessing remote data. \\n\\u2022 \\nDeciding how to test the app. For m\", \"ore information, see Unit testing. \\nThis guide provides guidance on these issues, and focuses on the\", \" core patterns and architecture for \\nbuilding a cross-platform enterprise app using Xamarin.Forms. T\", \"he guidance aims to help to produce \\nadaptable, maintainable, and testable code, by addressing commo\", \"n Xamarin.Forms enterprise app \\ndevelopment scenarios, and by separating the concerns of presentatio\", \"n, presentation logic, and \\nentities through support for the Model-View-ViewModel (MVVM) pattern. \\nS\", \"ample application \\nThis guide includes a sample application, eShopOnContainers, that's an online sto\", \"re that includes the \\nfollowing functionality: \\n\\u2022 \\nAuthenticating and authorizing against a backend \", \"service. \\n\\u2022 \\nBrowsing a catalog of shirts, coffee mugs, and other marketing items. \\n\\u2022 \\nFiltering the\", \" catalog. \\n\\u2022 \\nOrdering items from the catalog. \\n\\u2022 \\nViewing the user's order history. \\n\\u2022 \\nConfigurati\", \"on of settings. \\nSample application architecture \\nFigure 1-1 provides a high-level overview of the a\", \"rchitecture of the sample application. \\n3 \\nCHAPTER 1  |  Introduction \\n \\nFigure 1-1: eShopOnContaine\", \"rs high-level architecture \\nThe sample application ships with three client apps: \\n\\u2022 \\nAn MVC applicat\", \"ion developed with ASP.NET Core. \\n\\u2022 \\nA Single Page Application (SPA) developed with Angular 2 and Ty\", \"pescript. This approach for \\nweb applications avoids performing a round-trip to the server with each\", \" operation. \\n\\u2022 \\nA mobile app developed with Xamarin.Forms, which supports iOS, Android, and the Univ\", \"ersal \\nWindows Platform (UWP). \\nFor information about the web applications, see Architecting and Dev\", \"eloping Modern Web \\nApplications with ASP.NET Core and Microsoft Azure. \\nThe sample application incl\", \"udes the following backend services: \\n\\u2022 \\nAn identity microservice, which uses ASP.NET Core Identity \", \"and IdentityServer. \\n\\u2022 \\nA catalog microservice, which is a data-driven create, read, update, delete \", \"(CRUD) service that \\nconsumes an SQL Server database using EntityFramework Core. \\n\\u2022 \\nAn ordering mic\", \"roservice, which is a domain-driven service that uses domain-driven design \\npatterns. \\n\\u2022 \\nA basket m\", \"icroservice, which is a data-driven CRUD service that uses Redis Cache. \\nThese backend services are \", \"implemented as microservices using ASP.NET Core MVC, and are \\ndeployed as unique containers within a\", \" single Docker host. Collectively, these backend services are \\nreferred to as the eShopOnContainers \", \"reference application. Client apps communicate with the \\nbackend services through a Representational\", \" State Transfer (REST) web interface. For more \\ninformation about microservices and Docker, see Cont\", \"ainerized microservices. \\nFor information about the implementation of the backend services, see .NET\", \" Microservices: \\nArchitecture for Containerized .NET Applications. \\n4 \\nCHAPTER 1  |  Introduction \\n \", \"\\nMobile app \\nThis guide focuses on building cross-platform enterprise apps using Xamarin.Forms, and \", \"uses the \\neShopOnContainers mobile app as an example. Figure 1-2 shows the pages from the \\neShopOnCo\", \"ntainers mobile app that provide the functionality outlined earlier. \\nFigure 1-2: The eShopOnContain\", \"ers mobile app \\nThe mobile app consumes the backend services provided by the eShopOnContainers refer\", \"ence \\napplication. However, it can be configured to consume data from mock services for those who wi\", \"sh to \\navoid deploying the backend services.  \\nThe eShopOnContainers mobile app exercises the follow\", \"ing Xamarin.Forms functionality: \\n\\u2022 \\nXAML \\n\\u2022 \\nControls \\n\\u2022 \\nBindings \\n\\u2022 \\nConverters \\n\\u2022 \\nStyles \\n5 \\nCH\", \"APTER 1  |  Introduction \\n \\n\\u2022 \\nAnimations \\n\\u2022 \\nCommands \\n\\u2022 \\nBehaviors \\n\\u2022 \\nTriggers \\n\\u2022 \\nEffects \\n\\u2022 \\nCu\", \"stom Renderers \\n\\u2022 \\nMessagingCenter \\n\\u2022 \\nCustom Controls \\nFor more information about this functionalit\", \"y, see the Xamarin.Forms documentation on the Xamarin \\nDeveloper Center, and Creating Mobile Apps wi\", \"th Xamarin.Forms. \\nIn addition, unit tests are provided for some of the classes in the eShopOnContai\", \"ners mobile app. \\nMobile app solution \\nThe eShopOnContainers mobile app solution organizes the sourc\", \"e code and other resources into \\nprojects. All of the projects use folders to organize the source co\", \"de and other resources into \\ncategories. The following table outlines the projects that make up the \", \"eShopOnContainers mobile \\napp: \\nProject \\nDescription \\neShopOnContainers.Core \\nThis project is the po\", \"rtable class library (PCL) project \\nthat contains the shared code and shared UI. \\neShopOnContainers.\", \"Droid \\nThis project holds Android specific code and is the \\nentry point for the Android app. \\neShopO\", \"nContainers.iOS \\nThis project holds iOS specific code and is the entry \\npoint for the iOS app. \\neSho\", \"pOnContainers.UWP \\nThis project holds Universal Windows Platform (UWP) \\nspecific code and is the ent\", \"ry point for the Windows \\napp. \\neShopOnContainers.TestRunner.Droid \\nThis project is the Android test\", \" runner for the \\neShopOnContainers.UnitTests project. \\neShopOnContainers.TestRunner.iOS \\nThis projec\", \"t is the iOS test runner for the \\neShopOnContainers.UnitTests project. \\neShopOnContainers.TestRunner\", \".Windows \\nThis project is the Universal Windows Platform test \\nrunner for the eShopOnContainers.Unit\", \"Tests project. \\neShopOnContainers.UnitTests \\nThis project contains unit tests for the \\neShopOnContai\", \"ners.Core project. \\n \\nThe classes from the eShopOnContainers mobile app can be re-used in any Xamari\", \"n.Forms app with \\nlittle or no modification.  \\neShopOnContainers.Core project \\nThe eShopOnContainers\", \".Core PCL project contains the following folders: \\n \\n6 \\nCHAPTER 1  |  Introduction \\n \\nFolder \\nDescri\", \"ption \\nAnimations \\nContains classes that enable animations to be consumed in XAML. \\nBehaviors \\nConta\", \"ins behaviors that are exposed to view classes. \\nControls \\nContains custom controls used by the app.\", \" \\nConverters \\nContains value converters that apply custom logic to a binding. \\nEffects \\nContains the\", \" EntryLineColorEffect class, which is used to change the border \\ncolor of specific Entry controls. \\n\", \"Exceptions \\nContains the custom ServiceAuthenticationException. \\nExtensions \\nContains extension meth\", \"ods for the VisualElement and IEnumerable<T> classes. \\nHelpers \\nContains helper classes for the app.\", \" \\nModels \\nContains the model classes for the app. \\nProperties \\nContains AssemblyInfo.cs, a .NET asse\", \"mbly metadata file. \\nServices \\nContains interfaces and classes that implement services that are prov\", \"ided to the \\napp. \\nTriggers \\nContains the BeginAnimation trigger, which is used to invoke an animati\", \"on in \\nXAML. \\nValidations \\nContains classes involved in validating data input. \\nViewModels \\nContains\", \" the application logic that's exposed to pages. \\nViews \\nContains the pages for the app. \\n \\nPlatform \", \"projects \\nThe platform projects contain effect implementations, custom renderer implementations, and\", \" other \\nplatform-specific resources. \\nSummary \\nXamarin's cross-platform mobile app development tools\", \" and platforms provide a comprehensive \\nsolution for B2E, B2B, and B2C mobile client apps, providing\", \" the ability to share code across all target \\nplatforms (iOS, Android, and Windows) and helping to l\", \"ower the total cost of ownership. Apps can \\nshare their user interface and app logic code, while ret\", \"aining the native platform look and feel. \\nDevelopers of enterprise apps face several challenges tha\", \"t can alter the architecture of the app during \\ndevelopment. Therefore, it's important to build an a\", \"pp so that it can be modified or extended over \\ntime. Designing for such adaptability can be difficu\", \"lt, but typically involves partitioning an app into \\ndiscrete, loosely coupled components that can b\", \"e easily integrated together into an app.\\n \\n \\n \\n7 \\nCHAPTER 2  |  MVVM \\n \\n \\n \\nCHAP TER  2 \\nMVVM \\nThe \", \"Xamarin.Forms developer experience typically involves creating a user interface in XAML, and then \\na\", \"dding code-behind that operates on the user interface. As apps are modified, and grow in size and \\ns\", \"cope, complex maintenance issues can arise. These issues include the tight coupling between the UI \\n\", \"controls and the business logic, which increases the cost of making UI modifications, and the diffic\", \"ulty \\nof unit testing such code. \\nThe Model-View-ViewModel (MVVM) pattern helps to cleanly separate \", \"the business and presentation \\nlogic of an application from its user interface (UI). Maintaining a c\", \"lean separation between application \\nlogic and the UI helps to address numerous development issues a\", \"nd can make an application easier \\nto test, maintain, and evolve. It can also greatly improve code r\", \"e-use opportunities and allows \\ndevelopers and UI designers to more easily collaborate when developi\", \"ng their respective parts of an \\napp. \\nThe MVVM pattern \\nThere are three core components in the MVVM\", \" pattern: the model, the view, and the view model. \\nEach serves a distinct purpose. Figure 2-1 shows\", \" the relationships between the three components. \\nFigure 2-1: The MVVM pattern \\nIn addition to under\", \"standing the responsibilities of each components, it's also important to \\nunderstand how they intera\", \"ct with each other. At a high level, the view \\\"knows about\\\" the view model, \\nand the view model \\\"kno\", \"ws about\\\" the model, but the model is unaware of the view model, and the \\nview model is unaware of t\", \"he view. Therefore, the view model isolates the view from the model, and \\nallows the model to evolve\", \" independently of the view. \\nThe benefits of using the MVVM pattern are as follows: \\n\\u2022 \\nIf there's a\", \"n existing model implementation that encapsulates existing business logic, it can \\nbe difficult or r\", \"isky to change it. In this scenario, the view model acts as an adapter for the \\nmodel classes and en\", \"ables you to avoid making any major changes to the model code. \\n8 \\nCHAPTER 2  |  MVVM \\n \\n\\u2022 \\nDevelope\", \"rs can create unit tests for the view model and the model, without using the view. \\nThe unit tests f\", \"or the view model can exercise exactly the same functionality as used by the \\nview. \\n\\u2022 \\nThe app UI c\", \"an be redesigned without touching the code, provided that the view is \\nimplemented entirely in XAML.\", \" Therefore, a new version of the view should work with the \\nexisting view model. \\n\\u2022 \\nDesigners and d\", \"evelopers can work independently and concurrently on their components \\nduring the development proces\", \"s. Designers can focus on the view, while developers can work \\non the view model and model component\", \"s. \\nThe key to using MVVM effectively lies in understanding how to factor app code into the correct \", \"\\nclasses, and in understanding how the classes interact. The following sections discuss the \\nrespons\", \"ibilities of each of the classes in the MVVM pattern. \\nView \\nThe view is responsible for defining th\", \"e structure, layout, and appearance of what the user sees on \\nscreen. Ideally, each view is defined \", \"in XAML, with a limited code-behind that does not contain \\nbusiness logic. However, in some cases, t\", \"he code-behind might contain UI logic that implements \\nvisual behavior that is difficult to express \", \"in XAML, such as animations. \\nIn a Xamarin.Forms application, a view is typically a Page-derived or \", \"ContentView-derived class. \\nHowever, views can also be represented by a data template, which specifi\", \"es the UI elements to be \\nused to visually represent an object when it's displayed. A data template \", \"as a view does not have any \\ncode-behind, and is designed to bind to a specific view model type. \\nTi\", \"p: Avoid enabling and disabling UI elements in the code-behind \\nEnsure that view models are responsi\", \"ble for defining logical state changes that affect some aspects \\nof the view's display, such as whet\", \"her a command is available, or an indication that an operation is \\npending. Therefore, enable and di\", \"sable UI elements by binding to view model properties, rather \\nthan enabling and disabling them in c\", \"ode-behind. \\nThere are several options for executing code on the view model in response to interacti\", \"ons on the \\nview, such as a button click or item selection. If a control supports commands, the cont\", \"rol's Command \\nproperty can be data-bound to an ICommand property on the view model. When the contro\", \"l's \\ncommand is invoked, the code in the view model will be executed. In addition to commands, \\nbeha\", \"viors can be attached to an object in the view and can listen for either a command to be invoked \\nor\", \" event to be raised. In response, the behavior can then invoke an ICommand on the view model or a \\nm\", \"ethod on the view model. \\nViewModel \\nThe view model implements properties and commands to which the \", \"view can data bind to, and \\nnotifies the view of any state changes through change notification event\", \"s. The properties and \\ncommands that the view model provides define the functionality to be offered \", \"by the UI, but the view \\ndetermines how that functionality is to be displayed. \\nTip: Keep the UI res\", \"ponsive with asynchronous operations \\nMobile apps should keep the UI thread unblocked to improve the\", \" user's perception of \\nperformance. Therefore, in the view model, use asynchronous methods for I/O o\", \"perations and raise \\nevents to asynchronously notify views of property changes. \\n9 \\nCHAPTER 2  |  MV\", \"VM \\n \\nThe view model is also responsible for coordinating the view's interactions with any model cla\", \"sses that \\nare required. There's typically a one-to-many relationship between the view model and the\", \" model \\nclasses. The view model might choose to expose model classes directly to the view so that co\", \"ntrols in \\nthe view can data bind directly to them. In this case, the model classes will need to be \", \"designed to \\nsupport data binding and change notification events. \\nEach view model provides data fro\", \"m a model in a form that the view can easily consume. To \\naccomplish this, the view model sometimes \", \"performs data conversion. Placing this data conversion in \\nthe view model is a good idea because it \", \"provides properties that the view can bind to. For example, \\nthe view model might combine the values\", \" of two properties to make it easier for display by the view. \\nTip: Centralize data conversions in a\", \" conversion layer \\nIt's also possible to use converters as a separate data conversion layer that sit\", \"s between the view \\nmodel and the view. This can be necessary, for example, when data requires speci\", \"al formatting that \\nthe view model doesn't provide. \\nIn order for the view model to participate in t\", \"wo-way data binding with the view, its properties must \\nraise the PropertyChanged event. View models\", \" satisfy this requirement by implementing the \\nINotifyPropertyChanged interface, and raising the Pro\", \"pertyChanged event when a property is \\nchanged. \\nFor collections, the view-friendly ObservableCollec\", \"tion<T> is provided. This collection implements \\ncollection changed notification, relieving the deve\", \"loper from having to implement the \\nINotifyCollectionChanged interface on collections. \\nModel \\nModel\", \" classes are non-visual classes that encapsulate the app's data. Therefore, the model can be \\nthough\", \"t of as representing the app's domain model, which usually includes a data model along with \\nbusines\", \"s and validation logic. Examples of model objects include data transfer objects (DTOs), Plain \\nOld C\", \"LR Objects (POCOs), and generated entity and proxy objects. \\nModel classes are typically used in con\", \"junction with services or repositories that encapsulate data \\naccess and caching. \\nConnecting view m\", \"odels to views \\nView models can be connected to views by using the data-binding capabilities of Xama\", \"rin.Forms. \\nThere are many approaches that can be used to construct views and view models and associ\", \"ate them \\nat runtime. These approaches fall into two categories, known as view first composition, an\", \"d view \\nmodel first composition. Choosing between view first composition and view model first compos\", \"ition is \\nan issue of preference and complexity. However, all approaches share the same aim, which i\", \"s for the \\nview to have a view model assigned to its BindingContext property. \\nWith view first compo\", \"sition the app is conceptually composed of views that connect to the view \\nmodels they depend on. Th\", \"e primary benefit of this approach is that it makes it easy to construct \\nloosely coupled, unit test\", \"able apps because the view models have no dependence on the views \\nthemselves. It's also easy to und\", \"erstand the structure of the app by following its visual structure, \\nrather than having to track cod\", \"e execution to understand how classes are created and associated. In \\naddition, view first construct\", \"ion aligns with the Xamarin.Forms navigation system that's responsible \\nfor constructing pages when \", \"navigation occurs, which makes a view model first composition complex \\nand misaligned with the platf\", \"orm. \\n10 \\nCHAPTER 2  |  MVVM \\n \\nWith view model first composition the app is conceptually composed o\", \"f view models, with a service \\nbeing responsible for locating the view for a view model. View model \", \"first composition feels more \\nnatural to some developers, since the view creation can be abstracted \", \"away, allowing them to focus \\non the logical non-UI structure of the app. In addition, it allows vie\", \"w models to be created by other \\nview models. However, this approach is often complex and it can bec\", \"ome difficult to understand how \\nthe various parts of the app are created and associated. \\nTip: Keep\", \" view models and views independent \\nThe binding of views to a property in a data source should be th\", \"e view's principal dependency on \\nits corresponding view model. Specifically, don't reference view t\", \"ypes, such as Button and \\nListView, from view models. By following the principles outlined here, vie\", \"w models can be tested \\nin isolation, therefore reducing the likelihood of software defects by limit\", \"ing scope. \\nThe following sections discuss the main approaches to connecting view models to views. \\n\", \"Creating a view model declaratively \\nThe simplest approach is for the view to declaratively instanti\", \"ate its corresponding view model in \\nXAML. When the view is constructed, the corresponding view mode\", \"l object will also be constructed. \\nThis approach is demonstrated in the following code example: \\n<C\", \"ontentPage ... xmlns:local=\\\"clr-namespace:eShop\\\"> \\n    <ContentPage.BindingContext> \\n        <local:\", \"LoginViewModel /> \\n    </ContentPage.BindingContext> \\n    ... \\n</ContentPage>  \\nWhen the ContentPage\", \" is created, an instance of the LoginViewModel is automatically constructed \\nand set as the view's B\", \"indingContext. \\nThis declarative construction and assignment of the view model by the view has the a\", \"dvantage that \\nit's simple, but has the disadvantage that it requires a default (parameter-less) con\", \"structor in the view \\nmodel. \\nCreating a view model programmatically \\nA view can have code in the co\", \"de-behind file that results in the view model being assigned to its \\nBindingContext property. This i\", \"s often accomplished in the view's constructor, as shown in the \\nfollowing code example: \\npublic Log\", \"inView() \\n{ \\n    InitializeComponent(); \\n    BindingContext = new LoginViewModel(navigationService);\", \" \\n}  \\nThe programmatic construction and assignment of the view model within the view's code-behind h\", \"as \\nthe advantage that it's simple. However, the main disadvantage of this approach is that the view\", \" \\nneeds to provide the view model with any required dependencies. Using a dependency injection \\ncont\", \"ainer can help to maintain loose coupling between the view and view model. For more \\ninformation, se\", \"e Dependency injection. \\n11 \\nCHAPTER 2  |  MVVM \\n \\nCreating a view defined as a data template \\nA vie\", \"w can be defined as a data template and associated with a view model type. Data templates can \\nbe de\", \"fined as resources, or they can be defined inline within the control that will display the view \\nmod\", \"el. The content of the control is the view model instance, and the data template is used to visually\", \" \\nrepresent it. This technique is an example of a situation in which the view model is instantiated \", \"first, \\nfollowed by the creation of the view. \\nAutomatically creating a view model with a view model\", \" locator \\nA view model locator is a custom class that manages the instantiation of view models and t\", \"heir \\nassociation to views. In the eShopOnContainers mobile app, the ViewModelLocator class has an \\n\", \"attached property, AutoWireViewModel, that's used to associate view models with views. In the view's\", \" \\nXAML, this attached property is set to true to indicate that the view model should be automaticall\", \"y \\nconnected to the view, as shown in the following code example: \\nviewModelBase:ViewModelLocator.Au\", \"toWireViewModel=\\\"true\\\" \\nThe AutoWireViewModel property is a bindable property that's initialized to \", \"false, and when its \\nvalue changes the OnAutoWireViewModelChanged event handler is called. This meth\", \"od resolves the \\nview model for the view. The following code example shows how this is achieved: \\npr\", \"ivate static void OnAutoWireViewModelChanged(BindableObject bindable, object oldValue, object n\\newVa\", \"lue) \\n{ \\n    var view = bindable as Element; \\n    if (view == null) \\n    { \\n        return; \\n    } \\n\", \" \\n    var viewType = view.GetType(); \\n    var viewName = viewType.FullName.Replace(\\\".Views.\\\", \\\".View\", \"Models.\\\"); \\n    var viewAssemblyName = viewType.GetTypeInfo().Assembly.FullName; \\n    var viewModelN\", \"ame = string.Format( \\n        CultureInfo.InvariantCulture, \\\"{0}Model, {1}\\\", viewName, viewAssemblyN\", \"ame); \\n \\n    var viewModelType = Type.GetType(viewModelName); \\n    if (viewModelType == null) \\n    {\", \" \\n        return; \\n    } \\n    var viewModel = _container.Resolve(viewModelType); \\n    view.BindingCo\", \"ntext = viewModel; \\n}  \\nThe OnAutoWireViewModelChanged method attempts to resolve the view model usi\", \"ng a convention-\\nbased approach. This convention assumes that: \\n\\u2022 \\nView models are in the same assem\", \"bly as view types. \\n\\u2022 \\nViews are in a .Views child namespace. \\n\\u2022 \\nView models are in a .ViewModels c\", \"hild namespace. \\n\\u2022 \\nView model names correspond with view names and end with \\\"ViewModel\\\". \\n12 \\nCHAPT\", \"ER 2  |  MVVM \\n \\nFinally, the OnAutoWireViewModelChanged method sets the BindingContext of the view \", \"type to the \\nresolved view model type. For more information about resolving the view model type, see\", \" Resolution. \\nThis approach has the advantage that an app has a single class that is responsible for\", \" the instantiation \\nof view models and their connection to views. \\nTip: Use a view model locator for\", \" ease of substitution \\nA view model locator can also be used as a point of substitution for alternat\", \"e implementations of \\ndependencies, such as for unit testing or design time data. \\nUpdating views in\", \" response to changes in the \\nunderlying view model or model \\nAll view model and model classes that a\", \"re accessible to a view should implement the \\nINotifyPropertyChanged interface. Implementing this in\", \"terface in a view model or model class \\nallows the class to provide change notifications to any data\", \"-bound controls in the view when the \\nunderlying property value changes.  \\nApp's should be architect\", \"ed for the correct use of property change notification, by meeting the \\nfollowing requirements: \\n\\u2022 \\n\", \"Always raising a PropertyChanged event if a public property's value changes. Do not assume \\nthat rai\", \"sing the PropertyChanged event can be ignored because of knowledge of how XAML \\nbinding occurs. \\n\\u2022 \\n\", \"Always raising a PropertyChanged event for any calculated properties whose values are used \\nby other\", \" properties in the view model or model. \\n\\u2022 \\nAlways raising the PropertyChanged event at the end of t\", \"he method that makes a property \\nchange, or when the object is known to be in a safe state. Raising \", \"the event interrupts the \\noperation by invoking the event's handlers synchronously. If this happens \", \"in the middle of an \\noperation, it might expose the object to callback functions when it is in an un\", \"safe, partially \\nupdated state. In addition, it's possible for cascading changes to be triggered by \", \"\\nPropertyChanged events. Cascading changes generally require updates to be complete \\nbefore the casc\", \"ading change is safe to execute. \\n\\u2022 \\nNever raising a PropertyChanged event if the property does not \", \"change. This means that you \\nmust compare the old and new values before raising the PropertyChanged \", \"event. \\n\\u2022 \\nNever raising the PropertyChanged event during a view model's constructor if you are \\nini\", \"tializing a property. Data-bound controls in the view will not have subscribed to receive \\nchange no\", \"tifications at this point. \\n\\u2022 \\nNever raising more than one PropertyChanged event with the same prope\", \"rty name \\nargument within a single synchronous invocation of a public method of a class. For example\", \", \\ngiven a NumberOfItems property whose backing store is the _numberOfItems field, if a \\nmethod incr\", \"ements _numberOfItems fifty times during the execution of a loop, it should only \\nraise property cha\", \"nge notification on the NumberOfItems property once, after all the work is \\ncomplete. For asynchrono\", \"us methods, raise the PropertyChanged event for a given property \\nname in each synchronous segment o\", \"f an asynchronous continuation chain. \\nThe eShopOnContainers mobile app uses the ExtendedBindableObj\", \"ect class to provide change \\nnotifications, which is shown in the following code example: \\n13 \\nCHAPT\", \"ER 2  |  MVVM \\n \\npublic abstract class ExtendedBindableObject : BindableObject \\n{ \\n    public void R\", \"aisePropertyChanged<T>(Expression<Func<T>> property) \\n    { \\n        var name = GetMemberInfo(proper\", \"ty).Name; \\n        OnPropertyChanged(name); \\n    } \\n \\n    private MemberInfo GetMemberInfo(Expressio\", \"n expression) \\n    { \\n        ... \\n    } \\n}  \\nXamarin.Form's BindableObject class implements the INo\", \"tifyPropertyChanged interface, and \\nprovides an OnPropertyChanged method. The ExtendedBindableObject\", \" class provides the \\nRaisePropertyChanged method to invoke property change notification, and in doin\", \"g so uses the \\nfunctionality provided by the BindableObject class. \\nEach view model class in the eSh\", \"opOnContainers mobile app derives from the ViewModelBase class, \\nwhich in turn derives from the Exte\", \"ndedBindableObject class. Therefore, each view model class uses \\nthe RaisePropertyChanged method in \", \"the ExtendedBindableObject class to provide property \\nchange notification. The following code exampl\", \"e shows how the eShopOnContainers mobile app \\ninvokes property change notification by using a lambda\", \" expression: \\npublic bool IsLogin \\n{ \\n    get \\n    { \\n        return _isLogin; \\n    } \\n    set \\n    \", \"{ \\n        _isLogin = value; \\n        RaisePropertyChanged(() => IsLogin); \\n    } \\n}  \\nNote that usi\", \"ng a lambda expression in this way involves a small performance cost because the \\nlambda expression \", \"has to be evaluated for each call. Although the performance cost is small and \\nwould not normally im\", \"pact an app, the costs can accrue when there are many change notifications. \\nHowever, the benefit of\", \" this approach is that it provides compile-time type safety and refactoring \\nsupport when renaming p\", \"roperties. \\nUI interaction using commands and behaviors \\nIn mobile apps, actions are typically invok\", \"ed in response to a user action, such as a button click, that \\ncan be implemented by creating an eve\", \"nt handler in the code-behind file. However, in the MVVM \\npattern, the responsibility for implementi\", \"ng the action lies with the view model, and placing code in \\nthe code-behind should be avoided. \\nCom\", \"mands provide a convenient way to represent actions that can be bound to controls in the UI. \\nThey e\", \"ncapsulate the code that implements the action, and help to keep it decoupled from its visual \\nrepre\", \"sentation in the view. Xamarin.Forms includes controls that can be declaratively connected to a \\ncom\", \"mand, and these controls will invoke the command when the user interacts with the control. \\n14 \\nCHAP\", \"TER 2  |  MVVM \\n \\nBehaviors also allow controls to be declaratively connected to a command. However,\", \" behaviors can be \\nused to invoke an action that's associated with a range of events raised by a con\", \"trol. Therefore, \\nbehaviors address many of the same scenarios as command-enabled controls, while pr\", \"oviding a \\ngreater degree of flexibility and control. In addition, behaviors can also be used to ass\", \"ociate command \\nobjects or methods with controls that were not specifically designed to interact wit\", \"h commands. \\nImplementing commands \\nView models typically expose command properties, for binding fro\", \"m the view, that are object \\ninstances that implement the ICommand interface. A number of Xamarin.Fo\", \"rms controls provide a \\nCommand property, which can be data bound to an ICommand object provided by \", \"the view model. The \\nICommand interface defines an Execute method, which encapsulates the operation \", \"itself, a \\nCanExecute method, which indicates whether the command can be invoked, and a \\nCanExecuteC\", \"hanged event that occurs when changes occur that affect whether the command should \\nexecute. The Com\", \"mand and Command<T> classes, provided by Xamarin.Forms, implement the ICommand \\ninterface, where T i\", \"s the type of the arguments to Execute and CanExecute.  \\nWithin a view model, there should be an obj\", \"ect of type Command or Command<T> for each public \\nproperty in the view model of type ICommand. The \", \"Command or Command<T> constructor requires an \\nAction callback object that's called when the IComman\", \"d.Execute method is invoked. The \\nCanExecute method is an optional constructor parameter, and is a F\", \"unc that returns a bool. \\nThe following code shows how a Command instance, which represents a regist\", \"er command, is \\nconstructed by specifying a delegate to the Register view model method: \\npublic ICom\", \"mand RegisterCommand => new Command(Register);  \\nThe command is exposed to the view through a proper\", \"ty that returns a reference to an ICommand. \\nWhen the Execute method is called on the Command object\", \", it simply forwards the call to the method \\nin the view model via the delegate that was specified i\", \"n the Command constructor.  \\nAn asynchronous method can be invoked by a command by using the async a\", \"nd await keywords \\nwhen specifying the command's Execute delegate. This indicates that the callback \", \"is a Task and \\nshould be awaited. For example, the following code shows how a Command instance, whic\", \"h represents \\na sign-in command, is constructed by specifying a delegate to the SignInAsync view mod\", \"el method: \\npublic ICommand SignInCommand => new Command(async () => await SignInAsync());  \\nParamet\", \"ers can be passed to the Execute and CanExecute actions by using the Command<T> class to \\ninstantiat\", \"e the command. For example, the following code shows how a Command<T> instance is used \\nto indicate \", \"that the NavigateAsync method will require an argument of type string: \\npublic ICommand NavigateComm\", \"and => new Command<string>(NavigateAsync);  \\nIn both the Command and Command<T> classes, the delegat\", \"e to the CanExecute method in each \\nconstructor is optional. If a delegate isn't specified, the Comm\", \"and will return true for CanExecute. \\nHowever, the view model can indicate a change in the command's\", \" CanExecute status by calling the \\nChangeCanExecute method on the Command object. This causes the Ca\", \"nExecuteChanged event to be \\nraised. Any controls in the UI that are bound to the command will then \", \"update their enabled status to \\nreflect the availability of the data-bound command. \\n15 \\nCHAPTER 2  \", \"|  MVVM \\n \\nInvoking commands from a view \\nThe following code example shows how a Grid in the LoginVi\", \"ew binds to the RegisterCommand in \\nthe LoginViewModel class by using a TapGestureRecognizer instanc\", \"e: \\n<Grid Grid.Column=\\\"1\\\" HorizontalOptions=\\\"Center\\\"> \\n    <Label Text=\\\"REGISTER\\\" TextColor=\\\"Gray\\\"/>\", \" \\n    <Grid.GestureRecognizers> \\n        <TapGestureRecognizer Command=\\\"{Binding RegisterCommand}\\\" N\", \"umberOfTapsRequired=\\\"1\\\" /> \\n    </Grid.GestureRecognizers> \\n</Grid>  \\nA command parameter can also b\", \"e optionally defined using the CommandParameter property. The \\ntype of the expected argument is spec\", \"ified in the Execute and CanExecute target methods. The \\nTapGestureRecognizer will automatically inv\", \"oke the target command when the user interacts with \\nthe attached control. The command parameter, if\", \" provided, will be passed as the argument to the \\ncommand's Execute delegate. \\nImplementing behavior\", \"s \\nBehaviors allow functionality to be added to UI controls without having to subclass them. Instead\", \", the \\nfunctionality is implemented in a behavior class and attached to the control as if it was par\", \"t of the \\ncontrol itself. Behaviors enable you to implement code that you would normally have to wri\", \"te as \\ncode-behind, because it directly interacts with the API of the control, in such a way that it\", \" can be \\nconcisely attached to the control, and packaged for reuse across more than one view or app.\", \" In the \\ncontext of MVVM, behaviors are a useful approach for connecting controls to commands. \\nA be\", \"havior that's attached to a control through attached properties is known as an attached behavior. \\nT\", \"he behavior can then use the exposed API of the element to which it is attached to add functionality\", \" \\nto that control, or other controls, in the visual tree of the view. The eShopOnContainers mobile a\", \"pp \\ncontains the LineColorBehavior class, which is an attached behavior. For more information about \", \"\\nthis behavior, see Displaying validation errors. \\nA Xamarin.Forms behavior is a class that derives \", \"from the Behavior or Behavior<T> class, where T is \\nthe type of the control to which the behavior sh\", \"ould apply. These classes provide OnAttachedTo and \\nOnDetachingFrom methods, which should be overrid\", \"den to provide logic that will be executed when \\nthe behavior is attached to and detached from contr\", \"ols. \\nIn the eShopOnContainers mobile app, the BindableBehavior<T> class derives from the \\nBehavior<\", \"T> class. The purpose of the BindableBehavior<T> class is to provide a base class for \\nXamarin.Forms\", \" behaviors that require the BindingContext of the behavior to be set to the attached \\ncontrol.  \\nThe\", \" BindableBehavior<T> class provides an overridable OnAttachedTo method that sets the \\nBindingContext\", \" of the behavior, and an overridable OnDetachingFrom method that cleans up the \\nBindingContext. In a\", \"ddition, the class stores a reference to the attached control in the \\nAssociatedObject property. \\nTh\", \"e eShopOnContainers mobile app includes an EventToCommandBehavior class, which executes a \\ncommand i\", \"n response to an event occurring. This class derives from the BindableBehavior<View> \\nclass so that \", \"the behavior can bind to and execute an ICommand specified by a Command property \\nwhen the behavior \", \"is consumed. The following code example shows the EventToCommandBehavior \\nclass: \\n \\n16 \\nCHAPTER 2  |\", \"  MVVM \\n \\npublic class EventToCommandBehavior : BindableBehavior<View> \\n{ \\n    ... \\n    protected ov\", \"erride void OnAttachedTo(View visualElement) \\n    { \\n        base.OnAttachedTo(visualElement); \\n \\n  \", \"      var events = AssociatedObject.GetType().GetRuntimeEvents().ToArray(); \\n        if (events.Any(\", \")) \\n        { \\n            _eventInfo = events.FirstOrDefault(e => e.Name == EventName); \\n          \", \"  if (_eventInfo == null) \\n                throw new ArgumentException(string.Format( \\n             \", \"           \\\"EventToCommand: Can't find any event named '{0}' on attached type\\\",  \\n                  \", \"      EventName)); \\n \\n            AddEventHandler(_eventInfo, AssociatedObject, OnFired); \\n        }\", \" \\n    } \\n \\n    protected override void OnDetachingFrom(View view) \\n    { \\n        if (_handler != nu\", \"ll) \\n            _eventInfo.RemoveEventHandler(AssociatedObject, _handler); \\n \\n        base.OnDetach\", \"ingFrom(view); \\n    } \\n \\n    private void AddEventHandler( \\n            EventInfo eventInfo, object \", \"item, Action<object, EventArgs> action) \\n    { \\n        ... \\n    } \\n \\n    private void OnFired(objec\", \"t sender, EventArgs eventArgs) \\n    { \\n        ... \\n    } \\n}  \\nThe OnAttachedTo and OnDetachingFrom \", \"methods are used to register and deregister an event \\nhandler for the event defined in the EventName\", \" property. Then, when the event fires, the OnFired \\nmethod is invoked, which executes the command. \\n\", \"The advantage of using the EventToCommandBehavior to execute a command when an event fires, is \\nthat\", \" commands can be associated with controls that weren't designed to interact with commands. In \\naddit\", \"ion, this moves event-handling code to view models, where it can be unit tested. \\nInvoking behaviors\", \" from a view \\nThe EventToCommandBehavior is particularly useful for attaching a command to a control\", \" that \\ndoesn't support commands. For example, the ProfileView uses the EventToCommandBehavior to \\nex\", \"ecute the OrderDetailCommand when the ItemTapped event fires on the ListView that lists the \\nuser's \", \"orders, as shown in the following code: \\n<ListView> \\n    <ListView.Behaviors> \\n        <behaviors:Ev\", \"entToCommandBehavior            \\n            EventName=\\\"ItemTapped\\\" \\n            Command=\\\"{Binding O\", \"rderDetailCommand}\\\" \\n            EventArgsConverter=\\\"{StaticResource ItemTappedEventArgsConverter}\\\" \", \"/> \\n17 \\nCHAPTER 2  |  MVVM \\n \\n    </ListView.Behaviors> \\n    ... \\n</ListView>  \\nAt runtime, the Even\", \"tToCommandBehavior will respond to interaction with the ListView. When an \\nitem is selected in the L\", \"istView, the ItemTapped event will fire, which will execute the \\nOrderDetailCommand in the ProfileVi\", \"ewModel. By default, the event arguments for the event are \\npassed to the command. This data is conv\", \"erted as it's passed between source and target by the \\nconverter specified in the EventArgsConverter\", \" property, which returns the Item of the ListView \\nfrom the ItemTappedEventArgs. Therefore, when the\", \" OrderDetailCommand is executed, the selected \\nOrder is passed as a parameter to the registered Acti\", \"on. \\nFor more information about behaviors, see Behaviors on the Xamarin Developer Center. \\nSummary \\n\", \"The Model-View-ViewModel (MVVM) pattern helps to cleanly separate the business and presentation \\nlog\", \"ic of an application from its user interface (UI). Maintaining a clean separation between applicatio\", \"n \\nlogic and the UI helps to address numerous development issues and can make an application easier \", \"\\nto test, maintain, and evolve. It can also greatly improve code re-use opportunities and allows \\nde\", \"velopers and UI designers to more easily collaborate when developing their respective parts of an \\na\", \"pp. \\nUsing the MVVM pattern, the UI of the app and the underlying presentation and business logic is\", \" \\nseparated into three separate classes: the view, which encapsulates the UI and UI logic; the view \", \"\\nmodel, which encapsulates presentation logic and state; and the model, which encapsulates the app's\", \" \\nbusiness logic and data. \\n \\n \\n \\n18 \\nCHAPTER 3  |  Dependency injection \\n \\n \\n \\nCHAP TER  3 \\nDepende\", \"ncy \\ninjection \\nTypically, a class constructor is invoked when instantiating an object, and any valu\", \"es that the object \\nneeds are passed as arguments to the constructor. This is an example of dependen\", \"cy injection, and \\nspecifically is known as constructor injection. The dependencies the object needs\", \" are injected into the \\nconstructor. \\nBy specifying dependencies as interface types, dependency inje\", \"ction enables decoupling of the \\nconcrete types from the code that depends on these types. It genera\", \"lly uses a container that holds a \\nlist of registrations and mappings between interfaces and abstrac\", \"t types, and the concrete types that \\nimplement or extend these types. \\nThere are also other types o\", \"f dependency injection, such as property setter injection, and method call \\ninjection, but they are \", \"less commonly seen. Therefore, this chapter will focus solely on performing \\nconstructor injection w\", \"ith a dependency injection container. \\nIntroduction to dependency injection \\nDependency injection is\", \" a specialized version of the Inversion of Control (IoC) pattern, where the \\nconcern being inverted \", \"is the process of obtaining the required dependency. With dependency \\ninjection, another class is re\", \"sponsible for injecting dependencies into an object at runtime. The \\nfollowing code example shows ho\", \"w the ProfileViewModel class is structured when using \\ndependency injection: \\npublic class ProfileVi\", \"ewModel : ViewModelBase \\n{ \\n    private IOrderService _orderService; \\n \\n    public ProfileViewModel(\", \"IOrderService orderService) \\n    { \\n        _orderService = orderService; \\n    } \\n    ... \\n}  \\nThe P\", \"rofileViewModel constructor receives an IOrderService instance as an argument, injected by \\nanother \", \"class. The only dependency in the ProfileViewModel class is on the interface type. \\nTherefore, the P\", \"rofileViewModel class doesn't have any knowledge of the class that's responsible for \\ninstantiating \", \"the IOrderService object. The class that's responsible for instantiating the \\n19 \\nCHAPTER 3  |  Depe\", \"ndency injection \\n \\nIOrderService object, and inserting it into the ProfileViewModel class, is known\", \" as the dependency \\ninjection container. \\nDependency injection containers reduce the coupling betwee\", \"n objects by providing a facility to \\ninstantiate class instances and manage their lifetime based on\", \" the configuration of the container. \\nDuring the objects creation, the container injects any depende\", \"ncies that the object requires into it. If \\nthose dependencies have not yet been created, the contai\", \"ner creates and resolves their dependencies \\nfirst.  \\nNote: Dependency injection can also be impleme\", \"nted manually using factories. However, using a \\ncontainer provides additional capabilities such as \", \"lifetime management, and registration through \\nassembly scanning. \\nThere are several advantages to u\", \"sing a dependency injection container: \\n\\u2022 \\nA container removes the need for a class to locate its de\", \"pendencies and manage their \\nlifetimes. \\n\\u2022 \\nA container allows mapping of implemented dependencies w\", \"ithout affecting the class. \\n\\u2022 \\nA container facilitates testability by allowing dependencies to be m\", \"ocked. \\n\\u2022 \\nA container increases maintainability by allowing new classes to be easily added to the a\", \"pp. \\nIn the context of a Xamarin.Forms app that uses MVVM, a dependency injection container will \\nty\", \"pically be used for registering and resolving view models, and for registering services and injectin\", \"g \\nthem into view models. \\nThere are many dependency injection containers available, with the eShopO\", \"nContainers mobile app \\nusing Autofac to manage the instantiation of view model and service classes \", \"in the app. Autofac \\nfacilitates building loosely coupled apps, and provides all of the features com\", \"monly found in \\ndependency injection containers, including methods to register type mappings and obj\", \"ect instances, \\nresolve objects, manage object lifetimes, and inject dependent objects into construc\", \"tors of objects \\nthat it resolves. For more information about Autofac, see Autofac on readthedocs.io\", \". \\nIn Autofac, the IContainer interface provides the dependency injection container. Figure 3-1 show\", \"s \\nthe dependencies when using this container, which instantiates an IOrderService object and inject\", \"s \\nit into the ProfileViewModel class. \\nFigure 3-1: Dependencies when using dependency injection \\n20\", \" \\nCHAPTER 3  |  Dependency injection \\n \\nAt runtime, the container must know which implementation of \", \"the IOrderService interface it should \\ninstantiate, before it can instantiate a ProfileViewModel obj\", \"ect. This involves: \\n\\u2022 \\nThe container deciding how to instantiate an object that implements the IOrd\", \"erService \\ninterface. This is known as registration. \\n\\u2022 \\nThe container instantiating the object that\", \" implements the IOrderService interface, and the \\nProfileViewModel object. This is known as resoluti\", \"on. \\nEventually, the app will finish using the ProfileViewModel object and it will become available \", \"for \\ngarbage collection. At this point, the garbage collector should dispose of the IOrderService in\", \"stance \\nif other classes do not share the same instance.  \\nTip: Write container-agnostic code \\nAlway\", \"s try to write container-agnostic code to decouple the app from the specific dependency \\ncontainer b\", \"eing used. \\nRegistration \\nBefore dependencies can be injected into an object, the types of the depen\", \"dencies must first be \\nregistered with the container. Registering a type typically involves passing \", \"the container an interface \\nand a concrete type that implements the interface. \\nThere are two ways o\", \"f registering types and objects in the container through code: \\n\\u2022 \\nRegister a type or mapping with t\", \"he container. When required, the container will build an \\ninstance of the specified type. \\n\\u2022 \\nRegist\", \"er an existing object in the container as a singleton. When required, the container will \\nreturn a r\", \"eference to the existing object. \\nTip: Dependency injection containers are not always suitable \\nDepe\", \"ndency injection introduces additional complexity and requirements that might not be \\nappropriate or\", \" useful to small apps. If a class does not have any dependencies, or is not a \\ndependency for other \", \"types, it might not make sense to put it in the container. In addition, if a class \\nhas a single set\", \" of dependencies that are integral to the type and will never change, it might not \\nmake sense to pu\", \"t it in the container. \\nThe registration of types that require dependency injection should be perfor\", \"med in a single method in \\nan app, and this method should be invoked early in the app's lifecycle to\", \" ensure that the app is aware \\nof the dependencies between its classes. In the eShopOnContainers mob\", \"ile app this is performed by \\nthe ViewModelLocator class, which builds the IContainer object and is \", \"the only class in the app that \\nholds a reference to that object. The following code example shows h\", \"ow the eShopOnContainers \\nmobile app declares the IContainer object in the ViewModelLocator class: \\n\", \"private static IContainer _container;  \\nTypes and instances are registered in the RegisterDependenci\", \"es method in the ViewModelLocator \\nclass. This is achieved by first creating a ContainerBuilder inst\", \"ance, which is demonstrated in the \\nfollowing code example: \\nvar builder = new ContainerBuilder();  \", \"\\n21 \\nCHAPTER 3  |  Dependency injection \\n \\nTypes and instances are then registered with the Containe\", \"rBuilder object, and the following code \\nexample demonstrates the most common form of type registrat\", \"ion: \\nbuilder.RegisterType<RequestProvider>().As<IRequestProvider>();  \\nThe RegisterType method show\", \"n here maps an interface type to a concrete type. It tells the \\ncontainer to instantiate a RequestPr\", \"ovider object when it instantiates an object that requires an \\ninjection of an IRequestProvider thro\", \"ugh a constructor. \\nConcrete types can also be registered directly without a mapping from an interfa\", \"ce type, as shown in \\nthe following code example: \\nbuilder.RegisterType<ProfileViewModel>();  \\nWhen \", \"the ProfileViewModel type is resolved, the container will inject its required dependencies. \\nAutofac\", \" also allows instance registration, where the container is responsible for maintaining a \\nreference \", \"to a singleton instance of a type. For example, the following code example shows how the \\neShopOnCon\", \"tainers mobile app registers the concrete type to use when a ProfileViewModel \\ninstance requires an \", \"IOrderService instance: \\nbuilder.RegisterType<OrderService>().As<IOrderService>().SingleInstance(); \", \" \\nThe RegisterType method shown here maps an interface type to a concrete type. The \\nSingleInstance \", \"method configures the registration so that every dependent object receives the \\nsame shared instance\", \". Therefore, only a single OrderService instance will exist in the container, \\nwhich is shared by ob\", \"jects that require an injection of an IOrderService through a constructor.  \\nInstance registration c\", \"an also be performed with the RegisterInstance method, which is \\ndemonstrated in the following code \", \"example: \\nbuilder.RegisterInstance(new OrderMockService()).As<IOrderService>();  \\nThe RegisterInstan\", \"ce method shown here creates a new OrderMockService instance and registers \\nit with the container. T\", \"herefore, only a single OrderMockService instance exists in the container, \\nwhich is shared by objec\", \"ts that require an injection of an IOrderService through a constructor. \\nFollowing type and instance\", \" registration, the IContainer object must be built, which is demonstrated \\nin the following code exa\", \"mple: \\n_container = builder.Build();  \\nInvoking the Build method on the ContainerBuilder instance bu\", \"ilds a new dependency injection \\ncontainer that contains the registrations that have been made. \\nTip\", \": Consider an IContainer as being immutable \\nWhile Autofac provides an Update method to update regis\", \"trations in an existing container, calling \\nthis method should be avoided where possible. There are \", \"risks to modifying a container after it's \\nbeen built, particularly if the container has been used. \", \"For more information, see Consider a \\nContainer as Immutable on readthedocs.io. \\n22 \\nCHAPTER 3  |  D\", \"ependency injection \\n \\nResolution \\nAfter a type is registered, it can be resolved or injected as a d\", \"ependency. When a type is being \\nresolved and the container needs to create a new instance, it injec\", \"ts any dependencies into the \\ninstance. \\nGenerally, when a type is resolved, one of three things hap\", \"pens: \\n1. \\nIf the type hasn't been registered, the container throws an exception. \\n2. If the type ha\", \"s been registered as a singleton, the container returns the singleton instance. If \\nthis is the firs\", \"t time the type is called for, the container creates it if required, and maintains a \\nreference to i\", \"t. \\n3. If the type hasn't been registered as a singleton, the container returns a new instance, and \", \"\\ndoesn't maintain a reference to it. \\nThe following code example shows how the RequestProvider type \", \"that was previously registered \\nwith Autofac can be resolved: \\nvar requestProvider = _container.Reso\", \"lve<IRequestProvider>();  \\nIn this example, Autofac is asked to resolve the concrete type for the IR\", \"equestProvider type, along \\nwith any dependencies. Typically, the Resolve method is called when an i\", \"nstance of a specific type is \\nrequired. For information about controlling the lifetime of resolved \", \"objects, see Managing the lifetime \\nof resolved objects. \\nThe following code example shows how the e\", \"ShopOnContainers mobile app instantiates view model \\ntypes and their dependencies: \\nvar viewModel = \", \"_container.Resolve(viewModelType);  \\nIn this example, Autofac is asked to resolve the view model typ\", \"e for a requested view model, and the \\ncontainer will also resolve any dependencies. When resolving \", \"the ProfileViewModel type, the \\ndependency to resolve is an IOrderService object. Therefore, Autofac\", \" first constructs an \\nOrderService object and then passes it to the constructor of the ProfileViewMo\", \"del class. For more \\ninformation about how the eShopOnContainers mobile app constructs view models a\", \"nd associates \\nthem to views, see Automatically creating a view model with a view model locator. \\nNo\", \"te: Registering and resolving types with a container has a performance cost because of the \\ncontaine\", \"r's use of reflection for creating each type, especially if dependencies are being \\nreconstructed fo\", \"r each page navigation in the app. If there are many or deep dependencies, the \\ncost of creation can\", \" increase significantly. \\nManaging the lifetime of resolved objects \\nAfter registering a type, the d\", \"efault behavior for Autofac is to create a new instance of the registered \\ntype each time the type i\", \"s resolved, or when the dependency mechanism injects instances into other \\nclasses. In this scenario\", \", the container doesn't hold a reference to the resolved object. However, when \\nregistering an insta\", \"nce, the default behavior for Autofac is to manage the lifetime of the object as a \\nsingleton. There\", \"fore, the instance remains in scope while the container is in scope, and is disposed \\nwhen the conta\", \"iner goes out of scope and is garbage collected, or when code explicitly disposes the \\ncontainer. \\n2\", \"3 \\nCHAPTER 3  |  Dependency injection \\n \\nAn Autofac instance scope can be used to specify the single\", \"ton behavior for an object that Autofac \\ncreates from a registered type. Autofac instance scopes man\", \"age the object lifetimes instantiated by \\nthe container. The default instance scope for the Register\", \"Type method is the \\nInstancePerDependency scope. However, the SingleInstance scope can be used with \", \"the \\nRegisterType method, so that the container creates or returns a singleton instance of a type wh\", \"en \\ncalling the Resolve method. The following code example shows how Autofac is instructed to create\", \" a \\nsingleton instance of the NavigationService class: \\nbuilder.RegisterType<NavigationService>().As\", \"<INavigationService>().SingleInstance();  \\nThe first time that the INavigationService interface is r\", \"esolved, the container creates a new \\nNavigationService object and maintains a reference to it. On a\", \"ny subsequent resolutions of the \\nINavigationService interface, the container returns a reference to\", \" the NavigationService object \\nthat was previously created.  \\nNote: The SingleInstance scope dispose\", \"s created objects when the container is disposed. \\nAutofac includes additional instance scopes. For \", \"more information, see Instance Scope on \\nreadthedocs.io. \\nSummary \\nDependency injection enables deco\", \"upling of concrete types from the code that depends on these \\ntypes. It typically uses a container t\", \"hat holds a list of registrations and mappings between interfaces \\nand abstract types, and the concr\", \"ete types that implement or extend these types. \\nAutofac facilitates building loosely coupled apps, \", \"and provides all of the features commonly found in \\ndependency injection containers, including metho\", \"ds to register type mappings and object instances, \\nresolve objects, manage object lifetimes, and in\", \"ject dependent objects into constructors of objects it \\nresolves. \\n \\n \\n \\n24 \\nCHAPTER 4  |  Communica\", \"ting between loosely coupled components \\n \\n \\n \\nCHAP TER  4 \\nCommunicating \\nbetween loosely \\ncoupled \", \"\\ncomponents \\nThe publish-subscribe pattern is a messaging pattern in which publishers send messages \", \"without \\nhaving knowledge of any receivers, known as subscribers. Similarly, subscribers listen for \", \"specific \\nmessages, without having knowledge of any publishers.  \\nEvents in .NET implement the publi\", \"sh-subscribe pattern, and are the most simple and straightforward \\napproach for a communication laye\", \"r between components if loose coupling is not required, such as a \\ncontrol and the page that contain\", \"s it. However, the publisher and subscriber lifetimes are coupled by \\nobject references to each othe\", \"r, and the subscriber type must have a reference to the publisher type. \\nThis can create memory mana\", \"gement issues, especially when there are short lived objects that \\nsubscribe to an event of a static\", \" or long-lived object. If the event handler isn't removed, the subscriber \\nwill be kept alive by the\", \" reference to it in the publisher, and this will prevent or delay the garbage \\ncollection of the sub\", \"scriber. \\nIntroduction to MessagingCenter \\nThe Xamarin.Forms MessagingCenter class implements the pu\", \"blish-subscribe pattern, allowing \\nmessage-based communication between components that are inconveni\", \"ent to link by object and type \\nreferences. This mechanism allows publishers and subscribers to comm\", \"unicate without having a \\nreference to each other, helping to reduce dependencies between components\", \", while also allowing \\ncomponents to be independently developed and tested. \\nThe MessagingCenter cla\", \"ss provides multicast publish-subscribe functionality. This means that there \\ncan be multiple publis\", \"hers that publish a single message, and there can be multiple subscribers \\nlistening for the same me\", \"ssage. Figure 4-1 illustrates this relationship: \\n25 \\nCHAPTER 4  |  Communicating between loosley co\", \"upled components \\n \\n \\nFigure 4-1: Multicast publish-subscribe functionality \\nPublishers send message\", \"s using the MessagingCenter.Send method, while subscribers listen for \\nmessages using the MessagingC\", \"enter.Subscribe method. In addition, subscribers can also \\nunsubscribe from message subscriptions, i\", \"f required, with the MessagingCenter.Unsubscribe \\nmethod. \\nInternally, the MessagingCenter class use\", \"s weak references. This means that it will not keep objects \\nalive, and will allow them to be garbag\", \"e collected. Therefore, it should only be necessary to \\nunsubscribe from a message when a class no l\", \"onger wishes to receive the message. \\nThe eShopOnContainers mobile app uses the MessagingCenter clas\", \"s to communicate between \\nloosely coupled components. The app defines three messages: \\n\\u2022 \\nThe AddPro\", \"duct message is published by the CatalogViewModel class when an item is \\nadded to the shopping baske\", \"t. In return, the BasketViewModel class subscribes to the \\nmessage and increments the number of item\", \"s in the shopping basket in response. In addition, \\nthe BasketViewModel class also unsubscribes from\", \" this message. \\n\\u2022 \\nThe Filter message is published by the CatalogViewModel class when the user appli\", \"es a \\nbrand or type filter to the items displayed from the catalogue. In return, the CatalogView \\ncl\", \"ass subscribes to the message and updates the UI so that only items that match the filter \\ncriteria \", \"are displayed. \\n\\u2022 \\nThe ChangeTab message is published by the MainViewModel class when the \\nCheckoutV\", \"iewModel navigates to the MainViewModel following the successful creation and \\nsubmission of a new o\", \"rder. In return, the MainView class subscribes to the message and \\nupdates the UI so that the My pro\", \"file tab is active, to show the user's orders.  \\nNote: While the MessagingCenter class permits commu\", \"nication between loosely-coupled classes, \\nit does not offer the only architectural solution to this\", \" issue. For example, communication between \\na view model and a view can also be achieved by the bind\", \"ing engine and through property change \\nnotifications. In addition, communication between two view m\", \"odels can also be achieved by \\npassing data during navigation. \\nIn the eShopOnContainers mobile app,\", \" MessagingCenter is used to update in the UI in response to \\nan action occurring in another class. T\", \"herefore, messages are published on the UI thread, with \\nsubscribers receiving the message on the sa\", \"me thread. \\n \\n \\n26 \\nCHAPTER 4  |  Communicating between loosley coupled components \\n \\nTip: Marshal t\", \"o the UI thread when performing UI updates \\nIf a message that's sent from a background thread is req\", \"uired to update the UI, process the \\nmessage on the UI thread in the subscriber by invoking the Devi\", \"ce.BeginInvokeOnMainThread \\nmethod. \\nFor more information about MessagingCenter, see MessagingCenter\", \" on the Xamarin Developer \\nCenter. \\nDefining a message \\nMessagingCenter messages are strings that ar\", \"e used to identify messages. The following code \\nexample shows the messages defined within the eShop\", \"OnContainers mobile app: \\npublic class MessengerKeys \\n{ \\n    // Add product to basket \\n    public co\", \"nst string AddProduct = \\\"AddProduct\\\"; \\n \\n    // Filter \\n    public const string Filter = \\\"Filter\\\"; \\n\", \" \\n    // Change selected Tab programmatically \\n    public const string ChangeTab = \\\"ChangeTab\\\"; \\n}  \", \"\\nIn this example, messages are defined using constants. The advantage of this approach is that it \\np\", \"rovides compile-time type safety and refactoring support. \\nPublishing a message \\nPublishers notify s\", \"ubscribers of a message with one of the MessagingCenter.Send overloads. The \\nfollowing code example \", \"demonstrates publishing the AddProduct message: \\nMessagingCenter.Send(this, MessengerKeys.AddProduct\", \", catalogItem);  \\nIn this example, the Send method specifies three arguments: \\n\\u2022 \\nThe first argument\", \" specifies the sender class. The sender class must be specified by any \\nsubscribers who wish to rece\", \"ive the message. \\n\\u2022 \\nThe second argument specifies the message. \\n\\u2022 \\nThe third argument specifies the\", \" payload data to be sent to the subscriber. In this case the \\npayload data is a CatalogItem instance\", \". \\nThe Send method will publish the message, and its payload data, using a fire-and-forget approach.\", \" \\nTherefore, the message is sent even if there are no subscribers registered to receive the message.\", \" In \\nthis situation, the sent message is ignored. \\nNote: The MessagingCenter.Send method can use gen\", \"eric parameters to control how messages \\nare delivered. Therefore, multiple messages that share a me\", \"ssage identity but send different \\npayload data types can be received by different subscribers. \\n27 \", \"\\nCHAPTER 4  |  Communicating between loosley coupled components \\n \\nSubscribing to a message \\nSubscri\", \"bers can register to receive a message using one of the MessagingCenter.Subscribe \\noverloads. The fo\", \"llowing code example demonstrates how the eShopOnContainers mobile app \\nsubscribes to, and processes\", \", the AddProduct message: \\nMessagingCenter.Subscribe<CatalogViewModel, CatalogItem>( \\n    this, Mess\", \"ageKeys.AddProduct, async (sender, arg) => \\n{ \\n    BadgeCount++; \\n \\n    await AddCatalogItemAsync(ar\", \"g); \\n});  \\nIn this example, the Subscribe method subscribes to the AddProduct message, and executes \", \"a \\ncallback delegate in response to receiving the message. This callback delegate, specified as a la\", \"mbda \\nexpression, executes code that updates the UI. \\nTip: Consider using immutable payload data \\nDo\", \"n't attempt to modify the payload data from within a callback delegate because several threads \\ncoul\", \"d be accessing the received data simultaneously. In this scenario, the payload data should be \\nimmut\", \"able to avoid concurrency errors. \\nA subscriber might not need to handle every instance of a publish\", \"ed message, and this can be \\ncontrolled by the generic type arguments that are specified on the Subs\", \"cribe method. In this \\nexample, the subscriber will only receive AddProduct messages that are sent f\", \"rom the \\nCatalogViewModel class, whose payload data is a CatalogItem instance. \\nUnsubscribing from a\", \" message \\nSubscribers can unsubscribe from messages they no longer want to receive. This is achieved\", \" with one \\nof the MessagingCenter.Unsubscribe overloads, as demonstrated in the following code examp\", \"le: \\nMessagingCenter.Unsubscribe<CatalogViewModel, CatalogItem>(this, MessengerKeys.AddProduct);  \\nI\", \"n this example, the Unsubscribe method syntax reflects the type arguments specified when \\nsubscribin\", \"g to receive the AddProduct message. \\nSummary \\nThe Xamarin.Forms MessagingCenter class implements th\", \"e publish-subscribe pattern, allowing \\nmessage-based communication between components that are incon\", \"venient to link by object and type \\nreferences. This mechanism allows publishers and subscribers to \", \"communicate without having a \\nreference to each other, helping to reduce dependencies between compon\", \"ents, while also allowing \\ncomponents to be independently developed and tested. \\n \\n \\n \\n28 \\nCHAPTER 5\", \"  |  Navigation \\n \\n \\n \\nCHAP TER  5 \\nNavigation \\nXamarin.Forms includes support for page navigation, \", \"which typically results from the user's interaction \\nwith the UI or from the app itself as a result \", \"of internal logic-driven state changes. However, \\nnavigation can be complex to implement in apps tha\", \"t use the Model-View-ViewModel (MVVM) \\npattern, as the following challenges must be met: \\n\\u2022 \\nHow to \", \"identify the view to be navigated to, using an approach that does not introduce tight \\ncoupling and \", \"dependencies between views. \\n\\u2022 \\nHow to coordinate the process by which the view to be navigated to i\", \"s instantiated and \\ninitialized. When using MVVM, the view and view model need to be instantiated an\", \"d \\nassociated with each other via the view's binding context. When an app is using a \\ndependency inj\", \"ection container, the instantiation of views and view models might require a \\nspecific construction \", \"mechanism. \\n\\u2022 \\nWhether to perform view-first navigation, or view model-first navigation. With view-f\", \"irst \\nnavigation, the page to navigate to refers to the name of the view type. During navigation, \\nt\", \"he specified view is instantiated, along with its corresponding view model and other \\ndependent serv\", \"ices. An alternative approach is to use view model-first navigation, where the \\npage to navigate to \", \"refers to the name of the view model type. \\n\\u2022 \\nHow to cleanly separate the navigational behavior of \", \"the app across the views and view \\nmodels. The MVVM pattern provides a separation between the app's \", \"UI and its presentation \\nand business logic. However, the navigation behavior of an app will often s\", \"pan the UI and \\npresentations parts of the app. The user will often initiate navigation from a view,\", \" and the \\nview will be replaced as a result of the navigation. However, navigation might often also \", \"need \\nto be initiated or coordinated from within the view model.  \\n\\u2022 \\nHow to pass parameters during \", \"navigation for initialization purposes. For example, if the user \\nnavigates to a view to update orde\", \"r details, the order data will have to be passed to the view \\nso that it can display the correct dat\", \"a. \\n\\u2022 \\nHow to co-ordinate navigation, to ensure that certain business rules are obeyed. For example,\", \" \\nusers might be prompted before navigating away from a view so that they can correct any \\ninvalid d\", \"ata or be prompted to submit or discard any data changes that were made within the \\nview. \\nThis chap\", \"ter addresses these challenges by presenting a NavigationService class that's used to \\nperform view \", \"model-first page navigation. \\nNote: The NavigationService used by the app is designed only to perfor\", \"m hierarchical \\nnavigation between ContentPage instances. Using the service to navigate between othe\", \"r page \\ntypes might result in unexpected behavior. \\n29 \\nCHAPTER 5  |  Navigation \\n \\nNavigating betwe\", \"en pages \\nNavigation logic can reside in a view's code-behind, or in a data bound view model. While \", \"placing \\nnavigation logic in a view might be the simplest approach, it is not easily testable throug\", \"h unit tests. \\nPlacing navigation logic in view model classes means that the logic can be exercised \", \"through unit \\ntests. In addition, the view model can then implement logic to control navigation to e\", \"nsure that \\ncertain business rules are enforced. For example, an app might not allow the user to nav\", \"igate away \\nfrom a page without first ensuring that the entered data is valid. \\nA NavigationService \", \"class is typically invoked from view models, in order to promote testability. \\nHowever, navigating t\", \"o views from view models would require the view models to reference views, \\nand particularly views t\", \"hat the active view model isn't associated with, which is not recommended. \\nTherefore, the Navigatio\", \"nService presented here specifies the view model type as the target to \\nnavigate to. \\nThe eShopOnCon\", \"tainers mobile app uses the NavigationService class to provide view model-first \\nnavigation. This cl\", \"ass implements the INavigationService interface, which is shown in the following \\ncode example: \\npub\", \"lic interface INavigationService \\n{ \\n    ViewModelBase PreviousPageViewModel { get; } \\n    Task Init\", \"ializeAsync(); \\n    Task NavigateToAsync<TViewModel>() where TViewModel : ViewModelBase; \\n    Task N\", \"avigateToAsync<TViewModel>(object parameter) where TViewModel : ViewModelBase; \\n    Task RemoveLastF\", \"romBackStackAsync(); \\n    Task RemoveBackStackAsync(); \\n}  \\nThis interface specifies that an impleme\", \"nting class must provide the following methods: \\nMethod \\nPurpose \\nInitializeAsync \\nPerforms navigati\", \"on to one of two pages when the app is \\nlaunched. \\nNavigateToAsync<T> \\nPerforms hierarchical navigat\", \"ion to a specified page. \\nNavigateToAsync<T>(parameter) Performs hierarchical navigation to a specif\", \"ied page, passing \\na parameter. \\nRemoveLastFromBackStackAsync \\nRemoves the previous page from the na\", \"vigation stack. \\nRemoveBackStackAsync \\nRemoves all the previous pages from the navigation stack. \\n \\n\", \"In addition, the INavigationService interface specifies that an implementing class must provide a \\nP\", \"reviousPageViewModel property. This property returns the view model type associated with the \\nprevio\", \"us page in the navigation stack. \\nNote: An INavigationService interface would usually also specify a\", \" GoBackAsync method, which \\nis used to programmatically return to the previous page in the navigatio\", \"n stack. However, this \\nmethod is missing from the eShopOnContainers mobile app because it's not req\", \"uired. \\nCreating the NavigationService instance \\nThe NavigationService class, which implements the I\", \"NavigationService interface, is registered as \\na singleton with the Autofac dependency injection con\", \"tainer, as demonstrated in the following code \\nexample: \\n30 \\nCHAPTER 5  |  Navigation \\n \\nbuilder.Reg\", \"isterType<NavigationService>().As<INavigationService>().SingleInstance();  \\nThe INavigationService i\", \"nterface is resolved in the ViewModelBase class constructor, as \\ndemonstrated in the following code \", \"example: \\nNavigationService = ViewModelLocator.Resolve<INavigationService>();  \\nThis returns a refer\", \"ence to the NavigationService object that's stored in the Autofac dependency \\ninjection container, w\", \"hich is created by the InitNavigation method in the App class. For more \\ninformation, see Navigating\", \" when the app is launched. \\nThe ViewModelBase class stores the NavigationService instance in a Navig\", \"ationService property, \\nof type INavigationService. Therefore, all view model classes, which derive \", \"from the \\nViewModelBase class, can use the NavigationService property to access the methods specifie\", \"d by \\nthe INavigationService interface. This avoids the overhead of injecting the NavigationService \", \"\\nobject from the Autofac dependency injection container into each view model class. \\nHandling naviga\", \"tion requests \\nXamarin.Forms provides the NavigationPage class, which implements a hierarchical navi\", \"gation \\nexperience in which the user is able to navigate through pages, forwards and backwards, as d\", \"esired. \\nFor more information about hierarchical navigation, see Hierarchical Navigation on the Xama\", \"rin \\nDeveloper Center. \\nRather than use the NavigationPage class directly, the eShopOnContainers app\", \" wraps the \\nNavigationPage class in the CustomNavigationView class, as shown in the following code e\", \"xample: \\npublic partial class CustomNavigationView : NavigationPage \\n{ \\n    public CustomNavigationV\", \"iew() : base() \\n    { \\n        InitializeComponent(); \\n    } \\n \\n    public CustomNavigationView(Page\", \" root) : base(root) \\n    { \\n        InitializeComponent(); \\n    } \\n}  \\nThe purpose of this wrapping \", \"is for ease of styling the NavigationPage instance inside the XAML file \\nfor the class. \\nNavigation \", \"is performed inside view model classes by invoking one of the NavigateToAsync \\nmethods, specifying t\", \"he view model type for the page being navigated to, as demonstrated in the \\nfollowing code example: \", \"\\nawait NavigationService.NavigateToAsync<MainViewModel>();  \\nThe following code example shows the Na\", \"vigateToAsync methods provided by the \\nNavigationService class: \\n \\n31 \\nCHAPTER 5  |  Navigation \\n \\np\", \"ublic Task NavigateToAsync<TViewModel>() where TViewModel : ViewModelBase \\n{ \\n    return InternalNav\", \"igateToAsync(typeof(TViewModel), null); \\n} \\n \\npublic Task NavigateToAsync<TViewModel>(object paramet\", \"er) where TViewModel : ViewModelBase \\n{ \\n    return InternalNavigateToAsync(typeof(TViewModel), para\", \"meter); \\n}  \\nEach method allows any view model class that derives from the ViewModelBase class to pe\", \"rform \\nhierarchical navigation by invoking the InternalNavigateToAsync method. In addition, the seco\", \"nd \\nNavigateToAsync method enables navigation data to be specified as an argument that's passed to \\n\", \"the view model being navigated to, where it's typically used to perform initialization. For more \\nin\", \"formation, see Passing parameters during navigation. \\nThe InternalNavigateToAsync method executes th\", \"e navigation request, and is shown in the \\nfollowing code example: \\nprivate async Task InternalNavig\", \"ateToAsync(Type viewModelType, object parameter) \\n{ \\n    Page page = CreatePage(viewModelType, param\", \"eter); \\n \\n    if (page is LoginView) \\n    { \\n        Application.Current.MainPage = new CustomNaviga\", \"tionView(page); \\n    } \\n    else \\n    { \\n        var navigationPage = Application.Current.MainPage a\", \"s CustomNavigationView; \\n        if (navigationPage != null) \\n        { \\n            await navigatio\", \"nPage.PushAsync(page); \\n        } \\n        else \\n        { \\n            Application.Current.MainPage\", \" = new CustomNavigationView(page); \\n        } \\n    } \\n \\n    await (page.BindingContext as ViewModelB\", \"ase).InitializeAsync(parameter); \\n} \\n \\nprivate Type GetPageTypeForViewModel(Type viewModelType) \\n{ \\n\", \"    var viewName = viewModelType.FullName.Replace(\\\"Model\\\", string.Empty); \\n    var viewModelAssembly\", \"Name = viewModelType.GetTypeInfo().Assembly.FullName; \\n    var viewAssemblyName = string.Format( \\n  \", \"              CultureInfo.InvariantCulture, \\\"{0}, {1}\\\", viewName, viewModelAssemblyName); \\n    var v\", \"iewType = Type.GetType(viewAssemblyName); \\n    return viewType; \\n} \\n \\nprivate Page CreatePage(Type v\", \"iewModelType, object parameter) \\n{ \\n    Type pageType = GetPageTypeForViewModel(viewModelType); \\n   \", \" if (pageType == null) \\n    { \\n        throw new Exception($\\\"Cannot locate page type for {viewModelT\", \"ype}\\\"); \\n    } \\n \\n32 \\nCHAPTER 5  |  Navigation \\n \\n    Page page = Activator.CreateInstance(pageType)\", \" as Page; \\n    return page; \\n} \\nThe InternalNavigateToAsync method performs navigation to a view mod\", \"el by first calling the \\nCreatePage method. This method locates the view that corresponds to the spe\", \"cified view model type, \\nand creates and returns an instance of this view type. Locating the view th\", \"at corresponds to the view \\nmodel type uses a convention-based approach, which assumes that: \\n\\u2022 \\nVie\", \"ws are in the same assembly as view model types. \\n\\u2022 \\nViews are in a .Views child namespace. \\n\\u2022 \\nView\", \" models are in a .ViewModels child namespace. \\n\\u2022 \\nView names correspond to view model names, with \\\"M\", \"odel\\\" removed. \\nWhen a view is instantiated, it's associated with its corresponding view model. For \", \"more information \\nabout how this occurs, see Automatically creating a view model with a view model l\", \"ocator. \\nIf the view being created is a LoginView, it's wrapped inside a new instance of the \\nCustom\", \"NavigationView class and assigned to the Application.Current.MainPage property. \\nOtherwise, the Cust\", \"omNavigationView instance is retrieved, and provided that it isn't null, the \\nPushAsync method is in\", \"voked to push the view being created onto the navigation stack. However, If \\nthe retrieved CustomNav\", \"igationView instance is null, the view being created is wrapped inside a \\nnew instance of the Custom\", \"NavigationView class and assigned to the \\nApplication.Current.MainPage property. This mechanism ensu\", \"res that during navigation, pages \\nare added correctly to the navigation stack both when it's empty,\", \" and when it contains data. \\nTip: Consider caching pages \\nPage caching results in memory consumption\", \" for views that are not currently displayed. However, \\nwithout page caching it does mean that XAML p\", \"arsing and construction of the page and its view \\nmodel will occur every time a new page is navigate\", \"d to, which can have a performance impact for a \\ncomplex page. For a well-designed page that does no\", \"t use an excessive number of controls, the \\nperformance should be sufficient. However, page caching \", \"might help if slow page loading times are \\nencountered. \\nAfter the view is created and navigated to,\", \" the InitializeAsync method of the view's associated \\nview model is executed. For more information, \", \"see Passing parameters during navigation. \\nNavigating when the app is launched \\nWhen the app is laun\", \"ched, the InitNavigation method in the App class is invoked. The following \\ncode example shows this \", \"method: \\nprivate Task InitNavigation() \\n{ \\n    var navigationService = ViewModelLocator.Resolve<INav\", \"igationService>(); \\n    return navigationService.InitializeAsync(); \\n}  \\nThe method creates a new Na\", \"vigationService object in the Autofac dependency injection container, \\nand returns a reference to it\", \", before invoking its InitializeAsync method.  \\n33 \\nCHAPTER 5  |  Navigation \\n \\nNote: When the INavi\", \"gationService interface is resolved by the ViewModelBase class, the \\ncontainer returns a reference t\", \"o the NavigationService object that was created when the \\nInitNavigation method is invoked.  \\nThe fo\", \"llowing code example shows the NavigationService InitializeAsync method: \\npublic Task InitializeAsyn\", \"c() \\n{ \\n    if (string.IsNullOrEmpty(Settings.AuthAccessToken)) \\n        return NavigateToAsync<Logi\", \"nViewModel>(); \\n    else \\n        return NavigateToAsync<MainViewModel>(); \\n} \\nThe MainView is navig\", \"ated to if the app has a cached access token, which is used for authentication. \\nOtherwise, the Logi\", \"nView is navigated to. \\nFor more information about the Autofac dependency injection container, see I\", \"ntroduction to \\ndependency injection. \\nPassing parameters during navigation \\nOne of the NavigateToAs\", \"ync methods, specified by the INavigationService interface, enables \\nnavigation data to be specified\", \" as an argument that's passed to the view model being navigated to, \\nwhere it's typically used to pe\", \"rform initialization. \\nFor example, the ProfileViewModel class contains an OrderDetailCommand that's\", \" executed when \\nthe user selects an order on the ProfileView page. In turn, this executes the OrderD\", \"etailAsync \\nmethod, which is shown in the following code example: \\nprivate async Task OrderDetailAsy\", \"nc(Order order) \\n{ \\n    await NavigationService.NavigateToAsync<OrderDetailViewModel>(order); \\n}  \\nT\", \"his method invokes navigation to the OrderDetailViewModel, passing an Order instance that \\nrepresent\", \"s the order that the user selected on the ProfileView page. When the NavigationService \\nclass create\", \"s the OrderDetailView, the OrderDetailViewModel class is instantiated and assigned to \\nthe view's Bi\", \"ndingContext. After navigating to the OrderDetailView, the \\nInternalNavigateToAsync method executes \", \"the InitializeAsync method of the view's associated \\nview model. \\nThe InitializeAsync method is defi\", \"ned in the ViewModelBase class as a method that can be \\noverridden. This method specifies an object \", \"argument that represents the data to be passed to a \\nview model during a navigation operation. There\", \"fore, view model classes that want to receive data \\nfrom a navigation operation provide their own im\", \"plementation of the InitializeAsync method to \\nperform the required initialization. The following co\", \"de example shows the InitializeAsync method \\nfrom the OrderDetailViewModel class: \\npublic override a\", \"sync Task InitializeAsync(object navigationData) \\n{ \\n    if (navigationData is Order) \\n    { \\n      \", \"  ... \\n        Order = await _ordersService.GetOrderAsync( \\n                        Convert.ToInt32(\", \"order.OrderNumber), authToken); \\n34 \\nCHAPTER 5  |  Navigation \\n \\n        ... \\n    } \\n}  \\nThis method\", \" retrieves the Order instance that was passed into the view model during the navigation \\noperation, \", \"and uses it to retrieve the full order details from the OrderService instance. \\nInvoking navigation \", \"using behaviors \\nNavigation is usually triggered from a view by a user interaction. For example, the\", \" LoginView \\nperforms navigation following successful authentication. The following code example show\", \"s how the \\nnavigation is invoked by a behavior: \\n<WebView ...> \\n    <WebView.Behaviors> \\n        <be\", \"haviors:EventToCommandBehavior \\n            EventName=\\\"Navigating\\\" \\n            EventArgsConverter=\\\"\", \"{StaticResource WebNavigatingEventArgsConverter}\\\" \\n            Command=\\\"{Binding NavigateCommand}\\\" /\", \"> \\n    </WebView.Behaviors> \\n</WebView>  \\nAt runtime, the EventToCommandBehavior will respond to int\", \"eraction with the WebView. When the \\nWebView navigates to a web page, the Navigating event will fire\", \", which will execute the \\nNavigateCommand in the LoginViewModel. By default, the event arguments for\", \" the event are passed \\nto the command. This data is converted as it's passed between source and targ\", \"et by the converter \\nspecified in the EventArgsConverter property, which returns the Url from the \\nW\", \"ebNavigatingEventArgs. Therefore, when the NavigationCommand is executed, the Url of the web \\npage i\", \"s passed as a parameter to the registered Action. \\nIn turn, the NavigationCommand executes the Navig\", \"ateAsync method, which is shown in the \\nfollowing code example: \\nprivate async Task NavigateAsync(st\", \"ring url) \\n{ \\n    ...         \\n    await NavigationService.NavigateToAsync<MainViewModel>(); \\n    aw\", \"ait NavigationService.RemoveLastFromBackStackAsync(); \\n    ... \\n}  \\nThis method invokes navigation t\", \"o the MainViewModel, and following navigation, removes the \\nLoginView page from the navigation stack\", \". \\nConfirming or cancelling navigation \\nAn app might need to interact with the user during a navigat\", \"ion operation, so that the user can \\nconfirm or cancel navigation. This might be necessary, for exam\", \"ple, when the user attempts to \\nnavigate before having fully completed a data entry page. In this si\", \"tuation, an app should provide a \\nnotification that allows the user to navigate away from the page, \", \"or to cancel the navigation operation \\nbefore it occurs. This can be achieved in a view model class \", \"by using the response from a notification \\nto control whether or not navigation is invoked. \\n35 \\nCHA\", \"PTER 5  |  Navigation \\n \\nSummary \\nXamarin.Forms includes support for page navigation, which typicall\", \"y results from the user's interaction \\nwith the UI, or from the app itself, as a result of internal \", \"logic-driven state changes. However, \\nnavigation can be complex to implement in apps that use the MV\", \"VM pattern. \\nThis chapter presented a NavigationService class, which is used to perform view model-f\", \"irst \\nnavigation from view models. Placing navigation logic in view model classes means that the log\", \"ic can \\nbe exercised through automated tests. In addition, the view model can then implement logic t\", \"o \\ncontrol navigation to ensure that certain business rules are enforced. \\n \\n \\n \\n36 \\nCHAPTER 6  |  V\", \"alidation \\n \\n \\n \\nCHAP TER  6 \\nValidation \\nAny app that accepts input from users should ensure that t\", \"he input is valid. An app could, for \\nexample, check for input that contains only characters in a pa\", \"rticular range, is of a certain length, or \\nmatches a particular format. Without validation, a user \", \"can supply data that causes the app to fail. \\nValidation enforces business rules, and prevents an at\", \"tacker from injecting malicious data. \\nIn the context of the Model-ViewModel-Model (MVVM) pattern, a\", \" view model or model will often be \\nrequired to perform data validation and signal any validation er\", \"rors to the view so that the user can \\ncorrect them. The eShopOnContainers mobile app performs synch\", \"ronous client-side validation of view \\nmodel properties and notifies the user of any validation erro\", \"rs by highlighting the control that \\ncontains the invalid data, and by displaying error messages tha\", \"t inform the user of why the data is \\ninvalid. Figure 6-1 shows the classes involved in performing v\", \"alidation in the eShopOnContainers \\nmobile app. \\nFigure 6-1: Validation classes in the eShopOnContai\", \"ners mobile app \\nView model properties that require validation are of type ValidatableObject<T>, and\", \" each \\nValidatableObject<T> instance has validation rules added to its Validations property. Validat\", \"ion \\nis invoked from the view model by calling the Validate method of the ValidatableObject<T> \\n37 \\n\", \"CHAPTER 6  |  Validation \\n \\ninstance, which retrieves the validation rules and executes them against\", \" the ValidatableObject<T> \\nValue property. Any validation errors are placed into the Errors property\", \" of the \\nValidatableObject<T> instance, and the IsValid property of the ValidatableObject<T> instanc\", \"e \\nis updated to indicate whether validation succeeded or failed. \\nProperty change notification is p\", \"rovided by the ExtendedBindableObject class, and so an Entry \\ncontrol can bind to the IsValid proper\", \"ty of ValidatableObject<T> instance in the view model class \\nto be notified of whether or not the en\", \"tered data is valid. \\nSpecifying validation rules \\nValidation rules are specified by creating a clas\", \"s that derives from the IValidationRule<T> interface, \\nwhich is shown in the following code example:\", \" \\npublic interface IValidationRule<T> \\n{ \\n    string ValidationMessage { get; set; } \\n    bool Check\", \"(T value); \\n}  \\nThis interface specifies that a validation rule class must provide a boolean Check m\", \"ethod that is used \\nto perform the required validation, and a ValidationMessage property whose value\", \" is the validation \\nerror message that will be displayed if validation fails. \\nThe following code ex\", \"ample shows the IsNotNullOrEmptyRule<T> validation rule, which is used to \\nperform validation of the\", \" username and password entered by the user on the LoginView when using \\nmock services in the eShopOn\", \"Containers mobile app: \\npublic class IsNotNullOrEmptyRule<T> : IValidationRule<T> \\n{ \\n    public str\", \"ing ValidationMessage { get; set; } \\n \\n    public bool Check(T value) \\n    { \\n        if (value == n\", \"ull) \\n        { \\n            return false; \\n        } \\n \\n        var str = value as string; \\n       \", \" return !string.IsNullOrWhiteSpace(str); \\n    } \\n}  \\nThe Check method returns a boolean indicating w\", \"hether the value argument is null, empty, or \\nconsists only of whitespace characters. \\nAlthough not \", \"used by the eShopOnContainers mobile app, the following code example shows a \\nvalidation rule for va\", \"lidating email addresses: \\npublic class EmailRule<T> : IValidationRule<T> \\n{ \\n    public string Vali\", \"dationMessage { get; set; } \\n \\n    public bool Check(T value) \\n    { \\n        if (value == null) \\n38\", \" \\nCHAPTER 6  |  Validation \\n \\n        { \\n            return false; \\n        } \\n \\n        var str = v\", \"alue as string; \\n        Regex regex = new Regex(@\\\"^([\\\\w\\\\.\\\\-]+)@([\\\\w\\\\-]+)((\\\\.(\\\\w){2,3})+)$\\\"); \\n     \", \"   Match match = regex.Match(str); \\n \\n        return match.Success; \\n    } \\n}  \\nThe Check method ret\", \"urns a boolean indicating whether or not the value argument is a valid email \\naddress. This is achie\", \"ved by searching the value argument for the first occurrence of the regular \\nexpression pattern spec\", \"ified in the Regex constructor. Whether the regular expression pattern has \\nbeen found in the input \", \"string can be determined by checking the value of the Match object's \\nSuccess property. \\nNote: Prope\", \"rty validation can sometimes involve dependent properties. An example of dependent \\nproperties is wh\", \"en the set of valid values for property A depends on the particular value that has \\nbeen set in prop\", \"erty B. To check that the value of property A is one of the allowed values would \\ninvolve retrieving\", \" the value of property B. In addition, when the value of property B changes, \\nproperty A would need \", \"to be revalidated. \\nAdding validation rules to a property \\nIn the eShopOnContainers mobile app, view\", \" model properties that require validation are declared to \\nbe of type ValidatableObject<T>, where T \", \"is the type of the data to be validated. The following \\ncode example shows an example of two such pr\", \"operties: \\npublic ValidatableObject<string> UserName \\n{ \\n    get \\n    { \\n        return _userName; \\n\", \"    } \\n    set \\n    { \\n        _userName = value; \\n        RaisePropertyChanged(() => UserName); \\n  \", \"  } \\n} \\n \\npublic ValidatableObject<string> Password \\n{ \\n    get \\n    { \\n        return _password; \\n \", \"   } \\n    set \\n    { \\n        _password = value; \\n        RaisePropertyChanged(() => Password); \\n   \", \" } \\n}  \\nFor validation to occur, validation rules must be added to the Validations collection of eac\", \"h \\nValidatableObject<T> instance, as demonstrated in the following code example: \\n39 \\nCHAPTER 6  |  \", \"Validation \\n \\nprivate void AddValidations() \\n{ \\n    _userName.Validations.Add(new IsNotNullOrEmptyRu\", \"le<string>  \\n    {  \\n        ValidationMessage = \\\"A username is required.\\\"  \\n    }); \\n    _password.\", \"Validations.Add(new IsNotNullOrEmptyRule<string>  \\n    {  \\n        ValidationMessage = \\\"A password i\", \"s required.\\\"  \\n    }); \\n} \\nThis method adds the IsNotNullOrEmptyRule<T> validation rule to the Valid\", \"ations collection of \\neach ValidatableObject<T> instance, specifying values for the validation rule'\", \"s ValidationMessage \\nproperty, which specifies the validation error message that will be displayed i\", \"f validation fails. \\nTriggering validation \\nThe validation approach used in the eShopOnContainers mo\", \"bile app can manually trigger validation \\nof a property, and automatically trigger validation when a\", \" property changes. \\nTriggering validation manually \\nValidation can be triggered manually for a view \", \"model property. For example, this occurs in the \\neShopOnContainers mobile app when the user taps the\", \" Login button on the LoginView, when using \\nmock services. The command delegate calls the MockSignIn\", \"Async method in the LoginViewModel, \\nwhich invokes validation by executing the Validate method, whic\", \"h is shown in the following code \\nexample: \\nprivate bool Validate() \\n{ \\n    bool isValidUser = Valid\", \"ateUserName(); \\n    bool isValidPassword = ValidatePassword(); \\n    return isValidUser && isValidPas\", \"sword; \\n} \\n \\nprivate bool ValidateUserName() \\n{ \\n    return _userName.Validate(); \\n} \\n \\nprivate bool\", \" ValidatePassword() \\n{ \\n    return _password.Validate(); \\n}  \\nThe Validate method performs validatio\", \"n of the username and password entered by the user on the \\nLoginView, by invoking the Validate metho\", \"d on each ValidatableObject<T> instance. The \\nfollowing code example shows the Validate method from \", \"the ValidatableObject<T> class: \\npublic bool Validate() \\n{ \\n    Errors.Clear(); \\n \\n    IEnumerable<s\", \"tring> errors = _validations \\n        .Where(v => !v.Check(Value)) \\n        .Select(v => v.Validatio\", \"nMessage); \\n40 \\nCHAPTER 6  |  Validation \\n \\n \\n    Errors = errors.ToList(); \\n    IsValid = !Errors.A\", \"ny(); \\n \\n    return this.IsValid; \\n}  \\nThis method clears the Errors collection, and then retrieves \", \"any validation rules that were added to \\nthe object's Validations collection. The Check method for e\", \"ach retrieved validation rule is executed, \\nand the ValidationMessage property value for any validat\", \"ion rule that fails to validate the data is \\nadded to the Errors collection of the ValidatableObject\", \"<T> instance. Finally, the IsValid property \\nis set, and its value is returned to the calling method\", \", indicating whether validation succeeded or \\nfailed. \\nTriggering validation when properties change \", \"\\nValidation is also automatically triggered whenever a bound property changes. For example, when a \\n\", \"two-way binding in the LoginView sets the UserName or Password property, validation is triggered. \\nT\", \"he following code example demonstrates how this occurs: \\n<Entry Text=\\\"{Binding UserName.Value, Mode=\", \"TwoWay}\\\"> \\n    <Entry.Behaviors> \\n        <behaviors:EventToCommandBehavior \\n            EventName=\\\"\", \"TextChanged\\\" \\n            Command=\\\"{Binding ValidateUserNameCommand}\\\" /> \\n    </Entry.Behaviors> \\n  \", \"  ... \\n</Entry>  \\nThe Entry control binds to the UserName.Value property of the ValidatableObject<T>\", \" instance, \\nand the control's Behaviors collection has an EventToCommandBehavior instance added to i\", \"t. This \\nbehavior executes the ValidateUserNameCommand in response to the TextChanged event firing o\", \"n \\nthe Entry, which is raised when the text in the Entry changes. In turn, the \\nValidateUserNameComm\", \"and delegate executes the ValidateUserName method, which executes the \\nValidate method on the Valida\", \"tableObject<T> instance. Therefore, every time the user enters a \\ncharacter in the Entry control for\", \" the username, validation of the entered data is performed. \\nFor more information about behaviors, s\", \"ee Implementing behaviors. \\nDisplaying validation errors \\nThe eShopOnContainers mobile app notifies \", \"the user of any validation errors by highlighting the \\ncontrol that contains the invalid data with a\", \" red line, and by displaying an error message that informs \\nthe user why the data is invalid below t\", \"he control containing the invalid data. When the invalid data is \\ncorrected, the line changes to bla\", \"ck and the error message is removed. Figure 6-2 shows the \\nLoginView in the eShopOnContainers mobile\", \" app when validation errors are present. \\n41 \\nCHAPTER 6  |  Validation \\n \\nFigure 6-2: Displaying val\", \"idation errors during login \\nHighlighting a control that contains invalid data \\nThe LineColorBehavio\", \"r attached behavior is used to highlight Entry controls where validation \\nerrors have occurred. The \", \"following code example shows how the LineColorBehavior attached \\nbehavior is attached to an Entry co\", \"ntrol: \\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\"> \\n    <Entry.Style> \\n        <OnPlatform\", \" x:TypeArguments=\\\"Style\\\" \\n          iOS=\\\"{StaticResource EntryStyle}\\\" \\n          Android=\\\"{StaticRes\", \"ource EntryStyle}\\\" \\n          WinPhone=\\\"{StaticResource UwpEntryStyle}\\\"/> \\n    </Entry.Style> \\n    .\", \".. \\n</Entry> \\nThe Entry control consumes an explicit style, which is shown in the following code exa\", \"mple: \\n<Style x:Key=\\\"EntryStyle\\\" \\n       TargetType=\\\"{x:Type Entry}\\\"> \\n    ... \\n    <Setter Property\", \"=\\\"behaviors:LineColorBehavior.ApplyLineColor\\\" \\n            Value=\\\"True\\\" /> \\n    <Setter Property=\\\"be\", \"haviors:LineColorBehavior.LineColor\\\" \\n            Value=\\\"{StaticResource BlackColor}\\\" /> \\n    ... \\n<\", \"/Style>  \\nThis style sets the ApplyLineColor and LineColor attached properties of the LineColorBehav\", \"ior \\nattached behavior on the Entry control. For more information about styles, see Styles on the Xa\", \"marin \\nDeveloper Center. \\nWhen the value of the ApplyLineColor attached property is set, or changes,\", \" the LineColorBehavior \\nattached behavior executes the OnApplyLineColorChanged method, which is show\", \"n in the following \\ncode example:  \\n \\n \\n42 \\nCHAPTER 6  |  Validation \\n \\npublic static class LineColo\", \"rBehavior \\n{ \\n    ... \\n    private static void OnApplyLineColorChanged( \\n                BindableObj\", \"ect bindable, object oldValue, object newValue) \\n    { \\n        var view = bindable as View; \\n      \", \"  if (view == null) \\n        { \\n            return; \\n        } \\n \\n        bool hasLine = (bool)newVa\", \"lue; \\n        if (hasLine) \\n        { \\n            view.Effects.Add(new EntryLineColorEffect()); \\n  \", \"      } \\n        else \\n        { \\n            var entryLineColorEffectToRemove =  \\n                 \", \"   view.Effects.FirstOrDefault(e => e is EntryLineColorEffect); \\n            if (entryLineColorEffec\", \"tToRemove != null) \\n            { \\n                view.Effects.Remove(entryLineColorEffectToRemove)\", \"; \\n            } \\n        } \\n    } \\n} \\nThe parameters for this method provide the instance of the co\", \"ntrol that the behavior is attached to, \\nand the old and new values of the ApplyLineColor attached p\", \"roperty. The EntryLineColorEffect \\nclass is added to the control's Effects collection if the ApplyLi\", \"neColor attached property is true, \\notherwise it's removed from the control's Effects collection. Fo\", \"r more information about behaviors, \\nsee Implementing behaviors. \\nThe EntryLineColorEffect subclasse\", \"s the RoutingEffect class, and is shown in the following code \\nexample: \\npublic class EntryLineColor\", \"Effect : RoutingEffect \\n{ \\n    public EntryLineColorEffect() : base(\\\"eShopOnContainers.EntryLineColo\", \"rEffect\\\") \\n    { \\n    } \\n} \\nThe RoutingEffect class represents a platform-independent effect that wr\", \"aps an inner effect that's \\nplatform-specific. This simplifies the effect removal process, since the\", \"re is no compile-time access to \\nthe type information for a platform-specific effect. The EntryLineC\", \"olorEffect calls the base class \\nconstructor, passing in a parameter consisting of a concatenation o\", \"f the resolution group name, and \\nthe unique ID that's specified on each platform-specific effect cl\", \"ass.  \\nThe following code example shows the eShopOnContainers.EntryLineColorEffect implementation fo\", \"r \\niOS: \\n[assembly: ResolutionGroupName(\\\"eShopOnContainers\\\")] \\n[assembly: ExportEffect(typeof(EntryL\", \"ineColorEffect), \\\"EntryLineColorEffect\\\")] \\nnamespace eShopOnContainers.iOS.Effects \\n{ \\n    public cl\", \"ass EntryLineColorEffect : PlatformEffect \\n43 \\nCHAPTER 6  |  Validation \\n \\n    { \\n        UITextFiel\", \"d control; \\n \\n        protected override void OnAttached() \\n        { \\n            try \\n            \", \"{ \\n                control = Control as UITextField; \\n                UpdateLineColor(); \\n          \", \"  } \\n            catch (Exception ex) \\n            { \\n                Console.WriteLine(\\\"Can't set p\", \"roperty on attached control. Error: \\\", ex.Message); \\n            } \\n        } \\n \\n        protected o\", \"verride void OnDetached() \\n        { \\n            control = null; \\n        } \\n \\n        protected ov\", \"erride void OnElementPropertyChanged(PropertyChangedEventArgs args) \\n        { \\n            base.OnE\", \"lementPropertyChanged(args); \\n \\n            if (args.PropertyName == LineColorBehavior.LineColorProp\", \"erty.PropertyName || \\n                args.PropertyName == \\\"Height\\\") \\n            { \\n               \", \" Initialize(); \\n                UpdateLineColor(); \\n            } \\n        } \\n \\n        private void\", \" Initialize() \\n        { \\n            var entry = Element as Entry; \\n            if (entry != null) \", \"\\n            { \\n                Control.Bounds = new CGRect(0, 0, entry.Width, entry.Height); \\n     \", \"       } \\n        } \\n \\n        private void UpdateLineColor() \\n        { \\n            BorderLineLaye\", \"r lineLayer = control.Layer.Sublayers.OfType<BorderLineLayer>() \\n                                   \", \"                          .FirstOrDefault(); \\n \\n            if (lineLayer == null) \\n            { \\n \", \"               lineLayer = new BorderLineLayer(); \\n                lineLayer.MasksToBounds = true; \\n\", \"                lineLayer.BorderWidth = 1.0f; \\n                control.Layer.AddSublayer(lineLayer);\", \" \\n                control.BorderStyle = UITextBorderStyle.None; \\n            } \\n \\n            lineLa\", \"yer.Frame = new CGRect(0f, Control.Frame.Height-1f, Control.Bounds.Width, 1f); \\n            lineLaye\", \"r.BorderColor = LineColorBehavior.GetLineColor(Element).ToCGColor(); \\n            control.TintColor \", \"= control.TextColor; \\n        } \\n \\n        private class BorderLineLayer : CALayer \\n        { \\n     \", \"   } \\n44 \\nCHAPTER 6  |  Validation \\n \\n    } \\n} \\nThe OnAttached method retrieves the native control f\", \"or the Xamarin.Forms Entry control, and \\nupdates the line color by calling the UpdateLineColor metho\", \"d. The OnElementPropertyChanged \\noverride responds to bindable property changes on the Entry control\", \" by updating the line color if the \\nattached LineColor property changes, or the Height property of t\", \"he Entry changes. For more \\ninformation about effects, see Effects on the Xamarin Developer Center. \", \"\\nWhen valid data is entered in the Entry control, it will apply a black line to the bottom of the co\", \"ntrol, \\nto indicate that there is no validation error. Figure 6-3 shows an example of this. \\nFigure \", \"6-3: Black line indicating no validation error \\nThe Entry control also has a DataTrigger added to it\", \"s Triggers collection. The following code \\nexample shows the DataTrigger: \\n<Entry Text=\\\"{Binding Use\", \"rName.Value, Mode=TwoWay}\\\"> \\n    ... \\n    <Entry.Triggers> \\n        <DataTrigger  \\n            Targe\", \"tType=\\\"Entry\\\" \\n            Binding=\\\"{Binding UserName.IsValid}\\\" \\n            Value=\\\"False\\\"> \\n       \", \"     <Setter Property=\\\"behaviors:LineColorBehavior.LineColor\\\"  \\n                    Value=\\\"{StaticRe\", \"source ErrorColor}\\\" /> \\n        </DataTrigger> \\n    </Entry.Triggers> \\n</Entry> \\nThis DataTrigger mo\", \"nitors the UserName.IsValid property, and if it's value becomes false, it \\nexecutes the Setter, whic\", \"h changes the LineColor attached property of the LineColorBehavior \\nattached behavior to red. Figure\", \" 6-4 shows an example of this. \\nFigure 6-4: Red line indicating validation error \\nThe line in the En\", \"try control will remain red while the entered data is invalid, otherwise it will change \\nto black to\", \" indicate that the entered data is valid. \\nFor more information about Triggers, see Triggers on the \", \"Xamarin Developer Center. \\nDisplaying error messages \\nThe UI displays validation error messages in L\", \"abel controls below each control whose data failed \\nvalidation. The following code example shows the\", \" Label that displays a validation error message if \\nthe user has not entered a valid username: \\n45 \\n\", \"CHAPTER 6  |  Validation \\n \\n<Label Text=\\\"{Binding UserName.Errors, Converter={StaticResource FirstVa\", \"lidationErrorConverter}\\\" \\n       Style=\\\"{StaticResource ValidationErrorLabelStyle}\\\" />  \\nEach Label \", \"binds to the Errors property of the view model object that's being validated. The Errors \\nproperty i\", \"s provided by the ValidatableObject<T> class, and is of type List<string>. Because the \\nErrors prope\", \"rty can contain multiple validation errors, the FirstValidationErrorConverter \\ninstance is used to r\", \"etrieve the first error from the collection for display. \\nSummary \\nThe eShopOnContainers mobile app \", \"performs synchronous client-side validation of view model \\nproperties and notifies the user of any v\", \"alidation errors by highlighting the control that contains the \\ninvalid data, and by displaying erro\", \"r messages that inform the user why the data is invalid.  \\nView model properties that require valida\", \"tion are of type ValidatableObject<T>, and each \\nValidatableObject<T> instance has validation rules \", \"added to its Validations property. Validation \\nis invoked from the view model by calling the Validat\", \"e method of the ValidatableObject<T> \\ninstance, which retrieves the validation rules and executes th\", \"em against the ValidatableObject<T> \\nValue property. Any validation errors are placed into the Error\", \"s property of the \\nValidatableObject<T> instance, and the IsValid property of the ValidatableObject<\", \"T> instance \\nis updated to indicate whether validation succeeded or failed. \\n \\n \\n \\n46 \\nCHAPTER 7  | \", \" Configuration management \\n \\n \\n \\nCHAP TER  7 \\nConfiguration \\nmanagement \\nSettings allow the separati\", \"on of data that configures the behavior of an app from the code, allowing \\nthe behavior to be change\", \"d without rebuilding the app. There are two types of settings: app settings, \\nand user settings. \\nAp\", \"p settings are data that an app creates and manages. It can include data such as fixed web service \\n\", \"endpoints, API keys, and runtime state. App settings are tied to the existence of the app and are on\", \"ly \\nmeaningful to that app. \\nUser settings are the customizable settings of an app that affect the b\", \"ehavior of the app and don't \\nrequire frequent re-adjustment. For example, an app might let the user\", \" specify where to retrieve data \\nfrom, and how to display it on the screen. \\nXamarin.Forms includes \", \"a persistent dictionary that can be used to store settings data. This dictionary \\ncan be accessed us\", \"ing the Application.Current.Properties property, and any data that's placed \\ninto it is saved when t\", \"he app goes into a sleep state, and is restored when the app resumes or starts \\nup again. In additio\", \"n, the Application class also has a SavePropertiesAsync method that allows an \\napp to have its setti\", \"ngs saved when required. For more information about this dictionary, see \\nProperties Dictionary on t\", \"he Xamarin Developer Center. \\nA downside to storing data using the Xamarin.Forms persistent dictiona\", \"ry is that it's not easily data \\nbound to. Therefore, the eShopOnContainers mobile app uses the Xam.\", \"Plugins.Settings library, \\navailable from NuGet. This library provides a consistent, type-safe, cros\", \"s-platform approach for \\npersisting and retrieving app and user settings, while using the native set\", \"tings management provided \\nby each platform. In addition, it's straightforward to use data binding t\", \"o access settings data exposed \\nby the library. \\nNote: While the Xam.Plugin.Settings library can sto\", \"re both app and user settings, it makes no \\ndistinction between the two. \\nCreating a settings class \", \"\\nWhen using the Xam.Plugins.Settings library, a single static class should be created that will cont\", \"ain \\nthe app and user settings required by the app. The following code example shows the Settings cl\", \"ass \\nin the eShopOnContainers mobile app: \\n \\n47 \\nCHAPTER 7  |  Configuration management \\n \\npublic st\", \"atic class Settings \\n{ \\n    private static ISettings AppSettings \\n    { \\n        get \\n        { \\n   \", \"         return CrossSettings.Current; \\n        } \\n    } \\n    ... \\n}  \\nSettings can be read and writ\", \"ten through the ISettings API, which is provided by the \\nXam.Plugins.Settings library. This library \", \"provides a singleton that can be used to access the API, \\nCrossSettings.Current, and an app's settin\", \"gs class should expose this singleton via an ISettings \\nproperty. \\nNote: Using directives for the Pl\", \"ugin.Settings and Plugin.Settings.Abstractions \\nnamespaces should be added to a class that requires \", \"access to the Xam.Plugins.Settings library \\ntypes. \\nAdding a setting \\nEach setting consists of a key\", \", a default value, and a property. The following code example shows all \\nthree items for a user sett\", \"ing that represents the base URL for the online services that the \\neShopOnContainers mobile app conn\", \"ects to: \\npublic static class Settings \\n{ \\n    ... \\n    private const string IdUrlBase = \\\"url_base\\\";\", \" \\n    private static readonly string UrlBaseDefault = GlobalSetting.Instance.BaseEndpoint; \\n    ... \", \"\\n \\n    public static string UrlBase \\n    { \\n        get \\n        { \\n            return AppSettings.G\", \"etValueOrDefault<string>(IdUrlBase, UrlBaseDefault); \\n        } \\n        set \\n        { \\n           \", \" AppSettings.AddOrUpdateValue<string>(IdUrlBase, value); \\n        } \\n    } \\n} \\nThe key is always a c\", \"onst string that defines the key name, with the default value for the setting \\nbeing a static readon\", \"ly value of the required type. Providing a default value ensures that a valid \\nvalue is available if\", \" an unset setting is retrieved. \\nThe UrlBase static property uses two methods from the ISettings API\", \" to read or write the setting \\nvalue. The ISettings.GetValueOrDefault method is used to retrieve a s\", \"etting's value from \\nplatform-specific storage. If no value is defined for the setting, its default \", \"value is retrieved instead. \\nSimilarly, the ISettings.AddOrUpdateValue method is used to persist a s\", \"etting's value to platform-\\nspecific storage. \\n48 \\nCHAPTER 7  |  Configuration management \\n \\nRather \", \"that define a default value inside the Settings class, the UrlBaseDefault string obtains its \\nvalue \", \"from the GlobalSetting class. The following code example shows the BaseEndpoint property \\nand Update\", \"Endpoint method in this class: \\npublic class GlobalSetting \\n{ \\n    ... \\n    public string BaseEndpoi\", \"nt \\n    { \\n        get { return _baseEndpoint; } \\n        set \\n        { \\n            _baseEndpoint \", \"= value; \\n            UpdateEndpoint(_baseEndpoint); \\n        } \\n    } \\n    ... \\n \\n    private void \", \"UpdateEndpoint(string baseEndpoint) \\n    { \\n        RegisterWebsite = string.Format(\\\"{0}:5105/Accoun\", \"t/Register\\\", baseEndpoint); \\n        CatalogEndpoint = string.Format(\\\"{0}:5101\\\", baseEndpoint); \\n   \", \"     OrdersEndpoint = string.Format(\\\"{0}:5102\\\", baseEndpoint); \\n        BasketEndpoint = string.Form\", \"at(\\\"{0}:5103\\\", baseEndpoint); \\n        IdentityEndpoint = string.Format(\\\"{0}:5105/connect/authorize\\\"\", \", baseEndpoint); \\n        UserInfoEndpoint = string.Format(\\\"{0}:5105/connect/userinfo\\\", baseEndpoint\", \"); \\n        TokenEndpoint = string.Format(\\\"{0}:5105/connect/token\\\", baseEndpoint); \\n        LogoutEn\", \"dpoint = string.Format(\\\"{0}:5105/connect/endsession\\\", baseEndpoint); \\n        IdentityCallback = str\", \"ing.Format(\\\"{0}:5105/xamarincallback\\\", baseEndpoint); \\n        LogoutCallback = string.Format(\\\"{0}:5\", \"105/Account/Redirecting\\\", baseEndpoint);  \\n    } \\n}  \\nEach time the BaseEndpoint property is set, th\", \"e UpdateEndpoint method is called. This method \\nupdates a series of properties, all of which are bas\", \"ed on the UrlBase user setting that's provided by \\nthe Settings class that represent different endpo\", \"ints that the eShopOnContainers mobile app \\nconnects to. \\nData binding to user settings \\nIn the eSho\", \"pOnContainers mobile app, the SettingsView exposes two user settings. These settings \\nallow configur\", \"ation of whether the app should retrieve data from microservices that are deployed as \\nDocker contai\", \"ners, or whether the app should retrieve data from mock services that don't require an \\ninternet con\", \"nection. When choosing to retrieve data from containerized microservices, a base \\nendpoint URL for t\", \"he microservices must be specified. Figure 7-1 shows the SettingsView when the \\nuser has chosen to r\", \"etrieve data from containerized microservices. \\n49 \\nCHAPTER 7  |  Configuration management \\n \\n \\n \\n \\n\", \" \\n \\n \\n \\n \\n \\nFigure 7-1: User settings exposed by the eShopOnContainers mobile app \\nData binding can \", \"be used to retrieve and set settings exposed by the Settings class. This is achieved \\nby controls on\", \" the view binding to view model properties that in turn access properties in the \\nSettings class, an\", \"d raising a property changed notification if the settings value has changed. For \\ninformation about \", \"how the eShopOnContainers mobile app constructs view models and associates \\nthem to views, see Autom\", \"atically creating a view model with a view model locator. \\nThe following code example shows the Entr\", \"y control from the SettingsView that allows the user to \\nenter a base endpoint URL for the container\", \"ized microservices: \\n<Entry Text=\\\"{Binding Endpoint, Mode=TwoWay}\\\" />  \\nThis Entry control binds to \", \"the Endpoint property of the SettingsViewModel class, using a two-way \\nbinding. The following code e\", \"xample shows the Endpoint property: \\npublic string Endpoint \\n{ \\n    get { return _endpoint; } \\n    s\", \"et \\n    { \\n        _endpoint = value; \\n \\n        if(!string.IsNullOrEmpty(_endpoint)) \\n        { \\n  \", \"          UpdateEndpoint(_endpoint); \\n        } \\n \\n        RaisePropertyChanged(() => Endpoint); \\n  \", \"  } \\n} \\nWhen the Endpoint property is set the UpdateEndpoint method is called, provided that the sup\", \"plied \\nvalue is valid, and property changed notification is raised. The following code example shows\", \" the \\nUpdateEndpoint method: \\nprivate void UpdateEndpoint(string endpoint) \\n{ \\n    Settings.UrlBase \", \"= endpoint; \\n} \\n50 \\nCHAPTER 7  |  Configuration management \\n \\nThis method updates the UrlBase proper\", \"ty in the Settings class with the base endpoint URL value \\nentered by the user, which causes it to b\", \"e persisted to platform-specific storage. \\nWhen the SettingsView is navigated to, the InitializeAsyn\", \"c method in the SettingsViewModel \\nclass is executed. The following code example shows this method: \", \"\\npublic override Task InitializeAsync(object navigationData) \\n{ \\n    ... \\n    Endpoint = Settings.Ur\", \"lBase; \\n    ... \\n} \\nThe method sets the Endpoint property to the value of the UrlBase property in th\", \"e Settings class. \\nAccessing the UrlBase property causes the Xam.Plugins.Settings library to retriev\", \"e the settings value \\nfrom platform-specific storage. For information about how the InitializeAsync \", \"method is invoked, \\nsee Passing parameters during navigation. \\nThis mechanism ensures that whenever \", \"a user navigates to the SettingsView, user settings are \\nretrieved from platform-specific storage an\", \"d presented through data binding. Then, if the user \\nchanges the settings values, data binding ensur\", \"es that they are immediately persisted back to \\nplatform-specific storage. \\nSummary \\nSettings allow \", \"the separation of data that configures the behavior of an app from the code, allowing \\nthe behavior \", \"to be changed without rebuilding the app. App settings are data that an app creates and \\nmanages, an\", \"d user settings are the customizable settings of an app that affect the behavior of the app \\nand don\", \"'t require frequent re-adjustment. \\nThe Xam.Plugins.Settings library provides a consistent, type-saf\", \"e, cross-platform approach for \\npersisting and retrieving app and user settings, and data binding ca\", \"n be used to access settings \\ncreated with the library. \\n \\n \\n \\n51 \\nCHAPTER 8  |  Containerized micro\", \"services \\n \\n \\n \\nCHAP TER  8 \\nContainerized \\nmicroservices \\nDeveloping client-server applications has\", \" resulted in a focus on building tiered applications that use \\nspecific technologies in each tier. S\", \"uch applications are often referred to as monolithic applications, \\nand are packaged onto hardware p\", \"re-scaled for peak loads. The main drawbacks of this development \\napproach are the tight coupling be\", \"tween components within each tier, that individual components \\ncan't be easily scaled, and the cost \", \"of testing. A simple update can have unforeseen effects on the rest \\nof the tier, and so a change to\", \" an application component requires its entire tier to be retested and \\nredeployed. \\nParticularly con\", \"cerning in the age of the cloud, is that individual components can't be easily scaled. A \\nmonolithic\", \" application contains domain-specific functionality, and is typically divided by functional \\nlayers \", \"such as front end, business logic, and data storage. A monolithic application is scaled by \\ncloning \", \"the entire application onto multiple machines, as illustrated in Figure 8-1. \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n\", \"Figure 8-1: Monolithic application scaling approach \\n52 \\nCHAPTER 8  |  Containerized microservices \\n\", \" \\nMicroservices \\nMicroservices offer a different approach to application development and deployment,\", \" an approach \\nthat's suited to the agility, scale, and reliability requirements of modern cloud appl\", \"ications. A \\nmicroservices application is decomposed into independent components that work together \", \"to deliver \\nthe application's overall functionality. The term microservice emphasizes that applicati\", \"ons should be \\ncomposed of services small enough to reflect independent concerns, so that each micro\", \"service \\nimplements a single function. In addition, each microservice has well-defined contracts so \", \"that other \\nmicroservices can communicate and share data with it. Typical examples of microservices \", \"include \\nshopping carts, inventory processing, purchase subsystems, and payment processing. \\nMicrose\", \"rvices can scale-out independently, as compared to giant monolithic applications that scale \\ntogethe\", \"r. This means that a specific functional area, that requires more processing power or network \\nbandw\", \"idth to support demand, can be scaled rather than unnecessarily scaling-out other areas of the \\nappl\", \"ication. Figure 8-2 illustrates this approach, where microservices are deployed and scaled \\nindepend\", \"ently, creating instances of services across machines. \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\nFigure 8-2: Microservice\", \"s application scaling approach \\nMicroservice scale-out can be nearly instantaneous, allowing an appl\", \"ication to adapt to changing \\nloads. For example, a single microservice in the web-facing functional\", \"ity of an application might be \\nthe only microservice in the application that needs to scale out to \", \"handle additional incoming traffic. \\nThe classic model for application scalability is to have a load\", \"-balanced, stateless tier with a shared \\nexternal datastore to store persistent data. Stateful micro\", \"services manage their own persistent data, \\nusually storing it locally on the servers on which they \", \"are placed, to avoid the overhead of network \\naccess and complexity of cross-service operations. Thi\", \"s enables the fastest possible processing of data \\nand can eliminate the need for caching systems. I\", \"n addition, scalable stateful microservices usually \\npartition data among their instances, in order \", \"to manage data size and transfer throughput beyond \\nwhich a single server can support. \\nMicroservice\", \"s also support independent updates. This loose coupling between microservices provides \\na rapid and \", \"reliable application evolution. Their independent, distributed nature supports rolling \\nupdates, whe\", \"re only a subset of instances of a single microservice will update at any given time. \\nTherefore, if\", \" a problem is detected, a buggy update can be rolled back, before all instances update \\nwith the fau\", \"lty code or configuration. Similarly, microservices typically use schema versioning, so that \\n53 \\nCH\", \"APTER 8  |  Containerized microservices \\n \\nclients see a consistent version when updates are being a\", \"pplied, regardless of which microservice \\ninstance is being communicated with. \\nTherefore, microserv\", \"ice applications have many benefits over monolithic applications: \\n\\u2022 \\nEach microservice is relativel\", \"y small, easy to manage and evolve. \\n\\u2022 \\nEach microservice can be developed and deployed independentl\", \"y of other services. \\n\\u2022 \\nEach microservice can be scaled-out independently. For example, a catalog s\", \"ervice or \\nshopping basket service might need to be scaled-out more than an ordering service. \\nThere\", \"fore, the resulting infrastructure will more efficiently consume resources when scaling \\nout. \\n\\u2022 \\nEa\", \"ch microservice isolates any issues. For example, if there is an issue in a service it only \\nimpacts\", \" that service. The other services can continue to handle requests. \\n\\u2022 \\nEach microservice can use the\", \" latest technologies. Because microservices are autonomous and \\nrun side-by-side, the latest technol\", \"ogies and frameworks can be used, rather than being \\nforced to use an older framework that might be \", \"used by a monolithic application. \\nHowever, a microservice based solution also has potential drawbac\", \"ks: \\n\\u2022 \\nChoosing how to partition an application into microservices can be challenging, as each \\nmic\", \"roservice has to be completely autonomous, end-to-end, including responsibility for its \\ndata source\", \"s. \\n\\u2022 \\nDevelopers must implement inter-service communication, which adds complexity and latency \\nto \", \"the application. \\n\\u2022 \\nAtomic transactions between multiple microservices usually aren't possible. The\", \"refore, \\nbusiness requirements must embrace eventual consistency between microservices. \\n\\u2022 \\nIn produ\", \"ction, there is an operational complexity in deploying and managing a system \\ncompromised of many in\", \"dependent services. \\n\\u2022 \\nDirect client-to-microservice communication can make it difficult to refacto\", \"r the contracts of \\nmicroservices. For example, over time how the system is partitioned into service\", \"s might need \\nto change. A single service might split into two or more services, and two services mi\", \"ght \\nmerge. When clients communicate directly with microservices, this refactoring work can break \\nc\", \"ompatibility with client apps. \\nContainerization \\nContainerization is an approach to software develo\", \"pment in which an application and its versioned set \\nof dependencies, plus its environment configura\", \"tion abstracted as deployment manifest files, are \\npackaged together as a container image, tested as\", \" a unit, and deployed to a host operating system.  \\nA container is an isolated, resource controlled,\", \" and portable operating environment, where an \\napplication can run without touching the resources of\", \" other containers, or the host. Therefore, a \\ncontainer looks and acts like a newly installed physic\", \"al computer or a virtual machine. \\nThere are many similarities between containers and virtual machin\", \"es, as illustrated in Figure 8-3. \\n54 \\nCHAPTER 8  |  Containerized microservices \\n \\nFigure 8-3: Comp\", \"arison of virtual machines and containers \\nA container runs an operating system, has a file system, \", \"and can be accessed over a network as if it \\nwere a physical or virtual machine. However, the techno\", \"logy and concepts used by containers are very \\ndifferent from virtual machines. Virtual machines inc\", \"lude the applications, the required dependencies, \\nand a full guest operating system. Containers inc\", \"lude the application and its dependencies, but share \\nthe operating system with other containers, ru\", \"nning as isolated processes on the host operating \\nsystem (aside from Hyper-V containers which run i\", \"nside of a special virtual machine per container). \\nTherefore, containers share resources and typica\", \"lly require fewer resources than virtual machines. \\nThe advantage of a container-oriented developmen\", \"t and deployment approach is that it eliminates \\nmost of the issues that arise from inconsistent env\", \"ironment setups and the problems that come with \\nthem. In addition, containers permit fast applicati\", \"on scale-up functionality by instancing new \\ncontainers as required. \\nThe key concepts when creating\", \" and working with containers are: \\n\\u2022 \\nContainer Host: The physical or virtual machine configured to \", \"host containers. The container \\nhost will run one or more containers. \\n\\u2022 \\nContainer Image: An image \", \"consists of a union of layered filesystems stacked on top of each \\nother, and is the basis of a cont\", \"ainer. An image does not have state and it never changes as \\nit's deployed to different environments\", \". \\n\\u2022 \\nContainer: A container is a runtime instance of an image. \\n\\u2022 \\nContainer OS Image: Containers a\", \"re deployed from images. The container operating system \\nimage is the first layer in potentially man\", \"y image layers that make up a container. A container \\noperating system is immutable, and can't be mo\", \"dified. \\n\\u2022 \\nContainer Repository: Each time a container image is created, the image and its dependen\", \"cies \\nare stored in a local repository. These images can be reused many times on the container \\nhost\", \". The container images can also be stored in a public or private registry, such as Docker \\nHub, so t\", \"hat they can be used across different container hosts. \\n55 \\nCHAPTER 8  |  Containerized microservice\", \"s \\n \\nEnterprises are increasingly adopting containers when implementing microservice based applicati\", \"ons, \\nand Docker has become the standard container implementation that has been adopted by most \\nsof\", \"tware platforms and cloud vendors. \\nThe eShopOnContainers reference application uses Docker to host \", \"four containerized back-end \\nmicroservices, as illustrated in Figure 8-4. \\n \\nFigure 8-4: eShopOnCont\", \"ainers reference application back-end microservices \\nThe architecture of the back-end services in th\", \"e reference application is decomposed into multiple \\nautonomous sub-systems in the form of collabora\", \"ting microservices and containers. Each microservice \\nprovides a single area of functionality: an id\", \"entity service, a catalog service, an ordering service, and a \\nbasket service. \\nEach microservice ha\", \"s its own database, allowing it to be fully decoupled from the other \\nmicroservices. Where necessary\", \", consistency between databases from different microservices is \\nachieved using application-level ev\", \"ents. For more information, see Communication between \\nmicroservices. \\nFor more information about th\", \"e reference application, see .NET Microservices: Architecture for \\nContainerized .NET Applications. \", \"\\nCommunication between client and microservices \\nThe eShopOnContainers mobile app communicates with \", \"the containerized back-end microservices \\nusing direct client-to-microservice communication, which i\", \"s shown in Figure 8-5. \\n56 \\nCHAPTER 8  |  Containerized microservices \\n \\n \\nFigure 8-5: Direct client\", \"-to-microservice communication \\nWith direct client-to-microservice communication, the mobile app mak\", \"es requests to each \\nmicroservice directly through its public endpoint, with a different TCP port pe\", \"r microservice. In \\nproduction, the endpoint would typically map to the microservice's load balancer\", \", which distributes \\nrequests across the available instances. \\nTip: Consider using API gateway commu\", \"nication \\nDirect client-to-microservice communication can have drawbacks when building a large and \\n\", \"complex microservice based application, but it's more than adequate for a small application. When \\nd\", \"esigning a large microservice based application with tens of microservices, consider using API \\ngate\", \"way communication. For more information, see .NET Microservices: Architecture for \\nContainerized .NE\", \"T Applications. \\nCommunication between microservices \\nA microservices based application is a distrib\", \"uted system, potentially running on multiple machines. \\nEach service instance is typically a process\", \". Therefore, services must interact using an inter-process \\ncommunication protocol, such as HTTP, TC\", \"P, Advanced Message Queuing Protocol (AMQP), or binary \\nprotocols, depending on the nature of each s\", \"ervice. \\nThe two common approaches for microservice-to-microservice communication are HTTP based RES\", \"T \\ncommunication when querying for data, and lightweight asynchronous messaging when \\ncommunicating \", \"updates across multiple microservices. \\nAsynchronous messaging based event-driven communication is c\", \"ritical when propagating changes \\nacross multiple microservices. With this approach, a microservice \", \"publishes an event when something \\nnotable happens, for example, when it updates a business entity. \", \"Other microservices subscribe to \\nthese events. Then, when a microservice receives an event, it upda\", \"tes its own business entities, which \\nmight in turn lead to more events being published. This publis\", \"h-subscribe functionality is usually \\nachieved with an event bus. \\nAn event bus allows publish-subsc\", \"ribe communication between microservices, without requiring the \\ncomponents to be explicitly aware o\", \"f each other, as shown in Figure 8-6. \\n57 \\nCHAPTER 8  |  Containerized microservices \\n \\n \\nFigure 8-6\", \": Publish-subscribe with an event bus \\nFrom an application perspective, the event bus is simply a pu\", \"blish-subscribe channel exposed via an \\ninterface. However, the way the event bus is implemented can\", \" vary. For example, an event bus \\nimplementation could use RabbitMQ, Azure Service Bus, or other ser\", \"vice buses such as NServiceBus \\nand MassTransit. Figure 8-7 shows how an event bus is used in the eS\", \"hopOnContainers reference \\napplication. \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\nFigure 8-7: Asynchronous event-dr\", \"iven communication in the reference application \\nThe eShopOnContainers event bus, implemented using \", \"RabbitMQ, provides one-to-many \\nasynchronous publish-subscribe functionality. This means that after \", \"publishing an event, there can be \\nmultiple subscribers listening for the same event. Figure 8-9 ill\", \"ustrates this relationship. \\n58 \\nCHAPTER 8  |  Containerized microservices \\n \\nFigure 8-9: One-to-man\", \"y communication \\nThis one-to-many communication approach uses events to implement business transacti\", \"ons that span \\nmultiple services, ensuring eventual consistency between the services. An eventual-co\", \"nsistent \\ntransaction consists of a series of distributed steps. Therefore, when the user-profile mi\", \"croservice \\nreceives the UpdateUser command, it updates the user's details in its database and publi\", \"shes the \\nUserUpdated event to the event bus. Both the basket microservice and the ordering microser\", \"vice \\nhave subscribed to receive this event, and in response update their buyer information in their\", \" \\nrespective databases. \\nNote: The eShopOnContainers event bus, implemented using RabbitMQ, is inten\", \"ded to be used \\nonly as a proof of concept. For production systems, alternative event bus implementa\", \"tions should \\nbe considered. \\nFor information about the event bus implementation, see .NET Microserv\", \"ices: Architecture for \\nContainerized .NET Applications. \\nSummary \\nMicroservices offer an approach t\", \"o application development and deployment that's suited to the \\nagility, scale, and reliability requi\", \"rements of modern cloud applications. One of the main advantages \\nof microservices is that they can \", \"be scaled-out independently, which means that a specific functional \\narea can be scaled that require\", \"s more processing power or network bandwidth to support demand, \\nwithout unnecessarily scaling areas\", \" of the application that are not experiencing increased demand. \\nA container is an isolated, resourc\", \"e controlled, and portable operating environment, where an \\napplication can run without touching the\", \" resources of other containers, or the host. Enterprises are \\nincreasingly adopting containers when \", \"implementing microservice based applications, and Docker has \\nbecome the standard container implemen\", \"tation that has been adopted by most software platforms \\nand cloud vendors. \\n \\n \\n \\n59 \\nCHAPTER 9  | \", \" Authentication and authorization \\n \\n \\n \\nCHAP TER  9 \\nAuthentication \\nand authorization \\n \\nAuthentic\", \"ation is the process of obtaining identification credentials such as name and password from \\na user,\", \" and validating those credentials against an authority. If the credentials are valid, the entity tha\", \"t \\nsubmitted the credentials is considered an authenticated identity. Once an identity has been \\naut\", \"henticated, an authorization process determines whether that identity has access to a given \\nresourc\", \"e. \\nThere are many approaches to integrating authentication and authorization into a Xamarin.Forms a\", \"pp \\nthat communicates with an ASP.NET MVC web application, including using ASP.NET Core Identity, \\ne\", \"xternal authentication providers such as Microsoft, Google, Facebook, or Twitter, and authentication\", \" \\nmiddleware. The eShopOnContainers mobile app performs authentication and authorization with a \\ncon\", \"tainerized identity microservice that uses IdentityServer 4. The mobile app requests security tokens\", \" \\nfrom IdentityServer, either for authenticating a user or for accessing a resource. For IdentitySer\", \"ver to \\nissue tokens on behalf of a user, the user must sign-in to IdentityServer. However, Identity\", \"Server \\ndoesn't provide a user interface or database for authentication. Therefore, in the eShopOnCo\", \"ntainers \\nreference application, ASP.NET Core Identity is used for this purpose.  \\nAuthentication \\nA\", \"uthentication is required when an application needs to know the identity of the current user. \\nASP.N\", \"ET Core's primary mechanism for identifying users is the ASP.NET Core Identity membership \\nsystem, w\", \"hich stores user information in a data store configured by the developer. Typically, this data \\nstor\", \"e will be an EntityFramework store, though custom stores or third party packages can be used to \\nsto\", \"re identity information in Azure storage, DocumentDB, or other locations. \\nFor authentication scenar\", \"ios that make use of a local user data store, and that persist identity \\ninformation between request\", \"s via cookies (as is typical in ASP.NET MVC web applications), ASP.NET \\nCore Identity is a suitable \", \"solution. However, cookies are not always a natural means of persisting and \\ntransmitting data. For \", \"example, an ASP.NET Core web application that exposes RESTful endpoints that \\nare accessed from a mo\", \"bile app will typically need to use bearer token authentication, since cookies \\ncan't be used in thi\", \"s scenario. However, bearer tokens can easily be retrieved and included in the \\nauthorization header\", \" of web requests made from the mobile app. \\n60 \\nCHAPTER 9  |  Authentication and authorization \\n \\nIs\", \"suing bearer tokens using IdentityServer 4 \\nIdentityServer 4 is an open source OpenID Connect and OA\", \"uth 2.0 framework for ASP.NET Core, \\nwhich can be used for many authentication and authorization sce\", \"narios including issuing security \\ntokens for local ASP.NET Core Identity users. \\nNote: OpenID Conne\", \"ct and OAuth 2.0 are very similar, while having different responsibilities. \\nOpenID Connect is an au\", \"thentication layer on top of the OAuth 2.0 protocol. OAuth 2 is a protocol \\nthat allows applications\", \" to request access tokens from a security token service and use them to \\ncommunicate with APIs. This\", \" delegation reduces complexity in both client applications and APIs \\nsince authentication and author\", \"ization can be centralized. \\nThe combination of OpenID Connect and OAuth 2.0 combine the two fundame\", \"ntal security \\nconcerns of authentication and API access, and IdentityServer 4 is an implementation \", \"of these \\nprotocols. \\nIn applications that use direct client-to-microservice communication, such as \", \"the eShopOnContainers \\nreference application, a dedicated authentication microservice acting as a Se\", \"curity Token Service (STS) \\ncan be used to authenticate users, as shown in Figure 9-1. For more info\", \"rmation about direct client-\\nto-microservice communication, see Communication between client and mic\", \"roservices. \\nFigure 9-1: Authentication by a dedicated authentication microservice \\nThe eShopOnConta\", \"iners mobile app communicates with the identity microservice, which uses \\nIdentityServer 4 to perfor\", \"m authentication, and access control for APIs. Therefore, the mobile app \\nrequests tokens from Ident\", \"ityServer, either for authenticating a user or for accessing a resource: \\n\\u2022 \\nAuthenticating users wi\", \"th IdentityServer is achieved by the mobile app requesting an identity \\ntoken, which represents the \", \"outcome of an authentication process. At a bare minimum, it \\ncontains an identifier for the user, an\", \"d information about how and when the user \\nauthenticated. It can also contain additional identity da\", \"ta. \\n\\u2022 \\nAccessing a resource with IdentityServer is achieved by the mobile app requesting an access \", \"\\ntoken, which allows access to an API resource. Clients request access tokens and forward \\nthem to t\", \"he API. Access tokens contain information about the client, and the user (if present). \\nAPIs then us\", \"e that information to authorize access to their data. \\nNote: A client must be registered with Identi\", \"tyServer before it can request tokens. \\nAdding IdentityServer to a web application \\nIn order for an \", \"ASP.NET Core web application to use IdentityServer 4, it must be added to the web \\napplication's Vis\", \"ual Studio solution. For more information, see Setup and Overview in the \\nIdentityServer documentati\", \"on. \\n \\n61 \\nCHAPTER 9  |  Authentication and authorization \\n \\nOnce IdentityServer is included in the \", \"web application's Visual Studio solution, it must be added to \\nthe web application's HTTP request pr\", \"ocessing pipeline, so that it can serve requests to OpenID \\nConnect and OAuth 2.0 endpoints. This is\", \" achieved in the Configure method in the web application's \\nStartup class, as demonstrated in the fo\", \"llowing code example: \\npublic void Configure( \\n    IApplicationBuilder app, IHostingEnvironment env,\", \" ILoggerFactory loggerFactory) \\n{ \\n    ... \\n    app.UseIdentity(); \\n    ... \\n}  \\nOrder matters in th\", \"e web application's HTTP request processing pipeline. Therefore, IdentityServer \\nmust be added to th\", \"e pipeline before the UI framework that implements the login screen. \\nConfiguring IdentityServer \\nId\", \"entityServer should be configured in the ConfigureServices method in the web application's \\nStartup \", \"class by calling the services.AddIdentityServer method, as demonstrated in the \\nfollowing code examp\", \"le from the eShopOnContainers reference application: \\npublic void ConfigureServices(IServiceCollecti\", \"on services) \\n{ \\n    ... \\n    services.AddIdentityServer(x => x.IssuerUri = \\\"null\\\") \\n        .AddSig\", \"ningCredential(Certificate.Get())                \\n        .AddAspNetIdentity<ApplicationUser>() \\n   \", \"     .AddConfigurationStore(builder => \\n            builder.UseSqlServer(connectionString, options =\", \"> \\n                options.MigrationsAssembly(migrationsAssembly))) \\n        .AddOperationalStore(bu\", \"ilder => \\n            builder.UseSqlServer(connectionString, options => \\n                options.Mig\", \"rationsAssembly(migrationsAssembly))) \\n        .Services.AddTransient<IProfileService, ProfileServic\", \"e>(); \\n}  \\nAfter calling the services.AddIdentityServer method, additional fluent APIs are called to\", \" \\nconfigure the following: \\n\\u2022 \\nCredentials used for signing. \\n\\u2022 \\nAPI and identity resources that use\", \"rs might request access to. \\n\\u2022 \\nClients that will be connecting to request tokens. \\n\\u2022 \\nASP.NET Core \", \"Identity. \\nTip: Dynamically load the IdentityServer 4 configuration \\nIdentityServer 4's APIs allow f\", \"or configuring IdentityServer from an in-memory list of configuration \\nobjects. In the eShopOnContai\", \"ners reference application, these in-memory collections are hard-\\ncoded into the application. Howeve\", \"r, in production scenarios they can be loaded dynamically from \\na configuration file or from a datab\", \"ase. \\nFor information about configuring IdentityServer to use ASP.NET Core Identity, see Using ASP.N\", \"ET \\nCore Identity in the IdentityServer documentation. \\n62 \\nCHAPTER 9  |  Authentication and authori\", \"zation \\n \\nConfiguring API resources \\nWhen configuring API resources, the AddInMemoryApiResources met\", \"hod expects an \\nIEnumerable<ApiResource> collection. The following code example shows the GetApis me\", \"thod that \\nprovides this collection in the eShopOnContainers reference application: \\npublic static I\", \"Enumerable<ApiResource> GetApis() \\n{ \\n    return new List<ApiResource> \\n    { \\n        new ApiResour\", \"ce(\\\"orders\\\", \\\"Orders Service\\\"), \\n        new ApiResource(\\\"basket\\\", \\\"Basket Service\\\") \\n    }; \\n}  \\nTh\", \"is method specifies that IdentityServer should protect the orders and basket APIs. Therefore, \\nIdent\", \"ityServer managed access tokens will be required when making calls to these APIs. For more \\ninformat\", \"ion about the ApiResource type, see API Resource in the IdentityServer 4 documentation. \\nConfiguring\", \" identity resources \\nWhen configuring identity resources, the AddInMemoryIdentityResources method ex\", \"pects an \\nIEnumerable<IdentityResource> collection. Identity resources are data such as user ID, nam\", \"e, or \\nemail address. Each identity resource has a unique name, and arbitrary claim types can be ass\", \"igned to \\nit, which will then be included in the identity token for the user. The following code exa\", \"mple shows \\nthe GetResources method that provides this collection in the eShopOnContainers reference\", \" \\napplication: \\npublic static IEnumerable<IdentityResource> GetResources() \\n{ \\n    return new List<I\", \"dentityResource> \\n    { \\n        new IdentityResources.OpenId(), \\n        new IdentityResources.Prof\", \"ile() \\n    }; \\n}  \\nThe OpenID Connect specification specifies some standard identity resources. The \", \"minimum \\nrequirement is that support is provided for emitting a unique ID for users. This is achieve\", \"d by \\nexposing the IdentityResources.OpenId identity resource. \\nNote: The IdentityResources class su\", \"pports all of the scopes defined in the OpenID Connect \\nspecification (openid, email, profile, telep\", \"hone, and address). \\nIdentityServer also supports defining custom identity resources. For more infor\", \"mation, see Defining \\ncustom identity resources in the IdentityServer documentation. For more inform\", \"ation about the \\nIdentityResource type, see Identity Resource in the IdentityServer 4 documentation.\", \" \\nConfiguring clients \\nClients are applications that can request tokens from IdentityServer. Typical\", \"ly, the following settings \\nmust be defined for each client as a minimum: \\n\\u2022 \\nA unique client ID. \\n\\u2022\", \" \\nThe allowed interactions with the token service (known as the grant type). \\n\\u2022 \\nThe location where \", \"identity and access tokens are sent to (known as a redirect URI). \\n63 \\nCHAPTER 9  |  Authentication \", \"and authorization \\n \\n\\u2022 \\nA list of resources that the client is allowed access to (known as scopes). \", \"\\nWhen configuring clients, the AddInMemoryClients method expects an IEnumerable<Client> \\ncollection.\", \" The following code example shows the configuration for the eShopOnContainers mobile \\napp in the Get\", \"Clients method that provides this collection in the eShopOnContainers reference \\napplication: \\npubli\", \"c static IEnumerable<Client> GetClients(Dictionary<string,string> clientsUrl) \\n{ \\n    return new Lis\", \"t<Client> \\n    { \\n        ... \\n        new Client \\n        { \\n            ClientId = \\\"xamarin\\\", \\n   \", \"         ClientName = \\\"eShop Xamarin OpenId Client\\\", \\n            AllowedGrantTypes = GrantTypes.Hyb\", \"rid, \\n            ClientSecrets = \\n            { \\n                new Secret(\\\"secret\\\".Sha256()) \\n   \", \"         }, \\n            RedirectUris = { clientsUrl[\\\"Xamarin\\\"] }, \\n            RequireConsent = fal\", \"se, \\n            RequirePkce = true, \\n            PostLogoutRedirectUris = { $\\\"{clientsUrl[\\\"Xamarin\\\"\", \"]}/Account/Redirecting\\\" }, \\n            AllowedCorsOrigins = { \\\"http://eshopxamarin\\\" }, \\n           \", \" AllowedScopes = new List<string> \\n            { \\n                IdentityServerConstants.StandardSc\", \"opes.OpenId, \\n                IdentityServerConstants.StandardScopes.Profile, \\n                Ident\", \"ityServerConstants.StandardScopes.OfflineAccess, \\n                \\\"orders\\\", \\n                \\\"basket\", \"\\\" \\n            },  \\n            AllowOfflineAccess = true, \\n            AllowAccessTokensViaBrowser \", \"= true \\n        }, \\n        ... \\n    }; \\n}  \\nThis configuration specifies data for the following pro\", \"perties: \\n\\u2022 \\nClientId: A unique ID for the client. \\n\\u2022 \\nClientName: The client display name, which is\", \" used for logging and the consent screen. \\n\\u2022 \\nAllowedGrantTypes: Specifies how a client wants to int\", \"eract with IdentityServer. For more \\ninformation see Configuring the authentication flow. \\n\\u2022 \\nClient\", \"Secrets: Specifies the client secret credentials that are used when requesting tokens \\nfrom the toke\", \"n endpoint. \\n\\u2022 \\nRedirectUris: Specifies the allowed URIs to which to return tokens or authorization \", \"codes. \\n\\u2022 \\nRequireConsent: Specifies whether a consent screen is required. \\n\\u2022 \\nRequirePkce: Specifie\", \"s whether clients using an authorization code must send a proof key. \\n\\u2022 \\nPostLogoutRedirectUris: Spe\", \"cifies the allowed URIs to redirect to after logout. \\n64 \\nCHAPTER 9  |  Authentication and authoriza\", \"tion \\n \\n\\u2022 \\nAllowedCorsOrigins: Specifies the origin of the client so that IdentityServer can allow c\", \"ross-\\norigin calls from the origin. \\n\\u2022 \\nAllowedScopes: Specifies the resources the client has access\", \" to. By default, a client has no \\naccess to any resources. \\n\\u2022 \\nAllowOfflineAccess: Specifies whether\", \" the client can request refresh tokens. \\nConfiguring the authentication flow \\nThe authentication flo\", \"w between a client and IdentityServer can be configured by specifying the grant \\ntypes in the Client\", \".AllowedGrantTypes property. The OpenID Connect and OAuth 2.0 specifications \\ndefine a number of aut\", \"hentication flows, including: \\n\\u2022 \\nImplicit. This flow is optimized for browser-based applications an\", \"d should be used either for \\nuser authentication-only, or authentication and access token requests. \", \"All tokens are \\ntransmitted via the browser, and therefore advanced features like refresh tokens are\", \" not \\npermitted.  \\n\\u2022 \\nAuthorization code. This flow provides the ability to retrieve tokens on a bac\", \"k channel, as \\nopposed to the browser front channel, while also supporting client authentication. \\n\\u2022\", \" \\nHybrid. This flow is a combination of the implicit and authorization code grant types. The \\nidenti\", \"ty token is transmitted via the browser channel and contains the signed protocol \\nresponse along wit\", \"h other artifacts such as the authorization code. After successful validation \\nof the response, the \", \"back channel should be used to retrieve the access and refresh token. \\nTip: Use the hybrid authentic\", \"ation flow \\nThe hybrid authentication flow mitigates a number of attacks that apply to the browser c\", \"hannel, \\nand is the recommended flow for native applications that want to retrieve access tokens (an\", \"d \\npossibly refresh tokens). \\nFor more information about authentication flows, see Grant Types in th\", \"e IdentityServer 4 \\ndocumentation. \\nPerforming authentication \\nFor IdentityServer to issue tokens on\", \" behalf of a user, the user must sign-in to IdentityServer. \\nHowever, IdentityServer doesn't provide\", \" a user interface or database for authentication. Therefore, in \\nthe eShopOnContainers reference app\", \"lication, ASP.NET Core Identity is used for this purpose. \\nThe eShopOnContainers mobile app authenti\", \"cates with IdentityServer with the hybrid authentication \\nflow, which is illustrated in Figure 9-2. \", \"\\nFigure 9-2: High-level overview of the sign-in process \\n65 \\nCHAPTER 9  |  Authentication and author\", \"ization \\n \\nA sign-in request is made to <base endpoint>:5105/connect/authorize. Following successful\", \" \\nauthentication, IdentityServer returns an authentication response containing an authorization code\", \" \\nand an identity token. The authorization code is then sent to <base \\nendpoint>:5105/connect/token,\", \" which responds with access, identity, and refresh tokens. \\nThe eShopOnContainers mobile app signs-o\", \"ut of IdentityServer by sending a request to \\nhttp://<base endpoint>:5105/connect/endsession, with a\", \"dditional parameters. After sign-out \\noccurs, IdentityServer responds by sending a post logout redir\", \"ect URI back to the mobile app. Figure \\n9-3 illustrates this process. \\nFigure 9-3: High-level overvi\", \"ew of the sign-out process \\nIn the eShopOnContainers mobile app, communication with IdentityServer i\", \"s performed by the \\nIdentityService class, which implements the IIdentityService interface. This int\", \"erface specifies \\nthat the implementing class must provide CreateAuthorizationRequest, CreateLogoutR\", \"equest, \\nand GetTokenAsync methods. \\nSigning-in \\nWhen the user taps the LOGIN button on the LoginVie\", \"w, the SignInCommand in the LoginViewModel \\nclass is executed, which in turn executes the SignInAsyn\", \"c method. The following code example \\nshows this method: \\nprivate async Task SignInAsync() \\n{ \\n    .\", \".. \\n    LoginUrl = _identityService.CreateAuthorizationRequest(); \\n    IsLogin = true; \\n    ... \\n}  \", \"\\nThis method invokes the CreateAuthorizationRequest method in the IdentityService class, \\nwhich is s\", \"hown in the following code example: \\npublic string CreateAuthorizationRequest() \\n{ \\n    // Create UR\", \"I to authorization endpoint \\n    var authorizeRequest = new AuthorizeRequest(GlobalSetting.Instance.\", \"IdentityEndpoint); \\n \\n    // Dictionary with values for the authorize request \\n    var dic = new Dic\", \"tionary<string, string>(); \\n    dic.Add(\\\"client_id\\\", GlobalSetting.Instance.ClientId); \\n    dic.Add(\", \"\\\"client_secret\\\", GlobalSetting.Instance.ClientSecret);  \\n    dic.Add(\\\"response_type\\\", \\\"code id_token\", \"\\\"); \\n    dic.Add(\\\"scope\\\", \\\"openid profile basket orders locations marketing offline_access\\\"); \\n    d\", \"ic.Add(\\\"redirect_uri\\\", GlobalSetting.Instance.IdentityCallback); \\n    dic.Add(\\\"nonce\\\", Guid.NewGuid(\", \").ToString(\\\"N\\\")); \\n    dic.Add(\\\"code_challenge\\\", CreateCodeChallenge()); \\n    dic.Add(\\\"code_challeng\", \"e_method\\\", \\\"S256\\\"); \\n \\n66 \\nCHAPTER 9  |  Authentication and authorization \\n \\n    // Add CSRF token t\", \"o protect against cross-site request forgery attacks. \\n    var currentCSRFToken = Guid.NewGuid().ToS\", \"tring(\\\"N\\\"); \\n    dic.Add(\\\"state\\\", currentCSRFToken); \\n \\n    var authorizeUri = authorizeRequest.Crea\", \"te(dic);  \\n    return authorizeUri; \\n} \\nThis method creates the URI for IdentityServer's authorizati\", \"on endpoint, with the required parameters. \\nThe authorization endpoint is at /connect/authorize on p\", \"ort 5105 of the base endpoint exposed as \\na user setting. For more information about user settings, \", \"see Configuration management. \\nNote: The attack surface of the eShopOnContainers mobile app is reduc\", \"ed by implementing the \\nProof Key for Code Exchange (PKCE) extension to OAuth. PKCE protects the aut\", \"horization code \\nfrom being used if it\\u2019s intercepted. This is achieved by the client generating a se\", \"cret verifier, a hash \\nof which is passed in the authorization request, and which is presented unhas\", \"hed when redeeming \\nthe authorization code. For more information about PKCE, see Proof Key for Code \", \"Exchange by \\nOAuth Public Clients on the Internet Engineering Task Force web site. \\nThe returned URI\", \" is stored in the LoginUrl property of the LoginViewModel class. When the IsLogin \\nproperty becomes \", \"true, the WebView in the LoginView becomes visible. The WebView data binds its \\nSource property to t\", \"he LoginUrl property of the LoginViewModel class, and so makes a sign-in \\nrequest to IdentityServer \", \"when the LoginUrl property is set to IdentityServer's authorization \\nendpoint. When IdentityServer r\", \"eceives this request and the user isn't authenticated, the WebView will \\nbe redirected to the config\", \"ured login page, which is shown in Figure 9-4. \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\nFigure 9-4: Login page dis\", \"played by the WebView \\nOnce login is completed, the WebView will be redirected to a return URI. This\", \" WebView navigation will \\ncause the NavigateAsync method in the LoginViewModel class to be executed,\", \" which is shown in \\nthe following code example: \\n67 \\nCHAPTER 9  |  Authentication and authorization \", \"\\n \\nprivate async Task NavigateAsync(string url) \\n{ \\n    ... \\n    var authResponse = new AuthorizeRes\", \"ponse(url); \\n    if (!string.IsNullOrWhiteSpace(authResponse.Code)) \\n    { \\n        var userToken = \", \"await _identityService.GetTokenAsync(authResponse.Code); \\n        string accessToken = userToken.Acc\", \"essToken; \\n \\n        if (!string.IsNullOrWhiteSpace(accessToken)) \\n        { \\n            Settings.A\", \"uthAccessToken = accessToken; \\n            Settings.AuthIdToken = authResponse.IdentityToken; \\n \\n   \", \"         await NavigationService.NavigateToAsync<MainViewModel>(); \\n            await NavigationServ\", \"ice.RemoveLastFromBackStackAsync(); \\n        } \\n    } \\n    ... \\n} \\nThis method parses the authentica\", \"tion response that's contained in the return URI, and provided that \\na valid authorization code is p\", \"resent, it makes a request to IdentityServer's token endpoint, passing \\nthe authorization code, the \", \"PKCE secret verifier, and other required parameters. The token endpoint is \\nat /connect/token on por\", \"t 5105 of the base endpoint exposed as a user setting. For more \\ninformation about user settings, se\", \"e Configuration management. \\nTip: Validate return URIs \\nAlthough the eShopOnContainers mobile app do\", \"esn't validate the return URI, the best practice is to \\nvalidate that the return URI refers to a kno\", \"wn location in order to prevent open-redirect attacks. \\nIf the token endpoint receives a valid autho\", \"rization code and PKCE secret verifier, it responds with an \\naccess token, identity token, and refre\", \"sh token. The access token (which allows access to API \\nresources) and identity token are then store\", \"d as application settings, and page navigation is \\nperformed. Therefore, the overall effect in the e\", \"ShopOnContainers mobile app is this: provided that \\nusers are able to successfully authenticate with\", \" IdentityServer, they are navigated to the MainView \\npage, which is a TabbedPage that displays the C\", \"atalogView as its selected tab. \\nFor information about page navigation, see Navigation. For informat\", \"ion about how WebView \\nnavigation causes a view model method to be executed, see Invoking navigation\", \" using behaviors. For \\ninformation about application settings, see Configuration management.  \\nNote:\", \" The eShopOnContainers also allows a mock sign-in when the app is configured to use mock \\nservices i\", \"n the SettingsView. In this mode, the app doesn't communicate with IdentityServer, \\ninstead allowing\", \" the user to sign-in using any credentials. \\nSigning-out \\nWhen the user taps the LOG OUT button in t\", \"he ProfileView, the LogoutCommand in the \\nProfileViewModel class is executed, which in turn executes\", \" the LogoutAsync method. This method \\nperforms page navigation to the LoginView page, passing a Logo\", \"utParameter instance set to true \\nas a parameter. For more information about passing parameters duri\", \"ng page navigation, see Passing \\nparameters during navigation. \\n68 \\nCHAPTER 9  |  Authentication and\", \" authorization \\n \\nWhen a view is created and navigated to, the InitializeAsync method of the view's \", \"associated \\nview model is executed, which then executes the Logout method of the LoginViewModel clas\", \"s, which \\nis shown in the following code example: \\nprivate void Logout() \\n{ \\n    var authIdToken = S\", \"ettings.AuthIdToken; \\n    var logoutRequest = _identityService.CreateLogoutRequest(authIdToken); \\n \\n\", \"    if (!string.IsNullOrEmpty(logoutRequest)) \\n    { \\n        // Logout \\n        LoginUrl = logoutRe\", \"quest; \\n    } \\n    ... \\n}  \\nThis method invokes the CreateLogoutRequest method in the IdentityServic\", \"e class, passing the \\nidentity token retrieved from application settings as a parameter. For more in\", \"formation about \\napplication settings, see Configuration management. The following code example show\", \"s the \\nCreateLogoutRequest method: \\npublic string CreateLogoutRequest(string token) \\n{ \\n    ... \\n   \", \" return string.Format(\\\"{0}?id_token_hint={1}&post_logout_redirect_uri={2}\\\",  \\n        GlobalSetting.\", \"Instance.LogoutEndpoint, \\n        token, \\n        GlobalSetting.Instance.LogoutCallback); \\n}  \\nThis \", \"method creates the URI to IdentityServer's end session endpoint, with the required parameters. \\nThe \", \"end session endpoint is at /connect/endsession on port 5105 of the base endpoint exposed as \\na user \", \"setting. For more information about user settings, see Configuration management. \\nThe returned URI i\", \"s stored in the LoginUrl property of the LoginViewModel class. While the IsLogin \\nproperty is true, \", \"the WebView in the LoginView is visible. The WebView data binds its Source property \\nto the LoginUrl\", \" property of the LoginViewModel class, and so makes a sign-out request to \\nIdentityServer when the L\", \"oginUrl property is set to IdentityServer's end session endpoint. When \\nIdentityServer receives this\", \" request, provided that the user is signed-in, sign-out occurs. \\nAuthentication is tracked with a co\", \"okie managed by the cookie authentication middleware from \\nASP.NET Core. Therefore, signing out of I\", \"dentityServer removes the authentication cookie and sends a \\npost logout redirect URI back to the cl\", \"ient. \\nIn the mobile app, the WebView will be redirected to the post logout redirect URI. This WebVi\", \"ew \\nnavigation will cause the NavigateAsync method in the LoginViewModel class to be executed, which\", \" \\nis shown in the following code example: \\nprivate async Task NavigateAsync(string url) \\n{ \\n    ... \", \"\\n    Settings.AuthAccessToken = string.Empty; \\n    Settings.AuthIdToken = string.Empty; \\n    IsLogin\", \" = false; \\n    LoginUrl = _identityService.CreateAuthorizationRequest(); \\n    ... \\n} \\n69 \\nCHAPTER 9 \", \" |  Authentication and authorization \\n \\nThis method clears both the identity token and the access to\", \"ken from application settings, and sets \\nthe IsLogin property to false, which causes the WebView on \", \"the LoginView page to become \\ninvisible. Finally, the LoginUrl property is set to the URI of Identit\", \"yServer's authorization endpoint, \\nwith the required parameters, in preparation for the next time th\", \"e user initiates a sign-in. \\nFor information about page navigation, see Navigation. For information \", \"about how WebView \\nnavigation causes a view model method to be executed, see Invoking navigation usi\", \"ng behaviors. For \\ninformation about application settings, see Configuration management. \\nNote: The \", \"eShopOnContainers also allows a mock sign-out when the app is configured to use \\nmock services in th\", \"e SettingsView. In this mode, the app doesn't communicate with \\nIdentityServer, and instead clears a\", \"ny stored tokens from application settings. \\nAuthorization \\nAfter authentication, ASP.NET Core web A\", \"PIs often need to authorize access, which allows a service to \\nmake APIs available to some authentic\", \"ated users, but not to all. \\nRestricting access to an ASP.NET Core MVC route can be achieved by appl\", \"ying an Authorize attribute \\nto a controller or action, which limits access to the controller or act\", \"ion to authenticated users, as \\nshown in the following code example: \\n[Authorize] \\npublic class Bask\", \"etController : Controller \\n{ \\n    ... \\n}  \\nIf an unauthorized user attempts to access a controller o\", \"r action that's marked with the Authorize \\nattribute, the MVC framework returns a 401 (unauthorized)\", \" HTTP status code. \\nNote: Parameters can be specified on the Authorize attribute to restrict an API \", \"to specific users. \\nFor more information, see Authorization on the Microsoft Documentation Center. \\n\", \"70 \\nCHAPTER 9  |  Authentication and authorization \\n \\nIdentityServer can be integrated into the auth\", \"orization workflow so that the access tokens it provides \\ncontrol authorization. This approach is sh\", \"own in Figure 9-5. \\nFigure 9-5: Authorization by access token \\nThe eShopOnContainers mobile app comm\", \"unicates with the identity microservice and requests an \\naccess token as part of the authentication \", \"process. The access token is then forwarded to the APIs \\nexposed by the ordering and basket microser\", \"vices as part of the access requests. Access tokens \\ncontain information about the client, and the u\", \"ser. APIs then use that information to authorize access \\nto their data. For information about how to\", \" configure IdentityServer to protect APIs, see Configuring \\nAPI resources. \\nConfiguring IdentityServ\", \"er to perform authorization \\nTo perform authorization with IdentityServer, its authorization middlew\", \"are must be added to the web \\napplication's HTTP request pipeline. The middleware is added in the Co\", \"nfigureAuth method in the \\nweb application's Startup class, which is invoked from the Configure meth\", \"od, and is demonstrated \\nin the following code example from the eShopOnContainers reference applicat\", \"ion: \\nprotected virtual void ConfigureAuth(IApplicationBuilder app) \\n{ \\n    var identityUrl = Config\", \"uration.GetValue<string>(\\\"IdentityUrl\\\"); \\n    app.UseIdentityServerAuthentication(new IdentityServer\", \"AuthenticationOptions \\n    { \\n        Authority = identityUrl.ToString(), \\n        ScopeName = \\\"bask\", \"et\\\", \\n        RequireHttpsMetadata = false \\n    }); \\n}   \\nThis method ensures that the API can only \", \"be accessed with a valid access token. The middleware \\nvalidates the incoming token to ensure that i\", \"t's sent from a trusted issuer, and validates that the token \\nis valid to be used with the API that \", \"receives it. Therefore, browsing to the ordering or basket \\ncontroller will return a 401 (unauthoriz\", \"ed) HTTP status code, indicating that an access token is \\nrequired. \\n71 \\nCHAPTER 9  |  Authenticatio\", \"n and authorization \\n \\nNote: IdentityServer's authorization middleware must be added to the web appl\", \"ication's HTTP \\nrequest pipeline before adding MVC with app.UseMvc() or app.UseMvcWithDefaultRoute()\", \". \\nMaking access requests to APIs \\nWhen making requests to the ordering and basket microservices, th\", \"e access token, obtained from \\nIdentityServer during the authentication process, must be included in\", \" the request, as shown in the \\nfollowing code example: \\nvar authToken = Settings.AuthAccessToken; \\nO\", \"rder = await _ordersService.GetOrderAsync(Convert.ToInt32(order.OrderNumber), authToken);  \\nThe acce\", \"ss token is stored as an application setting, and is retrieved from platform-specific storage \\nand i\", \"ncluded in the call to the GetOrderAsync method in the OrderService class.  \\nSimilarly, the access t\", \"oken must be included when sending data to an IdentityServer protected API, as \\nshown in the followi\", \"ng code example: \\nvar authToken = Settings.AuthAccessToken; \\nawait _basketService.UpdateBasketAsync(\", \"new CustomerBasket \\n{ \\n    BuyerId = userInfo.UserId,  \\n    Items = BasketItems.ToList() \\n}, authTok\", \"en);  \\nThe access token is retrieved from platform-specific storage and included in the call to the \", \"\\nUpdateBasketAsync method in the BasketService class. \\nThe RequestProvider class, in the eShopOnCont\", \"ainers mobile app, uses the HttpClient class to \\nmake requests to the RESTful APIs exposed by the eS\", \"hopOnContainers reference application. When \\nmaking requests to the ordering and basket APIs, which \", \"require authorization, a valid access token \\nmust be included with the request. This is achieved by \", \"adding the access token to the headers of the \\nHttpClient instance, as demonstrated in the following\", \" code example: \\nhttpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\\\"Bear\", \"er\\\", token);  \\nThe DefaultRequestHeaders property of the HttpClient class exposes the headers that a\", \"re sent \\nwith each request, and the access token is added to the Authorization header prefixed with \", \"the \\nstring Bearer. When the request is sent to a RESTful API, the value of the Authorization header\", \" is \\nextracted and validated to ensure that it's sent from a trusted issuer, and used to determine w\", \"hether \\nthe user has permission to invoke the API that receives it. \\nFor more information about how \", \"the eShopOnContainers mobile app makes web requests, see \\nAccessing remote data. \\nSummary \\nThere are\", \" many approaches to integrating authentication and authorization into a Xamarin.Forms app \\nthat comm\", \"unicates with an ASP.NET MVC web application. The eShopOnContainers mobile app \\nperforms authenticat\", \"ion and authorization with a containerized identity microservice that uses \\nIdentityServer 4. Identi\", \"tyServer is an open source OpenID Connect and OAuth 2.0 framework for \\nASP.NET Core that integrates \", \"with ASP.NET Core Identity to perform bearer token authentication. \\n72 \\nCHAPTER 9  |  Authentication\", \" and authorization \\n \\nThe mobile app requests security tokens from IdentityServer, either for authen\", \"ticating a user or for \\naccessing a resource. When accessing a resource, an access token must be inc\", \"luded in the request to \\nAPIs that require authorization. IdentityServer's middleware validates inco\", \"ming access tokens to \\nensure that they are sent from a trusted issuer, and that they are valid to b\", \"e used with the API that \\nreceives them.\\n \\n \\n \\n73 \\nCHAPTER 10  |  Accessing remote data \\n \\n \\n \\nCHAP \", \"TER  10 \\nAccessing remote \\ndata \\nMany modern web-based solutions make use of web services, hosted by\", \" web servers, to provide \\nfunctionality for remote client applications. The operations that a web se\", \"rvice exposes constitute a \\nweb API. \\nClient apps should be able to utilize the web API without know\", \"ing how the data or operations that the \\nAPI exposes are implemented. This requires that the API abi\", \"des by common standards that enable a \\nclient app and web service to agree on which data formats to \", \"use, and the structure of the data that is \\nexchanged between client apps and the web service. \\nIntr\", \"oduction to Representational State Transfer \\nRepresentational State Transfer (REST) is an architectu\", \"ral style for building distributed systems based \\non hypermedia. A primary advantage of the REST mod\", \"el is that it's based on open standards and \\ndoesn't bind the implementation of the model or the cli\", \"ent apps that access it to any specific \\nimplementation. Therefore, a REST web service could be impl\", \"emented using Microsoft ASP.NET Core \\nMVC, and client apps could be developing using any language an\", \"d toolset that can generate HTTP \\nrequests and parse HTTP responses. \\nThe REST model uses a navigati\", \"onal scheme to represent objects and services over a network, referred \\nto as resources. Systems tha\", \"t implement REST typically use the HTTP protocol to transmit requests to \\naccess these resources. In\", \" such systems, a client app submits a request in the form of a URI that \\nidentifies a resource, and \", \"an HTTP method (such as GET, POST, PUT, or DELETE) that indicates the \\noperation to be performed on \", \"that resource. The body of the HTTP request contains any data required \\nto perform the operation.  \\n\", \"Note: REST defines a stateless request model. Therefore, HTTP requests must be independent and \\nmigh\", \"t occur in any order. \\nThe response from a REST request makes use of standard HTTP status codes. For\", \" example, a request \\nthat returns valid data should include the HTTP response code 200 (OK), while a\", \" request that fails to \\nfind or delete a specified resource should return a response that includes t\", \"he HTTP status code 404 \\n(Not Found). \\nA RESTful web API exposes a set of connected resources, and p\", \"rovides the core operations that \\nenable an app to manipulate those resources and easily navigate be\", \"tween them. For this reason, the \\nURIs that constitute a typical RESTful web API are oriented toward\", \"s the data that it exposes, and use \\nthe facilities provided by HTTP to operate on this data. \\n74 \\nC\", \"HAPTER 10  |  Accessing remote data \\n \\nThe data included by a client app in an HTTP request, and the\", \" corresponding response messages from \\nthe web server, could be presented in a variety of formats, k\", \"nown as media types. When a client app \\nsends a request that returns data in the body of a message, \", \"it can specify the media types it can \\nhandle in the Accept header of the request. If the web server\", \" supports this media type, it can reply \\nwith a response that includes the Content-Type header that \", \"specifies the format of the data in the \\nbody of the message. It's then the responsibility of the cl\", \"ient app to parse the response message and \\ninterpret the results in the message body appropriately.\", \" \\nFor more information about REST, see API design and API implementation on Microsoft Docs. \\nConsumi\", \"ng RESTful APIs \\nThe eShopOnContainers mobile app uses the Model-View-ViewModel (MVVM) pattern, and \", \"the \\nmodel elements of the pattern represent the domain entities used in the app. The controller and\", \" \\nrepository classes in the eShopOnContainers reference application accept and return many of these \", \"\\nmodel objects. Therefore, they are used as data transfer objects (DTOs) that hold all the data that\", \" is \\npassed between the mobile app and the containerized microservices. The main benefit of using DT\", \"Os \\nto pass data to and receive data from a web service is that by transmitting more data in a singl\", \"e \\nremote call, the app can reduce the number of remote calls that need to be made. \\nMaking web requ\", \"ests \\nThe eShopOnContainers mobile app uses the HttpClient class to make requests over HTTP, with \\nJ\", \"SON being used as the media type. This class provides functionality for asynchronously sending HTTP \", \"\\nrequests and receiving HTTP responses from a URI identified resource. The HttpResponseMessage \\nclas\", \"s represents an HTTP response message received from a REST API after an HTTP request has been \\nmade.\", \" It contains information about the response, including the status code, headers, and any body. \\nThe \", \"HttpContent class represents the HTTP body and content headers, such as Content-Type and \\nContent-En\", \"coding. The content can be read using any of the ReadAs methods, such as \\nReadAsStringAsync and Read\", \"AsByteArrayAsync, depending on the format of the data. \\nMaking a GET request \\nThe CatalogService cla\", \"ss is used to manage the data retrieval process from the catalog \\nmicroservice. In the RegisterDepen\", \"dencies method in the ViewModelLocator class, the \\nCatalogService class is registered as a type mapp\", \"ing against the ICatalogService type with the \\nAutofac dependency injection container. Then, when an\", \" instance of the CatalogViewModel class is \\ncreated, its constructor accepts an ICatalogService type\", \", which Autofac resolves, returning an \\ninstance of the CatalogService class. For more information a\", \"bout dependency injection, see \\nIntroduction to dependency injection. \\nFigure 10-1 shows the interac\", \"tion of classes that read catalog data from the catalog microservice for \\ndisplaying by the CatalogV\", \"iew. \\n \\n75 \\nCHAPTER 10  |  Accessing remote data \\n \\n \\nFigure 10-1: Retrieving data from the catalog \", \"microservice \\nWhen the CatalogView is navigated to, the OnInitialize method in the CatalogViewModel \", \"class is \\ncalled. This method retrieves catalog data from the catalog microservice, as demonstrated \", \"in the \\nfollowing code example: \\npublic override async Task InitializeAsync(object navigationData) \\n\", \"{ \\n    ... \\n    Products = await _productsService.GetCatalogAsync(); \\n    ... \\n}  \\nThis method calls\", \" the GetCatalogAsync method of the CatalogService instance that was injected \\ninto the CatalogViewMo\", \"del by Autofac. The following code example shows the GetCatalogAsync \\nmethod: \\npublic async Task<Obs\", \"ervableCollection<CatalogItem>> GetCatalogAsync() \\n{ \\n    UriBuilder builder = new UriBuilder(Global\", \"Setting.Instance.CatalogEndpoint); \\n    builder.Path = \\\"api/v1/catalog/items\\\"; \\n    string uri = bui\", \"lder.ToString(); \\n \\n    CatalogRoot catalog = await _requestProvider.GetAsync<CatalogRoot>(uri); \\n  \", \"  ... \\n76 \\nCHAPTER 10  |  Accessing remote data \\n \\n    return catalog?.Data.ToObservableCollection()\", \";           \\n}  \\nThis method builds the URI that identifies the resource the request will be sent to\", \", and uses the \\nRequestProvider class to invoke the GET HTTP method on the resource, before returnin\", \"g the results \\nto the CatalogViewModel. The RequestProvider class contains functionality that submit\", \"s a request \\nin the form of a URI that identifies a resource, an HTTP method that indicates the oper\", \"ation to be \\nperformed on that resource, and a body that contains any data required to perform the o\", \"peration. For \\ninformation about how the RequestProvider class is injected into the CatalogService c\", \"lass, see \\nIntroduction to dependency injection. \\nThe following code example shows the GetAsync meth\", \"od in the RequestProvider class: \\npublic async Task<TResult> GetAsync<TResult>(string uri, string to\", \"ken = \\\"\\\") \\n{ \\n    HttpClient httpClient = CreateHttpClient(token); \\n    HttpResponseMessage response\", \" = await httpClient.GetAsync(uri); \\n \\n    await HandleResponse(response); \\n    string serialized = a\", \"wait response.Content.ReadAsStringAsync(); \\n \\n    TResult result = await Task.Run(() =>  \\n        Js\", \"onConvert.DeserializeObject<TResult>(serialized, _serializerSettings)); \\n \\n    return result; \\n} \\nTh\", \"is method calls the CreateHttpClient method, which returns an instance of the HttpClient class \\nwith\", \" the appropriate headers set. It then submits an asynchronous GET request to the resource \\nidentifie\", \"d by the URI, with the response being stored in the HttpResponseMessage instance. The \\nHandleRespons\", \"e method is then invoked, which throws an exception if the response doesn't include \\na success HTTP \", \"status code. Then the response is read as a string, converted from JSON to a \\nCatalogRoot object, an\", \"d returned to the CatalogService. \\nThe CreateHttpClient method is shown in the following code exampl\", \"e: \\nprivate HttpClient CreateHttpClient(string token = \\\"\\\") \\n{ \\n    var httpClient = new HttpClient()\", \"; \\n    httpClient.DefaultRequestHeaders.Accept.Add( \\n        new MediaTypeWithQualityHeaderValue(\\\"ap\", \"plication/json\\\")); \\n \\n    if (!string.IsNullOrEmpty(token)) \\n    { \\n        httpClient.DefaultReques\", \"tHeaders.Authorization =  \\n            new AuthenticationHeaderValue(\\\"Bearer\\\", token); \\n    } \\n    r\", \"eturn httpClient; \\n} \\nThis method creates a new instance of the HttpClient class, and sets the Accep\", \"t header of any \\nrequests made by the HttpClient instance to application/json, which indicates that \", \"it expects the \\ncontent of any response to be formatted using JSON. Then, if an access token was pas\", \"sed as an \\nargument to the CreateHttpClient method, it's added to the Authorization header of any \\nr\", \"equests made by the HttpClient instance, prefixed with the string Bearer. For more information \\nabou\", \"t authorization, see Authorization. \\n77 \\nCHAPTER 10  |  Accessing remote data \\n \\nWhen the GetAsync m\", \"ethod in the RequestProvider class calls HttpClient.GetAsync, the Items \\nmethod in the CatalogContro\", \"ller class in the Catalog.API project is invoked, which is shown in the \\nfollowing code example: \\n[H\", \"ttpGet] \\n[Route(\\\"[action]\\\")] \\npublic async Task<IActionResult> Items( \\n    [FromQuery]int pageSize =\", \" 10, [FromQuery]int pageIndex = 0) \\n{ \\n    var totalItems = await _catalogContext.CatalogItems \\n    \", \"    .LongCountAsync(); \\n \\n    var itemsOnPage = await _catalogContext.CatalogItems \\n        .OrderBy\", \"(c=>c.Name) \\n        .Skip(pageSize * pageIndex) \\n        .Take(pageSize) \\n        .ToListAsync(); \\n\", \" \\n    itemsOnPage = ComposePicUri(itemsOnPage); \\n    var model = new PaginatedItemsViewModel<Catalog\", \"Item>( \\n        pageIndex, pageSize, totalItems, itemsOnPage);            \\n \\n    return Ok(model); \\n\", \"} \\nThis method retrieves the catalog data from the SQL database using EntityFramework, and returns i\", \"t \\nas a response message that includes a success HTTP status code, and a collection of JSON formatte\", \"d \\nCatalogItem instances. \\nMaking a POST request \\nThe BasketService class is used to manage the data\", \" retrieval and update process with the basket \\nmicroservice. In the RegisterDependencies method in t\", \"he ViewModelLocator class, the \\nBasketService class is registered as a type mapping against the IBas\", \"ketService type with the \\nAutofac dependency injection container. Then, when an instance of the Bask\", \"etViewModel class is \\ncreated, its constructor accepts an IBasketService type, which Autofac resolve\", \"s, returning an \\ninstance of the BasketService class. For more information about dependency injectio\", \"n, see \\nIntroduction to dependency injection. \\nFigure 10-2 shows the interaction of classes that sen\", \"d the basket data displayed by the BasketView, \\nto the basket microservice. \\n78 \\nCHAPTER 10  |  Acce\", \"ssing remote data \\n \\n \\nFigure 10-2: Sending data to the basket microservice \\nWhen an item is added t\", \"o the shopping basket, the ReCalculateTotalAsync method in the \\nBasketViewModel class is called. Thi\", \"s method updates the total value of items in the basket, and \\nsends the basket data to the basket mi\", \"croservice, as demonstrated in the following code example: \\nprivate async Task ReCalculateTotalAsync\", \"() \\n{ \\n    ... \\n    await _basketService.UpdateBasketAsync(new CustomerBasket \\n    { \\n        BuyerI\", \"d = userInfo.UserId,  \\n        Items = BasketItems.ToList() \\n    }, authToken); \\n} \\nThis method call\", \"s the UpdateBasketAsync method of the BasketService instance that was injected \\ninto the BasketViewM\", \"odel by Autofac. The following method shows the UpdateBasketAsync \\nmethod: \\npublic async Task<Custom\", \"erBasket> UpdateBasketAsync(CustomerBasket customerBasket, string token) \\n{ \\n    UriBuilder builder \", \"= new UriBuilder(GlobalSetting.Instance.BasketEndpoint); \\n    string uri = builder.ToString(); \\n79 \\n\", \"CHAPTER 10  |  Accessing remote data \\n \\n    var result = await _requestProvider.PostAsync(uri, custo\", \"merBasket, token); \\n    return result; \\n} \\nThis method builds the URI that identifies the resource t\", \"he request will be sent to, and uses the \\nRequestProvider class to invoke the POST HTTP method on th\", \"e resource, before returning the \\nresults to the BasketViewModel. Note that an access token, obtaine\", \"d from IdentityServer during the \\nauthentication process, is required to authorize requests to the b\", \"asket microservice. For more \\ninformation about authorization, see Authorization. \\nThe following cod\", \"e example shows one of the PostAsync methods in the RequestProvider class: \\npublic async Task<TResul\", \"t> PostAsync<TResult>( \\n    string uri, TResult data, string token = \\\"\\\", string header = \\\"\\\") \\n{ \\n   \", \" HttpClient httpClient = CreateHttpClient(token); \\n    ... \\n    var content = new StringContent(Json\", \"Convert.SerializeObject(data)); \\n    content.Headers.ContentType = new MediaTypeHeaderValue(\\\"applica\", \"tion/json\\\"); \\n    HttpResponseMessage response = await httpClient.PostAsync(uri, content); \\n \\n    aw\", \"ait HandleResponse(response); \\n    string serialized = await response.Content.ReadAsStringAsync(); \\n\", \" \\n    TResult result = await Task.Run(() => \\n        JsonConvert.DeserializeObject<TResult>(serializ\", \"ed, _serializerSettings)); \\n \\n    return result; \\n} \\nThis method calls the CreateHttpClient method, \", \"which returns an instance of the HttpClient class \\nwith the appropriate headers set. It then submits\", \" an asynchronous POST request to the resource \\nidentified by the URI, with the serialized basket dat\", \"a being sent in JSON format, and the response \\nbeing stored in the HttpResponseMessage instance. The\", \" HandleResponse method is then invoked, \\nwhich throws an exception if the response doesn't include a\", \" success HTTP status code. Then, the \\nresponse is read as a string, converted from JSON to a Custome\", \"rBasket object, and returned to the \\nBasketService. For more information about the CreateHttpClient \", \"method, see Making a GET request. \\nWhen the PostAsync method in the RequestProvider class calls Http\", \"Client.PostAsync, the Post \\nmethod in the BasketController class in the Basket.API project is invoke\", \"d, which is shown in the \\nfollowing code example: \\n[HttpPost] \\npublic async Task<IActionResult> Post\", \"([FromBody]CustomerBasket value) \\n{ \\n    var basket = await _repository.UpdateBasketAsync(value); \\n \", \"   return Ok(basket); \\n}  \\nThis method uses an instance of the RedisBasketRepository class to persis\", \"t the basket data to the \\nRedis cache, and returns it as a response message that includes a success \", \"HTTP status code, and a \\nJSON formatted CustomerBasket instance. \\nMaking a DELETE request \\nFigure 10\", \"-3 shows the interactions of classes that delete basket data from the basket microservice, for \\nthe \", \"CheckoutView. \\n80 \\nCHAPTER 10  |  Accessing remote data \\n \\n \\nFigure 10-3: Deleting data from the bas\", \"ket microservice \\nWhen the checkout process is invoked, the CheckoutAsync method in the CheckoutView\", \"Model class \\nis called. This method creates a new order, before clearing the shopping basket, as dem\", \"onstrated in \\nthe following code example: \\nprivate async Task CheckoutAsync() \\n{ \\n    ... \\n    await\", \" _basketService.ClearBasketAsync(_shippingAddress.Id.ToString(), authToken); \\n    ... \\n} \\nThis metho\", \"d calls the ClearBasketAsync method of the BasketService instance that was injected \\ninto the Checko\", \"utViewModel by Autofac. The following method shows the ClearBasketAsync \\nmethod: \\npublic async Task \", \"ClearBasketAsync(string guidUser, string token) \\n{ \\n    UriBuilder builder = new UriBuilder(GlobalSe\", \"tting.Instance.BasketEndpoint); \\n    builder.Path = guidUser; \\n    string uri = builder.ToString(); \", \"\\n    await _requestProvider.DeleteAsync(uri, token); \\n} \\nThis method builds the URI that identifies \", \"the resource that the request will be sent to, and uses the \\nRequestProvider class to invoke the DEL\", \"ETE HTTP method on the resource. Note that an access \\ntoken, obtained from IdentityServer during the\", \" authentication process, is required to authorize \\nrequests to the basket microservice. For more inf\", \"ormation about authorization, see Authorization. \\nThe following code example shows the DeleteAsync m\", \"ethod in the RequestProvider class: \\n \\n81 \\nCHAPTER 10  |  Accessing remote data \\n \\npublic async Task\", \" DeleteAsync(string uri, string token = \\\"\\\") \\n{ \\n    HttpClient httpClient = CreateHttpClient(token);\", \" \\n    await httpClient.DeleteAsync(uri); \\n} \\nThis method calls the CreateHttpClient method, which re\", \"turns an instance of the HttpClient class \\nwith the appropriate headers set. It then submits an asyn\", \"chronous DELETE request to the resource \\nidentified by the URI. For more information about the Creat\", \"eHttpClient method, see Making a GET \\nrequest. \\nWhen the DeleteAsync method in the RequestProvider c\", \"lass calls HttpClient.DeleteAsync, the \\nDelete method in the BasketController class in the Basket.AP\", \"I project is invoked, which is shown \\nin the following code example: \\n[HttpDelete(\\\"{id}\\\")] \\npublic v\", \"oid Delete(string id) \\n{ \\n    _repository.DeleteBasketAsync(id); \\n} \\nThis method uses an instance of\", \" the RedisBasketRepository class to delete the basket data from \\nthe Redis cache. \\nCaching data \\nThe\", \" performance of an app can be improved by caching frequently accessed data to fast storage \\nthat's l\", \"ocated close to the app. If the fast storage is located closer to the app than the original source, \", \"\\nthen caching can significantly improve response times when retrieving data. \\nThe most common form o\", \"f caching is read-through caching, where an app retrieves data by \\nreferencing the cache. If the dat\", \"a isn't in the cache, it's retrieved from the data store and added to the \\ncache. Apps can implement\", \" read-through caching with the cache-aside pattern. This pattern \\ndetermines whether the item is cur\", \"rently in the cache. If the item isn't in the cache, it's read from the \\ndata store and added to the\", \" cache. For more information, see the Cache-Aside pattern on Microsoft \\nDocs. \\nTip: Cache data that'\", \"s read frequently and that changes infrequently \\nThis data can be added to the cache on demand the f\", \"irst time it is retrieved by an app. This means \\nthat the app needs to fetch the data only once from\", \" the data store, and that subsequent access can \\nbe satisfied by using the cache. \\nDistributed appli\", \"cations, such as the eShopOnContainers reference application, should provide either \\nor both of the \", \"following caches: \\n\\u2022 \\nA shared cache, which can be accessed by multiple processes or machines. \\n\\u2022 \\nA\", \" private cache, where data is held locally on the device running the app. \\nThe eShopOnContainers mob\", \"ile app uses a private cache, where data is held locally on the device \\nthat's running an instance o\", \"f the app. For information about the cache used by the \\neShopOnContainers reference application, see\", \" .NET Microservices: Architecture for Containerized .NET \\nApplications. \\n82 \\nCHAPTER 10  |  Accessin\", \"g remote data \\n \\nTip: Think of the cache as a transient data store that could disappear at any time \", \"\\nEnsure that data is maintained in the original data store as well as the cache. The chances of losi\", \"ng \\ndata are then minimized if the cache becomes unavailable. \\nManaging data expiration \\nIt's imprac\", \"tical to expect that cached data will always be consistent with the original data. Data in the \\norig\", \"inal data store might change after it's been cached, causing the cached data to become stale. \\nThere\", \"fore, apps should implement a strategy that helps to ensure that the data in the cache is as up-\\nto-\", \"date as possible, but can also detect and handle situations that arise when the data in the cache \\nh\", \"as become stale. Most caching mechanisms enable the cache to be configured to expire data, and \\nhenc\", \"e reduce the period for which data might be out of date. \\nTip: Set a default expiration time when co\", \"nfiguring a cache \\nMany caches implement expiration, which invalidates data and removes it from the \", \"cache if it's not \\naccessed for a specified period. However, care must be taken when choosing the ex\", \"piration period. \\nIf it's made too short, data will expire too quickly and the benefits of caching w\", \"ill be reduced. If it's \\nmade too long, the data risks becoming stale. Therefore, the expiration tim\", \"e should match the \\npattern of access for apps that use the data. \\nWhen cached data expires, it shou\", \"ld be removed from the cache, and the app must retrieve the data \\nfrom the original data store and p\", \"lace it back into the cache. \\nIt's also possible that a cache might fill up if data is allowed to re\", \"main for too long a period. Therefore, \\nrequests to add new items to the cache might be required to \", \"remove some items in a process known \\nas eviction. Caching services typically evict data on a least-\", \"recently-used basis. However, there are \\nother eviction policies, including most-recently-used, and \", \"first-in-first-out. For more information, see \\nCaching Guidance on Microsoft Docs. \\nCaching images \\n\", \"The eShopOnContainers mobile app consumes remote product images that benefit from being \\ncached. The\", \"se images are displayed by the Image control, and the CachedImage control provided by \\nthe FFImageLo\", \"ading library. \\nThe Xamarin.Forms Image control supports caching of downloaded images. Caching is en\", \"abled by \\ndefault, and will store the image locally for 24 hours. In addition, the expiration time c\", \"an be \\nconfigured with the CacheValidity property. For more information, see Downloaded Image Cachin\", \"g \\non the Xamarin Developer Center. \\nFFImageLoading's CachedImage control is a replacement for the X\", \"amarin.Forms Image control, \\nproviding additional properties that enable supplementary functionality\", \". Amongst this functionality, \\nthe control provides configurable caching, while supporting error and\", \" loading image placeholders. \\nThe following code example shows how the eShopOnContainers mobile app \", \"uses the CachedImage \\ncontrol in the ProductTemplate, which is the data template used by the ListVie\", \"w control in the \\nCatalogView: \\n<ffimageloading:CachedImage  \\n    Grid.Row=\\\"0\\\" \\n    Source=\\\"{Binding\", \" PictureUri}\\\"      \\n    Aspect=\\\"AspectFill\\\"> \\n    <ffimageloading:CachedImage.LoadingPlaceholder> \\n \", \"       <OnPlatform    \\n            x:TypeArguments=\\\"ImageSource\\\" \\n83 \\nCHAPTER 10  |  Accessing remot\", \"e data \\n \\n            iOS=\\\"default_product\\\" \\n            Android=\\\"default_product\\\" \\n            WinP\", \"hone=\\\"Assets/default_product.png\\\"/> \\n    </ffimageloading:CachedImage.LoadingPlaceholder> \\n    <ffim\", \"ageloading:CachedImage.ErrorPlaceholder> \\n        <OnPlatform    \\n            x:TypeArguments=\\\"Image\", \"Source\\\" \\n            iOS=\\\"noimage\\\" \\n            Android=\\\"noimage\\\" \\n            WinPhone=\\\"Assets/noim\", \"age.png\\\"/> \\n    </ffimageloading:CachedImage.ErrorPlaceholder> \\n</ffimageloading:CachedImage>  \\nThe \", \"CachedImage control sets the LoadingPlaceholder and ErrorPlaceholder properties to \\nplatform-specifi\", \"c images. The LoadingPlaceholder property specifies the image to be displayed \\nwhile the image speci\", \"fied by the Source property is retrieved, and the ErrorPlaceholder property \\nspecifies the image to \", \"be displayed if an error occurs when attempting to retrieve the image specified \\nby the Source prope\", \"rty. \\nAs the name implies, the CachedImage control caches remote images on the device for the time \\n\", \"specified by the value of the CacheDuration property. When this property value isn't explicitly set,\", \" the \\ndefault value of 30 days is applied. \\nIncreasing resilience \\nAll apps that communicate with re\", \"mote services and resources must be sensitive to transient faults. \\nTransient faults include the mom\", \"entary loss of network connectivity to services, the temporary \\nunavailability of a service, or time\", \"outs that arise when a service is busy. These faults are often self-\\ncorrecting, and if the action i\", \"s repeated after a suitable delay it's likely to succeed. \\nTransient faults can have a huge impact o\", \"n the perceived quality of an app, even if it has been \\nthoroughly tested under all foreseeable circ\", \"umstances. To ensure that an app that communicates with \\nremote services operates reliably, it must \", \"be able to do all of the following: \\n\\u2022 \\nDetect faults when they occur, and determine if the faults a\", \"re likely to be transient. \\n\\u2022 \\nRetry the operation if it determines that the fault is likely to be t\", \"ransient and keep track of the \\nnumber of times the operation was retried. \\n\\u2022 \\nUse an appropriate re\", \"try strategy, which specifies the number of retries, the delay between \\neach attempt, and the action\", \"s to take after a failed attempt.  \\nThis transient fault handling can be achieved by wrapping all at\", \"tempts to access a remote service in \\ncode that implements the retry pattern. \\nRetry pattern \\nIf an \", \"app detects a failure when it tries to send a request to a remote service, it can handle the failure\", \" \\nin any of the following ways: \\n\\u2022 \\nRetrying the operation. The app could retry the failing request \", \"immediately. \\n\\u2022 \\nRetrying the operation after a delay. The app should wait for a suitable amount of \", \"time before \\nretrying the request. \\n\\u2022 \\nCancelling the operation. The application should cancel the o\", \"peration and report an \\nexception. \\n84 \\nCHAPTER 10  |  Accessing remote data \\n \\nThe retry strategy s\", \"hould be tuned to match the business requirements of the app. For example, it's \\nimportant to optimi\", \"ze the retry count and retry interval to the operation being attempted. If the \\noperation is part of\", \" a user interaction, the retry interval should be short and only a few retries \\nattempted to avoid m\", \"aking users wait for a response. If the operation is part of a long running \\nworkflow, where cancell\", \"ing or restarting the workflow is expensive or time-consuming, it's appropriate \\nto wait longer betw\", \"een attempts and to retry more times. \\nNote: An aggressive retry strategy with minimal delay between\", \" attempts, and a large number of \\nretries, could degrade a remote service that's running close to or\", \" at capacity. In addition, such a \\nretry strategy could also affect the responsiveness of the app if\", \" it's continually trying to perform a \\nfailing operation. \\nIf a request still fails after a number o\", \"f retries, it's better for the app to prevent further requests going \\nto the same resource and to re\", \"port a failure. Then, after a set period, the app can make one or more \\nrequests to the resource to \", \"see if they're successful. For more information, see Circuit breaker pattern. \\nTip: Never implement \", \"an endless retry mechanism \\nUse a finite number of retries, or implement the Circuit Breaker pattern\", \" to allow a service to recover. \\nThe eShopOnContainers mobile app does not currently implement the r\", \"etry pattern when making \\nRESTful web requests. However, the CachedImage control, provided by the FF\", \"ImageLoading library \\nsupports transient fault handling by retrying image loading. If image loading \", \"fails, further attempts \\nwill be made. The number of attempts is specified by the RetryCount propert\", \"y, and retries will occur \\nafter a delay specified by the RetryDelay property. If these property val\", \"ues aren't explicitly set, their \\ndefault values are applied \\u2013 3 for the RetryCount property, and 25\", \"0ms for the RetryDelay property. \\nFor more information about the CachedImage control, see Caching im\", \"ages. \\nThe eShopOnContainers reference application does implement the retry pattern. For more \\ninfor\", \"mation, including a discussion of how to combine the retry pattern with the HttpClient class, \\nsee .\", \"NET Microservices: Architecture for Containerized .NET Applications. \\nFor more information about the\", \" retry pattern, see the Retry pattern on Microsoft Docs. \\nCircuit breaker pattern \\nIn some situation\", \"s, faults can occur due to anticipated events that take longer to fix. These faults can \\nrange from \", \"a partial loss of connectivity to the complete failure of a service. In these situations, it's \\npoin\", \"tless for an app to retry an operation that's unlikely to succeed, and instead should accept that \\nt\", \"he operation has failed and handle this failure accordingly. \\nThe circuit breaker pattern can preven\", \"t an app from repeatedly trying to execute an operation that's \\nlikely to fail, while also enabling \", \"the app to detect whether the fault has been resolved.  \\nNote: The purpose of the circuit breaker pa\", \"ttern is different from the retry pattern. The retry \\npattern enables an app to retry an operation i\", \"n the expectation that it'll succeed. The circuit breaker \\npattern prevents an app from performing a\", \"n operation that's likely to fail.  \\nA circuit breaker acts as a proxy for operations that might fai\", \"l. The proxy should monitor the number \\nof recent failures that have occurred, and use this informat\", \"ion to decide whether to allow the \\noperation to proceed, or to return an exception immediately. \\nTh\", \"e eShopOnContainers mobile app does not currently implement the circuit breaker pattern. \\nHowever, t\", \"he eShopOnContainers does. For more information, see .NET Microservices: Architecture \\nfor Container\", \"ized .NET Applications. \\n85 \\nCHAPTER 10  |  Accessing remote data \\n \\nTip: Combine the retry and circ\", \"uit breaker patterns \\nAn app can combine the retry and circuit breaker patterns by using the retry p\", \"attern to invoke an \\noperation through a circuit breaker. However, the retry logic should be sensiti\", \"ve to any exceptions \\nreturned by the circuit breaker and abandon retry attempts if the circuit brea\", \"ker indicates that a \\nfault is not transient. \\nFor more information about the circuit breaker patter\", \"n, see the Circuit Breaker pattern on Microsoft \\nDocs. \\nSummary \\nMany modern web-based solutions mak\", \"e use of web services, hosted by web servers, to provide \\nfunctionality for remote client applicatio\", \"ns. The operations that a web service exposes constitute a \\nweb API, and client apps should be able \", \"to utilize the web API without knowing how the data or \\noperations that the API exposes are implemen\", \"ted. \\nThe performance of an app can be improved by caching frequently accessed data to fast storage \", \"\\nthat's located close to the app. Apps can implement read-through caching with the cache-aside \\npatt\", \"ern. This pattern determines whether the item is currently in the cache. If the item isn't in the \\nc\", \"ache, it's read from the data store and added to the cache.  \\nWhen communicating with web APIs, apps\", \" must be sensitive to transient faults. Transient faults \\ninclude the momentary loss of network conn\", \"ectivity to services, the temporary unavailability of a \\nservice, or timeouts that arise when a serv\", \"ice is busy. These faults are often self-correcting, and if the \\naction is repeated after a suitable\", \" delay, then it's likely to succeed. Therefore, apps should wrap all \\nattempts to access a web API i\", \"n code that implements a transient fault handling mechanism. \\n \\n \\n \\n86 \\nCHAPTER 11  |  Unit testing \", \"\\n \\n \\n \\nCHAP TER  11 \\nUnit testing \\nMobile apps have unique problems that desktop and web-based appli\", \"cations don't have to worry \\nabout. Mobile users will differ by the devices that they use, by networ\", \"k connectivity, by the availability \\nof services, and a range of other factors. Therefore, mobile ap\", \"ps should be tested as they will be used \\nin the real world in order to improve their quality, relia\", \"bility, and performance. There are many types \\nof testing that should be performed on an app, includ\", \"ing unit testing, integration testing, and user \\ninterface testing, with unit testing being the most\", \" common form of testing. \\nA unit test takes a small unit of the app, typically a method, isolates it\", \" from the remainder of the code, \\nand verifies that it behaves as expected. Its goal is to check tha\", \"t each unit of functionality performs as \\nexpected, so that errors don't propagate throughout the ap\", \"p. Detecting a bug where it occurs is more \\nefficient that observing the effect of a bug indirectly \", \"at a secondary point of failure.  \\nUnit testing has the greatest effect on code quality when it's an\", \" integral part of the software \\ndevelopment workflow. As soon as a method has been written, unit tes\", \"ts should be written that verify \\nthe behavior of the method in response to standard, boundary, and \", \"incorrect cases of input data, and \\nthat check any explicit or implicit assumptions made by the code\", \". Alternatively, with test driven \\ndevelopment, unit tests are written before the code. In this scen\", \"ario, unit tests act as both design \\ndocumentation and functional specifications. \\nNote: Unit tests \", \"are very effective against regression \\u2013 that is, functionality that used to work but \\nhas been distu\", \"rbed by a faulty update. \\nUnit tests typically use the arrange-act-assert pattern: \\n\\u2022 \\nThe arrange s\", \"ection of the unit test method initializes objects and sets the value of the data \\nthat is passed to\", \" the method under test. \\n\\u2022 \\nThe act section invokes the method under test with the required argument\", \"s. \\n\\u2022 \\nThe assert section verifies that the action of the method under test behaves as expected. \\nFo\", \"llowing this pattern ensures that unit tests are readable and consistent. \\nDependency injection and \", \"unit testing \\nOne of the motivations for adopting a loosely-coupled architecture is that it facilita\", \"tes unit testing. \\nOne of the types registered with Autofac is the OrderService class. The following\", \" code example \\nshows an outline of this class: \\npublic class OrderDetailViewModel : ViewModelBase \\n{\", \" \\n    private IOrderService _ordersService; \\n \\n    public OrderDetailViewModel(IOrderService ordersS\", \"ervice) \\n87 \\nCHAPTER 11  |  Unit testing \\n \\n    { \\n        _ordersService = ordersService; \\n    } \\n \", \"   ... \\n}  \\nThe OrderDetailViewModel class has a dependency on the IOrderService type which the cont\", \"ainer \\nresolves when it instantiates a OrderDetailViewModel object. However, rather than create an \\n\", \"OrderService object to unit test the OrderDetailViewModel class, instead, replace the \\nOrderService \", \"object with a mock for the purpose of the tests. Figure 10-1 illustrates this relationship. \\n \\n \\n \\n \", \"\\n \\n \\n \\n \\n \\n \\n \\nFigure 10-1: Classes that implement the IOrderService interface \\nThis approach allows\", \" the OrderService object to be passed into the OrderDetailViewModel class at \\nruntime, and in the in\", \"terests of testability, it allows the OrderMockService class to be passed into the \\nOrderDetailViewM\", \"odel class at test time. The main advantage of this approach is that it enables unit \\ntests to be ex\", \"ecuted without requiring unwieldy resources such as web services, or databases. \\nTesting MVVM applic\", \"ations \\nTesting models and view models from MVVM applications is identical to testing any other clas\", \"ses, and \\nthe same tools and techniques \\u2013 such as unit testing and mocking, can be used. However, th\", \"ere are \\nsome patterns that are typical to model and view model classes, that can benefit from speci\", \"fic unit \\ntesting techniques. \\nTip: Test one thing with each unit test \\nDon't be tempted to make a u\", \"nit test exercise more than one aspect of the unit's behavior. Doing \\nso leads to tests that are dif\", \"ficult to read and update. It can also lead to confusion when \\ninterpreting a failure. \\nThe eShopOnC\", \"ontainers mobile app uses xUnit to perform unit testing, which supports two different \\ntypes of unit\", \" tests: \\n\\u2022 \\nFacts are tests that are always true, which test invariant conditions. \\n\\u2022 \\nTheories are \", \"tests that are only true for a particular set of data. \\n88 \\nCHAPTER 11  |  Unit testing \\n \\nThe unit \", \"tests included with the eShopOnContainers mobile app are fact tests, and so each unit test \\nmethod i\", \"s decorated with the [Fact] attribute. \\nNote: xUnit tests are executed by a test runner. To execute \", \"the test runner, run the \\neShopOnContainers.TestRunner project for the required platform. \\nTesting a\", \"synchronous functionality \\nWhen implementing the MVVM pattern, view models usually invoke operations\", \" on services, often \\nasynchronously. Tests for code that invokes these operations typically use mock\", \"s as replacements for \\nthe actual services. The following code example demonstrates testing asynchro\", \"nous functionality by \\npassing a mock service into a view model: \\n[Fact] \\npublic async Task OrderPro\", \"pertyIsNotNullAfterViewModelInitializationTest() \\n{ \\n    var orderService = new OrderMockService(); \", \"\\n    var orderViewModel = new OrderDetailViewModel(orderService); \\n \\n    var order = await orderServ\", \"ice.GetOrderAsync(1, GlobalSetting.Instance.AuthToken); \\n    await orderViewModel.InitializeAsync(or\", \"der); \\n \\n    Assert.NotNull(orderViewModel.Order); \\n}  \\nThis unit test checks that the Order propert\", \"y of the OrderDetailViewModel instance will have a value \\nafter the InitializeAsync method has been \", \"invoked. The InitializeAsync method is invoked \\nwhen the view model's corresponding view is navigate\", \"d to. For more information about navigation, \\nsee Navigation. \\nWhen the OrderDetailViewModel instanc\", \"e is created, it expects an OrderService instance to be \\nspecified as an argument. However, the Orde\", \"rService retrieves data from a web service. Therefore, \\nan OrderMockService instance, which is a moc\", \"k version of the OrderService class, is specified as the \\nargument to the OrderDetailViewModel const\", \"ructor. Then, when the view model's \\nInitializeAsync method is invoked, which invokes IOrderService \", \"operations, mock data is \\nretrieved rather than communicating with a web service. \\nTesting INotifyPr\", \"opertyChanged implementations \\nImplementing the INotifyPropertyChanged interface allows views to rea\", \"ct to changes that originate \\nfrom view models and models. These changes are not limited to data sho\", \"wn in controls \\u2013 they are \\nalso used to control the view, such as view model states that cause anima\", \"tions to be started or \\ncontrols to be disabled. \\nProperties that can be updated directly by the uni\", \"t test can be tested by attaching an event handler to \\nthe PropertyChanged event and checking whethe\", \"r the event is raised after setting a new value for the \\nproperty. The following code example shows \", \"such a test: \\n[Fact] \\npublic async Task SettingOrderPropertyShouldRaisePropertyChanged() \\n{ \\n    boo\", \"l invoked = false; \\n    var orderService = new OrderMockService(); \\n    var orderViewModel = new Ord\", \"erDetailViewModel(orderService); \\n \\n    orderViewModel.PropertyChanged += (sender, e) => \\n    { \\n89 \", \"\\nCHAPTER 11  |  Unit testing \\n \\n        if (e.PropertyName.Equals(\\\"Order\\\")) \\n            invoked = t\", \"rue; \\n    }; \\n    var order = await orderService.GetOrderAsync(1, GlobalSetting.Instance.AuthToken);\", \" \\n    await orderViewModel.InitializeAsync(order); \\n \\n    Assert.True(invoked); \\n} \\nThis unit test i\", \"nvokes the InitializeAsync method of the OrderViewModel class, which causes its \\nOrder property to b\", \"e updated. The unit test will pass, provided that the PropertyChanged event is \\nraised for the Order\", \" property. \\nTesting message-based communication \\nView models that use the MessagingCenter class to c\", \"ommunicate between loosely-coupled classes \\ncan be unit tested by subscribing to the message being s\", \"ent by the code under test, as demonstrated \\nin the following code example: \\n[Fact] \\npublic void Add\", \"CatalogItemCommandSendsAddProductMessageTest() \\n{ \\n    bool messageReceived = false; \\n    var catalo\", \"gService = new CatalogMockService(); \\n    var catalogViewModel = new CatalogViewModel(catalogService\", \"); \\n \\n    Xamarin.Forms.MessagingCenter.Subscribe<CatalogViewModel, CatalogItem>( \\n        this, Mes\", \"sageKeys.AddProduct, (sender, arg) => \\n    { \\n        messageReceived = true; \\n    }); \\n    catalogV\", \"iewModel.AddCatalogItemCommand.Execute(null); \\n \\n    Assert.True(messageReceived); \\n} \\nThis unit tes\", \"t checks that the CatalogViewModel publishes the AddProduct message in response to \\nits AddCatalogIt\", \"emCommand being executed. Because the MessagingCenter class supports multicast \\nmessage subscription\", \"s, the unit test can subscribe to the AddProduct message and execute a callback \\ndelegate in respons\", \"e to receiving it. This callback delegate, specified as a lambda expression, sets a \\nboolean field t\", \"hat's used by the Assert statement to verify the behavior of the test. \\nTesting exception handling \\n\", \"Unit tests can also be written that check that specific exceptions are thrown for invalid actions or\", \" \\ninputs, as demonstrated in the following code example: \\n[Fact] \\npublic void InvalidEventNameShould\", \"ThrowArgumentExceptionText() \\n{ \\n    var behavior = new MockEventToCommandBehavior \\n    { \\n        E\", \"ventName = \\\"OnItemTapped\\\" \\n    }; \\n    var listView = new ListView(); \\n \\n    Assert.Throws<ArgumentE\", \"xception>(() => listView.Behaviors.Add(behavior)); \\n}  \\n90 \\nCHAPTER 11  |  Unit testing \\n \\nThis unit\", \" test will throw an exception, because the ListView control does not have an event named \\nOnItemTapp\", \"ed. The Assert.Throws<T> method is a generic method where T is the type of the \\nexpected exception. \", \"The argument passed to the Assert.Throws<T> method is a lambda expression \\nthat will throw the excep\", \"tion. Therefore, the unit test will pass provided that the lambda expression \\nthrows an ArgumentExce\", \"ption. \\nTip: Avoid writing unit tests that examine exception message strings \\nException message stri\", \"ngs might change over time, and so unit tests that rely on their presence are \\nregarded as brittle. \", \"\\nTesting validation \\nThere are two aspects to testing the validation implementation: testing that an\", \"y validation rules are \\ncorrectly implemented, and testing that the ValidatableObject<T> class perfo\", \"rms as expected. \\nValidation logic is usually simple to test, because it is typically a self-contain\", \"ed process where the \\noutput depends on the input. There should be tests on the results of invoking \", \"the Validate method \\non each property that has at least one associated validation rule, as demonstra\", \"ted in the following \\ncode example: \\n[Fact] \\npublic void CheckValidationPassesWhenBothPropertiesHave\", \"DataTest() \\n{ \\n    var mockViewModel = new MockViewModel(); \\n    mockViewModel.Forename.Value = \\\"Joh\", \"n\\\"; \\n    mockViewModel.Surname.Value = \\\"Smith\\\"; \\n \\n    bool isValid = mockViewModel.Validate(); \\n \\n \", \"   Assert.True(isValid); \\n} \\nThis unit test checks that validation succeeds when the two Validatable\", \"Object<T> properties in the \\nMockViewModel instance both have data. \\nAs well as checking that valida\", \"tion succeeds, validation unit tests should also check the values of the \\nValue, IsValid, and Errors\", \" property of each ValidatableObject<T> instance, to verify that the \\nclass performs as expected. The\", \" following code example demonstrates a unit test that does this: \\n[Fact] \\npublic void CheckValidatio\", \"nFailsWhenOnlyForenameHasDataTest() \\n{ \\n    var mockViewModel = new MockViewModel(); \\n    mockViewMo\", \"del.Forename.Value = \\\"John\\\"; \\n \\n    bool isValid = mockViewModel.Validate(); \\n \\n    Assert.False(isV\", \"alid); \\n    Assert.NotNull(mockViewModel.Forename.Value); \\n    Assert.Null(mockViewModel.Surname.Val\", \"ue); \\n    Assert.True(mockViewModel.Forename.IsValid); \\n    Assert.False(mockViewModel.Surname.IsVal\", \"id); \\n    Assert.Empty(mockViewModel.Forename.Errors); \\n    Assert.NotEmpty(mockViewModel.Surname.Er\", \"rors); \\n}  \\n91 \\nCHAPTER 11  |  Unit testing \\n \\nThis unit test checks that validation fails when the \", \"Surname property of the MockViewModel doesn't \\nhave any data, and the Value, IsValid, and Errors pro\", \"perty of each ValidatableObject<T> instance \\nare correctly set. \\nSummary \\nA unit test takes a small \", \"unit of the app, typically a method, isolates it from the remainder of the code, \\nand verifies that \", \"it behaves as expected. Its goal is to check that each unit of functionality performs as \\nexpected, \", \"so that errors don't propagate throughout the app. \\nThe behavior of an object under test can be isol\", \"ated by replacing dependent objects with mock \\nobjects that simulate the behavior of the dependent o\", \"bjects. This enables unit tests to be executed \\nwithout requiring unwieldy resources such as web ser\", \"vices, or databases. \\nTesting models and view models from MVVM applications is identical to testing \", \"any other classes, and \\nthe same tools and techniques can be used. \\n \\n \\n92 \\nCHAPTER 11  |  Unit test\", \"ing \\n \\n \\n\"]"