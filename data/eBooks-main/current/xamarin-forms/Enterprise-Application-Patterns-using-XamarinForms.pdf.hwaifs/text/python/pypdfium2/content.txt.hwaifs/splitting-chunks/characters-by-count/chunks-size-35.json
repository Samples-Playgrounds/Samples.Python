"[\"Book title\\nBook subtitle\\nAuthor NamePUBLISHED BY\\nDevDiv, .NET and Visual Studio produc teams\\nA divis\", \"ion of Microsoft Corporation\\nOne Microsoft Way\\nRedmond, Washington 98052-6399\\nCopyright \\u00a9 2017 by Mi\", \"crosoft Corporation\\nAll rights reserved. No part of the contents of this book may be reproduced or t\", \"ransmitted in any \\nform or by any means without the written permission of the publisher.\\nThis book i\", \"s provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The views, opinions and \\ninformati\", \"on expressed in this book, including URL and other Internet website references, may change \\nwithout \", \"notice. \\nSome examples depicted herein are provided for illustration only and are fictitious. No rea\", \"l association \\nor connection is intended or should be inferred.\\nMicrosoft and the trademarks listed \", \"at http://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are \\ntrademarks of the Microsoft group of co\", \"mpanies. All other marks are property of their respective \\nowners.\\nAuthor: David Britch\\nDeveloper: J\", \"avier Suarez Ruiz (Plain Concepts)\\nParticipants and reviewers: Craig Dunn, Tom Opgenorth\\nEditor: Joh\", \"n Meade (Populus Group)i\\nContents\\nPreface ..........................................................\", \"................................................................. iv\\nPurpose .......................\", \"....................................................................................................\", \".......iv\\nWhat's left out of this guide's scope ....................................................\", \"..........................................iv\\nWho should use this guide .............................\", \"................................................................................iv\\nHow to use this g\", \"uide ...............................................................................................\", \".......................v\\nIntroduction ..............................................................\", \"...................................................... 1\\nSample application.........................\", \"..........................................................................................2\\nSample a\", \"pplication architecture.............................................................................\", \".........................2\\nMobile app...............................................................\", \"........................................................................4\\neShopOnContainers.Core pro\", \"ject................................................................................................\", \"...5\\nPlatform projects .............................................................................\", \"...............................................6\\nSummary ...........................................\", \"......................................................................................6\\nMVVM........\", \"....................................................................................................\", \"................. 7\\nThe MVVM pattern ...............................................................\", \"...................................................7\\nView ..........................................\", \"....................................................................................................\", \"...8\\nViewModel......................................................................................\", \".................................................8\\nModel............................................\", \"...................................................................................................9\", \"\\nConnecting view models to views....................................................................\", \".........................9\\nCreating a view model declaratively .....................................\", \"........................................................10\\nCreating a view model programmatically ..\", \"...................................................................................10\\nCreating a vie\", \"w defined as a data template........................................................................\", \"..........11\\nAutomatically creating a view model with a view model locator..........................\", \".......................11\\nUpdating views in response to changes in the underlying view model or mode\", \"l .......................12\\nUI interaction using commands and behaviors ............................\", \"............................................13\\nImplementing commands................................\", \"..............................................................................14\\nImplementing behavi\", \"ors.................................................................................................\", \"...............15\\nSummary ..........................................................................\", \".....................................................17\\nDependency injection .......................\", \"............................................................................. 18\\nIntroduction to dep\", \"endency injection ..................................................................................\", \"...18\\nRegistration .................................................................................\", \"..........................................20\\nResolution.............................................\", \".................................................................................22\\nManaging the lif\", \"etime of resolved objects...........................................................................\", \"....22\\nSummary .....................................................................................\", \"..........................................23ii\\nCommunicating between loosely coupled components ....\", \".............................................. 24\\nIntroduction to MessagingCenter...................\", \".........................................................................24\\nDefining a message......\", \"....................................................................................................\", \".......26\\nPublishing a message......................................................................\", \"........................................26\\nSubscribing to a message.................................\", \".......................................................................27\\nUnsubscribing from a messa\", \"ge................................................................................................27\", \"\\nSummary ...........................................................................................\", \"....................................27\\nNavigation ..................................................\", \"................................................................... 28\\nNavigating between pages.....\", \".................................................................................................29\\n\", \"Creating the NavigationService instance.............................................................\", \"..........................29\\nHandling navigation requests...........................................\", \".............................................................30\\nNavigating when the app is launched \", \"...........................................................................................32\\nPassin\", \"g parameters during navigation .....................................................................\", \".....................33\\nInvoking navigation using behaviors ........................................\", \".....................................................34\\nConfirming or cancelling navigation.........\", \".....................................................................................34\\nSummary ....\", \"....................................................................................................\", \".......................35\\nValidation................................................................\", \"...................................................... 36\\nSpecifying validation rules...............\", \".......................................................................................37\\nAdding val\", \"idation rules to a property ........................................................................\", \"..............38\\nTriggering validation..............................................................\", \".................................................39\\nTriggering validation manually .................\", \".....................................................................................39\\nTriggering v\", \"alidation when properties change....................................................................\", \"..........40\\nDisplaying validation errors...........................................................\", \".........................................40\\nHighlighting a control that contains invalid data ......\", \"....................................................................41\\nDisplaying error messages....\", \"....................................................................................................\", \".....44\\nSummary ....................................................................................\", \"...........................................45\\nConfiguration management .............................\", \".............................................................. 46\\nCreating a settings class.........\", \".................................................................................................46\\n\", \"Adding a setting ...................................................................................\", \"..................................47\\nData binding to user settings .................................\", \".................................................................48\\nSummary ........................\", \"....................................................................................................\", \"...50\\nContainerized microservices...................................................................\", \"........................ 51\\nMicroservices...........................................................\", \"..............................................................52\\nContainerization...................\", \"..................................................................................................53\", \"\\nCommunication between client and microservices.....................................................\", \".............55\\nCommunication between microservices.................................................\", \".................................56\\nSummary ........................................................\", \".......................................................................58\\nAuthentication and authori\", \"zation .................................................................................. 59\\nAuthent\", \"ication ............................................................................................\", \"...........................59\\nIssuing bearer tokens using IdentityServer 4 .........................\", \".......................................................60\\nAdding IdentityServer to a web application\", \"..................................................................................60\\nConfiguring Ide\", \"ntityServer ........................................................................................\", \"....................61iii\\nPerforming authentication ................................................\", \"............................................................64\\nAuthorization........................\", \".................................................................................................69\\n\", \"Configuring IdentityServer to perform authorization ................................................\", \"...................70\\nMaking access requests to APIs................................................\", \".....................................................71\\nSummary ....................................\", \"...........................................................................................71\\nAccess\", \"ing remote data ....................................................................................\", \"............... 73\\nIntroduction to Representational State Transfer..................................\", \"....................................73\\nConsuming RESTful APIs ......................................\", \"...................................................................74\\nMaking web requests ..........\", \"....................................................................................................\", \"......74\\nCaching data ..............................................................................\", \"............................................81\\nManaging data expiration ............................\", \".................................................................................82\\nCaching images..\", \"....................................................................................................\", \"........................82\\nIncreasing resilience ...................................................\", \"............................................................83\\nRetry pattern .......................\", \"....................................................................................................\", \"......83\\nCircuit breaker pattern ...................................................................\", \"...............................................84\\nSummary ..........................................\", \".....................................................................................85\\nUnit testing\", \"....................................................................................................\", \"................ 86\\nDependency injection and unit testing ..........................................\", \"..........................................86\\nTesting MVVM applications..............................\", \"......................................................................87\\nTesting asynchronous functi\", \"onality.............................................................................................\", \"..88\\nTesting INotifyPropertyChanged implementations.................................................\", \"......................88\\nTesting message-based communication .......................................\", \"................................................89\\nTesting exception handling.......................\", \".....................................................................................89\\nTesting vali\", \"dation .............................................................................................\", \".............................90\\nSummary ............................................................\", \"...................................................................91iv Preface\\nPreface\\nPurpose\\nThis\", \" eBook provides guidance on building cross-platform enterprise apps using Xamarin.Forms. \\nXamarin.Fo\", \"rms is a cross-platform UI toolkit that allows developers to easily create native user \\ninterface la\", \"youts that can be shared across platforms, including iOS, Android, and the Universal \\nWindows Platfo\", \"rm (UWP). It provides a comprehensive solution for Business to Employee (B2E), \\nBusiness to Business\", \" (B2B), and Business to Consumer (B2C) apps, providing the ability to share code \\nacross all target \", \"platforms and helping to lower the total cost of ownership (TCO).\\nThe guide provides architectural g\", \"uidance for developing adaptable, maintainable, and testable \\nXamarin.Forms enterprise apps. Guidanc\", \"e is provided on how to implement MVVM, dependency \\ninjection, navigation, validation, and configura\", \"tion management, while maintaining loose coupling. In \\naddition, there's also guidance on performing\", \" authentication and authorization with IdentityServer, \\naccessing data from containerized microservi\", \"ces, and unit testing.\\nThe guide comes with source code for the eShopOnContainers mobile app, and so\", \"urce code for the \\neShopOnContainers reference app. The eShopOnContainers mobile app is a cross-plat\", \"form enterprise \\napp developed using Xamarin.Forms, which connects to a series of containerized micr\", \"oservices known \\nas the eShopOnContainers reference app. However, the eShopOnContainers mobile app c\", \"an be \\nconfigured to consume data from mock services for those who wish to avoid deploying the \\ncont\", \"ainerized microservices.\\nWhat's left out of this guide's scope\\nThis guide is aimed at readers who ar\", \"e already familiar with Xamarin.Forms. For a detailed \\nintroduction to Xamarin.Forms, see the Xamari\", \"n.Forms documentation on the Xamarin Developer \\nCenter, and Creating Mobile Apps with Xamarin.Forms.\", \"\\nThe guide is complementary to .NET Microservices: Architecture for Containerized .NET Applications,\", \" \\nwhich focuses on developing and deploying containerized microservices. Other guides worth reading \", \"\\ninclude Architecting and Developing Modern Web Applications with ASP.NET Core and Microsoft \\nAzure,\", \" Containerized Docker Application Lifecycle with Microsoft Platform and Tools, and Microsoft \\nPlatfo\", \"rm and Tools for Mobile App Development.\\nWho should use this guide\\nThe audience for this guide is ma\", \"inly developers and architects who would like to learn how to \\narchitect and implement cross-platfor\", \"m enterprise apps using Xamarin.Forms.v Preface\\nA secondary audience is technical decision makers wh\", \"o would like to receive an architectural and \\ntechnology overview before deciding on what approach t\", \"o select for cross-platform enterprise app \\ndevelopment using Xamarin.Forms.\\nHow to use this guide\\nT\", \"his guide focuses on building cross-platform enterprise apps using Xamarin.Forms. As such, it should\", \" \\nbe read in its entirety to provide a foundation of understanding such apps and their technical \\nco\", \"nsiderations. The guide, along with its sample app, can also serve as a starting point or reference \", \"for \\ncreating a new enterprise app. Use the associated sample app as a template for the new app, or \", \"to see \\nhow to organize an app's component parts. Then, refer back to this guide for architectural g\", \"uidance.\\nFeel free to forward this guide to team members to help ensure a common understanding of cr\", \"oss\\u0002platform enterprise app development using Xamarin.Forms. Having everybody working from a \\ncommon\", \" set of terminologies and underlying principles will help ensure a consistent application of \\narchit\", \"ectural patterns and practices.1 CHAPTER 1 | Introduction\\nC H A P T E R 1\\nIntroduction\\nRegardless of\", \" platform, developers of enterprise apps face several challenges:\\n\\u2022 App requirements that can change\", \" over time.\\n\\u2022 New business opportunities and challenges.\\n\\u2022 Ongoing feedback during development that \", \"can significantly affect the scope and \\nrequirements of the app.\\nWith these in mind, it's important \", \"to build apps that can be easily modified or extended over time. \\nDesigning for such adaptability ca\", \"n be difficult as it requires an architecture that allows individual \\nparts of the app to be indepen\", \"dently developed and tested in isolation without affecting the rest of \\nthe app.\\nMany enterprise app\", \"s are sufficiently complex to require more than one developer. It can be a \\nsignificant challenge to\", \" decide how to design an app so that multiple developers can work effectively \\non different pieces o\", \"f the app independently, while ensuring that the pieces come together seamlessly \\nwhen integrated in\", \"to the app.\\nThe traditional approach to designing and building an app results in what is referred to\", \" as a \\nmonolithic app, where components are tightly coupled with no clear separation between them.\\nT\", \"ypically, this monolithic approach leads to apps that are difficult and inefficient to maintain, bec\", \"ause\\nit can be difficult to resolve bugs without breaking other components in the app, and it can be\", \"\\ndifficult to add new features or to replace existing features.\\nAn effective remedy for these challe\", \"nges is to partition an app into discrete, loosely coupled\\ncomponents that can be easily integrated \", \"together into an app. Such an approach offers several\\nbenefits:\\n\\u2022 It allows individual functionality\", \" to be developed, tested, extended, and maintained by \\ndifferent individuals or teams.\\n\\u2022 It promotes\", \" reuse and a clean separation of concerns between the app's horizontal \\ncapabilities, such as authen\", \"tication and data access, and the vertical capabilities, such as app \\nspecific business functionalit\", \"y. This allows the dependencies and interactions between app \\ncomponents to be more easily managed.\\n\", \"\\u2022 It helps maintain a separation of roles by allowing different individuals, or teams, to focus on \\n\", \"a specific task or piece of functionality according to their expertise. In particular, it provides a\", \" \\ncleaner separation between the user interface and the app's business logic.\\nHowever, there are man\", \"y issues that must be resolved when partitioning an app into discrete, loosely \\ncoupled components. \", \"These include:\\n\\u2022 Deciding how to provide a clean separation of concerns between the user interface c\", \"ontrols \\nand their logic. One of the most important decisions when creating a Xamarin.Forms \\nenterpr\", \"ise app is whether to place business logic in code-behind files, or whether to create a \\nclean separ\", \"ation of concerns between the user interface controls and their logic, in order to 2 CHAPTER 1 | Int\", \"roduction\\nmake the app more maintainable and testable. For more information, see Model-View\\u0002ViewMode\", \"l.\\n\\u2022 Determining whether to use a dependency injection container. Dependency injection \\ncontainers r\", \"educe the dependency coupling between objects by providing a facility to \\nconstruct instances of cla\", \"sses with their dependencies injected, and manage their lifetime \\nbased on the configuration of the \", \"container. For more information, see Dependency injection.\\n\\u2022 Choosing between platform provided even\", \"ting and loosely coupled message-based \\ncommunication between components that are inconvenient to li\", \"nk by object and type \\nreferences. For more information, see Introduction to Communicating between l\", \"oosely \\ncoupled components.\\n\\u2022 Deciding how to navigate between pages, including how to invoke naviga\", \"tion, and where \\nnavigation logic should reside. For more information, see Navigation.\\n\\u2022 Determining\", \" how to validate user input for correctness. The decision must include how to \\nvalidate user input, \", \"and how to notify the user about validation errors. For more information, \\nsee Validation.\\n\\u2022 Decidin\", \"g how to perform authentication, and how to protect resources with authorization. For \\nmore informat\", \"ion, see Authentication and authorization.\\n\\u2022 Determining how to access remote data from web services\", \", including how to reliably retrieve \\ndata, and how to cache data. For more information, see Accessi\", \"ng remote data.\\n\\u2022 Deciding how to test the app. For more information, see Unit testing.\\nThis guide p\", \"rovides guidance on these issues, and focuses on the core patterns and architecture for \\nbuilding a \", \"cross-platform enterprise app using Xamarin.Forms. The guidance aims to help to produce \\nadaptable, \", \"maintainable, and testable code, by addressing common Xamarin.Forms enterprise app \\ndevelopment scen\", \"arios, and by separating the concerns of presentation, presentation logic, and \\nentities through sup\", \"port for the Model-View-ViewModel (MVVM) pattern.\\nSample application\\nThis guide includes a sample ap\", \"plication, eShopOnContainers, that's an online store that includes the \\nfollowing functionality:\\n\\u2022 A\", \"uthenticating and authorizing against a backend service.\\n\\u2022 Browsing a catalog of shirts, coffee mugs\", \", and other marketing items.\\n\\u2022 Filtering the catalog.\\n\\u2022 Ordering items from the catalog.\\n\\u2022 Viewing t\", \"he user's order history.\\n\\u2022 Configuration of settings.\\nSample application architecture\\nFigure 1-1 pro\", \"vides a high-level overview of the architecture of the sample application.3 CHAPTER 1 | Introduction\", \"\\nFigure 1-1: eShopOnContainers high-level architecture\\nThe sample application ships with three clien\", \"t apps:\\n\\u2022 An MVC application developed with ASP.NET Core.\\n\\u2022 A Single Page Application (SPA) develope\", \"d with Angular 2 and Typescript. This approach for \\nweb applications avoids performing a round-trip \", \"to the server with each operation.\\n\\u2022 A mobile app developed with Xamarin.Forms, which supports iOS, \", \"Android, and the Universal \\nWindows Platform (UWP).\\nFor information about the web applications, see \", \"Architecting and Developing Modern Web \\nApplications with ASP.NET Core and Microsoft Azure.\\nThe samp\", \"le application includes the following backend services:\\n\\u2022 An identity microservice, which uses ASP.N\", \"ET Core Identity and IdentityServer.\\n\\u2022 A catalog microservice, which is a data-driven create, read, \", \"update, delete (CRUD) service that \\nconsumes an SQL Server database using EntityFramework Core.\\n\\u2022 An\", \" ordering microservice, which is a domain-driven service that uses domain-driven design \\npatterns.\\n\\u2022\", \" A basket microservice, which is a data-driven CRUD service that uses Redis Cache.\\nThese backend ser\", \"vices are implemented as microservices using ASP.NET Core MVC, and are \\ndeployed as unique container\", \"s within a single Docker host. Collectively, these backend services are \\nreferred to as the eShopOnC\", \"ontainers reference application. Client apps communicate with the \\nbackend services through a Repres\", \"entational State Transfer (REST) web interface. For more \\ninformation about microservices and Docker\", \", see Containerized microservices.\\nFor information about the implementation of the backend services,\", \" see .NET Microservices: \\nArchitecture for Containerized .NET Applications.4 CHAPTER 1 | Introductio\", \"n\\nMobile app\\nThis guide focuses on building cross-platform enterprise apps using Xamarin.Forms, and \", \"uses the \\neShopOnContainers mobile app as an example. Figure 1-2 shows the pages from the \\neShopOnCo\", \"ntainers mobile app that provide the functionality outlined earlier.\\nFigure 1-2: The eShopOnContaine\", \"rs mobile app\\nThe mobile app consumes the backend services provided by the eShopOnContainers referen\", \"ce \\napplication. However, it can be configured to consume data from mock services for those who wish\", \" to \\navoid deploying the backend services.\\nThe eShopOnContainers mobile app exercises the following \", \"Xamarin.Forms functionality:\\n\\u2022 XAML\\n\\u2022 Controls\\n\\u2022 Bindings\\n\\u2022 Converters\\n\\u2022 Styles5 CHAPTER 1 | Introdu\", \"ction\\n\\u2022 Animations\\n\\u2022 Commands\\n\\u2022 Behaviors\\n\\u2022 Triggers\\n\\u2022 Effects\\n\\u2022 Custom Renderers\\n\\u2022 MessagingCenter\\n\", \"\\u2022 Custom Controls\\nFor more information about this functionality, see the Xamarin.Forms documentation\", \" on the Xamarin \\nDeveloper Center, and Creating Mobile Apps with Xamarin.Forms.\\nIn addition, unit te\", \"sts are provided for some of the classes in the eShopOnContainers mobile app.\\nMobile app solution\\nTh\", \"e eShopOnContainers mobile app solution organizes the source code and other resources into \\nprojects\", \". All of the projects use folders to organize the source code and other resources into \\ncategories. \", \"The following table outlines the projects that make up the eShopOnContainers mobile \\napp:\\nProject De\", \"scription\\neShopOnContainers.Core This project is the portable class library (PCL) project \\nthat cont\", \"ains the shared code and shared UI.\\neShopOnContainers.Droid This project holds Android specific code\", \" and is the \\nentry point for the Android app.\\neShopOnContainers.iOS This project holds iOS specific \", \"code and is the entry \\npoint for the iOS app.\\neShopOnContainers.UWP This project holds Universal Win\", \"dows Platform (UWP) \\nspecific code and is the entry point for the Windows \\napp.\\neShopOnContainers.Te\", \"stRunner.Droid This project is the Android test runner for the \\neShopOnContainers.UnitTests project.\", \"\\neShopOnContainers.TestRunner.iOS This project is the iOS test runner for the \\neShopOnContainers.Uni\", \"tTests project.\\neShopOnContainers.TestRunner.Windows This project is the Universal Windows Platform \", \"test \\nrunner for the eShopOnContainers.UnitTests project.\\neShopOnContainers.UnitTests This project c\", \"ontains unit tests for the \\neShopOnContainers.Core project.\\nThe classes from the eShopOnContainers m\", \"obile app can be re-used in any Xamarin.Forms app with \\nlittle or no modification. \\neShopOnContainer\", \"s.Core project\\nThe eShopOnContainers.Core PCL project contains the following folders:6 CHAPTER 1 | I\", \"ntroduction\\nFolder Description\\nAnimations Contains classes that enable animations to be consumed in \", \"XAML.\\nBehaviors Contains behaviors that are exposed to view classes.\\nControls Contains custom contro\", \"ls used by the app.\\nConverters Contains value converters that apply custom logic to a binding.\\nEffec\", \"ts Contains the EntryLineColorEffect class, which is used to change the border \\ncolor of specific En\", \"try controls.\\nExceptions Contains the custom ServiceAuthenticationException.\\nExtensions Contains ext\", \"ension methods for the VisualElement and IEnumerable<T> classes.\\nHelpers Contains helper classes for\", \" the app.\\nModels Contains the model classes for the app.\\nProperties Contains AssemblyInfo.cs, a .NET\", \" assembly metadata file.\\nServices Contains interfaces and classes that implement services that are p\", \"rovided to the \\napp.\\nTriggers Contains the BeginAnimation trigger, which is used to invoke an animat\", \"ion in \\nXAML.\\nValidations Contains classes involved in validating data input.\\nViewModels Contains th\", \"e application logic that's exposed to pages.\\nViews Contains the pages for the app.\\nPlatform projects\", \"\\nThe platform projects contain effect implementations, custom renderer implementations, and other \\np\", \"latform-specific resources.\\nSummary\\nXamarin's cross-platform mobile app development tools and platfo\", \"rms provide a comprehensive \\nsolution for B2E, B2B, and B2C mobile client apps, providing the abilit\", \"y to share code across all target \\nplatforms (iOS, Android, and Windows) and helping to lower the to\", \"tal cost of ownership. Apps can \\nshare their user interface and app logic code, while retaining the \", \"native platform look and feel.\\nDevelopers of enterprise apps face several challenges that can alter \", \"the architecture of the app during \\ndevelopment. Therefore, it's important to build an app so that i\", \"t can be modified or extended over \\ntime. Designing for such adaptability can be difficult, but typi\", \"cally involves partitioning an app into \\ndiscrete, loosely coupled components that can be easily int\", \"egrated together into an app.7 CHAPTER 2 | MVVM\\nC H A P T E R 2\\nMVVM\\nThe Xamarin.Forms developer exp\", \"erience typically involves creating a user interface in XAML, and then \\nadding code-behind that oper\", \"ates on the user interface. As apps are modified, and grow in size and \\nscope, complex maintenance i\", \"ssues can arise. These issues include the tight coupling between the UI \\ncontrols and the business l\", \"ogic, which increases the cost of making UI modifications, and the difficulty \\nof unit testing such \", \"code.\\nThe Model-View-ViewModel (MVVM) pattern helps to cleanly separate the business and presentatio\", \"n \\nlogic of an application from its user interface (UI). Maintaining a clean separation between appl\", \"ication \\nlogic and the UI helps to address numerous development issues and can make an application e\", \"asier \\nto test, maintain, and evolve. It can also greatly improve code re-use opportunities and allo\", \"ws \\ndevelopers and UI designers to more easily collaborate when developing their respective parts of\", \" an \\napp.\\nThe MVVM pattern\\nThere are three core components in the MVVM pattern: the model, the view,\", \" and the view model. \\nEach serves a distinct purpose. Figure 2-1 shows the relationships between the\", \" three components.\\nFigure 2-1: The MVVM pattern\\nIn addition to understanding the responsibilities of\", \" each components, it's also important to \\nunderstand how they interact with each other. At a high le\", \"vel, the view \\\"knows about\\\" the view model, \\nand the view model \\\"knows about\\\" the model, but the mod\", \"el is unaware of the view model, and the \\nview model is unaware of the view. Therefore, the view mod\", \"el isolates the view from the model, and \\nallows the model to evolve independently of the view.\\nThe \", \"benefits of using the MVVM pattern are as follows:\\n\\u2022 If there's an existing model implementation tha\", \"t encapsulates existing business logic, it can \\nbe difficult or risky to change it. In this scenario\", \", the view model acts as an adapter for the \\nmodel classes and enables you to avoid making any major\", \" changes to the model code.8 CHAPTER 2 | MVVM\\n\\u2022 Developers can create unit tests for the view model \", \"and the model, without using the view. \\nThe unit tests for the view model can exercise exactly the s\", \"ame functionality as used by the \\nview.\\n\\u2022 The app UI can be redesigned without touching the code, pr\", \"ovided that the view is \\nimplemented entirely in XAML. Therefore, a new version of the view should w\", \"ork with the \\nexisting view model.\\n\\u2022 Designers and developers can work independently and concurrentl\", \"y on their components \\nduring the development process. Designers can focus on the view, while develo\", \"pers can work \\non the view model and model components.\\nThe key to using MVVM effectively lies in und\", \"erstanding how to factor app code into the correct \\nclasses, and in understanding how the classes in\", \"teract. The following sections discuss the \\nresponsibilities of each of the classes in the MVVM patt\", \"ern.\\nView\\nThe view is responsible for defining the structure, layout, and appearance of what the use\", \"r sees on \\nscreen. Ideally, each view is defined in XAML, with a limited code-behind that does not c\", \"ontain \\nbusiness logic. However, in some cases, the code-behind might contain UI logic that implemen\", \"ts \\nvisual behavior that is difficult to express in XAML, such as animations.\\nIn a Xamarin.Forms app\", \"lication, a view is typically a Page-derived or ContentView-derived class. \\nHowever, views can also \", \"be represented by a data template, which specifies the UI elements to be \\nused to visually represent\", \" an object when it's displayed. A data template as a view does not have any \\ncode-behind, and is des\", \"igned to bind to a specific view model type.\\nTip: Avoid enabling and disabling UI elements in the co\", \"de-behind\\nEnsure that view models are responsible for defining logical state changes that affect som\", \"e aspects\\nof the view's display, such as whether a command is available, or an indication that an op\", \"eration is \\npending. Therefore, enable and disable UI elements by binding to view model properties, \", \"rather \\nthan enabling and disabling them in code-behind.\\nThere are several options for executing cod\", \"e on the view model in response to interactions on the \\nview, such as a button click or item selecti\", \"on. If a control supports commands, the control's Command\\nproperty can be data-bound to an ICommand \", \"property on the view model. When the control's \\ncommand is invoked, the code in the view model will \", \"be executed. In addition to commands, \\nbehaviors can be attached to an object in the view and can li\", \"sten for either a command to be invoked \\nor event to be raised. In response, the behavior can then i\", \"nvoke an ICommand on the view model or a \\nmethod on the view model.\\nViewModel\\nThe view model impleme\", \"nts properties and commands to which the view can data bind to, and \\nnotifies the view of any state \", \"changes through change notification events. The properties and \\ncommands that the view model provide\", \"s define the functionality to be offered by the UI, but the view \\ndetermines how that functionality \", \"is to be displayed.\\nTip: Keep the UI responsive with asynchronous operations\\nMobile apps should keep\", \" the UI thread unblocked to improve the user's perception of \\nperformance. Therefore, in the view mo\", \"del, use asynchronous methods for I/O operations and raise\\nevents to asynchronously notify views of \", \"property changes.9 CHAPTER 2 | MVVM\\nThe view model is also responsible for coordinating the view's i\", \"nteractions with any model classes that \\nare required. There's typically a one-to-many relationship \", \"between the view model and the model \\nclasses. The view model might choose to expose model classes d\", \"irectly to the view so that controls in \\nthe view can data bind directly to them. In this case, the \", \"model classes will need to be designed to \\nsupport data binding and change notification events.\\nEach\", \" view model provides data from a model in a form that the view can easily consume. To \\naccomplish th\", \"is, the view model sometimes performs data conversion. Placing this data conversion in \\nthe view mod\", \"el is a good idea because it provides properties that the view can bind to. For example, \\nthe view m\", \"odel might combine the values of two properties to make it easier for display by the view.\\nTip: Cent\", \"ralize data conversions in a conversion layer\\nIt's also possible to use converters as a separate dat\", \"a conversion layer that sits between the view \\nmodel and the view. This can be necessary, for exampl\", \"e, when data requires special formatting that \\nthe view model doesn't provide.\\nIn order for the view\", \" model to participate in two-way data binding with the view, its properties must \\nraise the Property\", \"Changed event. View models satisfy this requirement by implementing the \\nINotifyPropertyChanged inte\", \"rface, and raising the PropertyChanged event when a property is \\nchanged.\\nFor collections, the view-\", \"friendly ObservableCollection<T> is provided. This collection implements \\ncollection changed notific\", \"ation, relieving the developer from having to implement the \\nINotifyCollectionChanged interface on c\", \"ollections.\\nModel\\nModel classes are non-visual classes that encapsulate the app's data. Therefore, t\", \"he model can be \\nthought of as representing the app's domain model, which usually includes a data mo\", \"del along with \\nbusiness and validation logic. Examples of model objects include data transfer objec\", \"ts (DTOs), Plain \\nOld CLR Objects (POCOs), and generated entity and proxy objects.\\nModel classes are\", \" typically used in conjunction with services or repositories that encapsulate data \\naccess and cachi\", \"ng.\\nConnecting view models to views\\nView models can be connected to views by using the data-binding \", \"capabilities of Xamarin.Forms. \\nThere are many approaches that can be used to construct views and vi\", \"ew models and associate them \\nat runtime. These approaches fall into two categories, known as view f\", \"irst composition, and view \\nmodel first composition. Choosing between view first composition and vie\", \"w model first composition is \\nan issue of preference and complexity. However, all approaches share t\", \"he same aim, which is for the \\nview to have a view model assigned to its BindingContext property.\\nWi\", \"th view first composition the app is conceptually composed of views that connect to the view \\nmodels\", \" they depend on. The primary benefit of this approach is that it makes it easy to construct \\nloosely\", \" coupled, unit testable apps because the view models have no dependence on the views \\nthemselves. It\", \"'s also easy to understand the structure of the app by following its visual structure, \\nrather than \", \"having to track code execution to understand how classes are created and associated. In \\naddition, v\", \"iew first construction aligns with the Xamarin.Forms navigation system that's responsible \\nfor const\", \"ructing pages when navigation occurs, which makes a view model first composition complex \\nand misali\", \"gned with the platform.10 CHAPTER 2 | MVVM\\nWith view model first composition the app is conceptually\", \" composed of view models, with a service \\nbeing responsible for locating the view for a view model. \", \"View model first composition feels more \\nnatural to some developers, since the view creation can be \", \"abstracted away, allowing them to focus \\non the logical non-UI structure of the app. In addition, it\", \" allows view models to be created by other \\nview models. However, this approach is often complex and\", \" it can become difficult to understand how \\nthe various parts of the app are created and associated.\", \"\\nTip: Keep view models and views independent\\nThe binding of views to a property in a data source sho\", \"uld be the view's principal dependency on \\nits corresponding view model. Specifically, don't referen\", \"ce view types, such as Button and \\nListView, from view models. By following the principles outlined \", \"here, view models can be tested \\nin isolation, therefore reducing the likelihood of software defects\", \" by limiting scope.\\nThe following sections discuss the main approaches to connecting view models to \", \"views.\\nCreating a view model declaratively\\nThe simplest approach is for the view to declaratively in\", \"stantiate its corresponding view model in \\nXAML. When the view is constructed, the corresponding vie\", \"w model object will also be constructed. \\nThis approach is demonstrated in the following code exampl\", \"e:\\n<ContentPage ... xmlns:local=\\\"clr-namespace:eShop\\\">\\n <ContentPage.BindingContext>\\n <local:LoginVi\", \"ewModel />\\n </ContentPage.BindingContext>\\n ...\\n</ContentPage>\\nWhen the ContentPage is created, an in\", \"stance of the LoginViewModel is automatically constructed \\nand set as the view's BindingContext.\\nThi\", \"s declarative construction and assignment of the view model by the view has the advantage that \\nit's\", \" simple, but has the disadvantage that it requires a default (parameter-less) constructor in the vie\", \"w \\nmodel.\\nCreating a view model programmatically\\nA view can have code in the code-behind file that r\", \"esults in the view model being assigned to its \\nBindingContext property. This is often accomplished \", \"in the view's constructor, as shown in the \\nfollowing code example:\\npublic LoginView()\\n{\\n Initialize\", \"Component();\\n BindingContext = new LoginViewModel(navigationService);\\n}\\nThe programmatic constructio\", \"n and assignment of the view model within the view's code-behind has \\nthe advantage that it's simple\", \". However, the main disadvantage of this approach is that the view \\nneeds to provide the view model \", \"with any required dependencies. Using a dependency injection \\ncontainer can help to maintain loose c\", \"oupling between the view and view model. For more \\ninformation, see Dependency injection.11 CHAPTER \", \"2 | MVVM\\nCreating a view defined as a data template\\nA view can be defined as a data template and ass\", \"ociated with a view model type. Data templates can \\nbe defined as resources, or they can be defined \", \"inline within the control that will display the view \\nmodel. The content of the control is the view \", \"model instance, and the data template is used to visually \\nrepresent it. This technique is an exampl\", \"e of a situation in which the view model is instantiated first, \\nfollowed by the creation of the vie\", \"w.\\nAutomatically creating a view model with a view model locator\\nA view model locator is a custom cl\", \"ass that manages the instantiation of view models and their \\nassociation to views. In the eShopOnCon\", \"tainers mobile app, the ViewModelLocator class has an \\nattached property, AutoWireViewModel, that's \", \"used to associate view models with views. In the view's \\nXAML, this attached property is set to true\", \" to indicate that the view model should be automatically \\nconnected to the view, as shown in the fol\", \"lowing code example:\\nviewModelBase:ViewModelLocator.AutoWireViewModel=\\\"true\\\"\\nThe AutoWireViewModel p\", \"roperty is a bindable property that's initialized to false, and when its \\nvalue changes the OnAutoWi\", \"reViewModelChanged event handler is called. This method resolves the \\nview model for the view. The f\", \"ollowing code example shows how this is achieved:\\nprivate static void OnAutoWireViewModelChanged(Bin\", \"dableObject bindable, object oldValue, object n\\newValue)\\n{\\n var view = bindable as Element;\\n if (vie\", \"w == null)\\n {\\n return;\\n }\\n var viewType = view.GetType();\\n var viewName = viewType.FullName.Replace(\", \"\\\".Views.\\\", \\\".ViewModels.\\\");\\n var viewAssemblyName = viewType.GetTypeInfo().Assembly.FullName;\\n var v\", \"iewModelName = string.Format(\\n CultureInfo.InvariantCulture, \\\"{0}Model, {1}\\\", viewName, viewAssembly\", \"Name);\\n var viewModelType = Type.GetType(viewModelName);\\n if (viewModelType == null)\\n {\\n return;\\n }\\n\", \" var viewModel = _container.Resolve(viewModelType);\\n view.BindingContext = viewModel;\\n}\\nThe OnAutoWi\", \"reViewModelChanged method attempts to resolve the view model using a convention\\u0002based approach. This\", \" convention assumes that:\\n\\u2022 View models are in the same assembly as view types.\\n\\u2022 Views are in a .Vi\", \"ews child namespace.\\n\\u2022 View models are in a .ViewModels child namespace.\\n\\u2022 View model names correspo\", \"nd with view names and end with \\\"ViewModel\\\".12 CHAPTER 2 | MVVM\\nFinally, the OnAutoWireViewModelChan\", \"ged method sets the BindingContext of the view type to the \\nresolved view model type. For more infor\", \"mation about resolving the view model type, see Resolution.\\nThis approach has the advantage that an \", \"app has a single class that is responsible for the instantiation \\nof view models and their connectio\", \"n to views.\\nTip: Use a view model locator for ease of substitution\\nA view model locator can also be \", \"used as a point of substitution for alternate implementations of \\ndependencies, such as for unit tes\", \"ting or design time data.\\nUpdating views in response to changes in the \\nunderlying view model or mod\", \"el\\nAll view model and model classes that are accessible to a view should implement the \\nINotifyPrope\", \"rtyChanged interface. Implementing this interface in a view model or model class \\nallows the class t\", \"o provide change notifications to any data-bound controls in the view when the \\nunderlying property \", \"value changes. \\nApp's should be architected for the correct use of property change notification, by \", \"meeting the \\nfollowing requirements:\\n\\u2022 Always raising a PropertyChanged event if a public property's\", \" value changes. Do not assume \\nthat raising the PropertyChanged event can be ignored because of know\", \"ledge of how XAML \\nbinding occurs.\\n\\u2022 Always raising a PropertyChanged event for any calculated prope\", \"rties whose values are used \\nby other properties in the view model or model.\\n\\u2022 Always raising the Pr\", \"opertyChanged event at the end of the method that makes a property \\nchange, or when the object is kn\", \"own to be in a safe state. Raising the event interrupts the \\noperation by invoking the event's handl\", \"ers synchronously. If this happens in the middle of an \\noperation, it might expose the object to cal\", \"lback functions when it is in an unsafe, partially \\nupdated state. In addition, it's possible for ca\", \"scading changes to be triggered by \\nPropertyChanged events. Cascading changes generally require upda\", \"tes to be complete \\nbefore the cascading change is safe to execute.\\n\\u2022 Never raising a PropertyChange\", \"d event if the property does not change. This means that you \\nmust compare the old and new values be\", \"fore raising the PropertyChanged event.\\n\\u2022 Never raising the PropertyChanged event during a view mode\", \"l's constructor if you are \\ninitializing a property. Data-bound controls in the view will not have s\", \"ubscribed to receive \\nchange notifications at this point.\\n\\u2022 Never raising more than one PropertyChan\", \"ged event with the same property name \\nargument within a single synchronous invocation of a public m\", \"ethod of a class. For example, \\ngiven a NumberOfItems property whose backing store is the _numberOfI\", \"tems field, if a \\nmethod increments _numberOfItems fifty times during the execution of a loop, it sh\", \"ould only \\nraise property change notification on the NumberOfItems property once, after all the work\", \" is \\ncomplete. For asynchronous methods, raise the PropertyChanged event for a given property \\nname \", \"in each synchronous segment of an asynchronous continuation chain.\\nThe eShopOnContainers mobile app \", \"uses the ExtendedBindableObject class to provide change \\nnotifications, which is shown in the follow\", \"ing code example:13 CHAPTER 2 | MVVM\\npublic abstract class ExtendedBindableObject : BindableObject\\n{\", \"\\n public void RaisePropertyChanged<T>(Expression<Func<T>> property)\\n {\\n var name = GetMemberInfo(pro\", \"perty).Name;\\n OnPropertyChanged(name);\\n }\\n private MemberInfo GetMemberInfo(Expression expression)\\n \", \"{\\n ...\\n }\\n} \\nXamarin.Form's BindableObject class implements the INotifyPropertyChanged interface, an\", \"d \\nprovides an OnPropertyChanged method. The ExtendedBindableObject class provides the \\nRaisePropert\", \"yChanged method to invoke property change notification, and in doing so uses the \\nfunctionality prov\", \"ided by the BindableObject class.\\nEach view model class in the eShopOnContainers mobile app derives \", \"from the ViewModelBase class, \\nwhich in turn derives from the ExtendedBindableObject class. Therefor\", \"e, each view model class uses \\nthe RaisePropertyChanged method in the ExtendedBindableObject class t\", \"o provide property \\nchange notification. The following code example shows how the eShopOnContainers \", \"mobile app \\ninvokes property change notification by using a lambda expression:\\npublic bool IsLogin\\n{\", \"\\n get\\n {\\n return _isLogin;\\n }\\n set\\n {\\n _isLogin = value;\\n RaisePropertyChanged(() => IsLogin);\\n }\\n}\\n\", \"Note that using a lambda expression in this way involves a small performance cost because the \\nlambd\", \"a expression has to be evaluated for each call. Although the performance cost is small and \\nwould no\", \"t normally impact an app, the costs can accrue when there are many change notifications. \\nHowever, t\", \"he benefit of this approach is that it provides compile-time type safety and refactoring \\nsupport wh\", \"en renaming properties.\\nUI interaction using commands and behaviors\\nIn mobile apps, actions are typi\", \"cally invoked in response to a user action, such as a button click, that \\ncan be implemented by crea\", \"ting an event handler in the code-behind file. However, in the MVVM \\npattern, the responsibility for\", \" implementing the action lies with the view model, and placing code in \\nthe code-behind should be av\", \"oided.\\nCommands provide a convenient way to represent actions that can be bound to controls in the U\", \"I. \\nThey encapsulate the code that implements the action, and help to keep it decoupled from its vis\", \"ual \\nrepresentation in the view. Xamarin.Forms includes controls that can be declaratively connected\", \" to a \\ncommand, and these controls will invoke the command when the user interacts with the control.\", \"14 CHAPTER 2 | MVVM\\nBehaviors also allow controls to be declaratively connected to a command. Howeve\", \"r, behaviors can be \\nused to invoke an action that's associated with a range of events raised by a c\", \"ontrol. Therefore, \\nbehaviors address many of the same scenarios as command-enabled controls, while \", \"providing a \\ngreater degree of flexibility and control. In addition, behaviors can also be used to a\", \"ssociate command \\nobjects or methods with controls that were not specifically designed to interact w\", \"ith commands.\\nImplementing commands\\nView models typically expose command properties, for binding fro\", \"m the view, that are object \\ninstances that implement the ICommand interface. A number of Xamarin.Fo\", \"rms controls provide a \\nCommand property, which can be data bound to an ICommand object provided by \", \"the view model. The \\nICommand interface defines an Execute method, which encapsulates the operation \", \"itself, a \\nCanExecute method, which indicates whether the command can be invoked, and a \\nCanExecuteC\", \"hanged event that occurs when changes occur that affect whether the command should \\nexecute. The Com\", \"mand and Command<T> classes, provided by Xamarin.Forms, implement the ICommand\\ninterface, where T is\", \" the type of the arguments to Execute and CanExecute. \\nWithin a view model, there should be an objec\", \"t of type Command or Command<T> for each public \\nproperty in the view model of type ICommand. The Co\", \"mmand or Command<T> constructor requires an \\nAction callback object that's called when the ICommand.\", \"Execute method is invoked. The \\nCanExecute method is an optional constructor parameter, and is a Fun\", \"c that returns a bool.\\nThe following code shows how a Command instance, which represents a register \", \"command, is \\nconstructed by specifying a delegate to the Register view model method:\\npublic ICommand\", \" RegisterCommand => new Command(Register);\\nThe command is exposed to the view through a property tha\", \"t returns a reference to an ICommand. \\nWhen the Execute method is called on the Command object, it s\", \"imply forwards the call to the method \\nin the view model via the delegate that was specified in the \", \"Command constructor. \\nAn asynchronous method can be invoked by a command by using the async and awai\", \"t keywords \\nwhen specifying the command's Execute delegate. This indicates that the callback is a Ta\", \"sk and \\nshould be awaited. For example, the following code shows how a Command instance, which repre\", \"sents \\na sign-in command, is constructed by specifying a delegate to the SignInAsync view model meth\", \"od:\\npublic ICommand SignInCommand => new Command(async () => await SignInAsync());\\nParameters can be\", \" passed to the Execute and CanExecute actions by using the Command<T> class to \\ninstantiate the comm\", \"and. For example, the following code shows how a Command<T> instance is used \\nto indicate that the N\", \"avigateAsync method will require an argument of type string:\\npublic ICommand NavigateCommand => new \", \"Command<string>(NavigateAsync);\\nIn both the Command and Command<T> classes, the delegate to the CanE\", \"xecute method in each \\nconstructor is optional. If a delegate isn't specified, the Command will retu\", \"rn true for CanExecute. \\nHowever, the view model can indicate a change in the command's CanExecute s\", \"tatus by calling the \\nChangeCanExecute method on the Command object. This causes the CanExecuteChang\", \"ed event to be \\nraised. Any controls in the UI that are bound to the command will then update their \", \"enabled status to \\nreflect the availability of the data-bound command.15 CHAPTER 2 | MVVM\\nInvoking c\", \"ommands from a view\\nThe following code example shows how a Grid in the LoginView binds to the Regist\", \"erCommand in \\nthe LoginViewModel class by using a TapGestureRecognizer instance:\\n<Grid Grid.Column=\\\"\", \"1\\\" HorizontalOptions=\\\"Center\\\">\\n <Label Text=\\\"REGISTER\\\" TextColor=\\\"Gray\\\"/>\\n <Grid.GestureRecognizers>\", \"\\n <TapGestureRecognizer Command=\\\"{Binding RegisterCommand}\\\" NumberOfTapsRequired=\\\"1\\\" />\\n </Grid.Gest\", \"ureRecognizers>\\n</Grid>\\nA command parameter can also be optionally defined using the CommandParamete\", \"r property. The \\ntype of the expected argument is specified in the Execute and CanExecute target met\", \"hods. The \\nTapGestureRecognizer will automatically invoke the target command when the user interacts\", \" with \\nthe attached control. The command parameter, if provided, will be passed as the argument to t\", \"he \\ncommand's Execute delegate.\\nImplementing behaviors\\nBehaviors allow functionality to be added to \", \"UI controls without having to subclass them. Instead, the \\nfunctionality is implemented in a behavio\", \"r class and attached to the control as if it was part of the \\ncontrol itself. Behaviors enable you t\", \"o implement code that you would normally have to write as \\ncode-behind, because it directly interact\", \"s with the API of the control, in such a way that it can be \\nconcisely attached to the control, and \", \"packaged for reuse across more than one view or app. In the \\ncontext of MVVM, behaviors are a useful\", \" approach for connecting controls to commands.\\nA behavior that's attached to a control through attac\", \"hed properties is known as an attached behavior. \\nThe behavior can then use the exposed API of the e\", \"lement to which it is attached to add functionality \\nto that control, or other controls, in the visu\", \"al tree of the view. The eShopOnContainers mobile app \\ncontains the LineColorBehavior class, which i\", \"s an attached behavior. For more information about \\nthis behavior, see Displaying validation errors.\", \"\\nA Xamarin.Forms behavior is a class that derives from the Behavior or Behavior<T> class, where T is\", \" \\nthe type of the control to which the behavior should apply. These classes provide OnAttachedTo and\", \" \\nOnDetachingFrom methods, which should be overridden to provide logic that will be executed when \\nt\", \"he behavior is attached to and detached from controls.\\nIn the eShopOnContainers mobile app, the Bind\", \"ableBehavior<T> class derives from the \\nBehavior<T> class. The purpose of the BindableBehavior<T> cl\", \"ass is to provide a base class for \\nXamarin.Forms behaviors that require the BindingContext of the b\", \"ehavior to be set to the attached \\ncontrol. \\nThe BindableBehavior<T> class provides an overridable O\", \"nAttachedTo method that sets the \\nBindingContext of the behavior, and an overridable OnDetachingFrom\", \" method that cleans up the \\nBindingContext. In addition, the class stores a reference to the attache\", \"d control in the \\nAssociatedObject property.\\nThe eShopOnContainers mobile app includes an EventToCom\", \"mandBehavior class, which executes a \\ncommand in response to an event occurring. This class derives \", \"from the BindableBehavior<View>\\nclass so that the behavior can bind to and execute an ICommand speci\", \"fied by a Command property \\nwhen the behavior is consumed. The following code example shows the Even\", \"tToCommandBehavior \\nclass:16 CHAPTER 2 | MVVM\\npublic class EventToCommandBehavior : BindableBehavior\", \"<View>\\n{\\n ...\\n protected override void OnAttachedTo(View visualElement)\\n {\\n base.OnAttachedTo(visual\", \"Element);\\n var events = AssociatedObject.GetType().GetRuntimeEvents().ToArray();\\n if (events.Any())\\n\", \" {\\n _eventInfo = events.FirstOrDefault(e => e.Name == EventName);\\n if (_eventInfo == null)\\n throw ne\", \"w ArgumentException(string.Format(\\n \\\"EventToCommand: Can't find any event named '{0}' on attached ty\", \"pe\\\",\\n EventName));\\n AddEventHandler(_eventInfo, AssociatedObject, OnFired);\\n }\\n }\\n protected overrid\", \"e void OnDetachingFrom(View view)\\n {\\n if (_handler != null)\\n _eventInfo.RemoveEventHandler(Associate\", \"dObject, _handler);\\n base.OnDetachingFrom(view);\\n }\\n private void AddEventHandler(\\n EventInfo eventI\", \"nfo, object item, Action<object, EventArgs> action)\\n {\\n ...\\n }\\n private void OnFired(object sender, \", \"EventArgs eventArgs)\\n {\\n ...\\n }\\n}\\nThe OnAttachedTo and OnDetachingFrom methods are used to register \", \"and deregister an event \\nhandler for the event defined in the EventName property. Then, when the eve\", \"nt fires, the OnFired \\nmethod is invoked, which executes the command.\\nThe advantage of using the Eve\", \"ntToCommandBehavior to execute a command when an event fires, is \\nthat commands can be associated wi\", \"th controls that weren't designed to interact with commands. In \\naddition, this moves event-handling\", \" code to view models, where it can be unit tested.\\nInvoking behaviors from a view\\nThe EventToCommand\", \"Behavior is particularly useful for attaching a command to a control that \\ndoesn't support commands.\", \" For example, the ProfileView uses the EventToCommandBehavior to \\nexecute the OrderDetailCommand whe\", \"n the ItemTapped event fires on the ListView that lists the \\nuser's orders, as shown in the followin\", \"g code:\\n<ListView>\\n <ListView.Behaviors>\\n <behaviors:EventToCommandBehavior \\n EventName=\\\"ItemTapped\\\"\", \"\\n Command=\\\"{Binding OrderDetailCommand}\\\"\\n EventArgsConverter=\\\"{StaticResource ItemTappedEventArgsCon\", \"verter}\\\" />17 CHAPTER 2 | MVVM\\n </ListView.Behaviors>\\n ...\\n</ListView>\\nAt runtime, the EventToComman\", \"dBehavior will respond to interaction with the ListView. When an \\nitem is selected in the ListView, \", \"the ItemTapped event will fire, which will execute the \\nOrderDetailCommand in the ProfileViewModel. \", \"By default, the event arguments for the event are \\npassed to the command. This data is converted as \", \"it's passed between source and target by the \\nconverter specified in the EventArgsConverter property\", \", which returns the Item of the ListView\\nfrom the ItemTappedEventArgs. Therefore, when the OrderDeta\", \"ilCommand is executed, the selected \\nOrder is passed as a parameter to the registered Action.\\nFor mo\", \"re information about behaviors, see Behaviors on the Xamarin Developer Center.\\nSummary\\nThe Model-Vie\", \"w-ViewModel (MVVM) pattern helps to cleanly separate the business and presentation \\nlogic of an appl\", \"ication from its user interface (UI). Maintaining a clean separation between application \\nlogic and \", \"the UI helps to address numerous development issues and can make an application easier \\nto test, mai\", \"ntain, and evolve. It can also greatly improve code re-use opportunities and allows \\ndevelopers and \", \"UI designers to more easily collaborate when developing their respective parts of an \\napp.\\nUsing the\", \" MVVM pattern, the UI of the app and the underlying presentation and business logic is \\nseparated in\", \"to three separate classes: the view, which encapsulates the UI and UI logic; the view \\nmodel, which \", \"encapsulates presentation logic and state; and the model, which encapsulates the app's \\nbusiness log\", \"ic and data.18 CHAPTER 3 | Dependency injection\\nC H A P T E R 3\\nDependency \\ninjection\\nTypically, a c\", \"lass constructor is invoked when instantiating an object, and any values that the object \\nneeds are \", \"passed as arguments to the constructor. This is an example of dependency injection, and \\nspecificall\", \"y is known as constructor injection. The dependencies the object needs are injected into the \\nconstr\", \"uctor.\\nBy specifying dependencies as interface types, dependency injection enables decoupling of the\", \" \\nconcrete types from the code that depends on these types. It generally uses a container that holds\", \" a\\nlist of registrations and mappings between interfaces and abstract types, and the concrete types \", \"that \\nimplement or extend these types.\\nThere are also other types of dependency injection, such as p\", \"roperty setter injection, and method call \\ninjection, but they are less commonly seen. Therefore, th\", \"is chapter will focus solely on performing \\nconstructor injection with a dependency injection contai\", \"ner.\\nIntroduction to dependency injection\\nDependency injection is a specialized version of the Inver\", \"sion of Control (IoC) pattern, where the \\nconcern being inverted is the process of obtaining the req\", \"uired dependency. With dependency \\ninjection, another class is responsible for injecting dependencie\", \"s into an object at runtime. The \\nfollowing code example shows how the ProfileViewModel class is str\", \"uctured when using \\ndependency injection:\\npublic class ProfileViewModel : ViewModelBase\\n{\\n private I\", \"OrderService _orderService;\\n public ProfileViewModel(IOrderService orderService)\\n {\\n _orderService =\", \" orderService;\\n }\\n ...\\n}\\nThe ProfileViewModel constructor receives an IOrderService instance as an a\", \"rgument, injected by \\nanother class. The only dependency in the ProfileViewModel class is on the int\", \"erface type. \\nTherefore, the ProfileViewModel class doesn't have any knowledge of the class that's r\", \"esponsible for \\ninstantiating the IOrderService object. The class that's responsible for instantiati\", \"ng the 19 CHAPTER 3 | Dependency injection\\nIOrderService object, and inserting it into the ProfileVi\", \"ewModel class, is known as the dependency \\ninjection container.\\nDependency injection containers redu\", \"ce the coupling between objects by providing a facility to \\ninstantiate class instances and manage t\", \"heir lifetime based on the configuration of the container. \\nDuring the objects creation, the contain\", \"er injects any dependencies that the object requires into it. If \\nthose dependencies have not yet be\", \"en created, the container creates and resolves their dependencies \\nfirst.\\nNote: Dependency injection\", \" can also be implemented manually using factories. However, using a \\ncontainer provides additional c\", \"apabilities such as lifetime management, and registration through \\nassembly scanning.\\nThere are seve\", \"ral advantages to using a dependency injection container:\\n\\u2022 A container removes the need for a class\", \" to locate its dependencies and manage their \\nlifetimes.\\n\\u2022 A container allows mapping of implemented\", \" dependencies without affecting the class.\\n\\u2022 A container facilitates testability by allowing depende\", \"ncies to be mocked.\\n\\u2022 A container increases maintainability by allowing new classes to be easily add\", \"ed to the app.\\nIn the context of a Xamarin.Forms app that uses MVVM, a dependency injection containe\", \"r will \\ntypically be used for registering and resolving view models, and for registering services an\", \"d injecting \\nthem into view models.\\nThere are many dependency injection containers available, with t\", \"he eShopOnContainers mobile app \\nusing Autofac to manage the instantiation of view model and service\", \" classes in the app. Autofac \\nfacilitates building loosely coupled apps, and provides all of the fea\", \"tures commonly found in \\ndependency injection containers, including methods to register type mapping\", \"s and object instances, \\nresolve objects, manage object lifetimes, and inject dependent objects into\", \" constructors of objects \\nthat it resolves. For more information about Autofac, see Autofac on readt\", \"hedocs.io.\\nIn Autofac, the IContainer interface provides the dependency injection container. Figure \", \"3-1 shows \\nthe dependencies when using this container, which instantiates an IOrderService object an\", \"d injects \\nit into the ProfileViewModel class.\\nFigure 3-1: Dependencies when using dependency inject\", \"ion20 CHAPTER 3 | Dependency injection\\nAt runtime, the container must know which implementation of t\", \"he IOrderService interface it should \\ninstantiate, before it can instantiate a ProfileViewModel obje\", \"ct. This involves:\\n\\u2022 The container deciding how to instantiate an object that implements the IOrderS\", \"ervice\\ninterface. This is known as registration.\\n\\u2022 The container instantiating the object that imple\", \"ments the IOrderService interface, and the \\nProfileViewModel object. This is known as resolution.\\nEv\", \"entually, the app will finish using the ProfileViewModel object and it will become available for \\nga\", \"rbage collection. At this point, the garbage collector should dispose of the IOrderService instance \", \"\\nif other classes do not share the same instance. \\nTip: Write container-agnostic code\\nAlways try to \", \"write container-agnostic code to decouple the app from the specific dependency \\ncontainer being used\", \".\\nRegistration\\nBefore dependencies can be injected into an object, the types of the dependencies mus\", \"t first be \\nregistered with the container. Registering a type typically involves passing the contain\", \"er an interface \\nand a concrete type that implements the interface.\\nThere are two ways of registerin\", \"g types and objects in the container through code:\\n\\u2022 Register a type or mapping with the container. \", \"When required, the container will build an \\ninstance of the specified type.\\n\\u2022 Register an existing o\", \"bject in the container as a singleton. When required, the container will \\nreturn a reference to the \", \"existing object.\\nTip: Dependency injection containers are not always suitable\\nDependency injection i\", \"ntroduces additional complexity and requirements that might not be \\nappropriate or useful to small a\", \"pps. If a class does not have any dependencies, or is not a \\ndependency for other types, it might no\", \"t make sense to put it in the container. In addition, if a class\\nhas a single set of dependencies th\", \"at are integral to the type and will never change, it might not \\nmake sense to put it in the contain\", \"er.\\nThe registration of types that require dependency injection should be performed in a single meth\", \"od in \\nan app, and this method should be invoked early in the app's lifecycle to ensure that the app\", \" is aware \\nof the dependencies between its classes. In the eShopOnContainers mobile app this is perf\", \"ormed by \\nthe ViewModelLocator class, which builds the IContainer object and is the only class in th\", \"e app that \\nholds a reference to that object. The following code example shows how the eShopOnContai\", \"ners \\nmobile app declares the IContainer object in the ViewModelLocator class:\\nprivate static IConta\", \"iner _container;\\nTypes and instances are registered in the RegisterDependencies method in the ViewMo\", \"delLocator\\nclass. This is achieved by first creating a ContainerBuilder instance, which is demonstra\", \"ted in the \\nfollowing code example:\\nvar builder = new ContainerBuilder();21 CHAPTER 3 | Dependency i\", \"njection\\nTypes and instances are then registered with the ContainerBuilder object, and the following\", \" code \\nexample demonstrates the most common form of type registration:\\nbuilder.RegisterType<RequestP\", \"rovider>().As<IRequestProvider>();\\nThe RegisterType method shown here maps an interface type to a co\", \"ncrete type. It tells the \\ncontainer to instantiate a RequestProvider object when it instantiates an\", \" object that requires an \\ninjection of an IRequestProvider through a constructor.\\nConcrete types can\", \" also be registered directly without a mapping from an interface type, as shown in \\nthe following co\", \"de example:\\nbuilder.RegisterType<ProfileViewModel>();\\nWhen the ProfileViewModel type is resolved, th\", \"e container will inject its required dependencies.\\nAutofac also allows instance registration, where \", \"the container is responsible for maintaining a \\nreference to a singleton instance of a type. For exa\", \"mple, the following code example shows how the \\neShopOnContainers mobile app registers the concrete \", \"type to use when a ProfileViewModel\\ninstance requires an IOrderService instance:\\nbuilder.RegisterTyp\", \"e<OrderService>().As<IOrderService>().SingleInstance();\\nThe RegisterType method shown here maps an i\", \"nterface type to a concrete type. The \\nSingleInstance method configures the registration so that eve\", \"ry dependent object receives the \\nsame shared instance. Therefore, only a single OrderService instan\", \"ce will exist in the container, \\nwhich is shared by objects that require an injection of an IOrderSe\", \"rvice through a constructor. \\nInstance registration can also be performed with the RegisterInstance \", \"method, which is\\ndemonstrated in the following code example:\\nbuilder.RegisterInstance(new OrderMockS\", \"ervice()).As<IOrderService>();\\nThe RegisterInstance method shown here creates a new OrderMockService\", \" instance and registers \\nit with the container. Therefore, only a single OrderMockService instance e\", \"xists in the container, \\nwhich is shared by objects that require an injection of an IOrderService th\", \"rough a constructor.\\nFollowing type and instance registration, the IContainer object must be built, \", \"which is demonstrated \\nin the following code example:\\n_container = builder.Build();\\nInvoking the Bui\", \"ld method on the ContainerBuilder instance builds a new dependency injection \\ncontainer that contain\", \"s the registrations that have been made.\\nTip: Consider an IContainer as being immutable\\nWhile Autofa\", \"c provides an Update method to update registrations in an existing container, calling \\nthis method s\", \"hould be avoided where possible. There are risks to modifying a container after it's \\nbeen built, pa\", \"rticularly if the container has been used. For more information, see Consider a \\nContainer as Immuta\", \"ble on readthedocs.io.22 CHAPTER 3 | Dependency injection\\nResolution\\nAfter a type is registered, it \", \"can be resolved or injected as a dependency. When a type is being \\nresolved and the container needs \", \"to create a new instance, it injects any dependencies into the \\ninstance.\\nGenerally, when a type is \", \"resolved, one of three things happens:\\n1. If the type hasn't been registered, the container throws a\", \"n exception.\\n2. If the type has been registered as a singleton, the container returns the singleton \", \"instance. If \\nthis is the first time the type is called for, the container creates it if required, a\", \"nd maintains a \\nreference to it.\\n3. If the type hasn't been registered as a singleton, the container\", \" returns a new instance, and \\ndoesn't maintain a reference to it.\\nThe following code example shows h\", \"ow the RequestProvider type that was previously registered \\nwith Autofac can be resolved:\\nvar reques\", \"tProvider = _container.Resolve<IRequestProvider>();\\nIn this example, Autofac is asked to resolve the\", \" concrete type for the IRequestProvider type, along \\nwith any dependencies. Typically, the Resolve m\", \"ethod is called when an instance of a specific type is \\nrequired. For information about controlling \", \"the lifetime of resolved objects, see Managing the lifetime \\nof resolved objects.\\nThe following code\", \" example shows how the eShopOnContainers mobile app instantiates view model \\ntypes and their depende\", \"ncies:\\nvar viewModel = _container.Resolve(viewModelType);\\nIn this example, Autofac is asked to resol\", \"ve the view model type for a requested view model, and the \\ncontainer will also resolve any dependen\", \"cies. When resolving the ProfileViewModel type, the \\ndependency to resolve is an IOrderService objec\", \"t. Therefore, Autofac first constructs an \\nOrderService object and then passes it to the constructor\", \" of the ProfileViewModel class. For more \\ninformation about how the eShopOnContainers mobile app con\", \"structs view models and associates \\nthem to views, see Automatically creating a view model with a vi\", \"ew model locator.\\nNote: Registering and resolving types with a container has a performance cost beca\", \"use of the \\ncontainer's use of reflection for creating each type, especially if dependencies are bei\", \"ng \\nreconstructed for each page navigation in the app. If there are many or deep dependencies, the \\n\", \"cost of creation can increase significantly.\\nManaging the lifetime of resolved objects\\nAfter registe\", \"ring a type, the default behavior for Autofac is to create a new instance of the registered \\ntype ea\", \"ch time the type is resolved, or when the dependency mechanism injects instances into other \\nclasses\", \". In this scenario, the container doesn't hold a reference to the resolved object. However, when \\nre\", \"gistering an instance, the default behavior for Autofac is to manage the lifetime of the object as a\", \" \\nsingleton. Therefore, the instance remains in scope while the container is in scope, and is dispos\", \"ed \\nwhen the container goes out of scope and is garbage collected, or when code explicitly disposes \", \"the \\ncontainer.23 CHAPTER 3 | Dependency injection\\nAn Autofac instance scope can be used to specify \", \"the singleton behavior for an object that Autofac \\ncreates from a registered type. Autofac instance \", \"scopes manage the object lifetimes instantiated by \\nthe container. The default instance scope for th\", \"e RegisterType method is the \\nInstancePerDependency scope. However, the SingleInstance scope can be \", \"used with the \\nRegisterType method, so that the container creates or returns a singleton instance of\", \" a type when \\ncalling the Resolve method. The following code example shows how Autofac is instructed\", \" to create a \\nsingleton instance of the NavigationService class:\\nbuilder.RegisterType<NavigationServ\", \"ice>().As<INavigationService>().SingleInstance();\\nThe first time that the INavigationService interfa\", \"ce is resolved, the container creates a new \\nNavigationService object and maintains a reference to i\", \"t. On any subsequent resolutions of the \\nINavigationService interface, the container returns a refer\", \"ence to the NavigationService object \\nthat was previously created. \\nNote: The SingleInstance scope d\", \"isposes created objects when the container is disposed.\\nAutofac includes additional instance scopes.\", \" For more information, see Instance Scope on \\nreadthedocs.io.\\nSummary\\nDependency injection enables d\", \"ecoupling of concrete types from the code that depends on these \\ntypes. It typically uses a containe\", \"r that holds a list of registrations and mappings between interfaces \\nand abstract types, and the co\", \"ncrete types that implement or extend these types.\\nAutofac facilitates building loosely coupled apps\", \", and provides all of the features commonly found in \\ndependency injection containers, including met\", \"hods to register type mappings and object instances, \\nresolve objects, manage object lifetimes, and \", \"inject dependent objects into constructors of objects it \\nresolves.24 CHAPTER 4 | Communicating betw\", \"een loosely coupled components\\nC H A P T E R 4\\nCommunicating \\nbetween loosely \\ncoupled \\ncomponents\\nT\", \"he publish-subscribe pattern is a messaging pattern in which publishers send messages without \\nhavin\", \"g knowledge of any receivers, known as subscribers. Similarly, subscribers listen for specific \\nmess\", \"ages, without having knowledge of any publishers. \\nEvents in .NET implement the publish-subscribe pa\", \"ttern, and are the most simple and straightforward \\napproach for a communication layer between compo\", \"nents if loose coupling is not required, such as a \\ncontrol and the page that contains it. However, \", \"the publisher and subscriber lifetimes are coupled by \\nobject references to each other, and the subs\", \"criber type must have a reference to the publisher type. \\nThis can create memory management issues, \", \"especially when there are short lived objects that \\nsubscribe to an event of a static or long-lived \", \"object. If the event handler isn't removed, the subscriber \\nwill be kept alive by the reference to i\", \"t in the publisher, and this will prevent or delay the garbage \\ncollection of the subscriber.\\nIntrod\", \"uction to MessagingCenter\\nThe Xamarin.Forms MessagingCenter class implements the publish-subscribe p\", \"attern, allowing \\nmessage-based communication between components that are inconvenient to link by ob\", \"ject and type \\nreferences. This mechanism allows publishers and subscribers to communicate without h\", \"aving a \\nreference to each other, helping to reduce dependencies between components, while also allo\", \"wing \\ncomponents to be independently developed and tested.\\nThe MessagingCenter class provides multic\", \"ast publish-subscribe functionality. This means that there \\ncan be multiple publishers that publish \", \"a single message, and there can be multiple subscribers \\nlistening for the same message. Figure 4-1 \", \"illustrates this relationship:25 CHAPTER 4 | Communicating between loosley coupled components\\nFigure\", \" 4-1: Multicast publish-subscribe functionality\\nPublishers send messages using the MessagingCenter.S\", \"end method, while subscribers listen for \\nmessages using the MessagingCenter.Subscribe method. In ad\", \"dition, subscribers can also \\nunsubscribe from message subscriptions, if required, with the Messagin\", \"gCenter.Unsubscribe\\nmethod.\\nInternally, the MessagingCenter class uses weak references. This means t\", \"hat it will not keep objects \\nalive, and will allow them to be garbage collected. Therefore, it shou\", \"ld only be necessary to \\nunsubscribe from a message when a class no longer wishes to receive the mes\", \"sage.\\nThe eShopOnContainers mobile app uses the MessagingCenter class to communicate between \\nloosel\", \"y coupled components. The app defines three messages:\\n\\u2022 The AddProduct message is published by the C\", \"atalogViewModel class when an item is \\nadded to the shopping basket. In return, the BasketViewModel \", \"class subscribes to the \\nmessage and increments the number of items in the shopping basket in respon\", \"se. In addition, \\nthe BasketViewModel class also unsubscribes from this message.\\n\\u2022 The Filter messag\", \"e is published by the CatalogViewModel class when the user applies a \\nbrand or type filter to the it\", \"ems displayed from the catalogue. In return, the CatalogView\\nclass subscribes to the message and upd\", \"ates the UI so that only items that match the filter \\ncriteria are displayed.\\n\\u2022 The ChangeTab messag\", \"e is published by the MainViewModel class when the \\nCheckoutViewModel navigates to the MainViewModel\", \" following the successful creation and \\nsubmission of a new order. In return, the MainView class sub\", \"scribes to the message and \\nupdates the UI so that the My profile tab is active, to show the user's \", \"orders. \\nNote: While the MessagingCenter class permits communication between loosely-coupled classes\", \", \\nit does not offer the only architectural solution to this issue. For example, communication betwe\", \"en \\na view model and a view can also be achieved by the binding engine and through property change\\nn\", \"otifications. In addition, communication between two view models can also be achieved by \\npassing da\", \"ta during navigation.\\nIn the eShopOnContainers mobile app, MessagingCenter is used to update in the \", \"UI in response to \\nan action occurring in another class. Therefore, messages are published on the UI\", \" thread, with \\nsubscribers receiving the message on the same thread.26 CHAPTER 4 | Communicating bet\", \"ween loosley coupled components\\nTip: Marshal to the UI thread when performing UI updates\\nIf a messag\", \"e that's sent from a background thread is required to update the UI, process the \\nmessage on the UI \", \"thread in the subscriber by invoking the Device.BeginInvokeOnMainThread\\nmethod.\\nFor more information\", \" about MessagingCenter, see MessagingCenter on the Xamarin Developer \\nCenter.\\nDefining a message\\nMes\", \"sagingCenter messages are strings that are used to identify messages. The following code \\nexample sh\", \"ows the messages defined within the eShopOnContainers mobile app:\\npublic class MessengerKeys\\n{\\n // A\", \"dd product to basket\\n public const string AddProduct = \\\"AddProduct\\\";\\n // Filter\\n public const string\", \" Filter = \\\"Filter\\\";\\n // Change selected Tab programmatically\\n public const string ChangeTab = \\\"Chang\", \"eTab\\\";\\n}\\nIn this example, messages are defined using constants. The advantage of this approach is th\", \"at it \\nprovides compile-time type safety and refactoring support.\\nPublishing a message\\nPublishers no\", \"tify subscribers of a message with one of the MessagingCenter.Send overloads. The \\nfollowing code ex\", \"ample demonstrates publishing the AddProduct message:\\nMessagingCenter.Send(this, MessengerKeys.AddPr\", \"oduct, catalogItem);\\nIn this example, the Send method specifies three arguments:\\n\\u2022 The first argumen\", \"t specifies the sender class. The sender class must be specified by any \\nsubscribers who wish to rec\", \"eive the message.\\n\\u2022 The second argument specifies the message.\\n\\u2022 The third argument specifies the pa\", \"yload data to be sent to the subscriber. In this case the \\npayload data is a CatalogItem instance.\\nT\", \"he Send method will publish the message, and its payload data, using a fire-and-forget approach. \\nTh\", \"erefore, the message is sent even if there are no subscribers registered to receive the message. In \", \"\\nthis situation, the sent message is ignored.\\nNote: The MessagingCenter.Send method can use generic \", \"parameters to control how messages \\nare delivered. Therefore, multiple messages that share a message\", \" identity but send different \\npayload data types can be received by different subscribers.27 CHAPTER\", \" 4 | Communicating between loosley coupled components\\nSubscribing to a message\\nSubscribers can regis\", \"ter to receive a message using one of the MessagingCenter.Subscribe \\noverloads. The following code e\", \"xample demonstrates how the eShopOnContainers mobile app \\nsubscribes to, and processes, the AddProdu\", \"ct message:\\nMessagingCenter.Subscribe<CatalogViewModel, CatalogItem>(\\n this, MessageKeys.AddProduct,\", \" async (sender, arg) =>\\n{\\n BadgeCount++;\\n await AddCatalogItemAsync(arg);\\n});\\nIn this example, the S\", \"ubscribe method subscribes to the AddProduct message, and executes a \\ncallback delegate in response \", \"to receiving the message. This callback delegate, specified as a lambda \\nexpression, executes code t\", \"hat updates the UI.\\nTip: Consider using immutable payload data\\nDon't attempt to modify the payload d\", \"ata from within a callback delegate because several threads \\ncould be accessing the received data si\", \"multaneously. In this scenario, the payload data should be \\nimmutable to avoid concurrency errors.\\nA\", \" subscriber might not need to handle every instance of a published message, and this can be \\ncontrol\", \"led by the generic type arguments that are specified on the Subscribe method. In this \\nexample, the \", \"subscriber will only receive AddProduct messages that are sent from the \\nCatalogViewModel class, who\", \"se payload data is a CatalogItem instance.\\nUnsubscribing from a message\\nSubscribers can unsubscribe \", \"from messages they no longer want to receive. This is achieved with one \\nof the MessagingCenter.Unsu\", \"bscribe overloads, as demonstrated in the following code example:\\nMessagingCenter.Unsubscribe<Catalo\", \"gViewModel, CatalogItem>(this, MessengerKeys.AddProduct);\\nIn this example, the Unsubscribe method sy\", \"ntax reflects the type arguments specified when \\nsubscribing to receive the AddProduct message.\\nSumm\", \"ary\\nThe Xamarin.Forms MessagingCenter class implements the publish-subscribe pattern, allowing \\nmess\", \"age-based communication between components that are inconvenient to link by object and type \\nreferen\", \"ces. This mechanism allows publishers and subscribers to communicate without having a \\nreference to \", \"each other, helping to reduce dependencies between components, while also allowing \\ncomponents to be\", \" independently developed and tested.28 CHAPTER 5 | Navigation\\nC H A P T E R 5\\nNavigation\\nXamarin.For\", \"ms includes support for page navigation, which typically results from the user's interaction \\nwith t\", \"he UI or from the app itself as a result of internal logic-driven state changes. However, \\nnavigatio\", \"n can be complex to implement in apps that use the Model-View-ViewModel (MVVM) \\npattern, as the foll\", \"owing challenges must be met:\\n\\u2022 How to identify the view to be navigated to, using an approach that \", \"does not introduce tight \\ncoupling and dependencies between views.\\n\\u2022 How to coordinate the process b\", \"y which the view to be navigated to is instantiated and \\ninitialized. When using MVVM, the view and \", \"view model need to be instantiated and \\nassociated with each other via the view's binding context. W\", \"hen an app is using a \\ndependency injection container, the instantiation of views and view models mi\", \"ght require a \\nspecific construction mechanism.\\n\\u2022 Whether to perform view-first navigation, or view \", \"model-first navigation. With view-first \\nnavigation, the page to navigate to refers to the name of t\", \"he view type. During navigation, \\nthe specified view is instantiated, along with its corresponding v\", \"iew model and other \\ndependent services. An alternative approach is to use view model-first navigati\", \"on, where the \\npage to navigate to refers to the name of the view model type.\\n\\u2022 How to cleanly separ\", \"ate the navigational behavior of the app across the views and view \\nmodels. The MVVM pattern provide\", \"s a separation between the app's UI and its presentation\\nand business logic. However, the navigation\", \" behavior of an app will often span the UI and \\npresentations parts of the app. The user will often \", \"initiate navigation from a view, and the \\nview will be replaced as a result of the navigation. Howev\", \"er, navigation might often also need \\nto be initiated or coordinated from within the view model. \\n\\u2022 \", \"How to pass parameters during navigation for initialization purposes. For example, if the user \\nnavi\", \"gates to a view to update order details, the order data will have to be passed to the view \\nso that \", \"it can display the correct data.\\n\\u2022 How to co-ordinate navigation, to ensure that certain business ru\", \"les are obeyed. For example, \\nusers might be prompted before navigating away from a view so that the\", \"y can correct any \\ninvalid data or be prompted to submit or discard any data changes that were made \", \"within the \\nview.\\nThis chapter addresses these challenges by presenting a NavigationService class th\", \"at's used to \\nperform view model-first page navigation.\\nNote: The NavigationService used by the app \", \"is designed only to perform hierarchical \\nnavigation between ContentPage instances. Using the servic\", \"e to navigate between other page \\ntypes might result in unexpected behavior.29 CHAPTER 5 | Navigatio\", \"n\\nNavigating between pages\\nNavigation logic can reside in a view's code-behind, or in a data bound v\", \"iew model. While placing \\nnavigation logic in a view might be the simplest approach, it is not easil\", \"y testable through unit tests. \\nPlacing navigation logic in view model classes means that the logic \", \"can be exercised through unit\\ntests. In addition, the view model can then implement logic to control\", \" navigation to ensure that \\ncertain business rules are enforced. For example, an app might not allow\", \" the user to navigate away \\nfrom a page without first ensuring that the entered data is valid.\\nA Nav\", \"igationService class is typically invoked from view models, in order to promote testability. \\nHoweve\", \"r, navigating to views from view models would require the view models to reference views, \\nand parti\", \"cularly views that the active view model isn't associated with, which is not recommended. \\nTherefore\", \", the NavigationService presented here specifies the view model type as the target to \\nnavigate to.\\n\", \"The eShopOnContainers mobile app uses the NavigationService class to provide view model-first \\nnavig\", \"ation. This class implements the INavigationService interface, which is shown in the following \\ncode\", \" example:\\npublic interface INavigationService\\n{\\n ViewModelBase PreviousPageViewModel { get; }\\n Task \", \"InitializeAsync();\\n Task NavigateToAsync<TViewModel>() where TViewModel : ViewModelBase;\\n Task Navig\", \"ateToAsync<TViewModel>(object parameter) where TViewModel : ViewModelBase;\\n Task RemoveLastFromBackS\", \"tackAsync();\\n Task RemoveBackStackAsync();\\n}\\nThis interface specifies that an implementing class mus\", \"t provide the following methods:\\nMethod Purpose\\nInitializeAsync Performs navigation to one of two pa\", \"ges when the app is \\nlaunched.\\nNavigateToAsync<T> Performs hierarchical navigation to a specified pa\", \"ge.\\nNavigateToAsync<T>(parameter) Performs hierarchical navigation to a specified page, passing \\na p\", \"arameter.\\nRemoveLastFromBackStackAsync Removes the previous page from the navigation stack.\\nRemoveBa\", \"ckStackAsync Removes all the previous pages from the navigation stack.\\nIn addition, the INavigationS\", \"ervice interface specifies that an implementing class must provide a \\nPreviousPageViewModel property\", \". This property returns the view model type associated with the \\nprevious page in the navigation sta\", \"ck.\\nNote: An INavigationService interface would usually also specify a GoBackAsync method, which \\nis\", \" used to programmatically return to the previous page in the navigation stack. However, this \\nmethod\", \" is missing from the eShopOnContainers mobile app because it's not required.\\nCreating the Navigation\", \"Service instance\\nThe NavigationService class, which implements the INavigationService interface, is \", \"registered as \\na singleton with the Autofac dependency injection container, as demonstrated in the f\", \"ollowing code \\nexample:30 CHAPTER 5 | Navigation\\nbuilder.RegisterType<NavigationService>().As<INavig\", \"ationService>().SingleInstance(); \\nThe INavigationService interface is resolved in the ViewModelBase\", \" class constructor, as \\ndemonstrated in the following code example:\\nNavigationService = ViewModelLoc\", \"ator.Resolve<INavigationService>(); \\nThis returns a reference to the NavigationService object that's\", \" stored in the Autofac dependency \\ninjection container, which is created by the InitNavigation metho\", \"d in the App class. For more \\ninformation, see Navigating when the app is launched.\\nThe ViewModelBas\", \"e class stores the NavigationService instance in a NavigationService property, \\nof type INavigationS\", \"ervice. Therefore, all view model classes, which derive from the \\nViewModelBase class, can use the N\", \"avigationService property to access the methods specified by \\nthe INavigationService interface. This\", \" avoids the overhead of injecting the NavigationService\\nobject from the Autofac dependency injection\", \" container into each view model class.\\nHandling navigation requests\\nXamarin.Forms provides the Navig\", \"ationPage class, which implements a hierarchical navigation \\nexperience in which the user is able to\", \" navigate through pages, forwards and backwards, as desired. \\nFor more information about hierarchica\", \"l navigation, see Hierarchical Navigation on the Xamarin \\nDeveloper Center.\\nRather than use the Navi\", \"gationPage class directly, the eShopOnContainers app wraps the \\nNavigationPage class in the CustomNa\", \"vigationView class, as shown in the following code example:\\npublic partial class CustomNavigationVie\", \"w : NavigationPage\\n{\\n public CustomNavigationView() : base()\\n {\\n InitializeComponent();\\n }\\n public C\", \"ustomNavigationView(Page root) : base(root)\\n {\\n InitializeComponent();\\n }\\n}\\nThe purpose of this wrap\", \"ping is for ease of styling the NavigationPage instance inside the XAML file \\nfor the class.\\nNavigat\", \"ion is performed inside view model classes by invoking one of the NavigateToAsync\\nmethods, specifyin\", \"g the view model type for the page being navigated to, as demonstrated in the \\nfollowing code exampl\", \"e:\\nawait NavigationService.NavigateToAsync<MainViewModel>(); \\nThe following code example shows the N\", \"avigateToAsync methods provided by the \\nNavigationService class:31 CHAPTER 5 | Navigation\\npublic Tas\", \"k NavigateToAsync<TViewModel>() where TViewModel : ViewModelBase\\n{\\n return InternalNavigateToAsync(t\", \"ypeof(TViewModel), null);\\n}\\npublic Task NavigateToAsync<TViewModel>(object parameter) where TViewMod\", \"el : ViewModelBase\\n{\\n return InternalNavigateToAsync(typeof(TViewModel), parameter);\\n} \\nEach method \", \"allows any view model class that derives from the ViewModelBase class to perform \\nhierarchical navig\", \"ation by invoking the InternalNavigateToAsync method. In addition, the second \\nNavigateToAsync metho\", \"d enables navigation data to be specified as an argument that's passed to \\nthe view model being navi\", \"gated to, where it's typically used to perform initialization. For more \\ninformation, see Passing pa\", \"rameters during navigation.\\nThe InternalNavigateToAsync method executes the navigation request, and \", \"is shown in the \\nfollowing code example:\\nprivate async Task InternalNavigateToAsync(Type viewModelTy\", \"pe, object parameter)\\n{\\n Page page = CreatePage(viewModelType, parameter);\\n if (page is LoginView)\\n \", \"{\\n Application.Current.MainPage = new CustomNavigationView(page);\\n }\\n else\\n {\\n var navigationPage = \", \"Application.Current.MainPage as CustomNavigationView;\\n if (navigationPage != null)\\n {\\n await navigat\", \"ionPage.PushAsync(page);\\n }\\n else\\n {\\n Application.Current.MainPage = new CustomNavigationView(page);\", \"\\n }\\n }\\n await (page.BindingContext as ViewModelBase).InitializeAsync(parameter);\\n}\\nprivate Type GetP\", \"ageTypeForViewModel(Type viewModelType)\\n{\\n var viewName = viewModelType.FullName.Replace(\\\"Model\\\", st\", \"ring.Empty);\\n var viewModelAssemblyName = viewModelType.GetTypeInfo().Assembly.FullName;\\n var viewAs\", \"semblyName = string.Format(\\n CultureInfo.InvariantCulture, \\\"{0}, {1}\\\", viewName, viewModelAssemblyNa\", \"me);\\n var viewType = Type.GetType(viewAssemblyName);\\n return viewType;\\n}\\nprivate Page CreatePage(Typ\", \"e viewModelType, object parameter)\\n{\\n Type pageType = GetPageTypeForViewModel(viewModelType);\\n if (p\", \"ageType == null)\\n {\\n throw new Exception($\\\"Cannot locate page type for {viewModelType}\\\");\\n }32 CHAPT\", \"ER 5 | Navigation\\n Page page = Activator.CreateInstance(pageType) as Page;\\n return page;\\n}\\nThe Inter\", \"nalNavigateToAsync method performs navigation to a view model by first calling the \\nCreatePage metho\", \"d. This method locates the view that corresponds to the specified view model type, \\nand creates and \", \"returns an instance of this view type. Locating the view that corresponds to the view \\nmodel type us\", \"es a convention-based approach, which assumes that:\\n\\u2022 Views are in the same assembly as view model t\", \"ypes.\\n\\u2022 Views are in a .Views child namespace.\\n\\u2022 View models are in a .ViewModels child namespace.\\n\\u2022\", \" View names correspond to view model names, with \\\"Model\\\" removed.\\nWhen a view is instantiated, it's \", \"associated with its corresponding view model. For more information \\nabout how this occurs, see Autom\", \"atically creating a view model with a view model locator.\\nIf the view being created is a LoginView, \", \"it's wrapped inside a new instance of the \\nCustomNavigationView class and assigned to the Applicatio\", \"n.Current.MainPage property. \\nOtherwise, the CustomNavigationView instance is retrieved, and provide\", \"d that it isn't null, the \\nPushAsync method is invoked to push the view being created onto the navig\", \"ation stack. However, If \\nthe retrieved CustomNavigationView instance is null, the view being create\", \"d is wrapped inside a \\nnew instance of the CustomNavigationView class and assigned to the \\nApplicati\", \"on.Current.MainPage property. This mechanism ensures that during navigation, pages \\nare added correc\", \"tly to the navigation stack both when it's empty, and when it contains data.\\nTip: Consider caching p\", \"ages\\nPage caching results in memory consumption for views that are not currently displayed. However,\", \" \\nwithout page caching it does mean that XAML parsing and construction of the page and its view \\nmod\", \"el will occur every time a new page is navigated to, which can have a performance impact for a \\ncomp\", \"lex page. For a well-designed page that does not use an excessive number of controls, the \\nperforman\", \"ce should be sufficient. However, page caching might help if slow page loading times are \\nencountere\", \"d.\\nAfter the view is created and navigated to, the InitializeAsync method of the view's associated \\n\", \"view model is executed. For more information, see Passing parameters during navigation.\\nNavigating w\", \"hen the app is launched\\nWhen the app is launched, the InitNavigation method in the App class is invo\", \"ked. The following \\ncode example shows this method:\\nprivate Task InitNavigation()\\n{\\n var navigationS\", \"ervice = ViewModelLocator.Resolve<INavigationService>();\\n return navigationService.InitializeAsync()\", \";\\n}\\nThe method creates a new NavigationService object in the Autofac dependency injection container,\", \" \\nand returns a reference to it, before invoking its InitializeAsync method. 33 CHAPTER 5 | Navigati\", \"on\\nNote: When the INavigationService interface is resolved by the ViewModelBase class, the \\ncontaine\", \"r returns a reference to the NavigationService object that was created when the \\nInitNavigation meth\", \"od is invoked. \\nThe following code example shows the NavigationService InitializeAsync method:\\npubli\", \"c Task InitializeAsync()\\n{\\n if (string.IsNullOrEmpty(Settings.AuthAccessToken))\\n return NavigateToAs\", \"ync<LoginViewModel>();\\n else\\n return NavigateToAsync<MainViewModel>();\\n}\\nThe MainView is navigated t\", \"o if the app has a cached access token, which is used for authentication. \\nOtherwise, the LoginView \", \"is navigated to.\\nFor more information about the Autofac dependency injection container, see Introduc\", \"tion to \\ndependency injection.\\nPassing parameters during navigation\\nOne of the NavigateToAsync metho\", \"ds, specified by the INavigationService interface, enables \\nnavigation data to be specified as an ar\", \"gument that's passed to the view model being navigated to, \\nwhere it's typically used to perform ini\", \"tialization.\\nFor example, the ProfileViewModel class contains an OrderDetailCommand that's executed \", \"when \\nthe user selects an order on the ProfileView page. In turn, this executes the OrderDetailAsync\", \"\\nmethod, which is shown in the following code example:\\nprivate async Task OrderDetailAsync(Order ord\", \"er)\\n{\\n await NavigationService.NavigateToAsync<OrderDetailViewModel>(order);\\n}\\nThis method invokes n\", \"avigation to the OrderDetailViewModel, passing an Order instance that \\nrepresents the order that the\", \" user selected on the ProfileView page. When the NavigationService\\nclass creates the OrderDetailView\", \", the OrderDetailViewModel class is instantiated and assigned to \\nthe view's BindingContext. After n\", \"avigating to the OrderDetailView, the \\nInternalNavigateToAsync method executes the InitializeAsync m\", \"ethod of the view's associated \\nview model.\\nThe InitializeAsync method is defined in the ViewModelBa\", \"se class as a method that can be \\noverridden. This method specifies an object argument that represen\", \"ts the data to be passed to a \\nview model during a navigation operation. Therefore, view model class\", \"es that want to receive data \\nfrom a navigation operation provide their own implementation of the In\", \"itializeAsync method to \\nperform the required initialization. The following code example shows the I\", \"nitializeAsync method \\nfrom the OrderDetailViewModel class:\\npublic override async Task InitializeAsy\", \"nc(object navigationData)\\n{\\n if (navigationData is Order)\\n {\\n ...\\n Order = await _ordersService.GetO\", \"rderAsync(\\n Convert.ToInt32(order.OrderNumber), authToken);34 CHAPTER 5 | Navigation\\n ...\\n }\\n}\\nThis \", \"method retrieves the Order instance that was passed into the view model during the navigation \\nopera\", \"tion, and uses it to retrieve the full order details from the OrderService instance.\\nInvoking naviga\", \"tion using behaviors\\nNavigation is usually triggered from a view by a user interaction. For example,\", \" the LoginView\\nperforms navigation following successful authentication. The following code example s\", \"hows how the \\nnavigation is invoked by a behavior:\\n<WebView ...>\\n <WebView.Behaviors>\\n <behaviors:Ev\", \"entToCommandBehavior\\n EventName=\\\"Navigating\\\"\\n EventArgsConverter=\\\"{StaticResource WebNavigatingEvent\", \"ArgsConverter}\\\"\\n Command=\\\"{Binding NavigateCommand}\\\" />\\n </WebView.Behaviors>\\n</WebView>\\nAt runtime,\", \" the EventToCommandBehavior will respond to interaction with the WebView. When the \\nWebView navigate\", \"s to a web page, the Navigating event will fire, which will execute the \\nNavigateCommand in the Logi\", \"nViewModel. By default, the event arguments for the event are passed \\nto the command. This data is c\", \"onverted as it's passed between source and target by the converter \\nspecified in the EventArgsConver\", \"ter property, which returns the Url from the \\nWebNavigatingEventArgs. Therefore, when the Navigation\", \"Command is executed, the Url of the web \\npage is passed as a parameter to the registered Action.\\nIn \", \"turn, the NavigationCommand executes the NavigateAsync method, which is shown in the \\nfollowing code\", \" example:\\nprivate async Task NavigateAsync(string url)\\n{\\n ... \\n await NavigationService.NavigateToAs\", \"ync<MainViewModel>();\\n await NavigationService.RemoveLastFromBackStackAsync();\\n ...\\n} \\nThis method i\", \"nvokes navigation to the MainViewModel, and following navigation, removes the\\nLoginView page from th\", \"e navigation stack.\\nConfirming or cancelling navigation\\nAn app might need to interact with the user \", \"during a navigation operation, so that the user can \\nconfirm or cancel navigation. This might be nec\", \"essary, for example, when the user attempts to \\nnavigate before having fully completed a data entry \", \"page. In this situation, an app should provide a \\nnotification that allows the user to navigate away\", \" from the page, or to cancel the navigation operation \\nbefore it occurs. This can be achieved in a v\", \"iew model class by using the response from a notification \\nto control whether or not navigation is i\", \"nvoked.35 CHAPTER 5 | Navigation\\nSummary\\nXamarin.Forms includes support for page navigation, which t\", \"ypically results from the user's interaction \\nwith the UI, or from the app itself, as a result of in\", \"ternal logic-driven state changes. However, \\nnavigation can be complex to implement in apps that use\", \" the MVVM pattern.\\nThis chapter presented a NavigationService class, which is used to perform view m\", \"odel-first \\nnavigation from view models. Placing navigation logic in view model classes means that t\", \"he logic can \\nbe exercised through automated tests. In addition, the view model can then implement l\", \"ogic to \\ncontrol navigation to ensure that certain business rules are enforced.36 CHAPTER 6 | Valida\", \"tion\\nC H A P T E R 6\\nValidation\\nAny app that accepts input from users should ensure that the input i\", \"s valid. An app could, for \\nexample, check for input that contains only characters in a particular r\", \"ange, is of a certain length, or \\nmatches a particular format. Without validation, a user can supply\", \" data that causes the app to fail. \\nValidation enforces business rules, and prevents an attacker fro\", \"m injecting malicious data.\\nIn the context of the Model-ViewModel-Model (MVVM) pattern, a view model\", \" or model will often be \\nrequired to perform data validation and signal any validation errors to the\", \" view so that the user can \\ncorrect them. The eShopOnContainers mobile app performs synchronous clie\", \"nt-side validation of view \\nmodel properties and notifies the user of any validation errors by highl\", \"ighting the control that \\ncontains the invalid data, and by displaying error messages that inform th\", \"e user of why the data is \\ninvalid. Figure 6-1 shows the classes involved in performing validation i\", \"n the eShopOnContainers \\nmobile app.\\nFigure 6-1: Validation classes in the eShopOnContainers mobile \", \"app\\nView model properties that require validation are of type ValidatableObject<T>, and each \\nValida\", \"tableObject<T> instance has validation rules added to its Validations property. Validation \\nis invok\", \"ed from the view model by calling the Validate method of the ValidatableObject<T>37 CHAPTER 6 | Vali\", \"dation\\ninstance, which retrieves the validation rules and executes them against the ValidatableObjec\", \"t<T>\\nValue property. Any validation errors are placed into the Errors property of the \\nValidatableOb\", \"ject<T> instance, and the IsValid property of the ValidatableObject<T> instance \\nis updated to indic\", \"ate whether validation succeeded or failed.\\nProperty change notification is provided by the Extended\", \"BindableObject class, and so an Entry\\ncontrol can bind to the IsValid property of ValidatableObject<\", \"T> instance in the view model class \\nto be notified of whether or not the entered data is valid.\\nSpe\", \"cifying validation rules\\nValidation rules are specified by creating a class that derives from the IV\", \"alidationRule<T> interface, \\nwhich is shown in the following code example:\\npublic interface IValidat\", \"ionRule<T>\\n{\\n string ValidationMessage { get; set; }\\n bool Check(T value);\\n}\\nThis interface specifie\", \"s that a validation rule class must provide a boolean Check method that is used \\nto perform the requ\", \"ired validation, and a ValidationMessage property whose value is the validation \\nerror message that \", \"will be displayed if validation fails.\\nThe following code example shows the IsNotNullOrEmptyRule<T> \", \"validation rule, which is used to \\nperform validation of the username and password entered by the us\", \"er on the LoginView when using \\nmock services in the eShopOnContainers mobile app:\\npublic class IsNo\", \"tNullOrEmptyRule<T> : IValidationRule<T>\\n{\\n public string ValidationMessage { get; set; }\\n public bo\", \"ol Check(T value)\\n {\\n if (value == null)\\n {\\n return false;\\n }\\n var str = value as string;\\n return !s\", \"tring.IsNullOrWhiteSpace(str);\\n }\\n}\\nThe Check method returns a boolean indicating whether the value \", \"argument is null, empty, or \\nconsists only of whitespace characters.\\nAlthough not used by the eShopO\", \"nContainers mobile app, the following code example shows a \\nvalidation rule for validating email add\", \"resses:\\npublic class EmailRule<T> : IValidationRule<T>\\n{\\n public string ValidationMessage { get; set\", \"; }\\n public bool Check(T value)\\n {\\n if (value == null)38 CHAPTER 6 | Validation\\n {\\n return false;\\n }\", \"\\n var str = value as string;\\n Regex regex = new Regex(@\\\"^([\\\\w\\\\.\\\\-]+)@([\\\\w\\\\-]+)((\\\\.(\\\\w){2,3})+)$\\\");\\n \", \"Match match = regex.Match(str);\\n return match.Success;\\n }\\n}\\nThe Check method returns a boolean indic\", \"ating whether or not the value argument is a valid email \\naddress. This is achieved by searching the\", \" value argument for the first occurrence of the regular \\nexpression pattern specified in the Regex c\", \"onstructor. Whether the regular expression pattern has \\nbeen found in the input string can be determ\", \"ined by checking the value of the Match object's \\nSuccess property.\\nNote: Property validation can so\", \"metimes involve dependent properties. An example of dependent \\nproperties is when the set of valid v\", \"alues for property A depends on the particular value that has \\nbeen set in property B. To check that\", \" the value of property A is one of the allowed values would \\ninvolve retrieving the value of propert\", \"y B. In addition, when the value of property B changes, \\nproperty A would need to be revalidated.\\nAd\", \"ding validation rules to a property\\nIn the eShopOnContainers mobile app, view model properties that \", \"require validation are declared to \\nbe of type ValidatableObject<T>, where T is the type of the data\", \" to be validated. The following \\ncode example shows an example of two such properties:\\npublic Valida\", \"tableObject<string> UserName\\n{\\n get\\n {\\n return _userName;\\n }\\n set\\n {\\n _userName = value;\\n RaisePrope\", \"rtyChanged(() => UserName);\\n }\\n}\\npublic ValidatableObject<string> Password\\n{\\n get\\n {\\n return _passwo\", \"rd;\\n }\\n set\\n {\\n _password = value;\\n RaisePropertyChanged(() => Password);\\n }\\n} \\nFor validation to oc\", \"cur, validation rules must be added to the Validations collection of each \\nValidatableObject<T> inst\", \"ance, as demonstrated in the following code example:39 CHAPTER 6 | Validation\\nprivate void AddValida\", \"tions()\\n{\\n _userName.Validations.Add(new IsNotNullOrEmptyRule<string>\\n {\\n ValidationMessage = \\\"A use\", \"rname is required.\\\"\\n });\\n _password.Validations.Add(new IsNotNullOrEmptyRule<string>\\n {\\n ValidationM\", \"essage = \\\"A password is required.\\\"\\n });\\n}\\nThis method adds the IsNotNullOrEmptyRule<T> validation ru\", \"le to the Validations collection of \\neach ValidatableObject<T> instance, specifying values for the v\", \"alidation rule's ValidationMessage\\nproperty, which specifies the validation error message that will \", \"be displayed if validation fails.\\nTriggering validation\\nThe validation approach used in the eShopOnC\", \"ontainers mobile app can manually trigger validation \\nof a property, and automatically trigger valid\", \"ation when a property changes.\\nTriggering validation manually\\nValidation can be triggered manually f\", \"or a view model property. For example, this occurs in the \\neShopOnContainers mobile app when the use\", \"r taps the Login button on the LoginView, when using \\nmock services. The command delegate calls the \", \"MockSignInAsync method in the LoginViewModel, \\nwhich invokes validation by executing the Validate me\", \"thod, which is shown in the following code \\nexample:\\nprivate bool Validate()\\n{\\n bool isValidUser = V\", \"alidateUserName();\\n bool isValidPassword = ValidatePassword();\\n return isValidUser && isValidPasswor\", \"d;\\n}\\nprivate bool ValidateUserName()\\n{\\n return _userName.Validate();\\n}\\nprivate bool ValidatePassword\", \"()\\n{\\n return _password.Validate();\\n} \\nThe Validate method performs validation of the username and pa\", \"ssword entered by the user on the \\nLoginView, by invoking the Validate method on each ValidatableObj\", \"ect<T> instance. The \\nfollowing code example shows the Validate method from the ValidatableObject<T>\", \" class:\\npublic bool Validate()\\n{\\n Errors.Clear();\\n IEnumerable<string> errors = _validations\\n .Where\", \"(v => !v.Check(Value))\\n .Select(v => v.ValidationMessage);40 CHAPTER 6 | Validation\\n Errors = errors\", \".ToList();\\n IsValid = !Errors.Any();\\n return this.IsValid;\\n} \\nThis method clears the Errors collecti\", \"on, and then retrieves any validation rules that were added to \\nthe object's Validations collection.\", \" The Check method for each retrieved validation rule is executed, \\nand the ValidationMessage propert\", \"y value for any validation rule that fails to validate the data is \\nadded to the Errors collection o\", \"f the ValidatableObject<T> instance. Finally, the IsValid property \\nis set, and its value is returne\", \"d to the calling method, indicating whether validation succeeded or \\nfailed.\\nTriggering validation w\", \"hen properties change\\nValidation is also automatically triggered whenever a bound property changes. \", \"For example, when a \\ntwo-way binding in the LoginView sets the UserName or Password property, valida\", \"tion is triggered. \\nThe following code example demonstrates how this occurs:\\n<Entry Text=\\\"{Binding U\", \"serName.Value, Mode=TwoWay}\\\">\\n <Entry.Behaviors>\\n <behaviors:EventToCommandBehavior\\n EventName=\\\"Text\", \"Changed\\\"\\n Command=\\\"{Binding ValidateUserNameCommand}\\\" />\\n </Entry.Behaviors>\\n ...\\n</Entry>\\nThe Entry\", \" control binds to the UserName.Value property of the ValidatableObject<T> instance, \\nand the control\", \"'s Behaviors collection has an EventToCommandBehavior instance added to it. This \\nbehavior executes \", \"the ValidateUserNameCommand in response to the TextChanged event firing on \\nthe Entry, which is rais\", \"ed when the text in the Entry changes. In turn, the \\nValidateUserNameCommand delegate executes the V\", \"alidateUserName method, which executes the \\nValidate method on the ValidatableObject<T> instance. Th\", \"erefore, every time the user enters a \\ncharacter in the Entry control for the username, validation o\", \"f the entered data is performed.\\nFor more information about behaviors, see Implementing behaviors.\\nD\", \"isplaying validation errors\\nThe eShopOnContainers mobile app notifies the user of any validation err\", \"ors by highlighting the \\ncontrol that contains the invalid data with a red line, and by displaying a\", \"n error message that informs \\nthe user why the data is invalid below the control containing the inva\", \"lid data. When the invalid data is \\ncorrected, the line changes to black and the error message is re\", \"moved. Figure 6-2 shows the \\nLoginView in the eShopOnContainers mobile app when validation errors ar\", \"e present.41 CHAPTER 6 | Validation\\nFigure 6-2: Displaying validation errors during login\\nHighlighti\", \"ng a control that contains invalid data\\nThe LineColorBehavior attached behavior is used to highlight\", \" Entry controls where validation \\nerrors have occurred. The following code example shows how the Lin\", \"eColorBehavior attached \\nbehavior is attached to an Entry control:\\n<Entry Text=\\\"{Binding UserName.Va\", \"lue, Mode=TwoWay}\\\">\\n <Entry.Style>\\n <OnPlatform x:TypeArguments=\\\"Style\\\"\\n iOS=\\\"{StaticResource EntryS\", \"tyle}\\\"\\n Android=\\\"{StaticResource EntryStyle}\\\"\\n WinPhone=\\\"{StaticResource UwpEntryStyle}\\\"/>\\n </Entry.\", \"Style>\\n ...\\n</Entry>\\nThe Entry control consumes an explicit style, which is shown in the following c\", \"ode example:\\n<Style x:Key=\\\"EntryStyle\\\"\\n TargetType=\\\"{x:Type Entry}\\\">\\n ...\\n <Setter Property=\\\"behavio\", \"rs:LineColorBehavior.ApplyLineColor\\\"\\n Value=\\\"True\\\" />\\n <Setter Property=\\\"behaviors:LineColorBehavior\", \".LineColor\\\"\\n Value=\\\"{StaticResource BlackColor}\\\" />\\n ...\\n</Style>\\nThis style sets the ApplyLineColor\", \" and LineColor attached properties of the LineColorBehavior\\nattached behavior on the Entry control. \", \"For more information about styles, see Styles on the Xamarin \\nDeveloper Center.\\nWhen the value of th\", \"e ApplyLineColor attached property is set, or changes, the LineColorBehavior\\nattached behavior execu\", \"tes the OnApplyLineColorChanged method, which is shown in the following \\ncode example: 42 CHAPTER 6 \", \"| Validation\\npublic static class LineColorBehavior\\n{\\n ...\\n private static void OnApplyLineColorChang\", \"ed(\\n BindableObject bindable, object oldValue, object newValue)\\n {\\n var view = bindable as View;\\n if\", \" (view == null)\\n {\\n return;\\n }\\n bool hasLine = (bool)newValue;\\n if (hasLine)\\n {\\n view.Effects.Add(ne\", \"w EntryLineColorEffect());\\n }\\n else\\n {\\n var entryLineColorEffectToRemove =\\n view.Effects.FirstOrDefa\", \"ult(e => e is EntryLineColorEffect);\\n if (entryLineColorEffectToRemove != null)\\n {\\n view.Effects.Rem\", \"ove(entryLineColorEffectToRemove);\\n }\\n }\\n }\\n}\\nThe parameters for this method provide the instance of\", \" the control that the behavior is attached to, \\nand the old and new values of the ApplyLineColor att\", \"ached property. The EntryLineColorEffect\\nclass is added to the control's Effects collection if the A\", \"pplyLineColor attached property is true, \\notherwise it's removed from the control's Effects collecti\", \"on. For more information about behaviors, \\nsee Implementing behaviors.\\nThe EntryLineColorEffect subc\", \"lasses the RoutingEffect class, and is shown in the following code \\nexample:\\npublic class EntryLineC\", \"olorEffect : RoutingEffect\\n{\\n public EntryLineColorEffect() : base(\\\"eShopOnContainers.EntryLineColor\", \"Effect\\\")\\n {\\n }\\n}\\nThe RoutingEffect class represents a platform-independent effect that wraps an inne\", \"r effect that's \\nplatform-specific. This simplifies the effect removal process, since there is no co\", \"mpile-time access to \\nthe type information for a platform-specific effect. The EntryLineColorEffect \", \"calls the base class \\nconstructor, passing in a parameter consisting of a concatenation of the resol\", \"ution group name, and \\nthe unique ID that's specified on each platform-specific effect class. \\nThe f\", \"ollowing code example shows the eShopOnContainers.EntryLineColorEffect implementation for \\niOS:\\n[ass\", \"embly: ResolutionGroupName(\\\"eShopOnContainers\\\")]\\n[assembly: ExportEffect(typeof(EntryLineColorEffect\", \"), \\\"EntryLineColorEffect\\\")]\\nnamespace eShopOnContainers.iOS.Effects\\n{\\n public class EntryLineColorEf\", \"fect : PlatformEffect43 CHAPTER 6 | Validation\\n {\\n UITextField control;\\n protected override void OnA\", \"ttached()\\n {\\n try\\n {\\n control = Control as UITextField;\\n UpdateLineColor();\\n }\\n catch (Exception ex)\", \"\\n {\\n Console.WriteLine(\\\"Can't set property on attached control. Error: \\\", ex.Message);\\n }\\n }\\n protec\", \"ted override void OnDetached()\\n {\\n control = null;\\n }\\n protected override void OnElementPropertyChan\", \"ged(PropertyChangedEventArgs args)\\n {\\n base.OnElementPropertyChanged(args);\\n if (args.PropertyName =\", \"= LineColorBehavior.LineColorProperty.PropertyName ||\\n args.PropertyName == \\\"Height\\\")\\n {\\n Initialize\", \"();\\n UpdateLineColor();\\n }\\n }\\n private void Initialize()\\n {\\n var entry = Element as Entry;\\n if (entr\", \"y != null)\\n {\\n Control.Bounds = new CGRect(0, 0, entry.Width, entry.Height);\\n }\\n }\\n private void Upd\", \"ateLineColor()\\n {\\n BorderLineLayer lineLayer = control.Layer.Sublayers.OfType<BorderLineLayer>()\\n .F\", \"irstOrDefault();\\n if (lineLayer == null)\\n {\\n lineLayer = new BorderLineLayer();\\n lineLayer.MasksToBo\", \"unds = true;\\n lineLayer.BorderWidth = 1.0f;\\n control.Layer.AddSublayer(lineLayer);\\n control.BorderSt\", \"yle = UITextBorderStyle.None;\\n }\\n lineLayer.Frame = new CGRect(0f, Control.Frame.Height-1f, Control.\", \"Bounds.Width, 1f);\\n lineLayer.BorderColor = LineColorBehavior.GetLineColor(Element).ToCGColor();\\n co\", \"ntrol.TintColor = control.TextColor;\\n }\\n private class BorderLineLayer : CALayer\\n {\\n }44 CHAPTER 6 |\", \" Validation\\n }\\n}\\nThe OnAttached method retrieves the native control for the Xamarin.Forms Entry cont\", \"rol, and \\nupdates the line color by calling the UpdateLineColor method. The OnElementPropertyChanged\", \"\\noverride responds to bindable property changes on the Entry control by updating the line color if t\", \"he \\nattached LineColor property changes, or the Height property of the Entry changes. For more \\ninfo\", \"rmation about effects, see Effects on the Xamarin Developer Center.\\nWhen valid data is entered in th\", \"e Entry control, it will apply a black line to the bottom of the control, \\nto indicate that there is\", \" no validation error. Figure 6-3 shows an example of this.\\nFigure 6-3: Black line indicating no vali\", \"dation error\\nThe Entry control also has a DataTrigger added to its Triggers collection. The followin\", \"g code \\nexample shows the DataTrigger:\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\">\\n ...\\n <E\", \"ntry.Triggers>\\n <DataTrigger\\n TargetType=\\\"Entry\\\"\\n Binding=\\\"{Binding UserName.IsValid}\\\"\\n Value=\\\"False\", \"\\\">\\n <Setter Property=\\\"behaviors:LineColorBehavior.LineColor\\\"\\n Value=\\\"{StaticResource ErrorColor}\\\" />\", \"\\n </DataTrigger>\\n </Entry.Triggers>\\n</Entry>\\nThis DataTrigger monitors the UserName.IsValid property\", \", and if it's value becomes false, it \\nexecutes the Setter, which changes the LineColor attached pro\", \"perty of the LineColorBehavior\\nattached behavior to red. Figure 6-4 shows an example of this.\\nFigure\", \" 6-4: Red line indicating validation error\\nThe line in the Entry control will remain red while the e\", \"ntered data is invalid, otherwise it will change \\nto black to indicate that the entered data is vali\", \"d.\\nFor more information about Triggers, see Triggers on the Xamarin Developer Center.\\nDisplaying err\", \"or messages\\nThe UI displays validation error messages in Label controls below each control whose dat\", \"a failed \\nvalidation. The following code example shows the Label that displays a validation error me\", \"ssage if \\nthe user has not entered a valid username:45 CHAPTER 6 | Validation\\n<Label Text=\\\"{Binding \", \"UserName.Errors, Converter={StaticResource FirstValidationErrorConverter}\\\"\\n Style=\\\"{StaticResource V\", \"alidationErrorLabelStyle}\\\" />\\nEach Label binds to the Errors property of the view model object that'\", \"s being validated. The Errors\\nproperty is provided by the ValidatableObject<T> class, and is of type\", \" List<string>. Because the \\nErrors property can contain multiple validation errors, the FirstValidat\", \"ionErrorConverter\\ninstance is used to retrieve the first error from the collection for display.\\nSumm\", \"ary\\nThe eShopOnContainers mobile app performs synchronous client-side validation of view model \\nprop\", \"erties and notifies the user of any validation errors by highlighting the control that contains the \", \"\\ninvalid data, and by displaying error messages that inform the user why the data is invalid. \\nView \", \"model properties that require validation are of type ValidatableObject<T>, and each \\nValidatableObje\", \"ct<T> instance has validation rules added to its Validations property. Validation \\nis invoked from t\", \"he view model by calling the Validate method of the ValidatableObject<T>\\ninstance, which retrieves t\", \"he validation rules and executes them against the ValidatableObject<T>\\nValue property. Any validatio\", \"n errors are placed into the Errors property of the \\nValidatableObject<T> instance, and the IsValid \", \"property of the ValidatableObject<T> instance \\nis updated to indicate whether validation succeeded o\", \"r failed.46 CHAPTER 7 | Configuration management\\nC H A P T E R 7\\nConfiguration \\nmanagement\\nSettings \", \"allow the separation of data that configures the behavior of an app from the code, allowing \\nthe beh\", \"avior to be changed without rebuilding the app. There are two types of settings: app settings, \\nand \", \"user settings.\\nApp settings are data that an app creates and manages. It can include data such as fi\", \"xed web service \\nendpoints, API keys, and runtime state. App settings are tied to the existence of t\", \"he app and are only \\nmeaningful to that app.\\nUser settings are the customizable settings of an app t\", \"hat affect the behavior of the app and don't \\nrequire frequent re-adjustment. For example, an app mi\", \"ght let the user specify where to retrieve data \\nfrom, and how to display it on the screen.\\nXamarin.\", \"Forms includes a persistent dictionary that can be used to store settings data. This dictionary \\ncan\", \" be accessed using the Application.Current.Properties property, and any data that's placed \\ninto it \", \"is saved when the app goes into a sleep state, and is restored when the app resumes or starts \\nup ag\", \"ain. In addition, the Application class also has a SavePropertiesAsync method that allows an \\napp to\", \" have its settings saved when required. For more information about this dictionary, see \\nProperties \", \"Dictionary on the Xamarin Developer Center.\\nA downside to storing data using the Xamarin.Forms persi\", \"stent dictionary is that it's not easily data \\nbound to. Therefore, the eShopOnContainers mobile app\", \" uses the Xam.Plugins.Settings library, \\navailable from NuGet. This library provides a consistent, t\", \"ype-safe, cross-platform approach for \\npersisting and retrieving app and user settings, while using \", \"the native settings management provided \\nby each platform. In addition, it's straightforward to use \", \"data binding to access settings data exposed \\nby the library.\\nNote: While the Xam.Plugin.Settings li\", \"brary can store both app and user settings, it makes no \\ndistinction between the two.\\nCreating a set\", \"tings class\\nWhen using the Xam.Plugins.Settings library, a single static class should be created tha\", \"t will contain \\nthe app and user settings required by the app. The following code example shows the \", \"Settings class \\nin the eShopOnContainers mobile app:47 CHAPTER 7 | Configuration management\\npublic s\", \"tatic class Settings\\n{\\n private static ISettings AppSettings\\n {\\n get\\n {\\n return CrossSettings.Curren\", \"t;\\n }\\n }\\n ...\\n} \\nSettings can be read and written through the ISettings API, which is provided by th\", \"e \\nXam.Plugins.Settings library. This library provides a singleton that can be used to access the AP\", \"I, \\nCrossSettings.Current, and an app's settings class should expose this singleton via an ISettings\", \"\\nproperty.\\nNote: Using directives for the Plugin.Settings and Plugin.Settings.Abstractions\\nnamespace\", \"s should be added to a class that requires access to the Xam.Plugins.Settings library \\ntypes.\\nAdding\", \" a setting\\nEach setting consists of a key, a default value, and a property. The following code examp\", \"le shows all \\nthree items for a user setting that represents the base URL for the online services th\", \"at the \\neShopOnContainers mobile app connects to:\\npublic static class Settings\\n{\\n ...\\n private const\", \" string IdUrlBase = \\\"url_base\\\";\\n private static readonly string UrlBaseDefault = GlobalSetting.Insta\", \"nce.BaseEndpoint;\\n ...\\n public static string UrlBase\\n {\\n get\\n {\\n return AppSettings.GetValueOrDefaul\", \"t<string>(IdUrlBase, UrlBaseDefault);\\n }\\n set\\n {\\n AppSettings.AddOrUpdateValue<string>(IdUrlBase, va\", \"lue);\\n }\\n }\\n}\\nThe key is always a const string that defines the key name, with the default value for\", \" the setting \\nbeing a static readonly value of the required type. Providing a default value ensures \", \"that a valid \\nvalue is available if an unset setting is retrieved.\\nThe UrlBase static property uses \", \"two methods from the ISettings API to read or write the setting \\nvalue. The ISettings.GetValueOrDefa\", \"ult method is used to retrieve a setting's value from \\nplatform-specific storage. If no value is def\", \"ined for the setting, its default value is retrieved instead. \\nSimilarly, the ISettings.AddOrUpdateV\", \"alue method is used to persist a setting's value to platform\\u0002specific storage.48 CHAPTER 7 | Configu\", \"ration management\\nRather that define a default value inside the Settings class, the UrlBaseDefault s\", \"tring obtains its \\nvalue from the GlobalSetting class. The following code example shows the BaseEndp\", \"oint property \\nand UpdateEndpoint method in this class:\\npublic class GlobalSetting\\n{\\n ...\\n public st\", \"ring BaseEndpoint\\n {\\n get { return _baseEndpoint; }\\n set\\n {\\n _baseEndpoint = value;\\n UpdateEndpoint(\", \"_baseEndpoint);\\n }\\n }\\n ...\\n private void UpdateEndpoint(string baseEndpoint)\\n {\\n RegisterWebsite = s\", \"tring.Format(\\\"{0}:5105/Account/Register\\\", baseEndpoint);\\n CatalogEndpoint = string.Format(\\\"{0}:5101\\\"\", \", baseEndpoint);\\n OrdersEndpoint = string.Format(\\\"{0}:5102\\\", baseEndpoint);\\n BasketEndpoint = string\", \".Format(\\\"{0}:5103\\\", baseEndpoint);\\n IdentityEndpoint = string.Format(\\\"{0}:5105/connect/authorize\\\", b\", \"aseEndpoint);\\n UserInfoEndpoint = string.Format(\\\"{0}:5105/connect/userinfo\\\", baseEndpoint);\\n TokenEn\", \"dpoint = string.Format(\\\"{0}:5105/connect/token\\\", baseEndpoint);\\n LogoutEndpoint = string.Format(\\\"{0}\", \":5105/connect/endsession\\\", baseEndpoint);\\n IdentityCallback = string.Format(\\\"{0}:5105/xamarincallbac\", \"k\\\", baseEndpoint);\\n LogoutCallback = string.Format(\\\"{0}:5105/Account/Redirecting\\\", baseEndpoint); \\n \", \"}\\n}\\nEach time the BaseEndpoint property is set, the UpdateEndpoint method is called. This method \\nup\", \"dates a series of properties, all of which are based on the UrlBase user setting that's provided by \", \"\\nthe Settings class that represent different endpoints that the eShopOnContainers mobile app \\nconnec\", \"ts to.\\nData binding to user settings\\nIn the eShopOnContainers mobile app, the SettingsView exposes t\", \"wo user settings. These settings \\nallow configuration of whether the app should retrieve data from m\", \"icroservices that are deployed as \\nDocker containers, or whether the app should retrieve data from m\", \"ock services that don't require an \\ninternet connection. When choosing to retrieve data from contain\", \"erized microservices, a base \\nendpoint URL for the microservices must be specified. Figure 7-1 shows\", \" the SettingsView when the \\nuser has chosen to retrieve data from containerized microservices.49 CHA\", \"PTER 7 | Configuration management\\nFigure 7-1: User settings exposed by the eShopOnContainers mobile \", \"app\\nData binding can be used to retrieve and set settings exposed by the Settings class. This is ach\", \"ieved \\nby controls on the view binding to view model properties that in turn access properties in th\", \"e \\nSettings class, and raising a property changed notification if the settings value has changed. Fo\", \"r \\ninformation about how the eShopOnContainers mobile app constructs view models and associates \\nthe\", \"m to views, see Automatically creating a view model with a view model locator.\\nThe following code ex\", \"ample shows the Entry control from the SettingsView that allows the user to \\nenter a base endpoint U\", \"RL for the containerized microservices:\\n<Entry Text=\\\"{Binding Endpoint, Mode=TwoWay}\\\" />\\nThis Entry \", \"control binds to the Endpoint property of the SettingsViewModel class, using a two-way \\nbinding. The\", \" following code example shows the Endpoint property:\\npublic string Endpoint\\n{\\n get { return _endpoin\", \"t; }\\n set\\n {\\n _endpoint = value;\\n if(!string.IsNullOrEmpty(_endpoint))\\n {\\n UpdateEndpoint(_endpoint)\", \";\\n }\\n RaisePropertyChanged(() => Endpoint);\\n }\\n}\\nWhen the Endpoint property is set the UpdateEndpoin\", \"t method is called, provided that the supplied \\nvalue is valid, and property changed notification is\", \" raised. The following code example shows the \\nUpdateEndpoint method:\\nprivate void UpdateEndpoint(st\", \"ring endpoint)\\n{\\n Settings.UrlBase = endpoint;\\n}50 CHAPTER 7 | Configuration management\\nThis method \", \"updates the UrlBase property in the Settings class with the base endpoint URL value \\nentered by the \", \"user, which causes it to be persisted to platform-specific storage.\\nWhen the SettingsView is navigat\", \"ed to, the InitializeAsync method in the SettingsViewModel\\nclass is executed. The following code exa\", \"mple shows this method:\\npublic override Task InitializeAsync(object navigationData)\\n{\\n ...\\n Endpoint\", \" = Settings.UrlBase;\\n ...\\n}\\nThe method sets the Endpoint property to the value of the UrlBase proper\", \"ty in the Settings class. \\nAccessing the UrlBase property causes the Xam.Plugins.Settings library to\", \" retrieve the settings value \\nfrom platform-specific storage. For information about how the Initiali\", \"zeAsync method is invoked, \\nsee Passing parameters during navigation.\\nThis mechanism ensures that wh\", \"enever a user navigates to the SettingsView, user settings are \\nretrieved from platform-specific sto\", \"rage and presented through data binding. Then, if the user \\nchanges the settings values, data bindin\", \"g ensures that they are immediately persisted back to \\nplatform-specific storage.\\nSummary\\nSettings a\", \"llow the separation of data that configures the behavior of an app from the code, allowing \\nthe beha\", \"vior to be changed without rebuilding the app. App settings are data that an app creates and \\nmanage\", \"s, and user settings are the customizable settings of an app that affect the behavior of the app \\nan\", \"d don't require frequent re-adjustment.\\nThe Xam.Plugins.Settings library provides a consistent, type\", \"-safe, cross-platform approach for \\npersisting and retrieving app and user settings, and data bindin\", \"g can be used to access settings \\ncreated with the library.51 CHAPTER 8 | Containerized microservice\", \"s\\nC H A P T E R 8\\nContainerized \\nmicroservices\\nDeveloping client-server applications has resulted in\", \" a focus on building tiered applications that use \\nspecific technologies in each tier. Such applicat\", \"ions are often referred to as monolithic applications, \\nand are packaged onto hardware pre-scaled fo\", \"r peak loads. The main drawbacks of this development \\napproach are the tight coupling between compon\", \"ents within each tier, that individual components \\ncan't be easily scaled, and the cost of testing. \", \"A simple update can have unforeseen effects on the rest \\nof the tier, and so a change to an applicat\", \"ion component requires its entire tier to be retested and \\nredeployed.\\nParticularly concerning in th\", \"e age of the cloud, is that individual components can't be easily scaled. A \\nmonolithic application \", \"contains domain-specific functionality, and is typically divided by functional \\nlayers such as front\", \" end, business logic, and data storage. A monolithic application is scaled by \\ncloning the entire ap\", \"plication onto multiple machines, as illustrated in Figure 8-1.\\nFigure 8-1: Monolithic application s\", \"caling approach52 CHAPTER 8 | Containerized microservices\\nMicroservices\\nMicroservices offer a differ\", \"ent approach to application development and deployment, an approach \\nthat's suited to the agility, s\", \"cale, and reliability requirements of modern cloud applications. A \\nmicroservices application is dec\", \"omposed into independent components that work together to deliver \\nthe application's overall functio\", \"nality. The term microservice emphasizes that applications should be \\ncomposed of services small eno\", \"ugh to reflect independent concerns, so that each microservice \\nimplements a single function. In add\", \"ition, each microservice has well-defined contracts so that other \\nmicroservices can communicate and\", \" share data with it. Typical examples of microservices include \\nshopping carts, inventory processing\", \", purchase subsystems, and payment processing.\\nMicroservices can scale-out independently, as compare\", \"d to giant monolithic applications that scale \\ntogether. This means that a specific functional area,\", \" that requires more processing power or network \\nbandwidth to support demand, can be scaled rather t\", \"han unnecessarily scaling-out other areas of the \\napplication. Figure 8-2 illustrates this approach,\", \" where microservices are deployed and scaled \\nindependently, creating instances of services across m\", \"achines.\\nFigure 8-2: Microservices application scaling approach\\nMicroservice scale-out can be nearly\", \" instantaneous, allowing an application to adapt to changing \\nloads. For example, a single microserv\", \"ice in the web-facing functionality of an application might be \\nthe only microservice in the applica\", \"tion that needs to scale out to handle additional incoming traffic.\\nThe classic model for applicatio\", \"n scalability is to have a load-balanced, stateless tier with a shared \\nexternal datastore to store \", \"persistent data. Stateful microservices manage their own persistent data, \\nusually storing it locall\", \"y on the servers on which they are placed, to avoid the overhead of network \\naccess and complexity o\", \"f cross-service operations. This enables the fastest possible processing of data \\nand can eliminate \", \"the need for caching systems. In addition, scalable stateful microservices usually \\npartition data a\", \"mong their instances, in order to manage data size and transfer throughput beyond \\nwhich a single se\", \"rver can support.\\nMicroservices also support independent updates. This loose coupling between micros\", \"ervices provides \\na rapid and reliable application evolution. Their independent, distributed nature \", \"supports rolling \\nupdates, where only a subset of instances of a single microservice will update at \", \"any given time. \\nTherefore, if a problem is detected, a buggy update can be rolled back, before all \", \"instances update \\nwith the faulty code or configuration. Similarly, microservices typically use sche\", \"ma versioning, so that 53 CHAPTER 8 | Containerized microservices\\nclients see a consistent version w\", \"hen updates are being applied, regardless of which microservice \\ninstance is being communicated with\", \".\\nTherefore, microservice applications have many benefits over monolithic applications:\\n\\u2022 Each micro\", \"service is relatively small, easy to manage and evolve.\\n\\u2022 Each microservice can be developed and dep\", \"loyed independently of other services.\\n\\u2022 Each microservice can be scaled-out independently. For exam\", \"ple, a catalog service or \\nshopping basket service might need to be scaled-out more than an ordering\", \" service. \\nTherefore, the resulting infrastructure will more efficiently consume resources when scal\", \"ing \\nout.\\n\\u2022 Each microservice isolates any issues. For example, if there is an issue in a service it\", \" only \\nimpacts that service. The other services can continue to handle requests.\\n\\u2022 Each microservice\", \" can use the latest technologies. Because microservices are autonomous and \\nrun side-by-side, the la\", \"test technologies and frameworks can be used, rather than being \\nforced to use an older framework th\", \"at might be used by a monolithic application.\\nHowever, a microservice based solution also has potent\", \"ial drawbacks:\\n\\u2022 Choosing how to partition an application into microservices can be challenging, as \", \"each \\nmicroservice has to be completely autonomous, end-to-end, including responsibility for its \\nda\", \"ta sources.\\n\\u2022 Developers must implement inter-service communication, which adds complexity and laten\", \"cy \\nto the application.\\n\\u2022 Atomic transactions between multiple microservices usually aren't possible\", \". Therefore, \\nbusiness requirements must embrace eventual consistency between microservices.\\n\\u2022 In pr\", \"oduction, there is an operational complexity in deploying and managing a system \\ncompromised of many\", \" independent services.\\n\\u2022 Direct client-to-microservice communication can make it difficult to refact\", \"or the contracts of \\nmicroservices. For example, over time how the system is partitioned into servic\", \"es might need \\nto change. A single service might split into two or more services, and two services m\", \"ight\\nmerge. When clients communicate directly with microservices, this refactoring work can break \\nc\", \"ompatibility with client apps.\\nContainerization\\nContainerization is an approach to software developm\", \"ent in which an application and its versioned set \\nof dependencies, plus its environment configurati\", \"on abstracted as deployment manifest files, are \\npackaged together as a container image, tested as a\", \" unit, and deployed to a host operating system. \\nA container is an isolated, resource controlled, an\", \"d portable operating environment, where an \\napplication can run without touching the resources of ot\", \"her containers, or the host. Therefore, a \\ncontainer looks and acts like a newly installed physical \", \"computer or a virtual machine.\\nThere are many similarities between containers and virtual machines, \", \"as illustrated in Figure 8-3.54 CHAPTER 8 | Containerized microservices\\nFigure 8-3: Comparison of vi\", \"rtual machines and containers\\nA container runs an operating system, has a file system, and can be ac\", \"cessed over a network as if it \\nwere a physical or virtual machine. However, the technology and conc\", \"epts used by containers are very \\ndifferent from virtual machines. Virtual machines include the appl\", \"ications, the required dependencies, \\nand a full guest operating system. Containers include the appl\", \"ication and its dependencies, but share \\nthe operating system with other containers, running as isol\", \"ated processes on the host operating \\nsystem (aside from Hyper-V containers which run inside of a sp\", \"ecial virtual machine per container). \\nTherefore, containers share resources and typically require f\", \"ewer resources than virtual machines.\\nThe advantage of a container-oriented development and deployme\", \"nt approach is that it eliminates \\nmost of the issues that arise from inconsistent environment setup\", \"s and the problems that come with \\nthem. In addition, containers permit fast application scale-up fu\", \"nctionality by instancing new \\ncontainers as required.\\nThe key concepts when creating and working wi\", \"th containers are:\\n\\u2022 Container Host: The physical or virtual machine configured to host containers. \", \"The container \\nhost will run one or more containers.\\n\\u2022 Container Image: An image consists of a union\", \" of layered filesystems stacked on top of each \\nother, and is the basis of a container. An image doe\", \"s not have state and it never changes as \\nit's deployed to different environments.\\n\\u2022 Container: A co\", \"ntainer is a runtime instance of an image.\\n\\u2022 Container OS Image: Containers are deployed from images\", \". The container operating system \\nimage is the first layer in potentially many image layers that mak\", \"e up a container. A container \\noperating system is immutable, and can't be modified.\\n\\u2022 Container Rep\", \"ository: Each time a container image is created, the image and its dependencies \\nare stored in a loc\", \"al repository. These images can be reused many times on the container \\nhost. The container images ca\", \"n also be stored in a public or private registry, such as Docker \\nHub, so that they can be used acro\", \"ss different container hosts.55 CHAPTER 8 | Containerized microservices\\nEnterprises are increasingly\", \" adopting containers when implementing microservice based applications, \\nand Docker has become the s\", \"tandard container implementation that has been adopted by most \\nsoftware platforms and cloud vendors\", \".\\nThe eShopOnContainers reference application uses Docker to host four containerized back-end \\nmicro\", \"services, as illustrated in Figure 8-4.\\nFigure 8-4: eShopOnContainers reference application back-end\", \" microservices\\nThe architecture of the back-end services in the reference application is decomposed \", \"into multiple \\nautonomous sub-systems in the form of collaborating microservices and containers. Eac\", \"h microservice \\nprovides a single area of functionality: an identity service, a catalog service, an \", \"ordering service, and a \\nbasket service.\\nEach microservice has its own database, allowing it to be f\", \"ully decoupled from the other \\nmicroservices. Where necessary, consistency between databases from di\", \"fferent microservices is \\nachieved using application-level events. For more information, see Communi\", \"cation between \\nmicroservices.\\nFor more information about the reference application, see .NET Micros\", \"ervices: Architecture for \\nContainerized .NET Applications.\\nCommunication between client and microse\", \"rvices\\nThe eShopOnContainers mobile app communicates with the containerized back-end microservices \\n\", \"using direct client-to-microservice communication, which is shown in Figure 8-5.56 CHAPTER 8 | Conta\", \"inerized microservices\\nFigure 8-5: Direct client-to-microservice communication\\nWith direct client-to\", \"-microservice communication, the mobile app makes requests to each \\nmicroservice directly through it\", \"s public endpoint, with a different TCP port per microservice. In \\nproduction, the endpoint would ty\", \"pically map to the microservice's load balancer, which distributes \\nrequests across the available in\", \"stances.\\nTip: Consider using API gateway communication\\nDirect client-to-microservice communication c\", \"an have drawbacks when building a large and \\ncomplex microservice based application, but it's more t\", \"han adequate for a small application. When \\ndesigning a large microservice based application with te\", \"ns of microservices, consider using API \\ngateway communication. For more information, see .NET Micro\", \"services: Architecture for \\nContainerized .NET Applications.\\nCommunication between microservices\\nA m\", \"icroservices based application is a distributed system, potentially running on multiple machines. \\nE\", \"ach service instance is typically a process. Therefore, services must interact using an inter-proces\", \"s \\ncommunication protocol, such as HTTP, TCP, Advanced Message Queuing Protocol (AMQP), or binary \\np\", \"rotocols, depending on the nature of each service.\\nThe two common approaches for microservice-to-mic\", \"roservice communication are HTTP based REST \\ncommunication when querying for data, and lightweight a\", \"synchronous messaging when \\ncommunicating updates across multiple microservices.\\nAsynchronous messag\", \"ing based event-driven communication is critical when propagating changes \\nacross multiple microserv\", \"ices. With this approach, a microservice publishes an event when something \\nnotable happens, for exa\", \"mple, when it updates a business entity. Other microservices subscribe to \\nthese events. Then, when \", \"a microservice receives an event, it updates its own business entities, which \\nmight in turn lead to\", \" more events being published. This publish-subscribe functionality is usually \\nachieved with an even\", \"t bus.\\nAn event bus allows publish-subscribe communication between microservices, without requiring \", \"the \\ncomponents to be explicitly aware of each other, as shown in Figure 8-6.57 CHAPTER 8 | Containe\", \"rized microservices\\nFigure 8-6: Publish-subscribe with an event bus\\nFrom an application perspective,\", \" the event bus is simply a publish-subscribe channel exposed via an \\ninterface. However, the way the\", \" event bus is implemented can vary. For example, an event bus \\nimplementation could use RabbitMQ, Az\", \"ure Service Bus, or other service buses such as NServiceBus \\nand MassTransit. Figure 8-7 shows how a\", \"n event bus is used in the eShopOnContainers reference \\napplication.\\nFigure 8-7: Asynchronous event-\", \"driven communication in the reference application\\nThe eShopOnContainers event bus, implemented using\", \" RabbitMQ, provides one-to-many \\nasynchronous publish-subscribe functionality. This means that after\", \" publishing an event, there can be \\nmultiple subscribers listening for the same event. Figure 8-9 il\", \"lustrates this relationship.58 CHAPTER 8 | Containerized microservices\\nFigure 8-9: One-to-many commu\", \"nication\\nThis one-to-many communication approach uses events to implement business transactions that\", \" span \\nmultiple services, ensuring eventual consistency between the services. An eventual-consistent\", \" \\ntransaction consists of a series of distributed steps. Therefore, when the user-profile microservi\", \"ce \\nreceives the UpdateUser command, it updates the user's details in its database and publishes the\", \" \\nUserUpdated event to the event bus. Both the basket microservice and the ordering microservice \\nha\", \"ve subscribed to receive this event, and in response update their buyer information in their \\nrespec\", \"tive databases.\\nNote: The eShopOnContainers event bus, implemented using RabbitMQ, is intended to be\", \" used \\nonly as a proof of concept. For production systems, alternative event bus implementations sho\", \"uld \\nbe considered.\\nFor information about the event bus implementation, see .NET Microservices: Arch\", \"itecture for \\nContainerized .NET Applications.\\nSummary\\nMicroservices offer an approach to applicatio\", \"n development and deployment that's suited to the \\nagility, scale, and reliability requirements of m\", \"odern cloud applications. One of the main advantages \\nof microservices is that they can be scaled-ou\", \"t independently, which means that a specific functional \\narea can be scaled that requires more proce\", \"ssing power or network bandwidth to support demand, \\nwithout unnecessarily scaling areas of the appl\", \"ication that are not experiencing increased demand.\\nA container is an isolated, resource controlled,\", \" and portable operating environment, where an \\napplication can run without touching the resources of\", \" other containers, or the host. Enterprises are \\nincreasingly adopting containers when implementing \", \"microservice based applications, and Docker has \\nbecome the standard container implementation that h\", \"as been adopted by most software platforms \\nand cloud vendors.59 CHAPTER 9 | Authentication and auth\", \"orization\\nC H A P T E R 9\\nAuthentication \\nand authorization\\nAuthentication is the process of obtaini\", \"ng identification credentials such as name and password from \\na user, and validating those credentia\", \"ls against an authority. If the credentials are valid, the entity that \\nsubmitted the credentials is\", \" considered an authenticated identity. Once an identity has been \\nauthenticated, an authorization pr\", \"ocess determines whether that identity has access to a given \\nresource.\\nThere are many approaches to\", \" integrating authentication and authorization into a Xamarin.Forms app \\nthat communicates with an AS\", \"P.NET MVC web application, including using ASP.NET Core Identity, \\nexternal authentication providers\", \" such as Microsoft, Google, Facebook, or Twitter, and authentication \\nmiddleware. The eShopOnContain\", \"ers mobile app performs authentication and authorization with a \\ncontainerized identity microservice\", \" that uses IdentityServer 4. The mobile app requests security tokens \\nfrom IdentityServer, either fo\", \"r authenticating a user or for accessing a resource. For IdentityServer to \\nissue tokens on behalf o\", \"f a user, the user must sign-in to IdentityServer. However, IdentityServer \\ndoesn't provide a user i\", \"nterface or database for authentication. Therefore, in the eShopOnContainers \\nreference application,\", \" ASP.NET Core Identity is used for this purpose. \\nAuthentication\\nAuthentication is required when an \", \"application needs to know the identity of the current user. \\nASP.NET Core's primary mechanism for id\", \"entifying users is the ASP.NET Core Identity membership \\nsystem, which stores user information in a \", \"data store configured by the developer. Typically, this data \\nstore will be an EntityFramework store\", \", though custom stores or third party packages can be used to \\nstore identity information in Azure s\", \"torage, DocumentDB, or other locations.\\nFor authentication scenarios that make use of a local user d\", \"ata store, and that persist identity \\ninformation between requests via cookies (as is typical in ASP\", \".NET MVC web applications), ASP.NET \\nCore Identity is a suitable solution. However, cookies are not \", \"always a natural means of persisting and \\ntransmitting data. For example, an ASP.NET Core web applic\", \"ation that exposes RESTful endpoints that \\nare accessed from a mobile app will typically need to use\", \" bearer token authentication, since cookies \\ncan't be used in this scenario. However, bearer tokens \", \"can easily be retrieved and included in the \\nauthorization header of web requests made from the mobi\", \"le app.60 CHAPTER 9 | Authentication and authorization\\nIssuing bearer tokens using IdentityServer 4\\n\", \"IdentityServer 4 is an open source OpenID Connect and OAuth 2.0 framework for ASP.NET Core, \\nwhich c\", \"an be used for many authentication and authorization scenarios including issuing security \\ntokens fo\", \"r local ASP.NET Core Identity users.\\nNote: OpenID Connect and OAuth 2.0 are very similar, while havi\", \"ng different responsibilities.\\nOpenID Connect is an authentication layer on top of the OAuth 2.0 pro\", \"tocol. OAuth 2 is a protocol \\nthat allows applications to request access tokens from a security toke\", \"n service and use them to \\ncommunicate with APIs. This delegation reduces complexity in both client \", \"applications and APIs \\nsince authentication and authorization can be centralized.\\nThe combination of\", \" OpenID Connect and OAuth 2.0 combine the two fundamental security \\nconcerns of authentication and A\", \"PI access, and IdentityServer 4 is an implementation of these \\nprotocols.\\nIn applications that use d\", \"irect client-to-microservice communication, such as the eShopOnContainers \\nreference application, a \", \"dedicated authentication microservice acting as a Security Token Service (STS) \\ncan be used to authe\", \"nticate users, as shown in Figure 9-1. For more information about direct client\\u0002to-microservice comm\", \"unication, see Communication between client and microservices.\\nFigure 9-1: Authentication by a dedic\", \"ated authentication microservice\\nThe eShopOnContainers mobile app communicates with the identity mic\", \"roservice, which uses \\nIdentityServer 4 to perform authentication, and access control for APIs. Ther\", \"efore, the mobile app \\nrequests tokens from IdentityServer, either for authenticating a user or for \", \"accessing a resource:\\n\\u2022 Authenticating users with IdentityServer is achieved by the mobile app reque\", \"sting an identity\\ntoken, which represents the outcome of an authentication process. At a bare minimu\", \"m, it \\ncontains an identifier for the user, and information about how and when the user \\nauthenticat\", \"ed. It can also contain additional identity data.\\n\\u2022 Accessing a resource with IdentityServer is achi\", \"eved by the mobile app requesting an access\\ntoken, which allows access to an API resource. Clients r\", \"equest access tokens and forward \\nthem to the API. Access tokens contain information about the clien\", \"t, and the user (if present). \\nAPIs then use that information to authorize access to their data.\\nNot\", \"e: A client must be registered with IdentityServer before it can request tokens.\\nAdding IdentityServ\", \"er to a web application\\nIn order for an ASP.NET Core web application to use IdentityServer 4, it mus\", \"t be added to the web \\napplication's Visual Studio solution. For more information, see Setup and Ove\", \"rview in the \\nIdentityServer documentation.61 CHAPTER 9 | Authentication and authorization\\nOnce Iden\", \"tityServer is included in the web application's Visual Studio solution, it must be added to \\nthe web\", \" application's HTTP request processing pipeline, so that it can serve requests to OpenID \\nConnect an\", \"d OAuth 2.0 endpoints. This is achieved in the Configure method in the web application's \\nStartup cl\", \"ass, as demonstrated in the following code example:\\npublic void Configure(\\n IApplicationBuilder app,\", \" IHostingEnvironment env, ILoggerFactory loggerFactory)\\n{\\n ...\\n app.UseIdentity();\\n ...\\n} \\nOrder mat\", \"ters in the web application's HTTP request processing pipeline. Therefore, IdentityServer \\nmust be a\", \"dded to the pipeline before the UI framework that implements the login screen.\\nConfiguring IdentityS\", \"erver\\nIdentityServer should be configured in the ConfigureServices method in the web application's \\n\", \"Startup class by calling the services.AddIdentityServer method, as demonstrated in the \\nfollowing co\", \"de example from the eShopOnContainers reference application:\\npublic void ConfigureServices(IServiceC\", \"ollection services)\\n{\\n ...\\n services.AddIdentityServer(x => x.IssuerUri = \\\"null\\\")\\n .AddSigningCreden\", \"tial(Certificate.Get()) \\n .AddAspNetIdentity<ApplicationUser>()\\n .AddConfigurationStore(builder =>\\n \", \"builder.UseSqlServer(connectionString, options =>\\n options.MigrationsAssembly(migrationsAssembly)))\\n\", \" .AddOperationalStore(builder =>\\n builder.UseSqlServer(connectionString, options =>\\n options.Migrati\", \"onsAssembly(migrationsAssembly)))\\n .Services.AddTransient<IProfileService, ProfileService>();\\n}\\nAfte\", \"r calling the services.AddIdentityServer method, additional fluent APIs are called to \\nconfigure the\", \" following:\\n\\u2022 Credentials used for signing.\\n\\u2022 API and identity resources that users might request ac\", \"cess to.\\n\\u2022 Clients that will be connecting to request tokens.\\n\\u2022 ASP.NET Core Identity.\\nTip: Dynamica\", \"lly load the IdentityServer 4 configuration\\nIdentityServer 4's APIs allow for configuring IdentitySe\", \"rver from an in-memory list of configuration \\nobjects. In the eShopOnContainers reference applicatio\", \"n, these in-memory collections are hard\\u0002coded into the application. However, in production scenarios\", \" they can be loaded dynamically from \\na configuration file or from a database.\\nFor information about\", \" configuring IdentityServer to use ASP.NET Core Identity, see Using ASP.NET \\nCore Identity in the Id\", \"entityServer documentation.62 CHAPTER 9 | Authentication and authorization\\nConfiguring API resources\", \"\\nWhen configuring API resources, the AddInMemoryApiResources method expects an \\nIEnumerable<ApiResou\", \"rce> collection. The following code example shows the GetApis method that \\nprovides this collection \", \"in the eShopOnContainers reference application:\\npublic static IEnumerable<ApiResource> GetApis()\\n{\\n \", \"return new List<ApiResource>\\n {\\n new ApiResource(\\\"orders\\\", \\\"Orders Service\\\"),\\n new ApiResource(\\\"bask\", \"et\\\", \\\"Basket Service\\\")\\n };\\n}\\nThis method specifies that IdentityServer should protect the orders and\", \" basket APIs. Therefore, \\nIdentityServer managed access tokens will be required when making calls to\", \" these APIs. For more \\ninformation about the ApiResource type, see API Resource in the IdentityServe\", \"r 4 documentation.\\nConfiguring identity resources\\nWhen configuring identity resources, the AddInMemo\", \"ryIdentityResources method expects an \\nIEnumerable<IdentityResource> collection. Identity resources \", \"are data such as user ID, name, or \\nemail address. Each identity resource has a unique name, and arb\", \"itrary claim types can be assigned to \\nit, which will then be included in the identity token for the\", \" user. The following code example shows \\nthe GetResources method that provides this collection in th\", \"e eShopOnContainers reference \\napplication:\\npublic static IEnumerable<IdentityResource> GetResources\", \"()\\n{\\n return new List<IdentityResource>\\n {\\n new IdentityResources.OpenId(),\\n new IdentityResources.P\", \"rofile()\\n };\\n}\\nThe OpenID Connect specification specifies some standard identity resources. The mini\", \"mum \\nrequirement is that support is provided for emitting a unique ID for users. This is achieved by\", \" \\nexposing the IdentityResources.OpenId identity resource.\\nNote: The IdentityResources class support\", \"s all of the scopes defined in the OpenID Connect \\nspecification (openid, email, profile, telephone,\", \" and address).\\nIdentityServer also supports defining custom identity resources. For more information\", \", see Defining \\ncustom identity resources in the IdentityServer documentation. For more information \", \"about the \\nIdentityResource type, see Identity Resource in the IdentityServer 4 documentation.\\nConfi\", \"guring clients\\nClients are applications that can request tokens from IdentityServer. Typically, the \", \"following settings \\nmust be defined for each client as a minimum:\\n\\u2022 A unique client ID.\\n\\u2022 The allowe\", \"d interactions with the token service (known as the grant type).\\n\\u2022 The location where identity and a\", \"ccess tokens are sent to (known as a redirect URI).63 CHAPTER 9 | Authentication and authorization\\n\\u2022\", \" A list of resources that the client is allowed access to (known as scopes).\\nWhen configuring client\", \"s, the AddInMemoryClients method expects an IEnumerable<Client>\\ncollection. The following code examp\", \"le shows the configuration for the eShopOnContainers mobile \\napp in the GetClients method that provi\", \"des this collection in the eShopOnContainers reference \\napplication:\\npublic static IEnumerable<Clien\", \"t> GetClients(Dictionary<string,string> clientsUrl)\\n{\\n return new List<Client>\\n {\\n ...\\n new Client\\n \", \"{\\n ClientId = \\\"xamarin\\\",\\n ClientName = \\\"eShop Xamarin OpenId Client\\\",\\n AllowedGrantTypes = GrantType\", \"s.Hybrid,\\n ClientSecrets =\\n {\\n new Secret(\\\"secret\\\".Sha256())\\n },\\n RedirectUris = { clientsUrl[\\\"Xamar\", \"in\\\"] },\\n RequireConsent = false,\\n RequirePkce = true,\\n PostLogoutRedirectUris = { $\\\"{clientsUrl[\\\"Xam\", \"arin\\\"]}/Account/Redirecting\\\" },\\n AllowedCorsOrigins = { \\\"http://eshopxamarin\\\" },\\n AllowedScopes = ne\", \"w List<string>\\n {\\n IdentityServerConstants.StandardScopes.OpenId,\\n IdentityServerConstants.StandardS\", \"copes.Profile,\\n IdentityServerConstants.StandardScopes.OfflineAccess,\\n \\\"orders\\\",\\n \\\"basket\\\"\\n },\\n Allo\", \"wOfflineAccess = true,\\n AllowAccessTokensViaBrowser = true\\n },\\n ...\\n };\\n}\\nThis configuration specifi\", \"es data for the following properties:\\n\\u2022 ClientId: A unique ID for the client.\\n\\u2022 ClientName: The clie\", \"nt display name, which is used for logging and the consent screen.\\n\\u2022 AllowedGrantTypes: Specifies ho\", \"w a client wants to interact with IdentityServer. For more \\ninformation see Configuring the authenti\", \"cation flow.\\n\\u2022 ClientSecrets: Specifies the client secret credentials that are used when requesting \", \"tokens \\nfrom the token endpoint.\\n\\u2022 RedirectUris: Specifies the allowed URIs to which to return token\", \"s or authorization codes.\\n\\u2022 RequireConsent: Specifies whether a consent screen is required.\\n\\u2022 Requir\", \"ePkce: Specifies whether clients using an authorization code must send a proof key.\\n\\u2022 PostLogoutRedi\", \"rectUris: Specifies the allowed URIs to redirect to after logout.64 CHAPTER 9 | Authentication and a\", \"uthorization\\n\\u2022 AllowedCorsOrigins: Specifies the origin of the client so that IdentityServer can all\", \"ow cross\\u0002origin calls from the origin.\\n\\u2022 AllowedScopes: Specifies the resources the client has acces\", \"s to. By default, a client has no \\naccess to any resources.\\n\\u2022 AllowOfflineAccess: Specifies whether \", \"the client can request refresh tokens.\\nConfiguring the authentication flow\\nThe authentication flow b\", \"etween a client and IdentityServer can be configured by specifying the grant \\ntypes in the Client.Al\", \"lowedGrantTypes property. The OpenID Connect and OAuth 2.0 specifications \\ndefine a number of authen\", \"tication flows, including:\\n\\u2022 Implicit. This flow is optimized for browser-based applications and sho\", \"uld be used either for \\nuser authentication-only, or authentication and access token requests. All t\", \"okens are \\ntransmitted via the browser, and therefore advanced features like refresh tokens are not \", \"\\npermitted. \\n\\u2022 Authorization code. This flow provides the ability to retrieve tokens on a back chann\", \"el, as \\nopposed to the browser front channel, while also supporting client authentication.\\n\\u2022 Hybrid.\", \" This flow is a combination of the implicit and authorization code grant types. The \\nidentity token \", \"is transmitted via the browser channel and contains the signed protocol \\nresponse along with other a\", \"rtifacts such as the authorization code. After successful validation \\nof the response, the back chan\", \"nel should be used to retrieve the access and refresh token.\\nTip: Use the hybrid authentication flow\", \"\\nThe hybrid authentication flow mitigates a number of attacks that apply to the browser channel, \\nan\", \"d is the recommended flow for native applications that want to retrieve access tokens (and \\npossibly\", \" refresh tokens).\\nFor more information about authentication flows, see Grant Types in the IdentitySe\", \"rver 4 \\ndocumentation.\\nPerforming authentication\\nFor IdentityServer to issue tokens on behalf of a u\", \"ser, the user must sign-in to IdentityServer. \\nHowever, IdentityServer doesn't provide a user interf\", \"ace or database for authentication. Therefore, in \\nthe eShopOnContainers reference application, ASP.\", \"NET Core Identity is used for this purpose.\\nThe eShopOnContainers mobile app authenticates with Iden\", \"tityServer with the hybrid authentication \\nflow, which is illustrated in Figure 9-2.\\nFigure 9-2: Hig\", \"h-level overview of the sign-in process65 CHAPTER 9 | Authentication and authorization\\nA sign-in req\", \"uest is made to <base endpoint>:5105/connect/authorize. Following successful \\nauthentication, Identi\", \"tyServer returns an authentication response containing an authorization code \\nand an identity token.\", \" The authorization code is then sent to <base \\nendpoint>:5105/connect/token, which responds with acc\", \"ess, identity, and refresh tokens.\\nThe eShopOnContainers mobile app signs-out of IdentityServer by s\", \"ending a request to \\nhttp://<base endpoint>:5105/connect/endsession, with additional parameters. Aft\", \"er sign-out \\noccurs, IdentityServer responds by sending a post logout redirect URI back to the mobil\", \"e app. Figure \\n9-3 illustrates this process.\\nFigure 9-3: High-level overview of the sign-out process\", \"\\nIn the eShopOnContainers mobile app, communication with IdentityServer is performed by the \\nIdentit\", \"yService class, which implements the IIdentityService interface. This interface specifies \\nthat the \", \"implementing class must provide CreateAuthorizationRequest, CreateLogoutRequest, \\nand GetTokenAsync \", \"methods.\\nSigning-in\\nWhen the user taps the LOGIN button on the LoginView, the SignInCommand in the L\", \"oginViewModel\\nclass is executed, which in turn executes the SignInAsync method. The following code e\", \"xample \\nshows this method:\\nprivate async Task SignInAsync()\\n{\\n ...\\n LoginUrl = _identityService.Crea\", \"teAuthorizationRequest();\\n IsLogin = true;\\n ...\\n}\\nThis method invokes the CreateAuthorizationRequest\", \" method in the IdentityService class, \\nwhich is shown in the following code example:\\npublic string C\", \"reateAuthorizationRequest()\\n{\\n // Create URI to authorization endpoint\\n var authorizeRequest = new A\", \"uthorizeRequest(GlobalSetting.Instance.IdentityEndpoint);\\n // Dictionary with values for the authori\", \"ze request\\n var dic = new Dictionary<string, string>();\\n dic.Add(\\\"client_id\\\", GlobalSetting.Instance\", \".ClientId);\\n dic.Add(\\\"client_secret\\\", GlobalSetting.Instance.ClientSecret);\\n dic.Add(\\\"response_type\\\"\", \", \\\"code id_token\\\");\\n dic.Add(\\\"scope\\\", \\\"openid profile basket orders locations marketing offline_acce\", \"ss\\\");\\n dic.Add(\\\"redirect_uri\\\", GlobalSetting.Instance.IdentityCallback);\\n dic.Add(\\\"nonce\\\", Guid.NewG\", \"uid().ToString(\\\"N\\\"));\\n dic.Add(\\\"code_challenge\\\", CreateCodeChallenge());\\n dic.Add(\\\"code_challenge_me\", \"thod\\\", \\\"S256\\\");66 CHAPTER 9 | Authentication and authorization\\n // Add CSRF token to protect against\", \" cross-site request forgery attacks.\\n var currentCSRFToken = Guid.NewGuid().ToString(\\\"N\\\");\\n dic.Add(\", \"\\\"state\\\", currentCSRFToken);\\n var authorizeUri = authorizeRequest.Create(dic);\\n return authorizeUri;\\n\", \"}\\nThis method creates the URI for IdentityServer's authorization endpoint, with the required paramet\", \"ers. \\nThe authorization endpoint is at /connect/authorize on port 5105 of the base endpoint exposed \", \"as \\na user setting. For more information about user settings, see Configuration management.\\nNote: Th\", \"e attack surface of the eShopOnContainers mobile app is reduced by implementing the \\nProof Key for C\", \"ode Exchange (PKCE) extension to OAuth. PKCE protects the authorization code \\nfrom being used if it\\u2019\", \"s intercepted. This is achieved by the client generating a secret verifier, a hash \\nof which is pass\", \"ed in the authorization request, and which is presented unhashed when redeeming \\nthe authorization c\", \"ode. For more information about PKCE, see Proof Key for Code Exchange by \\nOAuth Public Clients on th\", \"e Internet Engineering Task Force web site.\\nThe returned URI is stored in the LoginUrl property of t\", \"he LoginViewModel class. When the IsLogin\\nproperty becomes true, the WebView in the LoginView become\", \"s visible. The WebView data binds its \\nSource property to the LoginUrl property of the LoginViewMode\", \"l class, and so makes a sign-in \\nrequest to IdentityServer when the LoginUrl property is set to Iden\", \"tityServer's authorization \\nendpoint. When IdentityServer receives this request and the user isn't a\", \"uthenticated, the WebView will \\nbe redirected to the configured login page, which is shown in Figure\", \" 9-4.\\nFigure 9-4: Login page displayed by the WebView\\nOnce login is completed, the WebView will be r\", \"edirected to a return URI. This WebView navigation will \\ncause the NavigateAsync method in the Login\", \"ViewModel class to be executed, which is shown in \\nthe following code example:67 CHAPTER 9 | Authent\", \"ication and authorization\\nprivate async Task NavigateAsync(string url)\\n{\\n ...\\n var authResponse = ne\", \"w AuthorizeResponse(url);\\n if (!string.IsNullOrWhiteSpace(authResponse.Code))\\n {\\n var userToken = aw\", \"ait _identityService.GetTokenAsync(authResponse.Code);\\n string accessToken = userToken.AccessToken;\\n\", \" if (!string.IsNullOrWhiteSpace(accessToken))\\n {\\n Settings.AuthAccessToken = accessToken;\\n Settings.\", \"AuthIdToken = authResponse.IdentityToken;\\n await NavigationService.NavigateToAsync<MainViewModel>();\", \"\\n await NavigationService.RemoveLastFromBackStackAsync();\\n }\\n }\\n ...\\n}\\nThis method parses the authen\", \"tication response that's contained in the return URI, and provided that\\na valid authorization code i\", \"s present, it makes a request to IdentityServer's token endpoint, passing \\nthe authorization code, t\", \"he PKCE secret verifier, and other required parameters. The token endpoint is \\nat /connect/token on \", \"port 5105 of the base endpoint exposed as a user setting. For more \\ninformation about user settings,\", \" see Configuration management.\\nTip: Validate return URIs\\nAlthough the eShopOnContainers mobile app d\", \"oesn't validate the return URI, the best practice is to \\nvalidate that the return URI refers to a kn\", \"own location in order to prevent open-redirect attacks.\\nIf the token endpoint receives a valid autho\", \"rization code and PKCE secret verifier, it responds with an \\naccess token, identity token, and refre\", \"sh token. The access token (which allows access to API \\nresources) and identity token are then store\", \"d as application settings, and page navigation is \\nperformed. Therefore, the overall effect in the e\", \"ShopOnContainers mobile app is this: provided that \\nusers are able to successfully authenticate with\", \" IdentityServer, they are navigated to the MainView\\npage, which is a TabbedPage that displays the Ca\", \"talogView as its selected tab.\\nFor information about page navigation, see Navigation. For informatio\", \"n about how WebView\\nnavigation causes a view model method to be executed, see Invoking navigation us\", \"ing behaviors. For \\ninformation about application settings, see Configuration management. \\nNote: The\", \" eShopOnContainers also allows a mock sign-in when the app is configured to use mock \\nservices in th\", \"e SettingsView. In this mode, the app doesn't communicate with IdentityServer, \\ninstead allowing the\", \" user to sign-in using any credentials.\\nSigning-out\\nWhen the user taps the LOG OUT button in the Pro\", \"fileView, the LogoutCommand in the \\nProfileViewModel class is executed, which in turn executes the L\", \"ogoutAsync method. This method \\nperforms page navigation to the LoginView page, passing a LogoutPara\", \"meter instance set to true\\nas a parameter. For more information about passing parameters during page\", \" navigation, see Passing \\nparameters during navigation.68 CHAPTER 9 | Authentication and authorizati\", \"on\\nWhen a view is created and navigated to, the InitializeAsync method of the view's associated \\nvie\", \"w model is executed, which then executes the Logout method of the LoginViewModel class, which \\nis sh\", \"own in the following code example:\\nprivate void Logout()\\n{\\n var authIdToken = Settings.AuthIdToken;\\n\", \" var logoutRequest = _identityService.CreateLogoutRequest(authIdToken);\\n if (!string.IsNullOrEmpty(l\", \"ogoutRequest))\\n {\\n // Logout\\n LoginUrl = logoutRequest;\\n }\\n ...\\n}\\nThis method invokes the CreateLogo\", \"utRequest method in the IdentityService class, passing the \\nidentity token retrieved from applicatio\", \"n settings as a parameter. For more information about \\napplication settings, see Configuration manag\", \"ement. The following code example shows the \\nCreateLogoutRequest method:\\npublic string CreateLogoutR\", \"equest(string token)\\n{\\n ...\\n return string.Format(\\\"{0}?id_token_hint={1}&post_logout_redirect_uri={2\", \"}\\\",\\n GlobalSetting.Instance.LogoutEndpoint,\\n token,\\n GlobalSetting.Instance.LogoutCallback);\\n}\\nThis \", \"method creates the URI to IdentityServer's end session endpoint, with the required parameters. \\nThe \", \"end session endpoint is at /connect/endsession on port 5105 of the base endpoint exposed as \\na user \", \"setting. For more information about user settings, see Configuration management.\\nThe returned URI is\", \" stored in the LoginUrl property of the LoginViewModel class. While the IsLogin\\nproperty is true, th\", \"e WebView in the LoginView is visible. The WebView data binds its Source property \\nto the LoginUrl p\", \"roperty of the LoginViewModel class, and so makes a sign-out request to \\nIdentityServer when the Log\", \"inUrl property is set to IdentityServer's end session endpoint. When \\nIdentityServer receives this r\", \"equest, provided that the user is signed-in, sign-out occurs. \\nAuthentication is tracked with a cook\", \"ie managed by the cookie authentication middleware from \\nASP.NET Core. Therefore, signing out of Ide\", \"ntityServer removes the authentication cookie and sends a \\npost logout redirect URI back to the clie\", \"nt.\\nIn the mobile app, the WebView will be redirected to the post logout redirect URI. This WebView\\n\", \"navigation will cause the NavigateAsync method in the LoginViewModel class to be executed, which \\nis\", \" shown in the following code example:\\nprivate async Task NavigateAsync(string url)\\n{\\n ...\\n Settings.\", \"AuthAccessToken = string.Empty;\\n Settings.AuthIdToken = string.Empty;\\n IsLogin = false;\\n LoginUrl = \", \"_identityService.CreateAuthorizationRequest();\\n ...\\n}69 CHAPTER 9 | Authentication and authorization\", \"\\nThis method clears both the identity token and the access token from application settings, and sets\", \" \\nthe IsLogin property to false, which causes the WebView on the LoginView page to become \\ninvisible\", \". Finally, the LoginUrl property is set to the URI of IdentityServer's authorization endpoint, \\nwith\", \" the required parameters, in preparation for the next time the user initiates a sign-in.\\nFor informa\", \"tion about page navigation, see Navigation. For information about how WebView\\nnavigation causes a vi\", \"ew model method to be executed, see Invoking navigation using behaviors. For \\ninformation about appl\", \"ication settings, see Configuration management.\\nNote: The eShopOnContainers also allows a mock sign-\", \"out when the app is configured to use \\nmock services in the SettingsView. In this mode, the app does\", \"n't communicate with \\nIdentityServer, and instead clears any stored tokens from application settings\", \".\\nAuthorization\\nAfter authentication, ASP.NET Core web APIs often need to authorize access, which al\", \"lows a service to \\nmake APIs available to some authenticated users, but not to all.\\nRestricting acce\", \"ss to an ASP.NET Core MVC route can be achieved by applying an Authorize attribute \\nto a controller \", \"or action, which limits access to the controller or action to authenticated users, as \\nshown in the \", \"following code example:\\n[Authorize]\\npublic class BasketController : Controller\\n{\\n ...\\n}\\nIf an unauth\", \"orized user attempts to access a controller or action that's marked with the Authorize\\nattribute, th\", \"e MVC framework returns a 401 (unauthorized) HTTP status code.\\nNote: Parameters can be specified on \", \"the Authorize attribute to restrict an API to specific users. \\nFor more information, see Authorizati\", \"on on the Microsoft Documentation Center.70 CHAPTER 9 | Authentication and authorization\\nIdentitySer\", \"ver can be integrated into the authorization workflow so that the access tokens it provides \\ncontrol\", \" authorization. This approach is shown in Figure 9-5.\\nFigure 9-5: Authorization by access token\\nThe \", \"eShopOnContainers mobile app communicates with the identity microservice and requests an \\naccess tok\", \"en as part of the authentication process. The access token is then forwarded to the APIs \\nexposed by\", \" the ordering and basket microservices as part of the access requests. Access tokens \\ncontain inform\", \"ation about the client, and the user. APIs then use that information to authorize access \\nto their d\", \"ata. For information about how to configure IdentityServer to protect APIs, see Configuring \\nAPI res\", \"ources.\\nConfiguring IdentityServer to perform authorization\\nTo perform authorization with IdentitySe\", \"rver, its authorization middleware must be added to the web \\napplication's HTTP request pipeline. Th\", \"e middleware is added in the ConfigureAuth method in the \\nweb application's Startup class, which is \", \"invoked from the Configure method, and is demonstrated \\nin the following code example from the eShop\", \"OnContainers reference application:\\nprotected virtual void ConfigureAuth(IApplicationBuilder app)\\n{\\n\", \" var identityUrl = Configuration.GetValue<string>(\\\"IdentityUrl\\\");\\n app.UseIdentityServerAuthenticati\", \"on(new IdentityServerAuthenticationOptions\\n {\\n Authority = identityUrl.ToString(),\\n ScopeName = \\\"bas\", \"ket\\\",\\n RequireHttpsMetadata = false\\n });\\n}\\nThis method ensures that the API can only be accessed wit\", \"h a valid access token. The middleware \\nvalidates the incoming token to ensure that it's sent from a\", \" trusted issuer, and validates that the token \\nis valid to be used with the API that receives it. Th\", \"erefore, browsing to the ordering or basket \\ncontroller will return a 401 (unauthorized) HTTP status\", \" code, indicating that an access token is \\nrequired.71 CHAPTER 9 | Authentication and authorization\\n\", \"Note: IdentityServer's authorization middleware must be added to the web application's HTTP \\nrequest\", \" pipeline before adding MVC with app.UseMvc() or app.UseMvcWithDefaultRoute().\\nMaking access request\", \"s to APIs\\nWhen making requests to the ordering and basket microservices, the access token, obtained \", \"from \\nIdentityServer during the authentication process, must be included in the request, as shown in\", \" the \\nfollowing code example:\\nvar authToken = Settings.AuthAccessToken;\\nOrder = await _ordersService\", \".GetOrderAsync(Convert.ToInt32(order.OrderNumber), authToken);\\nThe access token is stored as an appl\", \"ication setting, and is retrieved from platform-specific storage \\nand included in the call to the Ge\", \"tOrderAsync method in the OrderService class. \\nSimilarly, the access token must be included when sen\", \"ding data to an IdentityServer protected API, as \\nshown in the following code example:\\nvar authToken\", \" = Settings.AuthAccessToken;\\nawait _basketService.UpdateBasketAsync(new CustomerBasket\\n{\\n BuyerId = \", \"userInfo.UserId,\\n Items = BasketItems.ToList()\\n}, authToken); \\nThe access token is retrieved from pl\", \"atform-specific storage and included in the call to the \\nUpdateBasketAsync method in the BasketServi\", \"ce class.\\nThe RequestProvider class, in the eShopOnContainers mobile app, uses the HttpClient class \", \"to \\nmake requests to the RESTful APIs exposed by the eShopOnContainers reference application. When \\n\", \"making requests to the ordering and basket APIs, which require authorization, a valid access token \\n\", \"must be included with the request. This is achieved by adding the access token to the headers of the\", \" \\nHttpClient instance, as demonstrated in the following code example:\\nhttpClient.DefaultRequestHeade\", \"rs.Authorization = new AuthenticationHeaderValue(\\\"Bearer\\\", token); \\nThe DefaultRequestHeaders proper\", \"ty of the HttpClient class exposes the headers that are sent \\nwith each request, and the access toke\", \"n is added to the Authorization header prefixed with the \\nstring Bearer. When the request is sent to\", \" a RESTful API, the value of the Authorization header is \\nextracted and validated to ensure that it'\", \"s sent from a trusted issuer, and used to determine whether \\nthe user has permission to invoke the A\", \"PI that receives it.\\nFor more information about how the eShopOnContainers mobile app makes web reque\", \"sts, see\\nAccessing remote data.\\nSummary\\nThere are many approaches to integrating authentication and \", \"authorization into a Xamarin.Forms app \\nthat communicates with an ASP.NET MVC web application. The e\", \"ShopOnContainers mobile app \\nperforms authentication and authorization with a containerized identity\", \" microservice that uses \\nIdentityServer 4. IdentityServer is an open source OpenID Connect and OAuth\", \" 2.0 framework for \\nASP.NET Core that integrates with ASP.NET Core Identity to perform bearer token \", \"authentication.72 CHAPTER 9 | Authentication and authorization\\nThe mobile app requests security toke\", \"ns from IdentityServer, either for authenticating a user or for \\naccessing a resource. When accessin\", \"g a resource, an access token must be included in the request to \\nAPIs that require authorization. I\", \"dentityServer's middleware validates incoming access tokens to \\nensure that they are sent from a tru\", \"sted issuer, and that they are valid to be used with the API that \\nreceives them.73 CHAPTER 10 | Acc\", \"essing remote data\\nC H A P T E R 10\\nAccessing remote \\ndata\\nMany modern web-based solutions make use \", \"of web services, hosted by web servers, to provide \\nfunctionality for remote client applications. Th\", \"e operations that a web service exposes constitute a \\nweb API.\\nClient apps should be able to utilize\", \" the web API without knowing how the data or operations that the \\nAPI exposes are implemented. This \", \"requires that the API abides by common standards that enable a \\nclient app and web service to agree \", \"on which data formats to use, and the structure of the data that is \\nexchanged between client apps a\", \"nd the web service.\\nIntroduction to Representational State Transfer\\nRepresentational State Transfer \", \"(REST) is an architectural style for building distributed systems based \\non hypermedia. A primary ad\", \"vantage of the REST model is that it's based on open standards and \\ndoesn't bind the implementation \", \"of the model or the client apps that access it to any specific \\nimplementation. Therefore, a REST we\", \"b service could be implemented using Microsoft ASP.NET Core \\nMVC, and client apps could be developin\", \"g using any language and toolset that can generate HTTP \\nrequests and parse HTTP responses.\\nThe REST\", \" model uses a navigational scheme to represent objects and services over a network, referred \\nto as \", \"resources. Systems that implement REST typically use the HTTP protocol to transmit requests to \\nacce\", \"ss these resources. In such systems, a client app submits a request in the form of a URI that \\nident\", \"ifies a resource, and an HTTP method (such as GET, POST, PUT, or DELETE) that indicates the \\noperati\", \"on to be performed on that resource. The body of the HTTP request contains any data required \\nto per\", \"form the operation. \\nNote: REST defines a stateless request model. Therefore, HTTP requests must be \", \"independent and \\nmight occur in any order.\\nThe response from a REST request makes use of standard HT\", \"TP status codes. For example, a request \\nthat returns valid data should include the HTTP response co\", \"de 200 (OK), while a request that fails to \\nfind or delete a specified resource should return a resp\", \"onse that includes the HTTP status code 404 \\n(Not Found).\\nA RESTful web API exposes a set of connect\", \"ed resources, and provides the core operations that \\nenable an app to manipulate those resources and\", \" easily navigate between them. For this reason, the \\nURIs that constitute a typical RESTful web API \", \"are oriented towards the data that it exposes, and use \\nthe facilities provided by HTTP to operate o\", \"n this data.74 CHAPTER 10 | Accessing remote data\\nThe data included by a client app in an HTTP reque\", \"st, and the corresponding response messages from \\nthe web server, could be presented in a variety of\", \" formats, known as media types. When a client app \\nsends a request that returns data in the body of \", \"a message, it can specify the media types it can \\nhandle in the Accept header of the request. If the\", \" web server supports this media type, it can reply \\nwith a response that includes the Content-Type h\", \"eader that specifies the format of the data in the \\nbody of the message. It's then the responsibilit\", \"y of the client app to parse the response message and \\ninterpret the results in the message body app\", \"ropriately.\\nFor more information about REST, see API design and API implementation on Microsoft Docs\", \".\\nConsuming RESTful APIs\\nThe eShopOnContainers mobile app uses the Model-View-ViewModel (MVVM) patte\", \"rn, and the \\nmodel elements of the pattern represent the domain entities used in the app. The contro\", \"ller and \\nrepository classes in the eShopOnContainers reference application accept and return many o\", \"f these \\nmodel objects. Therefore, they are used as data transfer objects (DTOs) that hold all the d\", \"ata that is \\npassed between the mobile app and the containerized microservices. The main benefit of \", \"using DTOs \\nto pass data to and receive data from a web service is that by transmitting more data in\", \" a single \\nremote call, the app can reduce the number of remote calls that need to be made.\\nMaking w\", \"eb requests\\nThe eShopOnContainers mobile app uses the HttpClient class to make requests over HTTP, w\", \"ith \\nJSON being used as the media type. This class provides functionality for asynchronously sending\", \" HTTP \\nrequests and receiving HTTP responses from a URI identified resource. The HttpResponseMessage\", \"\\nclass represents an HTTP response message received from a REST API after an HTTP request has been \\n\", \"made. It contains information about the response, including the status code, headers, and any body. \", \"\\nThe HttpContent class represents the HTTP body and content headers, such as Content-Type and \\nConte\", \"nt-Encoding. The content can be read using any of the ReadAs methods, such as \\nReadAsStringAsync and\", \" ReadAsByteArrayAsync, depending on the format of the data.\\nMaking a GET request\\nThe CatalogService \", \"class is used to manage the data retrieval process from the catalog \\nmicroservice. In the RegisterDe\", \"pendencies method in the ViewModelLocator class, the \\nCatalogService class is registered as a type m\", \"apping against the ICatalogService type with the \\nAutofac dependency injection container. Then, when\", \" an instance of the CatalogViewModel class is \\ncreated, its constructor accepts an ICatalogService t\", \"ype, which Autofac resolves, returning an \\ninstance of the CatalogService class. For more informatio\", \"n about dependency injection, see \\nIntroduction to dependency injection.\\nFigure 10-1 shows the inter\", \"action of classes that read catalog data from the catalog microservice for \\ndisplaying by the Catalo\", \"gView.75 CHAPTER 10 | Accessing remote data\\nFigure 10-1: Retrieving data from the catalog microservi\", \"ce\\nWhen the CatalogView is navigated to, the OnInitialize method in the CatalogViewModel class is \\nc\", \"alled. This method retrieves catalog data from the catalog microservice, as demonstrated in the \\nfol\", \"lowing code example:\\npublic override async Task InitializeAsync(object navigationData)\\n{\\n ...\\n Produ\", \"cts = await _productsService.GetCatalogAsync();\\n ...\\n}\\nThis method calls the GetCatalogAsync method \", \"of the CatalogService instance that was injected \\ninto the CatalogViewModel by Autofac. The followin\", \"g code example shows the GetCatalogAsync\\nmethod:\\npublic async Task<ObservableCollection<CatalogItem>\", \"> GetCatalogAsync()\\n{\\n UriBuilder builder = new UriBuilder(GlobalSetting.Instance.CatalogEndpoint);\\n\", \" builder.Path = \\\"api/v1/catalog/items\\\";\\n string uri = builder.ToString();\\n CatalogRoot catalog = awa\", \"it _requestProvider.GetAsync<CatalogRoot>(uri);\\n ...76 CHAPTER 10 | Accessing remote data\\n return ca\", \"talog?.Data.ToObservableCollection(); \\n} \\nThis method builds the URI that identifies the resource th\", \"e request will be sent to, and uses the \\nRequestProvider class to invoke the GET HTTP method on the \", \"resource, before returning the results \\nto the CatalogViewModel. The RequestProvider class contains \", \"functionality that submits a request \\nin the form of a URI that identifies a resource, an HTTP metho\", \"d that indicates the operation to be \\nperformed on that resource, and a body that contains any data \", \"required to perform the operation. For \\ninformation about how the RequestProvider class is injected \", \"into the CatalogService class, see \\nIntroduction to dependency injection.\\nThe following code example\", \" shows the GetAsync method in the RequestProvider class:\\npublic async Task<TResult> GetAsync<TResult\", \">(string uri, string token = \\\"\\\")\\n{\\n HttpClient httpClient = CreateHttpClient(token);\\n HttpResponseMe\", \"ssage response = await httpClient.GetAsync(uri);\\n await HandleResponse(response);\\n string serialized\", \" = await response.Content.ReadAsStringAsync();\\n TResult result = await Task.Run(() =>\\n JsonConvert.D\", \"eserializeObject<TResult>(serialized, _serializerSettings));\\n return result;\\n}\\nThis method calls the\", \" CreateHttpClient method, which returns an instance of the HttpClient class \\nwith the appropriate he\", \"aders set. It then submits an asynchronous GET request to the resource \\nidentified by the URI, with \", \"the response being stored in the HttpResponseMessage instance. The \\nHandleResponse method is then in\", \"voked, which throws an exception if the response doesn't include \\na success HTTP status code. Then t\", \"he response is read as a string, converted from JSON to a \\nCatalogRoot object, and returned to the C\", \"atalogService.\\nThe CreateHttpClient method is shown in the following code example:\\nprivate HttpClien\", \"t CreateHttpClient(string token = \\\"\\\")\\n{\\n var httpClient = new HttpClient();\\n httpClient.DefaultReque\", \"stHeaders.Accept.Add(\\n new MediaTypeWithQualityHeaderValue(\\\"application/json\\\"));\\n if (!string.IsNull\", \"OrEmpty(token))\\n {\\n httpClient.DefaultRequestHeaders.Authorization =\\n new AuthenticationHeaderValue(\", \"\\\"Bearer\\\", token);\\n }\\n return httpClient;\\n}\\nThis method creates a new instance of the HttpClient clas\", \"s, and sets the Accept header of any \\nrequests made by the HttpClient instance to application/json, \", \"which indicates that it expects the\\ncontent of any response to be formatted using JSON. Then, if an \", \"access token was passed as an \\nargument to the CreateHttpClient method, it's added to the Authorizat\", \"ion header of any \\nrequests made by the HttpClient instance, prefixed with the string Bearer. For mo\", \"re information \\nabout authorization, see Authorization.77 CHAPTER 10 | Accessing remote data\\nWhen th\", \"e GetAsync method in the RequestProvider class calls HttpClient.GetAsync, the Items\\nmethod in the Ca\", \"talogController class in the Catalog.API project is invoked, which is shown in the \\nfollowing code e\", \"xample:\\n[HttpGet]\\n[Route(\\\"[action]\\\")]\\npublic async Task<IActionResult> Items(\\n [FromQuery]int pageSi\", \"ze = 10, [FromQuery]int pageIndex = 0)\\n{\\n var totalItems = await _catalogContext.CatalogItems\\n .Long\", \"CountAsync();\\n var itemsOnPage = await _catalogContext.CatalogItems\\n .OrderBy(c=>c.Name)\\n .Skip(page\", \"Size * pageIndex)\\n .Take(pageSize)\\n .ToListAsync();\\n itemsOnPage = ComposePicUri(itemsOnPage);\\n var \", \"model = new PaginatedItemsViewModel<CatalogItem>(\\n pageIndex, pageSize, totalItems, itemsOnPage); \\n \", \"return Ok(model);\\n}\\nThis method retrieves the catalog data from the SQL database using EntityFramewo\", \"rk, and returns it \\nas a response message that includes a success HTTP status code, and a collection\", \" of JSON formatted \\nCatalogItem instances.\\nMaking a POST request\\nThe BasketService class is used to \", \"manage the data retrieval and update process with the basket \\nmicroservice. In the RegisterDependenc\", \"ies method in the ViewModelLocator class, the \\nBasketService class is registered as a type mapping a\", \"gainst the IBasketService type with the \\nAutofac dependency injection container. Then, when an insta\", \"nce of the BasketViewModel class is \\ncreated, its constructor accepts an IBasketService type, which \", \"Autofac resolves, returning an \\ninstance of the BasketService class. For more information about depe\", \"ndency injection, see \\nIntroduction to dependency injection.\\nFigure 10-2 shows the interaction of cl\", \"asses that send the basket data displayed by the BasketView, \\nto the basket microservice.78 CHAPTER \", \"10 | Accessing remote data\\nFigure 10-2: Sending data to the basket microservice\\nWhen an item is adde\", \"d to the shopping basket, the ReCalculateTotalAsync method in the \\nBasketViewModel class is called. \", \"This method updates the total value of items in the basket, and \\nsends the basket data to the basket\", \" microservice, as demonstrated in the following code example:\\nprivate async Task ReCalculateTotalAsy\", \"nc()\\n{\\n ...\\n await _basketService.UpdateBasketAsync(new CustomerBasket\\n {\\n BuyerId = userInfo.UserId\", \",\\n Items = BasketItems.ToList()\\n }, authToken);\\n}\\nThis method calls the UpdateBasketAsync method of \", \"the BasketService instance that was injected \\ninto the BasketViewModel by Autofac. The following met\", \"hod shows the UpdateBasketAsync\\nmethod:\\npublic async Task<CustomerBasket> UpdateBasketAsync(Customer\", \"Basket customerBasket, string token)\\n{\\n UriBuilder builder = new UriBuilder(GlobalSetting.Instance.B\", \"asketEndpoint);\\n string uri = builder.ToString();79 CHAPTER 10 | Accessing remote data\\n var result =\", \" await _requestProvider.PostAsync(uri, customerBasket, token);\\n return result;\\n}\\nThis method builds \", \"the URI that identifies the resource the request will be sent to, and uses the \\nRequestProvider clas\", \"s to invoke the POST HTTP method on the resource, before returning the \\nresults to the BasketViewMod\", \"el. Note that an access token, obtained from IdentityServer during the \\nauthentication process, is r\", \"equired to authorize requests to the basket microservice. For more \\ninformation about authorization,\", \" see Authorization.\\nThe following code example shows one of the PostAsync methods in the RequestProv\", \"ider class:\\npublic async Task<TResult> PostAsync<TResult>(\\n string uri, TResult data, string token =\", \" \\\"\\\", string header = \\\"\\\")\\n{\\n HttpClient httpClient = CreateHttpClient(token);\\n ...\\n var content = new\", \" StringContent(JsonConvert.SerializeObject(data));\\n content.Headers.ContentType = new MediaTypeHeade\", \"rValue(\\\"application/json\\\");\\n HttpResponseMessage response = await httpClient.PostAsync(uri, content)\", \";\\n await HandleResponse(response);\\n string serialized = await response.Content.ReadAsStringAsync();\\n\", \" TResult result = await Task.Run(() =>\\n JsonConvert.DeserializeObject<TResult>(serialized, _serializ\", \"erSettings));\\n return result;\\n}\\nThis method calls the CreateHttpClient method, which returns an inst\", \"ance of the HttpClient class \\nwith the appropriate headers set. It then submits an asynchronous POST\", \" request to the resource \\nidentified by the URI, with the serialized basket data being sent in JSON \", \"format, and the response \\nbeing stored in the HttpResponseMessage instance. The HandleResponse metho\", \"d is then invoked, \\nwhich throws an exception if the response doesn't include a success HTTP status \", \"code. Then, the \\nresponse is read as a string, converted from JSON to a CustomerBasket object, and r\", \"eturned to the \\nBasketService. For more information about the CreateHttpClient method, see Making a \", \"GET request.\\nWhen the PostAsync method in the RequestProvider class calls HttpClient.PostAsync, the \", \"Post\\nmethod in the BasketController class in the Basket.API project is invoked, which is shown in th\", \"e \\nfollowing code example:\\n[HttpPost]\\npublic async Task<IActionResult> Post([FromBody]CustomerBasket\", \" value)\\n{\\n var basket = await _repository.UpdateBasketAsync(value);\\n return Ok(basket);\\n} \\nThis meth\", \"od uses an instance of the RedisBasketRepository class to persist the basket data to the \\nRedis cach\", \"e, and returns it as a response message that includes a success HTTP status code, and a \\nJSON format\", \"ted CustomerBasket instance.\\nMaking a DELETE request\\nFigure 10-3 shows the interactions of classes t\", \"hat delete basket data from the basket microservice, for \\nthe CheckoutView.80 CHAPTER 10 | Accessing\", \" remote data\\nFigure 10-3: Deleting data from the basket microservice\\nWhen the checkout process is in\", \"voked, the CheckoutAsync method in the CheckoutViewModel class \\nis called. This method creates a new\", \" order, before clearing the shopping basket, as demonstrated in \\nthe following code example:\\nprivate\", \" async Task CheckoutAsync()\\n{\\n ...\\n await _basketService.ClearBasketAsync(_shippingAddress.Id.ToStri\", \"ng(), authToken);\\n ...\\n}\\nThis method calls the ClearBasketAsync method of the BasketService instance\", \" that was injected \\ninto the CheckoutViewModel by Autofac. The following method shows the ClearBaske\", \"tAsync\\nmethod:\\npublic async Task ClearBasketAsync(string guidUser, string token)\\n{\\n UriBuilder build\", \"er = new UriBuilder(GlobalSetting.Instance.BasketEndpoint);\\n builder.Path = guidUser;\\n string uri = \", \"builder.ToString();\\n await _requestProvider.DeleteAsync(uri, token);\\n}\\nThis method builds the URI th\", \"at identifies the resource that the request will be sent to, and uses the \\nRequestProvider class to \", \"invoke the DELETE HTTP method on the resource. Note that an access \\ntoken, obtained from IdentitySer\", \"ver during the authentication process, is required to authorize\\nrequests to the basket microservice.\", \" For more information about authorization, see Authorization.\\nThe following code example shows the D\", \"eleteAsync method in the RequestProvider class:81 CHAPTER 10 | Accessing remote data\\npublic async Ta\", \"sk DeleteAsync(string uri, string token = \\\"\\\")\\n{\\n HttpClient httpClient = CreateHttpClient(token);\\n a\", \"wait httpClient.DeleteAsync(uri);\\n}\\nThis method calls the CreateHttpClient method, which returns an \", \"instance of the HttpClient class \\nwith the appropriate headers set. It then submits an asynchronous \", \"DELETE request to the resource \\nidentified by the URI. For more information about the CreateHttpClie\", \"nt method, see Making a GET \\nrequest.\\nWhen the DeleteAsync method in the RequestProvider class calls\", \" HttpClient.DeleteAsync, the \\nDelete method in the BasketController class in the Basket.API project \", \"is invoked, which is shown \\nin the following code example:\\n[HttpDelete(\\\"{id}\\\")]\\npublic void Delete(s\", \"tring id)\\n{\\n _repository.DeleteBasketAsync(id);\\n}\\nThis method uses an instance of the RedisBasketRep\", \"ository class to delete the basket data from \\nthe Redis cache.\\nCaching data\\nThe performance of an ap\", \"p can be improved by caching frequently accessed data to fast storage \\nthat's located close to the a\", \"pp. If the fast storage is located closer to the app than the original source, \\nthen caching can sig\", \"nificantly improve response times when retrieving data.\\nThe most common form of caching is read-thro\", \"ugh caching, where an app retrieves data by \\nreferencing the cache. If the data isn't in the cache, \", \"it's retrieved from the data store and added to the \\ncache. Apps can implement read-through caching \", \"with the cache-aside pattern. This pattern \\ndetermines whether the item is currently in the cache. I\", \"f the item isn't in the cache, it's read from the \\ndata store and added to the cache. For more infor\", \"mation, see the Cache-Aside pattern on Microsoft \\nDocs.\\nTip: Cache data that's read frequently and t\", \"hat changes infrequently\\nThis data can be added to the cache on demand the first time it is retrieve\", \"d by an app. This means \\nthat the app needs to fetch the data only once from the data store, and tha\", \"t subsequent access can \\nbe satisfied by using the cache.\\nDistributed applications, such as the eSho\", \"pOnContainers reference application, should provide either \\nor both of the following caches:\\n\\u2022 A sha\", \"red cache, which can be accessed by multiple processes or machines.\\n\\u2022 A private cache, where data is\", \" held locally on the device running the app.\\nThe eShopOnContainers mobile app uses a private cache, \", \"where data is held locally on the device \\nthat's running an instance of the app. For information abo\", \"ut the cache used by the \\neShopOnContainers reference application, see .NET Microservices: Architect\", \"ure for Containerized .NET \\nApplications.82 CHAPTER 10 | Accessing remote data\\nTip: Think of the cac\", \"he as a transient data store that could disappear at any time\\nEnsure that data is maintained in the \", \"original data store as well as the cache. The chances of losing \\ndata are then minimized if the cach\", \"e becomes unavailable.\\nManaging data expiration\\nIt's impractical to expect that cached data will alw\", \"ays be consistent with the original data. Data in the \\noriginal data store might change after it's b\", \"een cached, causing the cached data to become stale. \\nTherefore, apps should implement a strategy th\", \"at helps to ensure that the data in the cache is as up\\u0002to-date as possible, but can also detect and \", \"handle situations that arise when the data in the cache \\nhas become stale. Most caching mechanisms e\", \"nable the cache to be configured to expire data, and \\nhence reduce the period for which data might b\", \"e out of date.\\nTip: Set a default expiration time when configuring a cache\\nMany caches implement exp\", \"iration, which invalidates data and removes it from the cache if it's not \\naccessed for a specified \", \"period. However, care must be taken when choosing the expiration period. \\nIf it's made too short, da\", \"ta will expire too quickly and the benefits of caching will be reduced. If it's \\nmade too long, the \", \"data risks becoming stale. Therefore, the expiration time should match the \\npattern of access for ap\", \"ps that use the data.\\nWhen cached data expires, it should be removed from the cache, and the app mus\", \"t retrieve the data \\nfrom the original data store and place it back into the cache.\\nIt's also possib\", \"le that a cache might fill up if data is allowed to remain for too long a period. Therefore, \\nreques\", \"ts to add new items to the cache might be required to remove some items in a process known \\nas evict\", \"ion. Caching services typically evict data on a least-recently-used basis. However, there are \\nother\", \" eviction policies, including most-recently-used, and first-in-first-out. For more information, see \", \"\\nCaching Guidance on Microsoft Docs.\\nCaching images\\nThe eShopOnContainers mobile app consumes remote\", \" product images that benefit from being \\ncached. These images are displayed by the Image control, an\", \"d the CachedImage control provided by \\nthe FFImageLoading library.\\nThe Xamarin.Forms Image control s\", \"upports caching of downloaded images. Caching is enabled by \\ndefault, and will store the image local\", \"ly for 24 hours. In addition, the expiration time can be \\nconfigured with the CacheValidity property\", \". For more information, see Downloaded Image Caching\\non the Xamarin Developer Center.\\nFFImageLoading\", \"'s CachedImage control is a replacement for the Xamarin.Forms Image control, \\nproviding additional p\", \"roperties that enable supplementary functionality. Amongst this functionality, \\nthe control provides\", \" configurable caching, while supporting error and loading image placeholders. \\nThe following code ex\", \"ample shows how the eShopOnContainers mobile app uses the CachedImage\\ncontrol in the ProductTemplate\", \", which is the data template used by the ListView control in the \\nCatalogView:\\n<ffimageloading:Cache\", \"dImage\\n Grid.Row=\\\"0\\\"\\n Source=\\\"{Binding PictureUri}\\\" \\n Aspect=\\\"AspectFill\\\">\\n <ffimageloading:CachedIm\", \"age.LoadingPlaceholder>\\n <OnPlatform \\n x:TypeArguments=\\\"ImageSource\\\"83 CHAPTER 10 | Accessing remote\", \" data\\n iOS=\\\"default_product\\\"\\n Android=\\\"default_product\\\"\\n WinPhone=\\\"Assets/default_product.png\\\"/>\\n </\", \"ffimageloading:CachedImage.LoadingPlaceholder>\\n <ffimageloading:CachedImage.ErrorPlaceholder>\\n <OnPl\", \"atform \\n x:TypeArguments=\\\"ImageSource\\\"\\n iOS=\\\"noimage\\\"\\n Android=\\\"noimage\\\"\\n WinPhone=\\\"Assets/noimage.p\", \"ng\\\"/>\\n </ffimageloading:CachedImage.ErrorPlaceholder>\\n</ffimageloading:CachedImage>\\nThe CachedImage \", \"control sets the LoadingPlaceholder and ErrorPlaceholder properties to \\nplatform-specific images. Th\", \"e LoadingPlaceholder property specifies the image to be displayed \\nwhile the image specified by the \", \"Source property is retrieved, and the ErrorPlaceholder property \\nspecifies the image to be displayed\", \" if an error occurs when attempting to retrieve the image specified \\nby the Source property.\\nAs the \", \"name implies, the CachedImage control caches remote images on the device for the time \\nspecified by \", \"the value of the CacheDuration property. When this property value isn't explicitly set, the \\ndefault\", \" value of 30 days is applied.\\nIncreasing resilience\\nAll apps that communicate with remote services a\", \"nd resources must be sensitive to transient faults. \\nTransient faults include the momentary loss of \", \"network connectivity to services, the temporary \\nunavailability of a service, or timeouts that arise\", \" when a service is busy. These faults are often self\\u0002correcting, and if the action is repeated after\", \" a suitable delay it's likely to succeed.\\nTransient faults can have a huge impact on the perceived q\", \"uality of an app, even if it has been \\nthoroughly tested under all foreseeable circumstances. To ens\", \"ure that an app that communicates with \\nremote services operates reliably, it must be able to do all\", \" of the following:\\n\\u2022 Detect faults when they occur, and determine if the faults are likely to be tra\", \"nsient.\\n\\u2022 Retry the operation if it determines that the fault is likely to be transient and keep tra\", \"ck of the \\nnumber of times the operation was retried.\\n\\u2022 Use an appropriate retry strategy, which spe\", \"cifies the number of retries, the delay between \\neach attempt, and the actions to take after a faile\", \"d attempt. \\nThis transient fault handling can be achieved by wrapping all attempts to access a remot\", \"e service in \\ncode that implements the retry pattern.\\nRetry pattern\\nIf an app detects a failure when\", \" it tries to send a request to a remote service, it can handle the failure \\nin any of the following \", \"ways:\\n\\u2022 Retrying the operation. The app could retry the failing request immediately.\\n\\u2022 Retrying the \", \"operation after a delay. The app should wait for a suitable amount of time before \\nretrying the requ\", \"est.\\n\\u2022 Cancelling the operation. The application should cancel the operation and report an \\nexceptio\", \"n.84 CHAPTER 10 | Accessing remote data\\nThe retry strategy should be tuned to match the business req\", \"uirements of the app. For example, it's \\nimportant to optimize the retry count and retry interval to\", \" the operation being attempted. If the \\noperation is part of a user interaction, the retry interval \", \"should be short and only a few retries \\nattempted to avoid making users wait for a response. If the \", \"operation is part of a long running \\nworkflow, where cancelling or restarting the workflow is expens\", \"ive or time-consuming, it's appropriate \\nto wait longer between attempts and to retry more times.\\nNo\", \"te: An aggressive retry strategy with minimal delay between attempts, and a large number of \\nretries\", \", could degrade a remote service that's running close to or at capacity. In addition, such a \\nretry \", \"strategy could also affect the responsiveness of the app if it's continually trying to perform a \\nfa\", \"iling operation.\\nIf a request still fails after a number of retries, it's better for the app to prev\", \"ent further requests going \\nto the same resource and to report a failure. Then, after a set period, \", \"the app can make one or more \\nrequests to the resource to see if they're successful. For more inform\", \"ation, see Circuit breaker pattern.\\nTip: Never implement an endless retry mechanism\\nUse a finite num\", \"ber of retries, or implement the Circuit Breaker pattern to allow a service to recover.\\nThe eShopOnC\", \"ontainers mobile app does not currently implement the retry pattern when making \\nRESTful web request\", \"s. However, the CachedImage control, provided by the FFImageLoading library \\nsupports transient faul\", \"t handling by retrying image loading. If image loading fails, further attempts \\nwill be made. The nu\", \"mber of attempts is specified by the RetryCount property, and retries will occur \\nafter a delay spec\", \"ified by the RetryDelay property. If these property values aren't explicitly set, their \\ndefault val\", \"ues are applied \\u2013 3 for the RetryCount property, and 250ms for the RetryDelay property. \\nFor more in\", \"formation about the CachedImage control, see Caching images.\\nThe eShopOnContainers reference applica\", \"tion does implement the retry pattern. For more \\ninformation, including a discussion of how to combi\", \"ne the retry pattern with the HttpClient class, \\nsee .NET Microservices: Architecture for Containeri\", \"zed .NET Applications.\\nFor more information about the retry pattern, see the Retry pattern on Micros\", \"oft Docs.\\nCircuit breaker pattern\\nIn some situations, faults can occur due to anticipated events tha\", \"t take longer to fix. These faults can \\nrange from a partial loss of connectivity to the complete fa\", \"ilure of a service. In these situations, it's \\npointless for an app to retry an operation that's unl\", \"ikely to succeed, and instead should accept that \\nthe operation has failed and handle this failure a\", \"ccordingly.\\nThe circuit breaker pattern can prevent an app from repeatedly trying to execute an oper\", \"ation that's \\nlikely to fail, while also enabling the app to detect whether the fault has been resol\", \"ved. \\nNote: The purpose of the circuit breaker pattern is different from the retry pattern. The retr\", \"y \\npattern enables an app to retry an operation in the expectation that it'll succeed. The circuit b\", \"reaker \\npattern prevents an app from performing an operation that's likely to fail. \\nA circuit break\", \"er acts as a proxy for operations that might fail. The proxy should monitor the number \\nof recent fa\", \"ilures that have occurred, and use this information to decide whether to allow the \\noperation to pro\", \"ceed, or to return an exception immediately.\\nThe eShopOnContainers mobile app does not currently imp\", \"lement the circuit breaker pattern. \\nHowever, the eShopOnContainers does. For more information, see \", \".NET Microservices: Architecture \\nfor Containerized .NET Applications.85 CHAPTER 10 | Accessing remo\", \"te data\\nTip: Combine the retry and circuit breaker patterns\\nAn app can combine the retry and circuit\", \" breaker patterns by using the retry pattern to invoke an \\noperation through a circuit breaker. Howe\", \"ver, the retry logic should be sensitive to any exceptions \\nreturned by the circuit breaker and aban\", \"don retry attempts if the circuit breaker indicates that a \\nfault is not transient.\\nFor more informa\", \"tion about the circuit breaker pattern, see the Circuit Breaker pattern on Microsoft \\nDocs.\\nSummary\\n\", \"Many modern web-based solutions make use of web services, hosted by web servers, to provide \\nfunctio\", \"nality for remote client applications. The operations that a web service exposes constitute a \\nweb A\", \"PI, and client apps should be able to utilize the web API without knowing how the data or \\noperation\", \"s that the API exposes are implemented.\\nThe performance of an app can be improved by caching frequen\", \"tly accessed data to fast storage \\nthat's located close to the app. Apps can implement read-through \", \"caching with the cache-aside \\npattern. This pattern determines whether the item is currently in the \", \"cache. If the item isn't in the \\ncache, it's read from the data store and added to the cache. \\nWhen \", \"communicating with web APIs, apps must be sensitive to transient faults. Transient faults \\ninclude t\", \"he momentary loss of network connectivity to services, the temporary unavailability of a \\nservice, o\", \"r timeouts that arise when a service is busy. These faults are often self-correcting, and if the \\nac\", \"tion is repeated after a suitable delay, then it's likely to succeed. Therefore, apps should wrap al\", \"l \\nattempts to access a web API in code that implements a transient fault handling mechanism.86 CHAP\", \"TER 11 | Unit testing\\nC H A P T E R 11\\nUnit testing\\nMobile apps have unique problems that desktop an\", \"d web-based applications don't have to worry \\nabout. Mobile users will differ by the devices that th\", \"ey use, by network connectivity, by the availability\\nof services, and a range of other factors. Ther\", \"efore, mobile apps should be tested as they will be used \\nin the real world in order to improve thei\", \"r quality, reliability, and performance. There are many types \\nof testing that should be performed o\", \"n an app, including unit testing, integration testing, and user \\ninterface testing, with unit testin\", \"g being the most common form of testing.\\nA unit test takes a small unit of the app, typically a meth\", \"od, isolates it from the remainder of the code, \\nand verifies that it behaves as expected. Its goal \", \"is to check that each unit of functionality performs as \\nexpected, so that errors don't propagate th\", \"roughout the app. Detecting a bug where it occurs is more \\nefficient that observing the effect of a \", \"bug indirectly at a secondary point of failure. \\nUnit testing has the greatest effect on code qualit\", \"y when it's an integral part of the software \\ndevelopment workflow. As soon as a method has been wri\", \"tten, unit tests should be written that verify \\nthe behavior of the method in response to standard, \", \"boundary, and incorrect cases of input data, and \\nthat check any explicit or implicit assumptions ma\", \"de by the code. Alternatively, with test driven \\ndevelopment, unit tests are written before the code\", \". In this scenario, unit tests act as both design \\ndocumentation and functional specifications.\\nNote\", \": Unit tests are very effective against regression \\u2013 that is, functionality that used to work but \\nh\", \"as been disturbed by a faulty update.\\nUnit tests typically use the arrange-act-assert pattern:\\n\\u2022 The\", \" arrange section of the unit test method initializes objects and sets the value of the data \\nthat is\", \" passed to the method under test.\\n\\u2022 The act section invokes the method under test with the required \", \"arguments.\\n\\u2022 The assert section verifies that the action of the method under test behaves as expecte\", \"d.\\nFollowing this pattern ensures that unit tests are readable and consistent.\\nDependency injection \", \"and unit testing\\nOne of the motivations for adopting a loosely-coupled architecture is that it facil\", \"itates unit testing. \\nOne of the types registered with Autofac is the OrderService class. The follow\", \"ing code example \\nshows an outline of this class:\\npublic class OrderDetailViewModel : ViewModelBase\\n\", \"{\\n private IOrderService _ordersService;\\n public OrderDetailViewModel(IOrderService ordersService)87\", \" CHAPTER 11 | Unit testing\\n {\\n _ordersService = ordersService;\\n }\\n ...\\n}\\nThe OrderDetailViewModel cl\", \"ass has a dependency on the IOrderService type which the container \\nresolves when it instantiates a \", \"OrderDetailViewModel object. However, rather than create an \\nOrderService object to unit test the Or\", \"derDetailViewModel class, instead, replace the \\nOrderService object with a mock for the purpose of t\", \"he tests. Figure 10-1 illustrates this relationship.\\nFigure 10-1: Classes that implement the IOrderS\", \"ervice interface\\nThis approach allows the OrderService object to be passed into the OrderDetailViewM\", \"odel class at \\nruntime, and in the interests of testability, it allows the OrderMockService class to\", \" be passed into the \\nOrderDetailViewModel class at test time. The main advantage of this approach is\", \" that it enables unit \\ntests to be executed without requiring unwieldy resources such as web service\", \"s, or databases.\\nTesting MVVM applications\\nTesting models and view models from MVVM applications is \", \"identical to testing any other classes, and \\nthe same tools and techniques \\u2013 such as unit testing an\", \"d mocking, can be used. However, there are \\nsome patterns that are typical to model and view model c\", \"lasses, that can benefit from specific unit \\ntesting techniques.\\nTip: Test one thing with each unit \", \"test\\nDon't be tempted to make a unit test exercise more than one aspect of the unit's behavior. Doin\", \"g \\nso leads to tests that are difficult to read and update. It can also lead to confusion when \\ninte\", \"rpreting a failure.\\nThe eShopOnContainers mobile app uses xUnit to perform unit testing, which suppo\", \"rts two different \\ntypes of unit tests:\\n\\u2022 Facts are tests that are always true, which test invariant\", \" conditions.\\n\\u2022 Theories are tests that are only true for a particular set of data.88 CHAPTER 11 | Un\", \"it testing\\nThe unit tests included with the eShopOnContainers mobile app are fact tests, and so each\", \" unit test \\nmethod is decorated with the [Fact] attribute.\\nNote: xUnit tests are executed by a test \", \"runner. To execute the test runner, run the \\neShopOnContainers.TestRunner project for the required p\", \"latform.\\nTesting asynchronous functionality\\nWhen implementing the MVVM pattern, view models usually \", \"invoke operations on services, often \\nasynchronously. Tests for code that invokes these operations t\", \"ypically use mocks as replacements for \\nthe actual services. The following code example demonstrates\", \" testing asynchronous functionality by \\npassing a mock service into a view model:\\n[Fact]\\npublic asyn\", \"c Task OrderPropertyIsNotNullAfterViewModelInitializationTest()\\n{\\n var orderService = new OrderMockS\", \"ervice();\\n var orderViewModel = new OrderDetailViewModel(orderService);\\n var order = await orderServ\", \"ice.GetOrderAsync(1, GlobalSetting.Instance.AuthToken);\\n await orderViewModel.InitializeAsync(order)\", \";\\n Assert.NotNull(orderViewModel.Order);\\n}\\nThis unit test checks that the Order property of the Orde\", \"rDetailViewModel instance will have a value \\nafter the InitializeAsync method has been invoked. The \", \"InitializeAsync method is invoked \\nwhen the view model's corresponding view is navigated to. For mor\", \"e information about navigation, \\nsee Navigation.\\nWhen the OrderDetailViewModel instance is created, \", \"it expects an OrderService instance to be \\nspecified as an argument. However, the OrderService retri\", \"eves data from a web service. Therefore, \\nan OrderMockService instance, which is a mock version of t\", \"he OrderService class, is specified as the \\nargument to the OrderDetailViewModel constructor. Then, \", \"when the view model's \\nInitializeAsync method is invoked, which invokes IOrderService operations, mo\", \"ck data is \\nretrieved rather than communicating with a web service.\\nTesting INotifyPropertyChanged i\", \"mplementations\\nImplementing the INotifyPropertyChanged interface allows views to react to changes th\", \"at originate \\nfrom view models and models. These changes are not limited to data shown in controls \\u2013\", \" they are \\nalso used to control the view, such as view model states that cause animations to be star\", \"ted or \\ncontrols to be disabled.\\nProperties that can be updated directly by the unit test can be tes\", \"ted by attaching an event handler to \\nthe PropertyChanged event and checking whether the event is ra\", \"ised after setting a new value for the \\nproperty. The following code example shows such a test:\\n[Fac\", \"t]\\npublic async Task SettingOrderPropertyShouldRaisePropertyChanged()\\n{\\n bool invoked = false;\\n var \", \"orderService = new OrderMockService();\\n var orderViewModel = new OrderDetailViewModel(orderService);\", \"\\n orderViewModel.PropertyChanged += (sender, e) =>\\n {89 CHAPTER 11 | Unit testing\\n if (e.PropertyNam\", \"e.Equals(\\\"Order\\\"))\\n invoked = true;\\n };\\n var order = await orderService.GetOrderAsync(1, GlobalSetti\", \"ng.Instance.AuthToken);\\n await orderViewModel.InitializeAsync(order);\\n Assert.True(invoked);\\n}\\nThis \", \"unit test invokes the InitializeAsync method of the OrderViewModel class, which causes its \\nOrder pr\", \"operty to be updated. The unit test will pass, provided that the PropertyChanged event is \\nraised fo\", \"r the Order property.\\nTesting message-based communication\\nView models that use the MessagingCenter c\", \"lass to communicate between loosely-coupled classes \\ncan be unit tested by subscribing to the messag\", \"e being sent by the code under test, as demonstrated \\nin the following code example:\\n[Fact]\\npublic v\", \"oid AddCatalogItemCommandSendsAddProductMessageTest()\\n{\\n bool messageReceived = false;\\n var catalogS\", \"ervice = new CatalogMockService();\\n var catalogViewModel = new CatalogViewModel(catalogService);\\n Xa\", \"marin.Forms.MessagingCenter.Subscribe<CatalogViewModel, CatalogItem>(\\n this, MessageKeys.AddProduct,\", \" (sender, arg) =>\\n {\\n messageReceived = true;\\n });\\n catalogViewModel.AddCatalogItemCommand.Execute(n\", \"ull);\\n Assert.True(messageReceived);\\n}\\nThis unit test checks that the CatalogViewModel publishes the\", \" AddProduct message in response to \\nits AddCatalogItemCommand being executed. Because the MessagingC\", \"enter class supports multicast \\nmessage subscriptions, the unit test can subscribe to the AddProduct\", \" message and execute a callback \\ndelegate in response to receiving it. This callback delegate, speci\", \"fied as a lambda expression, sets a \\nboolean field that's used by the Assert statement to verify the\", \" behavior of the test.\\nTesting exception handling\\nUnit tests can also be written that check that spe\", \"cific exceptions are thrown for invalid actions or \\ninputs, as demonstrated in the following code ex\", \"ample:\\n[Fact]\\npublic void InvalidEventNameShouldThrowArgumentExceptionText()\\n{\\n var behavior = new M\", \"ockEventToCommandBehavior\\n {\\n EventName = \\\"OnItemTapped\\\"\\n };\\n var listView = new ListView();\\n Assert\", \".Throws<ArgumentException>(() => listView.Behaviors.Add(behavior));\\n}90 CHAPTER 11 | Unit testing\\nTh\", \"is unit test will throw an exception, because the ListView control does not have an event named \\nOnI\", \"temTapped. The Assert.Throws<T> method is a generic method where T is the type of the \\nexpected exce\", \"ption. The argument passed to the Assert.Throws<T> method is a lambda expression \\nthat will throw th\", \"e exception. Therefore, the unit test will pass provided that the lambda expression \\nthrows an Argum\", \"entException.\\nTip: Avoid writing unit tests that examine exception message strings\\nException message\", \" strings might change over time, and so unit tests that rely on their presence are\\nregarded as britt\", \"le.\\nTesting validation\\nThere are two aspects to testing the validation implementation: testing that \", \"any validation rules are \\ncorrectly implemented, and testing that the ValidatableObject<T> class per\", \"forms as expected.\\nValidation logic is usually simple to test, because it is typically a self-contai\", \"ned process where the \\noutput depends on the input. There should be tests on the results of invoking\", \" the Validate method \\non each property that has at least one associated validation rule, as demonstr\", \"ated in the following \\ncode example:\\n[Fact]\\npublic void CheckValidationPassesWhenBothPropertiesHaveD\", \"ataTest()\\n{\\n var mockViewModel = new MockViewModel();\\n mockViewModel.Forename.Value = \\\"John\\\";\\n mockV\", \"iewModel.Surname.Value = \\\"Smith\\\";\\n bool isValid = mockViewModel.Validate();\\n Assert.True(isValid);\\n}\", \"\\nThis unit test checks that validation succeeds when the two ValidatableObject<T> properties in the \", \"\\nMockViewModel instance both have data.\\nAs well as checking that validation succeeds, validation uni\", \"t tests should also check the values of the \\nValue, IsValid, and Errors property of each Validatable\", \"Object<T> instance, to verify that the \\nclass performs as expected. The following code example demon\", \"strates a unit test that does this:\\n[Fact]\\npublic void CheckValidationFailsWhenOnlyForenameHasDataTe\", \"st()\\n{\\n var mockViewModel = new MockViewModel();\\n mockViewModel.Forename.Value = \\\"John\\\";\\n bool isVal\", \"id = mockViewModel.Validate();\\n Assert.False(isValid);\\n Assert.NotNull(mockViewModel.Forename.Value)\", \";\\n Assert.Null(mockViewModel.Surname.Value);\\n Assert.True(mockViewModel.Forename.IsValid);\\n Assert.F\", \"alse(mockViewModel.Surname.IsValid);\\n Assert.Empty(mockViewModel.Forename.Errors);\\n Assert.NotEmpty(\", \"mockViewModel.Surname.Errors);\\n}91 CHAPTER 11 | Unit testing\\nThis unit test checks that validation f\", \"ails when the Surname property of the MockViewModel doesn't \\nhave any data, and the Value, IsValid, \", \"and Errors property of each ValidatableObject<T> instance \\nare correctly set.\\nSummary\\nA unit test ta\", \"kes a small unit of the app, typically a method, isolates it from the remainder of the code, \\nand ve\", \"rifies that it behaves as expected. Its goal is to check that each unit of functionality performs as\", \" \\nexpected, so that errors don't propagate throughout the app.\\nThe behavior of an object under test \", \"can be isolated by replacing dependent objects with mock \\nobjects that simulate the behavior of the \", \"dependent objects. This enables unit tests to be executed \\nwithout requiring unwieldy resources such\", \" as web services, or databases.\\nTesting models and view models from MVVM applications is identical t\", \"o testing any other classes, and \\nthe same tools and techniques can be used.92 CHAPTER 11 | Unit tes\", \"ting\"]"