"[\" \\n \\n \\nBook title  \\nBook subtitle  \\nAuthor Name  \\n \\n \\n \\n \\nPUBLISHED BY  \\n \\nDevDiv, .NET and Visual St\", \"udio produc teams  \\nA division of Microsoft Corporation  \\nOne Microsoft Way  \\nRedmond, Washington 98\", \"052 -6399  \\nCopyright \\u00a9 201 7 by Microsoft Corporation  \\nAll rights reserved. No part of the content\", \"s of this book may be reproduced or transmitted in any \\nform or by any means without the written per\", \"mission of the publisher.  \\nThis book is provided \\u201cas -is\\u201d and expresses the author\\u2019s views and opin\", \"ions. The views, opinions and \\ninformation expressed in this book, including URL and other Internet \", \"website references, may change \\nwithout notice.  \\nSome examples depicted herein are provi ded for il\", \"lustration only and are fictitious. No real association \\nor connection is intended or should be infe\", \"rred.  \\nMicrosoft and the trademarks listed at http://www.microsoft.com on the \\u201cTrademarks\\u201d webpage \", \"are \\ntrademarks of the Microsoft group of companie s. All other marks are property of their respecti\", \"ve \\nowners.  \\nAuthor:  David Britch  \\nDeveloper:  Javier Suarez Ruiz (Plain  Concepts)  \\nParticipant\", \"s and reviewers:  Craig Dunn , Tom Opgenorth  \\nEditor:  John Meade  (Populus Group)  \\n   i Contents \", \" \\nPreface  ................................ ................................ .......................\", \"......... ...........................  iv \\nPurpose  ................................ ...............\", \"................. ................................ ................................ .. iv \\nWhat's le\", \"ft out of this guide's scope  ................................ ................................ ....\", \"..........................  iv \\nWho should use this guide  ................................ ........\", \"........................ ................................ .............  iv \\nHow to use this guide  \", \"................................ ................................ ................................ .\", \".....................  v \\nIntroduction  ................................ ...........................\", \"..... ................................ ....................  1 \\nSample application  ................\", \"................ ................................ ................................ .................\", \"..  2 \\nSample application architecture ................................ ............................\", \".... ................................ ...... 2 \\nMobile app  ................................ .......\", \"......................... ................................ ................................ ....... \", \" 4 \\neShopOnContainers.Core project ................................ ................................\", \" ................................ ... 5 \\nPlatform projects  ................................ .......\", \"......................... ................................ ............................  6 \\nSummary \", \" ................................ ................................ ................................ \", \"................................ . 6 \\nMVVM  ................................ .......................\", \"......... ................................ .............................  7 \\nThe MVVM pattern  .....\", \"........................... ................................ ................................ ......\", \"............  7 \\nView  ................................ ................................ ...........\", \"..................... ................................ .................  8 \\nViewModel  ............\", \".................... ................................ ................................ .............\", \"................... .......  8 \\nModel  ................................ ............................\", \".... ................................ ................................ ...............  9 \\nConnectin\", \"g view models to v iews  ................................ ................................ .........\", \"....................  9 \\nCreating a view model declaratively  ................................ .....\", \"........................... ............................. 10 \\nCreating a view model programmatically\", \"  ................................ ................................ ..................... 10 \\nCreati\", \"ng a view defined as a data template  ................................ .............................\", \"... .................. 11 \\nAutomatically creating a view model with a view model locator  ..........\", \"...................... ................. 11 \\nUpdating view s in response to changes in the underlyin\", \"g view model or model  .......................  12 \\nUI interaction using commands and behaviors  ...\", \"............................. ................................ ........  13 \\nImplementing commands  \", \"................................ ................................ ................................ .\", \"............. 14 \\nImplementing behaviors  ................................ .........................\", \"....... ................................ ................ 15 \\nSummary  .............................\", \"... ................................ ................................ ..............................\", \".  17 \\nDependency injection  ................................ ................................ .....\", \"........................... .... 18 \\nIntroduction to dependency injection  .........................\", \"....... ................................ .....................  18 \\nRegistration  ..................\", \".............. ................................ ................................ ...................\", \"........  20 \\nResolution  ................................ ................................ ........\", \"........................ ..............................  22 \\nManaging the lifetime of resolved objec\", \"ts  ................................ ................................ ...............  22 \\nSummary  \", \"................................ ................................ ................................ .\", \"..............................  23 \\n  ii Communicating between loosely coupled components  .........\", \"....................... ..................  24 \\nIntroduction to MessagingCenter  ...................\", \"............. ................................ ............................  24 \\nDefining a message \", \"................................ ................................ ................................ .\", \"................  26 \\nPublishing a message  ................................ .......................\", \"......... ................................ ..............  26 \\nSubscribing to a message  ...........\", \"..................... ................................ ................................ ........  27\", \" \\nUnsubscribing from a message ................................ ................................ ...\", \".............................  27 \\nSummary  ................................ .......................\", \"......... ................................ ...............................  27 \\nNavigation  ........\", \"........................ ................................ ................................ .........\", \"............  28 \\nNavigating between pages  ................................ .......................\", \"......... ................................ ...... 29 \\nCreating the NavigationService instance  .....\", \"........................... ................................ ....................... 29 \\nHandling na\", \"vigation requests  ................................ ................................ ...............\", \"................. ........ 30 \\nNavigating when the app is launched  ................................\", \" ................................ ........................... 32 \\nPassing parameters during navigati\", \"on  ................................ ................................ .......................... 33 \", \"\\nInvoking navigation using behaviors  ................................ .............................\", \"... ............................. 34 \\nConfirming or cancelling navigation  .........................\", \"....... ................................ .............................. 34 \\nSummary  ...............\", \"................. ................................ ................................ ................\", \"...............  35 \\nValidation  ................................ ................................ .\", \"............................... ......................  36 \\nSpecifying validation rules  ...........\", \"..................... ................................ ................................ ...... 37 \\nA\", \"dding validation rules to a property  ................................ .............................\", \"... ......................  38 \\nTriggering validation  ................................ ............\", \".................... ................................ ...............  39 \\nTriggering validation man\", \"ually  ................................ ................................ ...........................\", \"..... ......39 \\nTriggering validation when properties change ................................ ......\", \".......................... .............. 40 \\nDisplaying validation errors  ........................\", \"........ ................................ ................................ .... 40 \\nHighlighting a c\", \"ontrol that contains invalid data  ................................ ................................\", \" .......... 41 \\nDisplaying error messages  ................................ ........................\", \"........ ................................ ............. 44 \\nSummary  ...............................\", \". ................................ ................................ ............................... \", \" 45 \\nConfiguration management  ................................ ................................ ...\", \"........................  46 \\nCreating a settings class  ................................ ..........\", \"...................... ................................ ..........  46 \\nAdding a setting  ..........\", \"...................... ................................ ................................ ...........\", \"..........  47 \\nData binding to user settings  ................................ ....................\", \"............ ................................ .. 48 \\nSummary  ................................ .....\", \"........................... ................................ ...............................  50 \\nCo\", \"ntainerized microservices  ................................ ................................ .......\", \"....................  51 \\nMicroservices  ................................ ..........................\", \"...... ................................ .........................  52 \\nContainerization  ...........\", \"..................... ................................ ................................ ............\", \".........  53 \\nCommunication between client and microservices  ................................ ....\", \"............................ .. 55 \\nCommunication between microservices  ...........................\", \"..... ................................ ..................  56 \\nSummary  ............................\", \".... ................................ ................................ .............................\", \"..  58 \\nAuthentication and authorization  ................................ .........................\", \"....... ..................  59 \\nAuthentication  ................................ ...................\", \"............. ................................ .......................  59 \\nIssuing bearer tokens us\", \"ing IdentityServer 4  ................................ ................................ ............\", \".... 60 \\nAdding IdentityServer to a web application  ................................ ..............\", \".................. .................. 60 \\nConfiguring IdentityServer  ..............................\", \".. ................................ ................................ ............ 61  iii Performing\", \" authentication  ................................ ................................ .................\", \"............... ............ 64 \\nAuthorization  ................................ ...................\", \"............. ................................ .........................  69 \\nConfiguring IdentitySe\", \"rver to perform authorization  ................................ ................................ ...\", \"70 \\nMaking access requests to APIs  ................................ ...............................\", \". ................................ .....71 \\nSummary  ................................ ..............\", \".................. ................................ ...............................  71 \\nAccessing r\", \"emote data  ................................ ................................ ......................\", \".......... ... 73 \\nIntroduction to Representational State Transfer ................................ \", \"................................ ...... 73 \\nConsuming RESTful APIs  ................................\", \" ................................ ................................ .........  74 \\nMaking web request\", \"s  ................................ ................................ ...............................\", \". .................... 74 \\nCaching data  ................................ ..........................\", \"...... ................................ ..........................  81 \\nManaging data expiration  ..\", \".............................. ................................ ................................ ...\", \".......... 82 \\nCaching images  ................................ ................................ ...\", \"............................. .............................. 82 \\nIncreasing resilience  ............\", \".................... ................................ ................................ .............\", \"..  83 \\nRetry pattern  ................................ ................................ ...........\", \"..................... ................................ .83 \\nCircuit breaker pattern  ...............\", \"................. ................................ ................................ ................\", \".. 84 \\nSummary  ................................ ................................ ..................\", \".............. ...............................  85 \\nUnit testing  ................................ .\", \"............................... ................................ ....................  86 \\nDependenc\", \"y injection and unit testing  ................................ ................................ ....\", \"................  86 \\nTesting MVVM applications  ................................ ..................\", \".............. ................................ .... 87 \\nTesting asynchronous functionality ........\", \"........................ ................................ ............................... 88 \\nTestin\", \"g INotifyPropertyChanged implementations ................................ ..........................\", \"...... ....... 88 \\nTesting message -based communication  ................................ ..........\", \"...................... ....................... 89 \\nTesting exception handling  .....................\", \"........... ................................ ................................ ............ 89 \\nTesti\", \"ng validation  ................................ ................................ ...................\", \"............. .......................... 90 \\nSummary  ................................ .............\", \"................... ................................ ...............................  91 \\n \\n  \\n \\n \\ni\", \"v Preface  \\n  \\n \\n Preface  \\n \\nPurpose  \\nThis eBook  provides guidance on building cross -platform en\", \"terprise apps using Xamarin.Forms. \\nXamarin.Forms is a cross -platform UI toolkit that allows develo\", \"pers to easily create native user \\ninterface layouts that can be shared across platforms, including \", \"iOS, Androi d, and the Universal \\nWindows Platform (UWP). It provides a comprehensive solution for B\", \"usiness to Employee (B2E), \\nBusiness to Business (B2B), and Business to Consumer (B2C) apps, providi\", \"ng the ability to share code \\nacross all target platforms and helping t o lower the total cost of ow\", \"nership (TCO).  \\nThe guide provides architectural guidance for developing adaptable , maintainable, \", \"and testable \\nXamari n.Forms enterprise apps . Guidance is provided on how to implement MVVM, depend\", \"ency \\ninjection, navigation, valida tion, and configuration management, while maintaining loose coup\", \"ling. In \\naddition, there's also guidance on performing authentication and authorization with Identi\", \"tyServer, \\naccessing data from containerized microservices, and unit testing.  \\nThe guide comes with\", \" source code for the eShopOnContainers mobile app , and source code for the \\neShopOnContainers refer\", \"ence app . The eShopOnContainers mobile app is a cross -platform enterprise \\napp developed using Xam\", \"arin.Forms, which connects to a series of containerized microservi ces known \\nas the eShopOnContain \", \"ers reference app. However, the  eShopOnContainers mobile app can be \\nconfigured to consume data fro\", \"m mock services  for those who wish to avoid deploying the \\ncontainerized microservices.  \\nWhat's le\", \"ft out of this guide's scope  \\nThis guide is aimed at readers who are already  familiar with  Xamari\", \"n.Forms . For a detailed \\nintroduction to Xamarin.Forms , see the Xamarin.Forms documentation  on th\", \"e Xamarin Developer \\nCenter, and Creating Mobile A pps with Xamarin.Forms . \\nThe guide is complement\", \"ary to .NET Microservices: Architecture for Containerized .NET Applications , \\nwhich focus es on dev\", \"eloping and deploying containerized microservices.  Other guide s worth reading \\ninclude Architectin\", \"g and Developing Modern Web Applications with ASP.NET Core and Microsoft \\nAzure , Containerized Dock\", \"er Application Lifecycle with Microsoft Platform and Tools , and Microsoft \\nPlatform and Tools for M\", \"obile App Development . \\nWho should use this guide  \\nThe audience for this guide is mainly developer\", \"s and architects who would li ke to learn how  to \\narchitect and implement cross -platform enterpris\", \"e apps using Xamarin.Forms.  v Preface  \\n A secondary audience is technical decision makers who woul\", \"d like to receive an architectural and \\ntechnology overview before deciding on what approach to sele\", \"ct for cross -platfo rm enterprise app \\ndevelopment using Xamarin.Forms.  \\nHow to use this guide  \\nT\", \"his guide focuses on building cross -platform enterprise apps using Xamarin.Forms. As such, it shoul\", \"d \\nbe read in its entirety to provide a foundation of understanding such apps and th eir technical \\n\", \"considerations. The guide, along with its sample app, can also serve as a starting point or referenc\", \"e for \\ncreating a new enterprise app. Use the associated sample app as a template for the new app, o\", \"r to see \\nhow to organize an app's component  parts. Then, refer back to this guide for architectura\", \"l guidance.  \\nFeel free to forward this guide to team members to help ensure a common understanding \", \"of cross -\\nplatform enterprise app development using Xamarin.Forms. Having everybody working from a \", \"\\ncommo n set of terminologies  and underlying principles will help ensure a consistent application o\", \"f \\narchitectural patterns and practices.  \\n  \\n \\n \\n1 CHAPTER  1  |  Introduction  \\n  \\n \\nC H A P T E R\", \"  \\n \\n \\n 1 \\n Introduction  \\nRegardless of platform, d evelopers of enterprise apps face several  chal\", \"lenges:  \\n\\u2022 App requirements  that can change over time.  \\n\\u2022 New business opportunities and challeng\", \"es.  \\n\\u2022 Ongoing feedback during development that can  significantly affect the scope and \\nrequiremen\", \" ts of the app.  \\nWith these in mind , it's important to build app s that can be easily modified or \", \"extended over time . \\nDesigning for such adaptability  can be difficult as it requires an architectu\", \"re that allows individual \\nparts of the app to be ind ependently d eveloped and tested  in isolation\", \" without affecting the rest of \\nthe app.  \\nMany enterprise apps are sufficiently complex to require \", \"more than one developer. It can be a \\nsignificant challenge to decide how to design an app so that m\", \"ultiple developers can work effectively \\non different piec es of the app independently, while  ensur\", \"ing that the pieces come toge ther seamlessly \\nwhen integrated  into the app.  \\nThe traditional appr\", \"oach to designing and building an app results in what is referred to as a \\nmonolithic  app, where co\", \"mponents are tightly coupled with no clear separation between them.  \\nTypically, this monolithic app\", \"roach leads to apps that are difficult and inefficient to maintain , because  \\nit can be difficult t\", \"o resolve bugs without breaking other components in the  app, and it can be  \\ndifficult to add new f\", \"eatures or to replace existing features.  \\nAn effective remedy for these challenges is to partition \", \"an app into discrete, loosely coupled  \\ncomponents that can be easily integrated together into an ap\", \"p. Such an approac h offers several  \\nbenefits:  \\n\\u2022 It allows individual functionality to be develop\", \"ed, tested, extended, and maintained by \\ndifferent individuals or teams.  \\n\\u2022 It promotes reuse and a\", \" clean separation of concerns between the app's horizontal \\ncapabilities, such as authe ntication an\", \"d data access, and the vertical capabilities, such as app \\nspecific business functionality. This all\", \"ows the dependencies and interactions between app \\ncomponents to be more easily managed.  \\n\\u2022 It help\", \"s maintain a separation of roles by allowing diffe rent individuals, or teams, to focus on \\na specif\", \"ic task or piece of functio nality according  to their expertise. In particular, it provides a \\nclea\", \"ner separation between the user interface  and the app's business log ic. \\nHowever, t here are many \", \"issues that must be  resolv ed when partitioning an app into discrete, loosely \\ncoupled components. \", \"These include:  \\n\\u2022 Decid ing how to provide a clean separation of concerns between the user interfac\", \"e controls \\nand their logic. One of the most important decisions when creatin g a Xamarin.Forms \\nent\", \"erprise app is whether to place business logic in code -behind files, or whether to create a \\nclean \", \"separation of concerns between the user interface controls and their logic, in order to 2 CHAPTER  1\", \"  |  Introduction  \\n make the app more maintainable and testable. For more information, see  Model -\", \"View -\\nViewModel . \\n\\u2022 Determining  whether to use a dependency injection container. Dependency injec\", \"tion \\ncontainers reduce the dependency coupling between objects by providing a facility to \\nconstruc\", \"t instances o f classes with their dependencies injected, and manage their lifetime \\nbased on the co\", \"nfiguration of the container. For more information, see Dependency injection . \\n\\u2022 Choos ing between \", \"platform provided eventing and loosely coupled message -based \\ncommunication between components that\", \" are inconvenient to link by object and type \\nreferences.  For more information, see Introduction to\", \" Communicating between loosely \\ncoupled components . \\n\\u2022 Deciding  how to navigate bet ween pages, in\", \"cluding how to invoke navigation, and where \\nnavigation logic should reside. For more information, s\", \"ee Navigation . \\n\\u2022 Determining  how to validate user input for correctness. The decision must includ\", \"e how to \\nvalidate user input, and how to notify the user about validation errors. For more informat\", \"ion, \\nsee Validation . \\n\\u2022 Deciding  how to perform authentication, and how to protect resources with\", \" authorization. F or \\nmore information, see Authenticat ion and authorization . \\n\\u2022 Determining  how \", \"to access remote data from web services, including how to reliably retrieve \\ndata, and how to cache \", \"data. F or more information, see Accessing remote data . \\n\\u2022 Deciding  how to test the app. For  more\", \" information, see Unit testing . \\nThis guide provides guidance on  these issues, and focuses on the \", \"core patterns and architecture for \\nbuilding a cross -platform enterprise app using Xamarin.Forms. T\", \"he guidance aims to help to  produce \\nadaptable , maintainable, and testable code, by addressing com\", \"mon Xamarin.Forms enterpris e app \\ndevelopment scenarios, and by separating the concerns of presenta\", \"tion, presentation logic, and \\nentities through support for the Model -View -ViewModel (MVVM) patter\", \"n.  \\nSample application  \\nThis guide in cludes a sample application,  eShopOnContainers , that's an \", \"online store  that includes  the \\nfollowing functionality:  \\n\\u2022 Authenticating and authorizing  again\", \"st a backend service.  \\n\\u2022 Browsing a catalog of shirts, coffee mugs, and other marketing items.  \\n\\u2022 \", \"Filtering the catalog.  \\n\\u2022 Ordering items from the catalog.  \\n\\u2022 Viewing the user's order history.  \\n\", \"\\u2022 Configuration of settings.  \\nSample application architecture  \\nFigure 1 -1 provides a high -level \", \"overview of the architecture of the sample application.  3 CHAPTER  1  |  Introduction  \\n Figure 1-1\", \": eShopOnContainers high-level architecture  \\nThe sample application ships with three client apps:  \", \"\\n\\u2022 An MVC application developed with ASP.NET Core.  \\n\\u2022 A Single Page Application (SPA) developed wit\", \"h Angular 2 and Typescript. This approach for \\nweb applications avoids performing a round -trip to t\", \"he server with each operation.  \\n\\u2022 A mobile a pp developed with Xamarin.Forms, which supports iOS, A\", \"ndroid, and the Universal \\nWindows Platform (UWP).  \\nFor information about the web applications, see\", \" Architecting and Developing Modern Web \\nApplications with ASP.N ET Core and Microsoft Azure . \\nThe \", \"sample application includes the following backend services:  \\n\\u2022 An identity microservice, which uses\", \" ASP.NET Core Identity and IdentityServer.  \\n\\u2022 A catalog micro service, which is a data -driven  cre\", \"ate, read, update, delete (CRUD) s ervice that \\nconsumes an SQL Server database using  EntityFramewo\", \"rk Core.  \\n\\u2022 An ordering microservice , which is a domain -driven service that uses domain -driven d\", \"esign \\npatterns . \\n\\u2022 A basket microservice , which is a data -driven CRUD service that uses Redis Ca\", \"che.  \\nThese backend services are implemented as mic roservices using ASP.NET Core MVC , and are \\nde\", \"ployed as unique containers within a single Docker host.  Collectively, these backend services are \\n\", \"referred to as the eShopOnContainers reference application.  Client a pps communicate with th e \\nbac\", \"kend services through a Representational State Transfer (REST)  web interface. For more \\ninformation\", \" about microservic es and Docker, see Containerized microservices . \\nFor information about the imple\", \"mentation of the backend services, see .NET Microservices: \\nArchitecture for Containerized .NET Appl\", \"ications . \\n4 CHAPTER  1  |  Introduction  \\n Mobile app  \\nThis guide focuses on building cross -plat\", \"form enterprise apps using Xamarin.Forms, and uses the \\neShopOnContainers mobi le app as an example.\", \" Figure 1 -2 shows the pages from the \\neShopOnContainers mobile app that provide the functionality o\", \"utlined earlier.  \\nFigure  1-2: The eShopOnContainers mobile app  \\nThe mobile app consumes the backe\", \"nd services provided by the eShopOnContainers reference \\napplication. However, it can be configured \", \"to consume data from mock service s for those who wish to \\navoid deploying the backend services.   \\n\", \"The eShopOnContainers mobile app exercises the following Xamarin.Forms functionality:  \\n\\u2022 XAML  \\n\\u2022 C\", \"ontrols  \\n\\u2022 Bindings  \\n\\u2022 Converters  \\n\\u2022 Styles  \\n5 CHAPTER  1  |  Introduction  \\n \\u2022 Animations  \\n\\u2022 C\", \"ommands  \\n\\u2022 Behaviors  \\n\\u2022 Triggers  \\n\\u2022 Effects  \\n\\u2022 Custom Renderers  \\n\\u2022 MessagingCenter  \\n\\u2022 Custom C\", \"ontrols  \\nFor more information a bout this functionality, see the Xamarin.Forms documentation  on th\", \"e Xamarin \\nDeveloper Center, and Creating Mobile Apps with Xamarin.Forms . \\nIn additi on, unit tests\", \" are provided for some of the classes in the eShopOnContainers mobile app.  \\nMobile app  solution  \\n\", \"The eShopOnContainers mobile app  solution organizes the source code and other resources into \\nproje\", \"cts. All of the projects use folders to organize the source code and other resources into \\ncategorie\", \"s. The following table outlines the projects that make up the eSho pOnContainers mobile \\napp: \\nProje\", \"ct  Description  \\neShopOnContainers.Core  This project is the portable class library (PCL) project \\n\", \"that contains  the shared code and shared UI.  \\neShopOnContainers.Droid  This project holds Android \", \"specific code and is the \\nentry point for the Android app.  \\neShopOnContainers.iOS  This project hol\", \"ds iOS specific code and is the entry \\npoint for the iOS app.  \\neShopOnContainers.UWP  This project \", \"holds Universal Windows Platform (UWP) \\nspecific code and is the entry point for the Windows \\napp. \\n\", \"eShopOnContainers.TestRunner.Droid  This project is the Android test runner for the \\neShopOnContaine\", \"rs.UnitTests project.  \\neShopOnContainers.TestRunner.iOS  This project is the iOS test runner for th\", \"e \\neShopOnContainers.UnitTests project.  \\neShopOnContainers.Te stRunner.Windows  This project is the\", \" Universal Windows Platform test \\nrunner for the eShopOnContainers.UnitTests project.  \\neShopOnConta\", \"iners.UnitTests  This project contains unit tests for the \\neShopOnContainers.Core project.  \\n \\nThe c\", \"lasses  from the eShopOnCon tainers mobile app  can be re -used  in any Xamarin.Forms app with \\nlitt\", \"le or no modification.  \\neShopOnContainers.Core project  \\nThe eShopOnContainers.Core PCL project con\", \"tains the following folders:  \\n 6 CHAPTER  1  |  Introduction  \\n Folder  Description  \\nAnimations  C\", \"ontains classes that enable animations to be consumed in XAML.  \\nBehaviors  Contains behaviors that \", \"are exposed to view classes.  \\nControls  Contains custom controls used by the app.  \\nConverters  Con\", \"tains value converters that apply custom logic to a binding.  \\nEffects  Contains the EntryLineColorE\", \"ffect  class, which is used to change the border \\ncolor of specific Entry  controls.  \\nExceptions  C\", \"ontains the custom ServiceAuthenticationException . \\nExtensions  Contains extension methods for the \", \"VisualElement  and IEnumerable<T>  classes.  \\nHelpers  Contains helper classes for the app.  \\nModels\", \"  Contains the model classes for the app.  \\nProperties  Contains AssemblyInfo.cs , a .NET assembly m\", \"etadata file.  \\nServices  Contains interfaces and classes that implement services that are provided \", \"to the \\napp. \\nTriggers  Contains the BeginAnimation  trigger, which is used to invoke an animation i\", \"n \\nXAML.  \\nValidations  Contains classes involved in validating data input.  \\nViewModels  Contains t\", \"he application logic that's exposed to pages.  \\nViews  Contains the pages for t he app.  \\n \\nPlatform\", \" projects  \\nThe platform projects contain effect implementations, custom renderer implementations, a\", \"nd other \\nplatform -specific resources.  \\nSummary  \\nXamarin's cross -platform mobile app development\", \" tools and platforms provide a comprehensive \\nsolution for B2E, B2B, and B2C mobile client apps, pro\", \"viding the ability to share code across all target \\nplatforms (iOS, Android, and Windows) and helpin\", \"g to low er the total cost of ownership . Apps can \\nshare their user interface  and app l ogic code,\", \" while r etaining the  native platform look and feel.  \\nDevelopers of enterprise apps face several c\", \"hallenges that can alter the architecture of the app during \\ndevelopment. Therefore, it's impor tant\", \" to build an app so that it  can be modified or extended over \\ntime. Designing for such adap tabilit\", \"y  can be difficult , but typically involves partitioning an app into \\ndiscrete, loosely coupled com\", \"ponents that can  be easily integrated together into an app. \\n \\n \\n7 CHAPTER  2  |  MVVM  \\n  \\n \\nC H A\", \" P T E R  \\n \\n \\n 2 \\n MVVM  \\nThe Xamarin.Forms developer experience typically involves creating a user\", \" interface in XAML, and then \\nadding code -behind that operates on the user interface. As apps are m\", \"odified, and grow in size and \\nscope, complex maintenance issues can arise. These issues include the\", \" tight coupling between the UI \\ncontrols and the business logic, which increases  the cost of making\", \" UI modifications, and the difficulty \\nof unit testing such code.  \\nThe Model -View -ViewModel (MVVM\", \") pattern helps to cleanly separate the business and presentation \\nlogic of an application from its \", \"user interface (UI). Maintaining a clean se paration between application \\nlogic and the UI helps to \", \"address numerous development issues and can make an application easier \\nto test, maintain, and evolv\", \"e. It can also greatly improve code re -use opportunities and allows \\ndevelopers and UI designers to\", \" mor e easily collaborate when developing their respective parts of an \\napp. \\nThe MVVM pattern  \\nThe\", \"re are three core components in the MVVM pattern: the model, the view, and the view model. \\nEach ser\", \"ves a distinct purpose. Figure 2 -1 shows the relationships betwee n the three components.  \\nFigure \", \"2 -1: The MVVM pattern  \\nIn addition to understanding the responsibilities of each components, it's \", \"also important to \\nunderstand how they interact with each other. At a high level, the view \\\"knows ab\", \"out\\\" the view model, \\nand the view model \\\"knows about\\\" the model, but the model is unaware of the vi\", \"ew model, and the \\nview model is unaware of the view. Therefore, the view model isolates the view fr\", \"om the model, and \\nallows the model to evolve independently of the view.  \\nThe benefits of  using th\", \"e MVVM pattern are as follows:  \\n\\u2022 If there's an existing model implementation that encapsulates exi\", \"sting business logic, it can \\nbe difficult or risky to change it. In this scenario, the view model a\", \"cts as an adapter for the \\nmodel classes and enables you to avoid making any major changes to the mo\", \"del code.  \\n8 CHAPTER  2  |  MVVM  \\n \\u2022 Developers can create unit tests for the view model and the m\", \"odel, without using the view. \\nThe unit tests for the view model can exercise exactly the same funct\", \"ionality as used by the \\nview.  \\n\\u2022 The app U I can be redesigned without touching the code, provided\", \" that the view is \\nimplemented entirely in XAML. Therefore, a new version of the view should work wi\", \"th the \\nexisting view model.  \\n\\u2022 Designers and developers can work independently and concurrently on\", \" their components \\nduring the development process. Designers can focus on the view, while developers\", \" can work \\non the view model and model components.  \\nThe key to using MVVM effectively lies in under\", \"standing how to factor app code into the correct \\nclasses, and in un derstanding how the classes int\", \"eract. The following sections discuss the \\nresponsibilities of each of the classes in the MVVM patte\", \"rn.  \\nView  \\nThe view is responsible for defining the structure, layout, and appearance of what the \", \"user sees on \\nscreen. Ideally, each view is defined in XAML, with a limited code -behind that does n\", \"ot contain \\nbusiness logic. However, i n some cases, the code -behind might  contain UI logic that i\", \"mplements \\nvisual behavior that is difficult to express in XAML, such as animations.  \\nIn a Xam arin\", \".Forms application, a view is typically a Page -derived or ContentView -derived class. \\nHowever, vie\", \"ws can also be represented by a data template, which specifies the UI elements to be \\nused to visual\", \"ly represent an object when it's displayed. A data templ ate as a view does not have any \\ncode -behi\", \"nd, and is designed to bind to a specific view model type.  \\nTip: Avoid enabling and disabling UI el\", \"ements in the code -behind  \\nEnsure that view models are responsible for defining logical state chan\", \"ges that affect some  aspect s \\nof the view's display, such as whether a command is available, or an\", \" indication that an operation is \\npending. Therefore, enable and disable UI elements by binding to v\", \"iew model properties, rather \\nthan enabling and disabling them in code -behind.  \\nThere are several \", \"options for executing code on the view model in response to interactions on the \\nview, such as a but\", \"ton click or item selection. If a control supports commands, the control's Command  \\nproperty can be\", \" data -bound to an ICommand  property on the view model. When the control's \\ncommand is invoked, the\", \" code in the view model will be executed. In addition to commands, \\nbehaviors can be attached to an \", \"object in the view and can listen for either a command to be invoked \\nor event to be raised. In resp\", \"onse , the behavior can then invoke an ICommand  on the view model or a \\nmethod on the view model.  \", \"\\nViewModel  \\nThe view model implements properties and commands to which the view can data bind to, a\", \"nd \\nnotifies the view of any state changes through change notificati on events. The properties and \\n\", \"commands that the view model provides define the functionality to be offered by the UI, but the view\", \" \\ndetermines how that functionality is to be displayed.  \\nTip: Keep the UI responsive with asynchron\", \"ous operations  \\nMobile apps sh ould keep the UI thread unblocked to improve the user's perception o\", \"f \\nperformance. Therefore,  in the view model,  use asynchronous metho ds for I/O operations and rai\", \"se  \\nevents to asynchronously notify views of property changes.  9 CHAPTER  2  |  MVVM  \\n The view m\", \"odel is also respons ible for coordinating the view's interactions with any model classes that \\nare \", \"required. There's typically a one -to-many relationship between the view model and the model \\nclasse\", \"s. The view model might choose to expose model classes directly to the view so t hat controls in \\nth\", \"e view can data bind directly to them. In this case, the model classes will need to be designed to \\n\", \"support data binding and change notification events.  \\nEach view model provides data from a model in\", \" a form that the view can easily consume.  To \\naccomplish this, the view model sometimes performs da\", \"ta conversion. Placing this data conversion in \\nthe view model is a good idea because it provides pr\", \"operties that the view can bind to.  For example, \\nthe view model might  combine the value s of two \", \"properties to make it easier for display by the view.  \\nTip: Centralize data conversions in a conver\", \"sion layer  \\nIt's also possible to use converters as a  separate data conversion layer that sits bet\", \"ween the view \\nmodel and the view. This can be necessary, for example, when data requires special fo\", \"rmatting that \\nthe view model doesn't provide.  \\nIn order for the view model to participate in two -\", \"way data binding  with the view, its properties must \\nraise the PropertyChanged  event. View models \", \"satisfy this requirement by implementing the \\nINotifyPropertyChanged interface, and raising the Prop\", \"ertyChanged  event when a property is \\nchanged.  \\nFor collections, the view -friendly ObservableColl\", \"ection<T>  is provided. This collection implements \\ncollection changed notification, relieving the d\", \"eveloper from having to implement the \\nINotifyCollectionChanged  interface on collections.  \\nModel  \", \"\\nModel classes are non -visual classes that en capsulate the app's data. Therefore, the model can be\", \" \\nthought of as representing the app's domain model, which usually includes a data model along with \", \"\\nbusiness and validation logic. Examples of model objects include data transfer objects (DTOs), Plai\", \"n \\nOld CLR Objects (POCOs), and generated entity and proxy objects.  \\nModel classes are typically us\", \"e d in conjunction with  service s or repositor ies that encapsulate data \\naccess and caching.  \\nCon\", \"necting view models to views  \\nView models can be connected to views by u sing the data-binding capa\", \"bilities of Xamarin.Forms . \\nThere are many approaches that can be used to construct views and view \", \"models and associate them \\nat runtime.  These approaches fall into two categories, known as view fir\", \"st composition, and view \\nmodel fir st composition. Choosing between view first composition and view\", \" model first composition is \\nan issue of preference and complexity.  However, all approaches share t\", \"he same aim, which is for the \\nview to have a view model assigned to its BindingContext  propert y. \", \"\\nWith view first composition the app is conceptually composed of views that connect to the view \\nmod\", \"els they depend on. The primary benefit of this approach is that it makes it easy to construct \\nloos\", \"ely coupled, unit testable apps because the view models have no dependence on the views \\nthemselves.\", \" It's also easy to understand the structure of the app by following its visual structure, \\nrather th\", \"an having to track code execution to understand how classes are created and associated. In \\naddition\", \", view first co nstruction aligns with the Xamarin.Forms navigation system that's responsible \\nfor c\", \"onstructing pages when navigation occurs, which makes a view model first composition complex \\nand mi\", \"saligned with the platform.  10 CHAPTER  2  |  MVVM  \\n With view model first composition the app is \", \"c onceptually composed of view models , with a service \\nbeing responsible for locating the view for \", \"a view model. View model first composition feels more \\nnatural to some developers, since the view cr\", \"eation can be abstracted away, allowing them to focus \\non the logical non -UI structure of the app. \", \"In addition, it allows view models to be created by other \\nview models.  However, this approach is o\", \"ften complex and it can become difficult to understand how \\nthe various parts of the app are created\", \" and associated.  \\nTip: Keep view models and views independent  \\nThe binding of views to a property \", \"in a data source should be the view's principal dependency on \\nits corresponding view model. Specifi\", \"cally, don't reference view types , such as Button  and \\nListView , from view models. By following t\", \"he principles outlined here, view models can be tested \\nin isolation, therefore reducing the likelih\", \"ood of software defects by limiting scope.  \\nThe following sections discuss the main approaches to c\", \"onnecting view models to views.  \\nCreating a view model declaratively  \\nThe simplest approach is for\", \" the view to declaratively instantiate its corresponding view model in \\nXAML. When the view is const\", \"ructed, the corresponding view model object will also be constructed. \\nThis approach is demonstrated\", \" in t he following code example:  \\n<ContentPage  ... xmlns:local= \\\"clr-namespace:eShop\\\" > \\n    <Cont\", \"entPage.BindingContext > \\n        <local:LoginViewModel  /> \\n    </ContentPage.BindingContext > \\n   \", \" ... \\n</ContentPage >  \\nWhen the ContentPage  is created, an instance of the LoginViewModel  is auto\", \"matically constructed \\nand set as the view's BindingContext . \\nThis declarative construction and ass\", \"ignment of the view model by the view has the advantage that \\nit's simple, but has the disadvantage \", \"that it requires a default (parameter -less) constructor in the view \\nmodel.  \\nCreating a view model\", \" programmatically  \\nA view can have code in the code -behind file that results in the view model bei\", \"ng assigned to its \\nBindingContext property. This is often accomplished in the view's constructor, a\", \"s s hown in the \\nfollowing code example:  \\npublic LoginView()  \\n{ \\n    InitializeComponent();  \\n    \", \"BindingContext  = new LoginViewModel (navigationService);  \\n}  \\nThe programmatic construction and as\", \"signment of the view model within the view's code -behind has \\nthe advantag e that it's simple. Howe\", \"ver, the main disadvantage of this approach is that the view \\nneeds to provide the view model with a\", \"ny required dependencies. Using a dependency injection \\ncontainer can help to main tain loose coupli\", \"ng between the view and view model.  For more \\ninformation, see Dependency injection . 11 CHAPTER  2\", \"  |  MVVM  \\n Creating a view defined as a data template  \\nA view can be defined as a data template a\", \"nd associated with a view model type. Data templates can \\nbe defined as resources, or they can be de\", \"fined inline within the control that will display the view \\nmodel. The content of the control is the\", \" view model instance, and the data template is used to visually \\nrepresent it. This technique is an \", \"example of a situation in which the view model is instan tiated first, \\nfollowed by the creation of \", \"the view.  \\nAutomatically creating a view model with a view model locator  \\nA view model locator is \", \"a custom class that manages the instantiation of view models and their \\nassociation to views. In the\", \" eShopOnContainers mobile app, the ViewModelLocator  class has an \\nattached property, AutoWireViewMo\", \"del , that's used to associate view models with views. In the view's \\nXAML , this attached property \", \"is set to true  to indicate that the view model should be automatically \\nconnected to the view, as s\", \"hown in the following code example:  \\nviewModelBase:ViewModelLocator.AutoWireViewModel=\\\"true\\\"  \\nThe \", \"AutoWireViewModel  property is a bindable property that's initialized to false, and when its \\nvalue \", \"changes the OnAutoWireViewModelChanged  event handler is called. This method resolves the \\nview mode\", \"l for the view. The following code example shows how this is achieved:  \\nprivate static void OnAutoW\", \"ireViewModelChanged( BindableObject  bindable, object oldValue,  object n\\newValue)  \\n{ \\n    var view\", \" = bindable  as Element; \\n    if (view == null) \\n    { \\n        return; \\n    } \\n \\n    var viewType  \", \"= view.GetType();  \\n    var viewName  = viewType.FullName.Replace( \\\".Views.\\\" , \\\".ViewModels.\\\" ); \\n  \", \"  var viewAssemb lyName = viewType.GetTypeInfo().Assembly.FullName;  \\n    var viewModelName  = strin\", \"g.Format(  \\n        CultureInfo .InvariantCulture,  \\\"{0}Model,  {1}\\\", viewName,  viewAssemblyName); \", \" \\n \\n    var viewModelType  = Type.GetType(viewModelName);  \\n    if (viewModelType  == null) \\n    { \\n\", \"        return; \\n    } \\n    var viewModel  = _container.Resolve(viewModelType);  \\n    view.BindingCo\", \"ntext  = viewModel;  \\n}  \\nThe OnAutoWireViewModelChanged  method attempts to resolve the view model \", \"using a convention -\\nbased approach. This convention assumes that:  \\n\\u2022 View models are in the same a\", \"ssembly as view types.  \\n\\u2022 Views are in a .Views child namespace.  \\n\\u2022 View models are in a .ViewMode\", \"ls child namespace.  \\n\\u2022 View mo del names correspond with view names and end with \\\"ViewModel\\\".  12 C\", \"HAPTER  2  |  MVVM  \\n Finally, the OnAutoWireViewModelChanged  method sets the BindingContext  of th\", \"e view type to the \\nresolved view model type. For more information about resolving the view model ty\", \"pe, see Resolution . \\nThis approach has the advantage that an app has a single class that is respons\", \"ible for the instantiation \\nof view models and their connection to views.  \\nTip: Use a view model lo\", \"cator for ease of substitution  \\nA view model loca tor can also be used as a point of substitution f\", \"or alternate implementations of \\ndependencies, such as for unit testing or design time data.  \\nUpdat\", \"ing views in response to changes in the \\nunderlying view model or model  \\nAll view model and model c\", \"lasses that a re accessible to a view should implement the \\nINotifyPropertyChanged  interface. Imple\", \"menting this interface in a view model or model class \\nallows the class to provide change notificati\", \"ons to any data -bound controls in the view when the \\nunderlying property v alue changes.  \\nApp's sh\", \"ould be architected for the correct use of property change notification, by  meeting the \\nfollowing \", \"requirements : \\n\\u2022 Always raising a PropertyChanged  event if a public property's value changes. Do n\", \"ot assume \\nthat raising the PropertyChang ed event can be ignored because of knowledge of how XAML \\n\", \"binding occurs.  \\n\\u2022 Always raising a PropertyChanged  event for any calculated properties whose valu\", \"es are used \\nby other properties in the view model or model.  \\n\\u2022 Always raising the PropertyChanged \", \" event at the end of the method that makes a property \\nchange, or when the object is known to be in \", \"a safe state. Raising the event interrupts the \\noperation by invoking the event's handlers synchrono\", \"usly. If this happens in the middle of an \\noperation, it might  expose  the object to callback funct\", \"ions when it is in an unsafe, partially \\nupdate d state. In addition, it's possible for cascading ch\", \"anges to be triggered by \\nPropertyChanged  events. Cascading changes generally require updates to be\", \" complete \\nbefore the cascading change is safe to execute.  \\n\\u2022 Never raising a PropertyChanged  even\", \"t if the property does not change. This means that you \\nmust compare the old and new values before r\", \"aising the PropertyChanged event.  \\n\\u2022 Never raising the PropertyChanged  event during a view model' \", \"s constructor if you are \\ninitializing a property. Data -bound controls in the view will not have su\", \"bscribed to receive \\nchange notifications at this point.  \\n\\u2022 Never raising more than one PropertyCha\", \"nged  event with the same property name \\nargument within a single  synchronous invocation of a publi\", \"c method of a class. For example, \\ngiven a NumberOfItems  property whose backing store is the _numbe\", \"rOfItems  field, if a \\nmethod increments _numberOfItems  fifty times during the execution of a loop,\", \" it should only \\nraise prope rty change notification on the NumberOfItems  property once, after all \", \"the work is \\ncomplete. For asynchronous methods, raise the PropertyChanged  event for a given proper\", \"ty \\nname in each synchronous segment of an asynchronous continuation chain.  \\nThe eShopOnContainers \", \"mobile app uses the ExtendedBindableObject class to provide change \\nnotifications , which is shown i\", \"n the following code example:  13 CHAPTER  2  |  MVVM  \\n public abstract  class ExtendedBindableObje\", \"ct  : BindableObject  \\n{ \\n    public void RaisePropertyChanged< T>(Expression <Func<T>> property)  \\n\", \"    { \\n        var name = GetMemberInfo(property).Name;  \\n        OnPropertyChanged(name);  \\n    } \\n\", \" \\n    private MemberInfo  GetMemberInfo( Expression  expression)  \\n    { \\n        ... \\n    } \\n}  \\nXa\", \"marin.Form's BindableObject  class implemen ts the INotifyPropertyChanged  interface, and \\nprovides \", \"an OnPropertyChanged  method. The ExtendedBindableObject  class provides the \\nRaisePropertyChanged  \", \"method to invoke property change notification, and in doing so uses the \\nfunctionality provided by t\", \"he BindableObject  class.  \\nEach view model class in the eShopOnContainers mobile app derives from t\", \"he ViewModelBase  class, \\nwhich in turn derives from the ExtendedBindableObject  class. Therefore, e\", \"ach view model class uses \\nthe RaisePropertyChanged  method in the ExtendedBindableObject  class to \", \"provide property \\nchange notification. The following code example shows how the eShopOnContainers mo\", \"bile app \\ninvokes property change notification by using a lambda expression:  \\npublic bool IsLogin \\n\", \"{ \\n    get \\n    { \\n        return _isLogin;  \\n    } \\n    set \\n    { \\n        _isLogin  = value; \\n   \", \"     RaisePropertyChanged(()  => IsLogin);  \\n    } \\n}  \\nNote that using a lambda expression in this \", \"way involves a small performance cost because the \\nlambda expression has to be evaluated for each ca\", \"ll . Although the performance cost is small and \\nwould not normally impact an app, the costs can acc\", \"rue when there are many change notifications. \\nHowever, the benefit of this approach is that it prov\", \"ides compile -time type safety and refactoring \\nsupport when re naming properties.  \\nUI interaction \", \"using commands and behaviors  \\nIn mobile apps, actions are typically invoked in response to a user a\", \"ction, such as a button click, that \\ncan be implemented by creating an event handler in the code -be\", \"hind file. However, in the  MVVM \\npattern, the responsibility for implementing the action lies with \", \"the view model, and placing code in \\nthe code -behind should be avoided.  \\nCommands provide a conven\", \"ient way to represent actions that can be bound to controls in the UI. \\nThey encapsulate the code th\", \"at implements the action, and help to keep it decoupled from its visual \\nrepresentation in the view.\", \" Xamarin.Forms includes controls that can be declaratively connected to a \\ncommand, and these contro\", \"ls will invoke the command when the user intera cts with the control.  14 CHAPTER  2  |  MVVM  \\n Beh\", \"aviors also allow controls to be declaratively connected to a command. However, behaviors can be \\nus\", \"ed to invoke an action that's associated with a range of events raised by a control. Therefore, \\nbeh\", \"aviors address many of the same s cenarios as command -enabled controls, while providing a \\ngreater \", \"degree of flexibility and control. In addition, behaviors can also be used to associate command \\nobj\", \"ects or methods with controls that were not specifically designed to interact with commands.  \\nImple\", \"menting commands  \\nView models typically expose command properties, for binding from the view, that \", \"are object \\ninstances that implement the ICommand  interface. A number of Xamarin.Forms controls pro\", \"vide a \\nCommand  property, which can be data bound to an ICommand  object provided by the view model\", \". The \\nICommand  interface defines an Execute  method, which encapsulates the operation itself, a \\nC\", \"anExecute  method, which indicates whether the command can be invoked, and a \\nCanExecuteChanged  eve\", \"nt that occurs when c hanges occur that a ffect whether the command should \\nexecute. The Command  an\", \"d Command<T>  classes, provided by Xamarin.Forms, implement the ICommand  \\ninterface, where T is the\", \" type of the arguments to Execute  and CanExecute .  \\nWithin a view model, there should  be an objec\", \"t of type Command  or Command<T>  for each public \\nproperty in the view model of type ICommand . The\", \" Command  or Command<T>  constructor requires an \\nAction  callback object  that's called when the IC\", \"ommand.Execute  method is invoked. The \\nCanExecute  meth od is an optional constructor parameter, an\", \"d is a Func  that returns a bool . \\nThe following code shows how a Command  instance, which represen\", \"ts a register command, is \\nconstructed by specifying a delegate to the Register  view model method: \", \" \\npublic ICommand  RegisterCommand  => new Command(Register);   \\nThe command is exposed to the view \", \"through a property that returns a reference to an ICommand . \\nWhen the Execute  method is called on \", \"the Command  object, it simply forwards the call to the method \\nin the view model via the delegate t\", \"hat was specified in the Command  constructor.  \\nAn asynchronous method can be invoked by a command \", \"by using the async  and await  keywords \\nwhen specifying the command's Execute  delegate. This indic\", \"ates that the callback is a Task  and \\nshould be awaited. For example, the following code shows how \", \"a Command  instance, which represents \\na sign -in command, is constructed by specifying a delegate t\", \"o the SignInAsync view model method:  \\npublic ICommand  SignInCommand  => new Command(async () => aw\", \"ait SignInAsync());   \\nParameters can be passed to the Execute  and CanExecute  actions by using the\", \" Command<T>  class to \\ninstantiate the command. For example, the following code shows how a Command<\", \"T>  instance is used \\nto indicate that the NavigateAsync  method will require an argument of type st\", \"ring : \\npublic ICommand  NavigateCommand  => new Command<string>(NavigateAsync);   \\nIn both the Comm\", \"and  and Command<T>  classes, the delegate to the CanExecute  method in each \\nconstructor is optiona\", \"l. If a delegate isn't specified, the Command  will return true  for CanExecute . \\nHowever, the view\", \" model can indicate a change in the command's CanExecute  status by calling the \\nChangeCanExecute  m\", \"ethod on the Command  object. This causes the CanExecuteChanged  event to be \\nraised. Any  controls \", \"in the UI that are bound to the command will then update their enabled status to \\nreflect the availa\", \"bility of the data -bound command.  15 CHAPTER  2  |  MVVM  \\n Invoking commands from a view  \\nThe fo\", \"llowing code example shows how a Grid  in the LoginView  binds to the RegisterC ommand  in \\nthe Logi\", \"nViewModel  class by using a TapGestureRecognizer  instance:  \\n<Grid Grid.Column=\\\"1\\\" HorizontalOptio\", \"ns= \\\"Center\\\" > \\n    <Label Text=\\\"REGISTER\\\"  TextColor= \\\"Gray\\\"/> \\n    <Grid.GestureRecognizers > \\n   \", \"     <TapGestureRecognizer  Command= \\\"{Binding  RegisterCommand}\\\"  NumberOfTapsRequired= \\\"1\\\" /> \\n   \", \" </Grid.GestureRecognizers > \\n</Grid>  \\nA command parameter can also be optionally defined using the\", \" CommandParameter  property. The \\ntype of the expected argument is specified in the Execute  and Can\", \"Execute  target methods. The \\nTapGestureRecognizer  will automatically invoke the target command whe\", \"n the user interacts with \\nthe attached control. The command parameter, if provided, will be passed \", \"as the argument to the \\ncommand's Execute  delegate.  \\nImplem enting behaviors  \\nBehaviors allow fun\", \"ctionality to be added to UI controls without having to subclass them. Instead, the \\nfunctionality i\", \"s implemented in a behavior class and attached to the control as if it was part of the \\ncontrol itse\", \"lf. Behaviors enable y ou to implement code that you would normally have to write as \\ncode -behind, \", \"because it directly interacts with the API of the control, in such a way that it can be \\nconcisely a\", \"ttached to the control, and packaged for reuse across more than one view or app. I n the \\ncontext of\", \" MVVM, behaviors are a useful approach for connecting controls to commands.  \\nA behavior that's atta\", \"ched to a control through attached properties is known as an attached behavior . \\nThe behavior can t\", \"hen use the exposed API of the element to wh ich it is attached to add functionality \\nto that contro\", \"l , or other controls , in the visual tree of the view. The eShopOnContainers mobile app \\ncontains t\", \"he LineColorBehavior  class, which is an attached behavior. For more information about \\nthis behavio\", \"r, see Displaying validation errors . \\nA Xamarin.Forms behavior is a class that derives from the Beh\", \"avior  or Behavior<T>  class, where T is \\nthe type of the control to which the behavior should apply\", \". These classes provide OnAttachedTo  and \\nOnDetachingFrom  methods, which should be overridden to p\", \"rovide logic that will be executed when \\nthe behavior is attached to and detached from controls.  \\nI\", \"n the eShopOnContainers mobile app, the BindableBehavior<T>  class derives from the \\nBehavior<T>  cl\", \"ass. The purpose of the BindableBehavior<T>  class is to provide a base class for \\nXamarin.Forms beh\", \"aviors that require the BindingContext  of the behavior to be set to the attached \\ncontrol.  \\nThe Bi\", \"ndableBehavior<T>  class provides an overridable OnAttachedTo  method that sets the \\nBindingContext \", \" of the behavior, and an overridable OnDetachingFrom  method that cleans up the \\nBindingContext . In\", \" addition, the class stores  a reference to the attached control in the \\nAssociatedObject  property.\", \"  \\nThe eShopOnContainers mobile app includes an EventToCommandBehavior  class, which executes a \\ncom\", \"mand in response to an event occurring. This class derives from the BindableBehavior<View>  \\nclass s\", \"o that the behavior can bind to and execute an ICommand  specified by a Command  property \\nwhen the \", \"behavior is consumed. The following code example shows the EventToCommandBehavior \\nclass:  \\n 16 CHAP\", \"TER  2  |  MVVM  \\n public class EventToCommandBehavior  : BindableBehavior <View> \\n{ \\n    ... \\n    p\", \"rotected  override  void OnAttachedTo( View visualElement)  \\n    { \\n        base.OnAttachedTo(visual\", \"Element);  \\n \\n        var events = AssociatedObject.GetType().GetRuntimeEvents().ToArray();  \\n      \", \"  if (events.Any())  \\n        { \\n            _eventInfo  = events.FirstOrDefault(e  => e.Name == Eve\", \"ntName);  \\n            if (_eventInfo  == null) \\n                throw new ArgumentException (string\", \".Format(  \\n                        \\\"EventToCommand:  Can't find any event named '{0}' on attached  t\", \"ype\\\",  \\n                        EventName));  \\n \\n            AddEventHandler(_eventInfo,  Associated\", \"Object,  OnFired);  \\n        } \\n    } \\n \\n    protected  override  void OnDetachingFrom( View view) \\n\", \"    { \\n        if (_handler  != null) \\n            _eventInfo.RemoveEventH andler(AssociatedObject, \", \" _handler);  \\n \\n        base.OnDetachingFrom(view);  \\n    } \\n \\n    private void AddEventHandler(  \\n \", \"           EventInfo  eventInfo,  object item, Action<object, EventArgs > action) \\n    { \\n        ..\", \". \\n    } \\n \\n    private void OnFired( object sender, EventArgs  eventArgs)  \\n    { \\n        ... \\n   \", \" } \\n}  \\nThe OnAttachedTo  and OnDetachingFrom  methods are used to register and deregister an event \", \"\\nhandler for the event defined in the EventName  property. Then, when the event fires, the OnFired \\n\", \"method is invoked,  which executes the command.  \\nThe advantage of using the EventToCommandBehavior \", \" to execute a command when an event fires, is \\nthat commands can be associated with controls that we\", \"ren't designed to interact with commands. In \\naddition, this moves event -handlin g code to view mod\", \"els, where it can be unit tested.  \\nInvoking behaviors from a view  \\nThe EventToCommandBehavior  is \", \"particularly useful for attaching a command to a control that \\ndoesn't support commands. For example\", \", the ProfileView  uses the EventToCommandBehavior  to \\nexecute the OrderDetailCommand  when the Ite\", \"mTapped  event fires on the ListView  that lists the \\nuser's orders, as shown in the following code:\", \"  \\n<ListView > \\n    <ListView.Behaviors > \\n        <behaviors:EventToCommandBehavior             \\n  \", \"          EventName= \\\"ItemTapped\\\"  \\n            Command= \\\"{Binding  OrderDetailCommand}\\\"  \\n         \", \"   EventArgsConverter= \\\"{StaticResource  ItemTappedEventArgsConverter}\\\"  /> 17 CHAPTER  2  |  MVVM  \", \"\\n     </ListView.Behaviors > \\n    ... \\n</ListView >  \\nAt runtime, the EventToCommandBehavior  will r\", \"espond to interaction with the ListView . When an \\nitem is selected in the ListView , the ItemTapped\", \"  event will fire, which will execute the \\nOrderDetailCommand  in the ProfileViewModel . By default,\", \" the event arguments for the event are \\npassed to the comman d. This data is converted as it's passe\", \"d between source and target by the \\nconverter specified in the EventArgsConverter property, which re\", \"turns the Item  of the ListView  \\nfrom the I temTappedEventArgs . Therefore, when the OrderDetailCom\", \"mand  is executed, the s elected \\nOrder  is passed as a parameter to the registered Action . \\nFor mo\", \"re information about behaviors, see Behaviors  on the Xamarin Developer Center.  \\nSummary  \\nThe Mode\", \"l -View -ViewModel (MVVM) pattern helps to cleanly separate the business and presentation \\nlogic of \", \"an application from its user interface (UI). Maintaining a clean separation between application \\nlog\", \"ic and the UI helps to address numerous deve lopment issues and can make an application easier \\nto t\", \"est, maintain, and evolve. It can also greatly improve code re -use opportunities and allows \\ndevelo\", \"pers and UI designers to more easily collaborate when developing their respective parts of an \\napp. \", \"\\nUsing  the MVVM pattern, the UI of the app and the underlying presentation and business logic is \\ns\", \"eparated into three separate classes: the view, which encapsulates the UI and UI logic; the view \\nmo\", \"del, which encapsulates presentation logic and state; and the mod el, which encapsulates the app's \\n\", \"business logic and data.   \\n \\n \\n18 CHAPTER  3  |  Dependency injection  \\n  \\n \\nC H A P T E R  \\n \\n \\n 3\", \" \\n Dependency \\ninjection  \\nTypically, a class constructor is invoked when instantiating an object, a\", \"nd any values that the object \\nneeds are passed as arguments to the constructor. This is an example \", \"of dependency injection, and \\nspecifically is known as constructor injection . The dep endencies the\", \" object needs are injected into the \\nconstructor.  \\nBy specifying dependencies as interface types, d\", \"ependency injection enables decoupling of the \\nconcrete types from the code that depends on these ty\", \"pes. It generally uses a container that holds a  \\nlist of registrations and mappings between interfa\", \"ces and abstract types, and the concrete types that \\nimplement or extend these types.  \\nThere are al\", \"so other types of dependency injection, such as property setter injection , and method call \\ninjecti\", \"on , but th ey are less commonly seen. Therefore, this chapter will focus solely on performing \\ncons\", \"tructor injection with a dependency injection container.  \\nIntroduction to dependency injection  \\nDe\", \"pendency injection is a specialized version of the Inversion of Control ( IoC) pattern, where the \\nc\", \"oncern being inverted is the process of obtaining the required dependency. With dependency \\ninjectio\", \"n, another class is responsible for injecting dependencies into an object at runtime. The \\nfollowing\", \" code example shows how the  ProfileViewModel  class is structured when using \\ndependency injection:\", \"  \\npublic class ProfileViewModel  : ViewModelBase  \\n{ \\n    private IOrderService  _orderService;  \\n \", \"\\n    public ProfileViewModel( IOrderService  orderService)  \\n    { \\n        _orderService  = orderSe\", \"rvice;  \\n    } \\n    ... \\n}  \\nThe ProfileViewModel  constructor receives an IOrderService  instance a\", \"s an argument, injected by \\nanother class. The only dependency in the ProfileViewModel  class is on \", \"the interface type. \\nTherefore, the ProfileViewModel  class doesn't have a ny knowledge of the class\", \" that's responsible for \\ninstantiating the IOrderService  object. The class that's responsible for i\", \"nstantiating the 19 CHAPTER  3  |  Dependency injection  \\n IOrderService  object, and inserting it i\", \"nto the ProfileViewModel  class, is known as the dependency \\ninjection contain er. \\nDependency injec\", \"tion containers reduce the coupling between objects by providing a facility to \\ninstantiate class in\", \"stances and manage their lifetime based on the configuration of the container. \\nDuring the objects c\", \"reation, the container injects any dependencies that the object requires into it. If \\nthose dependen\", \"cies have not yet been created, the container creates and resolves their dependencies \\nfirst.  \\nNote\", \":  Dependency injection can also be implemented manually using factories. However, using a \\ncontaine\", \"r provides additional capabilities such as lifetime management, and registration through \\nassembly s\", \"canning.  \\nThere are several advantages to using a dependency injection container:  \\n\\u2022 A container r\", \"emoves the need for a class to locate its dependencies and manage their \\nlifetimes.  \\n\\u2022 A container \", \"allows mapping of implemented dependencies without affecting the class.  \\n\\u2022 A container facilitates \", \"testability by allowing dependencies to be mocked.  \\n\\u2022 A container increases maintainability by allo\", \"wing new classes to be easil y added to the app.  \\nIn the context of a Xamarin.Forms app that uses M\", \"VVM, a dependency injection container will \\ntypically  be used for registering and resolving view mo\", \"dels, and for registering services and injecting \\nthem into view models.  \\nThere are many de pendenc\", \"y injection containers available, with the eShopOnContainers mobile app \\nusing Autofac  to manage th\", \"e instantiation of view model and service classes in the app.  Autofac \\nfacilitates building loosely\", \" coupled apps, and provides all of the features commo nly found in \\ndependency injection containers,\", \" including methods to register type mappings and object instances, \\nresolve objects, manage object l\", \"ifetimes, and inject dependent objects into constructors of objects \\nthat it resolves. For more info\", \"rmation about  Autofac, see Autofac  on readthedocs.io.  \\nIn Autofac, the IContainer  interface prov\", \"ides the dependency injection container. Figure 3 -1 shows \\nthe dependencies when using this contain\", \"er, which  instantiates an IOrderService  object and injects \\nit into the ProfileViewModel  class.  \", \"\\nFigure 3 -1: Dependencies when using dependency injection  \\n20 CHAPTER  3  |  Dependency injection \", \" \\n At runtime, the container must know which implementation of the IOrderService  interface it shoul\", \"d \\ninstantiate, b efore it can instantiate a ProfileViewModel  object. This involves:  \\n\\u2022 The contai\", \"ner deciding how to instantiate an object that implements the IOrderService  \\ninterface. This is kno\", \"wn as registration . \\n\\u2022 The container instantiating the object that implements the IOrderService  in\", \"terface, and the \\nProfileViewModel  object. This is known as resolution . \\nEventually, the app will \", \"finish using the ProfileViewModel object and it will become available for \\ngarbage collection. At th\", \"is point, the garbage collector should dispose of the IOrderService  instance \\nif other classes do n\", \"ot share the same instance.  \\nTip: Write container -agnostic code  \\nAlways try to write container -a\", \"gnostic code to decouple the app from the specific dependency \\ncontainer being used.  \\nRegistration \", \" \\nBefore dependencies can be injected into an object, the types of the dependencies must first be \\nr\", \"egistered with the container. Registering a type typically involves passing the container an interfa\", \"ce \\nand a concrete type that implements the interface.  \\nThere are tw o ways of registering types an\", \"d objects in the container through code:  \\n\\u2022 Register a type or mapping with the container. When req\", \"uired, the container will build an \\ninstance of the specified type.  \\n\\u2022 Register an existing object \", \"in the container as a singleton. Wh en required, the container will \\nreturn a reference to the exist\", \"ing object.  \\nTip: Dependency injection containers are not always suitable  \\nDependency injection in\", \"troduces additional complexity and requirements that might  not be \\nappropriate or useful to small a\", \"pps.  If a class does not have any dependencies, or is not a \\ndependency for other types, it might  \", \"not make sense to put it in the container. In addition, i f a class  \\nhas a single set of dependenci\", \"es that are integral t o the ty pe and will never change, it might  not \\nmake sense to put it in the\", \" container.  \\nThe registration of types that require dependency injection should be performed in a s\", \"ingle method in \\nan app, and this method should be invoked early in the app's lifecyc le to ensure t\", \"hat the app is aware \\nof the dependencies between its classes. In the eShopOnContainers mobile app t\", \"his is performed by \\nthe ViewModelLocator  class, which builds the IContainer  object and is the onl\", \"y class in the app that \\nholds a reference to t hat object. The following code example shows how the\", \" eShopOnContainers \\nmobile app declares the IContainer  object in the ViewModelLocator  class:  \\npri\", \"vate static IContainer  _container;   \\nTypes and instances are registered in the Register Dependenci\", \"es  method in the ViewModelLocator  \\nclass. This is achieved by first creating a ContainerBuilder  i\", \"nstance, which is demonstrated in the \\nfollowing code example:  \\nvar builder = new ContainerBuilder \", \"();  21 CHAPTER  3  |  Dependency injection  \\n Types and instances are then registered with the Cont\", \"ainerBuilder  object, and the following code \\nexample demonstrates the most common form of type regi\", \"stration:  \\nbuilder.RegisterType< RequestProvider >().As<IRequestProvider >();   \\nThe RegisterType  \", \"method shown here maps an interface type to a concrete type. It tells the \\ncontainer to instantiate \", \"a RequestProvider  object when it instantiates an object that requires an \\ninjection of an IRequestP\", \"rovider  through a constructor.  \\nConcrete types can also be registered directly without a mapping f\", \"rom an interface type, as shown in \\nthe following code example:  \\nbuilder.RegisterType< ProfileViewM\", \"odel >();   \\nWhen the ProfileViewModel  type is resolved, the container will inject its required dep\", \"endencies.  \\nAutofac also allows instance registration, where the container is responsible for maint\", \"aining  a \\nreference to a singleton instance of a type. For example, the following code example show\", \"s how the \\neShopOnContainers mobile app registers the concrete type to use when a ProfileViewModel  \", \"\\ninstance requires an IOrderService  instance:  \\nbuilder.RegisterType< OrderService >().As<IOrderSer\", \"vice >().SingleInstance();   \\nThe RegisterType  method shown here maps an interface type to a concre\", \"te type. The \\nSingleInstance  method configures the registration so that every dep endent object rec\", \"eives the \\nsame  shared instance. The refore, only a single OrderService  instance will exist in the\", \" container, \\nwhich is shared by objects that require an injection of an IOrderService  through a con\", \"structor.  \\nInstance registration can also be performed with the RegisterInstance  method, which is \", \" \\ndemonstrated in the following code example:  \\nbuilder.RegisterInstance( new OrderMockService ()).A\", \"s<IOrderService >();   \\nThe RegisterInstance  method shown here creates a new OrderMockService  inst\", \"ance and registers \\nit with the container. Therefore, only a single  OrderMockService  instance exis\", \"ts in the container, \\nwhich is shared by objects that require an injection of an IOrderService  thro\", \"ugh a constructor.  \\nFollowing type and instance registration, the IContainer  object must be built,\", \" which is demonstrated \\nin the following code example:  \\n_container  = builder.Build();   \\nInvoking \", \"the Build  method on the ContainerBuilder  instance builds a new dependency injection \\ncontainer tha\", \"t contains the registrations that have been made.  \\nTip: Consider an IContainer  as being immutable \", \" \\nWhile Autofac provides an Update  method to update registrations in an existing container, calling\", \" \\nthis method should be avoided where possible. There are risks to modifying a container after it's \", \"\\nbeen built, particularly if the containe r has been used. For more information, see Consider a \\nCon\", \"tainer as Immutable  on readthedocs.io.  22 CHAPTER  3  |  Dependency injection  \\n Resolution  \\nAfte\", \"r a type is registered, it can be resolv ed or injected as a dependency. When a type is being \\nresol\", \"ved and the container needs to create a new instance, it injects any dependencies into the \\ninstance\", \".  \\nGenerally, when a type is resolved, one of three things happens:  \\n1. If the type hasn't been re\", \"gistered, the container throws an exception.  \\n2. If the type has been registered as a singleton, th\", \"e container returns the singleton instance. If \\nthis is the first time the type is  called for, the \", \"container creates it if required, and maintains a \\nreference t o it. \\n3. If the type hasn't been reg\", \"istered as a singleton, the container returns a new instance, and \\ndoesn't maintain a reference to i\", \"t.  \\nThe following code example shows how the RequestProvider  type that was previously registered \\n\", \"with Autofac can be resolved : \\nvar requestProvider  = _container. Resolve< IRequestProvider >();   \", \"\\nIn this example, Autofac is asked to resolve the concrete type for the IRequestProvider  type, alon\", \"g \\nwith any dependencies. Typically, the Resolve  method is called when an instance of a specif ic t\", \"ype is \\nrequired. For information about controlling the lifetime of resolved objects, see Managing t\", \"he lifetime \\nof resolved objects . \\nThe following code example shows how the eShopOnContainers mobil\", \"e app in stantiates view model \\ntypes and their dependencies:  \\nvar viewModel  = _container.Resolve(\", \"viewModelType);   \\nIn this example, Autofac is asked to resolve the view model type for a requested \", \"view model, and the \\ncontainer will also resolve any dependencies. When resolving the ProfileViewMod\", \"el  type, the \\ndependency to resolve is an IOrderService  object. Therefore, Au tofac first construc\", \"ts an \\nOrderService  object and then passes it to the constructor of the ProfileViewModel  class. Fo\", \"r more \\ninformation about how the eShopOnContainers mobile app constructs view models and associates\", \" \\nthem to views, see Automatically creating a view model with a view model locator . \\nNote:  Registe\", \"ring and resolving types with a container has a performance cost because of the \\ncontainer's use of \", \"reflection for creating each type, especially if depende ncies are being \\nreconstructed for each pag\", \"e navigation in the app. If there are many or deep dependencies, the \\ncost of creation can increase \", \"significantly.  \\nManaging the lifetime of resolved objects  \\nAfter registering a type, the default b\", \"ehavior for Autofac  is to create a new instance of the registered \\ntype each time the type is resol\", \"ved, or when the dependency mechanism injects instances into other \\nclasses. In this scenario, the c\", \"ontainer doesn't hold a reference to the resolved object. However, when \\nregist ering an instance, t\", \"he default behavior for Autofac is to manage the lifetime of the object as a \\nsingleton. Therefore, \", \"the instance remains in scope while the container is in scope, and is disposed \\nwhen the container g\", \"oes out of scope and is garbage collec ted, or when code explicitly disposes the \\ncontainer.  23 CHA\", \"PTER  3  |  Dependency injection  \\n An Autofac instance scope can be used to specify the singleton b\", \"ehavior for an object that Autofac \\ncreates from a registered type. Autofac instance scopes manage t\", \"he object lifetimes instantiated by \\nthe container. The default instance scope for the RegisterType \", \" method is the \\nInstancePerDependency  scope. However, the SingleInstance  scope can be used with th\", \"e \\nRegisterType  method, so that the container creates or returns a singleton instance of a type whe\", \"n \\ncalling the Resolve  method. The following code example shows how Autofac is instructed to create\", \" a \\nsingleton instance of the NavigationService  class:  \\nbuilder.RegisterType< NavigationService >(\", \").As<INavigationService >().SingleInstance();   \\nThe first time that t he INavigationService  interf\", \"ace is resolved, the container creates a new \\nNavigationService  object and maintains a reference to\", \" it. On any subsequent resolutions of the \\nINavigationService  interface, the container returns a re\", \"ference to the NavigationService  object \\nthat was previously created.  \\nNote:  The SingleInstance  \", \"scope disposes created objects when the container is disposed.  \\nAutofac includes additional instanc\", \"e scopes. For more information, see Instance Scope  on \\nreadthedocs.io.  \\nSummary  \\nDependency injec\", \"tion enables decoupling of concrete types from the code that depends on these \\ntypes. It typically u\", \"ses a container that holds a list of registrations and mappings between i nterfaces \\nand abstract ty\", \"pes, and the concrete types that implement or extend these types.  \\nAutofac facilitates building loo\", \"sely coupled apps, and provides all of the features commonly found in \\ndependency injection containe\", \"rs, including methods to register type mappings and object instances, \\nresolve objects, manage objec\", \"t lifetimes, and inject dependent objects into constructors of objects it \\nresolves.   \\n \\n \\n24 CHAPT\", \"ER  4  |  Communicating between loosely coupled components  \\n  \\n \\nC H A P T E R  \\n \\n \\n 4 \\n Communica\", \"ting \\nbetween loosely \\ncoupled \\ncomponents  \\nThe publish -subscribe pattern is a messaging pattern i\", \"n which  publishers send messages without \\nhaving knowledge of any receiver s, known as subscribers.\", \" Similarly, subscribers listen for specific \\nmessages, without having knowledge of any publishers.  \", \"\\nEvent s in .NET implement the publish -subscribe pattern, and are the most simple and straightforwa\", \"rd \\napproach for a communication laye r between components if  loose coupling is not required, such \", \"as a \\ncontrol and the page that contains it. However, the publisher and subscriber lifetimes are cou\", \"pled by \\nobject references to each other, and the subscriber type must have a reference to the pu bl\", \"isher type. \\nThis can create memory management issues, especially when there are short lived objects\", \" that \\nsubscribe to an event of a static or long -lived object. If the event handler isn't removed, \", \"the subscriber \\nwill be kept alive by the reference to it in the publisher, and this will prevent or\", \" delay the garbage \\ncollection of the subscriber.  \\nIntroduction to MessagingCenter  \\nThe Xamarin.Fo\", \"rms MessagingCenter  class implements the publish -subscribe pattern, allowing \\nmessage -based commu\", \"nication between compon ents that are inconvenient to link by object and type \\nreferences. This mech\", \"anism allows publishers and subscribers to communicate without having a \\nreference to each other, he\", \"lping to reduce dependencies between components, while also allowing \\ncomponents to  be independentl\", \"y developed and tested.  \\nThe MessagingCenter  class provides multicast publish -subscribe functiona\", \"lity. This means that there \\ncan be multiple publishers that publish a single message, and there can\", \" be multiple subscribers \\nlistening for the sa me message. Figure 4 -1 illustrates this relationship\", \":  25 CHAPTER  4  |  Communicating between loosley coupled components  \\n  \\nFigure 4 -1: Multicast pu\", \"blish -subscribe functionality  \\nPublishers send messages using the MessagingCenter.Send  method, wh\", \"ile subscribers listen for \\nmessages using the MessagingCenter.Subscribe  method. In addition, subsc\", \"ribers can also \\nunsubscribe from message subscriptions, if required, with the MessagingCenter.Unsub\", \"scribe  \\nmethod.  \\nInternally, th e MessagingCenter  class uses weak references. This means that it \", \"will not keep objects \\nalive, and wil l allow them to be garbage collected. Therefore, it should onl\", \"y be necessary to \\nunsubscribe from a message when a clas s no longer wishes to receive the message \", \". \\nThe eShopOnContainers mobile app uses the MessagingCenter  class to communicate between \\nloosely \", \"coupled components. The app defines three messages:  \\n\\u2022 The AddProduct  message is published by the \", \"CatalogViewModel  class when an item is \\nadded to the shopping basket. In return, the BasketViewMode\", \"l  class subscribes to the \\nmessage and increments the number of items in the shopping basket in res\", \"ponse. In addition, \\nthe BasketViewModel  class also unsubscribes from this message.  \\n\\u2022 The Filter \", \" message is published by the CatalogViewModel  class when the user applies a \\nbrand or type filter t\", \"o the items displayed from the  catalogue. In return, the CatalogView  \\nclass subscribes to the mess\", \"age and updates the UI so that only items that match the filter \\ncriteria are displayed.  \\n\\u2022 The Cha\", \"ngeTab  message is published by the MainViewModel  class when the \\nCheckoutViewModel  navigates to  \", \"the MainViewModel  following the successful creation and \\nsubmission of a new order. In return, the \", \"MainView class subscribes to the message and \\nupdates the UI so that the My profile  tab is active, \", \"to show the user's orders.  \\nNote:  While the MessagingCenter  class p ermits communication between \", \"loosely -coupled classes, \\nit does not offer the only architectural solution  to this issue . For ex\", \"ample, communication between \\na view model and a view can also be achieved by the binding engine and\", \" through property change  \\nnotifications. In addition, communication between two view models can als\", \"o be achieved by \\npassing data during navigation.  \\nIn the eShopOnContainers mobile app, MessagingCe\", \"nter  is used to update in the UI in response to \\nan action occurring in another class.  Therefore, \", \"messages are published on the UI thread, with \\nsubscribers receiving the message on the same thread.\", \"  \\n \\n \\n26 CHAPTER  4  |  Communicating between loosley coupled components  \\n Tip: Marsha l to the UI\", \" thread when performing UI updates  \\nIf a message that's sent from a background thread is required t\", \"o update the UI, process the \\nmessage on the UI thread in the subscriber by invoking the Device.Begi\", \"nInvokeOnMainThread  \\nmethod.  \\nFor more information about MessagingCenter , see MessagingCenter  on\", \" the Xamarin Developer \\nCenter.  \\nDefining a message  \\nMessagingCenter  messages are strings that ar\", \"e used to identify messages. The following code \\nexam ple shows the messages defined within the eSho\", \"pOnContainers mobile app:  \\npublic class MessengerKeys  \\n{ \\n    // Add product to basket \\n    public\", \" const string AddProduct  = \\\"AddProduct\\\" ; \\n \\n    // Filter \\n    public const string Filter = \\\"Filte\", \"r\\\" ; \\n \\n    // Change selected  Tab programmatically  \\n    public const string ChangeTab  = \\\"ChangeT\", \"ab\\\" ; \\n}  \\nIn this example, messages are defined using constants. The advantage of this approach is \", \"that it \\nprovides compile -time type safety and refactoring support.  \\nPublishi ng a message  \\nPubli\", \"shers notify subscribers of a message with one of the MessagingCenter.Send  overloads. The \\nfollowin\", \"g code example demonstrates publishing the AddProduct message:  \\nMessagingCenter .Send(this, Messeng\", \"erKeys .AddProduct,  catalogItem);   \\nIn this e xample, the Send  method specifies three arguments: \", \" \\n\\u2022 The first argument specifies the sender class. The sender class must be specified by any \\nsubscr\", \"ibers who wish to receive the message.  \\n\\u2022 The second argument specifies the message.  \\n\\u2022 The third \", \"argument specifies  the payload data to be sent to the subscriber. In this case the \\npayload data is\", \" a CatalogItem  instance.  \\nThe Send  method will publish the message, and its payload data, using a\", \" fire -and-forget approach. \\nTherefore, the message is sent even if there are no subscribers registe\", \"red to receive the message. In \\nthis situation, the sent message is ignored.  \\nNote:  The Messaging \", \"Center.Send  method can use generic parameters to control how messages \\nare delivered. Therefore, mu\", \"ltiple messages that share a message identity but send different \\npayload data types can be received\", \" by different subscribers.  27 CHAPTER  4  |  Communicating between loosley coupled components  \\n Su\", \"bscribing to a message  \\nSubscribers can register to receive a message using one of the MessagingCen\", \"ter.Subscribe \\noverloads. The following code example demonstrates how the eShopOnContainers mobile a\", \"pp \\nsubscribes to , and processes , the AddProduct  message:  \\nMessagingCenter .Subscribe <CatalogVi\", \"ewModel , CatalogItem >( \\n    this, MessageKeys .AddProduct,  async (sender,  arg) => \\n{ \\n    BadgeC\", \"ount++;  \\n \\n    await AddCatalogItemAsync(arg);  \\n});  \\nIn this example, the Subscribe  method subsc\", \"ribes to the AddProduct  message, and executes a \\ncallback dele gate in response to receiving the me\", \"ssage. This callback delegate, specified as a lambda \\nexpression, executes code that updates the UI.\", \"  \\nTip: Consider using immutable payload data  \\nDon't attempt to modify the payload data from within\", \" a callback delegate beca use several threads \\ncould be accessing the received data simultaneously. \", \"In this scenario, the payload data should be \\nimmutable to avoid concurrency errors.  \\nA subscriber \", \"might  not need to handle every instance of a published message, and this can be \\ncontro lled by the\", \" generic type arguments that are specified on the Subscribe  method. In this \\nexample, the subscribe\", \"r will only receive AddProduct  messages that are sent from the \\nCatalogViewModel  class, whose payl\", \"oad data is a CatalogItem  instance.  \\nUnsubscribing from a message  \\nSubscribers can unsubscribe fr\", \"om messages they no longer want to receive. This is achieved with one \\nof the MessagingCenter.Unsubs\", \"cribe  overloads, as demonstrated in the following code example:  \\nMessagingCenter .Unsubscribe< Cat\", \"alogViewModel , CatalogItem >(this, MessengerKeys .AddProduct);   \\nIn this example, the Unsubscribe \", \" method syntax reflects the type arguments specified when \\nsubscribing to receive the AddProduct  me\", \"ssage.  \\nSummary  \\nThe Xamarin.Forms MessagingCenter  class implements the publish -subscribe patter\", \"n, allowing \\nmessage -based communication between components that are inconvenient to link by object\", \" and type \\nreferences. This mechanism allows publishers and subscribers to communicate without havin\", \"g a \\nreference to each other, helping to redu ce dependencies between components, while also allowin\", \"g \\ncomponents to be independently developed and tested.   \\n \\n \\n28 CHAPTER  5  |  Navigation  \\n  \\n \\nC\", \" H A P T E R  \\n \\n \\n 5 \\n Navigation  \\nXamarin.Forms includes support for page navigation, which typic\", \"ally results from the user's interaction \\nwith the UI or from the app itself as a result of internal\", \" log ic-driven state changes. However, \\nnavigation can be complex to implement in apps that use the \", \"Model -View -ViewModel (MVVM) \\npattern, as the following challenges must be met:  \\n\\u2022 How to identify\", \" the view to be navigated to, using an approach that does not introdu ce tight \\ncoupling and depende\", \"ncies between views.  \\n\\u2022 How to coordinate the process by which the view to be navigated to is insta\", \"ntiated and \\ninitialized. When using MVVM, the view and view model need to be instantiated and \\nasso\", \"ciated with each other via the vi ew's binding context. When an app is using a \\ndependency injection\", \" container, the instantiat ion of views and view models might  require a \\nspecific construction mech\", \"anism.  \\n\\u2022 Whether to perform view -first navigation, or view model -first navigation. With view -fi\", \"rst \\nnavigation, the page to navigate to refers to the name of the view type. During navigation, \\nth\", \"e specified view is instantiated, along with its corresponding view model and other \\ndependent servi\", \"ces. An alternative approach is to use view model -first navi gation, where the \\npage to navigate to\", \" refers to the name of the view model type . \\n\\u2022 How to cleanly separate the navigational behavior of\", \" the app across the view s and view \\nmodel s. The MVVM pattern provides a separation between the app\", \"'s UI and its presentation  \\nand business logic. However, the navigation behavior of an app will oft\", \"en span the UI and \\npresentations parts of the app. The user will often initiate navigation from a v\", \"iew, and the \\nview will be replaced as a result of the navigation. However, navigation  might  often\", \" also need \\nto be initiated or coordinated from within the view model.  \\n\\u2022 How to pa ss parameters d\", \"uring navigation  for initialization purposes. For examp le, if the user \\nnavigates to a view  to up\", \"date order details, the order data will have to be pa ssed to the view \\nso that it can display the c\", \"orrect data.  \\n\\u2022 How to co -ordinate navigation, to ensure that certain business rules ar e obeyed. \", \"For example, \\nusers might  be prompted before navigating away from a view so that they can correct a\", \"ny \\ninvalid data or be prompted to submit or discard any data changes that were made within the \\nvie\", \"w.  \\nThis chapter addresses these challenges by presenting a NavigationService  class that's used to\", \" \\nperform view model -first page navigation.  \\nNote:  The NavigationService  used by the app is desi\", \"gned only to perform hierarchical \\nnavigation between ContentPage  instances. Using the service to n\", \"avigate between other page \\ntypes might  result in unexpected behavior.  29 CHAPTER  5  |  Navigatio\", \"n  \\n Navigating between pages  \\nNavigation logic can reside in a view's code -behind, or in a data b\", \"ound view model. While placing \\nnavigation logic in a view might  be the simplest approach, it is no\", \"t easily testable through unit tests. \\nPlacing navigation logic in view model classes means that the\", \" logic can be exercised through unit \\ntests. In addition, the view model can then implement logic to\", \" control navigation to ensure that \\ncertain business rules are enforced. For example, an app might  \", \"not allow the user to navigate away \\nfrom a page wit hout first ensuring that the entered data is va\", \"lid.  \\nA NavigationService  class is typically invoked from view models, in order to promote testabi\", \"lity. \\nHowever, navigating to views from view models would require the view models to reference view\", \"s, \\nand partic ularly views that the active view model isn't associated with, which is not recommend\", \"ed. \\nTherefore, the NavigationService  presented here specifies the view model type as the target to\", \" \\nnavigate to.  \\nThe eShopOnContainers mobile app uses the NavigationService  class to provide view \", \"model -first \\nnavigation. This class implements the INavigationService  interface, which is shown in\", \" the following \\ncode example:  \\npublic interface  INavigationService  \\n{ \\n    ViewModelBase  Previou\", \"sPageViewModel  { get; } \\n    Task InitializeA sync(); \\n    Task NavigateToAsync< TViewModel >() whe\", \"re TViewModel  : ViewModelBase ; \\n    Task NavigateToAsync< TViewModel >(object parameter)  where TV\", \"iewModel  : ViewModelBase ; \\n    Task RemoveLastFromBackStackAsync();  \\n    Task RemoveBackStackAsyn\", \"c();  \\n}  \\nThis interface specifies that an implementing class must provide the following methods:  \", \"\\nMethod  Purpose  \\nInitializeAsync  Performs navigation to one of two pages when the app is \\nlaunche\", \"d.  \\nNavigateToAsync <T> Performs hierarchical navigation to a specified page.  \\nNavigateToAsync <T>\", \"(parameter)  Performs hierarchical navigation to a specified page, passing \\na parameter.  \\nRemoveLas\", \"tFromBackStackAsync  Removes the previous page from the navigation stack.  \\nRemoveBackStackAsync  Re\", \"moves all the previous pages from the naviga tion stack.  \\n \\nIn addition, the INavigationService  in\", \"terface specifies that an implementing class must provide a \\nPreviousPageViewModel  property. This p\", \"roperty returns the view model type associated with the \\nprevious page in the navigation stack.  \\nNo\", \"te:  An INavigationService  interface would usually also specify a GoBackAsync  method, which \\nis us\", \"ed to programmatically return to the previous page in the navigation stack. However, this \\nmethod is\", \" missing from the  eShopOnContainers mobile app because  it's not requir ed. \\nCreating the Navigatio\", \"nService instance  \\nThe NavigationService  class, which implements the INavigationService  interface\", \", is registered as \\na singleton with the Autofac dependency injection container, as demonstrated in \", \"the following code \\nexample:  30 CHAPTER  5  |  Navigation  \\n builder.RegisterType< NavigationServic\", \"e >().As<INavigationService >().SingleInstance();  \\nThe INavigationService  interface is resolved in\", \" the ViewModelBase class constructor, as \\ndemonstrated in the following code example:  \\nNavigationSe\", \"rvice  = ViewModelLocator.Resolve< INavigationService>();  \\nThis returns a reference to the Navigati\", \"onService object that's stored in the Autofac dependency \\ninjection container, which is created by t\", \"he InitNavigation  method in the App class. For more \\ninformation, see Navigating when the app is la\", \"unched . \\nThe ViewModelBase  class stores the NavigationService  instance in a NavigationService  pr\", \"operty, \\nof type INavigationService . Therefore, all view model classes, which derive from the \\nView\", \"ModelBase  class, can use the NavigationService  property to access the methods specified by \\nthe IN\", \"avigationService  interface. This avoids the overhead of injecting the NavigationService  \\nobject fr\", \"om the Autofac dependency injection container into each vie w model class.  \\nHandling navigation req\", \"uests  \\nXamarin.Forms provides the NavigationPage  class, which implements a hierarchical navigation\", \" \\nexperience in which  the user is able to navigate through pages, forwards and backwards, as desire\", \"d. \\nFor more information about hierarchical navigation, see Hierarchical Navigation  on the Xamarin \", \"\\nDeveloper Center.  \\nRather than use the NavigationPage  class directly, the eShopOnContainers app w\", \"raps the \\nNavigationPage  class in the CustomNavigationView  class, as shown in the following code e\", \"xample:  \\npublic partial class CustomNavigationView  : NavigationPage  \\n{ \\n    public CustomNavigati\", \"onView()  : base() \\n    { \\n        InitializeComponent();  \\n    } \\n \\n    public CustomNavigationView\", \"( Page root) : base(root) \\n    { \\n        InitializeComponent();  \\n    } \\n}  \\nThe purpose of this wr\", \"apping is for ease of styling the NavigationPage  instance  inside the XAML file \\nfor the class.  \\nN\", \"avigation is performed inside view model classes by invoking one of the NavigateToAsync  \\nmethods, s\", \"pecifying the view model type for the pag e being navigated to, as demonstrated in the \\nfollowing co\", \"de example:  \\nawait NavigationService.NavigateToAsync<MainViewModel>();  \\nThe following code example\", \" shows the NavigateToAsync  methods provided by the \\nNavigationService  class:  \\n 31 CHAPTER  5  |  \", \"Navigation  \\n public Task NavigateToAsy nc<TViewModel >() where TViewModel  : ViewModelBase  \\n{ \\n   \", \" return InternalNavigateToAsync( typeof(TViewModel ), null); \\n} \\n \\npublic Task NavigateToAsync< TVie\", \"wModel >(object parameter)  where TViewModel  : ViewModelBase  \\n{ \\n    return InternalNavigateToAsyn\", \"c( typeof(TViewModel ), parameter);  \\n}  \\nEach method allows any view model class that derives from \", \"the ViewModelBase  class to perform \\nhierarchical navigation  by invoking the InternalNavigateToAsyn\", \"c  method. In addition, the second \\nNavigateToAsync  method enables navigati on data to be specified\", \" as an argument that's passed to \\nthe view model being navigated to, where it's typically used to pe\", \"rform initialization. For more \\ninformation, see Passing parameters during navigation . \\nThe Interna\", \"lNavigateToAsync  method executes the navigation request, and is shown in the \\nfollowing code exampl\", \"e:  \\nprivate async Task InternalNavigateToAsync( Type viewModelType,  object parameter)  \\n{ \\n    Pag\", \"e page = CreatePage(viewModelType,  parameter);  \\n \\n    if (page is LoginView ) \\n    { \\n        Appl\", \"ication .Current.MainPage  = new CustomNavigationView (page); \\n    } \\n    else \\n    { \\n        var n\", \"avigationPage  = Application .Current.MainPage  as CustomNavigationView ; \\n        if (navigationPag\", \"e  != null) \\n        { \\n            await navigationPage.PushAsync(page);  \\n        } \\n        else \", \"\\n        { \\n            Application .Current.MainPage  = new CustomNavigationView (page); \\n        }\", \" \\n    } \\n \\n    await (page.BindingContext  as ViewModelBase ).InitializeAsync(parameter);  \\n} \\n \\npri\", \"vate Type GetPageTypeForViewModel( Type viewModelType)  \\n{ \\n    var viewName  = viewModelType.FullNa\", \"me.Replace( \\\"Model\\\", string.Empty);  \\n    var viewModelAssemblyName  = viewModelType.GetTypeInfo().A\", \"ssembly.FullName;  \\n    var viewAssemblyName  = string.Format(  \\n                CultureInfo .Invari\", \"antCulture,  \\\"{0}, {1}\\\", viewName,  viewModelAssemblyName);  \\n    var viewType  = Type.GetType(viewA\", \"ssemblyName);  \\n    return viewType;  \\n} \\n \\nprivate Page CreatePage( Type viewModelType,  object par\", \"ameter)  \\n{ \\n    Type pageType  = GetPageTypeForV iewModel(viewModelType);  \\n    if (pageType  == nu\", \"ll) \\n    { \\n        throw new Exception ($\\\"Cannot  locate page type for {viewModelType }\\\"); \\n    } \\n\", \" 32 CHAPTER  5  |  Navigation  \\n     Page page = Activator .CreateInstance(pageType)  as Page; \\n    \", \"return page; \\n} \\nThe InternalNavigateToAsync  method p erforms navigation to a view model by first c\", \"alling the \\nCreatePage  method. This method locates the view that corresponds to the specified view \", \"model type, \\nand creates and returns an instance of this view type. Locating the view that correspon\", \"ds to the view \\nmodel type uses a convention -based approach, which assumes that:  \\n\\u2022 Views are in t\", \"he same assembly as view model types.  \\n\\u2022 Views are in a .Views child namespace.  \\n\\u2022 View models are\", \" in a .ViewModels child namespace.  \\n\\u2022 View names correspond to view model names, with \\\"Model\\\" remov\", \"ed.  \\nWhen a view is instantiated, it's associated with its corresponding view model. For more infor\", \"mation \\nabout how this occurs, see Automatically creating a view model with a view model locator . \\n\", \"If the view being created is a LoginView , it's wrapped inside a new instance of the \\nCustomNavigati\", \"onView  class and assigned to the Application.Current.MainPage  property. \\nOtherwise, the CustomNavi\", \"gationView  instance is retrieved, and provided that it isn't null , the \\nPushAsync  method is invok\", \"ed to push the view being created  onto the navigation stack. However, If \\nthe retrieved CustomNavig\", \"ationView  instance is null , the view being created is wrapped inside a \\nnew instance of the Custom\", \"NavigationView  class and assigned to the \\nApplication.Current.MainPage  property. This mechanism  e\", \"nsures that during navigation, pages \\nare added correctly to the navigation stack both when it's emp\", \"ty, and when it contains data.  \\nTip: Consider caching pages  \\nPage caching results in memory consum\", \"ption for views that are not currently displayed. However, \\nwithout page caching it does mean that X\", \"AML parsing and construction of the page and its view \\nmodel will occur every time a new page is nav\", \"igated to, which can have a performance impact for a \\ncomplex page. For a well -designed page that  \", \"does not use an exce ssive number  of controls, the \\nperformance should be sufficient. However, page\", \" caching might  help if slow page loading times are \\nencountered.  \\nAfter the view is created and na\", \"vigated to, the InitializeAsync method of the view's associated \\nview model is execu ted. For more i\", \"nformation, see Passing parameters during navigation . \\nNavigating when the app is launched  \\nWhen t\", \"he app is launched, the InitNavigation  method in the App class is invoked. The following \\ncode exa \", \"mple shows this method:  \\nprivate Task InitNavigation()  \\n{ \\n    var navigationService  = ViewModelL\", \"ocator .Resolve< INavigationService >(); \\n    return navigationService.InitializeAsync();  \\n}  \\nThe \", \"method  creates a new NavigationService  object in the Autofac dependency injection container, \\nand \", \"returns a reference to it, before invoking its InitializeAsync  method.  33 CHAPTER  5  |  Navigatio\", \"n  \\n Note:  When the INavigationService  interface is resolved by the ViewModelBase  class, the \\ncon\", \"tainer returns a reference to the NavigationService  object that was created when the \\nInitNavigatio\", \"n  method is invoked.  \\nThe following code example shows the NavigationService  InitializeAsync  met\", \"hod:  \\npublic Task InitializeAsync()  \\n{ \\n    if (string.IsNullOrEmpty( Settings .AuthAccessToken)) \", \" \\n        return NavigateToAsync< LoginViewModel >(); \\n    else \\n        return NavigateToAsync< Mai\", \"nViewModel >(); \\n} \\nThe MainView  is navigated to if the app has a cached access token, which is use\", \"d for authentication. \\nOtherwise, the LoginView  is navigated to.  \\nFor mo re information about the \", \"Autofac dependency injection container, see  Introduction to \\ndependency injection . \\nPassing parame\", \"ters during navigation  \\nOne of the NavigateToAsync methods, specified by the INavigationService  in\", \"terface, enables \\nnavigation data to be specified as an argument that's passed to the view model bei\", \"ng navigated to, \\nwhere it's typically used to perform initialization.  \\nFor example, the ProfileVie\", \"wModel  class contains an OrderDetailCom mand  that's executed when \\nthe user selects an order on th\", \"e ProfileView  page. In turn, this executes the OrderDetailAsync  \\nmethod, which is shown in the fol\", \"lowing code example:  \\nprivate async Task OrderDetailAsync( Order order) \\n{ \\n    await NavigationSer\", \"vice.Na vigateToAsync< OrderDetailViewModel >(order);  \\n}  \\nThis method invokes navigation to the Or\", \"derDetailView Model , passing an Order  instance that \\nrepresents the order that the user selected o\", \"n the ProfileView  page. When the NavigationService  \\nclass creates the OrderDetailView , the OrderD\", \"etailViewModel  class is instantiated and assigned to \\nthe view's BindingContext . After navigating \", \"to the OrderDetailView , the \\nInternalNavigateToAsync  method executes the InitializeAsync  method o\", \"f the view's associated \\nview model.  \\nThe InitializeAsync  method is defined in the ViewModelBase  \", \"class as a method that can be \\noverridden . This method specifies an object  argument that represent\", \"s the data to be passed to a \\nview model during a navigation operation. Therefore, view model classe\", \"s tha t want to receive data \\nfrom a navigation operation provide their own implementation of the In\", \"itializeAsync  method  to \\nperform the required initialization. The following code example shows the\", \" InitializeAsync  method \\nfrom the OrderDetailViewModel  class:  \\npublic override  async Task Initia\", \"lizeAsync( object navigationData)  \\n{ \\n    if (navigationData  is Order) \\n    { \\n        ... \\n      \", \"  Order = await _ordersService.GetOrderAsync(  \\n                        Convert.ToInt32(order.OrderN\", \"umber),  authToken);  34 CHAPTER  5  |  Navigation  \\n         ... \\n    } \\n}  \\nThis method retrieves \", \"the Order  instance that was passed into the view model during the navigation \\noperation, and uses i\", \"t to retrieve the full order details from the OrderService  instance.  \\nInvoking navigation using be\", \"haviors  \\nNavigation is usually trigge red from a view by a user interaction. For example, the Login\", \"View  \\nperforms navigation following successful authentication. The following code example shows how\", \" the \\nnavigation is invoked by a behavior:  \\n<WebView ...> \\n    <WebView.Behaviors > \\n        <behav\", \"iors:EventToCommandBehavior  \\n            EventName= \\\"Navigating\\\"  \\n            EventArgsConverter= \", \"\\\"{StaticResource  WebNavigatingEventArgsConverter}\\\"  \\n            Command= \\\"{Binding  NavigateComman\", \"d}\\\"  /> \\n    </WebView.Behaviors > \\n</WebView>  \\nAt runtime, the EventToCommandBehavior  will respon\", \"d to interaction with the WebView . When the \\nWebView  navigates to a web page, the Navigating  even\", \"t will fire, which will execute the \\nNavigateCommand  in the LoginViewModel . By default, the event \", \"arguments for the event are pas sed \\nto the command. This data is converted as it's passed between s\", \"ource and target by the converter \\nspecified in the EventArgsConverter property, which returns the U\", \"rl from the \\nWebNavigatingEventArgs . Therefore, when the NavigationCommand  is executed, the  Url o\", \"f the web \\npage is passed as a parameter to the registered Action . \\nIn turn, the NavigationCommand \", \" executes the Navigate Async  method, which is shown in the \\nfollowing code example:  \\nprivate async\", \" Task NavigateAsync( string url) \\n{ \\n    ...         \\n    await NavigationService.NavigateToAsync<Ma\", \"inViewModel>();  \\n    await NavigationService.RemoveLastFromBackStackAsync();  \\n    ... \\n}  \\nThis me\", \"thod invokes navigation to the MainViewModel , and following navigation, removes the  \\nLoginView  pa\", \"ge from the navigation stack.  \\nConfirming or cancelling navigation  \\nAn app might  need to interact\", \" with the user during a navigation operation, so that the user can \\nconfirm or cancel navigation. Th\", \"is might  be necessary, for example, when the user attempts to \\nnavigate before having fully complet\", \"ed a data entry page. In this situation, an app should provide a \\nnotification that allows the user \", \"to navigate away from the page, or to cancel the navigation operation \\nbefore it occurs. This can be\", \" achieved in a view model class by using the respon se from a notification \\nto control whether or no\", \"t navigation is invoked.  35 CHAPTER  5  |  Navigation  \\n Summary  \\nXamarin.Forms includes support f\", \"or page navigation, which typically results from the user's interaction \\nwith the UI , or from the a\", \"pp itself , as a result of internal logic -driven state changes. However, \\nnavigation can be complex\", \" to implement in apps that use the MVVM pattern.  \\nThis chapter presented a NavigationService  class\", \", which is used to perform view model -first \\nnavigation from view models.  Placing navigation logic\", \" in view model classes means that the logic can \\nbe exercised through automated tests. In addition, \", \"the view model can then implement logic to \\ncontrol navigation to ensure that certain business rules\", \" are enforced.   \\n \\n \\n36 CHAPTER  6  |  Validation  \\n  \\n \\nC H A P T E R  \\n \\n \\n 6 \\n Validation  \\nAny \", \"app that accepts input from users should ensure that the input is valid. An app could, for \\nexample,\", \" check for input  that contains only characters in a particular range, is of a certain length, or \\nm\", \"atches a particular format. Without validation, a user can supply data that causes the app to fail. \", \"\\nValidation enforces business rules, and prevents an attacker from in jecting malicious data.  \\nIn t\", \"he context of the Model -ViewModel -Model (MVVM) pattern, a view model or model will often be \\nrequi\", \"red to perform data validation and signal any validation errors to the view so that the user can \\nco\", \"rrect them. The eShopOnContainers mobile app performs sy nchronous client -side validation of view \\n\", \"model properties and notifies the user of any validation errors by highlighting the control that \\nco\", \"ntains the invalid data, and by displaying error messages that inform the user of why the data is \\ni\", \"nvalid. Figure 6 -1 shows the classes involved in performing validation in the eShopOnContainers \\nmo\", \"bile app.  \\nFigure 6 -1: Validation classes in the eShopOnContainers mobile app  \\nView model propert\", \"ies that require validation are of type ValidatableObject <T>, and each \\nValidatab leObject <T> inst\", \"ance has validation rules added to its Validations  property. Validation \\nis invoked from the view m\", \"odel by calling the Validate  method of the ValidatableObject <T> \\n37 CHAPTER  6  |  Validation  \\n i\", \"nstance, which retrieves the validation rules and executes them against the ValidatableObject <T> \\nV\", \"alue  property. Any validation errors are placed into the Errors  property of the \\nValidatableObject\", \" <T> instance, and the IsValid  property of the ValidatableObject <T> instance \\nis updated to indica\", \"te whether validation succeeded or failed . \\nProperty change notification is provided by the Extende\", \"dBindableObject  class, and so an Entry  \\ncontrol can bind to the IsValid  property of ValidatableOb\", \"ject <T> instance in the view model class \\nto be notified of whether or not the entered data is vali\", \"d.  \\nSpecifying validation rules  \\nValidation rules are specified by creating a class that derives f\", \"rom the IValidationRule<T>  interface, \\nwhich is shown in the following code example:  \\npublic inter\", \"face  IValidationRule <T> \\n{ \\n    string ValidationMessage  { get; set; } \\n    bool Check(T value); \", \"\\n}  \\nThis interface specifies that a validation rule class must provide a boolean Check  method  tha\", \"t is used \\nto perform the required validation, and a ValidationMessage  property  whose value is the\", \" validation \\nerror message that will be  displayed if validation fails.  \\nThe following code example\", \" shows the IsNotNullOrEmptyRule<T>  validation rule, which is used to \\nperform validation of the use\", \"rname and password entered by the user on the LoginView  when using \\nmock services in the eShopOnCon\", \"ta iners mobile app:  \\npublic class IsNotNullOrEmptyRule <T> : IValidationRule <T> \\n{ \\n    public st\", \"ring ValidationMessage  { get; set; } \\n \\n    public bool Check(T value) \\n    { \\n        if (value ==\", \" null) \\n        { \\n            return false; \\n        } \\n \\n        var str = value as string; \\n     \", \"   return !string.IsNullOrWhiteSpace(str);  \\n    } \\n}  \\nThe Check  method returns a boolean  indicat\", \"ing whether the value  argument is null , empty, or \\nconsists only of whitespace characters.  \\nAltho\", \"ugh not used by the eShopOnContainers mobile app, the following code example shows a \\nvalidation rul\", \"e for validating email addresses:  \\npublic class EmailRule <T> : IValidationRule <T> \\n{ \\n    public \", \"string ValidationMessage  { get; set; } \\n \\n    public bool Check(T value) \\n    { \\n        if (value \", \"== null) 38 CHAPTER  6  |  Validation  \\n         { \\n            return false; \\n        } \\n \\n        \", \"var str = value as string; \\n        Regex regex = new Regex(@\\\"^([\\\\w\\\\.\\\\-]+)@([\\\\w\\\\-]+)((\\\\.(\\\\w){2,3})+)\", \"$\\\" ); \\n        Match match = regex.Match(str);  \\n \\n        return match.Success;  \\n    } \\n}  \\nThe Ch\", \"eck  method returns a boolean  indicating whether or not the value  argument  is a valid email \\naddr\", \"ess . This is achieved by searching the value  argument for the first occurrence of the regular \\nexp\", \"ression pattern specified in the Regex  constructor. Whether the regul ar expression pattern has \\nbe\", \"en found in the input string can be determined by checking the value of the Match  object's \\nSuccess\", \"  property.  \\nNote:  Property validation can sometimes involve dependent properties. An example of d\", \"ependent \\nproperties is when the se t of valid values for property A depends on the particular value\", \" that has \\nbeen set in property B. To check that the value of property A is one of the allowed value\", \"s would \\ninvolve retrieving the value of property B. In addition, when the value of property B  chan\", \"ges, \\nproperty A would need to be revalidated.  \\nAdding validation rules to a property  \\nIn the eSho\", \"pOnContainers mobile app, view model properties that require validation are declared to \\nbe of type \", \"ValidatableObject<T>,  where T is the type of the data to be validated. The following \\ncode example \", \"shows an example of two such properties:  \\npublic ValidatableObject <string> UserName  \\n{ \\n    get \\n\", \"    { \\n        return _userName;  \\n    } \\n    set \\n    { \\n        _userName  = value; \\n        Raise\", \"PropertyChanged(()  => UserName);  \\n    } \\n} \\n \\npublic ValidatableObject <string> Password  \\n{ \\n    \", \"get \\n    { \\n        return _password;  \\n    } \\n    set \\n    { \\n        _password  = value; \\n        \", \"RaisePropertyChanged(()  => Password);  \\n    } \\n}  \\nFor validation to occur, valid ation rules must \", \"be added to the Validations  collection of each \\nValidatableObject<T>  instance, as demonstrated in \", \"the following code example:  39 CHAPTER  6  |  Validation  \\n private void AddValidations()  \\n{ \\n    \", \"_userName.Validations.Add( new IsNotNullOrEmptyRule <string>  \\n    {  \\n        ValidationMessage  = \", \"\\\"A username  is required.\\\"   \\n    }); \\n    _password.Validations.Add( new IsNotNullOrEmptyRule <stri\", \"ng>  \\n    {  \\n        ValidationMessage  = \\\"A password  is required.\\\"   \\n    }); \\n} \\nThis method add\", \"s the IsNotNullOrEmptyRule<T>  validation rule to the Validations  collection of \\neach ValidatableOb\", \"ject<T>  instance, specifying values for the validation rule's ValidationMessage  \\nproperty, which s\", \"pecifies the validation error message that will be displayed if validation fails.  \\nTriggering valid\", \"ation  \\nThe validat ion approach used in the eShopOnContainers mobile app can manually trigger valid\", \"ation \\nof a property, and automatically trigger validation when a property changes.  \\nTriggering val\", \"idation manually  \\nValidation can be triggered manually for a view model property . For example, thi\", \"s occurs in the \\neShopOnContainers mobile app when the user taps the Login  button on the LoginView \", \", when using \\nmock services. The command delegate calls the MockSignInAsync  method in the LoginView\", \"Model , \\nwhich invokes validation by executing the Validate  method, which is shown in the following\", \" code \\nexample:  \\nprivate bool Validate()  \\n{ \\n    bool isValidUser  = ValidateUserName();  \\n    boo\", \"l isValidPassword  = ValidatePassword();  \\n    return isValidUser  && isValidPassword;  \\n} \\n \\nprivat\", \"e bool ValidateUserName()  \\n{ \\n    return _userName.Validate();  \\n} \\n \\nprivate bool ValidatePassword\", \"()  \\n{ \\n    return _password.Validate();  \\n}  \\nThe Validate  method performs validation of the usern\", \"ame and password entered by the user on the \\nLoginView , by invoking the Validate  method on each Va\", \"lidatableObject<T>  instance. The \\nfollowing code example shows the Validate  method from the Valida\", \"tableObject<T>  class:  \\npublic bool Validate()  \\n{ \\n    Errors.Clear();  \\n \\n    IEnumerable <string\", \"> errors = _validations  \\n        .Where(v  => !v.Check(Value))  \\n        .Select(v  => v.Validation\", \"Message);  40 CHAPTER  6  |  Validation  \\n  \\n    Errors = errors.ToList();  \\n    IsValid = !Errors.A\", \"ny();  \\n \\n    return this.IsValid;  \\n}  \\nThis method clears the Errors  collection, and then retriev\", \"es an y validation rules that were added to \\nthe object's Validations  collection. The Check  method\", \" for each retrieved validation rule is executed, \\nand the ValidationMessage  property value for any \", \"validation rule that fails to validate the data is \\nadded to the Errors  collection of the Validatab\", \"leObject<T>  instance. Finally, the IsValid  property \\nis set, and its value is returned to the call\", \"ing method, indicating whether validation succeeded or \\nfailed.  \\nTriggering validation when propert\", \"ies change  \\nValidation is als o automatically triggered whenever a bound property changes. For exam\", \"ple, when a \\ntwo-way binding in the LoginView  sets the UserName or Password  property, validation i\", \"s triggered. \\nThe following code example demonstrates how this occurs:  \\n<Entry Text=\\\"{Bindin g User\", \"Name.Value,  Mode=TwoWay}\\\" > \\n    <Entry.Behaviors > \\n        <behaviors:EventToCommandBehavior  \\n  \", \"          EventName= \\\"TextChanged\\\"  \\n            Command= \\\"{Binding  ValidateUserNameCommand}\\\"  /> \\n\", \"    </Entry.Behaviors > \\n    ... \\n</Entry>  \\nThe Entry  control binds  to the UserName.Value  proper\", \"ty of the ValidatableObject<T>  instance, \\nand the control's Behaviors  collection has an EventToCom\", \"mandBehavior  instance added to it. This \\nbehavior executes the ValidateUserNameCommand  in response\", \" to the TextChanged  event firing on \\nthe Entry, which is raised when the text in the Entry  changes\", \". In turn, the \\nValidateUserNameCommand  delegate executes the ValidateUserName  method, which execu\", \"tes the \\nValidate  method on the ValidatableObject<T>  instance. Therefore, every time the user ente\", \"rs a \\ncharacter in the Entry  control for the username, validation of the entered data is performed.\", \"  \\nFor more informati on about behaviors, see Implementing behaviors . \\nDisplaying validation errors\", \"  \\nThe eShopOnContainers mobile app notifies the user of any validation errors by highlighting the \\n\", \"control that contains the invalid data with a red line, and by displaying an error message that info\", \"rms \\nthe user why the data is inva lid below the control containing the invalid data. When the inval\", \"id data is \\ncorrected, the line changes to black and the error message is removed. Figure 6 -2 shows\", \" the \\nLoginView  in the eShopOnContainers mobile app when validation errors are present.  41 CHAPTER\", \"  6  |  Validation  \\n Figur e 6-2: Displaying validation errors during login  \\nHighlighting a contro\", \"l that contains invalid data  \\nThe LineColorBehavior  attached behavior is used to highlight Entry  \", \"controls where validation \\nerrors have occurred. The following code example shows how the LineColorB\", \"ehavior  attached \\nbehavior is attached to an Entry  control:  \\n<Entry Text=\\\"{Binding  UserName.Valu\", \"e,  Mode=TwoWay}\\\" > \\n    <Entry.Style > \\n        <OnPlatform  x:TypeArguments= \\\"Style\\\" \\n          iO\", \"S=\\\"{StaticResource  EntryStyle}\\\"  \\n          Android= \\\"{StaticResource  EntryStyle}\\\"  \\n          Win\", \"Phone= \\\"{StaticResource  UwpEntryStyle}\\\" /> \\n    </Entry.Style > \\n    ... \\n</Entry> \\nThe Entry  cont\", \"rol consumes an explicit style, which is shown in the following code example:  \\n<Style x:Key=\\\"EntryS\", \"tyle\\\"  \\n       TargetType= \\\"{x:Type  Entry}\\\"> \\n    ... \\n    <Setter Property= \\\"behaviors:LineColorBe\", \"havior.ApplyLineColor\\\"  \\n            Value=\\\"True\\\" /> \\n    <Setter Property= \\\"behaviors:LineColorBeha\", \"vior.LineColor\\\"  \\n            Value=\\\"{StaticResource  BlackColor}\\\"  /> \\n    ... \\n</Style>  \\nThis s t\", \"yle sets the ApplyLineColor  and LineColor  attached properties of the LineColorBehavior  \\nattached \", \"behavior on the Entry  control. For more information about styles, see Styles  on the Xamarin \\nDevel\", \"oper Center.  \\nWhen the value of the ApplyLineColor  attached property is set, or changes, the LineC\", \"olorBehavior  \\nattached behavior executes the OnApplyLineColorChanged  method, which is shown in the\", \" following \\ncode example:  \\n \\n \\n42 CHAPTER  6  |  Validation  \\n public static class LineColorBehavio\", \"r  \\n{ \\n    ... \\n    private static void OnApplyLineColorChanged(  \\n                BindableObject  b\", \"indable,  object oldValue,  object newValue)  \\n    { \\n        var view = bindable  as View; \\n       \", \" if (view == null) \\n        { \\n            return; \\n        } \\n \\n        bool hasLine = (bool)newVal\", \"ue;  \\n        if (hasLine)  \\n        { \\n            view.Effects.Add( new EntryLineColorEffect ()); \", \"\\n        } \\n        else \\n        { \\n            var entryLineColorEffectToRemove  =  \\n             \", \"       view.Effects.FirstOrDefault(e  => e is EntryLineColorEffect ); \\n            if (entryLineColo\", \"rEffectToRemove  != null) \\n            { \\n                view.Effects.Remove(entryLineColorEffectTo\", \"Remove);  \\n            } \\n        } \\n    } \\n} \\nThe parameters for this method prov ide the instance \", \"of the control that the behavior is attached to, \\nand the old and new values of the ApplyLineColor  \", \"attached property. The EntryLineColorEffect  \\nclass is added to the control's Effects  collection if\", \" the ApplyLineColor  attached property is true, \\notherwise it's removed from the control's Effects  \", \"collection. For more information about behaviors, \\nsee Implementing behaviors . \\nThe EntryLineColorE\", \"ffect  subclasses the RoutingEffect  class, and is shown in the following code \\nexample:  \\npublic cl\", \"ass EntryLineColorEffect  : RoutingEffect  \\n{ \\n    public EntryLineColorEffect()  : base(\\\"eShopOnCon\", \"tainers.EntryLineColorEffect\\\" ) \\n    { \\n    } \\n} \\nThe RoutingEffect  class represents a platform -in\", \"dependent effect that wraps an inner effect that's \\nplatform -specific. This simplifies the effect r\", \"emoval process, since there is no compile -time access to \\nthe type information for a platform -spec\", \"ific effect. The EntryLineColo rEffect  calls the base class \\nconstructor, passing in a parameter co\", \"nsisting of a concatenation of the resolution group name, and \\nthe unique ID that's specified on eac\", \"h platform -specific effect class.  \\nThe following code example shows the eShopOnContainers. EntryLi\", \"neColorEffect implementation for \\niOS: \\n[assembly:  ResolutionGroupName (\\\"eShopOnContainers\\\" )] \\n[as\", \"sembly:  ExportEffect (typeof(EntryLineColorEffect ), \\\"EntryLineColorEffect\\\" )] \\nnamespace  eShopOnC\", \"ontainers.iOS.Effects  \\n{ \\n    public class EntryLineColorEffect  : PlatformEffect  43 CHAPTER  6  |\", \"  Validation  \\n     { \\n        UITextField  control;  \\n \\n        protected  override  void OnAttache\", \"d()  \\n        { \\n            try \\n            { \\n                control = Control as UITextField ; \", \"\\n                UpdateLineColor();  \\n            } \\n            catch (Exception  ex) \\n            \", \"{ \\n                Console.WriteLine( \\\"Can't set property  on attached  control.  Error: \\\", ex.Messa\", \"ge);  \\n            } \\n        } \\n \\n        protected  override  void OnDetached()  \\n        { \\n     \", \"       control = null; \\n        } \\n \\n        protected  override  void OnElementPropertyChanged( Pro\", \"pertyChangedEventArgs  args) \\n        { \\n            base.OnElementPropertyChanged(args);  \\n \\n      \", \"      if (args.PropertyName  == LineColorBehavior .LineColorProperty.PropertyName  || \\n             \", \"   args.Propert yName == \\\"Height\\\" ) \\n            { \\n                Initialize();  \\n                \", \"UpdateLineColor();  \\n            } \\n        } \\n \\n        private void Initialize()  \\n        { \\n    \", \"        var entry = Element as Entry; \\n            if (entry != null) \\n            { \\n              \", \"  Control.Bounds  = new CGRect(0, 0, entry.Width,  entry.Height);  \\n            } \\n        } \\n \\n    \", \"    private void UpdateLineColor()  \\n        { \\n            BorderLineLayer  lineLayer  = control.La\", \"yer.Sublayers.OfType< BorderLineLayer >() \\n                                                         \", \"    .FirstOrDefault();  \\n \\n            if (lineLayer  == null) \\n            { \\n                lineL\", \"ayer  = new BorderLineLayer (); \\n                lineLayer.MasksToBounds  = true; \\n                l\", \"ineLayer.BorderWidth  = 1.0f; \\n                control.Layer.AddSublayer(lineLayer);  \\n             \", \"   control.BorderStyle  = UITextBorderStyle .None; \\n            } \\n \\n            lineLayer.Frame  = \", \"new CGRect(0f, Control.Frame.Height -1f, Control.Bounds.Width,  1f); \\n            lineLayer.B orderC\", \"olor  = LineColorBehavior .GetLineColor(Element).ToCGColor();  \\n            control.TintColor  = con\", \"trol.TextColor;  \\n        } \\n \\n        private class BorderLineLayer  : CALayer \\n        { \\n        \", \"} 44 CHAPTER  6  |  Validation  \\n     } \\n} \\nThe OnAttached  method retrieves the native control for \", \"the Xamarin.Forms Entry  control, and \\nupdates the line color by calling the UpdateLineColor  method\", \". The OnElementPropertyChanged  \\noverride responds to bindable property changes on the Entry  contro\", \"l by updating the lin e color if the \\nattached LineColor  property changes, or the Height  property \", \"of the Entry  changes. For more \\ninformation about effects, see  Effects  on the Xam arin Developer \", \"Center.  \\nWhen valid data is entered in the Entry  control, it will apply a black line to the bottom\", \" of the control, \\nto indicate that there is no validation error. Figure 6 -3 shows an example of thi\", \"s.  \\nFigure 6 -3: Black line indicating no valid ation error  \\nThe Entry  control also has a DataTri\", \"gger  added to its Triggers  collection. The following code \\nexample shows the DataTrigger : \\n<Entry\", \" Text=\\\"{Binding  UserName.Value,  Mode=TwoWay}\\\" > \\n    ... \\n    <Entry.Triggers > \\n        <DataTrig\", \"ger   \\n            TargetType= \\\"Entry\\\" \\n            Binding= \\\"{Binding  UserName.IsValid}\\\"  \\n       \", \"     Value=\\\"False\\\"> \\n            <Setter Property= \\\"behaviors:LineColorBehavior.LineColor\\\"   \\n      \", \"              Value=\\\"{StaticResource  ErrorColor}\\\"  /> \\n        </DataTrigger > \\n    </Entry.Trigger\", \"s > \\n</Entry> \\nThis DataTrigger  monitors the UserName.IsValid  property, and if it's value becomes \", \"false , it \\nexecutes the Setter , which changes the LineColor  attached property of the LineColorBeh\", \"avior  \\nattached behavio r to red. Figure 6 -4 shows an ex ample of this.  \\nFigure 6 -4: Red line in\", \"dicating validation error  \\nThe line in the Entry  control will remain red while the entered data is\", \" invalid, otherwise it will change \\nto black to indicate that the entered data is valid.  \\nFor more \", \"information about Trigge rs, see Triggers  on the Xamarin Developer Center.  \\nDisplaying error messa\", \"ges  \\nThe UI displays validation error messages in Label  controls below each control whose data fai\", \"led \\nvalidation. The following code example shows the Label  that displays a validation error messag\", \"e if \\nthe user has not entered a valid username:  \\n45 CHAPTER  6  |  Validation  \\n <Label Text=\\\"{Bin\", \"ding  UserName.Errors,  Converter={StaticResource  FirstValidationErrorConverter}\\\"  \\n       Style=\\\"{\", \"StaticResource  ValidationErrorLabelStyle}\\\"  />  \\nEach Label  binds to the Errors property of the vi\", \"ew model object that's being validated. The Errors  \\nproperty is provided by the ValidatableObject<T\", \">  class, and is o f type List<string>.  Because the \\nErrors  property can contain multiple validati\", \"on errors, the FirstValidationErrorConverter  \\ninstance is used to retrieve the first error from the\", \" collection  for display.  \\nSummary  \\nThe eShopOnContainers mobile app performs synch ronous client \", \"-side validation of view model \\nproperties and notifies the user of any validation errors by highlig\", \"hting the control that contains the \\ninvalid data, and by displaying error messages that inform the \", \"user why the data is invalid.  \\nView model pro perties that require validation are of type Validatab\", \"leObject <T>, and each \\nValidatableObject <T> instance has validation rules added to its Validations\", \"  property. Validation \\nis invoked from the view model by calling the Validate  method of the Valida\", \"tableObje ct<T> \\ninstance, which retrieves the validation rules and executes them against the Valida\", \"tableObject <T> \\nValue  property. Any validation errors are placed into the Errors  property of the \", \"\\nValidatableObject <T> instance, and the IsValid  property of the Validata bleObject <T> instance \\ni\", \"s updated to indicate whether validation succeeded or failed.   \\n \\n \\n46 CHAPTER  7  |  Configuration\", \" management  \\n  \\n \\nC H A P T E R  \\n \\n 7 \\n Configuration \\nmanagement  \\nSettings allow the separation \", \"of data that configures the behavior of an app from the code, allowing \\nthe behavior to be changed w\", \"ithout rebuilding the app. There are two types of settings: app settings, \\nand user settings.  \\nApp \", \"settings are data t hat an app creates and manages. It can include data such as fixed web service \\ne\", \"ndpoints, API keys, and runtime state. App settings are tied to the existence of the app and are onl\", \"y \\nmeaningful to that app.  \\nUser settings are the customizable settings of an a pp that affect the \", \"behavior of the app and don't \\nrequire frequent re -adjustment. For example, an app might let the us\", \"er specify where to retrieve data \\nfrom, and how to display it on the screen.  \\nXamarin.Forms includ\", \"es a persistent dictionary that can be use d to store settings data. This dictionary \\ncan be accesse\", \"d using the Application.Current.Properties  property, and any data that's placed \\ninto it is saved w\", \"hen the app goes into a sleep state, and is restored when the app resumes or starts \\nup again. In ad\", \"dit ion, the Application  class also has a SavePropertiesAsync  method that allows an \\napp to have i\", \"ts settings saved when required. For more information about this dictionary, see \\nProperties Diction\", \"ary  on the Xamarin Developer Center.  \\nA downside to storing data using the Xamarin.Forms persisten\", \"t dic tionary is that it's not easily data \\nbound to. Therefore, the eShopOnContainers mobile app us\", \"es the Xam.Plugins.Settings  library, \\navailable from NuGet . This library provides a consistent,  t\", \"ype-safe, cross -platform approach for \\npersisting and retrieving app and user settings, while using\", \" the native settings management provided \\nby each platform. In addition, it's straightforward to use\", \" data binding to access settings data exposed \\nby the libr ary. \\nNote:  While the Xam.Plugin.Setting\", \"s library can store both app and user settings, it makes no \\ndistinction between the two.  \\nCreating\", \" a settings class  \\nWhen using the Xam.Plugins.Settings  library, a single static  class should be c\", \"reated that will contain \\nthe app and user settings required by the app. The following code example \", \"shows the Settings  class \\nin the eShopOnContainers mobile app:  \\n 47 CHAPTER  7  |  Configuration m\", \"anagement  \\n public static class Settings  \\n{ \\n    private static ISettings  AppSettings  \\n    { \\n  \", \"      get \\n        { \\n            return CrossSettings .Current;  \\n        } \\n    } \\n    ... \\n}  \\nSe\", \"ttings can be read and written through the ISettings  API, which is provided by the \\nXam.Plugins.Set\", \"tings library. This library provides a singleton that can be us ed to access the API, \\nCrossSettings\", \".Current , and an app's settings class should expose this singleton via an ISettings  \\nproperty.  \\nN\", \"ote:  Using directives for the Plugin.Settings  and Plugin.Settings.Abstractions  \\nnamespaces should\", \" be added to a class that requires access to the Xam.Plugins.Settings library \\ntypes.  \\nAdding a set\", \"ting  \\nEach setting consists of a key, a default value, and a property. The following code example s\", \"hows all \\nthree items for a user setting tha t represents the base URL for the online services that \", \"the \\neShopOnContainers mobile app connects to:  \\npublic static class Settings  \\n{ \\n    ... \\n    priv\", \"ate const string IdUrlBase  = \\\"url_base\\\" ; \\n    private static readonly  string UrlBaseDefault  = Gl\", \"obalSetting .Instance.BaseEndpoint;  \\n    ... \\n \\n    public static string UrlBase \\n    { \\n        ge\", \"t \\n        { \\n            return AppSettings.GetValueOrDefault< string>(IdUrlBase,  UrlBaseDefault);\", \"  \\n        } \\n        set \\n        { \\n            AppSettings.AddOrUpdateValue< string>(IdUrlBase,  \", \"value); \\n        } \\n    } \\n} \\nThe key is always a const string  that defines the key name, with the \", \"default value for the setting \\nbeing a static readonly  value of the required type. Providing a defa\", \"ult value ensures that a valid \\nvalue is available if an unset setting is retrieved.  \\nThe UrlBase  \", \"static  property uses two methods from the ISettings  API to read or write the setting \\nvalue. The I\", \"Settings.GetValueOrDefault  method is used to retrieve a setting's value from \\nplatform -specific st\", \"orage. If no value is defined for the setting, its default value is retrieved instead. \\nSimilarly, t\", \"he ISettings.AddOrUpdateValue  method is used to persist a setting's value to platform -\\nspecific st\", \"orage.  48 CHAPTER  7  |  Configuration management  \\n Rather that define a default value inside the \", \"Settings  class, the UrlBaseDefault  string obtains its \\nvalue from the GlobalSetting  class. The fo\", \"llowing code example shows the BaseEndpoint  property \\nand UpdateEndpoint  method in this class:  \\np\", \"ublic class GlobalSetting  \\n{ \\n    ... \\n    public string BaseEndpoint  \\n    { \\n        get { return\", \" _baseEndpoint;  } \\n        set \\n        { \\n            _baseEndpoint  = value; \\n            UpdateE\", \"ndpoint(_baseEndpoint);  \\n        } \\n    } \\n    ... \\n \\n    private void UpdateEndpoint( string baseE\", \"ndpoint)  \\n    { \\n        RegisterWebsite  = string.Format( \\\"{0}:5105/Account/Register\\\" , baseEndpoi\", \"nt);  \\n        CatalogEndpoint  = string.Format( \\\"{0}:5101\\\" , baseEndpoint);  \\n        OrdersEndpoin\", \"t  = string.Format( \\\"{0}:5102\\\" , baseEndpoint);  \\n        BasketEndpoint  = string.Format( \\\"{0}:5103\", \"\\\" , baseEndpoint);  \\n        IdentityEndpoint  = string.Format( \\\"{0}:5105/connect/authorize\\\" , baseE\", \"ndpoint);  \\n        UserInfoEndpoint  = string.Format( \\\"{0}:5105/connect/userinfo\\\" , baseEndpoint); \", \" \\n        TokenEndpoin t = string.Format( \\\"{0}:5105/connect/token\\\" , baseEndpoint);  \\n        Logout\", \"Endpoint  = string.Format( \\\"{0}:5105/connect/endsession\\\" , baseEndpoint);  \\n        IdentityCallback\", \"  = string.Format( \\\"{0}:5105/xamarincallback\\\" , baseEndpoint);  \\n        LogoutCallback  = string.Fo\", \"rmat( \\\"{0}:5105/Account/Redirecting\\\" , baseEndpoint);  \\n    } \\n}  \\nEach time the BaseEndpoint  prope\", \"rty is set, the UpdateEndpoint  method is called. This method \\nupdates a series of properties, all o\", \"f which are based on the UrlBase  user setting that's pr ovided by \\nthe Settings  class that represe\", \"nt different endpoints that the eShopOnContainers mobile app \\nconnects to.  \\nData binding to user se\", \"ttings  \\nIn the eShopOnContainers mobile app, the SettingsView  exposes two user settings. These set\", \"tings \\nallow configura tion of whether the app should retrieve data from microservices that are depl\", \"oyed as \\nDocker containers, or whether the app should retrieve data from mock services that don't re\", \"quire an \\ninternet connection. When choosing to retrieve data from containerized microservices, a ba\", \"se \\nendpoint URL for the microservices must be specified. Figure 7 -1 shows the SettingsView  when t\", \"he \\nuser has chosen to retrieve data from containerized microservices.  49 CHAPTER  7  |  Configurat\", \"ion management  \\n  \\n \\n \\n \\n \\n \\n \\n \\n \\nFigure 7 -1: User settings exposed by the eShopOnContainers mobi\", \"le app  \\nData binding can be used to retrieve and set settings exposed by the Settings  class. This \", \"is achieved \\nby controls on the view binding to view model properties that in turn access properties\", \" in the \\nSettings  class, and raising a property changed n otification if the settings value has cha\", \"nged. For \\ninformation about how the eShopOnContainers mobile app constructs view models and associa\", \"tes \\nthem to views, see Automatically creating a view model with a vie w model locator . \\nThe follow\", \"ing code example shows the Entry  control from the SettingsView  that allows the user to \\nenter a ba\", \"se endpoint URL for the containerized microservices:  \\n<Entry Text=\\\"{Binding  Endpoint,  Mode=TwoWay\", \"}\\\"  />  \\nThis Entry  control binds to the Endpoint  property of the SettingsViewModel  class, using \", \"a two -way \\nbinding. The following code example shows the Endpoint  property:  \\npublic string Endpoi\", \"nt  \\n{ \\n    get { return _endpoint;  } \\n    set \\n    { \\n        _endpoint  = value; \\n \\n        if(!s\", \"tring.IsNullOrEmpty(_endpoint))  \\n        { \\n            UpdateEndpoint(_endpoint);  \\n        } \\n \\n \", \"       RaisePropertyChanged(()  => Endpoint);  \\n    } \\n} \\nWhen the Endpoint property is set the Upda\", \"teEndpoint  method is called, provided that the supplied \\nvalue  is valid, and property changed noti\", \"fication is raised. The following code example shows the \\nUpdateEndpoint  method:  \\nprivate void Upd\", \"ateEndpoint( string endpoint)  \\n{ \\n    Settings .UrlBase  = endpoint;  \\n} \\n50 CHAPTER  7  |  Configu\", \"ration management  \\n This method updates the UrlBase property in the Settings  class with the base e\", \"ndpoint URL value \\nentered by the user, which causes it to be persisted to platform -specific storag\", \"e.  \\nWhen the SettingsView  is navigated to, the InitializeAsync  method in the SettingsViewModel  \\n\", \"class is executed. The following code exampl e shows this method:  \\npublic override  Task Initialize\", \"Async( object navigationData)  \\n{ \\n    ... \\n    Endpoint  = Settings .UrlBase;  \\n    ... \\n} \\nThe met\", \"hod sets the Endpoint  property to the value of the UrlBase  property in the Settings  class. \\nAcces\", \"sing the UrlBase  property causes the Xam.Plugins.Settings library to retrieve the settings value \\nf\", \"rom platform -specific storage. For information about how the InitializeAsync  method is invoked, \\ns\", \"ee Passing parameters during navigation . \\nThis mechanism ensures that whenever a user navigates to \", \"the  SettingsView , user settings are \\nretrieved from platform -specific storage and presented throu\", \"gh data binding. Then, if the user \\nchanges the settings values, data binding ensures that t hey are\", \" immediately persisted back to \\nplatform -specific storage.  \\nSummary  \\nSettings allow the separatio\", \"n of data that configures the behavior of an app from the code, allowing \\nthe behavior to be changed\", \" without rebuilding the app. App settings are data that an app creates and \\nmanages, and user settin\", \"gs are the customizable settings of an app that affect the behavior of the app \\nand don't require fr\", \"equent re -adjustment.  \\nThe Xam.Plugins.Settings library provides a consistent, type -safe, cross -\", \"platform approach f or \\npersisting and retrieving app and user settings, and data binding can be use\", \"d to access settings \\ncreated with the library.   \\n \\n \\n51 CHAPTER  8  |  Containerized microservices\", \"  \\n  \\n \\nC H A P T E R  \\n \\n 8 \\n Containerized \\nmicroservices  \\nDeveloping client -server applications\", \" has resulted in a focus on building tiered applications that use \\nspecific technologies in each tie\", \"r. Such applications are often referred to a s monolithic  applications, \\nand are packaged onto hard\", \"ware pre -scaled for peak loads. The main drawbacks of this development \\napproach are the tight coup\", \"ling between components within each tier, that individual components \\ncan't be easily scaled, and th\", \"e cost  of testing. A simple update can have unforeseen effects on the rest \\nof the tier, and so a c\", \"hange to an application component requires its entire tier to be retested and \\nredeployed.  \\nParticu\", \"larly concerning in the age of the cloud, is that individual compon ents can't be easily scaled. A \\n\", \"monolithic application contains domain -specific functionality, and is typically divided by function\", \"al \\nlayers such as front end, business logic, and data storage. A monolithic application is scaled b\", \"y \\ncloning the entire applic ation onto multiple machines , as illustrated in Figure 8 -1. \\n \\n \\n \\n \\n\", \" \\n \\n \\n \\n \\n \\n \\nFigure 8-1: Monolithic application scaling approach  \\n52 CHAPTER  8  |  Containerized \", \"microservices  \\n Microservices  \\nMicroservices offer a different approach to application development\", \" and deployment, an approach \\nthat's suited to the agility, scale, and reliability requirements of m\", \"odern cloud applications. A \\nmicroservices application is decomposed into independent components tha\", \"t work together to deliver \\nthe application's overall functionality. The term microservice emphasize\", \"s that ap plications should be \\ncomposed of services small enough to reflect independent concerns, s\", \"o that each microservice \\nimplements a single function. In addition, each microservice has well -def\", \"ined contracts so that other \\nmicroservices can communicate and share data with it. Typical examples\", \" of microservices include \\nshopping carts, inventory processing, purchase subsystems, and payment pr\", \"ocessing.  \\nMicroservices can scale -out independently, as compared to giant monolithic applications\", \" that scale \\ntogether. This me ans that a specific functional area, that requires more processing po\", \"wer or network \\nbandwidth to support demand, can be scaled rather than unnecessarily scaling -out ot\", \"her areas of the \\napplication. Figure 8 -2 illustrates this approach, where microservices a re deplo\", \"yed and scaled \\nindependently, creating instances of services across machines.  \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \", \"\\nFigure 8-2: Microservices application scaling approach  \\nMicroservice scale -out can be nearly inst\", \"antaneous, allowing an application to adapt to changing \\nloads. For example, a single microservice i\", \"n the web -facing functionality of an application might be \\nthe only microservice in the application\", \" that needs to scale out to handle additional incoming traffic.  \\nThe classic model for application \", \"scalability is to have a  load-balanced, stateless tier with a shared \\nexternal datastore to store p\", \"ersistent data. Stateful microservices manage their own persistent data, \\nusually storing it locally\", \" on the servers on which they are placed, to avoid the overhead of network \\naccess a nd complexity o\", \"f cross -service operations. This enables the fastest possible processing of data \\nand can eliminate\", \" the need for caching systems. In addition, scalable stateful microservices usually \\npartition data \", \"among their instances, in order to manage da ta size and transfer throughput beyond \\nwhich a single \", \"server can support.  \\nMicroservices also support independent updates. This loose coupling between mi\", \"croservices provides \\na rapid and reliable application evolution. Their independent, distributed nat\", \"ure s upports rolling \\nupdates, where only a subset of instances of a single microservice will updat\", \"e at any given time. \\nTherefore, if a problem is detected, a buggy update can be rolled back, before\", \" all instances update \\nwith the faulty code or configuration. Sim ilarly, microservices typically us\", \"e schema versioning, so that \\n53 CHAPTER  8  |  Containerized microservices  \\n clients see a consist\", \"ent version when updates are being applied, regardless of which microservice \\ninstance is being comm\", \"unicated with.  \\nTherefore, microservice applications have many benefits ov er monolithic applicatio\", \"ns:  \\n\\u2022 Each microservice is relatively small, easy to manage and evolve.  \\n\\u2022 Each microservice can \", \"be developed and deployed independently of other services.  \\n\\u2022 Each microservice can be scaled -out \", \"independently. For example, a catalog service  or \\nshopping basket service might  need to be scaled \", \"-out more than an ordering service. \\nTherefore, the resulting infrastructure will more efficient ly \", \"consume  resources when scaling \\nout. \\n\\u2022 Each microservice isolates any issues. For example, if ther\", \"e is an issu e in a service it only \\nimpacts that service. The other services can continue to handle\", \" requests.  \\n\\u2022 Each microservice can use the latest technologies. Because microservices are autonomo\", \"us and \\nrun side -by-side, the latest technologies and frameworks can be use d, rather than being \\nf\", \"orced to use an older framework that might  be used by a monolithic application.  \\nHowever, a micros\", \"ervice based solution also has potential drawbacks:  \\n\\u2022 Choosing how to partition an application int\", \"o microservices can be challenging, as each \\nmicroservice has to be completely autonomous, end -to-e\", \"nd, including responsibility for its \\ndata sources.  \\n\\u2022 Developers must implement inter -service com\", \"munication, which adds complexity and latency \\nto the application.  \\n\\u2022 Atomic transactions between m\", \"ultiple microservices usually aren't possible. Therefore, \\nbusiness requirements must embrace eventu\", \"al consistency between microservices.  \\n\\u2022 In production, there is an operational complexity in deplo\", \"ying and managing a system \\ncompromised of many independent services.  \\n\\u2022 Direct client -to-microser\", \"vice communication can make it difficult to refactor the contracts of \\nmicroservices. For example, o\", \"ver time how the system is partitioned into services might  need \\nto change. A sin gle service might\", \"  split into two or mor e services, a nd two services might  \\nmerge. When clients communicate direct\", \"ly with microservices, this refactoring work can break \\ncompatibility with client apps.  \\nContaineri\", \"zation  \\nContainerization is an approach to software development in which an application and its ver\", \"s ioned set \\nof dependencies, plus its environment configuration abstracted as deployment manifest f\", \"iles, are \\npackaged together as a container image, tested as a unit, and deployed to a host operatin\", \"g system.  \\nA container is an isolated, resource controlled, and portable operating environment, whe\", \"re an \\napplication can run without touching the resources of other containers, or the host. Therefor\", \"e, a \\ncontainer looks and acts like a newly installed physical computer or a virtual machine.  \\nTher\", \"e are many similariti es between containers and virtual machines, as illustrated in Figure 8 -3. 54 \", \"CHAPTER  8  |  Containerized microservices  \\n Figure 8-3: Comparison of virtual machines and contain\", \"ers  \\nA container runs an operating system, has a file system, and can be accesse d over a network a\", \"s if it \\nwere  a physical or vir tual machine. However, the technology and concepts used by containe\", \"rs are very \\ndifferent from virtual machines. Virtual machines include the applications, the require\", \"d dependencies, \\nand a full guest operating system. Containers include the application and its depen\", \"dencies, but share \\nthe operating system with other containers, running as isolated processes on the\", \" host operating \\nsystem (aside from Hyper -V containers which run inside of a special virtual machin\", \"e per container). \\nTherefore, containers  share reso urces and typically require fewer resources tha\", \"n virtual machines . \\nThe advantage of a container -oriented development and deployment approach is \", \"that it eliminates \\nmost of the issues that arise from inconsistent environment setups and the probl\", \"ems that come  with \\nthem. In addition, containers permit fast application scale -up functionality b\", \"y instancing new \\ncontainers as required.  \\nThe key concepts when creating and working with containe\", \"rs are:  \\n\\u2022 Container Host: The physical or virtual machine configured to host containers. The conta\", \"iner \\nhost will run one or more containers.  \\n\\u2022 Container Image: An image consists of a union of lay\", \"ered filesystems stacked on top of each \\nother, and is the basis of a container. An image does not h\", \"ave state and it never changes as \\nit's de ployed to different environments.  \\n\\u2022 Container: A contai\", \"ner is a runtime instance of an image.  \\n\\u2022 Container OS Image: Containers are deployed from images. \", \"The container operating system \\nimage is the first layer in potentially many image layers that make \", \"up a con tainer. A container \\noperating system is immutable, and can't be modified.  \\n\\u2022 Container Re\", \"pository: Each time a container image is created, the image and its dependencies \\nare stored in a lo\", \"cal repository. These images can be reused many times on the container \\nhost. The container images c\", \"an also be stored in a public or private registry, such as Docker \\nHub, so that they can be used acr\", \"oss different container hosts.  \\n55 CHAPTER  8  |  Containerized microservices  \\n Enterprises are in\", \"creasingly adopting containers when impl ementing microservice based applications, \\nand Docker has b\", \"ecome the standard container implementation that has been adopted by most \\nsoftware platforms and cl\", \"oud vendors.  \\nThe eShopOnContainers reference application uses Docker to host four containerized ba\", \"c k-end \\nmicroservices, as illustrated in Figure 8 -4. \\n \\nFigure 8-4: eShopOnContainers reference ap\", \"plication back -end microservices  \\nThe architecture of the back -end services in the reference appl\", \"ication is decomposed into multiple \\nautonomous sub -systems in the  form of collaborating microserv\", \"ices and containers. Each microservice \\nprovides a single area of functionality: an identity service\", \", a catalog service, an ordering service, and a \\nbasket service.  \\nEach microservice has its own dat\", \"abase, allowing it to be ful ly decoupled from the other \\nmicroservices. Where necessary, consistenc\", \"y between databases from different microservices is \\nachieved using application -level events. For m\", \"ore information, see Communicati on between \\nmicroservices . \\nFor more information about the referen\", \"ce application, see .NET Microservices: Architecture for \\nContainerized .NET Applications . \\nCommuni\", \"cation between client and microservices  \\nThe eShopOnContainers mobile app communicates with the con\", \"tainerized back -end microservices \\nusing direct client -to-microservice  communication, which is sh\", \"own in Figure 8 -5. \\n56 CHAPTER  8  |  Containerized microservices  \\n  \\nFigure 8-5: Direct client -t\", \"o-microservice communication  \\nWith direct client -to-microservice communication, the mobile app mak\", \"es requests t o each \\nmicroservice directly through  its public endpoint, with a different TCP port \", \"per microservice. In \\nproduction, the endpoint would typically map to the microservice's load balanc\", \"er, which distrib utes \\nrequests across the available instances.  \\nTip: Consider using API gateway c\", \"ommunication  \\nDirect client -to-microservice communication can have drawbacks when building a large\", \" and \\ncomplex microservice based application, but it's more than adequate for a s mall application. \", \"When \\ndesigning a large microservice based application with tens of microservices, consider using AP\", \"I \\ngateway communication. For more information, see .NET Microservices: Architecture for \\nContaineri\", \"zed .NET Applications . \\nCommunication between microservices  \\nA microservices based application is \", \"a distributed system, potentially running on multiple machines. \\nEach service instance is typically \", \"a process. Therefore, services must interact using a n inter -process \\ncommunication protocol, such \", \"as HTTP, TCP, Advanced Message Queuing Protocol (AMQP), or binary \\nprotocols, depending on the natur\", \"e of each service.  \\nThe two common approaches for microservice -to-microservice communication are H\", \"TTP based REST \\ncommunication when querying for data, and lightweight asynchronous messaging when \\nc\", \"ommunicating updates across multiple microservices.  \\nAsynchronous messaging based event -driven com\", \"munication is critical when propagating changes \\nacross multiple microservice s. With this approach,\", \" a microservice publishes an event when something \\nnotable happens, for example , when it updates a \", \"business entity. Other microservices subscribe to \\nthese events. Then, when a microservice receives \", \"an event, it updates its own business  entities, which \\nmight  in turn lead to more events being pub\", \"lished. This publish -subscribe functionality is usually \\nachieved with an event bus.  \\nAn event bus\", \" allows publish -subscribe communication between microservices, without requiring the \\ncomponents to\", \" b e explicitly aware of each other, as shown in Figure 8 -6. \\n57 CHAPTER  8  |  Containerized micro\", \"services  \\n  \\nFigure 8-6: Publish -subscribe with an event bus  \\nFrom an application perspective, th\", \"e event bus is simply a publish -subscribe channel exposed via an \\ninterface. However, the way the e\", \"vent bus is imp lemented can vary. For example, an event bus \\nimplementation could use RabbitMQ, Azu\", \"re Service Bus, or other service buses such as NServiceBus \\nand MassTransit. Figure 8 -7 shows how a\", \"n event bus is used in the eShopOnContainers reference \\napplication.  \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\nFig\", \"ure 8 -7: Asynchronous event -driven communication in the reference application  \\nThe eShopOnContain\", \"ers event bus, implemented using RabbitMQ, provides one -to-many \\nasynchronous publish -subscribe fu\", \"nctionality. This means that after publishing an even t, there can be \\nmultiple subscribers listenin\", \"g for the same event. Figure 8 -9 illustrates this relationship.  \\n58 CHAPTER  8  |  Containerized m\", \"icroservices  \\n Figure 8-9: One -to-many communication  \\nThis one -to-many communication approach us\", \"es events to implement business transactions that span \\nmultiple services, ensuring eventual consist\", \"ency between the services. An eventual -consistent \\ntransaction consists of a series of distributed \", \"steps. Therefore,  when the user -profile microservice \\nreceives the UpdateUser  command, it updates\", \" the user's details in its database and publishes the \\nUserUpdated  event to the event bus. Both the\", \" basket microservice and the ordering microservice \\nhave subscribed to receive t his event, and in r\", \"esponse update their buyer information in their \\nrespective databases.  \\nNote:  The eShopOnContainer\", \"s event bus, implemented using RabbitMQ, is intended to be used \\nonly as a proof of concept. For pro\", \"duction systems, alternative event bus imp lementations should \\nbe considered.  \\nFor information abo\", \"ut the event bus implementation, see .NET Microservices: Architecture for \\nContainerized .NET Applic\", \"ations . \\nSummary  \\nMicroservices offer an approach to ap plication development and deployment that'\", \"s suited to the \\nagility, scale, and reliability requirements of modern cloud applications. One of t\", \"he main advantages \\nof microservices is that they can be scaled -out independently, which means that\", \" a specific funct ional \\narea can be scaled that requires more processing power or network bandwidth\", \" to support demand, \\nwithout unnecessarily scaling  areas of the application that are not experienci\", \"ng increased demand.  \\nA container is an isolated, resource controlled, and por table operating envi\", \"ronment, where an \\napplication can run without touching the resources of other containers, or the ho\", \"st. Enterprises are \\nincreasingly adopting containers when implementing microservice based applicati\", \"ons, and Docker has \\nbecome the standar d container implementation that has been adopted by most sof\", \"tware platforms \\nand cloud vendors.  \\n \\n \\n \\n59 CHAPTER  9  |  Authentication and authorization  \\n  \\n\", \" \\nC H A P T E R  \\n \\n 9 \\n Authentication \\nand authorization  \\n \\nAuthentication is the process of obta\", \"ining identification credentials such as name and password from \\na user, and validating those creden\", \"tials against an authority. If the credentials are valid, the entity that \\nsubmitted the credentials\", \" is considered an authenticated identity. Once an identity has been \\nauthenticated, an authorization\", \" process determines whether that identity has access to a given \\nresource.  \\nThere are many appr oac\", \"hes to  integrating authentication and authorization into a Xamarin.Forms app \\nthat communicates wit\", \"h an ASP.NET MVC web application, including using ASP.NET Core Identity, \\nexternal authentication pr\", \"oviders such as Microsoft, Google, Facebook, or Twitter,  and authentication \\nmiddleware. The eShopO\", \"nContainers mobile app performs authentication and authorization with a \\ncontainerized identity micr\", \"oservice that uses IdentityServer 4. The mobile app requests security tokens \\nfrom IdentityServer, e\", \"ither for authen ticating a user or for accessing a resource. For IdentityServer to \\nissue tokens on\", \" behalf of a user, the user must sign -in to IdentityServer. However, IdentityServer \\ndoesn't provid\", \"e a user interface or database for authentication. Therefore, in the eShopOn Containers \\nreference a\", \"pplication, ASP.NET Core Identity is used for this purpose.  \\nAuthentication  \\nAuthentication is req\", \"uired when an application needs to know the identity of the current user. \\nASP.NET Core's primary me\", \"chanism for identifying users is the A SP.NET Core Identity membership \\nsystem, which stores user in\", \"formation in a data store configured by the developer. Typically, this data \\nstore will be an Entity\", \"Framework store, though custom stores or third party packages can be used to \\nstore identity infor m\", \"ation in Azure storage, DocumentDB, or other locations.  \\nFor authentication scenarios that make use\", \" of a local user data store, and that persist identity \\ninformation between requests via cookies (as\", \" is typical in ASP.NET MVC web applications), ASP.NET \\nCore  Identity is a suitable solution. Howeve\", \"r, cookies are not always a natural means of persisting and \\ntransmitting data. For example, an ASP.\", \"NET Core web application that exposes RESTful endpoints that \\nare accessed from a mobile app will ty\", \"pically need to us e bearer token authentication, since cookies \\ncan't be used in this scenario. How\", \"ever, bearer tokens can easily be retrieved and included in the \\nauthorization header of web request\", \"s made from the mobile app.  60 CHAPTER  9  |  Authentication and authorization  \\n Issuing bearer to\", \"kens using IdentityServer 4  \\nIdentityServer 4  is an open source OpenID Connect and OAuth 2.0 frame\", \"work for ASP.NET Core, \\nwhich can be used for many authentication and authorization scenarios includ\", \"ing issuing security \\ntoken s for local ASP.NET Core Identity users.  \\nNote:  OpenID Connect and OAu\", \"th 2.0 are very similar, while having different responsibilities.  \\nOpenID Connect is an authenticat\", \"ion layer on top of the OAuth 2.0 protocol. OAuth 2 is a protocol \\nthat allows applications to reque\", \"st access tokens from a security token service and use them to \\ncommunicate with APIs. This delegati\", \"on reduces complexity in both client applications and APIs \\nsince authentication and authorization c\", \"an be centralized.  \\nThe combination of  OpenID Connect and OAuth 2.0 combine the two fundamental se\", \"curity \\nconcerns of authentication and API access, and IdentityServer 4 is an implementation of thes\", \"e \\nprotocols.  \\nIn applications that use direct client -to-microservice communication, such as the e\", \" ShopOnContainers \\nreference application, a dedicated authentication microservice acting as a Securi\", \"ty Token Service (STS) \\ncan be used to authenticate users, as shown in Figure 9 -1. For more informa\", \"tion about direct client -\\nto-microservice communication, see Communication between client and micro\", \"services . \\nFigure 9 -1: Authentication by a dedicated authentication microservice  \\nThe eShopOnCont\", \"ainers mobile app communicates with the identity microservice, which uses \\nIdentityServer 4 to perfo\", \"rm authentication, and access control for APIs. Therefore, the mobile app \\nrequests tokens from Iden\", \"tityServer, either for authenticating a user or for accessing a resource:  \\n\\u2022 Authenticating users w\", \"ith IdentityServer is achieved by th e mobile app requesting an identity  \\ntoken, which represents t\", \"he outcome of an authentication process. At a bare minimum, it \\ncontains an identifier for the user,\", \" and information about how and when the user \\nauthenticated. It can also contain additional ident it\", \"y data.  \\n\\u2022 Accessing a resource with IdentityServer is achieved by the mobile app requesting an acc\", \"ess  \\ntoken, which allows access to an API resource. Clients request access tokens and forward \\nthem\", \" to the API. Access tokens contain information about the clie nt, and the user (if present). \\nAPIs t\", \"hen use that information to authorize access to their data.  \\nNote : A client must be registered wit\", \"h IdentityServer before it can request tokens.  \\nAdding IdentityServer to a web application  \\nIn ord\", \"er for an ASP.NET Core web  application to use IdentityServer 4, it must be added to the web \\napplic\", \"ation's Visual Studio solution. For more information, see Setup and Overview  in the \\nIdenti tyServe\", \"r documentation.  \\n \\n61 CHAPTER  9  |  Authentication and authorization  \\n Once IdentityServer is in\", \"cluded in the web application's Visual Studio solution, it must be added to \\nthe web application's H\", \"TTP request processing pipeline, so that it can serve requests to OpenID \\nConnect and OAuth 2.0 endp\", \"oints. T his is achieved in the Configure  method in the web application's \\nStartup  class, as demon\", \"strated in the following code example:  \\npublic void Configure(  \\n    IApplicationBuilder  app, IHos\", \"tingEnvironment  env, ILoggerFactory  loggerFactory)  \\n{ \\n    ... \\n    app.UseI dentity();  \\n    ...\", \" \\n}  \\nOrder matters in the web application's HTTP request processing pipeline. Therefore, IdentitySe\", \"rver \\nmust be added to the pipeline before the UI framework that implements the login screen.  \\nConf\", \"iguring IdentityServer  \\nIdentityServer shoul d be configured in the ConfigureServices  method in th\", \"e web application's \\nStartup  class by calling the services.AddIdentityServer  method, as demonstrat\", \"ed in the \\nfollowing code example from the eShopOnContainers reference application:  \\npublic void Co\", \"nfigureSe rvices(IServiceCollection  services)  \\n{ \\n    ... \\n    services.AddIdentityServer(x  => x.\", \"IssuerUri  = \\\"null\\\") \\n        .AddSigningCredential(Certificate.Get())                 \\n        .Add\", \"AspNetIdentity<ApplicationUser>()  \\n        .AddConfigurationStore(builder  => \\n            builder.\", \"UseSqlServer(connectionString,  options => \\n                options.MigrationsAssembly(migrationsAss\", \"embly)))  \\n        .AddOperationalStore(builder  => \\n            builder.UseSqlServer(connectionStri\", \"ng,  options => \\n                options.Mig rationsAssembly(migrationsAssembly)))  \\n        .Servic\", \"es.AddTransient<IProfileService,  ProfileService>();  \\n}  \\nAfter calling the services.AddIdentitySer\", \"ver  method, additional fluent APIs are called to \\nconfigure the following:  \\n\\u2022 Credentials used for\", \" signing.  \\n\\u2022 API and identity resources that users might  request access to.  \\n\\u2022 Clients that will \", \"be connecting to request tokens.  \\n\\u2022 ASP.NET Core Identity.  \\nTip: Dynamically load the IdentityServ\", \"er 4 configuration  \\nIdentityServer 4's APIs allow for configuring IdentityServer from  an in -memor\", \"y list of configuration \\nobjects. In the eShopOnContainers reference application, these in -memory c\", \"ollections are hard -\\ncoded into the application. However, in production scenarios they can be loade\", \"d dynamically from \\na configuration file or from a database.  \\nFor information about configuring Ide\", \"ntityServer to use ASP.NET Core Identity, see Using ASP.NET \\nCore Identity  in the IdentityServer do\", \"cumentation.  62 CHAPTER  9  |  Authentication and authorization  \\n Configuring API resources  \\nWhen\", \" configuring API resources, the AddInMemoryApiResources  method expects an \\nIEnumerable< ApiResource\", \" > collection. The following code example shows the GetApis  method that \\nprovides this collec tion \", \"in the eShopOnContainers reference application:  \\npublic static IEnumerable<ApiResource>  GetApis() \", \" \\n{ \\n    return new List<ApiResource>  \\n    { \\n        new ApiResource( \\\"orders\\\" , \\\"Orders Service\\\" \", \"), \\n        new ApiResource( \\\"basket\\\" , \\\"Basket Service\\\" ) \\n    }; \\n}  \\nThis method specifies that I\", \"dentityServer should protect the orders  and basket  APIs. Therefore, \\nIdentityServer managed access\", \" tokens will be required when making calls to these APIs. For more \\ninformation about the ApiResourc\", \"e  type, see API Resource  in the IdentityServer 4 documentation.  \\nConfiguring identity resources  \", \"\\nWhen configuring identity resources, the AddInMemoryIdentityResources  method expects an \\nIEnumerab\", \"le<IdentityResource>  collection. Identity resources are data such as user ID, name, or \\nemail addre\", \"ss. Each identity resource has a unique name, and arbitrary claim types can be assigned to \\nit, whic\", \"h will then be included in the identity  token for the user. The following code example shows \\nthe G\", \"etResources  method that provides this collection in the eShopOnContainers reference \\napplication:  \", \"\\npublic static IEnumerable<IdentityResource>  GetResources()  \\n{ \\n    return new List<IdentityResour\", \"ce>  \\n    { \\n        new IdentityResources.OpenId(),  \\n        new IdentityResources.Profile()  \\n   \", \" }; \\n}  \\nThe OpenID Connect specification specifies some standard identity resourc es. The minimum \\n\", \"requirement is that support is provided for emitting a unique ID for users. This is achieved by \\nexp\", \"osing the IdentityResources.OpenId  identity resource.  \\nNote:  The IdentityResources  class support\", \"s all of the scopes defined in the OpenID Conn ect \\nspecification (openid, email, profile, telephone\", \", and address).  \\nIdentityServer also supports defining custom identity resources. For more informat\", \"ion, see Defining \\ncustom identity resources  in the IdentityServer documentation. For more informat\", \"ion about the \\nIdentityResource  type, see Identity Resource  in the IdentityServer 4 documentation.\", \"  \\nConfiguring clients  \\nClients are applications that can request tokens from IdentityServer. Typic\", \"ally, the following settings \\nmust be defined for each client as a minimum:  \\n\\u2022 A unique client ID. \", \" \\n\\u2022 The a llowed interactions with the token service (known as the grant type).  \\n\\u2022 The location whe\", \"re identity and access tokens are sent to (known as a redirect URI).  63 CHAPTER  9  |  Authenticati\", \"on and authorization  \\n \\u2022 A list of resources that the client is allowed access to (known as scopes)\", \".  \\nWhen configuring clients,  the AddInMemoryClients  method expects an IEnumerable<Client>  \\ncolle\", \"ction. The following code example shows the configuration for the eShopOnContainers mobile \\napp in t\", \"he GetClients  method that provides this collection in the eShopOnContainers reference \\napplication:\", \"  \\npublic static IEnumerable<Client>  GetClients(Dictionary< string,string> clientsUrl)  \\n{ \\n    ret\", \"urn new List<Client>  \\n    { \\n        ... \\n        new Client \\n        { \\n            ClientId  = \\\"x\", \"amarin\\\" , \\n            ClientName  = \\\"eShop Xamarin OpenId Client\\\", \\n            AllowedGrantTypes  \", \"= GrantTypes.Hybrid , \\n            ClientSecrets  = \\n            { \\n                new Secret(\\\"secr\", \"et\\\" .Sha256())  \\n            }, \\n            RedirectUris  = { clientsUrl[ \\\"Xamarin\\\" ] }, \\n         \", \"   RequireConsent  = false, \\n            RequirePkce  = true, \\n            PostLogoutRedirectUris  =\", \" { $\\\"{clientsUrl[ \\\"Xamarin\\\" ]}/Account/Redirecting\\\"  }, \\n            AllowedCorsOrigins  = { \\\"http:/\", \"/eshopxamarin\\\"  }, \\n            AllowedScopes  = new List<string> \\n            { \\n                Id\", \"entityServerConstants.StandardScopes.OpenId,  \\n                IdentityServerConstants.StandardScope\", \"s.Profile,  \\n                IdentityServerConstants.StandardScopes.OfflineAccess,  \\n               \", \" \\\"orders\\\" , \\n                \\\"basket\\\"  \\n            },  \\n            AllowOfflineAccess  = true, \\n  \", \"          AllowAccessTokensViaBrowser  = true \\n        }, \\n        ... \\n    }; \\n}  \\nThis configurati\", \"on specifies data for the following properties:  \\n\\u2022 ClientId : A unique ID for the client.  \\n\\u2022 Clien\", \"tName : The client d isplay name, which is used for logging and the consent screen.  \\n\\u2022 AllowedGrant\", \"Types : Specifies how a client wants to interact with IdentityServer. For more \\ninformation see Conf\", \"iguring the authentication flow . \\n\\u2022 ClientSecrets : Specifies the client secret credentials that ar\", \"e used when requesting tokens \\nfrom the token endpoint . \\n\\u2022 RedirectUris : Specifies the allowed URI\", \"s to  which to  return tokens or authorization codes . \\n\\u2022 RequireConsent : Specifies whether a conse\", \"nt screen is required.  \\n\\u2022 RequirePkce : Specifies whe ther clients using an authorization code  mus\", \"t send a proof key.  \\n\\u2022 PostLogoutRedirectUris : Specifies the allowed URIs to redirect to after log\", \"out.  64 CHAPTER  9  |  Authentication and authorization  \\n \\u2022 AllowedCorsOrigins : Specifies the ori\", \"gin of the client so that Ide ntityServer can allow cross -\\norigin calls from the origin.  \\n\\u2022 Allowe\", \"dScopes : Specifies the resources the client has access to. By default, a client has no \\naccess to a\", \"ny resources.  \\n\\u2022 AllowOfflineAccess : Specifies whether the client can request refresh tokens.  \\nCo\", \"nfiguring the authentication flow  \\nThe authentication flow between a client and IdentityServer can \", \"be configured by specifying the grant \\ntypes in the Client.AllowedGrantTypes  property. The OpenID C\", \"onnect and OAuth 2.0 specifications \\ndefine a number of authen tication flows, including:  \\n\\u2022 Implic\", \"it. This flow is optimized for browser -based applications and should be used either for \\nuser authe\", \"ntication -only, or authentication and access token requests. All tokens are \\ntransmitted via the br\", \"owser, and therefore advanc ed features like refresh tokens are not \\npermitted.  \\n\\u2022 Authorization co\", \"de. This flow provides the ability to retrieve tokens on a back channel, as \\nopposed to the browser \", \"front channel, while also supporting client authentication.  \\n\\u2022 Hybrid. This flow is a combin ation \", \"of the implicit and authorization code grant types. The \\nidentity token is transmitted via the brows\", \"er channel and contains the signed protocol \\nresponse along with other  artifacts such as the author\", \"ization code. After successful validation \\nof the resp onse, the back channel should be  used to ret\", \"rieve the access and refresh token.  \\nTip: Use the hybrid authentication flow  \\nThe hybrid authentic\", \"ation flow mitigates a number of attacks that apply to the browser channel, \\nand is the recommended \", \"flow for native a pplications that want to retrieve access tokens (and \\npossibly refresh tokens).  \\n\", \"For more information about authentication flows, see Grant Types  in the IdentityServer 4 \\ndocumenta\", \"tion.  \\nPerforming authentication  \\nFor IdentityServer to issue tokens on behalf of a user, the user\", \" must sign -in to IdentityServer. \\nHowever, IdentityServer doesn't provide a user interface or datab\", \"ase for authentication. Therefore, in \\nthe eShopOnCo ntainers reference application, ASP.NET Core Id\", \"e ntity is used for this purpose.  \\nThe eShopOnContainers mobile app auth enticates with IdentitySer\", \"ver  with the hybrid authentication \\nflow, which is illustrated in Figure 9 -2. \\nFigure 9 -2: High -\", \"level overview of the sign -in process  \\n65 CHAPTER  9  |  Authentication and authorization  \\n A sig\", \"n -in request is made to <base endpoint>:5105/connect/authorize . Following successful \\nauthenticati\", \"on, IdentityServer returns an authentication response containing an authorization code \\nand an ident\", \"ity token.  The authorization code is then sent to <base \\nendpoint>:5105/connect/token , which respo\", \"nds with access, identity, and refresh tokens.  \\nThe eShopOnContainers mobile app signs -out of Iden\", \"tityServer by sending a request to \\nhttp://<base  endpoint>:5 105/connect/endsession , with addition\", \"al parameters. After sign -out \\noccurs, IdentityServer responds by sending a post logout redirect UR\", \"I back to the mobile app. Figure \\n9-3 illustrates this process.  \\nFigure 9 -3: High -level overview \", \"of the sign -out process  \\nIn the eShopOnContainers mobile app, communication with IdentityServer is\", \"  performed by the \\nIdentityService  class, which implements the IIdentityService  interface. This i\", \"nterface specifies \\nthat the implementing class must provide CreateAuthorizationRequest , CreateLogo\", \"utRequest , \\nand GetTokenAsync  methods.  \\nSigning -in \\nWhen the user taps the LOGIN  button on the \", \"LoginView , the SignInCommand  in the LoginViewModel  \\nclass is executed, which in turn executes the\", \" SignInAsync  method. The following code example \\nshows this method:  \\nprivate async Task SignInAsyn\", \"c()  \\n{ \\n    ... \\n    LoginUrl  = _identityService.CreateAuthorizationRequest();  \\n    IsLogin = tru\", \"e; \\n    ... \\n}  \\nThis method invokes the CreateAuthorizationRequest  method in the IdentityService  \", \"class, \\nwhich is shown in the following code example:  \\npublic string CreateAuthorizationRequest()  \", \"\\n{ \\n    // Create URI to authorization  endpoint  \\n    var authorizeRequest  = new AuthorizeRequest \", \"(GlobalSetting .Instance.IdentityEndpoint);  \\n \\n    // Dictionary  with values for the authorize  re\", \"quest \\n    var dic = new Dictionary <string, string>(); \\n    dic.Add( \\\"client_id\\\" , GlobalSetting .I\", \"nstance.ClientId);  \\n    dic.Add( \\\"client_secret\\\" , GlobalSetting .Instance.ClientSecret);   \\n    di\", \"c.Add( \\\"response_type\\\" , \\\"code id_token\\\" ); \\n    dic.Add( \\\"scope\\\", \\\"openid profile basket orders loc\", \"ations  marketing  offline_access\\\" ); \\n    dic.Add( \\\"redirect_uri\\\" , GlobalSetting .Instance.Identit\", \"yCallback);  \\n    dic.Add( \\\"nonce\\\", Guid.NewGuid().ToString( \\\"N\\\")); \\n    dic.Add( \\\"code_challenge \\\",\", \" CreateCodeChallenge() ); \\n    dic.Add( \\\"code_challenge_method\\\" , \\\"S256\\\"); \\n \\n66 CHAPTER  9  |  Auth\", \"entication and authorization  \\n     // Add CSRF token to protect against cross-site request forgery \", \"attacks.  \\n    var currentCSRFToken  = Guid.NewGuid().ToString( \\\"N\\\"); \\n    dic.Add( \\\"state\\\", current\", \"CSRFToken);  \\n \\n    var authorizeUri  = authorizeRequest.Create(dic);   \\n    return authorizeUri;  \\n\", \"} \\nThis method creates the URI for IdentityServer's authorization endpoint , with the required param\", \"eters. \\nThe authorization endpoint is at /connect/authorize  on port 5105 of the base endpoint expos\", \"ed as \\na user setting. For more information about user settings, see Configuration management . \\nNot\", \"e : The a ttack surface of the eShopOnContainers mobile app is reduced by implementing the \\nProof Ke\", \"y for Code Exchange (PKCE) extension to OAuth. PKCE protects the authorization code \\nfrom being used\", \" if it\\u2019s intercepted. This is achieved by the client generating a se cret verifier, a hash \\nof which\", \" is passed in the authorization request, and which is presented unhashed  when redeeming \\nthe author\", \"ization code. For more information about PKCE, see Proof Key for Code Exchan ge by \\nOAuth Public Cli\", \"ents  on the Internet Engineering Task Force web site.  \\nThe returned URI is stored in the LoginUrl \", \" property of the LoginViewModel  class. When the IsLogin  \\nproperty becomes true , the WebView  in t\", \"he LoginView  becomes visible. The WebView  data binds its \\nSource  property to the LoginUrl propert\", \"y of the LoginViewModel  class, and so makes a sign -in \\nrequest to IdentityServer when the LoginUrl\", \"  property is set to IdentityServer's authorization \\nendpoint. When IdentityServer receives this req\", \"uest and  the user isn't authenticated, the WebView  will \\nbe redirected to the configured login pag\", \"e , which is  shown in Figure 9 -4. \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\nFigure 9 -4: Login page displayed by \", \"the WebView  \\nOnce login is completed, the WebView  will be redirected to a return URI. This WebView\", \"  navigation will \\ncause the NavigateAsync method in the LoginViewModel  class to be executed, which\", \" is shown in \\nthe following code example:  \\n67 CHAPTER  9  |  Authentication and authorization  \\n pr\", \"ivate async Task NavigateAsync( string url) \\n{ \\n    ... \\n    var authResponse = new AuthorizeRespons\", \"e (url); \\n    if (!string.IsNullOrWhiteSpace(authResponse.Code))  \\n    { \\n        var userToken  = a\", \"wait _identityService.GetTokenAsync(authResponse.Code);  \\n        string accessToken  = userToken.Ac\", \"cessToken;  \\n \\n        if (!string.IsNullOrWhiteSpace(accessToken))  \\n        { \\n            Setting\", \"s .AuthAccessToken  = accessToken;  \\n            Settings .AuthIdToken  = authResponse.IdentityToken\", \";  \\n \\n            await NavigationService.NavigateToAsync< MainViewModel >(); \\n            await Nav\", \"igationSer vice.RemoveLastFromBackStackAsync();  \\n        } \\n    } \\n    ... \\n} \\nThis method parses t\", \"he authentication response  that's contained in the return URI , and provided that  \\na valid authori\", \"zation code is present, it makes a request to IdentityServer's token endpoint , passing \\nthe authori\", \"zation code , the PKCE secret verifier,  and other required parameters. The token end point is \\nat /\", \"connect/token  on port 5105 of the base e ndpoint exposed as a user setting. For more \\ninformation a\", \"bout user settings, see Configuration management . \\nTip: Validate return URIs  \\nAlthough the eShopOn\", \"Containers mobile app doesn't validate the return URI, the best practice is  to \\nvalidate  that the \", \"return URI refers to a known location in order to prevent open -redirect attacks.  \\nIf the token end\", \"point receives a valid authorization code  and PKCE secre t verifier , it responds with  an \\naccess \", \"token, identity token, and refresh token.  The access token (which allows access to API \\nresources) \", \"and identity token are then stored as application settings, and page navigation is \\nperformed.  Ther\", \"efore, the overall effect in the eSho pOnContainers mobile app is this:  provided that \\nusers are ab\", \"le to  successfully authenticate with IdentityServer, they are navigated to the MainView  \\npage, whi\", \"ch is a TabbedPage  that displays the CatalogView  as its selected tab.  \\nFor information about page\", \" navigation, see Navigation . For information about how WebView  \\nnavigation causes a view mo del me\", \"thod to be executed, see Invoking navigation using behaviors . For \\ninformation about application se\", \"ttings, see Configuration management .  \\nNote:  The eShopOnContainers also allows a mock sign -in wh\", \"en the app is configured to use mock \\nservices in the SettingsView . In this mode, the app doesn't c\", \"ommunicate with IdentityServer, \\ninstead allowing the user to sign -in using an y credentials.  \\nSig\", \"ning -out \\nWhen the user taps the LOG OUT  button in the ProfileView , the LogoutCommand  in the \\nPr\", \"ofileViewModel class is executed, which in turn executes the LogoutAsync  method. This method \\nperfo\", \"rms page navigation to the LoginView  page, pas sing a LogoutParameter  instance set to true  \\nas a \", \"parameter. For more information about passing parameters du ring page navigation, see Passing \\nparam\", \"eters during navigation . 68 CHAPTER  9  |  Authentication and authorization  \\n When a view is creat\", \"ed and navigated  to, the InitializeAsync method of the view's associated \\nview model is executed , \", \"which then  executes the Logout  method of the LoginViewModel  class, which \\nis shown in the followi\", \"ng code example:  \\nprivate void Logout()  \\n{ \\n    var authIdToken  = Settings .AuthIdToken;  \\n    va\", \"r logoutRequest  = _identityService.CreateLogoutRequest(authIdToken);  \\n \\n    if (!string.IsNullOrEm\", \"pty(logoutRequest))  \\n    { \\n        // Logout \\n        LoginUrl  = logoutRequest;  \\n    } \\n    ... \", \"\\n}  \\nThis method invokes the CreateLogoutRequest  method in the IdentityService  class, passing the \", \"\\nidentity token  retrieved from application settings as a parameter. For more information about \\napp\", \"lication settings, see Configuration management . The following code example shows t he \\nCreateLogou\", \"tRequest  method:  \\npublic string CreateLogoutRequest( string token) \\n{ \\n    ... \\n    return string.\", \"Format( \\\"{0}?id_token_hint= {1}&post_logout_redirect_uri= {2}\\\",  \\n        GlobalSetting .Instance.Lo\", \"goutEndpoint,  \\n        token, \\n        GlobalSetting .Instance.LogoutCallback);  \\n}  \\nThis method c\", \"reates the URI to IdentityServer's end session endpoint , with the required parameters. \\nThe end ses\", \"sion  endpoint is at /connect/endsession  on port 5105 of the base endpoint exposed as \\na user setti\", \"ng. For more information about user settings, see Configuration management . \\nThe returned URI is st\", \"ored in the LoginUrl  property of the LoginViewModel  class. While the IsLogin  \\nproperty is true , \", \"the WebView  in the LoginView  is visible. The WebView  data binds its Source  property \\nto the Logi\", \"nUrl property of the LoginViewModel  class, and so makes a sign -out request to \\nIdentityServer when\", \" the LoginUrl  property is set to IdentityServer's end session endpoint. When \\nIdentityServer receiv\", \"es this request, provided that the user is signed -in, sign -out occurs. \\nAuthentication is tracked \", \"with a cookie managed by the cookie authentication middleware from \\nASP.NET Core. Therefore, signing\", \" out of IdentityServer removes the authentication cookie and sends a \\npost logout redirect URI back \", \"to the client.  \\nIn the mobile app, the WebView  will be redirected to the post logout redirect URI.\", \" This WebView  \\nnavigation will cause the NavigateAsync method in the LoginViewModel  class to be ex\", \"ecuted, which \\nis shown in the following code example:  \\nprivate async Task NavigateAsync( string ur\", \"l) \\n{ \\n    ... \\n    Settings .AuthAccessToken  = string.Empty; \\n    Settings .AuthIdToken = string.E\", \"mpty; \\n    IsLogin = false; \\n    LoginUrl  = _identityService.CreateAuthorizationRequest();  \\n    ..\", \". \\n} 69 CHAPTER  9  |  Authentication and authorization  \\n This method clears both the identity toke\", \"n and the access token from application settings, and sets \\nthe IsLogin  property to false , which c\", \"au ses the WebView  on the LoginView  page to become \\ninvisible. Finally, the LoginUrl  property is \", \"set to the URI of IdentityServer's authorization endpoint , \\nwith the requ ired parameters, in prepa\", \"ration for the next time the user initiates a sign -in. \\nFor information about page navigation, see \", \"Navigation . For information about how WebView  \\nnavigation causes a view model method to be execute\", \"d, see  Invoking navigation using behaviors . For \\ninformation about applicati on settings, see Conf\", \"iguration management . \\nNote:  The eShopOnContain ers also allows a mock sign -out when the app is c\", \"onfigured to use \\nmock services in the SettingsView . In this mode, the app doesn't communicate with\", \" \\nIdentityServer, and instead clears any stored tokens from application settings.  \\nAuthorization  \\n\", \"After authentication, ASP.NET Core web APIs o ften need to authorize access, which allows a service \", \"to \\nmake APIs available to some authenticated users, but not to all.  \\nRestricting access to an ASP.\", \"NET Core MVC route can be achieved by applying an Authorize  attribute \\nto a controller or action, w\", \"hich li mits access to the controller or action to authenticated users, as \\nshown in the following c\", \"ode example:  \\n[Authorize]  \\npublic class BasketController  : Controller  \\n{ \\n    ... \\n}  \\nIf an una\", \"uthorized user attempts to access a controller or action that's marked with  the Authorize  \\nattribu\", \"te, the MVC framework returns a 401 (unauthorized) HTTP status code.  \\nNote:  Parameters can be spec\", \"ified on the Authorize  attribute to restrict an API to specific users. \\nFor more information, see A\", \"uthorization  on the Microsoft Documentation Center.  70 CHAPTER  9  |  Authentication and authoriza\", \"tion  \\n IdentityServer can be integrated into the authorization workflow so that the access tokens i\", \"t provides \\ncontrol authorization. This approach is shown in Figure 9 -5. \\nFigure 9 -5: Authorizatio\", \"n by access token  \\nThe eShopOnContainers mobile app communicates with the identity microservice and\", \" requests an \\naccess token as part of the authentication process. The access token is then forwarded\", \" to the APIs \\nexposed by the ordering and basket microservices as part of the access requests. Acces\", \"s tokens \\ncontain information about the client, and the user. APIs then use that information to auth\", \"orize access \\nto their data. For information about how to configure IdentityServer to protect APIs, \", \"see Configuring \\nAPI resources . \\nConfiguring IdentityServer to perform authorization  \\nTo perform a\", \"uthorization with IdentityServer, its authorization middleware must be added to the web \\napplication\", \"'s HTTP request pipeline. The middleware is added in  the Configure Auth  method in the \\nweb applica\", \"tion's Startup  class, which is invoked from the Configure  method, and is demonstrated \\nin the foll\", \"owing code example from the eShopOnContainers reference application:  \\nprotected  virtual void Confi\", \"gureAuth(IApplicat ionBuilder  app) \\n{ \\n    var identityUrl  = Configuration.GetValue< string>(\\\"Iden\", \"tityUrl\\\" ); \\n    app.UseIdentityServerAuthentication( new IdentityServerAuthenticationOptions  \\n    \", \"{ \\n        Authority  = identityUrl.ToString(),  \\n        ScopeName  = \\\"basket\\\" , \\n        RequireHt\", \"tpsMetadata  = false \\n    }); \\n}   \\nThis method ensures that the API can only be accessed with a val\", \"id access token. The middleware \\nvalidates the incoming token to ensure that it's sent from a truste\", \"d issuer, and validates that the token \\nis valid to be  used with the API that receives it. Therefor\", \"e, browsing to the ordering or basket \\ncontroller will return a 401 (unauthorized) HTTP status code,\", \" indicating that an access token is \\nrequired.  \\n71 CHAPTER  9  |  Authentication and authorization \", \" \\n Note:  IdentityServer's authorization middleware must be added to t he web application's HTTP \\nre\", \"quest pipeline before adding MVC with app.UseMvc()  or app.UseMvcWithDefaultRoute() . \\nMaking access\", \" requests to APIs  \\nWhen making requests to the ordering and basket microservices, the access token,\", \" obtained from \\nIdentityServer dur ing the authentication process, must be included in the request, \", \"as shown in the \\nfollowing code example:  \\nvar authToken  = Settings .AuthAccessToken;  \\nOrder = awa\", \"it _ordersService.GetOrderAsync( Convert.ToInt32(order.OrderNumber),  authToken);   \\nThe access toke\", \"n is stored as an application setting, and is retrieved from platform -specific storage \\nand include\", \"d in the call to the GetOrderAsync  method in the OrderService  class.  \\nSimilarly, the access token\", \" must be included when se nding data to an Iden tityServer  protected API, as \\nshown in the followin\", \"g code example:  \\nvar authToken  = Settings .AuthAccessToken;  \\nawait _basketService.UpdateBasketAsy\", \"nc( new CustomerBasket  \\n{ \\n    BuyerId = userInfo.UserId,   \\n    Items = BasketItems.ToList()  \\n}, \", \"authToken);  \\nThe acc ess token is retrieved from platform -specific storage and included in the cal\", \"l to the \\nUpdateBasketAsync method in the BasketService  class.  \\nThe RequestProvider  class, in the\", \" eShopOnContainers mobile app, uses the HttpClient  class to \\nmake requests to the RES Tful APIs exp\", \"osed by the eShopOnContainers reference application. When \\nmaking requests to the ordering and baske\", \"t APIs, which require authorization, a valid access token \\nmust be included with the request. This i\", \"s achieved by adding the access token to the headers of the \\nHttpClient  instance, as demonstrated i\", \"n the following code example:  \\nhttpClient.DefaultRequestHeaders.Authorization  = new Authentication\", \"HeaderValue (\\\"Bearer\\\" , token);  \\nThe DefaultRequestHeaders  property of the HttpClient  class expos\", \"es the head ers that are sent \\nwith each request, and the access token is added to the Authorization\", \"  header prefixed with the \\nstring Bearer . When the request is sent to a RESTful API, the value of \", \"the Authorization  header is \\nextracted and validated to ensure that it's sent from a trusted issuer\", \", and used to determine whether \\nthe user has permission to invoke the API that receives it.  \\nFor m\", \"ore information about how the eShopOnContainers mobile app makes web requests,  see \\nAccessing remot\", \"e data . \\nSummary  \\nThere are many approaches to integrating authentication and authorization into a\", \" Xamarin.Forms app \\nthat communicates with an ASP.NET MVC web application. The eShopOnContainers mob\", \"ile app \\nperforms authentication and authorization with a containerized identity microservice that u\", \"ses \\nIdentityServer 4. IdentityServer is an open source OpenID Connect and OAuth 2.0 framework for \\n\", \"ASP.NET Core that integrates with ASP.NET Core Identity to perform bearer token authentication.  72 \", \"CHAPTER  9  |  Authentication and authorization  \\n The mobile app requests security tokens from Iden\", \"tityServer, either for authenticating a user or for \\naccessing a resource. When accessing a resource\", \", an access token must be included in the request to \\nAPIs that require authorization. IdentityServe\", \"r's middleware validates incoming access t okens to \\nensure that they are sent from a trusted issuer\", \", and that they are valid to be used with the API that \\nreceives them. \\n \\n \\n73 CHAPTER  10  |  Acces\", \"sing remote data  \\n  \\n \\nC H A P T E R  \\n \\n 10 \\n Accessing remote \\ndata  \\nMany modern web -based solu\", \"tions make use of web services, hosted by web servers, to provide \\nfunctionality fo r remote client \", \"applications. The operations that a web service exposes constitute a \\nweb API.  \\nClient apps should \", \"be able to utilize the web API without knowing how the data or operations that the \\nAPI exposes are \", \"implemented. This requires that the API abid es by common standards that enable a \\nclient app and we\", \"b service to agree on which data formats to use, and the structure of the data that is \\nexchanged be\", \"tween client apps and the web service.  \\nIntroduction to Representational State Transfer  \\nRepresent\", \"ational  State Transfer (REST) is an architectural style for building distributed systems based \\non \", \"hypermedia. A primary advantage of the REST model is that it's based on open standards and \\ndoesn't \", \"bind the implementation of the model or the client apps that acces s it to any specific \\nimplementat\", \"ion. Therefore, a REST web service could be implemented  using Microsoft ASP.NET Core \\nMVC , and cli\", \"ent apps could be developing using any language and toolset that can generate HTTP \\nrequests and par\", \"se HTTP responses.  \\nThe REST model uses a navigational scheme to represent objects and services ove\", \"r a network, referred \\nto as resources. Systems that implement REST typically use the HTTP protocol \", \"to transmit requests to \\naccess these resources. In such systems, a client app submits a  request in\", \" the form of a URI that \\nidentifies a resource, and a n HTTP method (such as GET, POST, PUT, or DELE\", \"TE) that indicates the \\noperation to be performed on that resource. The body of the HTTP request con\", \"tains any data required \\nto perform the operation .  \\nNote:  REST defines a stateless request model.\", \" Therefore, HTTP requests must be independent and \\nmight  occur in any order.  \\nThe response from a \", \"REST request makes use of standard HTTP status codes. For example, a request \\nthat returns valid dat\", \"a should include the HTTP response code 200 (OK), while a request that fails to \\nfind or delete a sp\", \"ecified resource should return a response that includes the HTTP status code 404 \\n(Not Found).  \\nA R\", \"ESTful web API exposes a set of connected resources, and provides the  core operations that \\nenable \", \"an app to manipulate those resources and easily navigate between them. For this reason, the \\nURIs th\", \"at constitute a typical RESTful web API are oriented towards the data that it exposes, and use \\nthe \", \"facilities provided by HTTP t o operate on this data.  74 CHAPTER  10  |  Acce ssing remote data  \\n \", \"The data included by a client app in a n HTTP request, and the corresponding response messages from \", \"\\nthe web server, could be presented in a variety of formats, known as media types. When a client app\", \" \\nsends a request that returns data  in the body of a message, it can specify the media types it can\", \" \\nhandle in the Accept  header of the request. If the web server supports this media type, it can re\", \"ply \\nwith a response that includes the Content-Type  header that specifies the format of the dat a i\", \"n the \\nbody of the message. It's then the responsibility of the client app to parse the response mes\", \"sage and \\ninterpret the results in the message body appropriately.  \\nFor more information about REST\", \", see API design  and API implementation  on Microsoft Docs.  \\nConsuming RESTful APIs  \\nThe eShopOnC\", \"ontainers mobile app uses the Model -View -ViewModel (MVVM) pattern, and the \\nmodel elements of the \", \"pattern represent the domain entities used in the app. The controller and \\nrepository classes in the\", \" eShopOnContainers reference application accept and return many of these \\nmodel ob jects. Therefore,\", \" they are used as data transfer objects (DTOs) that hold all the data that is \\npassed between the mo\", \"bile app and the containerized microservices. The main benefit of using DTOs \\nto pass data to and re\", \"ceive data from a web service is that by transmitting more data in a single \\nremote call, the app ca\", \"n reduce the number of remote calls that need to be made.  \\nMaking web requests  \\nThe eShopOnContain\", \"ers mobile app uses the HttpClient  class to make requests over HTTP, with \\nJSON being used as the m\", \"edia  type. This class provides functionality for asynchronously sending HTTP \\nrequests and receivin\", \"g HTTP responses from a URI identified resource. The HttpResponseMessage  \\nclass represents a n HTTP\", \" response message received from a REST API after a n HTTP request has been \\nmade. It contains inform\", \"ation about the response, including the status code, headers, and any body. \\nThe HttpContent  class \", \"represents the HTTP body and content headers, such as Content-Type  and \\nContent-Encoding . The cont\", \"ent can be read using any of  the ReadAs  methods, such as \\nReadAsStringAsync  and ReadAsByteArrayAs\", \"ync , depending on the format of the data.  \\nMaking a GET request  \\nThe CatalogService  class is use\", \"d to manage the data retrieval process from the catalog \\nmicroservice. In the RegisterDependenc ies \", \"method in the ViewModelLocator  class, the \\nCatalogService  class is registered as a type mapping ag\", \"ainst the ICatalogService  type with the \\nAutofac dependency injection container. Then, when an inst\", \"ance of the CatalogViewModel  class is \\ncreated, its constr uctor accepts an ICatalogService  type, \", \"which Autofac resolves, returning an \\ninstance of the CatalogService  class. For more information ab\", \"out dependency injection, see \\nIntroduction to dependency injection . \\nFigure 10 -1 shows the intera\", \"ction of classes that read catalog dat a from the catalog microservice  for \\ndisplaying by the Catal\", \"ogView . \\n 75 CHAPTER  10  |  Acce ssing remote data  \\n  \\nFigure 10 -1: Retrieving data from the cat\", \"alog microservice  \\nWhen the CatalogView  is navigated to, the OnInitialize  method in the CatalogVi\", \"ewModel  class is \\ncalled. This method retrieves catalog data from the catalog microservice, as demo\", \"nstrated in the \\nfollowing code example:  \\npublic override  async Task InitializeAsync( object navig\", \"ationData)  \\n{ \\n    ... \\n    Products  = await _productsService.GetCatalogAsync();  \\n    ... \\n}  \\nTh\", \"is method calls the GetCatalogAsync  method of the CatalogService  instance that was injected \\ninto \", \"the CatalogViewModel  by Autofac. The following code example shows the GetCatalogAsync  \\nmethod:  \\np\", \"ublic async Task<ObservableCollection <CatalogItem >> GetCatalogAsync()  \\n{ \\n    UriBuilder  builder\", \" = new UriBuilder (GlobalSetting .Instance.CatalogEndpoint);  \\n    builder.Path  = \\\"api/v1/catalog/i\", \"tems\\\" ; \\n    string uri = builder.ToString();  \\n \\n    CatalogRoot  catalog = await _requestProvider.\", \"GetAsync< CatalogRoot >(uri); \\n    ... \\n76 CHAPTER  10  |  Acce ssing remote data  \\n     return cata\", \"log?.Data.ToObservableCollection();            \\n}  \\nThis method builds the URI that identifies the r\", \"esource the request will be sent to, and uses the \\nRequestProvider  class to invoke the GET HTTP met\", \"hod on the resource, before returning the results \\nto the CatalogViewModel . The RequestProvider  cl\", \"ass contains functionality that submits a request \\nin the form of a URI that identifies a resource, \", \"a n HTTP method that indicat es the operation to be \\nperformed on that resource, and a body that con\", \"tains any data required to perform the operation. For \\ninformation about how the RequestProvider  cl\", \"ass is injected into the CatalogService  class, see \\nIntroduction to dependency injection . \\nThe fol\", \"lowing code example shows the GetAsync  method in the RequestProvider  class:  \\npublic async Task<TR\", \"esult> GetAsync< TResult>(string uri, string token = \\\"\\\") \\n{ \\n    HttpClient  httpClient  = CreateHtt\", \"pClient( token); \\n    HttpResponseMessage  response  = await httpClient.GetAsync(uri);  \\n \\n    await\", \" HandleResponse(response);  \\n    string serialized  = await response.Content.ReadAsStringAsync();  \\n\", \" \\n    TResult result = await Task.Run(() =>  \\n        JsonConvert .DeserializeObject< TResult>(seria\", \"lized,  _serializerSettings));  \\n \\n    return result; \\n} \\nThis method calls the CreateHttpClient  me\", \"thod, which returns an instance of the HttpClient  class \\nwith the appropriate headers set. It then \", \"submits an asynchronous GET requ est to the resource \\nidentified by the URI, with the response being\", \" stored in the HttpResponseMessage  instance. The \\nHandleResponse  method is then invoked, which thr\", \"ows an exception if the response doesn't include \\na success HTTP status code. Then the respons e is \", \"read as a string, converted from JSON to a \\nCatalogRoot  object, and returned to the CatalogService \", \". \\nThe CreateHttpC lient  method is shown in the following code example:  \\nprivate HttpClient  Creat\", \"eHttpClient( string token = \\\"\\\") \\n{ \\n    var httpClient  = new HttpClient (); \\n    httpClient.Default\", \"RequestHeaders.Accept.Add(  \\n        new MediaTypeWithQualityHeaderValue (\\\"application/json\\\" )); \\n \\n\", \"    if (!string.IsNullOrEmpty(token))  \\n    { \\n        httpClient.DefaultRequestHeaders.Authorizatio\", \"n  =  \\n            new Authentica tionHeaderValue (\\\"Bearer\\\" , token); \\n    } \\n    return httpClient;\", \"  \\n} \\nThis method creates a new instance of the HttpClient  class, and sets the Accept  header of an\", \"y \\nrequests made by the HttpClient  instance to application/json , which indicates that it expects t\", \"he  \\ncontent of any response to be formatted using JSON. Then, if an access token was passed as an \\n\", \"argument to the CreateHttpClient  method, it's added to the Authorization  header of any \\nrequests m\", \"ade by the HttpClient  instance, prefixed with the string Bearer . For more information \\nabout autho\", \"rization, see Authorization . 77 CHAPTER  10  |  Acce ssing remote data  \\n When the GetAsync  method\", \" in the RequestProvider  class calls HttpClient.GetAsync , the Items  \\nmethod in the CatalogControll\", \"er  class in the Catalog.API  project is invoked, which is shown in the \\nfollowing code example:  \\n[\", \"HttpGet]  \\n[Route(\\\"[action]\\\" )] \\npublic async Task<IActionResult>  Items( \\n    [FromQuery] int pageS\", \"ize  = 10, [FromQuery] int pageIndex  = 0) \\n{ \\n    var totalItems  = await _catalogContext.Catalog I\", \"tems \\n        .LongCountAsync();  \\n \\n    var itemsOnPage  = await _catalogContext.CatalogItems  \\n   \", \"     .OrderBy(c=>c.Name)  \\n        .Skip(pageSize  * pageIndex)  \\n        .Take(pageSize)  \\n        \", \".ToListAsync();  \\n \\n    itemsOnPage  = ComposePicUri(itemsOnPage);  \\n    var model = new PaginatedIt\", \"emsViewModel<CatalogItem>(  \\n        pageIndex,  pageSize,  totalItems,  itemsOnPage);             \\n\", \" \\n    return Ok(model);  \\n} \\nThis method retrieves the catalog data from the SQL database using Enti\", \"tyFramework, and returns it \\nas a response mes sage that includes a success HTTP status code, and a \", \"collection of JSON formatted \\nCatalogItem  instances.  \\nMaking a POST request  \\nThe BasketService  c\", \"lass is used to manage the data retrieval and update process with the basket \\nmicroservice. In the R\", \"egisterDepe ndencies  method in the ViewModelLocator  class, the \\nBasketService  class is registered\", \" as a type mapping against the IBasketService  type with the \\nAutofac dependency injection container\", \". Then, when an instance of the BasketViewModel  class is \\ncreated, its cons tructor accepts an IBas\", \"ketService  type, which Autofac resolves, returning an \\ninstance of the BasketService  class. For mo\", \"re information about dependency injection, see \\nIntroduction to dependency injection . \\nFigure 10 -2\", \" shows the interaction of classes that send the basket data displayed by the BasketView , \\nto the ba\", \"sket microservice.  78 CHAPTER  10  |  Acce ssing remote data  \\n  \\nFigure 10 -2: Sending data to the\", \" basket microservice  \\nWhen an item is added to the shopping basket, the ReCalculateTotalAsync  meth\", \"od in the \\nBasketViewModel  class is called. This method updates the total value of items in the bas\", \"ket, and \\nsends the basket data to the basket microservice, as demonstrated in the following code ex\", \"ample:  \\nprivate async Task ReCalculateTotalAsync()  \\n{ \\n    ... \\n    await _basketService.UpdateBas\", \"ketAsync( new CustomerBasket  \\n    { \\n        BuyerId = userInfo.UserId,   \\n        Items = BasketIt\", \"ems.ToList()  \\n    }, authToken);  \\n} \\nThis method calls the UpdateBasketAsync  method of the Basket\", \"Service  instance that was inje cted \\ninto the BasketViewModel  by Autofac. The following method sho\", \"ws the UpdateBasketAsync  \\nmethod:  \\npublic async Task<CustomerBasket > UpdateBasketAsync( CustomerB\", \"asket  customerBasket,  string token) \\n{ \\n    UriBuilder  builder = new UriBuilder (GlobalSetting .I\", \"nstance.BasketEndpoint);  \\n    string uri = builder.ToString();  \\n79 CHAPTER  10  |  Acce ssing remo\", \"te data  \\n     var result = await _requestProvider.PostAsync(uri,  customerBasket,  token); \\n    ret\", \"urn result; \\n} \\nThis method builds the URI that identifies the resource the request will be sent to,\", \" and use s the \\nRequestProvider  class to invoke the POST HTTP method on the resource, before return\", \"ing the \\nresults to the BasketViewModel . Note that an access token, obtained from IdentityServer du\", \"ring the \\nauthentication process, is required to authorize requests to  the basket microservice. For\", \" more \\ninformation about authorization, see Authorization . \\nThe following code example shows one of\", \" the PostAsync  method s in the RequestProvider  class:  \\npublic async Task<TResult> PostAsync< TRes\", \"ult>( \\n    string uri, TResult data, string token = \\\"\\\", string header = \\\"\\\") \\n{ \\n    HttpClient  http\", \"Client  = CreateHttpClient(token);  \\n    ... \\n    var content = new StringContent (JsonConvert .Seri\", \"alizeObject(data));  \\n    content.Headers.ContentType  = new MediaTypeHeaderValue (\\\"application/json\", \"\\\" ); \\n    HttpResponseMessage  response  = await httpClient.PostAsync(uri,  content);  \\n \\n    await \", \"HandleResponse(response);  \\n    string serialized  = await response.Content.ReadAsStringAsync();  \\n \", \"\\n    TResult result = await Task.Run(() => \\n        JsonConvert .DeserializeObject< TResult>(seriali\", \"zed,  _serializerSettings));  \\n \\n    return result; \\n} \\nThis method calls the CreateHttpClient  meth\", \"od, which returns an instance of the HttpClient  class \\nwith the appropriate headers set. It then su\", \" bmits an asynchronous POST request to the resource \\nidentified by the URI, with the serialized bask\", \"et data being sent in JSON format, and the response \\nbeing stored in the HttpResponseMessage  instan\", \"ce. The HandleResponse  method is then invoked, \\nwhich throws an exception if the response doesn't i\", \"nclude a success HTTP status code. Then, the \\nresponse is read as a string, converted from JSON to a\", \" CustomerBasket  object, and returned to the \\nBasketService . For more information about the CreateH\", \"ttpClient method, see Making a GET request . \\nWhen the PostAsync method in the RequestProvider  clas\", \"s calls HttpClient.PostAsync , the Post  \\nmethod in the BasketController  class in the Basket.API  p\", \"roject is invoked, which is shown in the \\nfollowing co de example:  \\n[HttpPost]  \\npublic async Task<\", \"IActionResult>  Post([FromBody]CustomerBasket  value) \\n{ \\n    var basket = await _repository.U pdate\", \"BasketAsync( value); \\n    return Ok(basket);  \\n}  \\nThis method uses an instance of the RedisBasketRe\", \"pository  class to persist the basket data to the \\nRedis cache, and returns it as a response message\", \" that includes a success HTTP status code, and a \\nJSON formatted CustomerBasket  instance.  \\nMaking \", \"a DELETE request  \\nFigure 10 -3 shows the interactions of classes that de lete basket data from the \", \"basket microservice, for \\nthe CheckoutView . 80 CHAPTER  10  |  Acce ssing remote data  \\n  \\nFigure 1\", \"0 -3: Deleting data from the basket microservice  \\nWhen the checkout process is invoked, the Checkou\", \"tAsync  method in the CheckoutViewModel  class \\nis called. This method creates a ne w order, before \", \"clearing the shopping basket, as demonstrated in \\nthe following code example:  \\nprivate async Task C\", \"heckoutAsync()  \\n{ \\n    ... \\n    await _basketService.ClearBasketAsync(_shippingAddress.Id.ToString(\", \"),  authToken);  \\n    ... \\n} \\nThis method calls the ClearBasketAsync  method of the BasketService  i\", \"nstance that was injected \\ninto the CheckoutViewModel  by Autofac. The following method shows the Cl\", \"earBasketAsync  \\nmethod:  \\npublic async Task ClearBasketAsync( string guidUser,  string token) \\n{ \\n \", \"   UriBuilder  builder = new UriBuilder (GlobalSetting .Instance.BasketEndpoint);  \\n    builder.Path\", \"  = guidUser;  \\n    string uri = builder.ToString();  \\n    await _requestProvider.DeleteAsync(uri,  \", \"token); \\n} \\nThis method builds the URI that identifies the resource that the reque st will be sent t\", \"o, and uses the \\nRequestProvider  class to invoke the DELETE HTTP method on the resource. Note that \", \"an access \\ntoken, obtained from IdentityServer during the authentication process, is required to aut\", \"horize  \\nrequest s to the basket microservice. For more inform ation about authorization, see Author\", \"ization . \\nThe following code example shows the DeleteAsync  method in the RequestProvider  class:  \", \"\\n \\n81 CHAPTER  10  |  Acce ssing remote data  \\n public async Task DeleteAsync( string uri, string to\", \"ken = \\\"\\\") \\n{ \\n    HttpClient  httpClient  = CreateHttpClient(token);  \\n    await httpClient.DeleteAs\", \"ync(uri);  \\n} \\nThis method calls the CreateHttpClient  method, which returns an instance of the Http\", \"Client  class \\nwith the appropriate headers set. It then sub mits an asynchronous DELETE request to \", \"the resource \\nidentified by the URI. For more information about the CreateHttpClient  method, see Ma\", \"king a GET \\nrequest . \\nWhen the DeleteAsync  method in the RequestProvider  class calls HttpClient.D\", \"eleteAsync , the \\nDelete  method in the BasketController  class in the Basket.API  project is invoke\", \"d, which is shown \\nin the following code example:  \\n[HttpDelete( \\\"{id}\\\")] \\npublic void Delete(string\", \" id) \\n{ \\n    _repository.DeleteBasketAsync(id);  \\n} \\nThis method uses an instance of the RedisBasket\", \"Repository  class to delete the basket data from \\nthe Redis cache.  \\nCaching data  \\nThe performance \", \"of an app can be improved by caching frequently accessed data to fast storage \\nthat's located close \", \"to the app. If t he fast storage is located closer to the app than the original source, \\nthen cachin\", \"g can significantly improve response times when retrieving data.  \\nThe most common form of caching i\", \"s read -through caching, where an app retrieves data by \\nreferencing the cache . If the data isn't i\", \"n the cache, it's retrieved from the data store and added to the \\ncache. Apps can implement read -th\", \"rough caching with the cache -aside pattern. This pattern \\ndetermines whether the item is currently \", \"in the cache. If the item isn't in the cache, it's read from the \\ndata store and added to the cache.\", \" For more information, see the Cache -Aside  pattern on Microsoft \\nDocs.  \\nTip: Cache data that's re\", \"ad frequentl y and that changes infrequently  \\nThis data can be added to the cache on demand the fir\", \"st time it is retrieved by an app. This means \\nthat the app needs to fetch the data only once from t\", \"he data store, and that subsequent access can \\nbe satisfied by using the cache.  \\nDistributed applic\", \"ations, such as the eShopOnContainers reference application, should provide either \\nor both of the f\", \"ollowing caches:  \\n\\u2022 A shared cache, which can be accessed by multiple processes or machines.  \\n\\u2022 A \", \"private cache, where data is held locall y on the device running the app.  \\nThe eShopOnContainers mo\", \"bile app uses a private cache, where data is held locally on the device \\nthat's running an instance \", \"of the app. For information about the cache used by the \\neShopOnContainers reference application,  s\", \"ee .NET Microservices: Architecture for Containerized .NET \\nApplications . 82 CHAPTER  10  |  Acce s\", \"sing remote data  \\n Tip: Think of the cache as a transient data store that could disappear at any ti\", \"me  \\nEnsure that data is maintained in the original data store as well as the cache. The chances of \", \"losing \\ndata are then minimized if the cache becomes unavailable.  \\nManaging data expiration  \\nIt's \", \"impractical to expect that cached data will always be consistent with the original data. Data in the\", \" \\noriginal data sto re might change after it's been cached, causing the cached data to become stale.\", \" \\nTherefore, apps should implement a strategy that helps to ensure that the data in the cache is as \", \"up -\\nto-date as possible, but can also detect and handle situations that arise when the data in the \", \"cache \\nhas become stale. Most caching mechanisms enable the cache to be configured to expire data, a\", \"nd \\nhence reduce the period for which data might  be out of date.  \\nTip: Set a default expiration ti\", \"me when configuring a cache  \\nMany caches implement expiration, which invalidates data and removes i\", \"t from the cache if it's not \\naccessed for a specified period. However, care must be taken when choo\", \"sing the expiration period. \\nIf it's made too short, data will expire too quickly and the benefits o\", \" f caching will be reduced. If it's \\nmade too long, the data risks becoming stale. Therefore, the ex\", \"piration time should match the \\npattern of access for apps that use the data.  \\nWhen cached data exp\", \"ires, it should be removed from the cache, and the app must r etrieve the data \\nfrom the original da\", \"ta store and place it back into the cache.  \\nIt's also possible that a cache might fill up if data i\", \"s allowed to remain for too long a period. Therefore, \\nrequests to add new items to the cache might \", \" be required to remove some items in a process known \\nas eviction . Caching services typically evict\", \" data on a least -recently -used basis. However, there are \\nother eviction policies, including most \", \"-recently -used, and first -in-first-out. For more information, see \\nCaching Guidance  on Microsoft \", \"Docs.  \\nCaching images  \\nThe eShopOnContainers mobile app consumes remote product images that benefi\", \"t from being \\ncached. These images a re displayed by the Image  control, and the CachedImage  contro\", \"l provided by \\nthe FFImageLoading  library.  \\nThe Xamarin.Forms Image  control supports caching of d\", \"ownloaded images. Caching is enabled by \\ndefault, and will store the image locally for 24 hours. In \", \"addition, the expiration time can be \\nconfigured with the CacheValidity  property. For more informat\", \"ion, see Downloaded Image Caching  \\non the Xamarin Developer Center.  \\nFFImageLoading's CachedImage \", \" control is a replacement for the Xamarin.Forms Image  control, \\nprovidi ng additional properties th\", \"at enable supplementary functionality. Amongst this functionality, \\nthe control provides configurabl\", \"e caching, while supporting error and loading image placeholders. \\nThe following code example shows \", \"how the eShopOnContainers mobil e app uses the CachedImage  \\ncontrol in the ProductTemplate , which \", \"is the data template used by the ListView  control in the \\nCatalogView : \\n<ffimageloading:CachedImag\", \"e   \\n    Grid.Row=\\\"0\\\" \\n    Source=\\\"{Binding  PictureUri}\\\"       \\n    Aspect=\\\"AspectFill\\\" > \\n    <ffi\", \"mageloading:CachedImage.LoadingPlaceholder > \\n        <OnPlatform     \\n            x:TypeArguments= \", \"\\\"ImageSource\\\"  83 CHAPTER  10  |  Acce ssing remote data  \\n             iOS=\\\"default_product\\\"  \\n    \", \"        Android= \\\"default_product\\\"  \\n            WinPhone= \\\"Assets/default_product.png\\\" /> \\n    </ff\", \"imageloading:CachedImage.LoadingPlaceholder > \\n    <ffimageloading:CachedImage.ErrorPlaceholder > \\n \", \"       <OnPlatform     \\n            x:TypeArguments= \\\"ImageSource\\\"  \\n            iOS=\\\"noimage\\\"  \\n   \", \"         Android= \\\"noimage\\\"  \\n            WinPhone= \\\"Assets/noimage.p ng\\\"/> \\n    </ffimageloading:Ca\", \"chedImage.ErrorPlaceholder > \\n</ffimageloading:CachedImage >  \\nThe CachedImage  control sets the Loa\", \"dingPlaceholder  and ErrorPlaceholder  properties to \\nplatform -specific images. The LoadingPlacehol\", \"der  property specifies the image to be displayed \\nwhile the image specified by the Source  property\", \" is retrieved, and the ErrorPlaceholder  property \\nspecifies the image to be displayed if an error o\", \"ccurs when attempting to retrieve the image specified \\nby the Source  property.  \\nAs the name implie\", \"s , the CachedImage  control cac hes remote images on the device  for the time \\nspecified by the val\", \"ue of the CacheDuration  property. When this property value isn't explicitly set, the \\ndefault value\", \" of 30 days is applied.  \\nIncreasing resilience  \\nAll apps that communicate with remote services and\", \" resources must be sensitive to transient faults. \\nTransient faults include the momentary loss of ne\", \"twork connectivity to services, the temporary \\nunavailability of a service, or timeouts that arise w\", \"hen a service is busy.  These faults are often self -\\ncorrecting, and if the action is repeated afte\", \"r a suitable delay it's likely to succeed.  \\nTransient faults can have a huge impact on the perceive\", \"d quality of an app, even if it has been \\nthoroughly tested under all foreseeable ci rcumstances. To\", \" ensure that an app that communicates with \\nremote services operates reliably, it must be able to  d\", \"o all of the following : \\n\\u2022 Detect faults when they occur, and determine if the faults are likely to\", \" be transient.  \\n\\u2022 Retry the operation if it determ ines that the fault is likely to be transient an\", \"d keep track of the \\nnumber of times the operation was retried.  \\n\\u2022 Use an appropriate retry strateg\", \"y, which specifies the number of retries, the delay between \\neach attempt, and the actions to take a\", \"fter a failed attempt.  \\nThis transient fault handling can be achieved by wrapping all attempts to a\", \"ccess a remote service in \\ncode that implements the retry pattern.  \\nRetry pattern  \\nIf an app detec\", \"ts a failure when it tries to send a request to a remote servi ce, it can han dle the failure \\nin an\", \"y of the following ways : \\n\\u2022 Retrying the operation. The app could retry the failing request immedia\", \"tely.  \\n\\u2022 Retrying the operation after a delay. The app should wait for a suitable amount of time be\", \"fore \\nretrying the request.  \\n\\u2022 Cancelling the o peration. The application should cancel the operati\", \"on and report an \\nexception.  84 CHAPTER  10  |  Acce ssing remote data  \\n The retry strategy should\", \" be tuned to match the business requirements of the app. For example, it's \\nimportant to optimize th\", \"e retry count and retry interval to the operation bei ng attempted. If the \\noperation is part of a u\", \"ser interaction, the retry interval should be short and only a few retries \\nattempted to avoid makin\", \"g users wait for a response. If the operation is part of a long running \\nworkflow, where cancelling \", \"or restarting  the workflow is expensive or time -consuming, it's appropriate \\nto wait longer betwee\", \"n attempts and to retry more times.  \\nNote:  An aggressive retry strategy with minimal delay between\", \" attempts, and a large number of \\nretries, could degrade a remote service th at's running close to o\", \"r at capacity. In addition, such a \\nretry strategy could also affect the responsiveness of the app i\", \"f it's continually trying to perform a \\nfailing operation.  \\nIf a request still fails after a number\", \" of retries, it's better for the app to prevent further requests going \\nto the same resource and to \", \"report a failure. Then, after a set period, the app can make one or more \\nrequests to the resource t\", \"o see if they're successful. For more information, see Circuit breaker pattern . \\nTip: Never impleme\", \"nt an endless retry mechanism  \\nUse a finite number of retries, or implement the Circuit Breaker  pa\", \"ttern to allow a se rvice to recover.  \\nThe eShopOnContainers mobile app does not currently implemen\", \"t the retry pattern when making \\nRESTful web requests. However, the CachedImage  control, provided b\", \"y the FFImageLoading  library \\nsupports transient fault handling by retrying image loading. If image\", \" loading fails, further attempts \\nwill be made. The number of attempts is specified by the  RetryCou\", \"nt  property, and retries will occur \\nafter a delay specified by the RetryDelay  property. If these \", \"property values aren't explicitly set, their \\ndefault values are applied \\u2013 3 for the RetryCount  pro\", \"perty, and 250ms for the RetryDelay  property. \\nFor mo re information about the CachedImage  control\", \", see Caching images . \\nThe eShopOnContainers reference application does implement the retry pattern\", \". For more \\ninformation, including a discussion of how to combine the retry patt ern with the HttpCl\", \"ient  class, \\nsee .NET Microservices: Architecture for Containerized .NET Applications . \\nFor more i\", \"nformation about the retry pattern, see the Retry  pattern on Microsoft Docs.  \\nCircuit breaker patt\", \"ern  \\nIn some situations, faults can occur due to anticipated events that take longer to fix. These \", \"faults can \\nrange from a partial loss of connectivity to the complete failure of a service. In these\", \" situations, it's \\npointless for an app to retry an operation that's unlikely to succeed, and instea\", \"d should accept that \\nthe operation has failed and handle this failure accordingly.  \\nThe circuit br\", \"eaker pattern can prevent an app from repeatedly trying to execute an operation that's \\nlikely to fa\", \"il, while also enabling the app to detect whether the fault has been resolved.  \\nNote:  The purpose \", \"of the circuit  breaker pattern is different from  the retry pattern. The retry \\npattern enables an \", \"app to retry an operation in the expectation that it'll succeed. The circuit breaker \\npattern preven\", \"ts an app from performing an operation that's likely to fail.  \\nA circuit breaker acts as a proxy fo\", \"r ope rations that might fail. The proxy should monitor the number \\nof recent failures that have occ\", \"urred, and use this information to decide whether to allow the \\noperation to proceed, or to return a\", \"n exception immediately.  \\nThe eShopOnContainers mobile app does n ot currently implement the circui\", \"t breaker pattern. \\nHowever, the eShopOnContainers does. For more information, see .NET Microservice\", \"s: Architecture \\nfor Containerized .NET Applications . 85 CHAPTER  10  |  Acce ssing remote data  \\n \", \"Tip: Combine the retr y and circuit breaker patterns  \\nAn app can combine the retry and circuit brea\", \"ker patterns by using the retry pattern to invoke an \\noperation through a circuit breaker. However, \", \"the retry logic should be sensitive to any exceptions \\nreturned by the circuit bre aker and abandon \", \"retry attempts if the circuit breaker indicates that a \\nfault is not transient.  \\nFor more informati\", \"on about the circuit breaker pattern, see the Circuit Breaker  pattern on Microsoft \\nDocs.  \\nSummary\", \"  \\nMany modern web -based solutions make use of web services, hosted by web servers, to provide \\nfun\", \"ctionality for remote client applications. The operations that a web service exposes constitute a \\nw\", \"eb API, and cl ient apps should be able to utilize the web API without knowing how the data or \\noper\", \"ations that the API exposes are implemented.  \\nThe performance of an app can be improved by caching \", \"frequently accessed data to fast storage \\nthat's located close to the app. Apps can implement read -\", \"through caching with the cache -aside \\npattern. This pattern determines whether the item is currentl\", \"y in the cache. If the item isn't in the \\ncache, it's read from the data store and added to the cach\", \"e.  \\nWhen communicating with web API s, apps must be sensitive to transient faults. Transient faults\", \" \\ninclude the momentary loss of network connectivity to services, the temporary unavailability of a \", \"\\nservice, or timeouts that arise when a service is busy. These faults are often self -correcting , a\", \"nd if the \\naction is repeated after a suitable delay , then  it's likely to succeed. Therefore, apps\", \" should wrap all \\nattempts to access a web API in code that implements a transient fault handling me\", \"chanism.   \\n \\n \\n86 CHAPTER  11  |  Unit testing  \\n  \\n \\nC H A P T E R  \\n \\n 11 \\n Unit testing  \\nMobile\", \" apps have unique problems that desktop and web -based applications don't have to worry \\nabout. Mobi\", \"le users will differ by the devices  that they use , by network connectivity, by the availability  \\n\", \"of services, and a range of other factors. Therefore, mo bile apps should be tested as they  will be\", \" used \\nin the real world  in order to improve their quality, reliability, and performance. There are\", \" many types \\nof testing that should be performed on an app, including unit testing, integration test\", \"ing, and user \\ninterface testing, with unit testing being the most common form of testing.  \\nA unit \", \"test takes a small unit of the app, typically a method, isolates it from the remainder of the code, \", \"\\nand verifies that it behaves as expected. Its goal is to check that each uni t of functionality per\", \"forms as \\nexpected, so that errors don't propagate throughout the app. Detecting a bug where it occu\", \"rs is more \\nefficient that observing the effect of a bug indirectly at a secondary point of failure.\", \"  \\nUnit testing has the greatest effe ct on code quality when it's an integral part of the software \", \"\\ndevelopment workflow. As soon as a method has been written, unit tests should be written that verif\", \"y \\nthe behavior of the method in response to standard, boundary, and incorrect cases of input da ta,\", \" and \\nthat check any explicit or implicit assumptions made by the code. Alternatively, with test dri\", \"ven \\ndevelopment, unit tests are written before the code. In this scenario, unit tests act as both d\", \"esign \\ndocumentation and functional specifications.  \\nNote : Unit tests are very effective against r\", \"egression \\u2013 that is, functionality that used to work but \\nhas been disturbed by a faulty update.  \\nU\", \"nit tests typically use the arrange -act-assert pattern:  \\n\\u2022 The arrange  section of the unit test m\", \"ethod initializes object s and sets the value of the data \\nthat is passed to the method under test. \", \" \\n\\u2022 The act section invokes the method under test with the required arguments.  \\n\\u2022 The assert  secti\", \"on verifies that the action of the method under test behaves as expected.  \\nFollowing this pa ttern \", \"ensures that unit tests are readable and consistent.  \\nDependency injection and unit testing  \\nOne o\", \"f the motivations for adopting a loosely -coupled architecture is that it facilitates unit testing. \", \"\\nOne of the types registered with Autofac is the OrderService  class. The following code example \\nsh\", \"ows an outline of this class:  \\npublic class OrderDetailViewModel  : ViewModelBase  \\n{ \\n    private \", \"IOrderService  _ordersService;  \\n \\n    public OrderDetailViewModel( IOrderService  ordersService)  8\", \"7 CHAPTER  11  |  Unit testing  \\n     { \\n        _ordersService  = ordersService;  \\n    } \\n    ... \\n\", \"}  \\nThe OrderDetail ViewModel  class has a dependency on the IOrderService  type which the container\", \" \\nresolves when it instantiates a OrderDetail ViewModel  object. However, rather than create an \\nOrd\", \"erService  object to unit test the OrderDetail ViewModel  class, instead , replace the \\nOrderService\", \"  object with a mock for the purpose of the tests. Figure 10 -1 illustrates this relationship.  \\n \\n \", \"\\n \\n \\n \\n \\n \\n \\n \\n \\n \\nFigure 10 -1: Classes that implement the IOrderService interface  \\nThis approach \", \"allows the OrderService  object to be passed into the OrderDetailViewModel  class at \\nruntime, and i\", \"n the interests of testability, it allows the OrderMockService  class to be passed into the \\nOrderDe\", \"tailViewModel  class at test time. The main advant age of this approach is that it enables unit \\ntes\", \"ts to be executed without requiring unwieldy resources such as web services, or databases.  \\nTesting\", \" MVVM applications  \\nTesting models and view models from MVVM applications is identical to testing a\", \"ny other cla sses, and \\nthe same tools and techniques \\u2013 such as unit testing and mocking, can be use\", \"d. However, there are \\nsome patterns that are typical to model and view model classes, that can bene\", \"fit from specific unit \\ntesting techniques.  \\nTip: Test one thing with eac h unit test  \\nDon't be te\", \"mpted to make a unit test exercise more than one aspect of the unit's behavior. Doing \\nso leads to t\", \"ests that are difficult to read and update. It can also lead to confusion when \\ninterpreting a failu\", \"re.  \\nThe eShopOnContainers mobile ap p uses xUnit  to perform unit testing, which supports two diff\", \"erent \\ntypes of unit tests:  \\n\\u2022 Facts are tests that are always true, which test invariant condition\", \"s.  \\n\\u2022 Theories are tests that are only true for a particular set of data.  \\n88 CHAPTER  11  |  Unit\", \" testing  \\n The unit tests included with the eShopOnContainers mobile app are fact tests, and so eac\", \"h unit test \\nmethod is decorated with the [Fact]  attribute.  \\nNote:  xUnit tests are executed by a \", \"test runner. To execute the test runner, run the \\neShopOnCont ainers.TestRunner project for the requ\", \"ired platform.  \\nTesting asynchronous functionality  \\nWhen implementing the MVVM pattern, view model\", \"s usually invoke operations on services, often \\nasynchronously. Tests for code that invokes these op\", \"erations typically use mocks as replacements for \\nthe actual services. The following code example de\", \"monstrates testing asynchronous functionality by \\npassing a mock service into a view model:  \\n[Fact]\", \" \\npublic async Task OrderPropertyIsNotNullAfterViewModelInitializationTest()  \\n{ \\n    var orderServi\", \"ce  = new OrderMockService (); \\n    var orderViewModel  = new OrderDetailViewModel (orderService);  \", \"\\n \\n    var order = await orderService.GetOrderAsync( 1, GlobalSetting .Instance.AuthToken);  \\n    aw\", \"ait orderViewModel.InitializeAsync(order);  \\n \\n    Assert.NotNull(orderViewModel.Order);  \\n}  \\nThis \", \"unit test checks that the Order  property of the OrderDetailViewModel  instance will have a value \\na\", \"fter the InitializeAsync  method has been invoked. The InitializeAsync  method is invoked \\nwhen the \", \"view model's correspond ing view is navigated to. For more information  about navigation, \\nsee Navig\", \"ation . \\nWhen the OrderDetailViewModel  instance is created, it expects an OrderService  instance to\", \" be \\nspecified as an argument. However, the OrderService  retrieves data from a web service. Therefo\", \"re, \\nan OrderMockService  instance, which is a mock version of the OrderService  class, is specified\", \" as the \\nargument to the OrderDetailViewModel  constructor. Then, when the view model's \\nInitializeA\", \"sync  method is invo ked, which invokes IOrderService  operations, mock data is \\nretrieved rather th\", \"an  communicating  with a web service.  \\nTesting INotifyPropertyChanged implementations  \\nImplementi\", \"ng the INotifyPropertyChanged  interface allows views to react to changes that origina te \\nfrom view\", \" models and models. These changes are not limited to data shown in controls \\u2013 they are \\nalso used to\", \" control the view, such as view model states that cause animations to be started or \\ncontrols to be \", \"disabled.  \\nProperties that can be updated direc tly by the unit test can be tested by attaching an \", \"event handler to \\nthe PropertyChanged  event and checking whether the event is raised after setting \", \"a new value for the \\nproperty. The following code example shows such a test:  \\n[Fact] \\npublic async \", \"Task SettingOrderPropertyShouldRaisePropertyChanged()  \\n{ \\n    bool invoked = false; \\n    var orderS\", \"ervice  = new OrderMockService (); \\n    var orderViewModel  = new OrderDetailViewModel (orderService\", \");  \\n \\n    orderViewModel.PropertyChanged  += (sender,  e) => \\n    { 89 CHAPTER  11  |  Unit testing\", \"  \\n         if (e.PropertyName.Equals( \\\"Order\\\")) \\n            invoked = true; \\n    }; \\n    var order\", \" = await orderService.GetOrderAsync( 1, GlobalSetting .Instance.AuthToken);  \\n    await orderViewMod\", \"el.InitializeAsync(order);  \\n \\n    Assert.True(invoked);  \\n} \\nThis unit test invokes the InitializeA\", \"sync  method of the OrderViewModel  class, which causes its \\nOrder  property to be updated. The unit\", \" test will pass , provided that the PropertyChanged  event is \\nraised for the Order  property.  \\nTes\", \"ting message -based communica tion \\nView models that use the MessagingCenter  class to communicate b\", \"etween loosely -coupled classes \\ncan be unit tested by subscribing to the message being sent by the \", \"code under test, as demonstrated \\nin the following code example:  \\n[Fact] \\npublic void AddCatalogIte\", \"mCommandSendsAddProductMessageTest()  \\n{ \\n    bool messageReceived  = false; \\n    var catalogService\", \"  = new CatalogMockService (); \\n    var catalogViewModel  = new CatalogViewModel (catalogService);  \", \"\\n \\n    Xamarin.Forms. MessagingCenter .Subscribe< CatalogViewModel , CatalogItem >( \\n        this, M\", \"essageKeys .AddProduct,  (sender,  arg) => \\n    { \\n        messageReceived  = true; \\n    }); \\n    ca\", \"talogViewModel.AddCatalogItemCommand.Execute( null); \\n \\n    Assert.True(messageReceived);  \\n} \\nThis \", \"unit test checks that the CatalogViewMo del publishes the AddProduct  message in response to \\nits Ad\", \"dCatalogItemCommand  being executed. Because the MessagingCenter  class supports multicast \\nmessage \", \"subscriptions, the unit test can subscribe to the AddProduct  message  and execute a callback \\ndeleg\", \"ate in response to receiving it. This callback delegate, specified as a lambda expression, sets a \\nb\", \"oolean  field that's used by the Assert  statement to verify the behavior of the test.  \\nTesting exc\", \"eption handling  \\nUnit tests can a lso be written that check that specific exceptions are thrown for\", \" invalid actions or \\ninputs, as demonstrated in the following code example:  \\n[Fact] \\npublic void In\", \"validEventNameShouldThrowArgumentExceptionText()  \\n{ \\n    var behavior  = new MockEventToCommandBeh \", \"avior \\n    { \\n        EventName  = \\\"OnItemTapped\\\"  \\n    }; \\n    var listView  = new ListView (); \\n \\n\", \"    Assert.Throws< ArgumentException >(() => listView.Behaviors.Add(behavior));  \\n}  90 CHAPTER  11 \", \" |  Unit testing  \\n This unit test will throw an exception, because the ListView  control does not h\", \"ave an  event named \\nOnItemTapped . The Assert.Throws<T>  method is a generic method where T is the \", \"type of the \\nexpected exception. The argument passed to the Assert.Throws<T>  method is a lambda exp\", \"ression \\nthat will throw the exception. Therefore, the unit test will pass provided that the lambda \", \"expression \\nthrows an ArgumentException . \\nTip: Avoid writing unit tests that examine exception mess\", \"age strings  \\nException message strings  might  change over time, and so unit tests that rely on the\", \" ir presence are \\nregarded as brittle.  \\nTesting validation  \\nThere are two aspects to testing the v\", \"alidation implementation: testing that any validation rules are \\ncorrectly implemented, and testing \", \"that  the ValidatableObject<T>  class performs as expected.  \\nValidation logic is usually simple to \", \"test, because it is typically a self -contained process where the \\noutput depends on the input. Ther\", \"e should be test s on the results of invoking the Validate  method \\non each property that has at lea\", \"st one associated validation rule, as demonstrated in the following \\ncode example:  \\n[Fact] \\npublic \", \"void CheckValidationPassesWhenBothPropertiesHaveDataTest()  \\n{ \\n    var mockViewModel  = new MockVie\", \"wModel (); \\n    mockViewMo del.Forename.Value  = \\\"John\\\"; \\n    mockViewModel.Surname.Value  = \\\"Smith\\\"\", \"; \\n \\n    bool isValid = mockViewModel.Validate();  \\n \\n    Assert.True(isValid);  \\n} \\nThis unit test \", \"checks that validation succeeds when the two ValidatableObject<T>  properties in the \\nMockViewModel \", \" instance both have data.  \\nAs well as checking that validation succeeds, validation unit tests shou\", \"ld also check the values of the \\nValue , IsValid , and Errors  property of each ValidatableObject<T>\", \"  instance, to verify that the \\nclass performs as e xpected. The following code example demonstrates\", \" a unit test that does this:  \\n[Fact] \\npublic void CheckValidationFailsWhenOnlyForenameHasDataTest()\", \"  \\n{ \\n    var mockViewModel  = new MockViewModel (); \\n    mockViewModel.Forename.Value  = \\\"John\\\"; \\n \", \"\\n    bool isValid = mockViewModel.Validate();  \\n \\n    Assert.False(isValid);  \\n    Assert.NotNull(mo\", \"ckViewModel.Forename.Value);  \\n    Assert.Null(mockViewModel.Surname.Value);  \\n    Assert.True(mockV\", \"iewModel.Forename.IsValid);  \\n    Assert.False(mockViewModel.Surname.IsValid);  \\n    Assert.Empty(mo\", \"ckViewModel.Forename.Errors);  \\n    Assert.NotEmpty(mockViewModel.Surname.Errors);  \\n}  91 CHAPTER  \", \"11  |  Unit testing  \\n This unit test checks that validation fails when the Surname  property of the\", \" MockViewModel  doesn't \\nhave any data, and the Value , IsValid , and Errors property of each Valida\", \"tableObject<T>  instance \\nare correctly set.  \\nSummary  \\nA unit test takes a small unit of the app, \", \"typically a method, isolates it from the remainder of the code, \\nand verifies that it behaves as exp\", \"ected. Its goal is to check that each unit of functi onality performs as \\nexpected, so that errors d\", \"on't propagate throughout the app.  \\nThe behavior of an object under test can be isolated by replaci\", \"ng dependent objects with mock \\nobjects that simulate the behavior of the dependent objects. This en\", \"ables unit te sts to be executed \\nwithout requiring unwieldy resources such as web services, or data\", \"bases.  \\nTesting models and view models from MVVM applications is identical to testing any other cla\", \"sses, and \\nthe same tools and techniques can be used.  \\n  92 CHAPTER  11  |  Unit testing  \\n  \\n\"]"