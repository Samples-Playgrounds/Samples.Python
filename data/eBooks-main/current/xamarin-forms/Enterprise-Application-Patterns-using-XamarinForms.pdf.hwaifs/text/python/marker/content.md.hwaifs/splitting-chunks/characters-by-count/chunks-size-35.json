"[\"![](_page_0_Picture_0.jpeg)\\n\\n# Book title Book subtitle\\n\\n![](_page_0_Picture_2.jpeg)\\n\\n#### PUBLISHED\", \" BY\\n\\nDevDiv, .NET and Visual Studio produc teams A division of Microsoft Corporation One Microsoft W\", \"ay Redmond, Washington 98052-6399\\n\\nCopyright \\u00a9 2017 by Microsoft Corporation\\n\\nAll rights reserved. N\", \"o part of the contents of this book may be reproduced or transmitted in any form or by any means wit\", \"hout the written permission of the publisher.\\n\\nThis book is provided \\\"as-is\\\" and expresses the autho\", \"r's views and opinions. The views, opinions and information expressed in this book, including URL an\", \"d other Internet website references, may change without notice.\\n\\nSome examples depicted herein are p\", \"rovided for illustration only and are fictitious. No real association or connection is intended or s\", \"hould be inferred.\\n\\nMicrosoft and the trademarks listed at http://www.microsoft.com on the \\\"Trademar\", \"ks\\\" webpage are trademarks of the Microsoft group of companies. All other marks are property of thei\", \"r respective owners.\\n\\n**Author:** David Britch\\n\\n**Developer:** Javier Suarez Ruiz (Plain Concepts)\\n\\n\", \"**Participants and reviewers:** Craig Dunn, Tom Opgenorth\\n\\n**Editor:** John Meade (Populus Group)\\n\\n#\", \" Contents\\n\\n| Preface                                                                     | iv |\\n|---\", \"--------------------------------------------------------------------------|----|\\n| Purpose          \", \"                                                           | iv |\\n| What's left out of this guide's \", \"scope                                       | iv |\\n| Who should use this guide                      \", \"                             | iv |\\n| How to use this guide                                         \", \"              | v  |\\n| Introduction                                                                |\", \" 1  |\\n| Sample application                                                          | 2  |\\n| Sample \", \"application architecture                                             | 2  |\\n| Mobile app            \", \"                                                      | 4  |\\n| eShopOnContainers.Core project       \", \"                                       | 5  |\\n| Platform projects                                   \", \"                        | 6  |\\n| Summary                                                            \", \"         | 6  |\\n| MVVM                                                                        | 7  |\", \"\\n| The MVVM pattern                                                            |    |\\n| View        \", \"                                                                |    |\\n| ViewModel                  \", \"                                                 |    |\\n| Model                                     \", \"                                  |    |\\n| Connecting view models to views                          \", \"                   | 9  |\\n| Creating a view model declaratively                                     \", \"    |    |\\n| Creating a view model programmatically                                      |    |\\n| Cr\", \"eating a view defined as a data template                                  |    |\\n| Automatically cre\", \"ating a view model with a view model locator               |    |\\n| Updating views in response to ch\", \"anges in the underlying view model or model |    |\\n| UI interaction using commands and behaviors    \", \"                             |    |\\n| Implementing commands                                         \", \"              |    |\\n| Implementing behaviors                                                      |\", \" 15 |\\n| Summary                                                                     | 17 |\\n| Depende\", \"ncy injection                                                        | 18 |\\n| Introduction to depend\", \"ency injection                                        |    |\\n| Registration                         \", \"                                       |    |\\n| Resolution                                          \", \"                        |    |\\n| Managing the lifetime of resolved objects                          \", \"         | 22 |\\n| Summary                                                                     |    |\", \"\\n\\n| Communicating between loosely coupled components  | 2 |\\n|---------------------------------------\", \"------------|---|\\n| Introduction to MessagingCenter                   | 2 |\\n| Defining a message    \", \"                            | 2 |\\n| Publishing a message                              | 2 |\\n| Subscr\", \"ibing to a message                          | 2 |\\n| Unsubscribing from a message                    \", \"  | 2 |\\n| Summary                                           | 2 |\\n| Navigation                      \", \"                  | 2 |\\n| Navigating between pages                          | 2 |\\n| Creating the Nav\", \"igationService instance           | 2 |\\n| Handling navigation requests                      | 3 |\\n| \", \"Navigating when the app is launched               | 3 |\\n| Passing parameters during navigation      \", \"        | 3 |\\n| Invoking navigation using behaviors               | 3 |\\n| Confirming or cancelling n\", \"avigation               | 3 |\\n| Summary                                           | 3 |\\n| Validation\", \"                                        | 3 |\\n| Specifying validation rules                       | \", \"3 |\\n| Adding validation rules to a property             | 3 |\\n| Triggering validation               \", \"              | 3 |\\n| Triggering validation manually                    | 3 |\\n| Triggering validatio\", \"n when properties change      | 4 |\\n| Displaying validation errors                      |   |\\n| High\", \"lighting a control that contains invalid data |   |\\n| Displaying error messages                     \", \"    |   |\\n| Summary                                           |   |\\n| Configuration management      \", \"                    | 4 |\\n| Creating a settings class                         |   |\\n| Adding a setti\", \"ng                                  |   |\\n| Data binding to user settings                     |   |\\n\", \"| Summary                                           |   |\\n| Containerized microservices             \", \"          | 5 |\\n| Microservices                                     | 5 |\\n| Containerization        \", \"                          |   |\\n| Communication between client and microservices    |   |\\n| Communic\", \"ation between microservices               |   |\\n| Summary                                           \", \"|   |\\n| Authentication and authorization                  | 5 |\\n| Authentication                    \", \"                |   |\\n| Issuing bearer tokens using IdentityServer 4      |   |\\n| Adding IdentitySer\", \"ver to a web application        |   |\\n| Configuring IdentityServer                        |   |\\n|   \", \"                                                |   |\\n\\n| Performing authentication                  \", \"         | 64 |\\n|-----------------------------------------------------|----|\\n| Authorization        \", \"                               | 69 |\\n| Configuring IdentityServer to perform authorization | 70 |\\n|\", \" Making access requests to APIs                      | 71 |\\n| Summary                               \", \"              | 71 |\\n| Accessing remote data                               | 73 |\\n| Introduction to \", \"Representational State Transfer     | 73 |\\n| Consuming RESTful APIs                              | 7\", \"4 |\\n| Making web requests                                 | 74 |\\n| Caching data                     \", \"                   | 81 |\\n| Managing data expiration                            | 82 |\\n| Caching ima\", \"ges                                      | 82 |\\n| Increasing resilience                             \", \"  | 83 |\\n| Retry pattern                                       | 83 |\\n| Circuit breaker pattern     \", \"                        | 84 |\\n| Summary                                             | 85 |\\n| Unit t\", \"esting                                        | 86 |\\n| Dependency injection and unit testing        \", \"       | 86 |\\n| Testing MVVM applications                           | 87 |\\n| Testing asynchronous fu\", \"nctionality                  | 88 |\\n| Testing INotifyPropertyChanged implementations      |    |\\n| T\", \"esting message-based communication                 |    |\\n| Testing exception handling              \", \"            |    |\\n| Testing validation                                  | 90 |\\n| Summary           \", \"                                  | 91 |\\n\\n# Preface\\n\\n# Purpose\\n\\nThis eBook provides guidance on buil\", \"ding cross-platform enterprise apps using Xamarin.Forms. Xamarin.Forms is a cross-platform UI toolki\", \"t that allows developers to easily create native user interface layouts that can be shared across pl\", \"atforms, including iOS, Android, and the Universal Windows Platform (UWP). It provides a comprehensi\", \"ve solution for Business to Employee (B2E), Business to Business (B2B), and Business to Consumer (B2\", \"C) apps, providing the ability to share code across all target platforms and helping to lower the to\", \"tal cost of ownership (TCO).\\n\\nThe guide provides architectural guidance for developing adaptable, ma\", \"intainable, and testable Xamarin.Forms enterprise apps. Guidance is provided on how to implement MVV\", \"M, dependency injection, navigation, validation, and configuration management, while maintaining loo\", \"se coupling. In addition, there's also guidance on performing authentication and authorization with \", \"IdentityServer, accessing data from containerized microservices, and unit testing.\\n\\nThe guide comes \", \"with source code for the [eShopOnContainers mobile app,](https://github.com/dotnet-architecture/eSho\", \"pOnContainers/tree/master/src/Mobile) and source code for the [eShopOnContainers reference app.](htt\", \"ps://github.com/dotnet-architecture/eShopOnContainers) The eShopOnContainers mobile app is a cross-p\", \"latform enterprise app developed using Xamarin.Forms, which connects to a series of containerized mi\", \"croservices known as the eShopOnContainers reference app. However, the eShopOnContainers mobile app \", \"can be configured to consume data from mock services for those who wish to avoid deploying the conta\", \"inerized microservices.\\n\\n### **What's left out of this guide's scope**\\n\\nThis guide is aimed at reade\", \"rs who are already familiar with Xamarin.Forms. For a detailed introduction to Xamarin.Forms, see th\", \"[e Xamarin.Forms documentation](https://developer.xamarin.com/guides/xamarin-forms/) on the Xamarin \", \"Developer Center, and [Creating Mobile Apps with Xamarin.Forms.](https://aka.ms/xamebook)\\n\\nThe guide\", \" is complementary to [.NET Microservices: Architecture for Containerized .NET Applications,](https:/\", \"/aka.ms/microservicesebook) which focuses on developing and deploying containerized microservices. O\", \"ther guides worth reading include [Architecting and Developing Modern Web Applications with ASP.NET \", \"Core and Microsoft](http://aka.ms/WebAppEbook)  [Azure,](http://aka.ms/WebAppEbook) [Containerized D\", \"ocker Application Lifecycle with Microsoft Platform and Tools,](http://aka.ms/dockerlifecycleebook) \", \"and [Microsoft](http://aka.ms/MobAppDev/StndPDF)  [Platform and Tools for Mobile App Development.](h\", \"ttp://aka.ms/MobAppDev/StndPDF)\\n\\n### **Who should use this guide**\\n\\nThe audience for this guide is m\", \"ainly developers and architects who would like to learn how to architect and implement cross-platfor\", \"m enterprise apps using Xamarin.Forms.\\n\\nA secondary audience is technical decision makers who would \", \"like to receive an architectural and technology overview before deciding on what approach to select \", \"for cross-platform enterprise app development using Xamarin.Forms.\\n\\n#### **How to use this guide**\\n\\n\", \"This guide focuses on building cross-platform enterprise apps using Xamarin.Forms. As such, it shoul\", \"d be read in its entirety to provide a foundation of understanding such apps and their technical con\", \"siderations. The guide, along with its sample app, can also serve as a starting point or reference f\", \"or creating a new enterprise app. Use the associated sample app as a template for the new app, or to\", \" see how to organize an app's component parts. Then, refer back to this guide for architectural guid\", \"ance.\\n\\nFeel free to forward this guide to team members to help ensure a common understanding of cros\", \"splatform enterprise app development using Xamarin.Forms. Having everybody working from a common set\", \" of terminologies and underlying principles will help ensure a consistent application of architectur\", \"al patterns and practices.\\n\\nC H A P T E R 1\\n\\n# Introduction\\n\\nRegardless of platform, developers of e\", \"nterprise apps face several challenges:\\n\\n- App requirements that can change over time.\\n- New busines\", \"s opportunities and challenges.\\n- Ongoing feedback during development that can significantly affect \", \"the scope and requirements of the app.\\n\\nWith these in mind, it's important to build apps that can be\", \" easily modified or extended over time. Designing for such adaptability can be difficult as it requi\", \"res an architecture that allows individual parts of the app to be independently developed and tested\", \" in isolation without affecting the rest of the app.\\n\\nMany enterprise apps are sufficiently complex \", \"to require more than one developer. It can be a significant challenge to decide how to design an app\", \" so that multiple developers can work effectively on different pieces of the app independently, whil\", \"e ensuring that the pieces come together seamlessly when integrated into the app.\\n\\nThe traditional a\", \"pproach to designing and building an app results in what is referred to as a *monolithic* app, where\", \" components are tightly coupled with no clear separation between them. Typically, this monolithic ap\", \"proach leads to apps that are difficult and inefficient to maintain, because it can be difficult to \", \"resolve bugs without breaking other components in the app, and it can be difficult to add new featur\", \"es or to replace existing features.\\n\\nAn effective remedy for these challenges is to partition an app\", \" into discrete, loosely coupled components that can be easily integrated together into an app. Such \", \"an approach offers several benefits:\\n\\n- It allows individual functionality to be developed, tested, \", \"extended, and maintained by different individuals or teams.\\n- It promotes reuse and a clean separati\", \"on of concerns between the app's horizontal capabilities, such as authentication and data access, an\", \"d the vertical capabilities, such as app specific business functionality. This allows the dependenci\", \"es and interactions between app components to be more easily managed.\\n- It helps maintain a separati\", \"on of roles by allowing different individuals, or teams, to focus on a specific task or piece of fun\", \"ctionality according to their expertise. In particular, it provides a cleaner separation between the\", \" user interface and the app's business logic.\\n\\nHowever, there are many issues that must be resolved \", \"when partitioning an app into discrete, loosely coupled components. These include:\\n\\n\\u2022 Deciding how t\", \"o provide a clean separation of concerns between the user interface controls and their logic. One of\", \" the most important decisions when creating a Xamarin.Forms enterprise app is whether to place busin\", \"ess logic in code-behind files, or whether to create a clean separation of concerns between the user\", \" interface controls and their logic, in order to\\n\\nmake the app more maintainable and testable. For m\", \"ore information, see [Model-View-](#page-13-0)[ViewModel.](#page-13-0)\\n\\n- Determining whether to use\", \" a dependency injection container. Dependency injection containers reduce the dependency coupling be\", \"tween objects by providing a facility to construct instances of classes with their dependencies inje\", \"cted, and manage their lifetime based on the configuration of the container. For more information, s\", \"ee [Dependency injection.](#page-24-0)\\n- Choosing between platform provided eventing and loosely cou\", \"pled message-based communication between components that are inconvenient to link by object and type\", \" references. For more information, see Introduction to [Communicating between loosely](#page-30-0)  \", \"[coupled components.](#page-30-0)\\n- Deciding how to navigate between pages, including how to invoke \", \"navigation, and where navigation logic should reside. For more information, see [Navigation.](#page-\", \"34-0)\\n- Determining how to validate user input for correctness. The decision must include how to val\", \"idate user input, and how to notify the user about validation errors. For more information, see [Val\", \"idation.](#page-42-0)\\n- Deciding how to perform authentication, and how to protect resources with au\", \"thorization. For more information, see [Authentication and authorization.](#page-65-0)\\n- Determining\", \" how to access remote data from web services, including how to reliably retrieve data, and how to ca\", \"che data. For more information, see [Accessing remote data.](#page-79-0)\\n- Deciding how to test the \", \"app. For more information, se[e Unit testing.](#page-92-0)\\n\\nThis guide provides guidance on these is\", \"sues, and focuses on the core patterns and architecture for building a cross-platform enterprise app\", \" using Xamarin.Forms. The guidance aims to help to produce adaptable, maintainable, and testable cod\", \"e, by addressing common Xamarin.Forms enterprise app development scenarios, and by separating the co\", \"ncerns of presentation, presentation logic, and entities through support for the Model-View-ViewMode\", \"l (MVVM) pattern.\\n\\n# Sample application\\n\\nThis guide includes a sample application, eShopOnContainers\", \", that's an online store that includes the following functionality:\\n\\n- Authenticating and authorizin\", \"g against a backend service.\\n- Browsing a catalog of shirts, coffee mugs, and other marketing items.\", \"\\n- Filtering the catalog.\\n- Ordering items from the catalog.\\n- Viewing the user's order history.\\n- C\", \"onfiguration of settings.\\n\\n### **Sample application architecture**\\n\\nFigure 1-1 provides a high-level\", \" overview of the architecture of the sample application.\\n\\n![](_page_9_Figure_0.jpeg)\\n\\n**Figure 1-1**\", \": eShopOnContainers high-level architecture\\n\\nThe sample application ships with three client apps:\\n\\n-\", \" An MVC application developed with ASP.NET Core.\\n- A Single Page Application (SPA) developed with An\", \"gular 2 and Typescript. This approach for web applications avoids performing a round-trip to the ser\", \"ver with each operation.\\n- A mobile app developed with Xamarin.Forms, which supports iOS, Android, a\", \"nd the Universal Windows Platform (UWP).\\n\\nFor information about the web applications, see [Architect\", \"ing and Developing Modern Web](http://aka.ms/WebAppEbook)  [Applications with ASP.NET Core and Micro\", \"soft Azure.](http://aka.ms/WebAppEbook)\\n\\nThe sample application includes the following backend servi\", \"ces:\\n\\n- An identity microservice, which uses ASP.NET Core Identity and IdentityServer.\\n- A catalog m\", \"icroservice, which is a data-driven create, read, update, delete (CRUD) service that consumes an SQL\", \" Server database using EntityFramework Core.\\n- An ordering microservice, which is a domain-driven se\", \"rvice that uses domain-driven design patterns.\\n- A basket microservice, which is a data-driven CRUD \", \"service that uses Redis Cache.\\n\\nThese backend services are implemented as microservices using ASP.NE\", \"T Core MVC, and are deployed as unique containers within a single Docker host. Collectively, these b\", \"ackend services are referred to as the eShopOnContainers reference application. Client apps communic\", \"ate with the backend services through a Representational State Transfer (REST) web interface. For mo\", \"re information about microservices and Docker, see [Containerized microservices.](#page-58-0)\\n\\nFor i\", \"nformation about the implementation of the backend services, se[e .NET Microservices:](https://aka.m\", \"s/microservicesebook)  [Architecture for Containerized .NET Applications.](https://aka.ms/microservi\", \"cesebook)\\n\\n#### **Mobile app**\\n\\nThis guide focuses on building cross-platform enterprise apps using \", \"Xamarin.Forms, and uses the eShopOnContainers mobile app as an example. Figure 1-2 shows the pages f\", \"rom the eShopOnContainers mobile app that provide the functionality outlined earlier.\\n\\n![](_page_10_\", \"Figure_2.jpeg)\\n\\n**Figure 1-2**: The eShopOnContainers mobile app\\n\\nThe mobile app consumes the backen\", \"d services provided by the eShopOnContainers reference application. However, it can be configured to\", \" consume data from mock services for those who wish to avoid deploying the backend services.\\n\\nThe eS\", \"hopOnContainers mobile app exercises the following Xamarin.Forms functionality:\\n\\n- XAML\\n- Controls\\n-\", \" Bindings\\n- Converters\\n- Styles\\n\\n- Animations\\n- Commands\\n- Behaviors\\n- Triggers\\n- Effects\\n- Custom R\", \"enderers\\n- MessagingCenter\\n- Custom Controls\\n\\nFor more information about this functionality, see the\", \" [Xamarin.Forms documentation](https://developer.xamarin.com/guides/xamarin-forms/) on the Xamarin D\", \"eveloper Center, and [Creating Mobile Apps with Xamarin.Forms.](https://aka.ms/xamebook)\\n\\nIn additio\", \"n, unit tests are provided for some of the classes in the eShopOnContainers mobile app.\\n\\n#### **Mobi\", \"le app solution**\\n\\nThe eShopOnContainers mobile app solution organizes the source code and other res\", \"ources into projects. All of the projects use folders to organize the source code and other resource\", \"s into categories. The following table outlines the projects that make up the eShopOnContainers mobi\", \"le app:\\n\\n| Project                              | Description                                       \", \"       |\\n|--------------------------------------|---------------------------------------------------\", \"-------|\\n| eShopOnContainers.Core               | This project is the portable class library (PCL) p\", \"roject |\\n|                                      | that contains<br>the shared code and shared UI.   \", \"       |\\n| eShopOnContainers.Droid              | This project holds Android specific code and is th\", \"e      |\\n|                                      | entry point for the Android app.                  \", \"       |\\n| eShopOnContainers.iOS                | This project holds iOS specific code and is the en\", \"try    |\\n|                                      | point for the iOS app.                            \", \"       |\\n| eShopOnContainers.UWP                | This project holds Universal Windows Platform (UWP\", \")      |\\n|                                      | specific code and is the entry point for the Windo\", \"ws     |\\n|                                      | app.                                              \", \"       |\\n| eShopOnContainers.TestRunner.Droid   | This project is the Android test runner for the   \", \"       |\\n|                                      | eShopOnContainers.UnitTests project.              \", \"       |\\n| eShopOnContainers.TestRunner.iOS     | This project is the iOS test runner for the       \", \"       |\\n|                                      | eShopOnContainers.UnitTests project.              \", \"       |\\n| eShopOnContainers.TestRunner.Windows | This project is the Universal Windows Platform tes\", \"t      |\\n|                                      | runner for the eShopOnContainers.UnitTests project\", \".      |\\n| eShopOnContainers.UnitTests          | This project contains unit tests for the          \", \"       |\\n|                                      | eShopOnContainers.Core project.                   \", \"       |\\n\\nThe classes from the eShopOnContainers mobile app can be re-used in any Xamarin.Forms app \", \"with little or no modification.\\n\\n## **eShopOnContainers.Core project**\\n\\nThe eShopOnContainers.Core P\", \"CL project contains the following folders:\\n\\n| Folder      | Description                             \", \"                                                                               |  |\\n|-------------|-\", \"----------------------------------------------------------------------------------------------------\", \"-------------------|--|\\n| Animations  | Contains classes that enable animations to be consumed in XA\", \"ML.                                                        |  |\\n| Behaviors   | Contains behaviors t\", \"hat are exposed to view classes.                                                                   |\", \"  |\\n| Controls    | Contains custom controls used by the app.                                       \", \"                                       |  |\\n| Converters  | Contains value converters that apply cus\", \"tom logic to a binding.                                                        |  |\\n| Effects     | \", \"Contains the EntryLineColorEffect<br>class, which is used to change the border<br>color of specific \", \"Entry<br>controls. |  |\\n| Exceptions  | Contains the custom ServiceAuthenticationException.         \", \"                                                           |  |\\n| Extensions  | Contains extension m\", \"ethods for the VisualElement<br>and IEnumerable <t><br/>classes.</t>                               |\", \"  |\\n| Helpers     | Contains helper classes for the app.                                            \", \"                                       |  |\\n| Models      | Contains the model classes for the app. \", \"                                                                               |  |\\n| Properties  | \", \"Contains AssemblyInfo.cs, a .NET assembly metadata file.                                            \", \"                   |  |\\n| Services    | Contains interfaces and classes that implement services that\", \" are provided to the<br>app.                               |  |\\n| Triggers    | Contains the BeginAn\", \"imation<br>trigger, which is used to invoke an animation in<br>XAML.                               |\", \"  |\\n| Validations | Contains classes involved in validating data input.                             \", \"                                       |  |\\n| ViewModels  | Contains the application logic that's ex\", \"posed to pages.                                                                |  |\\n| Views       | \", \"Contains the pages for the app.                                                                     \", \"                   |  |\\n\\n## **Platform projects**\\n\\nThe platform projects contain effect implementati\", \"ons, custom renderer implementations, and other platform-specific resources.\\n\\n# Summary\\n\\nXamarin's c\", \"ross-platform mobile app development tools and platforms provide a comprehensive solution for B2E, B\", \"2B, and B2C mobile client apps, providing the ability to share code across all target platforms (iOS\", \", Android, and Windows) and helping to lower the total cost of ownership. Apps can share their user \", \"interface and app logic code, while retaining the native platform look and feel.\\n\\nDevelopers of ente\", \"rprise apps face several challenges that can alter the architecture of the app during development. T\", \"herefore, it's important to build an app so that it can be modified or extended over time. Designing\", \" for such adaptability can be difficult, but typically involves partitioning an app into discrete, l\", \"oosely coupled components that can be easily integrated together into an app.\\n\\n# <span id=\\\"page-13-0\", \"\\\"></span>MVVM\\n\\nThe Xamarin.Forms developer experience typically involves creating a user interface i\", \"n XAML, and then adding code-behind that operates on the user interface. As apps are modified, and g\", \"row in size and scope, complex maintenance issues can arise. These issues include the tight coupling\", \" between the UI controls and the business logic, which increases the cost of making UI modifications\", \", and the difficulty of unit testing such code.\\n\\nThe Model-View-ViewModel (MVVM) pattern helps to cl\", \"eanly separate the business and presentation logic of an application from its user interface (UI). M\", \"aintaining a clean separation between application logic and the UI helps to address numerous develop\", \"ment issues and can make an application easier to test, maintain, and evolve. It can also greatly im\", \"prove code re-use opportunities and allows developers and UI designers to more easily collaborate wh\", \"en developing their respective parts of an app.\\n\\n# The MVVM pattern\\n\\nThere are three core components\", \" in the MVVM pattern: the model, the view, and the view model. Each serves a distinct purpose. Figur\", \"e 2-1 shows the relationships between the three components.\\n\\n![](_page_13_Figure_7.jpeg)\\n\\n**Figure 2\", \"-1**: The MVVM pattern\\n\\nIn addition to understanding the responsibilities of each components, it's a\", \"lso important to understand how they interact with each other. At a high level, the view \\\"knows abou\", \"t\\\" the view model, and the view model \\\"knows about\\\" the model, but the model is unaware of the view \", \"model, and the view model is unaware of the view. Therefore, the view model isolates the view from t\", \"he model, and allows the model to evolve independently of the view.\\n\\nThe benefits of using the MVVM \", \"pattern are as follows:\\n\\n\\u2022 If there's an existing model implementation that encapsulates existing bu\", \"siness logic, it can be difficult or risky to change it. In this scenario, the view model acts as an\", \" adapter for the model classes and enables you to avoid making any major changes to the model code.\\n\", \"\\n- Developers can create unit tests for the view model and the model, without using the view. The un\", \"it tests for the view model can exercise exactly the same functionality as used by the view.\\n- The a\", \"pp UI can be redesigned without touching the code, provided that the view is implemented entirely in\", \" XAML. Therefore, a new version of the view should work with the existing view model.\\n- Designers an\", \"d developers can work independently and concurrently on their components during the development proc\", \"ess. Designers can focus on the view, while developers can work on the view model and model componen\", \"ts.\\n\\nThe key to using MVVM effectively lies in understanding how to factor app code into the correct\", \" classes, and in understanding how the classes interact. The following sections discuss the responsi\", \"bilities of each of the classes in the MVVM pattern.\\n\\n#### **View**\\n\\nThe view is responsible for def\", \"ining the structure, layout, and appearance of what the user sees on screen. Ideally, each view is d\", \"efined in XAML, with a limited code-behind that does not contain business logic. However, in some ca\", \"ses, the code-behind might contain UI logic that implements visual behavior that is difficult to exp\", \"ress in XAML, such as animations.\\n\\nIn a Xamarin.Forms application, a view is typically a Page-derive\", \"d or ContentView-derived class. However, views can also be represented by a data template, which spe\", \"cifies the UI elements to be used to visually represent an object when it's displayed. A data templa\", \"te as a view does not have any code-behind, and is designed to bind to a specific view model type.\\n\\n\", \"**Tip:** Avoid enabling and disabling UI elements in the code-behind\\n\\nEnsure that view models are re\", \"sponsible for defining logical state changes that affect some aspects of the view's display, such as\", \" whether a command is available, or an indication that an operation is pending. Therefore, enable an\", \"d disable UI elements by binding to view model properties, rather than enabling and disabling them i\", \"n code-behind.\\n\\nThere are several options for executing code on the view model in response to intera\", \"ctions on the view, such as a button click or item selection. If a control supports commands, the co\", \"ntrol's Command property can be data-bound to an ICommand property on the view model. When the contr\", \"ol's command is invoked, the code in the view model will be executed. In addition to commands, behav\", \"iors can be attached to an object in the view and can listen for either a command to be invoked or e\", \"vent to be raised. In response, the behavior can then invoke an ICommand on the view model or a meth\", \"od on the view model.\\n\\n#### **ViewModel**\\n\\nThe view model implements properties and commands to whic\", \"h the view can data bind to, and notifies the view of any state changes through change notification \", \"events. The properties and commands that the view model provides define the functionality to be offe\", \"red by the UI, but the view determines how that functionality is to be displayed.\\n\\n**Tip:** Keep the\", \" UI responsive with asynchronous operations\\n\\nMobile apps should keep the UI thread unblocked to impr\", \"ove the user's perception of performance. Therefore, in the view model, use asynchronous methods for\", \" I/O operations and raise events to asynchronously notify views of property changes.\\n\\nThe view model\", \" is also responsible for coordinating the view's interactions with any model classes that are requir\", \"ed. There's typically a one-to-many relationship between the view model and the model classes. The v\", \"iew model might choose to expose model classes directly to the view so that controls in the view can\", \" data bind directly to them. In this case, the model classes will need to be designed to support dat\", \"a binding and change notification events.\\n\\nEach view model provides data from a model in a form that\", \" the view can easily consume. To accomplish this, the view model sometimes performs data conversion.\", \" Placing this data conversion in the view model is a good idea because it provides properties that t\", \"he view can bind to. For example, the view model might combine the values of two properties to make \", \"it easier for display by the view.\\n\\n#### **Tip:** Centralize data conversions in a conversion layer\\n\", \"\\nIt's also possible to use converters as a separate data conversion layer that sits between the view\", \" model and the view. This can be necessary, for example, when data requires special formatting that \", \"the view model doesn't provide.\\n\\nIn order for the view model to participate in two-way data binding \", \"with the view, its properties must raise the PropertyChanged event. View models satisfy this require\", \"ment by implementing the INotifyPropertyChanged interface, and raising the PropertyChanged event whe\", \"n a property is changed.\\n\\nFor collections, the view-friendly ObservableCollection<T> is provided. Th\", \"is collection implements collection changed notification, relieving the developer from having to imp\", \"lement the INotifyCollectionChanged interface on collections.\\n\\n#### **Model**\\n\\nModel classes are non\", \"-visual classes that encapsulate the app's data. Therefore, the model can be thought of as represent\", \"ing the app's domain model, which usually includes a data model along with business and validation l\", \"ogic. Examples of model objects include data transfer objects (DTOs), Plain Old CLR Objects (POCOs),\", \" and generated entity and proxy objects.\\n\\nModel classes are typically used in conjunction with servi\", \"ces or repositories that encapsulate data access and caching.\\n\\n# Connecting view models to views\\n\\nVi\", \"ew models can be connected to views by using the data-binding capabilities of Xamarin.Forms. There a\", \"re many approaches that can be used to construct views and view models and associate them at runtime\", \". These approaches fall into two categories, known as view first composition, and view model first c\", \"omposition. Choosing between view first composition and view model first composition is an issue of \", \"preference and complexity. However, all approaches share the same aim, which is for the view to have\", \" a view model assigned to its BindingContext property.\\n\\nWith view first composition the app is conce\", \"ptually composed of views that connect to the view models they depend on. The primary benefit of thi\", \"s approach is that it makes it easy to construct loosely coupled, unit testable apps because the vie\", \"w models have no dependence on the views themselves. It's also easy to understand the structure of t\", \"he app by following its visual structure, rather than having to track code execution to understand h\", \"ow classes are created and associated. In addition, view first construction aligns with the Xamarin.\", \"Forms navigation system that's responsible for constructing pages when navigation occurs, which make\", \"s a view model first composition complex and misaligned with the platform.\\n\\nWith view model first co\", \"mposition the app is conceptually composed of view models, with a service being responsible for loca\", \"ting the view for a view model. View model first composition feels more natural to some developers, \", \"since the view creation can be abstracted away, allowing them to focus on the logical non-UI structu\", \"re of the app. In addition, it allows view models to be created by other view models. However, this \", \"approach is often complex and it can become difficult to understand how the various parts of the app\", \" are created and associated.\\n\\n**Tip:** Keep view models and views independent\\n\\nThe binding of views \", \"to a property in a data source should be the view's principal dependency on its corresponding view m\", \"odel. Specifically, don't reference view types, such as Button and ListView, from view models. By fo\", \"llowing the principles outlined here, view models can be tested in isolation, therefore reducing the\", \" likelihood of software defects by limiting scope.\\n\\nThe following sections discuss the main approach\", \"es to connecting view models to views.\\n\\n### **Creating a view model declaratively**\\n\\nThe simplest ap\", \"proach is for the view to declaratively instantiate its corresponding view model in XAML. When the v\", \"iew is constructed, the corresponding view model object will also be constructed. This approach is d\", \"emonstrated in the following code example:\\n\\n```\\n<ContentPage ... xmlns:local=\\\"clr-namespace:eShop\\\">\\n\", \" <ContentPage.BindingContext>\\n <local:LoginViewModel />\\n </ContentPage.BindingContext>\\n ...\\n</Conten\", \"tPage>\\n```\\n\\nWhen the ContentPage is created, an instance of the LoginViewModel is automatically cons\", \"tructed and set as the view's BindingContext.\\n\\nThis declarative construction and assignment of the v\", \"iew model by the view has the advantage that it's simple, but has the disadvantage that it requires \", \"a default (parameter-less) constructor in the view model.\\n\\n## **Creating a view model programmatical\", \"ly**\\n\\nA view can have code in the code-behind file that results in the view model being assigned to \", \"its BindingContext property. This is often accomplished in the view's constructor, as shown in the f\", \"ollowing code example:\\n\\n```\\npublic LoginView()\\n{\\n InitializeComponent();\\n BindingContext = new Login\", \"ViewModel(navigationService);\\n}\\n```\\n\\nThe programmatic construction and assignment of the view model \", \"within the view's code-behind has the advantage that it's simple. However, the main disadvantage of \", \"this approach is that the view needs to provide the view model with any required dependencies. Using\", \" a dependency injection container can help to maintain loose coupling between the view and view mode\", \"l. For more information, se[e Dependency injection.](#page-24-0)\\n\\n### **Creating a view defined as a\", \" data template**\\n\\nA view can be defined as a data template and associated with a view model type. Da\", \"ta templates can be defined as resources, or they can be defined inline within the control that will\", \" display the view model. The content of the control is the view model instance, and the data templat\", \"e is used to visually represent it. This technique is an example of a situation in which the view mo\", \"del is instantiated first, followed by the creation of the view.\\n\\n### <span id=\\\"page-17-0\\\"></span>**\", \"Automatically creating a view model with a view model locator**\\n\\nA view model locator is a custom cl\", \"ass that manages the instantiation of view models and their association to views. In the eShopOnCont\", \"ainers mobile app, the ViewModelLocator class has an attached property, AutoWireViewModel, that's us\", \"ed to associate view models with views. In the view's XAML, this attached property is set to true to\", \" indicate that the view model should be automatically connected to the view, as shown in the followi\", \"ng code example:\\n\\n```\\nviewModelBase:ViewModelLocator.AutoWireViewModel=\\\"true\\\"\\n```\\n\\nThe AutoWireViewM\", \"odel property is a bindable property that's initialized to false, and when its value changes the OnA\", \"utoWireViewModelChanged event handler is called. This method resolves the view model for the view. T\", \"he following code example shows how this is achieved:\\n\\n```\\nprivate static void OnAutoWireViewModelCh\", \"anged(BindableObject bindable, object oldValue, object n\\newValue)\\n{\\n var view = bindable as Element;\", \"\\n if (view == null)\\n {\\n return;\\n }\\n var viewType = view.GetType();\\n var viewName = viewType.FullName\", \".Replace(\\\".Views.\\\", \\\".ViewModels.\\\");\\n var viewAssemblyName = viewType.GetTypeInfo().Assembly.FullNam\", \"e;\\n var viewModelName = string.Format(\\n CultureInfo.InvariantCulture, \\\"{0}Model, {1}\\\", viewName, vie\", \"wAssemblyName);\\n var viewModelType = Type.GetType(viewModelName);\\n if (viewModelType == null)\\n {\\n re\", \"turn;\\n }\\n var viewModel = _container.Resolve(viewModelType);\\n view.BindingContext = viewModel;\\n}\\n```\", \"\\n\\nThe OnAutoWireViewModelChanged method attempts to resolve the view model using a conventionbased a\", \"pproach. This convention assumes that:\\n\\n- View models are in the same assembly as view types.\\n- View\", \"s are in a .Views child namespace.\\n- View models are in a .ViewModels child namespace.\\n- View model \", \"names correspond with view names and end with \\\"ViewModel\\\".\\n\\nFinally, the OnAutoWireViewModelChanged \", \"method sets the BindingContext of the view type to the resolved view model type. For more informatio\", \"n about resolving the view model type, se[e Resolution.](#page-28-0)\\n\\nThis approach has the advantag\", \"e that an app has a single class that is responsible for the instantiation of view models and their \", \"connection to views.\\n\\n**Tip:** Use a view model locator for ease of substitution\\n\\nA view model locat\", \"or can also be used as a point of substitution for alternate implementations of dependencies, such a\", \"s for unit testing or design time data.\\n\\n# Updating views in response to changes in the underlying v\", \"iew model or model\\n\\nAll view model and model classes that are accessible to a view should implement \", \"the INotifyPropertyChanged interface. Implementing this interface in a view model or model class all\", \"ows the class to provide change notifications to any data-bound controls in the view when the underl\", \"ying property value changes.\\n\\nApp's should be architected for the correct use of property change not\", \"ification, by meeting the following requirements:\\n\\n- Always raising a PropertyChanged event if a pub\", \"lic property's value changes. Do not assume that raising the PropertyChanged event can be ignored be\", \"cause of knowledge of how XAML binding occurs.\\n- Always raising a PropertyChanged event for any calc\", \"ulated properties whose values are used by other properties in the view model or model.\\n- Always rai\", \"sing the PropertyChanged event at the end of the method that makes a property change, or when the ob\", \"ject is known to be in a safe state. Raising the event interrupts the operation by invoking the even\", \"t's handlers synchronously. If this happens in the middle of an operation, it might expose the objec\", \"t to callback functions when it is in an unsafe, partially updated state. In addition, it's possible\", \" for cascading changes to be triggered by PropertyChanged events. Cascading changes generally requir\", \"e updates to be complete before the cascading change is safe to execute.\\n- Never raising a PropertyC\", \"hanged event if the property does not change. This means that you must compare the old and new value\", \"s before raising the PropertyChanged event.\\n- Never raising the PropertyChanged event during a view \", \"model's constructor if you are initializing a property. Data-bound controls in the view will not hav\", \"e subscribed to receive change notifications at this point.\\n- Never raising more than one PropertyCh\", \"anged event with the same property name argument within a single synchronous invocation of a public \", \"method of a class. For example, given a NumberOfItems property whose backing store is the \\\\_numberOf\", \"Items field, if a method increments \\\\_numberOfItems fifty times during the execution of a loop, it s\", \"hould only raise property change notification on the NumberOfItems property once, after all the work\", \" is complete. For asynchronous methods, raise the PropertyChanged event for a given property name in\", \" each synchronous segment of an asynchronous continuation chain.\\n\\nThe eShopOnContainers mobile app u\", \"ses the ExtendedBindableObject class to provide change notifications, which is shown in the followin\", \"g code example:\\n\\n```\\npublic abstract class ExtendedBindableObject : BindableObject\\n{\\n public void Ra\", \"isePropertyChanged<T>(Expression<Func<T>> property)\\n {\\n var name = GetMemberInfo(property).Name;\\n On\", \"PropertyChanged(name);\\n }\\n private MemberInfo GetMemberInfo(Expression expression)\\n {\\n ...\\n }\\n}\\n```\\n\", \"\\nXamarin.Form's BindableObject class implements the INotifyPropertyChanged interface, and provides a\", \"n OnPropertyChanged method. The ExtendedBindableObject class provides the RaisePropertyChanged metho\", \"d to invoke property change notification, and in doing so uses the functionality provided by the Bin\", \"dableObject class.\\n\\nEach view model class in the eShopOnContainers mobile app derives from the ViewM\", \"odelBase class, which in turn derives from the ExtendedBindableObject class. Therefore, each view mo\", \"del class uses the RaisePropertyChanged method in the ExtendedBindableObject class to provide proper\", \"ty change notification. The following code example shows how the eShopOnContainers mobile app invoke\", \"s property change notification by using a lambda expression:\\n\\n```\\npublic bool IsLogin\\n{\\n get\\n {\\n ret\", \"urn _isLogin;\\n }\\n set\\n {\\n _isLogin = value;\\n RaisePropertyChanged(() => IsLogin);\\n }\\n}\\n```\\n\\nNote tha\", \"t using a lambda expression in this way involves a small performance cost because the lambda express\", \"ion has to be evaluated for each call. Although the performance cost is small and would not normally\", \" impact an app, the costs can accrue when there are many change notifications. However, the benefit \", \"of this approach is that it provides compile-time type safety and refactoring support when renaming \", \"properties.\\n\\n# UI interaction using commands and behaviors\\n\\nIn mobile apps, actions are typically in\", \"voked in response to a user action, such as a button click, that can be implemented by creating an e\", \"vent handler in the code-behind file. However, in the MVVM pattern, the responsibility for implement\", \"ing the action lies with the view model, and placing code in the code-behind should be avoided.\\n\\nCom\", \"mands provide a convenient way to represent actions that can be bound to controls in the UI. They en\", \"capsulate the code that implements the action, and help to keep it decoupled from its visual represe\", \"ntation in the view. Xamarin.Forms includes controls that can be declaratively connected to a comman\", \"d, and these controls will invoke the command when the user interacts with the control.\\n\\nBehaviors a\", \"lso allow controls to be declaratively connected to a command. However, behaviors can be used to inv\", \"oke an action that's associated with a range of events raised by a control. Therefore, behaviors add\", \"ress many of the same scenarios as command-enabled controls, while providing a greater degree of fle\", \"xibility and control. In addition, behaviors can also be used to associate command objects or method\", \"s with controls that were not specifically designed to interact with commands.\\n\\n#### **Implementing \", \"commands**\\n\\nView models typically expose command properties, for binding from the view, that are obj\", \"ect instances that implement the ICommand interface. A number of Xamarin.Forms controls provide a Co\", \"mmand property, which can be data bound to an ICommand object provided by the view model. The IComma\", \"nd interface defines an Execute method, which encapsulates the operation itself, a CanExecute method\", \", which indicates whether the command can be invoked, and a CanExecuteChanged event that occurs when\", \" changes occur that affect whether the command should execute. The Command and Command<T> classes, p\", \"rovided by Xamarin.Forms, implement the ICommand interface, where T is the type of the arguments to \", \"Execute and CanExecute.\\n\\nWithin a view model, there should be an object of type Command or Command<T\", \"> for each public property in the view model of type ICommand. The Command or Command<T> constructor\", \" requires an Action callback object that's called when the ICommand.Execute method is invoked. The C\", \"anExecute method is an optional constructor parameter, and is a Func that returns a bool.\\n\\nThe follo\", \"wing code shows how a Command instance, which represents a register command, is constructed by speci\", \"fying a delegate to the Register view model method:\\n\\n```\\npublic ICommand RegisterCommand => new Comm\", \"and(Register);\\n```\\n\\nThe command is exposed to the view through a property that returns a reference t\", \"o an ICommand. When the Execute method is called on the Command object, it simply forwards the call \", \"to the method in the view model via the delegate that was specified in the Command constructor.\\n\\nAn \", \"asynchronous method can be invoked by a command by using the async and await keywords when specifyin\", \"g the command's Execute delegate. This indicates that the callback is a Task and should be awaited. \", \"For example, the following code shows how a Command instance, which represents a sign-in command, is\", \" constructed by specifying a delegate to the SignInAsync view model method:\\n\\n```\\npublic ICommand Sig\", \"nInCommand => new Command(async () => await SignInAsync());\\n```\\n\\nParameters can be passed to the Exe\", \"cute and CanExecute actions by using the Command<T> class to instantiate the command. For example, t\", \"he following code shows how a Command<T> instance is used to indicate that the NavigateAsync method \", \"will require an argument of type string:\\n\\n```\\npublic ICommand NavigateCommand => new Command<string>\", \"(NavigateAsync);\\n```\\n\\nIn both the Command and Command<T> classes, the delegate to the CanExecute met\", \"hod in each constructor is optional. If a delegate isn't specified, the Command will return true for\", \" CanExecute. However, the view model can indicate a change in the command's CanExecute status by cal\", \"ling the ChangeCanExecute method on the Command object. This causes the CanExecuteChanged event to b\", \"e raised. Any controls in the UI that are bound to the command will then update their enabled status\", \" to reflect the availability of the data-bound command.\\n\\n#### **Invoking commands from a view**\\n\\nThe\", \" following code example shows how a Grid in the LoginView binds to the RegisterCommand in the LoginV\", \"iewModel class by using a TapGestureRecognizer instance:\\n\\n```\\n<Grid Grid.Column=\\\"1\\\" HorizontalOption\", \"s=\\\"Center\\\">\\n <Label Text=\\\"REGISTER\\\" TextColor=\\\"Gray\\\"/>\\n <Grid.GestureRecognizers>\\n <TapGestureRecogn\", \"izer Command=\\\"{Binding RegisterCommand}\\\" NumberOfTapsRequired=\\\"1\\\" />\\n </Grid.GestureRecognizers>\\n</G\", \"rid>\\n```\\n\\nA command parameter can also be optionally defined using the CommandParameter property. Th\", \"e type of the expected argument is specified in the Execute and CanExecute target methods. The TapGe\", \"stureRecognizer will automatically invoke the target command when the user interacts with the attach\", \"ed control. The command parameter, if provided, will be passed as the argument to the command's Exec\", \"ute delegate.\\n\\n#### <span id=\\\"page-21-0\\\"></span>**Implementing behaviors**\\n\\nBehaviors allow function\", \"ality to be added to UI controls without having to subclass them. Instead, the functionality is impl\", \"emented in a behavior class and attached to the control as if it was part of the control itself. Beh\", \"aviors enable you to implement code that you would normally have to write as code-behind, because it\", \" directly interacts with the API of the control, in such a way that it can be concisely attached to \", \"the control, and packaged for reuse across more than one view or app. In the context of MVVM, behavi\", \"ors are a useful approach for connecting controls to commands.\\n\\nA behavior that's attached to a cont\", \"rol through attached properties is known as an *attached behavior*. The behavior can then use the ex\", \"posed API of the element to which it is attached to add functionality to that control, or other cont\", \"rols, in the visual tree of the view. The eShopOnContainers mobile app contains the LineColorBehavio\", \"r class, which is an attached behavior. For more information about this behavior, see [Displaying va\", \"lidation errors.](#page-46-0)\\n\\nA Xamarin.Forms behavior is a class that derives from the Behavior or\", \" Behavior<T> class, where T is the type of the control to which the behavior should apply. These cla\", \"sses provide OnAttachedTo and OnDetachingFrom methods, which should be overridden to provide logic t\", \"hat will be executed when the behavior is attached to and detached from controls.\\n\\nIn the eShopOnCon\", \"tainers mobile app, the BindableBehavior<T> class derives from the Behavior<T> class. The purpose of\", \" the BindableBehavior<T> class is to provide a base class for Xamarin.Forms behaviors that require t\", \"he BindingContext of the behavior to be set to the attached control.\\n\\nThe BindableBehavior<T> class \", \"provides an overridable OnAttachedTo method that sets the BindingContext of the behavior, and an ove\", \"rridable OnDetachingFrom method that cleans up the BindingContext. In addition, the class stores a r\", \"eference to the attached control in the AssociatedObject property.\\n\\nThe eShopOnContainers mobile app\", \" includes an EventToCommandBehavior class, which executes a command in response to an event occurrin\", \"g. This class derives from the BindableBehavior<View> class so that the behavior can bind to and exe\", \"cute an ICommand specified by a Command property when the behavior is consumed. The following code e\", \"xample shows the EventToCommandBehavior class:\\n\\n```\\npublic class EventToCommandBehavior : BindableBe\", \"havior<View>\\n{\\n ...\\n protected override void OnAttachedTo(View visualElement)\\n {\\n base.OnAttachedTo(\", \"visualElement);\\n var events = AssociatedObject.GetType().GetRuntimeEvents().ToArray();\\n if (events.A\", \"ny())\\n {\\n _eventInfo = events.FirstOrDefault(e => e.Name == EventName);\\n if (_eventInfo == null)\\n th\", \"row new ArgumentException(string.Format(\\n \\\"EventToCommand: Can't find any event named '{0}' on attac\", \"hed type\\\",\\n EventName));\\n AddEventHandler(_eventInfo, AssociatedObject, OnFired);\\n }\\n }\\n protected o\", \"verride void OnDetachingFrom(View view)\\n {\\n if (_handler != null)\\n _eventInfo.RemoveEventHandler(Ass\", \"ociatedObject, _handler);\\n base.OnDetachingFrom(view);\\n }\\n private void AddEventHandler(\\n EventInfo \", \"eventInfo, object item, Action<object, EventArgs> action)\\n {\\n ...\\n }\\n private void OnFired(object se\", \"nder, EventArgs eventArgs)\\n {\\n ...\\n }\\n}\\n```\\n\\nThe OnAttachedTo and OnDetachingFrom methods are used t\", \"o register and deregister an event handler for the event defined in the EventName property. Then, wh\", \"en the event fires, the OnFired method is invoked, which executes the command.\\n\\nThe advantage of usi\", \"ng the EventToCommandBehavior to execute a command when an event fires, is that commands can be asso\", \"ciated with controls that weren't designed to interact with commands. In addition, this moves event-\", \"handling code to view models, where it can be unit tested.\\n\\n#### **Invoking behaviors from a view**\\n\", \"\\nThe EventToCommandBehavior is particularly useful for attaching a command to a control that doesn't\", \" support commands. For example, the ProfileView uses the EventToCommandBehavior to execute the Order\", \"DetailCommand when the ItemTapped event fires on the ListView that lists the user's orders, as shown\", \" in the following code:\\n\\n```\\n<ListView>\\n <ListView.Behaviors>\\n <behaviors:EventToCommandBehavior \\n E\", \"ventName=\\\"ItemTapped\\\"\\n Command=\\\"{Binding OrderDetailCommand}\\\"\\n EventArgsConverter=\\\"{StaticResource I\", \"temTappedEventArgsConverter}\\\" />\\n```\\n\\n```\\n </ListView.Behaviors>\\n ...\\n</ListView>\\n```\\n\\nAt runtime, t\", \"he EventToCommandBehavior will respond to interaction with the ListView. When an item is selected in\", \" the ListView, the ItemTapped event will fire, which will execute the OrderDetailCommand in the Prof\", \"ileViewModel. By default, the event arguments for the event are passed to the command. This data is \", \"converted as it's passed between source and target by the converter specified in the EventArgsConver\", \"ter property, which returns the Item of the ListView from the ItemTappedEventArgs. Therefore, when t\", \"he OrderDetailCommand is executed, the selected Order is passed as a parameter to the registered Act\", \"ion.\\n\\nFor more information about behaviors, see [Behaviors](https://developer.xamarin.com/guides/xam\", \"arin-forms/application-fundamentals/behaviors/) on the Xamarin Developer Center.\\n\\n# Summary\\n\\nThe Mod\", \"el-View-ViewModel (MVVM) pattern helps to cleanly separate the business and presentation logic of an\", \" application from its user interface (UI). Maintaining a clean separation between application logic \", \"and the UI helps to address numerous development issues and can make an application easier to test, \", \"maintain, and evolve. It can also greatly improve code re-use opportunities and allows developers an\", \"d UI designers to more easily collaborate when developing their respective parts of an app.\\n\\nUsing t\", \"he MVVM pattern, the UI of the app and the underlying presentation and business logic is separated i\", \"nto three separate classes: the view, which encapsulates the UI and UI logic; the view model, which \", \"encapsulates presentation logic and state; and the model, which encapsulates the app's business logi\", \"c and data.\\n\\n# <span id=\\\"page-24-0\\\"></span>Dependency injection\\n\\nTypically, a class constructor is i\", \"nvoked when instantiating an object, and any values that the object needs are passed as arguments to\", \" the constructor. This is an example of dependency injection, and specifically is known as *construc\", \"tor injection*. The dependencies the object needs are injected into the constructor.\\n\\nBy specifying \", \"dependencies as interface types, dependency injection enables decoupling of the concrete types from \", \"the code that depends on these types. It generally uses a container that holds a list of registratio\", \"ns and mappings between interfaces and abstract types, and the concrete types that implement or exte\", \"nd these types.\\n\\nThere are also other types of dependency injection, such as *property setter inject\", \"ion*, and *method call injection*, but they are less commonly seen. Therefore, this chapter will foc\", \"us solely on performing constructor injection with a dependency injection container.\\n\\n# <span id=\\\"pa\", \"ge-24-1\\\"></span>Introduction to dependency injection\\n\\nDependency injection is a specialized version \", \"of the Inversion of Control (IoC) pattern, where the concern being inverted is the process of obtain\", \"ing the required dependency. With dependency injection, another class is responsible for injecting d\", \"ependencies into an object at runtime. The following code example shows how the ProfileViewModel cla\", \"ss is structured when using dependency injection:\\n\\n```\\npublic class ProfileViewModel : ViewModelBase\", \"\\n{\\n private IOrderService _orderService;\\n public ProfileViewModel(IOrderService orderService)\\n {\\n _o\", \"rderService = orderService;\\n }\\n ...\\n}\\n```\\n\\nThe ProfileViewModel constructor receives an IOrderServic\", \"e instance as an argument, injected by another class. The only dependency in the ProfileViewModel cl\", \"ass is on the interface type. Therefore, the ProfileViewModel class doesn't have any knowledge of th\", \"e class that's responsible for instantiating the IOrderService object. The class that's responsible \", \"for instantiating the\\n\\nIOrderService object, and inserting it into the ProfileViewModel class, is kn\", \"own as the *dependency injection container*.\\n\\nDependency injection containers reduce the coupling be\", \"tween objects by providing a facility to instantiate class instances and manage their lifetime based\", \" on the configuration of the container. During the objects creation, the container injects any depen\", \"dencies that the object requires into it. If those dependencies have not yet been created, the conta\", \"iner creates and resolves their dependencies first.\\n\\n**Note:** Dependency injection can also be impl\", \"emented manually using factories. However, using a container provides additional capabilities such a\", \"s lifetime management, and registration through assembly scanning.\\n\\nThere are several advantages to \", \"using a dependency injection container:\\n\\n- A container removes the need for a class to locate its de\", \"pendencies and manage their lifetimes.\\n- A container allows mapping of implemented dependencies with\", \"out affecting the class.\\n- A container facilitates testability by allowing dependencies to be mocked\", \".\\n- A container increases maintainability by allowing new classes to be easily added to the app.\\n\\nIn\", \" the context of a Xamarin.Forms app that uses MVVM, a dependency injection container will typically \", \"be used for registering and resolving view models, and for registering services and injecting them i\", \"nto view models.\\n\\nThere are many dependency injection containers available, with the eShopOnContaine\", \"rs mobile app using Autofac to manage the instantiation of view model and service classes in the app\", \". Autofac facilitates building loosely coupled apps, and provides all of the features commonly found\", \" in dependency injection containers, including methods to register type mappings and object instance\", \"s, resolve objects, manage object lifetimes, and inject dependent objects into constructors of objec\", \"ts that it resolves. For more information about Autofac, see [Autofac](http://autofac.readthedocs.io\", \"/en/latest/index.html) on readthedocs.io.\\n\\nIn Autofac, the IContainer interface provides the depende\", \"ncy injection container. Figure 3-1 shows the dependencies when using this container, which instanti\", \"ates an IOrderService object and injects it into the ProfileViewModel class.\\n\\n![](_page_25_Figure_11\", \".jpeg)\\n\\n**Figure 3-1:** Dependencies when using dependency injection\\n\\nAt runtime, the container must\", \" know which implementation of the IOrderService interface it should instantiate, before it can insta\", \"ntiate a ProfileViewModel object. This involves:\\n\\n- The container deciding how to instantiate an obj\", \"ect that implements the IOrderService interface. This is known as *registration*.\\n- The container in\", \"stantiating the object that implements the IOrderService interface, and the ProfileViewModel object.\", \" This is known as *resolution*.\\n\\nEventually, the app will finish using the ProfileViewModel object a\", \"nd it will become available for garbage collection. At this point, the garbage collector should disp\", \"ose of the IOrderService instance if other classes do not share the same instance.\\n\\n**Tip:** Write c\", \"ontainer-agnostic code\\n\\nAlways try to write container-agnostic code to decouple the app from the spe\", \"cific dependency container being used.\\n\\n# Registration\\n\\nBefore dependencies can be injected into an \", \"object, the types of the dependencies must first be registered with the container. Registering a typ\", \"e typically involves passing the container an interface and a concrete type that implements the inte\", \"rface.\\n\\nThere are two ways of registering types and objects in the container through code:\\n\\n- Regist\", \"er a type or mapping with the container. When required, the container will build an instance of the \", \"specified type.\\n- Register an existing object in the container as a singleton. When required, the co\", \"ntainer will return a reference to the existing object.\\n\\n**Tip:** Dependency injection containers ar\", \"e not always suitable\\n\\nDependency injection introduces additional complexity and requirements that m\", \"ight not be appropriate or useful to small apps. If a class does not have any dependencies, or is no\", \"t a dependency for other types, it might not make sense to put it in the container. In addition, if \", \"a class has a single set of dependencies that are integral to the type and will never change, it mig\", \"ht not make sense to put it in the container.\\n\\nThe registration of types that require dependency inj\", \"ection should be performed in a single method in an app, and this method should be invoked early in \", \"the app's lifecycle to ensure that the app is aware of the dependencies between its classes. In the \", \"eShopOnContainers mobile app this is performed by the ViewModelLocator class, which builds the ICont\", \"ainer object and is the only class in the app that holds a reference to that object. The following c\", \"ode example shows how the eShopOnContainers mobile app declares the IContainer object in the ViewMod\", \"elLocator class:\\n\\n```\\nprivate static IContainer _container;\\n```\\n\\nTypes and instances are registered \", \"in the RegisterDependencies method in the ViewModelLocator class. This is achieved by first creating\", \" a ContainerBuilder instance, which is demonstrated in the following code example:\\n\\n```\\nvar builder \", \"= new ContainerBuilder();\\n```\\n\\nTypes and instances are then registered with the ContainerBuilder obj\", \"ect, and the following code example demonstrates the most common form of type registration:\\n\\n```\\nbui\", \"lder.RegisterType<RequestProvider>().As<IRequestProvider>();\\n```\\n\\nThe RegisterType method shown here\", \" maps an interface type to a concrete type. It tells the container to instantiate a RequestProvider \", \"object when it instantiates an object that requires an injection of an IRequestProvider through a co\", \"nstructor.\\n\\nConcrete types can also be registered directly without a mapping from an interface type,\", \" as shown in the following code example:\\n\\n```\\nbuilder.RegisterType<ProfileViewModel>();\\n```\\n\\nWhen th\", \"e ProfileViewModel type is resolved, the container will inject its required dependencies.\\n\\nAutofac a\", \"lso allows instance registration, where the container is responsible for maintaining a reference to \", \"a singleton instance of a type. For example, the following code example shows how the eShopOnContain\", \"ers mobile app registers the concrete type to use when a ProfileViewModel instance requires an IOrde\", \"rService instance:\\n\\n```\\nbuilder.RegisterType<OrderService>().As<IOrderService>().SingleInstance();\\n`\", \"``\\n\\nThe RegisterType method shown here maps an interface type to a concrete type. The SingleInstance\", \" method configures the registration so that every dependent object receives the same shared instance\", \". Therefore, only a single OrderService instance will exist in the container, which is shared by obj\", \"ects that require an injection of an IOrderService through a constructor.\\n\\nInstance registration can\", \" also be performed with the RegisterInstance method, which is demonstrated in the following code exa\", \"mple:\\n\\n```\\nbuilder.RegisterInstance(new OrderMockService()).As<IOrderService>();\\n```\\n\\nThe RegisterIn\", \"stance method shown here creates a new OrderMockService instance and registers it with the container\", \". Therefore, only a single OrderMockService instance exists in the container, which is shared by obj\", \"ects that require an injection of an IOrderService through a constructor.\\n\\nFollowing type and instan\", \"ce registration, the IContainer object must be built, which is demonstrated in the following code ex\", \"ample:\\n\\n```\\n_container = builder.Build();\\n```\\n\\nInvoking the Build method on the ContainerBuilder ins\", \"tance builds a new dependency injection container that contains the registrations that have been mad\", \"e.\\n\\n```\\nTip: Consider an IContainer as being immutable\\n```\\n\\nWhile Autofac provides an Update method \", \"to update registrations in an existing container, calling this method should be avoided where possib\", \"le. There are risks to modifying a container after it's been built, particularly if the container ha\", \"s been used. For more information, see [Consider a](http://docs.autofac.org/en/latest/best-practices\", \"/#consider-a-container-as-immutable)  [Container as Immutable](http://docs.autofac.org/en/latest/bes\", \"t-practices/#consider-a-container-as-immutable) on readthedocs.io.\\n\\n# <span id=\\\"page-28-0\\\"></span>Re\", \"solution\\n\\nAfter a type is registered, it can be resolved or injected as a dependency. When a type is\", \" being resolved and the container needs to create a new instance, it injects any dependencies into t\", \"he instance.\\n\\nGenerally, when a type is resolved, one of three things happens:\\n\\n- **1.** If the type\", \" hasn't been registered, the container throws an exception.\\n- **2.** If the type has been registered\", \" as a singleton, the container returns the singleton instance. If this is the first time the type is\", \" called for, the container creates it if required, and maintains a reference to it.\\n- **3.** If the \", \"type hasn't been registered as a singleton, the container returns a new instance, and doesn't mainta\", \"in a reference to it.\\n\\nThe following code example shows how the RequestProvider type that was previo\", \"usly registered with Autofac can be resolved:\\n\\n```\\nvar requestProvider = _container.Resolve<IRequest\", \"Provider>();\\n```\\n\\nIn this example, Autofac is asked to resolve the concrete type for the IRequestPro\", \"vider type, along with any dependencies. Typically, the Resolve method is called when an instance of\", \" a specific type is required. For information about controlling the lifetime of resolved objects, se\", \"e [Managing the lifetime](#page-28-1)  [of resolved objects.](#page-28-1)\\n\\nThe following code exampl\", \"e shows how the eShopOnContainers mobile app instantiates view model types and their dependencies:\\n\\n\", \"```\\nvar viewModel = _container.Resolve(viewModelType);\\n```\\n\\nIn this example, Autofac is asked to res\", \"olve the view model type for a requested view model, and the container will also resolve any depende\", \"ncies. When resolving the ProfileViewModel type, the dependency to resolve is an IOrderService objec\", \"t. Therefore, Autofac first constructs an OrderService object and then passes it to the constructor \", \"of the ProfileViewModel class. For more information about how the eShopOnContainers mobile app const\", \"ructs view models and associates them to views, se[e Automatically creating a view model with a view\", \" model locator.](#page-17-0)\\n\\n**Note:** Registering and resolving types with a container has a perfo\", \"rmance cost because of the container's use of reflection for creating each type, especially if depen\", \"dencies are being reconstructed for each page navigation in the app. If there are many or deep depen\", \"dencies, the cost of creation can increase significantly.\\n\\n# <span id=\\\"page-28-1\\\"></span>Managing th\", \"e lifetime of resolved objects\\n\\nAfter registering a type, the default behavior for Autofac is to cre\", \"ate a new instance of the registered type each time the type is resolved, or when the dependency mec\", \"hanism injects instances into other classes. In this scenario, the container doesn't hold a referenc\", \"e to the resolved object. However, when registering an instance, the default behavior for Autofac is\", \" to manage the lifetime of the object as a singleton. Therefore, the instance remains in scope while\", \" the container is in scope, and is disposed when the container goes out of scope and is garbage coll\", \"ected, or when code explicitly disposes the container.\\n\\nAn Autofac instance scope can be used to spe\", \"cify the singleton behavior for an object that Autofac creates from a registered type. Autofac insta\", \"nce scopes manage the object lifetimes instantiated by the container. The default instance scope for\", \" the RegisterType method is the InstancePerDependency scope. However, the SingleInstance scope can b\", \"e used with the RegisterType method, so that the container creates or returns a singleton instance o\", \"f a type when calling the Resolve method. The following code example shows how Autofac is instructed\", \" to create a singleton instance of the NavigationService class:\\n\\nbuilder.RegisterType<NavigationServ\", \"ice>().As<INavigationService>().SingleInstance();\\n\\nThe first time that the INavigationService interf\", \"ace is resolved, the container creates a new NavigationService object and maintains a reference to i\", \"t. On any subsequent resolutions of the INavigationService interface, the container returns a refere\", \"nce to the NavigationService object that was previously created.\\n\\n**Note:** The SingleInstance scope\", \" disposes created objects when the container is disposed.\\n\\nAutofac includes additional instance scop\", \"es. For more information, see [Instance Scope](http://autofac.readthedocs.io/en/latest/lifetime/inst\", \"ance-scope.html) on readthedocs.io.\\n\\n# Summary\\n\\nDependency injection enables decoupling of concrete \", \"types from the code that depends on these types. It typically uses a container that holds a list of \", \"registrations and mappings between interfaces and abstract types, and the concrete types that implem\", \"ent or extend these types.\\n\\nAutofac facilitates building loosely coupled apps, and provides all of t\", \"he features commonly found in dependency injection containers, including methods to register type ma\", \"ppings and object instances, resolve objects, manage object lifetimes, and inject dependent objects \", \"into constructors of objects it resolves.\\n\\n# <span id=\\\"page-30-0\\\"></span>Communicating between loose\", \"ly coupled components\\n\\nThe publish-subscribe pattern is a messaging pattern in which publishers send\", \" messages without having knowledge of any receivers, known as subscribers. Similarly, subscribers li\", \"sten for specific messages, without having knowledge of any publishers.\\n\\nEvents in .NET implement th\", \"e publish-subscribe pattern, and are the most simple and straightforward approach for a communicatio\", \"n layer between components if loose coupling is not required, such as a control and the page that co\", \"ntains it. However, the publisher and subscriber lifetimes are coupled by object references to each \", \"other, and the subscriber type must have a reference to the publisher type. This can create memory m\", \"anagement issues, especially when there are short lived objects that subscribe to an event of a stat\", \"ic or long-lived object. If the event handler isn't removed, the subscriber will be kept alive by th\", \"e reference to it in the publisher, and this will prevent or delay the garbage collection of the sub\", \"scriber.\\n\\n# Introduction to MessagingCenter\\n\\nThe Xamarin.Forms MessagingCenter class implements the \", \"publish-subscribe pattern, allowing message-based communication between components that are inconven\", \"ient to link by object and type references. This mechanism allows publishers and subscribers to comm\", \"unicate without having a reference to each other, helping to reduce dependencies between components,\", \" while also allowing components to be independently developed and tested.\\n\\nThe MessagingCenter class\", \" provides multicast publish-subscribe functionality. This means that there can be multiple publisher\", \"s that publish a single message, and there can be multiple subscribers listening for the same messag\", \"e. Figure 4-1 illustrates this relationship:\\n\\n![](_page_31_Figure_0.jpeg)\\n\\n**Figure 4-1:** Multicast\", \" publish-subscribe functionality\\n\\nPublishers send messages using the MessagingCenter.Send method, wh\", \"ile subscribers listen for messages using the MessagingCenter.Subscribe method. In addition, subscri\", \"bers can also unsubscribe from message subscriptions, if required, with the MessagingCenter.Unsubscr\", \"ibe method.\\n\\nInternally, the MessagingCenter class uses weak references. This means that it will not\", \" keep objects alive, and will allow them to be garbage collected. Therefore, it should only be neces\", \"sary to unsubscribe from a message when a class no longer wishes to receive the message.\\n\\nThe eShopO\", \"nContainers mobile app uses the MessagingCenter class to communicate between loosely coupled compone\", \"nts. The app defines three messages:\\n\\n- The AddProduct message is published by the CatalogViewModel \", \"class when an item is added to the shopping basket. In return, the BasketViewModel class subscribes \", \"to the message and increments the number of items in the shopping basket in response. In addition, t\", \"he BasketViewModel class also unsubscribes from this message.\\n- The Filter message is published by t\", \"he CatalogViewModel class when the user applies a brand or type filter to the items displayed from t\", \"he catalogue. In return, the CatalogView class subscribes to the message and updates the UI so that \", \"only items that match the filter criteria are displayed.\\n- The ChangeTab message is published by the\", \" MainViewModel class when the CheckoutViewModel navigates to the MainViewModel following the success\", \"ful creation and submission of a new order. In return, the MainView class subscribes to the message \", \"and updates the UI so that the **My profile** tab is active, to show the user's orders.\\n\\n**Note:** W\", \"hile the MessagingCenter class permits communication between loosely-coupled classes, it does not of\", \"fer the only architectural solution to this issue. For example, communication between a view model a\", \"nd a view can also be achieved by the binding engine and through property change notifications. In a\", \"ddition, communication between two view models can also be achieved by passing data during navigatio\", \"n.\\n\\nIn the eShopOnContainers mobile app, MessagingCenter is used to update in the UI in response to \", \"an action occurring in another class. Therefore, messages are published on the UI thread, with subsc\", \"ribers receiving the message on the same thread.\\n\\n**Tip:** Marshal to the UI thread when performing \", \"UI updates\\n\\nIf a message that's sent from a background thread is required to update the UI, process \", \"the message on the UI thread in the subscriber by invoking the Device.BeginInvokeOnMainThread method\", \".\\n\\nFor more information about MessagingCenter, see [MessagingCenter](https://developer.xamarin.com/g\", \"uides/xamarin-forms/application-fundamentals/messaging-center/) on the Xamarin Developer Center.\\n\\n# \", \"Defining a message\\n\\nMessagingCenter messages are strings that are used to identify messages. The fol\", \"lowing code example shows the messages defined within the eShopOnContainers mobile app:\\n\\n```\\npublic \", \"class MessengerKeys\\n{\\n // Add product to basket\\n public const string AddProduct = \\\"AddProduct\\\";\\n // \", \"Filter\\n public const string Filter = \\\"Filter\\\";\\n // Change selected Tab programmatically\\n public cons\", \"t string ChangeTab = \\\"ChangeTab\\\";\\n}\\n```\\n\\nIn this example, messages are defined using constants. The \", \"advantage of this approach is that it provides compile-time type safety and refactoring support.\\n\\n# \", \"Publishing a message\\n\\nPublishers notify subscribers of a message with one of the MessagingCenter.Sen\", \"d overloads. The following code example demonstrates publishing the AddProduct message:\\n\\n```\\nMessagi\", \"ngCenter.Send(this, MessengerKeys.AddProduct, catalogItem);\\n```\\n\\nIn this example, the Send method sp\", \"ecifies three arguments:\\n\\n- The first argument specifies the sender class. The sender class must be \", \"specified by any subscribers who wish to receive the message.\\n- The second argument specifies the me\", \"ssage.\\n- The third argument specifies the payload data to be sent to the subscriber. In this case th\", \"e payload data is a CatalogItem instance.\\n\\nThe Send method will publish the message, and its payload\", \" data, using a fire-and-forget approach. Therefore, the message is sent even if there are no subscri\", \"bers registered to receive the message. In this situation, the sent message is ignored.\\n\\n**Note:** T\", \"he MessagingCenter.Send method can use generic parameters to control how messages are delivered. The\", \"refore, multiple messages that share a message identity but send different payload data types can be\", \" received by different subscribers.\\n\\n# Subscribing to a message\\n\\nSubscribers can register to receive\", \" a message using one of the MessagingCenter.Subscribe overloads. The following code example demonstr\", \"ates how the eShopOnContainers mobile app subscribes to, and processes, the AddProduct message:\\n\\n```\", \"\\nMessagingCenter.Subscribe<CatalogViewModel, CatalogItem>(\\n this, MessageKeys.AddProduct, async (sen\", \"der, arg) =>\\n{\\n BadgeCount++;\\n await AddCatalogItemAsync(arg);\\n});\\n```\\n\\nIn this example, the Subscri\", \"be method subscribes to the AddProduct message, and executes a callback delegate in response to rece\", \"iving the message. This callback delegate, specified as a lambda expression, executes code that upda\", \"tes the UI.\\n\\n**Tip:** Consider using immutable payload data\\n\\nDon't attempt to modify the payload dat\", \"a from within a callback delegate because several threads could be accessing the received data simul\", \"taneously. In this scenario, the payload data should be immutable to avoid concurrency errors.\\n\\nA su\", \"bscriber might not need to handle every instance of a published message, and this can be controlled \", \"by the generic type arguments that are specified on the Subscribe method. In this example, the subsc\", \"riber will only receive AddProduct messages that are sent from the CatalogViewModel class, whose pay\", \"load data is a CatalogItem instance.\\n\\n# Unsubscribing from a message\\n\\nSubscribers can unsubscribe fr\", \"om messages they no longer want to receive. This is achieved with one of the MessagingCenter.Unsubsc\", \"ribe overloads, as demonstrated in the following code example:\\n\\n```\\nMessagingCenter.Unsubscribe<Cata\", \"logViewModel, CatalogItem>(this, MessengerKeys.AddProduct);\\n```\\n\\nIn this example, the Unsubscribe me\", \"thod syntax reflects the type arguments specified when subscribing to receive the AddProduct message\", \".\\n\\n# Summary\\n\\nThe Xamarin.Forms MessagingCenter class implements the publish-subscribe pattern, allo\", \"wing message-based communication between components that are inconvenient to link by object and type\", \" references. This mechanism allows publishers and subscribers to communicate without having a refere\", \"nce to each other, helping to reduce dependencies between components, while also allowing components\", \" to be independently developed and tested.\\n\\n# <span id=\\\"page-34-0\\\"></span>Navigation\\n\\nXamarin.Forms \", \"includes support for page navigation, which typically results from the user's interaction with the U\", \"I or from the app itself as a result of internal logic-driven state changes. However, navigation can\", \" be complex to implement in apps that use the Model-View-ViewModel (MVVM) pattern, as the following \", \"challenges must be met:\\n\\n- How to identify the view to be navigated to, using an approach that does \", \"not introduce tight coupling and dependencies between views.\\n- How to coordinate the process by whic\", \"h the view to be navigated to is instantiated and initialized. When using MVVM, the view and view mo\", \"del need to be instantiated and associated with each other via the view's binding context. When an a\", \"pp is using a dependency injection container, the instantiation of views and view models might requi\", \"re a specific construction mechanism.\\n- Whether to perform view-first navigation, or view model-firs\", \"t navigation. With view-first navigation, the page to navigate to refers to the name of the view typ\", \"e. During navigation, the specified view is instantiated, along with its corresponding view model an\", \"d other dependent services. An alternative approach is to use view model-first navigation, where the\", \" page to navigate to refers to the name of the view model type.\\n- How to cleanly separate the naviga\", \"tional behavior of the app across the views and view models. The MVVM pattern provides a separation \", \"between the app's UI and its presentation and business logic. However, the navigation behavior of an\", \" app will often span the UI and presentations parts of the app. The user will often initiate navigat\", \"ion from a view, and the view will be replaced as a result of the navigation. However, navigation mi\", \"ght often also need to be initiated or coordinated from within the view model.\\n- How to pass paramet\", \"ers during navigation for initialization purposes. For example, if the user navigates to a view to u\", \"pdate order details, the order data will have to be passed to the view so that it can display the co\", \"rrect data.\\n- How to co-ordinate navigation, to ensure that certain business rules are obeyed. For e\", \"xample, users might be prompted before navigating away from a view so that they can correct any inva\", \"lid data or be prompted to submit or discard any data changes that were made within the view.\\n\\nThis \", \"chapter addresses these challenges by presenting a NavigationService class that's used to perform vi\", \"ew model-first page navigation.\\n\\n**Note:** The NavigationService used by the app is designed only to\", \" perform hierarchical navigation between ContentPage instances. Using the service to navigate betwee\", \"n other page types might result in unexpected behavior.\\n\\n# Navigating between pages\\n\\nNavigation logi\", \"c can reside in a view's code-behind, or in a data bound view model. While placing navigation logic \", \"in a view might be the simplest approach, it is not easily testable through unit tests. Placing navi\", \"gation logic in view model classes means that the logic can be exercised through unit tests. In addi\", \"tion, the view model can then implement logic to control navigation to ensure that certain business \", \"rules are enforced. For example, an app might not allow the user to navigate away from a page withou\", \"t first ensuring that the entered data is valid.\\n\\nA NavigationService class is typically invoked fro\", \"m view models, in order to promote testability. However, navigating to views from view models would \", \"require the view models to reference views, and particularly views that the active view model isn't \", \"associated with, which is not recommended. Therefore, the NavigationService presented here specifies\", \" the view model type as the target to navigate to.\\n\\nThe eShopOnContainers mobile app uses the Naviga\", \"tionService class to provide view model-first navigation. This class implements the INavigationServi\", \"ce interface, which is shown in the following code example:\\n\\n```\\npublic interface INavigationService\", \"\\n{\\n ViewModelBase PreviousPageViewModel { get; }\\n Task InitializeAsync();\\n Task NavigateToAsync<TVie\", \"wModel>() where TViewModel : ViewModelBase;\\n Task NavigateToAsync<TViewModel>(object parameter) wher\", \"e TViewModel : ViewModelBase;\\n Task RemoveLastFromBackStackAsync();\\n Task RemoveBackStackAsync();\\n}\\n\", \"```\\n\\nThis interface specifies that an implementing class must provide the following methods:\\n\\n| Meth\", \"od                             | Purpose                                                       |\\n|--\", \"----------------------------------|---------------------------------------------------------------|\\n\", \"| InitializeAsync                    | Performs navigation to one of two pages when the app is      \", \" |\\n|                                    | launched.                                                 \", \"    |\\n| NavigateToAsync <t></t>            | Performs hierarchical navigation to a specified page.  \", \"       |\\n| NavigateToAsync <t>(parameter)</t> | Performs hierarchical navigation to a specified page\", \", passing |\\n|                                    | a parameter.                                     \", \"             |\\n| RemoveLastFromBackStackAsync       | Removes the previous page from the navigation \", \"stack.          |\\n| RemoveBackStackAsync               | Removes all the previous pages from the nav\", \"igation stack.     |\\n\\nIn addition, the INavigationService interface specifies that an implementing c\", \"lass must provide a PreviousPageViewModel property. This property returns the view model type associ\", \"ated with the previous page in the navigation stack.\\n\\n**Note:** An INavigationService interface woul\", \"d usually also specify a GoBackAsync method, which is used to programmatically return to the previou\", \"s page in the navigation stack. However, this method is missing from the eShopOnContainers mobile ap\", \"p because it's not required.\\n\\n## **Creating the NavigationService instance**\\n\\nThe NavigationService \", \"class, which implements the INavigationService interface, is registered as a singleton with the Auto\", \"fac dependency injection container, as demonstrated in the following code example:\\n\\n```\\nbuilder.Regi\", \"sterType<NavigationService>().As<INavigationService>().SingleInstance();\\n```\\n\\nThe INavigationService\", \" interface is resolved in the ViewModelBase class constructor, as demonstrated in the following code\", \" example:\\n\\n```\\nNavigationService = ViewModelLocator.Resolve<INavigationService>();\\n```\\n\\nThis returns\", \" a reference to the NavigationService object that's stored in the Autofac dependency injection conta\", \"iner, which is created by the InitNavigation method in the App class. For more information, se[e Nav\", \"igating when the app is launched.](#page-38-0)\\n\\nThe ViewModelBase class stores the NavigationService\", \" instance in a NavigationService property, of type INavigationService. Therefore, all view model cla\", \"sses, which derive from the ViewModelBase class, can use the NavigationService property to access th\", \"e methods specified by the INavigationService interface. This avoids the overhead of injecting the N\", \"avigationService object from the Autofac dependency injection container into each view model class.\\n\", \"\\n### **Handling navigation requests**\\n\\nXamarin.Forms provides the NavigationPage class, which implem\", \"ents a hierarchical navigation experience in which the user is able to navigate through pages, forwa\", \"rds and backwards, as desired. For more information about hierarchical navigation, see [Hierarchical\", \" Navigation](https://developer.xamarin.com/guides/xamarin-forms/application-fundamentals/navigation/\", \"hierarchical/) on the Xamarin Developer Center.\\n\\nRather than use the NavigationPage class directly, \", \"the eShopOnContainers app wraps the NavigationPage class in the CustomNavigationView class, as shown\", \" in the following code example:\\n\\n```\\npublic partial class CustomNavigationView : NavigationPage\\n{\\n p\", \"ublic CustomNavigationView() : base()\\n {\\n InitializeComponent();\\n }\\n public CustomNavigationView(Pag\", \"e root) : base(root)\\n {\\n InitializeComponent();\\n }\\n}\\n```\\n\\nThe purpose of this wrapping is for ease o\", \"f styling the NavigationPage instance inside the XAML file for the class.\\n\\nNavigation is performed i\", \"nside view model classes by invoking one of the NavigateToAsync methods, specifying the view model t\", \"ype for the page being navigated to, as demonstrated in the following code example:\\n\\n```\\nawait Navig\", \"ationService.NavigateToAsync<MainViewModel>();\\n```\\n\\nThe following code example shows the NavigateToA\", \"sync methods provided by the NavigationService class:\\n\\n```\\npublic Task NavigateToAsync<TViewModel>()\", \" where TViewModel : ViewModelBase\\n{\\n return InternalNavigateToAsync(typeof(TViewModel), null);\\n}\\npub\", \"lic Task NavigateToAsync<TViewModel>(object parameter) where TViewModel : ViewModelBase\\n{\\n return In\", \"ternalNavigateToAsync(typeof(TViewModel), parameter);\\n}\\n```\\n\\nEach method allows any view model class\", \" that derives from the ViewModelBase class to perform hierarchical navigation by invoking the Intern\", \"alNavigateToAsync method. In addition, the second NavigateToAsync method enables navigation data to \", \"be specified as an argument that's passed to the view model being navigated to, where it's typically\", \" used to perform initialization. For more information, se[e Passing parameters during navigation.](#\", \"page-39-0)\\n\\nThe InternalNavigateToAsync method executes the navigation request, and is shown in the \", \"following code example:\\n\\n```\\nprivate async Task InternalNavigateToAsync(Type viewModelType, object p\", \"arameter)\\n{\\n Page page = CreatePage(viewModelType, parameter);\\n if (page is LoginView)\\n {\\n Applicati\", \"on.Current.MainPage = new CustomNavigationView(page);\\n }\\n else\\n {\\n var navigationPage = Application.\", \"Current.MainPage as CustomNavigationView;\\n if (navigationPage != null)\\n {\\n await navigationPage.Push\", \"Async(page);\\n }\\n else\\n {\\n Application.Current.MainPage = new CustomNavigationView(page);\\n }\\n }\\n awai\", \"t (page.BindingContext as ViewModelBase).InitializeAsync(parameter);\\n}\\nprivate Type GetPageTypeForVi\", \"ewModel(Type viewModelType)\\n{\\n var viewName = viewModelType.FullName.Replace(\\\"Model\\\", string.Empty);\", \"\\n var viewModelAssemblyName = viewModelType.GetTypeInfo().Assembly.FullName;\\n var viewAssemblyName =\", \" string.Format(\\n CultureInfo.InvariantCulture, \\\"{0}, {1}\\\", viewName, viewModelAssemblyName);\\n var vi\", \"ewType = Type.GetType(viewAssemblyName);\\n return viewType;\\n}\\nprivate Page CreatePage(Type viewModelT\", \"ype, object parameter)\\n{\\n Type pageType = GetPageTypeForViewModel(viewModelType);\\n if (pageType == n\", \"ull)\\n {\\n throw new Exception($\\\"Cannot locate page type for {viewModelType}\\\");\\n }\\n```\\n\\n```\\n Page page\", \" = Activator.CreateInstance(pageType) as Page;\\n return page;\\n}\\n```\\n\\nThe InternalNavigateToAsync meth\", \"od performs navigation to a view model by first calling the CreatePage method. This method locates t\", \"he view that corresponds to the specified view model type, and creates and returns an instance of th\", \"is view type. Locating the view that corresponds to the view model type uses a convention-based appr\", \"oach, which assumes that:\\n\\n- Views are in the same assembly as view model types.\\n- Views are in a .V\", \"iews child namespace.\\n- View models are in a .ViewModels child namespace.\\n- View names correspond to\", \" view model names, with \\\"Model\\\" removed.\\n\\nWhen a view is instantiated, it's associated with its corr\", \"esponding view model. For more information about how this occurs, see [Automatically creating a view\", \" model with a view model locator.](#page-17-0)\\n\\nIf the view being created is a LoginView, it's wrapp\", \"ed inside a new instance of the CustomNavigationView class and assigned to the Application.Current.M\", \"ainPage property. Otherwise, the CustomNavigationView instance is retrieved, and provided that it is\", \"n't null, the PushAsync method is invoked to push the view being created onto the navigation stack. \", \"However, If the retrieved CustomNavigationView instance is null, the view being created is wrapped i\", \"nside a new instance of the CustomNavigationView class and assigned to the Application.Current.MainP\", \"age property. This mechanism ensures that during navigation, pages are added correctly to the naviga\", \"tion stack both when it's empty, and when it contains data.\\n\\n#### **Tip:** Consider caching pages\\n\\nP\", \"age caching results in memory consumption for views that are not currently displayed. However, witho\", \"ut page caching it does mean that XAML parsing and construction of the page and its view model will \", \"occur every time a new page is navigated to, which can have a performance impact for a complex page.\", \" For a well-designed page that does not use an excessive number of controls, the performance should \", \"be sufficient. However, page caching might help if slow page loading times are encountered.\\n\\nAfter t\", \"he view is created and navigated to, the InitializeAsync method of the view's associated view model \", \"is executed. For more information, see [Passing parameters during navigation.](#page-39-0)\\n\\n## <span\", \" id=\\\"page-38-0\\\"></span>**Navigating when the app is launched**\\n\\nWhen the app is launched, the InitNa\", \"vigation method in the App class is invoked. The following code example shows this method:\\n\\n```\\npriv\", \"ate Task InitNavigation()\\n{\\n var navigationService = ViewModelLocator.Resolve<INavigationService>();\", \"\\n return navigationService.InitializeAsync();\\n}\\n```\\n\\nThe method creates a new NavigationService obje\", \"ct in the Autofac dependency injection container, and returns a reference to it, before invoking its\", \" InitializeAsync method.\\n\\n**Note:** When the INavigationService interface is resolved by the ViewMod\", \"elBase class, the container returns a reference to the NavigationService object that was created whe\", \"n the InitNavigation method is invoked.\\n\\nThe following code example shows the NavigationService Init\", \"ializeAsync method:\\n\\n```\\npublic Task InitializeAsync()\\n{\\n if (string.IsNullOrEmpty(Settings.AuthAcce\", \"ssToken))\\n return NavigateToAsync<LoginViewModel>();\\n else\\n return NavigateToAsync<MainViewModel>();\", \"\\n}\\n```\\n\\nThe MainView is navigated to if the app has a cached access token, which is used for authent\", \"ication. Otherwise, the LoginView is navigated to.\\n\\nFor more information about the Autofac dependenc\", \"y injection container, see [Introduction to](#page-24-1)  [dependency injection.](#page-24-1)\\n\\n### <\", \"span id=\\\"page-39-0\\\"></span>**Passing parameters during navigation**\\n\\nOne of the NavigateToAsync meth\", \"ods, specified by the INavigationService interface, enables navigation data to be specified as an ar\", \"gument that's passed to the view model being navigated to, where it's typically used to perform init\", \"ialization.\\n\\nFor example, the ProfileViewModel class contains an OrderDetailCommand that's executed \", \"when the user selects an order on the ProfileView page. In turn, this executes the OrderDetailAsync \", \"method, which is shown in the following code example:\\n\\n```\\nprivate async Task OrderDetailAsync(Order\", \" order)\\n{\\n await NavigationService.NavigateToAsync<OrderDetailViewModel>(order);\\n}\\n```\\n\\nThis method \", \"invokes navigation to the OrderDetailViewModel, passing an Order instance that represents the order \", \"that the user selected on the ProfileView page. When the NavigationService class creates the OrderDe\", \"tailView, the OrderDetailViewModel class is instantiated and assigned to the view's BindingContext. \", \"After navigating to the OrderDetailView, the InternalNavigateToAsync method executes the InitializeA\", \"sync method of the view's associated view model.\\n\\nThe InitializeAsync method is defined in the ViewM\", \"odelBase class as a method that can be overridden. This method specifies an object argument that rep\", \"resents the data to be passed to a view model during a navigation operation. Therefore, view model c\", \"lasses that want to receive data from a navigation operation provide their own implementation of the\", \" InitializeAsync method to perform the required initialization. The following code example shows the\", \" InitializeAsync method from the OrderDetailViewModel class:\\n\\n```\\npublic override async Task Initial\", \"izeAsync(object navigationData)\\n{\\n if (navigationData is Order)\\n {\\n ...\\n Order = await _ordersServic\", \"e.GetOrderAsync(\\n Convert.ToInt32(order.OrderNumber), authToken);\\n```\\n\\n```\\n ...\\n }\\n}\\n```\\n\\nThis metho\", \"d retrieves the Order instance that was passed into the view model during the navigation operation, \", \"and uses it to retrieve the full order details from the OrderService instance.\\n\\n## <span id=\\\"page-40\", \"-0\\\"></span>**Invoking navigation using behaviors**\\n\\nNavigation is usually triggered from a view by a\", \" user interaction. For example, the LoginView performs navigation following successful authenticatio\", \"n. The following code example shows how the navigation is invoked by a behavior:\\n\\n```\\n<WebView ...>\\n\", \" <WebView.Behaviors>\\n <behaviors:EventToCommandBehavior\\n EventName=\\\"Navigating\\\"\\n EventArgsConverter=\", \"\\\"{StaticResource WebNavigatingEventArgsConverter}\\\"\\n Command=\\\"{Binding NavigateCommand}\\\" />\\n </WebVie\", \"w.Behaviors>\\n</WebView>\\n```\\n\\nAt runtime, the EventToCommandBehavior will respond to interaction with\", \" the WebView. When the WebView navigates to a web page, the Navigating event will fire, which will e\", \"xecute the NavigateCommand in the LoginViewModel. By default, the event arguments for the event are \", \"passed to the command. This data is converted as it's passed between source and target by the conver\", \"ter specified in the EventArgsConverter property, which returns the Url from the WebNavigatingEventA\", \"rgs. Therefore, when the NavigationCommand is executed, the Url of the web page is passed as a param\", \"eter to the registered Action.\\n\\nIn turn, the NavigationCommand executes the NavigateAsync method, wh\", \"ich is shown in the following code example:\\n\\n```\\nprivate async Task NavigateAsync(string url)\\n{\\n ...\", \" \\n await NavigationService.NavigateToAsync<MainViewModel>();\\n await NavigationService.RemoveLastFrom\", \"BackStackAsync();\\n ...\\n}\\n```\\n\\nThis method invokes navigation to the MainViewModel, and following nav\", \"igation, removes the LoginView page from the navigation stack.\\n\\n## **Confirming or cancelling naviga\", \"tion**\\n\\nAn app might need to interact with the user during a navigation operation, so that the user \", \"can confirm or cancel navigation. This might be necessary, for example, when the user attempts to na\", \"vigate before having fully completed a data entry page. In this situation, an app should provide a n\", \"otification that allows the user to navigate away from the page, or to cancel the navigation operati\", \"on before it occurs. This can be achieved in a view model class by using the response from a notific\", \"ation to control whether or not navigation is invoked.\\n\\n# Summary\\n\\nXamarin.Forms includes support fo\", \"r page navigation, which typically results from the user's interaction with the UI, or from the app \", \"itself, as a result of internal logic-driven state changes. However, navigation can be complex to im\", \"plement in apps that use the MVVM pattern.\\n\\nThis chapter presented a NavigationService class, which \", \"is used to perform view model-first navigation from view models. Placing navigation logic in view mo\", \"del classes means that the logic can be exercised through automated tests. In addition, the view mod\", \"el can then implement logic to control navigation to ensure that certain business rules are enforced\", \".\\n\\n# <span id=\\\"page-42-0\\\"></span>Validation\\n\\nAny app that accepts input from users should ensure tha\", \"t the input is valid. An app could, for example, check for input that contains only characters in a \", \"particular range, is of a certain length, or matches a particular format. Without validation, a user\", \" can supply data that causes the app to fail. Validation enforces business rules, and prevents an at\", \"tacker from injecting malicious data.\\n\\nIn the context of the Model-ViewModel-Model (MVVM) pattern, a\", \" view model or model will often be required to perform data validation and signal any validation err\", \"ors to the view so that the user can correct them. The eShopOnContainers mobile app performs synchro\", \"nous client-side validation of view model properties and notifies the user of any validation errors \", \"by highlighting the control that contains the invalid data, and by displaying error messages that in\", \"form the user of why the data is invalid. Figure 6-1 shows the classes involved in performing valida\", \"tion in the eShopOnContainers mobile app.\\n\\n![](_page_42_Figure_5.jpeg)\\n\\n**Figure 6-1**: Validation c\", \"lasses in the eShopOnContainers mobile app\\n\\nView model properties that require validation are of typ\", \"e ValidatableObject<T>, and each ValidatableObject<T> instance has validation rules added to its Val\", \"idations property. Validation is invoked from the view model by calling the Validate method of the V\", \"alidatableObject<T>\\n\\ninstance, which retrieves the validation rules and executes them against the Va\", \"lidatableObject<T> Value property. Any validation errors are placed into the Errors property of the \", \"ValidatableObject<T> instance, and the IsValid property of the ValidatableObject<T> instance is upda\", \"ted to indicate whether validation succeeded or failed.\\n\\nProperty change notification is provided by\", \" the ExtendedBindableObject class, and so an Entry control can bind to the IsValid property of Valid\", \"atableObject<T> instance in the view model class to be notified of whether or not the entered data i\", \"s valid.\\n\\n# Specifying validation rules\\n\\nValidation rules are specified by creating a class that der\", \"ives from the IValidationRule<T> interface, which is shown in the following code example:\\n\\n```\\npubli\", \"c interface IValidationRule<T>\\n{\\n string ValidationMessage { get; set; }\\n bool Check(T value);\\n}\\n```\", \"\\n\\nThis interface specifies that a validation rule class must provide a boolean Check method that is \", \"used to perform the required validation, and a ValidationMessage property whose value is the validat\", \"ion error message that will be displayed if validation fails.\\n\\nThe following code example shows the \", \"IsNotNullOrEmptyRule<T> validation rule, which is used to perform validation of the username and pas\", \"sword entered by the user on the LoginView when using mock services in the eShopOnContainers mobile \", \"app:\\n\\n```\\npublic class IsNotNullOrEmptyRule<T> : IValidationRule<T>\\n{\\n public string ValidationMessa\", \"ge { get; set; }\\n public bool Check(T value)\\n {\\n if (value == null)\\n {\\n return false;\\n }\\n var str = \", \"value as string;\\n return !string.IsNullOrWhiteSpace(str);\\n }\\n}\\n```\\n\\nThe Check method returns a boole\", \"an indicating whether the value argument is null, empty, or consists only of whitespace characters.\\n\", \"\\nAlthough not used by the eShopOnContainers mobile app, the following code example shows a validatio\", \"n rule for validating email addresses:\\n\\n```\\npublic class EmailRule<T> : IValidationRule<T>\\n{\\n public\", \" string ValidationMessage { get; set; }\\n public bool Check(T value)\\n {\\n if (value == null)\\n```\\n\\n```\\n\", \" {\\n return false;\\n }\\n var str = value as string;\\n Regex regex = new Regex(@\\\"^([\\\\w\\\\.\\\\-]+)@([\\\\w\\\\-]+)((\", \"\\\\.(\\\\w){2,3})+)$\\\");\\n Match match = regex.Match(str);\\n return match.Success;\\n }\\n}\\n```\\n\\nThe Check metho\", \"d returns a boolean indicating whether or not the value argument is a valid email address. This is a\", \"chieved by searching the value argument for the first occurrence of the regular expression pattern s\", \"pecified in the Regex constructor. Whether the regular expression pattern has been found in the inpu\", \"t string can be determined by checking the value of the Match object's Success property.\\n\\n**Note:** \", \"Property validation can sometimes involve dependent properties. An example of dependent properties i\", \"s when the set of valid values for property A depends on the particular value that has been set in p\", \"roperty B. To check that the value of property A is one of the allowed values would involve retrievi\", \"ng the value of property B. In addition, when the value of property B changes, property A would need\", \" to be revalidated.\\n\\n# Adding validation rules to a property\\n\\nIn the eShopOnContainers mobile app, v\", \"iew model properties that require validation are declared to be of type ValidatableObject<T>, where \", \"T is the type of the data to be validated. The following code example shows an example of two such p\", \"roperties:\\n\\n```\\npublic ValidatableObject<string> UserName\\n{\\n get\\n {\\n return _userName;\\n }\\n set\\n {\\n _\", \"userName = value;\\n RaisePropertyChanged(() => UserName);\\n }\\n}\\npublic ValidatableObject<string> Passw\", \"ord\\n{\\n get\\n {\\n return _password;\\n }\\n set\\n {\\n _password = value;\\n RaisePropertyChanged(() => Password\", \");\\n }\\n}\\n```\\n\\nFor validation to occur, validation rules must be added to the Validations collection o\", \"f each ValidatableObject<T> instance, as demonstrated in the following code example:\\n\\n```\\nprivate vo\", \"id AddValidations()\\n{\\n _userName.Validations.Add(new IsNotNullOrEmptyRule<string>\\n {\\n ValidationMess\", \"age = \\\"A username is required.\\\"\\n });\\n _password.Validations.Add(new IsNotNullOrEmptyRule<string>\\n {\\n\", \" ValidationMessage = \\\"A password is required.\\\"\\n });\\n}\\n```\\n\\nThis method adds the IsNotNullOrEmptyRule\", \"<T> validation rule to the Validations collection of each ValidatableObject<T> instance, specifying \", \"values for the validation rule's ValidationMessage property, which specifies the validation error me\", \"ssage that will be displayed if validation fails.\\n\\n# Triggering validation\\n\\nThe validation approach \", \"used in the eShopOnContainers mobile app can manually trigger validation of a property, and automati\", \"cally trigger validation when a property changes.\\n\\n### **Triggering validation manually**\\n\\nValidatio\", \"n can be triggered manually for a view model property. For example, this occurs in the eShopOnContai\", \"ners mobile app when the user taps the **Login** button on the LoginView, when using mock services. \", \"The command delegate calls the MockSignInAsync method in the LoginViewModel, which invokes validatio\", \"n by executing the Validate method, which is shown in the following code example:\\n\\n```\\nprivate bool \", \"Validate()\\n{\\n bool isValidUser = ValidateUserName();\\n bool isValidPassword = ValidatePassword();\\n re\", \"turn isValidUser && isValidPassword;\\n}\\nprivate bool ValidateUserName()\\n{\\n return _userName.Validate(\", \");\\n}\\nprivate bool ValidatePassword()\\n{\\n return _password.Validate();\\n}\\n```\\n\\nThe Validate method perf\", \"orms validation of the username and password entered by the user on the LoginView, by invoking the V\", \"alidate method on each ValidatableObject<T> instance. The following code example shows the Validate \", \"method from the ValidatableObject<T> class:\\n\\n```\\npublic bool Validate()\\n{\\n Errors.Clear();\\n IEnumera\", \"ble<string> errors = _validations\\n .Where(v => !v.Check(Value))\\n .Select(v => v.ValidationMessage);\\n\", \"```\\n\\n```\\n Errors = errors.ToList();\\n IsValid = !Errors.Any();\\n return this.IsValid;\\n}\\n```\\n\\nThis meth\", \"od clears the Errors collection, and then retrieves any validation rules that were added to the obje\", \"ct's Validations collection. The Check method for each retrieved validation rule is executed, and th\", \"e ValidationMessage property value for any validation rule that fails to validate the data is added \", \"to the Errors collection of the ValidatableObject<T> instance. Finally, the IsValid property is set,\", \" and its value is returned to the calling method, indicating whether validation succeeded or failed.\", \"\\n\\n### **Triggering validation when properties change**\\n\\nValidation is also automatically triggered w\", \"henever a bound property changes. For example, when a two-way binding in the LoginView sets the User\", \"Name or Password property, validation is triggered. The following code example demonstrates how this\", \" occurs:\\n\\n```\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\">\\n <Entry.Behaviors>\\n <behaviors:Ev\", \"entToCommandBehavior\\n EventName=\\\"TextChanged\\\"\\n Command=\\\"{Binding ValidateUserNameCommand}\\\" />\\n </Ent\", \"ry.Behaviors>\\n ...\\n</Entry>\\n```\\n\\nThe Entry control binds to the UserName.Value property of the Valid\", \"atableObject<T> instance, and the control's Behaviors collection has an EventToCommandBehavior insta\", \"nce added to it. This behavior executes the ValidateUserNameCommand in response to the TextChanged e\", \"vent firing on the Entry, which is raised when the text in the Entry changes. In turn, the ValidateU\", \"serNameCommand delegate executes the ValidateUserName method, which executes the Validate method on \", \"the ValidatableObject<T> instance. Therefore, every time the user enters a character in the Entry co\", \"ntrol for the username, validation of the entered data is performed.\\n\\nFor more information about beh\", \"aviors, see [Implementing behaviors.](#page-21-0)\\n\\n# <span id=\\\"page-46-0\\\"></span>Displaying validati\", \"on errors\\n\\nThe eShopOnContainers mobile app notifies the user of any validation errors by highlighti\", \"ng the control that contains the invalid data with a red line, and by displaying an error message th\", \"at informs the user why the data is invalid below the control containing the invalid data. When the \", \"invalid data is corrected, the line changes to black and the error message is removed. Figure 6-2 sh\", \"ows the LoginView in the eShopOnContainers mobile app when validation errors are present.\\n\\n![](_page\", \"_47_Picture_0.jpeg)\\n\\n**Figure 6-2:** Displaying validation errors during login\\n\\n### **Highlighting a\", \" control that contains invalid data**\\n\\nThe LineColorBehavior attached behavior is used to highlight \", \"Entry controls where validation errors have occurred. The following code example shows how the LineC\", \"olorBehavior attached behavior is attached to an Entry control:\\n\\n```\\n<Entry Text=\\\"{Binding UserName.\", \"Value, Mode=TwoWay}\\\">\\n <Entry.Style>\\n <OnPlatform x:TypeArguments=\\\"Style\\\"\\n iOS=\\\"{StaticResource Entr\", \"yStyle}\\\"\\n Android=\\\"{StaticResource EntryStyle}\\\"\\n WinPhone=\\\"{StaticResource UwpEntryStyle}\\\"/>\\n </Entr\", \"y.Style>\\n ...\\n</Entry>\\n```\\n\\nThe Entry control consumes an explicit style, which is shown in the foll\", \"owing code example:\\n\\n```\\n<Style x:Key=\\\"EntryStyle\\\"\\n TargetType=\\\"{x:Type Entry}\\\">\\n ...\\n <Setter Prope\", \"rty=\\\"behaviors:LineColorBehavior.ApplyLineColor\\\"\\n Value=\\\"True\\\" />\\n <Setter Property=\\\"behaviors:LineC\", \"olorBehavior.LineColor\\\"\\n Value=\\\"{StaticResource BlackColor}\\\" />\\n ...\\n</Style>\\n```\\n\\nThis style sets t\", \"he ApplyLineColor and LineColor attached properties of the LineColorBehavior attached behavior on th\", \"e Entry control. For more information about styles, se[e Styles](https://developer.xamarin.com/guide\", \"s/xamarin-forms/user-interface/styles/) on the Xamarin Developer Center.\\n\\nWhen the value of the Appl\", \"yLineColor attached property is set, or changes, the LineColorBehavior attached behavior executes th\", \"e OnApplyLineColorChanged method, which is shown in the following code example:\\n\\n```\\npublic static c\", \"lass LineColorBehavior\\n{\\n ...\\n private static void OnApplyLineColorChanged(\\n BindableObject bindable\", \", object oldValue, object newValue)\\n {\\n var view = bindable as View;\\n if (view == null)\\n {\\n return;\\n\", \" }\\n bool hasLine = (bool)newValue;\\n if (hasLine)\\n {\\n view.Effects.Add(new EntryLineColorEffect());\\n \", \"}\\n else\\n {\\n var entryLineColorEffectToRemove =\\n view.Effects.FirstOrDefault(e => e is EntryLineColor\", \"Effect);\\n if (entryLineColorEffectToRemove != null)\\n {\\n view.Effects.Remove(entryLineColorEffectToRe\", \"move);\\n }\\n }\\n }\\n}\\n```\\n\\nThe parameters for this method provide the instance of the control that the b\", \"ehavior is attached to, and the old and new values of the ApplyLineColor attached property. The Entr\", \"yLineColorEffect class is added to the control's Effects collection if the ApplyLineColor attached p\", \"roperty is true, otherwise it's removed from the control's Effects collection. For more information \", \"about behaviors, see [Implementing behaviors.](#page-21-0)\\n\\nThe EntryLineColorEffect subclasses the \", \"RoutingEffect class, and is shown in the following code example:\\n\\n```\\npublic class EntryLineColorEff\", \"ect : RoutingEffect\\n{\\n public EntryLineColorEffect() : base(\\\"eShopOnContainers.EntryLineColorEffect\\\"\", \")\\n {\\n }\\n}\\n```\\n\\nThe RoutingEffect class represents a platform-independent effect that wraps an inner \", \"effect that's platform-specific. This simplifies the effect removal process, since there is no compi\", \"le-time access to the type information for a platform-specific effect. The EntryLineColorEffect call\", \"s the base class constructor, passing in a parameter consisting of a concatenation of the resolution\", \" group name, and the unique ID that's specified on each platform-specific effect class.\\n\\nThe followi\", \"ng code example shows the eShopOnContainers.EntryLineColorEffect implementation for iOS:\\n\\n```\\n[assem\", \"bly: ResolutionGroupName(\\\"eShopOnContainers\\\")]\\n[assembly: ExportEffect(typeof(EntryLineColorEffect),\", \" \\\"EntryLineColorEffect\\\")]\\nnamespace eShopOnContainers.iOS.Effects\\n{\\n public class EntryLineColorEffe\", \"ct : PlatformEffect\\n```\\n\\n```\\n {\\n UITextField control;\\n protected override void OnAttached()\\n {\\n try\\n\", \" {\\n control = Control as UITextField;\\n UpdateLineColor();\\n }\\n catch (Exception ex)\\n {\\n Console.Write\", \"Line(\\\"Can't set property on attached control. Error: \\\", ex.Message);\\n }\\n }\\n protected override void \", \"OnDetached()\\n {\\n control = null;\\n }\\n protected override void OnElementPropertyChanged(PropertyChange\", \"dEventArgs args)\\n {\\n base.OnElementPropertyChanged(args);\\n if (args.PropertyName == LineColorBehavio\", \"r.LineColorProperty.PropertyName ||\\n args.PropertyName == \\\"Height\\\")\\n {\\n Initialize();\\n UpdateLineCol\", \"or();\\n }\\n }\\n private void Initialize()\\n {\\n var entry = Element as Entry;\\n if (entry != null)\\n {\\n Con\", \"trol.Bounds = new CGRect(0, 0, entry.Width, entry.Height);\\n }\\n }\\n private void UpdateLineColor()\\n {\\n\", \" BorderLineLayer lineLayer = control.Layer.Sublayers.OfType<BorderLineLayer>()\\n .FirstOrDefault();\\n \", \"if (lineLayer == null)\\n {\\n lineLayer = new BorderLineLayer();\\n lineLayer.MasksToBounds = true;\\n line\", \"Layer.BorderWidth = 1.0f;\\n control.Layer.AddSublayer(lineLayer);\\n control.BorderStyle = UITextBorder\", \"Style.None;\\n }\\n lineLayer.Frame = new CGRect(0f, Control.Frame.Height-1f, Control.Bounds.Width, 1f);\", \"\\n lineLayer.BorderColor = LineColorBehavior.GetLineColor(Element).ToCGColor();\\n control.TintColor = \", \"control.TextColor;\\n }\\n private class BorderLineLayer : CALayer\\n {\\n }\\n```\\n\\n```\\n }\\n}\\n```\\n\\nThe OnAttach\", \"ed method retrieves the native control for the Xamarin.Forms Entry control, and updates the line col\", \"or by calling the UpdateLineColor method. The OnElementPropertyChanged override responds to bindable\", \" property changes on the Entry control by updating the line color if the attached LineColor property\", \" changes, or the Height property of the Entry changes. For more information about effects, see [Effe\", \"cts](https://developer.xamarin.com/guides/xamarin-forms/application-fundamentals/effects/) on the Xa\", \"marin Developer Center.\\n\\nWhen valid data is entered in the Entry control, it will apply a black line\", \" to the bottom of the control, to indicate that there is no validation error. Figure 6-3 shows an ex\", \"ample of this.\\n\\n**Figure 6-3**: Black line indicating no validation error\\n\\nThe Entry control also ha\", \"s a DataTrigger added to its Triggers collection. The following code example shows the DataTrigger:\\n\", \"\\n```\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\">\\n ...\\n <Entry.Triggers>\\n <DataTrigger\\n Targ\", \"etType=\\\"Entry\\\"\\n Binding=\\\"{Binding UserName.IsValid}\\\"\\n Value=\\\"False\\\">\\n <Setter Property=\\\"behaviors:Li\", \"neColorBehavior.LineColor\\\"\\n Value=\\\"{StaticResource ErrorColor}\\\" />\\n </DataTrigger>\\n </Entry.Triggers\", \">\\n</Entry>\\n```\\n\\nThis DataTrigger monitors the UserName.IsValid property, and if it's value becomes f\", \"alse, it executes the Setter, which changes the LineColor attached property of the LineColorBehavior\", \" attached behavior to red. Figure 6-4 shows an example of this.\\n\\n**Figure 6-4**: Red line indicating\", \" validation error\\n\\nThe line in the Entry control will remain red while the entered data is invalid, \", \"otherwise it will change to black to indicate that the entered data is valid.\\n\\nFor more information \", \"about Triggers, se[e Triggers](https://developer.xamarin.com/guides/xamarin-forms/application-fundam\", \"entals/triggers/) on the Xamarin Developer Center.\\n\\n## **Displaying error messages**\\n\\nThe UI display\", \"s validation error messages in Label controls below each control whose data failed validation. The f\", \"ollowing code example shows the Label that displays a validation error message if the user has not e\", \"ntered a valid username:\\n\\n<Label Text=\\\"{Binding UserName.Errors, Converter={StaticResource FirstVali\", \"dationErrorConverter}\\\" Style=\\\"{StaticResource ValidationErrorLabelStyle}\\\" />\\n\\nEach Label binds to th\", \"e Errors property of the view model object that's being validated. The Errors property is provided b\", \"y the ValidatableObject<T> class, and is of type List<string>. Because the Errors property can conta\", \"in multiple validation errors, the FirstValidationErrorConverter instance is used to retrieve the fi\", \"rst error from the collection for display.\\n\\n# Summary\\n\\nThe eShopOnContainers mobile app performs syn\", \"chronous client-side validation of view model properties and notifies the user of any validation err\", \"ors by highlighting the control that contains the invalid data, and by displaying error messages tha\", \"t inform the user why the data is invalid.\\n\\nView model properties that require validation are of typ\", \"e ValidatableObject<T>, and each ValidatableObject<T> instance has validation rules added to its Val\", \"idations property. Validation is invoked from the view model by calling the Validate method of the V\", \"alidatableObject<T> instance, which retrieves the validation rules and executes them against the Val\", \"idatableObject<T> Value property. Any validation errors are placed into the Errors property of the V\", \"alidatableObject<T> instance, and the IsValid property of the ValidatableObject<T> instance is updat\", \"ed to indicate whether validation succeeded or failed.\\n\\n# <span id=\\\"page-52-0\\\"></span>Configuration \", \"management\\n\\nSettings allow the separation of data that configures the behavior of an app from the co\", \"de, allowing the behavior to be changed without rebuilding the app. There are two types of settings:\", \" app settings, and user settings.\\n\\nApp settings are data that an app creates and manages. It can inc\", \"lude data such as fixed web service endpoints, API keys, and runtime state. App settings are tied to\", \" the existence of the app and are only meaningful to that app.\\n\\nUser settings are the customizable s\", \"ettings of an app that affect the behavior of the app and don't require frequent re-adjustment. For \", \"example, an app might let the user specify where to retrieve data from, and how to display it on the\", \" screen.\\n\\nXamarin.Forms includes a persistent dictionary that can be used to store settings data. Th\", \"is dictionary can be accessed using the Application.Current.Properties property, and any data that's\", \" placed into it is saved when the app goes into a sleep state, and is restored when the app resumes \", \"or starts up again. In addition, the Application class also has a SavePropertiesAsync method that al\", \"lows an app to have its settings saved when required. For more information about this dictionary, se\", \"e [Properties Dictionary](https://developer.xamarin.com/guides/xamarin-forms/application-fundamental\", \"s/application-class/#Properties_Dictionary) on the Xamarin Developer Center.\\n\\nA downside to storing \", \"data using the Xamarin.Forms persistent dictionary is that it's not easily data bound to. Therefore,\", \" the eShopOnContainers mobile app uses the Xam.Plugins.Settings library, available fro[m NuGet.](htt\", \"ps://www.nuget.org/packages/Xam.Plugins.Settings/) This library provides a consistent, type-safe, cr\", \"oss-platform approach for persisting and retrieving app and user settings, while using the native se\", \"ttings management provided by each platform. In addition, it's straightforward to use data binding t\", \"o access settings data exposed by the library.\\n\\n**Note:** While the Xam.Plugin.Settings library can \", \"store both app and user settings, it makes no distinction between the two.\\n\\n# Creating a settings cl\", \"ass\\n\\nWhen using the Xam.Plugins.Settings library, a single static class should be created that will \", \"contain the app and user settings required by the app. The following code example shows the Settings\", \" class in the eShopOnContainers mobile app:\\n\\n```\\npublic static class Settings\\n{\\n private static ISet\", \"tings AppSettings\\n {\\n get\\n {\\n return CrossSettings.Current;\\n }\\n }\\n ...\\n}\\n```\\n\\nSettings can be read a\", \"nd written through the ISettings API, which is provided by the Xam.Plugins.Settings library. This li\", \"brary provides a singleton that can be used to access the API, CrossSettings.Current, and an app's s\", \"ettings class should expose this singleton via an ISettings property.\\n\\n**Note:** Using directives fo\", \"r the Plugin.Settings and Plugin.Settings.Abstractions namespaces should be added to a class that re\", \"quires access to the Xam.Plugins.Settings library types.\\n\\n# Adding a setting\\n\\nEach setting consists \", \"of a key, a default value, and a property. The following code example shows all three items for a us\", \"er setting that represents the base URL for the online services that the eShopOnContainers mobile ap\", \"p connects to:\\n\\n```\\npublic static class Settings\\n{\\n ...\\n private const string IdUrlBase = \\\"url_base\\\"\", \";\\n private static readonly string UrlBaseDefault = GlobalSetting.Instance.BaseEndpoint;\\n ...\\n public\", \" static string UrlBase\\n {\\n get\\n {\\n return AppSettings.GetValueOrDefault<string>(IdUrlBase, UrlBaseDe\", \"fault);\\n }\\n set\\n {\\n AppSettings.AddOrUpdateValue<string>(IdUrlBase, value);\\n }\\n }\\n}\\n```\\n\\nThe key is \", \"always a const string that defines the key name, with the default value for the setting being a stat\", \"ic readonly value of the required type. Providing a default value ensures that a valid value is avai\", \"lable if an unset setting is retrieved.\\n\\nThe UrlBase static property uses two methods from the ISett\", \"ings API to read or write the setting value. The ISettings.GetValueOrDefault method is used to retri\", \"eve a setting's value from platform-specific storage. If no value is defined for the setting, its de\", \"fault value is retrieved instead. Similarly, the ISettings.AddOrUpdateValue method is used to persis\", \"t a setting's value to platformspecific storage.\\n\\nRather that define a default value inside the Sett\", \"ings class, the UrlBaseDefault string obtains its value from the GlobalSetting class. The following \", \"code example shows the BaseEndpoint property and UpdateEndpoint method in this class:\\n\\n```\\npublic cl\", \"ass GlobalSetting\\n{\\n ...\\n public string BaseEndpoint\\n {\\n get { return _baseEndpoint; }\\n set\\n {\\n _bas\", \"eEndpoint = value;\\n UpdateEndpoint(_baseEndpoint);\\n }\\n }\\n ...\\n private void UpdateEndpoint(string ba\", \"seEndpoint)\\n {\\n RegisterWebsite = string.Format(\\\"{0}:5105/Account/Register\\\", baseEndpoint);\\n Catalog\", \"Endpoint = string.Format(\\\"{0}:5101\\\", baseEndpoint);\\n OrdersEndpoint = string.Format(\\\"{0}:5102\\\", base\", \"Endpoint);\\n BasketEndpoint = string.Format(\\\"{0}:5103\\\", baseEndpoint);\\n IdentityEndpoint = string.For\", \"mat(\\\"{0}:5105/connect/authorize\\\", baseEndpoint);\\n UserInfoEndpoint = string.Format(\\\"{0}:5105/connect\", \"/userinfo\\\", baseEndpoint);\\n TokenEndpoint = string.Format(\\\"{0}:5105/connect/token\\\", baseEndpoint);\\n \", \"LogoutEndpoint = string.Format(\\\"{0}:5105/connect/endsession\\\", baseEndpoint);\\n IdentityCallback = str\", \"ing.Format(\\\"{0}:5105/xamarincallback\\\", baseEndpoint);\\n LogoutCallback = string.Format(\\\"{0}:5105/Acco\", \"unt/Redirecting\\\", baseEndpoint); \\n }\\n}\\n```\\n\\nEach time the BaseEndpoint property is set, the UpdateEn\", \"dpoint method is called. This method updates a series of properties, all of which are based on the U\", \"rlBase user setting that's provided by the Settings class that represent different endpoints that th\", \"e eShopOnContainers mobile app connects to.\\n\\n# Data binding to user settings\\n\\nIn the eShopOnContaine\", \"rs mobile app, the SettingsView exposes two user settings. These settings allow configuration of whe\", \"ther the app should retrieve data from microservices that are deployed as Docker containers, or whet\", \"her the app should retrieve data from mock services that don't require an internet connection. When \", \"choosing to retrieve data from containerized microservices, a base endpoint URL for the microservice\", \"s must be specified. Figure 7-1 shows the SettingsView when the user has chosen to retrieve data fro\", \"m containerized microservices.\\n\\n![](_page_55_Picture_2.jpeg)\\n\\n**Figure 7-1**: User settings exposed \", \"by the eShopOnContainers mobile app\\n\\nData binding can be used to retrieve and set settings exposed b\", \"y the Settings class. This is achieved by controls on the view binding to view model properties that\", \" in turn access properties in the Settings class, and raising a property changed notification if the\", \" settings value has changed. For information about how the eShopOnContainers mobile app constructs v\", \"iew models and associates them to views, se[e Automatically creating a view model with a view model \", \"locator.](#page-17-0)\\n\\nThe following code example shows the Entry control from the SettingsView that\", \" allows the user to enter a base endpoint URL for the containerized microservices:\\n\\n```\\n<Entry Text=\", \"\\\"{Binding Endpoint, Mode=TwoWay}\\\" />\\n```\\n\\nThis Entry control binds to the Endpoint property of the S\", \"ettingsViewModel class, using a two-way binding. The following code example shows the Endpoint prope\", \"rty:\\n\\n```\\npublic string Endpoint\\n{\\n get { return _endpoint; }\\n set\\n {\\n _endpoint = value;\\n if(!strin\", \"g.IsNullOrEmpty(_endpoint))\\n {\\n UpdateEndpoint(_endpoint);\\n }\\n RaisePropertyChanged(() => Endpoint);\", \"\\n }\\n}\\n```\\n\\nWhen the Endpoint property is set the UpdateEndpoint method is called, provided that the \", \"supplied value is valid, and property changed notification is raised. The following code example sho\", \"ws the UpdateEndpoint method:\\n\\n```\\nprivate void UpdateEndpoint(string endpoint)\\n{\\n Settings.UrlBase \", \"= endpoint;\\n}\\n```\\n\\nThis method updates the UrlBase property in the Settings class with the base endp\", \"oint URL value entered by the user, which causes it to be persisted to platform-specific storage.\\n\\nW\", \"hen the SettingsView is navigated to, the InitializeAsync method in the SettingsViewModel class is e\", \"xecuted. The following code example shows this method:\\n\\n```\\npublic override Task InitializeAsync(obj\", \"ect navigationData)\\n{\\n ...\\n Endpoint = Settings.UrlBase;\\n ...\\n}\\n```\\n\\nThe method sets the Endpoint pr\", \"operty to the value of the UrlBase property in the Settings class. Accessing the UrlBase property ca\", \"uses the Xam.Plugins.Settings library to retrieve the settings value from platform-specific storage.\", \" For information about how the InitializeAsync method is invoked, see [Passing parameters during nav\", \"igation.](#page-39-0)\\n\\nThis mechanism ensures that whenever a user navigates to the SettingsView, us\", \"er settings are retrieved from platform-specific storage and presented through data binding. Then, i\", \"f the user changes the settings values, data binding ensures that they are immediately persisted bac\", \"k to platform-specific storage.\\n\\n# Summary\\n\\nSettings allow the separation of data that configures th\", \"e behavior of an app from the code, allowing the behavior to be changed without rebuilding the app. \", \"App settings are data that an app creates and manages, and user settings are the customizable settin\", \"gs of an app that affect the behavior of the app and don't require frequent re-adjustment.\\n\\nThe Xam.\", \"Plugins.Settings library provides a consistent, type-safe, cross-platform approach for persisting an\", \"d retrieving app and user settings, and data binding can be used to access settings created with the\", \" library.\\n\\n# Containerized microservices\\n\\nDeveloping client-server applications has resulted in a fo\", \"cus on building tiered applications that use specific technologies in each tier. Such applications a\", \"re often referred to as *monolithic* applications, and are packaged onto hardware pre-scaled for pea\", \"k loads. The main drawbacks of this development approach are the tight coupling between components w\", \"ithin each tier, that individual components can't be easily scaled, and the cost of testing. A simpl\", \"e update can have unforeseen effects on the rest of the tier, and so a change to an application comp\", \"onent requires its entire tier to be retested and redeployed.\\n\\nParticularly concerning in the age of\", \" the cloud, is that individual components can't be easily scaled. A monolithic application contains \", \"domain-specific functionality, and is typically divided by functional layers such as front end, busi\", \"ness logic, and data storage. A monolithic application is scaled by cloning the entire application o\", \"nto multiple machines, as illustrated in Figure 8-1.\\n\\n![](_page_57_Picture_5.jpeg)\\n\\n**Figure 8-1**: \", \"Monolithic application scaling approach\\n\\n# <span id=\\\"page-58-0\\\"></span>Microservices\\n\\nMicroservices \", \"offer a different approach to application development and deployment, an approach that's suited to t\", \"he agility, scale, and reliability requirements of modern cloud applications. A microservices applic\", \"ation is decomposed into independent components that work together to deliver the application's over\", \"all functionality. The term microservice emphasizes that applications should be composed of services\", \" small enough to reflect independent concerns, so that each microservice implements a single functio\", \"n. In addition, each microservice has well-defined contracts so that other microservices can communi\", \"cate and share data with it. Typical examples of microservices include shopping carts, inventory pro\", \"cessing, purchase subsystems, and payment processing.\\n\\nMicroservices can scale-out independently, as\", \" compared to giant monolithic applications that scale together. This means that a specific functiona\", \"l area, that requires more processing power or network bandwidth to support demand, can be scaled ra\", \"ther than unnecessarily scaling-out other areas of the application. Figure 8-2 illustrates this appr\", \"oach, where microservices are deployed and scaled independently, creating instances of services acro\", \"ss machines.\\n\\n![](_page_58_Picture_3.jpeg)\\n\\n**Figure 8-2**: Microservices application scaling approa\", \"ch\\n\\nMicroservice scale-out can be nearly instantaneous, allowing an application to adapt to changing\", \" loads. For example, a single microservice in the web-facing functionality of an application might b\", \"e the only microservice in the application that needs to scale out to handle additional incoming tra\", \"ffic.\\n\\nThe classic model for application scalability is to have a load-balanced, stateless tier with\", \" a shared external datastore to store persistent data. Stateful microservices manage their own persi\", \"stent data, usually storing it locally on the servers on which they are placed, to avoid the overhea\", \"d of network access and complexity of cross-service operations. This enables the fastest possible pr\", \"ocessing of data and can eliminate the need for caching systems. In addition, scalable stateful micr\", \"oservices usually partition data among their instances, in order to manage data size and transfer th\", \"roughput beyond which a single server can support.\\n\\nMicroservices also support independent updates. \", \"This loose coupling between microservices provides a rapid and reliable application evolution. Their\", \" independent, distributed nature supports rolling updates, where only a subset of instances of a sin\", \"gle microservice will update at any given time. Therefore, if a problem is detected, a buggy update \", \"can be rolled back, before all instances update with the faulty code or configuration. Similarly, mi\", \"croservices typically use schema versioning, so that\\n\\nclients see a consistent version when updates \", \"are being applied, regardless of which microservice instance is being communicated with.\\n\\nTherefore,\", \" microservice applications have many benefits over monolithic applications:\\n\\n- Each microservice is \", \"relatively small, easy to manage and evolve.\\n- Each microservice can be developed and deployed indep\", \"endently of other services.\\n- Each microservice can be scaled-out independently. For example, a cata\", \"log service or shopping basket service might need to be scaled-out more than an ordering service. Th\", \"erefore, the resulting infrastructure will more efficiently consume resources when scaling out.\\n- Ea\", \"ch microservice isolates any issues. For example, if there is an issue in a service it only impacts \", \"that service. The other services can continue to handle requests.\\n- Each microservice can use the la\", \"test technologies. Because microservices are autonomous and run side-by-side, the latest technologie\", \"s and frameworks can be used, rather than being forced to use an older framework that might be used \", \"by a monolithic application.\\n\\nHowever, a microservice based solution also has potential drawbacks:\\n\\n\", \"- Choosing how to partition an application into microservices can be challenging, as each microservi\", \"ce has to be completely autonomous, end-to-end, including responsibility for its data sources.\\n- Dev\", \"elopers must implement inter-service communication, which adds complexity and latency to the applica\", \"tion.\\n- Atomic transactions between multiple microservices usually aren't possible. Therefore, busin\", \"ess requirements must embrace eventual consistency between microservices.\\n- In production, there is \", \"an operational complexity in deploying and managing a system compromised of many independent service\", \"s.\\n- Direct client-to-microservice communication can make it difficult to refactor the contracts of \", \"microservices. For example, over time how the system is partitioned into services might need to chan\", \"ge. A single service might split into two or more services, and two services might merge. When clien\", \"ts communicate directly with microservices, this refactoring work can break compatibility with clien\", \"t apps.\\n\\n# Containerization\\n\\nContainerization is an approach to software development in which an app\", \"lication and its versioned set of dependencies, plus its environment configuration abstracted as dep\", \"loyment manifest files, are packaged together as a container image, tested as a unit, and deployed t\", \"o a host operating system.\\n\\nA container is an isolated, resource controlled, and portable operating \", \"environment, where an application can run without touching the resources of other containers, or the\", \" host. Therefore, a container looks and acts like a newly installed physical computer or a virtual m\", \"achine.\\n\\nThere are many similarities between containers and virtual machines, as illustrated in Figu\", \"re 8-3.\\n\\n![](_page_60_Picture_1.jpeg)\\n\\n![](_page_60_Figure_3.jpeg)\\n\\n**Figure 8-3**: Comparison of vi\", \"rtual machines and containers\\n\\nA container runs an operating system, has a file system, and can be a\", \"ccessed over a network as if it were a physical or virtual machine. However, the technology and conc\", \"epts used by containers are very different from virtual machines. Virtual machines include the appli\", \"cations, the required dependencies, and a full guest operating system. Containers include the applic\", \"ation and its dependencies, but share the operating system with other containers, running as isolate\", \"d processes on the host operating system (aside from Hyper-V containers which run inside of a specia\", \"l virtual machine per container). Therefore, containers share resources and typically require fewer \", \"resources than virtual machines.\\n\\nThe advantage of a container-oriented development and deployment a\", \"pproach is that it eliminates most of the issues that arise from inconsistent environment setups and\", \" the problems that come with them. In addition, containers permit fast application scale-up function\", \"ality by instancing new containers as required.\\n\\nThe key concepts when creating and working with con\", \"tainers are:\\n\\n- Container Host: The physical or virtual machine configured to host containers. The c\", \"ontainer host will run one or more containers.\\n- Container Image: An image consists of a union of la\", \"yered filesystems stacked on top of each other, and is the basis of a container. An image does not h\", \"ave state and it never changes as it's deployed to different environments.\\n- Container: A container \", \"is a runtime instance of an image.\\n- Container OS Image: Containers are deployed from images. The co\", \"ntainer operating system image is the first layer in potentially many image layers that make up a co\", \"ntainer. A container operating system is immutable, and can't be modified.\\n- Container Repository: E\", \"ach time a container image is created, the image and its dependencies are stored in a local reposito\", \"ry. These images can be reused many times on the container host. The container images can also be st\", \"ored in a public or private registry, such as [Docker](https://hub.docker.com/)  [Hub,](https://hub.\", \"docker.com/) so that they can be used across different container hosts.\\n\\nEnterprises are increasingl\", \"y adopting containers when implementing microservice based applications, and Docker has become the s\", \"tandard container implementation that has been adopted by most software platforms and cloud vendors.\", \"\\n\\nThe eShopOnContainers reference application uses Docker to host four containerized back-end micros\", \"ervices, as illustrated in Figure 8-4.\\n\\n![](_page_61_Figure_2.jpeg)\\n\\n**Figure 8-4**: eShopOnContaine\", \"rs reference application back-end microservices\\n\\nThe architecture of the back-end services in the re\", \"ference application is decomposed into multiple autonomous sub-systems in the form of collaborating \", \"microservices and containers. Each microservice provides a single area of functionality: an identity\", \" service, a catalog service, an ordering service, and a basket service.\\n\\nEach microservice has its o\", \"wn database, allowing it to be fully decoupled from the other microservices. Where necessary, consis\", \"tency between databases from different microservices is achieved using application-level events. For\", \" more information, se[e Communication between](#page-62-0)  [microservices.](#page-62-0)\\n\\nFor more i\", \"nformation about the reference application, se[e .NET Microservices: Architecture for](https://aka.m\", \"s/microservicesebook)  [Containerized .NET Applications.](https://aka.ms/microservicesebook)\\n\\n# <spa\", \"n id=\\\"page-61-0\\\"></span>Communication between client and microservices\\n\\nThe eShopOnContainers mobile\", \" app communicates with the containerized back-end microservices using *direct client-to-microservice\", \"* communication, which is shown in Figure 8-5.\\n\\n**Figure 8-5**: Direct client-to-microservice commun\", \"ication\\n\\nWith direct client-to-microservice communication, the mobile app makes requests to each mic\", \"roservice directly through its public endpoint, with a different TCP port per microservice. In produ\", \"ction, the endpoint would typically map to the microservice's load balancer, which distributes reque\", \"sts across the available instances.\\n\\n#### **Tip:** Consider using API gateway communication\\n\\nDirect \", \"client-to-microservice communication can have drawbacks when building a large and complex microservi\", \"ce based application, but it's more than adequate for a small application. When designing a large mi\", \"croservice based application with tens of microservices, consider using API gateway communication. F\", \"or more information, see [.NET Microservices: Architecture for](https://aka.ms/microservicesebook)  \", \"[Containerized .NET Applications.](https://aka.ms/microservicesebook)\\n\\n# <span id=\\\"page-62-0\\\"></span\", \">Communication between microservices\\n\\nA microservices based application is a distributed system, pot\", \"entially running on multiple machines. Each service instance is typically a process. Therefore, serv\", \"ices must interact using an inter-process communication protocol, such as HTTP, TCP, Advanced Messag\", \"e Queuing Protocol (AMQP), or binary protocols, depending on the nature of each service.\\n\\nThe two co\", \"mmon approaches for microservice-to-microservice communication are HTTP based REST communication whe\", \"n querying for data, and lightweight asynchronous messaging when communicating updates across multip\", \"le microservices.\\n\\nAsynchronous messaging based event-driven communication is critical when propagat\", \"ing changes across multiple microservices. With this approach, a microservice publishes an event whe\", \"n something notable happens, for example, when it updates a business entity. Other microservices sub\", \"scribe to these events. Then, when a microservice receives an event, it updates its own business ent\", \"ities, which might in turn lead to more events being published. This publish-subscribe functionality\", \" is usually achieved with an event bus.\\n\\nAn event bus allows publish-subscribe communication between\", \" microservices, without requiring the components to be explicitly aware of each other, as shown in F\", \"igure 8-6.\\n\\n![](_page_63_Figure_0.jpeg)\\n\\n**Figure 8-6:** Publish-subscribe with an event bus\\n\\nFrom a\", \"n application perspective, the event bus is simply a publish-subscribe channel exposed via an interf\", \"ace. However, the way the event bus is implemented can vary. For example, an event bus implementatio\", \"n could use RabbitMQ, Azure Service Bus, or other service buses such as NServiceBus and MassTransit.\", \" Figure 8-7 shows how an event bus is used in the eShopOnContainers reference application.\\n\\n![](_pag\", \"e_63_Figure_3.jpeg)\\n\\n**Figure 8-7:** Asynchronous event-driven communication in the reference applic\", \"ation\\n\\nThe eShopOnContainers event bus, implemented using RabbitMQ, provides one-to-many asynchronou\", \"s publish-subscribe functionality. This means that after publishing an event, there can be multiple \", \"subscribers listening for the same event. Figure 8-9 illustrates this relationship.\\n\\n![](_page_64_Fi\", \"gure_0.jpeg)\\n\\n**Figure 8-9**: One-to-many communication\\n\\nThis one-to-many communication approach use\", \"s events to implement business transactions that span multiple services, ensuring eventual consisten\", \"cy between the services. An eventual-consistent transaction consists of a series of distributed step\", \"s. Therefore, when the user-profile microservice receives the UpdateUser command, it updates the use\", \"r's details in its database and publishes the UserUpdated event to the event bus. Both the basket mi\", \"croservice and the ordering microservice have subscribed to receive this event, and in response upda\", \"te their buyer information in their respective databases.\\n\\n**Note:** The eShopOnContainers event bus\", \", implemented using RabbitMQ, is intended to be used only as a proof of concept. For production syst\", \"ems, alternative event bus implementations should be considered.\\n\\nFor information about the event bu\", \"s implementation, see [.NET Microservices: Architecture for](https://aka.ms/microservicesebook)  [Co\", \"ntainerized .NET Applications.](https://aka.ms/microservicesebook)\\n\\n# Summary\\n\\nMicroservices offer a\", \"n approach to application development and deployment that's suited to the agility, scale, and reliab\", \"ility requirements of modern cloud applications. One of the main advantages of microservices is that\", \" they can be scaled-out independently, which means that a specific functional area can be scaled tha\", \"t requires more processing power or network bandwidth to support demand, without unnecessarily scali\", \"ng areas of the application that are not experiencing increased demand.\\n\\nA container is an isolated,\", \" resource controlled, and portable operating environment, where an application can run without touch\", \"ing the resources of other containers, or the host. Enterprises are increasingly adopting containers\", \" when implementing microservice based applications, and Docker has become the standard container imp\", \"lementation that has been adopted by most software platforms and cloud vendors.\\n\\nC H A P T E R 9\\n\\n# \", \"Authentication and authorization\\n\\nAuthentication is the process of obtaining identification credenti\", \"als such as name and password from a user, and validating those credentials against an authority. If\", \" the credentials are valid, the entity that submitted the credentials is considered an authenticated\", \" identity. Once an identity has been authenticated, an authorization process determines whether that\", \" identity has access to a given resource.\\n\\nThere are many approaches to integrating authentication a\", \"nd authorization into a Xamarin.Forms app that communicates with an ASP.NET MVC web application, inc\", \"luding using ASP.NET Core Identity, external authentication providers such as Microsoft, Google, Fac\", \"ebook, or Twitter, and authentication middleware. The eShopOnContainers mobile app performs authenti\", \"cation and authorization with a containerized identity microservice that uses IdentityServer 4. The \", \"mobile app requests security tokens from IdentityServer, either for authenticating a user or for acc\", \"essing a resource. For IdentityServer to issue tokens on behalf of a user, the user must sign-in to \", \"IdentityServer. However, IdentityServer doesn't provide a user interface or database for authenticat\", \"ion. Therefore, in the eShopOnContainers reference application, ASP.NET Core Identity is used for th\", \"is purpose.\\n\\n# <span id=\\\"page-65-0\\\"></span>Authentication\\n\\nAuthentication is required when an applic\", \"ation needs to know the identity of the current user. ASP.NET Core's primary mechanism for identifyi\", \"ng users is the ASP.NET Core Identity membership system, which stores user information in a data sto\", \"re configured by the developer. Typically, this data store will be an EntityFramework store, though \", \"custom stores or third party packages can be used to store identity information in Azure storage, Do\", \"cumentDB, or other locations.\\n\\nFor authentication scenarios that make use of a local user data store\", \", and that persist identity information between requests via cookies (as is typical in ASP.NET MVC w\", \"eb applications), ASP.NET Core Identity is a suitable solution. However, cookies are not always a na\", \"tural means of persisting and transmitting data. For example, an ASP.NET Core web application that e\", \"xposes RESTful endpoints that are accessed from a mobile app will typically need to use bearer token\", \" authentication, since cookies can't be used in this scenario. However, bearer tokens can easily be \", \"retrieved and included in the authorization header of web requests made from the mobile app.\\n\\n### **\", \"Issuing bearer tokens using IdentityServer 4**\\n\\n[IdentityServer 4](https://github.com/IdentityServer\", \"/IdentityServer4) is an open source OpenID Connect and OAuth 2.0 framework for ASP.NET Core, which c\", \"an be used for many authentication and authorization scenarios including issuing security tokens for\", \" local ASP.NET Core Identity users.\\n\\n**Note:** OpenID Connect and OAuth 2.0 are very similar, while \", \"having different responsibilities.\\n\\nOpenID Connect is an authentication layer on top of the OAuth 2.\", \"0 protocol. OAuth 2 is a protocol that allows applications to request access tokens from a security \", \"token service and use them to communicate with APIs. This delegation reduces complexity in both clie\", \"nt applications and APIs since authentication and authorization can be centralized.\\n\\nThe combination\", \" of OpenID Connect and OAuth 2.0 combine the two fundamental security concerns of authentication and\", \" API access, and IdentityServer 4 is an implementation of these protocols.\\n\\nIn applications that use\", \" direct client-to-microservice communication, such as the eShopOnContainers reference application, a\", \" dedicated authentication microservice acting as a Security Token Service (STS) can be used to authe\", \"nticate users, as shown in Figure 9-1. For more information about direct clientto-microservice commu\", \"nication, see [Communication between client and microservices.](#page-61-0)\\n\\n![](_page_66_Figure_6.j\", \"peg)\\n\\n**Figure 9-1:** Authentication by a dedicated authentication microservice\\n\\nThe eShopOnContaine\", \"rs mobile app communicates with the identity microservice, which uses IdentityServer 4 to perform au\", \"thentication, and access control for APIs. Therefore, the mobile app requests tokens from IdentitySe\", \"rver, either for authenticating a user or for accessing a resource:\\n\\n- Authenticating users with Ide\", \"ntityServer is achieved by the mobile app requesting an *identity* token, which represents the outco\", \"me of an authentication process. At a bare minimum, it contains an identifier for the user, and info\", \"rmation about how and when the user authenticated. It can also contain additional identity data.\\n- A\", \"ccessing a resource with IdentityServer is achieved by the mobile app requesting an *access* token, \", \"which allows access to an API resource. Clients request access tokens and forward them to the API. A\", \"ccess tokens contain information about the client, and the user (if present). APIs then use that inf\", \"ormation to authorize access to their data.\\n\\n**Note**: A client must be registered with IdentityServ\", \"er before it can request tokens.\\n\\n## **Adding IdentityServer to a web application**\\n\\nIn order for an\", \" ASP.NET Core web application to use IdentityServer 4, it must be added to the web application's Vis\", \"ual Studio solution. For more information, see [Setup and Overview](https://identityserver4.readthed\", \"ocs.io/en/release/quickstarts/0_overview.html) in the IdentityServer documentation.\\n\\nOnce IdentitySe\", \"rver is included in the web application's Visual Studio solution, it must be added to the web applic\", \"ation's HTTP request processing pipeline, so that it can serve requests to OpenID Connect and OAuth \", \"2.0 endpoints. This is achieved in the Configure method in the web application's Startup class, as d\", \"emonstrated in the following code example:\\n\\n```\\npublic void Configure(\\n IApplicationBuilder app, IHo\", \"stingEnvironment env, ILoggerFactory loggerFactory)\\n{\\n ...\\n app.UseIdentity();\\n ...\\n}\\n```\\n\\nOrder mat\", \"ters in the web application's HTTP request processing pipeline. Therefore, IdentityServer must be ad\", \"ded to the pipeline before the UI framework that implements the login screen.\\n\\n### **Configuring Ide\", \"ntityServer**\\n\\nIdentityServer should be configured in the ConfigureServices method in the web applic\", \"ation's Startup class by calling the services.AddIdentityServer method, as demonstrated in the follo\", \"wing code example from the eShopOnContainers reference application:\\n\\n```\\npublic void ConfigureServic\", \"es(IServiceCollection services)\\n{\\n ...\\n services.AddIdentityServer(x => x.IssuerUri = \\\"null\\\")\\n .AddS\", \"igningCredential(Certificate.Get()) \\n .AddAspNetIdentity<ApplicationUser>()\\n .AddConfigurationStore(\", \"builder =>\\n builder.UseSqlServer(connectionString, options =>\\n options.MigrationsAssembly(migrations\", \"Assembly)))\\n .AddOperationalStore(builder =>\\n builder.UseSqlServer(connectionString, options =>\\n opt\", \"ions.MigrationsAssembly(migrationsAssembly)))\\n .Services.AddTransient<IProfileService, ProfileServic\", \"e>();\\n}\\n```\\n\\nAfter calling the services.AddIdentityServer method, additional fluent APIs are called \", \"to configure the following:\\n\\n- Credentials used for signing.\\n- API and identity resources that users\", \" might request access to.\\n- Clients that will be connecting to request tokens.\\n- ASP.NET Core Identi\", \"ty.\\n\\n**Tip**: Dynamically load the IdentityServer 4 configuration\\n\\nIdentityServer 4's APIs allow for\", \" configuring IdentityServer from an in-memory list of configuration objects. In the eShopOnContainer\", \"s reference application, these in-memory collections are hardcoded into the application. However, in\", \" production scenarios they can be loaded dynamically from a configuration file or from a database.\\n\\n\", \"For information about configuring IdentityServer to use ASP.NET Core Identity, see [Using ASP.NET](h\", \"ttps://identityserver4.readthedocs.io/en/release/quickstarts/6_aspnet_identity.html)  [Core Identity\", \"](https://identityserver4.readthedocs.io/en/release/quickstarts/6_aspnet_identity.html) in the Ident\", \"ityServer documentation.\\n\\n#### <span id=\\\"page-68-0\\\"></span>**Configuring API resources**\\n\\nWhen confi\", \"guring API resources, the AddInMemoryApiResources method expects an IEnumerable<ApiResource> collect\", \"ion. The following code example shows the GetApis method that provides this collection in the eShopO\", \"nContainers reference application:\\n\\n```\\npublic static IEnumerable<ApiResource> GetApis()\\n{\\n return n\", \"ew List<ApiResource>\\n {\\n new ApiResource(\\\"orders\\\", \\\"Orders Service\\\"),\\n new ApiResource(\\\"basket\\\", \\\"Ba\", \"sket Service\\\")\\n };\\n}\\n```\\n\\nThis method specifies that IdentityServer should protect the orders and ba\", \"sket APIs. Therefore, IdentityServer managed access tokens will be required when making calls to the\", \"se APIs. For more information about the ApiResource type, se[e API Resource](https://identityserver4\", \".readthedocs.io/en/release/reference/api_resource.html#refapiresource) in the IdentityServer 4 docum\", \"entation.\\n\\n#### **Configuring identity resources**\\n\\nWhen configuring identity resources, the AddInMe\", \"moryIdentityResources method expects an IEnumerable<IdentityResource> collection. Identity resources\", \" are data such as user ID, name, or email address. Each identity resource has a unique name, and arb\", \"itrary claim types can be assigned to it, which will then be included in the identity token for the \", \"user. The following code example shows the GetResources method that provides this collection in the \", \"eShopOnContainers reference application:\\n\\n```\\npublic static IEnumerable<IdentityResource> GetResourc\", \"es()\\n{\\n return new List<IdentityResource>\\n {\\n new IdentityResources.OpenId(),\\n new IdentityResources\", \".Profile()\\n };\\n}\\n```\\n\\nThe OpenID Connect specification specifies some [standard identity resources.]\", \"(https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims) The minimum requirement is that \", \"support is provided for emitting a unique ID for users. This is achieved by exposing the IdentityRes\", \"ources.OpenId identity resource.\\n\\n**Note:** The IdentityResources class supports all of the scopes d\", \"efined in the OpenID Connect specification (openid, email, profile, telephone, and address).\\n\\nIdenti\", \"tyServer also supports defining custom identity resources. For more information, see [Defining](http\", \"s://identityserver4.readthedocs.io/en/release/topics/resources.html#defining-custom-identity-resourc\", \"es)  [custom identity resources](https://identityserver4.readthedocs.io/en/release/topics/resources.\", \"html#defining-custom-identity-resources) in the IdentityServer documentation. For more information a\", \"bout the IdentityResource type, see [Identity Resource](https://identityserver4.readthedocs.io/en/re\", \"lease/reference/identity_resource.html) in the IdentityServer 4 documentation.\\n\\n#### **Configuring c\", \"lients**\\n\\nClients are applications that can request tokens from IdentityServer. Typically, the follo\", \"wing settings must be defined for each client as a minimum:\\n\\n- A unique client ID.\\n- The allowed int\", \"eractions with the token service (known as the grant type).\\n- The location where identity and access\", \" tokens are sent to (known as a redirect URI).\\n\\n\\u2022 A list of resources that the client is allowed acc\", \"ess to (known as scopes).\\n\\nWhen configuring clients, the AddInMemoryClients method expects an IEnume\", \"rable<Client> collection. The following code example shows the configuration for the eShopOnContaine\", \"rs mobile app in the GetClients method that provides this collection in the eShopOnContainers refere\", \"nce application:\\n\\n```\\npublic static IEnumerable<Client> GetClients(Dictionary<string,string> clients\", \"Url)\\n{\\n return new List<Client>\\n {\\n ...\\n new Client\\n {\\n ClientId = \\\"xamarin\\\",\\n ClientName = \\\"eShop X\", \"amarin OpenId Client\\\",\\n AllowedGrantTypes = GrantTypes.Hybrid,\\n ClientSecrets =\\n {\\n new Secret(\\\"secr\", \"et\\\".Sha256())\\n },\\n RedirectUris = { clientsUrl[\\\"Xamarin\\\"] },\\n RequireConsent = false,\\n RequirePkce =\", \" true,\\n PostLogoutRedirectUris = { $\\\"{clientsUrl[\\\"Xamarin\\\"]}/Account/Redirecting\\\" },\\n AllowedCorsOri\", \"gins = { \\\"http://eshopxamarin\\\" },\\n AllowedScopes = new List<string>\\n {\\n IdentityServerConstants.Stan\", \"dardScopes.OpenId,\\n IdentityServerConstants.StandardScopes.Profile,\\n IdentityServerConstants.Standar\", \"dScopes.OfflineAccess,\\n \\\"orders\\\",\\n \\\"basket\\\"\\n },\\n AllowOfflineAccess = true,\\n AllowAccessTokensViaBro\", \"wser = true\\n },\\n ...\\n };\\n}\\n```\\n\\nThis configuration specifies data for the following properties:\\n\\n- C\", \"lientId: A unique ID for the client.\\n- ClientName: The client display name, which is used for loggin\", \"g and the consent screen.\\n- AllowedGrantTypes: Specifies how a client wants to interact with Identit\", \"yServer. For more information see [Configuring the authentication flow.](#page-70-0)\\n- ClientSecrets\", \": Specifies the client secret credentials that are used when requesting tokens from the token endpoi\", \"nt.\\n- RedirectUris: Specifies the allowed URIs to which to return tokens or authorization codes.\\n- R\", \"equireConsent: Specifies whether a consent screen is required.\\n- RequirePkce: Specifies whether clie\", \"nts using an authorization code must send a proof key.\\n- PostLogoutRedirectUris: Specifies the allow\", \"ed URIs to redirect to after logout.\\n\\n- AllowedCorsOrigins: Specifies the origin of the client so th\", \"at IdentityServer can allow crossorigin calls from the origin.\\n- AllowedScopes: Specifies the resour\", \"ces the client has access to. By default, a client has no access to any resources.\\n- AllowOfflineAcc\", \"ess: Specifies whether the client can request refresh tokens.\\n\\n#### <span id=\\\"page-70-0\\\"></span>**Co\", \"nfiguring the authentication flow**\\n\\nThe authentication flow between a client and IdentityServer can\", \" be configured by specifying the grant types in the Client.AllowedGrantTypes property. The OpenID Co\", \"nnect and OAuth 2.0 specifications define a number of authentication flows, including:\\n\\n- Implicit. \", \"This flow is optimized for browser-based applications and should be used either for user authenticat\", \"ion-only, or authentication and access token requests. All tokens are transmitted via the browser, a\", \"nd therefore advanced features like refresh tokens are not permitted.\\n- Authorization code. This flo\", \"w provides the ability to retrieve tokens on a back channel, as opposed to the browser front channel\", \", while also supporting client authentication.\\n- Hybrid. This flow is a combination of the implicit \", \"and authorization code grant types. The identity token is transmitted via the browser channel and co\", \"ntains the signed protocol response along with other artifacts such as the authorization code. After\", \" successful validation of the response, the back channel should be used to retrieve the access and r\", \"efresh token.\\n\\n#### **Tip:** Use the hybrid authentication flow\\n\\nThe hybrid authentication flow miti\", \"gates a number of attacks that apply to the browser channel, and is the recommended flow for native \", \"applications that want to retrieve access tokens (and possibly refresh tokens).\\n\\nFor more informatio\", \"n about authentication flows, see [Grant Types](https://identityserver4.readthedocs.io/en/release/to\", \"pics/grant_types.html) in the IdentityServer 4 documentation.\\n\\n## **Performing authentication**\\n\\nFor\", \" IdentityServer to issue tokens on behalf of a user, the user must sign-in to IdentityServer. Howeve\", \"r, IdentityServer doesn't provide a user interface or database for authentication. Therefore, in the\", \" eShopOnContainers reference application, ASP.NET Core Identity is used for this purpose.\\n\\nThe eShop\", \"OnContainers mobile app authenticates with IdentityServer with the hybrid authentication flow, which\", \" is illustrated in Figure 9-2.\\n\\n![](_page_70_Figure_14.jpeg)\\n\\n**Figure 9-2:** High-level overview of\", \" the sign-in process\\n\\nA sign-in request is made to <base endpoint>:5105/connect/authorize. Following\", \" successful authentication, IdentityServer returns an authentication response containing an authoriz\", \"ation code and an identity token. The authorization code is then sent to <base endpoint>:5105/connec\", \"t/token, which responds with access, identity, and refresh tokens.\\n\\nThe eShopOnContainers mobile app\", \" signs-out of IdentityServer by sending a request to http://<base endpoint>:5105/connect/endsession,\", \" with additional parameters. After sign-out occurs, IdentityServer responds by sending a post logout\", \" redirect URI back to the mobile app. Figure 9-3 illustrates this process.\\n\\n![](_page_71_Figure_2.jp\", \"eg)\\n\\n**Figure 9-3:** High-level overview of the sign-out process\\n\\nIn the eShopOnContainers mobile ap\", \"p, communication with IdentityServer is performed by the IdentityService class, which implements the\", \" IIdentityService interface. This interface specifies that the implementing class must provide Creat\", \"eAuthorizationRequest, CreateLogoutRequest, and GetTokenAsync methods.\\n\\n#### **Signing-in**\\n\\nWhen th\", \"e user taps the **LOGIN** button on the LoginView, the SignInCommand in the LoginViewModel class is \", \"executed, which in turn executes the SignInAsync method. The following code example shows this metho\", \"d:\\n\\n```\\nprivate async Task SignInAsync()\\n{\\n ...\\n LoginUrl = _identityService.CreateAuthorizationRequ\", \"est();\\n IsLogin = true;\\n ...\\n}\\n```\\n\\nThis method invokes the CreateAuthorizationRequest method in the\", \" IdentityService class, which is shown in the following code example:\\n\\n```\\npublic string CreateAutho\", \"rizationRequest()\\n{\\n // Create URI to authorization endpoint\\n var authorizeRequest = new AuthorizeRe\", \"quest(GlobalSetting.Instance.IdentityEndpoint);\\n // Dictionary with values for the authorize request\", \"\\n var dic = new Dictionary<string, string>();\\n dic.Add(\\\"client_id\\\", GlobalSetting.Instance.ClientId)\", \";\\n dic.Add(\\\"client_secret\\\", GlobalSetting.Instance.ClientSecret);\\n dic.Add(\\\"response_type\\\", \\\"code id\", \"_token\\\");\\n dic.Add(\\\"scope\\\", \\\"openid profile basket orders locations marketing offline_access\\\");\\n dic\", \".Add(\\\"redirect_uri\\\", GlobalSetting.Instance.IdentityCallback);\\n dic.Add(\\\"nonce\\\", Guid.NewGuid().ToSt\", \"ring(\\\"N\\\"));\\n dic.Add(\\\"code_challenge\\\", CreateCodeChallenge());\\n dic.Add(\\\"code_challenge_method\\\", \\\"S2\", \"56\\\");\\n```\\n\\n```\\n // Add CSRF token to protect against cross-site request forgery attacks.\\n var curren\", \"tCSRFToken = Guid.NewGuid().ToString(\\\"N\\\");\\n dic.Add(\\\"state\\\", currentCSRFToken);\\n var authorizeUri = \", \"authorizeRequest.Create(dic);\\n return authorizeUri;\\n}\\n```\\n\\nThis method creates the URI for IdentityS\", \"erver's [authorization endpoint,](https://identityserver4.readthedocs.io/en/release/endpoints/author\", \"ize.html) with the required parameters. The authorization endpoint is at /connect/authorize on port \", \"5105 of the base endpoint exposed as a user setting. For more information about user settings, see [\", \"Configuration management.](#page-52-0)\\n\\n**Note**: The attack surface of the eShopOnContainers mobile\", \" app is reduced by implementing the Proof Key for Code Exchange (PKCE) extension to OAuth. PKCE prot\", \"ects the authorization code from being used if it's intercepted. This is achieved by the client gene\", \"rating a secret verifier, a hash of which is passed in the authorization request, and which is prese\", \"nted unhashed when redeeming the authorization code. For more information about PKCE, see [Proof Key\", \" for Code Exchange by](https://tools.ietf.org/html/rfc7636)  [OAuth Public Clients](https://tools.ie\", \"tf.org/html/rfc7636) on the Internet Engineering Task Force web site.\\n\\nThe returned URI is stored in\", \" the LoginUrl property of the LoginViewModel class. When the IsLogin property becomes true, the WebV\", \"iew in the LoginView becomes visible. The WebView data binds its Source property to the LoginUrl pro\", \"perty of the LoginViewModel class, and so makes a sign-in request to IdentityServer when the LoginUr\", \"l property is set to IdentityServer's authorization endpoint. When IdentityServer receives this requ\", \"est and the user isn't authenticated, the WebView will be redirected to the configured login page, w\", \"hich is shown in Figure 9-4.\\n\\n**Figure 9-4:** Login page displayed by the WebView\\n\\nOnce login is com\", \"pleted, the WebView will be redirected to a return URI. This WebView navigation will cause the Navig\", \"ateAsync method in the LoginViewModel class to be executed, which is shown in the following code exa\", \"mple:\\n\\n```\\nprivate async Task NavigateAsync(string url)\\n{\\n ...\\n var authResponse = new AuthorizeResp\", \"onse(url);\\n if (!string.IsNullOrWhiteSpace(authResponse.Code))\\n {\\n var userToken = await _identitySe\", \"rvice.GetTokenAsync(authResponse.Code);\\n string accessToken = userToken.AccessToken;\\n if (!string.Is\", \"NullOrWhiteSpace(accessToken))\\n {\\n Settings.AuthAccessToken = accessToken;\\n Settings.AuthIdToken = a\", \"uthResponse.IdentityToken;\\n await NavigationService.NavigateToAsync<MainViewModel>();\\n await Navigat\", \"ionService.RemoveLastFromBackStackAsync();\\n }\\n }\\n ...\\n}\\n```\\n\\nThis method parses the authentication r\", \"esponse that's contained in the return URI, and provided that a valid authorization code is present,\", \" it makes a request to IdentityServer's [token endpoint,](https://identityserver4.readthedocs.io/en/\", \"release/endpoints/token.html) passing the authorization code, the PKCE secret verifier, and other re\", \"quired parameters. The token endpoint is at /connect/token on port 5105 of the base endpoint exposed\", \" as a user setting. For more information about user settings, se[e Configuration management.](#page-\", \"52-0)\\n\\n#### **Tip**: Validate return URIs\\n\\nAlthough the eShopOnContainers mobile app doesn't validat\", \"e the return URI, the best practice is to validate that the return URI refers to a known location in\", \" order to prevent open-redirect attacks.\\n\\nIf the token endpoint receives a valid authorization code \", \"and PKCE secret verifier, it responds with an access token, identity token, and refresh token. The a\", \"ccess token (which allows access to API resources) and identity token are then stored as application\", \" settings, and page navigation is performed. Therefore, the overall effect in the eShopOnContainers \", \"mobile app is this: provided that users are able to successfully authenticate with IdentityServer, t\", \"hey are navigated to the MainView page, which is a TabbedPage that displays the CatalogView as its s\", \"elected tab.\\n\\nFor information about page navigation, see [Navigation.](#page-34-0) For information a\", \"bout how WebView navigation causes a view model method to be executed, see [Invoking navigation usin\", \"g behaviors.](#page-40-0) For information about application settings, see [Configuration management.\", \"](#page-52-0)\\n\\n**Note:** The eShopOnContainers also allows a mock sign-in when the app is configured\", \" to use mock services in the SettingsView. In this mode, the app doesn't communicate with IdentitySe\", \"rver, instead allowing the user to sign-in using any credentials.\\n\\n#### **Signing-out**\\n\\nWhen the us\", \"er taps the **LOG OUT** button in the ProfileView, the LogoutCommand in the ProfileViewModel class i\", \"s executed, which in turn executes the LogoutAsync method. This method performs page navigation to t\", \"he LoginView page, passing a LogoutParameter instance set to true as a parameter. For more informati\", \"on about passing parameters during page navigation, see [Passing](#page-39-0)  [parameters during na\", \"vigation.](#page-39-0)\\n\\nWhen a view is created and navigated to, the InitializeAsync method of the v\", \"iew's associated view model is executed, which then executes the Logout method of the LoginViewModel\", \" class, which is shown in the following code example:\\n\\n```\\nprivate void Logout()\\n{\\n var authIdToken \", \"= Settings.AuthIdToken;\\n var logoutRequest = _identityService.CreateLogoutRequest(authIdToken);\\n if \", \"(!string.IsNullOrEmpty(logoutRequest))\\n {\\n // Logout\\n LoginUrl = logoutRequest;\\n }\\n ...\\n}\\n```\\n\\nThis \", \"method invokes the CreateLogoutRequest method in the IdentityService class, passing the identity tok\", \"en retrieved from application settings as a parameter. For more information about application settin\", \"gs, see [Configuration management.](#page-52-0) The following code example shows the CreateLogoutReq\", \"uest method:\\n\\n```\\npublic string CreateLogoutRequest(string token)\\n{\\n ...\\n return string.Format(\\\"{0}?\", \"id_token_hint={1}&post_logout_redirect_uri={2}\\\",\\n GlobalSetting.Instance.LogoutEndpoint,\\n token,\\n Gl\", \"obalSetting.Instance.LogoutCallback);\\n}\\n```\\n\\nThis method creates the URI to IdentityServer's [end se\", \"ssion endpoint,](https://identityserver4.readthedocs.io/en/release/endpoints/endsession.html#refends\", \"ession) with the required parameters. The end session endpoint is at /connect/endsession on port 510\", \"5 of the base endpoint exposed as a user setting. For more information about user settings, see [Con\", \"figuration management.](#page-52-0)\\n\\nThe returned URI is stored in the LoginUrl property of the Logi\", \"nViewModel class. While the IsLogin property is true, the WebView in the LoginView is visible. The W\", \"ebView data binds its Source property to the LoginUrl property of the LoginViewModel class, and so m\", \"akes a sign-out request to IdentityServer when the LoginUrl property is set to IdentityServer's end \", \"session endpoint. When IdentityServer receives this request, provided that the user is signed-in, si\", \"gn-out occurs. Authentication is tracked with a cookie managed by the cookie authentication middlewa\", \"re from ASP.NET Core. Therefore, signing out of IdentityServer removes the authentication cookie and\", \" sends a post logout redirect URI back to the client.\\n\\nIn the mobile app, the WebView will be redire\", \"cted to the post logout redirect URI. This WebView navigation will cause the NavigateAsync method in\", \" the LoginViewModel class to be executed, which is shown in the following code example:\\n\\n```\\nprivate\", \" async Task NavigateAsync(string url)\\n{\\n ...\\n Settings.AuthAccessToken = string.Empty;\\n Settings.Aut\", \"hIdToken = string.Empty;\\n IsLogin = false;\\n LoginUrl = _identityService.CreateAuthorizationRequest()\", \";\\n ...\\n}\\n```\\n\\nThis method clears both the identity token and the access token from application setti\", \"ngs, and sets the IsLogin property to false, which causes the WebView on the LoginView page to becom\", \"e invisible. Finally, the LoginUrl property is set to the URI of IdentityServer's [authorization end\", \"point,](https://identityserver4.readthedocs.io/en/release/endpoints/authorize.html) with the require\", \"d parameters, in preparation for the next time the user initiates a sign-in.\\n\\nFor information about \", \"page navigation, see [Navigation.](#page-34-0) For information about how WebView navigation causes a\", \" view model method to be executed, see [Invoking navigation using behaviors.](#page-40-0) For inform\", \"ation about application settings, see [Configuration management.](#page-52-0)\\n\\n**Note:** The eShopOn\", \"Containers also allows a mock sign-out when the app is configured to use mock services in the Settin\", \"gsView. In this mode, the app doesn't communicate with IdentityServer, and instead clears any stored\", \" tokens from application settings.\\n\\n# <span id=\\\"page-75-0\\\"></span>Authorization\\n\\nAfter authenticatio\", \"n, ASP.NET Core web APIs often need to authorize access, which allows a service to make APIs availab\", \"le to some authenticated users, but not to all.\\n\\nRestricting access to an ASP.NET Core MVC route can\", \" be achieved by applying an Authorize attribute to a controller or action, which limits access to th\", \"e controller or action to authenticated users, as shown in the following code example:\\n\\n```\\n[Authori\", \"ze]\\npublic class BasketController : Controller\\n{\\n ...\\n}\\n```\\n\\nIf an unauthorized user attempts to acc\", \"ess a controller or action that's marked with the Authorize attribute, the MVC framework returns a 4\", \"01 (unauthorized) HTTP status code.\\n\\n**Note:** Parameters can be specified on the Authorize attribut\", \"e to restrict an API to specific users. For more information, see [Authorization](https://docs.micro\", \"soft.com/en-us/aspnet/core/security/authorization/introduction) on the Microsoft Documentation Cente\", \"r.\\n\\nIdentityServer can be integrated into the authorization workflow so that the access tokens it pr\", \"ovides control authorization. This approach is shown in Figure 9-5.\\n\\n![](_page_76_Figure_1.jpeg)\\n\\n**\", \"Figure 9-5:** Authorization by access token\\n\\nThe eShopOnContainers mobile app communicates with the \", \"identity microservice and requests an access token as part of the authentication process. The access\", \" token is then forwarded to the APIs exposed by the ordering and basket microservices as part of the\", \" access requests. Access tokens contain information about the client, and the user. APIs then use th\", \"at information to authorize access to their data. For information about how to configure IdentitySer\", \"ver to protect APIs, see [Configuring](#page-68-0)  [API resources.](#page-68-0)\\n\\n## **Configuring I\", \"dentityServer to perform authorization**\\n\\nTo perform authorization with IdentityServer, its authoriz\", \"ation middleware must be added to the web application's HTTP request pipeline. The middleware is add\", \"ed in the ConfigureAuth method in the web application's Startup class, which is invoked from the Con\", \"figure method, and is demonstrated in the following code example from the eShopOnContainers referenc\", \"e application:\\n\\n```\\nprotected virtual void ConfigureAuth(IApplicationBuilder app)\\n{\\n var identityUrl\", \" = Configuration.GetValue<string>(\\\"IdentityUrl\\\");\\n app.UseIdentityServerAuthentication(new IdentityS\", \"erverAuthenticationOptions\\n {\\n Authority = identityUrl.ToString(),\\n ScopeName = \\\"basket\\\",\\n RequireHt\", \"tpsMetadata = false\\n });\\n}\\n```\\n\\nThis method ensures that the API can only be accessed with a valid a\", \"ccess token. The middleware validates the incoming token to ensure that it's sent from a trusted iss\", \"uer, and validates that the token is valid to be used with the API that receives it. Therefore, brow\", \"sing to the ordering or basket controller will return a 401 (unauthorized) HTTP status code, indicat\", \"ing that an access token is required.\\n\\n**Note:** IdentityServer's authorization middleware must be a\", \"dded to the web application's HTTP request pipeline before adding MVC with app.UseMvc() or app.UseMv\", \"cWithDefaultRoute().\\n\\n#### **Making access requests to APIs**\\n\\nWhen making requests to the ordering \", \"and basket microservices, the access token, obtained from IdentityServer during the authentication p\", \"rocess, must be included in the request, as shown in the following code example:\\n\\n```\\nvar authToken \", \"= Settings.AuthAccessToken;\\nOrder = await _ordersService.GetOrderAsync(Convert.ToInt32(order.OrderNu\", \"mber), authToken);\\n```\\n\\nThe access token is stored as an application setting, and is retrieved from \", \"platform-specific storage and included in the call to the GetOrderAsync method in the OrderService c\", \"lass.\\n\\nSimilarly, the access token must be included when sending data to an IdentityServer protected\", \" API, as shown in the following code example:\\n\\n```\\nvar authToken = Settings.AuthAccessToken;\\nawait _\", \"basketService.UpdateBasketAsync(new CustomerBasket\\n{\\n BuyerId = userInfo.UserId,\\n Items = BasketItem\", \"s.ToList()\\n}, authToken);\\n```\\n\\nThe access token is retrieved from platform-specific storage and incl\", \"uded in the call to the UpdateBasketAsync method in the BasketService class.\\n\\nThe RequestProvider cl\", \"ass, in the eShopOnContainers mobile app, uses the HttpClient class to make requests to the RESTful \", \"APIs exposed by the eShopOnContainers reference application. When making requests to the ordering an\", \"d basket APIs, which require authorization, a valid access token must be included with the request. \", \"This is achieved by adding the access token to the headers of the HttpClient instance, as demonstrat\", \"ed in the following code example:\\n\\n```\\nhttpClient.DefaultRequestHeaders.Authorization = new Authenti\", \"cationHeaderValue(\\\"Bearer\\\", token);\\n```\\n\\nThe DefaultRequestHeaders property of the HttpClient class \", \"exposes the headers that are sent with each request, and the access token is added to the Authorizat\", \"ion header prefixed with the string Bearer. When the request is sent to a RESTful API, the value of \", \"the Authorization header is extracted and validated to ensure that it's sent from a trusted issuer, \", \"and used to determine whether the user has permission to invoke the API that receives it.\\n\\nFor more \", \"information about how the eShopOnContainers mobile app makes web requests, see [Accessing remote dat\", \"a.](#page-79-0)\\n\\n# Summary\\n\\nThere are many approaches to integrating authentication and authorizatio\", \"n into a Xamarin.Forms app that communicates with an ASP.NET MVC web application. The eShopOnContain\", \"ers mobile app performs authentication and authorization with a containerized identity microservice \", \"that uses IdentityServer 4. IdentityServer is an open source OpenID Connect and OAuth 2.0 framework \", \"for ASP.NET Core that integrates with ASP.NET Core Identity to perform bearer token authentication.\\n\", \"\\nThe mobile app requests security tokens from IdentityServer, either for authenticating a user or fo\", \"r accessing a resource. When accessing a resource, an access token must be included in the request t\", \"o APIs that require authorization. IdentityServer's middleware validates incoming access tokens to e\", \"nsure that they are sent from a trusted issuer, and that they are valid to be used with the API that\", \" receives them.\\n\\n# <span id=\\\"page-79-0\\\"></span>Accessing remote data\\n\\nMany modern web-based solution\", \"s make use of web services, hosted by web servers, to provide functionality for remote client applic\", \"ations. The operations that a web service exposes constitute a web API.\\n\\nClient apps should be able \", \"to utilize the web API without knowing how the data or operations that the API exposes are implement\", \"ed. This requires that the API abides by common standards that enable a client app and web service t\", \"o agree on which data formats to use, and the structure of the data that is exchanged between client\", \" apps and the web service.\\n\\n# Introduction to Representational State Transfer\\n\\nRepresentational Stat\", \"e Transfer (REST) is an architectural style for building distributed systems based on hypermedia. A \", \"primary advantage of the REST model is that it's based on open standards and doesn't bind the implem\", \"entation of the model or the client apps that access it to any specific implementation. Therefore, a\", \" REST web service could be implemented using Microsoft ASP.NET Core MVC, and client apps could be de\", \"veloping using any language and toolset that can generate HTTP requests and parse HTTP responses.\\n\\nT\", \"he REST model uses a navigational scheme to represent objects and services over a network, referred \", \"to as resources. Systems that implement REST typically use the HTTP protocol to transmit requests to\", \" access these resources. In such systems, a client app submits a request in the form of a URI that i\", \"dentifies a resource, and an HTTP method (such as GET, POST, PUT, or DELETE) that indicates the oper\", \"ation to be performed on that resource. The body of the HTTP request contains any data required to p\", \"erform the operation.\\n\\n**Note:** REST defines a stateless request model. Therefore, HTTP requests mu\", \"st be independent and might occur in any order.\\n\\nThe response from a REST request makes use of stand\", \"ard HTTP status codes. For example, a request that returns valid data should include the HTTP respon\", \"se code 200 (OK), while a request that fails to find or delete a specified resource should return a \", \"response that includes the HTTP status code 404 (Not Found).\\n\\nA RESTful web API exposes a set of con\", \"nected resources, and provides the core operations that enable an app to manipulate those resources \", \"and easily navigate between them. For this reason, the URIs that constitute a typical RESTful web AP\", \"I are oriented towards the data that it exposes, and use the facilities provided by HTTP to operate \", \"on this data.\\n\\nThe data included by a client app in an HTTP request, and the corresponding response \", \"messages from the web server, could be presented in a variety of formats, known as media types. When\", \" a client app sends a request that returns data in the body of a message, it can specify the media t\", \"ypes it can handle in the Accept header of the request. If the web server supports this media type, \", \"it can reply with a response that includes the Content-Type header that specifies the format of the \", \"data in the body of the message. It's then the responsibility of the client app to parse the respons\", \"e message and interpret the results in the message body appropriately.\\n\\nFor more information about R\", \"EST, see [API design](https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-design)\", \" an[d API implementation](https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-imp\", \"lementation) on Microsoft Docs.\\n\\n# Consuming RESTful APIs\\n\\nThe eShopOnContainers mobile app uses the\", \" Model-View-ViewModel (MVVM) pattern, and the model elements of the pattern represent the domain ent\", \"ities used in the app. The controller and repository classes in the eShopOnContainers reference appl\", \"ication accept and return many of these model objects. Therefore, they are used as data transfer obj\", \"ects (DTOs) that hold all the data that is passed between the mobile app and the containerized micro\", \"services. The main benefit of using DTOs to pass data to and receive data from a web service is that\", \" by transmitting more data in a single remote call, the app can reduce the number of remote calls th\", \"at need to be made.\\n\\n### **Making web requests**\\n\\nThe eShopOnContainers mobile app uses the HttpClie\", \"nt class to make requests over HTTP, with JSON being used as the media type. This class provides fun\", \"ctionality for asynchronously sending HTTP requests and receiving HTTP responses from a URI identifi\", \"ed resource. The HttpResponseMessage class represents an HTTP response message received from a REST \", \"API after an HTTP request has been made. It contains information about the response, including the s\", \"tatus code, headers, and any body. The HttpContent class represents the HTTP body and content header\", \"s, such as Content-Type and Content-Encoding. The content can be read using any of the ReadAs method\", \"s, such as ReadAsStringAsync and ReadAsByteArrayAsync, depending on the format of the data.\\n\\n#### <s\", \"pan id=\\\"page-80-0\\\"></span>**Making a GET request**\\n\\nThe CatalogService class is used to manage the d\", \"ata retrieval process from the catalog microservice. In the RegisterDependencies method in the ViewM\", \"odelLocator class, the CatalogService class is registered as a type mapping against the ICatalogServ\", \"ice type with the Autofac dependency injection container. Then, when an instance of the CatalogViewM\", \"odel class is created, its constructor accepts an ICatalogService type, which Autofac resolves, retu\", \"rning an instance of the CatalogService class. For more information about dependency injection, see \", \"[Introduction to dependency injection.](#page-24-1)\\n\\nFigure 10-1 shows the interaction of classes th\", \"at read catalog data from the catalog microservice for displaying by the CatalogView.\\n\\n![](_page_81_\", \"Figure_0.jpeg)\\n\\n**Figure 10-1**: Retrieving data from the catalog microservice\\n\\nWhen the CatalogView\", \" is navigated to, the OnInitialize method in the CatalogViewModel class is called. This method retri\", \"eves catalog data from the catalog microservice, as demonstrated in the following code example:\\n\\n```\", \"\\npublic override async Task InitializeAsync(object navigationData)\\n{\\n ...\\n Products = await _product\", \"sService.GetCatalogAsync();\\n ...\\n}\\n```\\n\\nThis method calls the GetCatalogAsync method of the CatalogS\", \"ervice instance that was injected into the CatalogViewModel by Autofac. The following code example s\", \"hows the GetCatalogAsync method:\\n\\n```\\npublic async Task<ObservableCollection<CatalogItem>> GetCatalo\", \"gAsync()\\n{\\n UriBuilder builder = new UriBuilder(GlobalSetting.Instance.CatalogEndpoint);\\n builder.Pa\", \"th = \\\"api/v1/catalog/items\\\";\\n string uri = builder.ToString();\\n CatalogRoot catalog = await _request\", \"Provider.GetAsync<CatalogRoot>(uri);\\n ...\\n```\\n\\n```\\n return catalog?.Data.ToObservableCollection(); \\n\", \"}\\n```\\n\\nThis method builds the URI that identifies the resource the request will be sent to, and uses\", \" the RequestProvider class to invoke the GET HTTP method on the resource, before returning the resul\", \"ts to the CatalogViewModel. The RequestProvider class contains functionality that submits a request \", \"in the form of a URI that identifies a resource, an HTTP method that indicates the operation to be p\", \"erformed on that resource, and a body that contains any data required to perform the operation. For \", \"information about how the RequestProvider class is injected into the CatalogService class, see [Intr\", \"oduction to dependency injection.](#page-24-1)\\n\\nThe following code example shows the GetAsync method\", \" in the RequestProvider class:\\n\\n```\\npublic async Task<TResult> GetAsync<TResult>(string uri, string \", \"token = \\\"\\\")\\n{\\n HttpClient httpClient = CreateHttpClient(token);\\n HttpResponseMessage response = awai\", \"t httpClient.GetAsync(uri);\\n await HandleResponse(response);\\n string serialized = await response.Con\", \"tent.ReadAsStringAsync();\\n TResult result = await Task.Run(() =>\\n JsonConvert.DeserializeObject<TRes\", \"ult>(serialized, _serializerSettings));\\n return result;\\n}\\n```\\n\\nThis method calls the CreateHttpClien\", \"t method, which returns an instance of the HttpClient class with the appropriate headers set. It the\", \"n submits an asynchronous GET request to the resource identified by the URI, with the response being\", \" stored in the HttpResponseMessage instance. The HandleResponse method is then invoked, which throws\", \" an exception if the response doesn't include a success HTTP status code. Then the response is read \", \"as a string, converted from JSON to a CatalogRoot object, and returned to the CatalogService.\\n\\nThe C\", \"reateHttpClient method is shown in the following code example:\\n\\n```\\nprivate HttpClient CreateHttpCli\", \"ent(string token = \\\"\\\")\\n{\\n var httpClient = new HttpClient();\\n httpClient.DefaultRequestHeaders.Accep\", \"t.Add(\\n new MediaTypeWithQualityHeaderValue(\\\"application/json\\\"));\\n if (!string.IsNullOrEmpty(token))\", \"\\n {\\n httpClient.DefaultRequestHeaders.Authorization =\\n new AuthenticationHeaderValue(\\\"Bearer\\\", token\", \");\\n }\\n return httpClient;\\n}\\n```\\n\\nThis method creates a new instance of the HttpClient class, and set\", \"s the Accept header of any requests made by the HttpClient instance to application/json, which indic\", \"ates that it expects the content of any response to be formatted using JSON. Then, if an access toke\", \"n was passed as an argument to the CreateHttpClient method, it's added to the Authorization header o\", \"f any requests made by the HttpClient instance, prefixed with the string Bearer. For more informatio\", \"n about authorization, see [Authorization.](#page-75-0)\\n\\nWhen the GetAsync method in the RequestProv\", \"ider class calls HttpClient.GetAsync, the Items method in the CatalogController class in the Catalog\", \".API project is invoked, which is shown in the following code example:\\n\\n```\\n[HttpGet]\\n[Route(\\\"[actio\", \"n]\\\")]\\npublic async Task<IActionResult> Items(\\n [FromQuery]int pageSize = 10, [FromQuery]int pageInde\", \"x = 0)\\n{\\n var totalItems = await _catalogContext.CatalogItems\\n .LongCountAsync();\\n var itemsOnPage =\", \" await _catalogContext.CatalogItems\\n .OrderBy(c=>c.Name)\\n .Skip(pageSize * pageIndex)\\n .Take(pageSiz\", \"e)\\n .ToListAsync();\\n itemsOnPage = ComposePicUri(itemsOnPage);\\n var model = new PaginatedItemsViewMo\", \"del<CatalogItem>(\\n pageIndex, pageSize, totalItems, itemsOnPage); \\n return Ok(model);\\n}\\n```\\n\\nThis me\", \"thod retrieves the catalog data from the SQL database using EntityFramework, and returns it as a res\", \"ponse message that includes a success HTTP status code, and a collection of JSON formatted CatalogIt\", \"em instances.\\n\\n#### **Making a POST request**\\n\\nThe BasketService class is used to manage the data re\", \"trieval and update process with the basket microservice. In the RegisterDependencies method in the V\", \"iewModelLocator class, the BasketService class is registered as a type mapping against the IBasketSe\", \"rvice type with the Autofac dependency injection container. Then, when an instance of the BasketView\", \"Model class is created, its constructor accepts an IBasketService type, which Autofac resolves, retu\", \"rning an instance of the BasketService class. For more information about dependency injection, see [\", \"Introduction to dependency injection.](#page-24-1)\\n\\nFigure 10-2 shows the interaction of classes tha\", \"t send the basket data displayed by the BasketView, to the basket microservice.\\n\\n![](_page_84_Figure\", \"_0.jpeg)\\n\\n**Figure 10-2**: Sending data to the basket microservice\\n\\nWhen an item is added to the sho\", \"pping basket, the ReCalculateTotalAsync method in the BasketViewModel class is called. This method u\", \"pdates the total value of items in the basket, and sends the basket data to the basket microservice,\", \" as demonstrated in the following code example:\\n\\n```\\nprivate async Task ReCalculateTotalAsync()\\n{\\n .\", \"..\\n await _basketService.UpdateBasketAsync(new CustomerBasket\\n {\\n BuyerId = userInfo.UserId,\\n Items \", \"= BasketItems.ToList()\\n }, authToken);\\n}\\n```\\n\\nThis method calls the UpdateBasketAsync method of the \", \"BasketService instance that was injected into the BasketViewModel by Autofac. The following method s\", \"hows the UpdateBasketAsync method:\\n\\n```\\npublic async Task<CustomerBasket> UpdateBasketAsync(Customer\", \"Basket customerBasket, string token)\\n{\\n UriBuilder builder = new UriBuilder(GlobalSetting.Instance.B\", \"asketEndpoint);\\n string uri = builder.ToString();\\n```\\n\\n```\\n var result = await _requestProvider.Post\", \"Async(uri, customerBasket, token);\\n return result;\\n}\\n```\\n\\nThis method builds the URI that identifies\", \" the resource the request will be sent to, and uses the RequestProvider class to invoke the POST HTT\", \"P method on the resource, before returning the results to the BasketViewModel. Note that an access t\", \"oken, obtained from IdentityServer during the authentication process, is required to authorize reque\", \"sts to the basket microservice. For more information about authorization, see [Authorization.](#page\", \"-75-0)\\n\\nThe following code example shows one of the PostAsync methods in the RequestProvider class:\\n\", \"\\n```\\npublic async Task<TResult> PostAsync<TResult>(\\n string uri, TResult data, string token = \\\"\\\", st\", \"ring header = \\\"\\\")\\n{\\n HttpClient httpClient = CreateHttpClient(token);\\n ...\\n var content = new String\", \"Content(JsonConvert.SerializeObject(data));\\n content.Headers.ContentType = new MediaTypeHeaderValue(\", \"\\\"application/json\\\");\\n HttpResponseMessage response = await httpClient.PostAsync(uri, content);\\n awai\", \"t HandleResponse(response);\\n string serialized = await response.Content.ReadAsStringAsync();\\n TResul\", \"t result = await Task.Run(() =>\\n JsonConvert.DeserializeObject<TResult>(serialized, _serializerSetti\", \"ngs));\\n return result;\\n}\\n```\\n\\nThis method calls the CreateHttpClient method, which returns an instan\", \"ce of the HttpClient class with the appropriate headers set. It then submits an asynchronous POST re\", \"quest to the resource identified by the URI, with the serialized basket data being sent in JSON form\", \"at, and the response being stored in the HttpResponseMessage instance. The HandleResponse method is \", \"then invoked, which throws an exception if the response doesn't include a success HTTP status code. \", \"Then, the response is read as a string, converted from JSON to a CustomerBasket object, and returned\", \" to the BasketService. For more information about the CreateHttpClient method, see [Making a GET req\", \"uest.](#page-80-0)\\n\\nWhen the PostAsync method in the RequestProvider class calls HttpClient.PostAsyn\", \"c, the Post method in the BasketController class in the Basket.API project is invoked, which is show\", \"n in the following code example:\\n\\n```\\n[HttpPost]\\npublic async Task<IActionResult> Post([FromBody]Cus\", \"tomerBasket value)\\n{\\n var basket = await _repository.UpdateBasketAsync(value);\\n return Ok(basket);\\n}\", \"\\n```\\n\\nThis method uses an instance of the RedisBasketRepository class to persist the basket data to \", \"the Redis cache, and returns it as a response message that includes a success HTTP status code, and \", \"a JSON formatted CustomerBasket instance.\\n\\n#### **Making a DELETE request**\\n\\nFigure 10-3 shows the i\", \"nteractions of classes that delete basket data from the basket microservice, for the CheckoutView.\\n\\n\", \"![](_page_86_Figure_0.jpeg)\\n\\n**Figure 10-3**: Deleting data from the basket microservice\\n\\nWhen the c\", \"heckout process is invoked, the CheckoutAsync method in the CheckoutViewModel class is called. This \", \"method creates a new order, before clearing the shopping basket, as demonstrated in the following co\", \"de example:\\n\\n```\\nprivate async Task CheckoutAsync()\\n{\\n ...\\n await _basketService.ClearBasketAsync(_s\", \"hippingAddress.Id.ToString(), authToken);\\n ...\\n}\\n```\\n\\nThis method calls the ClearBasketAsync method \", \"of the BasketService instance that was injected into the CheckoutViewModel by Autofac. The following\", \" method shows the ClearBasketAsync method:\\n\\n```\\npublic async Task ClearBasketAsync(string guidUser, \", \"string token)\\n{\\n UriBuilder builder = new UriBuilder(GlobalSetting.Instance.BasketEndpoint);\\n builde\", \"r.Path = guidUser;\\n string uri = builder.ToString();\\n await _requestProvider.DeleteAsync(uri, token)\", \";\\n}\\n```\\n\\nThis method builds the URI that identifies the resource that the request will be sent to, a\", \"nd uses the RequestProvider class to invoke the DELETE HTTP method on the resource. Note that an acc\", \"ess token, obtained from IdentityServer during the authentication process, is required to authorize \", \"requests to the basket microservice. For more information about authorization, see [Authorization.](\", \"#page-75-0)\\n\\nThe following code example shows the DeleteAsync method in the RequestProvider class:\\n\\n\", \"```\\npublic async Task DeleteAsync(string uri, string token = \\\"\\\")\\n{\\n HttpClient httpClient = CreateHt\", \"tpClient(token);\\n await httpClient.DeleteAsync(uri);\\n}\\n```\\n\\nThis method calls the CreateHttpClient m\", \"ethod, which returns an instance of the HttpClient class with the appropriate headers set. It then s\", \"ubmits an asynchronous DELETE request to the resource identified by the URI. For more information ab\", \"out the CreateHttpClient method, se[e Making a GET](#page-80-0)  [request.](#page-80-0)\\n\\nWhen the De\", \"leteAsync method in the RequestProvider class calls HttpClient.DeleteAsync, the Delete method in the\", \" BasketController class in the Basket.API project is invoked, which is shown in the following code e\", \"xample:\\n\\n```\\n[HttpDelete(\\\"{id}\\\")]\\npublic void Delete(string id)\\n{\\n _repository.DeleteBasketAsync(id)\", \";\\n}\\n```\\n\\nThis method uses an instance of the RedisBasketRepository class to delete the basket data f\", \"rom the Redis cache.\\n\\n# Caching data\\n\\nThe performance of an app can be improved by caching frequentl\", \"y accessed data to fast storage that's located close to the app. If the fast storage is located clos\", \"er to the app than the original source, then caching can significantly improve response times when r\", \"etrieving data.\\n\\nThe most common form of caching is read-through caching, where an app retrieves dat\", \"a by referencing the cache. If the data isn't in the cache, it's retrieved from the data store and a\", \"dded to the cache. Apps can implement read-through caching with the cache-aside pattern. This patter\", \"n determines whether the item is currently in the cache. If the item isn't in the cache, it's read f\", \"rom the data store and added to the cache. For more information, see the [Cache-Aside](https://docs.\", \"microsoft.com/en-us/azure/architecture/patterns/cache-aside) pattern on Microsoft Docs.\\n\\n**Tip:** Ca\", \"che data that's read frequently and that changes infrequently\\n\\nThis data can be added to the cache o\", \"n demand the first time it is retrieved by an app. This means that the app needs to fetch the data o\", \"nly once from the data store, and that subsequent access can be satisfied by using the cache.\\n\\nDistr\", \"ibuted applications, such as the eShopOnContainers reference application, should provide either or b\", \"oth of the following caches:\\n\\n- A shared cache, which can be accessed by multiple processes or machi\", \"nes.\\n- A private cache, where data is held locally on the device running the app.\\n\\nThe eShopOnContai\", \"ners mobile app uses a private cache, where data is held locally on the device that's running an ins\", \"tance of the app. For information about the cache used by the eShopOnContainers reference applicatio\", \"n, see [.NET Microservices: Architecture for Containerized .NET](https://aka.ms/microservicesebook) \", \" [Applications.](https://aka.ms/microservicesebook)\\n\\n**Tip:** Think of the cache as a transient data\", \" store that could disappear at any time\\n\\nEnsure that data is maintained in the original data store a\", \"s well as the cache. The chances of losing data are then minimized if the cache becomes unavailable.\", \"\\n\\n#### **Managing data expiration**\\n\\nIt's impractical to expect that cached data will always be cons\", \"istent with the original data. Data in the original data store might change after it's been cached, \", \"causing the cached data to become stale. Therefore, apps should implement a strategy that helps to e\", \"nsure that the data in the cache is as upto-date as possible, but can also detect and handle situati\", \"ons that arise when the data in the cache has become stale. Most caching mechanisms enable the cache\", \" to be configured to expire data, and hence reduce the period for which data might be out of date.\\n\\n\", \"**Tip:** Set a default expiration time when configuring a cache\\n\\nMany caches implement expiration, w\", \"hich invalidates data and removes it from the cache if it's not accessed for a specified period. How\", \"ever, care must be taken when choosing the expiration period. If it's made too short, data will expi\", \"re too quickly and the benefits of caching will be reduced. If it's made too long, the data risks be\", \"coming stale. Therefore, the expiration time should match the pattern of access for apps that use th\", \"e data.\\n\\nWhen cached data expires, it should be removed from the cache, and the app must retrieve th\", \"e data from the original data store and place it back into the cache.\\n\\nIt's also possible that a cac\", \"he might fill up if data is allowed to remain for too long a period. Therefore, requests to add new \", \"items to the cache might be required to remove some items in a process known as *eviction*. Caching \", \"services typically evict data on a least-recently-used basis. However, there are other eviction poli\", \"cies, including most-recently-used, and first-in-first-out. For more information, see [Caching Guida\", \"nce](https://docs.microsoft.com/en-us/azure/architecture/best-practices/caching) on Microsoft Docs.\\n\", \"\\n## <span id=\\\"page-88-0\\\"></span>**Caching images**\\n\\nThe eShopOnContainers mobile app consumes remote\", \" product images that benefit from being cached. These images are displayed by the Image control, and\", \" the CachedImage control provided by th[e FFImageLoading](https://www.nuget.org/packages/Xamarin.FFI\", \"mageLoading.Forms/) library.\\n\\nThe Xamarin.Forms Image control supports caching of downloaded images.\", \" Caching is enabled by default, and will store the image locally for 24 hours. In addition, the expi\", \"ration time can be configured with the CacheValidity property. For more information, se[e Downloaded\", \" Image Caching](https://developer.xamarin.com/guides/xamarin-forms/user-interface/images/#Downloaded\", \"_Image_Caching) on the Xamarin Developer Center.\\n\\nFFImageLoading's CachedImage control is a replacem\", \"ent for the Xamarin.Forms Image control, providing additional properties that enable supplementary f\", \"unctionality. Amongst this functionality, the control provides configurable caching, while supportin\", \"g error and loading image placeholders. The following code example shows how the eShopOnContainers m\", \"obile app uses the CachedImage control in the ProductTemplate, which is the data template used by th\", \"e ListView control in the CatalogView:\\n\\n```\\n<ffimageloading:CachedImage\\n Grid.Row=\\\"0\\\"\\n Source=\\\"{Bind\", \"ing PictureUri}\\\" \\n Aspect=\\\"AspectFill\\\">\\n <ffimageloading:CachedImage.LoadingPlaceholder>\\n <OnPlatfor\", \"m \\n x:TypeArguments=\\\"ImageSource\\\"\\n```\\n\\n```\\n iOS=\\\"default_product\\\"\\n Android=\\\"default_product\\\"\\n WinPho\", \"ne=\\\"Assets/default_product.png\\\"/>\\n </ffimageloading:CachedImage.LoadingPlaceholder>\\n <ffimageloading\", \":CachedImage.ErrorPlaceholder>\\n <OnPlatform \\n x:TypeArguments=\\\"ImageSource\\\"\\n iOS=\\\"noimage\\\"\\n Android=\", \"\\\"noimage\\\"\\n WinPhone=\\\"Assets/noimage.png\\\"/>\\n </ffimageloading:CachedImage.ErrorPlaceholder>\\n</ffimage\", \"loading:CachedImage>\\n```\\n\\nThe CachedImage control sets the LoadingPlaceholder and ErrorPlaceholder p\", \"roperties to platform-specific images. The LoadingPlaceholder property specifies the image to be dis\", \"played while the image specified by the Source property is retrieved, and the ErrorPlaceholder prope\", \"rty specifies the image to be displayed if an error occurs when attempting to retrieve the image spe\", \"cified by the Source property.\\n\\nAs the name implies, the CachedImage control caches remote images on\", \" the device for the time specified by the value of the CacheDuration property. When this property va\", \"lue isn't explicitly set, the default value of 30 days is applied.\\n\\n# Increasing resilience\\n\\nAll app\", \"s that communicate with remote services and resources must be sensitive to transient faults. Transie\", \"nt faults include the momentary loss of network connectivity to services, the temporary unavailabili\", \"ty of a service, or timeouts that arise when a service is busy. These faults are often selfcorrectin\", \"g, and if the action is repeated after a suitable delay it's likely to succeed.\\n\\nTransient faults ca\", \"n have a huge impact on the perceived quality of an app, even if it has been thoroughly tested under\", \" all foreseeable circumstances. To ensure that an app that communicates with remote services operate\", \"s reliably, it must be able to do all of the following:\\n\\n- Detect faults when they occur, and determ\", \"ine if the faults are likely to be transient.\\n- Retry the operation if it determines that the fault \", \"is likely to be transient and keep track of the number of times the operation was retried.\\n- Use an \", \"appropriate retry strategy, which specifies the number of retries, the delay between each attempt, a\", \"nd the actions to take after a failed attempt.\\n\\nThis transient fault handling can be achieved by wra\", \"pping all attempts to access a remote service in code that implements the retry pattern.\\n\\n## **Retry\", \" pattern**\\n\\nIf an app detects a failure when it tries to send a request to a remote service, it can \", \"handle the failure in any of the following ways:\\n\\n- Retrying the operation. The app could retry the \", \"failing request immediately.\\n- Retrying the operation after a delay. The app should wait for a suita\", \"ble amount of time before retrying the request.\\n- Cancelling the operation. The application should c\", \"ancel the operation and report an exception.\\n\\nThe retry strategy should be tuned to match the busine\", \"ss requirements of the app. For example, it's important to optimize the retry count and retry interv\", \"al to the operation being attempted. If the operation is part of a user interaction, the retry inter\", \"val should be short and only a few retries attempted to avoid making users wait for a response. If t\", \"he operation is part of a long running workflow, where cancelling or restarting the workflow is expe\", \"nsive or time-consuming, it's appropriate to wait longer between attempts and to retry more times.\\n\\n\", \"**Note:** An aggressive retry strategy with minimal delay between attempts, and a large number of re\", \"tries, could degrade a remote service that's running close to or at capacity. In addition, such a re\", \"try strategy could also affect the responsiveness of the app if it's continually trying to perform a\", \" failing operation.\\n\\nIf a request still fails after a number of retries, it's better for the app to \", \"prevent further requests going to the same resource and to report a failure. Then, after a set perio\", \"d, the app can make one or more requests to the resource to see if they're successful. For more info\", \"rmation, see [Circuit breaker pattern.](#page-90-0)\\n\\n**Tip:** Never implement an endless retry mecha\", \"nism\\n\\nUse a finite number of retries, or implement the [Circuit Breaker](https://docs.microsoft.com/\", \"en-us/azure/architecture/patterns/circuit-breaker) pattern to allow a service to recover.\\n\\nThe eShop\", \"OnContainers mobile app does not currently implement the retry pattern when making RESTful web reque\", \"sts. However, the CachedImage control, provided by th[e FFImageLoading](https://www.nuget.org/packag\", \"es/Xamarin.FFImageLoading.Forms/) library supports transient fault handling by retrying image loadin\", \"g. If image loading fails, further attempts will be made. The number of attempts is specified by the\", \" RetryCount property, and retries will occur after a delay specified by the RetryDelay property. If \", \"these property values aren't explicitly set, their default values are applied \\u2013 3 for the RetryCount\", \" property, and 250ms for the RetryDelay property. For more information about the CachedImage control\", \", se[e Caching images.](#page-88-0)\\n\\nThe eShopOnContainers reference application does implement the \", \"retry pattern. For more information, including a discussion of how to combine the retry pattern with\", \" the HttpClient class, see [.NET Microservices: Architecture for Containerized .NET Applications.](h\", \"ttps://aka.ms/microservicesebook)\\n\\nFor more information about the retry pattern, see the [Retry](htt\", \"ps://docs.microsoft.com/en-us/azure/architecture/patterns/retry) pattern on Microsoft Docs.\\n\\n## <spa\", \"n id=\\\"page-90-0\\\"></span>**Circuit breaker pattern**\\n\\nIn some situations, faults can occur due to ant\", \"icipated events that take longer to fix. These faults can range from a partial loss of connectivity \", \"to the complete failure of a service. In these situations, it's pointless for an app to retry an ope\", \"ration that's unlikely to succeed, and instead should accept that the operation has failed and handl\", \"e this failure accordingly.\\n\\nThe circuit breaker pattern can prevent an app from repeatedly trying t\", \"o execute an operation that's likely to fail, while also enabling the app to detect whether the faul\", \"t has been resolved.\\n\\n**Note:** The purpose of the circuit breaker pattern is different from the ret\", \"ry pattern. The retry pattern enables an app to retry an operation in the expectation that it'll suc\", \"ceed. The circuit breaker pattern prevents an app from performing an operation that's likely to fail\", \".\\n\\nA circuit breaker acts as a proxy for operations that might fail. The proxy should monitor the nu\", \"mber of recent failures that have occurred, and use this information to decide whether to allow the \", \"operation to proceed, or to return an exception immediately.\\n\\nThe eShopOnContainers mobile app does \", \"not currently implement the circuit breaker pattern. However, the eShopOnContainers does. For more i\", \"nformation, see [.NET Microservices: Architecture](https://aka.ms/microservicesebook)  [for Containe\", \"rized .NET Applications.](https://aka.ms/microservicesebook)\\n\\n#### **Tip:** Combine the retry and ci\", \"rcuit breaker patterns\\n\\nAn app can combine the retry and circuit breaker patterns by using the retry\", \" pattern to invoke an operation through a circuit breaker. However, the retry logic should be sensit\", \"ive to any exceptions returned by the circuit breaker and abandon retry attempts if the circuit brea\", \"ker indicates that a fault is not transient.\\n\\nFor more information about the circuit breaker pattern\", \", see the [Circuit Breaker](https://docs.microsoft.com/en-us/azure/architecture/patterns/circuit-bre\", \"aker) pattern on Microsoft Docs.\\n\\n# Summary\\n\\nMany modern web-based solutions make use of web service\", \"s, hosted by web servers, to provide functionality for remote client applications. The operations th\", \"at a web service exposes constitute a web API, and client apps should be able to utilize the web API\", \" without knowing how the data or operations that the API exposes are implemented.\\n\\nThe performance o\", \"f an app can be improved by caching frequently accessed data to fast storage that's located close to\", \" the app. Apps can implement read-through caching with the cache-aside pattern. This pattern determi\", \"nes whether the item is currently in the cache. If the item isn't in the cache, it's read from the d\", \"ata store and added to the cache.\\n\\nWhen communicating with web APIs, apps must be sensitive to trans\", \"ient faults. Transient faults include the momentary loss of network connectivity to services, the te\", \"mporary unavailability of a service, or timeouts that arise when a service is busy. These faults are\", \" often self-correcting, and if the action is repeated after a suitable delay, then it's likely to su\", \"cceed. Therefore, apps should wrap all attempts to access a web API in code that implements a transi\", \"ent fault handling mechanism.\\n\\n# <span id=\\\"page-92-0\\\"></span>Unit testing\\n\\nMobile apps have unique p\", \"roblems that desktop and web-based applications don't have to worry about. Mobile users will differ \", \"by the devices that they use, by network connectivity, by the availability of services, and a range \", \"of other factors. Therefore, mobile apps should be tested as they will be used in the real world in \", \"order to improve their quality, reliability, and performance. There are many types of testing that s\", \"hould be performed on an app, including unit testing, integration testing, and user interface testin\", \"g, with unit testing being the most common form of testing.\\n\\nA unit test takes a small unit of the a\", \"pp, typically a method, isolates it from the remainder of the code, and verifies that it behaves as \", \"expected. Its goal is to check that each unit of functionality performs as expected, so that errors \", \"don't propagate throughout the app. Detecting a bug where it occurs is more efficient that observing\", \" the effect of a bug indirectly at a secondary point of failure.\\n\\nUnit testing has the greatest effe\", \"ct on code quality when it's an integral part of the software development workflow. As soon as a met\", \"hod has been written, unit tests should be written that verify the behavior of the method in respons\", \"e to standard, boundary, and incorrect cases of input data, and that check any explicit or implicit \", \"assumptions made by the code. Alternatively, with test driven development, unit tests are written be\", \"fore the code. In this scenario, unit tests act as both design documentation and functional specific\", \"ations.\\n\\n**Note:** Unit tests are very effective against regression \\u2013 that is, functionality that us\", \"ed to work but has been disturbed by a faulty update.\\n\\nUnit tests typically use the arrange-act-asse\", \"rt pattern:\\n\\n- The *arrange* section of the unit test method initializes objects and sets the value \", \"of the data that is passed to the method under test.\\n- The *act* section invokes the method under te\", \"st with the required arguments.\\n- The *assert* section verifies that the action of the method under \", \"test behaves as expected.\\n\\nFollowing this pattern ensures that unit tests are readable and consisten\", \"t.\\n\\n# Dependency injection and unit testing\\n\\nOne of the motivations for adopting a loosely-coupled a\", \"rchitecture is that it facilitates unit testing. One of the types registered with Autofac is the Ord\", \"erService class. The following code example shows an outline of this class:\\n\\n```\\npublic class OrderD\", \"etailViewModel : ViewModelBase\\n{\\n private IOrderService _ordersService;\\n public OrderDetailViewModel\", \"(IOrderService ordersService)\\n```\\n\\n```\\n {\\n _ordersService = ordersService;\\n }\\n ...\\n}\\n```\\n\\nThe OrderD\", \"etailViewModel class has a dependency on the IOrderService type which the container resolves when it\", \" instantiates a OrderDetailViewModel object. However, rather than create an OrderService object to u\", \"nit test the OrderDetailViewModel class, instead, replace the OrderService object with a mock for th\", \"e purpose of the tests. Figure 10-1 illustrates this relationship.\\n\\n![](_page_93_Figure_2.jpeg)\\n\\n**F\", \"igure 10-1:** Classes that implement the IOrderService interface\\n\\nThis approach allows the OrderServ\", \"ice object to be passed into the OrderDetailViewModel class at runtime, and in the interests of test\", \"ability, it allows the OrderMockService class to be passed into the OrderDetailViewModel class at te\", \"st time. The main advantage of this approach is that it enables unit tests to be executed without re\", \"quiring unwieldy resources such as web services, or databases.\\n\\n# Testing MVVM applications\\n\\nTesting\", \" models and view models from MVVM applications is identical to testing any other classes, and the sa\", \"me tools and techniques \\u2013 such as unit testing and mocking, can be used. However, there are some pat\", \"terns that are typical to model and view model classes, that can benefit from specific unit testing \", \"techniques.\\n\\n**Tip:** Test one thing with each unit test\\n\\nDon't be tempted to make a unit test exerc\", \"ise more than one aspect of the unit's behavior. Doing so leads to tests that are difficult to read \", \"and update. It can also lead to confusion when interpreting a failure.\\n\\nThe eShopOnContainers mobile\", \" app use[s xUnit](https://xunit.github.io/) to perform unit testing, which supports two different ty\", \"pes of unit tests:\\n\\n- Facts are tests that are always true, which test invariant conditions.\\n- Theor\", \"ies are tests that are only true for a particular set of data.\\n\\nThe unit tests included with the eSh\", \"opOnContainers mobile app are fact tests, and so each unit test method is decorated with the [Fact] \", \"attribute.\\n\\n**Note:** xUnit tests are executed by a test runner. To execute the test runner, run the\", \" eShopOnContainers.TestRunner project for the required platform.\\n\\n#### **Testing asynchronous functi\", \"onality**\\n\\nWhen implementing the MVVM pattern, view models usually invoke operations on services, of\", \"ten asynchronously. Tests for code that invokes these operations typically use mocks as replacements\", \" for the actual services. The following code example demonstrates testing asynchronous functionality\", \" by passing a mock service into a view model:\\n\\n```\\n[Fact]\\npublic async Task OrderPropertyIsNotNullAf\", \"terViewModelInitializationTest()\\n{\\n var orderService = new OrderMockService();\\n var orderViewModel =\", \" new OrderDetailViewModel(orderService);\\n var order = await orderService.GetOrderAsync(1, GlobalSett\", \"ing.Instance.AuthToken);\\n await orderViewModel.InitializeAsync(order);\\n Assert.NotNull(orderViewMode\", \"l.Order);\\n}\\n```\\n\\nThis unit test checks that the Order property of the OrderDetailViewModel instance \", \"will have a value after the InitializeAsync method has been invoked. The InitializeAsync method is i\", \"nvoked when the view model's corresponding view is navigated to. For more information about navigati\", \"on, see [Navigation.](#page-34-0)\\n\\nWhen the OrderDetailViewModel instance is created, it expects an \", \"OrderService instance to be specified as an argument. However, the OrderService retrieves data from \", \"a web service. Therefore, an OrderMockService instance, which is a mock version of the OrderService \", \"class, is specified as the argument to the OrderDetailViewModel constructor. Then, when the view mod\", \"el's InitializeAsync method is invoked, which invokes IOrderService operations, mock data is retriev\", \"ed rather than communicating with a web service.\\n\\n### **Testing INotifyPropertyChanged implementatio\", \"ns**\\n\\nImplementing the INotifyPropertyChanged interface allows views to react to changes that origin\", \"ate from view models and models. These changes are not limited to data shown in controls \\u2013 they are \", \"also used to control the view, such as view model states that cause animations to be started or cont\", \"rols to be disabled.\\n\\nProperties that can be updated directly by the unit test can be tested by atta\", \"ching an event handler to the PropertyChanged event and checking whether the event is raised after s\", \"etting a new value for the property. The following code example shows such a test:\\n\\n```\\n[Fact]\\npubli\", \"c async Task SettingOrderPropertyShouldRaisePropertyChanged()\\n{\\n bool invoked = false;\\n var orderSer\", \"vice = new OrderMockService();\\n var orderViewModel = new OrderDetailViewModel(orderService);\\n orderV\", \"iewModel.PropertyChanged += (sender, e) =>\\n {\\n```\\n\\n```\\n if (e.PropertyName.Equals(\\\"Order\\\"))\\n invoked\", \" = true;\\n };\\n var order = await orderService.GetOrderAsync(1, GlobalSetting.Instance.AuthToken);\\n aw\", \"ait orderViewModel.InitializeAsync(order);\\n Assert.True(invoked);\\n}\\n```\\n\\nThis unit test invokes the \", \"InitializeAsync method of the OrderViewModel class, which causes its Order property to be updated. T\", \"he unit test will pass, provided that the PropertyChanged event is raised for the Order property.\\n\\n#\", \"## **Testing message-based communication**\\n\\nView models that use the MessagingCenter class to commun\", \"icate between loosely-coupled classes can be unit tested by subscribing to the message being sent by\", \" the code under test, as demonstrated in the following code example:\\n\\n```\\n[Fact]\\npublic void AddCata\", \"logItemCommandSendsAddProductMessageTest()\\n{\\n bool messageReceived = false;\\n var catalogService = ne\", \"w CatalogMockService();\\n var catalogViewModel = new CatalogViewModel(catalogService);\\n Xamarin.Forms\", \".MessagingCenter.Subscribe<CatalogViewModel, CatalogItem>(\\n this, MessageKeys.AddProduct, (sender, a\", \"rg) =>\\n {\\n messageReceived = true;\\n });\\n catalogViewModel.AddCatalogItemCommand.Execute(null);\\n Asse\", \"rt.True(messageReceived);\\n}\\n```\\n\\nThis unit test checks that the CatalogViewModel publishes the AddPr\", \"oduct message in response to its AddCatalogItemCommand being executed. Because the MessagingCenter c\", \"lass supports multicast message subscriptions, the unit test can subscribe to the AddProduct message\", \" and execute a callback delegate in response to receiving it. This callback delegate, specified as a\", \" lambda expression, sets a boolean field that's used by the Assert statement to verify the behavior \", \"of the test.\\n\\n## **Testing exception handling**\\n\\nUnit tests can also be written that check that spec\", \"ific exceptions are thrown for invalid actions or inputs, as demonstrated in the following code exam\", \"ple:\\n\\n```\\n[Fact]\\npublic void InvalidEventNameShouldThrowArgumentExceptionText()\\n{\\n var behavior = ne\", \"w MockEventToCommandBehavior\\n {\\n EventName = \\\"OnItemTapped\\\"\\n };\\n var listView = new ListView();\\n Ass\", \"ert.Throws<ArgumentException>(() => listView.Behaviors.Add(behavior));\\n}\\n```\\n\\nThis unit test will th\", \"row an exception, because the ListView control does not have an event named OnItemTapped. The Assert\", \".Throws<T> method is a generic method where T is the type of the expected exception. The argument pa\", \"ssed to the Assert.Throws<T> method is a lambda expression that will throw the exception. Therefore,\", \" the unit test will pass provided that the lambda expression throws an ArgumentException.\\n\\n**Tip**: \", \"Avoid writing unit tests that examine exception message strings\\n\\nException message strings might cha\", \"nge over time, and so unit tests that rely on their presence are regarded as brittle.\\n\\n#### **Testin\", \"g validation**\\n\\nThere are two aspects to testing the validation implementation: testing that any val\", \"idation rules are correctly implemented, and testing that the ValidatableObject<T> class performs as\", \" expected.\\n\\nValidation logic is usually simple to test, because it is typically a self-contained pro\", \"cess where the output depends on the input. There should be tests on the results of invoking the Val\", \"idate method on each property that has at least one associated validation rule, as demonstrated in t\", \"he following code example:\\n\\n```\\n[Fact]\\npublic void CheckValidationPassesWhenBothPropertiesHaveDataTe\", \"st()\\n{\\n var mockViewModel = new MockViewModel();\\n mockViewModel.Forename.Value = \\\"John\\\";\\n mockViewMo\", \"del.Surname.Value = \\\"Smith\\\";\\n bool isValid = mockViewModel.Validate();\\n Assert.True(isValid);\\n}\\n```\\n\", \"\\nThis unit test checks that validation succeeds when the two ValidatableObject<T> properties in the \", \"MockViewModel instance both have data.\\n\\nAs well as checking that validation succeeds, validation uni\", \"t tests should also check the values of the Value, IsValid, and Errors property of each ValidatableO\", \"bject<T> instance, to verify that the class performs as expected. The following code example demonst\", \"rates a unit test that does this:\\n\\n```\\n[Fact]\\npublic void CheckValidationFailsWhenOnlyForenameHasDat\", \"aTest()\\n{\\n var mockViewModel = new MockViewModel();\\n mockViewModel.Forename.Value = \\\"John\\\";\\n bool is\", \"Valid = mockViewModel.Validate();\\n Assert.False(isValid);\\n Assert.NotNull(mockViewModel.Forename.Val\", \"ue);\\n Assert.Null(mockViewModel.Surname.Value);\\n Assert.True(mockViewModel.Forename.IsValid);\\n Asser\", \"t.False(mockViewModel.Surname.IsValid);\\n Assert.Empty(mockViewModel.Forename.Errors);\\n Assert.NotEmp\", \"ty(mockViewModel.Surname.Errors);\\n}\\n```\\n\\nThis unit test checks that validation fails when the Surnam\", \"e property of the MockViewModel doesn't have any data, and the Value, IsValid, and Errors property o\", \"f each ValidatableObject<T> instance are correctly set.\\n\\n# Summary\\n\\nA unit test takes a small unit o\", \"f the app, typically a method, isolates it from the remainder of the code, and verifies that it beha\", \"ves as expected. Its goal is to check that each unit of functionality performs as expected, so that \", \"errors don't propagate throughout the app.\\n\\nThe behavior of an object under test can be isolated by \", \"replacing dependent objects with mock objects that simulate the behavior of the dependent objects. T\", \"his enables unit tests to be executed without requiring unwieldy resources such as web services, or \", \"databases.\\n\\nTesting models and view models from MVVM applications is identical to testing any other \", \"classes, and the same tools and techniques can be used.\"]"