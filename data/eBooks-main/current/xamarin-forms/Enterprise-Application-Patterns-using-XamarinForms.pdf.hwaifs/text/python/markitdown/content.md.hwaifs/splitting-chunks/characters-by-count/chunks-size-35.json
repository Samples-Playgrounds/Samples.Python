"[\"Book title\\n\\nBook subtitle\\n\\nAuthor Name\\n\\n\\fPUBLISHED BY\\n\\nDevDiv, .NET and Visual Studio produc teams\\nA\", \" division of Microsoft Corporation\\nOne Microsoft Way\\nRedmond, Washington 98052-6399\\n\\nCopyright \\u00a9 201\", \"7 by Microsoft Corporation\\n\\nAll rights reserved. No part of the contents of this book may be reprodu\", \"ced or transmitted in any\\nform or by any means without the written permission of the publisher.\\n\\nThi\", \"s book is provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The views, opinions and\\nin\", \"formation expressed in this book, including URL and other Internet website references, may change\\nwi\", \"thout notice.\\n\\nSome examples depicted herein are provided for illustration only and are fictitious. \", \"No real association\\nor connection is intended or should be inferred.\\n\\nMicrosoft and the trademarks l\", \"isted at http://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are\\ntrademarks of the Microsoft group \", \"of companies. All other marks are property of their respective\\nowners.\\n\\nAuthor: David Britch\\nDevelop\", \"er: Javier Suarez Ruiz (Plain Concepts)\\nParticipants and reviewers: Craig Dunn, Tom Opgenorth\\nEditor\", \": John Meade (Populus Group)\\n\\n\\fContents\\n\\nPreface ...................................................\", \"........................................................................ iv\\nPurpose ................\", \"....................................................................................................\", \".............. iv\\nWhat's left out of this guide's scope ............................................\", \".................................................. iv\\nWho should use this guide ....................\", \"......................................................................................... iv\\nHow to \", \"use this guide .....................................................................................\", \"................................. v\\n\\nIntroduction ..................................................\", \".................................................................. 1\\nSample application ............\", \"....................................................................................................\", \"... 2\\nSample application architecture...............................................................\", \"....................................... 2\\nMobile app ...............................................\", \"........................................................................................ 4\\neShopOnCo\", \"ntainers.Core project...............................................................................\", \".................... 5\\nPlatform projects ...........................................................\", \"................................................................. 6\\nSummary ........................\", \"....................................................................................................\", \"..... 6\\n\\nMVVM ......................................................................................\", \"....................................... 7\\nThe MVVM pattern .........................................\", \"......................................................................... 7\\nView ...................\", \"....................................................................................................\", \".......................... 8\\nViewModel .............................................................\", \".......................................................................... 8\\nModel .................\", \"....................................................................................................\", \".......................... 9\\nConnecting view models to views .......................................\", \"...................................................... 9\\nCreating a view model declaratively .......\", \"......................................................................................10\\nCreating a \", \"view model programmatically ........................................................................\", \".............10\\nCreating a view defined as a data template .........................................\", \".........................................11\\nAutomatically creating a view model with a view model lo\", \"cator .................................................11\\nUpdating views in response to changes in t\", \"he underlying view model or model ....................... 12\\nUI interaction using commands and behav\", \"iors ........................................................................ 13\\nImplementing comman\", \"ds .................................................................................................\", \".............14\\nImplementing behaviors .............................................................\", \"...................................................15\\nSummary ......................................\", \"......................................................................................... 17\\n\\nDepend\", \"ency injection .....................................................................................\", \"............... 18\\nIntroduction to dependency injection ............................................\", \"......................................... 18\\nRegistration ..........................................\", \"................................................................................. 20\\nResolution ....\", \"....................................................................................................\", \"...................... 22\\nManaging the lifetime of resolved objects ................................\", \"............................................... 22\\nSummary .........................................\", \"...................................................................................... 23\\n\\ni\\n\\n\\fCommu\", \"nicating between loosely coupled components .................................................. 24\\nIn\", \"troduction to MessagingCenter ......................................................................\", \"...................... 24\\nDefining a message........................................................\", \"......................................................... 26\\nPublishing a message ..................\", \"............................................................................................ 26\\nSubs\", \"cribing to a message ...............................................................................\", \"......................... 27\\nUnsubscribing from a message...........................................\", \"..................................................... 27\\nSummary ...................................\", \"............................................................................................ 27\\n\\nNav\", \"igation ............................................................................................\", \"......................... 28\\nNavigating between pages ..............................................\", \"........................................................ 29\\nCreating the NavigationService instance \", \".......................................................................................29\\nHandling n\", \"avigation requests .................................................................................\", \".......................30\\nNavigating when the app is launched ......................................\", \".....................................................32\\nPassing parameters during navigation .......\", \"...................................................................................33\\nInvoking navig\", \"ation using behaviors ..............................................................................\", \"...............34\\nConfirming or cancelling navigation ..............................................\", \"................................................34\\nSummary .........................................\", \"...................................................................................... 35\\n\\nValidatio\", \"n ..................................................................................................\", \".................... 36\\nSpecifying validation rules ................................................\", \"...................................................... 37\\nAdding validation rules to a property ....\", \".................................................................................. 38\\nTriggering val\", \"idation ............................................................................................\", \"................... 39\\nTriggering validation manually ..............................................\", \"........................................................39\\nTriggering validation when properties cha\", \"nge..............................................................................40\\nDisplaying valid\", \"ation errors .......................................................................................\", \"............. 40\\nHighlighting a control that contains invalid data .................................\", \".........................................41\\nDisplaying error messages ..............................\", \"...............................................................................44\\nSummary ..........\", \"....................................................................................................\", \"................. 45\\n\\nConfiguration management .....................................................\", \"...................................... 46\\nCreating a settings class ................................\", \".......................................................................... 46\\nAdding a setting .....\", \"....................................................................................................\", \"............ 47\\nData binding to user settings ......................................................\", \"............................................ 48\\nSummary ............................................\", \"................................................................................... 50\\n\\nContainerize\", \"d microservices ....................................................................................\", \"....... 51\\nMicroservices ...........................................................................\", \".............................................. 52\\nContainerization .................................\", \".................................................................................... 53\\nCommunicatio\", \"n between client and microservices .................................................................\", \". 55\\nCommunication between microservices ...........................................................\", \"....................... 56\\nSummary .................................................................\", \".............................................................. 58\\n\\nAuthentication and authorization \", \".................................................................................. 59\\nAuthentication\", \" ...................................................................................................\", \".................... 59\\nIssuing bearer tokens using IdentityServer 4 ...............................\", \".................................................60\\nAdding IdentityServer to a web application .....\", \".............................................................................60\\nConfiguring Identity\", \"Server .............................................................................................\", \"...............61\\n\\nii\\n\\n\\fPerforming authentication ..................................................\", \"..........................................................64\\nAuthorization .........................\", \"................................................................................................ 69\\n\", \"Configuring IdentityServer to perform authorization ................................................\", \"...................70\\nMaking access requests to APIs ...............................................\", \"......................................................71\\nSummary ...................................\", \"............................................................................................ 71\\n\\nAcc\", \"essing remote data .................................................................................\", \".................. 73\\nIntroduction to Representational State Transfer...............................\", \"....................................... 73\\nConsuming RESTful APIs ..................................\", \"....................................................................... 74\\nMaking web requests .....\", \"....................................................................................................\", \"...........74\\nCaching data .........................................................................\", \"................................................. 81\\nManaging data expiration ......................\", \".......................................................................................82\\nCaching im\", \"ages ...............................................................................................\", \"...............................82\\nIncreasing resilience ............................................\", \"................................................................... 83\\nRetry pattern ...............\", \"....................................................................................................\", \"..............83\\nCircuit breaker pattern ...........................................................\", \".......................................................84\\nSummary ..................................\", \"............................................................................................. 85\\n\\nUn\", \"it testing .........................................................................................\", \"........................... 86\\nDependency injection and unit testing ...............................\", \"..................................................... 86\\nTesting MVVM applications .................\", \"................................................................................... 87\\nTesting async\", \"hronous functionality...............................................................................\", \"................88\\nTesting INotifyPropertyChanged implementations...................................\", \"....................................88\\nTesting message-based communication .........................\", \"..............................................................89\\nTesting exception handling ........\", \"....................................................................................................\", \"89\\nTesting validation ..............................................................................\", \"............................................90\\nSummary .............................................\", \".................................................................................. 91\\n\\niii\\n\\n\\fPreface\", \"\\n\\nPurpose\\n\\nThis eBook provides guidance on building cross-platform enterprise apps using Xamarin.For\", \"ms.\\nXamarin.Forms is a cross-platform UI toolkit that allows developers to easily create native user\", \"\\ninterface layouts that can be shared across platforms, including iOS, Android, and the Universal\\nWi\", \"ndows Platform (UWP). It provides a comprehensive solution for Business to Employee (B2E),\\nBusiness \", \"to Business (B2B), and Business to Consumer (B2C) apps, providing the ability to share code\\nacross a\", \"ll target platforms and helping to lower the total cost of ownership (TCO).\\n\\nThe guide provides arch\", \"itectural guidance for developing adaptable, maintainable, and testable\\nXamarin.Forms enterprise app\", \"s. Guidance is provided on how to implement MVVM, dependency\\ninjection, navigation, validation, and \", \"configuration management, while maintaining loose coupling. In\\naddition, there's also guidance on pe\", \"rforming authentication and authorization with IdentityServer,\\naccessing data from containerized mic\", \"roservices, and unit testing.\\n\\nThe guide comes with source code for the eShopOnContainers mobile app\", \", and source code for the\\neShopOnContainers reference app. The eShopOnContainers mobile app is a cro\", \"ss-platform enterprise\\napp developed using Xamarin.Forms, which connects to a series of containerize\", \"d microservices known\\nas the eShopOnContainers reference app. However, the eShopOnContainers mobile \", \"app can be\\nconfigured to consume data from mock services for those who wish to avoid deploying the\\nc\", \"ontainerized microservices.\\n\\nWhat's left out of this guide's scope\\n\\nThis guide is aimed at readers w\", \"ho are already familiar with Xamarin.Forms. For a detailed\\nintroduction to Xamarin.Forms, see the Xa\", \"marin.Forms documentation on the Xamarin Developer\\nCenter, and Creating Mobile Apps with Xamarin.For\", \"ms.\\n\\nThe guide is complementary to .NET Microservices: Architecture for Containerized .NET Applicati\", \"ons,\\nwhich focuses on developing and deploying containerized microservices. Other guides worth readi\", \"ng\\ninclude Architecting and Developing Modern Web Applications with ASP.NET Core and Microsoft\\nAzure\", \", Containerized Docker Application Lifecycle with Microsoft Platform and Tools, and Microsoft\\nPlatfo\", \"rm and Tools for Mobile App Development.\\n\\nWho should use this guide\\n\\nThe audience for this guide is \", \"mainly developers and architects who would like to learn how to\\narchitect and implement cross-platfo\", \"rm enterprise apps using Xamarin.Forms.\\n\\niv\\n\\nPreface\\n\\n\\fA secondary audience is technical decision ma\", \"kers who would like to receive an architectural and\\ntechnology overview before deciding on what appr\", \"oach to select for cross-platform enterprise app\\ndevelopment using Xamarin.Forms.\\n\\nHow to use this g\", \"uide\\n\\nThis guide focuses on building cross-platform enterprise apps using Xamarin.Forms. As such, it\", \" should\\nbe read in its entirety to provide a foundation of understanding such apps and their technic\", \"al\\nconsiderations. The guide, along with its sample app, can also serve as a starting point or refer\", \"ence for\\ncreating a new enterprise app. Use the associated sample app as a template for the new app,\", \" or to see\\nhow to organize an app's component parts. Then, refer back to this guide for architectura\", \"l guidance.\\n\\nFeel free to forward this guide to team members to help ensure a common understanding o\", \"f cross-\\nplatform enterprise app development using Xamarin.Forms. Having everybody working from a\\nco\", \"mmon set of terminologies and underlying principles will help ensure a consistent application of\\narc\", \"hitectural patterns and practices.\\n\\nv\\n\\nPreface\\n\\n\\fC H A P T E R\\n\\n1\\n\\nIntroduction\\n\\nRegardless of platf\", \"orm, developers of enterprise apps face several challenges:\\n\\n\\u2022  App requirements that can change ove\", \"r time.\\n\\n\\u2022  New business opportunities and challenges.\\n\\n\\u2022  Ongoing feedback during development that \", \"can significantly affect the scope and\\n\\nrequirements of the app.\\n\\nWith these in mind, it's important\", \" to build apps that can be easily modified or extended over time.\\nDesigning for such adaptability ca\", \"n be difficult as it requires an architecture that allows individual\\nparts of the app to be independ\", \"ently developed and tested in isolation without affecting the rest of\\nthe app.\\n\\nMany enterprise apps\", \" are sufficiently complex to require more than one developer. It can be a\\nsignificant challenge to d\", \"ecide how to design an app so that multiple developers can work effectively\\non different pieces of t\", \"he app independently, while ensuring that the pieces come together seamlessly\\nwhen integrated into t\", \"he app.\\n\\nThe traditional approach to designing and building an app results in what is referred to as\", \" a\\nmonolithic app, where components are tightly coupled with no clear separation between them.\\nTypic\", \"ally, this monolithic approach leads to apps that are difficult and inefficient to maintain, because\", \"\\nit can be difficult to resolve bugs without breaking other components in the app, and it can be\\ndif\", \"ficult to add new features or to replace existing features.\\n\\nAn effective remedy for these challenge\", \"s is to partition an app into discrete, loosely coupled\\ncomponents that can be easily integrated tog\", \"ether into an app. Such an approach offers several\\nbenefits:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nIt allows individual function\", \"ality to be developed, tested, extended, and maintained by\\ndifferent individuals or teams.\\n\\nIt promo\", \"tes reuse and a clean separation of concerns between the app's horizontal\\ncapabilities, such as auth\", \"entication and data access, and the vertical capabilities, such as app\\nspecific business functionali\", \"ty. This allows the dependencies and interactions between app\\ncomponents to be more easily managed.\\n\", \"\\nIt helps maintain a separation of roles by allowing different individuals, or teams, to focus on\\na \", \"specific task or piece of functionality according to their expertise. In particular, it provides a\\nc\", \"leaner separation between the user interface and the app's business logic.\\n\\nHowever, there are many \", \"issues that must be resolved when partitioning an app into discrete, loosely\\ncoupled components. The\", \"se include:\\n\\n\\u2022  Deciding how to provide a clean separation of concerns between the user interface co\", \"ntrols\\n\\nand their logic. One of the most important decisions when creating a Xamarin.Forms\\nenterpris\", \"e app is whether to place business logic in code-behind files, or whether to create a\\nclean separati\", \"on of concerns between the user interface controls and their logic, in order to\\n\\n1\\n\\nC HA PTER  1  | \", \" Introduction\\n\\n\\fmake the app more maintainable and testable. For more information, see Model-View-\\nV\", \"iewModel.\\n\\n\\u2022  Determining whether to use a dependency injection container. Dependency injection\\ncont\", \"ainers reduce the dependency coupling between objects by providing a facility to\\nconstruct instances\", \" of classes with their dependencies injected, and manage their lifetime\\nbased on the configuration o\", \"f the container. For more information, see Dependency injection.\\n\\n\\u2022  Choosing between platform provi\", \"ded eventing and loosely coupled message-based\\n\\ncommunication between components that are inconvenie\", \"nt to link by object and type\\nreferences. For more information, see Introduction to Communicating be\", \"tween loosely\\ncoupled components.\\n\\n\\u2022  Deciding how to navigate between pages, including how to invok\", \"e navigation, and where\\n\\nnavigation logic should reside. For more information, see Navigation.\\n\\n\\u2022  D\", \"etermining how to validate user input for correctness. The decision must include how to\\n\\nvalidate us\", \"er input, and how to notify the user about validation errors. For more information,\\nsee Validation.\\n\", \"\\n\\u2022  Deciding how to perform authentication, and how to protect resources with authorization. For\\n\\nmo\", \"re information, see Authentication and authorization.\\n\\n\\u2022  Determining how to access remote data from\", \" web services, including how to reliably retrieve\\n\\ndata, and how to cache data. For more information\", \", see Accessing remote data.\\n\\n\\u2022  Deciding how to test the app. For more information, see Unit testin\", \"g.\\n\\nThis guide provides guidance on these issues, and focuses on the core patterns and architecture \", \"for\\nbuilding a cross-platform enterprise app using Xamarin.Forms. The guidance aims to help to produ\", \"ce\\nadaptable, maintainable, and testable code, by addressing common Xamarin.Forms enterprise app\\ndev\", \"elopment scenarios, and by separating the concerns of presentation, presentation logic, and\\nentities\", \" through support for the Model-View-ViewModel (MVVM) pattern.\\n\\nSample application\\n\\nThis guide includ\", \"es a sample application, eShopOnContainers, that's an online store that includes the\\nfollowing funct\", \"ionality:\\n\\n\\u2022  Authenticating and authorizing against a backend service.\\n\\n\\u2022  Browsing a catalog of sh\", \"irts, coffee mugs, and other marketing items.\\n\\n\\u2022\\n\\nFiltering the catalog.\\n\\n\\u2022  Ordering items from the\", \" catalog.\\n\\n\\u2022  Viewing the user's order history.\\n\\n\\u2022  Configuration of settings.\\n\\nSample application a\", \"rchitecture\\n\\nFigure 1-1 provides a high-level overview of the architecture of the sample application\", \".\\n\\n2\\n\\nC HA PTER  1  |  Introduction\\n\\n\\fFigure 1-1: eShopOnContainers high-level architecture\\n\\nThe sam\", \"ple application ships with three client apps:\\n\\n\\u2022  An MVC application developed with ASP.NET Core.\\n\\n\\u2022\", \"  A Single Page Application (SPA) developed with Angular 2 and Typescript. This approach for\\n\\nweb ap\", \"plications avoids performing a round-trip to the server with each operation.\\n\\n\\u2022  A mobile app develo\", \"ped with Xamarin.Forms, which supports iOS, Android, and the Universal\\n\\nWindows Platform (UWP).\\n\\nFor\", \" information about the web applications, see Architecting and Developing Modern Web\\nApplications wit\", \"h ASP.NET Core and Microsoft Azure.\\n\\nThe sample application includes the following backend services:\", \"\\n\\n\\u2022  An identity microservice, which uses ASP.NET Core Identity and IdentityServer.\\n\\n\\u2022  A catalog mi\", \"croservice, which is a data-driven create, read, update, delete (CRUD) service that\\n\\nconsumes an SQL\", \" Server database using EntityFramework Core.\\n\\n\\u2022  An ordering microservice, which is a domain-driven \", \"service that uses domain-driven design\\n\\npatterns.\\n\\n\\u2022  A basket microservice, which is a data-driven \", \"CRUD service that uses Redis Cache.\\n\\nThese backend services are implemented as microservices using A\", \"SP.NET Core MVC, and are\\ndeployed as unique containers within a single Docker host. Collectively, th\", \"ese backend services are\\nreferred to as the eShopOnContainers reference application. Client apps com\", \"municate with the\\nbackend services through a Representational State Transfer (REST) web interface. F\", \"or more\\ninformation about microservices and Docker, see Containerized microservices.\\n\\nFor informatio\", \"n about the implementation of the backend services, see .NET Microservices:\\nArchitecture for Contain\", \"erized .NET Applications.\\n\\n3\\n\\nC HA PTER  1  |  Introduction\\n\\n\\fMobile app\\n\\nThis guide focuses on buil\", \"ding cross-platform enterprise apps using Xamarin.Forms, and uses the\\neShopOnContainers mobile app a\", \"s an example. Figure 1-2 shows the pages from the\\neShopOnContainers mobile app that provide the func\", \"tionality outlined earlier.\\n\\nFigure 1-2: The eShopOnContainers mobile app\\n\\nThe mobile app consumes t\", \"he backend services provided by the eShopOnContainers reference\\napplication. However, it can be conf\", \"igured to consume data from mock services for those who wish to\\navoid deploying the backend services\", \".\\n\\nThe eShopOnContainers mobile app exercises the following Xamarin.Forms functionality:\\n\\n\\u2022  XAML\\n\\n\\u2022\", \"  Controls\\n\\n\\u2022  Bindings\\n\\n\\u2022  Converters\\n\\n\\u2022  Styles\\n\\n4\\n\\nC HA PTER  1  |  Introduction\\n\\n\\f\\u2022  Animations\\n\", \"\\n\\u2022  Commands\\n\\n\\u2022  Behaviors\\n\\n\\u2022  Triggers\\n\\n\\u2022  Effects\\n\\n\\u2022  Custom Renderers\\n\\n\\u2022  MessagingCenter\\n\\n\\u2022  Cus\", \"tom Controls\\n\\nFor more information about this functionality, see the Xamarin.Forms documentation on \", \"the Xamarin\\nDeveloper Center, and Creating Mobile Apps with Xamarin.Forms.\\n\\nIn addition, unit tests \", \"are provided for some of the classes in the eShopOnContainers mobile app.\\n\\nMobile app solution\\n\\nThe \", \"eShopOnContainers mobile app solution organizes the source code and other resources into\\nprojects. A\", \"ll of the projects use folders to organize the source code and other resources into\\ncategories. The \", \"following table outlines the projects that make up the eShopOnContainers mobile\\napp:\\n\\nProject\\n\\neShop\", \"OnContainers.Core\\n\\neShopOnContainers.Droid\\n\\neShopOnContainers.iOS\\n\\neShopOnContainers.UWP\\n\\neShopOnCon\", \"tainers.TestRunner.Droid\\n\\neShopOnContainers.TestRunner.iOS\\n\\nDescription\\n\\nThis project is the portabl\", \"e class library (PCL) project\\nthat contains the shared code and shared UI.\\nThis project holds Androi\", \"d specific code and is the\\nentry point for the Android app.\\nThis project holds iOS specific code and\", \" is the entry\\npoint for the iOS app.\\nThis project holds Universal Windows Platform (UWP)\\nspecific co\", \"de and is the entry point for the Windows\\napp.\\nThis project is the Android test runner for the\\neShop\", \"OnContainers.UnitTests project.\\nThis project is the iOS test runner for the\\neShopOnContainers.UnitTe\", \"sts project.\\n\\neShopOnContainers.TestRunner.Windows  This project is the Universal Windows Platform t\", \"est\\n\\neShopOnContainers.UnitTests\\n\\nrunner for the eShopOnContainers.UnitTests project.\\nThis project c\", \"ontains unit tests for the\\neShopOnContainers.Core project.\\n\\nThe classes from the eShopOnContainers m\", \"obile app can be re-used in any Xamarin.Forms app with\\nlittle or no modification.\\n\\neShopOnContainers\", \".Core project\\n\\nThe eShopOnContainers.Core PCL project contains the following folders:\\n\\n5\\n\\nC HA PTER \", \" 1  |  Introduction\\n\\n\\fFolder\\n\\nDescription\\n\\nAnimations\\nBehaviors\\nControls\\nConverters\\nEffects\\n\\nExcepti\", \"ons\\nExtensions\\nHelpers\\nModels\\nProperties\\nServices\\n\\nTriggers\\n\\nContains classes that enable animations\", \" to be consumed in XAML.\\nContains behaviors that are exposed to view classes.\\nContains custom contro\", \"ls used by the app.\\nContains value converters that apply custom logic to a binding.\\nContains the Ent\", \"ryLineColorEffect class, which is used to change the border\\ncolor of specific Entry controls.\\nContai\", \"ns the custom ServiceAuthenticationException.\\nContains extension methods for the VisualElement and I\", \"Enumerable<T> classes.\\nContains helper classes for the app.\\nContains the model classes for the app.\\n\", \"Contains AssemblyInfo.cs, a .NET assembly metadata file.\\nContains interfaces and classes that implem\", \"ent services that are provided to the\\napp.\\nContains the BeginAnimation trigger, which is used to inv\", \"oke an animation in\\nXAML.\\nContains classes involved in validating data input.\\n\\nValidations\\nViewModel\", \"s  Contains the application logic that's exposed to pages.\\nViews\\n\\nContains the pages for the app.\\n\\nP\", \"latform projects\\n\\nThe platform projects contain effect implementations, custom renderer implementati\", \"ons, and other\\nplatform-specific resources.\\n\\nSummary\\n\\nXamarin's cross-platform mobile app developmen\", \"t tools and platforms provide a comprehensive\\nsolution for B2E, B2B, and B2C mobile client apps, pro\", \"viding the ability to share code across all target\\nplatforms (iOS, Android, and Windows) and helping\", \" to lower the total cost of ownership. Apps can\\nshare their user interface and app logic code, while\", \" retaining the native platform look and feel.\\n\\nDevelopers of enterprise apps face several challenges\", \" that can alter the architecture of the app during\\ndevelopment. Therefore, it's important to build a\", \"n app so that it can be modified or extended over\\ntime. Designing for such adaptability can be diffi\", \"cult, but typically involves partitioning an app into\\ndiscrete, loosely coupled components that can \", \"be easily integrated together into an app.\\n\\n6\\n\\nC HA PTER  1  |  Introduction\\n\\n\\fC H A P T E R\\n\\n2\\n\\nMVV\", \"M\\n\\nThe Xamarin.Forms developer experience typically involves creating a user interface in XAML, and \", \"then\\nadding code-behind that operates on the user interface. As apps are modified, and grow in size \", \"and\\nscope, complex maintenance issues can arise. These issues include the tight coupling between the\", \" UI\\ncontrols and the business logic, which increases the cost of making UI modifications, and the di\", \"fficulty\\nof unit testing such code.\\n\\nThe Model-View-ViewModel (MVVM) pattern helps to cleanly separa\", \"te the business and presentation\\nlogic of an application from its user interface (UI). Maintaining a\", \" clean separation between application\\nlogic and the UI helps to address numerous development issues \", \"and can make an application easier\\nto test, maintain, and evolve. It can also greatly improve code r\", \"e-use opportunities and allows\\ndevelopers and UI designers to more easily collaborate when developin\", \"g their respective parts of an\\napp.\\n\\nThe MVVM pattern\\n\\nThere are three core components in the MVVM p\", \"attern: the model, the view, and the view model.\\nEach serves a distinct purpose. Figure 2-1 shows th\", \"e relationships between the three components.\\n\\nFigure 2-1: The MVVM pattern\\n\\nIn addition to understa\", \"nding the responsibilities of each components, it's also important to\\nunderstand how they interact w\", \"ith each other. At a high level, the view \\\"knows about\\\" the view model,\\nand the view model \\\"knows ab\", \"out\\\" the model, but the model is unaware of the view model, and the\\nview model is unaware of the vie\", \"w. Therefore, the view model isolates the view from the model, and\\nallows the model to evolve indepe\", \"ndently of the view.\\n\\nThe benefits of using the MVVM pattern are as follows:\\n\\n\\u2022\\n\\nIf there's an exist\", \"ing model implementation that encapsulates existing business logic, it can\\nbe difficult or risky to \", \"change it. In this scenario, the view model acts as an adapter for the\\nmodel classes and enables you\", \" to avoid making any major changes to the model code.\\n\\n7\\n\\nC HA PTER  2  |  MVVM\\n\\n\\f\\u2022  Developers can \", \"create unit tests for the view model and the model, without using the view.\\nThe unit tests for the v\", \"iew model can exercise exactly the same functionality as used by the\\nview.\\n\\n\\u2022  The app UI can be red\", \"esigned without touching the code, provided that the view is\\n\\nimplemented entirely in XAML. Therefor\", \"e, a new version of the view should work with the\\nexisting view model.\\n\\n\\u2022  Designers and developers \", \"can work independently and concurrently on their components\\n\\nduring the development process. Designe\", \"rs can focus on the view, while developers can work\\non the view model and model components.\\n\\nThe key\", \" to using MVVM effectively lies in understanding how to factor app code into the correct\\nclasses, an\", \"d in understanding how the classes interact. The following sections discuss the\\nresponsibilities of \", \"each of the classes in the MVVM pattern.\\n\\nView\\n\\nThe view is responsible for defining the structure, \", \"layout, and appearance of what the user sees on\\nscreen. Ideally, each view is defined in XAML, with \", \"a limited code-behind that does not contain\\nbusiness logic. However, in some cases, the code-behind \", \"might contain UI logic that implements\\nvisual behavior that is difficult to express in XAML, such as\", \" animations.\\n\\nIn a Xamarin.Forms application, a view is typically a Page-derived or ContentView-deri\", \"ved class.\\nHowever, views can also be represented by a data template, which specifies the UI element\", \"s to be\\nused to visually represent an object when it's displayed. A data template as a view does not\", \" have any\\ncode-behind, and is designed to bind to a specific view model type.\\n\\nTip: Avoid enabling a\", \"nd disabling UI elements in the code-behind\\n\\nEnsure that view models are responsible for defining lo\", \"gical state changes that affect some aspects\\nof the view's display, such as whether a command is ava\", \"ilable, or an indication that an operation is\\npending. Therefore, enable and disable UI elements by \", \"binding to view model properties, rather\\nthan enabling and disabling them in code-behind.\\n\\nThere are\", \" several options for executing code on the view model in response to interactions on the\\nview, such \", \"as a button click or item selection. If a control supports commands, the control's Command\\nproperty \", \"can be data-bound to an ICommand property on the view model. When the control's\\ncommand is invoked, \", \"the code in the view model will be executed. In addition to commands,\\nbehaviors can be attached to a\", \"n object in the view and can listen for either a command to be invoked\\nor event to be raised. In res\", \"ponse, the behavior can then invoke an ICommand on the view model or a\\nmethod on the view model.\\n\\nVi\", \"ewModel\\n\\nThe view model implements properties and commands to which the view can data bind to, and\\nn\", \"otifies the view of any state changes through change notification events. The properties and\\ncommand\", \"s that the view model provides define the functionality to be offered by the UI, but the view\\ndeterm\", \"ines how that functionality is to be displayed.\\n\\nTip: Keep the UI responsive with asynchronous opera\", \"tions\\n\\nMobile apps should keep the UI thread unblocked to improve the user's perception of\\nperforman\", \"ce. Therefore, in the view model, use asynchronous methods for I/O operations and raise\\nevents to as\", \"ynchronously notify views of property changes.\\n\\n8\\n\\nC HA PTER  2  |  MVVM\\n\\n\\fThe view model is also re\", \"sponsible for coordinating the view's interactions with any model classes that\\nare required. There's\", \" typically a one-to-many relationship between the view model and the model\\nclasses. The view model m\", \"ight choose to expose model classes directly to the view so that controls in\\nthe view can data bind \", \"directly to them. In this case, the model classes will need to be designed to\\nsupport data binding a\", \"nd change notification events.\\n\\nEach view model provides data from a model in a form that the view c\", \"an easily consume. To\\naccomplish this, the view model sometimes performs data conversion. Placing th\", \"is data conversion in\\nthe view model is a good idea because it provides properties that the view can\", \" bind to. For example,\\nthe view model might combine the values of two properties to make it easier f\", \"or display by the view.\\n\\nTip: Centralize data conversions in a conversion layer\\n\\nIt's also possible \", \"to use converters as a separate data conversion layer that sits between the view\\nmodel and the view.\", \" This can be necessary, for example, when data requires special formatting that\\nthe view model doesn\", \"'t provide.\\n\\nIn order for the view model to participate in two-way data binding with the view, its p\", \"roperties must\\nraise the PropertyChanged event. View models satisfy this requirement by implementing\", \" the\\nINotifyPropertyChanged interface, and raising the PropertyChanged event when a property is\\nchan\", \"ged.\\n\\nFor collections, the view-friendly ObservableCollection<T> is provided. This collection implem\", \"ents\\ncollection changed notification, relieving the developer from having to implement the\\nINotifyCo\", \"llectionChanged interface on collections.\\n\\nModel\\n\\nModel classes are non-visual classes that encapsul\", \"ate the app's data. Therefore, the model can be\\nthought of as representing the app's domain model, w\", \"hich usually includes a data model along with\\nbusiness and validation logic. Examples of model objec\", \"ts include data transfer objects (DTOs), Plain\\nOld CLR Objects (POCOs), and generated entity and pro\", \"xy objects.\\n\\nModel classes are typically used in conjunction with services or repositories that enca\", \"psulate data\\naccess and caching.\\n\\nConnecting view models to views\\n\\nView models can be connected to v\", \"iews by using the data-binding capabilities of Xamarin.Forms.\\nThere are many approaches that can be \", \"used to construct views and view models and associate them\\nat runtime. These approaches fall into tw\", \"o categories, known as view first composition, and view\\nmodel first composition. Choosing between vi\", \"ew first composition and view model first composition is\\nan issue of preference and complexity. Howe\", \"ver, all approaches share the same aim, which is for the\\nview to have a view model assigned to its B\", \"indingContext property.\\n\\nWith view first composition the app is conceptually composed of views that \", \"connect to the view\\nmodels they depend on. The primary benefit of this approach is that it makes it \", \"easy to construct\\nloosely coupled, unit testable apps because the view models have no dependence on \", \"the views\\nthemselves. It's also easy to understand the structure of the app by following its visual \", \"structure,\\nrather than having to track code execution to understand how classes are created and asso\", \"ciated. In\\naddition, view first construction aligns with the Xamarin.Forms navigation system that's \", \"responsible\\nfor constructing pages when navigation occurs, which makes a view model first compositio\", \"n complex\\nand misaligned with the platform.\\n\\n9\\n\\nC HA PTER  2  |  MVVM\\n\\n\\fWith view model first compos\", \"ition the app is conceptually composed of view models, with a service\\nbeing responsible for locating\", \" the view for a view model. View model first composition feels more\\nnatural to some developers, sinc\", \"e the view creation can be abstracted away, allowing them to focus\\non the logical non-UI structure o\", \"f the app. In addition, it allows view models to be created by other\\nview models. However, this appr\", \"oach is often complex and it can become difficult to understand how\\nthe various parts of the app are\", \" created and associated.\\n\\nTip: Keep view models and views independent\\n\\nThe binding of views to a pro\", \"perty in a data source should be the view's principal dependency on\\nits corresponding view model. Sp\", \"ecifically, don't reference view types, such as Button and\\nListView, from view models. By following \", \"the principles outlined here, view models can be tested\\nin isolation, therefore reducing the likelih\", \"ood of software defects by limiting scope.\\n\\nThe following sections discuss the main approaches to co\", \"nnecting view models to views.\\n\\nCreating a view model declaratively\\n\\nThe simplest approach is for th\", \"e view to declaratively instantiate its corresponding view model in\\nXAML. When the view is construct\", \"ed, the corresponding view model object will also be constructed.\\nThis approach is demonstrated in t\", \"he following code example:\\n\\n<ContentPage ... xmlns:local=\\\"clr-namespace:eShop\\\">\\n    <ContentPage.Bin\", \"dingContext>\\n        <local:LoginViewModel />\\n    </ContentPage.BindingContext>\\n    ...\\n</ContentPag\", \"e>\\n\\nWhen the ContentPage is created, an instance of the LoginViewModel is automatically constructed\\n\", \"and set as the view's BindingContext.\\n\\nThis declarative construction and assignment of the view mode\", \"l by the view has the advantage that\\nit's simple, but has the disadvantage that it requires a defaul\", \"t (parameter-less) constructor in the view\\nmodel.\\n\\nCreating a view model programmatically\\n\\nA view ca\", \"n have code in the code-behind file that results in the view model being assigned to its\\nBindingCont\", \"ext property. This is often accomplished in the view's constructor, as shown in the\\nfollowing code e\", \"xample:\\n\\npublic LoginView()\\n{\\n    InitializeComponent();\\n    BindingContext = new LoginViewModel(nav\", \"igationService);\\n}\\n\\nThe programmatic construction and assignment of the view model within the view's\", \" code-behind has\\nthe advantage that it's simple. However, the main disadvantage of this approach is \", \"that the view\\nneeds to provide the view model with any required dependencies. Using a dependency inj\", \"ection\\ncontainer can help to maintain loose coupling between the view and view model. For more\\ninfor\", \"mation, see Dependency injection.\\n\\n10\\n\\nC HA PTER  2  |  MVVM\\n\\n\\fCreating a view defined as a data tem\", \"plate\\n\\nA view can be defined as a data template and associated with a view model type. Data template\", \"s can\\nbe defined as resources, or they can be defined inline within the control that will display th\", \"e view\\nmodel. The content of the control is the view model instance, and the data template is used t\", \"o visually\\nrepresent it. This technique is an example of a situation in which the view model is inst\", \"antiated first,\\nfollowed by the creation of the view.\\n\\nAutomatically creating a view model with a vi\", \"ew model locator\\n\\nA view model locator is a custom class that manages the instantiation of view mode\", \"ls and their\\nassociation to views. In the eShopOnContainers mobile app, the ViewModelLocator class h\", \"as an\\nattached property, AutoWireViewModel, that's used to associate view models with views. In the \", \"view's\\nXAML, this attached property is set to true to indicate that the view model should be automat\", \"ically\\nconnected to the view, as shown in the following code example:\\n\\nviewModelBase:ViewModelLocato\", \"r.AutoWireViewModel=\\\"true\\\"\\n\\nThe AutoWireViewModel property is a bindable property that's initialized\", \" to false, and when its\\nvalue changes the OnAutoWireViewModelChanged event handler is called. This m\", \"ethod resolves the\\nview model for the view. The following code example shows how this is achieved:\\n\\n\", \"private static void OnAutoWireViewModelChanged(BindableObject bindable, object oldValue, object n\\new\", \"Value)\\n{\\n    var view = bindable as Element;\\n    if (view == null)\\n    {\\n        return;\\n    }\\n\\n    \", \"var viewType = view.GetType();\\n    var viewName = viewType.FullName.Replace(\\\".Views.\\\", \\\".ViewModels.\", \"\\\");\\n    var viewAssemblyName = viewType.GetTypeInfo().Assembly.FullName;\\n    var viewModelName = str\", \"ing.Format(\\n        CultureInfo.InvariantCulture, \\\"{0}Model, {1}\\\", viewName, viewAssemblyName);\\n\\n   \", \" var viewModelType = Type.GetType(viewModelName);\\n    if (viewModelType == null)\\n    {\\n        retur\", \"n;\\n    }\\n    var viewModel = _container.Resolve(viewModelType);\\n    view.BindingContext = viewModel;\", \"\\n}\\n\\nThe OnAutoWireViewModelChanged method attempts to resolve the view model using a convention-\\nbas\", \"ed approach. This convention assumes that:\\n\\n\\u2022  View models are in the same assembly as view types.\\n\\n\", \"\\u2022  Views are in a .Views child namespace.\\n\\n\\u2022  View models are in a .ViewModels child namespace.\\n\\n\\u2022  \", \"View model names correspond with view names and end with \\\"ViewModel\\\".\\n\\n11\\n\\nC HA PTER  2  |  MVVM\\n\\n\\fF\", \"inally, the OnAutoWireViewModelChanged method sets the BindingContext of the view type to the\\nresolv\", \"ed view model type. For more information about resolving the view model type, see Resolution.\\n\\nThis \", \"approach has the advantage that an app has a single class that is responsible for the instantiation\\n\", \"of view models and their connection to views.\\n\\nTip: Use a view model locator for ease of substitutio\", \"n\\n\\nA view model locator can also be used as a point of substitution for alternate implementations of\", \"\\ndependencies, such as for unit testing or design time data.\\n\\nUpdating views in response to changes \", \"in the\\nunderlying view model or model\\n\\nAll view model and model classes that are accessible to a vie\", \"w should implement the\\nINotifyPropertyChanged interface. Implementing this interface in a view model\", \" or model class\\nallows the class to provide change notifications to any data-bound controls in the v\", \"iew when the\\nunderlying property value changes.\\n\\nApp's should be architected for the correct use of \", \"property change notification, by meeting the\\nfollowing requirements:\\n\\n\\u2022  Always raising a PropertyCh\", \"anged event if a public property's value changes. Do not assume\\nthat raising the PropertyChanged eve\", \"nt can be ignored because of knowledge of how XAML\\nbinding occurs.\\n\\n\\u2022  Always raising a PropertyChan\", \"ged event for any calculated properties whose values are used\\n\\nby other properties in the view model\", \" or model.\\n\\n\\u2022  Always raising the PropertyChanged event at the end of the method that makes a proper\", \"ty\\nchange, or when the object is known to be in a safe state. Raising the event interrupts the\\nopera\", \"tion by invoking the event's handlers synchronously. If this happens in the middle of an\\noperation, \", \"it might expose the object to callback functions when it is in an unsafe, partially\\nupdated state. I\", \"n addition, it's possible for cascading changes to be triggered by\\nPropertyChanged events. Cascading\", \" changes generally require updates to be complete\\nbefore the cascading change is safe to execute.\\n\\n\\u2022\", \"  Never raising a PropertyChanged event if the property does not change. This means that you\\n\\nmust c\", \"ompare the old and new values before raising the PropertyChanged event.\\n\\n\\u2022  Never raising the Proper\", \"tyChanged event during a view model's constructor if you are\\n\\ninitializing a property. Data-bound co\", \"ntrols in the view will not have subscribed to receive\\nchange notifications at this point.\\n\\n\\u2022  Never\", \" raising more than one PropertyChanged event with the same property name\\n\\nargument within a single s\", \"ynchronous invocation of a public method of a class. For example,\\ngiven a NumberOfItems property who\", \"se backing store is the _numberOfItems field, if a\\nmethod increments _numberOfItems fifty times duri\", \"ng the execution of a loop, it should only\\nraise property change notification on the NumberOfItems p\", \"roperty once, after all the work is\\ncomplete. For asynchronous methods, raise the PropertyChanged ev\", \"ent for a given property\\nname in each synchronous segment of an asynchronous continuation chain.\\n\\nTh\", \"e eShopOnContainers mobile app uses the ExtendedBindableObject class to provide change\\nnotifications\", \", which is shown in the following code example:\\n\\n12\\n\\nC HA PTER  2  |  MVVM\\n\\n\\fpublic abstract class E\", \"xtendedBindableObject : BindableObject\\n{\\n    public void RaisePropertyChanged<T>(Expression<Func<T>>\", \" property)\\n    {\\n        var name = GetMemberInfo(property).Name;\\n        OnPropertyChanged(name);\\n \", \"   }\\n\\n    private MemberInfo GetMemberInfo(Expression expression)\\n    {\\n        ...\\n    }\\n}\\n\\nXamarin\", \".Form's BindableObject class implements the INotifyPropertyChanged interface, and\\nprovides an OnProp\", \"ertyChanged method. The ExtendedBindableObject class provides the\\nRaisePropertyChanged method to inv\", \"oke property change notification, and in doing so uses the\\nfunctionality provided by the BindableObj\", \"ect class.\\n\\nEach view model class in the eShopOnContainers mobile app derives from the ViewModelBase\", \" class,\\nwhich in turn derives from the ExtendedBindableObject class. Therefore, each view model clas\", \"s uses\\nthe RaisePropertyChanged method in the ExtendedBindableObject class to provide property\\nchang\", \"e notification. The following code example shows how the eShopOnContainers mobile app\\ninvokes proper\", \"ty change notification by using a lambda expression:\\n\\npublic bool IsLogin\\n{\\n    get\\n    {\\n        re\", \"turn _isLogin;\\n    }\\n    set\\n    {\\n        _isLogin = value;\\n        RaisePropertyChanged(() => IsLo\", \"gin);\\n    }\\n}\\n\\nNote that using a lambda expression in this way involves a small performance cost bec\", \"ause the\\nlambda expression has to be evaluated for each call. Although the performance cost is small\", \" and\\nwould not normally impact an app, the costs can accrue when there are many change notifications\", \".\\nHowever, the benefit of this approach is that it provides compile-time type safety and refactoring\", \"\\nsupport when renaming properties.\\n\\nUI interaction using commands and behaviors\\n\\nIn mobile apps, act\", \"ions are typically invoked in response to a user action, such as a button click, that\\ncan be impleme\", \"nted by creating an event handler in the code-behind file. However, in the MVVM\\npattern, the respons\", \"ibility for implementing the action lies with the view model, and placing code in\\nthe code-behind sh\", \"ould be avoided.\\n\\nCommands provide a convenient way to represent actions that can be bound to contro\", \"ls in the UI.\\nThey encapsulate the code that implements the action, and help to keep it decoupled fr\", \"om its visual\\nrepresentation in the view. Xamarin.Forms includes controls that can be declaratively \", \"connected to a\\ncommand, and these controls will invoke the command when the user interacts with the \", \"control.\\n\\n13\\n\\nC HA PTER  2  |  MVVM\\n\\n\\fBehaviors also allow controls to be declaratively connected to\", \" a command. However, behaviors can be\\nused to invoke an action that's associated with a range of eve\", \"nts raised by a control. Therefore,\\nbehaviors address many of the same scenarios as command-enabled \", \"controls, while providing a\\ngreater degree of flexibility and control. In addition, behaviors can al\", \"so be used to associate command\\nobjects or methods with controls that were not specifically designed\", \" to interact with commands.\\n\\nImplementing commands\\n\\nView models typically expose command properties,\", \" for binding from the view, that are object\\ninstances that implement the ICommand interface. A numbe\", \"r of Xamarin.Forms controls provide a\\nCommand property, which can be data bound to an ICommand objec\", \"t provided by the view model. The\\nICommand interface defines an Execute method, which encapsulates t\", \"he operation itself, a\\nCanExecute method, which indicates whether the command can be invoked, and a\\n\", \"CanExecuteChanged event that occurs when changes occur that affect whether the command should\\nexecut\", \"e. The Command and Command<T> classes, provided by Xamarin.Forms, implement the ICommand\\ninterface, \", \"where T is the type of the arguments to Execute and CanExecute.\\n\\nWithin a view model, there should b\", \"e an object of type Command or Command<T> for each public\\nproperty in the view model of type IComman\", \"d. The Command or Command<T> constructor requires an\\nAction callback object that's called when the I\", \"Command.Execute method is invoked. The\\nCanExecute method is an optional constructor parameter, and i\", \"s a Func that returns a bool.\\n\\nThe following code shows how a Command instance, which represents a r\", \"egister command, is\\nconstructed by specifying a delegate to the Register view model method:\\n\\npublic \", \"ICommand RegisterCommand => new Command(Register);\\n\\nThe command is exposed to the view through a pro\", \"perty that returns a reference to an ICommand.\\nWhen the Execute method is called on the Command obje\", \"ct, it simply forwards the call to the method\\nin the view model via the delegate that was specified \", \"in the Command constructor.\\n\\nAn asynchronous method can be invoked by a command by using the async a\", \"nd await keywords\\nwhen specifying the command's Execute delegate. This indicates that the callback i\", \"s a Task and\\nshould be awaited. For example, the following code shows how a Command instance, which \", \"represents\\na sign-in command, is constructed by specifying a delegate to the SignInAsync view model \", \"method:\\n\\npublic ICommand SignInCommand => new Command(async () => await SignInAsync());\\n\\nParameters \", \"can be passed to the Execute and CanExecute actions by using the Command<T> class to\\ninstantiate the\", \" command. For example, the following code shows how a Command<T> instance is used\\nto indicate that t\", \"he NavigateAsync method will require an argument of type string:\\n\\npublic ICommand NavigateCommand =>\", \" new Command<string>(NavigateAsync);\\n\\nIn both the Command and Command<T> classes, the delegate to th\", \"e CanExecute method in each\\nconstructor is optional. If a delegate isn't specified, the Command will\", \" return true for CanExecute.\\nHowever, the view model can indicate a change in the command's CanExecu\", \"te status by calling the\\nChangeCanExecute method on the Command object. This causes the CanExecuteCh\", \"anged event to be\\nraised. Any controls in the UI that are bound to the command will then update thei\", \"r enabled status to\\nreflect the availability of the data-bound command.\\n\\n14\\n\\nC HA PTER  2  |  MVVM\\n\\n\", \"\\fInvoking commands from a view\\n\\nThe following code example shows how a Grid in the LoginView binds t\", \"o the RegisterCommand in\\nthe LoginViewModel class by using a TapGestureRecognizer instance:\\n\\n<Grid G\", \"rid.Column=\\\"1\\\" HorizontalOptions=\\\"Center\\\">\\n    <Label Text=\\\"REGISTER\\\" TextColor=\\\"Gray\\\"/>\\n    <Grid.G\", \"estureRecognizers>\\n        <TapGestureRecognizer Command=\\\"{Binding RegisterCommand}\\\" NumberOfTapsReq\", \"uired=\\\"1\\\" />\\n    </Grid.GestureRecognizers>\\n</Grid>\\n\\nA command parameter can also be optionally defi\", \"ned using the CommandParameter property. The\\ntype of the expected argument is specified in the Execu\", \"te and CanExecute target methods. The\\nTapGestureRecognizer will automatically invoke the target comm\", \"and when the user interacts with\\nthe attached control. The command parameter, if provided, will be p\", \"assed as the argument to the\\ncommand's Execute delegate.\\n\\nImplementing behaviors\\n\\nBehaviors allow fu\", \"nctionality to be added to UI controls without having to subclass them. Instead, the\\nfunctionality i\", \"s implemented in a behavior class and attached to the control as if it was part of the\\ncontrol itsel\", \"f. Behaviors enable you to implement code that you would normally have to write as\\ncode-behind, beca\", \"use it directly interacts with the API of the control, in such a way that it can be\\nconcisely attach\", \"ed to the control, and packaged for reuse across more than one view or app. In the\\ncontext of MVVM, \", \"behaviors are a useful approach for connecting controls to commands.\\n\\nA behavior that's attached to \", \"a control through attached properties is known as an attached behavior.\\nThe behavior can then use th\", \"e exposed API of the element to which it is attached to add functionality\\nto that control, or other \", \"controls, in the visual tree of the view. The eShopOnContainers mobile app\\ncontains the LineColorBeh\", \"avior class, which is an attached behavior. For more information about\\nthis behavior, see Displaying\", \" validation errors.\\n\\nA Xamarin.Forms behavior is a class that derives from the Behavior or Behavior<\", \"T> class, where T is\\nthe type of the control to which the behavior should apply. These classes provi\", \"de OnAttachedTo and\\nOnDetachingFrom methods, which should be overridden to provide logic that will b\", \"e executed when\\nthe behavior is attached to and detached from controls.\\n\\nIn the eShopOnContainers mo\", \"bile app, the BindableBehavior<T> class derives from the\\nBehavior<T> class. The purpose of the Binda\", \"bleBehavior<T> class is to provide a base class for\\nXamarin.Forms behaviors that require the Binding\", \"Context of the behavior to be set to the attached\\ncontrol.\\n\\nThe BindableBehavior<T> class provides a\", \"n overridable OnAttachedTo method that sets the\\nBindingContext of the behavior, and an overridable O\", \"nDetachingFrom method that cleans up the\\nBindingContext. In addition, the class stores a reference t\", \"o the attached control in the\\nAssociatedObject property.\\n\\nThe eShopOnContainers mobile app includes \", \"an EventToCommandBehavior class, which executes a\\ncommand in response to an event occurring. This cl\", \"ass derives from the BindableBehavior<View>\\nclass so that the behavior can bind to and execute an IC\", \"ommand specified by a Command property\\nwhen the behavior is consumed. The following code example sho\", \"ws the EventToCommandBehavior\\nclass:\\n\\n15\\n\\nC HA PTER  2  |  MVVM\\n\\n\\fpublic class EventToCommandBehavio\", \"r : BindableBehavior<View>\\n{\\n    ...\\n    protected override void OnAttachedTo(View visualElement)\\n  \", \"  {\\n        base.OnAttachedTo(visualElement);\\n\\n        var events = AssociatedObject.GetType().GetRu\", \"ntimeEvents().ToArray();\\n        if (events.Any())\\n        {\\n            _eventInfo = events.FirstOr\", \"Default(e => e.Name == EventName);\\n            if (_eventInfo == null)\\n                throw new Arg\", \"umentException(string.Format(\\n                        \\\"EventToCommand: Can't find any event named '{\", \"0}' on attached type\\\",\\n                        EventName));\\n\\n            AddEventHandler(_eventInfo,\", \" AssociatedObject, OnFired);\\n        }\\n    }\\n\\n    protected override void OnDetachingFrom(View view)\", \"\\n    {\\n        if (_handler != null)\\n            _eventInfo.RemoveEventHandler(AssociatedObject, _ha\", \"ndler);\\n\\n        base.OnDetachingFrom(view);\\n    }\\n\\n    private void AddEventHandler(\\n            Ev\", \"entInfo eventInfo, object item, Action<object, EventArgs> action)\\n    {\\n        ...\\n    }\\n\\n    priva\", \"te void OnFired(object sender, EventArgs eventArgs)\\n    {\\n        ...\\n    }\\n}\\n\\nThe OnAttachedTo and \", \"OnDetachingFrom methods are used to register and deregister an event\\nhandler for the event defined i\", \"n the EventName property. Then, when the event fires, the OnFired\\nmethod is invoked, which executes \", \"the command.\\n\\nThe advantage of using the EventToCommandBehavior to execute a command when an event f\", \"ires, is\\nthat commands can be associated with controls that weren't designed to interact with comman\", \"ds. In\\naddition, this moves event-handling code to view models, where it can be unit tested.\\n\\nInvoki\", \"ng behaviors from a view\\n\\nThe EventToCommandBehavior is particularly useful for attaching a command \", \"to a control that\\ndoesn't support commands. For example, the ProfileView uses the EventToCommandBeha\", \"vior to\\nexecute the OrderDetailCommand when the ItemTapped event fires on the ListView that lists th\", \"e\\nuser's orders, as shown in the following code:\\n\\n<ListView>\\n    <ListView.Behaviors>\\n        <behav\", \"iors:EventToCommandBehavior\\n            EventName=\\\"ItemTapped\\\"\\n            Command=\\\"{Binding OrderDe\", \"tailCommand}\\\"\\n            EventArgsConverter=\\\"{StaticResource ItemTappedEventArgsConverter}\\\" />\\n\\n16\\n\", \"\\nC HA PTER  2  |  MVVM\\n\\n\\f    </ListView.Behaviors>\\n    ...\\n</ListView>\\n\\nAt runtime, the EventToComma\", \"ndBehavior will respond to interaction with the ListView. When an\\nitem is selected in the ListView, \", \"the ItemTapped event will fire, which will execute the\\nOrderDetailCommand in the ProfileViewModel. B\", \"y default, the event arguments for the event are\\npassed to the command. This data is converted as it\", \"'s passed between source and target by the\\nconverter specified in the EventArgsConverter property, w\", \"hich returns the Item of the ListView\\nfrom the ItemTappedEventArgs. Therefore, when the OrderDetailC\", \"ommand is executed, the selected\\nOrder is passed as a parameter to the registered Action.\\n\\nFor more \", \"information about behaviors, see Behaviors on the Xamarin Developer Center.\\n\\nSummary\\n\\nThe Model-View\", \"-ViewModel (MVVM) pattern helps to cleanly separate the business and presentation\\nlogic of an applic\", \"ation from its user interface (UI). Maintaining a clean separation between application\\nlogic and the\", \" UI helps to address numerous development issues and can make an application easier\\nto test, maintai\", \"n, and evolve. It can also greatly improve code re-use opportunities and allows\\ndevelopers and UI de\", \"signers to more easily collaborate when developing their respective parts of an\\napp.\\n\\nUsing the MVVM\", \" pattern, the UI of the app and the underlying presentation and business logic is\\nseparated into thr\", \"ee separate classes: the view, which encapsulates the UI and UI logic; the view\\nmodel, which encapsu\", \"lates presentation logic and state; and the model, which encapsulates the app's\\nbusiness logic and d\", \"ata.\\n\\n17\\n\\nC HA PTER  2  |  MVVM\\n\\n\\fC H A P T E R\\n\\n3\\n\\nDependency\\ninjection\\n\\nTypically, a class constru\", \"ctor is invoked when instantiating an object, and any values that the object\\nneeds are passed as arg\", \"uments to the constructor. This is an example of dependency injection, and\\nspecifically is known as \", \"constructor injection. The dependencies the object needs are injected into the\\nconstructor.\\n\\nBy spec\", \"ifying dependencies as interface types, dependency injection enables decoupling of the\\nconcrete type\", \"s from the code that depends on these types. It generally uses a container that holds a\\nlist of regi\", \"strations and mappings between interfaces and abstract types, and the concrete types that\\nimplement \", \"or extend these types.\\n\\nThere are also other types of dependency injection, such as property setter \", \"injection, and method call\\ninjection, but they are less commonly seen. Therefore, this chapter will \", \"focus solely on performing\\nconstructor injection with a dependency injection container.\\n\\nIntroductio\", \"n to dependency injection\\n\\nDependency injection is a specialized version of the Inversion of Control\", \" (IoC) pattern, where the\\nconcern being inverted is the process of obtaining the required dependency\", \". With dependency\\ninjection, another class is responsible for injecting dependencies into an object \", \"at runtime. The\\nfollowing code example shows how the ProfileViewModel class is structured when using\", \"\\ndependency injection:\\n\\npublic class ProfileViewModel : ViewModelBase\\n{\\n    private IOrderService _o\", \"rderService;\\n\\n    public ProfileViewModel(IOrderService orderService)\\n    {\\n        _orderService = \", \"orderService;\\n    }\\n    ...\\n}\\n\\nThe ProfileViewModel constructor receives an IOrderService instance a\", \"s an argument, injected by\\nanother class. The only dependency in the ProfileViewModel class is on th\", \"e interface type.\\nTherefore, the ProfileViewModel class doesn't have any knowledge of the class that\", \"'s responsible for\\ninstantiating the IOrderService object. The class that's responsible for instanti\", \"ating the\\n\\n18\\n\\nC HA PTER  3  |  Dependency injection\\n\\n\\fIOrderService object, and inserting it into t\", \"he ProfileViewModel class, is known as the dependency\\ninjection container.\\n\\nDependency injection con\", \"tainers reduce the coupling between objects by providing a facility to\\ninstantiate class instances a\", \"nd manage their lifetime based on the configuration of the container.\\nDuring the objects creation, t\", \"he container injects any dependencies that the object requires into it. If\\nthose dependencies have n\", \"ot yet been created, the container creates and resolves their dependencies\\nfirst.\\n\\nNote: Dependency \", \"injection can also be implemented manually using factories. However, using a\\ncontainer provides addi\", \"tional capabilities such as lifetime management, and registration through\\nassembly scanning.\\n\\nThere \", \"are several advantages to using a dependency injection container:\\n\\n\\u2022  A container removes the need f\", \"or a class to locate its dependencies and manage their\\n\\nlifetimes.\\n\\n\\u2022  A container allows mapping of\", \" implemented dependencies without affecting the class.\\n\\n\\u2022  A container facilitates testability by al\", \"lowing dependencies to be mocked.\\n\\n\\u2022  A container increases maintainability by allowing new classes \", \"to be easily added to the app.\\n\\nIn the context of a Xamarin.Forms app that uses MVVM, a dependency i\", \"njection container will\\ntypically be used for registering and resolving view models, and for registe\", \"ring services and injecting\\nthem into view models.\\n\\nThere are many dependency injection containers a\", \"vailable, with the eShopOnContainers mobile app\\nusing Autofac to manage the instantiation of view mo\", \"del and service classes in the app. Autofac\\nfacilitates building loosely coupled apps, and provides \", \"all of the features commonly found in\\ndependency injection containers, including methods to register\", \" type mappings and object instances,\\nresolve objects, manage object lifetimes, and inject dependent \", \"objects into constructors of objects\\nthat it resolves. For more information about Autofac, see Autof\", \"ac on readthedocs.io.\\n\\nIn Autofac, the IContainer interface provides the dependency injection contai\", \"ner. Figure 3-1 shows\\nthe dependencies when using this container, which instantiates an IOrderServic\", \"e object and injects\\nit into the ProfileViewModel class.\\n\\nFigure 3-1: Dependencies when using depend\", \"ency injection\\n\\n19\\n\\nC HA PTER  3  |  Dependency injection\\n\\n\\fAt runtime, the container must know whic\", \"h implementation of the IOrderService interface it should\\ninstantiate, before it can instantiate a P\", \"rofileViewModel object. This involves:\\n\\n\\u2022  The container deciding how to instantiate an object that \", \"implements the IOrderService\\n\\ninterface. This is known as registration.\\n\\n\\u2022  The container instantiat\", \"ing the object that implements the IOrderService interface, and the\\n\\nProfileViewModel object. This i\", \"s known as resolution.\\n\\nEventually, the app will finish using the ProfileViewModel object and it wil\", \"l become available for\\ngarbage collection. At this point, the garbage collector should dispose of th\", \"e IOrderService instance\\nif other classes do not share the same instance.\\n\\nTip: Write container-agno\", \"stic code\\n\\nAlways try to write container-agnostic code to decouple the app from the specific depende\", \"ncy\\ncontainer being used.\\n\\nRegistration\\n\\nBefore dependencies can be injected into an object, the typ\", \"es of the dependencies must first be\\nregistered with the container. Registering a type typically inv\", \"olves passing the container an interface\\nand a concrete type that implements the interface.\\n\\nThere a\", \"re two ways of registering types and objects in the container through code:\\n\\n\\u2022  Register a type or m\", \"apping with the container. When required, the container will build an\\n\\ninstance of the specified typ\", \"e.\\n\\n\\u2022  Register an existing object in the container as a singleton. When required, the container wil\", \"l\\n\\nreturn a reference to the existing object.\\n\\nTip: Dependency injection containers are not always s\", \"uitable\\n\\nDependency injection introduces additional complexity and requirements that might not be\\nap\", \"propriate or useful to small apps. If a class does not have any dependencies, or is not a\\ndependency\", \" for other types, it might not make sense to put it in the container. In addition, if a class\\nhas a \", \"single set of dependencies that are integral to the type and will never change, it might not\\nmake se\", \"nse to put it in the container.\\n\\nThe registration of types that require dependency injection should \", \"be performed in a single method in\\nan app, and this method should be invoked early in the app's life\", \"cycle to ensure that the app is aware\\nof the dependencies between its classes. In the eShopOnContain\", \"ers mobile app this is performed by\\nthe ViewModelLocator class, which builds the IContainer object a\", \"nd is the only class in the app that\\nholds a reference to that object. The following code example sh\", \"ows how the eShopOnContainers\\nmobile app declares the IContainer object in the ViewModelLocator clas\", \"s:\\n\\nprivate static IContainer _container;\\n\\nTypes and instances are registered in the RegisterDepende\", \"ncies method in the ViewModelLocator\\nclass. This is achieved by first creating a ContainerBuilder in\", \"stance, which is demonstrated in the\\nfollowing code example:\\n\\nvar builder = new ContainerBuilder();\\n\", \"\\n20\\n\\nC HA PTER  3  |  Dependency injection\\n\\n\\fTypes and instances are then registered with the Contai\", \"nerBuilder object, and the following code\\nexample demonstrates the most common form of type registra\", \"tion:\\n\\nbuilder.RegisterType<RequestProvider>().As<IRequestProvider>();\\n\\nThe RegisterType method show\", \"n here maps an interface type to a concrete type. It tells the\\ncontainer to instantiate a RequestPro\", \"vider object when it instantiates an object that requires an\\ninjection of an IRequestProvider throug\", \"h a constructor.\\n\\nConcrete types can also be registered directly without a mapping from an interface\", \" type, as shown in\\nthe following code example:\\n\\nbuilder.RegisterType<ProfileViewModel>();\\n\\nWhen the \", \"ProfileViewModel type is resolved, the container will inject its required dependencies.\\n\\nAutofac als\", \"o allows instance registration, where the container is responsible for maintaining a\\nreference to a \", \"singleton instance of a type. For example, the following code example shows how the\\neShopOnContainer\", \"s mobile app registers the concrete type to use when a ProfileViewModel\\ninstance requires an IOrderS\", \"ervice instance:\\n\\nbuilder.RegisterType<OrderService>().As<IOrderService>().SingleInstance();\\n\\nThe Re\", \"gisterType method shown here maps an interface type to a concrete type. The\\nSingleInstance method co\", \"nfigures the registration so that every dependent object receives the\\nsame shared instance. Therefor\", \"e, only a single OrderService instance will exist in the container,\\nwhich is shared by objects that \", \"require an injection of an IOrderService through a constructor.\\n\\nInstance registration can also be p\", \"erformed with the RegisterInstance method, which is\\ndemonstrated in the following code example:\\n\\nbui\", \"lder.RegisterInstance(new OrderMockService()).As<IOrderService>();\\n\\nThe RegisterInstance method show\", \"n here creates a new OrderMockService instance and registers\\nit with the container. Therefore, only \", \"a single OrderMockService instance exists in the container,\\nwhich is shared by objects that require \", \"an injection of an IOrderService through a constructor.\\n\\nFollowing type and instance registration, t\", \"he IContainer object must be built, which is demonstrated\\nin the following code example:\\n\\n_container\", \" = builder.Build();\\n\\nInvoking the Build method on the ContainerBuilder instance builds a new depende\", \"ncy injection\\ncontainer that contains the registrations that have been made.\\n\\nTip: Consider an ICont\", \"ainer as being immutable\\n\\nWhile Autofac provides an Update method to update registrations in an exis\", \"ting container, calling\\nthis method should be avoided where possible. There are risks to modifying a\", \" container after it's\\nbeen built, particularly if the container has been used. For more information,\", \" see Consider a\\nContainer as Immutable on readthedocs.io.\\n\\n21\\n\\nC HA PTER  3  |  Dependency injection\", \"\\n\\n\\fResolution\\n\\nAfter a type is registered, it can be resolved or injected as a dependency. When a ty\", \"pe is being\\nresolved and the container needs to create a new instance, it injects any dependencies i\", \"nto the\\ninstance.\\n\\nGenerally, when a type is resolved, one of three things happens:\\n\\n1.\\n\\nIf the type\", \" hasn't been registered, the container throws an exception.\\n\\n2.\\n\\nIf the type has been registered as \", \"a singleton, the container returns the singleton instance. If\\nthis is the first time the type is cal\", \"led for, the container creates it if required, and maintains a\\nreference to it.\\n\\n3.\\n\\nIf the type has\", \"n't been registered as a singleton, the container returns a new instance, and\\ndoesn't maintain a ref\", \"erence to it.\\n\\nThe following code example shows how the RequestProvider type that was previously reg\", \"istered\\nwith Autofac can be resolved:\\n\\nvar requestProvider = _container.Resolve<IRequestProvider>();\", \"\\n\\nIn this example, Autofac is asked to resolve the concrete type for the IRequestProvider type, alon\", \"g\\nwith any dependencies. Typically, the Resolve method is called when an instance of a specific type\", \" is\\nrequired. For information about controlling the lifetime of resolved objects, see Managing the l\", \"ifetime\\nof resolved objects.\\n\\nThe following code example shows how the eShopOnContainers mobile app \", \"instantiates view model\\ntypes and their dependencies:\\n\\nvar viewModel = _container.Resolve(viewModelT\", \"ype);\\n\\nIn this example, Autofac is asked to resolve the view model type for a requested view model, \", \"and the\\ncontainer will also resolve any dependencies. When resolving the ProfileViewModel type, the\\n\", \"dependency to resolve is an IOrderService object. Therefore, Autofac first constructs an\\nOrderServic\", \"e object and then passes it to the constructor of the ProfileViewModel class. For more\\ninformation a\", \"bout how the eShopOnContainers mobile app constructs view models and associates\\nthem to views, see A\", \"utomatically creating a view model with a view model locator.\\n\\nNote: Registering and resolving types\", \" with a container has a performance cost because of the\\ncontainer's use of reflection for creating e\", \"ach type, especially if dependencies are being\\nreconstructed for each page navigation in the app. If\", \" there are many or deep dependencies, the\\ncost of creation can increase significantly.\\n\\nManaging the\", \" lifetime of resolved objects\\n\\nAfter registering a type, the default behavior for Autofac is to crea\", \"te a new instance of the registered\\ntype each time the type is resolved, or when the dependency mech\", \"anism injects instances into other\\nclasses. In this scenario, the container doesn't hold a reference\", \" to the resolved object. However, when\\nregistering an instance, the default behavior for Autofac is \", \"to manage the lifetime of the object as a\\nsingleton. Therefore, the instance remains in scope while \", \"the container is in scope, and is disposed\\nwhen the container goes out of scope and is garbage colle\", \"cted, or when code explicitly disposes the\\ncontainer.\\n\\n22\\n\\nC HA PTER  3  |  Dependency injection\\n\\n\\fA\", \"n Autofac instance scope can be used to specify the singleton behavior for an object that Autofac\\ncr\", \"eates from a registered type. Autofac instance scopes manage the object lifetimes instantiated by\\nth\", \"e container. The default instance scope for the RegisterType method is the\\nInstancePerDependency sco\", \"pe. However, the SingleInstance scope can be used with the\\nRegisterType method, so that the containe\", \"r creates or returns a singleton instance of a type when\\ncalling the Resolve method. The following c\", \"ode example shows how Autofac is instructed to create a\\nsingleton instance of the NavigationService \", \"class:\\n\\nbuilder.RegisterType<NavigationService>().As<INavigationService>().SingleInstance();\\n\\nThe fi\", \"rst time that the INavigationService interface is resolved, the container creates a new\\nNavigationSe\", \"rvice object and maintains a reference to it. On any subsequent resolutions of the\\nINavigationServic\", \"e interface, the container returns a reference to the NavigationService object\\nthat was previously c\", \"reated.\\n\\nNote: The SingleInstance scope disposes created objects when the container is disposed.\\n\\nAu\", \"tofac includes additional instance scopes. For more information, see Instance Scope on\\nreadthedocs.i\", \"o.\\n\\nSummary\\n\\nDependency injection enables decoupling of concrete types from the code that depends on\", \" these\\ntypes. It typically uses a container that holds a list of registrations and mappings between \", \"interfaces\\nand abstract types, and the concrete types that implement or extend these types.\\n\\nAutofac\", \" facilitates building loosely coupled apps, and provides all of the features commonly found in\\ndepen\", \"dency injection containers, including methods to register type mappings and object instances,\\nresolv\", \"e objects, manage object lifetimes, and inject dependent objects into constructors of objects it\\nres\", \"olves.\\n\\n23\\n\\nC HA PTER  3  |  Dependency injection\\n\\n\\fC H A P T E R\\n\\n4\\n\\nCommunicating\\nbetween loosely\\n\", \"coupled\\ncomponents\\n\\nThe publish-subscribe pattern is a messaging pattern in which publishers send me\", \"ssages without\\nhaving knowledge of any receivers, known as subscribers. Similarly, subscribers liste\", \"n for specific\\nmessages, without having knowledge of any publishers.\\n\\nEvents in .NET implement the p\", \"ublish-subscribe pattern, and are the most simple and straightforward\\napproach for a communication l\", \"ayer between components if loose coupling is not required, such as a\\ncontrol and the page that conta\", \"ins it. However, the publisher and subscriber lifetimes are coupled by\\nobject references to each oth\", \"er, and the subscriber type must have a reference to the publisher type.\\nThis can create memory mana\", \"gement issues, especially when there are short lived objects that\\nsubscribe to an event of a static \", \"or long-lived object. If the event handler isn't removed, the subscriber\\nwill be kept alive by the r\", \"eference to it in the publisher, and this will prevent or delay the garbage\\ncollection of the subscr\", \"iber.\\n\\nIntroduction to MessagingCenter\\n\\nThe Xamarin.Forms MessagingCenter class implements the publi\", \"sh-subscribe pattern, allowing\\nmessage-based communication between components that are inconvenient \", \"to link by object and type\\nreferences. This mechanism allows publishers and subscribers to communica\", \"te without having a\\nreference to each other, helping to reduce dependencies between components, whil\", \"e also allowing\\ncomponents to be independently developed and tested.\\n\\nThe MessagingCenter class prov\", \"ides multicast publish-subscribe functionality. This means that there\\ncan be multiple publishers tha\", \"t publish a single message, and there can be multiple subscribers\\nlistening for the same message. Fi\", \"gure 4-1 illustrates this relationship:\\n\\n24\\n\\nC HA PTER  4  |  Communicating between loosely coupled \", \"components\\n\\n\\fFigure 4-1: Multicast publish-subscribe functionality\\n\\nPublishers send messages using t\", \"he MessagingCenter.Send method, while subscribers listen for\\nmessages using the MessagingCenter.Subs\", \"cribe method. In addition, subscribers can also\\nunsubscribe from message subscriptions, if required,\", \" with the MessagingCenter.Unsubscribe\\nmethod.\\n\\nInternally, the MessagingCenter class uses weak refer\", \"ences. This means that it will not keep objects\\nalive, and will allow them to be garbage collected. \", \"Therefore, it should only be necessary to\\nunsubscribe from a message when a class no longer wishes t\", \"o receive the message.\\n\\nThe eShopOnContainers mobile app uses the MessagingCenter class to communica\", \"te between\\nloosely coupled components. The app defines three messages:\\n\\n\\u2022  The AddProduct message is\", \" published by the CatalogViewModel class when an item is\\nadded to the shopping basket. In return, th\", \"e BasketViewModel class subscribes to the\\nmessage and increments the number of items in the shopping\", \" basket in response. In addition,\\nthe BasketViewModel class also unsubscribes from this message.\\n\\n\\u2022 \", \" The Filter message is published by the CatalogViewModel class when the user applies a\\nbrand or type\", \" filter to the items displayed from the catalogue. In return, the CatalogView\\nclass subscribes to th\", \"e message and updates the UI so that only items that match the filter\\ncriteria are displayed.\\n\\n\\u2022  Th\", \"e ChangeTab message is published by the MainViewModel class when the\\n\\nCheckoutViewModel navigates to\", \" the MainViewModel following the successful creation and\\nsubmission of a new order. In return, the M\", \"ainView class subscribes to the message and\\nupdates the UI so that the My profile tab is active, to \", \"show the user's orders.\\n\\nNote: While the MessagingCenter class permits communication between loosely\", \"-coupled classes,\\nit does not offer the only architectural solution to this issue. For example, comm\", \"unication between\\na view model and a view can also be achieved by the binding engine and through pro\", \"perty change\\nnotifications. In addition, communication between two view models can also be achieved \", \"by\\npassing data during navigation.\\n\\nIn the eShopOnContainers mobile app, MessagingCenter is used to \", \"update in the UI in response to\\nan action occurring in another class. Therefore, messages are publis\", \"hed on the UI thread, with\\nsubscribers receiving the message on the same thread.\\n\\n25\\n\\nC HA PTER  4  \", \"|  Communicating between loosley coupled components\\n\\n\\fTip: Marshal to the UI thread when performing \", \"UI updates\\n\\nIf a message that's sent from a background thread is required to update the UI, process \", \"the\\nmessage on the UI thread in the subscriber by invoking the Device.BeginInvokeOnMainThread\\nmethod\", \".\\n\\nFor more information about MessagingCenter, see MessagingCenter on the Xamarin Developer\\nCenter.\\n\", \"\\nDefining a message\\n\\nMessagingCenter messages are strings that are used to identify messages. The fo\", \"llowing code\\nexample shows the messages defined within the eShopOnContainers mobile app:\\n\\npublic cla\", \"ss MessengerKeys\\n{\\n    // Add product to basket\\n    public const string AddProduct = \\\"AddProduct\\\";\\n\\n\", \"    // Filter\\n    public const string Filter = \\\"Filter\\\";\\n\\n    // Change selected Tab programmaticall\", \"y\\n    public const string ChangeTab = \\\"ChangeTab\\\";\\n}\\n\\nIn this example, messages are defined using co\", \"nstants. The advantage of this approach is that it\\nprovides compile-time type safety and refactoring\", \" support.\\n\\nPublishing a message\\n\\nPublishers notify subscribers of a message with one of the Messagin\", \"gCenter.Send overloads. The\\nfollowing code example demonstrates publishing the AddProduct message:\\n\\n\", \"MessagingCenter.Send(this, MessengerKeys.AddProduct, catalogItem);\\n\\nIn this example, the Send method\", \" specifies three arguments:\\n\\n\\u2022  The first argument specifies the sender class. The sender class must\", \" be specified by any\\n\\nsubscribers who wish to receive the message.\\n\\n\\u2022  The second argument specifies\", \" the message.\\n\\n\\u2022  The third argument specifies the payload data to be sent to the subscriber. In thi\", \"s case the\\n\\npayload data is a CatalogItem instance.\\n\\nThe Send method will publish the message, and i\", \"ts payload data, using a fire-and-forget approach.\\nTherefore, the message is sent even if there are \", \"no subscribers registered to receive the message. In\\nthis situation, the sent message is ignored.\\n\\nN\", \"ote: The MessagingCenter.Send method can use generic parameters to control how messages\\nare delivere\", \"d. Therefore, multiple messages that share a message identity but send different\\npayload data types \", \"can be received by different subscribers.\\n\\n26\\n\\nC HA PTER  4  |  Communicating between loosley couple\", \"d components\\n\\n\\fSubscribing to a message\\n\\nSubscribers can register to receive a message using one of \", \"the MessagingCenter.Subscribe\\noverloads. The following code example demonstrates how the eShopOnCont\", \"ainers mobile app\\nsubscribes to, and processes, the AddProduct message:\\n\\nMessagingCenter.Subscribe<C\", \"atalogViewModel, CatalogItem>(\\n    this, MessageKeys.AddProduct, async (sender, arg) =>\\n{\\n    BadgeC\", \"ount++;\\n\\n    await AddCatalogItemAsync(arg);\\n});\\n\\nIn this example, the Subscribe method subscribes t\", \"o the AddProduct message, and executes a\\ncallback delegate in response to receiving the message. Thi\", \"s callback delegate, specified as a lambda\\nexpression, executes code that updates the UI.\\n\\nTip: Cons\", \"ider using immutable payload data\\n\\nDon't attempt to modify the payload data from within a callback d\", \"elegate because several threads\\ncould be accessing the received data simultaneously. In this scenari\", \"o, the payload data should be\\nimmutable to avoid concurrency errors.\\n\\nA subscriber might not need to\", \" handle every instance of a published message, and this can be\\ncontrolled by the generic type argume\", \"nts that are specified on the Subscribe method. In this\\nexample, the subscriber will only receive Ad\", \"dProduct messages that are sent from the\\nCatalogViewModel class, whose payload data is a CatalogItem\", \" instance.\\n\\nUnsubscribing from a message\\n\\nSubscribers can unsubscribe from messages they no longer w\", \"ant to receive. This is achieved with one\\nof the MessagingCenter.Unsubscribe overloads, as demonstra\", \"ted in the following code example:\\n\\nMessagingCenter.Unsubscribe<CatalogViewModel, CatalogItem>(this,\", \" MessengerKeys.AddProduct);\\n\\nIn this example, the Unsubscribe method syntax reflects the type argume\", \"nts specified when\\nsubscribing to receive the AddProduct message.\\n\\nSummary\\n\\nThe Xamarin.Forms Messag\", \"ingCenter class implements the publish-subscribe pattern, allowing\\nmessage-based communication betwe\", \"en components that are inconvenient to link by object and type\\nreferences. This mechanism allows pub\", \"lishers and subscribers to communicate without having a\\nreference to each other, helping to reduce d\", \"ependencies between components, while also allowing\\ncomponents to be independently developed and tes\", \"ted.\\n\\n27\\n\\nC HA PTER  4  |  Communicating between loosley coupled components\\n\\n\\fC H A P T E R\\n\\n5\\n\\nNavi\", \"gation\\n\\nXamarin.Forms includes support for page navigation, which typically results from the user's \", \"interaction\\nwith the UI or from the app itself as a result of internal logic-driven state changes. H\", \"owever,\\nnavigation can be complex to implement in apps that use the Model-View-ViewModel (MVVM)\\npatt\", \"ern, as the following challenges must be met:\\n\\n\\u2022  How to identify the view to be navigated to, using\", \" an approach that does not introduce tight\\n\\ncoupling and dependencies between views.\\n\\n\\u2022  How to coor\", \"dinate the process by which the view to be navigated to is instantiated and\\ninitialized. When using \", \"MVVM, the view and view model need to be instantiated and\\nassociated with each other via the view's \", \"binding context. When an app is using a\\ndependency injection container, the instantiation of views a\", \"nd view models might require a\\nspecific construction mechanism.\\n\\n\\u2022  Whether to perform view-first na\", \"vigation, or view model-first navigation. With view-first\\n\\nnavigation, the page to navigate to refer\", \"s to the name of the view type. During navigation,\\nthe specified view is instantiated, along with it\", \"s corresponding view model and other\\ndependent services. An alternative approach is to use view mode\", \"l-first navigation, where the\\npage to navigate to refers to the name of the view model type.\\n\\n\\u2022  How\", \" to cleanly separate the navigational behavior of the app across the views and view\\n\\nmodels. The MVV\", \"M pattern provides a separation between the app's UI and its presentation\\nand business logic. Howeve\", \"r, the navigation behavior of an app will often span the UI and\\npresentations parts of the app. The \", \"user will often initiate navigation from a view, and the\\nview will be replaced as a result of the na\", \"vigation. However, navigation might often also need\\nto be initiated or coordinated from within the v\", \"iew model.\\n\\n\\u2022  How to pass parameters during navigation for initialization purposes. For example, if\", \" the user\\nnavigates to a view to update order details, the order data will have to be passed to the \", \"view\\nso that it can display the correct data.\\n\\n\\u2022  How to co-ordinate navigation, to ensure that cert\", \"ain business rules are obeyed. For example,\\nusers might be prompted before navigating away from a vi\", \"ew so that they can correct any\\ninvalid data or be prompted to submit or discard any data changes th\", \"at were made within the\\nview.\\n\\nThis chapter addresses these challenges by presenting a NavigationSer\", \"vice class that's used to\\nperform view model-first page navigation.\\n\\nNote: The NavigationService use\", \"d by the app is designed only to perform hierarchical\\nnavigation between ContentPage instances. Usin\", \"g the service to navigate between other page\\ntypes might result in unexpected behavior.\\n\\n28\\n\\nC HA PT\", \"ER  5  |  Navigation\\n\\n\\fNavigating between pages\\n\\nNavigation logic can reside in a view's code-behind\", \", or in a data bound view model. While placing\\nnavigation logic in a view might be the simplest appr\", \"oach, it is not easily testable through unit tests.\\nPlacing navigation logic in view model classes m\", \"eans that the logic can be exercised through unit\\ntests. In addition, the view model can then implem\", \"ent logic to control navigation to ensure that\\ncertain business rules are enforced. For example, an \", \"app might not allow the user to navigate away\\nfrom a page without first ensuring that the entered da\", \"ta is valid.\\n\\nA NavigationService class is typically invoked from view models, in order to promote t\", \"estability.\\nHowever, navigating to views from view models would require the view models to reference\", \" views,\\nand particularly views that the active view model isn't associated with, which is not recomm\", \"ended.\\nTherefore, the NavigationService presented here specifies the view model type as the target t\", \"o\\nnavigate to.\\n\\nThe eShopOnContainers mobile app uses the NavigationService class to provide view mo\", \"del-first\\nnavigation. This class implements the INavigationService interface, which is shown in the \", \"following\\ncode example:\\n\\npublic interface INavigationService\\n{\\n    ViewModelBase PreviousPageViewMod\", \"el { get; }\\n    Task InitializeAsync();\\n    Task NavigateToAsync<TViewModel>() where TViewModel : Vi\", \"ewModelBase;\\n    Task NavigateToAsync<TViewModel>(object parameter) where TViewModel : ViewModelBase\", \";\\n    Task RemoveLastFromBackStackAsync();\\n    Task RemoveBackStackAsync();\\n}\\n\\nThis interface specif\", \"ies that an implementing class must provide the following methods:\\n\\nMethod\\nInitializeAsync\\n\\nPurpose\\n\", \"\\nNavigateToAsync<T>\\nNavigateToAsync<T>(parameter)  Performs hierarchical navigation to a specified p\", \"age, passing\\n\\nPerforms navigation to one of two pages when the app is\\nlaunched.\\nPerforms hierarchica\", \"l navigation to a specified page.\\n\\nRemoveLastFromBackStackAsync  Removes the previous page from the \", \"navigation stack.\\nRemoveBackStackAsync\\n\\nRemoves all the previous pages from the navigation stack.\\n\\na\", \" parameter.\\n\\nIn addition, the INavigationService interface specifies that an implementing class must\", \" provide a\\nPreviousPageViewModel property. This property returns the view model type associated with\", \" the\\nprevious page in the navigation stack.\\n\\nNote: An INavigationService interface would usually als\", \"o specify a GoBackAsync method, which\\nis used to programmatically return to the previous page in the\", \" navigation stack. However, this\\nmethod is missing from the eShopOnContainers mobile app because it'\", \"s not required.\\n\\nCreating the NavigationService instance\\n\\nThe NavigationService class, which impleme\", \"nts the INavigationService interface, is registered as\\na singleton with the Autofac dependency injec\", \"tion container, as demonstrated in the following code\\nexample:\\n\\n29\\n\\nC HA PTER  5  |  Navigation\\n\\n\\fbu\", \"ilder.RegisterType<NavigationService>().As<INavigationService>().SingleInstance();\\n\\nThe INavigationS\", \"ervice interface is resolved in the ViewModelBase class constructor, as\\ndemonstrated in the followin\", \"g code example:\\n\\nNavigationService = ViewModelLocator.Resolve<INavigationService>();\\n\\nThis returns a\", \" reference to the NavigationService object that's stored in the Autofac dependency\\ninjection contain\", \"er, which is created by the InitNavigation method in the App class. For more\\ninformation, see Naviga\", \"ting when the app is launched.\\n\\nThe ViewModelBase class stores the NavigationService instance in a N\", \"avigationService property,\\nof type INavigationService. Therefore, all view model classes, which deri\", \"ve from the\\nViewModelBase class, can use the NavigationService property to access the methods specif\", \"ied by\\nthe INavigationService interface. This avoids the overhead of injecting the NavigationService\", \"\\nobject from the Autofac dependency injection container into each view model class.\\n\\nHandling naviga\", \"tion requests\\n\\nXamarin.Forms provides the NavigationPage class, which implements a hierarchical navi\", \"gation\\nexperience in which the user is able to navigate through pages, forwards and backwards, as de\", \"sired.\\nFor more information about hierarchical navigation, see Hierarchical Navigation on the Xamari\", \"n\\nDeveloper Center.\\n\\nRather than use the NavigationPage class directly, the eShopOnContainers app wr\", \"aps the\\nNavigationPage class in the CustomNavigationView class, as shown in the following code examp\", \"le:\\n\\npublic partial class CustomNavigationView : NavigationPage\\n{\\n    public CustomNavigationView() \", \": base()\\n    {\\n        InitializeComponent();\\n    }\\n\\n    public CustomNavigationView(Page root) : ba\", \"se(root)\\n    {\\n        InitializeComponent();\\n    }\\n}\\n\\nThe purpose of this wrapping is for ease of s\", \"tyling the NavigationPage instance inside the XAML file\\nfor the class.\\n\\nNavigation is performed insi\", \"de view model classes by invoking one of the NavigateToAsync\\nmethods, specifying the view model type\", \" for the page being navigated to, as demonstrated in the\\nfollowing code example:\\n\\nawait NavigationSe\", \"rvice.NavigateToAsync<MainViewModel>();\\n\\nThe following code example shows the NavigateToAsync method\", \"s provided by the\\nNavigationService class:\\n\\n30\\n\\nC HA PTER  5  |  Navigation\\n\\n\\fpublic Task NavigateTo\", \"Async<TViewModel>() where TViewModel : ViewModelBase\\n{\\n    return InternalNavigateToAsync(typeof(TVi\", \"ewModel), null);\\n}\\n\\npublic Task NavigateToAsync<TViewModel>(object parameter) where TViewModel : Vie\", \"wModelBase\\n{\\n    return InternalNavigateToAsync(typeof(TViewModel), parameter);\\n}\\n\\nEach method allow\", \"s any view model class that derives from the ViewModelBase class to perform\\nhierarchical navigation \", \"by invoking the InternalNavigateToAsync method. In addition, the second\\nNavigateToAsync method enabl\", \"es navigation data to be specified as an argument that's passed to\\nthe view model being navigated to\", \", where it's typically used to perform initialization. For more\\ninformation, see Passing parameters \", \"during navigation.\\n\\nThe InternalNavigateToAsync method executes the navigation request, and is shown\", \" in the\\nfollowing code example:\\n\\nprivate async Task InternalNavigateToAsync(Type viewModelType, obje\", \"ct parameter)\\n{\\n    Page page = CreatePage(viewModelType, parameter);\\n\\n    if (page is LoginView)\\n  \", \"  {\\n        Application.Current.MainPage = new CustomNavigationView(page);\\n    }\\n    else\\n    {\\n    \", \"    var navigationPage = Application.Current.MainPage as CustomNavigationView;\\n        if (navigatio\", \"nPage != null)\\n        {\\n            await navigationPage.PushAsync(page);\\n        }\\n        else\\n  \", \"      {\\n            Application.Current.MainPage = new CustomNavigationView(page);\\n        }\\n    }\\n\\n\", \"    await (page.BindingContext as ViewModelBase).InitializeAsync(parameter);\\n}\\n\\nprivate Type GetPage\", \"TypeForViewModel(Type viewModelType)\\n{\\n    var viewName = viewModelType.FullName.Replace(\\\"Model\\\", st\", \"ring.Empty);\\n    var viewModelAssemblyName = viewModelType.GetTypeInfo().Assembly.FullName;\\n    var \", \"viewAssemblyName = string.Format(\\n                CultureInfo.InvariantCulture, \\\"{0}, {1}\\\", viewName\", \", viewModelAssemblyName);\\n    var viewType = Type.GetType(viewAssemblyName);\\n    return viewType;\\n}\\n\", \"\\nprivate Page CreatePage(Type viewModelType, object parameter)\\n{\\n    Type pageType = GetPageTypeForV\", \"iewModel(viewModelType);\\n    if (pageType == null)\\n    {\\n        throw new Exception($\\\"Cannot locate\", \" page type for {viewModelType}\\\");\\n    }\\n\\n31\\n\\nC HA PTER  5  |  Navigation\\n\\n\\f    Page page = Activator\", \".CreateInstance(pageType) as Page;\\n    return page;\\n}\\n\\nThe InternalNavigateToAsync method performs n\", \"avigation to a view model by first calling the\\nCreatePage method. This method locates the view that \", \"corresponds to the specified view model type,\\nand creates and returns an instance of this view type.\", \" Locating the view that corresponds to the view\\nmodel type uses a convention-based approach, which a\", \"ssumes that:\\n\\n\\u2022  Views are in the same assembly as view model types.\\n\\n\\u2022  Views are in a .Views child\", \" namespace.\\n\\n\\u2022  View models are in a .ViewModels child namespace.\\n\\n\\u2022  View names correspond to view \", \"model names, with \\\"Model\\\" removed.\\n\\nWhen a view is instantiated, it's associated with its correspond\", \"ing view model. For more information\\nabout how this occurs, see Automatically creating a view model \", \"with a view model locator.\\n\\nIf the view being created is a LoginView, it's wrapped inside a new inst\", \"ance of the\\nCustomNavigationView class and assigned to the Application.Current.MainPage property.\\nOt\", \"herwise, the CustomNavigationView instance is retrieved, and provided that it isn't null, the\\nPushAs\", \"ync method is invoked to push the view being created onto the navigation stack. However, If\\nthe retr\", \"ieved CustomNavigationView instance is null, the view being created is wrapped inside a\\nnew instance\", \" of the CustomNavigationView class and assigned to the\\nApplication.Current.MainPage property. This m\", \"echanism ensures that during navigation, pages\\nare added correctly to the navigation stack both when\", \" it's empty, and when it contains data.\\n\\nTip: Consider caching pages\\n\\nPage caching results in memory\", \" consumption for views that are not currently displayed. However,\\nwithout page caching it does mean \", \"that XAML parsing and construction of the page and its view\\nmodel will occur every time a new page i\", \"s navigated to, which can have a performance impact for a\\ncomplex page. For a well-designed page tha\", \"t does not use an excessive number of controls, the\\nperformance should be sufficient. However, page \", \"caching might help if slow page loading times are\\nencountered.\\n\\nAfter the view is created and naviga\", \"ted to, the InitializeAsync method of the view's associated\\nview model is executed. For more informa\", \"tion, see Passing parameters during navigation.\\n\\nNavigating when the app is launched\\n\\nWhen the app i\", \"s launched, the InitNavigation method in the App class is invoked. The following\\ncode example shows \", \"this method:\\n\\nprivate Task InitNavigation()\\n{\\n    var navigationService = ViewModelLocator.Resolve<I\", \"NavigationService>();\\n    return navigationService.InitializeAsync();\\n}\\n\\nThe method creates a new Na\", \"vigationService object in the Autofac dependency injection container,\\nand returns a reference to it,\", \" before invoking its InitializeAsync method.\\n\\n32\\n\\nC HA PTER  5  |  Navigation\\n\\n\\fNote: When the INavi\", \"gationService interface is resolved by the ViewModelBase class, the\\ncontainer returns a reference to\", \" the NavigationService object that was created when the\\nInitNavigation method is invoked.\\n\\nThe follo\", \"wing code example shows the NavigationService InitializeAsync method:\\n\\npublic Task InitializeAsync()\", \"\\n{\\n    if (string.IsNullOrEmpty(Settings.AuthAccessToken))\\n        return NavigateToAsync<LoginViewM\", \"odel>();\\n    else\\n        return NavigateToAsync<MainViewModel>();\\n}\\n\\nThe MainView is navigated to i\", \"f the app has a cached access token, which is used for authentication.\\nOtherwise, the LoginView is n\", \"avigated to.\\n\\nFor more information about the Autofac dependency injection container, see Introductio\", \"n to\\ndependency injection.\\n\\nPassing parameters during navigation\\n\\nOne of the NavigateToAsync methods\", \", specified by the INavigationService interface, enables\\nnavigation data to be specified as an argum\", \"ent that's passed to the view model being navigated to,\\nwhere it's typically used to perform initial\", \"ization.\\n\\nFor example, the ProfileViewModel class contains an OrderDetailCommand that's executed whe\", \"n\\nthe user selects an order on the ProfileView page. In turn, this executes the OrderDetailAsync\\nmet\", \"hod, which is shown in the following code example:\\n\\nprivate async Task OrderDetailAsync(Order order)\", \"\\n{\\n    await NavigationService.NavigateToAsync<OrderDetailViewModel>(order);\\n}\\n\\nThis method invokes \", \"navigation to the OrderDetailViewModel, passing an Order instance that\\nrepresents the order that the\", \" user selected on the ProfileView page. When the NavigationService\\nclass creates the OrderDetailView\", \", the OrderDetailViewModel class is instantiated and assigned to\\nthe view's BindingContext. After na\", \"vigating to the OrderDetailView, the\\nInternalNavigateToAsync method executes the InitializeAsync met\", \"hod of the view's associated\\nview model.\\n\\nThe InitializeAsync method is defined in the ViewModelBase\", \" class as a method that can be\\noverridden. This method specifies an object argument that represents \", \"the data to be passed to a\\nview model during a navigation operation. Therefore, view model classes t\", \"hat want to receive data\\nfrom a navigation operation provide their own implementation of the Initial\", \"izeAsync method to\\nperform the required initialization. The following code example shows the Initial\", \"izeAsync method\\nfrom the OrderDetailViewModel class:\\n\\npublic override async Task InitializeAsync(obj\", \"ect navigationData)\\n{\\n    if (navigationData is Order)\\n    {\\n        ...\\n        Order = await _orde\", \"rsService.GetOrderAsync(\\n                        Convert.ToInt32(order.OrderNumber), authToken);\\n\\n33\", \"\\n\\nC HA PTER  5  |  Navigation\\n\\n\\f        ...\\n    }\\n}\\n\\nThis method retrieves the Order instance that w\", \"as passed into the view model during the navigation\\noperation, and uses it to retrieve the full orde\", \"r details from the OrderService instance.\\n\\nInvoking navigation using behaviors\\n\\nNavigation is usuall\", \"y triggered from a view by a user interaction. For example, the LoginView\\nperforms navigation follow\", \"ing successful authentication. The following code example shows how the\\nnavigation is invoked by a b\", \"ehavior:\\n\\n<WebView ...>\\n    <WebView.Behaviors>\\n        <behaviors:EventToCommandBehavior\\n          \", \"  EventName=\\\"Navigating\\\"\\n            EventArgsConverter=\\\"{StaticResource WebNavigatingEventArgsConve\", \"rter}\\\"\\n            Command=\\\"{Binding NavigateCommand}\\\" />\\n    </WebView.Behaviors>\\n</WebView>\\n\\nAt ru\", \"ntime, the EventToCommandBehavior will respond to interaction with the WebView. When the\\nWebView nav\", \"igates to a web page, the Navigating event will fire, which will execute the\\nNavigateCommand in the \", \"LoginViewModel. By default, the event arguments for the event are passed\\nto the command. This data i\", \"s converted as it's passed between source and target by the converter\\nspecified in the EventArgsConv\", \"erter property, which returns the Url from the\\nWebNavigatingEventArgs. Therefore, when the Navigatio\", \"nCommand is executed, the Url of the web\\npage is passed as a parameter to the registered Action.\\n\\nIn\", \" turn, the NavigationCommand executes the NavigateAsync method, which is shown in the\\nfollowing code\", \" example:\\n\\nprivate async Task NavigateAsync(string url)\\n{\\n    ...\\n    await NavigationService.Naviga\", \"teToAsync<MainViewModel>();\\n    await NavigationService.RemoveLastFromBackStackAsync();\\n    ...\\n}\\n\\nT\", \"his method invokes navigation to the MainViewModel, and following navigation, removes the\\nLoginView \", \"page from the navigation stack.\\n\\nConfirming or cancelling navigation\\n\\nAn app might need to interact \", \"with the user during a navigation operation, so that the user can\\nconfirm or cancel navigation. This\", \" might be necessary, for example, when the user attempts to\\nnavigate before having fully completed a\", \" data entry page. In this situation, an app should provide a\\nnotification that allows the user to na\", \"vigate away from the page, or to cancel the navigation operation\\nbefore it occurs. This can be achie\", \"ved in a view model class by using the response from a notification\\nto control whether or not naviga\", \"tion is invoked.\\n\\n34\\n\\nC HA PTER  5  |  Navigation\\n\\n\\fSummary\\n\\nXamarin.Forms includes support for page\", \" navigation, which typically results from the user's interaction\\nwith the UI, or from the app itself\", \", as a result of internal logic-driven state changes. However,\\nnavigation can be complex to implemen\", \"t in apps that use the MVVM pattern.\\n\\nThis chapter presented a NavigationService class, which is use\", \"d to perform view model-first\\nnavigation from view models. Placing navigation logic in view model cl\", \"asses means that the logic can\\nbe exercised through automated tests. In addition, the view model can\", \" then implement logic to\\ncontrol navigation to ensure that certain business rules are enforced.\\n\\n35\\n\", \"\\nC HA PTER  5  |  Navigation\\n\\n\\fC H A P T E R\\n\\n6\\n\\nValidation\\n\\nAny app that accepts input from users s\", \"hould ensure that the input is valid. An app could, for\\nexample, check for input that contains only \", \"characters in a particular range, is of a certain length, or\\nmatches a particular format. Without va\", \"lidation, a user can supply data that causes the app to fail.\\nValidation enforces business rules, an\", \"d prevents an attacker from injecting malicious data.\\n\\nIn the context of the Model-ViewModel-Model (\", \"MVVM) pattern, a view model or model will often be\\nrequired to perform data validation and signal an\", \"y validation errors to the view so that the user can\\ncorrect them. The eShopOnContainers mobile app \", \"performs synchronous client-side validation of view\\nmodel properties and notifies the user of any va\", \"lidation errors by highlighting the control that\\ncontains the invalid data, and by displaying error \", \"messages that inform the user of why the data is\\ninvalid. Figure 6-1 shows the classes involved in p\", \"erforming validation in the eShopOnContainers\\nmobile app.\\n\\nFigure 6-1: Validation classes in the eSh\", \"opOnContainers mobile app\\n\\nView model properties that require validation are of type ValidatableObje\", \"ct<T>, and each\\nValidatableObject<T> instance has validation rules added to its Validations property\", \". Validation\\nis invoked from the view model by calling the Validate method of the ValidatableObject<\", \"T>\\n\\n36\\n\\nC HA PTER  6  |  Validation\\n\\n\\finstance, which retrieves the validation rules and executes th\", \"em against the ValidatableObject<T>\\nValue property. Any validation errors are placed into the Errors\", \" property of the\\nValidatableObject<T> instance, and the IsValid property of the ValidatableObject<T>\", \" instance\\nis updated to indicate whether validation succeeded or failed.\\n\\nProperty change notificati\", \"on is provided by the ExtendedBindableObject class, and so an Entry\\ncontrol can bind to the IsValid \", \"property of ValidatableObject<T> instance in the view model class\\nto be notified of whether or not t\", \"he entered data is valid.\\n\\nSpecifying validation rules\\n\\nValidation rules are specified by creating a\", \" class that derives from the IValidationRule<T> interface,\\nwhich is shown in the following code exam\", \"ple:\\n\\npublic interface IValidationRule<T>\\n{\\n    string ValidationMessage { get; set; }\\n    bool Chec\", \"k(T value);\\n}\\n\\nThis interface specifies that a validation rule class must provide a boolean Check me\", \"thod that is used\\nto perform the required validation, and a ValidationMessage property whose value i\", \"s the validation\\nerror message that will be displayed if validation fails.\\n\\nThe following code examp\", \"le shows the IsNotNullOrEmptyRule<T> validation rule, which is used to\\nperform validation of the use\", \"rname and password entered by the user on the LoginView when using\\nmock services in the eShopOnConta\", \"iners mobile app:\\n\\npublic class IsNotNullOrEmptyRule<T> : IValidationRule<T>\\n{\\n    public string Val\", \"idationMessage { get; set; }\\n\\n    public bool Check(T value)\\n    {\\n        if (value == null)\\n      \", \"  {\\n            return false;\\n        }\\n\\n        var str = value as string;\\n        return !string.I\", \"sNullOrWhiteSpace(str);\\n    }\\n}\\n\\nThe Check method returns a boolean indicating whether the value arg\", \"ument is null, empty, or\\nconsists only of whitespace characters.\\n\\nAlthough not used by the eShopOnCo\", \"ntainers mobile app, the following code example shows a\\nvalidation rule for validating email address\", \"es:\\n\\npublic class EmailRule<T> : IValidationRule<T>\\n{\\n    public string ValidationMessage { get; set\", \"; }\\n\\n    public bool Check(T value)\\n    {\\n        if (value == null)\\n\\n37\\n\\nC HA PTER  6  |  Validatio\", \"n\\n\\n\\f        {\\n            return false;\\n        }\\n\\n        var str = value as string;\\n        Regex \", \"regex = new Regex(@\\\"^([\\\\w\\\\.\\\\-]+)@([\\\\w\\\\-]+)((\\\\.(\\\\w){2,3})+)$\\\");\\n        Match match = regex.Match(str\", \");\\n\\n        return match.Success;\\n    }\\n}\\n\\nThe Check method returns a boolean indicating whether or \", \"not the value argument is a valid email\\naddress. This is achieved by searching the value argument fo\", \"r the first occurrence of the regular\\nexpression pattern specified in the Regex constructor. Whether\", \" the regular expression pattern has\\nbeen found in the input string can be determined by checking the\", \" value of the Match object's\\nSuccess property.\\n\\nNote: Property validation can sometimes involve depe\", \"ndent properties. An example of dependent\\nproperties is when the set of valid values for property A \", \"depends on the particular value that has\\nbeen set in property B. To check that the value of property\", \" A is one of the allowed values would\\ninvolve retrieving the value of property B. In addition, when \", \"the value of property B changes,\\nproperty A would need to be revalidated.\\n\\nAdding validation rules t\", \"o a property\\n\\nIn the eShopOnContainers mobile app, view model properties that require validation are\", \" declared to\\nbe of type ValidatableObject<T>, where T is the type of the data to be validated. The f\", \"ollowing\\ncode example shows an example of two such properties:\\n\\npublic ValidatableObject<string> Use\", \"rName\\n{\\n    get\\n    {\\n        return _userName;\\n    }\\n    set\\n    {\\n        _userName = value;\\n     \", \"   RaisePropertyChanged(() => UserName);\\n    }\\n}\\n\\npublic ValidatableObject<string> Password\\n{\\n    ge\", \"t\\n    {\\n        return _password;\\n    }\\n    set\\n    {\\n        _password = value;\\n        RaiseProper\", \"tyChanged(() => Password);\\n    }\\n}\\n\\nFor validation to occur, validation rules must be added to the V\", \"alidations collection of each\\nValidatableObject<T> instance, as demonstrated in the following code e\", \"xample:\\n\\n38\\n\\nC HA PTER  6  |  Validation\\n\\n\\fprivate void AddValidations()\\n{\\n    _userName.Validations\", \".Add(new IsNotNullOrEmptyRule<string>\\n    {\\n        ValidationMessage = \\\"A username is required.\\\"\\n  \", \"  });\\n    _password.Validations.Add(new IsNotNullOrEmptyRule<string>\\n    {\\n        ValidationMessage\", \" = \\\"A password is required.\\\"\\n    });\\n}\\n\\nThis method adds the IsNotNullOrEmptyRule<T> validation rule\", \" to the Validations collection of\\neach ValidatableObject<T> instance, specifying values for the vali\", \"dation rule's ValidationMessage\\nproperty, which specifies the validation error message that will be \", \"displayed if validation fails.\\n\\nTriggering validation\\n\\nThe validation approach used in the eShopOnCo\", \"ntainers mobile app can manually trigger validation\\nof a property, and automatically trigger validat\", \"ion when a property changes.\\n\\nTriggering validation manually\\n\\nValidation can be triggered manually f\", \"or a view model property. For example, this occurs in the\\neShopOnContainers mobile app when the user\", \" taps the Login button on the LoginView, when using\\nmock services. The command delegate calls the Mo\", \"ckSignInAsync method in the LoginViewModel,\\nwhich invokes validation by executing the Validate metho\", \"d, which is shown in the following code\\nexample:\\n\\nprivate bool Validate()\\n{\\n    bool isValidUser = V\", \"alidateUserName();\\n    bool isValidPassword = ValidatePassword();\\n    return isValidUser && isValidP\", \"assword;\\n}\\n\\nprivate bool ValidateUserName()\\n{\\n    return _userName.Validate();\\n}\\n\\nprivate bool Valid\", \"atePassword()\\n{\\n    return _password.Validate();\\n}\\n\\nThe Validate method performs validation of the u\", \"sername and password entered by the user on the\\nLoginView, by invoking the Validate method on each V\", \"alidatableObject<T> instance. The\\nfollowing code example shows the Validate method from the Validata\", \"bleObject<T> class:\\n\\npublic bool Validate()\\n{\\n    Errors.Clear();\\n\\n    IEnumerable<string> errors = \", \"_validations\\n        .Where(v => !v.Check(Value))\\n        .Select(v => v.ValidationMessage);\\n\\n39\\n\\nC \", \"HA PTER  6  |  Validation\\n\\n\\f    Errors = errors.ToList();\\n    IsValid = !Errors.Any();\\n\\n    return t\", \"his.IsValid;\\n}\\n\\nThis method clears the Errors collection, and then retrieves any validation rules th\", \"at were added to\\nthe object's Validations collection. The Check method for each retrieved validation\", \" rule is executed,\\nand the ValidationMessage property value for any validation rule that fails to va\", \"lidate the data is\\nadded to the Errors collection of the ValidatableObject<T> instance. Finally, the\", \" IsValid property\\nis set, and its value is returned to the calling method, indicating whether valida\", \"tion succeeded or\\nfailed.\\n\\nTriggering validation when properties change\\n\\nValidation is also automati\", \"cally triggered whenever a bound property changes. For example, when a\\ntwo-way binding in the LoginV\", \"iew sets the UserName or Password property, validation is triggered.\\nThe following code example demo\", \"nstrates how this occurs:\\n\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\">\\n    <Entry.Behaviors\", \">\\n        <behaviors:EventToCommandBehavior\\n            EventName=\\\"TextChanged\\\"\\n            Command=\", \"\\\"{Binding ValidateUserNameCommand}\\\" />\\n    </Entry.Behaviors>\\n    ...\\n</Entry>\\n\\nThe Entry control bi\", \"nds to the UserName.Value property of the ValidatableObject<T> instance,\\nand the control's Behaviors\", \" collection has an EventToCommandBehavior instance added to it. This\\nbehavior executes the ValidateU\", \"serNameCommand in response to the TextChanged event firing on\\nthe Entry, which is raised when the te\", \"xt in the Entry changes. In turn, the\\nValidateUserNameCommand delegate executes the ValidateUserName\", \" method, which executes the\\nValidate method on the ValidatableObject<T> instance. Therefore, every t\", \"ime the user enters a\\ncharacter in the Entry control for the username, validation of the entered dat\", \"a is performed.\\n\\nFor more information about behaviors, see Implementing behaviors.\\n\\nDisplaying valid\", \"ation errors\\n\\nThe eShopOnContainers mobile app notifies the user of any validation errors by highlig\", \"hting the\\ncontrol that contains the invalid data with a red line, and by displaying an error message\", \" that informs\\nthe user why the data is invalid below the control containing the invalid data. When t\", \"he invalid data is\\ncorrected, the line changes to black and the error message is removed. Figure 6-2\", \" shows the\\nLoginView in the eShopOnContainers mobile app when validation errors are present.\\n\\n40\\n\\nC \", \"HA PTER  6  |  Validation\\n\\n\\fFigure 6-2: Displaying validation errors during login\\n\\nHighlighting a co\", \"ntrol that contains invalid data\\n\\nThe LineColorBehavior attached behavior is used to highlight Entry\", \" controls where validation\\nerrors have occurred. The following code example shows how the LineColorB\", \"ehavior attached\\nbehavior is attached to an Entry control:\\n\\n<Entry Text=\\\"{Binding UserName.Value, Mo\", \"de=TwoWay}\\\">\\n    <Entry.Style>\\n        <OnPlatform x:TypeArguments=\\\"Style\\\"\\n          iOS=\\\"{StaticRes\", \"ource EntryStyle}\\\"\\n          Android=\\\"{StaticResource EntryStyle}\\\"\\n          WinPhone=\\\"{StaticResour\", \"ce UwpEntryStyle}\\\"/>\\n    </Entry.Style>\\n    ...\\n</Entry>\\n\\nThe Entry control consumes an explicit sty\", \"le, which is shown in the following code example:\\n\\n<Style x:Key=\\\"EntryStyle\\\"\\n       TargetType=\\\"{x:T\", \"ype Entry}\\\">\\n    ...\\n    <Setter Property=\\\"behaviors:LineColorBehavior.ApplyLineColor\\\"\\n            V\", \"alue=\\\"True\\\" />\\n    <Setter Property=\\\"behaviors:LineColorBehavior.LineColor\\\"\\n            Value=\\\"{Stat\", \"icResource BlackColor}\\\" />\\n    ...\\n</Style>\\n\\nThis style sets the ApplyLineColor and LineColor attach\", \"ed properties of the LineColorBehavior\\nattached behavior on the Entry control. For more information \", \"about styles, see Styles on the Xamarin\\nDeveloper Center.\\n\\nWhen the value of the ApplyLineColor atta\", \"ched property is set, or changes, the LineColorBehavior\\nattached behavior executes the OnApplyLineCo\", \"lorChanged method, which is shown in the following\\ncode example:\\n\\n41\\n\\nC HA PTER  6  |  Validation\\n\\n\\f\", \"public static class LineColorBehavior\\n{\\n    ...\\n    private static void OnApplyLineColorChanged(\\n   \", \"             BindableObject bindable, object oldValue, object newValue)\\n    {\\n        var view = bin\", \"dable as View;\\n        if (view == null)\\n        {\\n            return;\\n        }\\n\\n        bool hasLi\", \"ne = (bool)newValue;\\n        if (hasLine)\\n        {\\n            view.Effects.Add(new EntryLineColorE\", \"ffect());\\n        }\\n        else\\n        {\\n            var entryLineColorEffectToRemove =\\n          \", \"          view.Effects.FirstOrDefault(e => e is EntryLineColorEffect);\\n            if (entryLineColo\", \"rEffectToRemove != null)\\n            {\\n                view.Effects.Remove(entryLineColorEffectToRem\", \"ove);\\n            }\\n        }\\n    }\\n}\\n\\nThe parameters for this method provide the instance of the co\", \"ntrol that the behavior is attached to,\\nand the old and new values of the ApplyLineColor attached pr\", \"operty. The EntryLineColorEffect\\nclass is added to the control's Effects collection if the ApplyLine\", \"Color attached property is true,\\notherwise it's removed from the control's Effects collection. For m\", \"ore information about behaviors,\\nsee Implementing behaviors.\\n\\nThe EntryLineColorEffect subclasses th\", \"e RoutingEffect class, and is shown in the following code\\nexample:\\n\\npublic class EntryLineColorEffec\", \"t : RoutingEffect\\n{\\n    public EntryLineColorEffect() : base(\\\"eShopOnContainers.EntryLineColorEffect\", \"\\\")\\n    {\\n    }\\n}\\n\\nThe RoutingEffect class represents a platform-independent effect that wraps an inn\", \"er effect that's\\nplatform-specific. This simplifies the effect removal process, since there is no co\", \"mpile-time access to\\nthe type information for a platform-specific effect. The EntryLineColorEffect c\", \"alls the base class\\nconstructor, passing in a parameter consisting of a concatenation of the resolut\", \"ion group name, and\\nthe unique ID that's specified on each platform-specific effect class.\\n\\nThe foll\", \"owing code example shows the eShopOnContainers.EntryLineColorEffect implementation for\\niOS:\\n\\n[assemb\", \"ly: ResolutionGroupName(\\\"eShopOnContainers\\\")]\\n[assembly: ExportEffect(typeof(EntryLineColorEffect), \", \"\\\"EntryLineColorEffect\\\")]\\nnamespace eShopOnContainers.iOS.Effects\\n{\\n    public class EntryLineColorEf\", \"fect : PlatformEffect\\n\\n42\\n\\nC HA PTER  6  |  Validation\\n\\n\\f    {\\n        UITextField control;\\n\\n       \", \" protected override void OnAttached()\\n        {\\n            try\\n            {\\n                contro\", \"l = Control as UITextField;\\n                UpdateLineColor();\\n            }\\n            catch (Exce\", \"ption ex)\\n            {\\n                Console.WriteLine(\\\"Can't set property on attached control. E\", \"rror: \\\", ex.Message);\\n            }\\n        }\\n\\n        protected override void OnDetached()\\n        \", \"{\\n            control = null;\\n        }\\n\\n        protected override void OnElementPropertyChanged(Pr\", \"opertyChangedEventArgs args)\\n        {\\n            base.OnElementPropertyChanged(args);\\n\\n           \", \" if (args.PropertyName == LineColorBehavior.LineColorProperty.PropertyName ||\\n                args.P\", \"ropertyName == \\\"Height\\\")\\n            {\\n                Initialize();\\n                UpdateLineColor\", \"();\\n            }\\n        }\\n\\n        private void Initialize()\\n        {\\n            var entry = Ele\", \"ment as Entry;\\n            if (entry != null)\\n            {\\n                Control.Bounds = new CGR\", \"ect(0, 0, entry.Width, entry.Height);\\n            }\\n        }\\n\\n        private void UpdateLineColor(\", \")\\n        {\\n            BorderLineLayer lineLayer = control.Layer.Sublayers.OfType<BorderLineLayer>(\", \")\\n                                                             .FirstOrDefault();\\n\\n            if (l\", \"ineLayer == null)\\n            {\\n                lineLayer = new BorderLineLayer();\\n                l\", \"ineLayer.MasksToBounds = true;\\n                lineLayer.BorderWidth = 1.0f;\\n                control\", \".Layer.AddSublayer(lineLayer);\\n                control.BorderStyle = UITextBorderStyle.None;\\n       \", \"     }\\n\\n            lineLayer.Frame = new CGRect(0f, Control.Frame.Height-1f, Control.Bounds.Width, \", \"1f);\\n            lineLayer.BorderColor = LineColorBehavior.GetLineColor(Element).ToCGColor();\\n      \", \"      control.TintColor = control.TextColor;\\n        }\\n\\n        private class BorderLineLayer : CALa\", \"yer\\n        {\\n        }\\n\\n43\\n\\nC HA PTER  6  |  Validation\\n\\n\\f    }\\n}\\n\\nThe OnAttached method retrieves \", \"the native control for the Xamarin.Forms Entry control, and\\nupdates the line color by calling the Up\", \"dateLineColor method. The OnElementPropertyChanged\\noverride responds to bindable property changes on\", \" the Entry control by updating the line color if the\\nattached LineColor property changes, or the Hei\", \"ght property of the Entry changes. For more\\ninformation about effects, see Effects on the Xamarin De\", \"veloper Center.\\n\\nWhen valid data is entered in the Entry control, it will apply a black line to the \", \"bottom of the control,\\nto indicate that there is no validation error. Figure 6-3 shows an example of\", \" this.\\n\\nFigure 6-3: Black line indicating no validation error\\n\\nThe Entry control also has a DataTrig\", \"ger added to its Triggers collection. The following code\\nexample shows the DataTrigger:\\n\\n<Entry Text\", \"=\\\"{Binding UserName.Value, Mode=TwoWay}\\\">\\n    ...\\n    <Entry.Triggers>\\n        <DataTrigger\\n        \", \"    TargetType=\\\"Entry\\\"\\n            Binding=\\\"{Binding UserName.IsValid}\\\"\\n            Value=\\\"False\\\">\\n \", \"           <Setter Property=\\\"behaviors:LineColorBehavior.LineColor\\\"\\n                    Value=\\\"{Stat\", \"icResource ErrorColor}\\\" />\\n        </DataTrigger>\\n    </Entry.Triggers>\\n</Entry>\\n\\nThis DataTrigger m\", \"onitors the UserName.IsValid property, and if it's value becomes false, it\\nexecutes the Setter, whic\", \"h changes the LineColor attached property of the LineColorBehavior\\nattached behavior to red. Figure \", \"6-4 shows an example of this.\\n\\nFigure 6-4: Red line indicating validation error\\n\\nThe line in the Ent\", \"ry control will remain red while the entered data is invalid, otherwise it will change\\nto black to i\", \"ndicate that the entered data is valid.\\n\\nFor more information about Triggers, see Triggers on the Xa\", \"marin Developer Center.\\n\\nDisplaying error messages\\n\\nThe UI displays validation error messages in Lab\", \"el controls below each control whose data failed\\nvalidation. The following code example shows the La\", \"bel that displays a validation error message if\\nthe user has not entered a valid username:\\n\\n44\\n\\nC HA\", \" PTER  6  |  Validation\\n\\n\\f<Label Text=\\\"{Binding UserName.Errors, Converter={StaticResource FirstVali\", \"dationErrorConverter}\\\"\\n       Style=\\\"{StaticResource ValidationErrorLabelStyle}\\\" />\\n\\nEach Label bind\", \"s to the Errors property of the view model object that's being validated. The Errors\\nproperty is pro\", \"vided by the ValidatableObject<T> class, and is of type List<string>. Because the\\nErrors property ca\", \"n contain multiple validation errors, the FirstValidationErrorConverter\\ninstance is used to retrieve\", \" the first error from the collection for display.\\n\\nSummary\\n\\nThe eShopOnContainers mobile app perform\", \"s synchronous client-side validation of view model\\nproperties and notifies the user of any validatio\", \"n errors by highlighting the control that contains the\\ninvalid data, and by displaying error message\", \"s that inform the user why the data is invalid.\\n\\nView model properties that require validation are o\", \"f type ValidatableObject<T>, and each\\nValidatableObject<T> instance has validation rules added to it\", \"s Validations property. Validation\\nis invoked from the view model by calling the Validate method of \", \"the ValidatableObject<T>\\ninstance, which retrieves the validation rules and executes them against th\", \"e ValidatableObject<T>\\nValue property. Any validation errors are placed into the Errors property of \", \"the\\nValidatableObject<T> instance, and the IsValid property of the ValidatableObject<T> instance\\nis \", \"updated to indicate whether validation succeeded or failed.\\n\\n45\\n\\nC HA PTER  6  |  Validation\\n\\n\\fC H A\", \" P T E R\\n\\n7\\n\\nConfiguration\\nmanagement\\n\\nSettings allow the separation of data that configures the beh\", \"avior of an app from the code, allowing\\nthe behavior to be changed without rebuilding the app. There\", \" are two types of settings: app settings,\\nand user settings.\\n\\nApp settings are data that an app crea\", \"tes and manages. It can include data such as fixed web service\\nendpoints, API keys, and runtime stat\", \"e. App settings are tied to the existence of the app and are only\\nmeaningful to that app.\\n\\nUser sett\", \"ings are the customizable settings of an app that affect the behavior of the app and don't\\nrequire f\", \"requent re-adjustment. For example, an app might let the user specify where to retrieve data\\nfrom, a\", \"nd how to display it on the screen.\\n\\nXamarin.Forms includes a persistent dictionary that can be used\", \" to store settings data. This dictionary\\ncan be accessed using the Application.Current.Properties pr\", \"operty, and any data that's placed\\ninto it is saved when the app goes into a sleep state, and is res\", \"tored when the app resumes or starts\\nup again. In addition, the Application class also has a SavePro\", \"pertiesAsync method that allows an\\napp to have its settings saved when required. For more informatio\", \"n about this dictionary, see\\nProperties Dictionary on the Xamarin Developer Center.\\n\\nA downside to s\", \"toring data using the Xamarin.Forms persistent dictionary is that it's not easily data\\nbound to. The\", \"refore, the eShopOnContainers mobile app uses the Xam.Plugins.Settings library,\\navailable from NuGet\", \". This library provides a consistent, type-safe, cross-platform approach for\\npersisting and retrievi\", \"ng app and user settings, while using the native settings management provided\\nby each platform. In a\", \"ddition, it's straightforward to use data binding to access settings data exposed\\nby the library.\\n\\nN\", \"ote: While the Xam.Plugin.Settings library can store both app and user settings, it makes no\\ndistinc\", \"tion between the two.\\n\\nCreating a settings class\\n\\nWhen using the Xam.Plugins.Settings library, a sin\", \"gle static class should be created that will contain\\nthe app and user settings required by the app. \", \"The following code example shows the Settings class\\nin the eShopOnContainers mobile app:\\n\\n46\\n\\nC HA P\", \"TER  7  |  Configuration management\\n\\n\\fpublic static class Settings\\n{\\n    private static ISettings Ap\", \"pSettings\\n    {\\n        get\\n        {\\n            return CrossSettings.Current;\\n        }\\n    }\\n    \", \"...\\n}\\n\\nSettings can be read and written through the ISettings API, which is provided by the\\nXam.Plug\", \"ins.Settings library. This library provides a singleton that can be used to access the API,\\nCrossSet\", \"tings.Current, and an app's settings class should expose this singleton via an ISettings\\nproperty.\\n\\n\", \"Note: Using directives for the Plugin.Settings and Plugin.Settings.Abstractions\\nnamespaces should be\", \" added to a class that requires access to the Xam.Plugins.Settings library\\ntypes.\\n\\nAdding a setting\\n\", \"\\nEach setting consists of a key, a default value, and a property. The following code example shows a\", \"ll\\nthree items for a user setting that represents the base URL for the online services that the\\neSho\", \"pOnContainers mobile app connects to:\\n\\npublic static class Settings\\n{\\n    ...\\n    private const stri\", \"ng IdUrlBase = \\\"url_base\\\";\\n    private static readonly string UrlBaseDefault = GlobalSetting.Instanc\", \"e.BaseEndpoint;\\n    ...\\n\\n    public static string UrlBase\\n    {\\n        get\\n        {\\n            re\", \"turn AppSettings.GetValueOrDefault<string>(IdUrlBase, UrlBaseDefault);\\n        }\\n        set\\n       \", \" {\\n            AppSettings.AddOrUpdateValue<string>(IdUrlBase, value);\\n        }\\n    }\\n}\\n\\nThe key is\", \" always a const string that defines the key name, with the default value for the setting\\nbeing a sta\", \"tic readonly value of the required type. Providing a default value ensures that a valid\\nvalue is ava\", \"ilable if an unset setting is retrieved.\\n\\nThe UrlBase static property uses two methods from the ISet\", \"tings API to read or write the setting\\nvalue. The ISettings.GetValueOrDefault method is used to retr\", \"ieve a setting's value from\\nplatform-specific storage. If no value is defined for the setting, its d\", \"efault value is retrieved instead.\\nSimilarly, the ISettings.AddOrUpdateValue method is used to persi\", \"st a setting's value to platform-\\nspecific storage.\\n\\n47\\n\\nC HA PTER  7  |  Configuration management\\n\\n\", \"\\fRather that define a default value inside the Settings class, the UrlBaseDefault string obtains its\", \"\\nvalue from the GlobalSetting class. The following code example shows the BaseEndpoint property\\nand \", \"UpdateEndpoint method in this class:\\n\\npublic class GlobalSetting\\n{\\n    ...\\n    public string BaseEnd\", \"point\\n    {\\n        get { return _baseEndpoint; }\\n        set\\n        {\\n            _baseEndpoint = \", \"value;\\n            UpdateEndpoint(_baseEndpoint);\\n        }\\n    }\\n    ...\\n\\n    private void UpdateEn\", \"dpoint(string baseEndpoint)\\n    {\\n        RegisterWebsite = string.Format(\\\"{0}:5105/Account/Register\", \"\\\", baseEndpoint);\\n        CatalogEndpoint = string.Format(\\\"{0}:5101\\\", baseEndpoint);\\n        OrdersE\", \"ndpoint = string.Format(\\\"{0}:5102\\\", baseEndpoint);\\n        BasketEndpoint = string.Format(\\\"{0}:5103\\\"\", \", baseEndpoint);\\n        IdentityEndpoint = string.Format(\\\"{0}:5105/connect/authorize\\\", baseEndpoint\", \");\\n        UserInfoEndpoint = string.Format(\\\"{0}:5105/connect/userinfo\\\", baseEndpoint);\\n        Toke\", \"nEndpoint = string.Format(\\\"{0}:5105/connect/token\\\", baseEndpoint);\\n        LogoutEndpoint = string.F\", \"ormat(\\\"{0}:5105/connect/endsession\\\", baseEndpoint);\\n        IdentityCallback = string.Format(\\\"{0}:51\", \"05/xamarincallback\\\", baseEndpoint);\\n        LogoutCallback = string.Format(\\\"{0}:5105/Account/Redirec\", \"ting\\\", baseEndpoint);\\n    }\\n}\\n\\nEach time the BaseEndpoint property is set, the UpdateEndpoint method\", \" is called. This method\\nupdates a series of properties, all of which are based on the UrlBase user s\", \"etting that's provided by\\nthe Settings class that represent different endpoints that the eShopOnCont\", \"ainers mobile app\\nconnects to.\\n\\nData binding to user settings\\n\\nIn the eShopOnContainers mobile app, \", \"the SettingsView exposes two user settings. These settings\\nallow configuration of whether the app sh\", \"ould retrieve data from microservices that are deployed as\\nDocker containers, or whether the app sho\", \"uld retrieve data from mock services that don't require an\\ninternet connection. When choosing to ret\", \"rieve data from containerized microservices, a base\\nendpoint URL for the microservices must be speci\", \"fied. Figure 7-1 shows the SettingsView when the\\nuser has chosen to retrieve data from containerized\", \" microservices.\\n\\n48\\n\\nC HA PTER  7  |  Configuration management\\n\\n\\fFigure 7-1: User settings exposed b\", \"y the eShopOnContainers mobile app\\n\\nData binding can be used to retrieve and set settings exposed by\", \" the Settings class. This is achieved\\nby controls on the view binding to view model properties that \", \"in turn access properties in the\\nSettings class, and raising a property changed notification if the \", \"settings value has changed. For\\ninformation about how the eShopOnContainers mobile app constructs vi\", \"ew models and associates\\nthem to views, see Automatically creating a view model with a view model lo\", \"cator.\\n\\nThe following code example shows the Entry control from the SettingsView that allows the use\", \"r to\\nenter a base endpoint URL for the containerized microservices:\\n\\n<Entry Text=\\\"{Binding Endpoint,\", \" Mode=TwoWay}\\\" />\\n\\nThis Entry control binds to the Endpoint property of the SettingsViewModel class,\", \" using a two-way\\nbinding. The following code example shows the Endpoint property:\\n\\npublic string End\", \"point\\n{\\n    get { return _endpoint; }\\n    set\\n    {\\n        _endpoint = value;\\n\\n        if(!string.I\", \"sNullOrEmpty(_endpoint))\\n        {\\n            UpdateEndpoint(_endpoint);\\n        }\\n\\n        RaisePr\", \"opertyChanged(() => Endpoint);\\n    }\\n}\\n\\nWhen the Endpoint property is set the UpdateEndpoint method \", \"is called, provided that the supplied\\nvalue is valid, and property changed notification is raised. T\", \"he following code example shows the\\nUpdateEndpoint method:\\n\\nprivate void UpdateEndpoint(string endpo\", \"int)\\n{\\n    Settings.UrlBase = endpoint;\\n}\\n\\n49\\n\\nC HA PTER  7  |  Configuration management\\n\\n\\fThis meth\", \"od updates the UrlBase property in the Settings class with the base endpoint URL value\\nentered by th\", \"e user, which causes it to be persisted to platform-specific storage.\\n\\nWhen the SettingsView is navi\", \"gated to, the InitializeAsync method in the SettingsViewModel\\nclass is executed. The following code \", \"example shows this method:\\n\\npublic override Task InitializeAsync(object navigationData)\\n{\\n    ...\\n  \", \"  Endpoint = Settings.UrlBase;\\n    ...\\n}\\n\\nThe method sets the Endpoint property to the value of the \", \"UrlBase property in the Settings class.\\nAccessing the UrlBase property causes the Xam.Plugins.Settin\", \"gs library to retrieve the settings value\\nfrom platform-specific storage. For information about how \", \"the InitializeAsync method is invoked,\\nsee Passing parameters during navigation.\\n\\nThis mechanism ens\", \"ures that whenever a user navigates to the SettingsView, user settings are\\nretrieved from platform-s\", \"pecific storage and presented through data binding. Then, if the user\\nchanges the settings values, d\", \"ata binding ensures that they are immediately persisted back to\\nplatform-specific storage.\\n\\nSummary\\n\", \"\\nSettings allow the separation of data that configures the behavior of an app from the code, allowin\", \"g\\nthe behavior to be changed without rebuilding the app. App settings are data that an app creates a\", \"nd\\nmanages, and user settings are the customizable settings of an app that affect the behavior of th\", \"e app\\nand don't require frequent re-adjustment.\\n\\nThe Xam.Plugins.Settings library provides a consist\", \"ent, type-safe, cross-platform approach for\\npersisting and retrieving app and user settings, and dat\", \"a binding can be used to access settings\\ncreated with the library.\\n\\n50\\n\\nC HA PTER  7  |  Configurati\", \"on management\\n\\n\\fC H A P T E R\\n\\n8\\n\\nContainerized\\nmicroservices\\n\\nDeveloping client-server applications\", \" has resulted in a focus on building tiered applications that use\\nspecific technologies in each tier\", \". Such applications are often referred to as monolithic applications,\\nand are packaged onto hardware\", \" pre-scaled for peak loads. The main drawbacks of this development\\napproach are the tight coupling b\", \"etween components within each tier, that individual components\\ncan't be easily scaled, and the cost \", \"of testing. A simple update can have unforeseen effects on the rest\\nof the tier, and so a change to \", \"an application component requires its entire tier to be retested and\\nredeployed.\\n\\nParticularly conce\", \"rning in the age of the cloud, is that individual components can't be easily scaled. A\\nmonolithic ap\", \"plication contains domain-specific functionality, and is typically divided by functional\\nlayers such\", \" as front end, business logic, and data storage. A monolithic application is scaled by\\ncloning the e\", \"ntire application onto multiple machines, as illustrated in Figure 8-1.\\n\\nFigure 8-1: Monolithic appl\", \"ication scaling approach\\n\\n51\\n\\nC HA PTER  8  |  Containerized microservices\\n\\n\\fMicroservices\\n\\nMicroser\", \"vices offer a different approach to application development and deployment, an approach\\nthat's suite\", \"d to the agility, scale, and reliability requirements of modern cloud applications. A\\nmicroservices \", \"application is decomposed into independent components that work together to deliver\\nthe application'\", \"s overall functionality. The term microservice emphasizes that applications should be\\ncomposed of se\", \"rvices small enough to reflect independent concerns, so that each microservice\\nimplements a single f\", \"unction. In addition, each microservice has well-defined contracts so that other\\nmicroservices can c\", \"ommunicate and share data with it. Typical examples of microservices include\\nshopping carts, invento\", \"ry processing, purchase subsystems, and payment processing.\\n\\nMicroservices can scale-out independent\", \"ly, as compared to giant monolithic applications that scale\\ntogether. This means that a specific fun\", \"ctional area, that requires more processing power or network\\nbandwidth to support demand, can be sca\", \"led rather than unnecessarily scaling-out other areas of the\\napplication. Figure 8-2 illustrates thi\", \"s approach, where microservices are deployed and scaled\\nindependently, creating instances of service\", \"s across machines.\\n\\nFigure 8-2: Microservices application scaling approach\\n\\nMicroservice scale-out c\", \"an be nearly instantaneous, allowing an application to adapt to changing\\nloads. For example, a singl\", \"e microservice in the web-facing functionality of an application might be\\nthe only microservice in t\", \"he application that needs to scale out to handle additional incoming traffic.\\n\\nThe classic model for\", \" application scalability is to have a load-balanced, stateless tier with a shared\\nexternal datastore\", \" to store persistent data. Stateful microservices manage their own persistent data,\\nusually storing \", \"it locally on the servers on which they are placed, to avoid the overhead of network\\naccess and comp\", \"lexity of cross-service operations. This enables the fastest possible processing of data\\nand can eli\", \"minate the need for caching systems. In addition, scalable stateful microservices usually\\npartition \", \"data among their instances, in order to manage data size and transfer throughput beyond\\nwhich a sing\", \"le server can support.\\n\\nMicroservices also support independent updates. This loose coupling between \", \"microservices provides\\na rapid and reliable application evolution. Their independent, distributed na\", \"ture supports rolling\\nupdates, where only a subset of instances of a single microservice will update\", \" at any given time.\\nTherefore, if a problem is detected, a buggy update can be rolled back, before a\", \"ll instances update\\nwith the faulty code or configuration. Similarly, microservices typically use sc\", \"hema versioning, so that\\n\\n52\\n\\nC HA PTER  8  |  Containerized microservices\\n\\n\\fclients see a consisten\", \"t version when updates are being applied, regardless of which microservice\\ninstance is being communi\", \"cated with.\\n\\nTherefore, microservice applications have many benefits over monolithic applications:\\n\\n\", \"\\u2022  Each microservice is relatively small, easy to manage and evolve.\\n\\n\\u2022  Each microservice can be de\", \"veloped and deployed independently of other services.\\n\\n\\u2022  Each microservice can be scaled-out indepe\", \"ndently. For example, a catalog service or\\nshopping basket service might need to be scaled-out more \", \"than an ordering service.\\nTherefore, the resulting infrastructure will more efficiently consume reso\", \"urces when scaling\\nout.\\n\\n\\u2022  Each microservice isolates any issues. For example, if there is an issue\", \" in a service it only\\n\\nimpacts that service. The other services can continue to handle requests.\\n\\n\\u2022 \", \" Each microservice can use the latest technologies. Because microservices are autonomous and\\nrun sid\", \"e-by-side, the latest technologies and frameworks can be used, rather than being\\nforced to use an ol\", \"der framework that might be used by a monolithic application.\\n\\nHowever, a microservice based solutio\", \"n also has potential drawbacks:\\n\\n\\u2022  Choosing how to partition an application into microservices can \", \"be challenging, as each\\n\\nmicroservice has to be completely autonomous, end-to-end, including respons\", \"ibility for its\\ndata sources.\\n\\n\\u2022  Developers must implement inter-service communication, which adds \", \"complexity and latency\\n\\nto the application.\\n\\n\\u2022  Atomic transactions between multiple microservices u\", \"sually aren't possible. Therefore,\\nbusiness requirements must embrace eventual consistency between m\", \"icroservices.\\n\\n\\u2022\\n\\nIn production, there is an operational complexity in deploying and managing a syst\", \"em\\ncompromised of many independent services.\\n\\n\\u2022  Direct client-to-microservice communication can mak\", \"e it difficult to refactor the contracts of\\nmicroservices. For example, over time how the system is \", \"partitioned into services might need\\nto change. A single service might split into two or more servic\", \"es, and two services might\\nmerge. When clients communicate directly with microservices, this refacto\", \"ring work can break\\ncompatibility with client apps.\\n\\nContainerization\\n\\nContainerization is an approa\", \"ch to software development in which an application and its versioned set\\nof dependencies, plus its e\", \"nvironment configuration abstracted as deployment manifest files, are\\npackaged together as a contain\", \"er image, tested as a unit, and deployed to a host operating system.\\n\\nA container is an isolated, re\", \"source controlled, and portable operating environment, where an\\napplication can run without touching\", \" the resources of other containers, or the host. Therefore, a\\ncontainer looks and acts like a newly \", \"installed physical computer or a virtual machine.\\n\\nThere are many similarities between containers an\", \"d virtual machines, as illustrated in Figure 8-3.\\n\\n53\\n\\nC HA PTER  8  |  Containerized microservices\\n\", \"\\n\\fFigure 8-3: Comparison of virtual machines and containers\\n\\nA container runs an operating system, h\", \"as a file system, and can be accessed over a network as if it\\nwere a physical or virtual machine. Ho\", \"wever, the technology and concepts used by containers are very\\ndifferent from virtual machines. Virt\", \"ual machines include the applications, the required dependencies,\\nand a full guest operating system.\", \" Containers include the application and its dependencies, but share\\nthe operating system with other \", \"containers, running as isolated processes on the host operating\\nsystem (aside from Hyper-V container\", \"s which run inside of a special virtual machine per container).\\nTherefore, containers share resource\", \"s and typically require fewer resources than virtual machines.\\n\\nThe advantage of a container-oriente\", \"d development and deployment approach is that it eliminates\\nmost of the issues that arise from incon\", \"sistent environment setups and the problems that come with\\nthem. In addition, containers permit fast\", \" application scale-up functionality by instancing new\\ncontainers as required.\\n\\nThe key concepts when\", \" creating and working with containers are:\\n\\n\\u2022  Container Host: The physical or virtual machine confi\", \"gured to host containers. The container\\n\\nhost will run one or more containers.\\n\\n\\u2022  Container Image: \", \"An image consists of a union of layered filesystems stacked on top of each\\nother, and is the basis o\", \"f a container. An image does not have state and it never changes as\\nit's deployed to different envir\", \"onments.\\n\\n\\u2022  Container: A container is a runtime instance of an image.\\n\\n\\u2022  Container OS Image: Conta\", \"iners are deployed from images. The container operating system\\n\\nimage is the first layer in potentia\", \"lly many image layers that make up a container. A container\\noperating system is immutable, and can't\", \" be modified.\\n\\n\\u2022  Container Repository: Each time a container image is created, the image and its de\", \"pendencies\\nare stored in a local repository. These images can be reused many times on the container\\n\", \"host. The container images can also be stored in a public or private registry, such as Docker\\nHub, s\", \"o that they can be used across different container hosts.\\n\\n54\\n\\nC HA PTER  8  |  Containerized micros\", \"ervices\\n\\n\\fEnterprises are increasingly adopting containers when implementing microservice based appl\", \"ications,\\nand Docker has become the standard container implementation that has been adopted by most\\n\", \"software platforms and cloud vendors.\\n\\nThe eShopOnContainers reference application uses Docker to ho\", \"st four containerized back-end\\nmicroservices, as illustrated in Figure 8-4.\\n\\nFigure 8-4: eShopOnCont\", \"ainers reference application back-end microservices\\n\\nThe architecture of the back-end services in th\", \"e reference application is decomposed into multiple\\nautonomous sub-systems in the form of collaborat\", \"ing microservices and containers. Each microservice\\nprovides a single area of functionality: an iden\", \"tity service, a catalog service, an ordering service, and a\\nbasket service.\\n\\nEach microservice has i\", \"ts own database, allowing it to be fully decoupled from the other\\nmicroservices. Where necessary, co\", \"nsistency between databases from different microservices is\\nachieved using application-level events.\", \" For more information, see Communication between\\nmicroservices.\\n\\nFor more information about the refe\", \"rence application, see .NET Microservices: Architecture for\\nContainerized .NET Applications.\\n\\nCommun\", \"ication between client and microservices\\n\\nThe eShopOnContainers mobile app communicates with the con\", \"tainerized back-end microservices\\nusing direct client-to-microservice communication, which is shown \", \"in Figure 8-5.\\n\\n55\\n\\nC HA PTER  8  |  Containerized microservices\\n\\n\\fFigure 8-5: Direct client-to-micr\", \"oservice communication\\n\\nWith direct client-to-microservice communication, the mobile app makes reque\", \"sts to each\\nmicroservice directly through its public endpoint, with a different TCP port per microse\", \"rvice. In\\nproduction, the endpoint would typically map to the microservice's load balancer, which di\", \"stributes\\nrequests across the available instances.\\n\\nTip: Consider using API gateway communication\\n\\nD\", \"irect client-to-microservice communication can have drawbacks when building a large and\\ncomplex micr\", \"oservice based application, but it's more than adequate for a small application. When\\ndesigning a la\", \"rge microservice based application with tens of microservices, consider using API\\ngateway communicat\", \"ion. For more information, see .NET Microservices: Architecture for\\nContainerized .NET Applications.\", \"\\n\\nCommunication between microservices\\n\\nA microservices based application is a distributed system, po\", \"tentially running on multiple machines.\\nEach service instance is typically a process. Therefore, ser\", \"vices must interact using an inter-process\\ncommunication protocol, such as HTTP, TCP, Advanced Messa\", \"ge Queuing Protocol (AMQP), or binary\\nprotocols, depending on the nature of each service.\\n\\nThe two c\", \"ommon approaches for microservice-to-microservice communication are HTTP based REST\\ncommunication wh\", \"en querying for data, and lightweight asynchronous messaging when\\ncommunicating updates across multi\", \"ple microservices.\\n\\nAsynchronous messaging based event-driven communication is critical when propaga\", \"ting changes\\nacross multiple microservices. With this approach, a microservice publishes an event wh\", \"en something\\nnotable happens, for example, when it updates a business entity. Other microservices su\", \"bscribe to\\nthese events. Then, when a microservice receives an event, it updates its own business en\", \"tities, which\\nmight in turn lead to more events being published. This publish-subscribe functionalit\", \"y is usually\\nachieved with an event bus.\\n\\nAn event bus allows publish-subscribe communication betwee\", \"n microservices, without requiring the\\ncomponents to be explicitly aware of each other, as shown in \", \"Figure 8-6.\\n\\n56\\n\\nC HA PTER  8  |  Containerized microservices\\n\\n\\fFigure 8-6: Publish-subscribe with a\", \"n event bus\\n\\nFrom an application perspective, the event bus is simply a publish-subscribe channel ex\", \"posed via an\\ninterface. However, the way the event bus is implemented can vary. For example, an even\", \"t bus\\nimplementation could use RabbitMQ, Azure Service Bus, or other service buses such as NServiceB\", \"us\\nand MassTransit. Figure 8-7 shows how an event bus is used in the eShopOnContainers reference\\napp\", \"lication.\\n\\nFigure 8-7: Asynchronous event-driven communication in the reference application\\n\\nThe eSh\", \"opOnContainers event bus, implemented using RabbitMQ, provides one-to-many\\nasynchronous publish-subs\", \"cribe functionality. This means that after publishing an event, there can be\\nmultiple subscribers li\", \"stening for the same event. Figure 8-9 illustrates this relationship.\\n\\n57\\n\\nC HA PTER  8  |  Containe\", \"rized microservices\\n\\n\\fFigure 8-9: One-to-many communication\\n\\nThis one-to-many communication approach\", \" uses events to implement business transactions that span\\nmultiple services, ensuring eventual consi\", \"stency between the services. An eventual-consistent\\ntransaction consists of a series of distributed \", \"steps. Therefore, when the user-profile microservice\\nreceives the UpdateUser command, it updates the\", \" user's details in its database and publishes the\\nUserUpdated event to the event bus. Both the baske\", \"t microservice and the ordering microservice\\nhave subscribed to receive this event, and in response \", \"update their buyer information in their\\nrespective databases.\\n\\nNote: The eShopOnContainers event bus\", \", implemented using RabbitMQ, is intended to be used\\nonly as a proof of concept. For production syst\", \"ems, alternative event bus implementations should\\nbe considered.\\n\\nFor information about the event bu\", \"s implementation, see .NET Microservices: Architecture for\\nContainerized .NET Applications.\\n\\nSummary\", \"\\n\\nMicroservices offer an approach to application development and deployment that's suited to the\\nagi\", \"lity, scale, and reliability requirements of modern cloud applications. One of the main advantages\\no\", \"f microservices is that they can be scaled-out independently, which means that a specific functional\", \"\\narea can be scaled that requires more processing power or network bandwidth to support demand,\\nwith\", \"out unnecessarily scaling areas of the application that are not experiencing increased demand.\\n\\nA co\", \"ntainer is an isolated, resource controlled, and portable operating environment, where an\\napplicatio\", \"n can run without touching the resources of other containers, or the host. Enterprises are\\nincreasin\", \"gly adopting containers when implementing microservice based applications, and Docker has\\nbecome the\", \" standard container implementation that has been adopted by most software platforms\\nand cloud vendor\", \"s.\\n\\n58\\n\\nC HA PTER  8  |  Containerized microservices\\n\\n\\fC H A P T E R\\n\\n9\\n\\nAuthentication\\nand authoriz\", \"ation\\n\\nAuthentication is the process of obtaining identification credentials such as name and passwo\", \"rd from\\na user, and validating those credentials against an authority. If the credentials are valid,\", \" the entity that\\nsubmitted the credentials is considered an authenticated identity. Once an identity\", \" has been\\nauthenticated, an authorization process determines whether that identity has access to a g\", \"iven\\nresource.\\n\\nThere are many approaches to integrating authentication and authorization into a Xam\", \"arin.Forms app\\nthat communicates with an ASP.NET MVC web application, including using ASP.NET Core I\", \"dentity,\\nexternal authentication providers such as Microsoft, Google, Facebook, or Twitter, and auth\", \"entication\\nmiddleware. The eShopOnContainers mobile app performs authentication and authorization wi\", \"th a\\ncontainerized identity microservice that uses IdentityServer 4. The mobile app requests securit\", \"y tokens\\nfrom IdentityServer, either for authenticating a user or for accessing a resource. For Iden\", \"tityServer to\\nissue tokens on behalf of a user, the user must sign-in to IdentityServer. However, Id\", \"entityServer\\ndoesn't provide a user interface or database for authentication. Therefore, in the eSho\", \"pOnContainers\\nreference application, ASP.NET Core Identity is used for this purpose.\\n\\nAuthentication\", \"\\n\\nAuthentication is required when an application needs to know the identity of the current user.\\nASP\", \".NET Core's primary mechanism for identifying users is the ASP.NET Core Identity membership\\nsystem, \", \"which stores user information in a data store configured by the developer. Typically, this data\\nstor\", \"e will be an EntityFramework store, though custom stores or third party packages can be used to\\nstor\", \"e identity information in Azure storage, DocumentDB, or other locations.\\n\\nFor authentication scenari\", \"os that make use of a local user data store, and that persist identity\\ninformation between requests \", \"via cookies (as is typical in ASP.NET MVC web applications), ASP.NET\\nCore Identity is a suitable sol\", \"ution. However, cookies are not always a natural means of persisting and\\ntransmitting data. For exam\", \"ple, an ASP.NET Core web application that exposes RESTful endpoints that\\nare accessed from a mobile \", \"app will typically need to use bearer token authentication, since cookies\\ncan't be used in this scen\", \"ario. However, bearer tokens can easily be retrieved and included in the\\nauthorization header of web\", \" requests made from the mobile app.\\n\\n59\\n\\nC HA PTER  9  |  Authentication and authorization\\n\\n\\fIssuing\", \" bearer tokens using IdentityServer 4\\n\\nIdentityServer 4 is an open source OpenID Connect and OAuth 2\", \".0 framework for ASP.NET Core,\\nwhich can be used for many authentication and authorization scenarios\", \" including issuing security\\ntokens for local ASP.NET Core Identity users.\\n\\nNote: OpenID Connect and \", \"OAuth 2.0 are very similar, while having different responsibilities.\\n\\nOpenID Connect is an authentic\", \"ation layer on top of the OAuth 2.0 protocol. OAuth 2 is a protocol\\nthat allows applications to requ\", \"est access tokens from a security token service and use them to\\ncommunicate with APIs. This delegati\", \"on reduces complexity in both client applications and APIs\\nsince authentication and authorization ca\", \"n be centralized.\\n\\nThe combination of OpenID Connect and OAuth 2.0 combine the two fundamental secur\", \"ity\\nconcerns of authentication and API access, and IdentityServer 4 is an implementation of these\\npr\", \"otocols.\\n\\nIn applications that use direct client-to-microservice communication, such as the eShopOnC\", \"ontainers\\nreference application, a dedicated authentication microservice acting as a Security Token \", \"Service (STS)\\ncan be used to authenticate users, as shown in Figure 9-1. For more information about \", \"direct client-\\nto-microservice communication, see Communication between client and microservices.\\n\\nF\", \"igure 9-1: Authentication by a dedicated authentication microservice\\n\\nThe eShopOnContainers mobile a\", \"pp communicates with the identity microservice, which uses\\nIdentityServer 4 to perform authenticatio\", \"n, and access control for APIs. Therefore, the mobile app\\nrequests tokens from IdentityServer, eithe\", \"r for authenticating a user or for accessing a resource:\\n\\n\\u2022  Authenticating users with IdentityServe\", \"r is achieved by the mobile app requesting an identity\\ntoken, which represents the outcome of an aut\", \"hentication process. At a bare minimum, it\\ncontains an identifier for the user, and information abou\", \"t how and when the user\\nauthenticated. It can also contain additional identity data.\\n\\n\\u2022  Accessing a\", \" resource with IdentityServer is achieved by the mobile app requesting an access\\ntoken, which allows\", \" access to an API resource. Clients request access tokens and forward\\nthem to the API. Access tokens\", \" contain information about the client, and the user (if present).\\nAPIs then use that information to \", \"authorize access to their data.\\n\\nNote: A client must be registered with IdentityServer before it can\", \" request tokens.\\n\\nAdding IdentityServer to a web application\\n\\nIn order for an ASP.NET Core web appli\", \"cation to use IdentityServer 4, it must be added to the web\\napplication's Visual Studio solution. Fo\", \"r more information, see Setup and Overview in the\\nIdentityServer documentation.\\n\\n60\\n\\nC HA PTER  9  |\", \"  Authentication and authorization\\n\\n\\fOnce IdentityServer is included in the web application's Visual\", \" Studio solution, it must be added to\\nthe web application's HTTP request processing pipeline, so tha\", \"t it can serve requests to OpenID\\nConnect and OAuth 2.0 endpoints. This is achieved in the Configure\", \" method in the web application's\\nStartup class, as demonstrated in the following code example:\\n\\npubl\", \"ic void Configure(\\n    IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactor\", \"y)\\n{\\n    ...\\n    app.UseIdentity();\\n    ...\\n}\\n\\nOrder matters in the web application's HTTP request p\", \"rocessing pipeline. Therefore, IdentityServer\\nmust be added to the pipeline before the UI framework \", \"that implements the login screen.\\n\\nConfiguring IdentityServer\\n\\nIdentityServer should be configured i\", \"n the ConfigureServices method in the web application's\\nStartup class by calling the services.AddIde\", \"ntityServer method, as demonstrated in the\\nfollowing code example from the eShopOnContainers referen\", \"ce application:\\n\\npublic void ConfigureServices(IServiceCollection services)\\n{\\n    ...\\n    services.A\", \"ddIdentityServer(x => x.IssuerUri = \\\"null\\\")\\n        .AddSigningCredential(Certificate.Get())\\n       \", \" .AddAspNetIdentity<ApplicationUser>()\\n        .AddConfigurationStore(builder =>\\n            builder\", \".UseSqlServer(connectionString, options =>\\n                options.MigrationsAssembly(migrationsAsse\", \"mbly)))\\n        .AddOperationalStore(builder =>\\n            builder.UseSqlServer(connectionString, o\", \"ptions =>\\n                options.MigrationsAssembly(migrationsAssembly)))\\n        .Services.AddTran\", \"sient<IProfileService, ProfileService>();\\n}\\n\\nAfter calling the services.AddIdentityServer method, ad\", \"ditional fluent APIs are called to\\nconfigure the following:\\n\\n\\u2022  Credentials used for signing.\\n\\n\\u2022  AP\", \"I and identity resources that users might request access to.\\n\\n\\u2022  Clients that will be connecting to \", \"request tokens.\\n\\n\\u2022  ASP.NET Core Identity.\\n\\nTip: Dynamically load the IdentityServer 4 configuration\", \"\\n\\nIdentityServer 4's APIs allow for configuring IdentityServer from an in-memory list of configurati\", \"on\\nobjects. In the eShopOnContainers reference application, these in-memory collections are hard-\\nco\", \"ded into the application. However, in production scenarios they can be loaded dynamically from\\na con\", \"figuration file or from a database.\\n\\nFor information about configuring IdentityServer to use ASP.NET\", \" Core Identity, see Using ASP.NET\\nCore Identity in the IdentityServer documentation.\\n\\n61\\n\\nC HA PTER \", \" 9  |  Authentication and authorization\\n\\n\\fConfiguring API resources\\n\\nWhen configuring API resources,\", \" the AddInMemoryApiResources method expects an\\nIEnumerable<ApiResource> collection. The following co\", \"de example shows the GetApis method that\\nprovides this collection in the eShopOnContainers reference\", \" application:\\n\\npublic static IEnumerable<ApiResource> GetApis()\\n{\\n    return new List<ApiResource>\\n \", \"   {\\n        new ApiResource(\\\"orders\\\", \\\"Orders Service\\\"),\\n        new ApiResource(\\\"basket\\\", \\\"Basket \", \"Service\\\")\\n    };\\n}\\n\\nThis method specifies that IdentityServer should protect the orders and basket A\", \"PIs. Therefore,\\nIdentityServer managed access tokens will be required when making calls to these API\", \"s. For more\\ninformation about the ApiResource type, see API Resource in the IdentityServer 4 documen\", \"tation.\\n\\nConfiguring identity resources\\n\\nWhen configuring identity resources, the AddInMemoryIdentit\", \"yResources method expects an\\nIEnumerable<IdentityResource> collection. Identity resources are data s\", \"uch as user ID, name, or\\nemail address. Each identity resource has a unique name, and arbitrary clai\", \"m types can be assigned to\\nit, which will then be included in the identity token for the user. The f\", \"ollowing code example shows\\nthe GetResources method that provides this collection in the eShopOnCont\", \"ainers reference\\napplication:\\n\\npublic static IEnumerable<IdentityResource> GetResources()\\n{\\n    retu\", \"rn new List<IdentityResource>\\n    {\\n        new IdentityResources.OpenId(),\\n        new IdentityReso\", \"urces.Profile()\\n    };\\n}\\n\\nThe OpenID Connect specification specifies some standard identity resource\", \"s. The minimum\\nrequirement is that support is provided for emitting a unique ID for users. This is a\", \"chieved by\\nexposing the IdentityResources.OpenId identity resource.\\n\\nNote: The IdentityResources cla\", \"ss supports all of the scopes defined in the OpenID Connect\\nspecification (openid, email, profile, t\", \"elephone, and address).\\n\\nIdentityServer also supports defining custom identity resources. For more i\", \"nformation, see Defining\\ncustom identity resources in the IdentityServer documentation. For more inf\", \"ormation about the\\nIdentityResource type, see Identity Resource in the IdentityServer 4 documentatio\", \"n.\\n\\nConfiguring clients\\n\\nClients are applications that can request tokens from IdentityServer. Typic\", \"ally, the following settings\\nmust be defined for each client as a minimum:\\n\\n\\u2022  A unique client ID.\\n\\n\", \"\\u2022  The allowed interactions with the token service (known as the grant type).\\n\\n\\u2022  The location where\", \" identity and access tokens are sent to (known as a redirect URI).\\n\\n62\\n\\nC HA PTER  9  |  Authenticat\", \"ion and authorization\\n\\n\\f\\u2022  A list of resources that the client is allowed access to (known as scopes\", \").\\n\\nWhen configuring clients, the AddInMemoryClients method expects an IEnumerable<Client>\\ncollectio\", \"n. The following code example shows the configuration for the eShopOnContainers mobile\\napp in the Ge\", \"tClients method that provides this collection in the eShopOnContainers reference\\napplication:\\n\\npubli\", \"c static IEnumerable<Client> GetClients(Dictionary<string,string> clientsUrl)\\n{\\n    return new List<\", \"Client>\\n    {\\n        ...\\n        new Client\\n        {\\n            ClientId = \\\"xamarin\\\",\\n           \", \" ClientName = \\\"eShop Xamarin OpenId Client\\\",\\n            AllowedGrantTypes = GrantTypes.Hybrid,\\n    \", \"        ClientSecrets =\\n            {\\n                new Secret(\\\"secret\\\".Sha256())\\n            },\\n \", \"           RedirectUris = { clientsUrl[\\\"Xamarin\\\"] },\\n            RequireConsent = false,\\n           \", \" RequirePkce = true,\\n            PostLogoutRedirectUris = { $\\\"{clientsUrl[\\\"Xamarin\\\"]}/Account/Redire\", \"cting\\\" },\\n            AllowedCorsOrigins = { \\\"http://eshopxamarin\\\" },\\n            AllowedScopes = ne\", \"w List<string>\\n            {\\n                IdentityServerConstants.StandardScopes.OpenId,\\n        \", \"        IdentityServerConstants.StandardScopes.Profile,\\n                IdentityServerConstants.Stan\", \"dardScopes.OfflineAccess,\\n                \\\"orders\\\",\\n                \\\"basket\\\"\\n            },\\n        \", \"    AllowOfflineAccess = true,\\n            AllowAccessTokensViaBrowser = true\\n        },\\n        ...\", \"\\n    };\\n}\\n\\nThis configuration specifies data for the following properties:\\n\\n\\u2022  ClientId: A unique ID\", \" for the client.\\n\\n\\u2022  ClientName: The client display name, which is used for logging and the consent \", \"screen.\\n\\n\\u2022  AllowedGrantTypes: Specifies how a client wants to interact with IdentityServer. For mor\", \"e\\n\\ninformation see Configuring the authentication flow.\\n\\n\\u2022  ClientSecrets: Specifies the client secr\", \"et credentials that are used when requesting tokens\\n\\nfrom the token endpoint.\\n\\n\\u2022  RedirectUris: Spec\", \"ifies the allowed URIs to which to return tokens or authorization codes.\\n\\n\\u2022  RequireConsent: Specifi\", \"es whether a consent screen is required.\\n\\n\\u2022  RequirePkce: Specifies whether clients using an authori\", \"zation code must send a proof key.\\n\\n\\u2022  PostLogoutRedirectUris: Specifies the allowed URIs to redirec\", \"t to after logout.\\n\\n63\\n\\nC HA PTER  9  |  Authentication and authorization\\n\\n\\f\\u2022  AllowedCorsOrigins: S\", \"pecifies the origin of the client so that IdentityServer can allow cross-\\n\\norigin calls from the ori\", \"gin.\\n\\n\\u2022  AllowedScopes: Specifies the resources the client has access to. By default, a client has n\", \"o\\n\\naccess to any resources.\\n\\n\\u2022  AllowOfflineAccess: Specifies whether the client can request refresh\", \" tokens.\\n\\nConfiguring the authentication flow\\n\\nThe authentication flow between a client and Identity\", \"Server can be configured by specifying the grant\\ntypes in the Client.AllowedGrantTypes property. The\", \" OpenID Connect and OAuth 2.0 specifications\\ndefine a number of authentication flows, including:\\n\\n\\u2022\\n\", \"\\nImplicit. This flow is optimized for browser-based applications and should be used either for\\nuser \", \"authentication-only, or authentication and access token requests. All tokens are\\ntransmitted via the\", \" browser, and therefore advanced features like refresh tokens are not\\npermitted.\\n\\n\\u2022  Authorization c\", \"ode. This flow provides the ability to retrieve tokens on a back channel, as\\n\\nopposed to the browser\", \" front channel, while also supporting client authentication.\\n\\n\\u2022  Hybrid. This flow is a combination \", \"of the implicit and authorization code grant types. The\\nidentity token is transmitted via the browse\", \"r channel and contains the signed protocol\\nresponse along with other artifacts such as the authoriza\", \"tion code. After successful validation\\nof the response, the back channel should be used to retrieve \", \"the access and refresh token.\\n\\nTip: Use the hybrid authentication flow\\n\\nThe hybrid authentication fl\", \"ow mitigates a number of attacks that apply to the browser channel,\\nand is the recommended flow for \", \"native applications that want to retrieve access tokens (and\\npossibly refresh tokens).\\n\\nFor more inf\", \"ormation about authentication flows, see Grant Types in the IdentityServer 4\\ndocumentation.\\n\\nPerform\", \"ing authentication\\n\\nFor IdentityServer to issue tokens on behalf of a user, the user must sign-in to\", \" IdentityServer.\\nHowever, IdentityServer doesn't provide a user interface or database for authentica\", \"tion. Therefore, in\\nthe eShopOnContainers reference application, ASP.NET Core Identity is used for t\", \"his purpose.\\n\\nThe eShopOnContainers mobile app authenticates with IdentityServer with the hybrid aut\", \"hentication\\nflow, which is illustrated in Figure 9-2.\\n\\nFigure 9-2: High-level overview of the sign-i\", \"n process\\n\\n64\\n\\nC HA PTER  9  |  Authentication and authorization\\n\\n\\fA sign-in request is made to <bas\", \"e endpoint>:5105/connect/authorize. Following successful\\nauthentication, IdentityServer returns an a\", \"uthentication response containing an authorization code\\nand an identity token. The authorization cod\", \"e is then sent to <base\\nendpoint>:5105/connect/token, which responds with access, identity, and refr\", \"esh tokens.\\n\\nThe eShopOnContainers mobile app signs-out of IdentityServer by sending a request to\\nht\", \"tp://<base endpoint>:5105/connect/endsession, with additional parameters. After sign-out\\noccurs, Ide\", \"ntityServer responds by sending a post logout redirect URI back to the mobile app. Figure\\n9-3 illust\", \"rates this process.\\n\\nFigure 9-3: High-level overview of the sign-out process\\n\\nIn the eShopOnContaine\", \"rs mobile app, communication with IdentityServer is performed by the\\nIdentityService class, which im\", \"plements the IIdentityService interface. This interface specifies\\nthat the implementing class must p\", \"rovide CreateAuthorizationRequest, CreateLogoutRequest,\\nand GetTokenAsync methods.\\n\\nSigning-in\\n\\nWhen\", \" the user taps the LOGIN button on the LoginView, the SignInCommand in the LoginViewModel\\nclass is e\", \"xecuted, which in turn executes the SignInAsync method. The following code example\\nshows this method\", \":\\n\\nprivate async Task SignInAsync()\\n{\\n    ...\\n    LoginUrl = _identityService.CreateAuthorizationReq\", \"uest();\\n    IsLogin = true;\\n    ...\\n}\\n\\nThis method invokes the CreateAuthorizationRequest method in \", \"the IdentityService class,\\nwhich is shown in the following code example:\\n\\npublic string CreateAuthor\", \"izationRequest()\\n{\\n    // Create URI to authorization endpoint\\n    var authorizeRequest = new Author\", \"izeRequest(GlobalSetting.Instance.IdentityEndpoint);\\n\\n    // Dictionary with values for the authoriz\", \"e request\\n    var dic = new Dictionary<string, string>();\\n    dic.Add(\\\"client_id\\\", GlobalSetting.Ins\", \"tance.ClientId);\\n    dic.Add(\\\"client_secret\\\", GlobalSetting.Instance.ClientSecret);\\n    dic.Add(\\\"res\", \"ponse_type\\\", \\\"code id_token\\\");\\n    dic.Add(\\\"scope\\\", \\\"openid profile basket orders locations marketin\", \"g offline_access\\\");\\n    dic.Add(\\\"redirect_uri\\\", GlobalSetting.Instance.IdentityCallback);\\n    dic.Ad\", \"d(\\\"nonce\\\", Guid.NewGuid().ToString(\\\"N\\\"));\\n    dic.Add(\\\"code_challenge\\\", CreateCodeChallenge());\\n    \", \"dic.Add(\\\"code_challenge_method\\\", \\\"S256\\\");\\n\\n65\\n\\nC HA PTER  9  |  Authentication and authorization\\n\\n\\f \", \"   // Add CSRF token to protect against cross-site request forgery attacks.\\n    var currentCSRFToken\", \" = Guid.NewGuid().ToString(\\\"N\\\");\\n    dic.Add(\\\"state\\\", currentCSRFToken);\\n\\n    var authorizeUri = aut\", \"horizeRequest.Create(dic);\\n    return authorizeUri;\\n}\\n\\nThis method creates the URI for IdentityServe\", \"r's authorization endpoint, with the required parameters.\\nThe authorization endpoint is at /connect/\", \"authorize on port 5105 of the base endpoint exposed as\\na user setting. For more information about us\", \"er settings, see Configuration management.\\n\\nNote: The attack surface of the eShopOnContainers mobile\", \" app is reduced by implementing the\\nProof Key for Code Exchange (PKCE) extension to OAuth. PKCE prot\", \"ects the authorization code\\nfrom being used if it\\u2019s intercepted. This is achieved by the client gene\", \"rating a secret verifier, a hash\\nof which is passed in the authorization request, and which is prese\", \"nted unhashed when redeeming\\nthe authorization code. For more information about PKCE, see Proof Key \", \"for Code Exchange by\\nOAuth Public Clients on the Internet Engineering Task Force web site.\\n\\nThe retu\", \"rned URI is stored in the LoginUrl property of the LoginViewModel class. When the IsLogin\\nproperty b\", \"ecomes true, the WebView in the LoginView becomes visible. The WebView data binds its\\nSource propert\", \"y to the LoginUrl property of the LoginViewModel class, and so makes a sign-in\\nrequest to IdentitySe\", \"rver when the LoginUrl property is set to IdentityServer's authorization\\nendpoint. When IdentityServ\", \"er receives this request and the user isn't authenticated, the WebView will\\nbe redirected to the con\", \"figured login page, which is shown in Figure 9-4.\\n\\nFigure 9-4: Login page displayed by the WebView\\n\\n\", \"Once login is completed, the WebView will be redirected to a return URI. This WebView navigation wil\", \"l\\ncause the NavigateAsync method in the LoginViewModel class to be executed, which is shown in\\nthe f\", \"ollowing code example:\\n\\n66\\n\\nC HA PTER  9  |  Authentication and authorization\\n\\n\\fprivate async Task N\", \"avigateAsync(string url)\\n{\\n    ...\\n    var authResponse = new AuthorizeResponse(url);\\n    if (!strin\", \"g.IsNullOrWhiteSpace(authResponse.Code))\\n    {\\n        var userToken = await _identityService.GetTok\", \"enAsync(authResponse.Code);\\n        string accessToken = userToken.AccessToken;\\n\\n        if (!string\", \".IsNullOrWhiteSpace(accessToken))\\n        {\\n            Settings.AuthAccessToken = accessToken;\\n    \", \"        Settings.AuthIdToken = authResponse.IdentityToken;\\n\\n            await NavigationService.Navi\", \"gateToAsync<MainViewModel>();\\n            await NavigationService.RemoveLastFromBackStackAsync();\\n  \", \"      }\\n    }\\n    ...\\n}\\n\\nThis method parses the authentication response that's contained in the retu\", \"rn URI, and provided that\\na valid authorization code is present, it makes a request to IdentityServe\", \"r's token endpoint, passing\\nthe authorization code, the PKCE secret verifier, and other required par\", \"ameters. The token endpoint is\\nat /connect/token on port 5105 of the base endpoint exposed as a user\", \" setting. For more\\ninformation about user settings, see Configuration management.\\n\\nTip: Validate ret\", \"urn URIs\\n\\nAlthough the eShopOnContainers mobile app doesn't validate the return URI, the best practi\", \"ce is to\\nvalidate that the return URI refers to a known location in order to prevent open-redirect a\", \"ttacks.\\n\\nIf the token endpoint receives a valid authorization code and PKCE secret verifier, it resp\", \"onds with an\\naccess token, identity token, and refresh token. The access token (which allows access \", \"to API\\nresources) and identity token are then stored as application settings, and page navigation is\", \"\\nperformed. Therefore, the overall effect in the eShopOnContainers mobile app is this: provided that\", \"\\nusers are able to successfully authenticate with IdentityServer, they are navigated to the MainView\", \"\\npage, which is a TabbedPage that displays the CatalogView as its selected tab.\\n\\nFor information abo\", \"ut page navigation, see Navigation. For information about how WebView\\nnavigation causes a view model\", \" method to be executed, see Invoking navigation using behaviors. For\\ninformation about application s\", \"ettings, see Configuration management.\\n\\nNote: The eShopOnContainers also allows a mock sign-in when \", \"the app is configured to use mock\\nservices in the SettingsView. In this mode, the app doesn't commun\", \"icate with IdentityServer,\\ninstead allowing the user to sign-in using any credentials.\\n\\nSigning-out\\n\", \"\\nWhen the user taps the LOG OUT button in the ProfileView, the LogoutCommand in the\\nProfileViewModel\", \" class is executed, which in turn executes the LogoutAsync method. This method\\nperforms page navigat\", \"ion to the LoginView page, passing a LogoutParameter instance set to true\\nas a parameter. For more i\", \"nformation about passing parameters during page navigation, see Passing\\nparameters during navigation\", \".\\n\\n67\\n\\nC HA PTER  9  |  Authentication and authorization\\n\\n\\fWhen a view is created and navigated to, \", \"the InitializeAsync method of the view's associated\\nview model is executed, which then executes the \", \"Logout method of the LoginViewModel class, which\\nis shown in the following code example:\\n\\nprivate vo\", \"id Logout()\\n{\\n    var authIdToken = Settings.AuthIdToken;\\n    var logoutRequest = _identityService.C\", \"reateLogoutRequest(authIdToken);\\n\\n    if (!string.IsNullOrEmpty(logoutRequest))\\n    {\\n        // Log\", \"out\\n        LoginUrl = logoutRequest;\\n    }\\n    ...\\n}\\n\\nThis method invokes the CreateLogoutRequest m\", \"ethod in the IdentityService class, passing the\\nidentity token retrieved from application settings a\", \"s a parameter. For more information about\\napplication settings, see Configuration management. The fo\", \"llowing code example shows the\\nCreateLogoutRequest method:\\n\\npublic string CreateLogoutRequest(string\", \" token)\\n{\\n    ...\\n    return string.Format(\\\"{0}?id_token_hint={1}&post_logout_redirect_uri={2}\\\",\\n   \", \"     GlobalSetting.Instance.LogoutEndpoint,\\n        token,\\n        GlobalSetting.Instance.LogoutCall\", \"back);\\n}\\n\\nThis method creates the URI to IdentityServer's end session endpoint, with the required pa\", \"rameters.\\nThe end session endpoint is at /connect/endsession on port 5105 of the base endpoint expos\", \"ed as\\na user setting. For more information about user settings, see Configuration management.\\n\\nThe r\", \"eturned URI is stored in the LoginUrl property of the LoginViewModel class. While the IsLogin\\nproper\", \"ty is true, the WebView in the LoginView is visible. The WebView data binds its Source property\\nto t\", \"he LoginUrl property of the LoginViewModel class, and so makes a sign-out request to\\nIdentityServer \", \"when the LoginUrl property is set to IdentityServer's end session endpoint. When\\nIdentityServer rece\", \"ives this request, provided that the user is signed-in, sign-out occurs.\\nAuthentication is tracked w\", \"ith a cookie managed by the cookie authentication middleware from\\nASP.NET Core. Therefore, signing o\", \"ut of IdentityServer removes the authentication cookie and sends a\\npost logout redirect URI back to \", \"the client.\\n\\nIn the mobile app, the WebView will be redirected to the post logout redirect URI. This\", \" WebView\\nnavigation will cause the NavigateAsync method in the LoginViewModel class to be executed, \", \"which\\nis shown in the following code example:\\n\\nprivate async Task NavigateAsync(string url)\\n{\\n    ..\", \".\\n    Settings.AuthAccessToken = string.Empty;\\n    Settings.AuthIdToken = string.Empty;\\n    IsLogin \", \"= false;\\n    LoginUrl = _identityService.CreateAuthorizationRequest();\\n    ...\\n}\\n\\n68\\n\\nC HA PTER  9  \", \"|  Authentication and authorization\\n\\n\\fThis method clears both the identity token and the access toke\", \"n from application settings, and sets\\nthe IsLogin property to false, which causes the WebView on the\", \" LoginView page to become\\ninvisible. Finally, the LoginUrl property is set to the URI of IdentitySer\", \"ver's authorization endpoint,\\nwith the required parameters, in preparation for the next time the use\", \"r initiates a sign-in.\\n\\nFor information about page navigation, see Navigation. For information about\", \" how WebView\\nnavigation causes a view model method to be executed, see Invoking navigation using beh\", \"aviors. For\\ninformation about application settings, see Configuration management.\\n\\nNote: The eShopOn\", \"Containers also allows a mock sign-out when the app is configured to use\\nmock services in the Settin\", \"gsView. In this mode, the app doesn't communicate with\\nIdentityServer, and instead clears any stored\", \" tokens from application settings.\\n\\nAuthorization\\n\\nAfter authentication, ASP.NET Core web APIs often\", \" need to authorize access, which allows a service to\\nmake APIs available to some authenticated users\", \", but not to all.\\n\\nRestricting access to an ASP.NET Core MVC route can be achieved by applying an Au\", \"thorize attribute\\nto a controller or action, which limits access to the controller or action to auth\", \"enticated users, as\\nshown in the following code example:\\n\\n[Authorize]\\npublic class BasketController \", \": Controller\\n{\\n    ...\\n}\\n\\nIf an unauthorized user attempts to access a controller or action that's m\", \"arked with the Authorize\\nattribute, the MVC framework returns a 401 (unauthorized) HTTP status code.\", \"\\n\\nNote: Parameters can be specified on the Authorize attribute to restrict an API to specific users.\", \"\\nFor more information, see Authorization on the Microsoft Documentation Center.\\n\\n69\\n\\nC HA PTER  9  |\", \"  Authentication and authorization\\n\\n\\fIdentityServer can be integrated into the authorization workflo\", \"w so that the access tokens it provides\\ncontrol authorization. This approach is shown in Figure 9-5.\", \"\\n\\nFigure 9-5: Authorization by access token\\n\\nThe eShopOnContainers mobile app communicates with the \", \"identity microservice and requests an\\naccess token as part of the authentication process. The access\", \" token is then forwarded to the APIs\\nexposed by the ordering and basket microservices as part of the\", \" access requests. Access tokens\\ncontain information about the client, and the user. APIs then use th\", \"at information to authorize access\\nto their data. For information about how to configure IdentitySer\", \"ver to protect APIs, see Configuring\\nAPI resources.\\n\\nConfiguring IdentityServer to perform authoriza\", \"tion\\n\\nTo perform authorization with IdentityServer, its authorization middleware must be added to th\", \"e web\\napplication's HTTP request pipeline. The middleware is added in the ConfigureAuth method in th\", \"e\\nweb application's Startup class, which is invoked from the Configure method, and is demonstrated\\ni\", \"n the following code example from the eShopOnContainers reference application:\\n\\nprotected virtual vo\", \"id ConfigureAuth(IApplicationBuilder app)\\n{\\n    var identityUrl = Configuration.GetValue<string>(\\\"Id\", \"entityUrl\\\");\\n    app.UseIdentityServerAuthentication(new IdentityServerAuthenticationOptions\\n    {\\n \", \"       Authority = identityUrl.ToString(),\\n        ScopeName = \\\"basket\\\",\\n        RequireHttpsMetadat\", \"a = false\\n    });\\n}\\n\\nThis method ensures that the API can only be accessed with a valid access token\", \". The middleware\\nvalidates the incoming token to ensure that it's sent from a trusted issuer, and va\", \"lidates that the token\\nis valid to be used with the API that receives it. Therefore, browsing to the\", \" ordering or basket\\ncontroller will return a 401 (unauthorized) HTTP status code, indicating that an\", \" access token is\\nrequired.\\n\\n70\\n\\nC HA PTER  9  |  Authentication and authorization\\n\\n\\fNote: IdentitySe\", \"rver's authorization middleware must be added to the web application's HTTP\\nrequest pipeline before \", \"adding MVC with app.UseMvc() or app.UseMvcWithDefaultRoute().\\n\\nMaking access requests to APIs\\n\\nWhen \", \"making requests to the ordering and basket microservices, the access token, obtained from\\nIdentitySe\", \"rver during the authentication process, must be included in the request, as shown in the\\nfollowing c\", \"ode example:\\n\\nvar authToken = Settings.AuthAccessToken;\\nOrder = await _ordersService.GetOrderAsync(C\", \"onvert.ToInt32(order.OrderNumber), authToken);\\n\\nThe access token is stored as an application setting\", \", and is retrieved from platform-specific storage\\nand included in the call to the GetOrderAsync meth\", \"od in the OrderService class.\\n\\nSimilarly, the access token must be included when sending data to an \", \"IdentityServer protected API, as\\nshown in the following code example:\\n\\nvar authToken = Settings.Auth\", \"AccessToken;\\nawait _basketService.UpdateBasketAsync(new CustomerBasket\\n{\\n    BuyerId = userInfo.User\", \"Id,\\n    Items = BasketItems.ToList()\\n}, authToken);\\n\\nThe access token is retrieved from platform-spe\", \"cific storage and included in the call to the\\nUpdateBasketAsync method in the BasketService class.\\n\\n\", \"The RequestProvider class, in the eShopOnContainers mobile app, uses the HttpClient class to\\nmake re\", \"quests to the RESTful APIs exposed by the eShopOnContainers reference application. When\\nmaking reque\", \"sts to the ordering and basket APIs, which require authorization, a valid access token\\nmust be inclu\", \"ded with the request. This is achieved by adding the access token to the headers of the\\nHttpClient i\", \"nstance, as demonstrated in the following code example:\\n\\nhttpClient.DefaultRequestHeaders.Authorizat\", \"ion = new AuthenticationHeaderValue(\\\"Bearer\\\", token);\\n\\nThe DefaultRequestHeaders property of the Htt\", \"pClient class exposes the headers that are sent\\nwith each request, and the access token is added to \", \"the Authorization header prefixed with the\\nstring Bearer. When the request is sent to a RESTful API,\", \" the value of the Authorization header is\\nextracted and validated to ensure that it's sent from a tr\", \"usted issuer, and used to determine whether\\nthe user has permission to invoke the API that receives \", \"it.\\n\\nFor more information about how the eShopOnContainers mobile app makes web requests, see\\nAccessi\", \"ng remote data.\\n\\nSummary\\n\\nThere are many approaches to integrating authentication and authorization \", \"into a Xamarin.Forms app\\nthat communicates with an ASP.NET MVC web application. The eShopOnContainer\", \"s mobile app\\nperforms authentication and authorization with a containerized identity microservice th\", \"at uses\\nIdentityServer 4. IdentityServer is an open source OpenID Connect and OAuth 2.0 framework fo\", \"r\\nASP.NET Core that integrates with ASP.NET Core Identity to perform bearer token authentication.\\n\\n7\", \"1\\n\\nC HA PTER  9  |  Authentication and authorization\\n\\n\\fThe mobile app requests security tokens from \", \"IdentityServer, either for authenticating a user or for\\naccessing a resource. When accessing a resou\", \"rce, an access token must be included in the request to\\nAPIs that require authorization. IdentitySer\", \"ver's middleware validates incoming access tokens to\\nensure that they are sent from a trusted issuer\", \", and that they are valid to be used with the API that\\nreceives them.\\n\\n72\\n\\nC HA PTER  9  |  Authenti\", \"cation and authorization\\n\\n\\fC H A P T E R\\n\\n10\\n\\nAccessing remote\\ndata\\n\\nMany modern web-based solutions\", \" make use of web services, hosted by web servers, to provide\\nfunctionality for remote client applica\", \"tions. The operations that a web service exposes constitute a\\nweb API.\\n\\nClient apps should be able t\", \"o utilize the web API without knowing how the data or operations that the\\nAPI exposes are implemente\", \"d. This requires that the API abides by common standards that enable a\\nclient app and web service to\", \" agree on which data formats to use, and the structure of the data that is\\nexchanged between client \", \"apps and the web service.\\n\\nIntroduction to Representational State Transfer\\n\\nRepresentational State T\", \"ransfer (REST) is an architectural style for building distributed systems based\\non hypermedia. A pri\", \"mary advantage of the REST model is that it's based on open standards and\\ndoesn't bind the implement\", \"ation of the model or the client apps that access it to any specific\\nimplementation. Therefore, a RE\", \"ST web service could be implemented using Microsoft ASP.NET Core\\nMVC, and client apps could be devel\", \"oping using any language and toolset that can generate HTTP\\nrequests and parse HTTP responses.\\n\\nThe \", \"REST model uses a navigational scheme to represent objects and services over a network, referred\\nto \", \"as resources. Systems that implement REST typically use the HTTP protocol to transmit requests to\\nac\", \"cess these resources. In such systems, a client app submits a request in the form of a URI that\\niden\", \"tifies a resource, and an HTTP method (such as GET, POST, PUT, or DELETE) that indicates the\\noperati\", \"on to be performed on that resource. The body of the HTTP request contains any data required\\nto perf\", \"orm the operation.\\n\\nNote: REST defines a stateless request model. Therefore, HTTP requests must be i\", \"ndependent and\\nmight occur in any order.\\n\\nThe response from a REST request makes use of standard HTT\", \"P status codes. For example, a request\\nthat returns valid data should include the HTTP response code\", \" 200 (OK), while a request that fails to\\nfind or delete a specified resource should return a respons\", \"e that includes the HTTP status code 404\\n(Not Found).\\n\\nA RESTful web API exposes a set of connected \", \"resources, and provides the core operations that\\nenable an app to manipulate those resources and eas\", \"ily navigate between them. For this reason, the\\nURIs that constitute a typical RESTful web API are o\", \"riented towards the data that it exposes, and use\\nthe facilities provided by HTTP to operate on this\", \" data.\\n\\n73\\n\\nC HA PTER  10  |  Accessing remote data\\n\\n\\fThe data included by a client app in an HTTP r\", \"equest, and the corresponding response messages from\\nthe web server, could be presented in a variety\", \" of formats, known as media types. When a client app\\nsends a request that returns data in the body o\", \"f a message, it can specify the media types it can\\nhandle in the Accept header of the request. If th\", \"e web server supports this media type, it can reply\\nwith a response that includes the Content-Type h\", \"eader that specifies the format of the data in the\\nbody of the message. It's then the responsibility\", \" of the client app to parse the response message and\\ninterpret the results in the message body appro\", \"priately.\\n\\nFor more information about REST, see API design and API implementation on Microsoft Docs.\", \"\\n\\nConsuming RESTful APIs\\n\\nThe eShopOnContainers mobile app uses the Model-View-ViewModel (MVVM) patt\", \"ern, and the\\nmodel elements of the pattern represent the domain entities used in the app. The contro\", \"ller and\\nrepository classes in the eShopOnContainers reference application accept and return many of\", \" these\\nmodel objects. Therefore, they are used as data transfer objects (DTOs) that hold all the dat\", \"a that is\\npassed between the mobile app and the containerized microservices. The main benefit of usi\", \"ng DTOs\\nto pass data to and receive data from a web service is that by transmitting more data in a s\", \"ingle\\nremote call, the app can reduce the number of remote calls that need to be made.\\n\\nMaking web r\", \"equests\\n\\nThe eShopOnContainers mobile app uses the HttpClient class to make requests over HTTP, with\", \"\\nJSON being used as the media type. This class provides functionality for asynchronously sending HTT\", \"P\\nrequests and receiving HTTP responses from a URI identified resource. The HttpResponseMessage\\nclas\", \"s represents an HTTP response message received from a REST API after an HTTP request has been\\nmade. \", \"It contains information about the response, including the status code, headers, and any body.\\nThe Ht\", \"tpContent class represents the HTTP body and content headers, such as Content-Type and\\nContent-Encod\", \"ing. The content can be read using any of the ReadAs methods, such as\\nReadAsStringAsync and ReadAsBy\", \"teArrayAsync, depending on the format of the data.\\n\\nMaking a GET request\\n\\nThe CatalogService class i\", \"s used to manage the data retrieval process from the catalog\\nmicroservice. In the RegisterDependenci\", \"es method in the ViewModelLocator class, the\\nCatalogService class is registered as a type mapping ag\", \"ainst the ICatalogService type with the\\nAutofac dependency injection container. Then, when an instan\", \"ce of the CatalogViewModel class is\\ncreated, its constructor accepts an ICatalogService type, which \", \"Autofac resolves, returning an\\ninstance of the CatalogService class. For more information about depe\", \"ndency injection, see\\nIntroduction to dependency injection.\\n\\nFigure 10-1 shows the interaction of cl\", \"asses that read catalog data from the catalog microservice for\\ndisplaying by the CatalogView.\\n\\n74\\n\\nC\", \" HA PTER  10  |  Accessing remote data\\n\\n\\fFigure 10-1: Retrieving data from the catalog microservice\\n\", \"\\nWhen the CatalogView is navigated to, the OnInitialize method in the CatalogViewModel class is\\ncall\", \"ed. This method retrieves catalog data from the catalog microservice, as demonstrated in the\\nfollowi\", \"ng code example:\\n\\npublic override async Task InitializeAsync(object navigationData)\\n{\\n    ...\\n    Pr\", \"oducts = await _productsService.GetCatalogAsync();\\n    ...\\n}\\n\\nThis method calls the GetCatalogAsync \", \"method of the CatalogService instance that was injected\\ninto the CatalogViewModel by Autofac. The fo\", \"llowing code example shows the GetCatalogAsync\\nmethod:\\n\\npublic async Task<ObservableCollection<Catal\", \"ogItem>> GetCatalogAsync()\\n{\\n    UriBuilder builder = new UriBuilder(GlobalSetting.Instance.CatalogE\", \"ndpoint);\\n    builder.Path = \\\"api/v1/catalog/items\\\";\\n    string uri = builder.ToString();\\n\\n    Catal\", \"ogRoot catalog = await _requestProvider.GetAsync<CatalogRoot>(uri);\\n    ...\\n\\n75\\n\\nC HA PTER  10  |  A\", \"ccessing remote data\\n\\n\\f    return catalog?.Data.ToObservableCollection();\\n}\\n\\nThis method builds the \", \"URI that identifies the resource the request will be sent to, and uses the\\nRequestProvider class to \", \"invoke the GET HTTP method on the resource, before returning the results\\nto the CatalogViewModel. Th\", \"e RequestProvider class contains functionality that submits a request\\nin the form of a URI that iden\", \"tifies a resource, an HTTP method that indicates the operation to be\\nperformed on that resource, and\", \" a body that contains any data required to perform the operation. For\\ninformation about how the Requ\", \"estProvider class is injected into the CatalogService class, see\\nIntroduction to dependency injectio\", \"n.\\n\\nThe following code example shows the GetAsync method in the RequestProvider class:\\n\\npublic async\", \" Task<TResult> GetAsync<TResult>(string uri, string token = \\\"\\\")\\n{\\n    HttpClient httpClient = Create\", \"HttpClient(token);\\n    HttpResponseMessage response = await httpClient.GetAsync(uri);\\n\\n    await Han\", \"dleResponse(response);\\n    string serialized = await response.Content.ReadAsStringAsync();\\n\\n    TRes\", \"ult result = await Task.Run(() =>\\n        JsonConvert.DeserializeObject<TResult>(serialized, _serial\", \"izerSettings));\\n\\n    return result;\\n}\\n\\nThis method calls the CreateHttpClient method, which returns \", \"an instance of the HttpClient class\\nwith the appropriate headers set. It then submits an asynchronou\", \"s GET request to the resource\\nidentified by the URI, with the response being stored in the HttpRespo\", \"nseMessage instance. The\\nHandleResponse method is then invoked, which throws an exception if the res\", \"ponse doesn't include\\na success HTTP status code. Then the response is read as a string, converted f\", \"rom JSON to a\\nCatalogRoot object, and returned to the CatalogService.\\n\\nThe CreateHttpClient method i\", \"s shown in the following code example:\\n\\nprivate HttpClient CreateHttpClient(string token = \\\"\\\")\\n{\\n   \", \" var httpClient = new HttpClient();\\n    httpClient.DefaultRequestHeaders.Accept.Add(\\n        new Med\", \"iaTypeWithQualityHeaderValue(\\\"application/json\\\"));\\n\\n    if (!string.IsNullOrEmpty(token))\\n    {\\n    \", \"    httpClient.DefaultRequestHeaders.Authorization =\\n            new AuthenticationHeaderValue(\\\"Bear\", \"er\\\", token);\\n    }\\n    return httpClient;\\n}\\n\\nThis method creates a new instance of the HttpClient cl\", \"ass, and sets the Accept header of any\\nrequests made by the HttpClient instance to application/json,\", \" which indicates that it expects the\\ncontent of any response to be formatted using JSON. Then, if an\", \" access token was passed as an\\nargument to the CreateHttpClient method, it's added to the Authorizat\", \"ion header of any\\nrequests made by the HttpClient instance, prefixed with the string Bearer. For mor\", \"e information\\nabout authorization, see Authorization.\\n\\n76\\n\\nC HA PTER  10  |  Accessing remote data\\n\\n\", \"\\fWhen the GetAsync method in the RequestProvider class calls HttpClient.GetAsync, the Items\\nmethod i\", \"n the CatalogController class in the Catalog.API project is invoked, which is shown in the\\nfollowing\", \" code example:\\n\\n[HttpGet]\\n[Route(\\\"[action]\\\")]\\npublic async Task<IActionResult> Items(\\n    [FromQuery\", \"]int pageSize = 10, [FromQuery]int pageIndex = 0)\\n{\\n    var totalItems = await _catalogContext.Catal\", \"ogItems\\n        .LongCountAsync();\\n\\n    var itemsOnPage = await _catalogContext.CatalogItems\\n       \", \" .OrderBy(c=>c.Name)\\n        .Skip(pageSize * pageIndex)\\n        .Take(pageSize)\\n        .ToListAsyn\", \"c();\\n\\n    itemsOnPage = ComposePicUri(itemsOnPage);\\n    var model = new PaginatedItemsViewModel<Cata\", \"logItem>(\\n        pageIndex, pageSize, totalItems, itemsOnPage);\\n\\n    return Ok(model);\\n}\\n\\nThis meth\", \"od retrieves the catalog data from the SQL database using EntityFramework, and returns it\\nas a respo\", \"nse message that includes a success HTTP status code, and a collection of JSON formatted\\nCatalogItem\", \" instances.\\n\\nMaking a POST request\\n\\nThe BasketService class is used to manage the data retrieval and\", \" update process with the basket\\nmicroservice. In the RegisterDependencies method in the ViewModelLoc\", \"ator class, the\\nBasketService class is registered as a type mapping against the IBasketService type \", \"with the\\nAutofac dependency injection container. Then, when an instance of the BasketViewModel class\", \" is\\ncreated, its constructor accepts an IBasketService type, which Autofac resolves, returning an\\nin\", \"stance of the BasketService class. For more information about dependency injection, see\\nIntroduction\", \" to dependency injection.\\n\\nFigure 10-2 shows the interaction of classes that send the basket data di\", \"splayed by the BasketView,\\nto the basket microservice.\\n\\n77\\n\\nC HA PTER  10  |  Accessing remote data\\n\", \"\\n\\fFigure 10-2: Sending data to the basket microservice\\n\\nWhen an item is added to the shopping basket\", \", the ReCalculateTotalAsync method in the\\nBasketViewModel class is called. This method updates the t\", \"otal value of items in the basket, and\\nsends the basket data to the basket microservice, as demonstr\", \"ated in the following code example:\\n\\nprivate async Task ReCalculateTotalAsync()\\n{\\n    ...\\n    await \", \"_basketService.UpdateBasketAsync(new CustomerBasket\\n    {\\n        BuyerId = userInfo.UserId,\\n       \", \" Items = BasketItems.ToList()\\n    }, authToken);\\n}\\n\\nThis method calls the UpdateBasketAsync method o\", \"f the BasketService instance that was injected\\ninto the BasketViewModel by Autofac. The following me\", \"thod shows the UpdateBasketAsync\\nmethod:\\n\\npublic async Task<CustomerBasket> UpdateBasketAsync(Custom\", \"erBasket customerBasket, string token)\\n{\\n    UriBuilder builder = new UriBuilder(GlobalSetting.Insta\", \"nce.BasketEndpoint);\\n    string uri = builder.ToString();\\n\\n78\\n\\nC HA PTER  10  |  Accessing remote da\", \"ta\\n\\n\\f    var result = await _requestProvider.PostAsync(uri, customerBasket, token);\\n    return resul\", \"t;\\n}\\n\\nThis method builds the URI that identifies the resource the request will be sent to, and uses \", \"the\\nRequestProvider class to invoke the POST HTTP method on the resource, before returning the\\nresul\", \"ts to the BasketViewModel. Note that an access token, obtained from IdentityServer during the\\nauthen\", \"tication process, is required to authorize requests to the basket microservice. For more\\ninformation\", \" about authorization, see Authorization.\\n\\nThe following code example shows one of the PostAsync meth\", \"ods in the RequestProvider class:\\n\\npublic async Task<TResult> PostAsync<TResult>(\\n    string uri, TR\", \"esult data, string token = \\\"\\\", string header = \\\"\\\")\\n{\\n    HttpClient httpClient = CreateHttpClient(to\", \"ken);\\n    ...\\n    var content = new StringContent(JsonConvert.SerializeObject(data));\\n    content.He\", \"aders.ContentType = new MediaTypeHeaderValue(\\\"application/json\\\");\\n    HttpResponseMessage response =\", \" await httpClient.PostAsync(uri, content);\\n\\n    await HandleResponse(response);\\n    string serialize\", \"d = await response.Content.ReadAsStringAsync();\\n\\n    TResult result = await Task.Run(() =>\\n        J\", \"sonConvert.DeserializeObject<TResult>(serialized, _serializerSettings));\\n\\n    return result;\\n}\\n\\nThis\", \" method calls the CreateHttpClient method, which returns an instance of the HttpClient class\\nwith th\", \"e appropriate headers set. It then submits an asynchronous POST request to the resource\\nidentified b\", \"y the URI, with the serialized basket data being sent in JSON format, and the response\\nbeing stored \", \"in the HttpResponseMessage instance. The HandleResponse method is then invoked,\\nwhich throws an exce\", \"ption if the response doesn't include a success HTTP status code. Then, the\\nresponse is read as a st\", \"ring, converted from JSON to a CustomerBasket object, and returned to the\\nBasketService. For more in\", \"formation about the CreateHttpClient method, see Making a GET request.\\n\\nWhen the PostAsync method in\", \" the RequestProvider class calls HttpClient.PostAsync, the Post\\nmethod in the BasketController class\", \" in the Basket.API project is invoked, which is shown in the\\nfollowing code example:\\n\\n[HttpPost]\\npub\", \"lic async Task<IActionResult> Post([FromBody]CustomerBasket value)\\n{\\n    var basket = await _reposit\", \"ory.UpdateBasketAsync(value);\\n    return Ok(basket);\\n}\\n\\nThis method uses an instance of the RedisBas\", \"ketRepository class to persist the basket data to the\\nRedis cache, and returns it as a response mess\", \"age that includes a success HTTP status code, and a\\nJSON formatted CustomerBasket instance.\\n\\nMaking \", \"a DELETE request\\n\\nFigure 10-3 shows the interactions of classes that delete basket data from the bas\", \"ket microservice, for\\nthe CheckoutView.\\n\\n79\\n\\nC HA PTER  10  |  Accessing remote data\\n\\n\\fFigure 10-3: \", \"Deleting data from the basket microservice\\n\\nWhen the checkout process is invoked, the CheckoutAsync \", \"method in the CheckoutViewModel class\\nis called. This method creates a new order, before clearing th\", \"e shopping basket, as demonstrated in\\nthe following code example:\\n\\nprivate async Task CheckoutAsync(\", \")\\n{\\n    ...\\n    await _basketService.ClearBasketAsync(_shippingAddress.Id.ToString(), authToken);\\n  \", \"  ...\\n}\\n\\nThis method calls the ClearBasketAsync method of the BasketService instance that was inject\", \"ed\\ninto the CheckoutViewModel by Autofac. The following method shows the ClearBasketAsync\\nmethod:\\n\\np\", \"ublic async Task ClearBasketAsync(string guidUser, string token)\\n{\\n    UriBuilder builder = new UriB\", \"uilder(GlobalSetting.Instance.BasketEndpoint);\\n    builder.Path = guidUser;\\n    string uri = builder\", \".ToString();\\n    await _requestProvider.DeleteAsync(uri, token);\\n}\\n\\nThis method builds the URI that \", \"identifies the resource that the request will be sent to, and uses the\\nRequestProvider class to invo\", \"ke the DELETE HTTP method on the resource. Note that an access\\ntoken, obtained from IdentityServer d\", \"uring the authentication process, is required to authorize\\nrequests to the basket microservice. For \", \"more information about authorization, see Authorization.\\n\\nThe following code example shows the Delet\", \"eAsync method in the RequestProvider class:\\n\\n80\\n\\nC HA PTER  10  |  Accessing remote data\\n\\n\\fpublic as\", \"ync Task DeleteAsync(string uri, string token = \\\"\\\")\\n{\\n    HttpClient httpClient = CreateHttpClient(t\", \"oken);\\n    await httpClient.DeleteAsync(uri);\\n}\\n\\nThis method calls the CreateHttpClient method, whic\", \"h returns an instance of the HttpClient class\\nwith the appropriate headers set. It then submits an a\", \"synchronous DELETE request to the resource\\nidentified by the URI. For more information about the Cre\", \"ateHttpClient method, see Making a GET\\nrequest.\\n\\nWhen the DeleteAsync method in the RequestProvider \", \"class calls HttpClient.DeleteAsync, the\\nDelete method in the BasketController class in the Basket.AP\", \"I project is invoked, which is shown\\nin the following code example:\\n\\n[HttpDelete(\\\"{id}\\\")]\\npublic voi\", \"d Delete(string id)\\n{\\n    _repository.DeleteBasketAsync(id);\\n}\\n\\nThis method uses an instance of the \", \"RedisBasketRepository class to delete the basket data from\\nthe Redis cache.\\n\\nCaching data\\n\\nThe perfo\", \"rmance of an app can be improved by caching frequently accessed data to fast storage\\nthat's located \", \"close to the app. If the fast storage is located closer to the app than the original source,\\nthen ca\", \"ching can significantly improve response times when retrieving data.\\n\\nThe most common form of cachin\", \"g is read-through caching, where an app retrieves data by\\nreferencing the cache. If the data isn't i\", \"n the cache, it's retrieved from the data store and added to the\\ncache. Apps can implement read-thro\", \"ugh caching with the cache-aside pattern. This pattern\\ndetermines whether the item is currently in t\", \"he cache. If the item isn't in the cache, it's read from the\\ndata store and added to the cache. For \", \"more information, see the Cache-Aside pattern on Microsoft\\nDocs.\\n\\nTip: Cache data that's read freque\", \"ntly and that changes infrequently\\n\\nThis data can be added to the cache on demand the first time it \", \"is retrieved by an app. This means\\nthat the app needs to fetch the data only once from the data stor\", \"e, and that subsequent access can\\nbe satisfied by using the cache.\\n\\nDistributed applications, such a\", \"s the eShopOnContainers reference application, should provide either\\nor both of the following caches\", \":\\n\\n\\u2022  A shared cache, which can be accessed by multiple processes or machines.\\n\\n\\u2022  A private cache, \", \"where data is held locally on the device running the app.\\n\\nThe eShopOnContainers mobile app uses a p\", \"rivate cache, where data is held locally on the device\\nthat's running an instance of the app. For in\", \"formation about the cache used by the\\neShopOnContainers reference application, see .NET Microservice\", \"s: Architecture for Containerized .NET\\nApplications.\\n\\n81\\n\\nC HA PTER  10  |  Accessing remote data\\n\\n\\f\", \"Tip: Think of the cache as a transient data store that could disappear at any time\\n\\nEnsure that data\", \" is maintained in the original data store as well as the cache. The chances of losing\\ndata are then \", \"minimized if the cache becomes unavailable.\\n\\nManaging data expiration\\n\\nIt's impractical to expect th\", \"at cached data will always be consistent with the original data. Data in the\\noriginal data store mig\", \"ht change after it's been cached, causing the cached data to become stale.\\nTherefore, apps should im\", \"plement a strategy that helps to ensure that the data in the cache is as up-\\nto-date as possible, bu\", \"t can also detect and handle situations that arise when the data in the cache\\nhas become stale. Most\", \" caching mechanisms enable the cache to be configured to expire data, and\\nhence reduce the period fo\", \"r which data might be out of date.\\n\\nTip: Set a default expiration time when configuring a cache\\n\\nMan\", \"y caches implement expiration, which invalidates data and removes it from the cache if it's not\\nacce\", \"ssed for a specified period. However, care must be taken when choosing the expiration period.\\nIf it'\", \"s made too short, data will expire too quickly and the benefits of caching will be reduced. If it's\\n\", \"made too long, the data risks becoming stale. Therefore, the expiration time should match the\\npatter\", \"n of access for apps that use the data.\\n\\nWhen cached data expires, it should be removed from the cac\", \"he, and the app must retrieve the data\\nfrom the original data store and place it back into the cache\", \".\\n\\nIt's also possible that a cache might fill up if data is allowed to remain for too long a period.\", \" Therefore,\\nrequests to add new items to the cache might be required to remove some items in a proce\", \"ss known\\nas eviction. Caching services typically evict data on a least-recently-used basis. However,\", \" there are\\nother eviction policies, including most-recently-used, and first-in-first-out. For more i\", \"nformation, see\\nCaching Guidance on Microsoft Docs.\\n\\nCaching images\\n\\nThe eShopOnContainers mobile ap\", \"p consumes remote product images that benefit from being\\ncached. These images are displayed by the I\", \"mage control, and the CachedImage control provided by\\nthe FFImageLoading library.\\n\\nThe Xamarin.Forms\", \" Image control supports caching of downloaded images. Caching is enabled by\\ndefault, and will store \", \"the image locally for 24 hours. In addition, the expiration time can be\\nconfigured with the CacheVal\", \"idity property. For more information, see Downloaded Image Caching\\non the Xamarin Developer Center.\\n\", \"\\nFFImageLoading's CachedImage control is a replacement for the Xamarin.Forms Image control,\\nprovidin\", \"g additional properties that enable supplementary functionality. Amongst this functionality,\\nthe con\", \"trol provides configurable caching, while supporting error and loading image placeholders.\\nThe follo\", \"wing code example shows how the eShopOnContainers mobile app uses the CachedImage\\ncontrol in the Pro\", \"ductTemplate, which is the data template used by the ListView control in the\\nCatalogView:\\n\\n<ffimagel\", \"oading:CachedImage\\n    Grid.Row=\\\"0\\\"\\n    Source=\\\"{Binding PictureUri}\\\"\\n    Aspect=\\\"AspectFill\\\">\\n    <\", \"ffimageloading:CachedImage.LoadingPlaceholder>\\n        <OnPlatform\\n            x:TypeArguments=\\\"Imag\", \"eSource\\\"\\n\\n82\\n\\nC HA PTER  10  |  Accessing remote data\\n\\n\\f            iOS=\\\"default_product\\\"\\n          \", \"  Android=\\\"default_product\\\"\\n            WinPhone=\\\"Assets/default_product.png\\\"/>\\n    </ffimageloading\", \":CachedImage.LoadingPlaceholder>\\n    <ffimageloading:CachedImage.ErrorPlaceholder>\\n        <OnPlatfo\", \"rm\\n            x:TypeArguments=\\\"ImageSource\\\"\\n            iOS=\\\"noimage\\\"\\n            Android=\\\"noimage\\\"\", \"\\n            WinPhone=\\\"Assets/noimage.png\\\"/>\\n    </ffimageloading:CachedImage.ErrorPlaceholder>\\n</ff\", \"imageloading:CachedImage>\\n\\nThe CachedImage control sets the LoadingPlaceholder and ErrorPlaceholder \", \"properties to\\nplatform-specific images. The LoadingPlaceholder property specifies the image to be di\", \"splayed\\nwhile the image specified by the Source property is retrieved, and the ErrorPlaceholder prop\", \"erty\\nspecifies the image to be displayed if an error occurs when attempting to retrieve the image sp\", \"ecified\\nby the Source property.\\n\\nAs the name implies, the CachedImage control caches remote images o\", \"n the device for the time\\nspecified by the value of the CacheDuration property. When this property v\", \"alue isn't explicitly set, the\\ndefault value of 30 days is applied.\\n\\nIncreasing resilience\\n\\nAll apps\", \" that communicate with remote services and resources must be sensitive to transient faults.\\nTransien\", \"t faults include the momentary loss of network connectivity to services, the temporary\\nunavailabilit\", \"y of a service, or timeouts that arise when a service is busy. These faults are often self-\\ncorrecti\", \"ng, and if the action is repeated after a suitable delay it's likely to succeed.\\n\\nTransient faults c\", \"an have a huge impact on the perceived quality of an app, even if it has been\\nthoroughly tested unde\", \"r all foreseeable circumstances. To ensure that an app that communicates with\\nremote services operat\", \"es reliably, it must be able to do all of the following:\\n\\n\\u2022  Detect faults when they occur, and dete\", \"rmine if the faults are likely to be transient.\\n\\n\\u2022  Retry the operation if it determines that the fa\", \"ult is likely to be transient and keep track of the\\n\\nnumber of times the operation was retried.\\n\\n\\u2022  \", \"Use an appropriate retry strategy, which specifies the number of retries, the delay between\\n\\neach at\", \"tempt, and the actions to take after a failed attempt.\\n\\nThis transient fault handling can be achieve\", \"d by wrapping all attempts to access a remote service in\\ncode that implements the retry pattern.\\n\\nRe\", \"try pattern\\n\\nIf an app detects a failure when it tries to send a request to a remote service, it can\", \" handle the failure\\nin any of the following ways:\\n\\n\\u2022  Retrying the operation. The app could retry th\", \"e failing request immediately.\\n\\n\\u2022  Retrying the operation after a delay. The app should wait for a s\", \"uitable amount of time before\\n\\nretrying the request.\\n\\n\\u2022  Cancelling the operation. The application s\", \"hould cancel the operation and report an\\n\\nexception.\\n\\n83\\n\\nC HA PTER  10  |  Accessing remote data\\n\\n\\f\", \"The retry strategy should be tuned to match the business requirements of the app. For example, it's\\n\", \"important to optimize the retry count and retry interval to the operation being attempted. If the\\nop\", \"eration is part of a user interaction, the retry interval should be short and only a few retries\\natt\", \"empted to avoid making users wait for a response. If the operation is part of a long running\\nworkflo\", \"w, where cancelling or restarting the workflow is expensive or time-consuming, it's appropriate\\nto w\", \"ait longer between attempts and to retry more times.\\n\\nNote: An aggressive retry strategy with minima\", \"l delay between attempts, and a large number of\\nretries, could degrade a remote service that's runni\", \"ng close to or at capacity. In addition, such a\\nretry strategy could also affect the responsiveness \", \"of the app if it's continually trying to perform a\\nfailing operation.\\n\\nIf a request still fails afte\", \"r a number of retries, it's better for the app to prevent further requests going\\nto the same resourc\", \"e and to report a failure. Then, after a set period, the app can make one or more\\nrequests to the re\", \"source to see if they're successful. For more information, see Circuit breaker pattern.\\n\\nTip: Never \", \"implement an endless retry mechanism\\n\\nUse a finite number of retries, or implement the Circuit Break\", \"er pattern to allow a service to recover.\\n\\nThe eShopOnContainers mobile app does not currently imple\", \"ment the retry pattern when making\\nRESTful web requests. However, the CachedImage control, provided \", \"by the FFImageLoading library\\nsupports transient fault handling by retrying image loading. If image \", \"loading fails, further attempts\\nwill be made. The number of attempts is specified by the RetryCount \", \"property, and retries will occur\\nafter a delay specified by the RetryDelay property. If these proper\", \"ty values aren't explicitly set, their\\ndefault values are applied \\u2013 3 for the RetryCount property, a\", \"nd 250ms for the RetryDelay property.\\nFor more information about the CachedImage control, see Cachin\", \"g images.\\n\\nThe eShopOnContainers reference application does implement the retry pattern. For more\\nin\", \"formation, including a discussion of how to combine the retry pattern with the HttpClient class,\\nsee\", \" .NET Microservices: Architecture for Containerized .NET Applications.\\n\\nFor more information about t\", \"he retry pattern, see the Retry pattern on Microsoft Docs.\\n\\nCircuit breaker pattern\\n\\nIn some situati\", \"ons, faults can occur due to anticipated events that take longer to fix. These faults can\\nrange from\", \" a partial loss of connectivity to the complete failure of a service. In these situations, it's\\npoin\", \"tless for an app to retry an operation that's unlikely to succeed, and instead should accept that\\nth\", \"e operation has failed and handle this failure accordingly.\\n\\nThe circuit breaker pattern can prevent\", \" an app from repeatedly trying to execute an operation that's\\nlikely to fail, while also enabling th\", \"e app to detect whether the fault has been resolved.\\n\\nNote: The purpose of the circuit breaker patte\", \"rn is different from the retry pattern. The retry\\npattern enables an app to retry an operation in th\", \"e expectation that it'll succeed. The circuit breaker\\npattern prevents an app from performing an ope\", \"ration that's likely to fail.\\n\\nA circuit breaker acts as a proxy for operations that might fail. The\", \" proxy should monitor the number\\nof recent failures that have occurred, and use this information to \", \"decide whether to allow the\\noperation to proceed, or to return an exception immediately.\\n\\nThe eShopO\", \"nContainers mobile app does not currently implement the circuit breaker pattern.\\nHowever, the eShopO\", \"nContainers does. For more information, see .NET Microservices: Architecture\\nfor Containerized .NET \", \"Applications.\\n\\n84\\n\\nC HA PTER  10  |  Accessing remote data\\n\\n\\fTip: Combine the retry and circuit brea\", \"ker patterns\\n\\nAn app can combine the retry and circuit breaker patterns by using the retry pattern t\", \"o invoke an\\noperation through a circuit breaker. However, the retry logic should be sensitive to any\", \" exceptions\\nreturned by the circuit breaker and abandon retry attempts if the circuit breaker indica\", \"tes that a\\nfault is not transient.\\n\\nFor more information about the circuit breaker pattern, see the \", \"Circuit Breaker pattern on Microsoft\\nDocs.\\n\\nSummary\\n\\nMany modern web-based solutions make use of web\", \" services, hosted by web servers, to provide\\nfunctionality for remote client applications. The opera\", \"tions that a web service exposes constitute a\\nweb API, and client apps should be able to utilize the\", \" web API without knowing how the data or\\noperations that the API exposes are implemented.\\n\\nThe perfo\", \"rmance of an app can be improved by caching frequently accessed data to fast storage\\nthat's located \", \"close to the app. Apps can implement read-through caching with the cache-aside\\npattern. This pattern\", \" determines whether the item is currently in the cache. If the item isn't in the\\ncache, it's read fr\", \"om the data store and added to the cache.\\n\\nWhen communicating with web APIs, apps must be sensitive \", \"to transient faults. Transient faults\\ninclude the momentary loss of network connectivity to services\", \", the temporary unavailability of a\\nservice, or timeouts that arise when a service is busy. These fa\", \"ults are often self-correcting, and if the\\naction is repeated after a suitable delay, then it's like\", \"ly to succeed. Therefore, apps should wrap all\\nattempts to access a web API in code that implements \", \"a transient fault handling mechanism.\\n\\n85\\n\\nC HA PTER  10  |  Accessing remote data\\n\\n\\fC H A P T E R\\n\\n\", \"11\\n\\nUnit testing\\n\\nMobile apps have unique problems that desktop and web-based applications don't hav\", \"e to worry\\nabout. Mobile users will differ by the devices that they use, by network connectivity, by\", \" the availability\\nof services, and a range of other factors. Therefore, mobile apps should be tested\", \" as they will be used\\nin the real world in order to improve their quality, reliability, and performa\", \"nce. There are many types\\nof testing that should be performed on an app, including unit testing, int\", \"egration testing, and user\\ninterface testing, with unit testing being the most common form of testin\", \"g.\\n\\nA unit test takes a small unit of the app, typically a method, isolates it from the remainder of\", \" the code,\\nand verifies that it behaves as expected. Its goal is to check that each unit of function\", \"ality performs as\\nexpected, so that errors don't propagate throughout the app. Detecting a bug where\", \" it occurs is more\\nefficient that observing the effect of a bug indirectly at a secondary point of f\", \"ailure.\\n\\nUnit testing has the greatest effect on code quality when it's an integral part of the soft\", \"ware\\ndevelopment workflow. As soon as a method has been written, unit tests should be written that v\", \"erify\\nthe behavior of the method in response to standard, boundary, and incorrect cases of input dat\", \"a, and\\nthat check any explicit or implicit assumptions made by the code. Alternatively, with test dr\", \"iven\\ndevelopment, unit tests are written before the code. In this scenario, unit tests act as both d\", \"esign\\ndocumentation and functional specifications.\\n\\nNote: Unit tests are very effective against regr\", \"ession \\u2013 that is, functionality that used to work but\\nhas been disturbed by a faulty update.\\n\\nUnit t\", \"ests typically use the arrange-act-assert pattern:\\n\\n\\u2022  The arrange section of the unit test method i\", \"nitializes objects and sets the value of the data\\n\\nthat is passed to the method under test.\\n\\n\\u2022  The \", \"act section invokes the method under test with the required arguments.\\n\\n\\u2022  The assert section verifi\", \"es that the action of the method under test behaves as expected.\\n\\nFollowing this pattern ensures tha\", \"t unit tests are readable and consistent.\\n\\nDependency injection and unit testing\\n\\nOne of the motivat\", \"ions for adopting a loosely-coupled architecture is that it facilitates unit testing.\\nOne of the typ\", \"es registered with Autofac is the OrderService class. The following code example\\nshows an outline of\", \" this class:\\n\\npublic class OrderDetailViewModel : ViewModelBase\\n{\\n    private IOrderService _ordersS\", \"ervice;\\n\\n    public OrderDetailViewModel(IOrderService ordersService)\\n\\n86\\n\\nC HA PTER  11  |  Unit te\", \"sting\\n\\n\\f    {\\n        _ordersService = ordersService;\\n    }\\n    ...\\n}\\n\\nThe OrderDetailViewModel clas\", \"s has a dependency on the IOrderService type which the container\\nresolves when it instantiates a Ord\", \"erDetailViewModel object. However, rather than create an\\nOrderService object to unit test the OrderD\", \"etailViewModel class, instead, replace the\\nOrderService object with a mock for the purpose of the te\", \"sts. Figure 10-1 illustrates this relationship.\\n\\nFigure 10-1: Classes that implement the IOrderServi\", \"ce interface\\n\\nThis approach allows the OrderService object to be passed into the OrderDetailViewMode\", \"l class at\\nruntime, and in the interests of testability, it allows the OrderMockService class to be \", \"passed into the\\nOrderDetailViewModel class at test time. The main advantage of this approach is that\", \" it enables unit\\ntests to be executed without requiring unwieldy resources such as web services, or \", \"databases.\\n\\nTesting MVVM applications\\n\\nTesting models and view models from MVVM applications is iden\", \"tical to testing any other classes, and\\nthe same tools and techniques \\u2013 such as unit testing and moc\", \"king, can be used. However, there are\\nsome patterns that are typical to model and view model classes\", \", that can benefit from specific unit\\ntesting techniques.\\n\\nTip: Test one thing with each unit test\\n\\n\", \"Don't be tempted to make a unit test exercise more than one aspect of the unit's behavior. Doing\\nso \", \"leads to tests that are difficult to read and update. It can also lead to confusion when\\ninterpretin\", \"g a failure.\\n\\nThe eShopOnContainers mobile app uses xUnit to perform unit testing, which supports tw\", \"o different\\ntypes of unit tests:\\n\\n\\u2022\\n\\nFacts are tests that are always true, which test invariant cond\", \"itions.\\n\\n\\u2022  Theories are tests that are only true for a particular set of data.\\n\\n87\\n\\nC HA PTER  11  \", \"|  Unit testing\\n\\n\\fThe unit tests included with the eShopOnContainers mobile app are fact tests, and \", \"so each unit test\\nmethod is decorated with the [Fact] attribute.\\n\\nNote: xUnit tests are executed by \", \"a test runner. To execute the test runner, run the\\neShopOnContainers.TestRunner project for the requ\", \"ired platform.\\n\\nTesting asynchronous functionality\\n\\nWhen implementing the MVVM pattern, view models \", \"usually invoke operations on services, often\\nasynchronously. Tests for code that invokes these opera\", \"tions typically use mocks as replacements for\\nthe actual services. The following code example demons\", \"trates testing asynchronous functionality by\\npassing a mock service into a view model:\\n\\n[Fact]\\npubli\", \"c async Task OrderPropertyIsNotNullAfterViewModelInitializationTest()\\n{\\n    var orderService = new O\", \"rderMockService();\\n    var orderViewModel = new OrderDetailViewModel(orderService);\\n\\n    var order =\", \" await orderService.GetOrderAsync(1, GlobalSetting.Instance.AuthToken);\\n    await orderViewModel.Ini\", \"tializeAsync(order);\\n\\n    Assert.NotNull(orderViewModel.Order);\\n}\\n\\nThis unit test checks that the Or\", \"der property of the OrderDetailViewModel instance will have a value\\nafter the InitializeAsync method\", \" has been invoked. The InitializeAsync method is invoked\\nwhen the view model's corresponding view is\", \" navigated to. For more information about navigation,\\nsee Navigation.\\n\\nWhen the OrderDetailViewModel\", \" instance is created, it expects an OrderService instance to be\\nspecified as an argument. However, t\", \"he OrderService retrieves data from a web service. Therefore,\\nan OrderMockService instance, which is\", \" a mock version of the OrderService class, is specified as the\\nargument to the OrderDetailViewModel \", \"constructor. Then, when the view model's\\nInitializeAsync method is invoked, which invokes IOrderServ\", \"ice operations, mock data is\\nretrieved rather than communicating with a web service.\\n\\nTesting INotif\", \"yPropertyChanged implementations\\n\\nImplementing the INotifyPropertyChanged interface allows views to \", \"react to changes that originate\\nfrom view models and models. These changes are not limited to data s\", \"hown in controls \\u2013 they are\\nalso used to control the view, such as view model states that cause anim\", \"ations to be started or\\ncontrols to be disabled.\\n\\nProperties that can be updated directly by the uni\", \"t test can be tested by attaching an event handler to\\nthe PropertyChanged event and checking whether\", \" the event is raised after setting a new value for the\\nproperty. The following code example shows su\", \"ch a test:\\n\\n[Fact]\\npublic async Task SettingOrderPropertyShouldRaisePropertyChanged()\\n{\\n    bool inv\", \"oked = false;\\n    var orderService = new OrderMockService();\\n    var orderViewModel = new OrderDetai\", \"lViewModel(orderService);\\n\\n    orderViewModel.PropertyChanged += (sender, e) =>\\n    {\\n\\n88\\n\\nC HA PTER\", \"  11  |  Unit testing\\n\\n\\f        if (e.PropertyName.Equals(\\\"Order\\\"))\\n            invoked = true;\\n    \", \"};\\n    var order = await orderService.GetOrderAsync(1, GlobalSetting.Instance.AuthToken);\\n    await \", \"orderViewModel.InitializeAsync(order);\\n\\n    Assert.True(invoked);\\n}\\n\\nThis unit test invokes the Init\", \"ializeAsync method of the OrderViewModel class, which causes its\\nOrder property to be updated. The u\", \"nit test will pass, provided that the PropertyChanged event is\\nraised for the Order property.\\n\\nTesti\", \"ng message-based communication\\n\\nView models that use the MessagingCenter class to communicate betwee\", \"n loosely-coupled classes\\ncan be unit tested by subscribing to the message being sent by the code un\", \"der test, as demonstrated\\nin the following code example:\\n\\n[Fact]\\npublic void AddCatalogItemCommandSe\", \"ndsAddProductMessageTest()\\n{\\n    bool messageReceived = false;\\n    var catalogService = new CatalogM\", \"ockService();\\n    var catalogViewModel = new CatalogViewModel(catalogService);\\n\\n    Xamarin.Forms.Me\", \"ssagingCenter.Subscribe<CatalogViewModel, CatalogItem>(\\n        this, MessageKeys.AddProduct, (sende\", \"r, arg) =>\\n    {\\n        messageReceived = true;\\n    });\\n    catalogViewModel.AddCatalogItemCommand.\", \"Execute(null);\\n\\n    Assert.True(messageReceived);\\n}\\n\\nThis unit test checks that the CatalogViewModel\", \" publishes the AddProduct message in response to\\nits AddCatalogItemCommand being executed. Because t\", \"he MessagingCenter class supports multicast\\nmessage subscriptions, the unit test can subscribe to th\", \"e AddProduct message and execute a callback\\ndelegate in response to receiving it. This callback dele\", \"gate, specified as a lambda expression, sets a\\nboolean field that's used by the Assert statement to \", \"verify the behavior of the test.\\n\\nTesting exception handling\\n\\nUnit tests can also be written that ch\", \"eck that specific exceptions are thrown for invalid actions or\\ninputs, as demonstrated in the follow\", \"ing code example:\\n\\n[Fact]\\npublic void InvalidEventNameShouldThrowArgumentExceptionText()\\n{\\n    var b\", \"ehavior = new MockEventToCommandBehavior\\n    {\\n        EventName = \\\"OnItemTapped\\\"\\n    };\\n    var lis\", \"tView = new ListView();\\n\\n    Assert.Throws<ArgumentException>(() => listView.Behaviors.Add(behavior)\", \");\\n}\\n\\n89\\n\\nC HA PTER  11  |  Unit testing\\n\\n\\fThis unit test will throw an exception, because the ListV\", \"iew control does not have an event named\\nOnItemTapped. The Assert.Throws<T> method is a generic meth\", \"od where T is the type of the\\nexpected exception. The argument passed to the Assert.Throws<T> method\", \" is a lambda expression\\nthat will throw the exception. Therefore, the unit test will pass provided t\", \"hat the lambda expression\\nthrows an ArgumentException.\\n\\nTip: Avoid writing unit tests that examine e\", \"xception message strings\\n\\nException message strings might change over time, and so unit tests that r\", \"ely on their presence are\\nregarded as brittle.\\n\\nTesting validation\\n\\nThere are two aspects to testing\", \" the validation implementation: testing that any validation rules are\\ncorrectly implemented, and tes\", \"ting that the ValidatableObject<T> class performs as expected.\\n\\nValidation logic is usually simple t\", \"o test, because it is typically a self-contained process where the\\noutput depends on the input. Ther\", \"e should be tests on the results of invoking the Validate method\\non each property that has at least \", \"one associated validation rule, as demonstrated in the following\\ncode example:\\n\\n[Fact]\\npublic void C\", \"heckValidationPassesWhenBothPropertiesHaveDataTest()\\n{\\n    var mockViewModel = new MockViewModel();\\n\", \"    mockViewModel.Forename.Value = \\\"John\\\";\\n    mockViewModel.Surname.Value = \\\"Smith\\\";\\n\\n    bool isVa\", \"lid = mockViewModel.Validate();\\n\\n    Assert.True(isValid);\\n}\\n\\nThis unit test checks that validation \", \"succeeds when the two ValidatableObject<T> properties in the\\nMockViewModel instance both have data.\\n\", \"\\nAs well as checking that validation succeeds, validation unit tests should also check the values of\", \" the\\nValue, IsValid, and Errors property of each ValidatableObject<T> instance, to verify that the\\nc\", \"lass performs as expected. The following code example demonstrates a unit test that does this:\\n\\n[Fac\", \"t]\\npublic void CheckValidationFailsWhenOnlyForenameHasDataTest()\\n{\\n    var mockViewModel = new MockV\", \"iewModel();\\n    mockViewModel.Forename.Value = \\\"John\\\";\\n\\n    bool isValid = mockViewModel.Validate();\", \"\\n\\n    Assert.False(isValid);\\n    Assert.NotNull(mockViewModel.Forename.Value);\\n    Assert.Null(mockV\", \"iewModel.Surname.Value);\\n    Assert.True(mockViewModel.Forename.IsValid);\\n    Assert.False(mockViewM\", \"odel.Surname.IsValid);\\n    Assert.Empty(mockViewModel.Forename.Errors);\\n    Assert.NotEmpty(mockView\", \"Model.Surname.Errors);\\n}\\n\\n90\\n\\nC HA PTER  11  |  Unit testing\\n\\n\\fThis unit test checks that validation\", \" fails when the Surname property of the MockViewModel doesn't\\nhave any data, and the Value, IsValid,\", \" and Errors property of each ValidatableObject<T> instance\\nare correctly set.\\n\\nSummary\\n\\nA unit test \", \"takes a small unit of the app, typically a method, isolates it from the remainder of the code,\\nand v\", \"erifies that it behaves as expected. Its goal is to check that each unit of functionality performs a\", \"s\\nexpected, so that errors don't propagate throughout the app.\\n\\nThe behavior of an object under test\", \" can be isolated by replacing dependent objects with mock\\nobjects that simulate the behavior of the \", \"dependent objects. This enables unit tests to be executed\\nwithout requiring unwieldy resources such \", \"as web services, or databases.\\n\\nTesting models and view models from MVVM applications is identical t\", \"o testing any other classes, and\\nthe same tools and techniques can be used.\\n\\n91\\n\\nC HA PTER  11  |  U\", \"nit testing\\n\\n\\f92\\n\\nC HA PTER  11  |  Unit testing\\n\\n\"]"