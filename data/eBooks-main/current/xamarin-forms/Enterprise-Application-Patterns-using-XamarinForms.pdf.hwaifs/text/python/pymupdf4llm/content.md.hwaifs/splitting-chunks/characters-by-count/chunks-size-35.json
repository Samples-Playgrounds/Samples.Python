"[\"# Book title\\n\\n### Book subtitle Author Name\\n\\n\\nPUBLISHED BY\\n\\nDevDiv, .NET and Visual Studio produc te\", \"ams\\nA division of Microsoft Corporation\\nOne Microsoft Way\\nRedmond, Washington 98052-6399\\n\\n\\nCopyright\", \" \\u00a9 2017 by Microsoft Corporation\\n\\n\\nAll rights reserved. No part of the contents of this book may be \", \"reproduced or transmitted in any\\nform or by any means without the written permission of the publishe\", \"r.\\n\\n\\nThis book is provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The views, opinion\", \"s and\\ninformation expressed in this book, including URL and other Internet website references, may c\", \"hange\\nwithout notice.\\n\\n\\nSome examples depicted herein are provided for illustration only and are fic\", \"titious. No real association\\nor connection is intended or should be inferred.\\n\\n\\nMicrosoft and the tr\", \"ademarks listed at http://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are\\ntrademarks of the Micros\", \"oft group of companies. All other marks are property of their respective\\nowners.\\n\\n\\n**Author:** David\", \" Britch\\n**Developer:** Javier Suarez Ruiz (Plain Concepts)\\n**Participants and reviewers:** Craig Dun\", \"n, Tom Opgenorth\\n**Editor:** John Meade (Populus Group)\\n\\n\\n# Contents\\n\\n**Preface ....................\", \"....................................................................................................\", \"... iv**\\n\\n**Purpose ................................................................................\", \".................................................. iv**\\n\\nWhat's left out of this guide's scope .....\", \"......................................................................................... iv\\nWho sho\", \"uld use this guide .................................................................................\", \"............................ iv\\nHow to use this guide ..............................................\", \"........................................................................ v\\n\\n\\n**Introduction ........\", \"....................................................................................................\", \"........ 1**\\n\\n**Sample application .................................................................\", \".................................................. 2**\\n\\nSample application architecture.............\", \"......................................................................................... 2\\nMobile a\", \"pp .................................................................................................\", \"...................................... 4\\n**eShopOnContainers.Core project** ........................\", \"........................................................................... 5\\n**Platform projects** \", \"....................................................................................................\", \"........................ 6\\n**Summary ...............................................................\", \".................................................................. 6**\\n\\n\\n**MVVM ....................\", \"....................................................................................................\", \"..... 7**\\n\\n**The MVVM pattern ......................................................................\", \"............................................ 7**\\n\\nView .............................................\", \"....................................................................................................\", \" 8\\nViewModel .......................................................................................\", \"................................................ 8\\nModel ...........................................\", \"....................................................................................................\", \" 9\\n**Connecting view models to views ...............................................................\", \".............................. 9**\\n\\nCreating a view model declaratively ............................\", \".................................................................10\\nCreating a view model programmat\", \"ically .....................................................................................10\\nCreat\", \"ing a view defined as a data template ..............................................................\", \"....................11\\nAutomatically creating a view model with a view model locator ...............\", \"..................................11\\n**Updating views in response to changes in the underlying view \", \"model or model ....................... 12**\\n**UI interaction using commands and behaviors ..........\", \".............................................................. 13**\\n\\nImplementing commands .........\", \"....................................................................................................\", \".14\\nImplementing behaviors .........................................................................\", \".......................................15\\n**Summary ................................................\", \"............................................................................... 17**\\n\\n\\n**Dependency \", \"injection ..........................................................................................\", \".......... 18**\\n\\n**Introduction to dependency injection ............................................\", \"......................................... 18**\\n**Registration ......................................\", \"..................................................................................... 20**\\n**Resolut\", \"ion ................................................................................................\", \".............................. 22**\\n**Managing the lifetime of resolved objects ....................\", \"........................................................... 22**\\n**Summary .........................\", \"....................................................................................................\", \".. 23**\\n\\n\\ni\\n\\n\\n**Communicating between loosely coupled components ...................................\", \"............... 24**\\n\\n**Introduction to MessagingCenter ............................................\", \"................................................ 24**\\n**Defining a message..........................\", \"....................................................................................... 26**\\n**Publi\", \"shing a message ....................................................................................\", \".......................... 26**\\n**Subscribing to a message .........................................\", \"............................................................... 27**\\n**Unsubscribing from a message.\", \"............................................................................................... 27**\", \"\\n**Summary .........................................................................................\", \"...................................... 27**\\n\\n\\n**Navigation .........................................\", \"............................................................................ 28**\\n\\n**Navigating betw\", \"een pages ..........................................................................................\", \"............ 29**\\n\\nCreating the NavigationService instance .........................................\", \"..............................................29\\nHandling navigation requests ......................\", \"..................................................................................30\\nNavigating when\", \" the app is launched ...............................................................................\", \"............32\\nPassing parameters during navigation ................................................\", \"..........................................33\\nInvoking navigation using behaviors ...................\", \"..........................................................................34\\nConfirming or cancellin\", \"g navigation .......................................................................................\", \".......34\\n**Summary ................................................................................\", \"............................................... 35**\\n\\n\\n**Validation ................................\", \"...................................................................................... 36**\\n\\n**Speci\", \"fying validation rules .............................................................................\", \"......................... 37**\\n**Adding validation rules to a property .............................\", \"......................................................... 38**\\n**Triggering validation .............\", \".................................................................................................. 3\", \"9**\\n\\nTriggering validation manually ................................................................\", \"......................................39\\nTriggering validation when properties change...............\", \"...............................................................40\\n**Displaying validation errors ...\", \"................................................................................................. 40\", \"**\\n\\nHighlighting a control that contains invalid data ..............................................\", \"............................41\\nDisplaying error messages ...........................................\", \"..................................................................44\\n**Summary .....................\", \"....................................................................................................\", \"...... 45**\\n\\n\\n**Configuration management ...........................................................\", \"................................ 46**\\n\\n**Creating a settings class .................................\", \"......................................................................... 46**\\n**Adding a setting ..\", \"....................................................................................................\", \"............... 47**\\n**Data binding to user settings ...............................................\", \"................................................... 48**\\n**Summary .................................\", \".............................................................................................. 50**\\n\", \"\\n\\n**Containerized microservices ....................................................................\", \"....................... 51**\\n\\n**Microservices ......................................................\", \"................................................................... 52**\\n**Containerization ........\", \"....................................................................................................\", \"......... 53**\\n**Communication between client and microservices ....................................\", \".............................. 55**\\n**Communication between microservices ..........................\", \"........................................................ 56**\\n**Summary ............................\", \"................................................................................................... \", \"58**\\n\\n\\n**Authentication and authorization ..........................................................\", \"........................ 59**\\n\\n**Authentication ....................................................\", \"................................................................... 59**\\n\\nIssuing bearer tokens usin\", \"g IdentityServer 4 ................................................................................6\", \"0\\nAdding IdentityServer to a web application .......................................................\", \"...........................60\\nConfiguring IdentityServer ...........................................\", \".................................................................61\\n\\n\\nii\\n\\n\\nPerforming authentication\", \" ...................................................................................................\", \".........64\\n**Authorization ........................................................................\", \"................................................. 69**\\n\\nConfiguring IdentityServer to perform author\", \"ization ...................................................................70\\nMaking access requests\", \" to APIs ...........................................................................................\", \"..........71\\n**Summary .............................................................................\", \".................................................. 71**\\n\\n\\n**Accessing remote data ..................\", \"................................................................................. 73**\\n\\n**Introducti\", \"on to Representational State Transfer...............................................................\", \"....... 73**\\n**Consuming RESTful APIs ..............................................................\", \"........................................... 74**\\n\\nMaking web requests ..............................\", \"......................................................................................74\\n**Caching d\", \"ata ................................................................................................\", \".......................... 81**\\n\\nManaging data expiration ..........................................\", \"...................................................................82\\nCaching images ...............\", \"....................................................................................................\", \"...........82\\n**Increasing resilience ..............................................................\", \"................................................. 83**\\n\\nRetry pattern ..............................\", \"...................................................................................................8\", \"3\\nCircuit breaker pattern ..........................................................................\", \"........................................84\\n**Summary ...............................................\", \"................................................................................ 85**\\n\\n\\n**Unit testi\", \"ng .................................................................................................\", \"................... 86**\\n\\n**Dependency injection and unit testing ..................................\", \".................................................. 86**\\n**Testing MVVM applications ................\", \".................................................................................... 87**\\n\\nTesting a\", \"synchronous functionality...........................................................................\", \"....................88\\nTesting INotifyPropertyChanged implementations...............................\", \"........................................88\\nTesting message-based communication .....................\", \"..................................................................89\\nTesting exception handling ....\", \"....................................................................................................\", \"....89\\nTesting validation ..........................................................................\", \"................................................90\\n**Summary .......................................\", \"........................................................................................ 91**\\n\\n\\niii\\n\", \"\\n\\n# Preface\\n\\n#### Purpose\\n\\nThis eBook provides guidance on building cross-platform enterprise apps u\", \"sing Xamarin.Forms.\\nXamarin.Forms is a cross-platform UI toolkit that allows developers to easily cr\", \"eate native user\\ninterface layouts that can be shared across platforms, including iOS, Android, and \", \"the Universal\\nWindows Platform (UWP). It provides a comprehensive solution for Business to Employee \", \"(B2E),\\nBusiness to Business (B2B), and Business to Consumer (B2C) apps, providing the ability to sha\", \"re code\\nacross all target platforms and helping to lower the total cost of ownership (TCO).\\n\\n\\nThe gu\", \"ide provides architectural guidance for developing adaptable, maintainable, and testable\\nXamarin.For\", \"ms enterprise apps. Guidance is provided on how to implement MVVM, dependency\\ninjection, navigation,\", \" validation, and configuration management, while maintaining loose coupling. In\\naddition, there's al\", \"so guidance on performing authentication and authorization with IdentityServer,\\naccessing data from \", \"containerized microservices, and unit testing.\\n\\n\\n[The guide comes with source code for the eShopOnCo\", \"ntainers mobile app, and source code for the](https://github.com/dotnet-architecture/eShopOnContaine\", \"rs/tree/master/src/Mobile)\\n[eShopOnContainers reference app. The eShopOnContainers mobile app is a c\", \"ross-platform enterprise](https://github.com/dotnet-architecture/eShopOnContainers)\\napp developed us\", \"ing Xamarin.Forms, which connects to a series of containerized microservices known\\nas the eShopOnCon\", \"tainers reference app. However, the eShopOnContainers mobile app can be\\nconfigured to consume data f\", \"rom mock services for those who wish to avoid deploying the\\ncontainerized microservices.\\n##### **Wha\", \"t's left out of this guide's scope**\\n\\nThis guide is aimed at readers who are already familiar with X\", \"amarin.Forms. For a detailed\\nintroduction to Xamarin.Forms, see the [Xamarin.Forms documentation](ht\", \"tps://developer.xamarin.com/guides/xamarin-forms/) on the Xamarin Developer\\n[Center, and Creating Mo\", \"bile Apps with Xamarin.Forms.](https://aka.ms/xamebook)\\n\\n\\n[The guide is complementary to .NET Micros\", \"ervices: Architecture for Containerized .NET Applications,](https://aka.ms/microservicesebook)\\nwhich\", \" focuses on developing and deploying containerized microservices. Other guides worth reading\\ninclude\", \" [Architecting and Developing Modern Web Applications with ASP.NET Core and Microsoft](http://aka.ms\", \"/WebAppEbook)\\n[Azure,](http://aka.ms/WebAppEbook) [Containerized Docker Application Lifecycle with M\", \"icrosoft Platform and Tools, and Microsoft](http://aka.ms/dockerlifecycleebook)\\n[Platform and Tools \", \"for Mobile App Development.](http://aka.ms/MobAppDev/StndPDF)\\n##### **Who should use this guide**\\n\\nT\", \"he audience for this guide is mainly developers and architects who would like to learn how to\\narchit\", \"ect and implement cross-platform enterprise apps using Xamarin.Forms.\\n\\n\\niv Preface\\n\\n\\nA secondary aud\", \"ience is technical decision makers who would like to receive an architectural and\\ntechnology overvie\", \"w before deciding on what approach to select for cross-platform enterprise app\\ndevelopment using Xam\", \"arin.Forms.\\n##### **How to use this guide**\\n\\nThis guide focuses on building cross-platform enterpris\", \"e apps using Xamarin.Forms. As such, it should\\nbe read in its entirety to provide a foundation of un\", \"derstanding such apps and their technical\\nconsiderations. The guide, along with its sample app, can \", \"also serve as a starting point or reference for\\ncreating a new enterprise app. Use the associated sa\", \"mple app as a template for the new app, or to see\\nhow to organize an app's component parts. Then, re\", \"fer back to this guide for architectural guidance.\\n\\n\\nFeel free to forward this guide to team members\", \" to help ensure a common understanding of crossplatform enterprise app development using Xamarin.For\", \"ms. Having everybody working from a\\ncommon set of terminologies and underlying principles will help \", \"ensure a consistent application of\\narchitectural patterns and practices.\\n\\n\\nv Preface\\n\\n\\n# Introductio\", \"n\\n\\nRegardless of platform, developers of enterprise apps face several challenges:\\n\\n\\n  - App requirem\", \"ents that can change over time.\\n\\n  - New business opportunities and challenges.\\n\\n  - Ongoing feedbac\", \"k during development that can significantly affect the scope and\\nrequirements of the app.\\n\\n\\nWith the\", \"se in mind, it's important to build apps that can be easily modified or extended over time.\\nDesignin\", \"g for such adaptability can be difficult as it requires an architecture that allows individual\\nparts\", \" of the app to be independently developed and tested in isolation without affecting the rest of\\nthe \", \"app.\\n\\n\\nMany enterprise apps are sufficiently complex to require more than one developer. It can be a\", \"\\nsignificant challenge to decide how to design an app so that multiple developers can work effective\", \"ly\\non different pieces of the app independently, while ensuring that the pieces come together seamle\", \"ssly\\nwhen integrated into the app.\\n\\n\\nThe traditional approach to designing and building an app resul\", \"ts in what is referred to as a\\n_monolithic_ app, where components are tightly coupled with no clear \", \"separation between them.\\nTypically, this monolithic approach leads to apps that are difficult and in\", \"efficient to maintain, because\\nit can be difficult to resolve bugs without breaking other components\", \" in the app, and it can be\\ndifficult to add new features or to replace existing features.\\n\\n\\nAn effec\", \"tive remedy for these challenges is to partition an app into discrete, loosely coupled\\ncomponents th\", \"at can be easily integrated together into an app. Such an approach offers several\\nbenefits:\\n\\n\\n  - It\", \" allows individual functionality to be developed, tested, extended, and maintained by\\ndifferent indi\", \"viduals or teams.\\n\\n\\n  - It promotes reuse and a clean separation of concerns between the app's horiz\", \"ontal\\ncapabilities, such as authentication and data access, and the vertical capabilities, such as a\", \"pp\\nspecific business functionality. This allows the dependencies and interactions between app\\ncompon\", \"ents to be more easily managed.\\n\\n\\n  - It helps maintain a separation of roles by allowing different \", \"individuals, or teams, to focus on\\na specific task or piece of functionality according to their expe\", \"rtise. In particular, it provides a\\ncleaner separation between the user interface and the app's busi\", \"ness logic.\\n\\n\\nHowever, there are many issues that must be resolved when partitioning an app into dis\", \"crete, loosely\\ncoupled components. These include:\\n\\n\\n  - Deciding how to provide a clean separation o\", \"f concerns between the user interface controls\\nand their logic. One of the most important decisions \", \"when creating a Xamarin.Forms\\nenterprise app is whether to place business logic in code-behind files\", \", or whether to create a\\nclean separation of concerns between the user interface controls and their \", \"logic, in order to\\n\\n\\n1 CHAPTER 1 | Introduction\\n\\n\\nmake the app more maintainable and testable. For m\", \"ore information, see Model-ViewViewModel.\\n\\n\\n  - Determining whether to use a dependency injection co\", \"ntainer. Dependency injection\\ncontainers reduce the dependency coupling between objects by providing\", \" a facility to\\nconstruct instances of classes with their dependencies injected, and manage their lif\", \"etime\\nbased on the configuration of the container. For more information, see Dependency injection.\\n\\n\", \"\\n  - Choosing between platform provided eventing and loosely coupled message-based\\ncommunication bet\", \"ween components that are inconvenient to link by object and type\\nreferences. For more information, s\", \"ee Introduction to Communicating between loosely\\ncoupled components.\\n\\n\\n  - Deciding how to navigate \", \"between pages, including how to invoke navigation, and where\\nnavigation logic should reside. For mor\", \"e information, see Navigation.\\n\\n\\n  - Determining how to validate user input for correctness. The dec\", \"ision must include how to\\nvalidate user input, and how to notify the user about validation errors. F\", \"or more information,\\nsee Validation.\\n\\n\\n  - Deciding how to perform authentication, and how to protec\", \"t resources with authorization. For\\nmore information, see Authentication and authorization.\\n\\n\\n  - De\", \"termining how to access remote data from web services, including how to reliably retrieve\\ndata, and \", \"how to cache data. For more information, see Accessing remote data.\\n\\n\\n  - Deciding how to test the a\", \"pp. For more information, see Unit testing.\\n\\n\\nThis guide provides guidance on these issues, and focu\", \"ses on the core patterns and architecture for\\nbuilding a cross-platform enterprise app using Xamarin\", \".Forms. The guidance aims to help to produce\\nadaptable, maintainable, and testable code, by addressi\", \"ng common Xamarin.Forms enterprise app\\ndevelopment scenarios, and by separating the concerns of pres\", \"entation, presentation logic, and\\nentities through support for the Model-View-ViewModel (MVVM) patte\", \"rn.\\n#### Sample application\\n\\n\\nThis guide includes a sample application, eShopOnContainers, that's an\", \" online store that includes the\\nfollowing functionality:\\n\\n\\n  - Authenticating and authorizing agains\", \"t a backend service.\\n\\n  - Browsing a catalog of shirts, coffee mugs, and other marketing items.\\n\\n  -\", \" Filtering the catalog.\\n\\n  - Ordering items from the catalog.\\n\\n  - Viewing the user's order history.\", \"\\n\\n  - Configuration of settings.\\n##### **Sample application architecture**\\n\\nFigure 1-1 provides a hi\", \"gh-level overview of the architecture of the sample application.\\n\\n\\n2 CHAPTER 1 | Introduction\\n\\n\\n**Fi\", \"gure 1-1** : eShopOnContainers high-level architecture\\n\\n\\nThe sample application ships with three cli\", \"ent apps:\\n\\n\\n  - An MVC application developed with ASP.NET Core.\\n\\n  - A Single Page Application (SPA)\", \" developed with Angular 2 and Typescript. This approach for\\nweb applications avoids performing a rou\", \"nd-trip to the server with each operation.\\n\\n\\n  - A mobile app developed with Xamarin.Forms, which su\", \"pports iOS, Android, and the Universal\\nWindows Platform (UWP).\\n\\n\\n[For information about the web appl\", \"ications, see Architecting and Developing Modern Web](http://aka.ms/WebAppEbook)\\n[Applications with \", \"ASP.NET Core and Microsoft Azure.](http://aka.ms/WebAppEbook)\\n\\n\\nThe sample application includes the \", \"following backend services:\\n\\n\\n  - An identity microservice, which uses ASP.NET Core Identity and Ide\", \"ntityServer.\\n\\n  - A catalog microservice, which is a data-driven create, read, update, delete (CRUD)\", \" service that\\nconsumes an SQL Server database using EntityFramework Core.\\n\\n\\n  - An ordering microser\", \"vice, which is a domain-driven service that uses domain-driven design\\npatterns.\\n\\n\\n  - A basket micro\", \"service, which is a data-driven CRUD service that uses Redis Cache.\\n\\n\\nThese backend services are imp\", \"lemented as microservices using ASP.NET Core MVC, and are\\ndeployed as unique containers within a sin\", \"gle Docker host. Collectively, these backend services are\\nreferred to as the eShopOnContainers refer\", \"ence application. Client apps communicate with the\\nbackend services through a Representational State\", \" Transfer (REST) web interface. For more\\ninformation about microservices and Docker, see Containeriz\", \"ed microservices.\\n\\n\\n[For information about the implementation of the backend services, see .NET Micr\", \"oservices:](https://aka.ms/microservicesebook)\\n[Architecture for Containerized .NET Applications.](h\", \"ttps://aka.ms/microservicesebook)\\n\\n\\n3 CHAPTER 1 | Introduction\\n\\n\\n##### **Mobile app**\\n\\nThis guide fo\", \"cuses on building cross-platform enterprise apps using Xamarin.Forms, and uses the\\neShopOnContainers\", \" mobile app as an example. Figure 1-2 shows the pages from the\\neShopOnContainers mobile app that pro\", \"vide the functionality outlined earlier.\\n\\n\\n**Figure 1-2** : The eShopOnContainers mobile app\\n\\n\\nThe m\", \"obile app consumes the backend services provided by the eShopOnContainers reference\\napplication. How\", \"ever, it can be configured to consume data from mock services for those who wish to\\navoid deploying \", \"the backend services.\\n\\n\\nThe eShopOnContainers mobile app exercises the following Xamarin.Forms funct\", \"ionality:\\n\\n\\n  - XAML\\n\\n  - Controls\\n\\n  - Bindings\\n\\n  - Converters\\n\\n  - Styles\\n\\n\\n4 CHAPTER 1 | Introdu\", \"ction\\n\\n\\n  - Animations\\n\\n  - Commands\\n\\n  - Behaviors\\n\\n  - Triggers\\n\\n  - Effects\\n\\n  - Custom Renderers\", \"\\n\\n  - MessagingCenter\\n\\n  - Custom Controls\\n\\n\\nFor more information about this functionality, see the \", \"[Xamarin.Forms documentation](https://developer.xamarin.com/guides/xamarin-forms/) on the Xamarin\\n[D\", \"eveloper Center, and Creating Mobile Apps with Xamarin.Forms.](https://aka.ms/xamebook)\\n\\n\\nIn additio\", \"n, unit tests are provided for some of the classes in the eShopOnContainers mobile app.\\n\\n**Mobile ap\", \"p solution**\\n\\nThe eShopOnContainers mobile app solution organizes the source code and other resource\", \"s into\\nprojects. All of the projects use folders to organize the source code and other resources int\", \"o\\ncategories. The following table outlines the projects that make up the eShopOnContainers mobile\\nap\", \"p:\\n\\n|Project|Description|\\n|---|---|\\n|eShopOnContainers.Core|This project is the portable class libra\", \"ry (PCL) project<br>that contains the shared code and shared UI.|\\n|eShopOnContainers.Droid|This proj\", \"ect holds Android specific code and is the<br>entry point for the Android app.|\\n|eShopOnContainers.i\", \"OS|This project holds iOS specific code and is the entry<br>point for the iOS app.|\\n|eShopOnContaine\", \"rs.UWP|This project holds Universal Windows Platform (UWP)<br>specific code and is the entry point f\", \"or the Windows<br>app.|\\n|eShopOnContainers.TestRunner.Droid|This project is the Android test runner \", \"for the<br>eShopOnContainers.UnitTests project.|\\n|eShopOnContainers.TestRunner.iOS|This project is t\", \"he iOS test runner for the<br>eShopOnContainers.UnitTests project.|\\n|eShopOnContainers.TestRunner.Wi\", \"ndows|This project is the Universal Windows Platform test<br>runner for the eShopOnContainers.UnitTe\", \"sts project.|\\n|eShopOnContainers.UnitTests<br>|This project contains unit tests for the<br>eShopOnCo\", \"ntainers.Core project.|\\n\\n\\n\\nThe classes from the eShopOnContainers mobile app can be re-used in any X\", \"amarin.Forms app with\\nlittle or no modification.\\n##### **eShopOnContainers.Core project**\\n\\nThe eShop\", \"OnContainers.Core PCL project contains the following folders:\\n\\n\\n5 CHAPTER 1 | Introduction\\n\\n\\n|Folder\", \"|Description|\\n|---|---|\\n|Animations|Contains classes that enable animations to be consumed in XAML.|\", \"\\n|Behaviors|Contains behaviors that are exposed to view classes.|\\n|Controls|Contains custom controls\", \" used by the app.|\\n|Converters|Contains value converters that apply custom logic to a binding.|\\n|Eff\", \"ects|Contains the`EntryLineColorEffect` class, which is used to change the border<br>color of specif\", \"ic`Entry` controls.|\\n|Exceptions|Contains the custom`ServiceAuthenticationException`.|\\n|Extensions|C\", \"ontains extension methods for the`VisualElement` and`IEnumerable<T>` classes.|\\n|Helpers|Contains hel\", \"per classes for the app.|\\n|Models|Contains the model classes for the app.|\\n|Properties|Contains`Asse\", \"mblyInfo.cs`, a .NET assembly metadata file.|\\n|Services|Contains interfaces and classes that impleme\", \"nt services that are provided to the<br>app.|\\n|Triggers|Contains the`BeginAnimation` trigger, which \", \"is used to invoke an animation in<br>XAML.|\\n|Validations|Contains classes involved in validating dat\", \"a input.|\\n|ViewModels|Contains the application logic that's exposed to pages.|\\n|Views<br>|Contains t\", \"he pages for the app.|\\n\\n##### **Platform projects**\\n\\nThe platform projects contain effect implementa\", \"tions, custom renderer implementations, and other\\nplatform-specific resources.\\n#### Summary\\n\\n\\nXamari\", \"n's cross-platform mobile app development tools and platforms provide a comprehensive\\nsolution for B\", \"2E, B2B, and B2C mobile client apps, providing the ability to share code across all target\\nplatforms\", \" (iOS, Android, and Windows) and helping to lower the total cost of ownership. Apps can\\nshare their \", \"user interface and app logic code, while retaining the native platform look and feel.\\n\\n\\nDevelopers o\", \"f enterprise apps face several challenges that can alter the architecture of the app during\\ndevelopm\", \"ent. Therefore, it's important to build an app so that it can be modified or extended over\\ntime. Des\", \"igning for such adaptability can be difficult, but typically involves partitioning an app into\\ndiscr\", \"ete, loosely coupled components that can be easily integrated together into an app.\\n\\n\\n6 CHAPTER 1 | \", \"Introduction\\n\\n\\n# MVVM\\n\\nThe Xamarin.Forms developer experience typically involves creating a user int\", \"erface in XAML, and then\\nadding code-behind that operates on the user interface. As apps are modifie\", \"d, and grow in size and\\nscope, complex maintenance issues can arise. These issues include the tight \", \"coupling between the UI\\ncontrols and the business logic, which increases the cost of making UI modif\", \"ications, and the difficulty\\nof unit testing such code.\\n\\n\\nThe Model-View-ViewModel (MVVM) pattern he\", \"lps to cleanly separate the business and presentation\\nlogic of an application from its user interfac\", \"e (UI). Maintaining a clean separation between application\\nlogic and the UI helps to address numerou\", \"s development issues and can make an application easier\\nto test, maintain, and evolve. It can also g\", \"reatly improve code re-use opportunities and allows\\ndevelopers and UI designers to more easily colla\", \"borate when developing their respective parts of an\\napp.\\n#### The MVVM pattern\\n\\n\\nThere are three cor\", \"e components in the MVVM pattern: the model, the view, and the view model.\\nEach serves a distinct pu\", \"rpose. Figure 2-1 shows the relationships between the three components.\\n\\n\\n**Figure 2-1** : The MVVM \", \"pattern\\n\\n\\nIn addition to understanding the responsibilities of each components, it's also important \", \"to\\nunderstand how they interact with each other. At a high level, the view \\\"knows about\\\" the view mo\", \"del,\\nand the view model \\\"knows about\\\" the model, but the model is unaware of the view model, and the\", \"\\nview model is unaware of the view. Therefore, the view model isolates the view from the model, and\\n\", \"allows the model to evolve independently of the view.\\n\\n\\nThe benefits of using the MVVM pattern are a\", \"s follows:\\n\\n\\n  - If there's an existing model implementation that encapsulates existing business log\", \"ic, it can\\nbe difficult or risky to change it. In this scenario, the view model acts as an adapter f\", \"or the\\nmodel classes and enables you to avoid making any major changes to the model code.\\n\\n\\n7 CHAPTE\", \"R 2 | MVVM\\n\\n\\n  - Developers can create unit tests for the view model and the model, without using th\", \"e view.\\nThe unit tests for the view model can exercise exactly the same functionality as used by the\", \"\\nview.\\n\\n\\n  - The app UI can be redesigned without touching the code, provided that the view is\\nimple\", \"mented entirely in XAML. Therefore, a new version of the view should work with the\\nexisting view mod\", \"el.\\n\\n\\n  - Designers and developers can work independently and concurrently on their components\\ndurin\", \"g the development process. Designers can focus on the view, while developers can work\\non the view mo\", \"del and model components.\\n\\n\\nThe key to using MVVM effectively lies in understanding how to factor ap\", \"p code into the correct\\nclasses, and in understanding how the classes interact. The following sectio\", \"ns discuss the\\nresponsibilities of each of the classes in the MVVM pattern.\\n##### **View**\\n\\nThe view\", \" is responsible for defining the structure, layout, and appearance of what the user sees on\\nscreen. \", \"Ideally, each view is defined in XAML, with a limited code-behind that does not contain\\nbusiness log\", \"ic. However, in some cases, the code-behind might contain UI logic that implements\\nvisual behavior t\", \"hat is difficult to express in XAML, such as animations.\\n\\n\\nIn a Xamarin.Forms application, a view is\", \" typically a `Page` -derived or `ContentView` -derived class.\\nHowever, views can also be represented\", \" by a data template, which specifies the UI elements to be\\nused to visually represent an object when\", \" it's displayed. A data template as a view does not have any\\ncode-behind, and is designed to bind to\", \" a specific view model type.\\n\\n\\n\\n\\n\\nThere are several options for executing code on the view model in \", \"response to interactions on the\\nview, such as a button click or item selection. If a control support\", \"s commands, the control's `Command`\\nproperty can be data-bound to an `ICommand` property on the view\", \" model. When the control's\\ncommand is invoked, the code in the view model will be executed. In addit\", \"ion to commands,\\nbehaviors can be attached to an object in the view and can listen for either a comm\", \"and to be invoked\\nor event to be raised. In response, the behavior can then invoke an `ICommand` on \", \"the view model or a\\nmethod on the view model.\\n##### **ViewModel**\\n\\nThe view model implements propert\", \"ies and commands to which the view can data bind to, and\\nnotifies the view of any state changes thro\", \"ugh change notification events. The properties and\\ncommands that the view model provides define the \", \"functionality to be offered by the UI, but the view\\ndetermines how that functionality is to be displ\", \"ayed.\\n\\n\\n\\n\\n\\n8 CHAPTER 2 | MVVM\\n\\n\\nThe view model is also responsible for coordinating the view's inter\", \"actions with any model classes that\\nare required. There's typically a one-to-many relationship betwe\", \"en the view model and the model\\nclasses. The view model might choose to expose model classes directl\", \"y to the view so that controls in\\nthe view can data bind directly to them. In this case, the model c\", \"lasses will need to be designed to\\nsupport data binding and change notification events.\\n\\n\\nEach view \", \"model provides data from a model in a form that the view can easily consume. To\\naccomplish this, the\", \" view model sometimes performs data conversion. Placing this data conversion in\\nthe view model is a \", \"good idea because it provides properties that the view can bind to. For example,\\nthe view model migh\", \"t combine the values of two properties to make it easier for display by the view.\\n\\n\\n\\n\\n\\nIn order for \", \"the view model to participate in two-way data binding with the view, its properties must\\nraise the `\", \"PropertyChanged` event. View models satisfy this requirement by implementing the\\n`INotifyPropertyCha\", \"nged` interface, and raising the `PropertyChanged` event when a property is\\nchanged.\\n\\n\\nFor collectio\", \"ns, the view-friendly `ObservableCollection<T>` is provided. This collection implements\\ncollection c\", \"hanged notification, relieving the developer from having to implement the\\n`INotifyCollectionChanged`\", \" interface on collections.\\n##### **Model**\\n\\nModel classes are non-visual classes that encapsulate th\", \"e app's data. Therefore, the model can be\\nthought of as representing the app's domain model, which u\", \"sually includes a data model along with\\nbusiness and validation logic. Examples of model objects inc\", \"lude data transfer objects (DTOs), Plain\\nOld CLR Objects (POCOs), and generated entity and proxy obj\", \"ects.\\n\\n\\nModel classes are typically used in conjunction with services or repositories that encapsula\", \"te data\\naccess and caching.\\n#### Connecting view models to views\\n\\n\\nView models can be connected to v\", \"iews by using the data-binding capabilities of Xamarin.Forms.\\nThere are many approaches that can be \", \"used to construct views and view models and associate them\\nat runtime. These approaches fall into tw\", \"o categories, known as view first composition, and view\\nmodel first composition. Choosing between vi\", \"ew first composition and view model first composition is\\nan issue of preference and complexity. Howe\", \"ver, all approaches share the same aim, which is for the\\nview to have a view model assigned to its `\", \"BindingContext` property.\\n\\n\\nWith view first composition the app is conceptually composed of views th\", \"at connect to the view\\nmodels they depend on. The primary benefit of this approach is that it makes \", \"it easy to construct\\nloosely coupled, unit testable apps because the view models have no dependence \", \"on the views\\nthemselves. It's also easy to understand the structure of the app by following its visu\", \"al structure,\\nrather than having to track code execution to understand how classes are created and a\", \"ssociated. In\\naddition, view first construction aligns with the Xamarin.Forms navigation system that\", \"'s responsible\\nfor constructing pages when navigation occurs, which makes a view model first composi\", \"tion complex\\nand misaligned with the platform.\\n\\n\\n9 CHAPTER 2 | MVVM\\n\\n\\nWith view model first composit\", \"ion the app is conceptually composed of view models, with a service\\nbeing responsible for locating t\", \"he view for a view model. View model first composition feels more\\nnatural to some developers, since \", \"the view creation can be abstracted away, allowing them to focus\\non the logical non-UI structure of \", \"the app. In addition, it allows view models to be created by other\\nview models. However, this approa\", \"ch is often complex and it can become difficult to understand how\\nthe various parts of the app are c\", \"reated and associated.\\n\\n\\n\\n\\n\\nThe following sections discuss the main approaches to connecting view mo\", \"dels to views.\\n##### **Creating a view model declaratively**\\n\\nThe simplest approach is for the view \", \"to declaratively instantiate its corresponding view model in\\nXAML. When the view is constructed, the\", \" corresponding view model object will also be constructed.\\nThis approach is demonstrated in the foll\", \"owing code example:\\n\\n\\nWhen the `ContentPage` is created, an instance of the `LoginViewModel` is auto\", \"matically constructed\\nand set as the view's `BindingContext` .\\n\\n\\nThis declarative construction and a\", \"ssignment of the view model by the view has the advantage that\\nit's simple, but has the disadvantage\", \" that it requires a default (parameter-less) constructor in the view\\nmodel.\\n##### **Creating a view \", \"model programmatically**\\n\\nA view can have code in the code-behind file that results in the view mode\", \"l being assigned to its\\nBindingContext property. This is often accomplished in the view's constructo\", \"r, as shown in the\\nfollowing code example:\\n\\n\\nThe programmatic construction and assignment of the vie\", \"w model within the view's code-behind has\\nthe advantage that it's simple. However, the main disadvan\", \"tage of this approach is that the view\\nneeds to provide the view model with any required dependencie\", \"s. Using a dependency injection\\ncontainer can help to maintain loose coupling between the view and v\", \"iew model. For more\\ninformation, see Dependency injection.\\n\\n\\n10 CHAPTER 2 | MVVM\\n\\n\\n##### **Creating \", \"a view defined as a data template**\\n\\nA view can be defined as a data template and associated with a \", \"view model type. Data templates can\\nbe defined as resources, or they can be defined inline within th\", \"e control that will display the view\\nmodel. The content of the control is the view model instance, a\", \"nd the data template is used to visually\\nrepresent it. This technique is an example of a situation i\", \"n which the view model is instantiated first,\\nfollowed by the creation of the view.\\n##### **Automati\", \"cally creating a view model with a view model locator**\\n\\nA view model locator is a custom class that\", \" manages the instantiation of view models and their\\nassociation to views. In the eShopOnContainers m\", \"obile app, the `ViewModelLocator` class has an\\nattached property, `AutoWireViewModel`, that's used t\", \"o associate view models with views. In the view's\\nXAML, this attached property is set to `true` to i\", \"ndicate that the view model should be automatically\\nconnected to the view, as shown in the following\", \" code example:\\n\\n```\\n viewModelBase:ViewModelLocator.AutoWireViewModel=\\\"true\\\"\\n\\n```\\n\\nThe `AutoWireView\", \"Model` property is a bindable property that's initialized to `false`, and when its\\nvalue changes the\", \" `OnAutoWireViewModelChanged` event handler is called. This method resolves the\\nview model for the v\", \"iew. The following code example shows how this is achieved:\\n\\n\\nThe `OnAutoWireViewModelChanged` metho\", \"d attempts to resolve the view model using a conventionbased approach. This convention assumes that:\", \"\\n\\n\\n  - View models are in the same assembly as view types.\\n\\n  - Views are in a .Views child namespac\", \"e.\\n\\n  - View models are in a .ViewModels child namespace.\\n\\n  - View model names correspond with view\", \" names and end with \\\"ViewModel\\\".\\n\\n\\n11 CHAPTER 2 | MVVM\\n\\n\\nFinally, the `OnAutoWireViewModelChanged` m\", \"ethod sets the `BindingContext` of the view type to the\\nresolved view model type. For more informati\", \"on about resolving the view model type, see Resolution.\\n\\n\\nThis approach has the advantage that an ap\", \"p has a single class that is responsible for the instantiation\\nof view models and their connection t\", \"o views.\\n\\n\\n\\n\\n#### Updating views in response to changes in the underlying view model or model\\n\\nAll v\", \"iew model and model classes that are accessible to a view should implement the\\n`INotifyPropertyChang\", \"ed` interface. Implementing this interface in a view model or model class\\nallows the class to provid\", \"e change notifications to any data-bound controls in the view when the\\nunderlying property value cha\", \"nges.\\n\\n\\nApp's should be architected for the correct use of property change notification, by meeting \", \"the\\nfollowing requirements:\\n\\n\\n  - Always raising a `PropertyChanged` event if a public property's va\", \"lue changes. Do not assume\\nthat raising the `PropertyChanged` event can be ignored because of knowle\", \"dge of how XAML\\nbinding occurs.\\n\\n\\n  - Always raising a `PropertyChanged` event for any calculated pr\", \"operties whose values are used\\nby other properties in the view model or model.\\n\\n\\n  - Always raising \", \"the `PropertyChanged` event at the end of the method that makes a property\\nchange, or when the objec\", \"t is known to be in a safe state. Raising the event interrupts the\\noperation by invoking the event's\", \" handlers synchronously. If this happens in the middle of an\\noperation, it might expose the object t\", \"o callback functions when it is in an unsafe, partially\\nupdated state. In addition, it's possible fo\", \"r cascading changes to be triggered by\\n`PropertyChanged` events. Cascading changes generally require\", \" updates to be complete\\nbefore the cascading change is safe to execute.\\n\\n\\n  - Never raising a `Prope\", \"rtyChanged` event if the property does not change. This means that you\\nmust compare the old and new \", \"values before raising the `PropertyChanged` event.\\n\\n\\n  - Never raising the `PropertyChanged` event d\", \"uring a view model's constructor if you are\\ninitializing a property. Data-bound controls in the view\", \" will not have subscribed to receive\\nchange notifications at this point.\\n\\n\\n  - Never raising more th\", \"an one `PropertyChanged` event with the same property name\\nargument within a single synchronous invo\", \"cation of a public method of a class. For example,\\ngiven a `NumberOfItems` property whose backing st\", \"ore is the `_numberOfItems` field, if a\\nmethod increments `_numberOfItems` fifty times during the ex\", \"ecution of a loop, it should only\\nraise property change notification on the `NumberOfItems` property\", \" once, after all the work is\\ncomplete. For asynchronous methods, raise the `PropertyChanged` event f\", \"or a given property\\nname in each synchronous segment of an asynchronous continuation chain.\\n\\n\\nThe eS\", \"hopOnContainers mobile app uses the `ExtendedBindableObject` class to provide change\\nnotifications, \", \"which is shown in the following code example:\\n\\n\\n12 CHAPTER 2 | MVVM\\n\\n\\nXamarin.Form's `BindableObject\", \"` class implements the `INotifyPropertyChanged` interface, and\\nprovides an `OnPropertyChanged` metho\", \"d. The `ExtendedBindableObject` class provides the\\n`RaisePropertyChanged` method to invoke property \", \"change notification, and in doing so uses the\\nfunctionality provided by the `BindableObject` class.\\n\", \"\\n\\nEach view model class in the eShopOnContainers mobile app derives from the `ViewModelBase` class,\\n\", \"which in turn derives from the `ExtendedBindableObject` class. Therefore, each view model class uses\", \"\\nthe `RaisePropertyChanged` method in the `ExtendedBindableObject` class to provide property\\nchange \", \"notification. The following code example shows how the eShopOnContainers mobile app\\ninvokes property\", \" change notification by using a lambda expression:\\n\\n\\nNote that using a lambda expression in this way\", \" involves a small performance cost because the\\nlambda expression has to be evaluated for each call. \", \"Although the performance cost is small and\\nwould not normally impact an app, the costs can accrue wh\", \"en there are many change notifications.\\nHowever, the benefit of this approach is that it provides co\", \"mpile-time type safety and refactoring\\nsupport when renaming properties.\\n#### UI interaction using c\", \"ommands and behaviors\\n\\n\\nIn mobile apps, actions are typically invoked in response to a user action, \", \"such as a button click, that\\ncan be implemented by creating an event handler in the code-behind file\", \". However, in the MVVM\\npattern, the responsibility for implementing the action lies with the view mo\", \"del, and placing code in\\nthe code-behind should be avoided.\\n\\n\\nCommands provide a convenient way to r\", \"epresent actions that can be bound to controls in the UI.\\nThey encapsulate the code that implements \", \"the action, and help to keep it decoupled from its visual\\nrepresentation in the view. Xamarin.Forms \", \"includes controls that can be declaratively connected to a\\ncommand, and these controls will invoke t\", \"he command when the user interacts with the control.\\n\\n\\n13 CHAPTER 2 | MVVM\\n\\n\\nBehaviors also allow co\", \"ntrols to be declaratively connected to a command. However, behaviors can be\\nused to invoke an actio\", \"n that's associated with a range of events raised by a control. Therefore,\\nbehaviors address many of\", \" the same scenarios as command-enabled controls, while providing a\\ngreater degree of flexibility and\", \" control. In addition, behaviors can also be used to associate command\\nobjects or methods with contr\", \"ols that were not specifically designed to interact with commands.\\n##### **Implementing commands**\\n\\n\", \"View models typically expose command properties, for binding from the view, that are object\\ninstance\", \"s that implement the `ICommand` interface. A number of Xamarin.Forms controls provide a\\n`Command` pr\", \"operty, which can be data bound to an `ICommand` object provided by the view model. The\\n`ICommand` i\", \"nterface defines an `Execute` method, which encapsulates the operation itself, a\\n`CanExecute` method\", \", which indicates whether the command can be invoked, and a\\n`CanExecuteChanged` event that occurs wh\", \"en changes occur that affect whether the command should\\nexecute. The `Command` and `Command<T>` clas\", \"ses, provided by Xamarin.Forms, implement the `ICommand`\\ninterface, where `T` is the type of the arg\", \"uments to `Execute` and `CanExecute` .\\n\\n\\nWithin a view model, there should be an object of type `Com\", \"mand` or `Command<T>` for each public\\nproperty in the view model of type `ICommand` . The `Command` \", \"or `Command<T>` constructor requires an\\n`Action` callback object that's called when the `ICommand.Ex\", \"ecute` method is invoked. The\\n`CanExecute` method is an optional constructor parameter, and is a `Fu\", \"nc` that returns a `bool` .\\n\\n\\nThe following code shows how a `Command` instance, which represents a \", \"register command, is\\nconstructed by specifying a delegate to the `Register` view model method:\\n\\n```\\n\", \" public ICommand RegisterCommand => new Command(Register);\\n\\n```\\n\\nThe command is exposed to the view \", \"through a property that returns a reference to an `ICommand` .\\nWhen the `Execute` method is called o\", \"n the `Command` object, it simply forwards the call to the method\\nin the view model via the delegate\", \" that was specified in the `Command` constructor.\\n\\n\\nAn asynchronous method can be invoked by a comma\", \"nd by using the `async` and `await` keywords\\nwhen specifying the command's `Execute` delegate. This \", \"indicates that the callback is a `Task` and\\nshould be awaited. For example, the following code shows\", \" how a `Command` instance, which represents\\na sign-in command, is constructed by specifying a delega\", \"te to the `SignInAsync` view model method:\\n\\n```\\n public ICommand SignInCommand => new Command(async \", \"() => await SignInAsync());\\n\\n```\\n\\nParameters can be passed to the `Execute` and `CanExecute` actions\", \" by using the `Command<T>` class to\\ninstantiate the command. For example, the following code shows h\", \"ow a `Command<T>` instance is used\\nto indicate that the `NavigateAsync` method will require an argum\", \"ent of type `string` :\\n\\n```\\n public ICommand NavigateCommand => new Command<string>(NavigateAsync);\\n\", \"\\n```\\n\\nIn both the `Command` and `Command<T>` classes, the delegate to the `CanExecute` method in eac\", \"h\\nconstructor is optional. If a delegate isn't specified, the `Command` will return `true` for `CanE\", \"xecute` .\\nHowever, the view model can indicate a change in the command's `CanExecute` status by call\", \"ing the\\n`ChangeCanExecute` method on the `Command` object. This causes the `CanExecuteChanged` event\", \" to be\\nraised. Any controls in the UI that are bound to the command will then update their enabled s\", \"tatus to\\nreflect the availability of the data-bound command.\\n\\n\\n14 CHAPTER 2 | MVVM\\n\\n\\n**Invoking comm\", \"ands from a view**\\n\\nThe following code example shows how a `Grid` in the `LoginView` binds to the `R\", \"egisterCommand` in\\nthe `LoginViewModel` class by using a `TapGestureRecognizer` instance:\\n\\n\\nA comman\", \"d parameter can also be optionally defined using the `CommandParameter` property. The\\ntype of the ex\", \"pected argument is specified in the `Execute` and `CanExecute` target methods. The\\n`TapGestureRecogn\", \"izer` will automatically invoke the target command when the user interacts with\\nthe attached control\", \". The command parameter, if provided, will be passed as the argument to the\\ncommand's `Execute` dele\", \"gate.\\n##### **Implementing behaviors**\\n\\nBehaviors allow functionality to be added to UI controls wit\", \"hout having to subclass them. Instead, the\\nfunctionality is implemented in a behavior class and atta\", \"ched to the control as if it was part of the\\ncontrol itself. Behaviors enable you to implement code \", \"that you would normally have to write as\\ncode-behind, because it directly interacts with the API of \", \"the control, in such a way that it can be\\nconcisely attached to the control, and packaged for reuse \", \"across more than one view or app. In the\\ncontext of MVVM, behaviors are a useful approach for connec\", \"ting controls to commands.\\n\\n\\nA behavior that's attached to a control through attached properties is \", \"known as an _attached behavior_ .\\nThe behavior can then use the exposed API of the element to which \", \"it is attached to add functionality\\nto that control, or other controls, in the visual tree of the vi\", \"ew. The eShopOnContainers mobile app\\ncontains the `LineColorBehavior` class, which is an attached be\", \"havior. For more information about\\nthis behavior, see Displaying validation errors.\\n\\n\\nA Xamarin.Form\", \"s behavior is a class that derives from the `Behavior` or `Behavior<T>` class, where `T` is\\nthe type\", \" of the control to which the behavior should apply. These classes provide `OnAttachedTo` and\\n`OnDeta\", \"chingFrom` methods, which should be overridden to provide logic that will be executed when\\nthe behav\", \"ior is attached to and detached from controls.\\n\\n\\nIn the eShopOnContainers mobile app, the `BindableB\", \"ehavior<T>` class derives from the\\n`Behavior<T>` class. The purpose of the `BindableBehavior<T>` cla\", \"ss is to provide a base class for\\nXamarin.Forms behaviors that require the `BindingContext` of the b\", \"ehavior to be set to the attached\\ncontrol.\\n\\n\\nThe `BindableBehavior<T>` class provides an overridable\", \" `OnAttachedTo` method that sets the\\n`BindingContext` of the behavior, and an overridable `OnDetachi\", \"ngFrom` method that cleans up the\\n`BindingContext` . In addition, the class stores a reference to th\", \"e attached control in the\\n`AssociatedObject` property.\\n\\n\\nThe eShopOnContainers mobile app includes a\", \"n `EventToCommandBehavior` class, which executes a\\ncommand in response to an event occurring. This c\", \"lass derives from the `BindableBehavior<View>`\\nclass so that the behavior can bind to and execute an\", \" `ICommand` specified by a `Command` property\\nwhen the behavior is consumed. The following code exam\", \"ple shows the `EventToCommandBehavior`\\nclass:\\n\\n\\n15 CHAPTER 2 | MVVM\\n\\n\\nThe `OnAttachedTo` and `OnDeta\", \"chingFrom` methods are used to register and deregister an event\\nhandler for the event defined in the\", \" `EventName` property. Then, when the event fires, the `OnFired`\\nmethod is invoked, which executes t\", \"he command.\\n\\n\\nThe advantage of using the `EventToCommandBehavior` to execute a command when an event\", \" fires, is\\nthat commands can be associated with controls that weren't designed to interact with comm\", \"ands. In\\naddition, this moves event-handling code to view models, where it can be unit tested.\\n\\n**In\", \"voking behaviors from a view**\\n\\nThe `EventToCommandBehavior` is particularly useful for attaching a \", \"command to a control that\\ndoesn't support commands. For example, the `ProfileView` uses the `EventTo\", \"CommandBehavior` to\\nexecute the `OrderDetailCommand` when the `ItemTapped` event fires on the `ListV\", \"iew` that lists the\\nuser's orders, as shown in the following code:\\n\\n\\n16 CHAPTER 2 | MVVM\\n\\n\\nAt runtim\", \"e, the `EventToCommandBehavior` will respond to interaction with the `ListView` . When an\\nitem is se\", \"lected in the `ListView`, the `ItemTapped` event will fire, which will execute the\\n`OrderDetailComma\", \"nd` in the `ProfileViewModel` . By default, the event arguments for the event are\\npassed to the comm\", \"and. This data is converted as it's passed between source and target by the\\nconverter specified in t\", \"he `EventArgsConverter` property, which returns the `Item` of the `ListView`\\nfrom the I `temTappedEv\", \"entArgs` . Therefore, when the `OrderDetailCommand` is executed, the selected\\n`Order` is passed as a\", \" parameter to the registered `Action` .\\n\\n\\n[For more information about behaviors, see Behaviors on th\", \"e Xamarin Developer Center.](https://developer.xamarin.com/guides/xamarin-forms/application-fundamen\", \"tals/behaviors/)\\n#### Summary\\n\\n\\nThe Model-View-ViewModel (MVVM) pattern helps to cleanly separate th\", \"e business and presentation\\nlogic of an application from its user interface (UI). Maintaining a clea\", \"n separation between application\\nlogic and the UI helps to address numerous development issues and c\", \"an make an application easier\\nto test, maintain, and evolve. It can also greatly improve code re-use\", \" opportunities and allows\\ndevelopers and UI designers to more easily collaborate when developing the\", \"ir respective parts of an\\napp.\\n\\n\\nUsing the MVVM pattern, the UI of the app and the underlying presen\", \"tation and business logic is\\nseparated into three separate classes: the view, which encapsulates the\", \" UI and UI logic; the view\\nmodel, which encapsulates presentation logic and state; and the model, wh\", \"ich encapsulates the app's\\nbusiness logic and data.\\n\\n\\n17 CHAPTER 2 | MVVM\\n\\n\\n# Dependency injection\\n\\n\", \"Typically, a class constructor is invoked when instantiating an object, and any values that the obje\", \"ct\\nneeds are passed as arguments to the constructor. This is an example of dependency injection, and\", \"\\nspecifically is known as _constructor injection_ . The dependencies the object needs are injected i\", \"nto the\\nconstructor.\\n\\n\\nBy specifying dependencies as interface types, dependency injection enables d\", \"ecoupling of the\\nconcrete types from the code that depends on these types. It generally uses a conta\", \"iner that holds a\\nlist of registrations and mappings between interfaces and abstract types, and the \", \"concrete types that\\nimplement or extend these types.\\n\\n\\nThere are also other types of dependency inje\", \"ction, such as _property setter injection_, and _method call_\\n_injection_, but they are less commonl\", \"y seen. Therefore, this chapter will focus solely on performing\\nconstructor injection with a depende\", \"ncy injection container.\\n#### Introduction to dependency injection\\n\\n\\nDependency injection is a speci\", \"alized version of the Inversion of Control (IoC) pattern, where the\\nconcern being inverted is the pr\", \"ocess of obtaining the required dependency. With dependency\\ninjection, another class is responsible \", \"for injecting dependencies into an object at runtime. The\\nfollowing code example shows how the `Prof\", \"ileViewModel` class is structured when using\\ndependency injection:\\n\\n\\nThe `ProfileViewModel` construc\", \"tor receives an `IOrderService` instance as an argument, injected by\\nanother class. The only depende\", \"ncy in the `ProfileViewModel` class is on the interface type.\\nTherefore, the `ProfileViewModel` clas\", \"s doesn't have any knowledge of the class that's responsible for\\ninstantiating the `IOrderService` o\", \"bject. The class that's responsible for instantiating the\\n\\n\\n18 CHAPTER 3 | Dependency injection\\n\\n\\n`I\", \"OrderService` object, and inserting it into the `ProfileViewModel` class, is known as the _dependenc\", \"y_\\n_injection container_ .\\n\\n\\nDependency injection containers reduce the coupling between objects by \", \"providing a facility to\\ninstantiate class instances and manage their lifetime based on the configura\", \"tion of the container.\\nDuring the objects creation, the container injects any dependencies that the \", \"object requires into it. If\\nthose dependencies have not yet been created, the container creates and \", \"resolves their dependencies\\nfirst.\\n\\n\\nThere are several advantages to using a dependency injection co\", \"ntainer:\\n\\n\\n  - A container removes the need for a class to locate its dependencies and manage their\\n\", \"lifetimes.\\n\\n\\n  - A container allows mapping of implemented dependencies without affecting the class.\", \"\\n\\n  - A container facilitates testability by allowing dependencies to be mocked.\\n\\n  - A container in\", \"creases maintainability by allowing new classes to be easily added to the app.\\n\\n\\nIn the context of a\", \" Xamarin.Forms app that uses MVVM, a dependency injection container will\\ntypically be used for regis\", \"tering and resolving view models, and for registering services and injecting\\nthem into view models.\\n\", \"\\n\\nThere are many dependency injection containers available, with the eShopOnContainers mobile app\\nus\", \"ing Autofac to manage the instantiation of view model and service classes in the app. Autofac\\nfacili\", \"tates building loosely coupled apps, and provides all of the features commonly found in\\ndependency i\", \"njection containers, including methods to register type mappings and object instances,\\nresolve objec\", \"ts, manage object lifetimes, and inject dependent objects into constructors of objects\\nthat it resol\", \"ves. For more information about Autofac, see [Autofac](http://autofac.readthedocs.io/en/latest/index\", \".html) on readthedocs.io.\\n\\n\\nIn Autofac, the `IContainer` interface provides the dependency injection\", \" container. Figure 3-1 shows\\nthe dependencies when using this container, which instantiates an `IOrd\", \"erService` object and injects\\nit into the `ProfileViewModel` class.\\n\\n\\n**Figure 3-1:** Dependencies w\", \"hen using dependency injection\\n\\n\\n19 CHAPTER 3 | Dependency injection\\n\\n\\nAt runtime, the container mus\", \"t know which implementation of the `IOrderService` interface it should\\ninstantiate, before it can in\", \"stantiate a `ProfileViewModel` object. This involves:\\n\\n\\n  - The container deciding how to instantiat\", \"e an object that implements the `IOrderService`\\ninterface. This is known as _registration_ .\\n\\n\\n  - T\", \"he container instantiating the object that implements the `IOrderService` interface, and the\\n`Profil\", \"eViewModel` object. This is known as _resolution_ .\\n\\n\\nEventually, the app will finish using the `Pro\", \"fileViewModel` object and it will become available for\\ngarbage collection. At this point, the garbag\", \"e collector should dispose of the `IOrderService` instance\\nif other classes do not share the same in\", \"stance.\\n\\n\\n\\n\\n#### Registration\\n\\nBefore dependencies can be injected into an object, the types of the \", \"dependencies must first be\\nregistered with the container. Registering a type typically involves pass\", \"ing the container an interface\\nand a concrete type that implements the interface.\\n\\n\\nThere are two wa\", \"ys of registering types and objects in the container through code:\\n\\n\\n  - Register a type or mapping \", \"with the container. When required, the container will build an\\ninstance of the specified type.\\n\\n\\n  -\", \" Register an existing object in the container as a singleton. When required, the container will\\nretu\", \"rn a reference to the existing object.\\n\\n\\n\\n\\n\\nThe registration of types that require dependency inject\", \"ion should be performed in a single method in\\nan app, and this method should be invoked early in the\", \" app's lifecycle to ensure that the app is aware\\nof the dependencies between its classes. In the eSh\", \"opOnContainers mobile app this is performed by\\nthe `ViewModelLocator` class, which builds the `ICont\", \"ainer` object and is the only class in the app that\\nholds a reference to that object. The following \", \"code example shows how the eShopOnContainers\\nmobile app declares the `IContainer` object in the `Vie\", \"wModelLocator` class:\\n\\n```\\n private static IContainer _container;\\n\\n```\\n\\nTypes and instances are regi\", \"stered in the `RegisterDependencies` method in the `ViewModelLocator`\\nclass. This is achieved by fir\", \"st creating a `ContainerBuilder` instance, which is demonstrated in the\\nfollowing code example:\\n\\n```\", \"\\n var builder = new ContainerBuilder();\\n\\n```\\n\\n20 CHAPTER 3 | Dependency injection\\n\\n\\nTypes and instan\", \"ces are then registered with the `ContainerBuilder` object, and the following code\\nexample demonstra\", \"tes the most common form of type registration:\\n\\n```\\n builder.RegisterType<RequestProvider>().As<IReq\", \"uestProvider>();\\n\\n```\\n\\nThe `RegisterType` method shown here maps an interface type to a concrete typ\", \"e. It tells the\\ncontainer to instantiate a `RequestProvider` object when it instantiates an object t\", \"hat requires an\\ninjection of an `IRequestProvider` through a constructor.\\n\\n\\nConcrete types can also \", \"be registered directly without a mapping from an interface type, as shown in\\nthe following code exam\", \"ple:\\n\\n```\\n builder.RegisterType<ProfileViewModel>();\\n\\n```\\n\\nWhen the `ProfileViewModel` type is resol\", \"ved, the container will inject its required dependencies.\\n\\n\\nAutofac also allows instance registratio\", \"n, where the container is responsible for maintaining a\\nreference to a singleton instance of a type.\", \" For example, the following code example shows how the\\neShopOnContainers mobile app registers the co\", \"ncrete type to use when a `ProfileViewModel`\\ninstance requires an `IOrderService` instance:\\n\\n```\\n bu\", \"ilder.RegisterType<OrderService>().As<IOrderService>().SingleInstance();\\n\\n```\\n\\nThe `RegisterType` me\", \"thod shown here maps an interface type to a concrete type. The\\n`SingleInstance` method configures th\", \"e registration so that every dependent object receives the\\nsame shared instance. Therefore, only a s\", \"ingle `OrderService` instance will exist in the container,\\nwhich is shared by objects that require a\", \"n injection of an `IOrderService` through a constructor.\\n\\n\\nInstance registration can also be perform\", \"ed with the `RegisterInstance` method, which is\\ndemonstrated in the following code example:\\n\\n```\\n bu\", \"ilder.RegisterInstance(new OrderMockService()).As<IOrderService>();\\n\\n```\\n\\nThe `RegisterInstance` met\", \"hod shown here creates a new `OrderMockService` instance and registers\\nit with the container. Theref\", \"ore, only a single `OrderMockService` instance exists in the container,\\nwhich is shared by objects t\", \"hat require an injection of an `IOrderService` through a constructor.\\n\\n\\nFollowing type and instance \", \"registration, the `IContainer` object must be built, which is demonstrated\\nin the following code exa\", \"mple:\\n\\n```\\n _container = builder.Build();\\n\\n```\\n\\nInvoking the `Build` method on the `ContainerBuilder\", \"` instance builds a new dependency injection\\ncontainer that contains the registrations that have bee\", \"n made.\\n\\n\\n\\n\\n\\n21 CHAPTER 3 | Dependency injection\\n\\n\\n#### Resolution\\n\\nAfter a type is registered, it c\", \"an be resolved or injected as a dependency. When a type is being\\nresolved and the container needs to\", \" create a new instance, it injects any dependencies into the\\ninstance.\\n\\n\\nGenerally, when a type is r\", \"esolved, one of three things happens:\\n\\n\\n**1.** If the type hasn't been registered, the container thr\", \"ows an exception.\\n\\n\\n**2.** If the type has been registered as a singleton, the container returns the\", \" singleton instance. If\\n\\nthis is the first time the type is called for, the container creates it if \", \"required, and maintains a\\nreference to it.\\n\\n\\n**3.** If the type hasn't been registered as a singleto\", \"n, the container returns a new instance, and\\n\\ndoesn't maintain a reference to it.\\n\\n\\nThe following co\", \"de example shows how the `RequestProvider` type that was previously registered\\nwith Autofac can be r\", \"esolved:\\n\\n```\\n var requestProvider = _container.Resolve<IRequestProvider>();\\n\\n```\\n\\nIn this example, \", \"Autofac is asked to resolve the concrete type for the `IRequestProvider` type, along\\nwith any depend\", \"encies. Typically, the `Resolve` method is called when an instance of a specific type is\\nrequired. F\", \"or information about controlling the lifetime of resolved objects, see Managing the lifetime\\nof reso\", \"lved objects.\\n\\n\\nThe following code example shows how the eShopOnContainers mobile app instantiates v\", \"iew model\\ntypes and their dependencies:\\n\\n```\\n var viewModel = _container.Resolve(viewModelType);\\n\\n``\", \"`\\n\\nIn this example, Autofac is asked to resolve the view model type for a requested view model, and \", \"the\\ncontainer will also resolve any dependencies. When resolving the `ProfileViewModel` type, the\\nde\", \"pendency to resolve is an `IOrderService` object. Therefore, Autofac first constructs an\\n`OrderServi\", \"ce` object and then passes it to the constructor of the `ProfileViewModel` class. For more\\ninformati\", \"on about how the eShopOnContainers mobile app constructs view models and associates\\nthem to views, s\", \"ee Automatically creating a view model with a view model locator.\\n\\n#### Managing the lifetime of res\", \"olved objects\\n\\n\\nAfter registering a type, the default behavior for Autofac is to create a new instan\", \"ce of the registered\\ntype each time the type is resolved, or when the dependency mechanism injects i\", \"nstances into other\\nclasses. In this scenario, the container doesn't hold a reference to the resolve\", \"d object. However, when\\nregistering an instance, the default behavior for Autofac is to manage the l\", \"ifetime of the object as a\\nsingleton. Therefore, the instance remains in scope while the container i\", \"s in scope, and is disposed\\nwhen the container goes out of scope and is garbage collected, or when c\", \"ode explicitly disposes the\\ncontainer.\\n\\n\\n22 CHAPTER 3 | Dependency injection\\n\\n\\nAn Autofac instance s\", \"cope can be used to specify the singleton behavior for an object that Autofac\\ncreates from a registe\", \"red type. Autofac instance scopes manage the object lifetimes instantiated by\\nthe container. The def\", \"ault instance scope for the `RegisterType` method is the\\n`InstancePerDependency` scope. However, the\", \" `SingleInstance` scope can be used with the\\n`RegisterType` method, so that the container creates or\", \" returns a singleton instance of a type when\\ncalling the `Resolve` method. The following code exampl\", \"e shows how Autofac is instructed to create a\\nsingleton instance of the `NavigationService` class:\\n\\n\", \"```\\n builder.RegisterType<NavigationService>().As<INavigationService>().SingleInstance();\\n\\n```\\n\\nThe \", \"first time that the `INavigationService` interface is resolved, the container creates a new\\n`Navigat\", \"ionService` object and maintains a reference to it. On any subsequent resolutions of the\\n`INavigatio\", \"nService` interface, the container returns a reference to the `NavigationService` object\\nthat was pr\", \"eviously created.\\n\\n\\n\\n\\n\\n[Autofac includes additional instance scopes. For more information, see Insta\", \"nce Scope](http://autofac.readthedocs.io/en/latest/lifetime/instance-scope.html) on\\nreadthedocs.io.\\n\", \"#### Summary\\n\\n\\nDependency injection enables decoupling of concrete types from the code that depends \", \"on these\\ntypes. It typically uses a container that holds a list of registrations and mappings betwee\", \"n interfaces\\nand abstract types, and the concrete types that implement or extend these types.\\n\\n\\nAuto\", \"fac facilitates building loosely coupled apps, and provides all of the features commonly found in\\nde\", \"pendency injection containers, including methods to register type mappings and object instances,\\nres\", \"olve objects, manage object lifetimes, and inject dependent objects into constructors of objects it\\n\", \"resolves.\\n\\n\\n23 CHAPTER 3 | Dependency injection\\n\\n\\n# Communicating between loosely coupled components\", \"\\n\\nThe publish-subscribe pattern is a messaging pattern in which publishers send messages without\\nhav\", \"ing knowledge of any receivers, known as subscribers. Similarly, subscribers listen for specific\\nmes\", \"sages, without having knowledge of any publishers.\\n\\n\\nEvents in .NET implement the publish-subscribe \", \"pattern, and are the most simple and straightforward\\napproach for a communication layer between comp\", \"onents if loose coupling is not required, such as a\\ncontrol and the page that contains it. However, \", \"the publisher and subscriber lifetimes are coupled by\\nobject references to each other, and the subsc\", \"riber type must have a reference to the publisher type.\\nThis can create memory management issues, es\", \"pecially when there are short lived objects that\\nsubscribe to an event of a static or long-lived obj\", \"ect. If the event handler isn't removed, the subscriber\\nwill be kept alive by the reference to it in\", \" the publisher, and this will prevent or delay the garbage\\ncollection of the subscriber.\\n#### Introd\", \"uction to MessagingCenter\\n\\n\\nThe Xamarin.Forms `MessagingCenter` class implements the publish-subscri\", \"be pattern, allowing\\nmessage-based communication between components that are inconvenient to link by\", \" object and type\\nreferences. This mechanism allows publishers and subscribers to communicate without\", \" having a\\nreference to each other, helping to reduce dependencies between components, while also all\", \"owing\\ncomponents to be independently developed and tested.\\n\\n\\nThe `MessagingCenter` class provides mu\", \"lticast publish-subscribe functionality. This means that there\\ncan be multiple publishers that publi\", \"sh a single message, and there can be multiple subscribers\\nlistening for the same message. Figure 4-\", \"1 illustrates this relationship:\\n\\n\\n24 CHAPTER 4 | Communicating between loosely coupled components\\n\\n\", \"\\n**Figure 4-1:** Multicast publish-subscribe functionality\\n\\n\\nPublishers send messages using the `Mes\", \"sagingCenter.Send` method, while subscribers listen for\\nmessages using the `MessagingCenter.Subscrib\", \"e` method. In addition, subscribers can also\\nunsubscribe from message subscriptions, if required, wi\", \"th the `MessagingCenter.Unsubscribe`\\nmethod.\\n\\n\\nInternally, the `MessagingCenter` class uses weak ref\", \"erences. This means that it will not keep objects\\nalive, and will allow them to be garbage collected\", \". Therefore, it should only be necessary to\\nunsubscribe from a message when a class no longer wishes\", \" to receive the message.\\n\\n\\nThe eShopOnContainers mobile app uses the `MessagingCenter` class to comm\", \"unicate between\\nloosely coupled components. The app defines three messages:\\n\\n\\n  - The `AddProduct` m\", \"essage is published by the `CatalogViewModel` class when an item is\\nadded to the shopping basket. In\", \" return, the `BasketViewModel` class subscribes to the\\nmessage and increments the number of items in\", \" the shopping basket in response. In addition,\\nthe `BasketViewModel` class also unsubscribes from th\", \"is message.\\n\\n\\n  - The `Filter` message is published by the `CatalogViewModel` class when the user ap\", \"plies a\\nbrand or type filter to the items displayed from the catalogue. In return, the `CatalogView`\", \"\\nclass subscribes to the message and updates the UI so that only items that match the filter\\ncriteri\", \"a are displayed.\\n\\n\\n  - The `ChangeTab` message is published by the `MainViewModel` class when the\\n`C\", \"heckoutViewModel` navigates to the `MainViewModel` following the successful creation and\\nsubmission \", \"of a new order. In return, the `MainView` class subscribes to the message and\\nupdates the UI so that\", \" the **My profile** tab is active, to show the user's orders.\\n\\n\\nIn the eShopOnContainers mobile app,\", \" `MessagingCenter` is used to update in the UI in response to\\nan action occurring in another class. \", \"Therefore, messages are published on the UI thread, with\\nsubscribers receiving the message on the sa\", \"me thread.\\n\\n\\n25 CHAPTER 4 | Communicating between loosley coupled components\\n\\n\\nFor more information \", \"about `MessagingCenter` [, see MessagingCenter](https://developer.xamarin.com/guides/xamarin-forms/a\", \"pplication-fundamentals/messaging-center/) on the Xamarin Developer\\nCenter.\\n#### Defining a message\\n\", \"\\n\\n`MessagingCenter` messages are strings that are used to identify messages. The following code\\nexam\", \"ple shows the messages defined within the eShopOnContainers mobile app:\\n\\n\\nIn this example, messages \", \"are defined using constants. The advantage of this approach is that it\\nprovides compile-time type sa\", \"fety and refactoring support.\\n#### Publishing a message\\n\\n\\nPublishers notify subscribers of a message\", \" with one of the `MessagingCenter.Send` overloads. The\\nfollowing code example demonstrates publishin\", \"g the `AddProduct` message:\\n\\n```\\n MessagingCenter.Send(this, MessengerKeys.AddProduct, catalogItem);\", \"\\n\\n```\\n\\nIn this example, the `Send` method specifies three arguments:\\n\\n\\n  - The first argument specif\", \"ies the sender class. The sender class must be specified by any\\nsubscribers who wish to receive the \", \"message.\\n\\n\\n  - The second argument specifies the message.\\n\\n  - The third argument specifies the payl\", \"oad data to be sent to the subscriber. In this case the\\npayload data is a `CatalogItem` instance.\\n\\n\\n\", \"The `Send` method will publish the message, and its payload data, using a fire-and-forget approach.\\n\", \"Therefore, the message is sent even if there are no subscribers registered to receive the message. I\", \"n\\nthis situation, the sent message is ignored.\\n\\n\\n26 CHAPTER 4 | Communicating between loosley couple\", \"d components\\n\\n\\n#### Subscribing to a message\\n\\nSubscribers can register to receive a message using on\", \"e of the `MessagingCenter.Subscribe`\\noverloads. The following code example demonstrates how the eSho\", \"pOnContainers mobile app\\nsubscribes to, and processes, the `AddProduct` message:\\n\\n\\nIn this example, \", \"the `Subscribe` method subscribes to the `AddProduct` message, and executes a\\ncallback delegate in r\", \"esponse to receiving the message. This callback delegate, specified as a lambda\\nexpression, executes\", \" code that updates the UI.\\n\\n\\n\\n\\n\\nA subscriber might not need to handle every instance of a published \", \"message, and this can be\\ncontrolled by the generic type arguments that are specified on the `Subscri\", \"be` method. In this\\nexample, the subscriber will only receive `AddProduct` messages that are sent fr\", \"om the\\n`CatalogViewModel` class, whose payload data is a `CatalogItem` instance.\\n#### Unsubscribing \", \"from a message\\n\\n\\nSubscribers can unsubscribe from messages they no longer want to receive. This is a\", \"chieved with one\\nof the `MessagingCenter.Unsubscribe` overloads, as demonstrated in the following co\", \"de example:\\n\\n```\\n MessagingCenter.Unsubscribe<CatalogViewModel, CatalogItem>(this, MessengerKeys.Add\", \"Product);\\n\\n```\\n\\nIn this example, the `Unsubscribe` method syntax reflects the type arguments specifi\", \"ed when\\nsubscribing to receive the `AddProduct` message.\\n#### Summary\\n\\n\\nThe Xamarin.Forms `Messaging\", \"Center` class implements the publish-subscribe pattern, allowing\\nmessage-based communication between\", \" components that are inconvenient to link by object and type\\nreferences. This mechanism allows publi\", \"shers and subscribers to communicate without having a\\nreference to each other, helping to reduce dep\", \"endencies between components, while also allowing\\ncomponents to be independently developed and teste\", \"d.\\n\\n\\n27 CHAPTER 4 | Communicating between loosley coupled components\\n\\n\\n# Navigation\\n\\nXamarin.Forms i\", \"ncludes support for page navigation, which typically results from the user's interaction\\nwith the UI\", \" or from the app itself as a result of internal logic-driven state changes. However,\\nnavigation can \", \"be complex to implement in apps that use the Model-View-ViewModel (MVVM)\\npattern, as the following c\", \"hallenges must be met:\\n\\n\\n  - How to identify the view to be navigated to, using an approach that doe\", \"s not introduce tight\\ncoupling and dependencies between views.\\n\\n\\n  - How to coordinate the process b\", \"y which the view to be navigated to is instantiated and\\ninitialized. When using MVVM, the view and v\", \"iew model need to be instantiated and\\nassociated with each other via the view's binding context. Whe\", \"n an app is using a\\ndependency injection container, the instantiation of views and view models might\", \" require a\\nspecific construction mechanism.\\n\\n\\n  - Whether to perform view-first navigation, or view \", \"model-first navigation. With view-first\\nnavigation, the page to navigate to refers to the name of th\", \"e view type. During navigation,\\nthe specified view is instantiated, along with its corresponding vie\", \"w model and other\\ndependent services. An alternative approach is to use view model-first navigation,\", \" where the\\npage to navigate to refers to the name of the view model type.\\n\\n\\n  - How to cleanly separ\", \"ate the navigational behavior of the app across the views and view\\nmodels. The MVVM pattern provides\", \" a separation between the app's UI and its presentation\\nand business logic. However, the navigation \", \"behavior of an app will often span the UI and\\npresentations parts of the app. The user will often in\", \"itiate navigation from a view, and the\\nview will be replaced as a result of the navigation. However,\", \" navigation might often also need\\nto be initiated or coordinated from within the view model.\\n\\n\\n  - H\", \"ow to pass parameters during navigation for initialization purposes. For example, if the user\\nnaviga\", \"tes to a view to update order details, the order data will have to be passed to the view\\nso that it \", \"can display the correct data.\\n\\n\\n  - How to co-ordinate navigation, to ensure that certain business r\", \"ules are obeyed. For example,\\nusers might be prompted before navigating away from a view so that the\", \"y can correct any\\ninvalid data or be prompted to submit or discard any data changes that were made w\", \"ithin the\\nview.\\n\\n\\nThis chapter addresses these challenges by presenting a `NavigationService` class \", \"that's used to\\nperform view model-first page navigation.\\n\\n\\n28 CHAPTER 5 | Navigation\\n\\n\\n#### Navigati\", \"ng between pages\\n\\nNavigation logic can reside in a view's code-behind, or in a data bound view model\", \". While placing\\nnavigation logic in a view might be the simplest approach, it is not easily testable\", \" through unit tests.\\nPlacing navigation logic in view model classes means that the logic can be exer\", \"cised through unit\\ntests. In addition, the view model can then implement logic to control navigation\", \" to ensure that\\ncertain business rules are enforced. For example, an app might not allow the user to\", \" navigate away\\nfrom a page without first ensuring that the entered data is valid.\\n\\n\\nA `NavigationSer\", \"vice` class is typically invoked from view models, in order to promote testability.\\nHowever, navigat\", \"ing to views from view models would require the view models to reference views,\\nand particularly vie\", \"ws that the active view model isn't associated with, which is not recommended.\\nTherefore, the `Navig\", \"ationService` presented here specifies the view model type as the target to\\nnavigate to.\\n\\n\\nThe eShop\", \"OnContainers mobile app uses the `NavigationService` class to provide view model-first\\nnavigation. T\", \"his class implements the `INavigationService` interface, which is shown in the following\\ncode exampl\", \"e:\\n\\n\\nThis interface specifies that an implementing class must provide the following methods:\\n\\n|Metho\", \"d|Purpose|\\n|---|---|\\n|`InitializeAsync`|Performs navigation to one of two pages when the app is<br>l\", \"aunched.|\\n|`NavigateToAsync<T>`|Performs hierarchical navigation to a specified page.|\\n|`NavigateToA\", \"sync<T>(parameter)`|Performs hierarchical navigation to a specified page, passing<br>a parameter.|\\n|\", \"`RemoveLastFromBackStackAsync`|Removes the previous page from the navigation stack.|\\n|`RemoveBackSta\", \"ckAsync`<br>|Removes all the previous pages from the navigation stack.|\\n\\n\\n\\nIn addition, the `INaviga\", \"tionService` interface specifies that an implementing class must provide a\\n`PreviousPageViewModel` p\", \"roperty. This property returns the view model type associated with the\\nprevious page in the navigati\", \"on stack.\\n\\n##### **Creating the NavigationService instance**\\n\\nThe `NavigationService` class, which i\", \"mplements the `INavigationService` interface, is registered as\\na singleton with the Autofac dependen\", \"cy injection container, as demonstrated in the following code\\nexample:\\n\\n\\n29 CHAPTER 5 | Navigation\\n\\n\", \"\\n```\\n builder.RegisterType<NavigationService>().As<INavigationService>().SingleInstance();\\n\\n```\\n\\nThe\", \" `INavigationService` interface is resolved in the `ViewModelBase` class constructor, as\\ndemonstrate\", \"d in the following code example:\\n\\n```\\n NavigationService = ViewModelLocator.Resolve<INavigationServi\", \"ce>();\\n\\n```\\n\\nThis returns a reference to the `NavigationService` object that's stored in the Autofac\", \" dependency\\ninjection container, which is created by the `InitNavigation` method in the `App` class.\", \" For more\\ninformation, see Navigating when the app is launched.\\n\\n\\nThe `ViewModelBase` class stores t\", \"he `NavigationService` instance in a `NavigationService` property,\\nof type `INavigationService` . Th\", \"erefore, all view model classes, which derive from the\\n`ViewModelBase` class, can use the `Navigatio\", \"nService` property to access the methods specified by\\nthe `INavigationService` interface. This avoid\", \"s the overhead of injecting the `NavigationService`\\nobject from the Autofac dependency injection con\", \"tainer into each view model class.\\n##### **Handling navigation requests**\\n\\nXamarin.Forms provides th\", \"e `NavigationPage` class, which implements a hierarchical navigation\\nexperience in which the user is\", \" able to navigate through pages, forwards and backwards, as desired.\\n[For more information about hie\", \"rarchical navigation, see Hierarchical Navigation](https://developer.xamarin.com/guides/xamarin-form\", \"s/application-fundamentals/navigation/hierarchical/) on the Xamarin\\nDeveloper Center.\\n\\n\\nRather than \", \"use the `NavigationPage` class directly, the eShopOnContainers app wraps the\\n`NavigationPage` class \", \"in the `CustomNavigationView` class, as shown in the following code example:\\n\\n\\nThe purpose of this w\", \"rapping is for ease of styling the `NavigationPage` instance inside the XAML file\\nfor the class.\\n\\n\\nN\", \"avigation is performed inside view model classes by invoking one of the `NavigateToAsync`\\nmethods, s\", \"pecifying the view model type for the page being navigated to, as demonstrated in the\\nfollowing code\", \" example:\\n\\n```\\n await NavigationService.NavigateToAsync<MainViewModel>();\\n\\n```\\n\\nThe following code e\", \"xample shows the `NavigateToAsync` methods provided by the\\n`NavigationService` class:\\n\\n\\n30 CHAPTER 5\", \" | Navigation\\n\\n\\nEach method allows any view model class that derives from the `ViewModelBase` class \", \"to perform\\nhierarchical navigation by invoking the `InternalNavigateToAsync` method. In addition, th\", \"e second\\n`NavigateToAsync` method enables navigation data to be specified as an argument that's pass\", \"ed to\\nthe view model being navigated to, where it's typically used to perform initialization. For mo\", \"re\\ninformation, see Passing parameters during navigation.\\n\\n\\nThe `InternalNavigateToAsync` method exe\", \"cutes the navigation request, and is shown in the\\nfollowing code example:\\n\\n\\n31 CHAPTER 5 | Navigatio\", \"n\\n\\n\\nThe `InternalNavigateToAsync` method performs navigation to a view model by first calling the\\n`C\", \"reatePage` method. This method locates the view that corresponds to the specified view model type,\\na\", \"nd creates and returns an instance of this view type. Locating the view that corresponds to the view\", \"\\nmodel type uses a convention-based approach, which assumes that:\\n\\n\\n  - Views are in the same assemb\", \"ly as view model types.\\n\\n  - Views are in a .Views child namespace.\\n\\n  - View models are in a .ViewM\", \"odels child namespace.\\n\\n  - View names correspond to view model names, with \\\"Model\\\" removed.\\n\\n\\nWhen \", \"a view is instantiated, it's associated with its corresponding view model. For more information\\nabou\", \"t how this occurs, see Automatically creating a view model with a view model locator.\\n\\n\\nIf the view \", \"being created is a `LoginView`, it's wrapped inside a new instance of the\\n`CustomNavigationView` cla\", \"ss and assigned to the `Application.Current.MainPage` property.\\nOtherwise, the `CustomNavigationView\", \"` instance is retrieved, and provided that it isn't `null`, the\\n`PushAsync` method is invoked to pus\", \"h the view being created onto the navigation stack. However, If\\nthe retrieved `CustomNavigationView`\", \" instance is `null`, the view being created is wrapped inside a\\nnew instance of the `CustomNavigatio\", \"nView` class and assigned to the\\n`Application.Current.MainPage` property. This mechanism ensures tha\", \"t during navigation, pages\\nare added correctly to the navigation stack both when it's empty, and whe\", \"n it contains data.\\n\\n\\n\\n\\n\\nAfter the view is created and navigated to, the `InitializeAsync` method of\", \" the view's associated\\nview model is executed. For more information, see Passing parameters during n\", \"avigation.\\n##### **Navigating when the app is launched**\\n\\nWhen the app is launched, the `InitNavigat\", \"ion` method in the `App` class is invoked. The following\\ncode example shows this method:\\n\\n\\nThe metho\", \"d creates a new `NavigationService` object in the Autofac dependency injection container,\\nand return\", \"s a reference to it, before invoking its `InitializeAsync` method.\\n\\n\\n32 CHAPTER 5 | Navigation\\n\\n\\nThe\", \" following code example shows the `NavigationService` `InitializeAsync` method:\\n\\n\\nThe `MainView` is \", \"navigated to if the app has a cached access token, which is used for authentication.\\nOtherwise, the \", \"`LoginView` is navigated to.\\n\\n\\nFor more information about the Autofac dependency injection container\", \", see Introduction to\\ndependency injection.\\n##### **Passing parameters during navigation**\\n\\nOne of t\", \"he `NavigateToAsync` methods, specified by the `INavigationService` interface, enables\\nnavigation da\", \"ta to be specified as an argument that's passed to the view model being navigated to,\\nwhere it's typ\", \"ically used to perform initialization.\\n\\n\\nFor example, the `ProfileViewModel` class contains an `Orde\", \"rDetailCommand` that's executed when\\nthe user selects an order on the `ProfileView` page. In turn, t\", \"his executes the `OrderDetailAsync`\\nmethod, which is shown in the following code example:\\n\\n\\nThis met\", \"hod invokes navigation to the `OrderDetailViewModel`, passing an `Order` instance that\\nrepresents th\", \"e order that the user selected on the `ProfileView` page. When the `NavigationService`\\nclass creates\", \" the `OrderDetailView`, the `OrderDetailViewModel` class is instantiated and assigned to\\nthe view's \", \"`BindingContext` . After navigating to the `OrderDetailView`, the\\n`InternalNavigateToAsync` method e\", \"xecutes the `InitializeAsync` method of the view's associated\\nview model.\\n\\n\\nThe `InitializeAsync` me\", \"thod is defined in the `ViewModelBase` class as a method that can be\\noverridden. This method specifi\", \"es an `object` argument that represents the data to be passed to a\\nview model during a navigation op\", \"eration. Therefore, view model classes that want to receive data\\nfrom a navigation operation provide\", \" their own implementation of the `InitializeAsync` method to\\nperform the required initialization. Th\", \"e following code example shows the `InitializeAsync` method\\nfrom the `OrderDetailViewModel` class:\\n\\n\", \"\\n33 CHAPTER 5 | Navigation\\n\\n\\nThis method retrieves the `Order` instance that was passed into the vie\", \"w model during the navigation\\noperation, and uses it to retrieve the full order details from the `Or\", \"derService` instance.\\n##### **Invoking navigation using behaviors**\\n\\nNavigation is usually triggered\", \" from a view by a user interaction. For example, the `LoginView`\\nperforms navigation following succe\", \"ssful authentication. The following code example shows how the\\nnavigation is invoked by a behavior:\\n\", \"\\n\\nAt runtime, the `EventToCommandBehavior` will respond to interaction with the `WebView` . When the\", \"\\n`WebView` navigates to a web page, the `Navigating` event will fire, which will execute the\\n`Naviga\", \"teCommand` in the `LoginViewModel` . By default, the event arguments for the event are passed\\nto the\", \" command. This data is converted as it's passed between source and target by the converter\\nspecified\", \" in the `EventArgsConverter` property, which returns the `Url` from the\\n`WebNavigatingEventArgs` . T\", \"herefore, when the `NavigationCommand` is executed, the `Url` of the web\\npage is passed as a paramet\", \"er to the registered `Action` .\\n\\n\\nIn turn, the `NavigationCommand` executes the `NavigateAsync` meth\", \"od, which is shown in the\\nfollowing code example:\\n\\n\\nThis method invokes navigation to the `MainViewM\", \"odel`, and following navigation, removes the\\n`LoginView` page from the navigation stack.\\n##### **Con\", \"firming or cancelling navigation**\\n\\nAn app might need to interact with the user during a navigation \", \"operation, so that the user can\\nconfirm or cancel navigation. This might be necessary, for example, \", \"when the user attempts to\\nnavigate before having fully completed a data entry page. In this situatio\", \"n, an app should provide a\\nnotification that allows the user to navigate away from the page, or to c\", \"ancel the navigation operation\\nbefore it occurs. This can be achieved in a view model class by using\", \" the response from a notification\\nto control whether or not navigation is invoked.\\n\\n\\n34 CHAPTER 5 | \", \"Navigation\\n\\n\\n#### Summary\\n\\nXamarin.Forms includes support for page navigation, which typically resul\", \"ts from the user's interaction\\nwith the UI, or from the app itself, as a result of internal logic-dr\", \"iven state changes. However,\\nnavigation can be complex to implement in apps that use the MVVM patter\", \"n.\\n\\n\\nThis chapter presented a `NavigationService` class, which is used to perform view model-first\\nn\", \"avigation from view models. Placing navigation logic in view model classes means that the logic can\\n\", \"be exercised through automated tests. In addition, the view model can then implement logic to\\ncontro\", \"l navigation to ensure that certain business rules are enforced.\\n\\n\\n35 CHAPTER 5 | Navigation\\n\\n\\n# Val\", \"idation\\n\\nAny app that accepts input from users should ensure that the input is valid. An app could, \", \"for\\nexample, check for input that contains only characters in a particular range, is of a certain le\", \"ngth, or\\nmatches a particular format. Without validation, a user can supply data that causes the app\", \" to fail.\\nValidation enforces business rules, and prevents an attacker from injecting malicious data\", \".\\n\\n\\nIn the context of the Model-ViewModel-Model (MVVM) pattern, a view model or model will often be\\n\", \"required to perform data validation and signal any validation errors to the view so that the user ca\", \"n\\ncorrect them. The eShopOnContainers mobile app performs synchronous client-side validation of view\", \"\\nmodel properties and notifies the user of any validation errors by highlighting the control that\\nco\", \"ntains the invalid data, and by displaying error messages that inform the user of why the data is\\nin\", \"valid. Figure 6-1 shows the classes involved in performing validation in the eShopOnContainers\\nmobil\", \"e app.\\n\\n\\n**Figure 6-1** : Validation classes in the eShopOnContainers mobile app\\n\\n\\nView model proper\", \"ties that require validation are of type `ValidatableObject<T>`, and each\\n`ValidatableObject<T>` ins\", \"tance has validation rules added to its `Validations` property. Validation\\nis invoked from the view \", \"model by calling the `Validate` method of the `ValidatableObject<T>`\\n\\n\\n36 CHAPTER 6 | Validation\\n\\n\\ni\", \"nstance, which retrieves the validation rules and executes them against the `ValidatableObject<T>`\\n`\", \"Value` property. Any validation errors are placed into the `Errors` property of the\\n`ValidatableObje\", \"ct<T>` instance, and the `IsValid` property of the `ValidatableObject<T>` instance\\nis updated to ind\", \"icate whether validation succeeded or failed.\\n\\n\\nProperty change notification is provided by the `Ext\", \"endedBindableObject` class, and so an `Entry`\\ncontrol can bind to the `IsValid` property of `Validat\", \"ableObject<T>` instance in the view model class\\nto be notified of whether or not the entered data is\", \" valid.\\n#### Specifying validation rules\\n\\n\\nValidation rules are specified by creating a class that d\", \"erives from the `IValidationRule<T>` interface,\\nwhich is shown in the following code example:\\n\\n\\nThis\", \" interface specifies that a validation rule class must provide a `boolean Check` method that is used\", \"\\nto perform the required validation, and a `ValidationMessage` property whose value is the validatio\", \"n\\nerror message that will be displayed if validation fails.\\n\\n\\nThe following code example shows the `\", \"IsNotNullOrEmptyRule<T>` validation rule, which is used to\\nperform validation of the username and pa\", \"ssword entered by the user on the `LoginView` when using\\nmock services in the eShopOnContainers mobi\", \"le app:\\n\\n\\nThe `Check` method returns a `boolean` indicating whether the `value` argument is `null`, \", \"empty, or\\nconsists only of whitespace characters.\\n\\n\\nAlthough not used by the eShopOnContainers mobil\", \"e app, the following code example shows a\\nvalidation rule for validating email addresses:\\n\\n\\n37 CHAPT\", \"ER 6 | Validation\\n\\n\\nThe `Check` method returns a `boolean` indicating whether or not the `value` arg\", \"ument is a valid email\\naddress. This is achieved by searching the `value` argument for the first occ\", \"urrence of the regular\\nexpression pattern specified in the `Regex` constructor. Whether the regular \", \"expression pattern has\\nbeen found in the input string can be determined by checking the value of the\", \" `Match` object's\\n`Success` property.\\n\\n#### Adding validation rules to a property\\n\\n\\nIn the eShopOnCo\", \"ntainers mobile app, view model properties that require validation are declared to\\nbe of type `Valid\", \"atableObject<T>,` where `T` is the type of the data to be validated. The following\\ncode example show\", \"s an example of two such properties:\\n\\n\\nFor validation to occur, validation rules must be added to th\", \"e `Validations` collection of each\\n`ValidatableObject<T>` instance, as demonstrated in the following\", \" code example:\\n\\n\\n38 CHAPTER 6 | Validation\\n\\n\\nThis method adds the `IsNotNullOrEmptyRule<T>` validati\", \"on rule to the `Validations` collection of\\neach `ValidatableObject<T>` instance, specifying values f\", \"or the validation rule's `ValidationMessage`\\nproperty, which specifies the validation error message \", \"that will be displayed if validation fails.\\n#### Triggering validation\\n\\n\\nThe validation approach use\", \"d in the eShopOnContainers mobile app can manually trigger validation\\nof a property, and automatical\", \"ly trigger validation when a property changes.\\n##### **Triggering validation manually**\\n\\nValidation \", \"can be triggered manually for a view model property. For example, this occurs in the\\neShopOnContaine\", \"rs mobile app when the user taps the **Login** button on the `LoginView`, when using\\nmock services. \", \"The command delegate calls the `MockSignInAsync` method in the `LoginViewModel`,\\nwhich invokes valid\", \"ation by executing the `Validate` method, which is shown in the following code\\nexample:\\n\\n\\nThe `Valid\", \"ate` method performs validation of the username and password entered by the user on the\\n`LoginView`,\", \" by invoking the `Validate` method on each `ValidatableObject<T>` instance. The\\nfollowing code examp\", \"le shows the `Validate` method from the `ValidatableObject<T>` class:\\n\\n\\n39 CHAPTER 6 | Validation\\n\\n\\n\", \"This method clears the `Errors` collection, and then retrieves any validation rules that were added \", \"to\\nthe object's `Validations` collection. The `Check` method for each retrieved validation rule is e\", \"xecuted,\\nand the `ValidationMessage` property value for any validation rule that fails to validate t\", \"he data is\\nadded to the `Errors` collection of the `ValidatableObject<T>` instance. Finally, the `Is\", \"Valid` property\\nis set, and its value is returned to the calling method, indicating whether validati\", \"on succeeded or\\nfailed.\\n##### **Triggering validation when properties change**\\n\\nValidation is also a\", \"utomatically triggered whenever a bound property changes. For example, when a\\ntwo-way binding in the\", \" `LoginView` sets the `UserName` or `Password` property, validation is triggered.\\nThe following code\", \" example demonstrates how this occurs:\\n\\n\\nThe `Entry` control binds to the `UserName.Value` property \", \"of the `ValidatableObject<T>` instance,\\nand the control's `Behaviors` collection has an `EventToComm\", \"andBehavior` instance added to it. This\\nbehavior executes the `ValidateUserNameCommand` in response \", \"to the `TextChanged` event firing on\\nthe `Entry,` which is raised when the text in the `Entry` chang\", \"es. In turn, the\\n`ValidateUserNameCommand` delegate executes the `ValidateUserName` method, which ex\", \"ecutes the\\n`Validate` method on the `ValidatableObject<T>` instance. Therefore, every time the user \", \"enters a\\ncharacter in the `Entry` control for the username, validation of the entered data is perfor\", \"med.\\n\\n\\nFor more information about behaviors, see Implementing behaviors.\\n#### Displaying validation \", \"errors\\n\\n\\nThe eShopOnContainers mobile app notifies the user of any validation errors by highlighting\", \" the\\ncontrol that contains the invalid data with a red line, and by displaying an error message that\", \" informs\\nthe user why the data is invalid below the control containing the invalid data. When the in\", \"valid data is\\ncorrected, the line changes to black and the error message is removed. Figure 6-2 show\", \"s the\\n`LoginView` in the eShopOnContainers mobile app when validation errors are present.\\n\\n\\n40 CHAPT\", \"ER 6 | Validation\\n\\n\\n**Figure 6-2:** Displaying validation errors during login\\n##### **Highlighting a\", \" control that contains invalid data**\\n\\nThe `LineColorBehavior` attached behavior is used to highligh\", \"t `Entry` controls where validation\\nerrors have occurred. The following code example shows how the `\", \"LineColorBehavior` attached\\nbehavior is attached to an `Entry` control:\\n\\n\\nThe `Entry` control consum\", \"es an explicit style, which is shown in the following code example:\\n\\n\\nThis style sets the `ApplyLine\", \"Color` and `LineColor` attached properties of the `LineColorBehavior`\\nattached behavior on the `Entr\", \"y` [control. For more information about styles, see Styles](https://developer.xamarin.com/guides/xam\", \"arin-forms/user-interface/styles/) on the Xamarin\\nDeveloper Center.\\n\\n\\nWhen the value of the `ApplyLi\", \"neColor` attached property is set, or changes, the `LineColorBehavior`\\nattached behavior executes th\", \"e `OnApplyLineColorChanged` method, which is shown in the following\\ncode example:\\n\\n\\n41 CHAPTER 6 | V\", \"alidation\\n\\n\\nThe parameters for this method provide the instance of the control that the behavior is \", \"attached to,\\nand the old and new values of the `ApplyLineColor` attached property. The `EntryLineCol\", \"orEffect`\\nclass is added to the control's `Effects` collection if the `ApplyLineColor` attached prop\", \"erty is `true`,\\notherwise it's removed from the control's `Effects` collection. For more information\", \" about behaviors,\\nsee Implementing behaviors.\\n\\n\\nThe `EntryLineColorEffect` subclasses the `RoutingEf\", \"fect` class, and is shown in the following code\\nexample:\\n\\n\\nThe `RoutingEffect` class represents a pl\", \"atform-independent effect that wraps an inner effect that's\\nplatform-specific. This simplifies the e\", \"ffect removal process, since there is no compile-time access to\\nthe type information for a platform-\", \"specific effect. The `EntryLineColorEffect` calls the base class\\nconstructor, passing in a parameter\", \" consisting of a concatenation of the resolution group name, and\\nthe unique ID that's specified on e\", \"ach platform-specific effect class.\\n\\n\\nThe following code example shows the eShopOnContainers.EntryLi\", \"neColorEffect implementation for\\niOS:\\n\\n\\n42 CHAPTER 6 | Validation\\n\\n\\n43 CHAPTER 6 | Validation\\n\\n\\nThe \", \"`OnAttached` method retrieves the native control for the Xamarin.Forms `Entry` control, and\\nupdates \", \"the line color by calling the `UpdateLineColor` method. The `OnElementPropertyChanged`\\noverride resp\", \"onds to bindable property changes on the `Entry` control by updating the line color if the\\nattached \", \"`LineColor` property changes, or the `Height` property of the `Entry` changes. For more\\n[information\", \" about effects, see Effects](https://developer.xamarin.com/guides/xamarin-forms/application-fundamen\", \"tals/effects/) on the Xamarin Developer Center.\\n\\n\\nWhen valid data is entered in the `Entry` control,\", \" it will apply a black line to the bottom of the control,\\nto indicate that there is no validation er\", \"ror. Figure 6-3 shows an example of this.\\n\\n\\n**Figure 6-3** : Black line indicating no validation err\", \"or\\n\\n\\nThe `Entry` control also has a `DataTrigger` added to its `Triggers` collection. The following \", \"code\\nexample shows the `DataTrigger` :\\n\\n\\nThis `DataTrigger` monitors the `UserName.IsValid` property\", \", and if it's value becomes `false`, it\\nexecutes the `Setter`, which changes the `LineColor` attache\", \"d property of the `LineColorBehavior`\\nattached behavior to red. Figure 6-4 shows an example of this.\", \"\\n\\n\\n**Figure 6-4** : Red line indicating validation error\\n\\n\\nThe line in the `Entry` control will rema\", \"in red while the entered data is invalid, otherwise it will change\\nto black to indicate that the ent\", \"ered data is valid.\\n\\n\\n[For more information about Triggers, see Triggers on the Xamarin Developer Ce\", \"nter.](https://developer.xamarin.com/guides/xamarin-forms/application-fundamentals/triggers/)\\n##### \", \"**Displaying error messages**\\n\\nThe UI displays validation error messages in `Label` controls below e\", \"ach control whose data failed\\nvalidation. The following code example shows the `Label` that displays\", \" a validation error message if\\nthe user has not entered a valid username:\\n\\n\\n44 CHAPTER 6 | Validatio\", \"n\\n\\n\\nEach `Label` binds to the Errors property of the view model object that's being validated. The `\", \"Errors`\\nproperty is provided by the `ValidatableObject<T>` class, and is of type `List<string>.` Bec\", \"ause the\\n`Errors` property can contain multiple validation errors, the `FirstValidationErrorConverte\", \"r`\\ninstance is used to retrieve the first error from the collection for display.\\n#### Summary\\n\\n\\nThe \", \"eShopOnContainers mobile app performs synchronous client-side validation of view model\\nproperties an\", \"d notifies the user of any validation errors by highlighting the control that contains the\\ninvalid d\", \"ata, and by displaying error messages that inform the user why the data is invalid.\\n\\n\\nView model pro\", \"perties that require validation are of type `ValidatableObject<T>`, and each\\n`ValidatableObject<T>` \", \"instance has validation rules added to its `Validations` property. Validation\\nis invoked from the vi\", \"ew model by calling the `Validate` method of the `ValidatableObject<T>`\\ninstance, which retrieves th\", \"e validation rules and executes them against the `ValidatableObject<T>`\\n`Value` property. Any valida\", \"tion errors are placed into the `Errors` property of the\\n`ValidatableObject<T>` instance, and the `I\", \"sValid` property of the `ValidatableObject<T>` instance\\nis updated to indicate whether validation su\", \"cceeded or failed.\\n\\n\\n45 CHAPTER 6 | Validation\\n\\n\\n# Configuration management\\n\\nSettings allow the sepa\", \"ration of data that configures the behavior of an app from the code, allowing\\nthe behavior to be cha\", \"nged without rebuilding the app. There are two types of settings: app settings,\\nand user settings.\\n\\n\", \"\\nApp settings are data that an app creates and manages. It can include data such as fixed web servic\", \"e\\nendpoints, API keys, and runtime state. App settings are tied to the existence of the app and are \", \"only\\nmeaningful to that app.\\n\\n\\nUser settings are the customizable settings of an app that affect the\", \" behavior of the app and don't\\nrequire frequent re-adjustment. For example, an app might let the use\", \"r specify where to retrieve data\\nfrom, and how to display it on the screen.\\n\\n\\nXamarin.Forms includes\", \" a persistent dictionary that can be used to store settings data. This dictionary\\ncan be accessed us\", \"ing the `Application.Current.Properties` property, and any data that's placed\\ninto it is saved when \", \"the app goes into a sleep state, and is restored when the app resumes or starts\\nup again. In additio\", \"n, the `Application` class also has a `SavePropertiesAsync` method that allows an\\napp to have its se\", \"ttings saved when required. For more information about this dictionary, see\\n[Properties Dictionary o\", \"n the Xamarin Developer Center.](https://developer.xamarin.com/guides/xamarin-forms/application-fund\", \"amentals/application-class/#Properties_Dictionary)\\n\\n\\nA downside to storing data using the Xamarin.Fo\", \"rms persistent dictionary is that it's not easily data\\nbound to. Therefore, the eShopOnContainers mo\", \"bile app uses the Xam.Plugins.Settings library,\\n[available from NuGet. This library provides a consi\", \"stent, type-safe, cross-platform approach for](https://www.nuget.org/packages/Xam.Plugins.Settings/)\", \"\\npersisting and retrieving app and user settings, while using the native settings management provide\", \"d\\nby each platform. In addition, it's straightforward to use data binding to access settings data ex\", \"posed\\nby the library.\\n\\n#### Creating a settings class\\n\\n\\nWhen using the Xam.Plugins.Settings library,\", \" a single `static` class should be created that will contain\\nthe app and user settings required by t\", \"he app. The following code example shows the `Settings` class\\nin the eShopOnContainers mobile app:\\n\\n\", \"\\n46 CHAPTER 7 | Configuration management\\n\\n\\nSettings can be read and written through the `ISettings` \", \"API, which is provided by the\\nXam.Plugins.Settings library. This library provides a singleton that c\", \"an be used to access the API,\\n`CrossSettings.Current`, and an app's settings class should expose thi\", \"s singleton via an `ISettings`\\nproperty.\\n\\n#### Adding a setting\\n\\n\\nEach setting consists of a key, a \", \"default value, and a property. The following code example shows all\\nthree items for a user setting t\", \"hat represents the base URL for the online services that the\\neShopOnContainers mobile app connects t\", \"o:\\n\\n\\nThe key is always a `const string` that defines the key name, with the default value for the se\", \"tting\\nbeing a `static readonly` value of the required type. Providing a default value ensures that a\", \" valid\\nvalue is available if an unset setting is retrieved.\\n\\n\\nThe `UrlBase` `static` property uses t\", \"wo methods from the `ISettings` API to read or write the setting\\nvalue. The `ISettings.GetValueOrDef\", \"ault` method is used to retrieve a setting's value from\\nplatform-specific storage. If no value is de\", \"fined for the setting, its default value is retrieved instead.\\nSimilarly, the `ISettings.AddOrUpdate\", \"Value` method is used to persist a setting's value to platformspecific storage.\\n\\n\\n47 CHAPTER 7 | Con\", \"figuration management\\n\\n\\nRather that define a default value inside the `Settings` class, the `UrlBase\", \"Default` string obtains its\\nvalue from the `GlobalSetting` class. The following code example shows t\", \"he `BaseEndpoint` property\\nand `UpdateEndpoint` method in this class:\\n\\n\\nEach time the `BaseEndpoint`\", \" property is set, the `UpdateEndpoint` method is called. This method\\nupdates a series of properties,\", \" all of which are based on the `UrlBase` user setting that's provided by\\nthe `Settings` class that r\", \"epresent different endpoints that the eShopOnContainers mobile app\\nconnects to.\\n#### Data binding to\", \" user settings\\n\\n\\nIn the eShopOnContainers mobile app, the `SettingsView` exposes two user settings. \", \"These settings\\nallow configuration of whether the app should retrieve data from microservices that a\", \"re deployed as\\nDocker containers, or whether the app should retrieve data from mock services that do\", \"n't require an\\ninternet connection. When choosing to retrieve data from containerized microservices,\", \" a base\\nendpoint URL for the microservices must be specified. Figure 7-1 shows the `SettingsView` wh\", \"en the\\nuser has chosen to retrieve data from containerized microservices.\\n\\n\\n48 CHAPTER 7 | Configura\", \"tion management\\n\\n\\n**Figure 7-1** : User settings exposed by the eShopOnContainers mobile app\\n\\n\\nData \", \"binding can be used to retrieve and set settings exposed by the `Settings` class. This is achieved\\nb\", \"y controls on the view binding to view model properties that in turn access properties in the\\n`Setti\", \"ngs` class, and raising a property changed notification if the settings value has changed. For\\ninfor\", \"mation about how the eShopOnContainers mobile app constructs view models and associates\\nthem to view\", \"s, see Automatically creating a view model with a view model locator.\\n\\n\\nThe following code example s\", \"hows the `Entry` control from the `SettingsView` that allows the user to\\nenter a base endpoint URL f\", \"or the containerized microservices:\\n\\n```\\n <Entry Text=\\\"{Binding Endpoint, Mode=TwoWay}\\\" />\\n\\n```\\n\\nThi\", \"s `Entry` control binds to the `Endpoint` property of the `SettingsViewModel` class, using a two-way\", \"\\nbinding. The following code example shows the `Endpoint` property:\\n\\n\\nWhen the Endpoint property is \", \"set the `UpdateEndpoint` method is called, provided that the supplied\\nvalue is valid, and property c\", \"hanged notification is raised. The following code example shows the\\n`UpdateEndpoint` method:\\n\\n\\n49 CH\", \"APTER 7 | Configuration management\\n\\n\\nThis method updates the `UrlBase` property in the `Settings` cl\", \"ass with the base endpoint URL value\\nentered by the user, which causes it to be persisted to platfor\", \"m-specific storage.\\n\\n\\nWhen the `SettingsView` is navigated to, the `InitializeAsync` method in the `\", \"SettingsViewModel`\\nclass is executed. The following code example shows this method:\\n\\n\\nThe method set\", \"s the `Endpoint` property to the value of the `UrlBase` property in the `Settings` class.\\nAccessing \", \"the `UrlBase` property causes the Xam.Plugins.Settings library to retrieve the settings value\\nfrom p\", \"latform-specific storage. For information about how the `InitializeAsync` method is invoked,\\nsee Pas\", \"sing parameters during navigation.\\n\\n\\nThis mechanism ensures that whenever a user navigates to the `S\", \"ettingsView`, user settings are\\nretrieved from platform-specific storage and presented through data \", \"binding. Then, if the user\\nchanges the settings values, data binding ensures that they are immediate\", \"ly persisted back to\\nplatform-specific storage.\\n#### Summary\\n\\n\\nSettings allow the separation of data\", \" that configures the behavior of an app from the code, allowing\\nthe behavior to be changed without r\", \"ebuilding the app. App settings are data that an app creates and\\nmanages, and user settings are the \", \"customizable settings of an app that affect the behavior of the app\\nand don't require frequent re-ad\", \"justment.\\n\\n\\nThe Xam.Plugins.Settings library provides a consistent, type-safe, cross-platform approa\", \"ch for\\npersisting and retrieving app and user settings, and data binding can be used to access setti\", \"ngs\\ncreated with the library.\\n\\n\\n50 CHAPTER 7 | Configuration management\\n\\n\\n# Containerized microservi\", \"ces\\n\\nDeveloping client-server applications has resulted in a focus on building tiered applications t\", \"hat use\\nspecific technologies in each tier. Such applications are often referred to as _monolithic_ \", \"applications,\\nand are packaged onto hardware pre-scaled for peak loads. The main drawbacks of this d\", \"evelopment\\napproach are the tight coupling between components within each tier, that individual comp\", \"onents\\ncan't be easily scaled, and the cost of testing. A simple update can have unforeseen effects \", \"on the rest\\nof the tier, and so a change to an application component requires its entire tier to be \", \"retested and\\nredeployed.\\n\\n\\nParticularly concerning in the age of the cloud, is that individual compo\", \"nents can't be easily scaled. A\\nmonolithic application contains domain-specific functionality, and i\", \"s typically divided by functional\\nlayers such as front end, business logic, and data storage. A mono\", \"lithic application is scaled by\\ncloning the entire application onto multiple machines, as illustrate\", \"d in Figure 8-1.\\n\\n\\n**Figure 8-1** : Monolithic application scaling approach\\n\\n\\n51 CHAPTER 8 | Contain\", \"erized microservices\\n\\n\\n#### Microservices\\n\\nMicroservices offer a different approach to application d\", \"evelopment and deployment, an approach\\nthat's suited to the agility, scale, and reliability requirem\", \"ents of modern cloud applications. A\\nmicroservices application is decomposed into independent compon\", \"ents that work together to deliver\\nthe application's overall functionality. The term microservice em\", \"phasizes that applications should be\\ncomposed of services small enough to reflect independent concer\", \"ns, so that each microservice\\nimplements a single function. In addition, each microservice has well-\", \"defined contracts so that other\\nmicroservices can communicate and share data with it. Typical exampl\", \"es of microservices include\\nshopping carts, inventory processing, purchase subsystems, and payment p\", \"rocessing.\\n\\n\\nMicroservices can scale-out independently, as compared to giant monolithic applications\", \" that scale\\ntogether. This means that a specific functional area, that requires more processing powe\", \"r or network\\nbandwidth to support demand, can be scaled rather than unnecessarily scaling-out other \", \"areas of the\\napplication. Figure 8-2 illustrates this approach, where microservices are deployed and\", \" scaled\\nindependently, creating instances of services across machines.\\n\\n\\n**Figure 8-2** : Microservi\", \"ces application scaling approach\\n\\n\\nMicroservice scale-out can be nearly instantaneous, allowing an a\", \"pplication to adapt to changing\\nloads. For example, a single microservice in the web-facing function\", \"ality of an application might be\\nthe only microservice in the application that needs to scale out to\", \" handle additional incoming traffic.\\n\\n\\nThe classic model for application scalability is to have a lo\", \"ad-balanced, stateless tier with a shared\\nexternal datastore to store persistent data. Stateful micr\", \"oservices manage their own persistent data,\\nusually storing it locally on the servers on which they \", \"are placed, to avoid the overhead of network\\naccess and complexity of cross-service operations. This\", \" enables the fastest possible processing of data\\nand can eliminate the need for caching systems. In \", \"addition, scalable stateful microservices usually\\npartition data among their instances, in order to \", \"manage data size and transfer throughput beyond\\nwhich a single server can support.\\n\\n\\nMicroservices a\", \"lso support independent updates. This loose coupling between microservices provides\\na rapid and reli\", \"able application evolution. Their independent, distributed nature supports rolling\\nupdates, where on\", \"ly a subset of instances of a single microservice will update at any given time.\\nTherefore, if a pro\", \"blem is detected, a buggy update can be rolled back, before all instances update\\nwith the faulty cod\", \"e or configuration. Similarly, microservices typically use schema versioning, so that\\n\\n\\n52 CHAPTER 8\", \" | Containerized microservices\\n\\n\\nclients see a consistent version when updates are being applied, re\", \"gardless of which microservice\\ninstance is being communicated with.\\n\\n\\nTherefore, microservice applic\", \"ations have many benefits over monolithic applications:\\n\\n\\n  - Each microservice is relatively small,\", \" easy to manage and evolve.\\n\\n  - Each microservice can be developed and deployed independently of ot\", \"her services.\\n\\n  - Each microservice can be scaled-out independently. For example, a catalog service\", \" or\\nshopping basket service might need to be scaled-out more than an ordering service.\\nTherefore, th\", \"e resulting infrastructure will more efficiently consume resources when scaling\\nout.\\n\\n\\n  - Each micr\", \"oservice isolates any issues. For example, if there is an issue in a service it only\\nimpacts that se\", \"rvice. The other services can continue to handle requests.\\n\\n\\n  - Each microservice can use the lates\", \"t technologies. Because microservices are autonomous and\\nrun side-by-side, the latest technologies a\", \"nd frameworks can be used, rather than being\\nforced to use an older framework that might be used by \", \"a monolithic application.\\n\\n\\nHowever, a microservice based solution also has potential drawbacks:\\n\\n\\n \", \" - Choosing how to partition an application into microservices can be challenging, as each\\nmicroserv\", \"ice has to be completely autonomous, end-to-end, including responsibility for its\\ndata sources.\\n\\n\\n  \", \"- Developers must implement inter-service communication, which adds complexity and latency\\nto the ap\", \"plication.\\n\\n\\n  - Atomic transactions between multiple microservices usually aren't possible. Therefo\", \"re,\\nbusiness requirements must embrace eventual consistency between microservices.\\n\\n\\n  - In producti\", \"on, there is an operational complexity in deploying and managing a system\\ncompromised of many indepe\", \"ndent services.\\n\\n\\n  - Direct client-to-microservice communication can make it difficult to refactor \", \"the contracts of\\nmicroservices. For example, over time how the system is partitioned into services m\", \"ight need\\nto change. A single service might split into two or more services, and two services might\\n\", \"merge. When clients communicate directly with microservices, this refactoring work can break\\ncompati\", \"bility with client apps.\\n#### Containerization\\n\\n\\nContainerization is an approach to software develop\", \"ment in which an application and its versioned set\\nof dependencies, plus its environment configurati\", \"on abstracted as deployment manifest files, are\\npackaged together as a container image, tested as a \", \"unit, and deployed to a host operating system.\\n\\n\\nA container is an isolated, resource controlled, an\", \"d portable operating environment, where an\\napplication can run without touching the resources of oth\", \"er containers, or the host. Therefore, a\\ncontainer looks and acts like a newly installed physical co\", \"mputer or a virtual machine.\\n\\n\\nThere are many similarities between containers and virtual machines, \", \"as illustrated in Figure 8-3.\\n\\n\\n53 CHAPTER 8 | Containerized microservices\\n\\n\\n**Figure 8-3** : Compar\", \"ison of virtual machines and containers\\n\\n\\nA container runs an operating system, has a file system, a\", \"nd can be accessed over a network as if it\\nwere a physical or virtual machine. However, the technolo\", \"gy and concepts used by containers are very\\ndifferent from virtual machines. Virtual machines includ\", \"e the applications, the required dependencies,\\nand a full guest operating system. Containers include\", \" the application and its dependencies, but share\\nthe operating system with other containers, running\", \" as isolated processes on the host operating\\nsystem (aside from Hyper-V containers which run inside \", \"of a special virtual machine per container).\\nTherefore, containers share resources and typically req\", \"uire fewer resources than virtual machines.\\n\\n\\nThe advantage of a container-oriented development and \", \"deployment approach is that it eliminates\\nmost of the issues that arise from inconsistent environmen\", \"t setups and the problems that come with\\nthem. In addition, containers permit fast application scale\", \"-up functionality by instancing new\\ncontainers as required.\\n\\n\\nThe key concepts when creating and wor\", \"king with containers are:\\n\\n\\n  - Container Host: The physical or virtual machine configured to host c\", \"ontainers. The container\\nhost will run one or more containers.\\n\\n\\n  - Container Image: An image consi\", \"sts of a union of layered filesystems stacked on top of each\\nother, and is the basis of a container.\", \" An image does not have state and it never changes as\\nit's deployed to different environments.\\n\\n\\n  -\", \" Container: A container is a runtime instance of an image.\\n\\n  - Container OS Image: Containers are d\", \"eployed from images. The container operating system\\nimage is the first layer in potentially many ima\", \"ge layers that make up a container. A container\\noperating system is immutable, and can't be modified\", \".\\n\\n\\n  - Container Repository: Each time a container image is created, the image and its dependencies\", \"\\nare stored in a local repository. These images can be reused many times on the container\\n[host. The\", \" container images can also be stored in a public or private registry, such as Docker](https://hub.do\", \"cker.com/)\\nHub, so that they can be used across different container hosts.\\n\\n\\n54 CHAPTER 8 | Containe\", \"rized microservices\\n\\n\\nEnterprises are increasingly adopting containers when implementing microservic\", \"e based applications,\\nand Docker has become the standard container implementation that has been adop\", \"ted by most\\nsoftware platforms and cloud vendors.\\n\\n\\nThe eShopOnContainers reference application uses\", \" Docker to host four containerized back-end\\nmicroservices, as illustrated in Figure 8-4.\\n\\n\\n**Figure \", \"8-4** : eShopOnContainers reference application back-end microservices\\n\\n\\nThe architecture of the bac\", \"k-end services in the reference application is decomposed into multiple\\nautonomous sub-systems in th\", \"e form of collaborating microservices and containers. Each microservice\\nprovides a single area of fu\", \"nctionality: an identity service, a catalog service, an ordering service, and a\\nbasket service.\\n\\n\\nEa\", \"ch microservice has its own database, allowing it to be fully decoupled from the other\\nmicroservices\", \". Where necessary, consistency between databases from different microservices is\\nachieved using appl\", \"ication-level events. For more information, see Communication between\\nmicroservices.\\n\\n\\n[For more inf\", \"ormation about the reference application, see .NET Microservices: Architecture for](https://aka.ms/m\", \"icroservicesebook)\\n[Containerized .NET Applications.](https://aka.ms/microservicesebook)\\n#### Commun\", \"ication between client and microservices\\n\\n\\nThe eShopOnContainers mobile app communicates with the co\", \"ntainerized back-end microservices\\nusing _direct client-to-microservice_ communication, which is sho\", \"wn in Figure 8-5.\\n\\n\\n55 CHAPTER 8 | Containerized microservices\\n\\n\\n**Figure 8-5** : Direct client-to-m\", \"icroservice communication\\n\\n\\nWith direct client-to-microservice communication, the mobile app makes r\", \"equests to each\\nmicroservice directly through its public endpoint, with a different TCP port per mic\", \"roservice. In\\nproduction, the endpoint would typically map to the microservice's load balancer, whic\", \"h distributes\\nrequests across the available instances.\\n\\n\\n\\n\\n#### Communication between microservices\\n\", \"\\nA microservices based application is a distributed system, potentially running on multiple machines\", \".\\nEach service instance is typically a process. Therefore, services must interact using an inter-pro\", \"cess\\ncommunication protocol, such as HTTP, TCP, Advanced Message Queuing Protocol (AMQP), or binary\\n\", \"protocols, depending on the nature of each service.\\n\\n\\nThe two common approaches for microservice-to-\", \"microservice communication are HTTP based REST\\ncommunication when querying for data, and lightweight\", \" asynchronous messaging when\\ncommunicating updates across multiple microservices.\\n\\n\\nAsynchronous mes\", \"saging based event-driven communication is critical when propagating changes\\nacross multiple microse\", \"rvices. With this approach, a microservice publishes an event when something\\nnotable happens, for ex\", \"ample, when it updates a business entity. Other microservices subscribe to\\nthese events. Then, when \", \"a microservice receives an event, it updates its own business entities, which\\nmight in turn lead to \", \"more events being published. This publish-subscribe functionality is usually\\nachieved with an event \", \"bus.\\n\\n\\nAn event bus allows publish-subscribe communication between microservices, without requiring \", \"the\\ncomponents to be explicitly aware of each other, as shown in Figure 8-6.\\n\\n\\n56 CHAPTER 8 | Contai\", \"nerized microservices\\n\\n\\n**Figure 8-6:** Publish-subscribe with an event bus\\n\\n\\nFrom an application pe\", \"rspective, the event bus is simply a publish-subscribe channel exposed via an\\ninterface. However, th\", \"e way the event bus is implemented can vary. For example, an event bus\\nimplementation could use Rabb\", \"itMQ, Azure Service Bus, or other service buses such as NServiceBus\\nand MassTransit. Figure 8-7 show\", \"s how an event bus is used in the eShopOnContainers reference\\napplication.\\n\\n\\n**Figure 8-7:** Asynchr\", \"onous event-driven communication in the reference application\\n\\n\\nThe eShopOnContainers event bus, imp\", \"lemented using RabbitMQ, provides one-to-many\\nasynchronous publish-subscribe functionality. This mea\", \"ns that after publishing an event, there can be\\nmultiple subscribers listening for the same event. F\", \"igure 8-9 illustrates this relationship.\\n\\n\\n57 CHAPTER 8 | Containerized microservices\\n\\n\\n**Figure 8-9\", \"** : One-to-many communication\\n\\n\\nThis one-to-many communication approach uses events to implement bu\", \"siness transactions that span\\nmultiple services, ensuring eventual consistency between the services.\", \" An eventual-consistent\\ntransaction consists of a series of distributed steps. Therefore, when the u\", \"ser-profile microservice\\nreceives the `UpdateUser` command, it updates the user's details in its dat\", \"abase and publishes the\\n`UserUpdated` event to the event bus. Both the basket microservice and the o\", \"rdering microservice\\nhave subscribed to receive this event, and in response update their buyer infor\", \"mation in their\\nrespective databases.\\n\\n\\n[For information about the event bus implementation, see .NE\", \"T Microservices: Architecture for](https://aka.ms/microservicesebook)\\n[Containerized .NET Applicatio\", \"ns.](https://aka.ms/microservicesebook)\\n#### Summary\\n\\n\\nMicroservices offer an approach to applicatio\", \"n development and deployment that's suited to the\\nagility, scale, and reliability requirements of mo\", \"dern cloud applications. One of the main advantages\\nof microservices is that they can be scaled-out \", \"independently, which means that a specific functional\\narea can be scaled that requires more processi\", \"ng power or network bandwidth to support demand,\\nwithout unnecessarily scaling areas of the applicat\", \"ion that are not experiencing increased demand.\\n\\n\\nA container is an isolated, resource controlled, a\", \"nd portable operating environment, where an\\napplication can run without touching the resources of ot\", \"her containers, or the host. Enterprises are\\nincreasingly adopting containers when implementing micr\", \"oservice based applications, and Docker has\\nbecome the standard container implementation that has be\", \"en adopted by most software platforms\\nand cloud vendors.\\n\\n\\n58 CHAPTER 8 | Containerized microservice\", \"s\\n\\n\\n# Authentication and authorization\\n\\nAuthentication is the process of obtaining identification cr\", \"edentials such as name and password from\\na user, and validating those credentials against an authori\", \"ty. If the credentials are valid, the entity that\\nsubmitted the credentials is considered an authent\", \"icated identity. Once an identity has been\\nauthenticated, an authorization process determines whethe\", \"r that identity has access to a given\\nresource.\\n\\n\\nThere are many approaches to integrating authentic\", \"ation and authorization into a Xamarin.Forms app\\nthat communicates with an ASP.NET MVC web applicati\", \"on, including using ASP.NET Core Identity,\\nexternal authentication providers such as Microsoft, Goog\", \"le, Facebook, or Twitter, and authentication\\nmiddleware. The eShopOnContainers mobile app performs a\", \"uthentication and authorization with a\\ncontainerized identity microservice that uses IdentityServer \", \"4. The mobile app requests security tokens\\nfrom IdentityServer, either for authenticating a user or \", \"for accessing a resource. For IdentityServer to\\nissue tokens on behalf of a user, the user must sign\", \"-in to IdentityServer. However, IdentityServer\\ndoesn't provide a user interface or database for auth\", \"entication. Therefore, in the eShopOnContainers\\nreference application, ASP.NET Core Identity is used\", \" for this purpose.\\n#### Authentication\\n\\n\\nAuthentication is required when an application needs to kno\", \"w the identity of the current user.\\nASP.NET Core's primary mechanism for identifying users is the AS\", \"P.NET Core Identity membership\\nsystem, which stores user information in a data store configured by t\", \"he developer. Typically, this data\\nstore will be an EntityFramework store, though custom stores or t\", \"hird party packages can be used to\\nstore identity information in Azure storage, DocumentDB, or other\", \" locations.\\n\\n\\nFor authentication scenarios that make use of a local user data store, and that persis\", \"t identity\\ninformation between requests via cookies (as is typical in ASP.NET MVC web applications),\", \" ASP.NET\\nCore Identity is a suitable solution. However, cookies are not always a natural means of pe\", \"rsisting and\\ntransmitting data. For example, an ASP.NET Core web application that exposes RESTful en\", \"dpoints that\\nare accessed from a mobile app will typically need to use bearer token authentication, \", \"since cookies\\ncan't be used in this scenario. However, bearer tokens can easily be retrieved and inc\", \"luded in the\\nauthorization header of web requests made from the mobile app.\\n\\n\\n59 CHAPTER 9 | Authent\", \"ication and authorization\\n\\n\\n##### **Issuing bearer tokens using IdentityServer 4**\\n\\n[IdentityServer \", \"4](https://github.com/IdentityServer/IdentityServer4) is an open source OpenID Connect and OAuth 2.0\", \" framework for ASP.NET Core,\\nwhich can be used for many authentication and authorization scenarios i\", \"ncluding issuing security\\ntokens for local ASP.NET Core Identity users.\\n\\n\\n\\n\\n\\nIn applications that us\", \"e direct client-to-microservice communication, such as the eShopOnContainers\\nreference application, \", \"a dedicated authentication microservice acting as a Security Token Service (STS)\\ncan be used to auth\", \"enticate users, as shown in Figure 9-1. For more information about direct clientto-microservice comm\", \"unication, see Communication between client and microservices.\\n\\n\\n**Figure 9-1:** Authentication by a\", \" dedicated authentication microservice\\n\\n\\nThe eShopOnContainers mobile app communicates with the iden\", \"tity microservice, which uses\\nIdentityServer 4 to perform authentication, and access control for API\", \"s. Therefore, the mobile app\\nrequests tokens from IdentityServer, either for authenticating a user o\", \"r for accessing a resource:\\n\\n\\n  - Authenticating users with IdentityServer is achieved by the mobile\", \" app requesting an _identity_\\ntoken, which represents the outcome of an authentication process. At a\", \" bare minimum, it\\ncontains an identifier for the user, and information about how and when the user\\na\", \"uthenticated. It can also contain additional identity data.\\n\\n\\n  - Accessing a resource with Identity\", \"Server is achieved by the mobile app requesting an _access_\\ntoken, which allows access to an API res\", \"ource. Clients request access tokens and forward\\nthem to the API. Access tokens contain information \", \"about the client, and the user (if present).\\nAPIs then use that information to authorize access to t\", \"heir data.\\n\\n\\n\\n\\n##### **Adding IdentityServer to a web application**\\n\\nIn order for an ASP.NET Core we\", \"b application to use IdentityServer 4, it must be added to the web\\n[application's Visual Studio solu\", \"tion. For more information, see Setup and Overview](https://identityserver4.readthedocs.io/en/releas\", \"e/quickstarts/0_overview.html) in the\\nIdentityServer documentation.\\n\\n\\n60 CHAPTER 9 | Authentication \", \"and authorization\\n\\n\\nOnce IdentityServer is included in the web application's Visual Studio solution,\", \" it must be added to\\nthe web application's HTTP request processing pipeline, so that it can serve re\", \"quests to OpenID\\nConnect and OAuth 2.0 endpoints. This is achieved in the `Configure` method in the \", \"web application's\\n`Startup` class, as demonstrated in the following code example:\\n\\n\\nOrder matters in\", \" the web application's HTTP request processing pipeline. Therefore, IdentityServer\\nmust be added to \", \"the pipeline before the UI framework that implements the login screen.\\n##### **Configuring IdentityS\", \"erver**\\n\\nIdentityServer should be configured in the `ConfigureServices` method in the web applicatio\", \"n's\\n`Startup` class by calling the `services.AddIdentityServer` method, as demonstrated in the\\nfollo\", \"wing code example from the eShopOnContainers reference application:\\n\\n\\nAfter calling the `services.Ad\", \"dIdentityServer` method, additional fluent APIs are called to\\nconfigure the following:\\n\\n\\n  - Credent\", \"ials used for signing.\\n\\n  - API and identity resources that users might request access to.\\n\\n  - Clie\", \"nts that will be connecting to request tokens.\\n\\n  - ASP.NET Core Identity.\\n\\n\\n\\n\\n\\n[For information abo\", \"ut configuring IdentityServer to use ASP.NET Core Identity, see Using ASP.NET](https://identityserve\", \"r4.readthedocs.io/en/release/quickstarts/6_aspnet_identity.html)\\n[Core Identity](https://identityser\", \"ver4.readthedocs.io/en/release/quickstarts/6_aspnet_identity.html) in the IdentityServer documentati\", \"on.\\n\\n\\n61 CHAPTER 9 | Authentication and authorization\\n\\n\\n**Configuring API resources**\\n\\nWhen configur\", \"ing API resources, the `AddInMemoryApiResources` method expects an\\n`IEnumerable<ApiResource>` collec\", \"tion. The following code example shows the `GetApis` method that\\nprovides this collection in the eSh\", \"opOnContainers reference application:\\n\\n\\nThis method specifies that IdentityServer should protect the\", \" `orders` and `basket` APIs. Therefore,\\nIdentityServer managed access tokens will be required when m\", \"aking calls to these APIs. For more\\ninformation about the `ApiResource` [type, see API Resource](htt\", \"ps://identityserver4.readthedocs.io/en/release/reference/api_resource.html#refapiresource) in the Id\", \"entityServer 4 documentation.\\n\\n**Configuring identity resources**\\n\\nWhen configuring identity resourc\", \"es, the `AddInMemoryIdentityResources` method expects an\\n`IEnumerable<IdentityResource>` collection.\", \" Identity resources are data such as user ID, name, or\\nemail address. Each identity resource has a u\", \"nique name, and arbitrary claim types can be assigned to\\nit, which will then be included in the iden\", \"tity token for the user. The following code example shows\\nthe `GetResources` method that provides th\", \"is collection in the eShopOnContainers reference\\napplication:\\n\\n\\n[The OpenID Connect specification sp\", \"ecifies some standard identity resources. The minimum](https://openid.net/specs/openid-connect-core-\", \"1_0.html#ScopeClaims)\\nrequirement is that support is provided for emitting a unique ID for users. Th\", \"is is achieved by\\nexposing the `IdentityResources.OpenId` identity resource.\\n\\n\\n[IdentityServer also \", \"supports defining custom identity resources. For more information, see Defining](https://identityser\", \"ver4.readthedocs.io/en/release/topics/resources.html#defining-custom-identity-resources)\\n[custom ide\", \"ntity resources in the IdentityServer documentation. For more information about the](https://identit\", \"yserver4.readthedocs.io/en/release/topics/resources.html#defining-custom-identity-resources)\\n`Identi\", \"tyResource` type, see [Identity Resource](https://identityserver4.readthedocs.io/en/release/referenc\", \"e/identity_resource.html) in the IdentityServer 4 documentation.\\n\\n**Configuring clients**\\n\\nClients a\", \"re applications that can request tokens from IdentityServer. Typically, the following settings\\nmust \", \"be defined for each client as a minimum:\\n\\n\\n  - A unique client ID.\\n\\n  - The allowed interactions wit\", \"h the token service (known as the grant type).\\n\\n  - The location where identity and access tokens ar\", \"e sent to (known as a redirect URI).\\n\\n\\n62 CHAPTER 9 | Authentication and authorization\\n\\n\\n  - A list \", \"of resources that the client is allowed access to (known as scopes).\\n\\n\\nWhen configuring clients, the\", \" `AddInMemoryClients` method expects an `IEnumerable<Client>`\\ncollection. The following code example\", \" shows the configuration for the eShopOnContainers mobile\\napp in the `GetClients` method that provid\", \"es this collection in the eShopOnContainers reference\\napplication:\\n\\n\\nThis configuration specifies da\", \"ta for the following properties:\\n\\n\\n  - `ClientId` : A unique ID for the client.\\n\\n  - `ClientName` : \", \"The client display name, which is used for logging and the consent screen.\\n\\n  - `AllowedGrantTypes` \", \": Specifies how a client wants to interact with IdentityServer. For more\\ninformation see Configuring\", \" the authentication flow.\\n\\n\\n  - `ClientSecrets` : Specifies the client secret credentials that are u\", \"sed when requesting tokens\\nfrom the token endpoint.\\n\\n\\n  - `RedirectUris` : Specifies the allowed URI\", \"s to which to return tokens or authorization codes.\\n\\n  - `RequireConsent` : Specifies whether a cons\", \"ent screen is required.\\n\\n  - `RequirePkce` : Specifies whether clients using an authorization code m\", \"ust send a proof key.\\n\\n  - `PostLogoutRedirectUris` : Specifies the allowed URIs to redirect to afte\", \"r logout.\\n\\n\\n63 CHAPTER 9 | Authentication and authorization\\n\\n\\n  - `AllowedCorsOrigins` : Specifies t\", \"he origin of the client so that IdentityServer can allow crossorigin calls from the origin.\\n\\n\\n  - `A\", \"llowedScopes` : Specifies the resources the client has access to. By default, a client has no\\naccess\", \" to any resources.\\n\\n\\n  - `AllowOfflineAccess` : Specifies whether the client can request refresh tok\", \"ens.\\n\\n**Configuring the authentication flow**\\n\\nThe authentication flow between a client and Identity\", \"Server can be configured by specifying the grant\\ntypes in the `Client.AllowedGrantTypes` property. T\", \"he OpenID Connect and OAuth 2.0 specifications\\ndefine a number of authentication flows, including:\\n\\n\", \"\\n  - Implicit. This flow is optimized for browser-based applications and should be used either for\\nu\", \"ser authentication-only, or authentication and access token requests. All tokens are\\ntransmitted via\", \" the browser, and therefore advanced features like refresh tokens are not\\npermitted.\\n\\n\\n  - Authoriza\", \"tion code. This flow provides the ability to retrieve tokens on a back channel, as\\nopposed to the br\", \"owser front channel, while also supporting client authentication.\\n\\n\\n  - Hybrid. This flow is a combi\", \"nation of the implicit and authorization code grant types. The\\nidentity token is transmitted via the\", \" browser channel and contains the signed protocol\\nresponse along with other artifacts such as the au\", \"thorization code. After successful validation\\nof the response, the back channel should be used to re\", \"trieve the access and refresh token.\\n\\n\\n\\n\\n\\n[For more information about authentication flows, see Gran\", \"t Types](https://identityserver4.readthedocs.io/en/release/topics/grant_types.html) in the IdentityS\", \"erver 4\\ndocumentation.\\n##### **Performing authentication**\\n\\nFor IdentityServer to issue tokens on be\", \"half of a user, the user must sign-in to IdentityServer.\\nHowever, IdentityServer doesn't provide a u\", \"ser interface or database for authentication. Therefore, in\\nthe eShopOnContainers reference applicat\", \"ion, ASP.NET Core Identity is used for this purpose.\\n\\n\\nThe eShopOnContainers mobile app authenticate\", \"s with IdentityServer with the hybrid authentication\\nflow, which is illustrated in Figure 9-2.\\n\\n\\n**F\", \"igure 9-2:** High-level overview of the sign-in process\\n\\n\\n64 CHAPTER 9 | Authentication and authoriz\", \"ation\\n\\n\\nA sign-in request is made to `<base endpoint>:5105/connect/authorize` . Following successful\", \"\\nauthentication, IdentityServer returns an authentication response containing an authorization code\\n\", \"and an identity token. The authorization code is then sent to `<base`\\n`endpoint>:5105/connect/token`\", \", which responds with access, identity, and refresh tokens.\\n\\n\\nThe eShopOnContainers mobile app signs\", \"-out of IdentityServer by sending a request to\\n`http://<base endpoint>:5105/connect/endsession`, wit\", \"h additional parameters. After sign-out\\noccurs, IdentityServer responds by sending a post logout red\", \"irect URI back to the mobile app. Figure\\n9-3 illustrates this process.\\n\\n\\n**Figure 9-3:** High-level \", \"overview of the sign-out process\\n\\n\\nIn the eShopOnContainers mobile app, communication with IdentityS\", \"erver is performed by the\\n`IdentityService` class, which implements the `IIdentityService` interface\", \". This interface specifies\\nthat the implementing class must provide `CreateAuthorizationRequest`, `C\", \"reateLogoutRequest`,\\nand `GetTokenAsync` methods.\\n\\n**Signing-in**\\n\\nWhen the user taps the **LOGIN** \", \"button on the `LoginView`, the `SignInCommand` in the `LoginViewModel`\\nclass is executed, which in t\", \"urn executes the `SignInAsync` method. The following code example\\nshows this method:\\n\\n\\nThis method i\", \"nvokes the `CreateAuthorizationRequest` method in the `IdentityService` class,\\nwhich is shown in the\", \" following code example:\\n\\n\\n65 CHAPTER 9 | Authentication and authorization\\n\\n\\n[This method creates th\", \"e URI for IdentityServer's authorization endpoint, with the required parameters.](https://identityse\", \"rver4.readthedocs.io/en/release/endpoints/authorize.html)\\nThe authorization endpoint is at `/connect\", \"/authorize` on port 5105 of the base endpoint exposed as\\na user setting. For more information about \", \"user settings, see Configuration management.\\n\\n\\nThe returned URI is stored in the `LoginUrl` property\", \" of the `LoginViewModel` class. When the `IsLogin`\\nproperty becomes `true`, the `WebView` in the `Lo\", \"ginView` becomes visible. The `WebView` data binds its\\n`Source` property to the `LoginUrl` property \", \"of the `LoginViewModel` class, and so makes a sign-in\\nrequest to IdentityServer when the `LoginUrl` \", \"property is set to IdentityServer's authorization\\nendpoint. When IdentityServer receives this reques\", \"t and the user isn't authenticated, the `WebView` will\\nbe redirected to the configured login page, w\", \"hich is shown in Figure 9-4.\\n\\n\\n**Figure 9-4:** Login page displayed by the WebView\\n\\n\\nOnce login is c\", \"ompleted, the `WebView` will be redirected to a return URI. This `WebView` navigation will\\ncause the\", \" `NavigateAsync` method in the `LoginViewModel` class to be executed, which is shown in\\nthe followin\", \"g code example:\\n\\n\\n66 CHAPTER 9 | Authentication and authorization\\n\\n\\nThis method parses the authentic\", \"ation response that's contained in the return URI, and provided that\\n[a valid authorization code is \", \"present, it makes a request to IdentityServer's token endpoint, passing](https://identityserver4.rea\", \"dthedocs.io/en/release/endpoints/token.html)\\nthe authorization code, the PKCE secret verifier, and o\", \"ther required parameters. The token endpoint is\\nat `/connect/token` on port 5105 of the base endpoin\", \"t exposed as a user setting. For more\\ninformation about user settings, see Configuration management.\", \"\\n\\n\\n\\n\\n\\nIf the token endpoint receives a valid authorization code and PKCE secret verifier, it respond\", \"s with an\\naccess token, identity token, and refresh token. The access token (which allows access to \", \"API\\nresources) and identity token are then stored as application settings, and page navigation is\\npe\", \"rformed. Therefore, the overall effect in the eShopOnContainers mobile app is this: provided that\\nus\", \"ers are able to successfully authenticate with IdentityServer, they are navigated to the `MainView`\\n\", \"page, which is a `TabbedPage` that displays the `CatalogView` as its selected tab.\\n\\n\\nFor information\", \" about page navigation, see Navigation. For information about how `WebView`\\nnavigation causes a view\", \" model method to be executed, see Invoking navigation using behaviors. For\\ninformation about applica\", \"tion settings, see Configuration management.\\n\\n\\n**Signing-out**\\n\\nWhen the user taps the **LOG OUT** b\", \"utton in the `ProfileView`, the `LogoutCommand` in the\\n`ProfileViewModel` class is executed, which i\", \"n turn executes the `LogoutAsync` method. This method\\nperforms page navigation to the `LoginView` pa\", \"ge, passing a `LogoutParameter` instance set to `true`\\nas a parameter. For more information about pa\", \"ssing parameters during page navigation, see Passing\\nparameters during navigation.\\n\\n\\n67 CHAPTER 9 | \", \"Authentication and authorization\\n\\n\\nWhen a view is created and navigated to, the `InitializeAsync` me\", \"thod of the view's associated\\nview model is executed, which then executes the `Logout` method of the\", \" `LoginViewModel` class, which\\nis shown in the following code example:\\n\\n\\nThis method invokes the `Cr\", \"eateLogoutRequest` method in the `IdentityService` class, passing the\\nidentity token retrieved from \", \"application settings as a parameter. For more information about\\napplication settings, see Configurat\", \"ion management. The following code example shows the\\n`CreateLogoutRequest` method:\\n\\n\\n[This method cr\", \"eates the URI to IdentityServer's end session endpoint, with the required parameters.](https://ident\", \"ityserver4.readthedocs.io/en/release/endpoints/endsession.html#refendsession)\\nThe end session endpoi\", \"nt is at `/connect/endsession` on port 5105 of the base endpoint exposed as\\na user setting. For more\", \" information about user settings, see Configuration management.\\n\\n\\nThe returned URI is stored in the \", \"`LoginUrl` property of the `LoginViewModel` class. While the `IsLogin`\\nproperty is `true`, the `WebV\", \"iew` in the `LoginView` is visible. The `WebView` data binds its `Source` property\\nto the `LoginUrl`\", \" property of the `LoginViewModel` class, and so makes a sign-out request to\\nIdentityServer when the \", \"`LoginUrl` property is set to IdentityServer's end session endpoint. When\\nIdentityServer receives th\", \"is request, provided that the user is signed-in, sign-out occurs.\\nAuthentication is tracked with a c\", \"ookie managed by the cookie authentication middleware from\\nASP.NET Core. Therefore, signing out of I\", \"dentityServer removes the authentication cookie and sends a\\npost logout redirect URI back to the cli\", \"ent.\\n\\n\\nIn the mobile app, the `WebView` will be redirected to the post logout redirect URI. This `We\", \"bView`\\nnavigation will cause the `NavigateAsync` method in the `LoginViewModel` class to be executed\", \", which\\nis shown in the following code example:\\n\\n\\n68 CHAPTER 9 | Authentication and authorization\\n\\n\\n\", \"This method clears both the identity token and the access token from application settings, and sets\\n\", \"the `IsLogin` property to `false`, which causes the `WebView` on the `LoginView` page to become\\ninvi\", \"sible. Finally, the `LoginUrl` [property is set to the URI of IdentityServer's authorization endpoin\", \"t,](https://identityserver4.readthedocs.io/en/release/endpoints/authorize.html)\\nwith the required pa\", \"rameters, in preparation for the next time the user initiates a sign-in.\\n\\n\\nFor information about pag\", \"e navigation, see Navigation. For information about how `WebView`\\nnavigation causes a view model met\", \"hod to be executed, see Invoking navigation using behaviors. For\\ninformation about application setti\", \"ngs, see Configuration management.\\n\\n#### Authorization\\n\\n\\nAfter authentication, ASP.NET Core web APIs\", \" often need to authorize access, which allows a service to\\nmake APIs available to some authenticated\", \" users, but not to all.\\n\\n\\nRestricting access to an ASP.NET Core MVC route can be achieved by applyin\", \"g an `Authorize` attribute\\nto a controller or action, which limits access to the controller or actio\", \"n to authenticated users, as\\nshown in the following code example:\\n\\n\\nIf an unauthorized user attempts\", \" to access a controller or action that's marked with the `Authorize`\\nattribute, the MVC framework re\", \"turns a 401 (unauthorized) HTTP status code.\\n\\n\\n69 CHAPTER 9 | Authentication and authorization\\n\\n\\nIde\", \"ntityServer can be integrated into the authorization workflow so that the access tokens it provides\\n\", \"control authorization. This approach is shown in Figure 9-5.\\n\\n\\n**Figure 9-5:** Authorization by acce\", \"ss token\\n\\n\\nThe eShopOnContainers mobile app communicates with the identity microservice and requests\", \" an\\naccess token as part of the authentication process. The access token is then forwarded to the AP\", \"Is\\nexposed by the ordering and basket microservices as part of the access requests. Access tokens\\nco\", \"ntain information about the client, and the user. APIs then use that information to authorize access\", \"\\nto their data. For information about how to configure IdentityServer to protect APIs, see Configuri\", \"ng\\nAPI resources.\\n##### **Configuring IdentityServer to perform authorization**\\n\\nTo perform authoriz\", \"ation with IdentityServer, its authorization middleware must be added to the web\\napplication's HTTP \", \"request pipeline. The middleware is added in the `ConfigureAuth` method in the\\nweb application's `St\", \"artup` class, which is invoked from the `Configure` method, and is demonstrated\\nin the following cod\", \"e example from the eShopOnContainers reference application:\\n\\n\\nThis method ensures that the API can o\", \"nly be accessed with a valid access token. The middleware\\nvalidates the incoming token to ensure tha\", \"t it's sent from a trusted issuer, and validates that the token\\nis valid to be used with the API tha\", \"t receives it. Therefore, browsing to the ordering or basket\\ncontroller will return a 401 (unauthori\", \"zed) HTTP status code, indicating that an access token is\\nrequired.\\n\\n\\n70 CHAPTER 9 | Authentication \", \"and authorization\\n\\n\\n##### **Making access requests to APIs**\\n\\nWhen making requests to the ordering a\", \"nd basket microservices, the access token, obtained from\\nIdentityServer during the authentication pr\", \"ocess, must be included in the request, as shown in the\\nfollowing code example:\\n\\n\\nThe access token i\", \"s stored as an application setting, and is retrieved from platform-specific storage\\nand included in \", \"the call to the `GetOrderAsync` method in the `OrderService` class.\\n\\n\\nSimilarly, the access token mu\", \"st be included when sending data to an IdentityServer protected API, as\\nshown in the following code \", \"example:\\n\\n\\nThe access token is retrieved from platform-specific storage and included in the call to \", \"the\\n`UpdateBasketAsync` method in the `BasketService` class.\\n\\n\\nThe `RequestProvider` class, in the e\", \"ShopOnContainers mobile app, uses the `HttpClient` class to\\nmake requests to the RESTful APIs expose\", \"d by the eShopOnContainers reference application. When\\nmaking requests to the ordering and basket AP\", \"Is, which require authorization, a valid access token\\nmust be included with the request. This is ach\", \"ieved by adding the access token to the headers of the\\n`HttpClient` instance, as demonstrated in the\", \" following code example:\\n\\n```\\n httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHe\", \"aderValue(\\\"Bearer\\\", token);\\n\\n```\\n\\nThe `DefaultRequestHeaders` property of the `HttpClient` class exp\", \"oses the headers that are sent\\nwith each request, and the access token is added to the `Authorizatio\", \"n` header prefixed with the\\nstring `Bearer` . When the request is sent to a RESTful API, the value o\", \"f the `Authorization` header is\\nextracted and validated to ensure that it's sent from a trusted issu\", \"er, and used to determine whether\\nthe user has permission to invoke the API that receives it.\\n\\n\\nFor \", \"more information about how the eShopOnContainers mobile app makes web requests, see\\nAccessing remote\", \" data.\\n#### Summary\\n\\n\\nThere are many approaches to integrating authentication and authorization into\", \" a Xamarin.Forms app\\nthat communicates with an ASP.NET MVC web application. The eShopOnContainers mo\", \"bile app\\nperforms authentication and authorization with a containerized identity microservice that u\", \"ses\\nIdentityServer 4. IdentityServer is an open source OpenID Connect and OAuth 2.0 framework for\\nAS\", \"P.NET Core that integrates with ASP.NET Core Identity to perform bearer token authentication.\\n\\n\\n71 C\", \"HAPTER 9 | Authentication and authorization\\n\\n\\nThe mobile app requests security tokens from IdentityS\", \"erver, either for authenticating a user or for\\naccessing a resource. When accessing a resource, an a\", \"ccess token must be included in the request to\\nAPIs that require authorization. IdentityServer's mid\", \"dleware validates incoming access tokens to\\nensure that they are sent from a trusted issuer, and tha\", \"t they are valid to be used with the API that\\nreceives them.\\n\\n\\n72 CHAPTER 9 | Authentication and aut\", \"horization\\n\\n\\n# Accessing remote data\\n\\nMany modern web-based solutions make use of web services, host\", \"ed by web servers, to provide\\nfunctionality for remote client applications. The operations that a we\", \"b service exposes constitute a\\nweb API.\\n\\n\\nClient apps should be able to utilize the web API without \", \"knowing how the data or operations that the\\nAPI exposes are implemented. This requires that the API \", \"abides by common standards that enable a\\nclient app and web service to agree on which data formats t\", \"o use, and the structure of the data that is\\nexchanged between client apps and the web service.\\n####\", \" Introduction to Representational State Transfer\\n\\n\\nRepresentational State Transfer (REST) is an arch\", \"itectural style for building distributed systems based\\non hypermedia. A primary advantage of the RES\", \"T model is that it's based on open standards and\\ndoesn't bind the implementation of the model or the\", \" client apps that access it to any specific\\nimplementation. Therefore, a REST web service could be i\", \"mplemented using Microsoft ASP.NET Core\\nMVC, and client apps could be developing using any language \", \"and toolset that can generate HTTP\\nrequests and parse HTTP responses.\\n\\n\\nThe REST model uses a naviga\", \"tional scheme to represent objects and services over a network, referred\\nto as resources. Systems th\", \"at implement REST typically use the HTTP protocol to transmit requests to\\naccess these resources. In\", \" such systems, a client app submits a request in the form of a URI that\\nidentifies a resource, and a\", \"n HTTP method (such as GET, POST, PUT, or DELETE) that indicates the\\noperation to be performed on th\", \"at resource. The body of the HTTP request contains any data required\\nto perform the operation.\\n\\n\\nThe\", \" response from a REST request makes use of standard HTTP status codes. For example, a request\\nthat r\", \"eturns valid data should include the HTTP response code 200 (OK), while a request that fails to\\nfind\", \" or delete a specified resource should return a response that includes the HTTP status code 404\\n(Not\", \" Found).\\n\\n\\nA RESTful web API exposes a set of connected resources, and provides the core operations \", \"that\\nenable an app to manipulate those resources and easily navigate between them. For this reason, \", \"the\\nURIs that constitute a typical RESTful web API are oriented towards the data that it exposes, an\", \"d use\\nthe facilities provided by HTTP to operate on this data.\\n\\n\\n73 CHAPTER 10 | Accessing remote da\", \"ta\\n\\n\\nThe data included by a client app in an HTTP request, and the corresponding response messages f\", \"rom\\nthe web server, could be presented in a variety of formats, known as media types. When a client \", \"app\\nsends a request that returns data in the body of a message, it can specify the media types it ca\", \"n\\nhandle in the `Accept` header of the request. If the web server supports this media type, it can r\", \"eply\\nwith a response that includes the `Content-Type` header that specifies the format of the data i\", \"n the\\nbody of the message. It's then the responsibility of the client app to parse the response mess\", \"age and\\ninterpret the results in the message body appropriately.\\n\\n\\n[For more information about REST,\", \" see API design and](https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-design) \", \"[API implementation](https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-implemen\", \"tation) on Microsoft Docs.\\n#### Consuming RESTful APIs\\n\\n\\nThe eShopOnContainers mobile app uses the M\", \"odel-View-ViewModel (MVVM) pattern, and the\\nmodel elements of the pattern represent the domain entit\", \"ies used in the app. The controller and\\nrepository classes in the eShopOnContainers reference applic\", \"ation accept and return many of these\\nmodel objects. Therefore, they are used as data transfer objec\", \"ts (DTOs) that hold all the data that is\\npassed between the mobile app and the containerized microse\", \"rvices. The main benefit of using DTOs\\nto pass data to and receive data from a web service is that b\", \"y transmitting more data in a single\\nremote call, the app can reduce the number of remote calls that\", \" need to be made.\\n##### **Making web requests**\\n\\nThe eShopOnContainers mobile app uses the `HttpClie\", \"nt` class to make requests over HTTP, with\\nJSON being used as the media type. This class provides fu\", \"nctionality for asynchronously sending HTTP\\nrequests and receiving HTTP responses from a URI identif\", \"ied resource. The `HttpResponseMessage`\\nclass represents an HTTP response message received from a RE\", \"ST API after an HTTP request has been\\nmade. It contains information about the response, including th\", \"e status code, headers, and any body.\\nThe `HttpContent` class represents the HTTP body and content h\", \"eaders, such as `Content-Type` and\\n`Content-Encoding` . The content can be read using any of the `Re\", \"adAs` methods, such as\\n`ReadAsStringAsync` and `ReadAsByteArrayAsync`, depending on the format of th\", \"e data.\\n\\n**Making a GET request**\\n\\nThe `CatalogService` class is used to manage the data retrieval p\", \"rocess from the catalog\\nmicroservice. In the `RegisterDependencies` method in the `ViewModelLocator`\", \" class, the\\n`CatalogService` class is registered as a type mapping against the `ICatalogService` typ\", \"e with the\\nAutofac dependency injection container. Then, when an instance of the `CatalogViewModel` \", \"class is\\ncreated, its constructor accepts an `ICatalogService` type, which Autofac resolves, returni\", \"ng an\\ninstance of the `CatalogService` class. For more information about dependency injection, see\\nI\", \"ntroduction to dependency injection.\\n\\n\\nFigure 10-1 shows the interaction of classes that read catalo\", \"g data from the catalog microservice for\\ndisplaying by the `CatalogView` .\\n\\n\\n74 CHAPTER 10 | Accessi\", \"ng remote data\\n\\n\\n**Figure 10-1** : Retrieving data from the catalog microservice\\n\\n\\nWhen the `Catalog\", \"View` is navigated to, the `OnInitialize` method in the `CatalogViewModel` class is\\ncalled. This met\", \"hod retrieves catalog data from the catalog microservice, as demonstrated in the\\nfollowing code exam\", \"ple:\\n\\n\\nThis method calls the `GetCatalogAsync` method of the `CatalogService` instance that was inje\", \"cted\\ninto the `CatalogViewModel` by Autofac. The following code example shows the `GetCatalogAsync`\\n\", \"method:\\n\\n\\n75 CHAPTER 10 | Accessing remote data\\n\\n\\nThis method builds the URI that identifies the res\", \"ource the request will be sent to, and uses the\\n`RequestProvider` class to invoke the GET HTTP metho\", \"d on the resource, before returning the results\\nto the `CatalogViewModel` . The `RequestProvider` cl\", \"ass contains functionality that submits a request\\nin the form of a URI that identifies a resource, a\", \"n HTTP method that indicates the operation to be\\nperformed on that resource, and a body that contain\", \"s any data required to perform the operation. For\\ninformation about how the `RequestProvider` class \", \"is injected into the `CatalogService` class, see\\nIntroduction to dependency injection.\\n\\n\\nThe followi\", \"ng code example shows the `GetAsync` method in the `RequestProvider` class:\\n\\n\\nThis method calls the \", \"`CreateHttpClient` method, which returns an instance of the `HttpClient` class\\nwith the appropriate \", \"headers set. It then submits an asynchronous GET request to the resource\\nidentified by the URI, with\", \" the response being stored in the `HttpResponseMessage` instance. The\\n`HandleResponse` method is the\", \"n invoked, which throws an exception if the response doesn't include\\na success HTTP status code. The\", \"n the response is read as a string, converted from JSON to a\\n`CatalogRoot` object, and returned to t\", \"he `CatalogService` .\\n\\n\\nThe `CreateHttpClient` method is shown in the following code example:\\n\\n\\nThis\", \" method creates a new instance of the `HttpClient` class, and sets the `Accept` header of any\\nreques\", \"ts made by the `HttpClient` instance to `application/json`, which indicates that it expects the\\ncont\", \"ent of any response to be formatted using JSON. Then, if an access token was passed as an\\nargument t\", \"o the `CreateHttpClient` method, it's added to the `Authorization` header of any\\nrequests made by th\", \"e `HttpClient` instance, prefixed with the string `Bearer` . For more information\\nabout authorizatio\", \"n, see Authorization.\\n\\n\\n76 CHAPTER 10 | Accessing remote data\\n\\n\\nWhen the `GetAsync` method in the `R\", \"equestProvider` class calls `HttpClient.GetAsync`, the `Items`\\nmethod in the `CatalogController` cla\", \"ss in the `Catalog.API` project is invoked, which is shown in the\\nfollowing code example:\\n\\n\\nThis met\", \"hod retrieves the catalog data from the SQL database using EntityFramework, and returns it\\nas a resp\", \"onse message that includes a success HTTP status code, and a collection of JSON formatted\\n`CatalogIt\", \"em` instances.\\n\\n**Making a POST request**\\n\\nThe `BasketService` class is used to manage the data retr\", \"ieval and update process with the basket\\nmicroservice. In the `RegisterDependencies` method in the `\", \"ViewModelLocator` class, the\\n`BasketService` class is registered as a type mapping against the `IBas\", \"ketService` type with the\\nAutofac dependency injection container. Then, when an instance of the `Bas\", \"ketViewModel` class is\\ncreated, its constructor accepts an `IBasketService` type, which Autofac reso\", \"lves, returning an\\ninstance of the `BasketService` class. For more information about dependency inje\", \"ction, see\\nIntroduction to dependency injection.\\n\\n\\nFigure 10-2 shows the interaction of classes that\", \" send the basket data displayed by the `BasketView`,\\nto the basket microservice.\\n\\n\\n77 CHAPTER 10 | A\", \"ccessing remote data\\n\\n\\n**Figure 10-2** : Sending data to the basket microservice\\n\\n\\nWhen an item is a\", \"dded to the shopping basket, the `ReCalculateTotalAsync` method in the\\n`BasketViewModel` class is ca\", \"lled. This method updates the total value of items in the basket, and\\nsends the basket data to the b\", \"asket microservice, as demonstrated in the following code example:\\n\\n\\nThis method calls the `UpdateBa\", \"sketAsync` method of the `BasketService` instance that was injected\\ninto the `BasketViewModel` by Au\", \"tofac. The following method shows the `UpdateBasketAsync`\\nmethod:\\n\\n\\n78 CHAPTER 10 | Accessing remote\", \" data\\n\\n\\nThis method builds the URI that identifies the resource the request will be sent to, and use\", \"s the\\n`RequestProvider` class to invoke the POST HTTP method on the resource, before returning the\\nr\", \"esults to the `BasketViewModel` . Note that an access token, obtained from IdentityServer during the\", \"\\nauthentication process, is required to authorize requests to the basket microservice. For more\\ninfo\", \"rmation about authorization, see Authorization.\\n\\n\\nThe following code example shows one of the `PostA\", \"sync` methods in the `RequestProvider` class:\\n\\n\\nThis method calls the `CreateHttpClient` method, whi\", \"ch returns an instance of the `HttpClient` class\\nwith the appropriate headers set. It then submits a\", \"n asynchronous POST request to the resource\\nidentified by the URI, with the serialized basket data b\", \"eing sent in JSON format, and the response\\nbeing stored in the `HttpResponseMessage` instance. The `\", \"HandleResponse` method is then invoked,\\nwhich throws an exception if the response doesn't include a \", \"success HTTP status code. Then, the\\nresponse is read as a string, converted from JSON to a `Customer\", \"Basket` object, and returned to the\\n`BasketService` . For more information about the CreateHttpClien\", \"t method, see Making a GET request.\\n\\n\\nWhen the `PostAsync` method in the `RequestProvider` class cal\", \"ls `HttpClient.PostAsync`, the `Post`\\nmethod in the `BasketController` class in the `Basket.API` pro\", \"ject is invoked, which is shown in the\\nfollowing code example:\\n\\n\\nThis method uses an instance of the\", \" `RedisBasketRepository` class to persist the basket data to the\\nRedis cache, and returns it as a re\", \"sponse message that includes a success HTTP status code, and a\\nJSON formatted `CustomerBasket` insta\", \"nce.\\n\\n**Making a DELETE request**\\n\\nFigure 10-3 shows the interactions of classes that delete basket \", \"data from the basket microservice, for\\nthe `CheckoutView` .\\n\\n\\n79 CHAPTER 10 | Accessing remote data\\n\", \"\\n\\n**Figure 10-3** : Deleting data from the basket microservice\\n\\n\\nWhen the checkout process is invoke\", \"d, the `CheckoutAsync` method in the `CheckoutViewModel` class\\nis called. This method creates a new \", \"order, before clearing the shopping basket, as demonstrated in\\nthe following code example:\\n\\n\\nThis me\", \"thod calls the `ClearBasketAsync` method of the `BasketService` instance that was injected\\ninto the \", \"`CheckoutViewModel` by Autofac. The following method shows the `ClearBasketAsync`\\nmethod:\\n\\n\\nThis met\", \"hod builds the URI that identifies the resource that the request will be sent to, and uses the\\n`Requ\", \"estProvider` class to invoke the DELETE HTTP method on the resource. Note that an access\\ntoken, obta\", \"ined from IdentityServer during the authentication process, is required to authorize\\nrequests to the\", \" basket microservice. For more information about authorization, see Authorization.\\n\\n\\nThe following c\", \"ode example shows the `DeleteAsync` method in the `RequestProvider` class:\\n\\n\\n80 CHAPTER 10 | Accessi\", \"ng remote data\\n\\n\\nThis method calls the `CreateHttpClient` method, which returns an instance of the `\", \"HttpClient` class\\nwith the appropriate headers set. It then submits an asynchronous DELETE request t\", \"o the resource\\nidentified by the URI. For more information about the `CreateHttpClient` method, see \", \"Making a GET\\nrequest.\\n\\n\\nWhen the `DeleteAsync` method in the `RequestProvider` class calls `HttpClie\", \"nt.DeleteAsync`, the\\n`Delete` method in the `BasketController` class in the `Basket.API` project is \", \"invoked, which is shown\\nin the following code example:\\n\\n\\nThis method uses an instance of the `RedisB\", \"asketRepository` class to delete the basket data from\\nthe Redis cache.\\n#### Caching data\\n\\n\\nThe perfo\", \"rmance of an app can be improved by caching frequently accessed data to fast storage\\nthat's located \", \"close to the app. If the fast storage is located closer to the app than the original source,\\nthen ca\", \"ching can significantly improve response times when retrieving data.\\n\\n\\nThe most common form of cachi\", \"ng is read-through caching, where an app retrieves data by\\nreferencing the cache. If the data isn't \", \"in the cache, it's retrieved from the data store and added to the\\ncache. Apps can implement read-thr\", \"ough caching with the cache-aside pattern. This pattern\\ndetermines whether the item is currently in \", \"the cache. If the item isn't in the cache, it's read from the\\n[data store and added to the cache. Fo\", \"r more information, see the Cache-Aside](https://docs.microsoft.com/en-us/azure/architecture/pattern\", \"s/cache-aside) pattern on Microsoft\\nDocs.\\n\\n\\n\\n\\n\\nDistributed applications, such as the eShopOnContaine\", \"rs reference application, should provide either\\nor both of the following caches:\\n\\n\\n  - A shared cach\", \"e, which can be accessed by multiple processes or machines.\\n\\n  - A private cache, where data is held\", \" locally on the device running the app.\\n\\n\\nThe eShopOnContainers mobile app uses a private cache, whe\", \"re data is held locally on the device\\nthat's running an instance of the app. For information about t\", \"he cache used by the\\neShopOnContainers reference application, see [.NET Microservices: Architecture \", \"for Containerized .NET](https://aka.ms/microservicesebook)\\n[Applications.](https://aka.ms/microservi\", \"cesebook)\\n\\n\\n81 CHAPTER 10 | Accessing remote data\\n\\n\\n##### **Managing data expiration**\\n\\nIt's impract\", \"ical to expect that cached data will always be consistent with the original data. Data in the\\norigin\", \"al data store might change after it's been cached, causing the cached data to become stale.\\nTherefor\", \"e, apps should implement a strategy that helps to ensure that the data in the cache is as upto-date \", \"as possible, but can also detect and handle situations that arise when the data in the cache\\nhas bec\", \"ome stale. Most caching mechanisms enable the cache to be configured to expire data, and\\nhence reduc\", \"e the period for which data might be out of date.\\n\\n\\n\\n\\n\\nWhen cached data expires, it should be remove\", \"d from the cache, and the app must retrieve the data\\nfrom the original data store and place it back \", \"into the cache.\\n\\n\\nIt's also possible that a cache might fill up if data is allowed to remain for too\", \" long a period. Therefore,\\nrequests to add new items to the cache might be required to remove some i\", \"tems in a process known\\nas _eviction_ . Caching services typically evict data on a least-recently-us\", \"ed basis. However, there are\\nother eviction policies, including most-recently-used, and first-in-fir\", \"st-out. For more information, see\\n[Caching Guidance on Microsoft Docs.](https://docs.microsoft.com/e\", \"n-us/azure/architecture/best-practices/caching)\\n##### **Caching images**\\n\\nThe eShopOnContainers mobi\", \"le app consumes remote product images that benefit from being\\ncached. These images are displayed by \", \"the `Image` control, and the `CachedImage` control provided by\\n[the FFImageLoading library.](https:/\", \"/www.nuget.org/packages/Xamarin.FFImageLoading.Forms/)\\n\\n\\nThe Xamarin.Forms `Image` control supports \", \"caching of downloaded images. Caching is enabled by\\ndefault, and will store the image locally for 24\", \" hours. In addition, the expiration time can be\\nconfigured with the `CacheValidity` [property. For m\", \"ore information, see Downloaded Image Caching](https://developer.xamarin.com/guides/xamarin-forms/us\", \"er-interface/images/#Downloaded_Image_Caching)\\non the Xamarin Developer Center.\\n\\n\\nFFImageLoading's `\", \"CachedImage` control is a replacement for the Xamarin.Forms `Image` control,\\nproviding additional pr\", \"operties that enable supplementary functionality. Amongst this functionality,\\nthe control provides c\", \"onfigurable caching, while supporting error and loading image placeholders.\\nThe following code examp\", \"le shows how the eShopOnContainers mobile app uses the `CachedImage`\\ncontrol in the `ProductTemplate\", \"`, which is the data template used by the `ListView` control in the\\n`CatalogView` :\\n\\n\\n82 CHAPTER 10 \", \"| Accessing remote data\\n\\n\\nThe `CachedImage` control sets the `LoadingPlaceholder` and `ErrorPlacehol\", \"der` properties to\\nplatform-specific images. The `LoadingPlaceholder` property specifies the image t\", \"o be displayed\\nwhile the image specified by the `Source` property is retrieved, and the `ErrorPlaceh\", \"older` property\\nspecifies the image to be displayed if an error occurs when attempting to retrieve t\", \"he image specified\\nby the `Source` property.\\n\\n\\nAs the name implies, the `CachedImage` control caches\", \" remote images on the device for the time\\nspecified by the value of the `CacheDuration` property. Wh\", \"en this property value isn't explicitly set, the\\ndefault value of 30 days is applied.\\n#### Increasin\", \"g resilience\\n\\n\\nAll apps that communicate with remote services and resources must be sensitive to tra\", \"nsient faults.\\nTransient faults include the momentary loss of network connectivity to services, the \", \"temporary\\nunavailability of a service, or timeouts that arise when a service is busy. These faults a\", \"re often selfcorrecting, and if the action is repeated after a suitable delay it's likely to succeed\", \".\\n\\n\\nTransient faults can have a huge impact on the perceived quality of an app, even if it has been\\n\", \"thoroughly tested under all foreseeable circumstances. To ensure that an app that communicates with\\n\", \"remote services operates reliably, it must be able to do all of the following:\\n\\n\\n  - Detect faults w\", \"hen they occur, and determine if the faults are likely to be transient.\\n\\n  - Retry the operation if \", \"it determines that the fault is likely to be transient and keep track of the\\nnumber of times the ope\", \"ration was retried.\\n\\n\\n  - Use an appropriate retry strategy, which specifies the number of retries, \", \"the delay between\\neach attempt, and the actions to take after a failed attempt.\\n\\n\\nThis transient fau\", \"lt handling can be achieved by wrapping all attempts to access a remote service in\\ncode that impleme\", \"nts the retry pattern.\\n##### **Retry pattern**\\n\\nIf an app detects a failure when it tries to send a \", \"request to a remote service, it can handle the failure\\nin any of the following ways:\\n\\n\\n  - Retrying \", \"the operation. The app could retry the failing request immediately.\\n\\n  - Retrying the operation afte\", \"r a delay. The app should wait for a suitable amount of time before\\nretrying the request.\\n\\n\\n  - Canc\", \"elling the operation. The application should cancel the operation and report an\\nexception.\\n\\n\\n83 CHAP\", \"TER 10 | Accessing remote data\\n\\n\\nThe retry strategy should be tuned to match the business requiremen\", \"ts of the app. For example, it's\\nimportant to optimize the retry count and retry interval to the ope\", \"ration being attempted. If the\\noperation is part of a user interaction, the retry interval should be\", \" short and only a few retries\\nattempted to avoid making users wait for a response. If the operation \", \"is part of a long running\\nworkflow, where cancelling or restarting the workflow is expensive or time\", \"-consuming, it's appropriate\\nto wait longer between attempts and to retry more times.\\n\\n\\nIf a request\", \" still fails after a number of retries, it's better for the app to prevent further requests going\\nto\", \" the same resource and to report a failure. Then, after a set period, the app can make one or more\\nr\", \"equests to the resource to see if they're successful. For more information, see Circuit breaker patt\", \"ern.\\n\\n\\n\\n\\n\\nThe eShopOnContainers mobile app does not currently implement the retry pattern when makin\", \"g\\nRESTful web requests. However, the `CachedImage` control, provided by the [FFImageLoading](https:/\", \"/www.nuget.org/packages/Xamarin.FFImageLoading.Forms/) library\\nsupports transient fault handling by \", \"retrying image loading. If image loading fails, further attempts\\nwill be made. The number of attempt\", \"s is specified by the `RetryCount` property, and retries will occur\\nafter a delay specified by the `\", \"RetryDelay` property. If these property values aren't explicitly set, their\\ndefault values are appli\", \"ed \\u2013 3 for the `RetryCount` property, and 250ms for the `RetryDelay` property.\\nFor more information \", \"about the `CachedImage` control, see Caching images.\\n\\n\\nThe eShopOnContainers reference application d\", \"oes implement the retry pattern. For more\\ninformation, including a discussion of how to combine the \", \"retry pattern with the `HttpClient` class,\\n[see .NET Microservices: Architecture for Containerized .\", \"NET Applications.](https://aka.ms/microservicesebook)\\n\\n\\n[For more information about the retry patter\", \"n, see the Retry](https://docs.microsoft.com/en-us/azure/architecture/patterns/retry) pattern on Mic\", \"rosoft Docs.\\n##### **Circuit breaker pattern**\\n\\nIn some situations, faults can occur due to anticipa\", \"ted events that take longer to fix. These faults can\\nrange from a partial loss of connectivity to th\", \"e complete failure of a service. In these situations, it's\\npointless for an app to retry an operatio\", \"n that's unlikely to succeed, and instead should accept that\\nthe operation has failed and handle thi\", \"s failure accordingly.\\n\\n\\nThe circuit breaker pattern can prevent an app from repeatedly trying to ex\", \"ecute an operation that's\\nlikely to fail, while also enabling the app to detect whether the fault ha\", \"s been resolved.\\n\\n\\nA circuit breaker acts as a proxy for operations that might fail. The proxy shoul\", \"d monitor the number\\nof recent failures that have occurred, and use this information to decide wheth\", \"er to allow the\\noperation to proceed, or to return an exception immediately.\\n\\n\\nThe eShopOnContainers\", \" mobile app does not currently implement the circuit breaker pattern.\\n[However, the eShopOnContainer\", \"s does. For more information, see .NET Microservices: Architecture](https://aka.ms/microserviceseboo\", \"k)\\n[for Containerized .NET Applications.](https://aka.ms/microservicesebook)\\n\\n\\n84 CHAPTER 10 | Acces\", \"sing remote data\\n\\n\\n[For more information about the circuit breaker pattern, see the Circuit Breaker \", \"pattern on Microsoft](https://docs.microsoft.com/en-us/azure/architecture/patterns/circuit-breaker)\\n\", \"Docs.\\n#### Summary\\n\\n\\nMany modern web-based solutions make use of web services, hosted by web servers\", \", to provide\\nfunctionality for remote client applications. The operations that a web service exposes\", \" constitute a\\nweb API, and client apps should be able to utilize the web API without knowing how the\", \" data or\\noperations that the API exposes are implemented.\\n\\n\\nThe performance of an app can be improve\", \"d by caching frequently accessed data to fast storage\\nthat's located close to the app. Apps can impl\", \"ement read-through caching with the cache-aside\\npattern. This pattern determines whether the item is\", \" currently in the cache. If the item isn't in the\\ncache, it's read from the data store and added to \", \"the cache.\\n\\n\\nWhen communicating with web APIs, apps must be sensitive to transient faults. Transient\", \" faults\\ninclude the momentary loss of network connectivity to services, the temporary unavailability\", \" of a\\nservice, or timeouts that arise when a service is busy. These faults are often self-correcting\", \", and if the\\naction is repeated after a suitable delay, then it's likely to succeed. Therefore, apps\", \" should wrap all\\nattempts to access a web API in code that implements a transient fault handling mec\", \"hanism.\\n\\n\\n85 CHAPTER 10 | Accessing remote data\\n\\n\\n# Unit testing\\n\\nMobile apps have unique problems t\", \"hat desktop and web-based applications don't have to worry\\nabout. Mobile users will differ by the de\", \"vices that they use, by network connectivity, by the availability\\nof services, and a range of other \", \"factors. Therefore, mobile apps should be tested as they will be used\\nin the real world in order to \", \"improve their quality, reliability, and performance. There are many types\\nof testing that should be \", \"performed on an app, including unit testing, integration testing, and user\\ninterface testing, with u\", \"nit testing being the most common form of testing.\\n\\n\\nA unit test takes a small unit of the app, typi\", \"cally a method, isolates it from the remainder of the code,\\nand verifies that it behaves as expected\", \". Its goal is to check that each unit of functionality performs as\\nexpected, so that errors don't pr\", \"opagate throughout the app. Detecting a bug where it occurs is more\\nefficient that observing the eff\", \"ect of a bug indirectly at a secondary point of failure.\\n\\n\\nUnit testing has the greatest effect on c\", \"ode quality when it's an integral part of the software\\ndevelopment workflow. As soon as a method has\", \" been written, unit tests should be written that verify\\nthe behavior of the method in response to st\", \"andard, boundary, and incorrect cases of input data, and\\nthat check any explicit or implicit assumpt\", \"ions made by the code. Alternatively, with test driven\\ndevelopment, unit tests are written before th\", \"e code. In this scenario, unit tests act as both design\\ndocumentation and functional specifications.\", \"\\n\\n\\nUnit tests typically use the arrange-act-assert pattern:\\n\\n\\n  - The _arrange_ section of the unit \", \"test method initializes objects and sets the value of the data\\nthat is passed to the method under te\", \"st.\\n\\n\\n  - The _act_ section invokes the method under test with the required arguments.\\n\\n  - The _ass\", \"ert_ section verifies that the action of the method under test behaves as expected.\\n\\n\\nFollowing this\", \" pattern ensures that unit tests are readable and consistent.\\n#### Dependency injection and unit tes\", \"ting\\n\\n\\nOne of the motivations for adopting a loosely-coupled architecture is that it facilitates uni\", \"t testing.\\nOne of the types registered with Autofac is the `OrderService` class. The following code \", \"example\\nshows an outline of this class:\\n\\n\\n86 CHAPTER 11 | Unit testing\\n\\n\\nThe `OrderDetailViewModel` \", \"class has a dependency on the `IOrderService` type which the container\\nresolves when it instantiates\", \" a `OrderDetailViewModel` object. However, rather than create an\\n`OrderService` object to unit test \", \"the `OrderDetailViewModel` class, instead, replace the\\n`OrderService` object with a mock for the pur\", \"pose of the tests. Figure 10-1 illustrates this relationship.\\n\\n\\n**Figure 10-1:** Classes that implem\", \"ent the IOrderService interface\\n\\n\\nThis approach allows the `OrderService` object to be passed into t\", \"he `OrderDetailViewModel` class at\\nruntime, and in the interests of testability, it allows the `Orde\", \"rMockService` class to be passed into the\\n`OrderDetailViewModel` class at test time. The main advant\", \"age of this approach is that it enables unit\\ntests to be executed without requiring unwieldy resourc\", \"es such as web services, or databases.\\n#### Testing MVVM applications\\n\\n\\nTesting models and view mode\", \"ls from MVVM applications is identical to testing any other classes, and\\nthe same tools and techniqu\", \"es \\u2013 such as unit testing and mocking, can be used. However, there are\\nsome patterns that are typica\", \"l to model and view model classes, that can benefit from specific unit\\ntesting techniques.\\n\\n\\n\\n\\n\\n[The\", \" eShopOnContainers mobile app uses xUnit to perform unit testing, which supports two different](http\", \"s://xunit.github.io/)\\ntypes of unit tests:\\n\\n\\n  - Facts are tests that are always true, which test in\", \"variant conditions.\\n\\n  - Theories are tests that are only true for a particular set of data.\\n\\n\\n87 CH\", \"APTER 11 | Unit testing\\n\\n\\nThe unit tests included with the eShopOnContainers mobile app are fact tes\", \"ts, and so each unit test\\nmethod is decorated with the `[Fact]` attribute.\\n\\n##### **Testing asynchro\", \"nous functionality**\\n\\nWhen implementing the MVVM pattern, view models usually invoke operations on s\", \"ervices, often\\nasynchronously. Tests for code that invokes these operations typically use mocks as r\", \"eplacements for\\nthe actual services. The following code example demonstrates testing asynchronous fu\", \"nctionality by\\npassing a mock service into a view model:\\n\\n\\nThis unit test checks that the `Order` pr\", \"operty of the `OrderDetailViewModel` instance will have a value\\nafter the `InitializeAsync` method h\", \"as been invoked. The `InitializeAsync` method is invoked\\nwhen the view model's corresponding view is\", \" navigated to. For more information about navigation,\\nsee Navigation.\\n\\n\\nWhen the `OrderDetailViewMod\", \"el` instance is created, it expects an `OrderService` instance to be\\nspecified as an argument. Howev\", \"er, the `OrderService` retrieves data from a web service. Therefore,\\nan `OrderMockService` instance,\", \" which is a mock version of the `OrderService` class, is specified as the\\nargument to the `OrderDeta\", \"ilViewModel` constructor. Then, when the view model's\\n`InitializeAsync` method is invoked, which inv\", \"okes `IOrderService` operations, mock data is\\nretrieved rather than communicating with a web service\", \".\\n##### **Testing INotifyPropertyChanged implementations**\\n\\nImplementing the `INotifyPropertyChanged\", \"` interface allows views to react to changes that originate\\nfrom view models and models. These chang\", \"es are not limited to data shown in controls \\u2013 they are\\nalso used to control the view, such as view \", \"model states that cause animations to be started or\\ncontrols to be disabled.\\n\\n\\nProperties that can b\", \"e updated directly by the unit test can be tested by attaching an event handler to\\nthe `PropertyChan\", \"ged` event and checking whether the event is raised after setting a new value for the\\nproperty. The \", \"following code example shows such a test:\\n\\n\\n88 CHAPTER 11 | Unit testing\\n\\n\\nThis unit test invokes th\", \"e `InitializeAsync` method of the `OrderViewModel` class, which causes its\\n`Order` property to be up\", \"dated. The unit test will pass, provided that the `PropertyChanged` event is\\nraised for the `Order` \", \"property.\\n##### **Testing message-based communication**\\n\\nView models that use the `MessagingCenter` \", \"class to communicate between loosely-coupled classes\\ncan be unit tested by subscribing to the messag\", \"e being sent by the code under test, as demonstrated\\nin the following code example:\\n\\n\\nThis unit test\", \" checks that the `CatalogViewModel` publishes the `AddProduct` message in response to\\nits `AddCatalo\", \"gItemCommand` being executed. Because the `MessagingCenter` class supports multicast\\nmessage subscri\", \"ptions, the unit test can subscribe to the `AddProduct` message and execute a callback\\ndelegate in r\", \"esponse to receiving it. This callback delegate, specified as a lambda expression, sets a\\n`boolean` \", \"field that's used by the `Assert` statement to verify the behavior of the test.\\n##### **Testing exce\", \"ption handling**\\n\\nUnit tests can also be written that check that specific exceptions are thrown for \", \"invalid actions or\\ninputs, as demonstrated in the following code example:\\n\\n\\n89 CHAPTER 11 | Unit tes\", \"ting\\n\\n\\nThis unit test will throw an exception, because the `ListView` control does not have an event\", \" named\\n`OnItemTapped` . The `Assert.Throws<T>` method is a generic method where `T` is the type of t\", \"he\\nexpected exception. The argument passed to the `Assert.Throws<T>` method is a lambda expression\\nt\", \"hat will throw the exception. Therefore, the unit test will pass provided that the lambda expression\", \"\\nthrows an `ArgumentException` .\\n\\n\\n\\n\\n##### **Testing validation**\\n\\nThere are two aspects to testing \", \"the validation implementation: testing that any validation rules are\\ncorrectly implemented, and test\", \"ing that the `ValidatableObject<T>` class performs as expected.\\n\\n\\nValidation logic is usually simple\", \" to test, because it is typically a self-contained process where the\\noutput depends on the input. Th\", \"ere should be tests on the results of invoking the `Validate` method\\non each property that has at le\", \"ast one associated validation rule, as demonstrated in the following\\ncode example:\\n\\n\\nThis unit test \", \"checks that validation succeeds when the two `ValidatableObject<T>` properties in the\\n`MockViewModel\", \"` instance both have data.\\n\\n\\nAs well as checking that validation succeeds, validation unit tests sho\", \"uld also check the values of the\\n`Value`, `IsValid`, and `Errors` property of each `ValidatableObjec\", \"t<T>` instance, to verify that the\\nclass performs as expected. The following code example demonstrat\", \"es a unit test that does this:\\n\\n\\n90 CHAPTER 11 | Unit testing\\n\\n\\nThis unit test checks that validatio\", \"n fails when the `Surname` property of the `MockViewModel` doesn't\\nhave any data, and the `Value`, `\", \"IsValid`, and Errors property of each `ValidatableObject<T>` instance\\nare correctly set.\\n#### Summar\", \"y\\n\\n\\nA unit test takes a small unit of the app, typically a method, isolates it from the remainder of\", \" the code,\\nand verifies that it behaves as expected. Its goal is to check that each unit of function\", \"ality performs as\\nexpected, so that errors don't propagate throughout the app.\\n\\n\\nThe behavior of an \", \"object under test can be isolated by replacing dependent objects with mock\\nobjects that simulate the\", \" behavior of the dependent objects. This enables unit tests to be executed\\nwithout requiring unwield\", \"y resources such as web services, or databases.\\n\\n\\nTesting models and view models from MVVM applicati\", \"ons is identical to testing any other classes, and\\nthe same tools and techniques can be used.\\n\\n\\n91 C\", \"HAPTER 11 | Unit testing\\n\\n\\n92 CHAPTER 11 | Unit testing\\n\\n\\n\"]"