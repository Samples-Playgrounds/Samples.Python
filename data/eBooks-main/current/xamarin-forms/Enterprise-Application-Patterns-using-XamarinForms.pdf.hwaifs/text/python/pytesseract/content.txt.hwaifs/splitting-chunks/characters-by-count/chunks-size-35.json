"[\"Enterprise\\nApplication\\nPatterns using\\nXamarin.Forms\\n\\n\\u00ab a \\u00bb\\n\\nDavid Britch\\nPUBLISHED BY\\n\\nDevDiv, .NET \", \"and Visual Studio produc teams\\nA division of Microsoft Corporation\\n\\nOne Microsoft Way\\n\\nRedmond, Wash\", \"ington 98052-6399\\n\\nCopyright \\u00a9 2017 by Microsoft Corporation\\n\\nAll rights reserved. No part of the co\", \"ntents of this book may be reproduced or transmitted in any\\nform or by any means without the written\", \" permission of the publisher.\\n\\nThis book is provided \\u201cas-is\\u201d and expresses the author's views and op\", \"inions. The views, opinions and\\ninformation expressed in this book, including URL and other Internet\", \" website references, may change\\nwithout notice.\\n\\nSome examples depicted herein are provided for illu\", \"stration only and are fictitious. No real association\\nor connection is intended or should be inferre\", \"d.\\n\\nMicrosoft and the trademarks listed at http://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are\\n\", \"trademarks of the Microsoft group of companies. All other marks are property of their respective\\nown\", \"ers.\\n\\nAuthor: David Britch\\n\\nDeveloper: Javier Suarez Ruiz (Plain Concepts)\\nParticipants and reviewer\", \"s: Craig Dunn, Tom Opgenorth\\nEditor: John Meade (Populus Group)\\nContents\\n\\nPrOTACE ........scescsecsc\", \"csccsccsccsccecceccscscnscnscnscsccsccsscnccscoscescnscescnscssceccnsoscosseesescescescescsscusossos\", \"cees iv\\nPUIPOSE .........cscsccscsccecscsscecscsccscscsscscscoscscsscscscsscscecsscscecescscnsescscs\", \"cesscesescncesesoscnsescscesescusesoscesesons iv\\nWhat's left out Of this ZUIdE'S SCOPE ..........cce\", \"cccccccccssssssseecccccceceassssesecceceeeesseeussseeeceeeeesssaausseeseeeeeeeaas iv\\nWho ShOuId USE \", \"this QUIdE .......... cece scsssssseeececcccceaeeeeesseecccecceesuaesssseececeeeesseuussseeseeeeeess\", \"ssuaaseeeeeeeeeeaas iV\\nHOW tO USE ThiS QUICE ...........ccccccccccsssssseeeccccceecsueesseeeeeeecess\", \"saeaeeeeeeeeeessssaeeaesseeeceeeeeesueseaseeeeeeeeseuaaaagaes V\\nINCFOCUCTION ...........sccsccsccscc\", \"sccsccsccsccscescnscnccsccsccnccsccsccscescescnscescsscescssoscoesoscescoscescescssonsonsoes 1\\nSampl\", \"e application ..............sccscsecsccecsccscsccsccscescnccecccceccscsccsccscecssceececcecescncesce\", \"scscescesscescusescesoscescs 2\\nSample application ArChiteCture............ccsssssscccccccccsseeeseee\", \"ccccccecssaessssecceeeeeesseasesseeceeeesesseeeaaseeeseseeeeeas 2\\n\\nNV Ko) 6) | =r] \\u00a9) \\u00a9 eee eee ee 4\", \"\\nEShopOnContainers.Core Project. ..............cccccccccccsscsssssseceeccccseceecssseccecccceeceease\", \"eeceeceeesseeaggeeeeeeseseeees 5\\nPlatfOriM Projects ..............cccccccsssssssssceeecccccseeesssse\", \"ececccecsssaususececeeessssaussseeeeecesessseauaaceeeeeeesssaagaasseeeegs 6\\nSUIMIMALY ......scccscsc\", \"scscscscscscscscscescscnsscscssessesssesesseeseseseseesseeseseeseeseseseenssasssaseensesesscnsssscss\", \"sesesossseseees 6\\nNIV ......cccccccscscscsccscscsccscscsccscscscescscscesessesscessnseceeeseeseseese\", \"secensnenesnenceeseencseseescnasosscscsesesaces 7\\nThe MIVVM pattern .............ccscsccsccscsccscce\", \"csccscccceccecescncceccccnccscesceccecescncescescscescnsescescscescnsoscescnsosees 7\\nVIOW oo. cecccc\", \"essccenscccececeneeecaeeesenseseeeeeseeeseaeeeseeeceeeeeeeeeeeseeeeseaeeessuecseaesessucessuecesause\", \"ssuecesecessusessaesessusensuees 8\\nVIQCWMOE ..........cccccsssssseececeeessecccseuenecceeesuenececee\", \"suaeseceeeeseeceeceeaaeeeeeeeseueeceeeeueseceeseuenseceeeeauaeseeeeeaugassss 8\\nMOCEl..........ccssse\", \"eccccceesssecceceueeseceeseeeeseceeeeeuassceeessuesececeesaaeeseeeesaeaeeeeeeeaaseceeeeeaesseeeeeeea\", \"aeceeeeeaneeeeeeseagansss 9\\nConnecting View MOdeIS tO VIEWS ..........cscescsecsccecsccsccecsccncecc\", \"nccecescnccscecceccnceccncesceccecescescscscesonsees 9\\nCreating a View Model Ceclaratively .........\", \"....cccccccccsssssssseeccccceceeeeessecccceeeeesseesseesceeeeesssuaaseeeeeeeeeeaas 10\\nCreating a vie\", \"w Model programmatically ..............ccsssssscccccccccceeessseecccccceseseeessseeeeeeeeesssueaseee\", \"eeeeeeeaes 10\\nCreating a view defined as a data template .............ccccecccccccccccsssssssecceccc\", \"eceseeessseeeeeeeeessausseeeeeeeeeeeas 11\\nAutomatically creating a view model with a View Model lOCA\", \"tOF ..............ceeeecccceeesseeeeeeeeeseeeeeeeees 11\\nUpdating views in response to changes in the\", \" underlying view model or model ..............escseeees 12\\nUl interaction USINg COMMANAS ANd HEhAVIO\", \"LS ............cescsecsececsecsccececcecescecceccececcececceccecescnceecees 13\\nIMPIEMENtiNG COMMANAS\", \"............csssssssseeececccccceeesseeecececcsssuaueusesecceceessuuseesssceseceeeeessuaeseeeseeesee\", \"ssaagees 14\\nIMPIEMENtiNg DENAVIOSS ..........cccccccssssssseseccccccsscessseeececcccessuauseseseceec\", \"eesssuaeessseeceeeeeeesseaessseseeseseseaeaaees 15\\nSUIMMALY .......cccscccscscscscscscscscsceccscses\", \"csceceseeesseseseeeeeseeeeeseseseaeseeeseesseseensesesscscesscscsesesnsesesscsssssones 17\\nDE Penden \", \"Cy INJECTION .............csscsecsccsscsccsccsccsccsccscosccscescescnscsscsscescnccecoscscescescnscn\", \"scnsonsonces 18\\nINtroduction to CEPENAeNcCy INJECTION ............ccsccsccsscsccsccsccsccsccsccnccsc\", \"csscsscnscsscnscescssossoscossossoncees 18\\nREGiStratiOn ..........cscsccscsccccscsccccscsccecscnccec\", \"ecsscscncescccnssscscnssscscnssscscncescscssescncesoscscnsoscscesoscssesoscees 20\\nRESOIUTION........\", \"...scsccsscsscnscsscsscsscsccsscsscnscsscsscnscnscnscsscnscnscnscnscescnscsscnscescsscescssoesonsons\", \"ossonsossoesonsees 22\\nManaging the lifetime of resolved ODjects..............csccsccscsecsccecsccscc\", \"ececcncescnccececnccsceececescescsseecnes 22\\n\\nSUIMMALY .......cccscccscscscscscscscscsceccscsescscec\", \"eseeesseseseeeeeseeeeeseseseaeseeeseesseseensesesscscesscscsesesnsesesscsssssones 23\\nCommunicating b\", \"etween loosely coupled COMPONENHS ...........cecceccececcsccscnccsceccsccececceceees 24\\n\\nINtroductio\", \"n to MessagingCenter.............ccsscsccsscsccsscsscsscsccsscsscsscsscsscsscsscnscssosscssosscssoss\", \"ossossonsees 24\\nDefining a MOSSABEC...........csscsscsscsscsscsscsscsscsscsccsscnscsscsscsscsscsscss\", \"csscnscsscescsscnscsscescescnsonsossossonsonsens 26\\nPUbIISHING A MESSABEC...........csecsccsscsccssc\", \"sccsscsccsccsscsscsscsccsscssssscsscsscsscsscesssscescsscescsscsscssoesossossonsens 26\\nSUDSCIIDING t\", \"O A MESSAGE ..........cscesccsccsccsccsccsccsccsccsccsccsscsccsscsccsscessssceccsscsscsssescssoesoss\", \"ossossoesossones 27\\nUnsubscribing from a Me@SSAageC..........sscsscsccsscsccsscsscsscsccsscsscsscssc\", \"sscsscsscsscsscsccssosscssosscssossossossossees 27\\nSUIMIMALY .......ccscecececscsccccscscscecececscs\", \"esesscncsceseseseesesecsesenseseseseecesscsenesseseseceececsascncnsesesesscaeaeossnenses 27\\nNAVIGATI\", \"ON .........cscecscscsccccccecscscscscsceccscecscscncscncssscsscececscecscscncesescscscscscscscassce\", \"soscscscscscseaseees 28\\nNavigating DEtWEEN Pages. ..........scsscsscsscsscsccsscsccsscsscsscsscnsssc\", \"sscsscsscsscescsscsscssosscnsonsossonscesossonsens 29\\nCreating the NavigationServiCe INStANCE.......\", \".....ccccccccscssssssseeccececeesueesseeeececcesssuaaaasseeeceeesssuaaaaaasseees 29\\nHandling Navigat\", \"ion reQUESTS ............cccccccccccccsccessseeecececcecseesesseseceeeecessuassssseececeeeessusausss\", \"eseeeeseeeaeagees 30\\nNavigating when the app is IAUNCHE ..............ccesseeeccccccccceeeeeseeececc\", \"cccsueeseseseeeeceeeessueaessseceeeeeeeeseagees 32\\nPassing ParaMeters GULING NAVIGATION ............\", \".cssseeeeccccccecsceeesseecceeceessauaesssscececeeeessueasseeseeeeseesseaeees 33\\nINVOking Navigation\", \" USING DENAVIOSS ..........cccccsssssssseccccccecseeeeeseeecceccessuueesssseececeseessusassseeceeees\", \"eseseagees 34\\nConfirming or Cancelling NAVIGATION .............:::cccceccccccccceessseeeececccesauus\", \"seeeeceeccsseauuaasseseeceeesssaaaaaaaeeees 34\\nSUIMIMALY .......ccscecececscsccccscscscecececscseses\", \"scncsceseseseesesecsesenseseseseecesscsenesseseseceececsascncnsesesesscaeaeossnenses 35\\nValid atiON \", \"..........cscssccsccsscssccsccnccnscsscsscscccsccsscsscnsccsscescescsssosscsscessossosscescessaesces\", \"cessossasssescess 36\\nSpecifying Validation rules .............csscsscssccsccsccsccsccsccsccsscnscssc\", \"sscsscsscscceccsscsscssesscssessoesossossossossones 37\\nAdding validation rules to a property .......\", \"....cssscsccsscsccsscsccsccsscsscsccsccsscsscsscsscsscsscsscssosscssssossonees 38\\nTriggering Validat\", \"ion. .............scsscssccscssccsccsccsccsccsccsccsccsccnscsscsscscsscsscsscssssscsssscssoesossosso\", \"ssossossonees 39\\nTriggering Validation MANUAy ..........cccccesssecccccccsesececeeeeseecceeeeeececee\", \"eeeesecceesuaeseeceeseugeseeeessuageeeesseges 39\\nTriggering Validation WHEN propertieS CHANGE.......\", \"......cssccccccccsseeccceesseeccceeeeseeceeeeeeeeeeeeeeauaeeeessages 40\\nDisplaying Validation Errors\", \" ..........csscsccsscsccsscsccsccsscsscsccsscsscsscsscsscnscnscsscsccsscscoescssossossossossossosses\", \"s 40\\nHighlighting a control that CONTAINS INVAlID data ..........cccsssccceeceeeecceeeeeeeeeeceeeeee\", \"ceeceseeseeeeeeeansnses 41\\nDisplaying CrrOr MESSAGES .........cccccssesssseseccccccccceeseeecececcse\", \"sueuaeseeeececeessauaueseuseseceseeessuaussseesceeeeeeaeagees 44\\nSUIMIMALY .......ccscecececscsccccs\", \"cscscecececscsesesscncsceseseseesesecsesenseseseseecesscsenesseseseceececsascncnsesesesscaeaeossnens\", \"es 45\\nCONFI guration MANAGEMENL ............cssccsccssccsccscccscssccsscsscesccsscsscnscssscsscsscss\", \"sessosscessossossoosees 46\\nCreating a SEttINGS ClASS...........ccsccsscsccsccsccsscsccsscsscsscnscss\", \"cnscnscnscsscnscnscsscsscescssoescssoescnsoesonsossonsoes 46\\nAdding a SCtting .............ssscsscss\", \"csccsscsscsscnccsscsscsscnscsscnscsscescsscnscnscsscnscescnscnscsscescssoesonsossonsossonsonees 47\\nD\", \"ata binding to USEer SETtINGS .............ccsccsccsscsccsccsccsscsscsscsscnscsscsscsscnscsscnsosscs\", \"soescnsosscssossonsonsonsees 48\\nSUIMIMALY .......ccscecececscsccccscscscecececscsesesscncscesesesees\", \"esecsesenseseseseecesscsenesseseseceececsascncnsesesesscaeaeossnenses 50\\nContaineriZed MICFOSErVICES\", \".........csscesccsscnsccsccsccssccsccsscsscesccsscsscnscsscsscsscsssessesseessossonsoosees 51\\nIMICFO\", \"SEFVICES .......sccsccscsccsccscsscsccsccccscescessscscnsessescsscscescnsescsscesescesescescnsessesc\", \"ssoscesossescssossesessossoes 52\\nCONTAINELIZATION............csccscsccscssccscscsscsccsccscsscsccscs\", \"scncescesscnscssescescssessnssesescnsossescnsscssonsesoesossesss 53\\nCommunication between client ANd\", \" MICFOSEFVICES ...........ssccsccsccsccsccsccsccsccscssccsccsscssosscssesscssoees 55\\nCOMMUNICATION D\", \"ETWEEN MICFOSEFVICES ...........scsccsscsccsscsccsscsccsccsccsccsscsccescsscsccssosscessesossossonso\", \"es 56\\nSUIMIMALY .......ccscecececscsccccscscscecececscsesesscncsceseseseesesecsesenseseseseecesscsen\", \"esseseseceececsascncnsesesesscaeaeossnenses 58\\nAuthentication and authorization ............ccscsscc\", \"sscssccsccsccssccsccsccssccsccsscsscssscsscsscsssessosssescess 59\\nAUthenticatiOn ..............ccssc\", \"sscsscsccsscsscsscnscsscnscsscsscsscnscsscnscnscnscsscescsscescnscescescsscssossonsossossossonsonees\", \" 59\\nIssuing bearer tokens USINg IdeNtitySerVer 4 ou... ccccssssssssseeeeccccecsaeesessseecececeesese\", \"assseeceeseeeeeeeagees 60\\nAdding IdentityServer to a Web application ..............ccccccccssssssese\", \"eeeccecescaaeseseeeeccceseesueesseeeseeeeeeseuanees 60\\n\\nConfiguring ID@ntityServel ...........:ccccc\", \"cccccccsssssssseecccccccssseusseeeeeececesssuauseeeeeeecesesauaaasseeeseeeesssauaaaseeess 61\\nPerform\", \"ing AUTHENTICATION ..........cccccccecessssececcceeeseccecceueneceeeceueneceeeeseanececessaeeeeceeee\", \"auesceeseesugeeeeeeeansnsss 64\\n\\nAUtTHOLiZatiOn .............scsccsscsscsscsscnscsccsscnscsscnscsscns\", \"csscsscsscnscnscnscnscsscsscescsssescescescssossossossossossonsoness 69\\nConfiguring IdentityServer t\", \"o perform AUTHOLIZATION ............cccccccsssseseeeeeeeceseceaesseeeeececesssaaaaasaeeeees 70\\nMakin\", \"g access requests to APIS............ccccccccccsscessseeeeecccceesaaeeeseseceeceeessueseseseeeeceses\", \"sueeaasseceeeeeeseseanees 7/1\\n\\nSUIMIMALY .......ccscecececscsccccscscscecececscsesesscncsceseseseese\", \"secsesenseseseseecesscsenesseseseceececsascncnsesesesscaeaeossnenses 71\\n\\nACCESSING FEMOTtE ata .....\", \"......cccecceccccsccsceccsceccecccceccsceccnccccnccsceccnccecscesceccsceccsseccnccscecesceeces 73\\n\\nI\", \"ntroduction to Representational State Transfer...............cssccscssscsccsccsccsccsccsccsccsscsscs\", \"scsscssosscnsess 73\\n\\nCONSUMINg RESTFUul APIs ............sccsscsscsscsccsscsccsscsscsscnscsscnccsscn\", \"scsscescssosscsscescsscsscsscescusoesossossonsones 74\\nMaking WeD requests ...........cccccccccssssss\", \"seeeecccecsssseesseeececcecsssausasseeseeceesssueesseseeseceeeesssuausseeeeeeeeeesaaagees 74\\n\\nCachin\", \"g data ............ccsscsscsscssccscssccscsscsscnscnscsscnscsscnscsscnscsscnscnscsscescnssnscsscescs\", \"soescssoescesoesessossonsonss 81\\nManaging data Cxpiration ............ccccessssscececccccceeesseeece\", \"ccccssseeaeesesecceceesssueaesssseseceseeesauaassseeseeeeeseaaagees 82\\nCACHING IMAGES ...........0sc\", \"cccccccccccssssseeccccceecceaessssseeeeceeeessseuuseeeeceeeesssuuuuseeeceeecesssauaasseeeeceeessuaaa\", \"aaagsseees 82\\n\\nINCFEASING F@SIICNCE ...........ccsecsccsscsccsscnccsccsscsccsscnscnscsscnscsscnscssc\", \"sscnscsscescsscescsscesonsossoesossossossonsens 83\\nREtry Pattern oe ceccccccsseeeeeeeeeeeeeeeeeeeeee\", \"eeeeeea nese eeeeaeeeaeeeG EEG HEA;G EEE; ES;IEE;GE ESSE ES;HEE;GEEEGE ESE EEEEEEEE EEE: 83\\nCircuit \", \"Dreaker Pattern ............ceeesssssssccccccccsessssseeccecccesseeusseeeeeeceesssauuusseeeceeecesss\", \"uuaaagseeeeeessssaagaagsseeess 84\\n\\nSUIMIMALY .......ccscecececscsccccscscscecececscsesesscncsceseses\", \"eesesecsesenseseseseecesscsenesseseseceececsascncnsesesesscaeaeossnenses 85\\n\\nUMIt TOSTING...........\", \".cecscsccccccecscscscscscsccscecscscscscscsssccscececscecscscncesescscscscscsescasscesoscscscscsesea\", \"seees 86\\n\\nDependency injection and UNIt teStiNG ..............cssccsscsccsscsccsccsccsscsccsccnscssc\", \"nscsscsscescnscssossossossonsees 86\\n\\nTesting MVVM applications .............ccsccscssccscssccsccsccs\", \"ccsccsccsccsscsscsscsscsscsscsscsssscssosscssssossssossosees 87\\nTesting ASYNCHFONOUS FUNCTIONALILY..\", \"...........ccccccccssssssseececccccceaesseeeecceccssseaaeeseeececeeessuaeeasssceeeeseeseaaeees 88\\nTe\", \"sting INotifyPropertyChanged iMpleMentatiOns..............csscccccccccccsseeeseeeeccccecsseeeeesseec\", \"eeeeseeseeaeees 88\\nTesting MeSSage-basSed COMMUNICATION ............:cscssseececccccsceeseeeeccccecs\", \"scuaususeeeecceeeeesuaesseceeeeeeesesaases 89\\nTeStING EXCEPTION NANCIING.............ccsssssssseeccc\", \"cccceeessseeeececeecssuauaceecececesssseausseeeceeeesessueasseesceeseeeseagees 89\\nT@StING VALIDATION\", \" ..........ccssesssseccccccccsceesseseeeceeceeesauasseeeeeceecessaauseeeeeeeessssaeeeesseeeeeeeesuau\", \"aaaassceeeeeeeesaagees 90\\n\\nSUIMIMALY .......ccscecececscsccccscscscecececscsesesscncsceseseseesesecs\", \"esenseseseseecesscsenesseseseceececsascncnsesesesscaeaeossnenses 91\\nPreface\\n\\nPurpose\\n\\nThis eBook pro\", \"vides guidance on building cross-platform enterprise apps using Xamarin.Forms.\\nXamarin.Forms is a cr\", \"oss-platform UI toolkit that allows developers to easily create native user\\ninterface layouts that c\", \"an be shared across platforms, including iOS, Android, and the Universal\\nWindows Platform (UWP). It \", \"provides a comprehensive solution for Business to Employee (B2E),\\nBusiness to Business (B2B), and Bu\", \"siness to Consumer (B2C) apps, providing the ability to share code\\nacross all target platforms and h\", \"elping to lower the total cost of ownership (TCO).\\n\\nThe guide provides architectural guidance for de\", \"veloping adaptable, maintainable, and testable\\nXamarin.Forms enterprise apps. Guidance is provided o\", \"n how to implement MVVM, dependency\\ninjection, navigation, validation, and configuration management,\", \" while maintaining loose coupling. In\\naddition, there's also guidance on performing authentication a\", \"nd authorization with IdentityServer,\\naccessing data from containerized microservices, and unit test\", \"ing.\\n\\nThe guide comes with source code for the eShopOnContainers mobile app, and source code for the\", \"\\neShopOnContainers reference app. The eshopOnContainers mobile app is a cross-platform enterprise\\nap\", \"p developed using Xamarin.Forms, which connects to a series of containerized microservices known\\nas \", \"the eShopOnContainers reference app. However, the eshopOnContainers mobile app can be\\nconfigured to \", \"consume data from mock services for those who wish to avoid deploying the\\ncontainerized microservice\", \"s.\\n\\nWhat's left out of this guide's scope\\n\\nThis guide is aimed at readers who are already familiar w\", \"ith Xamarin.Forms. For a detailed\\nintroduction to Xamarin.Forms, see the Xamarin.Forms documentation\", \" on the Xamarin Developer\\n\\nCenter, and Creating Mobile Apps with Xamarin.Forms.\\nThe guide is complem\", \"entary to .NET Microservices: Architecture for Containerized .NET Applications,\\nwhich focuses on dev\", \"eloping and deploying containerized microservices. Other guides worth reading\\n\\ninclude Architecting \", \"and Developing Modern Web Applications with ASP.NET Core and Microsoft\\nAzure, Containerized Docker A\", \"pplication Lifecycle with Microsoft Platform and Tools, and Microsoft\\nPlatform and Tools for Mobile \", \"App Development.\\n\\nWho should use this guide\\n\\nThe audience for this guide is mainly developers and ar\", \"chitects who would like to learn how to\\narchitect and implement cross-platform enterprise apps using\", \" Xamarin.Forms.\\n\\niV Preface\\nA secondary audience is technical decision makers who would like to rece\", \"ive an architectural and\\ntechnology overview before deciding on what approach to select for cross-pl\", \"atform enterprise app\\ndevelopment using Xamarin.Forms.\\n\\nHow to use this guide\\n\\nThis guide focuses on\", \" building cross-platform enterprise apps using Xamarin.Forms. As such, it should\\nbe read in its enti\", \"rety to provide a foundation of understanding such apps and their technical\\nconsiderations. The guid\", \"e, along with its sample app, can also serve as a starting point or reference for\\ncreating a new ent\", \"erprise app. Use the associated sample app as a template for the new app, or to see\\nhow to organize \", \"an app's component parts. Then, refer back to this guide for architectural guidance.\\n\\nFeel free to f\", \"orward this guide to team members to help ensure a common understanding of cross -\\nplatform enterpri\", \"se app development using Xamarin.Forms. Having everybody working from a\\ncommon set of terminologies \", \"and underlying principles will help ensure a consistent application of\\narchitectural patterns and pr\", \"actices.\\n\\nV Preface\\nCHAPTER\\n\\nIntroduction\\n\\nRegardless of platform, developers of enterprise apps fac\", \"e several challenges:\\ne App requirements that can change over time.\\ne New business opportunities and\", \" challenges.\\n\\ne Ongoing feedback during development that can significantly affect the scope and\\nrequ\", \"irements of the app.\\n\\nWith these in mind, it's important to build apps that can be easily modified o\", \"r extended over time.\\nDesigning for such adaptability can be difficult as it requires an architectur\", \"e that allows individual\\nparts of the app to be independently developed and tested in isolation with\", \"out affecting the rest of\\nthe app.\\n\\nMany enterprise apps are sufficiently complex to require more th\", \"an one developer. It can be a\\nsignificant challenge to decide how to design an app so that multiple \", \"developers can work effectively\\non different pieces of the app independently, while ensuring that th\", \"e pieces come together seamlessly\\nwhen integrated into the app.\\n\\nThe traditional approach to designi\", \"ng and building an app results in what is referred to as a\\nmonolithic app, where components are tigh\", \"tly coupled with no clear separation between them.\\nTypically, this monolithic approach leads to apps\", \" that are difficult and inefficient to maintain, because\\nit can be difficult to resolve bugs without\", \" breaking other components in the app, and it can be\\ndifficult to add new features or to replace exi\", \"sting features.\\n\\nAn effective remedy for these challenges is to partition an app into discrete, loos\", \"ely coupled\\ncomponents that can be easily integrated together into an app. Such an approach offers s\", \"everal\\nbenefits:\\n\\ne It allows individual functionality to be developed, tested, extended, and mainta\", \"ined by\\ndifferent individuals or teams.\\n\\ne It promotes reuse and a clean separation of concerns betw\", \"een the app's horizontal\\ncapabilities, such as authentication and data access, and the vertical capa\", \"bilities, such as app\\nspecific business functionality. This allows the dependencies and interactions\", \" between app\\ncomponents to be more easily managed.\\n\\ne It helps maintain a separation of roles by all\", \"owing different individuals, or teams, to focus on\\na specific task or piece of functionality accordi\", \"ng to their expertise. In particular, it provides a\\ncleaner separation between the user interface an\", \"d the app's business logic.\\n\\nHowever, there are many issues that must be resolved when partitioning \", \"an app into discrete, loosely\\ncoupled components. These include:\\n\\ne Deciding how to provide a clean \", \"separation of concerns between the user interface controls\\nand their logic. One of the most importan\", \"t decisions when creating a Xamarin.Forms\\nenterprise app is whether to place business logic in code-\", \"behind files, or whether to create a\\nclean separation of concerns between the user interface control\", \"s and their logic, in order to\\n\\n1 CHAPTER 1 | Introduction\\nmake the app more maintainable and testab\", \"le. For more information, see Model-View-\\nViewModel.\\n\\nDetermining whether to use a dependency inject\", \"ion container. Dependency injection\\ncontainers reduce the dependency coupling between objects by pro\", \"viding a facility to\\nconstruct instances of classes with their dependencies injected, and manage the\", \"ir lifetime\\nbased on the configuration of the container. For more information, see Dependency inject\", \"ion.\\n\\nChoosing between platform provided eventing and loosely coupled message-based\\ncommunication be\", \"tween components that are inconvenient to link by object and type\\nreferences. For more information, \", \"see Introduction to Communicating between loosely\\n\\ncoupled components.\\n\\nDeciding how to navigate bet\", \"ween pages, including how to invoke navigation, and where\\nnavigation logic should reside. For more i\", \"nformation, see Navigation.\\n\\nDetermining how to validate user input for correctness. The decision mu\", \"st include how to\\nvalidate user input, and how to notify the user about validation errors. For more \", \"information,\\nsee Validation.\\n\\nDeciding how to perform authentication, and how to protect resources w\", \"ith authorization. For\\nmore information, see Authentication and authorization.\\n\\nDetermining how to a\", \"ccess remote data from web services, including how to reliably retrieve\\ndata, and how to cache data.\", \" For more information, see Accessing remote data.\\n\\nDeciding how to test the app. For more informatio\", \"n, see Unit testing.\\n\\nThis guide provides guidance on these issues, and focuses on the core patterns\", \" and architecture for\\nbuilding a cross-platform enterprise app using Xamarin.Forms. The guidance aim\", \"s to help to produce\\nadaptable, maintainable, and testable code, by addressing common Xamarin.Forms \", \"enterprise app\\ndevelopment scenarios, and by separating the concerns of presentation, presentation l\", \"ogic, and\\nentities through support for the Model-View-ViewModel (MVVM) pattern.\\n\\nSample application\\n\", \"\\nThis guide includes a sample application, eSshopOnContainers, that's an online store that includes \", \"the\\nfollowing functionality:\\n\\nAuthenticating and authorizing against a backend service.\\n\\nBrowsing a \", \"catalog of shirts, coffee mugs, and other marketing items.\\nFiltering the catalog.\\n\\nOrdering items fr\", \"om the catalog.\\n\\nViewing the user's order history.\\n\\nConfiguration of settings.\\n\\nSample application a\", \"rchitecture\\n\\nFigure 1-1 provides a high-level overview of the architecture of the sample application\", \".\\n\\nCHAPTER 1 | Introduction\\nmien SBS | Docker Host \\u201cdentity Microservice (srs usen)\\n\\n| [\\n| eShop Mob\", \"ile App l re 1 Web API\\n[ Mamarin.Pornms | = ue meres\\nCF | ; Container atanase i\\n| xPlatform 05: .\\nWS\", \". |\\n[ ee ; * Catalog Microservice a\\nWeb API\\n| SQL Server\\neShop Traditional WebApp | database\\n| __ Se\", \"ntainer )\\n[| MMR pf\\n] \\u201d Ordering Micraservice \\u2018\\n| Web API\\n| SOL Server\\n| Container aa\\n|\\n| \\u201cBasket Mi\", \"croservice\\n| | Web AP\\n= \\u2014* in Redis cache\\n| Typescript / Angular 2 | __ fontaimer /\\nL mz Yt Vt hz tz\", \" | = | i mz mz 7 mz mz i i Yt | mz\\n\\nFigu re 1-1: eShopOnContainers high- -level architecture\\n\\nThe sa\", \"mple application ships with three client apps:\\n\\nAn MVC application developed with ASP.NET Core.\\n\\nA S\", \"ingle Page Application (SPA) developed with Angular 2 and Typescript. This approach for\\nweb applicat\", \"ions avoids performing a round-trip to the server with each operation.\\n\\nA mobile app developed with \", \"Xamarin.Forms, which supports iOS, Android, and the Universal\\nWindows Platform (UWP).\\n\\nFor informati\", \"on about the web applications, see Architecting and Developing Modern Web\\nApplications with ASP.NET \", \"Core and Microsoft Azure.\\n\\nThe sample application includes the following backend services:\\n\\nAn ident\", \"ity microservice, which uses ASP.NET Core Identity and IdentityServer.\\n\\nA catalog microservice, whic\", \"h is a data-driven create, read, update, delete (CRUD) service that\\nconsumes an SQL Server database \", \"using EntityFramework Core.\\n\\nAn ordering microservice, which is a domain-driven service that uses do\", \"main-driven design\\npatterns.\\n\\nA basket microservice, which is a data-driven CRUD service that uses R\", \"edis Cache.\\n\\nThese backend services are implemented as microservices using ASP.NET Core MVC, and are\", \"\\ndeployed as unique containers within a single Docker host. Collectively, these backend services are\", \"\\nreferred to as the eShopOnContainers reference application. Client apps communicate with the\\nbacken\", \"d services through a Representational State Transfer (REST) web interface. For more\\ninformation abou\", \"t microservices and Docker, see Containerized microservices.\\n\\nFor information about the implementati\", \"on of the backend services, see .NET Microservices:\\nArchitecture for Containerized .NET Applications\", \".\\n\\nCHAPTER 1 | Introduction\\nMobile app\\n\\nThis guide focuses on building cross-platform enterprise app\", \"s using Xamarin.Forms, and uses the\\neShopOnContainers mobile app as an example. Figure 1-2 shows the\", \" pages from the\\neShopOnContainers mobile app that provide the functionality outlined earlier.\\n\\nSHIPP\", \"ING ADDRESS\\n120 E 87th Street\\n\\n.\\u00abT BLUE SWEATSHIRT (M)\\n\\nLOG OUT\\nVisual Studio\\nMY ORDERS\\nT-Shirt\\nORDE\", \"R NUMBER DATE\\n2016/N-123 NOVEMBER 29\\n2016\\nTOTAL STATUS\\n$56.40 DELIVERED\\nORDER NUMBER DATE\\n.NET BOT B\", \"LUE SWEATSHIRT (M) 2016/N1-132 NOVEMBER 29\\n2016\\n$19.50\\nTOTAL STATUS\\n$56.40 DELIVERED\\n\\nSHOPPING CART\\n\", \"\\nNET BOT BLUE SWEATSHIRT\\n(M)\\n\\n$19.50\\n$16.50 1 1\\n$16.50 $19.50\\n.. BLACK SWEATSHIRT (M)\\nNET BLACK CUPT\", \"\\n$19.95 2\\n$39.90 \\u2014 1\\n$17.00\\nTOTAL\\n$36.50\\n\\nSettings\\n\\nUse Mock Services\\n\\nMock Services are simulated o\", \"bjects that\\nmimic the behavior of reel services in\\ncontrolled ways\\n\\nMONMEO NIIMREO\\n\\nMATE\\n\\nTOTAL\\nFigu\", \"re 1-2: The eShopOnContainers mobile app\\n\\nThe mobile app consumes the backend services provided by t\", \"he eSshopOnContainers reference\\napplication. However, it can be configured to consume data from mock\", \" services for those who wish to\\navoid deploying the backend services.\\n\\nThe eShopOnContainers mobile \", \"app exercises the following Xamarin.Forms functionality:\\ne XAML\\ne Controls\\ne Bindings\\ne Converters\\n\\n\", \"e Styles\\n\\n4 CHAPTER 1 | Introduction\\ne Animations\\n\\ne Commands\\n\\ne Behaviors\\n\\ne Triggers\\n\\ne Effects\\n\\ne\", \" Custom Renderers\\ne MessagingCenter\\ne Custom Controls\\n\\nFor more information about this functionality\", \", see the Xamarin.Forms documentation on the Xamarin\\nDeveloper Center, and Creating Mobile Apps with\", \" Xamarin.Forms.\\n\\nIn addition, unit tests are provided for some of the classes in the eshopOnContaine\", \"rs mobile app.\\nMobile app solution\\n\\nThe eShopOnContainers mobile app solution organizes the source c\", \"ode and other resources into\\nprojects. All of the projects use folders to organize the source code a\", \"nd other resources into\\ncategories. The following table outlines the projects that make up the eshop\", \"OnContainers mobile\\n\\napp:\\n\\nProject | Description\\nthat contains the shared code and shared Ul\\nentry p\", \"oint for the Android app.\\npoint for the iOS app.\\n\\neShopOnContainers. UWP This project holds Universa\", \"l Windows Platform (UWP)\\nspecific code and is the entry point for the Windows\\n\\napp.\\neShopOnContainer\", \"s.UnitTests project.\\neShopOnContainers.UnitTests project.\\nrunner for the eshopOnContainers.UnitTests\", \" project.\\neShopOnContainers.Core project.\\n\\nThe classes from the eShopOnContainers mobile app can be \", \"re-used in any Xamarin.Forms app with\\nlittle or no modification.\\n\\neShopOnContainers.Core project\\n\\nTh\", \"e eShopOnContainers.Core PCL project contains the following folders:\\n\\n5 CHAPTER 1 | Introduction\\nFol\", \"der Description\\n\\ncolor of specific Entry controls.\\n\\nContains interfaces and classes that implement s\", \"ervices that are provided to the\\napp.\\n\\nContains the BeginAnimation trigger, which is used to invoke \", \"an animation in\\nXAML.\\n\\nValidations Contains classes involved in validating data input.\\nViewModels_ |\", \" Contains the application logic that's exposed to pages.\\nContains the pages for the app.\\n\\nPlatform p\", \"rojects\\n\\nThe platform projects contain effect implementations, custom renderer implementations, and \", \"other\\nplatform-specific resources.\\n\\nSummary\\n\\nXamarin's cross-platform mobile app development tools a\", \"nd platforms provide a comprehensive\\nsolution for B2E, B2B, and B2C mobile client apps, providing th\", \"e ability to share code across all target\\nplatforms (iOS, Android, and Windows) and helping to lower\", \" the total cost of ownership. Apps can\\nshare their user interface and app logic code, while retainin\", \"g the native platform look and feel.\\n\\nDevelopers of enterprise apps face several challenges that can\", \" alter the architecture of the app during\\ndevelopment. Therefore, it's important to build an app so \", \"that it can be modified or extended over\\ntime. Designing for such adaptability can be difficult, but\", \" typically involves partitioning an app into\\ndiscrete, loosely coupled components that can be easily\", \" integrated together into an app.\\n\\n6 CHAPTER 1 | Introduction\\nCHAPTER\\n\\nMVVM\\n\\nThe Xamarin.Forms devel\", \"oper experience typically involves creating a user interface in XAML, and then\\nadding code-behind th\", \"at operates on the user interface. As apps are modified, and grow in size and\\nscope, complex mainten\", \"ance issues can arise. These issues include the tight coupling between the UI\\ncontrols and the busin\", \"ess logic, which increases the cost of making Ul modifications, and the difficulty\\nof unit testing s\", \"uch code.\\n\\nThe Model-View-ViewModel (MVVM) pattern helps to cleanly separate the business and presen\", \"tation\\nlogic of an application from its user interface (Ul). Maintaining a clean separation between \", \"application\\nlogic and the UI helps to address numerous development issues and can make an applicatio\", \"n easier\\nto test, maintain, and evolve. It can also greatly improve code re-use opportunities and al\", \"lows\\ndevelopers and UI designers to more easily collaborate when developing their respective parts o\", \"f an\\n\\nThe MVVM pattern\\n\\nThere are three core components in the MVVM pattern: the model, the view, an\", \"d the view model.\\nEach serves a distinct purpose. Figure 2-1 shows the relationships between the thr\", \"ee components.\\n\\nData Binding ViewModel updates\\ni and Commands ; the model\\nView View Model > Model\\nHy\", \" ! H !\\nSend notifications Send notifications\\n\\nFigure 2-1: The MVVM pattern\\n\\nIn addition to understan\", \"ding the responsibilities of each components, it's also important to\\nunderstand how they interact wi\", \"th each other. At a high level, the view \\\"knows about\\\" the view model,\\nand the view model \\\"knows abo\", \"ut\\\" the model, but the model is unaware of the view model, and the\\nview model is unaware of the view\", \". Therefore, the view model isolates the view from the model, and\\nallows the model to evolve indepen\", \"dently of the view.\\n\\nThe benefits of using the MVVM pattern are as follows:\\n\\ne If there's an existin\", \"g model implementation that encapsulates existing business logic, it can\\nbe difficult or risky to ch\", \"ange it. In this scenario, the view model acts as an adapter for the\\nmodel classes and enables you t\", \"o avoid making any major changes to the model code.\\n\\n7 CHAPTER 2 | MVVM\\ne Developers can create unit\", \" tests for the view model and the model, without using the view.\\nThe unit tests for the view model c\", \"an exercise exactly the same functionality as used by the\\nview.\\n\\ne The app UI can be redesigned with\", \"out touching the code, provided that the view is\\nimplemented entirely in XAML. Therefore, a new vers\", \"ion of the view should work with the\\nexisting view model.\\n\\ne Designers and developers can work indep\", \"endently and concurrently on their components\\nduring the development process. Designers can focus on\", \" the view, while developers can work\\non the view model and model components.\\n\\nThe key to using MVVM \", \"effectively lies in understanding how to factor app code into the correct\\nclasses, and in understand\", \"ing how the classes interact. The following sections discuss the\\nresponsibilities of each of the cla\", \"sses in the MVVM pattern.\\n\\nView\\n\\nThe view is responsible for defining the structure, layout, and app\", \"earance of what the user sees on\\nscreen. Ideally, each view is defined in XAML, with a limited code-\", \"behind that does not contain\\nbusiness logic. However, in some cases, the code-behind might contain U\", \"I logic that implements\\nvisual behavior that is difficult to express in XAML, such as animations.\\n\\nI\", \"n a Xamarin.Forms application, a view Is typically a Page-derived or ContentVi ew-derived class.\\nHow\", \"ever, views can also be represented by a data template, which specifies the Ul elements to be\\nused t\", \"o visually represent an object when it's displayed. A data template as a view does not have any\\ncode\", \"-behind, and is designed to bind to a specific view model type.\\n\\nTip: Avoid enabling and disabling U\", \"l elements in the code-behind\\n\\nEnsure that view models are responsible for defining logical state ch\", \"anges that affect some aspects\\nof the view's display, such as whether a command is available, or an \", \"indication that an operation is\\npending. Therefore, enable and disable UI elements by binding to vie\", \"w model properties, rather\\nthan enabling and disabling them in code-behind.\\n\\nThere are several optio\", \"ns for executing code on the view model in response to interactions on the\\nview, such as a button cl\", \"ick or item selection. If a control supports commands, the control's Command\\nproperty can be data-bo\", \"und to an ICommand property on the view model. When the control's\\ncommand Is invoked, the code in th\", \"e view model will be executed. In addition to commands,\\nbehaviors can be attached to an object in th\", \"e view and can listen for either a command to be invoked\\nor event to be raised. In response, the beh\", \"avior can then invoke an ICommand on the view model or a\\nmethod on the view model.\\n\\nViewModel\\n\\nThe v\", \"iew model implements properties and commands to which the view can data bind to, and\\nnotifies the vi\", \"ew of any state changes through change notification events. The properties and\\ncommands that the vie\", \"w model provides define the functionality to be offered by the UI, but the view\\ndetermines how that \", \"functionality is to be displayed.\\n\\nTip: Keep the UI responsive with asynchronous operations\\n\\nMobile \", \"apps should keep the UI thread unblocked to improve the user's perception of\\nperformance. Therefore,\", \" in the view model, use asynchronous methods for I/O operations and raise\\nevents to asynchronously n\", \"otify views of property changes.\\n\\n8 CHAPTER 2 | MVVM\\nThe view model is also responsible for coordina\", \"ting the view's interactions with any model classes that\\nare required. There's typically a one-to-ma\", \"ny relationship between the view model and the model\\nclasses. The view model might choose to expose \", \"model classes directly to the view so that controls in\\nthe view can data bind directly to them. In t\", \"his case, the model classes will need to be designed to\\nsupport data binding and change notification\", \" events.\\n\\nEach view model provides data from a model in a form that the view can easily consume. To\\n\", \"\\naccomplish this, the view model sometimes performs data conversion. Placing this data conversion in\", \"\\nthe view model is a good idea because it provides properties that the view can bind to. For example\", \",\\nthe view model might combine the values of two properties to make it easier for display by the vie\", \"w.\\n\\nTip: Centralize data conversions in a conversion layer\\n\\nIt's also possible to use converters as \", \"a separate data conversion layer that sits between the view\\nmodel and the view. This can be necessar\", \"y, for example, when data requires special formatting that\\nthe view model doesn't provide.\\n\\nIn order\", \" for the view model to participate in two-way data binding with the view, its properties must\\nraise \", \"the PropertyChanged event. View models satisfy this requirement by implementing the\\nINotifyPropertyC\", \"hanged interface, and raising the PropertyChanged event when a property is\\nchanged.\\n\\nFor collections\", \", the view-friendly Observab1eCollection<T> is provided. This collection implements\\ncollection chang\", \"ed notification, relieving the developer from having to implement the\\nINotifyCollectionChanged inter\", \"face on collections.\\n\\nModel\\n\\nModel classes are non-visual classes that encapsulate the app's data. T\", \"herefore, the model can be\\nthought of as representing the app's domain model, which usually includes\", \" a data model along with\\nbusiness and validation logic. Examples of model objects include data trans\", \"fer objects (DTOs), Plain\\nOld CLR Objects (POCOs), and generated entity and proxy objects.\\n\\nModel cl\", \"asses are typically used in conjunction with services or repositories that encapsulate data\\naccess a\", \"nd caching.\\n\\nConnecting view models to views\\n\\nView models can be connected to views by using the dat\", \"a-binding capabilities of Xamarin.Forms.\\nThere are many approaches that can be used to construct vie\", \"ws and view models and associate them\\nat runtime. These approaches fall into two categories, known a\", \"s view first composition, and view\\nmodel first composition. Choosing between view first composition \", \"and view model first composition is\\nan issue of preference and complexity. However, all approaches s\", \"hare the same aim, which is for the\\nview to have a view model assigned to its BindingContext propert\", \"y.\\n\\nWith view first composition the app is conceptually composed of views that connect to the view\\nm\", \"odels they depend on. The primary benefit of this approach is that it makes it easy to construct\\nloo\", \"sely coupled, unit testable apps because the view models have no dependence on the views\\nthemselves.\", \" It's also easy to understand the structure of the app by following its visual structure,\\nrather tha\", \"n having to track code execution to understand how classes are created and associated. In\\naddition, \", \"view first construction aligns with the Xamarin.Forms navigation system that's responsible\\nfor const\", \"ructing pages when navigation occurs, which makes a view model first composition complex\\nand misalig\", \"ned with the platform.\\n\\n9 CHAPTER 2 | MVVM\\nWith view model first composition the app is conceptually\", \" composed of view models, with a service\\nbeing responsible for locating the view for a view model. V\", \"iew model first composition feels more\\nnatural to some developers, since the view creation can be ab\", \"stracted away, allowing them to focus\\non the logical non-UI structure of the app. In addition, it al\", \"lows view models to be created by other\\nview models. However, this approach is often complex and it \", \"can become difficult to understand how\\nthe various parts of the app are created and associated.\\n\\nTip\", \": Keep view models and views independent\\n\\nThe binding of views to a property in a data source should\", \" be the view's principal dependency on\\nits corresponding view model. Specifically, don't reference v\", \"iew types, such as Button and\\nListView, from view models. By following the principles outlined here,\", \" view models can be tested\\nin isolation, therefore reducing the likelihood of software defects by li\", \"miting scope.\\n\\nThe following sections discuss the main approaches to connecting view models to views\", \".\\n\\nCreating a view model declaratively\\n\\nThe simplest approach is for the view to declaratively insta\", \"ntiate its corresponding view model in\\nXAML. When the view is constructed, the corresponding view mo\", \"del object will also be constructed.\\nThis approach is demonstrated in the following code example:\\n\\n<\", \"ContentPage ... xmIns:local=\\\"clr-namespace:eShop\\\">\\n<ContentPage.BindingContext>\\n<local:LoginViewMode\", \"l />\\n</ContentPage.BindingContext>\\n\\n</ContentPage>\\n\\nWhen the ContentPage Is created, an instance of \", \"the LoginViewModel is automatically constructed\\nand set as the view's BindingContext.\\n\\nThis declarat\", \"ive construction and assignment of the view model by the view has the advantage that\\nit's simple, bu\", \"t has the disadvantage that it requires a default (parameter-less) constructor in the view\\nmodel.\\n\\nC\", \"reating a view model programmatically\\n\\nA view can have code in the code-behind file that results in \", \"the view model being assigned to its\\nBindingContext property. This is often accomplished in the view\", \"'s constructor, as shown in the\\nfollowing code example:\\n\\npublic LoginView()\\n{\\nInitializeComponent ()\", \" ;\\nBindingContext = new LoginViewModel (navigationService) ;\\n\\nThe programmatic construction and assi\", \"gnment of the view model within the view's code-behind has\\nthe advantage that it's simple. However, \", \"the main disadvantage of this approach is that the view\\nneeds to provide the view model with any req\", \"uired dependencies. Using a dependency injection\\ncontainer can help to maintain loose coupling betwe\", \"en the view and view model. For more\\n\\ninformation, see Dependency injection.\\n\\n10 CHAPTER 2 | MVVM\\nCr\", \"eating a view defined as a data template\\n\\nA view can be defined as a data template and associated wi\", \"th a view model type. Data templates can\\nbe defined as resources, or they can be defined inline with\", \"in the control that will display the view\\nmodel. The content of the control is the view model instan\", \"ce, and the data template is used to visually\\nrepresent it. This technique is an example of a situat\", \"ion in which the view model is instantiated first,\\nfollowed by the creation of the view.\\n\\nAutomatica\", \"lly creating a view model with a view model locator\\n\\nA view model locator is a custom class that man\", \"ages the instantiation of view models and their\\nassociation to views. In the eShopOnContainers mobil\", \"e app, the ViewModelLocator class has an\\nattached property, AutoWi reVi ewMode1, that's used to asso\", \"ciate view models with views. In the view's\\nXAML, this attached property is set to true to indicate \", \"that the view model should be automatically\\nconnected to the view, as shown in the following code ex\", \"ample:\\n\\nviewModelBase:ViewModelLocator.AutoWi reViewModel=\\\"true\\\"\\n\\nThe AutoWi reViewModel property is\", \" a bindable property that's initialized to false, and when its\\nvalue changes the OnAutoWi reVi ewMod\", \"el Changed event handler is called. This method resolves the\\nview model for the view. The following \", \"code example shows how this is achieved:\\n\\nprivate static void OnAutoWireVi ewModelChanged(BindableOb\", \"ject bindable, object oldValue, object n\\newValue)\\n{\\nvar view = bindable as Element;\\nif (view == null\", \")\\n{\\nreturn;\\n\\n}\\n\\nvar viewlype = view.GetType() ;\\nvar viewName viewlype.FullName.Replace(\\\".Views.\\\", \\\".\", \"ViewModels.\\\");\\nvar viewAssemblyName = viewlype.GetTypeInfo() .Assembly.FullName;\\nvar viewModelName =\", \" string.Format(\\nCultureinfo.InvariantCulture, \\\"\\u201c{0}Model, {1}\\\", viewName, viewAssemblyName) ;\\n\\n7 7\\n\\n\", \"var viewModelType = Type.GetType(viewMode IName) ;\\nif CviewModelType == null)\\n{\\n\\nreturn;\\n\\n}\\nvar view\", \"Model = _container.Resolve(viewModel Type) ;\\nview.BindingContext = viewModel;\\n\\nThe OnAutoWi reViewMo\", \"delChanged method attempts to resolve the view model using a convention-\\nbased approach. This conven\", \"tion assumes that:\\n\\ne View models are in the same assembly as view types.\\ne Views are in a .Views ch\", \"ild namespace.\\ne View models are in a .ViewModels child namespace.\\n\\ne View model names correspond wi\", \"th view names and end with \\\"ViewModel\\\".\\n\\n11 CHAPTER 2 | MVVM\\nFinally, the OnAutoWi reVi ewModelChang\", \"ed method sets the BindingContext of the view type to the\\nresolved view model type. For more informa\", \"tion about resolving the view model type, see Resolution.\\n\\nThis approach has the advantage that an a\", \"pp has a single class that is responsible for the instantiation\\nof view models and their connection \", \"to views.\\n\\nTip: Use a view model locator for ease of substitution\\n\\nA view model locator can also be \", \"used as a point of substitution for alternate implementations of\\ndependencies, such as for unit test\", \"ing or design time data.\\n\\nUpdating views in response to changes In the\\nunderlying view model or mode\", \"l\\n\\nAll view model and model classes that are accessible to a view should implement the\\n\\nINoti fyProp\", \"ertyChanged interface. Implementing this interface in a view model or model class\\nallows the class t\", \"o provide change notifications to any data-bound controls in the view when the\\nunderlying property v\", \"alue changes.\\n\\nApp's should be architected for the correct use of property change notification, by m\", \"eeting the\\nfollowing requirements:\\n\\ne Always raising a PropertyChanged event if a public property's \", \"value changes. Do not assume\\nthat raising the PropertyChanged event can be ignored because of knowle\", \"dge of how XAML\\nbinding occurs.\\n\\ne Always raising a PropertyChanged event for any calculated propert\", \"ies whose values are used\\nby other properties in the view model or model.\\n\\ne Always raising the Prop\", \"ertyChanged event at the end of the method that makes a property\\nchange, or when the object is known\", \" to be in a safe state. Raising the event interrupts the\\noperation by invoking the event's handlers \", \"synchronously. If this happens in the middle of an\\noperation, it might expose the object to callback\", \" functions when it is in an unsafe, partially\\nupdated state. In addition, it's possible for cascadin\", \"g changes to be triggered by\\nPropertyChanged events. Cascading changes generally require updates to \", \"be complete\\nbefore the cascading change is safe to execute.\\n\\ne Never raising a PropertyChanged event\", \" if the property does not change. This means that you\\nmust compare the old and new values before rai\", \"sing the PropertyChanged event.\\n\\ne Never raising the PropertyChanged event during a view model's con\", \"structor if you are\\ninitializing a property. Data-bound controls in the view will not have subscribe\", \"d to receive\\nchange notifications at this point.\\n\\ne Never raising more than one PropertyChanged even\", \"t with the same property name\\nargument within a single synchronous invocation of a public method of \", \"a class. For example,\\ngiven a NumberOfItems property whose backing store is the _numberOfItems field\", \", if a\\nmethod increments _numberOfItems fifty times during the execution of a loop, it should only\\nr\", \"aise property change notification on the NumberOfItems property once, after all the work is\\ncomplete\", \". For asynchronous methods, raise the PropertyChanged event for a given property\\nname in each synchr\", \"onous segment of an asynchronous continuation chain.\\n\\nThe eShopOnContainers mobile app uses the Exte\", \"ndedBindableObject class to provide change\\nnotifications, which is shown in the following code examp\", \"le:\\n\\n12 CHAPTER 2 | MVVM\\npublic abstract class ExtendedBindableObject : BindableObject\\n\\n{\\npublic voi\", \"d RaisePropertyChanged<I>CExpression<Func<!l>> property)\\n{\\nvar name = GetMemberInfo(property) .Name;\", \"\\nOnPropertyChanged(name) ;\\n}\\nprivate MemberInfo GetMemberInfo(Expression expression)\\n{\\n}\\n}\\n\\nXamarin.\", \"Form's BindableObject class implements the INoti fyPropertyChanged interface, and\\nprovides an OnProp\", \"ertyChanged method. The ExtendedBindab1leObject class provides the\\nRaisePropertyChanged method to in\", \"voke property change notification, and in doing so uses the\\nfunctionality provided by the BindableOb\", \"ject class.\\n\\nEach view model class in the eshopOnContainers mobile app derives from the Vi ewMode 1B\", \"ase class,\\nwhich in turn derives from the ExtendedBindab1eObject class. Therefore, each view model c\", \"lass uses\\nthe RaisePropertyChanged method in the ExtendedBindableObject class to provide property\\nch\", \"ange notification. The following code example shows how the eShopOnContainers mobile app\\ninvokes pro\", \"perty change notification by using a lambda expression:\\n\\npublic bool IsLogin\\n\\n{\\nget\\n{\\nreturn _isLogi\", \"n;\\n}\\nset\\n{\\n_isLogin = value;\\nRaisePropertyChanged(() => IsLogin);\\n}\\n}\\n\\nNote that using a lambda expr\", \"ession in this way involves a small performance cost because the\\nlambda expression has to be evaluat\", \"ed for each call. Although the performance cost is small and\\nwould not normally impact an app, the c\", \"osts can accrue when there are many change notifications.\\nHowever, the benefit of this approach is t\", \"hat it provides compile-time type safety and refactoring\\nsupport when renaming properties.\\n\\nUl inter\", \"action using commands and behaviors\\n\\nIn mobile apps, actions are typically invoked in response to a \", \"user action, such as a button click, that\\ncan be implemented by creating an event handler in the cod\", \"e-behind file. However, in the MVVM\\npattern, the responsibility for implementing the action lies wit\", \"h the view model, and placing code in\\nthe code-behind should be avoided.\\n\\nCommands provide a conveni\", \"ent way to represent actions that can be bound to controls in the UI.\\nThey encapsulate the code that\", \" implements the action, and help to keep it decoupled from its visual\\nrepresentation in the view. Xa\", \"marin.Forms includes controls that can be declaratively connected to a\\ncommand, and these controls w\", \"ill invoke the command when the user interacts with the control.\\n\\n13 CHAPTER 2 | MVVM\\nBehaviors also\", \" allow controls to be declaratively connected to a command. However, behaviors can be\\nused to invoke\", \" an action that's associated with a range of events raised by a control. Therefore,\\nbehaviors addres\", \"s many of the same scenarios as command-enabled controls, while providing a\\ngreater degree of flexib\", \"ility and control. In addition, behaviors can also be used to associate command\\nobjects or methods w\", \"ith controls that were not specifically designed to interact with commands.\\n\\nImplementing commands\\n\\n\", \"View models typically expose command properties, for binding from the view, that are object\\ninstance\", \"s that implement the ICommand interface. A number of Xamarin.Forms controls provide a\\nCommand proper\", \"ty, which can be data bound to an ICommand object provided by the view model. The\\nICommand interface\", \" defines an Execute method, which encapsulates the operation itself, a\\nCanExecute method, which indi\", \"cates whether the command can be invoked, and a\\nCanExecuteChanged event that occurs when changes occ\", \"ur that affect whether the command should\\nexecute. The Command and Command<T> classes, provided by X\", \"amarin.Forms, implement the [Command\\ninterface, where T is the type of the arguments to Execute and \", \"CanExecute.\\n\\nWithin a view model, there should be an object of type Command or Command<T> for each p\", \"ublic\\nproperty in the view model of type ICommand. The Command or Command<T> constructor requires an\", \"\\nAction callback object that's called when the ICommand.Execute method is invoked. The\\nCanExecute me\", \"thod is an optional constructor parameter, and is a Func that returns a bool.\\n\\nThe following code sh\", \"ows how a Command instance, which represents a register command, is\\nconstructed by specifying a dele\", \"gate to the Register view model method:\\n\\npublic ICommand RegisterCommand => new Command(Register) ;\\n\", \"\\nThe command is exposed to the view through a property that returns a reference to an ICommand.\\nWhen\", \" the Execute method is called on the Command object, it simply forwards the call to the method\\nin th\", \"e view model via the delegate that was specified in the Command constructor.\\n\\nAn asynchronous method\", \" can be invoked by a command by using the async and await keywords\\nwhen specifying the command's Exe\", \"cute delegate. This indicates that the callback is a Task and\\nshould be awaited. For example, the fo\", \"llowing code shows how a Command instance, which represents\\na sign-in command, is constructed by spe\", \"cifying a delegate to the SignInAsync view model method:\\n\\npublic ICommand SignInCommand => new Comma\", \"nd(async () => await SignInAsync());\\n\\nParameters can be passed to the Execute and CanExecute actions\", \" by using the Command<T> class to\\ninstantiate the command. For example, the following code shows how\", \" a Command<T> instance is used\\nto indicate that the NavigateAsync method will require an argument of\", \" type string:\\n\\npublic ICommand NavigateCommand => new Command<string>(NavigateAsync) ;\\n\\nIn both the \", \"Command and Command<T> classes, the delegate to the CanExecute method in each\\nconstructor is optiona\", \"l. If a delegate isn't specified, the Command will return true for CanExecute.\\nHowever, the view mod\", \"el can indicate a change in the command's CanExecute status by calling the\\nChangeCanExecute method o\", \"n the Command object. This causes the CanExecuteChanged event to be\\nraised. Any controls in the UI t\", \"hat are bound to the command will then update their enabled status to\\nreflect the availability of th\", \"e data-bound command.\\n\\n14 CHAPTER 2 | MVVM\\nInvoking commands from a view\\n\\nThe following code example\", \" shows how a Grid in the LoginView binds to the RegisterCommand in\\nthe LoginViewModel class by using\", \" a TapGestureRecognizer instance:\\n\\n<Grid Grid.Column=\\\"1\\\" HorizontalOptions=\\\"Center\\\">\\n<Label Text=\\\"RE\", \"GISTER\\\" TextColor=\\\"Gray\\\"/>\\n<Grid.GestureRecognizers>\\n<TapGestureRecognizer Command=\\\"{Binding Registe\", \"rCommand}\\\" NumberOfTapsRequired=\\\"1\\\" />\\n</Grid.GestureRecognizers>\\n</Grid>\\n\\nA command parameter can a\", \"lso be optionally defined using the CommandParameter property. The\\ntype of the expected argument Is \", \"specified in the Execute and CanExecute target methods. The\\nTapGestureRecognizer will automatically \", \"invoke the target command when the user interacts with\\nthe attached control. The command parameter, \", \"if provided, will be passed as the argument to the\\ncommand's Execute delegate.\\n\\nImplementing behavio\", \"rs\\n\\nBehaviors allow functionality to be added to UI controls without having to subclass them. Instea\", \"d, the\\nfunctionality is implemented in a behavior class and attached to the control as if it was par\", \"t of the\\ncontrol itself. Behaviors enable you to implement code that you would normally have to writ\", \"e as\\ncode-behind, because it directly interacts with the API of the control, in such a way that it c\", \"an be\\nconcisely attached to the control, and packaged for reuse across more than one view or app. In\", \" the\\ncontext of MVVM, behaviors are a useful approach for connecting controls to commands.\\n\\nA behavi\", \"or that's attached to a control through attached properties is known as an attached behavior.\\nThe be\", \"havior can then use the exposed API of the element to which it is attached to add functionality\\nto t\", \"hat control, or other controls, in the visual tree of the view. The eShopOnContainers mobile app\\ncon\", \"tains the LineColorBehavior class, which is an attached behavior. For more information about\\n\\nthis b\", \"ehavior, see Displaying validation errors.\\n\\nA Xamarin.Forms behavior is a class that derives from th\", \"e Behavior or Behavior<T> class, where T is\\nthe type of the control to which the behavior should app\", \"ly. These classes provide OnAttachedTo and\\nOnDetachingFrom methods, which should be overridden to pr\", \"ovide logic that will be executed when\\nthe behavior is attached to and detached from controls.\\n\\nIn t\", \"he eShopOnContainers mobile app, the Bindabl eBehavior<T> class derives from the\\nBehavior<T> class. \", \"The purpose of the BindableBehavior<T> class is to provide a base class for\\nXamarin.Forms behaviors \", \"that require the BindingContext of the behavior to be set to the attached\\ncontrol.\\n\\nThe Bindab1eBeha\", \"vior<T> class provides an overridable OnAttachedTo method that sets the\\nBindingContext of the behavi\", \"or, and an overridable OnDetachingFrom method that cleans up the\\nBindingContext. In addition, the cl\", \"ass stores a reference to the attached control in the\\nAssociatedObject property.\\n\\nThe eShopOnContain\", \"ers mobile app includes an EventToCommandBehavior class, which executes a\\ncommand in response to an \", \"event occurring. This class derives from the BindableBehavior<Vi ew>\\nclass so that the behavior can \", \"bind to and execute an ICommand specified by a Command property\\nwhen the behavior is consumed. The f\", \"ollowing code example shows the EventToCommandBehavior\\nclass:\\n\\n15 CHAPTER 2 | MVVM\\npublic class Even\", \"tToCommandBehavior : BindableBehavior<View>\\n\\n{\\nprotected override void OnAttachedTo(View visualEleme\", \"nt)\\n{\\nbase.OnAttachedTo(visualElement) ;\\nvar events = AssociatedObject.GetTypeQ .GetRuntimeEvents() \", \".ToArray();\\nif Cevents.Any())\\n{\\n_eventinfo = events. FirstOrDefault(e => e.Name == EventName) ;\\nif C\", \"eventInfo == null)\\nthrow new ArgumentException(string.Format(\\n\\\"EventToCommand: Can't find any event \", \"named '{0}' on attached type\\\",\\nEventName) ) ;\\nAddEventHandler(_eventiInfo, AssociatedObject, OnFired\", \");\\n$\\n$\\nprotected override void OnDetachingFrom(View view)\\n{\\nif Chandler != null)\\n_eventInfo.RemoveEv\", \"entHandler(AssociatedObject, _handler);\\nbase.OnDetachingFrom(view) ;\\n$\\nprivate void AddEventHandler(\", \"\\nEventInfo eventiInfo, object item, Action<object, EventArgs> action)\\n{\\n$\\nprivate void OnFired(objec\", \"t sender, EventArgs eventArgs)\\n{\\n$\\n$\\n\\nThe OnAttachedTo and OnDetachingFrom methods are used to regis\", \"ter and deregister an event\\nhandler for the event defined in the EventName property. Then, when the \", \"event fires, the OnFired\\nmethod is invoked, which executes the command.\\n\\nThe advantage of using the \", \"EventToCommandBehavior to execute a command when an event fires, is\\nthat commands can be associated \", \"with controls that weren't designed to interact with commands. In\\naddition, this moves event-handlin\", \"g code to view models, where it can be unit tested.\\n\\nInvoking behaviors from a view\\n\\nThe EventToComm\", \"andBehavior is particularly useful for attaching a command to a control that\\ndoesn't support command\", \"s. For example, the ProfileView uses the EventToCommandBehavior to\\nexecute the OrderDetai 1Command w\", \"hen the ItemTapped event fires on the ListView that lists the\\nuser's orders, as shown in the followi\", \"ng code:\\n\\n<ListView>\\n<ListView.Behaviors>\\n<behaviors: EventToCommandBehavior\\nEventName=\\\"Ttemlapped\\\"\\n\", \"Command=\\\"{Binding OrderDetai |Command}\\\"\\nEventArgsConverter=\\\"{StaticResource ItemTappedEventArgsConve\", \"rter}\\\" />\\n\\n16 CHAPTER 2 | MVVM\\n</ListView.Behaviors>\\n\\n</ListView>\\n\\nAt runtime, the EventToCommandBeh\", \"avior will respond to interaction with the ListView. When an\\nitem is selected in the ListView, the I\", \"temTapped event will fire, which will execute the\\n\\nOrderDetai 1Command in the Profi 1eViewModel. By \", \"default, the event arguments for the event are\\npassed to the command. This data is converted as it's\", \" passed between source and target by the\\nconverter specified in the EventArgsConverter property, whi\", \"ch returns the Item of the ListView\\nfrom the ItemTappedEventArgs. Therefore, when the OrderDetai 1Co\", \"mmand is executed, the selected\\nOrder is passed as a parameter to the registered Action.\\n\\nFor more i\", \"nformation about behaviors, see Behaviors on the Xamarin Developer Center.\\n\\nSummary\\n\\nThe Model-View-\", \"ViewModel (MVVM) pattern helps to cleanly separate the business and presentation\\nlogic of an applica\", \"tion from its user interface (UI). Maintaining a clean separation between application\\nlogic and the \", \"UI helps to address numerous development issues and can make an application easier\\nto test, maintain\", \", and evolve. It can also greatly improve code re-use opportunities and allows\\ndevelopers and UI des\", \"igners to more easily collaborate when developing their respective parts of an\\napp.\\n\\nUsing the MVVM \", \"pattern, the UI of the app and the underlying presentation and business logic is\\nseparated into thre\", \"e separate classes: the view, which encapsulates the UI and UI logic; the view\\nmodel, which encapsul\", \"ates presentation logic and state; and the model, which encapsulates the app's\\nbusiness logic and da\", \"ta.\\n\\n17 CHAPTER 2 | MVVM\\nCHAPTER\\n\\nDependency\\nInjection\\n\\nTypically, a class constructor is invoked wh\", \"en instantiating an object, and any values that the object\\nneeds are passed as arguments to the cons\", \"tructor. This is an example of dependency injection, and\\nspecifically is known as constructor inject\", \"ion. The dependencies the object needs are injected into the\\nconstructor.\\n\\nBy specifying dependencie\", \"s as interface types, dependency injection enables decoupling of the\\nconcrete types from the code th\", \"at depends on these types. It generally uses a container that holds a\\nlist of registrations and mapp\", \"ings between interfaces and abstract types, and the concrete types that\\nimplement or extend these ty\", \"pes.\\n\\nThere are also other types of dependency injection, such as property setter injection, and met\", \"hod call\\ninjection, but they are less commonly seen. Therefore, this chapter will focus solely on pe\", \"rforming\\nconstructor injection with a dependency injection container.\\n\\nIntroduction to dependency in\", \"jection\\n\\nDependency injection is a specialized version of the Inversion of Control (loC) pattern, wh\", \"ere the\\nconcern being inverted is the process of obtaining the required dependency. With dependency\\n\", \"injection, another class is responsible for injecting dependencies into an object at runtime. The\\nfo\", \"llowing code example shows how the ProfileViewModel class is structured when using\\ndependency inject\", \"ion:\\n\\npublic class ProfileViewModel : ViewModelBase\\n\\nprivate IOrderService _orderService;\\npublic Pro\", \"fileViewModel (lOrderService orderService)\\n_orderService = orderService;\\n}\\n\\nwae\\n\\nThe Profi 1leViewMo\", \"del constructor receives an IOrderService instance as an argument, injected by\\nanother class. The on\", \"ly dependency in the Profi 1eViewModel class is on the interface type.\\nTherefore, the Profi 1eViewMo\", \"del class doesn't have any knowledge of the class that's responsible for\\ninstantiating the IOrderSer\", \"vice object. The class that's responsible for instantiating the\\n\\n18 CHAPTER 3 | Dependency injection\", \"\\nTOrderService object, and inserting it into the Profi 1eViewModel class, is known as the dependency\", \"\\ninjection container.\\n\\nDependency injection containers reduce the coupling between objects by provid\", \"ing a facility to\\ninstantiate class instances and manage their lifetime based on the configuration o\", \"f the container.\\nDuring the objects creation, the container injects any dependencies that the object\", \" requires into it. If\\nthose dependencies have not yet been created, the container creates and resolv\", \"es their dependencies\\nfirst.\\n\\nNote: Dependency injection can also be implemented manually using fact\", \"ories. However, using a\\ncontainer provides additional capabilities such as lifetime management, and \", \"registration through\\nassembly scanning.\\n\\nThere are several advantages to using a dependency injectio\", \"n container:\\n\\ne Acontainer removes the need for a class to locate its dependencies and manage their\\n\", \"lifetimes.\\n\\ne Acontainer allows mapping of implemented dependencies without affecting the class.\\ne A\", \"container facilitates testability by allowing dependencies to be mocked.\\ne Acontainer increases main\", \"tainability by allowing new classes to be easily added to the app.\\n\\nIn the context of a Xamarin.Form\", \"s app that uses MVVM, a dependency injection container will\\ntypically be used for registering and re\", \"solving view models, and for registering services and injecting\\nthem into view models.\\n\\nThere are ma\", \"ny dependency injection containers available, with the eshopOnContainers mobile app\\nusing Autofac to\", \" manage the instantiation of view model and service classes in the app. Autofac\\nfacilitates building\", \" loosely coupled apps, and provides all of the features commonly found in\\ndependency injection conta\", \"iners, including methods to register type mappings and object instances,\\nresolve objects, manage obj\", \"ect lifetimes, and inject dependent objects into constructors of objects\\nthat it resolves. For more \", \"information about Autofac, see Autofac on readthedocs.io.\\n\\nIn Autofac, the IContainer interface prov\", \"ides the dependency injection container. Figure 3-1 shows\\nthe dependencies when using this container\", \", which instantiates an IOrderService object and injects\\nit into the Profi leViewMode!l class.\\n\\nProf\", \"ileView Model IContainer OrderService\\n\\nlOrderService\\n\\nFigure 3-1: Dependencies when using dependency\", \" injection\\n\\n19 CHAPTER 3 | Dependency injection\\nAt runtime, the container must know which implementa\", \"tion of the IOrderService interface it should\\ninstantiate, before it can instantiate a Profi leViewM\", \"odel object. This involves:\\n\\ne The container deciding how to instantiate an object that implements t\", \"he IOrderService\\ninterface. This is known as registration.\\n\\ne The container instantiating the object\", \" that implements the IOrderService interface, and the\\nProfi leViewModel object. This is known as res\", \"olution.\\n\\nEventually, the app will finish using the Profi leViewModel object and it will become avai\", \"lable for\\ngarbage collection. At this point, the garbage collector should dispose of the IOrderServi\", \"ce instance\\nif other classes do not share the same instance.\\n\\nTip: Write container-agnostic code\\n\\nAl\", \"ways try to write container-agnostic code to decouple the app from the specific dependency\\ncontainer\", \" being used.\\n\\nRegistration\\n\\nBefore dependencies can be injected into an object, the types of the dep\", \"endencies must first be\\nregistered with the container. Registering a type typically involves passing\", \" the container an interface\\nand a concrete type that implements the interface.\\n\\nThere are two ways o\", \"f registering types and objects in the container through code:\\n\\ne Register a type or mapping with th\", \"e container. When required, the container will build an\\ninstance of the specified type.\\n\\ne Register \", \"an existing object in the container as a singleton. When required, the container will\\nreturn a refer\", \"ence to the existing object.\\n\\nTip: Dependency injection containers are not always suitable\\n\\nDependen\", \"cy injection introduces additional complexity and requirements that might not be\\nappropriate or usef\", \"ul to small apps. If a class does not have any dependencies, or is not a\\ndependency for other types,\", \" it might not make sense to put it in the container. In addition, if a class\\nhas a single set of dep\", \"endencies that are integral to the type and will never change, it might not\\nmake sense to put it in \", \"the container.\\n\\nThe registration of types that require dependency injection should be performed in a\", \" single method in\\nan app, and this method should be invoked early in the app's lifecycle to ensure t\", \"hat the app is aware\\nof the dependencies between its classes. In the eshopOnContainers mobile app th\", \"is is performed by\\nthe ViewModelLocator class, which builds the [Container object and is the only cl\", \"ass in the app that\\nholds a reference to that object. The following code example shows how the eShop\", \"OnContainers\\nmobile app declares the [Container object in the ViewModelLocator class:\\n\\nprivate stati\", \"c IContainer _container;\\n\\nTypes and instances are registered in the RegisterDependencies method in t\", \"he ViewModelLocator\\nclass. This is achieved by first creating a ContainerBui Ider instance, which is\", \" demonstrated in the\\nfollowing code example:\\n\\nvar builder = new ContainerBui lderQ;\\n\\n20 CHAPTER 3 | \", \"Dependency injection\\nTypes and instances are then registered with the ContainerBui Ider object, and \", \"the following code\\nexample demonstrates the most common form of type registration:\\n\\nbuilder.Register\", \"Type<RequestProvider>() .As<IRequestProvider>Q ;\\n\\nThe RegisterType method shown here maps an interfa\", \"ce type to a concrete type. It tells the\\ncontainer to instantiate a RequestProvider object when it i\", \"nstantiates an object that requires an\\ninjection of an IRequestProvider through a constructor.\\n\\nConc\", \"rete types can also be registered directly without a mapping from an interface type, as shown in\\nthe\", \" following code example:\\n\\nbuilder.RegisterType<Profi leViewModel>(Q);\\n\\nWhen the Profi leViewModel ty\", \"pe is resolved, the container will inject its required dependencies.\\n\\nAutofac also allows instance r\", \"egistration, where the container is responsible for maintaining a\\nreference to a singleton instance \", \"of a type. For example, the following code example shows how the\\neShopOnContainers mobile app regist\", \"ers the concrete type to use when a Profi leViewModel\\ninstance requires an IOrderService instance:\\n\\n\", \"builder.RegisterType<OrderService>() .As<IOrderService>() .SingleInstanceQ() ;\\n\\nThe RegisterType met\", \"hod shown here maps an interface type to a concrete type. The\\nSingleInstance method configures the r\", \"egistration so that every dependent object receives the\\nsame shared instance. Therefore, only a sing\", \"le OrderService instance will exist in the container,\\nwhich is shared by objects that require an inj\", \"ection of an IOrderService through a constructor.\\n\\nInstance registration can also be performed with \", \"the RegisterInstance method, which is\\ndemonstrated in the following code example:\\n\\nbuilder.RegisterI\", \"nstance(new OrderMockService()) .As<IOrderService>Q();\\n\\nThe RegisterInstance method shown here creat\", \"es a new OrderMockService instance and registers\\nit with the container. Therefore, only a single Ord\", \"erMockService instance exists in the container,\\nwhich is shared by objects that require an injection\", \" of an IOrderService through a constructor.\\n\\nFollowing type and instance registration, the [Containe\", \"r object must be built, which is demonstrated\\nin the following code example:\\n\\n_container = builder.B\", \"uildQd;\\n\\nInvoking the Build method on the ContainerBui Ider instance builds a new dependency injecti\", \"on\\ncontainer that contains the registrations that have been made.\\n\\nTip: Consider an IContainer as be\", \"ing immutable\\n\\nWhile Autofac provides an Update method to update registrations in an existing contai\", \"ner, calling\\nthis method should be avoided where possible. There are risks to modifying a container \", \"after it's\\nbeen built, particularly if the container has been used. For more information, see Consid\", \"er a\\nContainer as Immutable on readthedocs.io.\\n\\n21 CHAPTER 3 | Dependency injection\\nResolution\\n\\nAfte\", \"r a type Is registered, it can be resolved or injected as a dependency. When a type is being\\nresolve\", \"d and the container needs to create a new instance, it injects any dependencies into the\\ninstance.\\n\\n\", \"Generally, when a type is resolved, one of three things happens:\\n1. If the type hasn't been register\", \"ed, the container throws an exception.\\n\\n2. If the type has been registered as a singleton, the conta\", \"iner returns the singleton instance. If\\nthis is the first time the type Is called for, the container\", \" creates it if required, and maintains a\\nreference to it.\\n\\n3. If the type hasn't been registered as \", \"a singleton, the container returns a new instance, and\\ndoesn't maintain a reference to it.\\n\\nThe foll\", \"owing code example shows how the RequestProvider type that was previously registered\\nwith Autofac ca\", \"n be resolved:\\n\\nvar requestProvider = _container.Resolve<IRequestProvider>Q ;\\n\\nIn this example, Auto\", \"fac is asked to resolve the concrete type for the IRequestProvider type, along\\nwith any dependencies\", \". Typically, the Resolve method is called when an instance of a specific type is\\nrequired. For infor\", \"mation about controlling the lifetime of resolved objects, see Managing the lifetime\\n\\nof resolved ob\", \"jects.\\n\\nThe following code example shows how the eShopOnContainers mobile app instantiates view mode\", \"l\\ntypes and their dependencies:\\n\\nvar viewModel = _container.Resolve(viewModelType) ;\\n\\nIn this exampl\", \"e, Autofac is asked to resolve the view model type for a requested view model, and the\\ncontainer wil\", \"l also resolve any dependencies. When resolving the Profi 1eViewModel type, the\\ndependency to resolv\", \"e is an IOrderService object. Therefore, Autofac first constructs an\\nOrderService object and then pa\", \"sses it to the constructor of the ProfileViewModel class. For more\\ninformation about how the eShopOn\", \"Containers mobile app constructs view models and associates\\n\\nthem to views, see Automatically creati\", \"ng a view model with a view model locator.\\n\\nNote: Registering and resolving types with a container h\", \"as a performance cost because of the\\ncontainer's use of reflection for creating each type, especiall\", \"y if dependencies are being\\nreconstructed for each page navigation in the app. If there are many or \", \"deep dependencies, the\\ncost of creation can increase significantly.\\n\\nManaging the lifetime of resolv\", \"ed objects\\n\\nAfter registering a type, the default behavior for Autofac is to create a new instance o\", \"f the registered\\ntype each time the type Is resolved, or when the dependency mechanism injects insta\", \"nces into other\\nclasses. In this scenario, the container doesn't hold a reference to the resolved ob\", \"ject. However, when\\nregistering an instance, the default behavior for Autofac is to manage the lifet\", \"ime of the object as a\\nsingleton. Therefore, the instance remains in scope while the container is in\", \" scope, and is disposed\\nwhen the container goes out of scope and is garbage collected, or when code \", \"explicitly disposes the\\ncontainer.\\n\\n22 CHAPTER 3 | Dependency injection\\nAn Autofac instance scope ca\", \"n be used to specify the singleton behavior for an object that Autofac\\ncreates from a registered typ\", \"e. Autofac instance scopes manage the object lifetimes instantiated by\\nthe container. The default in\", \"stance scope for the RegisterType method is the\\nInstancePerDependency scope. However, the SingleInst\", \"ance scope can be used with the\\nRegisterType method, so that the container creates or returns a sing\", \"leton instance of a type when\\ncalling the Resolve method. The following code example shows how Autof\", \"ac is instructed to create a\\nsingleton instance of the NavigationService class:\\n\\nbuilder.RegisterTyp\", \"e<NavigationService>() .As<INavigationService>().SingleInstanceQ() ;\\n\\nThe first time that the INavig\", \"ationService interface is resolved, the container creates a new\\nNavigationService object and maintai\", \"ns a reference to it. On any subsequent resolutions of the\\nINavigationService interface, the contain\", \"er returns a reference to the NavigationService object\\nthat was previously created.\\n\\nNote: The Singl\", \"eInstance scope disposes created objects when the container is disposed.\\n\\nAutofac includes additiona\", \"l instance scopes. For more information, see Instance Scope on\\nreadthedocs.io.\\n\\nSummary\\n\\nDependency \", \"injection enables decoupling of concrete types from the code that depends on these\\ntypes. It typical\", \"ly uses a container that holds a list of registrations and mappings between interfaces\\nand abstract \", \"types, and the concrete types that implement or extend these types.\\n\\nAutofac facilitates building lo\", \"osely coupled apps, and provides all of the features commonly found in\\ndependency injection containe\", \"rs, including methods to register type mappings and object instances,\\nresolve objects, manage object\", \" lifetimes, and inject dependent objects into constructors of objects it\\nresolves.\\n\\n23 CHAPTER 3 | D\", \"ependency injection\\nCHAPTER A\\n\\nCommunicating\\nbetween loosely\\ncoupled\\ncomponents\\n\\nThe publish-subscri\", \"be pattern is a messaging pattern in which publishers send messages without\\nhaving knowledge of any \", \"receivers, known as subscribers. Similarly, subscribers listen for specific\\nmessages, without having\", \" knowledge of any publishers.\\n\\nEvents in .NET implement the publish-subscribe pattern, and are the m\", \"ost simple and straightforward\\napproach for a communication layer between components if loose coupli\", \"ng is not required, such as a\\ncontrol and the page that contains it. However, the publisher and subs\", \"criber lifetimes are coupled by\\nobject references to each other, and the subscriber type must have a\", \" reference to the publisher type.\\nThis can create memory management issues, especially when there ar\", \"e short lived objects that\\nsubscribe to an event of a static or long-lived object. If the event hand\", \"ler isn't removed, the subscriber\\nwill be kept alive by the reference to it in the publisher, and th\", \"is will prevent or delay the garbage\\ncollection of the subscriber.\\n\\nIntroduction to MessagingCenter\\n\", \"\\nThe Xamarin.Forms MessagingCenter class implements the publish-subscribe pattern, allowing\\nmessage-\", \"based communication between components that are inconvenient to link by object and type\\nreferences. \", \"This mechanism allows publishers and subscribers to communicate without having a\\nreference to each o\", \"ther, helping to reduce dependencies between components, while also allowing\\ncomponents to be indepe\", \"ndently developed and tested.\\n\\nThe MessagingCenter class provides multicast publish-subscribe functi\", \"onality. This means that there\\ncan be multiple publishers that publish a single message, and there c\", \"an be multiple subscribers\\nlistening for the same message. Figure 4-1 illustrates this relationship:\", \"\\n\\n24 CHAPTER 4 | Communicating between loosely coupled components\\nMessage |\\n\\nF_Siberber |\\n_Messace |\", \"\\n\\nFSiberiber\\n\\nFigure 4-1: Multicast publish-subscribe functionality\\nPublishers send messages using t\", \"he MessagingCenter.Send method, while subscribers listen for\\nmessages using the MessagingCenter.Subs\", \"cribe method. In addition, subscribers can also\\nunsubscribe from message subscriptions, if required,\", \" with the MessagingCenter.Unsubscribe\\nmethod.\\n\\nPublisher\\n\\nPublisher\\n\\nInternally, the MessagingCenter\", \" class uses weak references. This means that it will not keep objects\\nalive, and will allow them to \", \"be garbage collected. Therefore, it should only be necessary to\\nunsubscribe from a message when a cl\", \"ass no longer wishes to receive the message.\\n\\nThe eShopOnContainers mobile app uses the MessagingCen\", \"ter class to communicate between\\nloosely coupled components. The app defines three messages:\\n\\ne The \", \"AddProduct message is published by the CatalogViewModel class when an item is\\nadded to the shopping \", \"basket. In return, the BasketViewModel class subscribes to the\\nmessage and increments the number of \", \"items in the shopping basket in response. In addition,\\nthe BasketViewModel class also unsubscribes f\", \"rom this message.\\n\\ne The Filter message is published by the CatalogViewModel class when the user app\", \"lies a\\nbrand or type filter to the items displayed from the catalogue. In return, the CatalogVi ew\\nc\", \"lass subscribes to the message and updates the UI so that only items that match the filter\\ncriteria \", \"are displayed.\\n\\ne The ChangeTab message is published by the MainViewModel class when the\\nCheckoutVie\", \"wModel navigates to the MainViewModel following the successful creation and\\nsubmission of a new orde\", \"r. In return, the MainView class subscribes to the message and\\nupdates the UI so that the My profile\", \" tab is active, to show the user's orders.\\n\\nNote: While the MessagingCenter class permits communicat\", \"ion between loosely-coupled classes,\\nit does not offer the only architectural solution to this issue\", \". For example, communication between\\na view model and a view can also be achieved by the binding eng\", \"ine and through property change\\nnotifications. In addition, communication between two view models ca\", \"n also be achieved by\\npassing data during navigation.\\n\\nIn the eShopOnContainers mobile app, Messagin\", \"gCenter is used to update in the UI in response to\\n\\nan action occurring in another class. Therefore,\", \" messages are published on the UI thread, with\\nsubscribers receiving the message on the same thread.\", \"\\n\\n25 CHAPTER 4 | Communicating between loosley coupled components\\nTip: Marshal to the UI thread when\", \" performing UI updates\\n\\nIf a message that's sent from a background thread is required to update the \", \"UI, process the\\nmessage on the UI thread in the subscriber by invoking the Device. BeginInvokeOnMain\", \"Thread\\nmethod.\\n\\nFor more information about MessagingCenter, see MessagingCenter on the Xamarin Devel\", \"oper\\nCenter.\\n\\nDefining a message\\n\\nMessagingCenter messages are strings that are used to identify mes\", \"sages. The following code\\nexample shows the messages defined within the eshopOnContainers mobile app\", \":\\n\\npublic class MessengerKeys\\n\\n{\\n// Add product to basket\\npublic const string AddProduct = \\\"AddProdu\", \"ct\\\";\\n// Filter\\npublic const string Filter = \\\"Filter\\\";\\n// Change selected Tab programmatically\\npublic\", \" const string ChangeTab = \\\"ChangeTab\\\";\\n\\n}\\n\\nIn this example, messages are defined using constants. Th\", \"e advantage of this approach is that it\\nprovides compile-time type safety and refactoring support.\\n\\n\", \"Publishing a message\\n\\nPublishers notify subscribers of a message with one of the MessagingCenter. Se\", \"nd overloads. The\\nfollowing code example demonstrates publishing the AddProduct message:\\n\\nMessagingC\", \"enter.Send(this, MessengerKeys.AddProduct, catalogItem) ;\\n\\nIn this example, the Send method specifie\", \"s three arguments:\\n\\ne The first argument specifies the sender class. The sender class must be specif\", \"ied by any\\nsubscribers who wish to receive the message.\\n\\ne The second argument specifies the message\", \".\\n\\ne The third argument specifies the payload data to be sent to the subscriber. In this case the\\npa\", \"yload data is a CatalogItem instance.\\n\\nThe Send method will publish the message, and its payload dat\", \"a, using a fire-and-forget approach.\\nTherefore, the message is sent even if there are no subscribers\", \" registered to receive the message. In\\nthis situation, the sent message is ignored.\\n\\nNote: The Messa\", \"gingCenter.Send method can use generic parameters to control how messages\\nare delivered. Therefore, \", \"multiple messages that share a message identity but send different\\npayload data types can be receive\", \"d by different subscribers.\\n\\n26 CHAPTER 4 | Communicating between loosley coupled components\\nSubscri\", \"bing to a message\\n\\nSubscribers can register to receive a message using one of the MessagingCenter. S\", \"ubscribe\\noverloads. The following code example demonstrates how the eShopOnContainers mobile app\\nsub\", \"scribes to, and processes, the AddProduct message:\\n\\nMessagingCenter.Subscribe<CatalogViewModel, Cata\", \"logItem>(\\nthis, MessageKeys.AddProduct, async (sender, arg) =>\\n\\n{\\n\\nBadgeCount++;\\n\\nawait AddCatalogIt\", \"emAsync(arg) ;\\nD5\\n\\nIn this example, the Subscribe method subscribes to the AddProduct message, and e\", \"xecutes a\\ncallback delegate in response to receiving the message. This callback delegate, specified \", \"as a lambda\\nexpression, executes code that updates the UI.\\n\\nTip: Consider using immutable payload da\", \"ta\\n\\nDon't attempt to modify the payload data from within a callback delegate because several threads\", \"\\ncould be accessing the received data simultaneously. In this scenario, the payload data should be\\ni\", \"mmutable to avoid concurrency errors.\\n\\nA subscriber might not need to handle every instance of a pub\", \"lished message, and this can be\\ncontrolled by the generic type arguments that are specified on the S\", \"ubscribe method. In this\\nexample, the subscriber will only receive AddProduct messages that are sent\", \" from the\\nCatalogViewModel class, whose payload data is a CatalogItem instance.\\n\\nUnsubscribing from \", \"a message\\n\\nSubscribers can unsubscribe from messages they no longer want to receive. This is achieve\", \"d with one\\nof the MessagingCenter. Unsubscribe overloads, as demonstrated in the following code exam\", \"ple:\\n\\nMessagingCenter.Unsubscribe<CatalogViewModel, CatalogItem>(this, MessengerKeys.AddProduct) ;\\n\\n\", \"In this example, the Unsubscribe method syntax reflects the type arguments specified when\\nsubscribin\", \"g to receive the AddProduct message.\\n\\nSummary\\n\\nThe Xamarin.Forms MessagingCenter class implements th\", \"e publish-subscribe pattern, allowing\\nmessage-based communication between components that are inconv\", \"enient to link by object and type\\nreferences. This mechanism allows publishers and subscribers to co\", \"mmunicate without having a\\nreference to each other, helping to reduce dependencies between component\", \"s, while also allowing\\ncomponents to be independently developed and tested.\\n\\n27 CHAPTER 4 | Communic\", \"ating between loosley coupled components\\nCHAPTER\\n\\nNavigation\\n\\nXamarin.Forms includes support for pag\", \"e navigation, which typically results from the user's interaction\\nwith the UI or from the app itself\", \" as a result of internal logic-driven state changes. However,\\nnavigation can be complex to implement\", \" in apps that use the Model-View-ViewModel (MVVM)\\npattern, as the following challenges must be met:\\n\", \"\\ne How to identify the view to be navigated to, using an approach that does not introduce tight\\ncoup\", \"ling and dependencies between views.\\n\\ne How to coordinate the process by which the view to be naviga\", \"ted to is instantiated and\\ninitialized. When using MVVM, the view and view model need to be instanti\", \"ated and\\nassociated with each other via the view's binding context. When an app is using a\\ndependenc\", \"y injection container, the instantiation of views and view models might require a\\nspecific construct\", \"ion mechanism.\\n\\ne Whether to perform view-first navigation, or view model-first navigation. With vie\", \"w-first\\nnavigation, the page to navigate to refers to the name of the view type. During navigation,\\n\", \"the specified view is instantiated, along with its corresponding view model and other\\ndependent serv\", \"ices. An alternative approach is to use view model-first navigation, where the\\npage to navigate to r\", \"efers to the name of the view model type.\\n\\ne How to cleanly separate the navigational behavior of th\", \"e app across the views and view\\nmodels. The MVVM pattern provides a separation between the app's UI \", \"and its presentation\\nand business logic. However, the navigation behavior of an app will often span \", \"the UI and\\npresentations parts of the app. The user will often initiate navigation from a view, and \", \"the\\nview will be replaced as a result of the navigation. However, navigation might often also need\\nt\", \"o be initiated or coordinated from within the view model.\\n\\ne How to pass parameters during navigatio\", \"n for initialization purposes. For example, if the user\\nnavigates to a view to update order details,\", \" the order data will have to be passed to the view\\nso that it can display the correct data.\\n\\ne How t\", \"o co-ordinate navigation, to ensure that certain business rules are obeyed. For example,\\nusers might\", \" be prompted before navigating away from a view so that they can correct any\\ninvalid data or be prom\", \"pted to submit or discard any data changes that were made within the\\nview.\\n\\nThis chapter addresses t\", \"hese challenges by presenting a NavigationService class that's used to\\nperform view model-first page\", \" navigation.\\n\\nNote: The NavigationService used by the app is designed only to perform hierarchical\\nn\", \"avigation between ContentPage instances. Using the service to navigate between other page\\ntypes migh\", \"t result in unexpected behavior.\\n\\n28 CHAPTER 5 | Navigation\\nNavigating between pages\\n\\nNavigation log\", \"ic can reside in a view's code-behind, or in a data bound view model. While placing\\nnavigation logic\", \" in a view might be the simplest approach, it is not easily testable through unit tests.\\nPlacing nav\", \"igation logic in view model classes means that the logic can be exercised through unit\\ntests. In add\", \"ition, the view model can then implement logic to control navigation to ensure that\\ncertain business\", \" rules are enforced. For example, an app might not allow the user to navigate away\\nfrom a page witho\", \"ut first ensuring that the entered data is valid.\\n\\nA NavigationService class is typically invoked fr\", \"om view models, in order to promote testability.\\nHowever, navigating to views from view models would\", \" require the view models to reference views,\\nand particularly views that the active view model isn't\", \" associated with, which is not recommended.\\nTherefore, the NavigationService presented here specifie\", \"s the view model type as the target to\\n\\nnavigate to.\\n\\nThe eShopOnContainers mobile app uses the Navi\", \"gationService class to provide view model-first\\nnavigation. This class implements the INavigationSer\", \"vice interface, which is shown in the following\\ncode example:\\n\\npublic interface INavigationService\\n\\n\", \"{\\nViewModelBase PreviousPageViewModel { get; }\\nTask InitializeAsyncQ ;\\nTask NavigateToAsync<TViewMod\", \"el>() where TViewModel : ViewModelBase;\\nTask NavigateToAsync<TViewModel>(Cobject parameter) where TV\", \"iewModel : ViewModelBase;\\nTask RemoveLastFromBackStackAsyncQ) ;\\nTask RemoveBackStackAsyncQ) ;\\n$\\n\\nThi\", \"s interface specifies that an implementing class must provide the following methods:\\n\\nMethod Purpose\", \"\\n\\nInitializeAsync Performs navigation to one of two pages when the app is\\nlaunched.\\n\\nNavigateToAsync\", \"<T> Performs hierarchical navigation to a specified page.\\n\\nNavigateToAsync<T>(parameter) | Performs \", \"hierarchical navigation to a specified page, passing\\na parameter.\\n\\nRemoveLastFromBackStackAsync | Re\", \"moves the previous page from the navigation stack.\\nRemoveBackStackAsync Removes all the previous pag\", \"es from the navigation stack.\\n\\nIn addition, the INavigationService interface specifies that an imple\", \"menting class must provide a\\nPreviousPageViewModel property. This property returns the view model ty\", \"pe associated with the\\nprevious page in the navigation stack.\\n\\nNote: An INavigationService interface\", \" would usually also specify a GoBackAsync method, which\\nis used to programmatically return to the pr\", \"evious page in the navigation stack. However, this\\nmethod is missing from the eSshopOnContainers mob\", \"ile app because it's not required.\\n\\nCreating the NavigationService instance\\n\\nThe NavigationService c\", \"lass, which implements the INavigationService interface, is registered as\\na singleton with the Autof\", \"ac dependency injection container, as demonstrated in the following code\\nexample:\\n\\n29 CHAPTER 5 | Na\", \"vigation\\nbuilder.RegisterType<NavigationService>() .As<INavigationService>().SingleInstanceQ() ;\\n\\nTh\", \"e INavigationService interface is resolved in the ViewModelBase class constructor, as\\ndemonstrated i\", \"n the following code example:\\n\\nNavigationService = ViewModelLocator.Resolve<INavigationService>() ;\\n\", \"\\nThis returns a reference to the NavigationService object that's stored in the Autofac dependency\\nin\", \"jection container, which is created by the InitNavigation method in the App class. For more\\n\\ninforma\", \"tion, see Navigating when the app is launched.\\n\\nThe ViewMode lBase class stores the NavigationServic\", \"e instance in a NavigationService property,\\nof type INavigationService. Therefore, all view model cl\", \"asses, which derive from the\\nViewModelBase class, can use the NavigationService property to access t\", \"he methods specified by\\nthe INavigationService interface. This avoids the overhead of injecting the \", \"NavigationService\\nobject from the Autofac dependency injection container into each view model class.\", \"\\n\\nHandling navigation requests\\n\\nXamarin.Forms provides the NavigationPage class, which implements a \", \"hierarchical navigation\\nexperience in which the user is able to navigate through pages, forwards and\", \" backwards, as desired.\\nFor more information about hierarchical navigation, see Hierarchical Navigat\", \"ion on the Xamarin\\nDeveloper Center.\\n\\nRather than use the NavigationPage class directly, the eshopOn\", \"Containers app wraps the\\nNavigationPage class in the CustomNavigati onVi ew class, as shown in the f\", \"ollowing code example:\\n\\npublic partial class CustomNavigationView : NavigationPage\\n\\n{\\npublic CustomN\", \"avigationView() : base()\\n{\\nInitializeComponent() ;\\n}\\npublic CustomNavigationView(Page root) : base(C\", \"root)\\n{\\nInitializeComponent() ;\\n}\\n}\\n\\nThe purpose of this wrapping is for ease of styling the Navigat\", \"ionPage Instance inside the XAML file\\nfor the class.\\n\\nNavigation is performed inside view model clas\", \"ses by invoking one of the NavigateToAsync\\nmethods, specifying the view model type for the page bein\", \"g navigated to, as demonstrated in the\\nfollowing code example:\\n\\nawait NavigationService.NavigateToAs\", \"ync<MainViewModel>() ;\\n\\nThe following code example shows the NavigateToAsync methods provided by the\", \"\\nNavigationService class:\\n\\n30 CHAPTER 5 | Navigation\\npublic Task NavigateToAsync<TViewModel>() where\", \" TViewModel : ViewModelBase\\n\\n{\\nreturn InternalNavigateToAsync(typeof(TViewModel), null);\\n\\n}\\n\\npublic \", \"Task NavigateToAsync<TViewModel>(Cobject parameter) where TViewModel : ViewModelBase\\n\\n{\\nreturn Inter\", \"nalNavigateToAsync(typeof(TViewModel), parameter) ;\\n\\n}\\n\\nEach method allows any view model class that\", \" derives from the Vi ewMode 1Base class to perform\\nhierarchical navigation by invoking the InternalN\", \"avigateToAsync method. In addition, the second\\nNavigateToAsync method enables navigation data to be \", \"specified as an argument that's passed to\\nthe view model being navigated to, where it's typically us\", \"ed to perform initialization. For more\\n\\ninformation, see Passing parameters during navigation.\\nThe I\", \"nternalNavigateToAsync method executes the navigation request, and is shown in the\\nfollowing code ex\", \"ample:\\n\\nprivate async Task InternalNavigateToAsync(Type viewModelType, object parameter)\\n\\n{\\n\\nPage pa\", \"ge = CreatePage(viewModelType, parameter) ;\\n\\nif (page is LoginView)\\n\\n{\\nApplication.Current.MainPage \", \"= new CustomNavigationView(page) ;\\n}\\nelse\\n{\\nvar navigationPage = Application.Current.MainPage as Cus\", \"tomNavigationView;\\nif CnavigationPage != null)\\n{\\nawait navigationPage.PushAsync (page) ;\\n}\\nelse\\n{\\nAp\", \"plication.Current.MainPage = new CustomNavigationView(page) ;\\n}\\n}\\nawait (page.BindingContext as View\", \"ModelBase).InitializeAsync(parameter) ;\\n}\\nprivate Type GetPageTypeForViewModel (Type viewModelType)\\n\", \"{\\nvar viewName = viewModelType.FullName.Replace(''Mode!l\\\", string.Empty) ;\\nvar viewModelAssemblyName\", \" = viewModelType.GetTypeInfoQ .Assembly.Ful1lName;\\nvar viewAssemblyName = string.Format(\\nCultureInfo\", \".InvariantCulture, \\\"\\u201c{0}, {1}\\\", viewName, viewModelAssemblyName) ;\\nvar viewlype = Type.GetType(viewA\", \"ssemb] yName) ;\\nreturn viewType;\\n}\\n\\nprivate Page CreatePage(lype viewModelType, object parameter)\\n{\\n\", \"Type pageType = GetPageTypeForVi ewModel (viewModelType) ;\\nif CpageType == null)\\n{\\nthrow new Excepti\", \"on($\\\"Cannot locate page type for {viewModelType}\\\") ;\\n\\n}\\n\\n31 CHAPTER 5 | Navigation\\nPage page = Activ\", \"ator.CreateInstance(pagelype) as Page;\\nreturn page;\\n\\nThe InternalNavigateToAsync method performs nav\", \"igation to a view model by first calling the\\nCreatePage method. This method locates the view that co\", \"rresponds to the specified view model type,\\nand creates and returns an instance of this view type. L\", \"ocating the view that corresponds to the view\\nmodel type uses a convention-based approach, which ass\", \"umes that:\\n\\ne Views are in the same assembly as view model types.\\n\\ne Views are in a .Views child nam\", \"espace.\\n\\ne View models are in a .ViewModels child namespace.\\n\\ne View names correspond to view model \", \"names, with \\\"Model\\\" removed.\\n\\nWhen a view is instantiated, it's associated with its corresponding vi\", \"ew model. For more information\\nabout how this occurs, see Automatically creating a view model with a\", \" view model locator.\\n\\nIf the view being created is a LoginView, it's wrapped inside a new instance o\", \"f the\\nCustomNavigationView class and assigned to the Application. Current.MainPage property.\\nOtherwi\", \"se, the CustomNavi gati onVi ew instance is retrieved, and provided that it isn't nu11, the\\nPushAsyn\", \"c method is invoked to push the view being created onto the navigation stack. However, If\\nthe retrie\", \"ved CustomNavi gati onVi ew instance is nul1, the view being created is wrapped inside a\\nnew instanc\", \"e of the CustomNavigationvView class and assigned to the\\n\\nApplication. Current.MainPage property. Th\", \"is mechanism ensures that during navigation, pages\\nare added correctly to the navigation stack both \", \"when it's empty, and when it contains data.\\n\\nTip: Consider caching pages\\n\\nPage caching results in me\", \"mory consumption for views that are not currently displayed. However,\\nwithout page caching it does m\", \"ean that XAML parsing and construction of the page and its view\\nmodel will occur every time a new pa\", \"ge is navigated to, which can have a performance impact for a\\ncomplex page. For a well-designed page\", \" that does not use an excessive number of controls, the\\nperformance should be sufficient. However, p\", \"age caching might help if slow page loading times are\\nencountered.\\n\\nAfter the view is created and na\", \"vigated to, the InitializeAsync method of the view's associated\\nview model is executed. For more inf\", \"ormation, see Passing parameters during navigation.\\n\\nNavigating when the app Is launched\\n\\nWhen the a\", \"pp is launched, the InitNavigation method in the App class is invoked. The following\\ncode example sh\", \"ows this method:\\n\\nprivate Task InitNavigation()\\n\\n{\\nvar navigationService = ViewModelLocator.Resolve<\", \"INavigationService>() ;\\nreturn navigationService.InitializeAsync() ;\\n\\nThe method creates a new Navig\", \"ationService object in the Autofac dependency injection container,\\nand returns a reference to it, be\", \"fore invoking its InitializeAsync method.\\n\\n32 CHAPTER 5 | Navigation\\nNote: When the INavigationServi\", \"ce interface is resolved by the ViewMode1Base class, the\\ncontainer returns a reference to the Naviga\", \"tionService object that was created when the\\nInitNavigation method is invoked.\\n\\nThe following code e\", \"xample shows the NavigationService InitializeAsync method:\\n\\npublic Task InitializeAsync()\\n\\n{\\nif Cstr\", \"ing.IsNul10rEmpty(Settings.AuthAccessToken) )\\nreturn NavigateToAsync<LoginViewModel>();\\nelse\\nreturn \", \"NavigateToAsync<MainViewModel>();\\n}\\n\\nThe MainView is navigated to if the app has a cached access tok\", \"en, which is used for authentication.\\nOtherwise, the LoginVi ew Is navigated to.\\n\\nFor more informati\", \"on about the Autofac dependency injection container, see Introduction to\\ndependency injection.\\n\\nPass\", \"ing parameters during navigation\\n\\nOne of the NavigateToAsync methods, specified by the INavigationSe\", \"rvice interface, enables\\nnavigation data to be specified as an argument that's passed to the view mo\", \"del being navigated to,\\nwhere it's typically used to perform initialization.\\n\\nFor example, the Profi\", \" 1eViewModel class contains an OrderDetai 1Command that's executed when\\nthe user selects an order on\", \" the ProfileView page. In turn, this executes the OrderDetai lAsync\\nmethod, which is shown in the fo\", \"llowing code example:\\n\\nprivate async Task OrderDetailAsync(Order order)\\n\\n{\\n\\nawait NavigationService.\", \"NavigateToAsync<OrderDetai |!ViewMode|l>(Corder) ;\\n\\n}\\n\\nThis method invokes navigation to the OrderDe\", \"tai 1ViewModel, passing an Order instance that\\nrepresents the order that the user selected on the Pr\", \"ofileView page. When the NavigationService\\nclass creates the OrderDetai 1View, the OrderDetai 1ViewM\", \"ode!] class is instantiated and assigned to\\nthe view's BindingContext. After navigating to the Order\", \"Detai 1View, the\\nInternalNavigateToAsync method executes the InitializeAsync method of the view's as\", \"sociated\\nview model.\\n\\nThe InitializeAsync method is defined in the ViewModelBase class as a method t\", \"hat can be\\noverridden. This method specifies an object argument that represents the data to be passe\", \"d to a\\nview model during a navigation operation. Therefore, view model classes that want to receive \", \"data\\nfrom a navigation operation provide their own implementation of the InitializeAsync method to\\np\", \"erform the required initialization. The following code example shows the InitializeAsync method\\nfrom\", \" the OrderDetai 1ViewMode] class:\\n\\npublic override async Task InitializeAsync(object navigationData)\", \"\\n\\n{\\n\\nif CnavigationData is Order)\\n\\n{\\n\\nOrder = await _ordersService.GetOrderAsync(\\nConvert. ToInt32(o\", \"rder.OrderNumber), authToken) ;\\n\\n33 CHAPTER 5 | Navigation\\nThis method retrieves the Order instance \", \"that was passed into the view model during the navigation\\noperation, and uses it to retrieve the ful\", \"l order details from the OrderService instance.\\n\\nInvoking navigation using behaviors\\n\\nNavigation is \", \"usually triggered from a view by a user interaction. For example, the LoginVi ew\\nperforms navigation\", \" following successful authentication. The following code example shows how the\\nnavigation is invoked\", \" by a behavior:\\n\\n<WebView ...>\\n<WebView. Behaviors>\\n<behaviors: EventToCommandBehavior\\nEventName=\\\"Na\", \"vigating\\\"\\nEventArgsConverter=\\\"{StaticResource WebNavigatingEventArgsConverter}\\\"\\nCommand=\\\"{Binding Na\", \"vigateCommand}\\\" />\\n</WebView.Behaviors>\\n</WebVi ew>\\n\\nAt runtime, the EventToCommandBehavior will res\", \"pond to interaction with the WebVi ew. When the\\nWebVi ew navigates to a web page, the Navigating eve\", \"nt will fire, which will execute the\\nNavigateCommand in the LoginViewModel. By default, the event ar\", \"guments for the event are passed\\nto the command. This data is converted as it's passed between sourc\", \"e and target by the converter\\nspecified in the EventArgsConverter property, which returns the Url fr\", \"om the\\nWebNavigatingEventArgs. Therefore, when the NavigationCommand is executed, the Url of the web\", \"\\npage Is passed as a parameter to the registered Action.\\n\\nIn turn, the NavigationCommand executes th\", \"e NavigateAsync method, which is shown in the\\nfollowing code example:\\n\\nprivate async Task NavigateAs\", \"ync(string url)\\n\\n{\\n\\nawait NavigationService.NavigateToAsync<MainViewMode I>() ;\\nawait NavigationServ\", \"ice.RemoveLastFromBackStackAsync() ;\\n\\nThis method invokes navigation to the MainViewModel, and follo\", \"wing navigation, removes the\\nLoginView page from the navigation stack.\\n\\nConfirming or cancelling nav\", \"igation\\n\\nAn app might need to interact with the user during a navigation operation, so that the user\", \" can\\nconfirm or cancel navigation. This might be necessary, for example, when the user attempts to\\nn\", \"avigate before having fully completed a data entry page. In this situation, an app should provide a\\n\", \"notification that allows the user to navigate away from the page, or to cancel the navigation operat\", \"ion\\nbefore it occurs. This can be achieved in a view model class by using the response from a notifi\", \"cation\\nto control whether or not navigation is invoked.\\n\\n34 CHAPTER 5 | Navigation\\nSummary\\n\\nXamarin.\", \"Forms includes support for page navigation, which typically results from the user's interaction\\nwith\", \" the UI, or from the app itself, as a result of internal logic-driven state changes. However,\\nnaviga\", \"tion can be complex to implement in apps that use the MVVM pattern.\\n\\nThis chapter presented a Naviga\", \"tionService class, which is used to perform view model-first\\nnavigation from view models. Placing na\", \"vigation logic in view model classes means that the logic can\\nbe exercised through automated tests. \", \"In addition, the view model can then implement logic to\\ncontrol navigation to ensure that certain bu\", \"siness rules are enforced.\\n\\n35 CHAPTER 5 | Navigation\\nCHAPTER\\n\\nValidation\\n\\nAny app that accepts inpu\", \"t from users should ensure that the input is valid. An app could, for\\nexample, check for input that \", \"contains only characters in a particular range, is of a certain length, or\\nmatches a particular form\", \"at. Without validation, a user can supply data that causes the app to fail.\\nValidation enforces busi\", \"ness rules, and prevents an attacker from injecting malicious data.\\n\\nIn the context of the Model-Vie\", \"wModel-Model (MVVM) pattern, a view model or model will often be\\nrequired to perform data validation\", \" and signal any validation errors to the view so that the user can\\ncorrect them. The eShopOnContaine\", \"rs mobile app performs synchronous client-side validation of view\\nmodel properties and notifies the \", \"user of any validation errors by highlighting the control that\\ncontains the invalid data, and by dis\", \"playing error messages that inform the user of why the data is\\ninvalid. Figure 6-1 shows the classes\", \" involved in performing validation in the eShopOnContainers\\nmobile app.\\n\\nEntry\\ngets errors to displa\", \"y\\n\\nsets properties \\u00a9) \\\\_)\\nlValidity | INotifyPropertyChanged\\n\\nValidatableObject | . ExtendedBindable\", \"\\nObject\\n\\nViewModel class\\n<I> derives from\\ncreates and uses\\n\\nadds\\n\\nlValidationRule<T>\\n\\nValidationrule\", \"s\\nexecutes\\n\\nFigure 6-1: Validation classes in the eshopOnContainers mobile app\\n\\nView model propertie\", \"s that require validation are of type ValidatableObject<T>, and each\\nValidatableObject<T> instance h\", \"as validation rules added to its Validations property. Validation\\nis invoked from the view model by \", \"calling the Validate method of the Validatab1eObject<T>\\n\\n36 CHAPTER 6 | Validation\\ninstance, which r\", \"etrieves the validation rules and executes them against the Validatab1eObject<T>\\nValue property. Any\", \" validation errors are placed into the Errors property of the\\nValidatableObject<T> instance, and the\", \" IsValid property of the ValidatableObject<T> instance\\nis updated to indicate whether validation suc\", \"ceeded or failed.\\n\\nProperty change notification is provided by the ExtendedBindab1eObject class, and\", \" so an Entry\\ncontrol can bind to the IsValid property of ValidatableObject<T> instance in the view m\", \"odel class\\nto be notified of whether or not the entered data Is valid.\\n\\nSpecifying validation rules\\n\", \"\\nValidation rules are specified by creating a class that derives from the IValidationRule<T> interfa\", \"ce,\\nwhich is shown in the following code example:\\n\\npublic interface IValidationRule<T>\\n\\n{\\n\\nstring Va\", \"lidationMessage { get; set; }\\nbool Check(T value);\\n\\nThis interface specifies that a validation rule \", \"class must provide a boolean Check method that is used\\nto perform the required validation, and a Val\", \"idationMessage property whose value is the validation\\nerror message that will be displayed if valida\", \"tion fails.\\n\\nThe following code example shows the IsNotNul10rEmptyRule<T> validation rule, which is \", \"used to\\nperform validation of the username and password entered by the user on the LoginView when us\", \"ing\\nmock services in the eSshopOnContainers mobile app:\\n\\npublic class IsNotNullOrEmptyRule<T> : IVal\", \"idationRule<T>\\n\\n{\\npublic string ValidationMessage { get; set; }\\npublic bool Check(T value)\\n{\\nif Cval\", \"ue == null)\\n{\\nreturn false;\\n}\\nvar str = value as string;\\nreturn !string.IsNullOrwhiteSpace(str) ;\\n}\\n\", \"}\\n\\nThe Check method returns a boolean indicating whether the value argument is nul 1, empty, or\\ncons\", \"ists only of whitespace characters.\\n\\nAlthough not used by the eShopOnContainers mobile app, the foll\", \"owing code example shows a\\nvalidation rule for validating email addresses:\\n\\npublic class EmailRule<T\", \"> : IValidationRule<T>\\n\\n{\\npublic string ValidationMessage { get; set; }\\n\\npublic bool Check(T value)\\n\", \"{\\n\\nif Cvalue == null)\\n\\n37 CHAPTER 6 | Validation\\n{\\n\\nreturn false;\\n\\n}\\n\\nvar str = value as string;\\nReg\", \"ex regex = new Regex(@\\\"A([\\\\w\\\\.\\\\-]+)@C[\\\\w\\\\-]+) CC\\\\. Qw) {2, 334+) $\\\") 5\\nMatch match regex.Match(str) \", \";\\n\\nreturn match.Success;\\n\\nThe Check method returns a boolean indicating whether or not the value arg\", \"ument is a valid email\\naddress. This is achieved by searching the value argument for the first occur\", \"rence of the regular\\nexpression pattern specified in the Regex constructor. Whether the regular expr\", \"ession pattern has\\nbeen found in the input string can be determined by checking the value of the Mat\", \"ch object's\\nSuccess property.\\n\\nNote: Property validation can sometimes involve dependent properties.\", \" An example of dependent\\nproperties is when the set of valid values for property A depends on the pa\", \"rticular value that has\\nbeen set in property B. To check that the value of property A Is one of the \", \"allowed values would\\ninvolve retrieving the value of property B. In addition, when the value of prop\", \"erty B changes,\\nproperty A would need to be revalidated.\\n\\nAdding validation rules to a property\\n\\nIn \", \"the eShopOnContainers mobile app, view model properties that require validation are declared to\\nbe o\", \"f type ValidatableObject<T>, where T is the type of the data to be validated. The following\\ncode exa\", \"mple shows an example of two such properties:\\n\\npublic ValidatableObject<string> UserName\\n\\n{\\nget\\n{\\nre\", \"turn _userName;\\nset\\n{\\n_userName = value;\\nRaisePropertyChanged(() => UserName) ;\\n}\\n}\\npublic Validatab\", \"leObject<string> Password\\n{\\nget\\n{\\nreturn _password;\\n}\\nset\\n{\\n_password = value;\\nRaisePropertyChanged(\", \"() => Password);\\n}\\n}\\n\\nFor validation to occur, validation rules must be added to the Validations col\", \"lection of each\\nValidatableObject<T> instance, as demonstrated in the following code example:\\n\\n38 CH\", \"APTER 6 | Validation\\nprivate void AddValidations()\\n\\n{\\n_userName.Validations.Add(new IsNotNul lOrEmpt\", \"yRule<string>\\n{\\nValidationMessage = \\\"A username is required.\\\"\\n5D;\\n_password.Validations.Add(new IsNo\", \"tNu] lOrEmptyRule<string>\\n{\\nValidationMessage = \\\"A password is required.\\\"\\n5D;\\n}\\n\\nThis method adds th\", \"e IsNotNu110rEmptyRule<T> validation rule to the Validations collection of\\neach ValidatableObject<T>\", \" instance, specifying values for the validation rule's ValidationMessage\\nproperty, which specifies t\", \"he validation error message that will be displayed if validation fails.\\n\\nTriggering validation\\n\\nThe \", \"validation approach used in the eshopOnContainers mobile app can manually trigger validation\\nof a pr\", \"operty, and automatically trigger validation when a property changes.\\n\\nTriggering validation manuall\", \"y\\n\\nValidation can be triggered manually for a view model property. For example, this occurs in the\\ne\", \"ShopOnContainers mobile app when the user taps the Login button on the LoginView, when using\\nmock se\", \"rvices. The command delegate calls the MockSignInAsync method in the LoginViewModel,\\nwhich invokes v\", \"alidation by executing the Validate method, which is shown in the following code\\nexample:\\n\\nprivate b\", \"ool Validate()\\n\\n{\\nbool isValidUser = ValidateUserName() ;\\nbool isValidPassword = ValidatePassword() \", \";\\nreturn isValidUser && isValidPassword;\\n}\\nprivate bool ValidateUserName()\\n{\\nreturn _userName.Valida\", \"teQ ;\\n}\\nprivate bool ValidatePassword()\\n{\\nreturn _password.Validate() ;\\n}\\n\\nThe Validate method perfo\", \"rms validation of the username and password entered by the user on the\\nLoginView, by invoking the Va\", \"lidate method on each Validatab1leObject<T> instance. The\\nfollowing code example shows the Validate \", \"method from the Validatab1eObject<T> class:\\n\\npublic bool ValidateQ\\n{\\n\\nErrors.Clear();\\nTEnumerable<st\", \"ring> errors = _validations\\n\\n.Where(v => !v.Check(Value))\\n.Select(v => v.ValidationMessage) ;\\n\\n39 CH\", \"APTER 6 | Validation\\nErrors = errors.ToList(Q);\\nIsValid = !Errors.Any(Q);\\n\\nreturn this.IsValid;\\n\\nThi\", \"s method clears the Errors collection, and then retrieves any validation rules that were added to\\nth\", \"e object's Validations collection. The Check method for each retrieved validation rule is executed,\\n\", \"and the ValidationMessage property value for any validation rule that fails to validate the data is\\n\", \"added to the Errors collection of the ValidatableObject<T> instance. Finally, the IsValid property\\ni\", \"s set, and its value is returned to the calling method, indicating whether validation succeeded or\\nf\", \"ailed.\\n\\nTriggering validation when properties change\\n\\nValidation is also automatically triggered whe\", \"never a bound property changes. For example, when a\\ntwo-way binding in the LoginView sets the UserNa\", \"me or Password property, validation is triggered.\\nThe following code example demonstrates how this o\", \"ccurs:\\n\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\">\\n<Entry.Behaviors>\\n<behaviors: EventToCo\", \"mmandBehavior\\nEventName=\\\"TextChanged\\\"\\nCommand=\\\"{Binding ValidateUserNameCommand}\\\" />\\n</Entry.Behavio\", \"rs>\\n\\n</Entry>\\n\\nThe Entry control binds to the UserName. Value property of the Validatab1eObject<T> i\", \"nstance,\\nand the control's Behaviors collection has an EventToCommandBehavior instance added to it. \", \"This\\nbehavior executes the ValidateUserNameCommand in response to the TextChanged event firing on\\nth\", \"e Entry, which is raised when the text in the Entry changes. In turn, the\\nValidateUserNameCommand de\", \"legate executes the ValidateUserName method, which executes the\\nValidate method on the ValidatableOb\", \"ject<T> instance. Therefore, every time the user enters a\\ncharacter in the Entry control for the use\", \"rname, validation of the entered data is performed.\\n\\nFor more information about behaviors, see Imple\", \"menting behaviors.\\n\\nDisplaying validation errors\\n\\nThe eShopOnContainers mobile app notifies the user\", \" of any validation errors by highlighting the\\ncontrol that contains the invalid data with a red line\", \", and by displaying an error message that informs\\nthe user why the data is invalid below the control\", \" containing the invalid data. When the invalid data is\\ncorrected, the line changes to black and the \", \"error message is removed. Figure 6-2 shows the\\nLoginView in the eSshopOnContainers mobile app when v\", \"alidation errors are present.\\n\\n40 CHAPTER 6 | Validation\\nUser name or email\\n\\nA username Is required.\", \"\\n\\nPassword\\n\\nA password is required.\\nFigure 6-2: Displaying validation errors during login\\n\\nHighlight\", \"ing a control that contains invalid data\\n\\nThe LineColorBehavior attached behavior is used to highlig\", \"ht Entry controls where validation\\nerrors have occurred. The following code example shows how the Li\", \"neColorBehavior attached\\nbehavior is attached to an Entry control:\\n\\n<Entry Text=\\\"{Binding UserName.V\", \"alue, Mode=TwoWay}\\\">\\n<Entry.Style>\\n<OnPlatform x:TypeArguments=\\\"Style\\\"\\n10S=\\\"{StaticResource EntrySty\", \"le}\\\"\\nAndroid=\\\"{StaticResource EntryStyle}\\\"\\nWinPhone=\\\"{StaticResource UwpEntrySty le}\\\"/>\\n</Entry.Styl\", \"e>\\n\\n</Entry>\\nThe Entry control consumes an explicit style, which is shown in the following code exam\", \"ple:\\n\\n<Style x:Key=\\\"EntryStyle\\\"\\nTargetType=\\\"{x:Type Entry}\\\">\\n\\n<Setter Property=\\\"behaviors:LineColorB\", \"ehavior.ApplyLineColor\\\"\\nValue=\\\"True\\\" />\\n\\n<Setter Property=\\\"behaviors:LineColorBehavior.LineColor\\\"\\nVa\", \"lue=\\\"{StaticResource BlackColor}\\\" />\\n\\n</Style>\\nThis style sets the ApplyLineColor and LineColor atta\", \"ched properties of the LineColorBehavior\\n\\nattached behavior on the Entry control. For more informati\", \"on about styles, see Styles on the Xamarin\\nDeveloper Center.\\n\\nWhen the value of the Appl yLineColor \", \"attached property is set, or changes, the LineColorBehavior\\nattached behavior executes the OnApp1yLi\", \"neColorChanged method, which is shown in the following\\ncode example:\\n\\n41 CHAPTER 6 | Validation\\npubl\", \"ic static class LineColorBehavior\\n\\n{\\nprivate static void OnApplyLineColorChanged(\\nBindableObject bin\", \"dable, object oldValue, object newValue)\\n{\\nvar view = bindable as View;\\nif (view == null)\\n{\\nreturn;\\n\", \"$\\nbool hasLine = (boo!l)newValue;\\nif ChasLine)\\n{\\nview.Effects.Add(new EntryLineColorEffectQ) ;\\n$\\nels\", \"e\\n{\\nvar entryLineColorEffectToRemove =\\nview.Effects.FirstOrDefault(Ce => e is EntryLineColorEffect) \", \";\\nif CentryLineColorEffectToRemove != null)\\n{\\nview.Effects.Remove(entryLineColorEffectToRemove) ;\\n$\\n\", \"$\\n$\\n$\\n\\nThe parameters for this method provide the instance of the control that the behavior is attac\", \"hed to,\\nand the old and new values of the ApplyLineColor attached property. The EntryLineColorEffect\", \"\\nclass is added to the control's Effects collection if the ApplyLineColor attached property Is true,\", \"\\notherwise It's removed from the control's Effects collection. For more information about behaviors,\", \"\\n\\nsee Implementing behaviors.\\n\\nThe EntryLineColorEffect subclasses the RoutingEffect class, and is s\", \"hown in the following code\\nexample:\\n\\npublic class EntryLineColorEffect : RoutingEffect\\n\\n{\\npublic Ent\", \"ryLineColorEffectQ) : baseC\\\"eShopOnContainers.EntryLineColorEffect\\\")\\n{\\n$\\n\\n$\\n\\nThe RoutingEffect class\", \" represents a platform-independent effect that wraps an inner effect that's\\nplatform-specific. This \", \"simplifies the effect removal process, since there is no compile-time access to\\nthe type information\", \" for a platform-specific effect. The EntryLineColorEffect calls the base class\\nconstructor, passing \", \"in a parameter consisting of a concatenation of the resolution group name, and\\nthe unique ID that's \", \"specified on each platform-specific effect class.\\n\\nThe following code example shows the eShopOnConta\", \"iners.EntryLineColorEffect implementation for\\niOS:\\n\\n[assembly: ResolutionGroupName(\\\"eShopOnContainer\", \"s\\\") ]\\n[assembly: ExportEffect(typeofCEntryLineColorEffect), \\\"\\u201cEntryLineColorEffect\\\")]\\nnamespace eSho\", \"pOnContainers.i0S.Effects\\n{\\npublic class EntryLineColorEffect : PlatformEffect\\n\\n42 CHAPTER 6 | Valid\", \"ation\\n43\\n\\nUITextField control;\\n\\nprotected override void OnAttached()\\n\\n{\\ntry\\n{\\ncontrol = Control as U\", \"ITextField;\\nUpdateLineColor();\\n}\\ncatch CException ex)\\n{\\nConsole.WriteLine(\\\"Can't set property on att\", \"ached control. Error: \\\", ex.Message);\\n}\\n}\\nprotected override void OnDetached()\\n{\\ncontrol = null;\\n}\\n\\n\", \"protected override void OnElementPropertyChanged(PropertyChangedEventArgs args)\\n\\n{\\nbase.OnElementPro\", \"pertyChanged(args) ;\\n\\nif Cargs.PropertyName == LineColorBehavior.LineColorProperty.PropertyName | |\\n\", \"args.PropertyName == \\u201cHeight\\\")\\n{\\nInitializeQ;\\nUpdateLineColor();\\n}\\n}\\nprivate void Initialize ()\\n{\\nva\", \"r entry = Element as Entry;\\nif Centry != null)\\n{\\nControl.Bounds = new CGRect(O, 0, entry.Width, entr\", \"y.Height) ;\\n}\\n}\\nprivate void UpdateLineColor()\\n{\\nBorderLineLayer lineLayer = control.Layer.Sublayers\", \".OfType<BorderLineLayer>()\\n.FirstOrDefaultQ;\\nif ClineLayer == nul1)\\n{\\nlineLayer = new BorderLineLaye\", \"r() ;\\nlineLayer.MasksToBounds = true;\\nlineLayer.BorderWidth = 1.0f;\\ncontrol.Layer.AddSublayer(lineLa\", \"yer) ;\\ncontrol.BorderStyle = UITextBorderStyle. None;\\n}\\nlineLayer.Frame = new CGRect(Of, Control.Fra\", \"me.Height-1f, Control.Bounds.Width, if);\\nlineLayer.BorderColor = LineColorBehavior.GetLineColorCElem\", \"ent) .ToCGColorQ ;\\ncontrol.TintColor = control.TextColor;\\n}\\nprivate class BorderLineLayer : CALayer\\n\", \"{\\n}\\n\\nCHAPTER 6 | Validation\\nThe OnAttached method retrieves the native control for the Xamarin.Forms\", \" Entry control, and\\nupdates the line color by calling the UpdateLineColor method. The OnElementPrope\", \"rtyChanged\\noverride responds to bindable property changes on the Entry control by updating the line \", \"color if the\\nattached LineColor property changes, or the Height property of the Entry changes. For m\", \"ore\\ninformation about effects, see Effects on the Xamarin Developer Center.\\n\\nWhen valid data is ente\", \"red in the Entry control, it will apply a black line to the bottom of the control,\\nto indicate that \", \"there is no validation error. Figure 6-3 shows an example of this.\\n\\nUser name or email\\n\\njohndoe\\n\\nFig\", \"ure 6-3: Black line indicating no validation error\\n\\nThe Entry control also has a DataTrigger added t\", \"o its Triggers collection. The following code\\nexample shows the DataTrigger:\\n\\n<Entry Text=\\\"{Binding \", \"UserName.Value, Mode=TwoWay}\\\">\\n\\n<Entry.Triggers>\\n<DataTrigger\\nTargetType=\\\"Entry\\\"\\nBinding=\\\"{Binding U\", \"serName.IsValid}\\\"\\nValue=\\\"False\\\">\\n<Setter Property=\\\"behaviors:LineColorBehavior.LineColor\\\"\\nValue=\\\"{St\", \"aticResource ErrorColor}\\\" />\\n</DataTrigger>\\n</Entry.Triggers>\\n</Entry>\\n\\nThis DataTrigger monitors th\", \"e UserName. IsValid property, and if it's value becomes false, it\\nexecutes the Setter, which changes\", \" the LineColor attached property of the LineColorBehavior\\nattached behavior to red. Figure 6-4 shows\", \" an example of this.\\n\\nUser name or email\\n\\nFigure 6-4: Red line indicating validation error\\n\\nThe line\", \" in the Entry control will remain red while the entered data is invalid, otherwise it will change\\nto\", \" black to indicate that the entered data Is valid.\\n\\nFor more information about Triggers, see Trigger\", \"s on the Xamarin Developer Center.\\n\\nDisplaying error messages\\n\\nThe UI displays validation error mess\", \"ages in Label controls below each control whose data failed\\nvalidation. The following code example s\", \"hows the Label that displays a validation error message if\\nthe user has not entered a valid username\", \":\\n\\n44 CHAPTER 6 | Validation\\n<Label Text=\\\"{Binding UserName.Errors, Converter={StaticResource FirstV\", \"alidationErrorConverter}\\\"\\nStyle=\\\"{StaticResource ValidationErrorLabelStyle}\\\" />\\n\\nEach Label binds to\", \" the Errors property of the view model object that's being validated. The Errors\\nproperty is provide\", \"d by the ValidatableObject<T> class, and is of type List<string>. Because the\\nErrors property can co\", \"ntain multiple validation errors, the FirstValidationErrorConverter\\ninstance Is used to retrieve the\", \" first error from the collection for display.\\n\\nSummary\\n\\nThe eShopOnContainers mobile app performs sy\", \"nchronous client-side validation of view model\\nproperties and notifies the user of any validation er\", \"rors by highlighting the control that contains the\\ninvalid data, and by displaying error messages th\", \"at inform the user why the data Is invalid.\\n\\nView model properties that require validation are of ty\", \"pe ValidatableObject<T>, and each\\nValidatableObject<T> instance has validation rules added to its Va\", \"lidations property. Validation\\nis invoked from the view model by calling the Validate method of the \", \"ValidatableObject<T>\\ninstance, which retrieves the validation rules and executes them against the Va\", \"lidatab1eObject<T>\\nValue property. Any validation errors are placed into the Errors property of the\\n\", \"ValidatableObject<T> instance, and the IsValid property of the ValidatableObject<T> instance\\nis upda\", \"ted to indicate whether validation succeeded or failed.\\n\\n45 CHAPTER 6 | Validation\\nCHAPTER\\n\\nConfigur\", \"ation\\nmanagement\\n\\nSettings allow the separation of data that configures the behavior of an app from \", \"the code, allowing\\nthe behavior to be changed without rebuilding the app. There are two types of set\", \"tings: app settings,\\nand user settings.\\n\\nApp settings are data that an app creates and manages. It c\", \"an include data such as fixed web service\\nendpoints, API keys, and runtime state. App settings are t\", \"ied to the existence of the app and are only\\nmeaningful to that app.\\n\\nUser settings are the customiz\", \"able settings of an app that affect the behavior of the app and don't\\nrequire frequent re-adjustment\", \". For example, an app might let the user specify where to retrieve data\\nfrom, and how to display it \", \"on the screen.\\n\\nXamarin.Forms includes a persistent dictionary that can be used to store settings da\", \"ta. This dictionary\\ncan be accessed using the Application.Current.Properties property, and any data \", \"that's placed\\ninto it is saved when the app goes into a sleep state, and is restored when the app re\", \"sumes or starts\\nup again. In addition, the Application class also has a SavePropertiesAsync method t\", \"hat allows an\\napp to have its settings saved when required. For more information about this dictiona\", \"ry, see\\nProperties Dictionary on the Xamarin Developer Center.\\n\\nA downside to storing data using the\", \" Xamarin.Forms persistent dictionary is that it's not easily data\\nbound to. Therefore, the eshopOnCo\", \"ntainers mobile app uses the Xam.Plugins.Settings library,\\navailable from NuGet. This library provid\", \"es a consistent, type-safe, cross-platform approach for\\npersisting and retrieving app and user setti\", \"ngs, while using the native settings management provided\\nby each platform. In addition, it's straigh\", \"tforward to use data binding to access settings data exposed\\nby the library.\\n\\nNote: While the Xam.Pl\", \"ugin.Settings library can store both app and user settings, it makes no\\ndistinction between the two.\", \"\\n\\nCreating a settings class\\n\\nWhen using the Xam.Plugins.Settings library, a single static class shou\", \"ld be created that will contain\\nthe app and user settings required by the app. The following code ex\", \"ample shows the Settings class\\nin the eShopOnContainers mobile app:\\n\\n46 CHAPTER 7 | Configuration ma\", \"nagement\\npublic static class Settings\\n\\n{\\nprivate static [Settings AppSettings\\n{\\nget\\n{\\nreturn CrossSe\", \"ttings.Current;\\n}\\n}\\n}\\n\\nSettings can be read and written through the ISettings API, which is provided\", \" by the\\nXam.Plugins.Settings library. This library provides a singleton that can be used to access t\", \"he API,\\nCrossSettings.Current, and an app's settings class should expose this singleton via an ISett\", \"ings\\n\\nproperty.\\nNote: Using directives for the Plugin. Settings and Plugin.Settings.Abstractions\\n\\nna\", \"mespaces should be added to a class that requires access to the Xam.Plugins.Settings library\\ntypes.\\n\", \"\\nAdding a setting\\nEach setting consists of a key, a default value, and a property. The following cod\", \"e example shows all\\nthree items for a user setting that represents the base URL for the online servi\", \"ces that the\\n\\neShopOnContainers mobile app connects to:\\n\\npublic static class Settings\\n\\n{\\nprivate con\", \"st string IdUrlBase = \\\"url_base\\\";\\nprivate static readonly string UrlBaseDefault = GlobalSetting. Ins\", \"tance. BaseEndpoint;\\npublic static string UrlBase\\n{\\nget\\n{\\nreturn AppSettings.GetValueOrDefault<strin\", \"g>(CIdUrlBase, UrlBaseDefault) ;\\nset\\n{\\nAppSettings.AddOrUpdateValue<string>CIdUrlBase, value);\\n}\\n}\\n}\", \"\\n\\nThe key is always a const string that defines the key name, with the default value for the setting\", \"\\nbeing a static readonly value of the required type. Providing a default value ensures that a valid\\n\", \"value is available if an unset setting is retrieved.\\n\\nThe UrlBase static property uses two methods f\", \"rom the ISettings API to read or write the setting\\nvalue. The ISettings .GetValueOrDefault method is\", \" used to retrieve a setting's value from\\nplatform-specific storage. If no value is defined for the s\", \"etting, its default value is retrieved instead.\\nSimilarly, the ISettings .AddOrUpdateValue method is\", \" used to persist a setting's value to platform-\\nspecific storage.\\n\\n47 CHAPTER 7 | Configuration mana\", \"gement\\nRather that define a default value inside the Settings class, the UrlBaseDefault string obtai\", \"ns its\\nvalue from the Global Setting class. The following code example shows the BaseEndpoint proper\", \"ty\\nand UpdateEndpoint method in this class:\\n\\npublic class GlobalSetting\\n{\\n\\npublic string BaseEndpoin\", \"t\\n{\\nget { return _baseEndpoint; }\\nset\\n{\\n_baseEndpoint = value;\\nUpdateEndpoint (_baseEndpoint) ;\\n\\npri\", \"vate void UpdateEndpoint(string baseEndpoint)\\n{\\n\\nRegisterWebsite = string.FormatC'{0}:5105/Account/R\", \"egister\\\", baseEndpoint) ;\\nCatalogEndpoint string.FormatC'{0}:5101\\\", baseEndpoint) ;\\n\\nOrdersEndpoint \", \"= string.Format('{0}:5102\\\", baseEndpoint) ;\\n\\nBasketEndpoint = string. Format('{0}:5103\\\", baseEndpoin\", \"t) ;\\n\\nIdentityEndpoint = string. Format('{0}:5105/connect/authorize\\\", baseEndpoint) ;\\nUserInfoEndpoi\", \"nt = string.FormatC'{0}:5105/connect/userinfo\\\", baseEndpoint) ;\\nTokenEndpoint = string.Format(C'{0}:\", \"5105/connect/token\\\", baseEndpoint) ;\\nLogoutEndpoint = string. Format('{0}:5105/connect/endsession\\\", \", \"baseEndpoint) ;\\nIdentityCallback = string. Format(C' {0}:5105/xamarincallback\\\", baseEndpoint) ;\\nLogo\", \"utCallback = string. Format(C'{0}:5105/Account/Redirecting\\\", baseEndpoint) ;\\n\\nEach time the BaseEndp\", \"oint property is set, the UpdateEndpoint method is called. This method\\nupdates a series of propertie\", \"s, all of which are based on the UrlBase user setting that's provided by\\nthe Settings class that rep\", \"resent different endpoints that the eshopOnContainers mobile app\\nconnects to.\\n\\nData binding to user \", \"settings\\n\\nIn the eSshopOnContainers mobile app, the SettingsView exposes two user settings. These se\", \"ttings\\nallow configuration of whether the app should retrieve data from microservices that are deplo\", \"yed as\\nDocker containers, or whether the app should retrieve data from mock services that don't requ\", \"ire an\\ninternet connection. When choosing to retrieve data from containerized microservices, a base\\n\", \"endpoint URL for the microservices must be specified. Figure 7-1 shows the SettingsView when the\\nuse\", \"r has chosen to retrieve data from containerized microservices.\\n\\n48 CHAPTER 7 | Configuration manage\", \"ment\\nUse Microservices/Containers from\\neShopOnContainers\\n\\nWhen enabling the use of microservices/con\", \"tainers,\\n\\nthe app will attempt to use real services deployed Cc\\n\\nas Docker containers at the specifi\", \"ed base\\nendpoint, which will must be reachable through the\\n\\nnetwork.\\n\\nEndpoint\\nhttp://13.88.8.119\\n\\nF\", \"igure 7-1: User settings exposed by the eSshopOnContainers mobile app\\n\\nData binding can be used to r\", \"etrieve and set settings exposed by the Settings class. This is achieved\\nby controls on the view bin\", \"ding to view model properties that in turn access properties in the\\nSettings class, and raising a pr\", \"operty changed notification if the settings value has changed. For\\ninformation about how the eShopOn\", \"Containers mobile app constructs view models and associates\\n\\nthem to views, see Automatically creati\", \"ng a view model with a view model locator.\\n\\nThe following code example shows the Entry control from \", \"the SettingsVi ew that allows the user to\\nenter a base endpoint URL for the containerized microservi\", \"ces:\\n\\n<Entry Text=\\\"{Binding Endpoint, Mode=TwoWay}\\\" />\\n\\nThis Entry control binds to the Endpoint pro\", \"perty of the SettingsViewModel class, using a two-way\\nbinding. The following code example shows the \", \"Endpoint property:\\n\\npublic string Endpoint\\n\\n{\\nget { return _endpoint; }\\nset\\n{\\n_endpoint = value;\\nifC\", \"!string.IsNull0OrEmpty (_endpoint) )\\n{\\nUpdateEndpoint (_endpoint) ;\\n}\\nRaisePropertyChanged(() => End\", \"point);\\n}\\n}\\n\\nWhen the Endpoint property is set the UpdateEndpoint method is called, provided that th\", \"e supplied\\nvalue is valid, and property changed notification Is raised. The following code example s\", \"hows the\\nUpdateEndpoint method:\\n\\nprivate void UpdateEndpoint(string endpoint)\\n\\n{\\nSettings.UrlBase = \", \"endpoint;\\n\\n}\\n\\n49 CHAPTER 7 | Configuration management\\nThis method updates the UrlBase property in th\", \"e Settings class with the base endpoint URL value\\nentered by the user, which causes it to be persist\", \"ed to platform-specific storage.\\n\\nWhen the SettingsVi ew Is navigated to, the InitializeAsync method\", \" in the SettingsVi ewModel\\nclass is executed. The following code example shows this method:\\n\\npublic \", \"override Task InitializeAsync(object navigationData)\\n\\n{\\n\\nEndpoint = Settings.Ur1Base;\\n\\nThe method se\", \"ts the Endpoint property to the value of the Ur1Base property in the Settings class.\\nAccessing the U\", \"r1Base property causes the Xam.Plugins.Settings library to retrieve the settings value\\nfrom platform\", \"-specific storage. For information about how the InitializeAsync method is invoked,\\n\\nsee Passing par\", \"ameters during navigation.\\n\\nThis mechanism ensures that whenever a user navigates to the SettingsVie\", \"w, user settings are\\nretrieved from platform-specific storage and presented through data binding. Th\", \"en, if the user\\nchanges the settings values, data binding ensures that they are immediately persiste\", \"d back to\\nplatform-specific storage.\\n\\nSummary\\n\\nSettings allow the separation of data that configures\", \" the behavior of an app from the code, allowing\\nthe behavior to be changed without rebuilding the ap\", \"p. App settings are data that an app creates and\\nmanages, and user settings are the customizable set\", \"tings of an app that affect the behavior of the app\\nand don't require frequent re-adjustment.\\n\\nThe X\", \"am.Plugins.Settings library provides a consistent, type-safe, cross-platform approach for\\npersisting\", \" and retrieving app and user settings, and data binding can be used to access settings\\ncreated with \", \"the library.\\n\\n50 CHAPTER 7 | Configuration management\\nCHAPTER &\\n\\nContainerized\\nmicroservices\\n\\nDevelo\", \"ping client-server applications has resulted in a focus on building tiered applications that use\\nspe\", \"cific technologies in each tier. Such applications are often referred to as monolithic applications,\", \"\\nand are packaged onto hardware pre-scaled for peak loads. The main drawbacks of this development\\nap\", \"proach are the tight coupling between components within each tier, that individual components\\ncan't \", \"be easily scaled, and the cost of testing. A simple update can have unforeseen effects on the rest\\no\", \"f the tier, and so a change to an application component requires its entire tier to be retested and\\n\", \"redeployed.\\n\\nParticularly concerning in the age of the cloud, is that individual components can't be\", \" easily scaled. A\\nmonolithic application contains domain-specific functionality, and is typically di\", \"vided by functional\\nlayers such as front end, business logic, and data storage. A monolithic applica\", \"tion is scaled by\\ncloning the entire application onto multiple machines, as illustrated in Figure 8-\", \"1.\\n\\nFigure 8-1: Monolithic application scaling approach\\n\\n51 CHAPTER 8 | Containerized microservices\\n\", \"Microservices\\n\\nMicroservices offer a different approach to application development and deployment, a\", \"n approach\\nthat's suited to the agility, scale, and reliability requirements of modern cloud applica\", \"tions. A\\nmicroservices application is decomposed into independent components that work together to d\", \"eliver\\nthe application's overall functionality. The term microservice emphasizes that applications s\", \"hould be\\ncomposed of services small enough to reflect independent concerns, so that each microservic\", \"e\\nimplements a single function. In addition, each microservice has well-defined contracts so that ot\", \"her\\nmicroservices can communicate and share data with it. Typical examples of microservices include\\n\", \"shopping carts, inventory processing, purchase subsystems, and payment processing.\\n\\nMicroservices ca\", \"n scale-out independently, as compared to giant monolithic applications that scale\\ntogether. This me\", \"ans that a specific functional area, that requires more processing power or network\\nbandwidth to sup\", \"port demand, can be scaled rather than unnecessarily scaling-out other areas of the\\napplication. Fig\", \"ure 8-2 illustrates this approach, where microservices are deployed and scaled\\nindependently, creati\", \"ng instances of services across machines.\\n\\nAppi App2\\n\\n-* *\\n= By\\n-\\n- a\\nr .\\n- Fay\\n! i\\n| 1\\n_\\nte hal\\n* =\", \"\\n\\nFigure 8-2: Microservices application scaling approach\\n\\nMicroservice scale-out can be nearly insta\", \"ntaneous, allowing an application to adapt to changing\\nloads. For example, a single microservice in \", \"the web-facing functionality of an application might be\\nthe only microservice in the application tha\", \"t needs to scale out to handle additional incoming traffic.\\n\\nThe classic model for application scala\", \"bility is to have a load-balanced, stateless tier with a shared\\nexternal datastore to store persiste\", \"nt data. Stateful microservices manage their own persistent data,\\nusually storing it locally on the \", \"servers on which they are placed, to avoid the overhead of network\\naccess and complexity of cross-se\", \"rvice operations. This enables the fastest possible processing of data\\nand can eliminate the need fo\", \"r caching systems. In addition, scalable stateful microservices usually\\npartition data among their i\", \"nstances, in order to manage data size and transfer throughput beyond\\nwhich a single server can supp\", \"ort.\\n\\nMicroservices also support independent updates. This loose coupling between microservices prov\", \"ides\\na rapid and reliable application evolution. Their independent, distributed nature supports roll\", \"ing\\nupdates, where only a subset of instances of a single microservice will update at any given time\", \".\\nTherefore, if a problem is detected, a buggy update can be rolled back, before all instances updat\", \"e\\nwith the faulty code or configuration. Similarly, microservices typically use schema versioning, s\", \"o that\\n\\n52 CHAPTER 8 | Containerized microservices\\nclients see a consistent version when updates are\", \" being applied, regardless of which microservice\\ninstance is being communicated with.\\n\\nTherefore, mi\", \"croservice applications have many benefits over monolithic applications:\\n\\nEach microservice is relat\", \"ively small, easy to manage and evolve.\\nEach microservice can be developed and deployed independentl\", \"y of other services.\\n\\nEach microservice can be scaled-out independently. For example, a catalog serv\", \"ice or\\nshopping basket service might need to be scaled-out more than an ordering service.\\nTherefore,\", \" the resulting infrastructure will more efficiently consume resources when scaling\\nout.\\n\\nEach micros\", \"ervice isolates any issues. For example, if there is an issue in a service it only\\nimpacts that serv\", \"ice. The other services can continue to handle requests.\\n\\nEach microservice can use the latest techn\", \"ologies. Because microservices are autonomous and\\nrun side-by-side, the latest technologies and fram\", \"eworks can be used, rather than being\\nforced to use an older framework that might be used by a monol\", \"ithic application.\\n\\nHowever, a microservice based solution also has potential drawbacks:\\n\\nChoosing h\", \"ow to partition an application into microservices can be challenging, as each\\nmicroservice has to be\", \" completely autonomous, end-to-end, including responsibility for its\\ndata sources.\\n\\nDevelopers must \", \"implement inter-service communication, which adds complexity and latency\\nto the application.\\n\\nAtomic\", \" transactions between multiple microservices usually aren't possible. Therefore,\\nbusiness requiremen\", \"ts must embrace eventual consistency between microservices.\\n\\nIn production, there is an operational \", \"complexity in deploying and managing a system\\ncompromised of many independent services.\\n\\nDirect clie\", \"nt-to-microservice communication can make it difficult to refactor the contracts of\\nmicroservices. F\", \"or example, over time how the system is partitioned into services might need\\nto change. A single ser\", \"vice might split into two or more services, and two services might\\nmerge. When clients communicate d\", \"irectly with microservices, this refactoring work can break\\ncompatibility with client apps.\\n\\nContain\", \"erization\\n\\nContainerization is an approach to software development in which an application and its v\", \"ersioned set\\nof dependencies, plus its environment configuration abstracted as deployment manifest f\", \"iles, are\\npackaged together as a container image, tested as a unit, and deployed to a host operating\", \" system.\\n\\nA container is an isolated, resource controlled, and portable operating environment, where\", \" an\\napplication can run without touching the resources of other containers, or the host. Therefore, \", \"a\\ncontainer looks and acts like a newly installed physical computer or a virtual machine.\\n\\nThere are\", \" many similarities between containers and virtual machines, as illustrated in Figure 8-3.\\n\\n53\\n\\nCHAPT\", \"ER 8 | Containerized microservices\\nVirtual Machines Containers\\n\\nApp 1\\n\\nrs or\\n\\nBins/Libs Bins/Libs\\n\\nB\", \"ins/Libs App 1 App 2 App 3\\n\\nBins/ Libs Bins/ Libs Bins,/\\\"Libs\\nGuest OS\\n\\nGuest OS Guest OS\\n\\nContainer\", \" Engine\\nHypervisor\\n\\nHost Operating System Operating System\\n\\nInfrastructure Infrastructure\\n\\nLig & Lig\", \" &\\n\\nFigure 8-3: Comparison of virtual machines and containers\\n\\nA container runs an operating system,\", \" has a file system, and can be accessed over a network as if it\\nwere a physical or virtual machine. \", \"However, the technology and concepts used by containers are very\\ndifferent from virtual machines. Vi\", \"rtual machines include the applications, the required dependencies,\\nand a full guest operating syste\", \"m. Containers include the application and its dependencies, but share\\nthe operating system with othe\", \"r containers, running as isolated processes on the host operating\\nsystem (aside from Hyper-V contain\", \"ers which run inside of a special virtual machine per container).\\nTherefore, containers share resour\", \"ces and typically require fewer resources than virtual machines.\\n\\nThe advantage of a container-orien\", \"ted development and deployment approach is that it eliminates\\nmost of the issues that arise from inc\", \"onsistent environment setups and the problems that come with\\nthem. In addition, containers permit fa\", \"st application scale-up functionality by instancing new\\ncontainers as required.\\n\\nThe key concepts wh\", \"en creating and working with containers are:\\n\\ne Container Host: The physical or virtual machine conf\", \"igured to host containers. The container\\nhost will run one or more containers.\\n\\ne Container Image: A\", \"n image consists of a union of layered filesystems stacked on top of each\\nother, and is the basis of\", \" a container. An image does not have state and it never changes as\\nit's deployed to different enviro\", \"nments.\\n\\ne Container: A container is a runtime instance of an image.\\n\\ne Container OS Image: Containe\", \"rs are deployed from images. The container operating system\\nimage is the first layer in potentially \", \"many image layers that make up a container. A container\\noperating system is immutable, and can't be \", \"modified.\\n\\ne Container Repository: Each time a container image is created, the image and its depende\", \"ncies\\nare stored in a local repository. These images can be reused many times on the container\\nhost.\", \" The container images can also be stored in a public or private registry, such as Docker\\nHub, so tha\", \"t they can be used across different container hosts.\\n\\n54 CHAPTER 8 | Containerized microservices\\nEnt\", \"erprises are increasingly adopting containers when implementing microservice based applications,\\nand\", \" Docker has become the standard container implementation that has been adopted by most\\nsoftware plat\", \"forms and cloud vendors.\\n\\nThe eShopOnContainers reference application uses Docker to host four conta\", \"inerized back-end\\nmicroservices, as illustrated in Figure 8-4.\\n\\n| Docker Host \\\"Identity Microservice\", \" (sts+users) '\\n\\n| | ena SQL Server :\\ndatabase _\\n\\nl __ Gentine _\\n|\\n( CatalogMicroservice == |\\n\\n[ | We\", \"b API\\nSQL Server | |\\n\\n\\u2014_ ]\\n\\n| | database |\\n| \\u2018.__ Container J |\\nee |\\n\\nl | Ordering Microservice 1\\nWe\", \"b API | |\\n[ Koy ia SQL Server : |\\n\\n| Container database }\\npo ]\\n(\\\"Basket Microservice SSS , |\\n| Web A\", \"PI | |\\n\\n| | \\u2014+ ip) Redis cache |\\n\\\\omtaines J |\\n\\nFigure 8-4: eShopOnContainers reference application \", \"back-end microservices\\n\\nThe architecture of the back-end services in the reference application is de\", \"composed into multiple\\nautonomous sub-systems in the form of collaborating microservices and contain\", \"ers. Each microservice\\nprovides a single area of functionality: an identity service, a catalog servi\", \"ce, an ordering service, and a\\nbasket service.\\n\\nEach microservice has its own database, allowing it \", \"to be fully decoupled from the other\\nmicroservices. Where necessary, consistency between databases f\", \"rom different microservices is\\nachieved using application-level events. For more information, see Co\", \"mmunication between\\nmicroservices.\\n\\nFor more information about the reference application, see .NET M\", \"icroservices: Architecture for\\nContainerized .NET Applications.\\n\\nCommunication between client and mi\", \"croservices\\n\\nThe eShopOnContainers mobile app communicates with the containerized back-end microserv\", \"ices\\nusing direct client-to-microservice communication, which is shown in Figure 8-5.\\n\\n55 CHAPTER 8 \", \"| Containerized microservices\\nBackend Microservices\\na Microservice 1\\n| Web AP\\n\\n|\\n\\n|\\n|\\n\\nCantainer\\n\\n| \", \"|\\n| |\\nWeb AP\\n\\n| |\\n| |\\nContainer!\\nMobile App ( Microservice 3 =)\\nWeb API\\n| i\\n| i\\n| Container i\\n\\nFigur\", \"e 8-5: Direct client-to-microservice communication\\n\\nWith direct client-to-microservice communication\", \", the mobile app makes requests to each\\nmicroservice directly through its public endpoint, with a di\", \"fferent TCP port per microservice. In\\nproduction, the endpoint would typically map to the microservi\", \"ce's load balancer, which distributes\\nrequests across the available instances.\\n\\nTip: Consider using \", \"API gateway communication\\n\\nDirect client-to-microservice communication can have drawbacks when build\", \"ing a large and\\ncomplex microservice based application, but it's more than adequate for a small appl\", \"ication. When\\ndesigning a large microservice based application with tens of microservices, consider \", \"using API\\ngateway communication. For more information, see .NET Microservices: Architecture for\\n\\nCon\", \"tainerized .NET Applications.\\n\\nCommunication between microservices\\n\\nA microservices based applicatio\", \"n is a distributed system, potentially running on multiple machines.\\nEach service instance is typica\", \"lly a process. Therefore, services must interact using an inter-process\\ncommunication protocol, such\", \" as HTTP, TCP, Advanced Message Queuing Protocol (AMQP), or binary\\nprotocols, depending on the natur\", \"e of each service.\\n\\nThe two common approaches for microservice-to-microservice communication are HTT\", \"P based REST\\ncommunication when querying for data, and lightweight asynchronous messaging when\\ncommu\", \"nicating updates across multiple microservices.\\n\\nAsynchronous messaging based event-driven communica\", \"tion is critical when propagating changes\\nacross multiple microservices. With this approach, a micro\", \"service publishes an event when something\\nnotable happens, for example, when it updates a business e\", \"ntity. Other microservices subscribe to\\nthese events. Then, when a microservice receives an event, i\", \"t updates its own business entities, which\\nmight in turn lead to more events being published. This p\", \"ublish-subscribe functionality is usually\\nachieved with an event bus.\\n\\nAn event bus allows publish-s\", \"ubscribe communication between microservices, without requiring the\\ncomponents to be explicitly awar\", \"e of each other, as shown in Figure 8-6.\\n\\n56 CHAPTER 8 | Containerized microservices\\nMicroservice B\\n\", \"\\nia\\nEvent\\nMicroservice A sy | Event Bus\\nEvent j |\\nEO >)\\nEvent\\n\\nMicraservice C\\n\\nFigure 8-6: Publish-s\", \"ubscribe with an event bus\\n\\nFrom an application perspective, the event bus is simply a publish-subsc\", \"ribe channel exposed via an\\ninterface. However, the way the event bus is implemented can vary. For e\", \"xample, an event bus\\nimplementation could use RabbitMQ, Azure Service Bus, or other service buses su\", \"ch as NServiceBus\\nand MassTransit. Figure 8-7 shows how an event bus is used in the eShopOnContainer\", \"s reference\\napplication.\\n\\n| Docker Host Identity Microservice (stssen)\\n\\n|\\ni Web API\\n| i [C) | \\u2014 SOL \", \"Server\\ndatabase aA.\\n+ Cantainer _ fb\\n\\n' Catalog Microservice\\nWeb 4P|\\n\\nia SOL Server\\n\\nvontamen databa\", \"se }\\n\\nQ Ordering Microservice \\\\\\n\\n|\\nMobile Web API\\nAPP | inl SOL Server\\n|\\n\\n1 Container database }\\n\\nsn\", \"g quang\\n\\n|) im _ Redis cache\\n\\nKey i\\n\\nTs pms ee ee SS SS SS ES SS\\n\\nFigure 8-7: Asynchronous event-dri\", \"ven communication in the reference application\\n\\nThe eShopOnContainers event bus, implemented using R\", \"abbitMQ, provides one-to-many\\nasynchronous publish-subscribe functionality. This means that after pu\", \"blishing an event, there can be\\nmultiple subscribers listening for the same event. Figure 8-9 illust\", \"rates this relationship.\\n\\n57 CHAPTER 8 | Containerized microservices\\ni Basket Micraservice\\n\\nrey \\u2014=, \", \"Database as\\n=\\nService Cache\\n\\u201c a\\n\\ni\\na\\n\\n* User-Profile Microservice my\\n\\nWiebe AP] Seryice\\n\\nUserUpdated\", \" event = Buyer into\\n\\nUpdateUser\\n\\n\\u2014 Event Bus\\n\\nche:\\n\\nUperUpdated event > Buyer info\\n\\neS ee ee ee =\\n\\ni\", \" Ordering Microservice\\n\\n_ |\\nLaas I\\n% yf col Database\\nfa, =I\\n\\n, Service\\n\\n\\u2014\\u2014\\u2014 \\u2014\\u2014\\u2014\\n\\n\\u2014 es me ee: oon\\u201d\\n\\nF\", \"igure 8-9: One-to-many communication\\n\\nThis one-to-many communication approach uses events to impleme\", \"nt business transactions that span\\nmultiple services, ensuring eventual consistency between the serv\", \"ices. An eventual-consistent\\ntransaction consists of a series of distributed steps. Therefore, when \", \"the user-profile microservice\\nreceives the UpdateUser commana, it updates the user's details in its \", \"database and publishes the\\nUserUpdated event to the event bus. Both the basket microservice and the \", \"ordering microservice\\nhave subscribed to receive this event, and in response update their buyer info\", \"rmation in their\\nrespective databases.\\n\\nNote: The eShopOnContainers event bus, implemented using Rab\", \"bitMQ, is intended to be used\\nonly as a proof of concept. For production systems, alternative event \", \"bus implementations should\\nbe considered.\\n\\nFor information about the event bus implementation, see .\", \"NET Microservices: Architecture for\\nContainerized .NET Applications.\\n\\nSummary\\n\\nMicroservices offer a\", \"n approach to application development and deployment that's suited to the\\nagility, scale, and reliab\", \"ility requirements of modern cloud applications. One of the main advantages\\nof microservices is that\", \" they can be scaled-out independently, which means that a specific functional\\narea can be scaled tha\", \"t requires more processing power or network bandwidth to support demand,\\nwithout unnecessarily scali\", \"ng areas of the application that are not experiencing increased demand.\\n\\nA container is an isolated,\", \" resource controlled, and portable operating environment, where an\\napplication can run without touch\", \"ing the resources of other containers, or the host. Enterprises are\\nincreasingly adopting containers\", \" when implementing microservice based applications, and Docker has\\nbecome the standard container imp\", \"lementation that has been adopted by most software platforms\\nand cloud vendors.\\n\\n58 CHAPTER 8 | Cont\", \"ainerized microservices\\nCHAPTER\\n\\nAuthentication\\nand authorization\\n\\nAuthentication is the process of \", \"obtaining identification credentials such as name and password from\\na user, and validating those cre\", \"dentials against an authority. If the credentials are valid, the entity that\\nsubmitted the credentia\", \"ls is considered an authenticated identity. Once an identity has been\\nauthenticated, an authorizatio\", \"n process determines whether that identity has access to a given\\nresource.\\n\\nThere are many approache\", \"s to integrating authentication and authorization into a Xamarin.Forms app\\nthat communicates with an\", \" ASP.NET MVC web application, including using ASP.NET Core Identity,\\nexternal authentication provide\", \"rs such as Microsoft, Google, Facebook, or Twitter, and authentication\\nmiddleware. The eShopOnContai\", \"ners mobile app performs authentication and authorization with a\\ncontainerized identity microservice\", \" that uses IdentityServer 4. The mobile app requests security tokens\\nfrom IdentityServer, either for\", \" authenticating a user or for accessing a resource. For IdentityServer to\\nissue tokens on behalf of \", \"a user, the user must sign-in to IdentityServer. However, IdentityServer\\ndoesn't provide a user inte\", \"rface or database for authentication. Therefore, in the eshopOn Containers\\nreference application, AS\", \"P.NET Core Identity is used for this purpose.\\n\\nAuthentication\\n\\nAuthentication is required when an ap\", \"plication needs to know the identity of the current user.\\nASP.NET Core's primary mechanism for ident\", \"ifying users is the ASP.NET Core Identity membership\\nsystem, which stores user information in a data\", \" store configured by the developer. Typically, this data\\nstore will be an EntityFramework store, tho\", \"ugh custom stores or third party packages can be used to\\nstore identity information in Azure storage\", \", DocumentDB, or other locations.\\n\\nFor authentication scenarios that make use of a local user data s\", \"tore, and that persist identity\\ninformation between requests via cookies (as is typical in ASP.NET M\", \"VC web applications), ASP.NET\\nCore Identity is a suitable solution. However, cookies are not always \", \"a natural means of persisting and\\ntransmitting data. For example, an ASP.NET Core web application th\", \"at exposes RESTful endpoints that\\nare accessed from a mobile app will typically need to use bearer t\", \"oken authentication, since cookies\\ncan't be used in this scenario. However, bearer tokens can easily\", \" be retrieved and included in the\\nauthorization header of web requests made from the mobile app.\\n\\n59\", \" CHAPTER 9 | Authentication and authorization\\nIssuing bearer tokens using IdentityServer 4\\n\\nIdentity\", \"Server 4 is an open source OpenID Connect and OAuth 2.0 framework for ASP.NET Core,\\nwhich can be use\", \"d for many authentication and authorization scenarios including issuing security\\ntokens for local AS\", \"P.NET Core Identity users.\\n\\nNote: OpenID Connect and OAuth 2.0 are very similar, while having differ\", \"ent responsibilities.\\n\\nOpenID Connect is an authentication layer on top of the OAuth 2.0 protocol. O\", \"Auth 2 is a protocol\\nthat allows applications to request access tokens from a security token service\", \" and use them to\\ncommunicate with APIs. This delegation reduces complexity in both client applicatio\", \"ns and APIs\\nsince authentication and authorization can be centralized.\\n\\nThe combination of OpenID Co\", \"nnect and OAuth 2.0 combine the two fundamental security\\nconcerns of authentication and API access, \", \"and IdentityServer 4 is an implementation of these\\nprotocols.\\n\\nIn applications that use direct clien\", \"t-to-microservice communication, such as the eSshopOnContainers\\nreference application, a dedicated a\", \"uthentication microservice acting as a Security Token Service (STS)\\ncan be used to authenticate user\", \"s, as shown in Figure 9-1. For more information about direct client-\\nto-microservice communication, \", \"see Communication between client and microservices.\\n\\neo\\n| Sign-in | Identity Microservice (sTs+Users\", \") \\u2019 Docker Host |\\nWeb API | \\u2014_\\nSecurity token SQL Server ! |\\ndatabase |\\n| SL Container J }\\n\\nMobile A\", \"pp\\n\\nFigure 9-1: Authentication by a dedicated authentication microservice\\n\\nThe eShopOnContainers mob\", \"ile app communicates with the identity microservice, which uses\\nIdentityServer 4 to perform authenti\", \"cation, and access control for APls. Therefore, the mobile app\\nrequests tokens from IdentityServer, \", \"either for authenticating a user or for accessing a resource:\\n\\ne Authenticating users with IdentityS\", \"erver is achieved by the mobile app requesting an identity\\ntoken, which represents the outcome of an\", \" authentication process. At a bare minimum, it\\ncontains an identifier for the user, and information \", \"about how and when the user\\nauthenticated. It can also contain additional identity data.\\n\\ne Accessin\", \"g a resource with IdentityServer is achieved by the mobile app requesting an access\\ntoken, which all\", \"ows access to an API resource. Clients request access tokens and forward\\nthem to the API. Access tok\", \"ens contain information about the client, and the user (if present).\\nAPIs then use that information \", \"to authorize access to their data.\\n\\nNote: A client must be registered with IdentityServer before it \", \"can request tokens.\\n\\nAdding IdentityServer to a web application\\n\\nIn order for an ASP.NET Core web ap\", \"plication to use IdentityServer 4, it must be added to the web\\napplication's Visual Studio solution.\", \" For more information, see Setup and Overview in the\\nIdentityServer documentation.\\n\\n60 CHAPTER 9 | A\", \"uthentication and authorization\\nOnce IdentityServer is included in the web application's Visual Stud\", \"io solution, it must be added to\\nthe web application's HTTP request processing pipeline, so that it \", \"can serve requests to OpenlD\\nConnect and OAuth 2.0 endpoints. This is achieved in the Configure meth\", \"od in the web application's\\nStartup class, as demonstrated in the following code example:\\n\\npublic vo\", \"id Configure(\\n\\nTApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)\\n{\\n\\nap\", \"p.UseIdentityQ ;\\n\\nOrder matters in the web application's HTTP request processing pipeline. Therefore\", \", IdentityServer\\nmust be added to the pipeline before the UI framework that implements the login scr\", \"een.\\n\\nConfiguring IdentityServer\\n\\nIdentityServer should be configured in the ConfigureServices metho\", \"d in the web application's\\nStartup class by calling the services.AddIdentityServer method, as demons\", \"trated in the\\nfollowing code example from the eShopOnContainers reference application:\\n\\npublic void \", \"ConfigureServices(IServiceCollection services)\\n\\n{\\n\\nservices.AddIdentityServer(x => x.IssuerUri = \\u201cnu\", \"ll\\\")\\n.AddSigningCredential (Certificate.GetQ)\\n. AddAspNetIdentity<App1icationUser>()\\n.AddConfigurati\", \"onStore(builder =>\\nbuilder.UseSqlServer(CconnectionString, options =>\\noptions.MigrationsAssembly(mig\", \"rationsAssembly)))\\n.AddOperationalStore(builder =>\\nbuilder.UseSqlServer(CconnectionString, options =\", \">\\noptions.MigrationsAssembly(migrationsAssembly)))\\n.Services.AddTransient<IProfileService, ProfileSe\", \"rvice>();\\n\\nAfter calling the services .AddIdentityServer method, additional fluent APls are called t\", \"o\\nconfigure the following:\\n\\ne Credentials used for signing.\\ne API and identity resources that users \", \"might request access to.\\ne \\u00a7=Clients that will be connecting to request tokens.\\n\\ne ASP.NET Core Iden\", \"tity.\\n\\nTip: Dynamically load the IdentityServer 4 configuration\\n\\nIdentityServer 4's APls allow for c\", \"onfiguring IdentityServer from an in-memory list of configuration\\nobjects. In the eshopOnContainers \", \"reference application, these in-memory collections are hard-\\ncoded into the application. However, in\", \" production scenarios they can be loaded dynamically from\\na configuration file or from a database.\\n\\n\", \"For information about configuring IdentityServer to use ASP.NET Core Identity, see Using ASP.NET\\nCor\", \"e Identity in the IdentityServer documentation.\\n\\n61 CHAPTER 9 | Authentication and authorization\\nCon\", \"figuring API resources\\n\\nWhen configuring API resources, the AddInMemoryApiResources method expects a\", \"n\\nTEnumerable<ApiResource> collection. The following code example shows the GetApis method that\\nprov\", \"ides this collection in the eshopOnContainers reference application:\\n\\npublic static IEnumerable<ApiR\", \"esource> GetApis()\\n\\n{\\nreturn new List<ApiResource>\\n{\\nnew ApiResourceC\\\"orders\\\", \\u201cOrders Service\\\"),\\nne\", \"w ApiResource(\\\"basket\\\", \\\"Basket Service\\\")\\nIg\\n}\\n\\nThis method specifies that IdentityServer should pro\", \"tect the orders and basket APIs. Therefore,\\nIdentityServer managed access tokens will be required wh\", \"en making calls to these APIs. For more\\ninformation about the ApiResource type, see API Resource in \", \"the IdentityServer 4 documentation.\\n\\nConfiguring identity resources\\n\\nWhen configuring identity resou\", \"rces, the AddInMemoryIdentityResources method expects an\\nTEnumerable<IdentityResource> collection. I\", \"dentity resources are data such as user ID, name, or\\nemail address. Each identity resource has a uni\", \"que name, and arbitrary claim types can be assigned to\\nit, which will then be included in the identi\", \"ty token for the user. The following code example shows\\nthe GetResources method that provides this c\", \"ollection in the eshopOnContainers reference\\napplication:\\n\\npublic static IEnumerable<IdentityResourc\", \"e> GetResources ()\\n\\n{\\nreturn new List<IdentityResource>\\n{\\nnew IdentityResources.OpenIdQ),\\nnew Identi\", \"tyResources. Profi leQ\\n3\\n}\\n\\nThe OpenID Connect specification specifies some standard identity resour\", \"ces. The minimum\\nrequirement is that support is provided for emitting a unique ID for users. This is\", \" achieved by\\nexposing the IdentityResources.OpentId identity resource.\\n\\nNote: The IdentityResources \", \"class supports all of the scopes defined in the OpenID Connect\\nspecification (openid, email, profile\", \", telephone, and address).\\n\\nIdentityServer also supports defining custom identity resources. For mor\", \"e information, see Defining\\ncustom identity resources in the IdentityServer documentation. For more \", \"information about the\\nIdentityResource type, see Identity Resource in the IdentityServer 4 documenta\", \"tion.\\n\\nConfiguring clients\\n\\nClients are applications that can request tokens from IdentityServer. Ty\", \"pically, the following settings\\nmust be defined for each client as a minimum:\\n\\ne Aunique client ID.\\n\", \"e The allowed interactions with the token service (known as the grant type).\\n\\ne The location where i\", \"dentity and access tokens are sent to (known as a redirect URI).\\n\\n62 CHAPTER 9 | Authentication and \", \"authorization\\ne A list of resources that the client is allowed access to (known as scopes).\\n\\nWhen co\", \"nfiguring clients, the AddInMemoryClients method expects an IEnumerable<Client>\\ncollection. The foll\", \"owing code example shows the configuration for the eshopOnContainers mobile\\napp in the GetClients me\", \"thod that provides this collection in the eshopOnContainers reference\\napplication:\\n\\npublic static IE\", \"numerable<Client> GetClients(Dictionary<string,string> clientsUrl)\\n\\n{\\n\\nreturn new List<Client>\\n\\n{\\nne\", \"w Client\\n{\\nClientId = \\\"xamarin\\\",\\nClientName = \\\"eShop Xamarin OpenId Client\\\",\\nAllowedGrantTypes = Gra\", \"ntTypes.Hybrid,\\nClientSecrets =\\n\\n{\\nnew SecretC'\\\"secret\\\".Sha256Q)\\n\\nt5\\n\\nRedirectUris = { clientsUrl[\\\"X\", \"amarin\\\"] },\\n\\nRequireConsent = false,\\n\\nRequirePkce = true,\\n\\nPostLogoutRedirectUris = { $\\\"{clientsUrl[\", \"\\\"Xamarin\\\"]}/Account/Redirecting\\\"\\u2122 },\\n\\nAllowedCorsOrigins = { \\u201chttp://eshopxamarin\\\" },\\n\\nAllowedScopes\", \" = new List<string>\\n\\n{\\nIdentityServerConstants.StandardScopes.OpenId,\\nIdentityServerConstants.Standa\", \"rdScopes. Profile,\\nIdentityServerConstants.StandardScopes.OfflineAccess,\\n\\\"orders\\\",\\n\\\"basket\\\"\\n\\nt5\\n\\nAll\", \"ow0OfflineAccess = true,\\nAl lowAccessTokensViaBrowser = true\\n\\nThis configuration specifies data for \", \"the following properties:\\ne ClientId: A unique ID for the client.\\ne ClientName: The client display n\", \"ame, which is used for logging and the consent screen.\\n\\ne AllowedGrantTypes: Specifies how a client \", \"wants to interact with IdentityServer. For more\\ninformation see Configuring the authentication flow.\", \"\\n\\ne ClientSecrets: Specifies the client secret credentials that are used when requesting tokens\\nfrom\", \" the token endpoint.\\n\\ne RedirectUris: Specifies the allowed URIs to which to return tokens or author\", \"ization codes.\\ne RequireConsent: Specifies whether a consent screen is required.\\ne RequirePkce: Spec\", \"ifies whether clients using an authorization code must send a proof key.\\n\\ne PostLogoutRedirectUris: \", \"Specifies the allowed URIs to redirect to after logout.\\n\\n63 CHAPTER 9 | Authentication and authoriza\", \"tion\\ne AllowedCorsOrigins: Specifies the origin of the client so that IdentityServer can allow cross\", \"-\\norigin calls from the origin.\\n\\ne AllowedScopes: Specifies the resources the client has access to. \", \"By default, a client has no\\naccess to any resources.\\n\\ne AllowOfflineAccess: Specifies whether the cl\", \"ient can request refresh tokens.\\n\\nConfiguring the authentication flow\\n\\nThe authentication flow betwe\", \"en a client and IdentityServer can be configured by specifying the grant\\ntypes in the Client.Al lowe\", \"dGrantTypes property. The OpenID Connect and OAuth 2.0 specifications\\ndefine a number of authenticat\", \"ion flows, including:\\n\\ne Implicit. This flow is optimized for browser-based applications and should \", \"be used either for\\nuser authentication-only, or authentication and access token requests. All tokens\", \" are\\ntransmitted via the browser, and therefore advanced features like refresh tokens are not\\npermit\", \"ted.\\n\\ne Authorization code. This flow provides the ability to retrieve tokens on a back channel, as\\n\", \"opposed to the browser front channel, while also supporting client authentication.\\n\\ne Hybrid. This f\", \"low is a combination of the implicit and authorization code grant types. The\\nidentity token is trans\", \"mitted via the browser channel and contains the signed protocol\\nresponse along with other artifacts \", \"such as the authorization code. After successful validation\\nof the response, the back channel should\", \" be used to retrieve the access and refresh token.\\n\\nTip: Use the hybrid authentication flow\\n\\nThe hyb\", \"rid authentication flow mitigates a number of attacks that apply to the browser channel,\\nand is the \", \"recommended flow for native applications that want to retrieve access tokens (and\\npossibly refresh t\", \"okens).\\n\\nFor more information about authentication flows, see Grant Types in the IdentityServer 4\\ndo\", \"cumentation.\\n\\nPerforming authentication\\n\\nFor IdentityServer to issue tokens on behalf of a user, the\", \" user must sign-in to IdentityServer.\\nHowever, IdentityServer doesn't provide a user interface or da\", \"tabase for authentication. Therefore, in\\nthe eShopOnContainers reference application, ASP.NET Core I\", \"dentity is used for this purpose.\\n\\nThe eShopOnContainers mobile app authenticates with IdentityServe\", \"r with the hybrid authentication\\nflow, which is illustrated in Figure 9-2.\\nhittp://<base endpoint=;5\", \"105/connect/authorize\\n\\nauthentication response .\\n{authorization cade and identity token) | Identity \", \"Microservice (STS+Users)\\n\\n|\\n|\\nrex sal sever | wa\\u201d |\\n\\u2014\\u2014 |\\n|\\n\\ndatabase\\n\\n; https /<base endpoint=:5105/\", \"conmecttoken\\n\\nMobile App\\n\\nFigure 9-2: High-level overview of the sign-in process\\n\\n64 CHAPTER 9 | Aut\", \"hentication and authorization\\nA sign-in request is made to <base endpoint>:5105/connect/authori ze. \", \"Following successful\\nauthentication, IdentityServer returns an authentication response containing an\", \" authorization code\\nand an identity token. The authorization code is then sent to <base\\nendpoint>:51\", \"05/connect/token, which responds with access, identity, and refresh tokens.\\n\\nThe eShopOnContainers m\", \"obile app signs-out of IdentityServer by sending a request to\\nhttp://<base endpoint>:5105/connect/en\", \"dsession, with additional parameters. After sign-out\\noccurs, IdentityServer responds by sending a po\", \"st logout redirect URI back to the mobile app. Figure\\n9-3 illustrates this process.\\n\\neco cso ctr ~, \", \"Docker Host\\n\\nl\\nIdentity Microservice (sT5+Users)\\nl\\n\\nWie AP\\nwi SSS ee\\n\\nhttp://<base endpoint=:5105/ca\", \"nnect/endsession\\n\\na a a\\n\\nl\\nl\\n|: im SQL Server\\n| \\u2014\\u2014 *\\npost logout redirect URI Kel database\\n\\nContaine\", \"r\\n\\nMobile App\\n\\nFigure 9-3: High-level overview of the sign-out process\\n\\nIn the eShopOnContainers mob\", \"ile app, communication with IdentityServer is performed by the\\nIdentityService class, which implemen\", \"ts the IIdentityService interface. This interface specifies\\nthat the implementing class must provide\", \" CreateAuthorizationRequest, CreateLogoutRequest,\\nand GetTokenAsync methods.\\n\\nSigning-in\\n\\nWhen the u\", \"ser taps the LOGIN button on the LoginView, the SignInCommand in the LoginVi ewMode 1\\nclass is execu\", \"ted, which in turn executes the SignInAsync method. The following code example\\nshows this method:\\n\\np\", \"rivate async Task SignInAsync()\\n{\\n\\nLoginUrl = _identityService.CreateAuthori zationRequest() ;\\nIsLog\", \"in = true;\\n\\nThis method invokes the CreateAuthorizationRequest method in the IdentityService class,\\n\", \"which is shown in the following code example:\\n\\npublic string CreateAuthorizationRequest()\\n{\\n// Creat\", \"e URI to authorization endpoint\\nvar authorizeRequest = new AuthorizeRequest(GlobalSetting. Instance.\", \" IdentityEndpoint) ;\\n\\n// Dictionary with values for the authorize request\\n\\nvar dic = new Dictionary<\", \"string, string>();\\n\\ndic.AddC'client_id\\\", GlobalSetting.Instance.ClientId) ;\\n\\ndic.AddC'client_secret\\\"\", \", GlobalSetting.Instance.ClientSecret) ;\\ndic.AddC\\\"response_type\\\", \\\"code id_token\\\") ;\\n\\ndic.Add(\\\"scope\", \"\\\", \\\"\\u201copenid profile basket orders locations marketing offline_access\\\");\\ndic.AddC'redirect_uri\\\", Glob\", \"alSetting. Instance. IdentityCallback) ;\\n\\ndic.AddC'nonce\\\", Guid.NewGuid().ToStringC'N'\\\"));\\n\\ndic.AddC\", \"''code_chal lenge\\\", CreateCodeChallenge());\\n\\ndic.AddC\\\"code_challenge_method\\\", \\\"S256\\\");\\n\\n65 CHAPTER 9\", \" | Authentication and authorization\\n// Add CSRF token to protect against cross-site request forgery \", \"attacks.\\nvar currentCSRFToken = Guid.NewGuid(Q) .ToString(C'N\\\");\\ndic.AddC''state\\\", currentCSRFToken)\", \" ;\\n\\nvar authorizeUri = authorizeRequest.Create(dic) ;\\nreturn authorizeuri;\\n\\nThis method creates the \", \"URI for IdentityServer's authorization endpoint, with the required parameters.\\nThe authorization end\", \"point is at /connect/authorize on port 5105 of the base endpoint exposed as\\na user setting. For more\", \" information about user settings, see Configuration management.\\n\\nNote: The attack surface of the esh\", \"opOnContainers mobile app is reduced by implementing the\\nProof Key for Code Exchange (PKCE) extensio\", \"n to OAuth. PKCE protects the authorization code\\nfrom being used if it's intercepted. This is achiev\", \"ed by the client generating a secret verifier, a hash\\nof which is passed in the authorization reques\", \"t, and which is presented unhashed when redeeming\\nthe authorization code. For more information about\", \" PKCE, see Proof Key for Code Exchange by\\nOAuth Public Clients on the Internet Engineering Task Forc\", \"e web site.\\n\\nThe returned URI is stored in the LoginUr1 property of the LoginViewModel class. When t\", \"he IsLogin\\nproperty becomes true, the WebView in the LoginView becomes visible. The WebV7 ew data bi\", \"nds its\\nSource property to the LoginUrl property of the LoginViewModel class, and so makes a sign-in\", \"\\nrequest to IdentityServer when the LoginUr1 property is set to IdentityServer's authorization\\nendpo\", \"int. When IdentityServer receives this request and the user isn't authenticated, the WebVi ew will\\nb\", \"e redirected to the configured login page, which is shown in Figure 9-4.\\n\\nARE YOU REGISTERED?\\n\\nEMAIL\", \"\\nPASSWORD\\n\\n[|] Remember me?\\n\\nRegister as a new user?\\nNote that for demo purposes you don't need to r\", \"egister and can login with these credentials:\\nUser: demouser@microsoft.com\\n\\nPassword: Pass@wordl\\n\\nFi\", \"gure 9-4: Login page displayed by the WebView\\n\\nOnce login is completed, the WebVi ew will be redirec\", \"ted to a return URI. This WebVi ew navigation will\\ncause the NavigateAsync method in the LoginViewMo\", \"del class to be executed, which is shown in\\nthe following code example:\\n\\n66 CHAPTER 9 | Authenticati\", \"on and authorization\\nprivate async Task NavigateAsync(string url)\\n\\n{\\n\\nvar authResponse = new Authori\", \"zeResponse(url);\\nif C!string.IsNullOrwhiteSpace(CauthResponse. Code) )\\n{\\n\\nvar userToken = await _ide\", \"ntityService.GetTokenAsync(authResponse. Code) ;\\nstring accessToken = userToken.AccessToken;\\n\\nif C!s\", \"tring.IsNullOrwWhiteSpace(accessToken) )\\n{\\n\\nSettings.AuthAccessToken = accessToken;\\nSettings.AuthIdT\", \"oken = authResponse.IdentityToken;\\n\\nawait NavigationService.NavigateloAsync<MainViewModel>(Q);\\nawait\", \" NavigationService.RemoveLastFromBackStackAsyncQ() ;\\n\\nThis method parses the authentication response\", \" that's contained in the return URI, and provided that\\na valid authorization code Is present, it mak\", \"es a request to IdentityServer's token endpoint, passing\\nthe authorization code, the PKCE secret ver\", \"ifier, and other required parameters. The token endpoint is\\nat /connect/token on port 5105 of the ba\", \"se endpoint exposed as a user setting. For more\\ninformation about user settings, see Configuration m\", \"anagement.\\n\\nTip: Validate return URIs\\n\\nAlthough the eShopOnContainers mobile app doesn't validate th\", \"e return URI, the best practice is to\\nvalidate that the return URI refers to a known location in ord\", \"er to prevent open-redirect attacks.\\n\\nIf the token endpoint receives a valid authorization code and \", \"PKCE secret verifier, it resoonds with an\\naccess token, identity token, and refresh token. The acces\", \"s token (which allows access to API\\nresources) and identity token are then stored as application set\", \"tings, and page navigation is\\nperformed. Therefore, the overall effect in the eshopOnContainers mobi\", \"le app is this: provided that\\nusers are able to successfully authenticate with IdentityServer, they \", \"are navigated to the MainVi ew\\npage, which is a TabbedPage that displays the CatalogView as its sele\", \"cted tab.\\n\\nFor information about page navigation, see Navigation. For information about how WebVi ew\", \"\\nnavigation causes a view model method to be executed, see Invoking navigation using behaviors. For\\n\", \"information about application settings, see Configuration management.\\n\\nNote: The eShopOnContainers a\", \"lso allows a mock sign-in when the app is configured to use mock\\nservices in the SettingsVi ew. In t\", \"his mode, the app doesn't communicate with IdentityServer,\\ninstead allowing the user to sign-in usin\", \"g any credentials.\\n\\nSigning-out\\n\\nWhen the user taps the LOG OUT button in the ProfileView, the Logou\", \"tCommand in the\\n\\nProfi leViewModel class is executed, which in turn executes the LogoutAsync method.\", \" This method\\nperforms page navigation to the LoginView page, passing a LogoutParameter instance set \", \"to true\\nas a parameter. For more information about passing parameters during page navigation, see Pa\", \"ssing\\n\\nparameters during navigation.\\n\\n67 CHAPTER 9 | Authentication and authorization\\nWhen a view Is\", \" created and navigated to, the InitializeAsync method of the view's associated\\nview model is execute\", \"d, which then executes the Logout method of the LoginViewModel class, which\\nis shown in the followin\", \"g code example:\\n\\nprivate void Logout ()\\n\\n{\\nvar authIdToken = Settings.AuthIdToken;\\nvar logoutRequest\", \" = _identityService.CreateLogoutRequest CauthIdToken) ;\\nif C!string.IsNul1lOrEmpty (logoutRequest) )\", \"\\n{\\n// Logout\\nLoginUrl = logoutRequest;\\n$\\n$\\n\\nThis method invokes the CreateLogoutRequest method in th\", \"e IdentityService class, passing the\\nidentity token retrieved from application settings as a paramet\", \"er. For more information about\\n\\napplication settings, see Configuration management. The following co\", \"de example shows the\\nCreateLogoutRequest method:\\n\\npublic string CreateLogoutRequest(string token)\\n\\n{\", \"\\nreturn string.Format(\\\"{0}?id_token_hint={1}&post_logout_redirect_uri={2}\\\",\\nGlobalSetting.Instance.L\", \"ogoutEndpoint,\\ntoken,\\nGlobalSetting.Instance.LogoutCal]back) ;\\n}\\n\\nThis method creates the URI to Ide\", \"ntityServer's end session endpoint, with the required parameters.\\nThe end session endpoint is at /co\", \"nnect/endsession on port 5105 of the base endpoint exposed as\\na user setting. For more information a\", \"bout user settings, see Configuration management.\\n\\nThe returned URI is stored in the LoginUr1 proper\", \"ty of the LoginViewModel class. While the IsLogin\\nproperty is true, the WebView in the LoginView Is \", \"visible. The WebVi ew data binds its Source property\\nto the LoginUr1 property of the LoginViewModel \", \"class, and so makes a sign-out request to\\nIdentityServer when the LoginUr1 property is set to Identi\", \"tyServer's end session endpoint. When\\nIdentityServer receives this request, provided that the user i\", \"s signed-in, sign-out occurs.\\nAuthentication is tracked with a cookie managed by the cookie authenti\", \"cation middleware from\\nASP.NET Core. Therefore, signing out of IdentityServer removes the authentica\", \"tion cookie and sends a\\npost logout redirect URI back to the client.\\n\\nIn the mobile app, the WebVi e\", \"w will be redirected to the post logout redirect URI. This WebVi ew\\nnavigation will cause the Naviga\", \"teAsync method in the LoginViewModel class to be executed, which\\nis shown in the following code exam\", \"ple:\\n\\nprivate async Task NavigateAsync(string url)\\n\\n{\\nSettings.AuthAccessToken = string.Empty;\\nSetti\", \"ngs.AuthIdToken = string.Empty;\\nIsLogin = false;\\nLoginUrl = _identityService.CreateAuthori zationReq\", \"uest() ;\\n}\\n\\n68 CHAPTER 9 | Authentication and authorization\\nThis method clears both the identity tok\", \"en and the access token from application settings, and sets\\nthe IsLogin property to false, which cau\", \"ses the WebVi ew on the LoginView page to become\\ninvisible. Finally, the LoginUrl property is set to\", \" the URI of IdentityServer's authorization endpoint,\\nwith the required parameters, in preparation fo\", \"r the next time the user initiates a sign-in.\\n\\nFor information about page navigation, see Navigation\", \". For information about how WebVi ew\\nnavigation causes a view model method to be executed, see Invok\", \"ing navigation using behaviors. For\\ninformation about application settings, see Configuration manage\", \"ment.\\n\\nNote: The eShopOnContainers also allows a mock sign-out when the app is configured to use\\nmoc\", \"k services in the SettingsVi ew. In this mode, the app doesn't communicate with\\nIdentityServer, and \", \"instead clears any stored tokens from application settings.\\n\\nAuthorization\\n\\nAfter authentication, AS\", \"P.NET Core web APIs often need to authorize access, which allows a service to\\nmake APIs available to\", \" some authenticated users, but not to all.\\n\\nRestricting access to an ASP.NET Core MVC route can be a\", \"chieved by applying an Authorize attribute\\nto a controller or action, which limits access to the con\", \"troller or action to authenticated users, as\\nshown in the following code example:\\n\\n[Authorize]\\n\\npubl\", \"ic class BasketController : Controller\\n{\\n\\n}\\n\\nIf an unauthorized user attempts to access a controller\", \" or action that's marked with the Authorize\\nattribute, the MVC framework returns a 401 (unauthorized\", \") HTTP status code.\\n\\nNote: Parameters can be specified on the Authorize attribute to restrict an API\", \" to specific users.\\nFor more information, see Authorization on the Microsoft Documentation Center.\\n\\n\", \"69 CHAPTER 9 | Authentication and authorization\\nIdentityServer can be integrated into the authorizat\", \"ion workflow so that the access tokens it provides\\ncontrol authorization. This approach is shown in \", \"Figure 9-5.\\n\\n\\u201cTa et, Baleececdon ioe Docker Host\\nSign-in | Identity Microservice (sTs+Users) 1 - |\\nW\", \"eb AP| | we\\nSecurity token SQL Server | 1\\n| database |\\n\\u2018Container J l\\nMobile App ee |\\n| | Ordering M\", \"icroservice 1\\n| Request with token | Web AP | |\\n_ SQL Server |\\n|\\n\\\\___ Container Gatabase :\\n( Basket \", \"Microservice 1 |\\nRequest with token | Web API | I\\n| | Key ma (7 Redis cache |\\nI \\\\_ Container J ]\\n\\n_ \", \"roe ele\\n\\nFigure 9-5: Authorization by access token\\n\\nThe eShopOnContainers mobile app communicates wi\", \"th the identity microservice and requests an\\naccess token as part of the authentication process. The\", \" access token Is then forwarded to the APIs\\nexposed by the ordering and basket microservices as part\", \" of the access requests. Access tokens\\ncontain information about the client, and the user. APIs then\", \" use that information to authorize access\\nto their data. For information about how to configure Iden\", \"tityServer to protect APIs, see Configuring\\nAPI resources.\\n\\nConfiguring IdentityServer to perform au\", \"thorization\\n\\nTo perform authorization with IdentityServer, its authorization middleware must be adde\", \"d to the web\\napplication's HTTP request pipeline. The middleware is added in the ConfigureAuth metho\", \"d in the\\nweb application's Startup class, which is invoked from the Configure method, and is demonst\", \"rated\\nin the following code example from the eShopOnContainers reference application:\\n\\nprotected vir\", \"tual void ConfigureAuth(IApplicationBuilder app)\\n\\n{\\nvar identityUrl = Configuration.GetValue<string>\", \"C'IdentityUr!\\\");\\napp.UseIdentityServerAuthentication(new IdentityServerAuthenticationOptions\\n{\\nAutho\", \"rity = identityUrl.ToStringQ,\\nScopeName = \\\"basket\\\",\\nRequireHttpsMetadata = false\\nb)3\\n}\\n\\nThis method \", \"ensures that the API can only be accessed with a valid access token. The middleware\\nvalidates the in\", \"coming token to ensure that it's sent from a trusted issuer, and validates that the token\\nis valid t\", \"o be used with the API that receives it. Therefore, browsing to the ordering or basket\\ncontroller wi\", \"ll return a 401 (unauthorized) HTTP status code, indicating that an access token is\\nrequired.\\n\\n70 CH\", \"APTER 9 | Authentication and authorization\\nNote: IdentityServer's authorization middleware must be a\", \"dded to the web application's HTTP\\nrequest pipeline before adding MVC with app.UseMvc() or app. UseM\", \"vcwithDefau1tRoute().\\n\\nMaking access requests to APIs\\n\\nWhen making requests to the ordering and bask\", \"et microservices, the access token, obtained from\\nIdentityServer during the authentication process, \", \"must be included in the request, as shown in the\\nfollowing code example:\\n\\nvar authToken = Settings.A\", \"uthAccessToken;\\nOrder = await _ordersService.GetOrderAsyncC(Convert.ToInt32(order.OrderNumber) , aut\", \"hToken) ;\\n\\nThe access token is stored as an application setting, and is retrieved from platform-spec\", \"ific storage\\nand included in the call to the GetOrderAsync method in the OrderService class.\\n\\nSimila\", \"rly, the access token must be included when sending data to an IdentityServer protected API, as\\nshow\", \"n in the following code example:\\n\\nvar authToken = Settings.AuthAccessToken;\\nawait _basketService.Upd\", \"ateBasketAsync(new CustomerBasket\\n\\n{\\nBuyerlId = userInfo.Userld,\\nItems = BasketItems.ToListQ\\n}, auth\", \"Token);\\n\\nThe access token is retrieved from platform-specific storage and included in the call to th\", \"e\\nUpdateBasketAsync method in the BasketService class.\\n\\nThe RequestProvider class, in the eSshopOnCo\", \"ntainers mobile app, uses the HttpClient class to\\nmake requests to the RESTful APIs exposed by the e\", \"ShopOnContainers reference application. When\\nmaking requests to the ordering and basket APls, which \", \"require authorization, a valid access token\\nmust be included with the request. This is achieved by a\", \"dding the access token to the headers of the\\nHttpClient instance, as demonstrated in the following c\", \"ode example:\\n\\nhttpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValueC\\\"Bearer\", \"\\\", token);\\n\\nThe DefaultRequestHeaders property of the HttpClient class exposes the headers that are \", \"sent\\nwith each request, and the access token is added to the Authorization header prefixed with the\\n\", \"string Bearer. When the request is sent to a RESTful API, the value of the Authorization header is\\ne\", \"xtracted and validated to ensure that It's sent from a trusted issuer, and used to determine whether\", \"\\nthe user has permission to invoke the API that receives it.\\n\\nFor more information about how the eSh\", \"opOnContainers mobile app makes web requests, see\\nAccessing remote data.\\n\\nSummary\\n\\nThere are many ap\", \"proaches to integrating authentication and authorization into a Xamarin.Forms app\\nthat communicates \", \"with an ASP.NET MVC web application. The eShopOnContainers mobile app\\nperforms authentication and au\", \"thorization with a containerized identity microservice that uses\\nIdentityServer 4. IdentityServer is\", \" an open source OpenID Connect and OAuth 2.0 framework for\\nASP.NET Core that integrates with ASP.NET\", \" Core Identity to perform bearer token authentication.\\n\\n71 CHAPTER 9 | Authentication and authorizat\", \"ion\\nThe mobile app requests security tokens from IdentityServer, either for authenticating a user or\", \" for\\naccessing a resource. When accessing a resource, an access token must be included in the reques\", \"t to\\nAPIs that require authorization. IdentityServer's middleware validates incoming access tokens t\", \"o\\n\\nensure that they are sent from a trusted issuer, and that they are valid to be used with the API \", \"that\\nreceives them.\\n\\n72 CHAPTER 9 | Authentication and authorization\\nCHAPTER | ()\\n\\nAccessing remote\\n\", \"data\\n\\nMany modern web-based solutions make use of web services, hosted by web servers, to provide\\nfu\", \"nctionality for remote client applications. The operations that a web service exposes constitute a\\nw\", \"eb API.\\n\\nClient apps should be able to utilize the web API without knowing how the data or operation\", \"s that the\\nAPI exposes are implemented. This requires that the API abides by common standards that e\", \"nable a\\nclient app and web service to agree on which data formats to use, and the structure of the d\", \"ata that is\\nexchanged between client apps and the web service.\\n\\nIntroduction to Representational Sta\", \"te Transfer\\n\\nRepresentational State Transfer (REST) is an architectural style for building distribut\", \"ed systems based\\non hypermedia. A primary advantage of the REST model is that it's based on open sta\", \"ndards and\\ndoesn't bind the implementation of the model or the client apps that access it to any spe\", \"cific\\nimplementation. Therefore, a REST web service could be implemented using Microsoft ASP.NET Cor\", \"e\\nMVC, and client apps could be developing using any language and toolset that can generate HTTP\\nreq\", \"uests and parse HTTP responses.\\n\\nThe REST model uses a navigational scheme to represent objects and \", \"services over a network, referred\\nto as resources. Systems that implement REST typically use the HTT\", \"P protocol to transmit requests to\\naccess these resources. In such systems, a client app submits a r\", \"equest in the form of a URI that\\nidentifies a resource, and an HTTP method (such as GET, POST, PUT, \", \"or DELETE) that indicates the\\noperation to be performed on that resource. The body of the HTTP reque\", \"st contains any data required\\nto perform the operation.\\n\\nNote: REST defines a stateless request mode\", \"l. Therefore, HTTP requests must be independent and\\nmight occur in any order.\\n\\nThe response from a R\", \"EST request makes use of standard HTTP status codes. For example, a request\\nthat returns valid data \", \"should include the HTTP response code 200 (OK), while a request that fails to\\nfind or delete a speci\", \"fied resource should return a response that includes the HTTP status code 404\\n\\n(Not Found).\\n\\nA RESTf\", \"ul web API exposes a set of connected resources, and provides the core operations that\\nenable an app\", \" to manipulate those resources and easily navigate between them. For this reason, the\\nURIs that cons\", \"titute a typical RESTful web API are oriented towards the data that It exposes, and use\\nthe faciliti\", \"es provided by HTTP to operate on this data.\\n\\n73 CHAPTER 10 | Accessing remote data\\nThe data include\", \"d by a client app in an HTTP request, and the corresponding response messages from\\nthe web server, c\", \"ould be presented in a variety of formats, known as media types. When a client app\\nsends a request t\", \"hat returns data in the body of a message, it can specify the media types it can\\nhandle in the Accep\", \"t header of the request. If the web server supports this media type, it can reply\\nwith a response th\", \"at includes the Content-Type header that specifies the format of the data in the\\nbody of the message\", \". It's then the responsibility of the client app to parse the response message and\\ninterpret the res\", \"ults in the message body appropriately.\\n\\nFor more information about REST, see API design and API imp\", \"lementation on Microsoft Docs.\\n\\nConsuming RESTtul APIs\\n\\nThe eShopOnContainers mobile app uses the Mo\", \"del-View-ViewModel (MVVM) pattern, and the\\nmodel elements of the pattern represent the domain entiti\", \"es used in the app. The controller and\\nrepository classes in the eSshopOnContainers reference applic\", \"ation accept and return many of these\\nmodel objects. Therefore, they are used as data transfer objec\", \"ts (DTOs) that hold all the data that is\\npassed between the mobile app and the containerized microse\", \"rvices. The main benefit of using DTOs\\nto pass data to and receive data from a web service Is that b\", \"y transmitting more data in a single\\nremote call, the app can reduce the number of remote calls that\", \" need to be made.\\n\\nMaking web requests\\n\\nThe eShopOnContainers mobile app uses the HttpClient class t\", \"o make requests over HTTP, with\\nJSON being used as the media type. This class provides functionality\", \" for asynchronously sending HTTP\\nrequests and receiving HTTP responses from a URI identified resourc\", \"e. The HttpResponseMessage\\nclass represents an HTTP response message received from a REST API after \", \"an HTTP request has been\\nmade. It contains information about the response, including the status code\", \", headers, and any body.\\nThe HttpContent class represents the HTTP body and content headers, such as\", \" Content-Type and\\nContent-Encoding. The content can be read using any of the ReadAs methods, such as\", \"\\nReadAsStringAsync and ReadAsByteArrayAsync, depending on the format of the data.\\n\\nMaking a GET requ\", \"est\\n\\nThe CatalogService class is used to manage the data retrieval process from the catalog\\nmicroser\", \"vice. In the RegisterDependencies method in the ViewModelLocator class, the\\nCatalogService class is \", \"registered as a type mapping against the ICatalogService type with the\\nAutofac dependency injection \", \"container. Then, when an instance of the CatalogViewModell class is\\ncreated, its constructor accepts\", \" an ICatalogService type, which Autofac resolves, returning an\\ninstance of the CatalogService class.\", \" For more information about dependency injection, see\\n\\nIntroduction to dependency injection.\\n\\nFigure\", \" 10-1 shows the interaction of classes that read catalog data from the catalog microservice for\\ndisp\", \"laying by the CatalogView.\\n\\n74 CHAPTER 10 | Accessing remote data\\neShopOnContainers.Core\\n\\nCatalogVie\", \"wModel RequestProvider\\nCatalogService\\n\\nGetCatalogAsync\\n\\nCatalog.API\\n\\nCatalogController\\n\\nSystem.Net.H\", \"ttp.HttpClient\\n\\nGetAsync\\n\\nGetAsync\\n\\n|\\n|\\nl\\n|\\nresponse\\n\\nread\\nresponse\\n\\nCatalogRoot\\n\\nCatalogitem\\ncollec\", \"tion\\n\\n|\\nFigure 10-1: Retrieving data from the catalog microservice\\n\\nWhen the CatalogView is navigate\", \"d to, the OnInitialize method in the CatalogViewModel class is\\ncalled. This method retrieves catalog\", \" data from the catalog microservice, as demonstrated in the\\nfollowing code example:\\n\\npublic override\", \" async Task InitializeAsync(object navigationData)\\n\\n{\\n\\nProducts = await _productsService.GetCatalogA\", \"sync() ;\\n\\nThis method calls the GetCatalogAsync method of the CatalogService instance that was injec\", \"ted\\ninto the CatalogViewModel by Autofac. The following code example shows the GetCatalogAsync\\nmetho\", \"d:\\n\\npublic async Task<ObservableCollection<CatalogItem>> GetCatalogAsync()\\n\\n{\\nUriBuilder builder = n\", \"ew UriBuilder(GlobalSetting.Instance.CatalogEndpoint) ;\\nbuilder.Path = \\\"api/vl/catalog/items\\\";\\nstrin\", \"g uri = builder.ToStringQ ;\\n\\nCatalogRoot catalog = await _requestProvider.GetAsync<CatalogRoot>(ur1)\", \" ;\\n\\n15 CHAPTER 10 | Accessing remote data\\nreturn catalog?.Data.ToObservableCol lectionQ ;\\n\\nThis meth\", \"od builds the URI that identifies the resource the request will be sent to, and uses the\\nRequestProv\", \"ider class to invoke the GET HTTP method on the resource, before returning the results\\nto the Catalo\", \"gViewModel. The RequestProvider class contains functionality that submits a request\\nin the form of a\", \" URI that identifies a resource, an HTTP method that indicates the operation to be\\nperformed on that\", \" resource, and a body that contains any data required to perform the operation. For\\ninformation abou\", \"t how the RequestProvider class is injected into the CatalogService class, see\\nIntroduction to depen\", \"dency injection.\\n\\nThe following code example shows the GetAsync method in the RequestProvider class:\", \"\\n\\npublic async Task<TResult> GetAsync<TResult>(Cstring uri, string token = \\\"\\\")\\n{\\n\\nHttpClient httpCli\", \"ent = CreateHttpClient(token) ;\\n\\nHttpResponseMessage response = await httpClient.GetAsync(uri) ;\\n\\naw\", \"ait HandleResponse(response) ;\\nstring serialized = await response.Content.ReadAsStringAsync() ;\\n\\nTRe\", \"sult result = await Task.Run(Q) =>\\nJsonConvert .DeserializeObject<IResult>Cserialized, _serializerSe\", \"ttings)) ;\\n\\nreturn result;\\n\\nThis method calls the CreateHttpClient method, which returns an instance\", \" of the HttpClient class\\nwith the appropriate headers set. It then submits an asynchronous GET reque\", \"st to the resource\\nidentified by the URI, with the response being stored in the HttpResponseMessage \", \"instance. The\\nHandleResponse method Is then invoked, which throws an exception if the response doesn\", \"'t include\\na success HTTP status code. Then the response is read as a string, converted from JSON to\", \" a\\nCatalogRoot object, and returned to the CatalogService.\\n\\nThe CreateHttpClient method is shown in \", \"the following code example:\\n\\nprivate HttpClient CreateHttpClient(string token = '\\\")\\n{\\nvar httpClient\", \" = new HttpClientQ;\\nhttpClient.DefaultRequestHeaders.Accept.Add(\\nnew MediaTypeWithQualityHeaderValue\", \"C\\\"application/json\\\"));\\n\\nif C!string.IsNull0OrEmpty (token) )\\n{\\nhttpClient.DefaultRequestHeaders.Auth\", \"orization =\\nnew AuthenticationHeaderValueC(\\\"Bearer\\\", token);\\n}\\nreturn httpClient;\\n\\nThis method creat\", \"es a new instance of the HttpClient class, and sets the Accept header of any\\nrequests made by the Ht\", \"tpClient instance to application/json, which indicates that it expects the\\ncontent of any response t\", \"o be formatted using JSON. Then, if an access token was passed as an\\nargument to the CreateHttpClien\", \"t method, it's added to the Authorization header of any\\nrequests made by the HttpClient instance, pr\", \"efixed with the string Bearer. For more information\\nabout authorization, see Authorization.\\n\\n76 CHAP\", \"TER 10 | Accessing remote data\\nWhen the GetAsync method in the RequestProvider class calls HttpClien\", \"t.GetAsync, the Items\\nmethod in the CatalogControl ler class in the Catalog.API project is invoked, \", \"which is shown in the\\nfollowing code example:\\n\\n[HttpGet ]\\n[RouteC'{action]|\\\")]\\npublic async Task<IAc\", \"tionResult> Items(\\n[FromQuery]int pageSize = 10, [FromQuery]int pageIndex = 0)\\n\\n{\\nvar totalItems = a\", \"wait _catalogContext.Cataloglitems\\n. LongCountAsync() ;\\nvar itemsOnPage = await _catalogContext.Cata\", \"logItems\\n.OrderBy(c=>c.Name)\\n.Skip(pageSize * pageIndex)\\n. Take (pageSize)\\n. ToListAsync();\\nitemsOnP\", \"age = ComposePicUri(itemsOnPage) ;\\nvar model = new PaginatedItemsViewModel <CatalogItem> (\\npageIndex\", \", pageSize, totalItems, itemsOnPage) ;\\nreturn Ok(model);\\n}\\n\\nThis method retrieves the catalog data f\", \"rom the SQL database using EntityFramework, and returns it\\nas a response message that includes a suc\", \"cess HTTP status code, and a collection of JSON formatted\\nCatalogItem instances.\\n\\nMaking a POST requ\", \"est\\n\\nThe BasketService class is used to manage the data retrieval and update process with the basket\", \"\\nmicroservice. In the RegisterDependencies method in the ViewModelLocator class, the\\nBasketService c\", \"lass is registered as a type mapping against the IBasketService type with the\\nAutofac dependency inj\", \"ection container. Then, when an instance of the BasketViewModel class is\\ncreated, its constructor ac\", \"cepts an IBasketService type, which Autofac resolves, returning an\\ninstance of the BasketService cla\", \"ss. For more information about dependency injection, see\\n\\nIntroduction to dependency injection.\\n\\nFig\", \"ure 10-2 shows the interaction of classes that send the basket data displayed by the BasketView,\\nto \", \"the basket microservice.\\n\\n77 CHAPTER 10 | Accessing remote data\\nBasket.API\\n\\nBasketController\\n\\neShopO\", \"nContainers.Core\\n\\nBasketView Model RequestProvider\\n|\\n|\\n| System.Net.Http.HttpClient\\n|\\n|\\n|\\n|\\n\\nUpdateB\", \"asketAsync\\n\\nPostAsync\\n\\nPostAsync\\n\\nPost\\n\\nresponse\\n\\nread\\nresponse\\n\\nCustomerBasket\\n\\nFigure 10-2: Sendin\", \"g data to the basket microservice\\n\\nWhen an item is added to the shopping basket, the ReCalculateTota\", \"lAsync method in the\\nBasketViewModel class is called. This method updates the total value of items i\", \"n the basket, and\\nsends the basket data to the basket microservice, as demonstrated in the following\", \" code example:\\n\\nprivate async Task ReCalculateTotalAsync()\\n\\n{\\nawait _basketService.UpdateBasketAsync\", \"Cnew CustomerBasket\\n{\\nBuyerlId = useriInfo.Userld,\\nItems = BasketItems.ToListQ)\\n}, authToken);\\n}\\n\\nTh\", \"is method calls the UpdateBasketAsync method of the BasketService instance that was injected\\ninto th\", \"e BasketViewModel by Autofac. The following method shows the UpdateBasketAsync\\nmethod:\\n\\npublic async\", \" Task<CustomerBasket> UpdateBasketAsync(CustomerBasket customerBasket, string token)\\n{\\n\\nUriBuilder b\", \"uilder = new UriBuilder(GlobalSetting. Instance. BasketEndpoint) ;\\n\\nstring uri = builder.ToStringQ ;\", \"\\n\\n78 CHAPTER 10 | Accessing remote data\\nvar result = await _requestProvider.PostAsync(uri, customerB\", \"asket, token);\\nreturn result;\\n\\nThis method builds the URI that identifies the resource the request w\", \"ill be sent to, and uses the\\nRequestProvider class to invoke the POST HTTP method on the resource, b\", \"efore returning the\\nresults to the BasketViewModel. Note that an access token, obtained from Identit\", \"yServer during the\\nauthentication process, is required to authorize requests to the basket microserv\", \"ice. For more\\ninformation about authorization, see Authorization.\\n\\nThe following code example shows \", \"one of the PostAsync methods in the RequestProvider class:\\n\\npublic async Task<TResult> PostAsync<TRe\", \"sult>(\\n\\nstring uri, TResult data, string token = \\\"\\\", string header = \\\"\\\")\\n\\n{\\nHttpClient httpClient = \", \"CreateHttpClient (token) ;\\nvar content = new StringContent(JsonConvert.SerializeObject(data)) ;\\ncont\", \"ent.Headers.ContentType = new MediaTypeHeaderValueC\\\"application/json\\\");\\nHttpResponseMessage response\", \" = await httpClient.PostAsync(uri, content) ;\\nawait HandleResponse(response) ;\\nstring serialized = a\", \"wait response.Content.ReadAsStringAsync() ;\\nTResult result = await Task.Run(Q) =>\\n\\nJsonConvert .Dese\", \"rializeObject<IResult>Cserialized, _serializerSettings)) ;\\n\\nreturn result;\\n\\n}\\n\\nThis method calls the\", \" CreateHttpClient method, which returns an instance of the HttpClient class\\nwith the appropriate hea\", \"ders set. It then submits an asynchronous POST request to the resource\\nidentified by the URI, with t\", \"he serialized basket data being sent in JSON format, and the response\\nbeing stored in the HttpRespon\", \"seMessage instance. The HandleResponse method is then invoked,\\nwhich throws an exception if the resp\", \"onse doesn't include a success HTTP status code. Then, the\\nresponse is read as a string, converted f\", \"rom JSON to a CustomerBasket object, and returned to the\\nBasketService. For more information about t\", \"he CreateHttpClient method, see Making a GET request.\\n\\nWhen the PostAsync method in the RequestProvi\", \"der class calls HttpClient.PostAsync, the Post\\nmethod in the BasketControl ler class in the Basket.A\", \"PI project is invoked, which is shown in the\\nfollowing code example:\\n\\n[HttpPost]\\npublic async Task<I\", \"ActionResult> Post([FromBody]CustomerBasket value)\\n{\\n\\nvar basket = await _repository.UpdateBasketAsy\", \"nc(value) ;\\n\\nreturn Ok(basket) ;\\n\\nThis method uses an instance of the RedisBasketRepository class to\", \" persist the basket data to the\\nRedis cache, and returns it as a response message that includes a su\", \"ccess HTTP status code, and a\\nJSON formatted CustomerBasket instance.\\n\\nMaking a DELETE request\\n\\nFigu\", \"re 10-3 shows the interactions of classes that delete basket data from the basket microservice, for\\n\", \"the CheckoutVi ew.\\n\\n719 CHAPTER 10 | Accessing remote data\\neShopOnContainers.Core Basket.API\\n\\n|\\n|\\n|\\n\", \"|\\n|\\nCheckoutView Model RequestProvider | BasketController\\n|\\n| | | |\\n| | |\\n| BasketService | System.N\", \"et.Http.HttpClient | |\\n| | | |\\n| | |\\n| | | |\\n! | |\\n|\\n|\\n|\\n|\\n|\\n|\\n|\\n|\\n|\\n|\\n\\nClearBasketAsync\\n\\nDeleteAsyn\", \"c\\n\\nDeleteAsync\\n\\nFigure 10-3: Deleting data from the basket microservice\\n\\nWhen the checkout process i\", \"s invoked, the CheckoutAsync method in the CheckoutViewModel class\\nis called. This method creates a \", \"new order, before clearing the shopping basket, as demonstrated in\\nthe following code example:\\n\\npriv\", \"ate async Task CheckoutAsync()\\n{\\n\\nawait _basketService.ClearBasketAsync(_shippingAddress.Id.ToString\", \"(), authToken) ;\\n\\nThis method calls the ClearBasketAsync method of the BasketService instance that w\", \"as injected\\ninto the CheckoutViewModel by Autofac. The following method shows the ClearBasketAsync\\nm\", \"ethod:\\n\\npublic async Task ClearBasketAsync(string guidUser, string token)\\n\\n{\\nUriBuilder builder = ne\", \"w UriBuilder(GlobalSetting. Instance. BasketEndpoint) ;\\nbuilder.Path = guidUser;\\nstring uri = builde\", \"r.ToStringQ ;\\nawait _requestProvider.DeleteAsync(uri, token) ;\\n$\\n\\nThis method builds the URI that id\", \"entifies the resource that the request will be sent to, and uses the\\nRequestProvider class to invoke\", \" the DELETE HTTP method on the resource. Note that an access\\ntoken, obtained from IdentityServer dur\", \"ing the authentication process, is required to authorize\\nrequests to the basket microservice. For mo\", \"re information about authorization, see Authorization.\\n\\nThe following code example shows the DeleteA\", \"sync method in the RequestProvider class:\\n\\n80 CHAPTER 10 | Accessing remote data\\npublic async Task D\", \"eleteAsync(string uri, string token = \\\"\\\")\\n\\n{\\nHttpClient httpClient = CreateHttpClient (token) ;\\nawai\", \"t httpClient.DeleteAsync (uri) ;\\n\\nThis method calls the CreateHttpClient method, which returns an in\", \"stance of the HttpClient class\\nwith the appropriate headers set. It then submits an asynchronous DEL\", \"ETE request to the resource\\nidentified by the URI. For more information about the CreateHttpClient m\", \"ethod, see Making a GET\\n\\nrequest.\\n\\nWhen the DeleteAsync method in the RequestProvider class calls Ht\", \"tpClient.DeleteAsync, the\\nDelete method in the BasketControl ler class in the Basket.API project is \", \"invoked, which is shown\\nin the following code example:\\n\\n[HttpDeleteC(\\\"{id}\\\")]\\npublic void Delete(str\", \"ing id)\\n\\n{\\n_repository.DeleteBasketAsync(id) ;\\n\\n}\\n\\nThis method uses an instance of the RedisBasketRe\", \"pository class to delete the basket data from\\nthe Redis cache.\\n\\nCaching data\\n\\nThe performance of an \", \"app can be improved by caching frequently accessed data to fast storage\\nthat's located close to the \", \"app. If the fast storage is located closer to the app than the original source,\\nthen caching can sig\", \"nificantly improve response times when retrieving data.\\n\\nThe most common form of caching is read-thr\", \"ough caching, where an app retrieves data by\\nreferencing the cache. If the data isn't in the cache, \", \"it's retrieved from the data store and added to the\\ncache. Apps can implement read-through caching w\", \"ith the cache-aside pattern. This pattern\\ndetermines whether the item is currently in the cache. If \", \"the item isn't in the cache, it's read from the\\ndata store and added to the cache. For more informat\", \"ion, see the Cache-Aside pattern on Microsoft\\nDocs.\\n\\nTip: Cache data that's read frequently and that\", \" changes infrequently\\n\\nThis data can be added to the cache on demand the first time it is retrieved \", \"by an app. This means\\nthat the app needs to fetch the data only once from the data store, and that s\", \"ubsequent access can\\nbe satisfied by using the cache.\\n\\nDistributed applications, such as the eshopOn\", \"Containers reference application, should provide either\\nor both of the following caches:\\n\\ne Ashared \", \"cache, which can be accessed by multiple processes or machines.\\ne A private cache, where data is hel\", \"d locally on the device running the app.\\n\\nThe eShopOnContainers mobile app uses a private cache, whe\", \"re data is held locally on the device\\nthat's running an instance of the app. For information about t\", \"he cache used by the\\neShopOnContainers reference application, see .NET Microservices: Architecture f\", \"or Containerized .NET\\n\\nApplications.\\n\\n81 CHAPTER 10 | Accessing remote data\\nTip: Think of the cache \", \"as a transient data store that could disappear at any time\\n\\nEnsure that data is maintained in the or\", \"iginal data store as well as the cache. The chances of losing\\ndata are then minimized if the cache b\", \"ecomes unavailable.\\n\\nManaging data expiration\\n\\nIt's impractical to expect that cached data will alwa\", \"ys be consistent with the original data. Data in the\\noriginal data store might change after it's bee\", \"n cached, causing the cached data to become stale.\\nTherefore, apps should implement a strategy that \", \"helps to ensure that the data in the cache Is as up-\\nto-date as possible, but can also detect and ha\", \"ndle situations that arise when the data in the cache\\nhas become stale. Most caching mechanisms enab\", \"le the cache to be configured to expire data, and\\nhence reduce the period for which data might be ou\", \"t of date.\\n\\nTip: Set a default expiration time when configuring a cache\\n\\nMany caches implement expir\", \"ation, which invalidates data and removes it from the cache if it's not\\naccessed for a specified per\", \"iod. However, care must be taken when choosing the expiration period.\\nIf it's made too short, data w\", \"ill expire too quickly and the benefits of caching will be reduced. If it's\\nmade too long, the data \", \"risks becoming stale. Therefore, the expiration time should match the\\npattern of access for apps tha\", \"t use the data.\\n\\nWhen cached data expires, it should be removed from the cache, and the app must ret\", \"rieve the data\\nfrom the original data store and place it back into the cache.\\n\\nIt's also possible th\", \"at a cache might fill up if data is allowed to remain for too long a period. Therefore,\\nrequests to \", \"add new items to the cache might be required to remove some items in a process known\\nas eviction. Ca\", \"ching services typically evict data on a least-recently-used basis. However, there are\\nother evictio\", \"n policies, including most-recently-used, and first-in-first-out. For more information, see\\nCaching \", \"Guidance on Microsoft Docs.\\n\\nCaching images\\n\\nThe eShopOnContainers mobile app consumes remote produc\", \"t images that benefit from being\\ncached. These images are displayed by the Image control, and the Ca\", \"chedImage control provided by\\n\\nthe FFlmageLoading library.\\n\\nThe Xamarin.Forms Image control supports\", \" caching of downloaded images. Caching is enabled by\\ndefault, and will store the image locally for 2\", \"4 hours. In addition, the expiration time can be\\nconfigured with the CacheValidity property. For mor\", \"e information, see Downloaded Image Caching\\non the Xamarin Developer Center.\\n\\nFFlmageLoading's Cache\", \"dImage control is a replacement for the Xamarin.Forms Image control,\\nproviding additional properties\", \" that enable supplementary functionality. Amongst this functionality,\\nthe control provides configura\", \"ble caching, while supporting error and loading image placeholders.\\nThe following code example shows\", \" how the eShopOnContainers mobile app uses the CachedImage\\ncontrol in the ProductTemp late, which is\", \" the data template used by the ListView control in the\\nCatalogVi ew:\\n\\n<ffimageloading:CachedImage\\nGr\", \"id.Row=\\\"0\\\"\\nSource=\\\"{Binding PictureUri}\\\"\\nAspect=\\\"AspectFi11\\\">\\n<ffimage loading :CachedImage.LoadingP\", \"laceholder>\\n<OnPlatform\\nx: TypeArguments=\\\" ImageSource\\\"\\n\\n82 CHAPTER 10 | Accessing remote data\\n10S=\\\"\", \"default_product\\\"\\n\\nAndroid=\\\"defau1t_product\\\"\\n\\nWinPhone=\\\"Assets/default_product.png\\\"/>\\n</ffimage loadi\", \"ng: CachedImage.LoadingPlaceholder>\\n<ffimage loading :CachedImage. ErrorPlaceholder>\\n\\n<OnPlatform\\n\\nx\", \": TypeArguments=\\\" ImageSource\\\"\\n\\n10S=\\\"noimage\\\"\\n\\nAndroid=\\\"noimage\\\"\\nWinPhone=\\\"Assets/noimage.png\\\"/>\\n</f\", \"fimage loading: CachedImage.ErrorPlaceholder>\\n\\n</ffimage loading: CachedImage>\\n\\nThe CachedImage cont\", \"rol sets the LoadingPlaceholder and ErrorPlaceholder properties to\\nplatform-specific images. The Loa\", \"dingPlaceholder property specifies the image to be displayed\\nwhile the image specified by the Source\", \" property is retrieved, and the ErrorPlaceholder property\\nspecifies the image to be displayed if an \", \"error occurs when attempting to retrieve the image specified\\nby the Source property.\\n\\nAs the name im\", \"plies, the CachedImage control caches remote images on the device for the time\\nspecified by the valu\", \"e of the CacheDuration property. When this property value isn't explicitly set, the\\ndefault value of\", \" 30 days is applied.\\n\\nIncreasing resilience\\n\\nAll apps that communicate with remote services and reso\", \"urces must be sensitive to transient faults.\\nTransient faults include the momentary loss of network \", \"connectivity to services, the temporary\\nunavailability of a service, or timeouts that arise when a s\", \"ervice is busy. These faults are often self-\\ncorrecting, and if the action is repeated after a suita\", \"ble delay it's likely to succeed.\\n\\nTransient faults can have a huge impact on the perceived quality \", \"of an app, even if it has been\\nthoroughly tested under all foreseeable circumstances. To ensure that\", \" an app that communicates with\\nremote services operates reliably, it must be able to do all of the f\", \"ollowing:\\n\\ne Detect faults when they occur, and determine if the faults are likely to be transient.\\n\", \"\\ne Retry the operation if it determines that the fault is likely to be transient and keep track of t\", \"he\\nnumber of times the operation was retried.\\n\\ne Use an appropriate retry strategy, which specifies \", \"the number of retries, the delay between\\neach attempt, and the actions to take after a failed attemp\", \"t.\\n\\nThis transient fault handling can be achieved by wrapping all attempts to access a remote servic\", \"e in\\ncode that implements the retry pattern.\\n\\nRetry pattern\\n\\nIf an app detects a failure when it tri\", \"es to send a request to a remote service, it can handle the failure\\nin any of the following ways:\\n\\ne\", \" Retrying the operation. The app could retry the failing request immediately.\\n\\ne Retrying the operat\", \"ion after a delay. The app should wait for a suitable amount of time before\\nretrying the request.\\n\\ne\", \" Cancelling the operation. The application should cancel the operation and report an\\nexception.\\n\\n83 \", \"CHAPTER 10 | Accessing remote data\\nThe retry strategy should be tuned to match the business requirem\", \"ents of the app. For example, it's\\nimportant to optimize the retry count and retry interval to the o\", \"peration being attempted. If the\\noperation Is part of a user interaction, the retry interval should \", \"be short and only a few retries\\nattempted to avoid making users wait for a response. If the operatio\", \"n is part of a long running\\nworkflow, where cancelling or restarting the workflow is expensive or ti\", \"me-consuming, it's appropriate\\nto wait longer between attempts and to retry more times.\\n\\nNote: An ag\", \"gressive retry strategy with minimal delay between attempts, and a large number of\\nretries, could de\", \"grade a remote service that's running close to or at capacity. In addition, such a\\nretry strategy co\", \"uld also affect the responsiveness of the app if it's continually trying to perform a\\nfailing operat\", \"ion.\\n\\nIf a request still fails after a number of retries, it's better for the app to prevent further\", \" requests going\\nto the same resource and to report a failure. Then, after a set period, the app can \", \"make one or more\\nrequests to the resource to see if they're successful. For more information, see Ci\", \"rcuit breaker pattern.\\n\\nTip: Never implement an endless retry mechanism\\n\\nUse a finite number of retr\", \"ies, or implement the Circuit Breaker pattern to allow a service to recover.\\n\\nThe eShopOnContainers \", \"mobile app does not currently implement the retry pattern when making\\nRESTful web requests. However,\", \" the CachedImage control, provided by the FFlmageLoading library\\nsupports transient fault handling b\", \"y retrying image loading. If image loading fails, further attempts\\nwill be made. The number of attem\", \"pts is specified by the RetryCount property, and retries will occur\\nafter a delay specified by the R\", \"etryDelay property. If these property values aren't explicitly set, their\\ndefault values are applied\", \" \\u2014 3 for the RetryCount property, and 250ms for the RetryDelay property.\\nFor more information about \", \"the CachedImage control, see Caching images.\\n\\nThe eShopOnContainers reference application does imple\", \"ment the retry pattern. For more\\ninformation, including a discussion of how to combine the retry pat\", \"tern with the HttpClient class,\\n\\nsee .NET Microservices: Architecture for Containerized .NET Applica\", \"tions.\\n\\nFor more information about the retry pattern, see the Retry pattern on Microsoft Docs.\\n\\nCirc\", \"uit breaker pattern\\n\\nIn some situations, faults can occur due to anticipated events that take longer\", \" to fix. These faults can\\nrange from a partial loss of connectivity to the complete failure of a ser\", \"vice. In these situations, it's\\npointless for an app to retry an operation that's unlikely to succee\", \"d, and instead should accept that\\nthe operation has failed and handle this failure accordingly.\\n\\nThe\", \" circuit breaker pattern can prevent an app from repeatedly trying to execute an operation that's\\nli\", \"kely to fail, while also enabling the app to detect whether the fault has been resolved.\\n\\nNote: The \", \"purpose of the circuit breaker pattern is different from the retry pattern. The retry\\npattern enable\", \"s an app to retry an operation in the expectation that it'll succeed. The circuit breaker\\npattern pr\", \"events an app from performing an operation that's likely to fail.\\n\\nA circuit breaker acts as a proxy\", \" for operations that might fail. The proxy should monitor the number\\nof recent failures that have oc\", \"curred, and use this information to decide whether to allow the\\noperation to proceed, or to return a\", \"n exception immediately.\\n\\nThe eShopOnContainers mobile app does not currently implement the circuit \", \"breaker pattern.\\nHowever, the eShopOnContainers does. For more information, see .NET Microservices: \", \"Architecture\\n\\nfor Containerized .NET Applications.\\n\\n84 CHAPTER 10 | Accessing remote data\\nTip: Combi\", \"ne the retry and circuit breaker patterns\\n\\nAn app can combine the retry and circuit breaker patterns\", \" by using the retry pattern to invoke an\\noperation through a circuit breaker. However, the retry log\", \"ic should be sensitive to any exceptions\\nreturned by the circuit breaker and abandon retry attempts \", \"if the circuit breaker indicates that a\\nfault is not transient.\\n\\nFor more information about the circ\", \"uit breaker pattern, see the Circuit Breaker pattern on Microsoft\\nDocs.\\n\\nSummary\\n\\nMany modern web-ba\", \"sed solutions make use of web services, hosted by web servers, to provide\\nfunctionality for remote c\", \"lient applications. The operations that a web service exposes constitute a\\nweb API, and client apps \", \"should be able to utilize the web API without knowing how the data or\\noperations that the API expose\", \"s are implemented.\\n\\nThe performance of an app can be improved by caching frequently accessed data to\", \" fast storage\\nthat's located close to the app. Apps can implement read-through caching with the cach\", \"e-aside\\npattern. This pattern determines whether the item Is currently in the cache. If the item isn\", \"'t in the\\ncache, it's read from the data store and added to the cache.\\n\\nWhen communicating with web \", \"APIs, apps must be sensitive to transient faults. Transient faults\\ninclude the momentary loss of net\", \"work connectivity to services, the temporary unavailability of a\\nservice, or timeouts that arise whe\", \"n a service is busy. These faults are often self-correcting, and if the\\naction Is repeated after a s\", \"uitable delay, then it's likely to succeed. Therefore, apps should wrap all\\nattempts to access a web\", \" API in code that implements a transient fault handling mechanism.\\n\\n85 CHAPTER 10 | Accessing remote\", \" data\\nUnit testing\\n\\nMobile apps have unique problems that desktop and web-based applications don't h\", \"ave to worry\\nabout. Mobile users will differ by the devices that they use, by network connectivity, \", \"by the availability\\nof services, and a range of other factors. Therefore, mobile apps should be test\", \"ed as they will be used\\nin the real world in order to improve their quality, reliability, and perfor\", \"mance. There are many types\\nof testing that should be performed on an app, including unit testing, i\", \"ntegration testing, and user\\ninterface testing, with unit testing being the most common form of test\", \"ing.\\n\\nA unit test takes a small unit of the app, typically a method, isolates it from the remainder \", \"of the code,\\nand verifies that it behaves as expected. Its goal is to check that each unit of functi\", \"onality performs as\\nexpected, so that errors don't propagate throughout the app. Detecting a bug whe\", \"re it occurs is more\\nefficient that observing the effect of a bug indirectly at a secondary point of\", \" failure.\\n\\nUnit testing has the greatest effect on code quality when it's an integral part of the so\", \"ftware\\ndevelopment workflow. As soon as a method has been written, unit tests should be written that\", \" verify\\nthe behavior of the method in response to standard, boundary, and incorrect cases of input d\", \"ata, and\\nthat check any explicit or implicit assumptions made by the code. Alternatively, with test \", \"driven\\ndevelopment, unit tests are written before the code. In this scenario, unit tests act as both\", \" design\\ndocumentation and functional specifications.\\n\\nNote: Unit tests are very effective against re\", \"gression \\u2014 that is, functionality that used to work but\\nhas been disturbed by a faulty update.\\n\\nUnit\", \" tests typically use the arrange-act-assert pattern:\\n\\ne The arrange section of the unit test method \", \"initializes objects and sets the value of the data\\nthat is passed to the method under test.\\n\\ne The a\", \"ct section invokes the method under test with the required arguments.\\ne The assert section verifies \", \"that the action of the method under test behaves as expected.\\n\\nFollowing this pattern ensures that u\", \"nit tests are readable and consistent.\\n\\nDependency injection and unit testing\\n\\nOne of the motivation\", \"s for adopting a loosely-coupled architecture is that it facilitates unit testing.\\nOne of the types \", \"registered with Autofac is the OrderService class. The following code example\\nshows an outline of th\", \"is class:\\n\\npublic class OrderDetailViewModel : ViewModelBase\\n{\\n\\nprivate IOrderService _ordersService\", \";\\n\\npublic OrderDetai 1ViewModel (IOrderService ordersService)\\n\\n86 CHAPTER 11 | Unit testing\\n_ordersS\", \"ervice = ordersService;\\n\\nThe OrderDetai 1ViewModel class has a dependency on the I0rderService type \", \"which the container\\nresolves when it instantiates a OrderDetai 1ViewModel object. However, rather th\", \"an create an\\nOrderService object to unit test the OrderDetai1ViewModel class, instead, replace the\\nO\", \"rderService object with a mock for the purpose of the tests. Figure 10-1 illustrates this relationsh\", \"ip.\\n\\nlOrderService -\\n\\nOrderService OrderMockService\\n\\nFigure 10-1: Classes that implement the |OrderS\", \"ervice interface\\n\\nThis approach allows the OrderService object to be passed into the OrderDetai1View\", \"Mode!] class at\\nruntime, and in the interests of testability, it allows the OrderMockService class t\", \"o be passed into the\\nOrderDetai 1ViewModel class at test time. The main advantage of this approach i\", \"s that it enables unit\\ntests to be executed without requiring unwieldy resources such as web service\", \"s, or databases.\\n\\nTesting MVVM applications\\n\\nTesting models and view models from MVVM applications i\", \"s identical to testing any other classes, and\\nthe same tools and techniques \\u2014 such as unit testing a\", \"nd mocking, can be used. However, there are\\nsome patterns that are typical to model and view model c\", \"lasses, that can benefit from specific unit\\ntesting techniques.\\n\\nTip: Test one thing with each unit \", \"test\\n\\nDon't be tempted to make a unit test exercise more than one aspect of the unit's behavior. Doi\", \"ng\\nso leads to tests that are difficult to read and update. It can also lead to confusion when\\ninter\", \"preting a failure.\\n\\nThe eShopOnContainers mobile app uses xUnit to perform unit testing, which suppo\", \"rts two different\\ntypes of unit tests:\\n\\ne Facts are tests that are always true, which test invariant\", \" conditions.\\n\\ne Theories are tests that are only true for a particular set of data.\\n\\n87 CHAPTER 11 |\", \" Unit testing\\nThe unit tests included with the eshopOnContainers mobile app are fact tests, and so e\", \"ach unit test\\nmethod is decorated with the [Fact] attribute.\\n\\nNote: xUnit tests are executed by a te\", \"st runner. To execute the test runner, run the\\neShopOnContainers.TestRunner project for the required\", \" platform.\\n\\nTesting asynchronous functionality\\n\\nWhen implementing the MVVM pattern, view models usua\", \"lly invoke operations on services, often\\nasynchronously. Tests for code that invokes these operation\", \"s typically use mocks as replacements for\\nthe actual services. The following code example demonstrat\", \"es testing asynchronous functionality by\\npassing a mock service into a view model:\\n\\n[Fact]\\npublic as\", \"ync Task OrderPropertyIsNotNul lAfterViewModelInitializationTest()\\nt\\n\\nvar orderService = new OrderMo\", \"ckService() ;\\nvar orderViewModel = new OrderDetai 1ViewModel CorderService) ;\\n\\nvar order = await ord\", \"erService.GetOrderAsync(1, GlobalSetting. Instance. AuthToken) ;\\nawait orderViewModel.InitializeAsyn\", \"c (order) ;\\n\\nAssert.NotNul1CorderViewModel.Order) ;\\n\\nThis unit test checks that the Order property o\", \"f the OrderDetai 1ViewModel instance will have a value\\nafter the InitializeAsync method has been inv\", \"oked. The InitializeAsync method is invoked\\nwhen the view model's corresponding view is navigated to\", \". For more information about navigation,\\n\\nsee Navigation.\\n\\nWhen the OrderDetai 1ViewModel instance i\", \"s created, it expects an OrderService instance to be\\nspecified as an argument. However, the OrderSer\", \"vice retrieves data from a web service. Therefore,\\nan OrderMockService instance, which is a mock ver\", \"sion of the OrderService class, is specified as the\\nargument to the OrderDetai 1ViewModel constructo\", \"r. Then, when the view model's\\nInitializeAsync method is invoked, which invokes IOrderService operat\", \"ions, mock data is\\nretrieved rather than communicating with a web service.\\n\\nTesting INotifyPropertyC\", \"hanged implementations\\n\\nImplementing the INotifyPropertyChanged interface allows views to react to c\", \"hanges that originate\\nfrom view models and models. These changes are not limited to data shown in co\", \"ntrols \\u2014 they are\\nalso used to control the view, such as view model states that cause animations to \", \"be started or\\ncontrols to be disabled.\\n\\nProperties that can be updated directly by the unit test can\", \" be tested by attaching an event handler to\\nthe PropertyChanged event and checking whether the event\", \" is raised after setting a new value for the\\nproperty. The following code example shows such a test:\", \"\\n\\n[Fact]\\npublic async Task SettingOrderPropertyShouldRaisePropertyChanged()\\n{\\n\\nboo! invoked = false;\", \"\\n\\nvar orderService = new OrderMockService() ;\\n\\nvar orderViewModel = new OrderDetai 1ViewModel Corder\", \"Service) ;\\n\\norderViewModel.PropertyChanged += (sender, e) =>\\n\\n{\\n\\n88 CHAPTER 11 | Unit testing\\nif Ce.\", \"PropertyName.EqualsC'Order\\\"))\\ninvoked = true;\\nIng\\nvar order = await orderService.GetOrderAsync(1, Gl\", \"obalSetting. Instance. AuthToken) ;\\nawait orderViewModel.InitializeAsync (order) ;\\n\\nAssert.TrueCinvo\", \"ked) ;\\n\\nThis unit test invokes the InitializeAsync method of the OrderViewModel class, which causes \", \"its\\nOrder property to be updated. The unit test will pass, provided that the PropertyChanged event i\", \"s\\nraised for the Order property.\\n\\nTesting message-based communication\\n\\nView models that use the Mess\", \"agingCenter class to communicate between loosely-coupled classes\\ncan be unit tested by subscribing t\", \"o the message being sent by the code under test, as demonstrated\\nin the following code example:\\n\\n[Fa\", \"ct]\\npublic void AddCatalogItemCommandSendsAddProductMessagelest()\\n{\\nbool messageReceived = false;\\nva\", \"r catalogService = new CatalogMockService() ;\\nvar catalogViewModel = new CatalogViewModel CcatalogSe\", \"rvice) ;\\n\\nXamarin. Forms .MessagingCenter.Subscribe<CatalogViewModel, CatalogItem>(\\nthis, MessageKey\", \"s.AddProduct, (sender, arg) =>\\n{\\n\\nmessageReceived = true;\\n\\nDE\\ncatalogViewModel .AddCatalogItemComman\", \"d.Execute(Cnul 1);\\n\\nAssert.True(messageReceived) ;\\n\\nThis unit test checks that the CatalogViewModel \", \"publishes the AddProduct message in response to\\nits AddCatalogItemCommand being executed. Because th\", \"e MessagingCenter class supports multicast\\nmessage subscriptions, the unit test can subscribe to the\", \" AddProduct message and execute a callback\\ndelegate in response to receiving it. This callback deleg\", \"ate, specified as a lambda expression, sets a\\nboolean field that's used by the Assert statement to v\", \"erify the behavior of the test.\\n\\nTesting exception handling\\n\\nUnit tests can also be written that che\", \"ck that specific exceptions are thrown for invalid actions or\\ninputs, as demonstrated in the followi\", \"ng code example:\\n\\n[Fact]\\npublic void InvalidEventNameShou |dThrowArgumentExceptionText()\\n{\\nvar behav\", \"ior = new MockEventToCommandBehavior\\n{\\nEventName = \\\"OnItemTapped\\\"\\nIg\\n\\nvar listView = new ListView();\", \"\\n\\nAssert. Throws<ArgumentException>(() => listView.Behaviors.Add(behavior) ) ;\\n\\n89 CHAPTER 11 | Unit\", \" testing\\nThis unit test will throw an exception, because the ListView control does not have an event\", \" named\\nOnItemTapped. The Assert. Throws<T> method is a generic method where T is the type of the\\nexp\", \"ected exception. The argument passed to the Assert.Throws<T> method is a lambda expression\\nthat will\", \" throw the exception. Therefore, the unit test will pass provided that the lambda expression\\nthrows \", \"an ArgumentException.\\n\\nTip: Avoid writing unit tests that examine exception message strings\\n\\nExcepti\", \"on message strings might change over time, and so unit tests that rely on their presence are\\nregarde\", \"d as brittle.\\n\\nTesting validation\\n\\nThere are two aspects to testing the validation implementation: t\", \"esting that any validation rules are\\ncorrectly implemented, and testing that the ValidatableObject<T\", \"> class performs as expected.\\n\\nValidation logic is usually simple to test, because it is typically a\", \" self-contained process where the\\noutput depends on the input. There should be tests on the results \", \"of invoking the Validate method\\non each property that has at least one associated validation rule, a\", \"s demonstrated in the following\\ncode example:\\n\\n[Fact]\\npublic void CheckValidationPasseswhenBothPrope\", \"rtiesHaveDataTest()\\n{\\n\\nvar mockViewModel = new MockViewModel();\\nmockViewModel.Forename.Value = \\\"John\", \"\\\";\\nmockViewModel.Surname.Value = \\\"Smith\\\";\\n\\nbool isValid = mockViewModel .Validate() ;\\n\\nAssert.True(i\", \"sValid);\\n\\nThis unit test checks that validation succeeds when the two ValidatableObject<T> propertie\", \"s in the\\nMockVi ewModel instance both have data.\\n\\nAs well as checking that validation succeeds, vali\", \"dation unit tests should also check the values of the\\nValue, IsValid, and Errors property of each Va\", \"lidatableObject<T> instance, to verify that the\\nclass performs as expected. The following code examp\", \"le demonstrates a unit test that does this:\\n\\n[Fact]\\npublic void CheckValidationFai lswhenOnl yForena\", \"meHasDataTest()\\n{\\nvar mockViewModel = new MockViewModel();\\nmockViewModel.Forename.Value = \\\"John\\\";\\n\\nb\", \"ool isValid = mockViewModel .ValidateQ ;\\n\\nAssert.False(isValid);\\nAssert.NotNul 1 CmockViewModel .For\", \"ename. Value) ;\\nAssert.Nul1CmockViewModel.Surname.Value) ;\\nAssert. True(mockViewModel. Forename. IsV\", \"alid);\\nAssert.FalseCmockViewModel.Surname.IsValid);\\nAssert. Empty (mockVi ewModel.Forename.Errors) ;\", \"\\nAssert.NotEmpty (mockViewModel.Surname.Errors) ;\\n\\n90 CHAPTER 11 | Unit testing\\nThis unit test check\", \"s that validation fails when the Surname property of the MockViewModel doesn't\\nhave any data, and th\", \"e Value, IsValid, and Errors property of each ValidatableObject<T> instance\\nare correctly set.\\n\\nSumm\", \"ary\\n\\nA unit test takes a small unit of the app, typically a method, isolates it from the remainder o\", \"f the code,\\nand verifies that it behaves as expected. Its goal is to check that each unit of functio\", \"nality performs as\\nexpected, so that errors don't propagate throughout the app.\\n\\nThe behavior of an \", \"object under test can be isolated by replacing dependent objects with mock\\nobjects that simulate the\", \" behavior of the dependent objects. This enables unit tests to be executed\\nwithout requiring unwield\", \"y resources such as web services, or databases.\\n\\nTesting models and view models from MVVM applicatio\", \"ns is identical to testing any other classes, and\\nthe same tools and techniques can be used.\\n\\n91 CHA\", \"PTER 11 | Unit testing\\nVisit our .NET Architecture Center\\nwww.microsoft.com/net/architecture\\n\\n\"]"