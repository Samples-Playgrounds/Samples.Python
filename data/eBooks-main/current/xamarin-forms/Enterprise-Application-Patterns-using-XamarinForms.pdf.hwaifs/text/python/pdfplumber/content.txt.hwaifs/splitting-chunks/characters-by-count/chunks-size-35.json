"[\"Book title\\nBook subtitle\\nAuthor NamePUBLISHED BY\\nDevDiv, .NET and Visual Studio produc teams\\nA divis\", \"ion of Microsoft Corporation\\nOne Microsoft Way\\nRedmond, Washington 98052-6399\\nCopyright \\u00a9 2017 by Mi\", \"crosoft Corporation\\nAll rights reserved. No part of the contents of this book may be reproduced or t\", \"ransmitted in any\\nform or by any means without the written permission of the publisher.\\nThis book is\", \" provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The views, opinions and\\ninformation\", \" expressed in this book, including URL and other Internet website references, may change\\nwithout not\", \"ice.\\nSome examples depicted herein are provided for illustration only and are fictitious. No real as\", \"sociation\\nor connection is intended or should be inferred.\\nMicrosoft and the trademarks listed at ht\", \"tp://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are\\ntrademarks of the Microsoft group of companie\", \"s. All other marks are property of their respective\\nowners.\\nAuthor: David Britch\\nDeveloper: Javier S\", \"uarez Ruiz (Plain Concepts)\\nParticipants and reviewers: Craig Dunn, Tom Opgenorth\\nEditor: John Meade\", \" (Populus Group)Contents\\nPreface ...................................................................\", \"........................................................ iv\\nPurpose ................................\", \".................................................................................................. i\", \"v\\nWhat's left out of this guide's scope ............................................................\", \".................................. iv\\nWho should use this guide ....................................\", \"......................................................................... iv\\nHow to use this guide .\", \"....................................................................................................\", \"................. v\\nIntroduction ...................................................................\", \"................................................. 1\\nSample application .............................\", \"...................................................................................... 2\\nSample appl\", \"ication architecture................................................................................\", \"...................... 2\\nMobile app ................................................................\", \"....................................................................... 4\\neShopOnContainers.Core pro\", \"ject................................................................................................\", \"... 5\\nPlatform projects ............................................................................\", \"................................................ 6\\nSummary .........................................\", \"........................................................................................ 6\\nMVVM ....\", \"....................................................................................................\", \"..................... 7\\nThe MVVM pattern ...........................................................\", \"....................................................... 7\\nView .....................................\", \"....................................................................................................\", \"........ 8\\nViewModel ...............................................................................\", \"........................................................ 8\\nModel ...................................\", \"....................................................................................................\", \"........ 9\\nConnecting view models to views .........................................................\", \".................................... 9\\nCreating a view model declaratively .........................\", \"....................................................................10\\nCreating a view model program\", \"matically .....................................................................................10\\nCr\", \"eating a view defined as a data template ...........................................................\", \".......................11\\nAutomatically creating a view model with a view model locator ............\", \".....................................11\\nUpdating views in response to changes in the underlying view\", \" model or model ....................... 12\\nUI interaction using commands and behaviors .............\", \"........................................................... 13\\nImplementing commands ...............\", \"...............................................................................................14\\nIm\", \"plementing behaviors ...............................................................................\", \".................................15\\nSummary ........................................................\", \"....................................................................... 17\\nDependency injection ....\", \"................................................................................................ 18\\n\", \"Introduction to dependency injection ...............................................................\", \"...................... 18\\nRegistration .............................................................\", \".............................................................. 20\\nResolution .......................\", \"....................................................................................................\", \"... 22\\nManaging the lifetime of resolved objects ...................................................\", \"............................ 22\\nSummary ............................................................\", \"................................................................... 23\\niCommunicating between loosel\", \"y coupled components .................................................. 24\\nIntroduction to Messaging\", \"Center ............................................................................................ \", \"24\\nDefining a message...............................................................................\", \".................................. 26\\nPublishing a message .........................................\", \"..................................................................... 26\\nSubscribing to a message ..\", \"....................................................................................................\", \".. 27\\nUnsubscribing from a message..................................................................\", \".............................. 27\\nSummary ..........................................................\", \"..................................................................... 27\\nNavigation ................\", \"....................................................................................................\", \". 28\\nNavigating between pages ......................................................................\", \"................................ 29\\nCreating the NavigationService instance ........................\", \"...............................................................29\\nHandling navigation requests .....\", \"...................................................................................................3\", \"0\\nNavigating when the app is launched ..............................................................\", \".............................32\\nPassing parameters during navigation ...............................\", \"...........................................................33\\nInvoking navigation using behaviors ..\", \"...........................................................................................34\\nConfir\", \"ming or cancelling navigation ......................................................................\", \"........................34\\nSummary .................................................................\", \".............................................................. 35\\nValidation .......................\", \"............................................................................................... 36\\nS\", \"pecifying validation rules .........................................................................\", \"............................. 37\\nAdding validation rules to a property .............................\", \"......................................................... 38\\nTriggering validation .................\", \".............................................................................................. 39\\nTr\", \"iggering validation manually .......................................................................\", \"...............................39\\nTriggering validation when properties change......................\", \"........................................................40\\nDisplaying validation errors ............\", \"........................................................................................ 40\\nHighligh\", \"ting a control that contains invalid data ..........................................................\", \"................41\\nDisplaying error messages .......................................................\", \"......................................................44\\nSummary ...................................\", \"............................................................................................ 45\\nConf\", \"iguration management ...............................................................................\", \"............ 46\\nCreating a settings class ..........................................................\", \"................................................ 46\\nAdding a setting ...............................\", \"...................................................................................... 47\\nData bindi\", \"ng to user settings ................................................................................\", \".................. 48\\nSummary ......................................................................\", \"......................................................... 50\\nContainerized microservices ...........\", \"................................................................................ 51\\nMicroservices ..\", \"....................................................................................................\", \"................... 52\\nContainerization ............................................................\", \"......................................................... 53\\nCommunication between client and micros\", \"ervices .................................................................. 55\\nCommunication between \", \"microservices .................................................................................. 56\\n\", \"Summary ............................................................................................\", \"................................... 58\\nAuthentication and authorization ............................\", \"...................................................... 59\\nAuthentication ...........................\", \"............................................................................................ 59\\nIssu\", \"ing bearer tokens using IdentityServer 4 ...........................................................\", \".....................60\\nAdding IdentityServer to a web application .................................\", \".................................................60\\nConfiguring IdentityServer .....................\", \".......................................................................................61\\niiPerformi\", \"ng authentication ..................................................................................\", \"..........................64\\nAuthorization .........................................................\", \"................................................................ 69\\nConfiguring IdentityServer to pe\", \"rform authorization ...................................................................70\\nMaking acc\", \"ess requests to APIs ...............................................................................\", \"......................71\\nSummary ...................................................................\", \"............................................................ 71\\nAccessing remote data ..............\", \"..................................................................................... 73\\nIntroductio\", \"n to Representational State Transfer................................................................\", \"...... 73\\nConsuming RESTful APIs ...................................................................\", \"...................................... 74\\nMaking web requests ......................................\", \"..............................................................................74\\nCaching data ......\", \"....................................................................................................\", \"................ 81\\nManaging data expiration .......................................................\", \"......................................................82\\nCaching images ............................\", \"..................................................................................................82\", \"\\nIncreasing resilience .............................................................................\", \".................................. 83\\nRetry pattern ................................................\", \".................................................................................83\\nCircuit breaker \", \"pattern ............................................................................................\", \"......................84\\nSummary ...................................................................\", \"............................................................ 85\\nUnit testing .......................\", \"............................................................................................. 86\\nDep\", \"endency injection and unit testing .................................................................\", \"................... 86\\nTesting MVVM applications ...................................................\", \"................................................. 87\\nTesting asynchronous functionality.............\", \"..................................................................................88\\nTesting INotify\", \"PropertyChanged implementations.....................................................................\", \"..88\\nTesting message-based communication ...........................................................\", \"............................89\\nTesting exception handling ..........................................\", \"..................................................................89\\nTesting validation ............\", \"....................................................................................................\", \"..........90\\nSummary ...............................................................................\", \"................................................ 91\\niiiPreface\\nPurpose\\nThis eBook provides guidance \", \"on building cross-platform enterprise apps using Xamarin.Forms.\\nXamarin.Forms is a cross-platform UI\", \" toolkit that allows developers to easily create native user\\ninterface layouts that can be shared ac\", \"ross platforms, including iOS, Android, and the Universal\\nWindows Platform (UWP). It provides a comp\", \"rehensive solution for Business to Employee (B2E),\\nBusiness to Business (B2B), and Business to Consu\", \"mer (B2C) apps, providing the ability to share code\\nacross all target platforms and helping to lower\", \" the total cost of ownership (TCO).\\nThe guide provides architectural guidance for developing adaptab\", \"le, maintainable, and testable\\nXamarin.Forms enterprise apps. Guidance is provided on how to impleme\", \"nt MVVM, dependency\\ninjection, navigation, validation, and configuration management, while maintaini\", \"ng loose coupling. In\\naddition, there's also guidance on performing authentication and authorization\", \" with IdentityServer,\\naccessing data from containerized microservices, and unit testing.\\nThe guide c\", \"omes with source code for the eShopOnContainers mobile app, and source code for the\\neShopOnContainer\", \"s reference app. The eShopOnContainers mobile app is a cross-platform enterprise\\napp developed using\", \" Xamarin.Forms, which connects to a series of containerized microservices known\\nas the eShopOnContai\", \"ners reference app. However, the eShopOnContainers mobile app can be\\nconfigured to consume data from\", \" mock services for those who wish to avoid deploying the\\ncontainerized microservices.\\nWhat's left ou\", \"t of this guide's scope\\nThis guide is aimed at readers who are already familiar with Xamarin.Forms. \", \"For a detailed\\nintroduction to Xamarin.Forms, see the Xamarin.Forms documentation on the Xamarin Dev\", \"eloper\\nCenter, and Creating Mobile Apps with Xamarin.Forms.\\nThe guide is complementary to .NET Micro\", \"services: Architecture for Containerized .NET Applications,\\nwhich focuses on developing and deployin\", \"g containerized microservices. Other guides worth reading\\ninclude Architecting and Developing Modern\", \" Web Applications with ASP.NET Core and Microsoft\\nAzure, Containerized Docker Application Lifecycle \", \"with Microsoft Platform and Tools, and Microsoft\\nPlatform and Tools for Mobile App Development.\\nWho \", \"should use this guide\\nThe audience for this guide is mainly developers and architects who would like\", \" to learn how to\\narchitect and implement cross-platform enterprise apps using Xamarin.Forms.\\niv Pref\", \"aceA secondary audience is technical decision makers who would like to receive an architectural and\\n\", \"technology overview before deciding on what approach to select for cross-platform enterprise app\\ndev\", \"elopment using Xamarin.Forms.\\nHow to use this guide\\nThis guide focuses on building cross-platform en\", \"terprise apps using Xamarin.Forms. As such, it should\\nbe read in its entirety to provide a foundatio\", \"n of understanding such apps and their technical\\nconsiderations. The guide, along with its sample ap\", \"p, can also serve as a starting point or reference for\\ncreating a new enterprise app. Use the associ\", \"ated sample app as a template for the new app, or to see\\nhow to organize an app's component parts. T\", \"hen, refer back to this guide for architectural guidance.\\nFeel free to forward this guide to team me\", \"mbers to help ensure a common understanding of cross-\\nplatform enterprise app development using Xama\", \"rin.Forms. Having everybody working from a\\ncommon set of terminologies and underlying principles wil\", \"l help ensure a consistent application of\\narchitectural patterns and practices.\\nv Preface1\\nCHAPTER\\nI\", \"ntroduction\\nRegardless of platform, developers of enterprise apps face several challenges:\\n\\u2022 App req\", \"uirements that can change over time.\\n\\u2022 New business opportunities and challenges.\\n\\u2022 Ongoing feedback\", \" during development that can significantly affect the scope and\\nrequirements of the app.\\nWith these \", \"in mind, it's important to build apps that can be easily modified or extended over time.\\nDesigning f\", \"or such adaptability can be difficult as it requires an architecture that allows individual\\nparts of\", \" the app to be independently developed and tested in isolation without affecting the rest of\\nthe app\", \".\\nMany enterprise apps are sufficiently complex to require more than one developer. It can be a\\nsign\", \"ificant challenge to decide how to design an app so that multiple developers can work effectively\\non\", \" different pieces of the app independently, while ensuring that the pieces come together seamlessly\\n\", \"when integrated into the app.\\nThe traditional approach to designing and building an app results in w\", \"hat is referred to as a\\nmonolithic app, where components are tightly coupled with no clear separatio\", \"n between them.\\nTypically, this monolithic approach leads to apps that are difficult and inefficient\", \" to maintain, because\\nit can be difficult to resolve bugs without breaking other components in the a\", \"pp, and it can be\\ndifficult to add new features or to replace existing features.\\nAn effective remedy\", \" for these challenges is to partition an app into discrete, loosely coupled\\ncomponents that can be e\", \"asily integrated together into an app. Such an approach offers several\\nbenefits:\\n\\u2022 It allows individ\", \"ual functionality to be developed, tested, extended, and maintained by\\ndifferent individuals or team\", \"s.\\n\\u2022 It promotes reuse and a clean separation of concerns between the app's horizontal\\ncapabilities,\", \" such as authentication and data access, and the vertical capabilities, such as app\\nspecific busines\", \"s functionality. This allows the dependencies and interactions between app\\ncomponents to be more eas\", \"ily managed.\\n\\u2022 It helps maintain a separation of roles by allowing different individuals, or teams, \", \"to focus on\\na specific task or piece of functionality according to their expertise. In particular, i\", \"t provides a\\ncleaner separation between the user interface and the app's business logic.\\nHowever, th\", \"ere are many issues that must be resolved when partitioning an app into discrete, loosely\\ncoupled co\", \"mponents. These include:\\n\\u2022 Deciding how to provide a clean separation of concerns between the user i\", \"nterface controls\\nand their logic. One of the most important decisions when creating a Xamarin.Forms\", \"\\nenterprise app is whether to place business logic in code-behind files, or whether to create a\\nclea\", \"n separation of concerns between the user interface controls and their logic, in order to\\n1 CHAPTER \", \"1 | Introductionmake the app more maintainable and testable. For more information, see Model-View-\\nV\", \"iewModel.\\n\\u2022 Determining whether to use a dependency injection container. Dependency injection\\ncontai\", \"ners reduce the dependency coupling between objects by providing a facility to\\nconstruct instances o\", \"f classes with their dependencies injected, and manage their lifetime\\nbased on the configuration of \", \"the container. For more information, see Dependency injection.\\n\\u2022 Choosing between platform provided \", \"eventing and loosely coupled message-based\\ncommunication between components that are inconvenient to\", \" link by object and type\\nreferences. For more information, see Introduction to Communicating between\", \" loosely\\ncoupled components.\\n\\u2022 Deciding how to navigate between pages, including how to invoke navig\", \"ation, and where\\nnavigation logic should reside. For more information, see Navigation.\\n\\u2022 Determining\", \" how to validate user input for correctness. The decision must include how to\\nvalidate user input, a\", \"nd how to notify the user about validation errors. For more information,\\nsee Validation.\\n\\u2022 Deciding \", \"how to perform authentication, and how to protect resources with authorization. For\\nmore information\", \", see Authentication and authorization.\\n\\u2022 Determining how to access remote data from web services, i\", \"ncluding how to reliably retrieve\\ndata, and how to cache data. For more information, see Accessing r\", \"emote data.\\n\\u2022 Deciding how to test the app. For more information, see Unit testing.\\nThis guide provi\", \"des guidance on these issues, and focuses on the core patterns and architecture for\\nbuilding a cross\", \"-platform enterprise app using Xamarin.Forms. The guidance aims to help to produce\\nadaptable, mainta\", \"inable, and testable code, by addressing common Xamarin.Forms enterprise app\\ndevelopment scenarios, \", \"and by separating the concerns of presentation, presentation logic, and\\nentities through support for\", \" the Model-View-ViewModel (MVVM) pattern.\\nSample application\\nThis guide includes a sample applicatio\", \"n, eShopOnContainers, that's an online store that includes the\\nfollowing functionality:\\n\\u2022 Authentica\", \"ting and authorizing against a backend service.\\n\\u2022 Browsing a catalog of shirts, coffee mugs, and oth\", \"er marketing items.\\n\\u2022 Filtering the catalog.\\n\\u2022 Ordering items from the catalog.\\n\\u2022 Viewing the user's\", \" order history.\\n\\u2022 Configuration of settings.\\nSample application architecture\\nFigure 1-1 provides a h\", \"igh-level overview of the architecture of the sample application.\\n2 CHAPTER 1 | IntroductionFigure 1\", \"-1: eShopOnContainers high-level architecture\\nThe sample application ships with three client apps:\\n\\u2022\", \" An MVC application developed with ASP.NET Core.\\n\\u2022 A Single Page Application (SPA) developed with An\", \"gular 2 and Typescript. This approach for\\nweb applications avoids performing a round-trip to the ser\", \"ver with each operation.\\n\\u2022 A mobile app developed with Xamarin.Forms, which supports iOS, Android, a\", \"nd the Universal\\nWindows Platform (UWP).\\nFor information about the web applications, see Architectin\", \"g and Developing Modern Web\\nApplications with ASP.NET Core and Microsoft Azure.\\nThe sample applicati\", \"on includes the following backend services:\\n\\u2022 An identity microservice, which uses ASP.NET Core Iden\", \"tity and IdentityServer.\\n\\u2022 A catalog microservice, which is a data-driven create, read, update, dele\", \"te (CRUD) service that\\nconsumes an SQL Server database using EntityFramework Core.\\n\\u2022 An ordering mic\", \"roservice, which is a domain-driven service that uses domain-driven design\\npatterns.\\n\\u2022 A basket micr\", \"oservice, which is a data-driven CRUD service that uses Redis Cache.\\nThese backend services are impl\", \"emented as microservices using ASP.NET Core MVC, and are\\ndeployed as unique containers within a sing\", \"le Docker host. Collectively, these backend services are\\nreferred to as the eShopOnContainers refere\", \"nce application. Client apps communicate with the\\nbackend services through a Representational State \", \"Transfer (REST) web interface. For more\\ninformation about microservices and Docker, see Containerize\", \"d microservices.\\nFor information about the implementation of the backend services, see .NET Microser\", \"vices:\\nArchitecture for Containerized .NET Applications.\\n3 CHAPTER 1 | IntroductionMobile app\\nThis g\", \"uide focuses on building cross-platform enterprise apps using Xamarin.Forms, and uses the\\neShopOnCon\", \"tainers mobile app as an example. Figure 1-2 shows the pages from the\\neShopOnContainers mobile app t\", \"hat provide the functionality outlined earlier.\\nFigure 1-2: The eShopOnContainers mobile app\\nThe mob\", \"ile app consumes the backend services provided by the eShopOnContainers reference\\napplication. Howev\", \"er, it can be configured to consume data from mock services for those who wish to\\navoid deploying th\", \"e backend services.\\nThe eShopOnContainers mobile app exercises the following Xamarin.Forms functiona\", \"lity:\\n\\u2022 XAML\\n\\u2022 Controls\\n\\u2022 Bindings\\n\\u2022 Converters\\n\\u2022 Styles\\n4 CHAPTER 1 | Introduction\\u2022 Animations\\n\\u2022 Co\", \"mmands\\n\\u2022 Behaviors\\n\\u2022 Triggers\\n\\u2022 Effects\\n\\u2022 Custom Renderers\\n\\u2022 MessagingCenter\\n\\u2022 Custom Controls\\nFor m\", \"ore information about this functionality, see the Xamarin.Forms documentation on the Xamarin\\nDevelop\", \"er Center, and Creating Mobile Apps with Xamarin.Forms.\\nIn addition, unit tests are provided for som\", \"e of the classes in the eShopOnContainers mobile app.\\nMobile app solution\\nThe eShopOnContainers mobi\", \"le app solution organizes the source code and other resources into\\nprojects. All of the projects use\", \" folders to organize the source code and other resources into\\ncategories. The following table outlin\", \"es the projects that make up the eShopOnContainers mobile\\napp:\\nProject Description\\neShopOnContainers\", \".Core This project is the portable class library (PCL) project\\nthat contains the shared code and sha\", \"red UI.\\neShopOnContainers.Droid This project holds Android specific code and is the\\nentry point for \", \"the Android app.\\neShopOnContainers.iOS This project holds iOS specific code and is the entry\\npoint f\", \"or the iOS app.\\neShopOnContainers.UWP This project holds Universal Windows Platform (UWP)\\nspecific c\", \"ode and is the entry point for the Windows\\napp.\\neShopOnContainers.TestRunner.Droid This project is t\", \"he Android test runner for the\\neShopOnContainers.UnitTests project.\\neShopOnContainers.TestRunner.iOS\", \" This project is the iOS test runner for the\\neShopOnContainers.UnitTests project.\\neShopOnContainers.\", \"TestRunner.Windows This project is the Universal Windows Platform test\\nrunner for the eShopOnContain\", \"ers.UnitTests project.\\neShopOnContainers.UnitTests This project contains unit tests for the\\neShopOnC\", \"ontainers.Core project.\\nThe classes from the eShopOnContainers mobile app can be re-used in any Xama\", \"rin.Forms app with\\nlittle or no modification.\\neShopOnContainers.Core project\\nThe eShopOnContainers.C\", \"ore PCL project contains the following folders:\\n5 CHAPTER 1 | IntroductionFolder Description\\nAnimati\", \"ons Contains classes that enable animations to be consumed in XAML.\\nBehaviors Contains behaviors tha\", \"t are exposed to view classes.\\nControls Contains custom controls used by the app.\\nConverters Contain\", \"s value converters that apply custom logic to a binding.\\nEffects Contains the EntryLineColorEffect c\", \"lass, which is used to change the border\\ncolor of specific Entry controls.\\nExceptions Contains the c\", \"ustom ServiceAuthenticationException.\\nExtensions Contains extension methods for the VisualElement an\", \"d IEnumerable<T> classes.\\nHelpers Contains helper classes for the app.\\nModels Contains the model cla\", \"sses for the app.\\nProperties Contains AssemblyInfo.cs, a .NET assembly metadata file.\\nServices Conta\", \"ins interfaces and classes that implement services that are provided to the\\napp.\\nTriggers Contains t\", \"he BeginAnimation trigger, which is used to invoke an animation in\\nXAML.\\nValidations Contains classe\", \"s involved in validating data input.\\nViewModels Contains the application logic that's exposed to pag\", \"es.\\nViews Contains the pages for the app.\\nPlatform projects\\nThe platform projects contain effect imp\", \"lementations, custom renderer implementations, and other\\nplatform-specific resources.\\nSummary\\nXamari\", \"n's cross-platform mobile app development tools and platforms provide a comprehensive\\nsolution for B\", \"2E, B2B, and B2C mobile client apps, providing the ability to share code across all target\\nplatforms\", \" (iOS, Android, and Windows) and helping to lower the total cost of ownership. Apps can\\nshare their \", \"user interface and app logic code, while retaining the native platform look and feel.\\nDevelopers of \", \"enterprise apps face several challenges that can alter the architecture of the app during\\ndevelopmen\", \"t. Therefore, it's important to build an app so that it can be modified or extended over\\ntime. Desig\", \"ning for such adaptability can be difficult, but typically involves partitioning an app into\\ndiscret\", \"e, loosely coupled components that can be easily integrated together into an app.\\n6 CHAPTER 1 | Intr\", \"oduction2\\nCHAPTER\\nMVVM\\nThe Xamarin.Forms developer experience typically involves creating a user int\", \"erface in XAML, and then\\nadding code-behind that operates on the user interface. As apps are modifie\", \"d, and grow in size and\\nscope, complex maintenance issues can arise. These issues include the tight \", \"coupling between the UI\\ncontrols and the business logic, which increases the cost of making UI modif\", \"ications, and the difficulty\\nof unit testing such code.\\nThe Model-View-ViewModel (MVVM) pattern help\", \"s to cleanly separate the business and presentation\\nlogic of an application from its user interface \", \"(UI). Maintaining a clean separation between application\\nlogic and the UI helps to address numerous \", \"development issues and can make an application easier\\nto test, maintain, and evolve. It can also gre\", \"atly improve code re-use opportunities and allows\\ndevelopers and UI designers to more easily collabo\", \"rate when developing their respective parts of an\\napp.\\nThe MVVM pattern\\nThere are three core compone\", \"nts in the MVVM pattern: the model, the view, and the view model.\\nEach serves a distinct purpose. Fi\", \"gure 2-1 shows the relationships between the three components.\\nFigure 2-1: The MVVM pattern\\nIn addit\", \"ion to understanding the responsibilities of each components, it's also important to\\nunderstand how \", \"they interact with each other. At a high level, the view \\\"knows about\\\" the view model,\\nand the view \", \"model \\\"knows about\\\" the model, but the model is unaware of the view model, and the\\nview model is una\", \"ware of the view. Therefore, the view model isolates the view from the model, and\\nallows the model t\", \"o evolve independently of the view.\\nThe benefits of using the MVVM pattern are as follows:\\n\\u2022 If ther\", \"e's an existing model implementation that encapsulates existing business logic, it can\\nbe difficult \", \"or risky to change it. In this scenario, the view model acts as an adapter for the\\nmodel classes and\", \" enables you to avoid making any major changes to the model code.\\n7 CHAPTER 2 | MVVM\\u2022 Developers can\", \" create unit tests for the view model and the model, without using the view.\\nThe unit tests for the \", \"view model can exercise exactly the same functionality as used by the\\nview.\\n\\u2022 The app UI can be rede\", \"signed without touching the code, provided that the view is\\nimplemented entirely in XAML. Therefore,\", \" a new version of the view should work with the\\nexisting view model.\\n\\u2022 Designers and developers can \", \"work independently and concurrently on their components\\nduring the development process. Designers ca\", \"n focus on the view, while developers can work\\non the view model and model components.\\nThe key to us\", \"ing MVVM effectively lies in understanding how to factor app code into the correct\\nclasses, and in u\", \"nderstanding how the classes interact. The following sections discuss the\\nresponsibilities of each o\", \"f the classes in the MVVM pattern.\\nView\\nThe view is responsible for defining the structure, layout, \", \"and appearance of what the user sees on\\nscreen. Ideally, each view is defined in XAML, with a limite\", \"d code-behind that does not contain\\nbusiness logic. However, in some cases, the code-behind might co\", \"ntain UI logic that implements\\nvisual behavior that is difficult to express in XAML, such as animati\", \"ons.\\nIn a Xamarin.Forms application, a view is typically a Page-derived or ContentView-derived class\", \".\\nHowever, views can also be represented by a data template, which specifies the UI elements to be\\nu\", \"sed to visually represent an object when it's displayed. A data template as a view does not have any\", \"\\ncode-behind, and is designed to bind to a specific view model type.\\nTip: Avoid enabling and disabli\", \"ng UI elements in the code-behind\\nEnsure that view models are responsible for defining logical state\", \" changes that affect some aspects\\nof the view's display, such as whether a command is available, or \", \"an indication that an operation is\\npending. Therefore, enable and disable UI elements by binding to \", \"view model properties, rather\\nthan enabling and disabling them in code-behind.\\nThere are several opt\", \"ions for executing code on the view model in response to interactions on the\\nview, such as a button \", \"click or item selection. If a control supports commands, the control's Command\\nproperty can be data-\", \"bound to an ICommand property on the view model. When the control's\\ncommand is invoked, the code in \", \"the view model will be executed. In addition to commands,\\nbehaviors can be attached to an object in \", \"the view and can listen for either a command to be invoked\\nor event to be raised. In response, the b\", \"ehavior can then invoke an ICommand on the view model or a\\nmethod on the view model.\\nViewModel\\nThe v\", \"iew model implements properties and commands to which the view can data bind to, and\\nnotifies the vi\", \"ew of any state changes through change notification events. The properties and\\ncommands that the vie\", \"w model provides define the functionality to be offered by the UI, but the view\\ndetermines how that \", \"functionality is to be displayed.\\nTip: Keep the UI responsive with asynchronous operations\\nMobile ap\", \"ps should keep the UI thread unblocked to improve the user's perception of\\nperformance. Therefore, i\", \"n the view model, use asynchronous methods for I/O operations and raise\\nevents to asynchronously not\", \"ify views of property changes.\\n8 CHAPTER 2 | MVVMThe view model is also responsible for coordinating\", \" the view's interactions with any model classes that\\nare required. There's typically a one-to-many r\", \"elationship between the view model and the model\\nclasses. The view model might choose to expose mode\", \"l classes directly to the view so that controls in\\nthe view can data bind directly to them. In this \", \"case, the model classes will need to be designed to\\nsupport data binding and change notification eve\", \"nts.\\nEach view model provides data from a model in a form that the view can easily consume. To\\naccom\", \"plish this, the view model sometimes performs data conversion. Placing this data conversion in\\nthe v\", \"iew model is a good idea because it provides properties that the view can bind to. For example,\\nthe \", \"view model might combine the values of two properties to make it easier for display by the view.\\nTip\", \": Centralize data conversions in a conversion layer\\nIt's also possible to use converters as a separa\", \"te data conversion layer that sits between the view\\nmodel and the view. This can be necessary, for e\", \"xample, when data requires special formatting that\\nthe view model doesn't provide.\\nIn order for the \", \"view model to participate in two-way data binding with the view, its properties must\\nraise the Prope\", \"rtyChanged event. View models satisfy this requirement by implementing the\\nINotifyPropertyChanged in\", \"terface, and raising the PropertyChanged event when a property is\\nchanged.\\nFor collections, the view\", \"-friendly ObservableCollection<T> is provided. This collection implements\\ncollection changed notific\", \"ation, relieving the developer from having to implement the\\nINotifyCollectionChanged interface on co\", \"llections.\\nModel\\nModel classes are non-visual classes that encapsulate the app's data. Therefore, th\", \"e model can be\\nthought of as representing the app's domain model, which usually includes a data mode\", \"l along with\\nbusiness and validation logic. Examples of model objects include data transfer objects \", \"(DTOs), Plain\\nOld CLR Objects (POCOs), and generated entity and proxy objects.\\nModel classes are typ\", \"ically used in conjunction with services or repositories that encapsulate data\\naccess and caching.\\nC\", \"onnecting view models to views\\nView models can be connected to views by using the data-binding capab\", \"ilities of Xamarin.Forms.\\nThere are many approaches that can be used to construct views and view mod\", \"els and associate them\\nat runtime. These approaches fall into two categories, known as view first co\", \"mposition, and view\\nmodel first composition. Choosing between view first composition and view model \", \"first composition is\\nan issue of preference and complexity. However, all approaches share the same a\", \"im, which is for the\\nview to have a view model assigned to its BindingContext property.\\nWith view fi\", \"rst composition the app is conceptually composed of views that connect to the view\\nmodels they depen\", \"d on. The primary benefit of this approach is that it makes it easy to construct\\nloosely coupled, un\", \"it testable apps because the view models have no dependence on the views\\nthemselves. It's also easy \", \"to understand the structure of the app by following its visual structure,\\nrather than having to trac\", \"k code execution to understand how classes are created and associated. In\\naddition, view first const\", \"ruction aligns with the Xamarin.Forms navigation system that's responsible\\nfor constructing pages wh\", \"en navigation occurs, which makes a view model first composition complex\\nand misaligned with the pla\", \"tform.\\n9 CHAPTER 2 | MVVMWith view model first composition the app is conceptually composed of view \", \"models, with a service\\nbeing responsible for locating the view for a view model. View model first co\", \"mposition feels more\\nnatural to some developers, since the view creation can be abstracted away, all\", \"owing them to focus\\non the logical non-UI structure of the app. In addition, it allows view models t\", \"o be created by other\\nview models. However, this approach is often complex and it can become difficu\", \"lt to understand how\\nthe various parts of the app are created and associated.\\nTip: Keep view models \", \"and views independent\\nThe binding of views to a property in a data source should be the view's princ\", \"ipal dependency on\\nits corresponding view model. Specifically, don't reference view types, such as B\", \"utton and\\nListView, from view models. By following the principles outlined here, view models can be \", \"tested\\nin isolation, therefore reducing the likelihood of software defects by limiting scope.\\nThe fo\", \"llowing sections discuss the main approaches to connecting view models to views.\\nCreating a view mod\", \"el declaratively\\nThe simplest approach is for the view to declaratively instantiate its correspondin\", \"g view model in\\nXAML. When the view is constructed, the corresponding view model object will also be\", \" constructed.\\nThis approach is demonstrated in the following code example:\\n<ContentPage ... xmlns:lo\", \"cal=\\\"clr-namespace:eShop\\\">\\n<ContentPage.BindingContext>\\n<local:LoginViewModel />\\n</ContentPage.Bindi\", \"ngContext>\\n...\\n</ContentPage>\\nWhen the ContentPage is created, an instance of the LoginViewModel is \", \"automatically constructed\\nand set as the view's BindingContext.\\nThis declarative construction and as\", \"signment of the view model by the view has the advantage that\\nit's simple, but has the disadvantage \", \"that it requires a default (parameter-less) constructor in the view\\nmodel.\\nCreating a view model pro\", \"grammatically\\nA view can have code in the code-behind file that results in the view model being assi\", \"gned to its\\nBindingContext property. This is often accomplished in the view's constructor, as shown \", \"in the\\nfollowing code example:\\npublic LoginView()\\n{\\nInitializeComponent();\\nBindingContext = new Logi\", \"nViewModel(navigationService);\\n}\\nThe programmatic construction and assignment of the view model with\", \"in the view's code-behind has\\nthe advantage that it's simple. However, the main disadvantage of this\", \" approach is that the view\\nneeds to provide the view model with any required dependencies. Using a d\", \"ependency injection\\ncontainer can help to maintain loose coupling between the view and view model. F\", \"or more\\ninformation, see Dependency injection.\\n10 CHAPTER 2 | MVVMCreating a view defined as a data \", \"template\\nA view can be defined as a data template and associated with a view model type. Data templa\", \"tes can\\nbe defined as resources, or they can be defined inline within the control that will display \", \"the view\\nmodel. The content of the control is the view model instance, and the data template is used\", \" to visually\\nrepresent it. This technique is an example of a situation in which the view model is in\", \"stantiated first,\\nfollowed by the creation of the view.\\nAutomatically creating a view model with a v\", \"iew model locator\\nA view model locator is a custom class that manages the instantiation of view mode\", \"ls and their\\nassociation to views. In the eShopOnContainers mobile app, the ViewModelLocator class h\", \"as an\\nattached property, AutoWireViewModel, that's used to associate view models with views. In the \", \"view's\\nXAML, this attached property is set to true to indicate that the view model should be automat\", \"ically\\nconnected to the view, as shown in the following code example:\\nviewModelBase:ViewModelLocator\", \".AutoWireViewModel=\\\"true\\\"\\nThe AutoWireViewModel property is a bindable property that's initialized t\", \"o false, and when its\\nvalue changes the OnAutoWireViewModelChanged event handler is called. This met\", \"hod resolves the\\nview model for the view. The following code example shows how this is achieved:\\npri\", \"vate static void OnAutoWireViewModelChanged(BindableObject bindable, object oldValue, object n\\newVal\", \"ue)\\n{\\nvar view = bindable as Element;\\nif (view == null)\\n{\\nreturn;\\n}\\nvar viewType = view.GetType();\\nv\", \"ar viewName = viewType.FullName.Replace(\\\".Views.\\\", \\\".ViewModels.\\\");\\nvar viewAssemblyName = viewType.\", \"GetTypeInfo().Assembly.FullName;\\nvar viewModelName = string.Format(\\nCultureInfo.InvariantCulture, \\\"{\", \"0}Model, {1}\\\", viewName, viewAssemblyName);\\nvar viewModelType = Type.GetType(viewModelName);\\nif (vie\", \"wModelType == null)\\n{\\nreturn;\\n}\\nvar viewModel = _container.Resolve(viewModelType);\\nview.BindingConte\", \"xt = viewModel;\\n}\\nThe OnAutoWireViewModelChanged method attempts to resolve the view model using a c\", \"onvention-\\nbased approach. This convention assumes that:\\n\\u2022 View models are in the same assembly as v\", \"iew types.\\n\\u2022 Views are in a .Views child namespace.\\n\\u2022 View models are in a .ViewModels child namespa\", \"ce.\\n\\u2022 View model names correspond with view names and end with \\\"ViewModel\\\".\\n11 CHAPTER 2 | MVVMFinal\", \"ly, the OnAutoWireViewModelChanged method sets the BindingContext of the view type to the\\nresolved v\", \"iew model type. For more information about resolving the view model type, see Resolution.\\nThis appro\", \"ach has the advantage that an app has a single class that is responsible for the instantiation\\nof vi\", \"ew models and their connection to views.\\nTip: Use a view model locator for ease of substitution\\nA vi\", \"ew model locator can also be used as a point of substitution for alternate implementations of\\ndepend\", \"encies, such as for unit testing or design time data.\\nUpdating views in response to changes in the\\nu\", \"nderlying view model or model\\nAll view model and model classes that are accessible to a view should \", \"implement the\\nINotifyPropertyChanged interface. Implementing this interface in a view model or model\", \" class\\nallows the class to provide change notifications to any data-bound controls in the view when \", \"the\\nunderlying property value changes.\\nApp's should be architected for the correct use of property c\", \"hange notification, by meeting the\\nfollowing requirements:\\n\\u2022 Always raising a PropertyChanged event \", \"if a public property's value changes. Do not assume\\nthat raising the PropertyChanged event can be ig\", \"nored because of knowledge of how XAML\\nbinding occurs.\\n\\u2022 Always raising a PropertyChanged event for \", \"any calculated properties whose values are used\\nby other properties in the view model or model.\\n\\u2022 Al\", \"ways raising the PropertyChanged event at the end of the method that makes a property\\nchange, or whe\", \"n the object is known to be in a safe state. Raising the event interrupts the\\noperation by invoking \", \"the event's handlers synchronously. If this happens in the middle of an\\noperation, it might expose t\", \"he object to callback functions when it is in an unsafe, partially\\nupdated state. In addition, it's \", \"possible for cascading changes to be triggered by\\nPropertyChanged events. Cascading changes generall\", \"y require updates to be complete\\nbefore the cascading change is safe to execute.\\n\\u2022 Never raising a P\", \"ropertyChanged event if the property does not change. This means that you\\nmust compare the old and n\", \"ew values before raising the PropertyChanged event.\\n\\u2022 Never raising the PropertyChanged event during\", \" a view model's constructor if you are\\ninitializing a property. Data-bound controls in the view will\", \" not have subscribed to receive\\nchange notifications at this point.\\n\\u2022 Never raising more than one Pr\", \"opertyChanged event with the same property name\\nargument within a single synchronous invocation of a\", \" public method of a class. For example,\\ngiven a NumberOfItems property whose backing store is the _n\", \"umberOfItems field, if a\\nmethod increments _numberOfItems fifty times during the execution of a loop\", \", it should only\\nraise property change notification on the NumberOfItems property once, after all th\", \"e work is\\ncomplete. For asynchronous methods, raise the PropertyChanged event for a given property\\nn\", \"ame in each synchronous segment of an asynchronous continuation chain.\\nThe eShopOnContainers mobile \", \"app uses the ExtendedBindableObject class to provide change\\nnotifications, which is shown in the fol\", \"lowing code example:\\n12 CHAPTER 2 | MVVMpublic abstract class ExtendedBindableObject : BindableObjec\", \"t\\n{\\npublic void RaisePropertyChanged<T>(Expression<Func<T>> property)\\n{\\nvar name = GetMemberInfo(pro\", \"perty).Name;\\nOnPropertyChanged(name);\\n}\\nprivate MemberInfo GetMemberInfo(Expression expression)\\n{\\n..\", \".\\n}\\n}\\nXamarin.Form's BindableObject class implements the INotifyPropertyChanged interface, and\\nprovi\", \"des an OnPropertyChanged method. The ExtendedBindableObject class provides the\\nRaisePropertyChanged \", \"method to invoke property change notification, and in doing so uses the\\nfunctionality provided by th\", \"e BindableObject class.\\nEach view model class in the eShopOnContainers mobile app derives from the V\", \"iewModelBase class,\\nwhich in turn derives from the ExtendedBindableObject class. Therefore, each vie\", \"w model class uses\\nthe RaisePropertyChanged method in the ExtendedBindableObject class to provide pr\", \"operty\\nchange notification. The following code example shows how the eShopOnContainers mobile app\\nin\", \"vokes property change notification by using a lambda expression:\\npublic bool IsLogin\\n{\\nget\\n{\\nreturn \", \"_isLogin;\\n}\\nset\\n{\\n_isLogin = value;\\nRaisePropertyChanged(() => IsLogin);\\n}\\n}\\nNote that using a lambd\", \"a expression in this way involves a small performance cost because the\\nlambda expression has to be e\", \"valuated for each call. Although the performance cost is small and\\nwould not normally impact an app,\", \" the costs can accrue when there are many change notifications.\\nHowever, the benefit of this approac\", \"h is that it provides compile-time type safety and refactoring\\nsupport when renaming properties.\\nUI \", \"interaction using commands and behaviors\\nIn mobile apps, actions are typically invoked in response t\", \"o a user action, such as a button click, that\\ncan be implemented by creating an event handler in the\", \" code-behind file. However, in the MVVM\\npattern, the responsibility for implementing the action lies\", \" with the view model, and placing code in\\nthe code-behind should be avoided.\\nCommands provide a conv\", \"enient way to represent actions that can be bound to controls in the UI.\\nThey encapsulate the code t\", \"hat implements the action, and help to keep it decoupled from its visual\\nrepresentation in the view.\", \" Xamarin.Forms includes controls that can be declaratively connected to a\\ncommand, and these control\", \"s will invoke the command when the user interacts with the control.\\n13 CHAPTER 2 | MVVMBehaviors als\", \"o allow controls to be declaratively connected to a command. However, behaviors can be\\nused to invok\", \"e an action that's associated with a range of events raised by a control. Therefore,\\nbehaviors addre\", \"ss many of the same scenarios as command-enabled controls, while providing a\\ngreater degree of flexi\", \"bility and control. In addition, behaviors can also be used to associate command\\nobjects or methods \", \"with controls that were not specifically designed to interact with commands.\\nImplementing commands\\nV\", \"iew models typically expose command properties, for binding from the view, that are object\\ninstances\", \" that implement the ICommand interface. A number of Xamarin.Forms controls provide a\\nCommand propert\", \"y, which can be data bound to an ICommand object provided by the view model. The\\nICommand interface \", \"defines an Execute method, which encapsulates the operation itself, a\\nCanExecute method, which indic\", \"ates whether the command can be invoked, and a\\nCanExecuteChanged event that occurs when changes occu\", \"r that affect whether the command should\\nexecute. The Command and Command<T> classes, provided by Xa\", \"marin.Forms, implement the ICommand\\ninterface, where T is the type of the arguments to Execute and C\", \"anExecute.\\nWithin a view model, there should be an object of type Command or Command<T> for each pub\", \"lic\\nproperty in the view model of type ICommand. The Command or Command<T> constructor requires an\\nA\", \"ction callback object that's called when the ICommand.Execute method is invoked. The\\nCanExecute meth\", \"od is an optional constructor parameter, and is a Func that returns a bool.\\nThe following code shows\", \" how a Command instance, which represents a register command, is\\nconstructed by specifying a delegat\", \"e to the Register view model method:\\npublic ICommand RegisterCommand => new Command(Register);\\nThe c\", \"ommand is exposed to the view through a property that returns a reference to an ICommand.\\nWhen the E\", \"xecute method is called on the Command object, it simply forwards the call to the method\\nin the view\", \" model via the delegate that was specified in the Command constructor.\\nAn asynchronous method can be\", \" invoked by a command by using the async and await keywords\\nwhen specifying the command's Execute de\", \"legate. This indicates that the callback is a Task and\\nshould be awaited. For example, the following\", \" code shows how a Command instance, which represents\\na sign-in command, is constructed by specifying\", \" a delegate to the SignInAsync view model method:\\npublic ICommand SignInCommand => new Command(async\", \" () => await SignInAsync());\\nParameters can be passed to the Execute and CanExecute actions by using\", \" the Command<T> class to\\ninstantiate the command. For example, the following code shows how a Comman\", \"d<T> instance is used\\nto indicate that the NavigateAsync method will require an argument of type str\", \"ing:\\npublic ICommand NavigateCommand => new Command<string>(NavigateAsync);\\nIn both the Command and \", \"Command<T> classes, the delegate to the CanExecute method in each\\nconstructor is optional. If a dele\", \"gate isn't specified, the Command will return true for CanExecute.\\nHowever, the view model can indic\", \"ate a change in the command's CanExecute status by calling the\\nChangeCanExecute method on the Comman\", \"d object. This causes the CanExecuteChanged event to be\\nraised. Any controls in the UI that are boun\", \"d to the command will then update their enabled status to\\nreflect the availability of the data-bound\", \" command.\\n14 CHAPTER 2 | MVVMInvoking commands from a view\\nThe following code example shows how a Gr\", \"id in the LoginView binds to the RegisterCommand in\\nthe LoginViewModel class by using a TapGestureRe\", \"cognizer instance:\\n<Grid Grid.Column=\\\"1\\\" HorizontalOptions=\\\"Center\\\">\\n<Label Text=\\\"REGISTER\\\" TextColo\", \"r=\\\"Gray\\\"/>\\n<Grid.GestureRecognizers>\\n<TapGestureRecognizer Command=\\\"{Binding RegisterCommand}\\\" Numbe\", \"rOfTapsRequired=\\\"1\\\" />\\n</Grid.GestureRecognizers>\\n</Grid>\\nA command parameter can also be optionally\", \" defined using the CommandParameter property. The\\ntype of the expected argument is specified in the \", \"Execute and CanExecute target methods. The\\nTapGestureRecognizer will automatically invoke the target\", \" command when the user interacts with\\nthe attached control. The command parameter, if provided, will\", \" be passed as the argument to the\\ncommand's Execute delegate.\\nImplementing behaviors\\nBehaviors allow\", \" functionality to be added to UI controls without having to subclass them. Instead, the\\nfunctionalit\", \"y is implemented in a behavior class and attached to the control as if it was part of the\\ncontrol it\", \"self. Behaviors enable you to implement code that you would normally have to write as\\ncode-behind, b\", \"ecause it directly interacts with the API of the control, in such a way that it can be\\nconcisely att\", \"ached to the control, and packaged for reuse across more than one view or app. In the\\ncontext of MVV\", \"M, behaviors are a useful approach for connecting controls to commands.\\nA behavior that's attached t\", \"o a control through attached properties is known as an attached behavior.\\nThe behavior can then use \", \"the exposed API of the element to which it is attached to add functionality\\nto that control, or othe\", \"r controls, in the visual tree of the view. The eShopOnContainers mobile app\\ncontains the LineColorB\", \"ehavior class, which is an attached behavior. For more information about\\nthis behavior, see Displayi\", \"ng validation errors.\\nA Xamarin.Forms behavior is a class that derives from the Behavior or Behavior\", \"<T> class, where T is\\nthe type of the control to which the behavior should apply. These classes prov\", \"ide OnAttachedTo and\\nOnDetachingFrom methods, which should be overridden to provide logic that will \", \"be executed when\\nthe behavior is attached to and detached from controls.\\nIn the eShopOnContainers mo\", \"bile app, the BindableBehavior<T> class derives from the\\nBehavior<T> class. The purpose of the Binda\", \"bleBehavior<T> class is to provide a base class for\\nXamarin.Forms behaviors that require the Binding\", \"Context of the behavior to be set to the attached\\ncontrol.\\nThe BindableBehavior<T> class provides an\", \" overridable OnAttachedTo method that sets the\\nBindingContext of the behavior, and an overridable On\", \"DetachingFrom method that cleans up the\\nBindingContext. In addition, the class stores a reference to\", \" the attached control in the\\nAssociatedObject property.\\nThe eShopOnContainers mobile app includes an\", \" EventToCommandBehavior class, which executes a\\ncommand in response to an event occurring. This clas\", \"s derives from the BindableBehavior<View>\\nclass so that the behavior can bind to and execute an ICom\", \"mand specified by a Command property\\nwhen the behavior is consumed. The following code example shows\", \" the EventToCommandBehavior\\nclass:\\n15 CHAPTER 2 | MVVMpublic class EventToCommandBehavior : Bindable\", \"Behavior<View>\\n{\\n...\\nprotected override void OnAttachedTo(View visualElement)\\n{\\nbase.OnAttachedTo(vi\", \"sualElement);\\nvar events = AssociatedObject.GetType().GetRuntimeEvents().ToArray();\\nif (events.Any()\", \")\\n{\\n_eventInfo = events.FirstOrDefault(e => e.Name == EventName);\\nif (_eventInfo == null)\\nthrow new \", \"ArgumentException(string.Format(\\n\\\"EventToCommand: Can't find any event named '{0}' on attached type\\\"\", \",\\nEventName));\\nAddEventHandler(_eventInfo, AssociatedObject, OnFired);\\n}\\n}\\nprotected override void O\", \"nDetachingFrom(View view)\\n{\\nif (_handler != null)\\n_eventInfo.RemoveEventHandler(AssociatedObject, _h\", \"andler);\\nbase.OnDetachingFrom(view);\\n}\\nprivate void AddEventHandler(\\nEventInfo eventInfo, object ite\", \"m, Action<object, EventArgs> action)\\n{\\n...\\n}\\nprivate void OnFired(object sender, EventArgs eventArgs\", \")\\n{\\n...\\n}\\n}\\nThe OnAttachedTo and OnDetachingFrom methods are used to register and deregister an even\", \"t\\nhandler for the event defined in the EventName property. Then, when the event fires, the OnFired\\nm\", \"ethod is invoked, which executes the command.\\nThe advantage of using the EventToCommandBehavior to e\", \"xecute a command when an event fires, is\\nthat commands can be associated with controls that weren't \", \"designed to interact with commands. In\\naddition, this moves event-handling code to view models, wher\", \"e it can be unit tested.\\nInvoking behaviors from a view\\nThe EventToCommandBehavior is particularly u\", \"seful for attaching a command to a control that\\ndoesn't support commands. For example, the ProfileVi\", \"ew uses the EventToCommandBehavior to\\nexecute the OrderDetailCommand when the ItemTapped event fires\", \" on the ListView that lists the\\nuser's orders, as shown in the following code:\\n<ListView>\\n<ListView.\", \"Behaviors>\\n<behaviors:EventToCommandBehavior\\nEventName=\\\"ItemTapped\\\"\\nCommand=\\\"{Binding OrderDetailCom\", \"mand}\\\"\\nEventArgsConverter=\\\"{StaticResource ItemTappedEventArgsConverter}\\\" />\\n16 CHAPTER 2 | MVVM</Li\", \"stView.Behaviors>\\n...\\n</ListView>\\nAt runtime, the EventToCommandBehavior will respond to interaction\", \" with the ListView. When an\\nitem is selected in the ListView, the ItemTapped event will fire, which \", \"will execute the\\nOrderDetailCommand in the ProfileViewModel. By default, the event arguments for the\", \" event are\\npassed to the command. This data is converted as it's passed between source and target by\", \" the\\nconverter specified in the EventArgsConverter property, which returns the Item of the ListView\\n\", \"from the ItemTappedEventArgs. Therefore, when the OrderDetailCommand is executed, the selected\\nOrder\", \" is passed as a parameter to the registered Action.\\nFor more information about behaviors, see Behavi\", \"ors on the Xamarin Developer Center.\\nSummary\\nThe Model-View-ViewModel (MVVM) pattern helps to cleanl\", \"y separate the business and presentation\\nlogic of an application from its user interface (UI). Maint\", \"aining a clean separation between application\\nlogic and the UI helps to address numerous development\", \" issues and can make an application easier\\nto test, maintain, and evolve. It can also greatly improv\", \"e code re-use opportunities and allows\\ndevelopers and UI designers to more easily collaborate when d\", \"eveloping their respective parts of an\\napp.\\nUsing the MVVM pattern, the UI of the app and the underl\", \"ying presentation and business logic is\\nseparated into three separate classes: the view, which encap\", \"sulates the UI and UI logic; the view\\nmodel, which encapsulates presentation logic and state; and th\", \"e model, which encapsulates the app's\\nbusiness logic and data.\\n17 CHAPTER 2 | MVVM3\\nCHAPTER\\nDependen\", \"cy\\ninjection\\nTypically, a class constructor is invoked when instantiating an object, and any values \", \"that the object\\nneeds are passed as arguments to the constructor. This is an example of dependency i\", \"njection, and\\nspecifically is known as constructor injection. The dependencies the object needs are \", \"injected into the\\nconstructor.\\nBy specifying dependencies as interface types, dependency injection e\", \"nables decoupling of the\\nconcrete types from the code that depends on these types. It generally uses\", \" a container that holds a\\nlist of registrations and mappings between interfaces and abstract types, \", \"and the concrete types that\\nimplement or extend these types.\\nThere are also other types of dependenc\", \"y injection, such as property setter injection, and method call\\ninjection, but they are less commonl\", \"y seen. Therefore, this chapter will focus solely on performing\\nconstructor injection with a depende\", \"ncy injection container.\\nIntroduction to dependency injection\\nDependency injection is a specialized \", \"version of the Inversion of Control (IoC) pattern, where the\\nconcern being inverted is the process o\", \"f obtaining the required dependency. With dependency\\ninjection, another class is responsible for inj\", \"ecting dependencies into an object at runtime. The\\nfollowing code example shows how the ProfileViewM\", \"odel class is structured when using\\ndependency injection:\\npublic class ProfileViewModel : ViewModelB\", \"ase\\n{\\nprivate IOrderService _orderService;\\npublic ProfileViewModel(IOrderService orderService)\\n{\\n_or\", \"derService = orderService;\\n}\\n...\\n}\\nThe ProfileViewModel constructor receives an IOrderService instan\", \"ce as an argument, injected by\\nanother class. The only dependency in the ProfileViewModel class is o\", \"n the interface type.\\nTherefore, the ProfileViewModel class doesn't have any knowledge of the class \", \"that's responsible for\\ninstantiating the IOrderService object. The class that's responsible for inst\", \"antiating the\\n18 CHAPTER 3 | Dependency injectionIOrderService object, and inserting it into the Pro\", \"fileViewModel class, is known as the dependency\\ninjection container.\\nDependency injection containers\", \" reduce the coupling between objects by providing a facility to\\ninstantiate class instances and mana\", \"ge their lifetime based on the configuration of the container.\\nDuring the objects creation, the cont\", \"ainer injects any dependencies that the object requires into it. If\\nthose dependencies have not yet \", \"been created, the container creates and resolves their dependencies\\nfirst.\\nNote: Dependency injectio\", \"n can also be implemented manually using factories. However, using a\\ncontainer provides additional c\", \"apabilities such as lifetime management, and registration through\\nassembly scanning.\\nThere are sever\", \"al advantages to using a dependency injection container:\\n\\u2022 A container removes the need for a class \", \"to locate its dependencies and manage their\\nlifetimes.\\n\\u2022 A container allows mapping of implemented d\", \"ependencies without affecting the class.\\n\\u2022 A container facilitates testability by allowing dependenc\", \"ies to be mocked.\\n\\u2022 A container increases maintainability by allowing new classes to be easily added\", \" to the app.\\nIn the context of a Xamarin.Forms app that uses MVVM, a dependency injection container \", \"will\\ntypically be used for registering and resolving view models, and for registering services and i\", \"njecting\\nthem into view models.\\nThere are many dependency injection containers available, with the e\", \"ShopOnContainers mobile app\\nusing Autofac to manage the instantiation of view model and service clas\", \"ses in the app. Autofac\\nfacilitates building loosely coupled apps, and provides all of the features \", \"commonly found in\\ndependency injection containers, including methods to register type mappings and o\", \"bject instances,\\nresolve objects, manage object lifetimes, and inject dependent objects into constru\", \"ctors of objects\\nthat it resolves. For more information about Autofac, see Autofac on readthedocs.io\", \".\\nIn Autofac, the IContainer interface provides the dependency injection container. Figure 3-1 shows\", \"\\nthe dependencies when using this container, which instantiates an IOrderService object and injects\\n\", \"it into the ProfileViewModel class.\\nFigure 3-1: Dependencies when using dependency injection\\n19 CHAP\", \"TER 3 | Dependency injectionAt runtime, the container must know which implementation of the IOrderSe\", \"rvice interface it should\\ninstantiate, before it can instantiate a ProfileViewModel object. This inv\", \"olves:\\n\\u2022 The container deciding how to instantiate an object that implements the IOrderService\\ninter\", \"face. This is known as registration.\\n\\u2022 The container instantiating the object that implements the IO\", \"rderService interface, and the\\nProfileViewModel object. This is known as resolution.\\nEventually, the\", \" app will finish using the ProfileViewModel object and it will become available for\\ngarbage collecti\", \"on. At this point, the garbage collector should dispose of the IOrderService instance\\nif other class\", \"es do not share the same instance.\\nTip: Write container-agnostic code\\nAlways try to write container-\", \"agnostic code to decouple the app from the specific dependency\\ncontainer being used.\\nRegistration\\nBe\", \"fore dependencies can be injected into an object, the types of the dependencies must first be\\nregist\", \"ered with the container. Registering a type typically involves passing the container an interface\\nan\", \"d a concrete type that implements the interface.\\nThere are two ways of registering types and objects\", \" in the container through code:\\n\\u2022 Register a type or mapping with the container. When required, the \", \"container will build an\\ninstance of the specified type.\\n\\u2022 Register an existing object in the contain\", \"er as a singleton. When required, the container will\\nreturn a reference to the existing object.\\nTip:\", \" Dependency injection containers are not always suitable\\nDependency injection introduces additional \", \"complexity and requirements that might not be\\nappropriate or useful to small apps. If a class does n\", \"ot have any dependencies, or is not a\\ndependency for other types, it might not make sense to put it \", \"in the container. In addition, if a class\\nhas a single set of dependencies that are integral to the \", \"type and will never change, it might not\\nmake sense to put it in the container.\\nThe registration of \", \"types that require dependency injection should be performed in a single method in\\nan app, and this m\", \"ethod should be invoked early in the app's lifecycle to ensure that the app is aware\\nof the dependen\", \"cies between its classes. In the eShopOnContainers mobile app this is performed by\\nthe ViewModelLoca\", \"tor class, which builds the IContainer object and is the only class in the app that\\nholds a referenc\", \"e to that object. The following code example shows how the eShopOnContainers\\nmobile app declares the\", \" IContainer object in the ViewModelLocator class:\\nprivate static IContainer _container;\\nTypes and in\", \"stances are registered in the RegisterDependencies method in the ViewModelLocator\\nclass. This is ach\", \"ieved by first creating a ContainerBuilder instance, which is demonstrated in the\\nfollowing code exa\", \"mple:\\nvar builder = new ContainerBuilder();\\n20 CHAPTER 3 | Dependency injectionTypes and instances a\", \"re then registered with the ContainerBuilder object, and the following code\\nexample demonstrates the\", \" most common form of type registration:\\nbuilder.RegisterType<RequestProvider>().As<IRequestProvider>\", \"();\\nThe RegisterType method shown here maps an interface type to a concrete type. It tells the\\nconta\", \"iner to instantiate a RequestProvider object when it instantiates an object that requires an\\ninjecti\", \"on of an IRequestProvider through a constructor.\\nConcrete types can also be registered directly with\", \"out a mapping from an interface type, as shown in\\nthe following code example:\\nbuilder.RegisterType<P\", \"rofileViewModel>();\\nWhen the ProfileViewModel type is resolved, the container will inject its requir\", \"ed dependencies.\\nAutofac also allows instance registration, where the container is responsible for m\", \"aintaining a\\nreference to a singleton instance of a type. For example, the following code example sh\", \"ows how the\\neShopOnContainers mobile app registers the concrete type to use when a ProfileViewModel\\n\", \"instance requires an IOrderService instance:\\nbuilder.RegisterType<OrderService>().As<IOrderService>(\", \").SingleInstance();\\nThe RegisterType method shown here maps an interface type to a concrete type. Th\", \"e\\nSingleInstance method configures the registration so that every dependent object receives the\\nsame\", \" shared instance. Therefore, only a single OrderService instance will exist in the container,\\nwhich \", \"is shared by objects that require an injection of an IOrderService through a constructor.\\nInstance r\", \"egistration can also be performed with the RegisterInstance method, which is\\ndemonstrated in the fol\", \"lowing code example:\\nbuilder.RegisterInstance(new OrderMockService()).As<IOrderService>();\\nThe Regis\", \"terInstance method shown here creates a new OrderMockService instance and registers\\nit with the cont\", \"ainer. Therefore, only a single OrderMockService instance exists in the container,\\nwhich is shared b\", \"y objects that require an injection of an IOrderService through a constructor.\\nFollowing type and in\", \"stance registration, the IContainer object must be built, which is demonstrated\\nin the following cod\", \"e example:\\n_container = builder.Build();\\nInvoking the Build method on the ContainerBuilder instance \", \"builds a new dependency injection\\ncontainer that contains the registrations that have been made.\\nTip\", \": Consider an IContainer as being immutable\\nWhile Autofac provides an Update method to update regist\", \"rations in an existing container, calling\\nthis method should be avoided where possible. There are ri\", \"sks to modifying a container after it's\\nbeen built, particularly if the container has been used. For\", \" more information, see Consider a\\nContainer as Immutable on readthedocs.io.\\n21 CHAPTER 3 | Dependenc\", \"y injectionResolution\\nAfter a type is registered, it can be resolved or injected as a dependency. Wh\", \"en a type is being\\nresolved and the container needs to create a new instance, it injects any depende\", \"ncies into the\\ninstance.\\nGenerally, when a type is resolved, one of three things happens:\\n1. If the \", \"type hasn't been registered, the container throws an exception.\\n2. If the type has been registered a\", \"s a singleton, the container returns the singleton instance. If\\nthis is the first time the type is c\", \"alled for, the container creates it if required, and maintains a\\nreference to it.\\n3. If the type has\", \"n't been registered as a singleton, the container returns a new instance, and\\ndoesn't maintain a ref\", \"erence to it.\\nThe following code example shows how the RequestProvider type that was previously regi\", \"stered\\nwith Autofac can be resolved:\\nvar requestProvider = _container.Resolve<IRequestProvider>();\\nI\", \"n this example, Autofac is asked to resolve the concrete type for the IRequestProvider type, along\\nw\", \"ith any dependencies. Typically, the Resolve method is called when an instance of a specific type is\", \"\\nrequired. For information about controlling the lifetime of resolved objects, see Managing the life\", \"time\\nof resolved objects.\\nThe following code example shows how the eShopOnContainers mobile app inst\", \"antiates view model\\ntypes and their dependencies:\\nvar viewModel = _container.Resolve(viewModelType);\", \"\\nIn this example, Autofac is asked to resolve the view model type for a requested view model, and th\", \"e\\ncontainer will also resolve any dependencies. When resolving the ProfileViewModel type, the\\ndepend\", \"ency to resolve is an IOrderService object. Therefore, Autofac first constructs an\\nOrderService obje\", \"ct and then passes it to the constructor of the ProfileViewModel class. For more\\ninformation about h\", \"ow the eShopOnContainers mobile app constructs view models and associates\\nthem to views, see Automat\", \"ically creating a view model with a view model locator.\\nNote: Registering and resolving types with a\", \" container has a performance cost because of the\\ncontainer's use of reflection for creating each typ\", \"e, especially if dependencies are being\\nreconstructed for each page navigation in the app. If there \", \"are many or deep dependencies, the\\ncost of creation can increase significantly.\\nManaging the lifetim\", \"e of resolved objects\\nAfter registering a type, the default behavior for Autofac is to create a new \", \"instance of the registered\\ntype each time the type is resolved, or when the dependency mechanism inj\", \"ects instances into other\\nclasses. In this scenario, the container doesn't hold a reference to the r\", \"esolved object. However, when\\nregistering an instance, the default behavior for Autofac is to manage\", \" the lifetime of the object as a\\nsingleton. Therefore, the instance remains in scope while the conta\", \"iner is in scope, and is disposed\\nwhen the container goes out of scope and is garbage collected, or \", \"when code explicitly disposes the\\ncontainer.\\n22 CHAPTER 3 | Dependency injectionAn Autofac instance \", \"scope can be used to specify the singleton behavior for an object that Autofac\\ncreates from a regist\", \"ered type. Autofac instance scopes manage the object lifetimes instantiated by\\nthe container. The de\", \"fault instance scope for the RegisterType method is the\\nInstancePerDependency scope. However, the Si\", \"ngleInstance scope can be used with the\\nRegisterType method, so that the container creates or return\", \"s a singleton instance of a type when\\ncalling the Resolve method. The following code example shows h\", \"ow Autofac is instructed to create a\\nsingleton instance of the NavigationService class:\\nbuilder.Regi\", \"sterType<NavigationService>().As<INavigationService>().SingleInstance();\\nThe first time that the INa\", \"vigationService interface is resolved, the container creates a new\\nNavigationService object and main\", \"tains a reference to it. On any subsequent resolutions of the\\nINavigationService interface, the cont\", \"ainer returns a reference to the NavigationService object\\nthat was previously created.\\nNote: The Sin\", \"gleInstance scope disposes created objects when the container is disposed.\\nAutofac includes addition\", \"al instance scopes. For more information, see Instance Scope on\\nreadthedocs.io.\\nSummary\\nDependency i\", \"njection enables decoupling of concrete types from the code that depends on these\\ntypes. It typicall\", \"y uses a container that holds a list of registrations and mappings between interfaces\\nand abstract t\", \"ypes, and the concrete types that implement or extend these types.\\nAutofac facilitates building loos\", \"ely coupled apps, and provides all of the features commonly found in\\ndependency injection containers\", \", including methods to register type mappings and object instances,\\nresolve objects, manage object l\", \"ifetimes, and inject dependent objects into constructors of objects it\\nresolves.\\n23 CHAPTER 3 | Depe\", \"ndency injection4\\nCHAPTER\\nCommunicating\\nbetween loosely\\ncoupled\\ncomponents\\nThe publish-subscribe pat\", \"tern is a messaging pattern in which publishers send messages without\\nhaving knowledge of any receiv\", \"ers, known as subscribers. Similarly, subscribers listen for specific\\nmessages, without having knowl\", \"edge of any publishers.\\nEvents in .NET implement the publish-subscribe pattern, and are the most sim\", \"ple and straightforward\\napproach for a communication layer between components if loose coupling is n\", \"ot required, such as a\\ncontrol and the page that contains it. However, the publisher and subscriber \", \"lifetimes are coupled by\\nobject references to each other, and the subscriber type must have a refere\", \"nce to the publisher type.\\nThis can create memory management issues, especially when there are short\", \" lived objects that\\nsubscribe to an event of a static or long-lived object. If the event handler isn\", \"'t removed, the subscriber\\nwill be kept alive by the reference to it in the publisher, and this will\", \" prevent or delay the garbage\\ncollection of the subscriber.\\nIntroduction to MessagingCenter\\nThe Xama\", \"rin.Forms MessagingCenter class implements the publish-subscribe pattern, allowing\\nmessage-based com\", \"munication between components that are inconvenient to link by object and type\\nreferences. This mech\", \"anism allows publishers and subscribers to communicate without having a\\nreference to each other, hel\", \"ping to reduce dependencies between components, while also allowing\\ncomponents to be independently d\", \"eveloped and tested.\\nThe MessagingCenter class provides multicast publish-subscribe functionality. T\", \"his means that there\\ncan be multiple publishers that publish a single message, and there can be mult\", \"iple subscribers\\nlistening for the same message. Figure 4-1 illustrates this relationship:\\n24 CHAPTE\", \"R 4 | Communicating between loosely coupled componentsFigure 4-1: Multicast publish-subscribe functi\", \"onality\\nPublishers send messages using the MessagingCenter.Send method, while subscribers listen for\", \"\\nmessages using the MessagingCenter.Subscribe method. In addition, subscribers can also\\nunsubscribe \", \"from message subscriptions, if required, with the MessagingCenter.Unsubscribe\\nmethod.\\nInternally, th\", \"e MessagingCenter class uses weak references. This means that it will not keep objects\\nalive, and wi\", \"ll allow them to be garbage collected. Therefore, it should only be necessary to\\nunsubscribe from a \", \"message when a class no longer wishes to receive the message.\\nThe eShopOnContainers mobile app uses \", \"the MessagingCenter class to communicate between\\nloosely coupled components. The app defines three m\", \"essages:\\n\\u2022 The AddProduct message is published by the CatalogViewModel class when an item is\\nadded t\", \"o the shopping basket. In return, the BasketViewModel class subscribes to the\\nmessage and increments\", \" the number of items in the shopping basket in response. In addition,\\nthe BasketViewModel class also\", \" unsubscribes from this message.\\n\\u2022 The Filter message is published by the CatalogViewModel class whe\", \"n the user applies a\\nbrand or type filter to the items displayed from the catalogue. In return, the \", \"CatalogView\\nclass subscribes to the message and updates the UI so that only items that match the fil\", \"ter\\ncriteria are displayed.\\n\\u2022 The ChangeTab message is published by the MainViewModel class when the\", \"\\nCheckoutViewModel navigates to the MainViewModel following the successful creation and\\nsubmission o\", \"f a new order. In return, the MainView class subscribes to the message and\\nupdates the UI so that th\", \"e My profile tab is active, to show the user's orders.\\nNote: While the MessagingCenter class permits\", \" communication between loosely-coupled classes,\\nit does not offer the only architectural solution to\", \" this issue. For example, communication between\\na view model and a view can also be achieved by the \", \"binding engine and through property change\\nnotifications. In addition, communication between two vie\", \"w models can also be achieved by\\npassing data during navigation.\\nIn the eShopOnContainers mobile app\", \", MessagingCenter is used to update in the UI in response to\\nan action occurring in another class. T\", \"herefore, messages are published on the UI thread, with\\nsubscribers receiving the message on the sam\", \"e thread.\\n25 CHAPTER 4 | Communicating between loosley coupled componentsTip: Marshal to the UI thre\", \"ad when performing UI updates\\nIf a message that's sent from a background thread is required to updat\", \"e the UI, process the\\nmessage on the UI thread in the subscriber by invoking the Device.BeginInvokeO\", \"nMainThread\\nmethod.\\nFor more information about MessagingCenter, see MessagingCenter on the Xamarin D\", \"eveloper\\nCenter.\\nDefining a message\\nMessagingCenter messages are strings that are used to identify m\", \"essages. The following code\\nexample shows the messages defined within the eShopOnContainers mobile a\", \"pp:\\npublic class MessengerKeys\\n{\\n// Add product to basket\\npublic const string AddProduct = \\\"AddProdu\", \"ct\\\";\\n// Filter\\npublic const string Filter = \\\"Filter\\\";\\n// Change selected Tab programmatically\\npublic\", \" const string ChangeTab = \\\"ChangeTab\\\";\\n}\\nIn this example, messages are defined using constants. The \", \"advantage of this approach is that it\\nprovides compile-time type safety and refactoring support.\\nPub\", \"lishing a message\\nPublishers notify subscribers of a message with one of the MessagingCenter.Send ov\", \"erloads. The\\nfollowing code example demonstrates publishing the AddProduct message:\\nMessagingCenter.\", \"Send(this, MessengerKeys.AddProduct, catalogItem);\\nIn this example, the Send method specifies three \", \"arguments:\\n\\u2022 The first argument specifies the sender class. The sender class must be specified by an\", \"y\\nsubscribers who wish to receive the message.\\n\\u2022 The second argument specifies the message.\\n\\u2022 The th\", \"ird argument specifies the payload data to be sent to the subscriber. In this case the\\npayload data \", \"is a CatalogItem instance.\\nThe Send method will publish the message, and its payload data, using a f\", \"ire-and-forget approach.\\nTherefore, the message is sent even if there are no subscribers registered \", \"to receive the message. In\\nthis situation, the sent message is ignored.\\nNote: The MessagingCenter.Se\", \"nd method can use generic parameters to control how messages\\nare delivered. Therefore, multiple mess\", \"ages that share a message identity but send different\\npayload data types can be received by differen\", \"t subscribers.\\n26 CHAPTER 4 | Communicating between loosley coupled componentsSubscribing to a messa\", \"ge\\nSubscribers can register to receive a message using one of the MessagingCenter.Subscribe\\noverload\", \"s. The following code example demonstrates how the eShopOnContainers mobile app\\nsubscribes to, and p\", \"rocesses, the AddProduct message:\\nMessagingCenter.Subscribe<CatalogViewModel, CatalogItem>(\\nthis, Me\", \"ssageKeys.AddProduct, async (sender, arg) =>\\n{\\nBadgeCount++;\\nawait AddCatalogItemAsync(arg);\\n});\\nIn \", \"this example, the Subscribe method subscribes to the AddProduct message, and executes a\\ncallback del\", \"egate in response to receiving the message. This callback delegate, specified as a lambda\\nexpression\", \", executes code that updates the UI.\\nTip: Consider using immutable payload data\\nDon't attempt to mod\", \"ify the payload data from within a callback delegate because several threads\\ncould be accessing the \", \"received data simultaneously. In this scenario, the payload data should be\\nimmutable to avoid concur\", \"rency errors.\\nA subscriber might not need to handle every instance of a published message, and this \", \"can be\\ncontrolled by the generic type arguments that are specified on the Subscribe method. In this\\n\", \"example, the subscriber will only receive AddProduct messages that are sent from the\\nCatalogViewMode\", \"l class, whose payload data is a CatalogItem instance.\\nUnsubscribing from a message\\nSubscribers can \", \"unsubscribe from messages they no longer want to receive. This is achieved with one\\nof the Messaging\", \"Center.Unsubscribe overloads, as demonstrated in the following code example:\\nMessagingCenter.Unsubsc\", \"ribe<CatalogViewModel, CatalogItem>(this, MessengerKeys.AddProduct);\\nIn this example, the Unsubscrib\", \"e method syntax reflects the type arguments specified when\\nsubscribing to receive the AddProduct mes\", \"sage.\\nSummary\\nThe Xamarin.Forms MessagingCenter class implements the publish-subscribe pattern, allo\", \"wing\\nmessage-based communication between components that are inconvenient to link by object and type\", \"\\nreferences. This mechanism allows publishers and subscribers to communicate without having a\\nrefere\", \"nce to each other, helping to reduce dependencies between components, while also allowing\\ncomponents\", \" to be independently developed and tested.\\n27 CHAPTER 4 | Communicating between loosley coupled comp\", \"onents5\\nCHAPTER\\nNavigation\\nXamarin.Forms includes support for page navigation, which typically resul\", \"ts from the user's interaction\\nwith the UI or from the app itself as a result of internal logic-driv\", \"en state changes. However,\\nnavigation can be complex to implement in apps that use the Model-View-Vi\", \"ewModel (MVVM)\\npattern, as the following challenges must be met:\\n\\u2022 How to identify the view to be na\", \"vigated to, using an approach that does not introduce tight\\ncoupling and dependencies between views.\", \"\\n\\u2022 How to coordinate the process by which the view to be navigated to is instantiated and\\ninitialize\", \"d. When using MVVM, the view and view model need to be instantiated and\\nassociated with each other v\", \"ia the view's binding context. When an app is using a\\ndependency injection container, the instantiat\", \"ion of views and view models might require a\\nspecific construction mechanism.\\n\\u2022 Whether to perform v\", \"iew-first navigation, or view model-first navigation. With view-first\\nnavigation, the page to naviga\", \"te to refers to the name of the view type. During navigation,\\nthe specified view is instantiated, al\", \"ong with its corresponding view model and other\\ndependent services. An alternative approach is to us\", \"e view model-first navigation, where the\\npage to navigate to refers to the name of the view model ty\", \"pe.\\n\\u2022 How to cleanly separate the navigational behavior of the app across the views and view\\nmodels.\", \" The MVVM pattern provides a separation between the app's UI and its presentation\\nand business logic\", \". However, the navigation behavior of an app will often span the UI and\\npresentations parts of the a\", \"pp. The user will often initiate navigation from a view, and the\\nview will be replaced as a result o\", \"f the navigation. However, navigation might often also need\\nto be initiated or coordinated from with\", \"in the view model.\\n\\u2022 How to pass parameters during navigation for initialization purposes. For examp\", \"le, if the user\\nnavigates to a view to update order details, the order data will have to be passed t\", \"o the view\\nso that it can display the correct data.\\n\\u2022 How to co-ordinate navigation, to ensure that \", \"certain business rules are obeyed. For example,\\nusers might be prompted before navigating away from \", \"a view so that they can correct any\\ninvalid data or be prompted to submit or discard any data change\", \"s that were made within the\\nview.\\nThis chapter addresses these challenges by presenting a Navigation\", \"Service class that's used to\\nperform view model-first page navigation.\\nNote: The NavigationService u\", \"sed by the app is designed only to perform hierarchical\\nnavigation between ContentPage instances. Us\", \"ing the service to navigate between other page\\ntypes might result in unexpected behavior.\\n28 CHAPTER\", \" 5 | NavigationNavigating between pages\\nNavigation logic can reside in a view's code-behind, or in a\", \" data bound view model. While placing\\nnavigation logic in a view might be the simplest approach, it \", \"is not easily testable through unit tests.\\nPlacing navigation logic in view model classes means that\", \" the logic can be exercised through unit\\ntests. In addition, the view model can then implement logic\", \" to control navigation to ensure that\\ncertain business rules are enforced. For example, an app might\", \" not allow the user to navigate away\\nfrom a page without first ensuring that the entered data is val\", \"id.\\nA NavigationService class is typically invoked from view models, in order to promote testability\", \".\\nHowever, navigating to views from view models would require the view models to reference views,\\nan\", \"d particularly views that the active view model isn't associated with, which is not recommended.\\nThe\", \"refore, the NavigationService presented here specifies the view model type as the target to\\nnavigate\", \" to.\\nThe eShopOnContainers mobile app uses the NavigationService class to provide view model-first\\nn\", \"avigation. This class implements the INavigationService interface, which is shown in the following\\nc\", \"ode example:\\npublic interface INavigationService\\n{\\nViewModelBase PreviousPageViewModel { get; }\\nTask\", \" InitializeAsync();\\nTask NavigateToAsync<TViewModel>() where TViewModel : ViewModelBase;\\nTask Naviga\", \"teToAsync<TViewModel>(object parameter) where TViewModel : ViewModelBase;\\nTask RemoveLastFromBackSta\", \"ckAsync();\\nTask RemoveBackStackAsync();\\n}\\nThis interface specifies that an implementing class must p\", \"rovide the following methods:\\nMethod Purpose\\nInitializeAsync Performs navigation to one of two pages\", \" when the app is\\nlaunched.\\nNavigateToAsync<T> Performs hierarchical navigation to a specified page.\\n\", \"NavigateToAsync<T>(parameter) Performs hierarchical navigation to a specified page, passing\\na parame\", \"ter.\\nRemoveLastFromBackStackAsync Removes the previous page from the navigation stack.\\nRemoveBackSta\", \"ckAsync Removes all the previous pages from the navigation stack.\\nIn addition, the INavigationServic\", \"e interface specifies that an implementing class must provide a\\nPreviousPageViewModel property. This\", \" property returns the view model type associated with the\\nprevious page in the navigation stack.\\nNot\", \"e: An INavigationService interface would usually also specify a GoBackAsync method, which\\nis used to\", \" programmatically return to the previous page in the navigation stack. However, this\\nmethod is missi\", \"ng from the eShopOnContainers mobile app because it's not required.\\nCreating the NavigationService i\", \"nstance\\nThe NavigationService class, which implements the INavigationService interface, is registere\", \"d as\\na singleton with the Autofac dependency injection container, as demonstrated in the following c\", \"ode\\nexample:\\n29 CHAPTER 5 | Navigationbuilder.RegisterType<NavigationService>().As<INavigationServic\", \"e>().SingleInstance();\\nThe INavigationService interface is resolved in the ViewModelBase class const\", \"ructor, as\\ndemonstrated in the following code example:\\nNavigationService = ViewModelLocator.Resolve<\", \"INavigationService>();\\nThis returns a reference to the NavigationService object that's stored in the\", \" Autofac dependency\\ninjection container, which is created by the InitNavigation method in the App cl\", \"ass. For more\\ninformation, see Navigating when the app is launched.\\nThe ViewModelBase class stores t\", \"he NavigationService instance in a NavigationService property,\\nof type INavigationService. Therefore\", \", all view model classes, which derive from the\\nViewModelBase class, can use the NavigationService p\", \"roperty to access the methods specified by\\nthe INavigationService interface. This avoids the overhea\", \"d of injecting the NavigationService\\nobject from the Autofac dependency injection container into eac\", \"h view model class.\\nHandling navigation requests\\nXamarin.Forms provides the NavigationPage class, wh\", \"ich implements a hierarchical navigation\\nexperience in which the user is able to navigate through pa\", \"ges, forwards and backwards, as desired.\\nFor more information about hierarchical navigation, see Hie\", \"rarchical Navigation on the Xamarin\\nDeveloper Center.\\nRather than use the NavigationPage class direc\", \"tly, the eShopOnContainers app wraps the\\nNavigationPage class in the CustomNavigationView class, as \", \"shown in the following code example:\\npublic partial class CustomNavigationView : NavigationPage\\n{\\npu\", \"blic CustomNavigationView() : base()\\n{\\nInitializeComponent();\\n}\\npublic CustomNavigationView(Page roo\", \"t) : base(root)\\n{\\nInitializeComponent();\\n}\\n}\\nThe purpose of this wrapping is for ease of styling the\", \" NavigationPage instance inside the XAML file\\nfor the class.\\nNavigation is performed inside view mod\", \"el classes by invoking one of the NavigateToAsync\\nmethods, specifying the view model type for the pa\", \"ge being navigated to, as demonstrated in the\\nfollowing code example:\\nawait NavigationService.Naviga\", \"teToAsync<MainViewModel>();\\nThe following code example shows the NavigateToAsync methods provided by\", \" the\\nNavigationService class:\\n30 CHAPTER 5 | Navigationpublic Task NavigateToAsync<TViewModel>() whe\", \"re TViewModel : ViewModelBase\\n{\\nreturn InternalNavigateToAsync(typeof(TViewModel), null);\\n}\\npublic T\", \"ask NavigateToAsync<TViewModel>(object parameter) where TViewModel : ViewModelBase\\n{\\nreturn Internal\", \"NavigateToAsync(typeof(TViewModel), parameter);\\n}\\nEach method allows any view model class that deriv\", \"es from the ViewModelBase class to perform\\nhierarchical navigation by invoking the InternalNavigateT\", \"oAsync method. In addition, the second\\nNavigateToAsync method enables navigation data to be specifie\", \"d as an argument that's passed to\\nthe view model being navigated to, where it's typically used to pe\", \"rform initialization. For more\\ninformation, see Passing parameters during navigation.\\nThe InternalNa\", \"vigateToAsync method executes the navigation request, and is shown in the\\nfollowing code example:\\npr\", \"ivate async Task InternalNavigateToAsync(Type viewModelType, object parameter)\\n{\\nPage page = CreateP\", \"age(viewModelType, parameter);\\nif (page is LoginView)\\n{\\nApplication.Current.MainPage = new CustomNav\", \"igationView(page);\\n}\\nelse\\n{\\nvar navigationPage = Application.Current.MainPage as CustomNavigationVie\", \"w;\\nif (navigationPage != null)\\n{\\nawait navigationPage.PushAsync(page);\\n}\\nelse\\n{\\nApplication.Current.\", \"MainPage = new CustomNavigationView(page);\\n}\\n}\\nawait (page.BindingContext as ViewModelBase).Initiali\", \"zeAsync(parameter);\\n}\\nprivate Type GetPageTypeForViewModel(Type viewModelType)\\n{\\nvar viewName = view\", \"ModelType.FullName.Replace(\\\"Model\\\", string.Empty);\\nvar viewModelAssemblyName = viewModelType.GetType\", \"Info().Assembly.FullName;\\nvar viewAssemblyName = string.Format(\\nCultureInfo.InvariantCulture, \\\"{0}, \", \"{1}\\\", viewName, viewModelAssemblyName);\\nvar viewType = Type.GetType(viewAssemblyName);\\nreturn viewTy\", \"pe;\\n}\\nprivate Page CreatePage(Type viewModelType, object parameter)\\n{\\nType pageType = GetPageTypeFor\", \"ViewModel(viewModelType);\\nif (pageType == null)\\n{\\nthrow new Exception($\\\"Cannot locate page type for \", \"{viewModelType}\\\");\\n}\\n31 CHAPTER 5 | NavigationPage page = Activator.CreateInstance(pageType) as Page\", \";\\nreturn page;\\n}\\nThe InternalNavigateToAsync method performs navigation to a view model by first cal\", \"ling the\\nCreatePage method. This method locates the view that corresponds to the specified view mode\", \"l type,\\nand creates and returns an instance of this view type. Locating the view that corresponds to\", \" the view\\nmodel type uses a convention-based approach, which assumes that:\\n\\u2022 Views are in the same a\", \"ssembly as view model types.\\n\\u2022 Views are in a .Views child namespace.\\n\\u2022 View models are in a .ViewMo\", \"dels child namespace.\\n\\u2022 View names correspond to view model names, with \\\"Model\\\" removed.\\nWhen a view\", \" is instantiated, it's associated with its corresponding view model. For more information\\nabout how \", \"this occurs, see Automatically creating a view model with a view model locator.\\nIf the view being cr\", \"eated is a LoginView, it's wrapped inside a new instance of the\\nCustomNavigationView class and assig\", \"ned to the Application.Current.MainPage property.\\nOtherwise, the CustomNavigationView instance is re\", \"trieved, and provided that it isn't null, the\\nPushAsync method is invoked to push the view being cre\", \"ated onto the navigation stack. However, If\\nthe retrieved CustomNavigationView instance is null, the\", \" view being created is wrapped inside a\\nnew instance of the CustomNavigationView class and assigned \", \"to the\\nApplication.Current.MainPage property. This mechanism ensures that during navigation, pages\\na\", \"re added correctly to the navigation stack both when it's empty, and when it contains data.\\nTip: Con\", \"sider caching pages\\nPage caching results in memory consumption for views that are not currently disp\", \"layed. However,\\nwithout page caching it does mean that XAML parsing and construction of the page and\", \" its view\\nmodel will occur every time a new page is navigated to, which can have a performance impac\", \"t for a\\ncomplex page. For a well-designed page that does not use an excessive number of controls, th\", \"e\\nperformance should be sufficient. However, page caching might help if slow page loading times are\\n\", \"encountered.\\nAfter the view is created and navigated to, the InitializeAsync method of the view's as\", \"sociated\\nview model is executed. For more information, see Passing parameters during navigation.\\nNav\", \"igating when the app is launched\\nWhen the app is launched, the InitNavigation method in the App clas\", \"s is invoked. The following\\ncode example shows this method:\\nprivate Task InitNavigation()\\n{\\nvar navi\", \"gationService = ViewModelLocator.Resolve<INavigationService>();\\nreturn navigationService.InitializeA\", \"sync();\\n}\\nThe method creates a new NavigationService object in the Autofac dependency injection cont\", \"ainer,\\nand returns a reference to it, before invoking its InitializeAsync method.\\n32 CHAPTER 5 | Nav\", \"igationNote: When the INavigationService interface is resolved by the ViewModelBase class, the\\nconta\", \"iner returns a reference to the NavigationService object that was created when the\\nInitNavigation me\", \"thod is invoked.\\nThe following code example shows the NavigationService InitializeAsync method:\\npubl\", \"ic Task InitializeAsync()\\n{\\nif (string.IsNullOrEmpty(Settings.AuthAccessToken))\\nreturn NavigateToAsy\", \"nc<LoginViewModel>();\\nelse\\nreturn NavigateToAsync<MainViewModel>();\\n}\\nThe MainView is navigated to i\", \"f the app has a cached access token, which is used for authentication.\\nOtherwise, the LoginView is n\", \"avigated to.\\nFor more information about the Autofac dependency injection container, see Introduction\", \" to\\ndependency injection.\\nPassing parameters during navigation\\nOne of the NavigateToAsync methods, s\", \"pecified by the INavigationService interface, enables\\nnavigation data to be specified as an argument\", \" that's passed to the view model being navigated to,\\nwhere it's typically used to perform initializa\", \"tion.\\nFor example, the ProfileViewModel class contains an OrderDetailCommand that's executed when\\nth\", \"e user selects an order on the ProfileView page. In turn, this executes the OrderDetailAsync\\nmethod,\", \" which is shown in the following code example:\\nprivate async Task OrderDetailAsync(Order order)\\n{\\naw\", \"ait NavigationService.NavigateToAsync<OrderDetailViewModel>(order);\\n}\\nThis method invokes navigation\", \" to the OrderDetailViewModel, passing an Order instance that\\nrepresents the order that the user sele\", \"cted on the ProfileView page. When the NavigationService\\nclass creates the OrderDetailView, the Orde\", \"rDetailViewModel class is instantiated and assigned to\\nthe view's BindingContext. After navigating t\", \"o the OrderDetailView, the\\nInternalNavigateToAsync method executes the InitializeAsync method of the\", \" view's associated\\nview model.\\nThe InitializeAsync method is defined in the ViewModelBase class as a\", \" method that can be\\noverridden. This method specifies an object argument that represents the data to\", \" be passed to a\\nview model during a navigation operation. Therefore, view model classes that want to\", \" receive data\\nfrom a navigation operation provide their own implementation of the InitializeAsync me\", \"thod to\\nperform the required initialization. The following code example shows the InitializeAsync me\", \"thod\\nfrom the OrderDetailViewModel class:\\npublic override async Task InitializeAsync(object navigati\", \"onData)\\n{\\nif (navigationData is Order)\\n{\\n...\\nOrder = await _ordersService.GetOrderAsync(\\nConvert.ToI\", \"nt32(order.OrderNumber), authToken);\\n33 CHAPTER 5 | Navigation...\\n}\\n}\\nThis method retrieves the Orde\", \"r instance that was passed into the view model during the navigation\\noperation, and uses it to retri\", \"eve the full order details from the OrderService instance.\\nInvoking navigation using behaviors\\nNavig\", \"ation is usually triggered from a view by a user interaction. For example, the LoginView\\nperforms na\", \"vigation following successful authentication. The following code example shows how the\\nnavigation is\", \" invoked by a behavior:\\n<WebView ...>\\n<WebView.Behaviors>\\n<behaviors:EventToCommandBehavior\\nEventNam\", \"e=\\\"Navigating\\\"\\nEventArgsConverter=\\\"{StaticResource WebNavigatingEventArgsConverter}\\\"\\nCommand=\\\"{Bindi\", \"ng NavigateCommand}\\\" />\\n</WebView.Behaviors>\\n</WebView>\\nAt runtime, the EventToCommandBehavior will \", \"respond to interaction with the WebView. When the\\nWebView navigates to a web page, the Navigating ev\", \"ent will fire, which will execute the\\nNavigateCommand in the LoginViewModel. By default, the event a\", \"rguments for the event are passed\\nto the command. This data is converted as it's passed between sour\", \"ce and target by the converter\\nspecified in the EventArgsConverter property, which returns the Url f\", \"rom the\\nWebNavigatingEventArgs. Therefore, when the NavigationCommand is executed, the Url of the we\", \"b\\npage is passed as a parameter to the registered Action.\\nIn turn, the NavigationCommand executes th\", \"e NavigateAsync method, which is shown in the\\nfollowing code example:\\nprivate async Task NavigateAsy\", \"nc(string url)\\n{\\n...\\nawait NavigationService.NavigateToAsync<MainViewModel>();\\nawait NavigationServi\", \"ce.RemoveLastFromBackStackAsync();\\n...\\n}\\nThis method invokes navigation to the MainViewModel, and fo\", \"llowing navigation, removes the\\nLoginView page from the navigation stack.\\nConfirming or cancelling n\", \"avigation\\nAn app might need to interact with the user during a navigation operation, so that the use\", \"r can\\nconfirm or cancel navigation. This might be necessary, for example, when the user attempts to\\n\", \"navigate before having fully completed a data entry page. In this situation, an app should provide a\", \"\\nnotification that allows the user to navigate away from the page, or to cancel the navigation opera\", \"tion\\nbefore it occurs. This can be achieved in a view model class by using the response from a notif\", \"ication\\nto control whether or not navigation is invoked.\\n34 CHAPTER 5 | NavigationSummary\\nXamarin.Fo\", \"rms includes support for page navigation, which typically results from the user's interaction\\nwith t\", \"he UI, or from the app itself, as a result of internal logic-driven state changes. However,\\nnavigati\", \"on can be complex to implement in apps that use the MVVM pattern.\\nThis chapter presented a Navigatio\", \"nService class, which is used to perform view model-first\\nnavigation from view models. Placing navig\", \"ation logic in view model classes means that the logic can\\nbe exercised through automated tests. In \", \"addition, the view model can then implement logic to\\ncontrol navigation to ensure that certain busin\", \"ess rules are enforced.\\n35 CHAPTER 5 | Navigation6\\nCHAPTER\\nValidation\\nAny app that accepts input fro\", \"m users should ensure that the input is valid. An app could, for\\nexample, check for input that conta\", \"ins only characters in a particular range, is of a certain length, or\\nmatches a particular format. W\", \"ithout validation, a user can supply data that causes the app to fail.\\nValidation enforces business \", \"rules, and prevents an attacker from injecting malicious data.\\nIn the context of the Model-ViewModel\", \"-Model (MVVM) pattern, a view model or model will often be\\nrequired to perform data validation and s\", \"ignal any validation errors to the view so that the user can\\ncorrect them. The eShopOnContainers mob\", \"ile app performs synchronous client-side validation of view\\nmodel properties and notifies the user o\", \"f any validation errors by highlighting the control that\\ncontains the invalid data, and by displayin\", \"g error messages that inform the user of why the data is\\ninvalid. Figure 6-1 shows the classes invol\", \"ved in performing validation in the eShopOnContainers\\nmobile app.\\nFigure 6-1: Validation classes in \", \"the eShopOnContainers mobile app\\nView model properties that require validation are of type Validatab\", \"leObject<T>, and each\\nValidatableObject<T> instance has validation rules added to its Validations pr\", \"operty. Validation\\nis invoked from the view model by calling the Validate method of the ValidatableO\", \"bject<T>\\n36 CHAPTER 6 | Validationinstance, which retrieves the validation rules and executes them a\", \"gainst the ValidatableObject<T>\\nValue property. Any validation errors are placed into the Errors pro\", \"perty of the\\nValidatableObject<T> instance, and the IsValid property of the ValidatableObject<T> ins\", \"tance\\nis updated to indicate whether validation succeeded or failed.\\nProperty change notification is\", \" provided by the ExtendedBindableObject class, and so an Entry\\ncontrol can bind to the IsValid prope\", \"rty of ValidatableObject<T> instance in the view model class\\nto be notified of whether or not the en\", \"tered data is valid.\\nSpecifying validation rules\\nValidation rules are specified by creating a class \", \"that derives from the IValidationRule<T> interface,\\nwhich is shown in the following code example:\\npu\", \"blic interface IValidationRule<T>\\n{\\nstring ValidationMessage { get; set; }\\nbool Check(T value);\\n}\\nTh\", \"is interface specifies that a validation rule class must provide a boolean Check method that is used\", \"\\nto perform the required validation, and a ValidationMessage property whose value is the validation\\n\", \"error message that will be displayed if validation fails.\\nThe following code example shows the IsNot\", \"NullOrEmptyRule<T> validation rule, which is used to\\nperform validation of the username and password\", \" entered by the user on the LoginView when using\\nmock services in the eShopOnContainers mobile app:\\n\", \"public class IsNotNullOrEmptyRule<T> : IValidationRule<T>\\n{\\npublic string ValidationMessage { get; s\", \"et; }\\npublic bool Check(T value)\\n{\\nif (value == null)\\n{\\nreturn false;\\n}\\nvar str = value as string;\\nr\", \"eturn !string.IsNullOrWhiteSpace(str);\\n}\\n}\\nThe Check method returns a boolean indicating whether the\", \" value argument is null, empty, or\\nconsists only of whitespace characters.\\nAlthough not used by the \", \"eShopOnContainers mobile app, the following code example shows a\\nvalidation rule for validating emai\", \"l addresses:\\npublic class EmailRule<T> : IValidationRule<T>\\n{\\npublic string ValidationMessage { get;\", \" set; }\\npublic bool Check(T value)\\n{\\nif (value == null)\\n37 CHAPTER 6 | Validation{\\nreturn false;\\n}\\nv\", \"ar str = value as string;\\nRegex regex = new Regex(@\\\"^([\\\\w\\\\.\\\\-]+)@([\\\\w\\\\-]+)((\\\\.(\\\\w){2,3})+)$\\\");\\nMatch\", \" match = regex.Match(str);\\nreturn match.Success;\\n}\\n}\\nThe Check method returns a boolean indicating w\", \"hether or not the value argument is a valid email\\naddress. This is achieved by searching the value a\", \"rgument for the first occurrence of the regular\\nexpression pattern specified in the Regex constructo\", \"r. Whether the regular expression pattern has\\nbeen found in the input string can be determined by ch\", \"ecking the value of the Match object's\\nSuccess property.\\nNote: Property validation can sometimes inv\", \"olve dependent properties. An example of dependent\\nproperties is when the set of valid values for pr\", \"operty A depends on the particular value that has\\nbeen set in property B. To check that the value of\", \" property A is one of the allowed values would\\ninvolve retrieving the value of property B. In additi\", \"on, when the value of property B changes,\\nproperty A would need to be revalidated.\\nAdding validation\", \" rules to a property\\nIn the eShopOnContainers mobile app, view model properties that require validat\", \"ion are declared to\\nbe of type ValidatableObject<T>, where T is the type of the data to be validated\", \". The following\\ncode example shows an example of two such properties:\\npublic ValidatableObject<strin\", \"g> UserName\\n{\\nget\\n{\\nreturn _userName;\\n}\\nset\\n{\\n_userName = value;\\nRaisePropertyChanged(() => UserName\", \");\\n}\\n}\\npublic ValidatableObject<string> Password\\n{\\nget\\n{\\nreturn _password;\\n}\\nset\\n{\\n_password = value\", \";\\nRaisePropertyChanged(() => Password);\\n}\\n}\\nFor validation to occur, validation rules must be added \", \"to the Validations collection of each\\nValidatableObject<T> instance, as demonstrated in the followin\", \"g code example:\\n38 CHAPTER 6 | Validationprivate void AddValidations()\\n{\\n_userName.Validations.Add(n\", \"ew IsNotNullOrEmptyRule<string>\\n{\\nValidationMessage = \\\"A username is required.\\\"\\n});\\n_password.Valida\", \"tions.Add(new IsNotNullOrEmptyRule<string>\\n{\\nValidationMessage = \\\"A password is required.\\\"\\n});\\n}\\nThi\", \"s method adds the IsNotNullOrEmptyRule<T> validation rule to the Validations collection of\\neach Vali\", \"datableObject<T> instance, specifying values for the validation rule's ValidationMessage\\nproperty, w\", \"hich specifies the validation error message that will be displayed if validation fails.\\nTriggering v\", \"alidation\\nThe validation approach used in the eShopOnContainers mobile app can manually trigger vali\", \"dation\\nof a property, and automatically trigger validation when a property changes.\\nTriggering valid\", \"ation manually\\nValidation can be triggered manually for a view model property. For example, this occ\", \"urs in the\\neShopOnContainers mobile app when the user taps the Login button on the LoginView, when u\", \"sing\\nmock services. The command delegate calls the MockSignInAsync method in the LoginViewModel,\\nwhi\", \"ch invokes validation by executing the Validate method, which is shown in the following code\\nexample\", \":\\nprivate bool Validate()\\n{\\nbool isValidUser = ValidateUserName();\\nbool isValidPassword = ValidatePa\", \"ssword();\\nreturn isValidUser && isValidPassword;\\n}\\nprivate bool ValidateUserName()\\n{\\nreturn _userNam\", \"e.Validate();\\n}\\nprivate bool ValidatePassword()\\n{\\nreturn _password.Validate();\\n}\\nThe Validate method\", \" performs validation of the username and password entered by the user on the\\nLoginView, by invoking \", \"the Validate method on each ValidatableObject<T> instance. The\\nfollowing code example shows the Vali\", \"date method from the ValidatableObject<T> class:\\npublic bool Validate()\\n{\\nErrors.Clear();\\nIEnumerabl\", \"e<string> errors = _validations\\n.Where(v => !v.Check(Value))\\n.Select(v => v.ValidationMessage);\\n39 C\", \"HAPTER 6 | ValidationErrors = errors.ToList();\\nIsValid = !Errors.Any();\\nreturn this.IsValid;\\n}\\nThis \", \"method clears the Errors collection, and then retrieves any validation rules that were added to\\nthe \", \"object's Validations collection. The Check method for each retrieved validation rule is executed,\\nan\", \"d the ValidationMessage property value for any validation rule that fails to validate the data is\\nad\", \"ded to the Errors collection of the ValidatableObject<T> instance. Finally, the IsValid property\\nis \", \"set, and its value is returned to the calling method, indicating whether validation succeeded or\\nfai\", \"led.\\nTriggering validation when properties change\\nValidation is also automatically triggered wheneve\", \"r a bound property changes. For example, when a\\ntwo-way binding in the LoginView sets the UserName o\", \"r Password property, validation is triggered.\\nThe following code example demonstrates how this occur\", \"s:\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\">\\n<Entry.Behaviors>\\n<behaviors:EventToCommandB\", \"ehavior\\nEventName=\\\"TextChanged\\\"\\nCommand=\\\"{Binding ValidateUserNameCommand}\\\" />\\n</Entry.Behaviors>\\n..\", \".\\n</Entry>\\nThe Entry control binds to the UserName.Value property of the ValidatableObject<T> instan\", \"ce,\\nand the control's Behaviors collection has an EventToCommandBehavior instance added to it. This\\n\", \"behavior executes the ValidateUserNameCommand in response to the TextChanged event firing on\\nthe Ent\", \"ry, which is raised when the text in the Entry changes. In turn, the\\nValidateUserNameCommand delegat\", \"e executes the ValidateUserName method, which executes the\\nValidate method on the ValidatableObject<\", \"T> instance. Therefore, every time the user enters a\\ncharacter in the Entry control for the username\", \", validation of the entered data is performed.\\nFor more information about behaviors, see Implementin\", \"g behaviors.\\nDisplaying validation errors\\nThe eShopOnContainers mobile app notifies the user of any \", \"validation errors by highlighting the\\ncontrol that contains the invalid data with a red line, and by\", \" displaying an error message that informs\\nthe user why the data is invalid below the control contain\", \"ing the invalid data. When the invalid data is\\ncorrected, the line changes to black and the error me\", \"ssage is removed. Figure 6-2 shows the\\nLoginView in the eShopOnContainers mobile app when validation\", \" errors are present.\\n40 CHAPTER 6 | ValidationFigure 6-2: Displaying validation errors during login\\n\", \"Highlighting a control that contains invalid data\\nThe LineColorBehavior attached behavior is used to\", \" highlight Entry controls where validation\\nerrors have occurred. The following code example shows ho\", \"w the LineColorBehavior attached\\nbehavior is attached to an Entry control:\\n<Entry Text=\\\"{Binding Use\", \"rName.Value, Mode=TwoWay}\\\">\\n<Entry.Style>\\n<OnPlatform x:TypeArguments=\\\"Style\\\"\\niOS=\\\"{StaticResource E\", \"ntryStyle}\\\"\\nAndroid=\\\"{StaticResource EntryStyle}\\\"\\nWinPhone=\\\"{StaticResource UwpEntryStyle}\\\"/>\\n</Entr\", \"y.Style>\\n...\\n</Entry>\\nThe Entry control consumes an explicit style, which is shown in the following \", \"code example:\\n<Style x:Key=\\\"EntryStyle\\\"\\nTargetType=\\\"{x:Type Entry}\\\">\\n...\\n<Setter Property=\\\"behaviors\", \":LineColorBehavior.ApplyLineColor\\\"\\nValue=\\\"True\\\" />\\n<Setter Property=\\\"behaviors:LineColorBehavior.Lin\", \"eColor\\\"\\nValue=\\\"{StaticResource BlackColor}\\\" />\\n...\\n</Style>\\nThis style sets the ApplyLineColor and L\", \"ineColor attached properties of the LineColorBehavior\\nattached behavior on the Entry control. For mo\", \"re information about styles, see Styles on the Xamarin\\nDeveloper Center.\\nWhen the value of the Apply\", \"LineColor attached property is set, or changes, the LineColorBehavior\\nattached behavior executes the\", \" OnApplyLineColorChanged method, which is shown in the following\\ncode example:\\n41 CHAPTER 6 | Valida\", \"tionpublic static class LineColorBehavior\\n{\\n...\\nprivate static void OnApplyLineColorChanged(\\nBindabl\", \"eObject bindable, object oldValue, object newValue)\\n{\\nvar view = bindable as View;\\nif (view == null)\", \"\\n{\\nreturn;\\n}\\nbool hasLine = (bool)newValue;\\nif (hasLine)\\n{\\nview.Effects.Add(new EntryLineColorEffect\", \"());\\n}\\nelse\\n{\\nvar entryLineColorEffectToRemove =\\nview.Effects.FirstOrDefault(e => e is EntryLineColo\", \"rEffect);\\nif (entryLineColorEffectToRemove != null)\\n{\\nview.Effects.Remove(entryLineColorEffectToRemo\", \"ve);\\n}\\n}\\n}\\n}\\nThe parameters for this method provide the instance of the control that the behavior is\", \" attached to,\\nand the old and new values of the ApplyLineColor attached property. The EntryLineColor\", \"Effect\\nclass is added to the control's Effects collection if the ApplyLineColor attached property is\", \" true,\\notherwise it's removed from the control's Effects collection. For more information about beha\", \"viors,\\nsee Implementing behaviors.\\nThe EntryLineColorEffect subclasses the RoutingEffect class, and \", \"is shown in the following code\\nexample:\\npublic class EntryLineColorEffect : RoutingEffect\\n{\\npublic E\", \"ntryLineColorEffect() : base(\\\"eShopOnContainers.EntryLineColorEffect\\\")\\n{\\n}\\n}\\nThe RoutingEffect class\", \" represents a platform-independent effect that wraps an inner effect that's\\nplatform-specific. This \", \"simplifies the effect removal process, since there is no compile-time access to\\nthe type information\", \" for a platform-specific effect. The EntryLineColorEffect calls the base class\\nconstructor, passing \", \"in a parameter consisting of a concatenation of the resolution group name, and\\nthe unique ID that's \", \"specified on each platform-specific effect class.\\nThe following code example shows the eShopOnContai\", \"ners.EntryLineColorEffect implementation for\\niOS:\\n[assembly: ResolutionGroupName(\\\"eShopOnContainers\\\"\", \")]\\n[assembly: ExportEffect(typeof(EntryLineColorEffect), \\\"EntryLineColorEffect\\\")]\\nnamespace eShopOnC\", \"ontainers.iOS.Effects\\n{\\npublic class EntryLineColorEffect : PlatformEffect\\n42 CHAPTER 6 | Validation\", \"{\\nUITextField control;\\nprotected override void OnAttached()\\n{\\ntry\\n{\\ncontrol = Control as UITextField\", \";\\nUpdateLineColor();\\n}\\ncatch (Exception ex)\\n{\\nConsole.WriteLine(\\\"Can't set property on attached cont\", \"rol. Error: \\\", ex.Message);\\n}\\n}\\nprotected override void OnDetached()\\n{\\ncontrol = null;\\n}\\nprotected o\", \"verride void OnElementPropertyChanged(PropertyChangedEventArgs args)\\n{\\nbase.OnElementPropertyChanged\", \"(args);\\nif (args.PropertyName == LineColorBehavior.LineColorProperty.PropertyName ||\\nargs.PropertyNa\", \"me == \\\"Height\\\")\\n{\\nInitialize();\\nUpdateLineColor();\\n}\\n}\\nprivate void Initialize()\\n{\\nvar entry = Eleme\", \"nt as Entry;\\nif (entry != null)\\n{\\nControl.Bounds = new CGRect(0, 0, entry.Width, entry.Height);\\n}\\n}\\n\", \"private void UpdateLineColor()\\n{\\nBorderLineLayer lineLayer = control.Layer.Sublayers.OfType<BorderLi\", \"neLayer>()\\n.FirstOrDefault();\\nif (lineLayer == null)\\n{\\nlineLayer = new BorderLineLayer();\\nlineLayer.\", \"MasksToBounds = true;\\nlineLayer.BorderWidth = 1.0f;\\ncontrol.Layer.AddSublayer(lineLayer);\\ncontrol.Bo\", \"rderStyle = UITextBorderStyle.None;\\n}\\nlineLayer.Frame = new CGRect(0f, Control.Frame.Height-1f, Cont\", \"rol.Bounds.Width, 1f);\\nlineLayer.BorderColor = LineColorBehavior.GetLineColor(Element).ToCGColor();\\n\", \"control.TintColor = control.TextColor;\\n}\\nprivate class BorderLineLayer : CALayer\\n{\\n}\\n43 CHAPTER 6 | \", \"Validation}\\n}\\nThe OnAttached method retrieves the native control for the Xamarin.Forms Entry control\", \", and\\nupdates the line color by calling the UpdateLineColor method. The OnElementPropertyChanged\\nove\", \"rride responds to bindable property changes on the Entry control by updating the line color if the\\na\", \"ttached LineColor property changes, or the Height property of the Entry changes. For more\\ninformatio\", \"n about effects, see Effects on the Xamarin Developer Center.\\nWhen valid data is entered in the Entr\", \"y control, it will apply a black line to the bottom of the control,\\nto indicate that there is no val\", \"idation error. Figure 6-3 shows an example of this.\\nFigure 6-3: Black line indicating no validation \", \"error\\nThe Entry control also has a DataTrigger added to its Triggers collection. The following code\\n\", \"example shows the DataTrigger:\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\">\\n...\\n<Entry.Trigg\", \"ers>\\n<DataTrigger\\nTargetType=\\\"Entry\\\"\\nBinding=\\\"{Binding UserName.IsValid}\\\"\\nValue=\\\"False\\\">\\n<Setter Pro\", \"perty=\\\"behaviors:LineColorBehavior.LineColor\\\"\\nValue=\\\"{StaticResource ErrorColor}\\\" />\\n</DataTrigger>\\n\", \"</Entry.Triggers>\\n</Entry>\\nThis DataTrigger monitors the UserName.IsValid property, and if it's valu\", \"e becomes false, it\\nexecutes the Setter, which changes the LineColor attached property of the LineCo\", \"lorBehavior\\nattached behavior to red. Figure 6-4 shows an example of this.\\nFigure 6-4: Red line indi\", \"cating validation error\\nThe line in the Entry control will remain red while the entered data is inva\", \"lid, otherwise it will change\\nto black to indicate that the entered data is valid.\\nFor more informat\", \"ion about Triggers, see Triggers on the Xamarin Developer Center.\\nDisplaying error messages\\nThe UI d\", \"isplays validation error messages in Label controls below each control whose data failed\\nvalidation.\", \" The following code example shows the Label that displays a validation error message if\\nthe user has\", \" not entered a valid username:\\n44 CHAPTER 6 | Validation<Label Text=\\\"{Binding UserName.Errors, Conve\", \"rter={StaticResource FirstValidationErrorConverter}\\\"\\nStyle=\\\"{StaticResource ValidationErrorLabelStyl\", \"e}\\\" />\\nEach Label binds to the Errors property of the view model object that's being validated. The \", \"Errors\\nproperty is provided by the ValidatableObject<T> class, and is of type List<string>. Because \", \"the\\nErrors property can contain multiple validation errors, the FirstValidationErrorConverter\\ninstan\", \"ce is used to retrieve the first error from the collection for display.\\nSummary\\nThe eShopOnContainer\", \"s mobile app performs synchronous client-side validation of view model\\nproperties and notifies the u\", \"ser of any validation errors by highlighting the control that contains the\\ninvalid data, and by disp\", \"laying error messages that inform the user why the data is invalid.\\nView model properties that requi\", \"re validation are of type ValidatableObject<T>, and each\\nValidatableObject<T> instance has validatio\", \"n rules added to its Validations property. Validation\\nis invoked from the view model by calling the \", \"Validate method of the ValidatableObject<T>\\ninstance, which retrieves the validation rules and execu\", \"tes them against the ValidatableObject<T>\\nValue property. Any validation errors are placed into the \", \"Errors property of the\\nValidatableObject<T> instance, and the IsValid property of the ValidatableObj\", \"ect<T> instance\\nis updated to indicate whether validation succeeded or failed.\\n45 CHAPTER 6 | Valida\", \"tion7\\nCHAPTER\\nConfiguration\\nmanagement\\nSettings allow the separation of data that configures the beh\", \"avior of an app from the code, allowing\\nthe behavior to be changed without rebuilding the app. There\", \" are two types of settings: app settings,\\nand user settings.\\nApp settings are data that an app creat\", \"es and manages. It can include data such as fixed web service\\nendpoints, API keys, and runtime state\", \". App settings are tied to the existence of the app and are only\\nmeaningful to that app.\\nUser settin\", \"gs are the customizable settings of an app that affect the behavior of the app and don't\\nrequire fre\", \"quent re-adjustment. For example, an app might let the user specify where to retrieve data\\nfrom, and\", \" how to display it on the screen.\\nXamarin.Forms includes a persistent dictionary that can be used to\", \" store settings data. This dictionary\\ncan be accessed using the Application.Current.Properties prope\", \"rty, and any data that's placed\\ninto it is saved when the app goes into a sleep state, and is restor\", \"ed when the app resumes or starts\\nup again. In addition, the Application class also has a SaveProper\", \"tiesAsync method that allows an\\napp to have its settings saved when required. For more information a\", \"bout this dictionary, see\\nProperties Dictionary on the Xamarin Developer Center.\\nA downside to stori\", \"ng data using the Xamarin.Forms persistent dictionary is that it's not easily data\\nbound to. Therefo\", \"re, the eShopOnContainers mobile app uses the Xam.Plugins.Settings library,\\navailable from NuGet. Th\", \"is library provides a consistent, type-safe, cross-platform approach for\\npersisting and retrieving a\", \"pp and user settings, while using the native settings management provided\\nby each platform. In addit\", \"ion, it's straightforward to use data binding to access settings data exposed\\nby the library.\\nNote: \", \"While the Xam.Plugin.Settings library can store both app and user settings, it makes no\\ndistinction \", \"between the two.\\nCreating a settings class\\nWhen using the Xam.Plugins.Settings library, a single sta\", \"tic class should be created that will contain\\nthe app and user settings required by the app. The fol\", \"lowing code example shows the Settings class\\nin the eShopOnContainers mobile app:\\n46 CHAPTER 7 | Con\", \"figuration managementpublic static class Settings\\n{\\nprivate static ISettings AppSettings\\n{\\nget\\n{\\nret\", \"urn CrossSettings.Current;\\n}\\n}\\n...\\n}\\nSettings can be read and written through the ISettings API, whi\", \"ch is provided by the\\nXam.Plugins.Settings library. This library provides a singleton that can be us\", \"ed to access the API,\\nCrossSettings.Current, and an app's settings class should expose this singleto\", \"n via an ISettings\\nproperty.\\nNote: Using directives for the Plugin.Settings and Plugin.Settings.Abst\", \"ractions\\nnamespaces should be added to a class that requires access to the Xam.Plugins.Settings libr\", \"ary\\ntypes.\\nAdding a setting\\nEach setting consists of a key, a default value, and a property. The fol\", \"lowing code example shows all\\nthree items for a user setting that represents the base URL for the on\", \"line services that the\\neShopOnContainers mobile app connects to:\\npublic static class Settings\\n{\\n...\\n\", \"private const string IdUrlBase = \\\"url_base\\\";\\nprivate static readonly string UrlBaseDefault = GlobalS\", \"etting.Instance.BaseEndpoint;\\n...\\npublic static string UrlBase\\n{\\nget\\n{\\nreturn AppSettings.GetValueOr\", \"Default<string>(IdUrlBase, UrlBaseDefault);\\n}\\nset\\n{\\nAppSettings.AddOrUpdateValue<string>(IdUrlBase, \", \"value);\\n}\\n}\\n}\\nThe key is always a const string that defines the key name, with the default value for\", \" the setting\\nbeing a static readonly value of the required type. Providing a default value ensures t\", \"hat a valid\\nvalue is available if an unset setting is retrieved.\\nThe UrlBase static property uses tw\", \"o methods from the ISettings API to read or write the setting\\nvalue. The ISettings.GetValueOrDefault\", \" method is used to retrieve a setting's value from\\nplatform-specific storage. If no value is defined\", \" for the setting, its default value is retrieved instead.\\nSimilarly, the ISettings.AddOrUpdateValue \", \"method is used to persist a setting's value to platform-\\nspecific storage.\\n47 CHAPTER 7 | Configurat\", \"ion managementRather that define a default value inside the Settings class, the UrlBaseDefault strin\", \"g obtains its\\nvalue from the GlobalSetting class. The following code example shows the BaseEndpoint \", \"property\\nand UpdateEndpoint method in this class:\\npublic class GlobalSetting\\n{\\n...\\npublic string Bas\", \"eEndpoint\\n{\\nget { return _baseEndpoint; }\\nset\\n{\\n_baseEndpoint = value;\\nUpdateEndpoint(_baseEndpoint)\", \";\\n}\\n}\\n...\\nprivate void UpdateEndpoint(string baseEndpoint)\\n{\\nRegisterWebsite = string.Format(\\\"{0}:51\", \"05/Account/Register\\\", baseEndpoint);\\nCatalogEndpoint = string.Format(\\\"{0}:5101\\\", baseEndpoint);\\nOrde\", \"rsEndpoint = string.Format(\\\"{0}:5102\\\", baseEndpoint);\\nBasketEndpoint = string.Format(\\\"{0}:5103\\\", bas\", \"eEndpoint);\\nIdentityEndpoint = string.Format(\\\"{0}:5105/connect/authorize\\\", baseEndpoint);\\nUserInfoEn\", \"dpoint = string.Format(\\\"{0}:5105/connect/userinfo\\\", baseEndpoint);\\nTokenEndpoint = string.Format(\\\"{0\", \"}:5105/connect/token\\\", baseEndpoint);\\nLogoutEndpoint = string.Format(\\\"{0}:5105/connect/endsession\\\", \", \"baseEndpoint);\\nIdentityCallback = string.Format(\\\"{0}:5105/xamarincallback\\\", baseEndpoint);\\nLogoutCal\", \"lback = string.Format(\\\"{0}:5105/Account/Redirecting\\\", baseEndpoint);\\n}\\n}\\nEach time the BaseEndpoint \", \"property is set, the UpdateEndpoint method is called. This method\\nupdates a series of properties, al\", \"l of which are based on the UrlBase user setting that's provided by\\nthe Settings class that represen\", \"t different endpoints that the eShopOnContainers mobile app\\nconnects to.\\nData binding to user settin\", \"gs\\nIn the eShopOnContainers mobile app, the SettingsView exposes two user settings. These settings\\na\", \"llow configuration of whether the app should retrieve data from microservices that are deployed as\\nD\", \"ocker containers, or whether the app should retrieve data from mock services that don't require an\\ni\", \"nternet connection. When choosing to retrieve data from containerized microservices, a base\\nendpoint\", \" URL for the microservices must be specified. Figure 7-1 shows the SettingsView when the\\nuser has ch\", \"osen to retrieve data from containerized microservices.\\n48 CHAPTER 7 | Configuration managementFigur\", \"e 7-1: User settings exposed by the eShopOnContainers mobile app\\nData binding can be used to retriev\", \"e and set settings exposed by the Settings class. This is achieved\\nby controls on the view binding t\", \"o view model properties that in turn access properties in the\\nSettings class, and raising a property\", \" changed notification if the settings value has changed. For\\ninformation about how the eShopOnContai\", \"ners mobile app constructs view models and associates\\nthem to views, see Automatically creating a vi\", \"ew model with a view model locator.\\nThe following code example shows the Entry control from the Sett\", \"ingsView that allows the user to\\nenter a base endpoint URL for the containerized microservices:\\n<Ent\", \"ry Text=\\\"{Binding Endpoint, Mode=TwoWay}\\\" />\\nThis Entry control binds to the Endpoint property of th\", \"e SettingsViewModel class, using a two-way\\nbinding. The following code example shows the Endpoint pr\", \"operty:\\npublic string Endpoint\\n{\\nget { return _endpoint; }\\nset\\n{\\n_endpoint = value;\\nif(!string.IsNul\", \"lOrEmpty(_endpoint))\\n{\\nUpdateEndpoint(_endpoint);\\n}\\nRaisePropertyChanged(() => Endpoint);\\n}\\n}\\nWhen t\", \"he Endpoint property is set the UpdateEndpoint method is called, provided that the supplied\\nvalue is\", \" valid, and property changed notification is raised. The following code example shows the\\nUpdateEndp\", \"oint method:\\nprivate void UpdateEndpoint(string endpoint)\\n{\\nSettings.UrlBase = endpoint;\\n}\\n49 CHAPTE\", \"R 7 | Configuration managementThis method updates the UrlBase property in the Settings class with th\", \"e base endpoint URL value\\nentered by the user, which causes it to be persisted to platform-specific \", \"storage.\\nWhen the SettingsView is navigated to, the InitializeAsync method in the SettingsViewModel\\n\", \"class is executed. The following code example shows this method:\\npublic override Task InitializeAsyn\", \"c(object navigationData)\\n{\\n...\\nEndpoint = Settings.UrlBase;\\n...\\n}\\nThe method sets the Endpoint prope\", \"rty to the value of the UrlBase property in the Settings class.\\nAccessing the UrlBase property cause\", \"s the Xam.Plugins.Settings library to retrieve the settings value\\nfrom platform-specific storage. Fo\", \"r information about how the InitializeAsync method is invoked,\\nsee Passing parameters during navigat\", \"ion.\\nThis mechanism ensures that whenever a user navigates to the SettingsView, user settings are\\nre\", \"trieved from platform-specific storage and presented through data binding. Then, if the user\\nchanges\", \" the settings values, data binding ensures that they are immediately persisted back to\\nplatform-spec\", \"ific storage.\\nSummary\\nSettings allow the separation of data that configures the behavior of an app f\", \"rom the code, allowing\\nthe behavior to be changed without rebuilding the app. App settings are data \", \"that an app creates and\\nmanages, and user settings are the customizable settings of an app that affe\", \"ct the behavior of the app\\nand don't require frequent re-adjustment.\\nThe Xam.Plugins.Settings librar\", \"y provides a consistent, type-safe, cross-platform approach for\\npersisting and retrieving app and us\", \"er settings, and data binding can be used to access settings\\ncreated with the library.\\n50 CHAPTER 7 \", \"| Configuration management8\\nCHAPTER\\nContainerized\\nmicroservices\\nDeveloping client-server application\", \"s has resulted in a focus on building tiered applications that use\\nspecific technologies in each tie\", \"r. Such applications are often referred to as monolithic applications,\\nand are packaged onto hardwar\", \"e pre-scaled for peak loads. The main drawbacks of this development\\napproach are the tight coupling \", \"between components within each tier, that individual components\\ncan't be easily scaled, and the cost\", \" of testing. A simple update can have unforeseen effects on the rest\\nof the tier, and so a change to\", \" an application component requires its entire tier to be retested and\\nredeployed.\\nParticularly conce\", \"rning in the age of the cloud, is that individual components can't be easily scaled. A\\nmonolithic ap\", \"plication contains domain-specific functionality, and is typically divided by functional\\nlayers such\", \" as front end, business logic, and data storage. A monolithic application is scaled by\\ncloning the e\", \"ntire application onto multiple machines, as illustrated in Figure 8-1.\\nFigure 8-1: Monolithic appli\", \"cation scaling approach\\n51 CHAPTER 8 | Containerized microservicesMicroservices\\nMicroservices offer \", \"a different approach to application development and deployment, an approach\\nthat's suited to the agi\", \"lity, scale, and reliability requirements of modern cloud applications. A\\nmicroservices application \", \"is decomposed into independent components that work together to deliver\\nthe application's overall fu\", \"nctionality. The term microservice emphasizes that applications should be\\ncomposed of services small\", \" enough to reflect independent concerns, so that each microservice\\nimplements a single function. In \", \"addition, each microservice has well-defined contracts so that other\\nmicroservices can communicate a\", \"nd share data with it. Typical examples of microservices include\\nshopping carts, inventory processin\", \"g, purchase subsystems, and payment processing.\\nMicroservices can scale-out independently, as compar\", \"ed to giant monolithic applications that scale\\ntogether. This means that a specific functional area,\", \" that requires more processing power or network\\nbandwidth to support demand, can be scaled rather th\", \"an unnecessarily scaling-out other areas of the\\napplication. Figure 8-2 illustrates this approach, w\", \"here microservices are deployed and scaled\\nindependently, creating instances of services across mach\", \"ines.\\nFigure 8-2: Microservices application scaling approach\\nMicroservice scale-out can be nearly in\", \"stantaneous, allowing an application to adapt to changing\\nloads. For example, a single microservice \", \"in the web-facing functionality of an application might be\\nthe only microservice in the application \", \"that needs to scale out to handle additional incoming traffic.\\nThe classic model for application sca\", \"lability is to have a load-balanced, stateless tier with a shared\\nexternal datastore to store persis\", \"tent data. Stateful microservices manage their own persistent data,\\nusually storing it locally on th\", \"e servers on which they are placed, to avoid the overhead of network\\naccess and complexity of cross-\", \"service operations. This enables the fastest possible processing of data\\nand can eliminate the need \", \"for caching systems. In addition, scalable stateful microservices usually\\npartition data among their\", \" instances, in order to manage data size and transfer throughput beyond\\nwhich a single server can su\", \"pport.\\nMicroservices also support independent updates. This loose coupling between microservices pro\", \"vides\\na rapid and reliable application evolution. Their independent, distributed nature supports rol\", \"ling\\nupdates, where only a subset of instances of a single microservice will update at any given tim\", \"e.\\nTherefore, if a problem is detected, a buggy update can be rolled back, before all instances upda\", \"te\\nwith the faulty code or configuration. Similarly, microservices typically use schema versioning, \", \"so that\\n52 CHAPTER 8 | Containerized microservicesclients see a consistent version when updates are \", \"being applied, regardless of which microservice\\ninstance is being communicated with.\\nTherefore, micr\", \"oservice applications have many benefits over monolithic applications:\\n\\u2022 Each microservice is relati\", \"vely small, easy to manage and evolve.\\n\\u2022 Each microservice can be developed and deployed independent\", \"ly of other services.\\n\\u2022 Each microservice can be scaled-out independently. For example, a catalog se\", \"rvice or\\nshopping basket service might need to be scaled-out more than an ordering service.\\nTherefor\", \"e, the resulting infrastructure will more efficiently consume resources when scaling\\nout.\\n\\u2022 Each mic\", \"roservice isolates any issues. For example, if there is an issue in a service it only\\nimpacts that s\", \"ervice. The other services can continue to handle requests.\\n\\u2022 Each microservice can use the latest t\", \"echnologies. Because microservices are autonomous and\\nrun side-by-side, the latest technologies and \", \"frameworks can be used, rather than being\\nforced to use an older framework that might be used by a m\", \"onolithic application.\\nHowever, a microservice based solution also has potential drawbacks:\\n\\u2022 Choosi\", \"ng how to partition an application into microservices can be challenging, as each\\nmicroservice has t\", \"o be completely autonomous, end-to-end, including responsibility for its\\ndata sources.\\n\\u2022 Developers \", \"must implement inter-service communication, which adds complexity and latency\\nto the application.\\n\\u2022 \", \"Atomic transactions between multiple microservices usually aren't possible. Therefore,\\nbusiness requ\", \"irements must embrace eventual consistency between microservices.\\n\\u2022 In production, there is an opera\", \"tional complexity in deploying and managing a system\\ncompromised of many independent services.\\n\\u2022 Dir\", \"ect client-to-microservice communication can make it difficult to refactor the contracts of\\nmicroser\", \"vices. For example, over time how the system is partitioned into services might need\\nto change. A si\", \"ngle service might split into two or more services, and two services might\\nmerge. When clients commu\", \"nicate directly with microservices, this refactoring work can break\\ncompatibility with client apps.\\n\", \"Containerization\\nContainerization is an approach to software development in which an application and\", \" its versioned set\\nof dependencies, plus its environment configuration abstracted as deployment mani\", \"fest files, are\\npackaged together as a container image, tested as a unit, and deployed to a host ope\", \"rating system.\\nA container is an isolated, resource controlled, and portable operating environment, \", \"where an\\napplication can run without touching the resources of other containers, or the host. Theref\", \"ore, a\\ncontainer looks and acts like a newly installed physical computer or a virtual machine.\\nThere\", \" are many similarities between containers and virtual machines, as illustrated in Figure 8-3.\\n53 CHA\", \"PTER 8 | Containerized microservicesFigure 8-3: Comparison of virtual machines and containers\\nA cont\", \"ainer runs an operating system, has a file system, and can be accessed over a network as if it\\nwere \", \"a physical or virtual machine. However, the technology and concepts used by containers are very\\ndiff\", \"erent from virtual machines. Virtual machines include the applications, the required dependencies,\\na\", \"nd a full guest operating system. Containers include the application and its dependencies, but share\", \"\\nthe operating system with other containers, running as isolated processes on the host operating\\nsys\", \"tem (aside from Hyper-V containers which run inside of a special virtual machine per container).\\nThe\", \"refore, containers share resources and typically require fewer resources than virtual machines.\\nThe \", \"advantage of a container-oriented development and deployment approach is that it eliminates\\nmost of \", \"the issues that arise from inconsistent environment setups and the problems that come with\\nthem. In \", \"addition, containers permit fast application scale-up functionality by instancing new\\ncontainers as \", \"required.\\nThe key concepts when creating and working with containers are:\\n\\u2022 Container Host: The phys\", \"ical or virtual machine configured to host containers. The container\\nhost will run one or more conta\", \"iners.\\n\\u2022 Container Image: An image consists of a union of layered filesystems stacked on top of each\", \"\\nother, and is the basis of a container. An image does not have state and it never changes as\\nit's d\", \"eployed to different environments.\\n\\u2022 Container: A container is a runtime instance of an image.\\n\\u2022 Con\", \"tainer OS Image: Containers are deployed from images. The container operating system\\nimage is the fi\", \"rst layer in potentially many image layers that make up a container. A container\\noperating system is\", \" immutable, and can't be modified.\\n\\u2022 Container Repository: Each time a container image is created, t\", \"he image and its dependencies\\nare stored in a local repository. These images can be reused many time\", \"s on the container\\nhost. The container images can also be stored in a public or private registry, su\", \"ch as Docker\\nHub, so that they can be used across different container hosts.\\n54 CHAPTER 8 | Containe\", \"rized microservicesEnterprises are increasingly adopting containers when implementing microservice b\", \"ased applications,\\nand Docker has become the standard container implementation that has been adopted\", \" by most\\nsoftware platforms and cloud vendors.\\nThe eShopOnContainers reference application uses Dock\", \"er to host four containerized back-end\\nmicroservices, as illustrated in Figure 8-4.\\nFigure 8-4: eSho\", \"pOnContainers reference application back-end microservices\\nThe architecture of the back-end services\", \" in the reference application is decomposed into multiple\\nautonomous sub-systems in the form of coll\", \"aborating microservices and containers. Each microservice\\nprovides a single area of functionality: a\", \"n identity service, a catalog service, an ordering service, and a\\nbasket service.\\nEach microservice \", \"has its own database, allowing it to be fully decoupled from the other\\nmicroservices. Where necessar\", \"y, consistency between databases from different microservices is\\nachieved using application-level ev\", \"ents. For more information, see Communication between\\nmicroservices.\\nFor more information about the \", \"reference application, see .NET Microservices: Architecture for\\nContainerized .NET Applications.\\nCom\", \"munication between client and microservices\\nThe eShopOnContainers mobile app communicates with the c\", \"ontainerized back-end microservices\\nusing direct client-to-microservice communication, which is show\", \"n in Figure 8-5.\\n55 CHAPTER 8 | Containerized microservicesFigure 8-5: Direct client-to-microservice\", \" communication\\nWith direct client-to-microservice communication, the mobile app makes requests to ea\", \"ch\\nmicroservice directly through its public endpoint, with a different TCP port per microservice. In\", \"\\nproduction, the endpoint would typically map to the microservice's load balancer, which distributes\", \"\\nrequests across the available instances.\\nTip: Consider using API gateway communication\\nDirect clien\", \"t-to-microservice communication can have drawbacks when building a large and\\ncomplex microservice ba\", \"sed application, but it's more than adequate for a small application. When\\ndesigning a large microse\", \"rvice based application with tens of microservices, consider using API\\ngateway communication. For mo\", \"re information, see .NET Microservices: Architecture for\\nContainerized .NET Applications.\\nCommunicat\", \"ion between microservices\\nA microservices based application is a distributed system, potentially run\", \"ning on multiple machines.\\nEach service instance is typically a process. Therefore, services must in\", \"teract using an inter-process\\ncommunication protocol, such as HTTP, TCP, Advanced Message Queuing Pr\", \"otocol (AMQP), or binary\\nprotocols, depending on the nature of each service.\\nThe two common approach\", \"es for microservice-to-microservice communication are HTTP based REST\\ncommunication when querying fo\", \"r data, and lightweight asynchronous messaging when\\ncommunicating updates across multiple microservi\", \"ces.\\nAsynchronous messaging based event-driven communication is critical when propagating changes\\nac\", \"ross multiple microservices. With this approach, a microservice publishes an event when something\\nno\", \"table happens, for example, when it updates a business entity. Other microservices subscribe to\\nthes\", \"e events. Then, when a microservice receives an event, it updates its own business entities, which\\nm\", \"ight in turn lead to more events being published. This publish-subscribe functionality is usually\\nac\", \"hieved with an event bus.\\nAn event bus allows publish-subscribe communication between microservices,\", \" without requiring the\\ncomponents to be explicitly aware of each other, as shown in Figure 8-6.\\n56 C\", \"HAPTER 8 | Containerized microservicesFigure 8-6: Publish-subscribe with an event bus\\nFrom an applic\", \"ation perspective, the event bus is simply a publish-subscribe channel exposed via an\\ninterface. How\", \"ever, the way the event bus is implemented can vary. For example, an event bus\\nimplementation could \", \"use RabbitMQ, Azure Service Bus, or other service buses such as NServiceBus\\nand MassTransit. Figure \", \"8-7 shows how an event bus is used in the eShopOnContainers reference\\napplication.\\nFigure 8-7: Async\", \"hronous event-driven communication in the reference application\\nThe eShopOnContainers event bus, imp\", \"lemented using RabbitMQ, provides one-to-many\\nasynchronous publish-subscribe functionality. This mea\", \"ns that after publishing an event, there can be\\nmultiple subscribers listening for the same event. F\", \"igure 8-9 illustrates this relationship.\\n57 CHAPTER 8 | Containerized microservicesFigure 8-9: One-t\", \"o-many communication\\nThis one-to-many communication approach uses events to implement business trans\", \"actions that span\\nmultiple services, ensuring eventual consistency between the services. An eventual\", \"-consistent\\ntransaction consists of a series of distributed steps. Therefore, when the user-profile \", \"microservice\\nreceives the UpdateUser command, it updates the user's details in its database and publ\", \"ishes the\\nUserUpdated event to the event bus. Both the basket microservice and the ordering microser\", \"vice\\nhave subscribed to receive this event, and in response update their buyer information in their\\n\", \"respective databases.\\nNote: The eShopOnContainers event bus, implemented using RabbitMQ, is intended\", \" to be used\\nonly as a proof of concept. For production systems, alternative event bus implementation\", \"s should\\nbe considered.\\nFor information about the event bus implementation, see .NET Microservices: \", \"Architecture for\\nContainerized .NET Applications.\\nSummary\\nMicroservices offer an approach to applica\", \"tion development and deployment that's suited to the\\nagility, scale, and reliability requirements of\", \" modern cloud applications. One of the main advantages\\nof microservices is that they can be scaled-o\", \"ut independently, which means that a specific functional\\narea can be scaled that requires more proce\", \"ssing power or network bandwidth to support demand,\\nwithout unnecessarily scaling areas of the appli\", \"cation that are not experiencing increased demand.\\nA container is an isolated, resource controlled, \", \"and portable operating environment, where an\\napplication can run without touching the resources of o\", \"ther containers, or the host. Enterprises are\\nincreasingly adopting containers when implementing mic\", \"roservice based applications, and Docker has\\nbecome the standard container implementation that has b\", \"een adopted by most software platforms\\nand cloud vendors.\\n58 CHAPTER 8 | Containerized microservices\", \"9\\nCHAPTER\\nAuthentication\\nand authorization\\nAuthentication is the process of obtaining identification\", \" credentials such as name and password from\\na user, and validating those credentials against an auth\", \"ority. If the credentials are valid, the entity that\\nsubmitted the credentials is considered an auth\", \"enticated identity. Once an identity has been\\nauthenticated, an authorization process determines whe\", \"ther that identity has access to a given\\nresource.\\nThere are many approaches to integrating authenti\", \"cation and authorization into a Xamarin.Forms app\\nthat communicates with an ASP.NET MVC web applicat\", \"ion, including using ASP.NET Core Identity,\\nexternal authentication providers such as Microsoft, Goo\", \"gle, Facebook, or Twitter, and authentication\\nmiddleware. The eShopOnContainers mobile app performs \", \"authentication and authorization with a\\ncontainerized identity microservice that uses IdentityServer\", \" 4. The mobile app requests security tokens\\nfrom IdentityServer, either for authenticating a user or\", \" for accessing a resource. For IdentityServer to\\nissue tokens on behalf of a user, the user must sig\", \"n-in to IdentityServer. However, IdentityServer\\ndoesn't provide a user interface or database for aut\", \"hentication. Therefore, in the eShopOnContainers\\nreference application, ASP.NET Core Identity is use\", \"d for this purpose.\\nAuthentication\\nAuthentication is required when an application needs to know the \", \"identity of the current user.\\nASP.NET Core's primary mechanism for identifying users is the ASP.NET \", \"Core Identity membership\\nsystem, which stores user information in a data store configured by the dev\", \"eloper. Typically, this data\\nstore will be an EntityFramework store, though custom stores or third p\", \"arty packages can be used to\\nstore identity information in Azure storage, DocumentDB, or other locat\", \"ions.\\nFor authentication scenarios that make use of a local user data store, and that persist identi\", \"ty\\ninformation between requests via cookies (as is typical in ASP.NET MVC web applications), ASP.NET\", \"\\nCore Identity is a suitable solution. However, cookies are not always a natural means of persisting\", \" and\\ntransmitting data. For example, an ASP.NET Core web application that exposes RESTful endpoints \", \"that\\nare accessed from a mobile app will typically need to use bearer token authentication, since co\", \"okies\\ncan't be used in this scenario. However, bearer tokens can easily be retrieved and included in\", \" the\\nauthorization header of web requests made from the mobile app.\\n59 CHAPTER 9 | Authentication an\", \"d authorizationIssuing bearer tokens using IdentityServer 4\\nIdentityServer 4 is an open source OpenI\", \"D Connect and OAuth 2.0 framework for ASP.NET Core,\\nwhich can be used for many authentication and au\", \"thorization scenarios including issuing security\\ntokens for local ASP.NET Core Identity users.\\nNote:\", \" OpenID Connect and OAuth 2.0 are very similar, while having different responsibilities.\\nOpenID Conn\", \"ect is an authentication layer on top of the OAuth 2.0 protocol. OAuth 2 is a protocol\\nthat allows a\", \"pplications to request access tokens from a security token service and use them to\\ncommunicate with \", \"APIs. This delegation reduces complexity in both client applications and APIs\\nsince authentication a\", \"nd authorization can be centralized.\\nThe combination of OpenID Connect and OAuth 2.0 combine the two\", \" fundamental security\\nconcerns of authentication and API access, and IdentityServer 4 is an implemen\", \"tation of these\\nprotocols.\\nIn applications that use direct client-to-microservice communication, suc\", \"h as the eShopOnContainers\\nreference application, a dedicated authentication microservice acting as \", \"a Security Token Service (STS)\\ncan be used to authenticate users, as shown in Figure 9-1. For more i\", \"nformation about direct client-\\nto-microservice communication, see Communication between client and \", \"microservices.\\nFigure 9-1: Authentication by a dedicated authentication microservice\\nThe eShopOnCont\", \"ainers mobile app communicates with the identity microservice, which uses\\nIdentityServer 4 to perfor\", \"m authentication, and access control for APIs. Therefore, the mobile app\\nrequests tokens from Identi\", \"tyServer, either for authenticating a user or for accessing a resource:\\n\\u2022 Authenticating users with \", \"IdentityServer is achieved by the mobile app requesting an identity\\ntoken, which represents the outc\", \"ome of an authentication process. At a bare minimum, it\\ncontains an identifier for the user, and inf\", \"ormation about how and when the user\\nauthenticated. It can also contain additional identity data.\\n\\u2022 \", \"Accessing a resource with IdentityServer is achieved by the mobile app requesting an access\\ntoken, w\", \"hich allows access to an API resource. Clients request access tokens and forward\\nthem to the API. Ac\", \"cess tokens contain information about the client, and the user (if present).\\nAPIs then use that info\", \"rmation to authorize access to their data.\\nNote: A client must be registered with IdentityServer bef\", \"ore it can request tokens.\\nAdding IdentityServer to a web application\\nIn order for an ASP.NET Core w\", \"eb application to use IdentityServer 4, it must be added to the web\\napplication's Visual Studio solu\", \"tion. For more information, see Setup and Overview in the\\nIdentityServer documentation.\\n60 CHAPTER 9\", \" | Authentication and authorizationOnce IdentityServer is included in the web application's Visual S\", \"tudio solution, it must be added to\\nthe web application's HTTP request processing pipeline, so that \", \"it can serve requests to OpenID\\nConnect and OAuth 2.0 endpoints. This is achieved in the Configure m\", \"ethod in the web application's\\nStartup class, as demonstrated in the following code example:\\npublic \", \"void Configure(\\nIApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)\\n{\\n..\", \".\\napp.UseIdentity();\\n...\\n}\\nOrder matters in the web application's HTTP request processing pipeline. \", \"Therefore, IdentityServer\\nmust be added to the pipeline before the UI framework that implements the \", \"login screen.\\nConfiguring IdentityServer\\nIdentityServer should be configured in the ConfigureService\", \"s method in the web application's\\nStartup class by calling the services.AddIdentityServer method, as\", \" demonstrated in the\\nfollowing code example from the eShopOnContainers reference application:\\npublic\", \" void ConfigureServices(IServiceCollection services)\\n{\\n...\\nservices.AddIdentityServer(x => x.IssuerU\", \"ri = \\\"null\\\")\\n.AddSigningCredential(Certificate.Get())\\n.AddAspNetIdentity<ApplicationUser>()\\n.AddConf\", \"igurationStore(builder =>\\nbuilder.UseSqlServer(connectionString, options =>\\noptions.MigrationsAssemb\", \"ly(migrationsAssembly)))\\n.AddOperationalStore(builder =>\\nbuilder.UseSqlServer(connectionString, opti\", \"ons =>\\noptions.MigrationsAssembly(migrationsAssembly)))\\n.Services.AddTransient<IProfileService, Prof\", \"ileService>();\\n}\\nAfter calling the services.AddIdentityServer method, additional fluent APIs are cal\", \"led to\\nconfigure the following:\\n\\u2022 Credentials used for signing.\\n\\u2022 API and identity resources that us\", \"ers might request access to.\\n\\u2022 Clients that will be connecting to request tokens.\\n\\u2022 ASP.NET Core Ide\", \"ntity.\\nTip: Dynamically load the IdentityServer 4 configuration\\nIdentityServer 4's APIs allow for co\", \"nfiguring IdentityServer from an in-memory list of configuration\\nobjects. In the eShopOnContainers r\", \"eference application, these in-memory collections are hard-\\ncoded into the application. However, in \", \"production scenarios they can be loaded dynamically from\\na configuration file or from a database.\\nFo\", \"r information about configuring IdentityServer to use ASP.NET Core Identity, see Using ASP.NET\\nCore \", \"Identity in the IdentityServer documentation.\\n61 CHAPTER 9 | Authentication and authorizationConfigu\", \"ring API resources\\nWhen configuring API resources, the AddInMemoryApiResources method expects an\\nIEn\", \"umerable<ApiResource> collection. The following code example shows the GetApis method that\\nprovides \", \"this collection in the eShopOnContainers reference application:\\npublic static IEnumerable<ApiResourc\", \"e> GetApis()\\n{\\nreturn new List<ApiResource>\\n{\\nnew ApiResource(\\\"orders\\\", \\\"Orders Service\\\"),\\nnew ApiRe\", \"source(\\\"basket\\\", \\\"Basket Service\\\")\\n};\\n}\\nThis method specifies that IdentityServer should protect the\", \" orders and basket APIs. Therefore,\\nIdentityServer managed access tokens will be required when makin\", \"g calls to these APIs. For more\\ninformation about the ApiResource type, see API Resource in the Iden\", \"tityServer 4 documentation.\\nConfiguring identity resources\\nWhen configuring identity resources, the \", \"AddInMemoryIdentityResources method expects an\\nIEnumerable<IdentityResource> collection. Identity re\", \"sources are data such as user ID, name, or\\nemail address. Each identity resource has a unique name, \", \"and arbitrary claim types can be assigned to\\nit, which will then be included in the identity token f\", \"or the user. The following code example shows\\nthe GetResources method that provides this collection \", \"in the eShopOnContainers reference\\napplication:\\npublic static IEnumerable<IdentityResource> GetResou\", \"rces()\\n{\\nreturn new List<IdentityResource>\\n{\\nnew IdentityResources.OpenId(),\\nnew IdentityResources.P\", \"rofile()\\n};\\n}\\nThe OpenID Connect specification specifies some standard identity resources. The minim\", \"um\\nrequirement is that support is provided for emitting a unique ID for users. This is achieved by\\ne\", \"xposing the IdentityResources.OpenId identity resource.\\nNote: The IdentityResources class supports a\", \"ll of the scopes defined in the OpenID Connect\\nspecification (openid, email, profile, telephone, and\", \" address).\\nIdentityServer also supports defining custom identity resources. For more information, se\", \"e Defining\\ncustom identity resources in the IdentityServer documentation. For more information about\", \" the\\nIdentityResource type, see Identity Resource in the IdentityServer 4 documentation.\\nConfiguring\", \" clients\\nClients are applications that can request tokens from IdentityServer. Typically, the follow\", \"ing settings\\nmust be defined for each client as a minimum:\\n\\u2022 A unique client ID.\\n\\u2022 The allowed inter\", \"actions with the token service (known as the grant type).\\n\\u2022 The location where identity and access t\", \"okens are sent to (known as a redirect URI).\\n62 CHAPTER 9 | Authentication and authorization\\u2022 A list\", \" of resources that the client is allowed access to (known as scopes).\\nWhen configuring clients, the \", \"AddInMemoryClients method expects an IEnumerable<Client>\\ncollection. The following code example show\", \"s the configuration for the eShopOnContainers mobile\\napp in the GetClients method that provides this\", \" collection in the eShopOnContainers reference\\napplication:\\npublic static IEnumerable<Client> GetCli\", \"ents(Dictionary<string,string> clientsUrl)\\n{\\nreturn new List<Client>\\n{\\n...\\nnew Client\\n{\\nClientId = \\\"\", \"xamarin\\\",\\nClientName = \\\"eShop Xamarin OpenId Client\\\",\\nAllowedGrantTypes = GrantTypes.Hybrid,\\nClientS\", \"ecrets =\\n{\\nnew Secret(\\\"secret\\\".Sha256())\\n},\\nRedirectUris = { clientsUrl[\\\"Xamarin\\\"] },\\nRequireConsent\", \" = false,\\nRequirePkce = true,\\nPostLogoutRedirectUris = { $\\\"{clientsUrl[\\\"Xamarin\\\"]}/Account/Redirecti\", \"ng\\\" },\\nAllowedCorsOrigins = { \\\"http://eshopxamarin\\\" },\\nAllowedScopes = new List<string>\\n{\\nIdentitySe\", \"rverConstants.StandardScopes.OpenId,\\nIdentityServerConstants.StandardScopes.Profile,\\nIdentityServerC\", \"onstants.StandardScopes.OfflineAccess,\\n\\\"orders\\\",\\n\\\"basket\\\"\\n},\\nAllowOfflineAccess = true,\\nAllowAccessT\", \"okensViaBrowser = true\\n},\\n...\\n};\\n}\\nThis configuration specifies data for the following properties:\\n\\u2022\", \" ClientId: A unique ID for the client.\\n\\u2022 ClientName: The client display name, which is used for logg\", \"ing and the consent screen.\\n\\u2022 AllowedGrantTypes: Specifies how a client wants to interact with Ident\", \"ityServer. For more\\ninformation see Configuring the authentication flow.\\n\\u2022 ClientSecrets: Specifies \", \"the client secret credentials that are used when requesting tokens\\nfrom the token endpoint.\\n\\u2022 Redire\", \"ctUris: Specifies the allowed URIs to which to return tokens or authorization codes.\\n\\u2022 RequireConsen\", \"t: Specifies whether a consent screen is required.\\n\\u2022 RequirePkce: Specifies whether clients using an\", \" authorization code must send a proof key.\\n\\u2022 PostLogoutRedirectUris: Specifies the allowed URIs to r\", \"edirect to after logout.\\n63 CHAPTER 9 | Authentication and authorization\\u2022 AllowedCorsOrigins: Specif\", \"ies the origin of the client so that IdentityServer can allow cross-\\norigin calls from the origin.\\n\\u2022\", \" AllowedScopes: Specifies the resources the client has access to. By default, a client has no\\naccess\", \" to any resources.\\n\\u2022 AllowOfflineAccess: Specifies whether the client can request refresh tokens.\\nCo\", \"nfiguring the authentication flow\\nThe authentication flow between a client and IdentityServer can be\", \" configured by specifying the grant\\ntypes in the Client.AllowedGrantTypes property. The OpenID Conne\", \"ct and OAuth 2.0 specifications\\ndefine a number of authentication flows, including:\\n\\u2022 Implicit. This\", \" flow is optimized for browser-based applications and should be used either for\\nuser authentication-\", \"only, or authentication and access token requests. All tokens are\\ntransmitted via the browser, and t\", \"herefore advanced features like refresh tokens are not\\npermitted.\\n\\u2022 Authorization code. This flow pr\", \"ovides the ability to retrieve tokens on a back channel, as\\nopposed to the browser front channel, wh\", \"ile also supporting client authentication.\\n\\u2022 Hybrid. This flow is a combination of the implicit and \", \"authorization code grant types. The\\nidentity token is transmitted via the browser channel and contai\", \"ns the signed protocol\\nresponse along with other artifacts such as the authorization code. After suc\", \"cessful validation\\nof the response, the back channel should be used to retrieve the access and refre\", \"sh token.\\nTip: Use the hybrid authentication flow\\nThe hybrid authentication flow mitigates a number \", \"of attacks that apply to the browser channel,\\nand is the recommended flow for native applications th\", \"at want to retrieve access tokens (and\\npossibly refresh tokens).\\nFor more information about authenti\", \"cation flows, see Grant Types in the IdentityServer 4\\ndocumentation.\\nPerforming authentication\\nFor I\", \"dentityServer to issue tokens on behalf of a user, the user must sign-in to IdentityServer.\\nHowever,\", \" IdentityServer doesn't provide a user interface or database for authentication. Therefore, in\\nthe e\", \"ShopOnContainers reference application, ASP.NET Core Identity is used for this purpose.\\nThe eShopOnC\", \"ontainers mobile app authenticates with IdentityServer with the hybrid authentication\\nflow, which is\", \" illustrated in Figure 9-2.\\nFigure 9-2: High-level overview of the sign-in process\\n64 CHAPTER 9 | Au\", \"thentication and authorizationA sign-in request is made to <base endpoint>:5105/connect/authorize. F\", \"ollowing successful\\nauthentication, IdentityServer returns an authentication response containing an \", \"authorization code\\nand an identity token. The authorization code is then sent to <base\\nendpoint>:510\", \"5/connect/token, which responds with access, identity, and refresh tokens.\\nThe eShopOnContainers mob\", \"ile app signs-out of IdentityServer by sending a request to\\nhttp://<base endpoint>:5105/connect/ends\", \"ession, with additional parameters. After sign-out\\noccurs, IdentityServer responds by sending a post\", \" logout redirect URI back to the mobile app. Figure\\n9-3 illustrates this process.\\nFigure 9-3: High-l\", \"evel overview of the sign-out process\\nIn the eShopOnContainers mobile app, communication with Identi\", \"tyServer is performed by the\\nIdentityService class, which implements the IIdentityService interface.\", \" This interface specifies\\nthat the implementing class must provide CreateAuthorizationRequest, Creat\", \"eLogoutRequest,\\nand GetTokenAsync methods.\\nSigning-in\\nWhen the user taps the LOGIN button on the Log\", \"inView, the SignInCommand in the LoginViewModel\\nclass is executed, which in turn executes the SignIn\", \"Async method. The following code example\\nshows this method:\\nprivate async Task SignInAsync()\\n{\\n...\\nL\", \"oginUrl = _identityService.CreateAuthorizationRequest();\\nIsLogin = true;\\n...\\n}\\nThis method invokes t\", \"he CreateAuthorizationRequest method in the IdentityService class,\\nwhich is shown in the following c\", \"ode example:\\npublic string CreateAuthorizationRequest()\\n{\\n// Create URI to authorization endpoint\\nva\", \"r authorizeRequest = new AuthorizeRequest(GlobalSetting.Instance.IdentityEndpoint);\\n// Dictionary wi\", \"th values for the authorize request\\nvar dic = new Dictionary<string, string>();\\ndic.Add(\\\"client_id\\\",\", \" GlobalSetting.Instance.ClientId);\\ndic.Add(\\\"client_secret\\\", GlobalSetting.Instance.ClientSecret);\\ndi\", \"c.Add(\\\"response_type\\\", \\\"code id_token\\\");\\ndic.Add(\\\"scope\\\", \\\"openid profile basket orders locations ma\", \"rketing offline_access\\\");\\ndic.Add(\\\"redirect_uri\\\", GlobalSetting.Instance.IdentityCallback);\\ndic.Add(\", \"\\\"nonce\\\", Guid.NewGuid().ToString(\\\"N\\\"));\\ndic.Add(\\\"code_challenge\\\", CreateCodeChallenge());\\ndic.Add(\\\"c\", \"ode_challenge_method\\\", \\\"S256\\\");\\n65 CHAPTER 9 | Authentication and authorization// Add CSRF token to \", \"protect against cross-site request forgery attacks.\\nvar currentCSRFToken = Guid.NewGuid().ToString(\\\"\", \"N\\\");\\ndic.Add(\\\"state\\\", currentCSRFToken);\\nvar authorizeUri = authorizeRequest.Create(dic);\\nreturn aut\", \"horizeUri;\\n}\\nThis method creates the URI for IdentityServer's authorization endpoint, with the requi\", \"red parameters.\\nThe authorization endpoint is at /connect/authorize on port 5105 of the base endpoin\", \"t exposed as\\na user setting. For more information about user settings, see Configuration management.\", \"\\nNote: The attack surface of the eShopOnContainers mobile app is reduced by implementing the\\nProof K\", \"ey for Code Exchange (PKCE) extension to OAuth. PKCE protects the authorization code\\nfrom being used\", \" if it\\u2019s intercepted. This is achieved by the client generating a secret verifier, a hash\\nof which i\", \"s passed in the authorization request, and which is presented unhashed when redeeming\\nthe authorizat\", \"ion code. For more information about PKCE, see Proof Key for Code Exchange by\\nOAuth Public Clients o\", \"n the Internet Engineering Task Force web site.\\nThe returned URI is stored in the LoginUrl property \", \"of the LoginViewModel class. When the IsLogin\\nproperty becomes true, the WebView in the LoginView be\", \"comes visible. The WebView data binds its\\nSource property to the LoginUrl property of the LoginViewM\", \"odel class, and so makes a sign-in\\nrequest to IdentityServer when the LoginUrl property is set to Id\", \"entityServer's authorization\\nendpoint. When IdentityServer receives this request and the user isn't \", \"authenticated, the WebView will\\nbe redirected to the configured login page, which is shown in Figure\", \" 9-4.\\nFigure 9-4: Login page displayed by the WebView\\nOnce login is completed, the WebView will be r\", \"edirected to a return URI. This WebView navigation will\\ncause the NavigateAsync method in the LoginV\", \"iewModel class to be executed, which is shown in\\nthe following code example:\\n66 CHAPTER 9 | Authenti\", \"cation and authorizationprivate async Task NavigateAsync(string url)\\n{\\n...\\nvar authResponse = new Au\", \"thorizeResponse(url);\\nif (!string.IsNullOrWhiteSpace(authResponse.Code))\\n{\\nvar userToken = await _id\", \"entityService.GetTokenAsync(authResponse.Code);\\nstring accessToken = userToken.AccessToken;\\nif (!str\", \"ing.IsNullOrWhiteSpace(accessToken))\\n{\\nSettings.AuthAccessToken = accessToken;\\nSettings.AuthIdToken \", \"= authResponse.IdentityToken;\\nawait NavigationService.NavigateToAsync<MainViewModel>();\\nawait Naviga\", \"tionService.RemoveLastFromBackStackAsync();\\n}\\n}\\n...\\n}\\nThis method parses the authentication response\", \" that's contained in the return URI, and provided that\\na valid authorization code is present, it mak\", \"es a request to IdentityServer's token endpoint, passing\\nthe authorization code, the PKCE secret ver\", \"ifier, and other required parameters. The token endpoint is\\nat /connect/token on port 5105 of the ba\", \"se endpoint exposed as a user setting. For more\\ninformation about user settings, see Configuration m\", \"anagement.\\nTip: Validate return URIs\\nAlthough the eShopOnContainers mobile app doesn't validate the \", \"return URI, the best practice is to\\nvalidate that the return URI refers to a known location in order\", \" to prevent open-redirect attacks.\\nIf the token endpoint receives a valid authorization code and PKC\", \"E secret verifier, it responds with an\\naccess token, identity token, and refresh token. The access t\", \"oken (which allows access to API\\nresources) and identity token are then stored as application settin\", \"gs, and page navigation is\\nperformed. Therefore, the overall effect in the eShopOnContainers mobile \", \"app is this: provided that\\nusers are able to successfully authenticate with IdentityServer, they are\", \" navigated to the MainView\\npage, which is a TabbedPage that displays the CatalogView as its selected\", \" tab.\\nFor information about page navigation, see Navigation. For information about how WebView\\nnavig\", \"ation causes a view model method to be executed, see Invoking navigation using behaviors. For\\ninform\", \"ation about application settings, see Configuration management.\\nNote: The eShopOnContainers also all\", \"ows a mock sign-in when the app is configured to use mock\\nservices in the SettingsView. In this mode\", \", the app doesn't communicate with IdentityServer,\\ninstead allowing the user to sign-in using any cr\", \"edentials.\\nSigning-out\\nWhen the user taps the LOG OUT button in the ProfileView, the LogoutCommand i\", \"n the\\nProfileViewModel class is executed, which in turn executes the LogoutAsync method. This method\", \"\\nperforms page navigation to the LoginView page, passing a LogoutParameter instance set to true\\nas a\", \" parameter. For more information about passing parameters during page navigation, see Passing\\nparame\", \"ters during navigation.\\n67 CHAPTER 9 | Authentication and authorizationWhen a view is created and na\", \"vigated to, the InitializeAsync method of the view's associated\\nview model is executed, which then e\", \"xecutes the Logout method of the LoginViewModel class, which\\nis shown in the following code example:\", \"\\nprivate void Logout()\\n{\\nvar authIdToken = Settings.AuthIdToken;\\nvar logoutRequest = _identityServic\", \"e.CreateLogoutRequest(authIdToken);\\nif (!string.IsNullOrEmpty(logoutRequest))\\n{\\n// Logout\\nLoginUrl =\", \" logoutRequest;\\n}\\n...\\n}\\nThis method invokes the CreateLogoutRequest method in the IdentityService cl\", \"ass, passing the\\nidentity token retrieved from application settings as a parameter. For more informa\", \"tion about\\napplication settings, see Configuration management. The following code example shows the\\n\", \"CreateLogoutRequest method:\\npublic string CreateLogoutRequest(string token)\\n{\\n...\\nreturn string.Form\", \"at(\\\"{0}?id_token_hint={1}&post_logout_redirect_uri={2}\\\",\\nGlobalSetting.Instance.LogoutEndpoint,\\ntoke\", \"n,\\nGlobalSetting.Instance.LogoutCallback);\\n}\\nThis method creates the URI to IdentityServer's end ses\", \"sion endpoint, with the required parameters.\\nThe end session endpoint is at /connect/endsession on p\", \"ort 5105 of the base endpoint exposed as\\na user setting. For more information about user settings, s\", \"ee Configuration management.\\nThe returned URI is stored in the LoginUrl property of the LoginViewMod\", \"el class. While the IsLogin\\nproperty is true, the WebView in the LoginView is visible. The WebView d\", \"ata binds its Source property\\nto the LoginUrl property of the LoginViewModel class, and so makes a s\", \"ign-out request to\\nIdentityServer when the LoginUrl property is set to IdentityServer's end session \", \"endpoint. When\\nIdentityServer receives this request, provided that the user is signed-in, sign-out o\", \"ccurs.\\nAuthentication is tracked with a cookie managed by the cookie authentication middleware from\\n\", \"ASP.NET Core. Therefore, signing out of IdentityServer removes the authentication cookie and sends a\", \"\\npost logout redirect URI back to the client.\\nIn the mobile app, the WebView will be redirected to t\", \"he post logout redirect URI. This WebView\\nnavigation will cause the NavigateAsync method in the Logi\", \"nViewModel class to be executed, which\\nis shown in the following code example:\\nprivate async Task Na\", \"vigateAsync(string url)\\n{\\n...\\nSettings.AuthAccessToken = string.Empty;\\nSettings.AuthIdToken = string\", \".Empty;\\nIsLogin = false;\\nLoginUrl = _identityService.CreateAuthorizationRequest();\\n...\\n}\\n68 CHAPTER \", \"9 | Authentication and authorizationThis method clears both the identity token and the access token \", \"from application settings, and sets\\nthe IsLogin property to false, which causes the WebView on the L\", \"oginView page to become\\ninvisible. Finally, the LoginUrl property is set to the URI of IdentityServe\", \"r's authorization endpoint,\\nwith the required parameters, in preparation for the next time the user \", \"initiates a sign-in.\\nFor information about page navigation, see Navigation. For information about ho\", \"w WebView\\nnavigation causes a view model method to be executed, see Invoking navigation using behavi\", \"ors. For\\ninformation about application settings, see Configuration management.\\nNote: The eShopOnCont\", \"ainers also allows a mock sign-out when the app is configured to use\\nmock services in the SettingsVi\", \"ew. In this mode, the app doesn't communicate with\\nIdentityServer, and instead clears any stored tok\", \"ens from application settings.\\nAuthorization\\nAfter authentication, ASP.NET Core web APIs often need \", \"to authorize access, which allows a service to\\nmake APIs available to some authenticated users, but \", \"not to all.\\nRestricting access to an ASP.NET Core MVC route can be achieved by applying an Authorize\", \" attribute\\nto a controller or action, which limits access to the controller or action to authenticat\", \"ed users, as\\nshown in the following code example:\\n[Authorize]\\npublic class BasketController : Contro\", \"ller\\n{\\n...\\n}\\nIf an unauthorized user attempts to access a controller or action that's marked with th\", \"e Authorize\\nattribute, the MVC framework returns a 401 (unauthorized) HTTP status code.\\nNote: Parame\", \"ters can be specified on the Authorize attribute to restrict an API to specific users.\\nFor more info\", \"rmation, see Authorization on the Microsoft Documentation Center.\\n69 CHAPTER 9 | Authentication and \", \"authorizationIdentityServer can be integrated into the authorization workflow so that the access tok\", \"ens it provides\\ncontrol authorization. This approach is shown in Figure 9-5.\\nFigure 9-5: Authorizati\", \"on by access token\\nThe eShopOnContainers mobile app communicates with the identity microservice and \", \"requests an\\naccess token as part of the authentication process. The access token is then forwarded t\", \"o the APIs\\nexposed by the ordering and basket microservices as part of the access requests. Access t\", \"okens\\ncontain information about the client, and the user. APIs then use that information to authoriz\", \"e access\\nto their data. For information about how to configure IdentityServer to protect APIs, see C\", \"onfiguring\\nAPI resources.\\nConfiguring IdentityServer to perform authorization\\nTo perform authorizati\", \"on with IdentityServer, its authorization middleware must be added to the web\\napplication's HTTP req\", \"uest pipeline. The middleware is added in the ConfigureAuth method in the\\nweb application's Startup \", \"class, which is invoked from the Configure method, and is demonstrated\\nin the following code example\", \" from the eShopOnContainers reference application:\\nprotected virtual void ConfigureAuth(IApplication\", \"Builder app)\\n{\\nvar identityUrl = Configuration.GetValue<string>(\\\"IdentityUrl\\\");\\napp.UseIdentityServe\", \"rAuthentication(new IdentityServerAuthenticationOptions\\n{\\nAuthority = identityUrl.ToString(),\\nScopeN\", \"ame = \\\"basket\\\",\\nRequireHttpsMetadata = false\\n});\\n}\\nThis method ensures that the API can only be acce\", \"ssed with a valid access token. The middleware\\nvalidates the incoming token to ensure that it's sent\", \" from a trusted issuer, and validates that the token\\nis valid to be used with the API that receives \", \"it. Therefore, browsing to the ordering or basket\\ncontroller will return a 401 (unauthorized) HTTP s\", \"tatus code, indicating that an access token is\\nrequired.\\n70 CHAPTER 9 | Authentication and authoriza\", \"tionNote: IdentityServer's authorization middleware must be added to the web application's HTTP\\nrequ\", \"est pipeline before adding MVC with app.UseMvc() or app.UseMvcWithDefaultRoute().\\nMaking access requ\", \"ests to APIs\\nWhen making requests to the ordering and basket microservices, the access token, obtain\", \"ed from\\nIdentityServer during the authentication process, must be included in the request, as shown \", \"in the\\nfollowing code example:\\nvar authToken = Settings.AuthAccessToken;\\nOrder = await _ordersServic\", \"e.GetOrderAsync(Convert.ToInt32(order.OrderNumber), authToken);\\nThe access token is stored as an app\", \"lication setting, and is retrieved from platform-specific storage\\nand included in the call to the Ge\", \"tOrderAsync method in the OrderService class.\\nSimilarly, the access token must be included when send\", \"ing data to an IdentityServer protected API, as\\nshown in the following code example:\\nvar authToken =\", \" Settings.AuthAccessToken;\\nawait _basketService.UpdateBasketAsync(new CustomerBasket\\n{\\nBuyerId = use\", \"rInfo.UserId,\\nItems = BasketItems.ToList()\\n}, authToken);\\nThe access token is retrieved from platfor\", \"m-specific storage and included in the call to the\\nUpdateBasketAsync method in the BasketService cla\", \"ss.\\nThe RequestProvider class, in the eShopOnContainers mobile app, uses the HttpClient class to\\nmak\", \"e requests to the RESTful APIs exposed by the eShopOnContainers reference application. When\\nmaking r\", \"equests to the ordering and basket APIs, which require authorization, a valid access token\\nmust be i\", \"ncluded with the request. This is achieved by adding the access token to the headers of the\\nHttpClie\", \"nt instance, as demonstrated in the following code example:\\nhttpClient.DefaultRequestHeaders.Authori\", \"zation = new AuthenticationHeaderValue(\\\"Bearer\\\", token);\\nThe DefaultRequestHeaders property of the H\", \"ttpClient class exposes the headers that are sent\\nwith each request, and the access token is added t\", \"o the Authorization header prefixed with the\\nstring Bearer. When the request is sent to a RESTful AP\", \"I, the value of the Authorization header is\\nextracted and validated to ensure that it's sent from a \", \"trusted issuer, and used to determine whether\\nthe user has permission to invoke the API that receive\", \"s it.\\nFor more information about how the eShopOnContainers mobile app makes web requests, see\\nAccess\", \"ing remote data.\\nSummary\\nThere are many approaches to integrating authentication and authorization i\", \"nto a Xamarin.Forms app\\nthat communicates with an ASP.NET MVC web application. The eShopOnContainers\", \" mobile app\\nperforms authentication and authorization with a containerized identity microservice tha\", \"t uses\\nIdentityServer 4. IdentityServer is an open source OpenID Connect and OAuth 2.0 framework for\", \"\\nASP.NET Core that integrates with ASP.NET Core Identity to perform bearer token authentication.\\n71 \", \"CHAPTER 9 | Authentication and authorizationThe mobile app requests security tokens from IdentitySer\", \"ver, either for authenticating a user or for\\naccessing a resource. When accessing a resource, an acc\", \"ess token must be included in the request to\\nAPIs that require authorization. IdentityServer's middl\", \"eware validates incoming access tokens to\\nensure that they are sent from a trusted issuer, and that \", \"they are valid to be used with the API that\\nreceives them.\\n72 CHAPTER 9 | Authentication and authori\", \"zation10\\nCHAPTER\\nAccessing remote\\ndata\\nMany modern web-based solutions make use of web services, hos\", \"ted by web servers, to provide\\nfunctionality for remote client applications. The operations that a w\", \"eb service exposes constitute a\\nweb API.\\nClient apps should be able to utilize the web API without k\", \"nowing how the data or operations that the\\nAPI exposes are implemented. This requires that the API a\", \"bides by common standards that enable a\\nclient app and web service to agree on which data formats to\", \" use, and the structure of the data that is\\nexchanged between client apps and the web service.\\nIntro\", \"duction to Representational State Transfer\\nRepresentational State Transfer (REST) is an architectura\", \"l style for building distributed systems based\\non hypermedia. A primary advantage of the REST model \", \"is that it's based on open standards and\\ndoesn't bind the implementation of the model or the client \", \"apps that access it to any specific\\nimplementation. Therefore, a REST web service could be implement\", \"ed using Microsoft ASP.NET Core\\nMVC, and client apps could be developing using any language and tool\", \"set that can generate HTTP\\nrequests and parse HTTP responses.\\nThe REST model uses a navigational sch\", \"eme to represent objects and services over a network, referred\\nto as resources. Systems that impleme\", \"nt REST typically use the HTTP protocol to transmit requests to\\naccess these resources. In such syst\", \"ems, a client app submits a request in the form of a URI that\\nidentifies a resource, and an HTTP met\", \"hod (such as GET, POST, PUT, or DELETE) that indicates the\\noperation to be performed on that resourc\", \"e. The body of the HTTP request contains any data required\\nto perform the operation.\\nNote: REST defi\", \"nes a stateless request model. Therefore, HTTP requests must be independent and\\nmight occur in any o\", \"rder.\\nThe response from a REST request makes use of standard HTTP status codes. For example, a reque\", \"st\\nthat returns valid data should include the HTTP response code 200 (OK), while a request that fail\", \"s to\\nfind or delete a specified resource should return a response that includes the HTTP status code\", \" 404\\n(Not Found).\\nA RESTful web API exposes a set of connected resources, and provides the core oper\", \"ations that\\nenable an app to manipulate those resources and easily navigate between them. For this r\", \"eason, the\\nURIs that constitute a typical RESTful web API are oriented towards the data that it expo\", \"ses, and use\\nthe facilities provided by HTTP to operate on this data.\\n73 CHAPTER 10 | Accessing remo\", \"te dataThe data included by a client app in an HTTP request, and the corresponding response messages\", \" from\\nthe web server, could be presented in a variety of formats, known as media types. When a clien\", \"t app\\nsends a request that returns data in the body of a message, it can specify the media types it \", \"can\\nhandle in the Accept header of the request. If the web server supports this media type, it can r\", \"eply\\nwith a response that includes the Content-Type header that specifies the format of the data in \", \"the\\nbody of the message. It's then the responsibility of the client app to parse the response messag\", \"e and\\ninterpret the results in the message body appropriately.\\nFor more information about REST, see \", \"API design and API implementation on Microsoft Docs.\\nConsuming RESTful APIs\\nThe eShopOnContainers mo\", \"bile app uses the Model-View-ViewModel (MVVM) pattern, and the\\nmodel elements of the pattern represe\", \"nt the domain entities used in the app. The controller and\\nrepository classes in the eShopOnContaine\", \"rs reference application accept and return many of these\\nmodel objects. Therefore, they are used as \", \"data transfer objects (DTOs) that hold all the data that is\\npassed between the mobile app and the co\", \"ntainerized microservices. The main benefit of using DTOs\\nto pass data to and receive data from a we\", \"b service is that by transmitting more data in a single\\nremote call, the app can reduce the number o\", \"f remote calls that need to be made.\\nMaking web requests\\nThe eShopOnContainers mobile app uses the H\", \"ttpClient class to make requests over HTTP, with\\nJSON being used as the media type. This class provi\", \"des functionality for asynchronously sending HTTP\\nrequests and receiving HTTP responses from a URI i\", \"dentified resource. The HttpResponseMessage\\nclass represents an HTTP response message received from \", \"a REST API after an HTTP request has been\\nmade. It contains information about the response, includin\", \"g the status code, headers, and any body.\\nThe HttpContent class represents the HTTP body and content\", \" headers, such as Content-Type and\\nContent-Encoding. The content can be read using any of the ReadAs\", \" methods, such as\\nReadAsStringAsync and ReadAsByteArrayAsync, depending on the format of the data.\\nM\", \"aking a GET request\\nThe CatalogService class is used to manage the data retrieval process from the c\", \"atalog\\nmicroservice. In the RegisterDependencies method in the ViewModelLocator class, the\\nCatalogSe\", \"rvice class is registered as a type mapping against the ICatalogService type with the\\nAutofac depend\", \"ency injection container. Then, when an instance of the CatalogViewModel class is\\ncreated, its const\", \"ructor accepts an ICatalogService type, which Autofac resolves, returning an\\ninstance of the Catalog\", \"Service class. For more information about dependency injection, see\\nIntroduction to dependency injec\", \"tion.\\nFigure 10-1 shows the interaction of classes that read catalog data from the catalog microserv\", \"ice for\\ndisplaying by the CatalogView.\\n74 CHAPTER 10 | Accessing remote dataFigure 10-1: Retrieving \", \"data from the catalog microservice\\nWhen the CatalogView is navigated to, the OnInitialize method in \", \"the CatalogViewModel class is\\ncalled. This method retrieves catalog data from the catalog microservi\", \"ce, as demonstrated in the\\nfollowing code example:\\npublic override async Task InitializeAsync(object\", \" navigationData)\\n{\\n...\\nProducts = await _productsService.GetCatalogAsync();\\n...\\n}\\nThis method calls \", \"the GetCatalogAsync method of the CatalogService instance that was injected\\ninto the CatalogViewMode\", \"l by Autofac. The following code example shows the GetCatalogAsync\\nmethod:\\npublic async Task<Observa\", \"bleCollection<CatalogItem>> GetCatalogAsync()\\n{\\nUriBuilder builder = new UriBuilder(GlobalSetting.In\", \"stance.CatalogEndpoint);\\nbuilder.Path = \\\"api/v1/catalog/items\\\";\\nstring uri = builder.ToString();\\nCat\", \"alogRoot catalog = await _requestProvider.GetAsync<CatalogRoot>(uri);\\n...\\n75 CHAPTER 10 | Accessing \", \"remote datareturn catalog?.Data.ToObservableCollection();\\n}\\nThis method builds the URI that identifi\", \"es the resource the request will be sent to, and uses the\\nRequestProvider class to invoke the GET HT\", \"TP method on the resource, before returning the results\\nto the CatalogViewModel. The RequestProvider\", \" class contains functionality that submits a request\\nin the form of a URI that identifies a resource\", \", an HTTP method that indicates the operation to be\\nperformed on that resource, and a body that cont\", \"ains any data required to perform the operation. For\\ninformation about how the RequestProvider class\", \" is injected into the CatalogService class, see\\nIntroduction to dependency injection.\\nThe following \", \"code example shows the GetAsync method in the RequestProvider class:\\npublic async Task<TResult> GetA\", \"sync<TResult>(string uri, string token = \\\"\\\")\\n{\\nHttpClient httpClient = CreateHttpClient(token);\\nHttp\", \"ResponseMessage response = await httpClient.GetAsync(uri);\\nawait HandleResponse(response);\\nstring se\", \"rialized = await response.Content.ReadAsStringAsync();\\nTResult result = await Task.Run(() =>\\nJsonCon\", \"vert.DeserializeObject<TResult>(serialized, _serializerSettings));\\nreturn result;\\n}\\nThis method call\", \"s the CreateHttpClient method, which returns an instance of the HttpClient class\\nwith the appropriat\", \"e headers set. It then submits an asynchronous GET request to the resource\\nidentified by the URI, wi\", \"th the response being stored in the HttpResponseMessage instance. The\\nHandleResponse method is then \", \"invoked, which throws an exception if the response doesn't include\\na success HTTP status code. Then \", \"the response is read as a string, converted from JSON to a\\nCatalogRoot object, and returned to the C\", \"atalogService.\\nThe CreateHttpClient method is shown in the following code example:\\nprivate HttpClien\", \"t CreateHttpClient(string token = \\\"\\\")\\n{\\nvar httpClient = new HttpClient();\\nhttpClient.DefaultRequest\", \"Headers.Accept.Add(\\nnew MediaTypeWithQualityHeaderValue(\\\"application/json\\\"));\\nif (!string.IsNullOrEm\", \"pty(token))\\n{\\nhttpClient.DefaultRequestHeaders.Authorization =\\nnew AuthenticationHeaderValue(\\\"Bearer\", \"\\\", token);\\n}\\nreturn httpClient;\\n}\\nThis method creates a new instance of the HttpClient class, and se\", \"ts the Accept header of any\\nrequests made by the HttpClient instance to application/json, which indi\", \"cates that it expects the\\ncontent of any response to be formatted using JSON. Then, if an access tok\", \"en was passed as an\\nargument to the CreateHttpClient method, it's added to the Authorization header \", \"of any\\nrequests made by the HttpClient instance, prefixed with the string Bearer. For more informati\", \"on\\nabout authorization, see Authorization.\\n76 CHAPTER 10 | Accessing remote dataWhen the GetAsync me\", \"thod in the RequestProvider class calls HttpClient.GetAsync, the Items\\nmethod in the CatalogControll\", \"er class in the Catalog.API project is invoked, which is shown in the\\nfollowing code example:\\n[HttpG\", \"et]\\n[Route(\\\"[action]\\\")]\\npublic async Task<IActionResult> Items(\\n[FromQuery]int pageSize = 10, [FromQ\", \"uery]int pageIndex = 0)\\n{\\nvar totalItems = await _catalogContext.CatalogItems\\n.LongCountAsync();\\nvar\", \" itemsOnPage = await _catalogContext.CatalogItems\\n.OrderBy(c=>c.Name)\\n.Skip(pageSize * pageIndex)\\n.T\", \"ake(pageSize)\\n.ToListAsync();\\nitemsOnPage = ComposePicUri(itemsOnPage);\\nvar model = new PaginatedIte\", \"msViewModel<CatalogItem>(\\npageIndex, pageSize, totalItems, itemsOnPage);\\nreturn Ok(model);\\n}\\nThis me\", \"thod retrieves the catalog data from the SQL database using EntityFramework, and returns it\\nas a res\", \"ponse message that includes a success HTTP status code, and a collection of JSON formatted\\nCatalogIt\", \"em instances.\\nMaking a POST request\\nThe BasketService class is used to manage the data retrieval and\", \" update process with the basket\\nmicroservice. In the RegisterDependencies method in the ViewModelLoc\", \"ator class, the\\nBasketService class is registered as a type mapping against the IBasketService type \", \"with the\\nAutofac dependency injection container. Then, when an instance of the BasketViewModel class\", \" is\\ncreated, its constructor accepts an IBasketService type, which Autofac resolves, returning an\\nin\", \"stance of the BasketService class. For more information about dependency injection, see\\nIntroduction\", \" to dependency injection.\\nFigure 10-2 shows the interaction of classes that send the basket data dis\", \"played by the BasketView,\\nto the basket microservice.\\n77 CHAPTER 10 | Accessing remote dataFigure 10\", \"-2: Sending data to the basket microservice\\nWhen an item is added to the shopping basket, the ReCalc\", \"ulateTotalAsync method in the\\nBasketViewModel class is called. This method updates the total value o\", \"f items in the basket, and\\nsends the basket data to the basket microservice, as demonstrated in the \", \"following code example:\\nprivate async Task ReCalculateTotalAsync()\\n{\\n...\\nawait _basketService.Update\", \"BasketAsync(new CustomerBasket\\n{\\nBuyerId = userInfo.UserId,\\nItems = BasketItems.ToList()\\n}, authToke\", \"n);\\n}\\nThis method calls the UpdateBasketAsync method of the BasketService instance that was injected\", \"\\ninto the BasketViewModel by Autofac. The following method shows the UpdateBasketAsync\\nmethod:\\npubli\", \"c async Task<CustomerBasket> UpdateBasketAsync(CustomerBasket customerBasket, string token)\\n{\\nUriBui\", \"lder builder = new UriBuilder(GlobalSetting.Instance.BasketEndpoint);\\nstring uri = builder.ToString(\", \");\\n78 CHAPTER 10 | Accessing remote datavar result = await _requestProvider.PostAsync(uri, customerB\", \"asket, token);\\nreturn result;\\n}\\nThis method builds the URI that identifies the resource the request \", \"will be sent to, and uses the\\nRequestProvider class to invoke the POST HTTP method on the resource, \", \"before returning the\\nresults to the BasketViewModel. Note that an access token, obtained from Identi\", \"tyServer during the\\nauthentication process, is required to authorize requests to the basket microser\", \"vice. For more\\ninformation about authorization, see Authorization.\\nThe following code example shows \", \"one of the PostAsync methods in the RequestProvider class:\\npublic async Task<TResult> PostAsync<TRes\", \"ult>(\\nstring uri, TResult data, string token = \\\"\\\", string header = \\\"\\\")\\n{\\nHttpClient httpClient = Cre\", \"ateHttpClient(token);\\n...\\nvar content = new StringContent(JsonConvert.SerializeObject(data));\\nconten\", \"t.Headers.ContentType = new MediaTypeHeaderValue(\\\"application/json\\\");\\nHttpResponseMessage response =\", \" await httpClient.PostAsync(uri, content);\\nawait HandleResponse(response);\\nstring serialized = await\", \" response.Content.ReadAsStringAsync();\\nTResult result = await Task.Run(() =>\\nJsonConvert.Deserialize\", \"Object<TResult>(serialized, _serializerSettings));\\nreturn result;\\n}\\nThis method calls the CreateHttp\", \"Client method, which returns an instance of the HttpClient class\\nwith the appropriate headers set. I\", \"t then submits an asynchronous POST request to the resource\\nidentified by the URI, with the serializ\", \"ed basket data being sent in JSON format, and the response\\nbeing stored in the HttpResponseMessage i\", \"nstance. The HandleResponse method is then invoked,\\nwhich throws an exception if the response doesn'\", \"t include a success HTTP status code. Then, the\\nresponse is read as a string, converted from JSON to\", \" a CustomerBasket object, and returned to the\\nBasketService. For more information about the CreateHt\", \"tpClient method, see Making a GET request.\\nWhen the PostAsync method in the RequestProvider class ca\", \"lls HttpClient.PostAsync, the Post\\nmethod in the BasketController class in the Basket.API project is\", \" invoked, which is shown in the\\nfollowing code example:\\n[HttpPost]\\npublic async Task<IActionResult> \", \"Post([FromBody]CustomerBasket value)\\n{\\nvar basket = await _repository.UpdateBasketAsync(value);\\nretu\", \"rn Ok(basket);\\n}\\nThis method uses an instance of the RedisBasketRepository class to persist the bask\", \"et data to the\\nRedis cache, and returns it as a response message that includes a success HTTP status\", \" code, and a\\nJSON formatted CustomerBasket instance.\\nMaking a DELETE request\\nFigure 10-3 shows the i\", \"nteractions of classes that delete basket data from the basket microservice, for\\nthe CheckoutView.\\n7\", \"9 CHAPTER 10 | Accessing remote dataFigure 10-3: Deleting data from the basket microservice\\nWhen the\", \" checkout process is invoked, the CheckoutAsync method in the CheckoutViewModel class\\nis called. Thi\", \"s method creates a new order, before clearing the shopping basket, as demonstrated in\\nthe following \", \"code example:\\nprivate async Task CheckoutAsync()\\n{\\n...\\nawait _basketService.ClearBasketAsync(_shippi\", \"ngAddress.Id.ToString(), authToken);\\n...\\n}\\nThis method calls the ClearBasketAsync method of the Bask\", \"etService instance that was injected\\ninto the CheckoutViewModel by Autofac. The following method sho\", \"ws the ClearBasketAsync\\nmethod:\\npublic async Task ClearBasketAsync(string guidUser, string token)\\n{\\n\", \"UriBuilder builder = new UriBuilder(GlobalSetting.Instance.BasketEndpoint);\\nbuilder.Path = guidUser;\", \"\\nstring uri = builder.ToString();\\nawait _requestProvider.DeleteAsync(uri, token);\\n}\\nThis method buil\", \"ds the URI that identifies the resource that the request will be sent to, and uses the\\nRequestProvid\", \"er class to invoke the DELETE HTTP method on the resource. Note that an access\\ntoken, obtained from \", \"IdentityServer during the authentication process, is required to authorize\\nrequests to the basket mi\", \"croservice. For more information about authorization, see Authorization.\\nThe following code example \", \"shows the DeleteAsync method in the RequestProvider class:\\n80 CHAPTER 10 | Accessing remote datapubl\", \"ic async Task DeleteAsync(string uri, string token = \\\"\\\")\\n{\\nHttpClient httpClient = CreateHttpClient(\", \"token);\\nawait httpClient.DeleteAsync(uri);\\n}\\nThis method calls the CreateHttpClient method, which re\", \"turns an instance of the HttpClient class\\nwith the appropriate headers set. It then submits an async\", \"hronous DELETE request to the resource\\nidentified by the URI. For more information about the CreateH\", \"ttpClient method, see Making a GET\\nrequest.\\nWhen the DeleteAsync method in the RequestProvider class\", \" calls HttpClient.DeleteAsync, the\\nDelete method in the BasketController class in the Basket.API pro\", \"ject is invoked, which is shown\\nin the following code example:\\n[HttpDelete(\\\"{id}\\\")]\\npublic void Dele\", \"te(string id)\\n{\\n_repository.DeleteBasketAsync(id);\\n}\\nThis method uses an instance of the RedisBasket\", \"Repository class to delete the basket data from\\nthe Redis cache.\\nCaching data\\nThe performance of an \", \"app can be improved by caching frequently accessed data to fast storage\\nthat's located close to the \", \"app. If the fast storage is located closer to the app than the original source,\\nthen caching can sig\", \"nificantly improve response times when retrieving data.\\nThe most common form of caching is read-thro\", \"ugh caching, where an app retrieves data by\\nreferencing the cache. If the data isn't in the cache, i\", \"t's retrieved from the data store and added to the\\ncache. Apps can implement read-through caching wi\", \"th the cache-aside pattern. This pattern\\ndetermines whether the item is currently in the cache. If t\", \"he item isn't in the cache, it's read from the\\ndata store and added to the cache. For more informati\", \"on, see the Cache-Aside pattern on Microsoft\\nDocs.\\nTip: Cache data that's read frequently and that c\", \"hanges infrequently\\nThis data can be added to the cache on demand the first time it is retrieved by \", \"an app. This means\\nthat the app needs to fetch the data only once from the data store, and that subs\", \"equent access can\\nbe satisfied by using the cache.\\nDistributed applications, such as the eShopOnCont\", \"ainers reference application, should provide either\\nor both of the following caches:\\n\\u2022 A shared cach\", \"e, which can be accessed by multiple processes or machines.\\n\\u2022 A private cache, where data is held lo\", \"cally on the device running the app.\\nThe eShopOnContainers mobile app uses a private cache, where da\", \"ta is held locally on the device\\nthat's running an instance of the app. For information about the ca\", \"che used by the\\neShopOnContainers reference application, see .NET Microservices: Architecture for Co\", \"ntainerized .NET\\nApplications.\\n81 CHAPTER 10 | Accessing remote dataTip: Think of the cache as a tra\", \"nsient data store that could disappear at any time\\nEnsure that data is maintained in the original da\", \"ta store as well as the cache. The chances of losing\\ndata are then minimized if the cache becomes un\", \"available.\\nManaging data expiration\\nIt's impractical to expect that cached data will always be consi\", \"stent with the original data. Data in the\\noriginal data store might change after it's been cached, c\", \"ausing the cached data to become stale.\\nTherefore, apps should implement a strategy that helps to en\", \"sure that the data in the cache is as up-\\nto-date as possible, but can also detect and handle situat\", \"ions that arise when the data in the cache\\nhas become stale. Most caching mechanisms enable the cach\", \"e to be configured to expire data, and\\nhence reduce the period for which data might be out of date.\\n\", \"Tip: Set a default expiration time when configuring a cache\\nMany caches implement expiration, which \", \"invalidates data and removes it from the cache if it's not\\naccessed for a specified period. However,\", \" care must be taken when choosing the expiration period.\\nIf it's made too short, data will expire to\", \"o quickly and the benefits of caching will be reduced. If it's\\nmade too long, the data risks becomin\", \"g stale. Therefore, the expiration time should match the\\npattern of access for apps that use the dat\", \"a.\\nWhen cached data expires, it should be removed from the cache, and the app must retrieve the data\", \"\\nfrom the original data store and place it back into the cache.\\nIt's also possible that a cache migh\", \"t fill up if data is allowed to remain for too long a period. Therefore,\\nrequests to add new items t\", \"o the cache might be required to remove some items in a process known\\nas eviction. Caching services \", \"typically evict data on a least-recently-used basis. However, there are\\nother eviction policies, inc\", \"luding most-recently-used, and first-in-first-out. For more information, see\\nCaching Guidance on Mic\", \"rosoft Docs.\\nCaching images\\nThe eShopOnContainers mobile app consumes remote product images that ben\", \"efit from being\\ncached. These images are displayed by the Image control, and the CachedImage control\", \" provided by\\nthe FFImageLoading library.\\nThe Xamarin.Forms Image control supports caching of downloa\", \"ded images. Caching is enabled by\\ndefault, and will store the image locally for 24 hours. In additio\", \"n, the expiration time can be\\nconfigured with the CacheValidity property. For more information, see \", \"Downloaded Image Caching\\non the Xamarin Developer Center.\\nFFImageLoading's CachedImage control is a \", \"replacement for the Xamarin.Forms Image control,\\nproviding additional properties that enable supplem\", \"entary functionality. Amongst this functionality,\\nthe control provides configurable caching, while s\", \"upporting error and loading image placeholders.\\nThe following code example shows how the eShopOnCont\", \"ainers mobile app uses the CachedImage\\ncontrol in the ProductTemplate, which is the data template us\", \"ed by the ListView control in the\\nCatalogView:\\n<ffimageloading:CachedImage\\nGrid.Row=\\\"0\\\"\\nSource=\\\"{Bin\", \"ding PictureUri}\\\"\\nAspect=\\\"AspectFill\\\">\\n<ffimageloading:CachedImage.LoadingPlaceholder>\\n<OnPlatform\\nx\", \":TypeArguments=\\\"ImageSource\\\"\\n82 CHAPTER 10 | Accessing remote dataiOS=\\\"default_product\\\"\\nAndroid=\\\"def\", \"ault_product\\\"\\nWinPhone=\\\"Assets/default_product.png\\\"/>\\n</ffimageloading:CachedImage.LoadingPlaceholde\", \"r>\\n<ffimageloading:CachedImage.ErrorPlaceholder>\\n<OnPlatform\\nx:TypeArguments=\\\"ImageSource\\\"\\niOS=\\\"noim\", \"age\\\"\\nAndroid=\\\"noimage\\\"\\nWinPhone=\\\"Assets/noimage.png\\\"/>\\n</ffimageloading:CachedImage.ErrorPlaceholder\", \">\\n</ffimageloading:CachedImage>\\nThe CachedImage control sets the LoadingPlaceholder and ErrorPlaceho\", \"lder properties to\\nplatform-specific images. The LoadingPlaceholder property specifies the image to \", \"be displayed\\nwhile the image specified by the Source property is retrieved, and the ErrorPlaceholder\", \" property\\nspecifies the image to be displayed if an error occurs when attempting to retrieve the ima\", \"ge specified\\nby the Source property.\\nAs the name implies, the CachedImage control caches remote imag\", \"es on the device for the time\\nspecified by the value of the CacheDuration property. When this proper\", \"ty value isn't explicitly set, the\\ndefault value of 30 days is applied.\\nIncreasing resilience\\nAll ap\", \"ps that communicate with remote services and resources must be sensitive to transient faults.\\nTransi\", \"ent faults include the momentary loss of network connectivity to services, the temporary\\nunavailabil\", \"ity of a service, or timeouts that arise when a service is busy. These faults are often self-\\ncorrec\", \"ting, and if the action is repeated after a suitable delay it's likely to succeed.\\nTransient faults \", \"can have a huge impact on the perceived quality of an app, even if it has been\\nthoroughly tested und\", \"er all foreseeable circumstances. To ensure that an app that communicates with\\nremote services opera\", \"tes reliably, it must be able to do all of the following:\\n\\u2022 Detect faults when they occur, and deter\", \"mine if the faults are likely to be transient.\\n\\u2022 Retry the operation if it determines that the fault\", \" is likely to be transient and keep track of the\\nnumber of times the operation was retried.\\n\\u2022 Use an\", \" appropriate retry strategy, which specifies the number of retries, the delay between\\neach attempt, \", \"and the actions to take after a failed attempt.\\nThis transient fault handling can be achieved by wra\", \"pping all attempts to access a remote service in\\ncode that implements the retry pattern.\\nRetry patte\", \"rn\\nIf an app detects a failure when it tries to send a request to a remote service, it can handle th\", \"e failure\\nin any of the following ways:\\n\\u2022 Retrying the operation. The app could retry the failing re\", \"quest immediately.\\n\\u2022 Retrying the operation after a delay. The app should wait for a suitable amount\", \" of time before\\nretrying the request.\\n\\u2022 Cancelling the operation. The application should cancel the \", \"operation and report an\\nexception.\\n83 CHAPTER 10 | Accessing remote dataThe retry strategy should be\", \" tuned to match the business requirements of the app. For example, it's\\nimportant to optimize the re\", \"try count and retry interval to the operation being attempted. If the\\noperation is part of a user in\", \"teraction, the retry interval should be short and only a few retries\\nattempted to avoid making users\", \" wait for a response. If the operation is part of a long running\\nworkflow, where cancelling or resta\", \"rting the workflow is expensive or time-consuming, it's appropriate\\nto wait longer between attempts \", \"and to retry more times.\\nNote: An aggressive retry strategy with minimal delay between attempts, and\", \" a large number of\\nretries, could degrade a remote service that's running close to or at capacity. I\", \"n addition, such a\\nretry strategy could also affect the responsiveness of the app if it's continuall\", \"y trying to perform a\\nfailing operation.\\nIf a request still fails after a number of retries, it's be\", \"tter for the app to prevent further requests going\\nto the same resource and to report a failure. The\", \"n, after a set period, the app can make one or more\\nrequests to the resource to see if they're succe\", \"ssful. For more information, see Circuit breaker pattern.\\nTip: Never implement an endless retry mech\", \"anism\\nUse a finite number of retries, or implement the Circuit Breaker pattern to allow a service to\", \" recover.\\nThe eShopOnContainers mobile app does not currently implement the retry pattern when makin\", \"g\\nRESTful web requests. However, the CachedImage control, provided by the FFImageLoading library\\nsup\", \"ports transient fault handling by retrying image loading. If image loading fails, further attempts\\nw\", \"ill be made. The number of attempts is specified by the RetryCount property, and retries will occur\\n\", \"after a delay specified by the RetryDelay property. If these property values aren't explicitly set, \", \"their\\ndefault values are applied \\u2013 3 for the RetryCount property, and 250ms for the RetryDelay prope\", \"rty.\\nFor more information about the CachedImage control, see Caching images.\\nThe eShopOnContainers r\", \"eference application does implement the retry pattern. For more\\ninformation, including a discussion \", \"of how to combine the retry pattern with the HttpClient class,\\nsee .NET Microservices: Architecture \", \"for Containerized .NET Applications.\\nFor more information about the retry pattern, see the Retry pat\", \"tern on Microsoft Docs.\\nCircuit breaker pattern\\nIn some situations, faults can occur due to anticipa\", \"ted events that take longer to fix. These faults can\\nrange from a partial loss of connectivity to th\", \"e complete failure of a service. In these situations, it's\\npointless for an app to retry an operatio\", \"n that's unlikely to succeed, and instead should accept that\\nthe operation has failed and handle thi\", \"s failure accordingly.\\nThe circuit breaker pattern can prevent an app from repeatedly trying to exec\", \"ute an operation that's\\nlikely to fail, while also enabling the app to detect whether the fault has \", \"been resolved.\\nNote: The purpose of the circuit breaker pattern is different from the retry pattern.\", \" The retry\\npattern enables an app to retry an operation in the expectation that it'll succeed. The c\", \"ircuit breaker\\npattern prevents an app from performing an operation that's likely to fail.\\nA circuit\", \" breaker acts as a proxy for operations that might fail. The proxy should monitor the number\\nof rece\", \"nt failures that have occurred, and use this information to decide whether to allow the\\noperation to\", \" proceed, or to return an exception immediately.\\nThe eShopOnContainers mobile app does not currently\", \" implement the circuit breaker pattern.\\nHowever, the eShopOnContainers does. For more information, s\", \"ee .NET Microservices: Architecture\\nfor Containerized .NET Applications.\\n84 CHAPTER 10 | Accessing r\", \"emote dataTip: Combine the retry and circuit breaker patterns\\nAn app can combine the retry and circu\", \"it breaker patterns by using the retry pattern to invoke an\\noperation through a circuit breaker. How\", \"ever, the retry logic should be sensitive to any exceptions\\nreturned by the circuit breaker and aban\", \"don retry attempts if the circuit breaker indicates that a\\nfault is not transient.\\nFor more informat\", \"ion about the circuit breaker pattern, see the Circuit Breaker pattern on Microsoft\\nDocs.\\nSummary\\nMa\", \"ny modern web-based solutions make use of web services, hosted by web servers, to provide\\nfunctional\", \"ity for remote client applications. The operations that a web service exposes constitute a\\nweb API, \", \"and client apps should be able to utilize the web API without knowing how the data or\\noperations tha\", \"t the API exposes are implemented.\\nThe performance of an app can be improved by caching frequently a\", \"ccessed data to fast storage\\nthat's located close to the app. Apps can implement read-through cachin\", \"g with the cache-aside\\npattern. This pattern determines whether the item is currently in the cache. \", \"If the item isn't in the\\ncache, it's read from the data store and added to the cache.\\nWhen communica\", \"ting with web APIs, apps must be sensitive to transient faults. Transient faults\\ninclude the momenta\", \"ry loss of network connectivity to services, the temporary unavailability of a\\nservice, or timeouts \", \"that arise when a service is busy. These faults are often self-correcting, and if the\\naction is repe\", \"ated after a suitable delay, then it's likely to succeed. Therefore, apps should wrap all\\nattempts t\", \"o access a web API in code that implements a transient fault handling mechanism.\\n85 CHAPTER 10 | Acc\", \"essing remote data11\\nCHAPTER\\nUnit testing\\nMobile apps have unique problems that desktop and web-base\", \"d applications don't have to worry\\nabout. Mobile users will differ by the devices that they use, by \", \"network connectivity, by the availability\\nof services, and a range of other factors. Therefore, mobi\", \"le apps should be tested as they will be used\\nin the real world in order to improve their quality, r\", \"eliability, and performance. There are many types\\nof testing that should be performed on an app, inc\", \"luding unit testing, integration testing, and user\\ninterface testing, with unit testing being the mo\", \"st common form of testing.\\nA unit test takes a small unit of the app, typically a method, isolates i\", \"t from the remainder of the code,\\nand verifies that it behaves as expected. Its goal is to check tha\", \"t each unit of functionality performs as\\nexpected, so that errors don't propagate throughout the app\", \". Detecting a bug where it occurs is more\\nefficient that observing the effect of a bug indirectly at\", \" a secondary point of failure.\\nUnit testing has the greatest effect on code quality when it's an int\", \"egral part of the software\\ndevelopment workflow. As soon as a method has been written, unit tests sh\", \"ould be written that verify\\nthe behavior of the method in response to standard, boundary, and incorr\", \"ect cases of input data, and\\nthat check any explicit or implicit assumptions made by the code. Alter\", \"natively, with test driven\\ndevelopment, unit tests are written before the code. In this scenario, un\", \"it tests act as both design\\ndocumentation and functional specifications.\\nNote: Unit tests are very e\", \"ffective against regression \\u2013 that is, functionality that used to work but\\nhas been disturbed by a f\", \"aulty update.\\nUnit tests typically use the arrange-act-assert pattern:\\n\\u2022 The arrange section of the \", \"unit test method initializes objects and sets the value of the data\\nthat is passed to the method und\", \"er test.\\n\\u2022 The act section invokes the method under test with the required arguments.\\n\\u2022 The assert s\", \"ection verifies that the action of the method under test behaves as expected.\\nFollowing this pattern\", \" ensures that unit tests are readable and consistent.\\nDependency injection and unit testing\\nOne of t\", \"he motivations for adopting a loosely-coupled architecture is that it facilitates unit testing.\\nOne \", \"of the types registered with Autofac is the OrderService class. The following code example\\nshows an \", \"outline of this class:\\npublic class OrderDetailViewModel : ViewModelBase\\n{\\nprivate IOrderService _or\", \"dersService;\\npublic OrderDetailViewModel(IOrderService ordersService)\\n86 CHAPTER 11 | Unit testing{\\n\", \"_ordersService = ordersService;\\n}\\n...\\n}\\nThe OrderDetailViewModel class has a dependency on the IOrde\", \"rService type which the container\\nresolves when it instantiates a OrderDetailViewModel object. Howev\", \"er, rather than create an\\nOrderService object to unit test the OrderDetailViewModel class, instead, \", \"replace the\\nOrderService object with a mock for the purpose of the tests. Figure 10-1 illustrates th\", \"is relationship.\\nFigure 10-1: Classes that implement the IOrderService interface\\nThis approach allow\", \"s the OrderService object to be passed into the OrderDetailViewModel class at\\nruntime, and in the in\", \"terests of testability, it allows the OrderMockService class to be passed into the\\nOrderDetailViewMo\", \"del class at test time. The main advantage of this approach is that it enables unit\\ntests to be exec\", \"uted without requiring unwieldy resources such as web services, or databases.\\nTesting MVVM applicati\", \"ons\\nTesting models and view models from MVVM applications is identical to testing any other classes,\", \" and\\nthe same tools and techniques \\u2013 such as unit testing and mocking, can be used. However, there a\", \"re\\nsome patterns that are typical to model and view model classes, that can benefit from specific un\", \"it\\ntesting techniques.\\nTip: Test one thing with each unit test\\nDon't be tempted to make a unit test \", \"exercise more than one aspect of the unit's behavior. Doing\\nso leads to tests that are difficult to \", \"read and update. It can also lead to confusion when\\ninterpreting a failure.\\nThe eShopOnContainers mo\", \"bile app uses xUnit to perform unit testing, which supports two different\\ntypes of unit tests:\\n\\u2022 Fac\", \"ts are tests that are always true, which test invariant conditions.\\n\\u2022 Theories are tests that are on\", \"ly true for a particular set of data.\\n87 CHAPTER 11 | Unit testingThe unit tests included with the e\", \"ShopOnContainers mobile app are fact tests, and so each unit test\\nmethod is decorated with the [Fact\", \"] attribute.\\nNote: xUnit tests are executed by a test runner. To execute the test runner, run the\\neS\", \"hopOnContainers.TestRunner project for the required platform.\\nTesting asynchronous functionality\\nWhe\", \"n implementing the MVVM pattern, view models usually invoke operations on services, often\\nasynchrono\", \"usly. Tests for code that invokes these operations typically use mocks as replacements for\\nthe actua\", \"l services. The following code example demonstrates testing asynchronous functionality by\\npassing a \", \"mock service into a view model:\\n[Fact]\\npublic async Task OrderPropertyIsNotNullAfterViewModelInitial\", \"izationTest()\\n{\\nvar orderService = new OrderMockService();\\nvar orderViewModel = new OrderDetailViewM\", \"odel(orderService);\\nvar order = await orderService.GetOrderAsync(1, GlobalSetting.Instance.AuthToken\", \");\\nawait orderViewModel.InitializeAsync(order);\\nAssert.NotNull(orderViewModel.Order);\\n}\\nThis unit te\", \"st checks that the Order property of the OrderDetailViewModel instance will have a value\\nafter the I\", \"nitializeAsync method has been invoked. The InitializeAsync method is invoked\\nwhen the view model's \", \"corresponding view is navigated to. For more information about navigation,\\nsee Navigation.\\nWhen the \", \"OrderDetailViewModel instance is created, it expects an OrderService instance to be\\nspecified as an \", \"argument. However, the OrderService retrieves data from a web service. Therefore,\\nan OrderMockServic\", \"e instance, which is a mock version of the OrderService class, is specified as the\\nargument to the O\", \"rderDetailViewModel constructor. Then, when the view model's\\nInitializeAsync method is invoked, whic\", \"h invokes IOrderService operations, mock data is\\nretrieved rather than communicating with a web serv\", \"ice.\\nTesting INotifyPropertyChanged implementations\\nImplementing the INotifyPropertyChanged interfac\", \"e allows views to react to changes that originate\\nfrom view models and models. These changes are not\", \" limited to data shown in controls \\u2013 they are\\nalso used to control the view, such as view model stat\", \"es that cause animations to be started or\\ncontrols to be disabled.\\nProperties that can be updated di\", \"rectly by the unit test can be tested by attaching an event handler to\\nthe PropertyChanged event and\", \" checking whether the event is raised after setting a new value for the\\nproperty. The following code\", \" example shows such a test:\\n[Fact]\\npublic async Task SettingOrderPropertyShouldRaisePropertyChanged(\", \")\\n{\\nbool invoked = false;\\nvar orderService = new OrderMockService();\\nvar orderViewModel = new OrderD\", \"etailViewModel(orderService);\\norderViewModel.PropertyChanged += (sender, e) =>\\n{\\n88 CHAPTER 11 | Uni\", \"t testingif (e.PropertyName.Equals(\\\"Order\\\"))\\ninvoked = true;\\n};\\nvar order = await orderService.GetOr\", \"derAsync(1, GlobalSetting.Instance.AuthToken);\\nawait orderViewModel.InitializeAsync(order);\\nAssert.T\", \"rue(invoked);\\n}\\nThis unit test invokes the InitializeAsync method of the OrderViewModel class, which\", \" causes its\\nOrder property to be updated. The unit test will pass, provided that the PropertyChanged\", \" event is\\nraised for the Order property.\\nTesting message-based communication\\nView models that use th\", \"e MessagingCenter class to communicate between loosely-coupled classes\\ncan be unit tested by subscri\", \"bing to the message being sent by the code under test, as demonstrated\\nin the following code example\", \":\\n[Fact]\\npublic void AddCatalogItemCommandSendsAddProductMessageTest()\\n{\\nbool messageReceived = fals\", \"e;\\nvar catalogService = new CatalogMockService();\\nvar catalogViewModel = new CatalogViewModel(catalo\", \"gService);\\nXamarin.Forms.MessagingCenter.Subscribe<CatalogViewModel, CatalogItem>(\\nthis, MessageKeys\", \".AddProduct, (sender, arg) =>\\n{\\nmessageReceived = true;\\n});\\ncatalogViewModel.AddCatalogItemCommand.E\", \"xecute(null);\\nAssert.True(messageReceived);\\n}\\nThis unit test checks that the CatalogViewModel publis\", \"hes the AddProduct message in response to\\nits AddCatalogItemCommand being executed. Because the Mess\", \"agingCenter class supports multicast\\nmessage subscriptions, the unit test can subscribe to the AddPr\", \"oduct message and execute a callback\\ndelegate in response to receiving it. This callback delegate, s\", \"pecified as a lambda expression, sets a\\nboolean field that's used by the Assert statement to verify \", \"the behavior of the test.\\nTesting exception handling\\nUnit tests can also be written that check that \", \"specific exceptions are thrown for invalid actions or\\ninputs, as demonstrated in the following code \", \"example:\\n[Fact]\\npublic void InvalidEventNameShouldThrowArgumentExceptionText()\\n{\\nvar behavior = new \", \"MockEventToCommandBehavior\\n{\\nEventName = \\\"OnItemTapped\\\"\\n};\\nvar listView = new ListView();\\nAssert.Thr\", \"ows<ArgumentException>(() => listView.Behaviors.Add(behavior));\\n}\\n89 CHAPTER 11 | Unit testingThis u\", \"nit test will throw an exception, because the ListView control does not have an event named\\nOnItemTa\", \"pped. The Assert.Throws<T> method is a generic method where T is the type of the\\nexpected exception.\", \" The argument passed to the Assert.Throws<T> method is a lambda expression\\nthat will throw the excep\", \"tion. Therefore, the unit test will pass provided that the lambda expression\\nthrows an ArgumentExcep\", \"tion.\\nTip: Avoid writing unit tests that examine exception message strings\\nException message strings\", \" might change over time, and so unit tests that rely on their presence are\\nregarded as brittle.\\nTest\", \"ing validation\\nThere are two aspects to testing the validation implementation: testing that any vali\", \"dation rules are\\ncorrectly implemented, and testing that the ValidatableObject<T> class performs as \", \"expected.\\nValidation logic is usually simple to test, because it is typically a self-contained proce\", \"ss where the\\noutput depends on the input. There should be tests on the results of invoking the Valid\", \"ate method\\non each property that has at least one associated validation rule, as demonstrated in the\", \" following\\ncode example:\\n[Fact]\\npublic void CheckValidationPassesWhenBothPropertiesHaveDataTest()\\n{\\n\", \"var mockViewModel = new MockViewModel();\\nmockViewModel.Forename.Value = \\\"John\\\";\\nmockViewModel.Surnam\", \"e.Value = \\\"Smith\\\";\\nbool isValid = mockViewModel.Validate();\\nAssert.True(isValid);\\n}\\nThis unit test c\", \"hecks that validation succeeds when the two ValidatableObject<T> properties in the\\nMockViewModel ins\", \"tance both have data.\\nAs well as checking that validation succeeds, validation unit tests should als\", \"o check the values of the\\nValue, IsValid, and Errors property of each ValidatableObject<T> instance,\", \" to verify that the\\nclass performs as expected. The following code example demonstrates a unit test \", \"that does this:\\n[Fact]\\npublic void CheckValidationFailsWhenOnlyForenameHasDataTest()\\n{\\nvar mockViewM\", \"odel = new MockViewModel();\\nmockViewModel.Forename.Value = \\\"John\\\";\\nbool isValid = mockViewModel.Vali\", \"date();\\nAssert.False(isValid);\\nAssert.NotNull(mockViewModel.Forename.Value);\\nAssert.Null(mockViewMod\", \"el.Surname.Value);\\nAssert.True(mockViewModel.Forename.IsValid);\\nAssert.False(mockViewModel.Surname.I\", \"sValid);\\nAssert.Empty(mockViewModel.Forename.Errors);\\nAssert.NotEmpty(mockViewModel.Surname.Errors);\", \"\\n}\\n90 CHAPTER 11 | Unit testingThis unit test checks that validation fails when the Surname property\", \" of the MockViewModel doesn't\\nhave any data, and the Value, IsValid, and Errors property of each Val\", \"idatableObject<T> instance\\nare correctly set.\\nSummary\\nA unit test takes a small unit of the app, typ\", \"ically a method, isolates it from the remainder of the code,\\nand verifies that it behaves as expecte\", \"d. Its goal is to check that each unit of functionality performs as\\nexpected, so that errors don't p\", \"ropagate throughout the app.\\nThe behavior of an object under test can be isolated by replacing depen\", \"dent objects with mock\\nobjects that simulate the behavior of the dependent objects. This enables uni\", \"t tests to be executed\\nwithout requiring unwieldy resources such as web services, or databases.\\nTest\", \"ing models and view models from MVVM applications is identical to testing any other classes, and\\nthe\", \" same tools and techniques can be used.\\n91 CHAPTER 11 | Unit testing92 CHAPTER 11 | Unit testing\"]"