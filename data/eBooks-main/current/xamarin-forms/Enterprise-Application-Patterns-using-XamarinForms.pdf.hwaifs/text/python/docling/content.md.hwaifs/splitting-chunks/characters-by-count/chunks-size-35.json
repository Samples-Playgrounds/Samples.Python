"[\"## Book title Book subtitle\\n\\n<!-- image -->\\n\\n<!-- image -->\\n\\nPUBLISHED BY\\n\\nDevDiv, .NET and Visual S\", \"tudio produc teams A division of Microsoft Corporation One Microsoft Way Redmond, Washington 98052-6\", \"399\\n\\nCopyright \\u00a9 2017 by Microsoft Corporation\\n\\nAll rights reserved. No part of the contents of this\", \" book may be reproduced or transmitted in any form or by any means without the written permission of\", \" the publisher.\\n\\nT his book is provided 'as -is' and expresses the author's views and opinions. The \", \"views, opinions and information expressed in this book, including URL and other Internet website ref\", \"erences, may change without notice.\\n\\nSome examples depicted herein are provided for illustration onl\", \"y and are fictitious. No real association or connection is intended or should be inferred.\\n\\nMicrosof\", \"t and the trademarks listed at http://www.microsoft.com on the 'Trademarks' webpage are trademarks o\", \"f the Microsoft group of companies. All other marks are property of their respective owners.\\n\\nAuthor\", \":\\n\\nDavid Britch\\n\\nDeveloper:\\n\\nJavier Suarez Ruiz (Plain Concepts)\\n\\nParticipants and reviewers:\\n\\nCraig\", \" Dunn, Tom Opgenorth\\n\\nEditor:\\n\\nJohn Meade (Populus Group)\\n\\n## Contents\\n\\n| Preface ..................\", \"....................................................................................................\", \"..... iv                 |\\n|------------------------------------------------------------------------\", \"--------------------------------------------------------------------------------|\\n| Purpose ........\", \"....................................................................................................\", \"......................iv           |\\n| What's left out of this guide's scope .......................\", \".......................................................................iv                 |\\n| Who sh\", \"ould use this guide ................................................................................\", \".............................iv              |\\n| How to use this guide .............................\", \".........................................................................................v          \", \"|\\n| Introduction ...................................................................................\", \".................................1                     |\\n| Sample application.......................\", \"............................................................................................2       \", \"          |\\n| Sample application architecture.......................................................\", \"...............................................2                 |\\n| Mobile app.....................\", \"....................................................................................................\", \"..............4     |\\n| eShopOnContainers.Core project .............................................\", \"......................................................5                    |\\n| Platform projects ...\", \"....................................................................................................\", \".....................6        |\\n| Summary ..........................................................\", \".......................................................................6             |\\n| MVVM.......\", \"....................................................................................................\", \"..................7                     |\\n| The MVVMpattern ........................................\", \"..........................................................................7                    |\\n| V\", \"iew.................................................................................................\", \"................................................8 |\\n| ViewModel.....................................\", \"..................................................................................................8 \", \"     |\\n| Model......................................................................................\", \".........................................................9  |\\n| Connecting view models to views ....\", \".........................................................................................9          \", \"               |\\n| Creating a view model declaratively .............................................\", \"................................................10                    |\\n| Creating a view model prog\", \"rammatically .....................................................................................10\", \"                         |\\n| Creating a view defined as a data template.............................\", \".....................................................11                         |\\n| Automatically cr\", \"eating a view model with a view model locator.................................................11    \", \"                                   |\\n| Updating views in response to changes in the underlying view \", \"model or model.......................12                                                   |\\n| UI int\", \"eraction using commands and behaviors ..............................................................\", \"..........13                                 |\\n| Implementing commands..............................\", \"................................................................................14                  \", \"|\\n| Implementing behaviors..........................................................................\", \"......................................15               |\\n| Summary .................................\", \"..............................................................................................17    \", \"          |\\n| Dependency injection .................................................................\", \"................................... 18                           |\\n| Introduction to dependency inje\", \"ction .....................................................................................18       \", \"                    |\\n| Registration ...............................................................\", \"............................................................20             |\\n| Resolution...........\", \"....................................................................................................\", \"...............22             |\\n| Managing the lifetime of resolved objects.........................\", \"......................................................22                             |\\n\\n| Communicat\", \"ing between loosely coupled components ..................................................           \", \"                            | 24                                                                    \", \"                                                    |\\n|---------------------------------------------\", \"----------------------------------------------------------------------------------------------|-----\", \"----------------------------------------------------------------------------------------------------\", \"------------------|\\n| Introduction to MessagingCenter...............................................\", \".............................................24             |                                       \", \"                                                                                    |\\n| Defining a m\", \"essage..............................................................................................\", \"...................26     |                                                                         \", \"                                                  |\\n| Publishing a message..........................\", \"....................................................................................26      |       \", \"                                                                                                    \", \"                |\\n| Subscribing to a message........................................................\", \"................................................27        |                                         \", \"                                                                                  |\\n| Unsubscribing \", \"from a message......................................................................................\", \"..........27            |                                                                           \", \"                                                |\\n| Summary ........................................\", \".......................................................................................27 |         \", \"                                                                                                    \", \"              |\\n| Navigation........................................................................\", \".............................................           | 28                                        \", \"                                                                                |\\n| Navigating betwe\", \"en pages............................................................................................\", \"..........29          |                                                                             \", \"                                              |\\n| Creating the NavigationService instance...........\", \"............................................................................29          |           \", \"                                                                                                    \", \"            |\\n| Handling navigation requests........................................................\", \"................................................30    |                                             \", \"                                                                              |\\n| Navigating when th\", \"e app is launched ..................................................................................\", \".........32         |                                                                               \", \"                                            |\\n| Passing parameters during navigation ...............\", \"...........................................................................33         |             \", \"                                                                                                    \", \"          |\\n| Invoking navigation using behaviors ..................................................\", \"...........................................34       |                                               \", \"                                                                            |\\n| Confirming or cancel\", \"ling navigation.....................................................................................\", \".........34       |                                                                                 \", \"                                          |\\n| Summary ..............................................\", \".................................................................................35 |               \", \"                                                                                                    \", \"        |\\n| Validation..............................................................................\", \"........................................          | 36                                              \", \"                                                                          |\\n| Specifying validation \", \"rules                                                                                               \", \"                | ..................................................................................\", \"....................37                  |\\n| Adding validation rules to a property...................\", \"...................................................................38             |                 \", \"                                                                                                    \", \"      |\\n| Triggering validation.....................................................................\", \"..........................................39    |                                                   \", \"                                                                        |\\n| Triggering validation ma\", \"nually                                                                                              \", \"              | ....................................................................................\", \"..................39                  |\\n| Triggering validation when properties change..............\", \"................................................................40              |                   \", \"                                                                                                    \", \"    |\\n| Displaying validation errors ...............................................................\", \".....................................40       |                                                     \", \"                                                                      |\\n| Highlighting a control tha\", \"t contains invalid data                                                                             \", \"            | ..........................................................................41          \", \"                                    |\\n| Displaying error messages...................................\", \"..........................................................................44  |                     \", \"                                                                                                    \", \"  |\\n| Summary ......................................................................................\", \".........................................45 |                                                       \", \"                                                                    |\\n| Configuration management ...\", \"........................................................................................            \", \"          | 46                                                                                      \", \"                                  |\\n| Creating a settings class.....................................\", \".....................................................................46     |                       \", \"                                                                                                    \", \"|\\n| Adding a setting ...............................................................................\", \"......................................47  |                                                         \", \"                                                                  |\\n| Data binding to user settings \", \"..................................................................................................48\", \"        |                                                                                           \", \"                                |\\n| Summary ........................................................\", \".......................................................................50 |                         \", \"                                                                                                  |\\n\", \"| Containerized microservices.......................................................................\", \"....................                    | 51                                                        \", \"                                                                |\\n| Microservices...................\", \"....................................................................................................\", \"..52  |                                                                                             \", \"                              |\\n| Containerization..................................................\", \"...................................................................53   |                           \", \"                                                                                                |\\n| \", \"Communication between client and microservices .....................................................\", \".............55                       |                                                             \", \"                                                              |\\n| Communication between microservice\", \"s..................................................................................56               \", \"    |                                                                                               \", \"                            |\\n| Summary ............................................................\", \"...................................................................58 |                             \", \"                                                                                              |\\n| Au\", \"thentication and authorization .....................................................................\", \".............                       | 59                                                            \", \"                                                            |\\n| Authentication                      \", \"                                                                                                    \", \"  | ................................................................................................\", \".......................59 |\\n| Issuing bearer tokens using IdentityServer 4 .........................\", \".......................................................60           |                               \", \"                                                                                            |\\n| Addi\", \"ng IdentityServer to a web application..............................................................\", \"....................60            |                                                                 \", \"                                                          |\\n| Configuring IdentityServer            \", \"                                                                                                    \", \"| ..................................................................................................\", \"..........61            |\\n\\n| Performing authentication .............................................\", \"...............................................................64          |\\n|----------------------\", \"----------------------------------------------------------------------------------------------------\", \"-------------------------|\\n| Authorization..........................................................\", \"...............................................................69          |\\n| Configuring IdentityS\", \"erver to perform authorization ...................................................................70\", \"                         |\\n| Making access requests to APIs.........................................\", \"............................................................71             |\\n| Summary .............\", \"....................................................................................................\", \"..............71         |\\n| Accessing remote data..................................................\", \"................................................. 73                       |\\n| Introduction to Repre\", \"sentational State Transfer......................................................................73  \", \"                         |\\n| Consuming RESTful APIs ................................................\", \".........................................................74                |\\n| Making web requests .\", \"....................................................................................................\", \"...............74        |\\n| Caching data ..........................................................\", \"................................................................81         |\\n| Managing data expirat\", \"ion ................................................................................................\", \".............82          |\\n| Caching images.........................................................\", \".....................................................................82    |\\n| Increasing resilience\", \" ...................................................................................................\", \"............83           |\\n| Retry pattern .........................................................\", \"........................................................................83 |\\n| Circuit breaker patte\", \"rn .................................................................................................\", \".................84      |\\n| Summary ...............................................................\", \"................................................................85         |\\n| Unit testing.........\", \"....................................................................................................\", \"....... 86               |\\n| Dependency injection and unit testing .................................\", \"...................................................86                      |\\n| Testing MVVMapplicati\", \"ons.................................................................................................\", \"...87                    |\\n| Testing asynchronous functionality.....................................\", \"..........................................................88               |\\n| Testing INotifyProper\", \"tyChanged implementations.......................................................................88  \", \"                         |\\n| Testing message-based communication ...................................\", \"....................................................89                     |\\n| Testing exception han\", \"dling...............................................................................................\", \".............89          |\\n| Testing validation ....................................................\", \"......................................................................90   |\\n\\n## Preface\\n\\n## Purpose\", \"\\n\\nThis eBook provides guidance on building cross-platform enterprise apps using Xamarin.Forms. Xamar\", \"in.Forms is a cross-platform UI toolkit that allows developers to easily create native user interfac\", \"e layouts that can be shared across platforms, including iOS, Android, and the Universal Windows Pla\", \"tform (UWP). It provides a comprehensive solution for Business to Employee (B2E), Business to Busine\", \"ss (B2B), and Business to Consumer (B2C) apps, providing the ability to share code across all target\", \" platforms and helping to lower the total cost of ownership (TCO).\\n\\nThe guide provides architectural\", \" guidance for developing adaptable, maintainable, and testable Xamarin.Forms enterprise apps. Guidan\", \"ce is provided on how to implement MVVM, dependency injection, navigation, validation, and configura\", \"tion management, while maintaining loose coupling. In addition, there's also guidance on performing \", \"authentication and authorization with IdentityServer, accessing data from containerized microservice\", \"s, and unit testing.\\n\\nThe guide comes with source code for the eShopOnContainers mobile app, and sou\", \"rce code for the eShopOnContainers reference app. The eShopOnContainers mobile app is a cross-platfo\", \"rm enterprise app developed using Xamarin.Forms, which connects to a series of containerized microse\", \"rvices known as the eShopOnContainers reference app. However, the eShopOnContainers mobile app can b\", \"e configured to consume data from mock services for those who wish to avoid deploying the containeri\", \"zed microservices.\\n\\n## What's left out of this guide's scope\\n\\nThis guide is aimed at readers who are\", \" already familiar with Xamarin.Forms. For a detailed introduction to Xamarin.Forms, see the Xamarin.\", \"Forms documentation on the Xamarin Developer Center, and Creating Mobile Apps with Xamarin.Forms.\\n\\nT\", \"he guide is complementary to .NET Microservices: Architecture for Containerized .NET Applications, w\", \"hich focuses on developing and deploying containerized microservices. Other guides worth reading inc\", \"lude Architecting and Developing Modern Web Applications with ASP.NET Core and Microsoft Azure, Cont\", \"ainerized Docker Application Lifecycle with Microsoft Platform and Tools, and Microsoft Platform and\", \" Tools for Mobile App Development.\\n\\n## Who should use this guide\\n\\nThe audience for this guide is mai\", \"nly developers and architects who would like to learn how to architect and implement cross-platform \", \"enterprise apps using Xamarin.Forms.\\n\\nA secondary audience is technical decision makers who would li\", \"ke to receive an architectural and technology overview before deciding on what approach to select fo\", \"r cross-platform enterprise app development using Xamarin.Forms.\\n\\n## How to use this guide\\n\\nThis gui\", \"de focuses on building cross-platform enterprise apps using Xamarin.Forms. As such, it should be rea\", \"d in its entirety to provide a foundation of understanding such apps and their technical considerati\", \"ons. The guide, along with its sample app, can also serve as a starting point or reference for creat\", \"ing a new enterprise app. Use the associated sample app as a template for the new app, or to see how\", \" to organize an app's component parts. Then, refer back to this guide for architectural guidance.\\n\\nF\", \"eel free to forward this guide to team members to help ensure a common understanding of crossplatfor\", \"m enterprise app development using Xamarin.Forms. Having everybody working from a common set of term\", \"inologies and underlying principles will help ensure a consistent application of architectural patte\", \"rns and practices.\\n\\n## Introduction\\n\\nRegardless of platform, developers of enterprise apps face seve\", \"ral challenges:\\n\\n- App requirements that can change over time.\\n- New business opportunities and chal\", \"lenges.\\n- Ongoing feedback during development that can significantly affect the scope and requiremen\", \"ts of the app.\\n\\nWith these in mind, it's important to build apps that can be easily modified or exte\", \"nded over time. Designing for such adaptability can be difficult as it requires an architecture that\", \" allows individual parts of the app to be independently developed and tested in isolation without af\", \"fecting the rest of the app.\\n\\nMany enterprise apps are sufficiently complex to require more than one\", \" developer. It can be a significant challenge to decide how to design an app so that multiple develo\", \"pers can work effectively on different pieces of the app independently, while ensuring that the piec\", \"es come together seamlessly when integrated into the app.\\n\\nThe traditional approach to designing and\", \" building an app results in what is referred to as a monolithic app, where components are tightly co\", \"upled with no clear separation between them. Typically, this monolithic approach leads to apps that \", \"are difficult and inefficient to maintain, because it can be difficult to resolve bugs without break\", \"ing other components in the app, and it can be difficult to add new features or to replace existing \", \"features.\\n\\nAn effective remedy for these challenges is to partition an app into discrete, loosely co\", \"upled components that can be easily integrated together into an app. Such an approach offers several\", \" benefits:\\n\\n- It allows individual functionality to be developed, tested, extended, and maintained b\", \"y different individuals or teams.\\n- It promotes reuse and a clean separation of concerns between the\", \" app's horizontal capabilities, such as authentication and data access, and the vertical capabilitie\", \"s, such as app specific business functionality. This allows the dependencies and interactions betwee\", \"n app components to be more easily managed.\\n- It helps maintain a separation of roles by allowing di\", \"fferent individuals, or teams, to focus on a specific task or piece of functionality according to th\", \"eir expertise. In particular, it provides a cleaner separation between the user interface and the ap\", \"p's business logic.\\n\\nHowever, there are many issues that must be resolved when partitioning an app i\", \"nto discrete, loosely coupled components. These include:\\n\\n- Deciding how to provide a clean separati\", \"on of concerns between the user interface controls and their logic. One of the most important decisi\", \"ons when creating a Xamarin.Forms enterprise app is whether to place business logic in code-behind f\", \"iles, or whether to create a clean separation of concerns between the user interface controls and th\", \"eir logic, in order to\\n\\nmake the app more maintainable and testable. For more information, see Model\", \"-ViewViewModel.\\n\\n- Determining whether to use a dependency injection container. Dependency injection\", \" containers reduce the dependency coupling between objects by providing a facility to construct inst\", \"ances of classes with their dependencies injected, and manage their lifetime based on the configurat\", \"ion of the container. For more information, see Dependency injection.\\n- Choosing between platform pr\", \"ovided eventing and loosely coupled message-based communication between components that are inconven\", \"ient to link by object and type references. For more information, see Introduction to Communicating \", \"between loosely coupled components.\\n- Deciding how to navigate between pages, including how to invok\", \"e navigation, and where navigation logic should reside. For more information, see Navigation.\\n- Dete\", \"rmining how to validate user input for correctness. The decision must include how to validate user i\", \"nput, and how to notify the user about validation errors. For more information, see Validation.\\n- De\", \"ciding how to perform authentication, and how to protect resources with authorization. For more info\", \"rmation, see Authentication and authorization.\\n- Determining how to access remote data from web serv\", \"ices, including how to reliably retrieve data, and how to cache data. For more information, see Acce\", \"ssing remote data.\\n- Deciding how to test the app. For more information, see Unit testing.\\n\\nThis gui\", \"de provides guidance on these issues, and focuses on the core patterns and architecture for building\", \" a cross-platform enterprise app using Xamarin.Forms. The guidance aims to help to produce adaptable\", \", maintainable, and testable code, by addressing common Xamarin.Forms enterprise app development sce\", \"narios, and by separating the concerns of presentation, presentation logic, and entities through sup\", \"port for the Model-View-ViewModel (MVVM) pattern.\\n\\n## Sample application\\n\\nThis guide includes a samp\", \"le application, eShopOnContainers, that's an online store that includes the following functionality:\", \"\\n\\n- Authenticating and authorizing against a backend service.\\n- Browsing a catalog of shirts, coffee\", \" mugs, and other marketing items.\\n- Filtering the catalog.\\n- Ordering items from the catalog.\\n- View\", \"ing the user's order history.\\n- Configuration of settings.\\n\\n## Sample application architecture\\n\\nFigu\", \"re 1-1 provides a high-level overview of the architecture of the sample application.\\n\\nL\\n\\nClient apps\", \" eShop Mobile App\\n\\nXamarin.Forms\\n\\nCFF\\n\\nxPlatform O5:\\n\\nIOS\\n\\nAndroid\\n\\nWindows eshop Traditional WebApp\", \"\\n\\nHTML\\n\\neShop SPA WebApp\\n\\nTypeScript / Angular 2\\n\\nDocker Host\\n\\nIdentity Microservice (STS + Users]\\n\\n\", \"Web APl\\n\\nSQL Server\\n\\nContainer database\\n\\nFigure 1-1 : eShopOnContainers high-level architecture\\n\\n<!-\", \"- image -->\\n\\nThe sample application ships with three client apps:\\n\\n- An MVC application developed wi\", \"th ASP.NET Core.\\n- A Single Page Application (SPA) developed with Angular 2 and Typescript. This app\", \"roach for web applications avoids performing a round-trip to the server with each operation.\\n- A mob\", \"ile app developed with Xamarin.Forms, which supports iOS, Android, and the Universal Windows Platfor\", \"m (UWP).\\n\\nFor information about the web applications, see Architecting and Developing Modern Web App\", \"lications with ASP.NET Core and Microsoft Azure.\\n\\nThe sample application includes the following back\", \"end services:\\n\\n- An identity microservice, which uses ASP.NET Core Identity and IdentityServer.\\n- A \", \"catalog microservice, which is a data-driven create, read, update, delete (CRUD) service that consum\", \"es an SQL Server database using EntityFramework Core.\\n- An ordering microservice, which is a domain-\", \"driven service that uses domain-driven design patterns.\\n- A basket microservice, which is a data-dri\", \"ven CRUD service that uses Redis Cache.\\n\\nThese backend services are implemented as microservices usi\", \"ng ASP.NET Core MVC, and are deployed as unique containers within a single Docker host. Collectively\", \", these backend services are referred to as the eShopOnContainers reference application. Client apps\", \" communicate with the backend services through a Representational State Transfer (REST) web interfac\", \"e. For more information about microservices and Docker, see Containerized microservices.\\n\\nFor inform\", \"ation about the implementation of the backend services, see .NET Microservices: Architecture for Con\", \"tainerized .NET Applications.\\n\\n[e] OTCONTANNERS\\n\\nE\\n\\n## Mobile app\\n\\nNET\\n\\nLE CONTAINERS\\n\\nE\\n\\n8\\n\\nVisual \", \"Studio\\n\\nT-Shirt\\n\\n[e] CONTANERS\\n\\nLOG OUT\\n\\nMY ORDERS\\n\\nORDER NUMBER\\n\\nDATE\\n\\nThis guide focuses on buildi\", \"ng cross-platform enterprise apps using Xamarin.Forms, and uses the eShopOnContainers mobile app as \", \"an example. Figure 1-2 shows the pages from the eShopOnContainers mobile app that provide the functi\", \"onality outlined earlier.\\n\\n[LOGIN |\\n\\n123\\n\\nSHIPPING ADDRESS\\n\\n120 E 87th Street\\n\\nSeattle, WA\\n\\n98122\\n\\nU\", \"nited States\\n\\nFigure 1-2 : The eShopOnContainers mobile app\\n\\n<!-- image -->\\n\\nThe mobile app consumes\", \" the backend services provided by the eShopOnContainers reference application. However, it can be co\", \"nfigured to consume data from mock services for those who wish to avoid deploying the backend servic\", \"es.\\n\\nThe eShopOnContainers mobile app exercises the following Xamarin.Forms functionality:\\n\\n- XAML\\n-\", \" Controls\\n- Bindings\\n- Converters\\n- Styles\\n\\n7 / 0 7:28\\n\\nT BLUE SWEATSHIRT (M)\\n\\n$16.50\\n\\n... BLACK SWE\", \"ATSHIRT (M)\\n\\n$19.95\\n\\n8\\n\\nFILTER\\n\\n7E 0 721\\n\\n7A 0 7:22\\n\\nE\\n\\n7 / 0 7:23\\n\\n- Animations\\n- Commands\\n- Behavi\", \"ors\\n- Triggers\\n- Effects\\n- Custom Renderers\\n- MessagingCenter\\n- Custom Controls\\n\\nFor more informatio\", \"n about this functionality, see the Xamarin.Forms documentation on the Xamarin Developer Center, and\", \" Creating Mobile Apps with Xamarin.Forms.\\n\\nIn addition, unit tests are provided for some of the clas\", \"ses in the eShopOnContainers mobile app.\\n\\n## Mobile app solution\\n\\nThe eShopOnContainers mobile app s\", \"olution organizes the source code and other resources into projects. All of the projects use folders\", \" to organize the source code and other resources into categories. The following table outlines the p\", \"rojects that make up the eShopOnContainers mobile app:\\n\\n| Project                              | Des\", \"cription                                                                                            \", \"       |\\n|--------------------------------------|---------------------------------------------------\", \"------------------------------------------------------------|\\n| eShopOnContainers.Core              \", \" | This project is the portable class library (PCL) project that contains the shared code and shared\", \" UI.         |\\n| eShopOnContainers.Droid              | This project holds Android specific code and\", \" is the entry point for the Android app.                          |\\n| eShopOnContainers.iOS         \", \"       | This project holds iOS specific code and is the entry point for the iOS app.               \", \"                   |\\n| eShopOnContainers.UWP                | This project holds Universal Windows P\", \"latform (UWP) specific code and is the entry point for the Windows app. |\\n| eShopOnContainers.TestRu\", \"nner.Droid   | This project is the Android test runner for the eShopOnContainers.UnitTests project. \", \"                         |\\n| eShopOnContainers.TestRunner.iOS     | This project is the iOS test run\", \"ner for the eShopOnContainers.UnitTests project.                              |\\n| eShopOnContainers.\", \"TestRunner.Windows | This project is the Universal Windows Platform test runner for the eShopOnConta\", \"iners.UnitTests project.       |\\n| eShopOnContainers.UnitTests          | This project contains unit\", \" tests for the eShopOnContainers.Core project.                                      |\\n\\nThe classes f\", \"rom the eShopOnContainers mobile app can be re-used in any Xamarin.Forms app with little or no modif\", \"ication.\\n\\n## eShopOnContainers.Core project\\n\\nThe eShopOnContainers.Core PCL project contains the fol\", \"lowing folders:\\n\\n| Folder      | Description                                                        \", \"                                           |\\n|-------------|----------------------------------------\", \"-----------------------------------------------------------------------|\\n| Animations  | Contains cl\", \"asses that enable animations to be consumed in XAML.                                               |\", \"\\n| Behaviors   | Contains behaviors that are exposed to view classes.                               \", \"                           |\\n| Controls    | Contains custom controls used by the app.              \", \"                                                       |\\n| Converters  | Contains value converters t\", \"hat apply custom logic to a binding.                                               |\\n| Effects     |\", \" Contains the EntryLineColorEffect class, which is used to change the border color of specific Entry\", \" controls. |\\n| Exceptions  | Contains the custom ServiceAuthenticationException .                   \", \"                                       |\\n| Extensions  | Contains extension methods for the VisualEl\", \"ement and IEnumerable<T> classes.                                  |\\n| Helpers     | Contains helper\", \" classes for the app.                                                                          |\\n| M\", \"odels      | Contains the model classes for the app.                                                \", \"                       |\\n| Properties  | Contains AssemblyInfo.cs , a .NET assembly metadata file.  \", \"                                                   |\\n| Services    | Contains interfaces and classes\", \" that implement services that are provided to the app.                         |\\n| Triggers    | Con\", \"tains the BeginAnimation trigger, which is used to invoke an animation in XAML.                     \", \"       |\\n| Validations | Contains classes involved in validating data input.                        \", \"                                   |\\n| ViewModels  | Contains the application logic that's exposed t\", \"o pages.                                                       |\\n| Views       | Contains the pages \", \"for the app.                                                                               |\\n\\n## Pla\", \"tform projects\\n\\nThe platform projects contain effect implementations, custom renderer implementation\", \"s, and other platform-specific resources.\\n\\n## Summary\\n\\nXamarin's cross-platform mobile app developme\", \"nt tools and platforms provide a comprehensive solution for B2E, B2B, and B2C mobile client apps, pr\", \"oviding the ability to share code across all target platforms (iOS, Android, and Windows) and helpin\", \"g to lower the total cost of ownership. Apps can share their user interface and app logic code, whil\", \"e retaining the native platform look and feel.\\n\\nDevelopers of enterprise apps face several challenge\", \"s that can alter the architecture of the app during development. Therefore, it's important to build \", \"an app so that it can be modified or extended over time. Designing for such adaptability can be diff\", \"icult, but typically involves partitioning an app into discrete, loosely coupled components that can\", \" be easily integrated together into an app.\\n\\nView\\n\\nData Binding and Commands\\n\\nSend notifications\\n\\nVi\", \"ewModel updates the model\\n\\n\\u2022\\n\\nSend notifications\\n\\nSauro 2.1. The MWVM nattern\\n\\n## MVVM\\n\\nThe Xamarin.\", \"Forms developer experience typically involves creating a user interface in XAML, and then adding cod\", \"e-behind that operates on the user interface. As apps are modified, and grow in size and scope, comp\", \"lex maintenance issues can arise. These issues include the tight coupling between the UI controls an\", \"d the business logic, which increases the cost of making UI modifications, and the difficulty of uni\", \"t testing such code.\\n\\nThe Model-View-ViewModel (MVVM) pattern helps to cleanly separate the business\", \" and presentation logic of an application from its user interface (UI). Maintaining a clean separati\", \"on between application logic and the UI helps to address numerous development issues and can make an\", \" application easier to test, maintain, and evolve. It can also greatly improve code re-use opportuni\", \"ties and allows developers and UI designers to more easily collaborate when developing their respect\", \"ive parts of an app.\\n\\n## The MVVM pattern\\n\\nThere are three core components in the MVVM pattern: the \", \"model, the view, and the view model. Each serves a distinct purpose. Figure 2-1 shows the relationsh\", \"ips between the three components.\\n\\nFigure 2-1 : The MVVM pattern\\n\\n<!-- image -->\\n\\nIn addition to und\", \"erstanding the responsibilities of each components, it's also important to understand how they inter\", \"act with each other. At a high level, the view \\\"knows about\\\" the view model, and the view model \\\"kno\", \"ws about\\\" the model, but the model is unaware of the view model, and the view model is unaware of th\", \"e view. Therefore, the view model isolates the view from the model, and allows the model to evolve i\", \"ndependently of the view.\\n\\nThe benefits of using the MVVM pattern are as follows:\\n\\n- If there's an e\", \"xisting model implementation that encapsulates existing business logic, it can be difficult or risky\", \" to change it. In this scenario, the view model acts as an adapter for the model classes and enables\", \" you to avoid making any major changes to the model code.\\n\\n\\u2022\\n\\nView Model\\n\\n+\\n\\nModel\\n\\n- Developers can\", \" create unit tests for the view model and the model, without using the view. The unit tests for the \", \"view model can exercise exactly the same functionality as used by the view.\\n- The app UI can be rede\", \"signed without touching the code, provided that the view is implemented entirely in XAML. Therefore,\", \" a new version of the view should work with the existing view model.\\n- Designers and developers can \", \"work independently and concurrently on their components during the development process. Designers ca\", \"n focus on the view, while developers can work on the view model and model components.\\n\\nThe key to u\", \"sing MVVM effectively lies in understanding how to factor app code into the correct classes, and in \", \"understanding how the classes interact. The following sections discuss the responsibilities of each \", \"of the classes in the MVVM pattern.\\n\\n## View\\n\\nThe view is responsible for defining the structure, la\", \"yout, and appearance of what the user sees on screen. Ideally, each view is defined in XAML, with a \", \"limited code-behind that does not contain business logic. However, in some cases, the code-behind mi\", \"ght contain UI logic that implements visual behavior that is difficult to express in XAML, such as a\", \"nimations.\\n\\nIn a Xamarin.Forms application, a view is typically a Page -derived or ContentView -deri\", \"ved class. However, views can also be represented by a data template, which specifies the UI element\", \"s to be used to visually represent an object when it's displayed. A data template as a view does not\", \" have any code-behind, and is designed to bind to a specific view model type.\\n\\nTip: Avoid enabling a\", \"nd disabling UI elements in the code-behind\\n\\nEnsure that view models are responsible for defining lo\", \"gical state changes that affect some aspects of the view's display, such as whether a command is ava\", \"ilable, or an indication that an operation is pending. Therefore, enable and disable UI elements by \", \"binding to view model properties, rather than enabling and disabling them in code-behind.\\n\\nThere are\", \" several options for executing code on the view model in response to interactions on the view, such \", \"as a button click or item selection. If a control supports commands, the control's Command property \", \"can be data-bound to an ICommand property on the view model. When the control's command is invoked, \", \"the code in the view model will be executed. In addition to commands, behaviors can be attached to a\", \"n object in the view and can listen for either a command to be invoked or event to be raised. In res\", \"ponse, the behavior can then invoke an ICommand on the view model or a method on the view model.\\n\\n##\", \" ViewModel\\n\\nThe view model implements properties and commands to which the view can data bind to, an\", \"d notifies the view of any state changes through change notification events. The properties and comm\", \"ands that the view model provides define the functionality to be offered by the UI, but the view det\", \"ermines how that functionality is to be displayed.\\n\\nTip: Keep the UI responsive with asynchronous op\", \"erations\\n\\nMobile apps should keep the UI thread unblocked to improve the user's perception of perfor\", \"mance. Therefore, in the view model, use asynchronous methods for I/O operations and raise events to\", \" asynchronously notify views of property changes.\\n\\nThe view model is also responsible for coordinati\", \"ng the view's interactions with any model classes that are required. There's typically a one-to-many\", \" relationship between the view model and the model classes. The view model might choose to expose mo\", \"del classes directly to the view so that controls in the view can data bind directly to them. In thi\", \"s case, the model classes will need to be designed to support data binding and change notification e\", \"vents.\\n\\nEach view model provides data from a model in a form that the view can easily consume. To ac\", \"complish this, the view model sometimes performs data conversion. Placing this data conversion in th\", \"e view model is a good idea because it provides properties that the view can bind to. For example, t\", \"he view model might combine the values of two properties to make it easier for display by the view.\\n\", \"\\nTip: Centralize data conversions in a conversion layer\\n\\nIt's also possible to use converters as a s\", \"eparate data conversion layer that sits between the view model and the view. This can be necessary, \", \"for example, when data requires special formatting that the view model doesn't provide.\\n\\nIn order fo\", \"r the view model to participate in two-way data binding with the view, its properties must raise the\", \" PropertyChanged event. View models satisfy this requirement by implementing the INotifyPropertyChan\", \"ged interface, and raising the PropertyChanged event when a property is changed.\\n\\nFor collections, t\", \"he view-friendly ObservableCollection&lt;T&gt; is provided. This collection implements collection ch\", \"anged notification, relieving the developer from having to implement the INotifyCollectionChanged in\", \"terface on collections.\\n\\n## Model\\n\\nModel classes are non-visual classes that encapsulate the app's d\", \"ata. Therefore, the model can be thought of as representing the app's domain model, which usually in\", \"cludes a data model along with business and validation logic. Examples of model objects include data\", \" transfer objects (DTOs), Plain Old CLR Objects (POCOs), and generated entity and proxy objects.\\n\\nMo\", \"del classes are typically used in conjunction with services or repositories that encapsulate data ac\", \"cess and caching.\\n\\n## Connecting view models to views\\n\\nView models can be connected to views by usin\", \"g the data-binding capabilities of Xamarin.Forms. There are many approaches that can be used to cons\", \"truct views and view models and associate them at runtime. These approaches fall into two categories\", \", known as view first composition, and view model first composition. Choosing between view first com\", \"position and view model first composition is an issue of preference and complexity. However, all app\", \"roaches share the same aim, which is for the view to have a view model assigned to its BindingContex\", \"t property.\\n\\nWith view first composition the app is conceptually composed of views that connect to t\", \"he view models they depend on. The primary benefit of this approach is that it makes it easy to cons\", \"truct loosely coupled, unit testable apps because the view models have no dependence on the views th\", \"emselves. It's also easy to understand the structure of the app by following its visual structure, r\", \"ather than having to track code execution to understand how classes are created and associated. In a\", \"ddition, view first construction aligns with the Xamarin.Forms navigation system that's responsible \", \"for constructing pages when navigation occurs, which makes a view model first composition complex an\", \"d misaligned with the platform.\\n\\nWith view model first composition the app is conceptually composed \", \"of view models, with a service being responsible for locating the view for a view model. View model \", \"first composition feels more natural to some developers, since the view creation can be abstracted a\", \"way, allowing them to focus on the logical non-UI structure of the app. In addition, it allows view \", \"models to be created by other view models. However, this approach is often complex and it can become\", \" difficult to understand how the various parts of the app are created and associated.\\n\\nTip: Keep vie\", \"w models and views independent\\n\\nThe binding of views to a property in a data source should be the vi\", \"ew's principal dependency on its corresponding view model. Specifically, don't reference view types,\", \" such as Button and ListView , from view models. By following the principles outlined here, view mod\", \"els can be tested in isolation, therefore reducing the likelihood of software defects by limiting sc\", \"ope.\\n\\nThe following sections discuss the main approaches to connecting view models to views.\\n\\n## Cre\", \"ating a view model declaratively\\n\\nThe simplest approach is for the view to declaratively instantiate\", \" its corresponding view model in XAML. When the view is constructed, the corresponding view model ob\", \"ject will also be constructed. This approach is demonstrated in the following code example:\\n\\n```\\n<Co\", \"ntentPage ... xmlns:local=\\\"clr-namespace:eShop\\\"> <ContentPage.BindingContext> <local:LoginViewModel \", \"/> </ContentPage.BindingContext> ... </ContentPage>\\n```\\n\\nWhen the ContentPage is created, an instanc\", \"e of the LoginViewModel is automatically constructed and set as the view's BindingContext .\\n\\nThis de\", \"clarative construction and assignment of the view model by the view has the advantage that it's simp\", \"le, but has the disadvantage that it requires a default (parameter-less) constructor in the view mod\", \"el.\\n\\n## Creating a view model programmatically\\n\\nA view can have code in the code-behind file that re\", \"sults in the view model being assigned to its BindingContext property. This is often accomplished in\", \" the view's constructor, as shown in the following code example:\\n\\n```\\npublic LoginView() { Initializ\", \"eComponent(); BindingContext = new LoginViewModel(navigationService); }\\n```\\n\\nThe programmatic constr\", \"uction and assignment of the view model within the view's code-behind has the advantage that it's si\", \"mple. However, the main disadvantage of this approach is that the view needs to provide the view mod\", \"el with any required dependencies. Using a dependency injection container can help to maintain loose\", \" coupling between the view and view model. For more information, see Dependency injection.\\n\\n## Creat\", \"ing a view defined as a data template\\n\\nA view can be defined as a data template and associated with \", \"a view model type. Data templates can be defined as resources, or they can be defined inline within \", \"the control that will display the view model. The content of the control is the view model instance,\", \" and the data template is used to visually represent it. This technique is an example of a situation\", \" in which the view model is instantiated first, followed by the creation of the view.\\n\\n## Automatica\", \"lly creating a view model with a view model locator\\n\\nA view model locator is a custom class that man\", \"ages the instantiation of view models and their association to views. In the eShopOnContainers mobil\", \"e app, the ViewModelLocator class has an attached property, AutoWireViewModel , that's used to assoc\", \"iate view models with views. In the view's XAML, this attached property is set to true to indicate t\", \"hat the view model should be automatically connected to the view, as shown in the following code exa\", \"mple:\\n\\n```\\nviewModelBase:ViewModelLocator.AutoWireViewModel=\\\"true\\\"\\n```\\n\\nThe AutoWireViewModel proper\", \"ty is a bindable property that's initialized to false , and when its value changes the OnAutoWireVie\", \"wModelChanged event handler is called. This method resolves the view model for the view. The followi\", \"ng code example shows how this is achieved:\\n\\n```\\nprivate static void OnAutoWireViewModelChanged(Bind\", \"ableObject bindable, object oldValue, object n ewValue) { var view = bindable as Element; if (view =\", \"= null) { return; } var viewType = view.GetType(); var viewName = viewType.FullName.Replace(\\\".Views.\", \"\\\", \\\".ViewModels.\\\"); var viewAssemblyName = viewType.GetTypeInfo().Assembly.FullName; var viewModelNa\", \"me = string.Format( CultureInfo.InvariantCulture, \\\"{0}Model, {1}\\\", viewName, viewAssemblyName); var \", \"viewModelType = Type.GetType(viewModelName); if (viewModelType == null) { return; } var viewModel = \", \"_container.Resolve(viewModelType); view.BindingContext = viewModel; }\\n```\\n\\nThe OnAutoWireViewModelCh\", \"anged method attempts to resolve the view model using a conventionbased approach. This convention as\", \"sumes that:\\n\\n- View models are in the same assembly as view types.\\n- Views are in a .Views child nam\", \"espace.\\n- View models are in a .ViewModels child namespace.\\n- View model names correspond with view \", \"names and end with \\\"ViewModel\\\".\\n\\nFinally, the OnAutoWireViewModelChanged method sets the BindingCont\", \"ext of the view type to the resolved view model type. For more information about resolving the view \", \"model type, see Resolution.\\n\\nThis approach has the advantage that an app has a single class that is \", \"responsible for the instantiation of view models and their connection to views.\\n\\nTip: Use a view mod\", \"el locator for ease of substitution\\n\\nA view model locator can also be used as a point of substitutio\", \"n for alternate implementations of dependencies, such as for unit testing or design time data.\\n\\n## U\", \"pdating views in response to changes in the underlying view model or model\\n\\nAll view model and model\", \" classes that are accessible to a view should implement the INotifyPropertyChanged interface. Implem\", \"enting this interface in a view model or model class allows the class to provide change notification\", \"s to any data-bound controls in the view when the underlying property value changes.\\n\\nApp's should b\", \"e architected for the correct use of property change notification, by meeting the following requirem\", \"ents:\\n\\n- Always raising a PropertyChanged event if a public property's value changes. Do not assume \", \"that raising the PropertyChanged event can be ignored because of knowledge of how XAML binding occur\", \"s.\\n- Always raising a PropertyChanged event for any calculated properties whose values are used by o\", \"ther properties in the view model or model.\\n- Always raising the PropertyChanged event at the end of\", \" the method that makes a property change, or when the object is known to be in a safe state. Raising\", \" the event interrupts the operation by invoking the event's handlers synchronously. If this happens \", \"in the middle of an operation, it might expose the object to callback functions when it is in an uns\", \"afe, partially updated state. In addition, it's possible for cascading changes to be triggered by Pr\", \"opertyChanged events. Cascading changes generally require updates to be complete before the cascadin\", \"g change is safe to execute.\\n- Never raising a PropertyChanged event if the property does not change\", \". This means that you must compare the old and new values before raising the PropertyChanged event.\\n\", \"- Never raising the PropertyChanged event during a view model's constructor if you are initializing \", \"a property. Data-bound controls in the view will not have subscribed to receive change notifications\", \" at this point.\\n- Never raising more than one PropertyChanged event with the same property name argu\", \"ment within a single synchronous invocation of a public method of a class. For example, given a Numb\", \"erOfItems property whose backing store is the \\\\_numberOfItems field, if a method increments \\\\_number\", \"OfItems fifty times during the execution of a loop, it should only raise property change notificatio\", \"n on the NumberOfItems property once, after all the work is complete. For asynchronous methods, rais\", \"e the PropertyChanged event for a given property name in each synchronous segment of an asynchronous\", \" continuation chain.\\n\\nThe eShopOnContainers mobile app uses the ExtendedBindableObject class to prov\", \"ide change notifications, which is shown in the following code example:\\n\\n```\\npublic abstract class E\", \"xtendedBindableObject : BindableObject { public void RaisePropertyChanged<T>(Expression<Func<T>> pro\", \"perty) { var name = GetMemberInfo(property).Name; OnPropertyChanged(name); } private MemberInfo GetM\", \"emberInfo(Expression expression) { ... } }\\n```\\n\\nXamarin.Form's BindableObject class implements the I\", \"NotifyPropertyChanged interface, and provides an OnPropertyChanged method. The ExtendedBindableObjec\", \"t class provides the RaisePropertyChanged method to invoke property change notification, and in doin\", \"g so uses the functionality provided by the BindableObject class.\\n\\nEach view model class in the eSho\", \"pOnContainers mobile app derives from the ViewModelBase class, which in turn derives from the Extend\", \"edBindableObject class. Therefore, each view model class uses the RaisePropertyChanged method in the\", \" ExtendedBindableObject class to provide property change notification. The following code example sh\", \"ows how the eShopOnContainers mobile app invokes property change notification by using a lambda expr\", \"ession:\\n\\n```\\npublic bool IsLogin { get { return _isLogin; } set { _isLogin = value; RaisePropertyCha\", \"nged(() => IsLogin); } }\\n```\\n\\nNote that using a lambda expression in this way involves a small perfo\", \"rmance cost because the lambda expression has to be evaluated for each call. Although the performanc\", \"e cost is small and would not normally impact an app, the costs can accrue when there are many chang\", \"e notifications. However, the benefit of this approach is that it provides compile-time type safety \", \"and refactoring support when renaming properties.\\n\\n## UI interaction using commands and behaviors\\n\\nI\", \"n mobile apps, actions are typically invoked in response to a user action, such as a button click, t\", \"hat can be implemented by creating an event handler in the code-behind file. However, in the MVVM pa\", \"ttern, the responsibility for implementing the action lies with the view model, and placing code in \", \"the code-behind should be avoided.\\n\\nCommands provide a convenient way to represent actions that can \", \"be bound to controls in the UI. They encapsulate the code that implements the action, and help to ke\", \"ep it decoupled from its visual representation in the view. Xamarin.Forms includes controls that can\", \" be declaratively connected to a command, and these controls will invoke the command when the user i\", \"nteracts with the control.\\n\\nBehaviors also allow controls to be declaratively connected to a command\", \". However, behaviors can be used to invoke an action that's associated with a range of events raised\", \" by a control. Therefore, behaviors address many of the same scenarios as command-enabled controls, \", \"while providing a greater degree of flexibility and control. In addition, behaviors can also be used\", \" to associate command objects or methods with controls that were not specifically designed to intera\", \"ct with commands.\\n\\n## Implementing commands\\n\\nView models typically expose command properties, for bi\", \"nding from the view, that are object instances that implement the ICommand interface. A number of Xa\", \"marin.Forms controls provide a Command property, which can be data bound to an ICommand object provi\", \"ded by the view model. The ICommand interface defines an Execute method, which encapsulates the oper\", \"ation itself, a CanExecute method, which indicates whether the command can be invoked, and a CanExec\", \"uteChanged event that occurs when changes occur that affect whether the command should execute. The \", \"Command and Command&lt;T&gt; classes, provided by Xamarin.Forms, implement the ICommand interface, w\", \"here T is the type of the arguments to Execute and CanExecute .\\n\\nWithin a view model, there should b\", \"e an object of type Command or Command&lt;T&gt; for each public property in the view model of type I\", \"Command . The Command or Command&lt;T&gt; constructor requires an Action callback object that's call\", \"ed when the ICommand.Execute method is invoked. The CanExecute method is an optional constructor par\", \"ameter, and is a Func that returns a bool .\\n\\nThe following code shows how a Command instance, which \", \"represents a register command, is constructed by specifying a delegate to the Register view model me\", \"thod:\\n\\n```\\npublic ICommand RegisterCommand => new Command(Register);\\n```\\n\\nThe command is exposed to \", \"the view through a property that returns a reference to an ICommand . When the Execute method is cal\", \"led on the Command object, it simply forwards the call to the method in the view model via the deleg\", \"ate that was specified in the Command constructor.\\n\\nAn asynchronous method can be invoked by a comma\", \"nd by using the async and await keywords when specifying the command's Execute delegate. This indica\", \"tes that the callback is a Task and should be awaited. For example, the following code shows how a C\", \"ommand instance, which represents a sign-in command, is constructed by specifying a delegate to the \", \"SignInAsync view model method:\\n\\n```\\npublic ICommand SignInCommand => new Command(async () => await S\", \"ignInAsync());\\n```\\n\\nParameters can be passed to the Execute and CanExecute actions by using the Comm\", \"and&lt;T&gt; class to instantiate the command. For example, the following code shows how a Command&l\", \"t;T&gt; instance is used to indicate that the NavigateAsync method will require an argument of type \", \"string :\\n\\n```\\npublic ICommand NavigateCommand => new Command<string>(NavigateAsync);\\n```\\n\\nIn both th\", \"e Command and Command&lt;T&gt; classes, the delegate to the CanExecute method in each constructor is\", \" optional. If a delegate isn't specified, the Command will return true for CanExecute . However, the\", \" view model can indicate a change in the command's CanExecute status by calling the ChangeCanExecute\", \" method on the Command object. This causes the CanExecuteChanged event to be raised. Any controls in\", \" the UI that are bound to the command will then update their enabled status to reflect the availabil\", \"ity of the data-bound command.\\n\\n## Invoking commands from a view\\n\\nThe following code example shows h\", \"ow a Grid in the LoginView binds to the RegisterCommand in the LoginViewModel class by using a TapGe\", \"stureRecognizer instance:\\n\\n```\\n<Grid Grid.Column=\\\"1\\\" HorizontalOptions=\\\"Center\\\"> <Label Text=\\\"REGIST\", \"ER\\\" TextColor=\\\"Gray\\\"/> <Grid.GestureRecognizers> <TapGestureRecognizer Command=\\\"{Binding RegisterCom\", \"mand}\\\" NumberOfTapsRequired=\\\"1\\\" /> </Grid.GestureRecognizers> </Grid>\\n```\\n\\nA command parameter can a\", \"lso be optionally defined using the CommandParameter property. The type of the expected argument is \", \"specified in the Execute and CanExecute target methods. The TapGestureRecognizer will automatically \", \"invoke the target command when the user interacts with the attached control. The command parameter, \", \"if provided, will be passed as the argument to the command's Execute delegate.\\n\\n## Implementing beha\", \"viors\\n\\nBehaviors allow functionality to be added to UI controls without having to subclass them. Ins\", \"tead, the functionality is implemented in a behavior class and attached to the control as if it was \", \"part of the control itself. Behaviors enable you to implement code that you would normally have to w\", \"rite as code-behind, because it directly interacts with the API of the control, in such a way that i\", \"t can be concisely attached to the control, and packaged for reuse across more than one view or app.\", \" In the context of MVVM, behaviors are a useful approach for connecting controls to commands.\\n\\nA beh\", \"avior that's attached to a control through attached properties is known as an attached behavior . Th\", \"e behavior can then use the exposed API of the element to which it is attached to add functionality \", \"to that control, or other controls, in the visual tree of the view. The eShopOnContainers mobile app\", \" contains the LineColorBehavior class, which is an attached behavior. For more information about thi\", \"s behavior, see Displaying validation errors.\\n\\nA Xamarin.Forms behavior is a class that derives from\", \" the Behavior or Behavior&lt;T&gt; class, where T is the type of the control to which the behavior s\", \"hould apply. These classes provide OnAttachedTo and OnDetachingFrom methods, which should be overrid\", \"den to provide logic that will be executed when the behavior is attached to and detached from contro\", \"ls.\\n\\nIn the eShopOnContainers mobile app, the BindableBehavior&lt;T&gt; class derives from the Behav\", \"ior&lt;T&gt; class. The purpose of the BindableBehavior&lt;T&gt; class is to provide a base class fo\", \"r Xamarin.Forms behaviors that require the BindingContext of the behavior to be set to the attached \", \"control.\\n\\nThe BindableBehavior&lt;T&gt; class provides an overridable OnAttachedTo method that sets \", \"the BindingContext of the behavior, and an overridable OnDetachingFrom method that cleans up the Bin\", \"dingContext . In addition, the class stores a reference to the attached control in the AssociatedObj\", \"ect property.\\n\\nThe eShopOnContainers mobile app includes an EventToCommandBehavior class, which exec\", \"utes a command in response to an event occurring. This class derives from the BindableBehavior&lt;Vi\", \"ew&gt; class so that the behavior can bind to and execute an ICommand specified by a Command propert\", \"y when the behavior is consumed. The following code example shows the EventToCommandBehavior class:\\n\", \"\\n```\\npublic class EventToCommandBehavior : BindableBehavior<View> { ... protected override void OnAt\", \"tachedTo(View visualElement) { base.OnAttachedTo(visualElement); var events = AssociatedObject.GetTy\", \"pe().GetRuntimeEvents().ToArray(); if (events.Any()) { _eventInfo = events.FirstOrDefault(e => e.Nam\", \"e == EventName); if (_eventInfo == null) throw new ArgumentException(string.Format( \\\"EventToCommand:\", \" Can't find any event named '{0}' on attached type\\\", EventName)); AddEventHandler(_eventInfo, Associ\", \"atedObject, OnFired); } } protected override void OnDetachingFrom(View view) { if (_handler != null)\", \" _eventInfo.RemoveEventHandler(AssociatedObject, _handler); base.OnDetachingFrom(view); } private vo\", \"id AddEventHandler( EventInfo eventInfo, object item, Action<object, EventArgs> action) { ... } priv\", \"ate void OnFired(object sender, EventArgs eventArgs) { ... } }\\n```\\n\\nThe OnAttachedTo and OnDetaching\", \"From methods are used to register and deregister an event handler for the event defined in the Event\", \"Name property. Then, when the event fires, the OnFired method is invoked, which executes the command\", \".\\n\\nThe advantage of using the EventToCommandBehavior to execute a command when an event fires, is th\", \"at commands can be associated with controls that weren't designed to interact with commands. In addi\", \"tion, this moves event-handling code to view models, where it can be unit tested.\\n\\n## Invoking behav\", \"iors from a view\\n\\nThe EventToCommandBehavior is particularly useful for attaching a command to a con\", \"trol that doesn't support commands. For example, the ProfileView uses the EventToCommandBehavior to \", \"execute the OrderDetailCommand when the ItemTapped event fires on the ListView that lists the user's\", \" orders, as shown in the following code:\\n\\n```\\n<ListView> <ListView.Behaviors> <behaviors:EventToComm\", \"andBehavior EventName=\\\"ItemTapped\\\" Command=\\\"{Binding OrderDetailCommand}\\\" EventArgsConverter=\\\"{Stati\", \"cResource ItemTappedEventArgsConverter}\\\" />\\n```\\n\\n<!-- image -->\\n\\n| </ListView.Behaviors>   |\\n|------\", \"-------------------|\\n| ...                     |\\n| </ListView>             |\\n\\nAt runtime, the EventT\", \"oCommandBehavior will respond to interaction with the ListView . When an item is selected in the Lis\", \"tView , the ItemTapped event will fire, which will execute the OrderDetailCommand in the ProfileView\", \"Model . By default, the event arguments for the event are passed to the command. This data is conver\", \"ted as it's passed between source and target by the converter specified in the EventArgsConverter pr\", \"operty, which returns the Item of the ListView from the I temTappedEventArgs . Therefore, when the O\", \"rderDetailCommand is executed, the selected Order is passed as a parameter to the registered Action \", \".\\n\\nFor more information about behaviors, see Behaviors on the Xamarin Developer Center.\\n\\n## Summary\\n\", \"\\nThe Model-View-ViewModel (MVVM) pattern helps to cleanly separate the business and presentation log\", \"ic of an application from its user interface (UI). Maintaining a clean separation between applicatio\", \"n logic and the UI helps to address numerous development issues and can make an application easier t\", \"o test, maintain, and evolve. It can also greatly improve code re-use opportunities and allows devel\", \"opers and UI designers to more easily collaborate when developing their respective parts of an app.\\n\", \"\\nUsing the MVVM pattern, the UI of the app and the underlying presentation and business logic is sep\", \"arated into three separate classes: the view, which encapsulates the UI and UI logic; the view model\", \", which encapsulates presentation logic and state; and the model, which encapsulates the app's busin\", \"ess logic and data.\\n\\n## Dependency injection\\n\\nTypically, a class constructor is invoked when instant\", \"iating an object, and any values that the object needs are passed as arguments to the constructor. T\", \"his is an example of dependency injection, and specifically is known as constructor injection . The \", \"dependencies the object needs are injected into the constructor.\\n\\nBy specifying dependencies as inte\", \"rface types, dependency injection enables decoupling of the concrete types from the code that depend\", \"s on these types. It generally uses a container that holds a list of registrations and mappings betw\", \"een interfaces and abstract types, and the concrete types that implement or extend these types.\\n\\nThe\", \"re are also other types of dependency injection, such as property setter injection , and method call\", \" injection , but they are less commonly seen. Therefore, this chapter will focus solely on performin\", \"g constructor injection with a dependency injection container.\\n\\n## Introduction to dependency inject\", \"ion\\n\\nDependency injection is a specialized version of the Inversion of Control (IoC) pattern, where \", \"the concern being inverted is the process of obtaining the required dependency. With dependency inje\", \"ction, another class is responsible for injecting dependencies into an object at runtime. The follow\", \"ing code example shows how the ProfileViewModel class is structured when using dependency injection:\", \"\\n\\n```\\npublic class ProfileViewModel : ViewModelBase { private IOrderService _orderService; public Pr\", \"ofileViewModel(IOrderService orderService) { _orderService = orderService; } ... }\\n```\\n\\nThe ProfileV\", \"iewModel constructor receives an IOrderService another class. The only dependency in the ProfileView\", \"Model class is on the interface type.\\n\\ninstance as an argument, injected by\\n\\nTherefore, the ProfileV\", \"iewModel class doesn't have any knowledge of the class that's responsible for instantiating the IOrd\", \"erService object. The class that's responsible for instantiating the\\n\\nProfileViewModel +\\n\\nContainer\\n\", \"\\nOrderService\\n\\nIOrderService object, and inserting it into the ProfileViewModel class, is known as t\", \"he dependency injection container .\\n\\nDependency injection containers reduce the coupling between obj\", \"ects by providing a facility to instantiate class instances and manage their lifetime based on the c\", \"onfiguration of the container. During the objects creation, the container injects any dependencies t\", \"hat the object requires into it. If those dependencies have not yet been created, the container crea\", \"tes and resolves their dependencies first.\\n\\nOrderService m\\n\\nNote: Dependency injection can also be i\", \"mplemented manually using factories. However, using a container provides additional capabilities suc\", \"h as lifetime management, and registration through assembly scanning.\\n\\nSaure 2-1. Demendencies when \", \"icina denendency iniertion\\n\\nThere are several advantages to using a dependency injection container:\\n\", \"\\n- A container removes the need for a class to locate its dependencies and manage their lifetimes.\\n-\", \" A container allows mapping of implemented dependencies without affecting the class.\\n- A container f\", \"acilitates testability by allowing dependencies to be mocked.\\n- A container increases maintainabilit\", \"y by allowing new classes to be easily added to the app.\\n\\nIn the context of a Xamarin.Forms app that\", \" uses MVVM, a dependency injection container will typically be used for registering and resolving vi\", \"ew models, and for registering services and injecting them into view models.\\n\\nThere are many depende\", \"ncy injection containers available, with the eShopOnContainers mobile app using Autofac to manage th\", \"e instantiation of view model and service classes in the app. Autofac facilitates building loosely c\", \"oupled apps, and provides all of the features commonly found in dependency injection containers, inc\", \"luding methods to register type mappings and object instances, resolve objects, manage object lifeti\", \"mes, and inject dependent objects into constructors of objects that it resolves. For more informatio\", \"n about Autofac, see Autofac on readthedocs.io.\\n\\nIn Autofac, the IContainer interface provides the d\", \"ependency injection container. Figure 3-1 shows the dependencies when using this container, which in\", \"stantiates an IOrderService object and injects it into the ProfileViewModel class.\\n\\nFigure 3-1: Depe\", \"ndencies when using dependency injection\\n\\n<!-- image -->\\n\\nAt runtime, the container must know which \", \"implementation of the IOrderService interface it should instantiate, before it can instantiate a Pro\", \"fileViewModel object. This involves:\\n\\n- The container deciding how to instantiate an object that imp\", \"lements the IOrderService interface. This is known as registration .\\n- The container instantiating t\", \"he object that implements the IOrderService interface, and the ProfileViewModel object. This is know\", \"n as resolution .\\n\\nEventually, the app will finish using the ProfileViewModel object and it will bec\", \"ome available for garbage collection. At this point, the garbage collector should dispose of the IOr\", \"derService instance if other classes do not share the same instance.\\n\\nTip: Write container-agnostic \", \"code\\n\\nAlways try to write container-agnostic code to decouple the app from the specific dependency c\", \"ontainer being used.\\n\\n## Registration\\n\\nBefore dependencies can be injected into an object, the types\", \" of the dependencies must first be registered with the container. Registering a type typically invol\", \"ves passing the container an interface and a concrete type that implements the interface.\\n\\nThere are\", \" two ways of registering types and objects in the container through code:\\n\\n- Register a type or mapp\", \"ing with the container. When required, the container will build an instance of the specified type.\\n-\", \" Register an existing object in the container as a singleton. When required, the container will retu\", \"rn a reference to the existing object.\\n\\nTip: Dependency injection containers are not always suitable\", \"\\n\\nDependency injection introduces additional complexity and requirements that might not be appropria\", \"te or useful to small apps. If a class does not have any dependencies, or is not a dependency for ot\", \"her types, it might not make sense to put it in the container. In addition, if a class has a single \", \"set of dependencies that are integral to the type and will never change, it might not make sense to \", \"put it in the container.\\n\\nThe registration of types that require dependency injection should be perf\", \"ormed in a single method in an app, and this method should be invoked early in the app's lifecycle t\", \"o ensure that the app is aware of the dependencies between its classes. In the eShopOnContainers mob\", \"ile app this is performed by the ViewModelLocator class, which builds the IContainer object and is t\", \"he only class in the app that holds a reference to that object. The following code example shows how\", \" the eShopOnContainers mobile app declares the IContainer object in the ViewModelLocator class:\\n\\n```\", \"\\nprivate static IContainer _container;\\n```\\n\\nTypes and instances are registered in the RegisterDepend\", \"encies method in the ViewModelLocator class. This is achieved by first creating a ContainerBuilder i\", \"nstance, which is demonstrated in the following code example:\\n\\n```\\nvar builder = new ContainerBuilde\", \"r();\\n```\\n\\nTypes and instances are then registered with the ContainerBuilder object, and the followin\", \"g code example demonstrates the most common form of type registration:\\n\\nbuilder.RegisterType&lt;Requ\", \"estProvider&gt;().As&lt;IRequestProvider&gt;();\\n\\nThe RegisterType method shown here maps an interfac\", \"e type to a concrete type. It tells the container to instantiate a RequestProvider object when it in\", \"stantiates an object that requires an injection of an IRequestProvider through a constructor.\\n\\nConcr\", \"ete types can also be registered directly without a mapping from an interface type, as shown in the \", \"following code example:\\n\\n```\\nbuilder.RegisterType<ProfileViewModel>();\\n```\\n\\nWhen the ProfileViewMode\", \"l type is resolved, the container will inject its required dependencies.\\n\\nAutofac also allows instan\", \"ce registration, where the container is responsible for maintaining a reference to a singleton insta\", \"nce of a type. For example, the following code example shows how the eShopOnContainers mobile app re\", \"gisters the concrete type to use when a ProfileViewModel instance requires an IOrderService instance\", \":\\n\\nbuilder.RegisterType&lt;OrderService&gt;().As&lt;IOrderService&gt;().SingleInstance();\\n\\nThe Regis\", \"terType method shown here maps an interface type to a concrete type. The SingleInstance method confi\", \"gures the registration so that every dependent object receives the same shared instance. Therefore, \", \"only a single OrderService instance will exist in the container, which is shared by objects that req\", \"uire an injection of an IOrderService through a constructor.\\n\\nInstance registration can also be perf\", \"ormed with the RegisterInstance method, which is demonstrated in the following code example:\\n\\nbuilde\", \"r.RegisterInstance(new OrderMockService()).As&lt;IOrderService&gt;();\\n\\nThe RegisterInstance method s\", \"hown here creates a new OrderMockService instance and registers it with the container. Therefore, on\", \"ly a single OrderMockService instance exists in the container, which is shared by objects that requi\", \"re an injection of an IOrderService through a constructor.\\n\\nFollowing type and instance registration\", \", the IContainer object must be built, which is demonstrated in the following code example:\\n\\n```\\n_co\", \"ntainer = builder.Build();\\n```\\n\\nInvoking the Build method on the ContainerBuilder instance builds a \", \"new dependency injection container that contains the registrations that have been made.\\n\\nTip : Consi\", \"der an IContainer as being immutable\\n\\nWhile Autofac provides an Update method to update registration\", \"s in an existing container, calling this method should be avoided where possible. There are risks to\", \" modifying a container after it's been built, particularly if the container has been used. For more \", \"information, see Consider a Container as Immutable on readthedocs.io.\\n\\n## Resolution\\n\\nAfter a type i\", \"s registered, it can be resolved or injected as a dependency. When a type is being resolved and the \", \"container needs to create a new instance, it injects any dependencies into the instance.\\n\\nGenerally,\", \" when a type is resolved, one of three things happens:\\n\\n1. If the type hasn't been registered, the c\", \"ontainer throws an exception.\\n2. If the type has been registered as a singleton, the container retur\", \"ns the singleton instance. If this is the first time the type is called for, the container creates i\", \"t if required, and maintains a reference to it.\\n3. If the type hasn't been registered as a singleton\", \", the container returns a new instance, and doesn't maintain a reference to it.\\n\\nThe following code \", \"example shows how the RequestProvider type that was previously registered with Autofac can be resolv\", \"ed:\\n\\n```\\nvar requestProvider = _container.Resolve<IRequestProvider>();\\n```\\n\\nIn this example, Autofac\", \" is asked to resolve the concrete type for the IRequestProvider type, along with any dependencies. T\", \"ypically, the Resolve method is called when an instance of a specific type is required. For informat\", \"ion about controlling the lifetime of resolved objects, see Managing the lifetime of resolved object\", \"s.\\n\\nThe following code example shows how the eShopOnContainers mobile app instantiates view model ty\", \"pes and their dependencies:\\n\\n```\\nvar viewModel = _container.Resolve(viewModelType);\\n```\\n\\nIn this exa\", \"mple, Autofac is asked to resolve the view model type for a requested view model, and the container \", \"will also resolve any dependencies. When resolving the ProfileViewModel type, the dependency to reso\", \"lve is an IOrderService object. Therefore, Autofac first constructs an OrderService object and then \", \"passes it to the constructor of the ProfileViewModel class. For more information about how the eShop\", \"OnContainers mobile app constructs view models and associates them to views, see Automatically creat\", \"ing a view model with a view model locator.\\n\\nNote: Registering and resolving types with a container \", \"has a performance cost because of the container's use of reflection for creating each type, especial\", \"ly if dependencies are being reconstructed for each page navigation in the app. If there are many or\", \" deep dependencies, the cost of creation can increase significantly.\\n\\n## Managing the lifetime of re\", \"solved objects\\n\\nAfter registering a type, the default behavior for Autofac is to create a new instan\", \"ce of the registered type each time the type is resolved, or when the dependency mechanism injects i\", \"nstances into other classes. In this scenario, the container doesn't hold a reference to the resolve\", \"d object. However, when registering an instance, the default behavior for Autofac is to manage the l\", \"ifetime of the object as a singleton. Therefore, the instance remains in scope while the container i\", \"s in scope, and is disposed when the container goes out of scope and is garbage collected, or when c\", \"ode explicitly disposes the container.\\n\\nAn Autofac instance scope can be used to specify the singlet\", \"on behavior for an object that Autofac creates from a registered type. Autofac instance scopes manag\", \"e the object lifetimes instantiated by the container. The default instance scope for the RegisterTyp\", \"e method is the InstancePerDependency scope. However, the SingleInstance scope can be used with the \", \"RegisterType method, so that the container creates or returns a singleton instance of a type when ca\", \"lling the Resolve method. The following code example shows how Autofac is instructed to create a sin\", \"gleton instance of the NavigationService class:\\n\\nbuilder.RegisterType&lt;NavigationService&gt;().As&\", \"lt;INavigationService&gt;().SingleInstance();\\n\\nThe first time that the INavigationService interface \", \"is resolved, the container creates a new NavigationService object and maintains a reference to it. O\", \"n any subsequent resolutions of the INavigationService interface, the container returns a reference \", \"to the NavigationService object that was previously created.\\n\\nNote: The SingleInstance scope dispose\", \"s created objects when the container is disposed.\\n\\nAutofac includes additional instance scopes. For \", \"more information, see Instance Scope on readthedocs.io.\\n\\n## Summary\\n\\nDependency injection enables de\", \"coupling of concrete types from the code that depends on these types. It typically uses a container \", \"that holds a list of registrations and mappings between interfaces and abstract types, and the concr\", \"ete types that implement or extend these types.\\n\\nAutofac facilitates building loosely coupled apps, \", \"and provides all of the features commonly found in dependency injection containers, including method\", \"s to register type mappings and object instances, resolve objects, manage object lifetimes, and inje\", \"ct dependent objects into constructors of objects it resolves.\\n\\n## Communicating between loosely cou\", \"pled components\\n\\nThe publish-subscribe pattern is a messaging pattern in which publishers send messa\", \"ges without having knowledge of any receivers, known as subscribers. Similarly, subscribers listen f\", \"or specific messages, without having knowledge of any publishers.\\n\\nEvents in .NET implement the publ\", \"ish-subscribe pattern, and are the most simple and straightforward approach for a communication laye\", \"r between components if loose coupling is not required, such as a control and the page that contains\", \" it. However, the publisher and subscriber lifetimes are coupled by object references to each other,\", \" and the subscriber type must have a reference to the publisher type. This can create memory managem\", \"ent issues, especially when there are short lived objects that subscribe to an event of a static or \", \"long-lived object. If the event handler isn't removed, the subscriber will be kept alive by the refe\", \"rence to it in the publisher, and this will prevent or delay the garbage collection of the subscribe\", \"r.\\n\\n## Introduction to MessagingCenter\\n\\nThe Xamarin.Forms MessagingCenter class implements the publi\", \"sh-subscribe pattern, allowing message-based communication between components that are inconvenient \", \"to link by object and type references. This mechanism allows publishers and subscribers to communica\", \"te without having a reference to each other, helping to reduce dependencies between components, whil\", \"e also allowing components to be independently developed and tested.\\n\\nThe MessagingCenter class prov\", \"ides multicast publish-subscribe functionality. This means that there can be multiple publishers tha\", \"t publish a single message, and there can be multiple subscribers listening for the same message. Fi\", \"gure 4-1 illustrates this relationship:\\n\\nPublisher\\n\\nPublisher\\n\\nPublisher\\n\\nMessage\\n\\nSubscriber\\n\\nSubsc\", \"riber\\n\\nFigure 4-1: Multicast publish-subscribe functionality\\n\\n<!-- image -->\\n\\nPublishers send messag\", \"es using the MessagingCenter.Send method, while subscribers listen for messages using the MessagingC\", \"enter.Subscribe method. In addition, subscribers can also unsubscribe from message subscriptions, if\", \" required, with the MessagingCenter.Unsubscribe method.\\n\\nInternally, the MessagingCenter class uses \", \"weak references. This means that it will not keep objects alive, and will allow them to be garbage c\", \"ollected. Therefore, it should only be necessary to unsubscribe from a message when a class no longe\", \"r wishes to receive the message.\\n\\nThe eShopOnContainers mobile app uses the MessagingCenter class to\", \" communicate between loosely coupled components. The app defines three messages:\\n\\n- The AddProduct m\", \"essage is published by the CatalogViewModel class when an item is added to the shopping basket. In r\", \"eturn, the BasketViewModel class subscribes to the message and increments the number of items in the\", \" shopping basket in response. In addition, the BasketViewModel class also unsubscribes from this mes\", \"sage.\\n- The Filter message is published by the CatalogViewModel class when the user applies a brand \", \"or type filter to the items displayed from the catalogue. In return, the CatalogView class subscribe\", \"s to the message and updates the UI so that only items that match the filter criteria are displayed.\", \"\\n- The ChangeTab message is published by the MainViewModel class when the CheckoutViewModel navigate\", \"s to the MainViewModel following the successful creation and submission of a new order. In return, t\", \"he MainView class subscribes to the message and updates the UI so that the My profile tab is active,\", \" to show the user's orders.\\n\\nNote: While the MessagingCenter class permits communication between loo\", \"sely-coupled classes, it does not offer the only architectural solution to this issue. For example, \", \"communication between a view model and a view can also be achieved by the binding engine and through\", \" property change notifications. In addition, communication between two view models can also be achie\", \"ved by passing data during navigation.\\n\\nIn the eShopOnContainers mobile app, MessagingCenter is used\", \" to update in the UI in response to an action occurring in another class. Therefore, messages are pu\", \"blished on the UI thread, with subscribers receiving the message on the same thread.\\n\\nTip: Marshal t\", \"o the UI thread when performing UI updates\\n\\nIf a message that's sent from a background thread is req\", \"uired to update the UI, process the message on the UI thread in the subscriber by invoking the Devic\", \"e.BeginInvokeOnMainThread method.\\n\\nFor more information about MessagingCenter , see MessagingCenter \", \"on the Xamarin Developer Center.\\n\\n## Defining a message\\n\\nMessagingCenter messages are strings that a\", \"re used to identify messages. The following code example shows the messages defined within the eShop\", \"OnContainers mobile app:\\n\\n```\\npublic class MessengerKeys { // Add product to basket public const str\", \"ing AddProduct = \\\"AddProduct\\\"; // Filter public const string Filter = \\\"Filter\\\"; // Change selected T\", \"ab programmatically public const string ChangeTab = \\\"ChangeTab\\\"; }\\n```\\n\\nIn this example, messages ar\", \"e defined using constants. The advantage of this approach is that it provides compile-time type safe\", \"ty and refactoring support.\\n\\n## Publishing a message\\n\\nPublishers notify subscribers of a message wit\", \"h one of the MessagingCenter.Send overloads. The following code example demonstrates publishing the \", \"AddProduct message:\\n\\n```\\nMessagingCenter.Send(this, MessengerKeys.AddProduct, catalogItem);\\n```\\n\\nIn \", \"this example, the Send method specifies three arguments:\\n\\n- The first argument specifies the sender \", \"class. The sender class must be specified by any subscribers who wish to receive the message.\\n- The \", \"second argument specifies the message.\\n- The third argument specifies the payload data to be sent to\", \" the subscriber. In this case the payload data is a CatalogItem instance.\\n\\nThe Send method will publ\", \"ish the message, and its payload data, using a fire-and-forget approach. Therefore, the message is s\", \"ent even if there are no subscribers registered to receive the message. In this situation, the sent \", \"message is ignored.\\n\\nNote: The MessagingCenter.Send method can use generic parameters to control how\", \" messages are delivered. Therefore, multiple messages that share a message identity but send differe\", \"nt payload data types can be received by different subscribers.\\n\\n## Subscribing to a message\\n\\nSubscr\", \"ibers can register to receive a message using one of the MessagingCenter.Subscribe overloads. The fo\", \"llowing code example demonstrates how the eShopOnContainers mobile app subscribes to, and processes,\", \" the AddProduct message:\\n\\n```\\nMessagingCenter.Subscribe<CatalogViewModel, CatalogItem>( this, Messag\", \"eKeys.AddProduct, async (sender, arg) => { BadgeCount++; await AddCatalogItemAsync(arg); });\\n```\\n\\nIn\", \" this example, the Subscribe method subscribes to the AddProduct message, and executes a callback de\", \"legate in response to receiving the message. This callback delegate, specified as a lambda expressio\", \"n, executes code that updates the UI.\\n\\nTip: Consider using immutable payload data\\n\\nDon't attempt to \", \"modify the payload data from within a callback delegate because several threads could be accessing t\", \"he received data simultaneously. In this scenario, the payload data should be immutable to avoid con\", \"currency errors.\\n\\nA subscriber might not need to handle every instance of a published message, and t\", \"his can be controlled by the generic type arguments that are specified on the Subscribe method. In t\", \"his example, the subscriber will only receive AddProduct messages that are sent from the CatalogView\", \"Model class, whose payload data is a CatalogItem instance.\\n\\n## Unsubscribing from a message\\n\\nSubscri\", \"bers can unsubscribe from messages they no longer want to receive. This is achieved with one of the \", \"MessagingCenter.Unsubscribe overloads, as demonstrated in the following code example:\\n\\n```\\nMessaging\", \"Center.Unsubscribe<CatalogViewModel, CatalogItem>(this, MessengerKeys.AddProduct);\\n```\\n\\nIn this exam\", \"ple, the Unsubscribe method syntax reflects the type arguments specified when subscribing to receive\", \" the AddProduct message.\\n\\n## Summary\\n\\nThe Xamarin.Forms MessagingCenter class implements the publish\", \"-subscribe pattern, allowing message-based communication between components that are inconvenient to\", \" link by object and type references. This mechanism allows publishers and subscribers to communicate\", \" without having a reference to each other, helping to reduce dependencies between components, while \", \"also allowing components to be independently developed and tested.\\n\\n## Navigation\\n\\nXamarin.Forms inc\", \"ludes support for page navigation, which typically results from the user's interaction with the UI o\", \"r from the app itself as a result of internal logic-driven state changes. However, navigation can be\", \" complex to implement in apps that use the Model-View-ViewModel (MVVM) pattern, as the following cha\", \"llenges must be met:\\n\\n- How to identify the view to be navigated to, using an approach that does not\", \" introduce tight coupling and dependencies between views.\\n- How to coordinate the process by which t\", \"he view to be navigated to is instantiated and initialized. When using MVVM, the view and view model\", \" need to be instantiated and associated with each other via the view's binding context. When an app \", \"is using a dependency injection container, the instantiation of views and view models might require \", \"a specific construction mechanism.\\n- Whether to perform view-first navigation, or view model-first n\", \"avigation. With view-first navigation, the page to navigate to refers to the name of the view type. \", \"During navigation, the specified view is instantiated, along with its corresponding view model and o\", \"ther dependent services. An alternative approach is to use view model-first navigation, where the pa\", \"ge to navigate to refers to the name of the view model type.\\n- How to cleanly separate the navigatio\", \"nal behavior of the app across the views and view models. The MVVM pattern provides a separation bet\", \"ween the app's UI and its presentation and business logic. However, the navigation behavior of an ap\", \"p will often span the UI and presentations parts of the app. The user will often initiate navigation\", \" from a view, and the view will be replaced as a result of the navigation. However, navigation might\", \" often also need to be initiated or coordinated from within the view model.\\n- How to pass parameters\", \" during navigation for initialization purposes. For example, if the user navigates to a view to upda\", \"te order details, the order data will have to be passed to the view so that it can display the corre\", \"ct data.\\n- How to co-ordinate navigation, to ensure that certain business rules are obeyed. For exam\", \"ple, users might be prompted before navigating away from a view so that they can correct any invalid\", \" data or be prompted to submit or discard any data changes that were made within the view.\\n\\nThis cha\", \"pter addresses these challenges by presenting a NavigationService class that's used to perform view \", \"model-first page navigation.\\n\\nNote: The NavigationService used by the app is designed only to perfor\", \"m hierarchical navigation between ContentPage instances. Using the service to navigate between other\", \" page types might result in unexpected behavior.\\n\\n## Navigating between pages\\n\\nNavigation logic can \", \"reside in a view's code-behind, or in a data bound view model. While placing navigation logic in a v\", \"iew might be the simplest approach, it is not easily testable through unit tests. Placing navigation\", \" logic in view model classes means that the logic can be exercised through unit tests. In addition, \", \"the view model can then implement logic to control navigation to ensure that certain business rules \", \"are enforced. For example, an app might not allow the user to navigate away from a page without firs\", \"t ensuring that the entered data is valid.\\n\\nA NavigationService class is typically invoked from view\", \" models, in order to promote testability. However, navigating to views from view models would requir\", \"e the view models to reference views, and particularly views that the active view model isn't associ\", \"ated with, which is not recommended. Therefore, the NavigationService presented here specifies the v\", \"iew model type as the target to navigate to.\\n\\nThe eShopOnContainers mobile app uses the NavigationSe\", \"rvice class to provide view model-first navigation. This class implements the INavigationService int\", \"erface, which is shown in the following code example:\\n\\n```\\npublic interface INavigationService { Vie\", \"wModelBase PreviousPageViewModel { get; } Task InitializeAsync(); Task NavigateToAsync<TViewModel>()\", \" where TViewModel : ViewModelBase; Task NavigateToAsync<TViewModel>(object parameter) where TViewMod\", \"el : ViewModelBase; Task RemoveLastFromBackStackAsync(); Task RemoveBackStackAsync(); }\\n```\\n\\nThis in\", \"terface specifies that an implementing class must provide the following methods:\\n\\n| Method          \", \"              | Purpose                                                                    |\\n|------\", \"-------------------------|--------------------------------------------------------------------------\", \"--|\\n| InitializeAsync               | Performs navigation to one of two pages when the app is launch\", \"ed.          |\\n| NavigateToAsync<T>            | Performs hierarchical navigation to a specified pag\", \"e.                      |\\n| NavigateToAsync<T>(parameter) | Performs hierarchical navigation to a sp\", \"ecified page, passing a parameter. |\\n| RemoveLastFromBackStackAsync  | Removes the previous page fro\", \"m the navigation stack.                       |\\n| RemoveBackStackAsync          | Removes all the pr\", \"evious pages from the navigation stack.                  |\\n\\nIn addition, the INavigationService inte\", \"rface specifies that an implementing class must provide a PreviousPageViewModel property. This prope\", \"rty returns the view model type associated with the previous page in the navigation stack.\\n\\nNote: An\", \" INavigationService interface would usually also specify a GoBackAsync method, which is used to prog\", \"rammatically return to the previous page in the navigation stack. However, this method is missing fr\", \"om the eShopOnContainers mobile app because it's not required.\\n\\n## Creating the NavigationService in\", \"stance\\n\\nThe NavigationService class, which implements the INavigationService interface, is registere\", \"d as a singleton with the Autofac dependency injection container, as demonstrated in the following c\", \"ode example:\\n\\n```\\nbuilder.RegisterType<NavigationService>().As<INavigationService>().SingleInstance(\", \");\\n```\\n\\nThe INavigationService interface is resolved in the ViewModelBase class constructor, as demo\", \"nstrated in the following code example:\\n\\n```\\nNavigationService = ViewModelLocator.Resolve<INavigatio\", \"nService>();\\n```\\n\\nThis returns a reference to the NavigationService object that's stored in the Auto\", \"fac dependency injection container, which is created by the InitNavigation method in the App class. \", \"For more information, see Navigating when the app is launched.\\n\\nThe ViewModelBase class stores the N\", \"avigationService instance in a NavigationService property, of type INavigationService . Therefore, a\", \"ll view model classes, which derive from the ViewModelBase class, can use the NavigationService prop\", \"erty to access the methods specified by the INavigationService interface. This avoids the overhead o\", \"f injecting the NavigationService object from the Autofac dependency injection container into each v\", \"iew model class.\\n\\n## Handling navigation requests\\n\\nXamarin.Forms provides the NavigationPage class, \", \"which implements a hierarchical navigation experience in which the user is able to navigate through \", \"pages, forwards and backwards, as desired. For more information about hierarchical navigation, see H\", \"ierarchical Navigation on the Xamarin Developer Center.\\n\\nRather than use the NavigationPage class di\", \"rectly, the eShopOnContainers app wraps the NavigationPage class in the CustomNavigationView class, \", \"as shown in the following code example:\\n\\n```\\npublic partial class CustomNavigationView : NavigationP\", \"age { public CustomNavigationView() : base() { InitializeComponent(); } public CustomNavigationView(\", \"Page root) : base(root) { InitializeComponent(); } }\\n```\\n\\nThe purpose of this wrapping is for ease o\", \"f styling the NavigationPage instance inside the XAML file for the class.\\n\\nNavigation is performed i\", \"nside view model classes by invoking one of the NavigateToAsync methods, specifying the view model t\", \"ype for the page being navigated to, as demonstrated in the following code example:\\n\\n```\\nawait Navig\", \"ationService.NavigateToAsync<MainViewModel>();\\n```\\n\\nThe following code example shows the NavigateToA\", \"sync methods provided by the NavigationService class:\\n\\n```\\npublic Task NavigateToAsync<TViewModel>()\", \" where TViewModel : ViewModelBase { return InternalNavigateToAsync(typeof(TViewModel), null); } publ\", \"ic Task NavigateToAsync<TViewModel>(object parameter) where TViewModel : ViewModelBase { return Inte\", \"rnalNavigateToAsync(typeof(TViewModel), parameter); }\\n```\\n\\nEach method allows any view model class t\", \"hat derives from the ViewModelBase class to perform hierarchical navigation by invoking the Internal\", \"NavigateToAsync method. In addition, the second NavigateToAsync method enables navigation data to be\", \" specified as an argument that's passed to the view model being navigated to, where it's typically u\", \"sed to perform initialization. For more information, see Passing parameters during navigation.\\n\\nThe \", \"InternalNavigateToAsync method executes the navigation request, and is shown in the following code e\", \"xample:\\n\\n```\\nprivate async Task InternalNavigateToAsync(Type viewModelType, object parameter) { Page\", \" page = CreatePage(viewModelType, parameter); if (page is LoginView) { Application.Current.MainPage \", \"= new CustomNavigationView(page); } else { var navigationPage = Application.Current.MainPage as Cust\", \"omNavigationView; if (navigationPage != null) { await navigationPage.PushAsync(page); } else { Appli\", \"cation.Current.MainPage = new CustomNavigationView(page); } } await (page.BindingContext as ViewMode\", \"lBase).InitializeAsync(parameter); } private Type GetPageTypeForViewModel(Type viewModelType) { var \", \"viewName = viewModelType.FullName.Replace(\\\"Model\\\", string.Empty); var viewModelAssemblyName = viewMo\", \"delType.GetTypeInfo().Assembly.FullName; var viewAssemblyName = string.Format( CultureInfo.Invariant\", \"Culture, \\\"{0}, {1}\\\", viewName, viewModelAssemblyName); var viewType = Type.GetType(viewAssemblyName)\", \"; return viewType; } private Page CreatePage(Type viewModelType, object parameter) { Type pageType =\", \" GetPageTypeForViewModel(viewModelType); if (pageType == null) { throw new Exception($\\\"Cannot locate\", \" page type for {viewModelType}\\\"); }\\n```\\n\\n```\\nPage page = Activator.CreateInstance(pageType) as Page;\", \" return page; }\\n```\\n\\nThe InternalNavigateToAsync method performs navigation to a view model by first\", \" calling the CreatePage method. This method locates the view that corresponds to the specified view \", \"model type, and creates and returns an instance of this view type. Locating the view that correspond\", \"s to the view model type uses a convention-based approach, which assumes that:\\n\\n- Views are in the s\", \"ame assembly as view model types.\\n- Views are in a .Views child namespace.\\n- View models are in a .V\", \"iewModels child namespace.\\n- View names correspond to view model names, with \\\"Model\\\" removed.\\n\\nWhen \", \"a view is instantiated, it's associated with its corresponding view model. For more information abou\", \"t how this occurs, see Automatically creating a view model with a view model locator.\\n\\nIf the view b\", \"eing created is a LoginView , it's wrapped inside a new instance of the CustomNavigationView class a\", \"nd assigned to the Application.Current.MainPage property. Otherwise, the CustomNavigationView instan\", \"ce is retrieved, and provided that it isn't null , the PushAsync method is invoked to push the view \", \"being created onto the navigation stack. However, If the retrieved CustomNavigationView instance is \", \"null , the view being created is wrapped inside a new instance of the CustomNavigationView class and\", \" assigned to the\\n\\nApplication.Current.MainPage property. This mechanism ensures that during navigati\", \"on, pages are added correctly to the navigation stack both when it's empty, and when it contains dat\", \"a.\\n\\nTip: Consider caching pages\\n\\nPage caching results in memory consumption for views that are not c\", \"urrently displayed. However, without page caching it does mean that XAML parsing and construction of\", \" the page and its view model will occur every time a new page is navigated to, which can have a perf\", \"ormance impact for a complex page. For a well-designed page that does not use an excessive number of\", \" controls, the performance should be sufficient. However, page caching might help if slow page loadi\", \"ng times are encountered.\\n\\nAfter the view is created and navigated to, the InitializeAsync method of\", \" the view's associated view model is executed. For more information, see Passing parameters during n\", \"avigation.\\n\\n## Navigating when the app is launched\\n\\nWhen the app is launched, the InitNavigation met\", \"hod in the App class is invoked. The following code example shows this method:\\n\\n```\\nprivate Task Ini\", \"tNavigation() { var navigationService = ViewModelLocator.Resolve<INavigationService>(); return navig\", \"ationService.InitializeAsync(); }\\n```\\n\\nThe method creates a new NavigationService object in the Auto\", \"fac dependency injection container, and returns a reference to it, before invoking its InitializeAsy\", \"nc method.\\n\\nNote: When the INavigationService interface is resolved by the ViewModelBase class, the \", \"container returns a reference to the NavigationService object that was created when the InitNavigati\", \"on method is invoked.\\n\\nThe following code example shows the NavigationService InitializeAsync method\", \":\\n\\n```\\npublic Task InitializeAsync() { if (string.IsNullOrEmpty(Settings.AuthAccessToken)) return Na\", \"vigateToAsync<LoginViewModel>(); else return NavigateToAsync<MainViewModel>(); }\\n```\\n\\nThe MainView i\", \"s navigated to if the app has a cached access token, which is used for authentication. Otherwise, th\", \"e LoginView is navigated to.\\n\\nFor more information about the Autofac dependency injection container,\", \" see Introduction to dependency injection.\\n\\n## Passing parameters during navigation\\n\\nOne of the Navi\", \"gateToAsync methods, specified by the INavigationService interface, enables navigation data to be sp\", \"ecified as an argument that's passed to the view model being navigated to, where it's typically used\", \" to perform initialization.\\n\\nFor example, the ProfileViewModel class contains an OrderDetailCommand \", \"that's executed when the user selects an order on the ProfileView page. In turn, this executes the O\", \"rderDetailAsync method, which is shown in the following code example:\\n\\n```\\nprivate async Task OrderD\", \"etailAsync(Order order) { await NavigationService.NavigateToAsync<OrderDetailViewModel>(order); }\\n``\", \"`\\n\\nThis method invokes navigation to the OrderDetailViewModel , passing an Order instance that repre\", \"sents the order that the user selected on the ProfileView page. When the NavigationService class cre\", \"ates the OrderDetailView , the OrderDetailViewModel class is instantiated and assigned to the view's\", \" BindingContext . After navigating to the OrderDetailView , the InternalNavigateToAsync method execu\", \"tes the InitializeAsync method of the view's associated view model.\\n\\nThe InitializeAsync method is d\", \"efined in the ViewModelBase class as a method that can be overridden. This method specifies an objec\", \"t argument that represents the data to be passed to a view model during a navigation operation. Ther\", \"efore, view model classes that want to receive data from a navigation operation provide their own im\", \"plementation of the InitializeAsync method to perform the required initialization. The following cod\", \"e example shows the InitializeAsync method from the OrderDetailViewModel class:\\n\\n```\\npublic override\", \" async Task InitializeAsync(object navigationData) { if (navigationData is Order) { ... Order = awai\", \"t _ordersService.GetOrderAsync( Convert.ToInt32(order.OrderNumber), authToken);\\n```\\n\\n```\\n... } }\\n```\", \"\\n\\nThis method retrieves the Order instance that was passed into the view model during the navigation\", \" operation, and uses it to retrieve the full order details from the OrderService instance.\\n\\n## Invok\", \"ing navigation using behaviors\\n\\nNavigation is usually triggered from a view by a user interaction. F\", \"or example, the LoginView performs navigation following successful authentication. The following cod\", \"e example shows how the navigation is invoked by a behavior:\\n\\n```\\n<WebView ...> <WebView.Behaviors> \", \"<behaviors:EventToCommandBehavior EventName=\\\"Navigating\\\" EventArgsConverter=\\\"{StaticResource WebNavi\", \"gatingEventArgsConverter}\\\" Command=\\\"{Binding NavigateCommand}\\\" /> </WebView.Behaviors> </WebView>\\n``\", \"`\\n\\nAt runtime, the EventToCommandBehavior will respond to interaction with the WebView . When the We\", \"bView navigates to a web page, the Navigating event will fire, which will execute the NavigateComman\", \"d in the LoginViewModel . By default, the event arguments for the event are passed to the command. T\", \"his data is converted as it's passed between source and target by the converter specified in the Eve\", \"ntArgsConverter property, which returns the Url from the WebNavigatingEventArgs . Therefore, when th\", \"e NavigationCommand is executed, the Url of the web page is passed as a parameter to the registered \", \"Action .\\n\\nIn turn, the NavigationCommand executes the NavigateAsync method, which is shown in the fo\", \"llowing code example:\\n\\n```\\nprivate async Task NavigateAsync(string url) { ... await NavigationServic\", \"e.NavigateToAsync<MainViewModel>(); await NavigationService.RemoveLastFromBackStackAsync(); ... }\\n``\", \"`\\n\\nThis method invokes navigation to the MainViewModel , and following navigation, removes the Login\", \"View page from the navigation stack.\\n\\n## Confirming or cancelling navigation\\n\\nAn app might need to i\", \"nteract with the user during a navigation operation, so that the user can confirm or cancel navigati\", \"on. This might be necessary, for example, when the user attempts to navigate before having fully com\", \"pleted a data entry page. In this situation, an app should provide a notification that allows the us\", \"er to navigate away from the page, or to cancel the navigation operation before it occurs. This can \", \"be achieved in a view model class by using the response from a notification to control whether or no\", \"t navigation is invoked.\\n\\n## Summary\\n\\nXamarin.Forms includes support for page navigation, which typi\", \"cally results from the user's interaction with the UI, or from the app itself, as a result of intern\", \"al logic-driven state changes. However, navigation can be complex to implement in apps that use the \", \"MVVM pattern.\\n\\nThis chapter presented a NavigationService class, which is used to perform view model\", \"-first navigation from view models. Placing navigation logic in view model classes means that the lo\", \"gic can be exercised through automated tests. In addition, the view model can then implement logic t\", \"o control navigation to ensure that certain business rules are enforced.\\n\\nhe app.\\n\\nEntry gets errors\", \" to display\\n\\nsets properties\\n\\nIValidity\\n\\n## Validation\\n\\nadds\\n\\nAny app that accepts input from users \", \"should ensure that the input is valid. An app could, for example, check for input that contains only\", \" characters in a particular range, is of a certain length, or matches a particular format. Without v\", \"alidation, a user can supply data that causes the app to fail. Validation enforces business rules, a\", \"nd prevents an attacker from injecting malicious data.\\n\\nIn the context of the Model-ViewModel-Model \", \"(MVVM) pattern, a view model or model will often be required to perform data validation and signal a\", \"ny validation errors to the view so that the user can correct them. The eShopOnContainers mobile app\", \" performs synchronous client-side validation of view model properties and notifies the user of any v\", \"alidation errors by highlighting the control that contains the invalid data, and by displaying error\", \" messages that inform the user of why the data is invalid. Figure 6-1 shows the classes involved in \", \"performing validation in the eShopOnContainers mobile app.\\n\\nFigure 6-1 : Validation classes in the e\", \"ShopOnContainers mobile app\\n\\n<!-- image -->\\n\\nView model properties that require validation are of ty\", \"pe ValidatableObject&lt;T&gt; , and each ValidatableObject&lt;T&gt; instance has validation rules ad\", \"ded to its Validations property. Validation is invoked from the view model by calling the Validate m\", \"ethod of the ValidatableObject&lt;T&gt;\\n\\nINotifyPropertyChanged\\n\\n<!-- image -->\\n\\ninstance, which ret\", \"rieves the validation rules and executes them against the ValidatableObject&lt;T&gt; Value property.\", \" Any validation errors are placed into the Errors property of the ValidatableObject&lt;T&gt; instanc\", \"e, and the IsValid property of the ValidatableObject&lt;T&gt; instance is updated to indicate whethe\", \"r validation succeeded or failed.\\n\\nProperty change notification is provided by the ExtendedBindableO\", \"bject class, and so an Entry control can bind to the IsValid property of ValidatableObject&lt;T&gt; \", \"instance in the view model class to be notified of whether or not the entered data is valid.\\n\\n## Spe\", \"cifying validation rules\\n\\nValidation rules are specified by creating a class that derives from the I\", \"ValidationRule&lt;T&gt; interface, which is shown in the following code example:\\n\\n```\\npublic interfa\", \"ce IValidationRule<T> { string ValidationMessage { get; set; } bool Check(T value); }\\n```\\n\\nThis inte\", \"rface specifies that a validation rule class must provide a boolean Check method that is used to per\", \"form the required validation, and a ValidationMessage property whose value is the validation error m\", \"essage that will be displayed if validation fails.\\n\\nThe following code example shows the IsNotNullOr\", \"EmptyRule&lt;T&gt; validation rule, which is used to perform validation of the username and password\", \" entered by the user on the LoginView when using mock services in the eShopOnContainers mobile app:\\n\", \"\\n```\\npublic class IsNotNullOrEmptyRule<T> : IValidationRule<T> { public string ValidationMessage { g\", \"et; set; } public bool Check(T value) { if (value == null) { return false; } var str = value as stri\", \"ng; return !string.IsNullOrWhiteSpace(str); } }\\n```\\n\\nThe Check method returns a boolean indicating w\", \"hether the value argument is null , empty, or consists only of whitespace characters.\\n\\nAlthough not \", \"used by the eShopOnContainers mobile app, the following code example shows a validation rule for val\", \"idating email addresses:\\n\\n```\\npublic class EmailRule<T> : IValidationRule<T> { public string Validat\", \"ionMessage { get; set; } public bool Check(T value) { if (value == null)\\n```\\n\\n```\\n{ return false; } \", \"var str = value as string; Regex regex = new Regex(@\\\"^([\\\\w\\\\.\\\\-]+)@([\\\\w\\\\-]+)((\\\\.(\\\\w){2,3})+)$\\\"); Matc\", \"h match = regex.Match(str); return match.Success; } }\\n```\\n\\nThe Check method returns a boolean indica\", \"ting whether or not the value argument is a valid email address. This is achieved by searching the v\", \"alue argument for the first occurrence of the regular expression pattern specified in the Regex cons\", \"tructor. Whether the regular expression pattern has been found in the input string can be determined\", \" by checking the value of the Match object's Success property.\\n\\nNote: Property validation can someti\", \"mes involve dependent properties. An example of dependent properties is when the set of valid values\", \" for property A depends on the particular value that has been set in property B. To check that the v\", \"alue of property A is one of the allowed values would involve retrieving the value of property B. In\", \" addition, when the value of property B changes, property A would need to be revalidated.\\n\\n## Adding\", \" validation rules to a property\\n\\nIn the eShopOnContainers mobile app, view model properties that req\", \"uire validation are declared to be of type ValidatableObject&lt;T&gt;, where T is the type of the da\", \"ta to be validated. The following code example shows an example of two such properties:\\n\\n```\\npublic \", \"ValidatableObject<string> UserName { get { return _userName; } set { _userName = value; RaisePropert\", \"yChanged(() => UserName); } } public ValidatableObject<string> Password { get { return _password; } \", \"set { _password = value; RaisePropertyChanged(() => Password); } }\\n```\\n\\nFor validation to occur, val\", \"idation rules must be added to the Validations collection of each ValidatableObject&lt;T&gt; instanc\", \"e, as demonstrated in the following code example:\\n\\n```\\nprivate void AddValidations() { _userName.Val\", \"idations.Add(new IsNotNullOrEmptyRule<string> { ValidationMessage = \\\"A username is required.\\\" }); _p\", \"assword.Validations.Add(new IsNotNullOrEmptyRule<string> { ValidationMessage = \\\"A password is requir\", \"ed.\\\" }); }\\n```\\n\\nThis method adds the IsNotNullOrEmptyRule&lt;T&gt; validation rule to the Validation\", \"s collection of each ValidatableObject&lt;T&gt; instance, specifying values for the validation rule'\", \"s ValidationMessage property, which specifies the validation error message that will be displayed if\", \" validation fails.\\n\\n## Triggering validation\\n\\nThe validation approach used in the eShopOnContainers \", \"mobile app can manually trigger validation of a property, and automatically trigger validation when \", \"a property changes.\\n\\n## Triggering validation manually\\n\\nValidation can be triggered manually for a v\", \"iew model property. For example, this occurs in the eShopOnContainers mobile app when the user taps \", \"the Login button on the LoginView , when using mock services. The command delegate calls the MockSig\", \"nInAsync method in the LoginViewModel , which invokes validation by executing the Validate method, w\", \"hich is shown in the following code example:\\n\\n```\\nprivate bool Validate() { bool isValidUser = Valid\", \"ateUserName(); bool isValidPassword = ValidatePassword(); return isValidUser && isValidPassword; } p\", \"rivate bool ValidateUserName() { return _userName.Validate(); } private bool ValidatePassword() { re\", \"turn _password.Validate(); }\\n```\\n\\nThe Validate method performs validation of the username and passwo\", \"rd entered by the user on the LoginView , by invoking the Validate method on each ValidatableObject&\", \"lt;T&gt; instance. The following code example shows the Validate method from the ValidatableObject&l\", \"t;T&gt; class:\\n\\n```\\npublic bool Validate() { Errors.Clear(); IEnumerable<string> errors = _validatio\", \"ns .Where(v => !v.Check(Value)) .Select(v => v.ValidationMessage);\\n```\\n\\n```\\nErrors = errors.ToList()\", \"; IsValid = !Errors.Any(); return this.IsValid; }\\n```\\n\\nThis method clears the Errors collection, and\", \" then retrieves any validation rules that were added to the object's Validations collection. The Che\", \"ck method for each retrieved validation rule is executed, and the ValidationMessage property value f\", \"or any validation rule that fails to validate the data is added to the Errors collection of the Vali\", \"datableObject&lt;T&gt; instance. Finally, the IsValid property is set, and its value is returned to \", \"the calling method, indicating whether validation succeeded or failed.\\n\\n## Triggering validation whe\", \"n properties change\\n\\nValidation is also automatically triggered whenever a bound property changes. F\", \"or example, when a two-way binding in the LoginView sets the UserName or Password property, validati\", \"on is triggered. The following code example demonstrates how this occurs:\\n\\n```\\n<Entry Text=\\\"{Binding\", \" UserName.Value, Mode=TwoWay}\\\"> <Entry.Behaviors> <behaviors:EventToCommandBehavior EventName=\\\"TextC\", \"hanged\\\" Command=\\\"{Binding ValidateUserNameCommand}\\\" /> </Entry.Behaviors> ... </Entry>\\n```\\n\\nThe Entr\", \"y control binds to the UserName.Value property of the ValidatableObject&lt;T&gt; instance, and the c\", \"ontrol's Behaviors collection has an EventToCommandBehavior instance added to it. This behavior exec\", \"utes the ValidateUserNameCommand in response to the TextChanged event firing on the Entry, which is \", \"raised when the text in the Entry changes. In turn, the\\n\\nValidateUserNameCommand delegate executes t\", \"he ValidateUserName method, which executes the Validate method on the ValidatableObject&lt;T&gt; ins\", \"tance. Therefore, every time the user enters a character in the Entry control for the username, vali\", \"dation of the entered data is performed.\\n\\nFor more information about behaviors, see Implementing beh\", \"aviors.\\n\\n## Displaying validation errors\\n\\nThe eShopOnContainers mobile app notifies the user of any \", \"validation errors by highlighting the control that contains the invalid data with a red line, and by\", \" displaying an error message that informs the user why the data is invalid below the control contain\", \"ing the invalid data. When the invalid data is corrected, the line changes to black and the error me\", \"ssage is removed. Figure 6-2 shows the LoginView in the eShopOnContainers mobile app when validation\", \" errors are present.\\n\\nUser name or email\\n\\n```\\nA username is required. Password A password is require\", \"d.\\n```\\n\\nFigure 6-2: Displaying validation errors during login\\n\\n## Highlighting a control that contai\", \"ns invalid data\\n\\nThe LineColorBehavior attached behavior is used to highlight Entry controls where v\", \"alidation errors have occurred. The following code example shows how the LineColorBehavior attached \", \"behavior is attached to an Entry control:\\n\\n```\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\"> \", \"<Entry.Style> <OnPlatform x:TypeArguments=\\\"Style\\\" iOS=\\\"{StaticResource EntryStyle}\\\" Android=\\\"{Static\", \"Resource EntryStyle}\\\" WinPhone=\\\"{StaticResource UwpEntryStyle}\\\"/> </Entry.Style> ... </Entry>\\n```\\n\\nT\", \"he Entry control consumes an explicit style, which is shown in the following code example:\\n\\n```\\n<Sty\", \"le x:Key=\\\"EntryStyle\\\" TargetType=\\\"{x:Type Entry}\\\"> ... <Setter Property=\\\"behaviors:LineColorBehavior\", \".ApplyLineColor\\\" Value=\\\"True\\\" /> <Setter Property=\\\"behaviors:LineColorBehavior.LineColor\\\" Value=\\\"{St\", \"aticResource BlackColor}\\\" /> ... </Style>\\n```\\n\\nThis style sets the ApplyLineColor and LineColor atta\", \"ched properties of the LineColorBehavior attached behavior on the Entry control. For more informatio\", \"n about styles, see Styles on the Xamarin Developer Center.\\n\\nWhen the value of the ApplyLineColor at\", \"tached property is set, or changes, the LineColorBehavior attached behavior executes the OnApplyLine\", \"ColorChanged method, which is shown in the following code example:\\n\\n```\\npublic static class LineColo\", \"rBehavior { ... private static void OnApplyLineColorChanged( BindableObject bindable, object oldValu\", \"e, object newValue) { var view = bindable as View; if (view == null) { return; } bool hasLine = (boo\", \"l)newValue; if (hasLine) { view.Effects.Add(new EntryLineColorEffect()); } else { var entryLineColor\", \"EffectToRemove = view.Effects.FirstOrDefault(e => e is EntryLineColorEffect); if (entryLineColorEffe\", \"ctToRemove != null) { view.Effects.Remove(entryLineColorEffectToRemove); } } } }\\n```\\n\\nThe parameters\", \" for this method provide the instance of the control that the behavior is attached to, and the old a\", \"nd new values of the ApplyLineColor attached property. The EntryLineColorEffect class is added to th\", \"e control's Effects collection if the ApplyLineColor attached property is true , otherwise it's remo\", \"ved from the control's Effects collection. For more information about behaviors, see Implementing be\", \"haviors.\\n\\nThe EntryLineColorEffect subclasses the RoutingEffect class, and is shown in the following\", \" code example:\\n\\n```\\npublic class EntryLineColorEffect : RoutingEffect { public EntryLineColorEffect(\", \") : base(\\\"eShopOnContainers.EntryLineColorEffect\\\") { } }\\n```\\n\\nThe RoutingEffect class represents a p\", \"latform-independent effect that wraps an inner effect that's platform-specific. This simplifies the \", \"effect removal process, since there is no compile-time access to the type information for a platform\", \"-specific effect. The EntryLineColorEffect calls the base class constructor, passing in a parameter \", \"consisting of a concatenation of the resolution group name, and the unique ID that's specified on ea\", \"ch platform-specific effect class.\\n\\nThe following code example shows the eShopOnContainers.EntryLine\", \"ColorEffect implementation for iOS:\\n\\n```\\n[assembly: ResolutionGroupName(\\\"eShopOnContainers\\\")] [assem\", \"bly: ExportEffect(typeof(EntryLineColorEffect), \\\"EntryLineColorEffect\\\")] namespace eShopOnContainers\", \".iOS.Effects { public class EntryLineColorEffect : PlatformEffect\\n```\\n\\n```\\n{ UITextField control; pr\", \"otected override void OnAttached() { try { control = Control as UITextField; UpdateLineColor(); } ca\", \"tch (Exception ex) { Console.WriteLine(\\\"Can't set property on attached control. Error: \\\", ex.Message\", \"); } } protected override void OnDetached() { control = null; } protected override void OnElementPro\", \"pertyChanged(PropertyChangedEventArgs args) { base.OnElementPropertyChanged(args); if (args.Property\", \"Name == LineColorBehavior.LineColorProperty.PropertyName || args.PropertyName == \\\"Height\\\") { Initial\", \"ize(); UpdateLineColor(); } } private void Initialize() { var entry = Element as Entry; if (entry !=\", \" null) { Control.Bounds = new CGRect(0, 0, entry.Width, entry.Height); } } private void UpdateLineCo\", \"lor() { BorderLineLayer lineLayer = control.Layer.Sublayers.OfType<BorderLineLayer>() .FirstOrDefaul\", \"t(); if (lineLayer == null) { lineLayer = new BorderLineLayer(); lineLayer.MasksToBounds = true; lin\", \"eLayer.BorderWidth = 1.0f; control.Layer.AddSublayer(lineLayer); control.BorderStyle = UITextBorderS\", \"tyle.None; } lineLayer.Frame = new CGRect(0f, Control.Frame.Height-1f, Control.Bounds.Width, 1f); li\", \"neLayer.BorderColor = LineColorBehavior.GetLineColor(Element).ToCGColor(); control.TintColor = contr\", \"ol.TextColor; } private class BorderLineLayer : CALayer { }\\n```\\n\\nto inalcate thal there is no valida\", \"tion error. rigure o-s snows an example or tnis.\\n\\nUser name or email\\n\\nUser name or email johndoe\\n\\n``\", \"`\\n} }\\n```\\n\\nThe OnAttached method retrieves the native control for the Xamarin.Forms Entry control, a\", \"nd updates the line color by calling the UpdateLineColor method. The OnElementPropertyChanged overri\", \"de responds to bindable property changes on the Entry control by updating the line color if the atta\", \"ched LineColor property changes, or the Height property of the Entry changes. For more information a\", \"bout effects, see Effects on the Xamarin Developer Center.\\n\\nWhen valid data is entered in the Entry \", \"control, it will apply a black line to the bottom of the control, to indicate that there is no valid\", \"ation error. Figure 6-3 shows an example of this.\\n\\nFigure 6-3 : Black line indicating no validation \", \"error\\n\\nThe Entry control also has a DataTrigger added to its Triggers collection. The following code\", \" example shows the DataTrigger :\\n\\n```\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\"> ... <Entr\", \"y.Triggers> <DataTrigger TargetType=\\\"Entry\\\" Binding=\\\"{Binding UserName.IsValid}\\\" Value=\\\"False\\\"> <Set\", \"ter Property=\\\"behaviors:LineColorBehavior.LineColor\\\" Value=\\\"{StaticResource ErrorColor}\\\" /> </DataTr\", \"igger> </Entry.Triggers> </Entry>\\n```\\n\\nThis DataTrigger monitors the UserName.IsValid property, and \", \"if it's value becomes false , it executes the Setter , which changes the LineColor attached property\", \" of the LineColorBehavior attached behavior to red. Figure 6-4 shows an example of this.\\n\\nFigure 6-4\", \" : Red line indicating validation error\\n\\nThe line in the Entry control will remain red while the ent\", \"ered data is invalid, otherwise it will change to black to indicate that the entered data is valid.\\n\", \"\\nFor more information about Triggers, see Triggers on the Xamarin Developer Center.\\n\\n## Displaying e\", \"rror messages\\n\\nThe UI displays validation error messages in Label controls below each control whose \", \"data failed validation. The following code example shows the Label that displays a validation error \", \"message if the user has not entered a valid username:\\n\\n&lt;Label Text=\\\"{Binding UserName.Errors, Con\", \"verter={StaticResource FirstValidationErrorConverter}\\\" Style=\\\"{StaticResource ValidationErrorLabelSt\", \"yle}\\\" /&gt;\\n\\nEach Label binds to the Errors property of the view model object that's being validated\", \". The Errors property is provided by the ValidatableObject&lt;T&gt; class, and is of type List&lt;st\", \"ring&gt;. Because the Errors property can contain multiple validation errors, the FirstValidationErr\", \"orConverter instance is used to retrieve the first error from the collection for display.\\n\\n## Summar\", \"y\\n\\nThe eShopOnContainers mobile app performs synchronous client-side validation of view model proper\", \"ties and notifies the user of any validation errors by highlighting the control that contains the in\", \"valid data, and by displaying error messages that inform the user why the data is invalid.\\n\\nView mod\", \"el properties that require validation are of type ValidatableObject&lt;T&gt; , and each ValidatableO\", \"bject&lt;T&gt; instance has validation rules added to its Validations property. Validation is invoke\", \"d from the view model by calling the Validate method of the ValidatableObject&lt;T&gt; instance, whi\", \"ch retrieves the validation rules and executes them against the ValidatableObject&lt;T&gt; Value pro\", \"perty. Any validation errors are placed into the Errors property of the ValidatableObject&lt;T&gt; i\", \"nstance, and the IsValid property of the ValidatableObject&lt;T&gt; instance is updated to indicate \", \"whether validation succeeded or failed.\\n\\n## Configuration management\\n\\nSettings allow the separation \", \"of data that configures the behavior of an app from the code, allowing the behavior to be changed wi\", \"thout rebuilding the app. There are two types of settings: app settings, and user settings.\\n\\nApp set\", \"tings are data that an app creates and manages. It can include data such as fixed web service endpoi\", \"nts, API keys, and runtime state. App settings are tied to the existence of the app and are only mea\", \"ningful to that app.\\n\\nUser settings are the customizable settings of an app that affect the behavior\", \" of the app and don't require frequent re-adjustment. For example, an app might let the user specify\", \" where to retrieve data from, and how to display it on the screen.\\n\\nXamarin.Forms includes a persist\", \"ent dictionary that can be used to store settings data. This dictionary can be accessed using the Ap\", \"plication.Current.Properties property, and any data that's placed into it is saved when the app goes\", \" into a sleep state, and is restored when the app resumes or starts up again. In addition, the Appli\", \"cation class also has a SavePropertiesAsync method that allows an app to have its settings saved whe\", \"n required. For more information about this dictionary, see Properties Dictionary on the Xamarin Dev\", \"eloper Center.\\n\\nA downside to storing data using the Xamarin.Forms persistent dictionary is that it'\", \"s not easily data bound to. Therefore, the eShopOnContainers mobile app uses the Xam.Plugins.Setting\", \"s library, available from NuGet. This library provides a consistent, type-safe, cross-platform appro\", \"ach for persisting and retrieving app and user settings, while using the native settings management \", \"provided by each platform. In addition, it's straightforward to use data binding to access settings \", \"data exposed by the library.\\n\\nNote: While the Xam.Plugin.Settings library can store both app and use\", \"r settings, it makes no distinction between the two.\\n\\n## Creating a settings class\\n\\nWhen using the X\", \"am.Plugins.Settings library, a single static class should be created that will contain the app and u\", \"ser settings required by the app. The following code example shows the Settings class in the eShopOn\", \"Containers mobile app:\\n\\n```\\npublic static class Settings { private static ISettings AppSettings { ge\", \"t { return CrossSettings.Current; } } ... }\\n```\\n\\nSettings can be read and written through the ISetti\", \"ngs API, which is provided by the Xam.Plugins.Settings library. This library provides a singleton th\", \"at can be used to access the API, CrossSettings.Current , and an app's settings class should expose \", \"this singleton via an ISettings property.\\n\\nNote: Using directives for the Plugin.Settings and Plugin\", \".Settings.Abstractions namespaces should be added to a class that requires access to the Xam.Plugins\", \".Settings library types.\\n\\n## Adding a setting\\n\\nEach setting consists of a key, a default value, and \", \"a property. The following code example shows all three items for a user setting that represents the \", \"base URL for the online services that the eShopOnContainers mobile app connects to:\\n\\n```\\npublic stat\", \"ic class Settings { ... private const string IdUrlBase = \\\"url_base\\\"; private static readonly string \", \"UrlBaseDefault = GlobalSetting.Instance.BaseEndpoint; ... public static string UrlBase { get { retur\", \"n AppSettings.GetValueOrDefault<string>(IdUrlBase, UrlBaseDefault); } set { AppSettings.AddOrUpdateV\", \"alue<string>(IdUrlBase, value); } } }\\n```\\n\\nThe key is always a const string that defines the key nam\", \"e, with the default value for the setting being a static readonly value of the required type. Provid\", \"ing a default value ensures that a valid value is available if an unset setting is retrieved.\\n\\nThe U\", \"rlBase static property uses two methods from the ISettings API to read or write the setting value. T\", \"he ISettings.GetValueOrDefault method is used to retrieve a setting's value from platform-specific s\", \"torage. If no value is defined for the setting, its default value is retrieved instead. Similarly, t\", \"he ISettings.AddOrUpdateValue method is used to persist a setting's value to platformspecific storag\", \"e.\\n\\nRather that define a default value inside the Settings class, the UrlBaseDefault string obtains \", \"its value from the GlobalSetting class. The following code example shows the BaseEndpoint property a\", \"nd UpdateEndpoint method in this class:\\n\\n```\\npublic class GlobalSetting { ... public string BaseEndp\", \"oint { get { return _baseEndpoint; } set { _baseEndpoint = value; UpdateEndpoint(_baseEndpoint); } }\", \" ... private void UpdateEndpoint(string baseEndpoint) { RegisterWebsite = string.Format(\\\"{0}:5105/Ac\", \"count/Register\\\", baseEndpoint); CatalogEndpoint = string.Format(\\\"{0}:5101\\\", baseEndpoint); OrdersEnd\", \"point = string.Format(\\\"{0}:5102\\\", baseEndpoint); BasketEndpoint = string.Format(\\\"{0}:5103\\\", baseEndp\", \"oint); IdentityEndpoint = string.Format(\\\"{0}:5105/connect/authorize\\\", baseEndpoint); UserInfoEndpoin\", \"t = string.Format(\\\"{0}:5105/connect/userinfo\\\", baseEndpoint); TokenEndpoint = string.Format(\\\"{0}:510\", \"5/connect/token\\\", baseEndpoint); LogoutEndpoint = string.Format(\\\"{0}:5105/connect/endsession\\\", baseE\", \"ndpoint); IdentityCallback = string.Format(\\\"{0}:5105/xamarincallback\\\", baseEndpoint); LogoutCallback\", \" = string.Format(\\\"{0}:5105/Account/Redirecting\\\", baseEndpoint); } }\\n```\\n\\nEach time the BaseEndpoint \", \"property is set, the UpdateEndpoint method is called. This method updates a series of properties, al\", \"l of which are based on the UrlBase user setting that's provided by the Settings class that represen\", \"t different endpoints that the eShopOnContainers mobile app connects to.\\n\\n## Data binding to user se\", \"ttings\\n\\nIn the eShopOnContainers mobile app, the SettingsView exposes two user settings. These setti\", \"ngs allow configuration of whether the app should retrieve data from microservices that are deployed\", \" as Docker containers, or whether the app should retrieve data from mock services that don't require\", \" an internet connection. When choosing to retrieve data from containerized microservices, a base end\", \"point URL for the microservices must be specified. Figure 7-1 shows the SettingsView when the user h\", \"as chosen to retrieve data from containerized microservices.\\n\\nUse Microservices/Containers from eSho\", \"pOnContainers\\n\\nWhen enabling the use of microservices/containers, network.\\n\\nEndpoint\\n\\nFigure 7-1 : U\", \"ser settings exposed by the eShopOnContainers mobile app\\n\\n<!-- image -->\\n\\nData binding can be used t\", \"o retrieve and set settings exposed by the Settings class. This is achieved by controls on the view \", \"binding to view model properties that in turn access properties in the Settings class, and raising a\", \" property changed notification if the settings value has changed. For information about how the eSho\", \"pOnContainers mobile app constructs view models and associates them to views, see Automatically crea\", \"ting a view model with a view model locator.\\n\\nThe following code example shows the Entry control fro\", \"m the SettingsView that allows the user to enter a base endpoint URL for the containerized microserv\", \"ices:\\n\\n```\\n<Entry Text=\\\"{Binding Endpoint, Mode=TwoWay}\\\" />\\n```\\n\\nThis Entry control binds to the End\", \"point property of the SettingsViewModel class, using a two-way binding. The following code example s\", \"hows the Endpoint property:\\n\\n```\\npublic string Endpoint { get { return _endpoint; } set { _endpoint \", \"= value; if(!string.IsNullOrEmpty(_endpoint)) { UpdateEndpoint(_endpoint); } RaisePropertyChanged(()\", \" => Endpoint); } }\\n```\\n\\nWhen the Endpoint property is set the UpdateEndpoint method is called, provi\", \"ded that the supplied value is valid, and property changed notification is raised. The following cod\", \"e example shows the UpdateEndpoint method:\\n\\n```\\nprivate void UpdateEndpoint(string endpoint) { Setti\", \"ngs.UrlBase = endpoint; }\\n```\\n\\nThis method updates the UrlBase property in the Settings class with t\", \"he base endpoint URL value entered by the user, which causes it to be persisted to platform-specific\", \" storage.\\n\\nWhen the SettingsView is navigated to, the InitializeAsync method in the SettingsViewMode\", \"l class is executed. The following code example shows this method:\\n\\n```\\npublic override Task Initial\", \"izeAsync(object navigationData) { ... Endpoint = Settings.UrlBase; ... }\\n```\\n\\nThe method sets the En\", \"dpoint property to the value of the UrlBase property in the Settings class. Accessing the UrlBase pr\", \"operty causes the Xam.Plugins.Settings library to retrieve the settings value from platform-specific\", \" storage. For information about how the InitializeAsync method is invoked, see Passing parameters du\", \"ring navigation.\\n\\nThis mechanism ensures that whenever a user navigates to the SettingsView , user s\", \"ettings are retrieved from platform-specific storage and presented through data binding. Then, if th\", \"e user changes the settings values, data binding ensures that they are immediately persisted back to\", \" platform-specific storage.\\n\\n## Summary\\n\\nSettings allow the separation of data that configures the b\", \"ehavior of an app from the code, allowing the behavior to be changed without rebuilding the app. App\", \" settings are data that an app creates and manages, and user settings are the customizable settings \", \"of an app that affect the behavior of the app and don't require frequent re-adjustment.\\n\\nThe Xam.Plu\", \"gins.Settings library provides a consistent, type-safe, cross-platform approach for persisting and r\", \"etrieving app and user settings, and data binding can be used to access settings created with the li\", \"brary.\\n\\n## Containerized microservices\\n\\n\\u2022 Manathic nnestion coing on\\n\\nDeveloping client-server appli\", \"cations has resulted in a focus on building tiered applications that use specific technologies in ea\", \"ch tier. Such applications are often referred to as monolithic applications, and are packaged onto h\", \"ardware pre-scaled for peak loads. The main drawbacks of this development approach are the tight cou\", \"pling between components within each tier, that individual components can't be easily scaled, and th\", \"e cost of testing. A simple update can have unforeseen effects on the rest of the tier, and so a cha\", \"nge to an application component requires its entire tier to be retested and redeployed.\\n\\nParticularl\", \"y concerning in the age of the cloud, is that individual components can't be easily scaled. A monoli\", \"thic application contains domain-specific functionality, and is typically divided by functional laye\", \"rs such as front end, business logic, and data storage. A monolithic application is scaled by clonin\", \"g the entire application onto multiple machines, as illustrated in Figure 8-1.\\n\\nFigure 8-1 : Monolit\", \"hic application scaling approach\\n\\n<!-- image -->\\n\\neating instances of services across machines.\\n\\nApp\", \" 1\\n\\nApp 2\\n\\n## Microservices\\n\\nMicroservices offer a different approach to application development and\", \" deployment, an approach that's suited to the agility, scale, and reliability requirements of modern\", \" cloud applications. A microservices application is decomposed into independent components that work\", \" together to deliver the application's overall functionality. The term microservice emphasizes that \", \"applications should be composed of services small enough to reflect independent concerns, so that ea\", \"ch microservice implements a single function. In addition, each microservice has well-defined contra\", \"cts so that other microservices can communicate and share data with it. Typical examples of microser\", \"vices include shopping carts, inventory processing, purchase subsystems, and payment processing.\\n\\nMi\", \"croservices can scale-out independently, as compared to giant monolithic applications that scale tog\", \"ether. This means that a specific functional area, that requires more processing power or network ba\", \"ndwidth to support demand, can be scaled rather than unnecessarily scaling-out other areas of the ap\", \"plication. Figure 8-2 illustrates this approach, where microservices are deployed and scaled indepen\", \"dently, creating instances of services across machines.\\n\\nFigure 8-2 : Microservices application scal\", \"ing approach\\n\\n<!-- image -->\\n\\nMicroservice scale-out can be nearly instantaneous, allowing an applic\", \"ation to adapt to changing loads. For example, a single microservice in the web-facing functionality\", \" of an application might be the only microservice in the application that needs to scale out to hand\", \"le additional incoming traffic.\\n\\nThe classic model for application scalability is to have a load-bal\", \"anced, stateless tier with a shared external datastore to store persistent data. Stateful microservi\", \"ces manage their own persistent data, usually storing it locally on the servers on which they are pl\", \"aced, to avoid the overhead of network access and complexity of cross-service operations. This enabl\", \"es the fastest possible processing of data and can eliminate the need for caching systems. In additi\", \"on, scalable stateful microservices usually partition data among their instances, in order to manage\", \" data size and transfer throughput beyond which a single server can support.\\n\\nMicroservices also sup\", \"port independent updates. This loose coupling between microservices provides a rapid and reliable ap\", \"plication evolution. Their independent, distributed nature supports rolling updates, where only a su\", \"bset of instances of a single microservice will update at any given time. Therefore, if a problem is\", \" detected, a buggy update can be rolled back, before all instances update with the faulty code or co\", \"nfiguration. Similarly, microservices typically use schema versioning, so that dianeo\\n\\nclients see a\", \" consistent version when updates are being applied, regardless of which microservice instance is bei\", \"ng communicated with.\\n\\nTherefore, microservice applications have many benefits over monolithic appli\", \"cations:\\n\\n- Each microservice is relatively small, easy to manage and evolve.\\n- Each microservice ca\", \"n be developed and deployed independently of other services.\\n- Each microservice can be scaled-out i\", \"ndependently. For example, a catalog service or shopping basket service might need to be scaled-out \", \"more than an ordering service. Therefore, the resulting infrastructure will more efficiently consume\", \" resources when scaling out.\\n- Each microservice isolates any issues. For example, if there is an is\", \"sue in a service it only impacts that service. The other services can continue to handle requests.\\n-\", \" Each microservice can use the latest technologies. Because microservices are autonomous and run sid\", \"e-by-side, the latest technologies and frameworks can be used, rather than being forced to use an ol\", \"der framework that might be used by a monolithic application.\\n\\nHowever, a microservice based solutio\", \"n also has potential drawbacks:\\n\\n- Choosing how to partition an application into microservices can b\", \"e challenging, as each microservice has to be completely autonomous, end-to-end, including responsib\", \"ility for its data sources.\\n- Developers must implement inter-service communication, which adds comp\", \"lexity and latency to the application.\\n- Atomic transactions between multiple microservices usually \", \"aren't possible. Therefore, business requirements must embrace eventual consistency between microser\", \"vices.\\n- In production, there is an operational complexity in deploying and managing a system compro\", \"mised of many independent services.\\n- Direct client-to-microservice communication can make it diffic\", \"ult to refactor the contracts of microservices. For example, over time how the system is partitioned\", \" into services might need to change. A single service might split into two or more services, and two\", \" services might merge. When clients communicate directly with microservices, this refactoring work c\", \"an break compatibility with client apps.\\n\\n## Containerization\\n\\nContainerization is an approach to so\", \"ftware development in which an application and its versioned set of dependencies, plus its environme\", \"nt configuration abstracted as deployment manifest files, are packaged together as a container image\", \", tested as a unit, and deployed to a host operating system.\\n\\nA container is an isolated, resource c\", \"ontrolled, and portable operating environment, where an application can run without touching the res\", \"ources of other containers, or the host. Therefore, a container looks and acts like a newly installe\", \"d physical computer or a virtual machine.\\n\\nThere are many similarities between containers and virtua\", \"l machines, as illustrated in Figure 8-3.\\n\\nVirtual Machines\\n\\nApp 1\\n\\nApp 2\\n\\nBins/Libs\\n\\nGuest OS\\n\\nBins\", \"/Libs\\n\\nApp 3\\n\\nBins/Libs\\n\\nApp 1\\n\\nContainers\\n\\nApp 2\\n\\nApp 3\\n\\nFigure 8-3 : Comparison of virtual machine\", \"s and containers\\n\\n<!-- image -->\\n\\nA container runs an operating system, has a file system, and can b\", \"e accessed over a network as if it were a physical or virtual machine. However, the technology and c\", \"oncepts used by containers are very different from virtual machines. Virtual machines include the ap\", \"plications, the required dependencies, and a full guest operating system. Containers include the app\", \"lication and its dependencies, but share the operating system with other containers, running as isol\", \"ated processes on the host operating system (aside from Hyper-V containers which run inside of a spe\", \"cial virtual machine per container). Therefore, containers share resources and typically require few\", \"er resources than virtual machines.\\n\\nThe advantage of a container-oriented development and deploymen\", \"t approach is that it eliminates most of the issues that arise from inconsistent environment setups \", \"and the problems that come with them. In addition, containers permit fast application scale-up funct\", \"ionality by instancing new containers as required.\\n\\nThe key concepts when creating and working with \", \"containers are:\\n\\n- Container Host: The physical or virtual machine configured to host containers. Th\", \"e container host will run one or more containers.\\n- Container Image: An image consists of a union of\", \" layered filesystems stacked on top of each other, and is the basis of a container. An image does no\", \"t have state and it never changes as it's deployed to different environments.\\n- Container: A contain\", \"er is a runtime instance of an image.\\n- Container OS Image: Containers are deployed from images. The\", \" container operating system image is the first layer in potentially many image layers that make up a\", \" container. A container operating system is immutable, and can't be modified.\\n- Container Repository\", \": Each time a container image is created, the image and its dependencies are stored in a local repos\", \"itory. These images can be reused many times on the container host. The container images can also be\", \" stored in a public or private registry, such as Docker Hub, so that they can be used across differe\", \"nt container hosts.\\n\\nDocker Host\\n\\nIdentity Microservice (STS+Users)\\n\\nWeb API\\n\\nSQL Server database\\n\\nC\", \"ontainer\\n\\nEnterprises are increasingly adopting containers when implementing microservice based appl\", \"ications, and Docker has become the standard container implementation that has been adopted by most \", \"software platforms and cloud vendors.\\n\\nThe eShopOnContainers reference application uses Docker to ho\", \"st four containerized back-end microservices, as illustrated in Figure 8-4.\\n\\nOrdering Microservice\\n\\n\", \"Web API\\n\\nContainer\\n\\nBasket Microservice\\n\\nWeb API\\n\\nContainer\\n\\nPAtinare raforans anplication hark-and \", \"microcor\\n\\nFigure 8-4 : eShopOnContainers reference application back-end microservices\\n\\n<!-- image --\", \">\\n\\nThe architecture of the back-end services in the reference application is decomposed into multipl\", \"e autonomous sub-systems in the form of collaborating microservices and containers. Each microservic\", \"e provides a single area of functionality: an identity service, a catalog service, an ordering servi\", \"ce, and a basket service.\\n\\nEach microservice has its own database, allowing it to be fully decoupled\", \" from the other microservices. Where necessary, consistency between databases from different microse\", \"rvices is achieved using application-level events. For more information, see Communication between m\", \"icroservices.\\n\\nFor more information about the reference application, see .NET Microservices: Archite\", \"cture for Containerized .NET Applications.\\n\\n## Communication between client and microservices\\n\\nThe e\", \"ShopOnContainers mobile app communicates with the containerized back-end microservices using direct \", \"client-to-microservice communication, which is shown in Figure 8-5.\\n\\nMobile App\\n\\nFiaure 9-5: Direct \", \"client-to-microcervice communication\\n\\nBackend Microservices\\n\\nMicroservice 1\\n\\nWeb AP\\n\\nFigure 8-5 : Di\", \"rect client-to-microservice communication\\n\\n<!-- image -->\\n\\nWith direct client-to-microservice commun\", \"ication, the mobile app makes requests to each microservice directly through its public endpoint, wi\", \"th a different TCP port per microservice. In production, the endpoint would typically map to the mic\", \"roservice's load balancer, which distributes requests across the available instances.\\n\\nTip: Consider\", \" using API gateway communication\\n\\nDirect client-to-microservice communication can have drawbacks whe\", \"n building a large and complex microservice based application, but it's more than adequate for a sma\", \"ll application. When designing a large microservice based application with tens of microservices, co\", \"nsider using API gateway communication. For more information, see .NET Microservices: Architecture f\", \"or Containerized .NET Applications.\\n\\n## Communication between microservices\\n\\nA microservices based a\", \"pplication is a distributed system, potentially running on multiple machines. Each service instance \", \"is typically a process. Therefore, services must interact using an inter-process communication proto\", \"col, such as HTTP, TCP, Advanced Message Queuing Protocol (AMQP), or binary protocols, depending on \", \"the nature of each service.\\n\\nThe two common approaches for microservice-to-microservice communicatio\", \"n are HTTP based REST communication when querying for data, and lightweight asynchronous messaging w\", \"hen communicating updates across multiple microservices.\\n\\nAsynchronous messaging based event-driven \", \"communication is critical when propagating changes across multiple microservices. With this approach\", \", a microservice publishes an event when something notable happens, for example, when it updates a b\", \"usiness entity. Other microservices subscribe to these events. Then, when a microservice receives an\", \" event, it updates its own business entities, which might in turn lead to more events being publishe\", \"d. This publish-subscribe functionality is usually achieved with an event bus.\\n\\nAn event bus allows \", \"publish-subscribe communication between microservices, without requiring the components to be explic\", \"itly aware of each other, as shown in Figure 8-6.\\n\\nMicroservice A\\n\\nMobile App\\n\\nDocker Host\\n\\nIdentity\", \" Microservice (STS+Users)\\n\\nWeb API\\n\\nSQL Server\\n\\nContainer database\\n\\nFigure 8-6: Publish-subscribe wi\", \"th an event bus\\n\\n<!-- image -->\\n\\nFrom an application perspective, the event bus is simply a publish-\", \"subscribe channel exposed via an interface. However, the way the event bus is implemented can vary. \", \"For example, an event bus implementation could use RabbitMQ, Azure Service Bus, or other service bus\", \"es such as NServiceBus and MassTransit. Figure 8-7 shows how an event bus is used in the eShopOnCont\", \"ainers reference application.\\n\\nFigure 8-7: Asynchronous event-driven communication in the reference \", \"application\\n\\n<!-- image -->\\n\\nThe eShopOnContainers event bus, implemented using RabbitMQ, provides o\", \"ne-to-many asynchronous publish-subscribe functionality. This means that after publishing an event, \", \"there can be multiple subscribers listening for the same event. Figure 8-9 illustrates this relation\", \"ship.\\n\\nMicroservice B\\n\\nUser-Profile Microservice\\n\\nWeb API Service\\n\\n3\\n\\nDatabase as\\n\\nCache ervice\\n\\nUse\", \"rUpdated event \\u2192 Buyer info\\n\\nFigure 8-9 : One-to-many communication\\n\\n<!-- image -->\\n\\nThis one-to-man\", \"y communication approach uses events to implement business transactions that span multiple services,\", \" ensuring eventual consistency between the services. An eventual-consistent transaction consists of \", \"a series of distributed steps. Therefore, when the user-profile microservice receives the UpdateUser\", \" command, it updates the user's details in its database and publishes the UserUpdated event to the e\", \"vent bus. Both the basket microservice and the ordering microservice have subscribed to receive this\", \" event, and in response update their buyer information in their respective databases.\\n\\nNote: The eSh\", \"opOnContainers event bus, implemented using RabbitMQ, is intended to be used only as a proof of conc\", \"ept. For production systems, alternative event bus implementations should be considered.\\n\\nFor inform\", \"ation about the event bus implementation, see .NET Microservices: Architecture for Containerized .NE\", \"T Applications.\\n\\n## Summary\\n\\nMicroservices offer an approach to application development and deployme\", \"nt that's suited to the agility, scale, and reliability requirements of modern cloud applications. O\", \"ne of the main advantages of microservices is that they can be scaled-out independently, which means\", \" that a specific functional area can be scaled that requires more processing power or network bandwi\", \"dth to support demand, without unnecessarily scaling areas of the application that are not experienc\", \"ing increased demand.\\n\\nA container is an isolated, resource controlled, and portable operating envir\", \"onment, where an application can run without touching the resources of other containers, or the host\", \". Enterprises are increasingly adopting containers when implementing microservice based applications\", \", and Docker has become the standard container implementation that has been adopted by most software\", \" platforms and cloud vendors.\\n\\nUpdateUser command\\n\\nDatabase\\n\\nBasket Microservice\\n\\n## Authentication \", \"and authorization\\n\\nAuthentication is the process of obtaining identification credentials such as nam\", \"e and password from a user, and validating those credentials against an authority. If the credential\", \"s are valid, the entity that submitted the credentials is considered an authenticated identity. Once\", \" an identity has been authenticated, an authorization process determines whether that identity has a\", \"ccess to a given resource.\\n\\nThere are many approaches to integrating authentication and authorizatio\", \"n into a Xamarin.Forms app that communicates with an ASP.NET MVC web application, including using AS\", \"P.NET Core Identity, external authentication providers such as Microsoft, Google, Facebook, or Twitt\", \"er, and authentication middleware. The eShopOnContainers mobile app performs authentication and auth\", \"orization with a containerized identity microservice that uses IdentityServer 4. The mobile app requ\", \"ests security tokens from IdentityServer, either for authenticating a user or for accessing a resour\", \"ce. For IdentityServer to issue tokens on behalf of a user, the user must sign-in to IdentityServer.\", \" However, IdentityServer doesn't provide a user interface or database for authentication. Therefore,\", \" in the eShopOnContainers reference application, ASP.NET Core Identity is used for this purpose.\\n\\n##\", \" Authentication\\n\\nAuthentication is required when an application needs to know the identity of the cu\", \"rrent user. ASP.NET Core's primary mechanism for identifying users is the ASP.NET Core Identity memb\", \"ership system, which stores user information in a data store configured by the developer. Typically,\", \" this data store will be an EntityFramework store, though custom stores or third party packages can \", \"be used to store identity information in Azure storage, DocumentDB, or other locations.\\n\\nFor authent\", \"ication scenarios that make use of a local user data store, and that persist identity information be\", \"tween requests via cookies (as is typical in ASP.NET MVC web applications), ASP.NET Core Identity is\", \" a suitable solution. However, cookies are not always a natural means of persisting and transmitting\", \" data. For example, an ASP.NET Core web application that exposes RESTful endpoints that are accessed\", \" from a mobile app will typically need to use bearer token authentication, since cookies can't be us\", \"ed in this scenario. However, bearer tokens can easily be retrieved and included in the authorizatio\", \"n header of web requests made from the mobile app.\\n\\nMobile App\\n\\n-\\n\\nSign-in\\n\\nSecurity token\\n\\nIdentity\", \" Microservice (STS+Users)\\n\\nWeb API\\n\\nSQL Server database\\n\\n## Issuing bearer tokens using IdentityServ\", \"er 4 Container\\n\\nIdentityServer 4 is an open source OpenID Connect and OAuth 2.0 framework for ASP.NE\", \"T Core, which can be used for many authentication and authorization scenarios including issuing secu\", \"rity tokens for local ASP.NET Core Identity users.\\n\\nNote: OpenID Connect and OAuth 2.0 are very simi\", \"lar, while having different responsibilities.\\n\\nOpenID Connect is an authentication layer on top of t\", \"he OAuth 2.0 protocol. OAuth 2 is a protocol that allows applications to request access tokens from \", \"a security token service and use them to communicate with APIs. This delegation reduces complexity i\", \"n both client applications and APIs since authentication and authorization can be centralized.\\n\\nThe \", \"combination of OpenID Connect and OAuth 2.0 combine the two fundamental security concerns of authent\", \"ication and API access, and IdentityServer 4 is an implementation of these protocols.\\n\\nIn applicatio\", \"ns that use direct client-to-microservice communication, such as the eShopOnContainers reference app\", \"lication, a dedicated authentication microservice acting as a Security Token Service (STS) can be us\", \"ed to authenticate users, as shown in Figure 9-1. For more information about direct clientto-microse\", \"rvice communication, see Communication between client and microservices.\\n\\nFigure 9-1: Authentication\", \" by a dedicated authentication microservice\\n\\n<!-- image -->\\n\\nThe eShopOnContainers mobile app commun\", \"icates with the identity microservice, which uses IdentityServer 4 to perform authentication, and ac\", \"cess control for APIs. Therefore, the mobile app requests tokens from IdentityServer, either for aut\", \"henticating a user or for accessing a resource:\\n\\n- Authenticating users with IdentityServer is achie\", \"ved by the mobile app requesting an identity token, which represents the outcome of an authenticatio\", \"n process. At a bare minimum, it contains an identifier for the user, and information about how and \", \"when the user authenticated. It can also contain additional identity data.\\n- Accessing a resource wi\", \"th IdentityServer is achieved by the mobile app requesting an access token, which allows access to a\", \"n API resource. Clients request access tokens and forward them to the API. Access tokens contain inf\", \"ormation about the client, and the user (if present). APIs then use that information to authorize ac\", \"cess to their data.\\n\\nNote : A client must be registered with IdentityServer before it can request to\", \"kens.\\n\\n## Adding IdentityServer to a web application\\n\\nIn order for an ASP.NET Core web application t\", \"o use IdentityServer 4, it must be added to the web application's Visual Studio solution. For more i\", \"nformation, see Setup and Overview in the IdentityServer documentation.\\n\\nDocker Host\\n\\nOnce IdentityS\", \"erver is included in the web application's Visual Studio solution, it must be added to the web appli\", \"cation's HTTP request processing pipeline, so that it can serve requests to OpenID Connect and OAuth\", \" 2.0 endpoints. This is achieved in the Configure method in the web application's Startup class, as \", \"demonstrated in the following code example:\\n\\n```\\npublic void Configure( IApplicationBuilder app, IHo\", \"stingEnvironment env, ILoggerFactory loggerFactory) { ... app.UseIdentity(); ... }\\n```\\n\\nOrder matter\", \"s in the web application's HTTP request processing pipeline. Therefore, IdentityServer must be added\", \" to the pipeline before the UI framework that implements the login screen.\\n\\n## Configuring IdentityS\", \"erver\\n\\nIdentityServer should be configured in the ConfigureServices method in the web application's \", \"Startup class by calling the services.AddIdentityServer method, as demonstrated in the following cod\", \"e example from the eShopOnContainers reference application:\\n\\n```\\npublic void ConfigureServices(IServ\", \"iceCollection services) { ... services.AddIdentityServer(x => x.IssuerUri = \\\"null\\\") .AddSigningCrede\", \"ntial(Certificate.Get()) .AddAspNetIdentity<ApplicationUser>() .AddConfigurationStore(builder => bui\", \"lder.UseSqlServer(connectionString, options => options.MigrationsAssembly(migrationsAssembly))) .Add\", \"OperationalStore(builder => builder.UseSqlServer(connectionString, options => options.MigrationsAsse\", \"mbly(migrationsAssembly))) .Services.AddTransient<IProfileService, ProfileService>(); }\\n```\\n\\nAfter c\", \"alling the services.AddIdentityServer method, additional fluent APIs are called to configure the fol\", \"lowing:\\n\\n- Credentials used for signing.\\n- API and identity resources that users might request acces\", \"s to.\\n- Clients that will be connecting to request tokens.\\n- ASP.NET Core Identity.\\n\\nTip : Dynamical\", \"ly load the IdentityServer 4 configuration\\n\\nIdentityServer 4's APIs allow for configuring IdentitySe\", \"rver from an in-memory list of configuration objects. In the eShopOnContainers reference application\", \", these in-memory collections are hardcoded into the application. However, in production scenarios t\", \"hey can be loaded dynamically from a configuration file or from a database.\\n\\nFor information about c\", \"onfiguring IdentityServer to use ASP.NET Core Identity, see Using ASP.NET Core Identity in the Ident\", \"ityServer documentation.\\n\\n## Configuring API resources\\n\\nWhen configuring API resources, the AddInMem\", \"oryApiResources method expects an IEnumerable&lt;ApiResource&gt; collection. The following code exam\", \"ple shows the GetApis method that provides this collection in the eShopOnContainers reference applic\", \"ation:\\n\\n```\\npublic static IEnumerable<ApiResource> GetApis() { return new List<ApiResource> { new Ap\", \"iResource(\\\"orders\\\", \\\"Orders Service\\\"), new ApiResource(\\\"basket\\\", \\\"Basket Service\\\") }; }\\n```\\n\\nThis me\", \"thod specifies that IdentityServer should protect the orders and basket APIs. Therefore, IdentitySer\", \"ver managed access tokens will be required when making calls to these APIs. For more information abo\", \"ut the ApiResource type, see API Resource in the IdentityServer 4 documentation.\\n\\n## Configuring ide\", \"ntity resources\\n\\nWhen configuring identity resources, the AddInMemoryIdentityResources method expect\", \"s an IEnumerable&lt;IdentityResource&gt; collection. Identity resources are data such as user ID, na\", \"me, or email address. Each identity resource has a unique name, and arbitrary claim types can be ass\", \"igned to it, which will then be included in the identity token for the user. The following code exam\", \"ple shows the GetResources method that provides this collection in the eShopOnContainers reference a\", \"pplication:\\n\\n```\\npublic static IEnumerable<IdentityResource> GetResources() { return new List<Identi\", \"tyResource> { new IdentityResources.OpenId(), new IdentityResources.Profile() }; }\\n```\\n\\nThe OpenID C\", \"onnect specification specifies some standard identity resources. The minimum requirement is that sup\", \"port is provided for emitting a unique ID for users. This is achieved by exposing the IdentityResour\", \"ces.OpenId identity resource.\\n\\nNote: The IdentityResources class supports all of the scopes defined \", \"in the OpenID Connect specification (openid, email, profile, telephone, and address).\\n\\nIdentityServe\", \"r also supports defining custom identity resources. For more information, see Defining custom identi\", \"ty resources in the IdentityServer documentation. For more information about the IdentityResource ty\", \"pe, see Identity Resource in the IdentityServer 4 documentation.\\n\\n## Configuring clients\\n\\nClients ar\", \"e applications that can request tokens from IdentityServer. Typically, the following settings must b\", \"e defined for each client as a minimum:\\n\\n- A unique client ID.\\n- The allowed interactions with the t\", \"oken service (known as the grant type).\\n- The location where identity and access tokens are sent to \", \"(known as a redirect URI).\\n\\n- A list of resources that the client is allowed access to (known as sco\", \"pes).\\n\\nWhen configuring clients, the AddInMemoryClients method expects an IEnumerable&lt;Client&gt; \", \"collection. The following code example shows the configuration for the eShopOnContainers mobile app \", \"in the GetClients method that provides this collection in the eShopOnContainers reference applicatio\", \"n:\\n\\n```\\npublic static IEnumerable<Client> GetClients(Dictionary<string,string> clientsUrl) { return \", \"new List<Client> { ... new Client { ClientId = \\\"xamarin\\\", ClientName = \\\"eShop Xamarin OpenId Client\\\"\", \", AllowedGrantTypes = GrantTypes.Hybrid, ClientSecrets = { new Secret(\\\"secret\\\".Sha256()) }, Redirect\", \"Uris = { clientsUrl[\\\"Xamarin\\\"] }, RequireConsent = false, RequirePkce = true, PostLogoutRedirectUris\", \" = { $\\\"{clientsUrl[\\\"Xamarin\\\"]}/Account/Redirecting\\\" }, AllowedCorsOrigins = { \\\"http://eshopxamarin\\\" \", \"}, AllowedScopes = new List<string> { IdentityServerConstants.StandardScopes.OpenId, IdentityServerC\", \"onstants.StandardScopes.Profile, IdentityServerConstants.StandardScopes.OfflineAccess, \\\"orders\\\", \\\"ba\", \"sket\\\" }, AllowOfflineAccess = true, AllowAccessTokensViaBrowser = true }, ... }; }\\n```\\n\\nThis configu\", \"ration specifies data for the following properties:\\n\\n- ClientId : A unique ID for the client.\\n- Clie\", \"ntName : The client display name, which is used for logging and the consent screen.\\n- AllowedGrantTy\", \"pes : Specifies how a client wants to interact with IdentityServer. For more information see Configu\", \"ring the authentication flow.\\n- ClientSecrets : Specifies the client secret credentials that are use\", \"d when requesting tokens from the token endpoint.\\n- RedirectUris : Specifies the allowed URIs to whi\", \"ch to return tokens or authorization codes.\\n- RequireConsent : Specifies whether a consent screen is\", \" required.\\n- RequirePkce : Specifies whether clients using an authorization code must send a proof k\", \"ey.\\n- PostLogoutRedirectUris : Specifies the allowed URIs to redirect to after logout.\\n\\nMobile App h\", \"ttp://cbase endpoint&gt;:5105/connect/authorize\\n\\nauthentication response\\n\\n(authorization code and id\", \"entity token)\\n\\nIdentity Microservice (STS+Users)\\n\\nWeb API\\n\\nSQL Server\\n\\n- AllowedCorsOrigins : Specif\", \"ies the origin of the client so that IdentityServer can allow crossorigin calls from the origin.\\n- A\", \"llowedScopes : Specifies the resources the client has access to. By default, a client has no access \", \"to any resources.\\n- AllowOfflineAccess : Specifies whether the client can request refresh tokens. Fi\", \"auro 9-2. Hiah level averview of the cian-in nrocecc\\n\\n## Configuring the authentication flow\\n\\nThe au\", \"thentication flow between a client and IdentityServer can be configured by specifying the grant type\", \"s in the Client.AllowedGrantTypes property. The OpenID Connect and OAuth 2.0 specifications define a\", \" number of authentication flows, including:\\n\\n- Implicit. This flow is optimized for browser-based ap\", \"plications and should be used either for user authentication-only, or authentication and access toke\", \"n requests. All tokens are transmitted via the browser, and therefore advanced features like refresh\", \" tokens are not permitted.\\n- Authorization code. This flow provides the ability to retrieve tokens o\", \"n a back channel, as opposed to the browser front channel, while also supporting client authenticati\", \"on.\\n- Hybrid. This flow is a combination of the implicit and authorization code grant types. The ide\", \"ntity token is transmitted via the browser channel and contains the signed protocol response along w\", \"ith other artifacts such as the authorization code. After successful validation of the response, the\", \" back channel should be used to retrieve the access and refresh token.\\n\\nTip: Use the hybrid authenti\", \"cation flow\\n\\nThe hybrid authentication flow mitigates a number of attacks that apply to the browser \", \"channel, and is the recommended flow for native applications that want to retrieve access tokens (an\", \"d possibly refresh tokens).\\n\\nFor more information about authentication flows, see Grant Types in the\", \" IdentityServer 4 documentation.\\n\\n## Performing authentication\\n\\nFor IdentityServer to issue tokens o\", \"n behalf of a user, the user must sign-in to IdentityServer. However, IdentityServer doesn't provide\", \" a user interface or database for authentication. Therefore, in the eShopOnContainers reference appl\", \"ication, ASP.NET Core Identity is used for this purpose.\\n\\nThe eShopOnContainers mobile app authentic\", \"ates with IdentityServer with the hybrid authentication flow, which is illustrated in Figure 9-2.\\n\\nF\", \"igure 9-2: High-level overview of the sign-in process\\n\\n<!-- image -->\\n\\n-\\n\\nDocker Host 1\\n\\nhttp://&lt;\", \"base endpoint&gt;:5105/connect/endsession\\n\\n+\\n\\npost logout redirect URI\\n\\nMobile App\\n\\nIdentity Microse\", \"rvice (STS+Users)\\n\\nWeb API\\n\\nContainer\\n\\nSQL Server database\\n\\nA sign-in request is made to &lt;base en\", \"dpoint&gt;:5105/connect/authorize . Following successful authentication, IdentityServer returns an a\", \"uthentication response containing an authorization code and an identity token. The authorization cod\", \"e is then sent to &lt;base endpoint&gt;:5105/connect/token , which responds with access, identity, a\", \"nd refresh tokens.\\n\\nThe eShopOnContainers mobile app signs-out of IdentityServer by sending a reques\", \"t to http://&lt;base endpoint&gt;:5105/connect/endsession , with additional parameters. After sign-o\", \"ut occurs, IdentityServer responds by sending a post logout redirect URI back to the mobile app. Fig\", \"ure 9-3 illustrates this process.\\n\\nFigure 9-3: High-level overview of the sign-out process\\n\\n<!-- ima\", \"ge -->\\n\\nIn the eShopOnContainers mobile app, communication with IdentityServer is performed by the I\", \"dentityService class, which implements the IIdentityService interface. This interface specifies that\", \" the implementing class must provide CreateAuthorizationRequest , CreateLogoutRequest , and GetToken\", \"Async methods.\\n\\n## Signing-in\\n\\nWhen the user taps the LOGIN button on the LoginView , the SignInComm\", \"and in the LoginViewModel class is executed, which in turn executes the SignInAsync method. The foll\", \"owing code example shows this method:\\n\\n```\\nprivate async Task SignInAsync() { ... LoginUrl = _identi\", \"tyService.CreateAuthorizationRequest(); IsLogin = true; ... }\\n```\\n\\nThis method invokes the CreateAut\", \"horizationRequest method in the IdentityService class, which is shown in the following code example:\", \"\\n\\n```\\npublic string CreateAuthorizationRequest() { // Create URI to authorization endpoint var autho\", \"rizeRequest = new AuthorizeRequest(GlobalSetting.Instance.IdentityEndpoint); // Dictionary with valu\", \"es for the authorize request var dic = new Dictionary<string, string>(); dic.Add(\\\"client_id\\\", Global\", \"Setting.Instance.ClientId); dic.Add(\\\"client_secret\\\", GlobalSetting.Instance.ClientSecret); dic.Add(\\\"\", \"response_type\\\", \\\"code id_token\\\"); dic.Add(\\\"scope\\\", \\\"openid profile basket orders locations marketing\", \" offline_access\\\"); dic.Add(\\\"redirect_uri\\\", GlobalSetting.Instance.IdentityCallback); dic.Add(\\\"nonce\\\"\", \", Guid.NewGuid().ToString(\\\"N\\\")); dic.Add(\\\"code_challenge\\\", CreateCodeChallenge()); dic.Add(\\\"code_cha\", \"llenge_method\\\", \\\"S256\\\");\\n```\\n\\nDocker Host 1\\n\\nARE YOU REGISTERED?\\n\\nEMAIL\\n\\n```\\n// Add CSRF token to pr\", \"otect against cross-site request forgery attacks. var currentCSRFToken = Guid.NewGuid().ToString(\\\"N\\\"\", \"); dic.Add(\\\"state\\\", currentCSRFToken); var authorizeUri = authorizeRequest.Create(dic); return autho\", \"rizeUri; } \\u00b7 Remember me?\\n```\\n\\nThis method creates the URI for IdentityServer's authorization endpoi\", \"nt, with the required parameters. The authorization endpoint is at /connect/authorize on port 5105 o\", \"f the base endpoint exposed as a user setting. For more information about user settings, see Configu\", \"ration management.\\n\\nNote : The attack surface of the eShopOnContainers mobile app is reduced by impl\", \"ementing the Proof Key for Code Exchange (PKCE) extension to OAuth. PKCE protects the authorization \", \"code from being used if it's intercepted. This is achieved by the client generating a se cret verifi\", \"er, a hash of which is passed in the authorization request, and which is presented unhashed when red\", \"eeming the authorization code. For more information about PKCE, see Proof Key for Code Exchange by O\", \"Auth Public Clients on the Internet Engineering Task Force web site.\\n\\nThe returned URI is stored in \", \"the LoginUrl property of the LoginViewModel class. When the IsLogin property becomes true , the WebV\", \"iew in the LoginView becomes visible. The WebView data binds its Source property to the LoginUrl pro\", \"perty of the LoginViewModel class, and so makes a sign-in request to IdentityServer when the LoginUr\", \"l property is set to IdentityServer's authorization endpoint. When IdentityServer receives this requ\", \"est and the user isn't authenticated, the WebView will be redirected to the configured login page, w\", \"hich is shown in Figure 9-4.\\n\\nFigure 9-4: Login page displayed by the WebView\\n\\n<!-- image -->\\n\\nOnce \", \"login is completed, the WebView will be redirected to a return URI. This WebView navigation will cau\", \"se the NavigateAsync method in the LoginViewModel class to be executed, which is shown in the follow\", \"ing code example:\\n\\n```\\nprivate async Task NavigateAsync(string url) { ... var authResponse = new Aut\", \"horizeResponse(url); if (!string.IsNullOrWhiteSpace(authResponse.Code)) { var userToken = await _ide\", \"ntityService.GetTokenAsync(authResponse.Code); string accessToken = userToken.AccessToken; if (!stri\", \"ng.IsNullOrWhiteSpace(accessToken)) { Settings.AuthAccessToken = accessToken; Settings.AuthIdToken =\", \" authResponse.IdentityToken; await NavigationService.NavigateToAsync<MainViewModel>(); await Navigat\", \"ionService.RemoveLastFromBackStackAsync(); } } ... }\\n```\\n\\nThis method parses the authentication resp\", \"onse that's contained in the return URI, and provided that a valid authorization code is present, it\", \" makes a request to IdentityServer's token endpoint, passing the authorization code, the PKCE secret\", \" verifier, and other required parameters. The token endpoint is at /connect/token on port 5105 of th\", \"e base endpoint exposed as a user setting. For more information about user settings, see Configurati\", \"on management.\\n\\nTip : Validate return URIs Although the eShopOnContainers mobile app doesn't validat\", \"e the return URI, the best practice is to validate that the return URI refers to a known location in\", \" order to prevent open-redirect attacks.\\n\\nIf the token endpoint receives a valid authorization code \", \"and PKCE secret verifier, it responds with an access token, identity token, and refresh token. The a\", \"ccess token (which allows access to API resources) and identity token are then stored as application\", \" settings, and page navigation is performed. Therefore, the overall effect in the eShopOnContainers \", \"mobile app is this: provided that users are able to successfully authenticate with IdentityServer, t\", \"hey are navigated to the MainView page, which is a TabbedPage that displays the CatalogView as its s\", \"elected tab.\\n\\nFor information about page navigation, see Navigation. For information about how WebVi\", \"ew navigation causes a view model method to be executed, see Invoking navigation using behaviors. Fo\", \"r information about application settings, see Configuration management.\\n\\nNote: The eShopOnContainers\", \" also allows a mock sign-in when the app is configured to use mock services in the SettingsView . In\", \" this mode, the app doesn't communicate with IdentityServer, instead allowing the user to sign-in us\", \"ing any credentials.\\n\\n## Signing-out\\n\\nWhen the user taps the LOG OUT button in the ProfileView , the\", \" LogoutCommand in the ProfileViewModel class is executed, which in turn executes the LogoutAsync met\", \"hod. This method performs page navigation to the LoginView page, passing a LogoutParameter instance \", \"set to true as a parameter. For more information about passing parameters during page navigation, se\", \"e Passing parameters during navigation.\\n\\nWhen a view is created and navigated to, the InitializeAsyn\", \"c method of the view's associated view model is executed, which then executes the Logout method of t\", \"he LoginViewModel class, which is shown in the following code example:\\n\\n```\\nprivate void Logout() { \", \"var authIdToken = Settings.AuthIdToken; var logoutRequest = _identityService.CreateLogoutRequest(aut\", \"hIdToken); if (!string.IsNullOrEmpty(logoutRequest)) { // Logout LoginUrl = logoutRequest; } ... }\\n`\", \"``\\n\\nThis method invokes the CreateLogoutRequest method in the IdentityService class, passing the ide\", \"ntity token retrieved from application settings as a parameter. For more information about applicati\", \"on settings, see Configuration management. The following code example shows the CreateLogoutRequest \", \"method:\\n\\n```\\npublic string CreateLogoutRequest(string token) { ... return string.Format(\\\"{0}?id_toke\", \"n_hint={1}&post_logout_redirect_uri={2}\\\", GlobalSetting.Instance.LogoutEndpoint, token, GlobalSettin\", \"g.Instance.LogoutCallback); }\\n```\\n\\nThis method creates the URI to IdentityServer's end session endpo\", \"int, with the required parameters. The end session endpoint is at /connect/endsession on port 5105 o\", \"f the base endpoint exposed as a user setting. For more information about user settings, see Configu\", \"ration management.\\n\\nThe returned URI is stored in the LoginUrl property of the LoginViewModel class.\", \" While the IsLogin property is true , the WebView in the LoginView is visible. The WebView data bind\", \"s its Source property to the LoginUrl property of the LoginViewModel class, and so makes a sign-out \", \"request to IdentityServer when the LoginUrl property is set to IdentityServer's end session endpoint\", \". When IdentityServer receives this request, provided that the user is signed-in, sign-out occurs. A\", \"uthentication is tracked with a cookie managed by the cookie authentication middleware from ASP.NET \", \"Core. Therefore, signing out of IdentityServer removes the authentication cookie and sends a post lo\", \"gout redirect URI back to the client.\\n\\nIn the mobile app, the WebView will be redirected to the post\", \" logout redirect URI. This WebView navigation will cause the NavigateAsync method in the LoginViewMo\", \"del class to be executed, which is shown in the following code example:\\n\\n```\\nprivate async Task Navi\", \"gateAsync(string url) { ... Settings.AuthAccessToken = string.Empty; Settings.AuthIdToken = string.E\", \"mpty; IsLogin = false; LoginUrl = _identityService.CreateAuthorizationRequest(); ... }\\n```\\n\\nThis met\", \"hod clears both the identity token and the access token from application settings, and sets the IsLo\", \"gin property to false , which causes the WebView on the LoginView page to become invisible. Finally,\", \" the LoginUrl property is set to the URI of IdentityServer's authorization endpoint, with the requir\", \"ed parameters, in preparation for the next time the user initiates a sign-in.\\n\\nFor information about\", \" page navigation, see Navigation. For information about how WebView navigation causes a view model m\", \"ethod to be executed, see Invoking navigation using behaviors. For information about application set\", \"tings, see Configuration management.\\n\\nNote: The eShopOnContainers also allows a mock sign-out when t\", \"he app is configured to use mock services in the SettingsView . In this mode, the app doesn't commun\", \"icate with IdentityServer, and instead clears any stored tokens from application settings.\\n\\n## Autho\", \"rization\\n\\nAfter authentication, ASP.NET Core web APIs often need to authorize access, which allows a\", \" service to make APIs available to some authenticated users, but not to all.\\n\\nRestricting access to \", \"an ASP.NET Core MVC route can be achieved by applying an Authorize attribute to a controller or acti\", \"on, which limits access to the controller or action to authenticated users, as shown in the followin\", \"g code example:\\n\\n```\\n[Authorize] public class BasketController : Controller { ... }\\n```\\n\\nIf an unaut\", \"horized user attempts to access a controller or action that's marked with the Authorize attribute, t\", \"he MVC framework returns a 401 (unauthorized) HTTP status code.\\n\\nNote: Parameters can be specified o\", \"n the Authorize attribute to restrict an API to specific users. For more information, see Authorizat\", \"ion on the Microsoft Documentation Center.\\n\\nMobile App\\n\\n. ---\\n\\nSign-in\\n\\n-\\n\\nSecurity token\\n\\n\\u2022 -\\n\\nIden\", \"tity Microservice (STS+Users)\\n\\nWeb API\\n\\nContainer\\n\\nIdentityServer can be integrated into the authori\", \"zation workflow so that the access tokens it provides control authorization. This approach is shown \", \"in Figure 9-5.\\n\\nOrdering Microservice\\n\\n<!-- image -->\\n\\nThe eShopOnContainers mobile app communicates\", \" with the identity microservice and requests an access token as part of the authentication process. \", \"The access token is then forwarded to the APIs exposed by the ordering and basket microservices as p\", \"art of the access requests. Access tokens contain information about the client, and the user. APIs t\", \"hen use that information to authorize access to their data. For information about how to configure I\", \"dentityServer to protect APIs, see Configuring API resources.\\n\\n## Configuring IdentityServer to perf\", \"orm authorization\\n\\nTo perform authorization with IdentityServer, its authorization middleware must b\", \"e added to the web application's HTTP request pipeline. The middleware is added in the ConfigureAuth\", \" method in the web application's Startup class, which is invoked from the Configure method, and is d\", \"emonstrated in the following code example from the eShopOnContainers reference application:\\n\\n```\\npro\", \"tected virtual void ConfigureAuth(IApplicationBuilder app) { var identityUrl = Configuration.GetValu\", \"e<string>(\\\"IdentityUrl\\\"); app.UseIdentityServerAuthentication(new IdentityServerAuthenticationOption\", \"s { Authority = identityUrl.ToString(), ScopeName = \\\"basket\\\", RequireHttpsMetadata = false }); }\\n```\", \"\\n\\nThis method ensures that the API can only be accessed with a valid access token. The middleware va\", \"lidates the incoming token to ensure that it's sent from a trusted issuer, and validates that the to\", \"ken is valid to be used with the API that receives it. Therefore, browsing to the ordering or basket\", \" controller will return a 401 (unauthorized) HTTP status code, indicating that an access token is re\", \"quired.\\n\\nSQL Server database\\n\\nDocker Host\\n\\nNote: IdentityServer's authorization middleware must be a\", \"dded to the web application's HTTP request pipeline before adding MVC with app.UseMvc() or app.UseMv\", \"cWithDefaultRoute() .\\n\\n## Making access requests to APIs\\n\\nWhen making requests to the ordering and b\", \"asket microservices, the access token, obtained from IdentityServer during the authentication proces\", \"s, must be included in the request, as shown in the following code example:\\n\\n```\\nvar authToken = Set\", \"tings.AuthAccessToken; Order = await _ordersService.GetOrderAsync(Convert.ToInt32(order.OrderNumber)\", \", authToken);\\n```\\n\\nThe access token is stored as an application setting, and is retrieved from platf\", \"orm-specific storage and included in the call to the GetOrderAsync method in the OrderService class.\", \"\\n\\nSimilarly, the access token must be included when sending data to an IdentityServer protected API,\", \" as shown in the following code example:\\n\\n```\\nvar authToken = Settings.AuthAccessToken; await _baske\", \"tService.UpdateBasketAsync(new CustomerBasket { BuyerId = userInfo.UserId, Items = BasketItems.ToLis\", \"t() }, authToken);\\n```\\n\\nThe access token is retrieved from platform-specific storage and included in\", \" the call to the UpdateBasketAsync method in the BasketService class.\\n\\nThe RequestProvider class, in\", \" the eShopOnContainers mobile app, uses the HttpClient class to make requests to the RESTful APIs ex\", \"posed by the eShopOnContainers reference application. When making requests to the ordering and baske\", \"t APIs, which require authorization, a valid access token must be included with the request. This is\", \" achieved by adding the access token to the headers of the HttpClient instance, as demonstrated in t\", \"he following code example:\\n\\n```\\nhttpClient.DefaultRequestHeaders.Authorization = new AuthenticationH\", \"eaderValue(\\\"Bearer\\\", token);\\n```\\n\\nThe DefaultRequestHeaders property of the HttpClient class exposes\", \" the headers that are sent with each request, and the access token is added to the Authorization hea\", \"der prefixed with the string Bearer . When the request is sent to a RESTful API, the value of the Au\", \"thorization header is extracted and validated to ensure that it's sent from a trusted issuer, and us\", \"ed to determine whether the user has permission to invoke the API that receives it.\\n\\nFor more inform\", \"ation about how the eShopOnContainers mobile app makes web requests, see Accessing remote data.\\n\\n## \", \"Summary\\n\\nThere are many approaches to integrating authentication and authorization into a Xamarin.Fo\", \"rms app that communicates with an ASP.NET MVC web application. The eShopOnContainers mobile app perf\", \"orms authentication and authorization with a containerized identity microservice that uses IdentityS\", \"erver 4. IdentityServer is an open source OpenID Connect and OAuth 2.0 framework for ASP.NET Core th\", \"at integrates with ASP.NET Core Identity to perform bearer token authentication.\\n\\nThe mobile app req\", \"uests security tokens from IdentityServer, either for authenticating a user or for accessing a resou\", \"rce. When accessing a resource, an access token must be included in the request to APIs that require\", \" authorization. IdentityServer's middleware validates incoming access tokens to ensure that they are\", \" sent from a trusted issuer, and that they are valid to be used with the API that receives them.\\n\\n<!\", \"-- image -->\\n\\n## Accessing remote data\\n\\nMany modern web-based solutions make use of web services, ho\", \"sted by web servers, to provide functionality for remote client applications. The operations that a \", \"web service exposes constitute a web API.\\n\\nClient apps should be able to utilize the web API without\", \" knowing how the data or operations that the API exposes are implemented. This requires that the API\", \" abides by common standards that enable a client app and web service to agree on which data formats \", \"to use, and the structure of the data that is exchanged between client apps and the web service.\\n\\n##\", \" Introduction to Representational State Transfer\\n\\nRepresentational State Transfer (REST) is an archi\", \"tectural style for building distributed systems based on hypermedia. A primary advantage of the REST\", \" model is that it's based on open standards and doesn't bind the implementation of the model or the \", \"client apps that access it to any specific implementation. Therefore, a REST web service could be im\", \"plemented using Microsoft ASP.NET Core MVC, and client apps could be developing using any language a\", \"nd toolset that can generate HTTP requests and parse HTTP responses.\\n\\nThe REST model uses a navigati\", \"onal scheme to represent objects and services over a network, referred to as resources. Systems that\", \" implement REST typically use the HTTP protocol to transmit requests to access these resources. In s\", \"uch systems, a client app submits a request in the form of a URI that identifies a resource, and an \", \"HTTP method (such as GET, POST, PUT, or DELETE) that indicates the operation to be performed on that\", \" resource. The body of the HTTP request contains any data required to perform the operation.\\n\\nNote: \", \"REST defines a stateless request model. Therefore, HTTP requests must be independent and might occur\", \" in any order.\\n\\nThe response from a REST request makes use of standard HTTP status codes. For exampl\", \"e, a request that returns valid data should include the HTTP response code 200 (OK), while a request\", \" that fails to find or delete a specified resource should return a response that includes the HTTP s\", \"tatus code 404 (Not Found).\\n\\nA RESTful web API exposes a set of connected resources, and provides th\", \"e core operations that enable an app to manipulate those resources and easily navigate between them.\", \" For this reason, the URIs that constitute a typical RESTful web API are oriented towards the data t\", \"hat it exposes, and use the facilities provided by HTTP to operate on this data.\\n\\nThe data included \", \"by a client app in an HTTP request, and the corresponding response messages from the web server, cou\", \"ld be presented in a variety of formats, known as media types. When a client app sends a request tha\", \"t returns data in the body of a message, it can specify the media types it can handle in the Accept \", \"header of the request. If the web server supports this media type, it can reply with a response that\", \" includes the Content-Type header that specifies the format of the data in the body of the message. \", \"It's then the responsibility of the client app to parse the response message and interpret the resul\", \"ts in the message body appropriately.\\n\\nFor more information about REST, see API design and API imple\", \"mentation on Microsoft Docs.\\n\\n## Consuming RESTful APIs\\n\\nThe eShopOnContainers mobile app uses the M\", \"odel-View-ViewModel (MVVM) pattern, and the model elements of the pattern represent the domain entit\", \"ies used in the app. The controller and repository classes in the eShopOnContainers reference applic\", \"ation accept and return many of these model objects. Therefore, they are used as data transfer objec\", \"ts (DTOs) that hold all the data that is passed between the mobile app and the containerized microse\", \"rvices. The main benefit of using DTOs to pass data to and receive data from a web service is that b\", \"y transmitting more data in a single remote call, the app can reduce the number of remote calls that\", \" need to be made.\\n\\n## Making web requests\\n\\nThe eShopOnContainers mobile app uses the HttpClient clas\", \"s to make requests over HTTP, with JSON being used as the media type. This class provides functional\", \"ity for asynchronously sending HTTP requests and receiving HTTP responses from a URI identified reso\", \"urce. The HttpResponseMessage class represents an HTTP response message received from a REST API aft\", \"er an HTTP request has been made. It contains information about the response, including the status c\", \"ode, headers, and any body. The HttpContent class represents the HTTP body and content headers, such\", \" as Content-Type and Content-Encoding . The content can be read using any of the ReadAs methods, suc\", \"h as ReadAsStringAsync and ReadAsByteArrayAsync , depending on the format of the data.\\n\\n## Making a \", \"GET request\\n\\nThe CatalogService class is used to manage the data retrieval process from the catalog \", \"microservice. In the RegisterDependencies method in the ViewModelLocator class, the CatalogService c\", \"lass is registered as a type mapping against the ICatalogService type with the Autofac dependency in\", \"jection container. Then, when an instance of the CatalogViewModel class is created, its constructor \", \"accepts an ICatalogService type, which Autofac resolves, returning an instance of the CatalogService\", \" class. For more information about dependency injection, see Introduction to dependency injection.\\n\\n\", \"Figure 10-1 shows the interaction of classes that read catalog data from the catalog microservice fo\", \"r displaying by the CatalogView .\\n\\nCatalogViewModel\\n\\nGetCatalogAsync eShopOnContainers.Core\\n\\nRequest\", \"Provider\\n\\nCatalog.API\\n\\nCatalogController\\n\\nFigure 10-1 : Retrieving data from the catalog microservic\", \"e\\n\\n<!-- image -->\\n\\nWhen the CatalogView is navigated to, the OnInitialize method in the CatalogViewM\", \"odel class is called. This method retrieves catalog data from the catalog microservice, as demonstra\", \"ted in the following code example:\\n\\n```\\npublic override async Task InitializeAsync(object navigation\", \"Data) { ... Products = await _productsService.GetCatalogAsync(); ... }\\n```\\n\\nThis method calls the Ge\", \"tCatalogAsync method of the CatalogService instance that was injected into the CatalogViewModel by A\", \"utofac. The following code example shows the GetCatalogAsync method:\\n\\n```\\npublic async Task<Observab\", \"leCollection<CatalogItem>> GetCatalogAsync() { UriBuilder builder = new UriBuilder(GlobalSetting.Ins\", \"tance.CatalogEndpoint); builder.Path = \\\"api/v1/catalog/items\\\"; string uri = builder.ToString(); Cata\", \"logRoot catalog = await _requestProvider.GetAsync<CatalogRoot>(uri); ...\\n```\\n\\n```\\nreturn catalog?.Da\", \"ta.ToObservableCollection(); }\\n```\\n\\nThis method builds the URI that identifies the resource the requ\", \"est will be sent to, and uses the RequestProvider class to invoke the GET HTTP method on the resourc\", \"e, before returning the results to the CatalogViewModel . The RequestProvider class contains functio\", \"nality that submits a request in the form of a URI that identifies a resource, an HTTP method that i\", \"ndicates the operation to be performed on that resource, and a body that contains any data required \", \"to perform the operation. For information about how the RequestProvider class is injected into the C\", \"atalogService class, see Introduction to dependency injection.\\n\\nThe following code example shows the\", \" GetAsync method in the RequestProvider class:\\n\\n```\\npublic async Task<TResult> GetAsync<TResult>(str\", \"ing uri, string token = \\\"\\\") { HttpClient httpClient = CreateHttpClient(token); HttpResponseMessage r\", \"esponse = await httpClient.GetAsync(uri); await HandleResponse(response); string serialized = await \", \"response.Content.ReadAsStringAsync(); TResult result = await Task.Run(() => JsonConvert.DeserializeO\", \"bject<TResult>(serialized, _serializerSettings)); return result; }\\n```\\n\\nThis method calls the Create\", \"HttpClient method, which returns an instance of the HttpClient class with the appropriate headers se\", \"t. It then submits an asynchronous GET request to the resource identified by the URI, with the respo\", \"nse being stored in the HttpResponseMessage instance. The HandleResponse method is then invoked, whi\", \"ch throws an exception if the response doesn't include a success HTTP status code. Then the response\", \" is read as a string, converted from JSON to a CatalogRoot object, and returned to the CatalogServic\", \"e .\\n\\nThe CreateHttpClient method is shown in the following code example:\\n\\n```\\nprivate HttpClient Cre\", \"ateHttpClient(string token = \\\"\\\") { var httpClient = new HttpClient(); httpClient.DefaultRequestHeade\", \"rs.Accept.Add( new MediaTypeWithQualityHeaderValue(\\\"application/json\\\")); if (!string.IsNullOrEmpty(t\", \"oken)) { httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\\\"Bearer\\\", to\", \"ken); } return httpClient; }\\n```\\n\\nThis method creates a new instance of the HttpClient class, and se\", \"ts the Accept header of any requests made by the HttpClient instance to application/json , which ind\", \"icates that it expects the content of any response to be formatted using JSON. Then, if an access to\", \"ken was passed as an argument to the CreateHttpClient method, it's added to the Authorization header\", \" of any requests made by the HttpClient instance, prefixed with the string Bearer . For more informa\", \"tion about authorization, see Authorization.\\n\\nWhen the GetAsync method in the RequestProvider class \", \"calls HttpClient.GetAsync , the Items method in the CatalogController class in the Catalog.API proje\", \"ct is invoked, which is shown in the following code example:\\n\\n```\\n[HttpGet] [Route(\\\"[action]\\\")] publ\", \"ic async Task<IActionResult> Items( [FromQuery]int pageSize = 10, [FromQuery]int pageIndex = 0) { va\", \"r totalItems = await _catalogContext.CatalogItems .LongCountAsync(); var itemsOnPage = await _catalo\", \"gContext.CatalogItems .OrderBy(c=>c.Name) .Skip(pageSize * pageIndex) .Take(pageSize) .ToListAsync()\", \"; itemsOnPage = ComposePicUri(itemsOnPage); var model = new PaginatedItemsViewModel<CatalogItem>( pa\", \"geIndex, pageSize, totalItems, itemsOnPage); return Ok(model); }\\n```\\n\\nThis method retrieves the cata\", \"log data from the SQL database using EntityFramework, and returns it as a response message that incl\", \"udes a success HTTP status code, and a collection of JSON formatted CatalogItem instances.\\n\\n## Makin\", \"g a POST request\\n\\nThe BasketService class is used to manage the data retrieval and update process wi\", \"th the basket microservice. In the RegisterDependencies method in the ViewModelLocator class, the Ba\", \"sketService class is registered as a type mapping against the IBasketService type with the Autofac d\", \"ependency injection container. Then, when an instance of the BasketViewModel class is created, its c\", \"onstructor accepts an IBasketService type, which Autofac resolves, returning an instance of the Bask\", \"etService class. For more information about dependency injection, see Introduction to dependency inj\", \"ection.\\n\\nFigure 10-2 shows the interaction of classes that send the basket data displayed by the Bas\", \"ketView , to the basket microservice.\\n\\nBasketViewModel\\n\\nUpdateBasketAsync eShopOnContainers.Core\\n\\nRe\", \"questProvider\\n\\nBasket.API\\n\\nBasketController\\n\\nFigure 10-2 : Sending data to the basket microservice\\n\\n\", \"<!-- image -->\\n\\nWhen an item is added to the shopping basket, the ReCalculateTotalAsync method in th\", \"e BasketViewModel class is called. This method updates the total value of items in the basket, and s\", \"ends the basket data to the basket microservice, as demonstrated in the following code example:\\n\\n```\", \"\\nprivate async Task ReCalculateTotalAsync() { ... await _basketService.UpdateBasketAsync(new Custome\", \"rBasket { BuyerId = userInfo.UserId, Items = BasketItems.ToList() }, authToken); }\\n```\\n\\nThis method \", \"calls the UpdateBasketAsync method of the BasketService instance that was injected into the BasketVi\", \"ewModel by Autofac. The following method shows the UpdateBasketAsync method:\\n\\n```\\npublic async Task<\", \"CustomerBasket> UpdateBasketAsync(CustomerBasket customerBasket, string token) { UriBuilder builder \", \"= new UriBuilder(GlobalSetting.Instance.BasketEndpoint); string uri = builder.ToString();\\n```\\n\\n```\\nv\", \"ar result = await _requestProvider.PostAsync(uri, customerBasket, token); return result; }\\n```\\n\\nThis\", \" method builds the URI that identifies the resource the request will be sent to, and uses the Reques\", \"tProvider class to invoke the POST HTTP method on the resource, before returning the results to the \", \"BasketViewModel . Note that an access token, obtained from IdentityServer during the authentication \", \"process, is required to authorize requests to the basket microservice. For more information about au\", \"thorization, see Authorization.\\n\\nThe following code example shows one of the PostAsync methods in th\", \"e RequestProvider class:\\n\\n```\\npublic async Task<TResult> PostAsync<TResult>( string uri, TResult dat\", \"a, string token = \\\"\\\", string header = \\\"\\\") { HttpClient httpClient = CreateHttpClient(token); ... var\", \" content = new StringContent(JsonConvert.SerializeObject(data)); content.Headers.ContentType = new M\", \"ediaTypeHeaderValue(\\\"application/json\\\"); HttpResponseMessage response = await httpClient.PostAsync(u\", \"ri, content); await HandleResponse(response); string serialized = await response.Content.ReadAsStrin\", \"gAsync(); TResult result = await Task.Run(() => JsonConvert.DeserializeObject<TResult>(serialized, _\", \"serializerSettings)); return result; }\\n```\\n\\nThis method calls the CreateHttpClient method, which ret\", \"urns an instance of the HttpClient class with the appropriate headers set. It then submits an asynch\", \"ronous POST request to the resource identified by the URI, with the serialized basket data being sen\", \"t in JSON format, and the response being stored in the HttpResponseMessage instance. The HandleRespo\", \"nse method is then invoked, which throws an exception if the response doesn't include a success HTTP\", \" status code. Then, the response is read as a string, converted from JSON to a CustomerBasket object\", \", and returned to the BasketService . For more information about the CreateHttpClient method, see Ma\", \"king a GET request.\\n\\nWhen the PostAsync method in the RequestProvider class calls HttpClient.PostAsy\", \"nc , the Post method in the BasketController class in the Basket.API project is invoked, which is sh\", \"own in the following code example:\\n\\n```\\n[HttpPost] public async Task<IActionResult> Post([FromBody]C\", \"ustomerBasket value) { var basket = await _repository.UpdateBasketAsync(value); return Ok(basket); }\", \"\\n```\\n\\nThis method uses an instance of the RedisBasketRepository class to persist the basket data to \", \"the Redis cache, and returns it as a response message that includes a success HTTP status code, and \", \"a JSON formatted CustomerBasket instance.\\n\\n## Making a DELETE request\\n\\nFigure 10-3 shows the interac\", \"tions of classes that delete basket data from the basket microservice, for the CheckoutView .\\n\\nCheck\", \"outViewModel\\n\\nClearBasketAsync eShopOnContainers.Core\\n\\nRequestProvider\\n\\nBasket.API\\n\\nBasketController\", \"\\n\\nFigure 10-3 : Deleting data from the basket microservice\\n\\n<!-- image -->\\n\\nWhen the checkout proces\", \"s is invoked, the CheckoutAsync method in the CheckoutViewModel class is called. This method creates\", \" a new order, before clearing the shopping basket, as demonstrated in the following code example:\\n\\n`\", \"``\\nprivate async Task CheckoutAsync() { ... await _basketService.ClearBasketAsync(_shippingAddress.I\", \"d.ToString(), authToken); ... }\\n```\\n\\nThis method calls the ClearBasketAsync method of the BasketServ\", \"ice instance that was injected into the CheckoutViewModel by Autofac. The following method shows the\", \" ClearBasketAsync method:\\n\\n```\\npublic async Task ClearBasketAsync(string guidUser, string token) { U\", \"riBuilder builder = new UriBuilder(GlobalSetting.Instance.BasketEndpoint); builder.Path = guidUser; \", \"string uri = builder.ToString(); await _requestProvider.DeleteAsync(uri, token); }\\n```\\n\\nThis method \", \"builds the URI that identifies the resource that the request will be sent to, and uses the RequestPr\", \"ovider class to invoke the DELETE HTTP method on the resource. Note that an access token, obtained f\", \"rom IdentityServer during the authentication process, is required to authorize requests to the baske\", \"t microservice. For more information about authorization, see Authorization.\\n\\nThe following code exa\", \"mple shows the DeleteAsync method in the RequestProvider class:\\n\\n```\\npublic async Task DeleteAsync(s\", \"tring uri, string token = \\\"\\\") { HttpClient httpClient = CreateHttpClient(token); await httpClient.De\", \"leteAsync(uri); }\\n```\\n\\nThis method calls the CreateHttpClient method, which returns an instance of t\", \"he HttpClient class with the appropriate headers set. It then submits an asynchronous DELETE request\", \" to the resource identified by the URI. For more information about the CreateHttpClient method, see \", \"Making a GET request.\\n\\nWhen the DeleteAsync method in the RequestProvider class calls HttpClient.Del\", \"eteAsync , the Delete method in the BasketController class in the Basket.API project is invoked, whi\", \"ch is shown in the following code example:\\n\\n```\\n[HttpDelete(\\\"{id}\\\")] public void Delete(string id) {\", \" _repository.DeleteBasketAsync(id); }\\n```\\n\\nThis method uses an instance of the RedisBasketRepository\", \" class to delete the basket data from the Redis cache.\\n\\n## Caching data\\n\\nThe performance of an app c\", \"an be improved by caching frequently accessed data to fast storage that's located close to the app. \", \"If the fast storage is located closer to the app than the original source, then caching can signific\", \"antly improve response times when retrieving data.\\n\\nThe most common form of caching is read-through \", \"caching, where an app retrieves data by referencing the cache. If the data isn't in the cache, it's \", \"retrieved from the data store and added to the cache. Apps can implement read-through caching with t\", \"he cache-aside pattern. This pattern determines whether the item is currently in the cache. If the i\", \"tem isn't in the cache, it's read from the data store and added to the cache. For more information, \", \"see the Cache-Aside pattern on Microsoft Docs.\\n\\nTip: Cache data that's read frequently and that chan\", \"ges infrequently\\n\\nThis data can be added to the cache on demand the first time it is retrieved by an\", \" app. This means that the app needs to fetch the data only once from the data store, and that subseq\", \"uent access can be satisfied by using the cache.\\n\\nDistributed applications, such as the eShopOnConta\", \"iners reference application, should provide either or both of the following caches:\\n\\n- A shared cach\", \"e, which can be accessed by multiple processes or machines.\\n- A private cache, where data is held lo\", \"cally on the device running the app.\\n\\nThe eShopOnContainers mobile app uses a private cache, where d\", \"ata is held locally on the device that's running an instance of the app. For information about the c\", \"ache used by the eShopOnContainers reference application, see .NET Microservices: Architecture for C\", \"ontainerized .NET Applications.\\n\\nTip: Think of the cache as a transient data store that could disapp\", \"ear at any time\\n\\nEnsure that data is maintained in the original data store as well as the cache. The\", \" chances of losing data are then minimized if the cache becomes unavailable.\\n\\n## Managing data expir\", \"ation\\n\\nIt's impractical to expect that cached data will always be consistent with the original data.\", \" Data in the original data store might change after it's been cached, causing the cached data to bec\", \"ome stale. Therefore, apps should implement a strategy that helps to ensure that the data in the cac\", \"he is as upto-date as possible, but can also detect and handle situations that arise when the data i\", \"n the cache has become stale. Most caching mechanisms enable the cache to be configured to expire da\", \"ta, and hence reduce the period for which data might be out of date.\\n\\nTip: Set a default expiration \", \"time when configuring a cache\\n\\nMany caches implement expiration, which invalidates data and removes \", \"it from the cache if it's not accessed for a specified period. However, care must be taken when choo\", \"sing the expiration period. If it's made too short, data will expire too quickly and the benefits of\", \" caching will be reduced. If it's made too long, the data risks becoming stale. Therefore, the expir\", \"ation time should match the pattern of access for apps that use the data.\\n\\nWhen cached data expires,\", \" it should be removed from the cache, and the app must retrieve the data from the original data stor\", \"e and place it back into the cache.\\n\\nIt's also possible that a cache might fill up if data is allowe\", \"d to remain for too long a period. Therefore, requests to add new items to the cache might be requir\", \"ed to remove some items in a process known as eviction . Caching services typically evict data on a \", \"least-recently-used basis. However, there are other eviction policies, including most-recently-used,\", \" and first-in-first-out. For more information, see Caching Guidance on Microsoft Docs.\\n\\n## Caching i\", \"mages\\n\\nThe eShopOnContainers mobile app consumes remote product images that benefit from being cache\", \"d. These images are displayed by the Image control, and the CachedImage control provided by the FFIm\", \"ageLoading library.\\n\\nThe Xamarin.Forms Image control supports caching of downloaded images. Caching \", \"is enabled by default, and will store the image locally for 24 hours. In addition, the expiration ti\", \"me can be configured with the CacheValidity property. For more information, see Downloaded Image Cac\", \"hing on the Xamarin Developer Center.\\n\\nFFImageLoading's CachedImage control is a replacement for the\", \" Xamarin.Forms Image control, providing additional properties that enable supplementary functionalit\", \"y. Amongst this functionality, the control provides configurable caching, while supporting error and\", \" loading image placeholders. The following code example shows how the eShopOnContainers mobile app u\", \"ses the CachedImage control in the ProductTemplate , which is the data template used by the ListView\", \" control in the CatalogView :\\n\\n```\\n<ffimageloading:CachedImage Grid.Row=\\\"0\\\" Source=\\\"{Binding Picture\", \"Uri}\\\" Aspect=\\\"AspectFill\\\"> <ffimageloading:CachedImage.LoadingPlaceholder> <OnPlatform x:TypeArgumen\", \"ts=\\\"ImageSource\\\"\\n```\\n\\n```\\niOS=\\\"default_product\\\" Android=\\\"default_product\\\" WinPhone=\\\"Assets/default_p\", \"roduct.png\\\"/> </ffimageloading:CachedImage.LoadingPlaceholder> <ffimageloading:CachedImage.ErrorPlac\", \"eholder> <OnPlatform x:TypeArguments=\\\"ImageSource\\\" iOS=\\\"noimage\\\" Android=\\\"noimage\\\" WinPhone=\\\"Assets/\", \"noimage.png\\\"/> </ffimageloading:CachedImage.ErrorPlaceholder> </ffimageloading:CachedImage>\\n```\\n\\nThe\", \" CachedImage control sets the LoadingPlaceholder and ErrorPlaceholder properties to platform-specifi\", \"c images. The LoadingPlaceholder property specifies the image to be displayed while the image specif\", \"ied by the Source property is retrieved, and the ErrorPlaceholder property specifies the image to be\", \" displayed if an error occurs when attempting to retrieve the image specified by the Source property\", \".\\n\\nAs the name implies, the CachedImage control caches remote images on the device for the time spec\", \"ified by the value of the CacheDuration property. When this property value isn't explicitly set, the\", \" default value of 30 days is applied.\\n\\n## Increasing resilience\\n\\nAll apps that communicate with remo\", \"te services and resources must be sensitive to transient faults. Transient faults include the moment\", \"ary loss of network connectivity to services, the temporary unavailability of a service, or timeouts\", \" that arise when a service is busy. These faults are often selfcorrecting, and if the action is repe\", \"ated after a suitable delay it's likely to succeed.\\n\\nTransient faults can have a huge impact on the \", \"perceived quality of an app, even if it has been thoroughly tested under all foreseeable circumstanc\", \"es. To ensure that an app that communicates with remote services operates reliably, it must be able \", \"to do all of the following:\\n\\n- Detect faults when they occur, and determine if the faults are likely\", \" to be transient.\\n- Retry the operation if it determines that the fault is likely to be transient an\", \"d keep track of the number of times the operation was retried.\\n- Use an appropriate retry strategy, \", \"which specifies the number of retries, the delay between each attempt, and the actions to take after\", \" a failed attempt.\\n\\nThis transient fault handling can be achieved by wrapping all attempts to access\", \" a remote service in code that implements the retry pattern.\\n\\n## Retry pattern\\n\\nIf an app detects a \", \"failure when it tries to send a request to a remote service, it can handle the failure in any of the\", \" following ways:\\n\\n- Retrying the operation. The app could retry the failing request immediately.\\n- R\", \"etrying the operation after a delay. The app should wait for a suitable amount of time before retryi\", \"ng the request.\\n- Cancelling the operation. The application should cancel the operation and report a\", \"n exception.\\n\\nThe retry strategy should be tuned to match the business requirements of the app. For \", \"example, it's important to optimize the retry count and retry interval to the operation being attemp\", \"ted. If the operation is part of a user interaction, the retry interval should be short and only a f\", \"ew retries attempted to avoid making users wait for a response. If the operation is part of a long r\", \"unning workflow, where cancelling or restarting the workflow is expensive or time-consuming, it's ap\", \"propriate to wait longer between attempts and to retry more times.\\n\\nNote: An aggressive retry strate\", \"gy with minimal delay between attempts, and a large number of retries, could degrade a remote servic\", \"e that's running close to or at capacity. In addition, such a retry strategy could also affect the r\", \"esponsiveness of the app if it's continually trying to perform a failing operation.\\n\\nIf a request st\", \"ill fails after a number of retries, it's better for the app to prevent further requests going to th\", \"e same resource and to report a failure. Then, after a set period, the app can make one or more requ\", \"ests to the resource to see if they're successful. For more information, see Circuit breaker pattern\", \".\\n\\nTip: Never implement an endless retry mechanism\\n\\nUse a finite number of retries, or implement the\", \" Circuit Breaker pattern to allow a service to recover.\\n\\nThe eShopOnContainers mobile app does not c\", \"urrently implement the retry pattern when making RESTful web requests. However, the CachedImage cont\", \"rol, provided by the FFImageLoading library supports transient fault handling by retrying image load\", \"ing. If image loading fails, further attempts will be made. The number of attempts is specified by t\", \"he RetryCount property, and retries will occur after a delay specified by the RetryDelay property. I\", \"f these property values aren't explicitly set, their default values are applied -3 for the RetryCoun\", \"t property, and 250ms for the RetryDelay property. For more information about the CachedImage contro\", \"l, see Caching images.\\n\\nThe eShopOnContainers reference application does implement the retry pattern\", \". For more information, including a discussion of how to combine the retry pattern with the HttpClie\", \"nt class, see .NET Microservices: Architecture for Containerized .NET Applications.\\n\\nFor more inform\", \"ation about the retry pattern, see the Retry pattern on Microsoft Docs.\\n\\n## Circuit breaker pattern\\n\", \"\\nIn some situations, faults can occur due to anticipated events that take longer to fix. These fault\", \"s can range from a partial loss of connectivity to the complete failure of a service. In these situa\", \"tions, it's pointless for an app to retry an operation that's unlikely to succeed, and instead shoul\", \"d accept that the operation has failed and handle this failure accordingly.\\n\\nThe circuit breaker pat\", \"tern can prevent an app from repeatedly trying to execute an operation that's likely to fail, while \", \"also enabling the app to detect whether the fault has been resolved.\\n\\nNote: The purpose of the circu\", \"it breaker pattern is different from the retry pattern. The retry pattern enables an app to retry an\", \" operation in the expectation that it'll succeed. The circuit breaker pattern prevents an app from p\", \"erforming an operation that's likely to fail.\\n\\nA circuit breaker acts as a proxy for operations that\", \" might fail. The proxy should monitor the number of recent failures that have occurred, and use this\", \" information to decide whether to allow the operation to proceed, or to return an exception immediat\", \"ely.\\n\\nThe eShopOnContainers mobile app does not currently implement the circuit breaker pattern. How\", \"ever, the eShopOnContainers does. For more information, see .NET Microservices: Architecture for Con\", \"tainerized .NET Applications.\\n\\nTip: Combine the retry and circuit breaker patterns\\n\\nAn app can combi\", \"ne the retry and circuit breaker patterns by using the retry pattern to invoke an operation through \", \"a circuit breaker. However, the retry logic should be sensitive to any exceptions returned by the ci\", \"rcuit breaker and abandon retry attempts if the circuit breaker indicates that a fault is not transi\", \"ent.\\n\\nFor more information about the circuit breaker pattern, see the Circuit Breaker pattern on Mic\", \"rosoft Docs.\\n\\n## Summary\\n\\nMany modern web-based solutions make use of web services, hosted by web se\", \"rvers, to provide functionality for remote client applications. The operations that a web service ex\", \"poses constitute a web API, and client apps should be able to utilize the web API without knowing ho\", \"w the data or operations that the API exposes are implemented.\\n\\nThe performance of an app can be imp\", \"roved by caching frequently accessed data to fast storage that's located close to the app. Apps can \", \"implement read-through caching with the cache-aside pattern. This pattern determines whether the ite\", \"m is currently in the cache. If the item isn't in the cache, it's read from the data store and added\", \" to the cache.\\n\\nWhen communicating with web APIs, apps must be sensitive to transient faults. Transi\", \"ent faults include the momentary loss of network connectivity to services, the temporary unavailabil\", \"ity of a service, or timeouts that arise when a service is busy. These faults are often self-correct\", \"ing, and if the action is repeated after a suitable delay, then it's likely to succeed. Therefore, a\", \"pps should wrap all attempts to access a web API in code that implements a transient fault handling \", \"mechanism.\\n\\n## Unit testing\\n\\nMobile apps have unique problems that desktop and web-based application\", \"s don't have to worry about. Mobile users will differ by the devices that they use, by network conne\", \"ctivity, by the availability of services, and a range of other factors. Therefore, mobile apps shoul\", \"d be tested as they will be used in the real world in order to improve their quality, reliability, a\", \"nd performance. There are many types of testing that should be performed on an app, including unit t\", \"esting, integration testing, and user interface testing, with unit testing being the most common for\", \"m of testing.\\n\\nA unit test takes a small unit of the app, typically a method, isolates it from the r\", \"emainder of the code, and verifies that it behaves as expected. Its goal is to check that each unit \", \"of functionality performs as expected, so that errors don't propagate throughout the app. Detecting \", \"a bug where it occurs is more efficient that observing the effect of a bug indirectly at a secondary\", \" point of failure.\\n\\nUnit testing has the greatest effect on code quality when it's an integral part \", \"of the software development workflow. As soon as a method has been written, unit tests should be wri\", \"tten that verify the behavior of the method in response to standard, boundary, and incorrect cases o\", \"f input data, and that check any explicit or implicit assumptions made by the code. Alternatively, w\", \"ith test driven development, unit tests are written before the code. In this scenario, unit tests ac\", \"t as both design documentation and functional specifications.\\n\\nNote: Unit tests are very effective a\", \"gainst regression -that is, functionality that used to work but has been disturbed by a faulty updat\", \"e.\\n\\nUnit tests typically use the arrange-act-assert pattern:\\n\\n- The arrange section of the unit test\", \" method initializes objects and sets the value of the data that is passed to the method under test.\\n\", \"- The act section invokes the method under test with the required arguments.\\n- The assert section ve\", \"rifies that the action of the method under test behaves as expected.\\n\\nFollowing this pattern ensures\", \" that unit tests are readable and consistent.\\n\\n## Dependency injection and unit testing\\n\\nOne of the \", \"motivations for adopting a loosely-coupled architecture is that it facilitates unit testing. One of \", \"the types registered with Autofac is the OrderService class. The following code example shows an out\", \"line of this class:\\n\\n```\\npublic class OrderDetailViewModel : ViewModelBase { private IOrderService _\", \"ordersService; public OrderDetailViewModel(IOrderService ordersService)\\n```\\n\\n```\\n86 CHAPTER 11  |  U\", \"nit testing\\n```\\n\\n<!-- image -->\\n\\n\\u2022\\n\\nIOrderService\\n\\n```\\n{ _ordersService = ordersService; } ... }\\n```\", \"\\n\\nThe OrderDetailViewModel class has a dependency on the IOrderService type which the container reso\", \"lves when it instantiates a OrderDetailViewModel object. However, rather than create an OrderService\", \" object to unit test the OrderDetailViewModel class, instead, replace the OrderService object with a\", \" mock for the purpose of the tests. Figure 10-1 illustrates this relationship.\\n\\nFigure 10-1: Classes\", \" that implement the IOrderService interface\\n\\n<!-- image -->\\n\\nThis approach allows the OrderService o\", \"bject to be passed into the OrderDetailViewModel class at runtime, and in the interests of testabili\", \"ty, it allows the OrderMockService class to be passed into the OrderDetailViewModel class at test ti\", \"me. The main advantage of this approach is that it enables unit tests to be executed without requiri\", \"ng unwieldy resources such as web services, or databases.\\n\\n## Testing MVVM applications\\n\\nTesting mod\", \"els and view models from MVVM applications is identical to testing any other classes, and the same t\", \"ools and techniques -such as unit testing and mocking, can be used. However, there are some patterns\", \" that are typical to model and view model classes, that can benefit from specific unit testing techn\", \"iques.\\n\\nTip: Test one thing with each unit test\\n\\nDon't be tempted to make a unit test exercise more \", \"than one aspect of the unit's behavior. Doing so leads to tests that are difficult to read and updat\", \"e. It can also lead to confusion when interpreting a failure.\\n\\nThe eShopOnContainers mobile app uses\", \" xUnit to perform unit testing, which supports two different types of unit tests:\\n\\n- Facts are tests\", \" that are always true, which test invariant conditions.\\n- Theories are tests that are only true for \", \"a particular set of data.\\n\\nThe unit tests included with the eShopOnContainers mobile app are fact te\", \"sts, and so each unit test method is decorated with the [Fact] attribute.\\n\\nNote: xUnit tests are exe\", \"cuted by a test runner. To execute the test runner, run the eShopOnContainers.TestRunner project for\", \" the required platform.\\n\\n## Testing asynchronous functionality\\n\\nWhen implementing the MVVM pattern, \", \"view models usually invoke operations on services, often asynchronously. Tests for code that invokes\", \" these operations typically use mocks as replacements for the actual services. The following code ex\", \"ample demonstrates testing asynchronous functionality by passing a mock service into a view model:\\n\\n\", \"```\\n[Fact] public async Task OrderPropertyIsNotNullAfterViewModelInitializationTest() { var orderSer\", \"vice = new OrderMockService(); var orderViewModel = new OrderDetailViewModel(orderService); var orde\", \"r = await orderService.GetOrderAsync(1, GlobalSetting.Instance.AuthToken); await orderViewModel.Init\", \"ializeAsync(order); Assert.NotNull(orderViewModel.Order); }\\n```\\n\\nThis unit test checks that the Orde\", \"r property of the OrderDetailViewModel instance will have a value after the InitializeAsync method h\", \"as been invoked. The InitializeAsync method is invoked when the view model's corresponding view is n\", \"avigated to. For more information about navigation, see Navigation.\\n\\nWhen the OrderDetailViewModel i\", \"nstance is created, it expects an OrderService instance to be specified as an argument. However, the\", \" OrderService retrieves data from a web service. Therefore, an OrderMockService instance, which is a\", \" mock version of the OrderService class, is specified as the argument to the OrderDetailViewModel co\", \"nstructor. Then, when the view model's InitializeAsync method is invoked, which invokes IOrderServic\", \"e operations, mock data is retrieved rather than communicating with a web service.\\n\\n## Testing INoti\", \"fyPropertyChanged implementations\\n\\nImplementing the INotifyPropertyChanged interface allows views to\", \" react to changes that originate from view models and models. These changes are not limited to data \", \"shown in controls -they are also used to control the view, such as view model states that cause anim\", \"ations to be started or controls to be disabled.\\n\\nProperties that can be updated directly by the uni\", \"t test can be tested by attaching an event handler to the PropertyChanged event and checking whether\", \" the event is raised after setting a new value for the property. The following code example shows su\", \"ch a test:\\n\\n```\\n[Fact] public async Task SettingOrderPropertyShouldRaisePropertyChanged() { bool inv\", \"oked = false; var orderService = new OrderMockService(); var orderViewModel = new OrderDetailViewMod\", \"el(orderService); orderViewModel.PropertyChanged += (sender, e) => {\\n```\\n\\n```\\nif (e.PropertyName.Equ\", \"als(\\\"Order\\\")) invoked = true; }; var order = await orderService.GetOrderAsync(1, GlobalSetting.Insta\", \"nce.AuthToken); await orderViewModel.InitializeAsync(order); Assert.True(invoked); }\\n```\\n\\nThis unit \", \"test invokes the InitializeAsync method of the OrderViewModel class, which causes its Order property\", \" to be updated. The unit test will pass, provided that the PropertyChanged event is raised for the O\", \"rder property.\\n\\n## Testing message-based communication\\n\\nView models that use the MessagingCenter cla\", \"ss to communicate between loosely-coupled classes can be unit tested by subscribing to the message b\", \"eing sent by the code under test, as demonstrated in the following code example:\\n\\n```\\n[Fact] public \", \"void AddCatalogItemCommandSendsAddProductMessageTest() { bool messageReceived = false; var catalogSe\", \"rvice = new CatalogMockService(); var catalogViewModel = new CatalogViewModel(catalogService); Xamar\", \"in.Forms.MessagingCenter.Subscribe<CatalogViewModel, CatalogItem>( this, MessageKeys.AddProduct, (se\", \"nder, arg) => { messageReceived = true; }); catalogViewModel.AddCatalogItemCommand.Execute(null); As\", \"sert.True(messageReceived); }\\n```\\n\\nThis unit test checks that the CatalogViewModel publishes the Add\", \"Product message in response to its AddCatalogItemCommand being executed. Because the MessagingCenter\", \" class supports multicast message subscriptions, the unit test can subscribe to the AddProduct messa\", \"ge and execute a callback delegate in response to receiving it. This callback delegate, specified as\", \" a lambda expression, sets a boolean field that's used by the Assert statement to verify the behavio\", \"r of the test.\\n\\n## Testing exception handling\\n\\nUnit tests can also be written that check that specif\", \"ic exceptions are thrown for invalid actions or inputs, as demonstrated in the following code exampl\", \"e:\\n\\n```\\n[Fact] public void InvalidEventNameShouldThrowArgumentExceptionText() { var behavior = new M\", \"ockEventToCommandBehavior { EventName = \\\"OnItemTapped\\\" }; var listView = new ListView(); Assert.Thro\", \"ws<ArgumentException>(() => listView.Behaviors.Add(behavior)); }\\n```\\n\\nThis unit test will throw an e\", \"xception, because the ListView control does not have an event named OnItemTapped . The Assert.Throws\", \"&lt;T&gt; method is a generic method where T is the type of the expected exception. The argument pas\", \"sed to the Assert.Throws&lt;T&gt; method is a lambda expression that will throw the exception. There\", \"fore, the unit test will pass provided that the lambda expression throws an ArgumentException .\\n\\nTip\", \" : Avoid writing unit tests that examine exception message strings\\n\\nException message strings might \", \"change over time, and so unit tests that rely on their presence are regarded as brittle.\\n\\n## Testing\", \" validation\\n\\nThere are two aspects to testing the validation implementation: testing that any valida\", \"tion rules are correctly implemented, and testing that the ValidatableObject&lt;T&gt; class performs\", \" as expected.\\n\\nValidation logic is usually simple to test, because it is typically a self-contained \", \"process where the output depends on the input. There should be tests on the results of invoking the \", \"Validate method on each property that has at least one associated validation rule, as demonstrated i\", \"n the following code example:\\n\\n```\\n[Fact] public void CheckValidationPassesWhenBothPropertiesHaveDat\", \"aTest() { var mockViewModel = new MockViewModel(); mockViewModel.Forename.Value = \\\"John\\\"; mockViewMo\", \"del.Surname.Value = \\\"Smith\\\"; bool isValid = mockViewModel.Validate(); Assert.True(isValid); }\\n```\\n\\nT\", \"his unit test checks that validation succeeds when the two ValidatableObject&lt;T&gt; properties in \", \"the MockViewModel instance both have data.\\n\\nAs well as checking that validation succeeds, validation\", \" unit tests should also check the values of the Value , IsValid , and Errors property of each Valida\", \"tableObject&lt;T&gt; instance, to verify that the class performs as expected. The following code exa\", \"mple demonstrates a unit test that does this:\\n\\n```\\n[Fact] public void CheckValidationFailsWhenOnlyFo\", \"renameHasDataTest() { var mockViewModel = new MockViewModel(); mockViewModel.Forename.Value = \\\"John\\\"\", \"; bool isValid = mockViewModel.Validate(); Assert.False(isValid); Assert.NotNull(mockViewModel.Foren\", \"ame.Value); Assert.Null(mockViewModel.Surname.Value); Assert.True(mockViewModel.Forename.IsValid); A\", \"ssert.False(mockViewModel.Surname.IsValid); Assert.Empty(mockViewModel.Forename.Errors); Assert.NotE\", \"mpty(mockViewModel.Surname.Errors); }\\n```\\n\\nThis unit test checks that validation fails when the Surn\", \"ame property of the MockViewModel doesn't have any data, and the Value , IsValid , and Errors proper\", \"ty of each ValidatableObject&lt;T&gt; instance are correctly set.\\n\\n## Summary\\n\\nA unit test takes a s\", \"mall unit of the app, typically a method, isolates it from the remainder of the code, and verifies t\", \"hat it behaves as expected. Its goal is to check that each unit of functionality performs as expecte\", \"d, so that errors don't propagate throughout the app.\\n\\nThe behavior of an object under test can be i\", \"solated by replacing dependent objects with mock objects that simulate the behavior of the dependent\", \" objects. This enables unit tests to be executed without requiring unwieldy resources such as web se\", \"rvices, or databases.\\n\\nTesting models and view models from MVVM applications is identical to testing\", \" any other classes, and the same tools and techniques can be used.\\n\\n92\\n\\nCHAPTER 11  |  Unit testing \", \"Visit our NET Architecture Center\"]"