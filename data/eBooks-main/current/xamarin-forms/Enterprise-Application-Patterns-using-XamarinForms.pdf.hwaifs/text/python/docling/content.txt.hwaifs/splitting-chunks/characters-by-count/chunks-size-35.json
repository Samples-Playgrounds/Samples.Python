"[\"## Book title Book subtitle\\n\\nPUBLISHED BY\\n\\nDevDiv, .NET and Visual Studio produc teams A division of\", \" Microsoft Corporation One Microsoft Way Redmond, Washington 98052-6399\\n\\nCopyright \\u00a9 2017 by Microso\", \"ft Corporation\\n\\nAll rights reserved. No part of the contents of this book may be reproduced or trans\", \"mitted in any form or by any means without the written permission of the publisher.\\n\\nT his book is p\", \"rovided 'as -is' and expresses the author's views and opinions. The views, opinions and information \", \"expressed in this book, including URL and other Internet website references, may change without noti\", \"ce.\\n\\nSome examples depicted herein are provided for illustration only and are fictitious. No real as\", \"sociation or connection is intended or should be inferred.\\n\\nMicrosoft and the trademarks listed at h\", \"ttp://www.microsoft.com on the 'Trademarks' webpage are trademarks of the Microsoft group of compani\", \"es. All other marks are property of their respective owners.\\n\\nAuthor:\\n\\nDavid Britch\\n\\nDeveloper:\\n\\nJav\", \"ier Suarez Ruiz (Plain Concepts)\\n\\nParticipants and reviewers:\\n\\nCraig Dunn, Tom Opgenorth\\n\\nEditor:\\n\\nJ\", \"ohn Meade (Populus Group)\\n\\n## Contents\\n\\n| Preface ..................................................\", \"......................................................................... iv                 |\\n|----\", \"----------------------------------------------------------------------------------------------------\", \"------------------------------------------------|\\n| Purpose ........................................\", \"..........................................................................................iv        \", \"   |\\n| What's left out of this guide's scope .......................................................\", \".......................................iv                 |\\n| Who should use this guide ............\", \".................................................................................................iv \", \"             |\\n| How to use this guide .............................................................\", \".........................................................v          |\\n| Introduction ...............\", \"....................................................................................................\", \".1                     |\\n| Sample application.......................................................\", \"............................................................2                 |\\n| Sample application\", \" architecture.......................................................................................\", \"...............2                 |\\n| Mobile app.....................................................\", \"..................................................................................4     |\\n| eShopOnC\", \"ontainers.Core project .............................................................................\", \"......................5                    |\\n| Platform projects ...................................\", \".........................................................................................6        |\\n\", \"| Summary ..........................................................................................\", \".......................................6             |\\n| MVVM.......................................\", \"......................................................................................7             \", \"        |\\n| The MVVMpattern ........................................................................\", \"..........................................7                    |\\n| View.............................\", \"....................................................................................................\", \"................8 |\\n| ViewModel.....................................................................\", \"..................................................................8      |\\n| Model..................\", \"....................................................................................................\", \".........................9  |\\n| Connecting view models to views ....................................\", \".........................................................9                         |\\n| Creating a vi\", \"ew model declaratively .............................................................................\", \"................10                    |\\n| Creating a view model programmatically ...................\", \"..................................................................10                         |\\n| Cre\", \"ating a view defined as a data template.............................................................\", \".....................11                         |\\n| Automatically creating a view model with a view \", \"model locator.................................................11                                    \", \"   |\\n| Updating views in response to changes in the underlying view model or model..................\", \".....12                                                   |\\n| UI interaction using commands and beha\", \"viors ........................................................................13                    \", \"             |\\n| Implementing commands..............................................................\", \"................................................14                  |\\n| Implementing behaviors......\", \"....................................................................................................\", \"......15               |\\n| Summary .................................................................\", \"..............................................................17              |\\n| Dependency injecti\", \"on .................................................................................................\", \"... 18                           |\\n| Introduction to dependency injection ..........................\", \"...........................................................18                           |\\n| Registra\", \"tion ...............................................................................................\", \"............................20             |\\n| Resolution...........................................\", \"...................................................................................22             |\\n\", \"| Managing the lifetime of resolved objects.........................................................\", \"......................22                             |\\n\\n| Communicating between loosely coupled comp\", \"onents ..................................................                                       | 24\", \"                                                                                                    \", \"                    |\\n|-----------------------------------------------------------------------------\", \"--------------------------------------------------------------|-------------------------------------\", \"--------------------------------------------------------------------------------------|\\n| Introducti\", \"on to MessagingCenter...............................................................................\", \".............24             |                                                                       \", \"                                                    |\\n| Defining a message..........................\", \".......................................................................................26     |     \", \"                                                                                                    \", \"                  |\\n| Publishing a message..........................................................\", \"....................................................26      |                                       \", \"                                                                                    |\\n| Subscribing \", \"to a message........................................................................................\", \"................27        |                                                                         \", \"                                                  |\\n| Unsubscribing from a message..................\", \"..............................................................................27            |       \", \"                                                                                                    \", \"                |\\n| Summary ........................................................................\", \".......................................................27 |                                         \", \"                                                                                  |\\n| Navigation....\", \"....................................................................................................\", \".............           | 28                                                                        \", \"                                                |\\n| Navigating between pages........................\", \"..............................................................................29          |         \", \"                                                                                                    \", \"              |\\n| Creating the NavigationService instance...........................................\", \"............................................29          |                                           \", \"                                                                                |\\n| Handling navigat\", \"ion requests........................................................................................\", \"................30    |                                                                             \", \"                                              |\\n| Navigating when the app is launched ..............\", \".............................................................................32         |           \", \"                                                                                                    \", \"            |\\n| Passing parameters during navigation ...............................................\", \"...........................................33         |                                             \", \"                                                                              |\\n| Invoking navigatio\", \"n using behaviors ..................................................................................\", \"...........34       |                                                                               \", \"                                            |\\n| Confirming or cancelling navigation.................\", \".............................................................................34       |             \", \"                                                                                                    \", \"          |\\n| Summary ..............................................................................\", \".................................................35 |                                               \", \"                                                                            |\\n| Validation..........\", \"....................................................................................................\", \"........          | 36                                                                              \", \"                                          |\\n| Specifying validation rules                           \", \"                                                                                    | ..............\", \"........................................................................................37          \", \"        |\\n| Adding validation rules to a property...................................................\", \"...................................38             |                                                 \", \"                                                                          |\\n| Triggering validation.\", \"....................................................................................................\", \"..........39    |                                                                                   \", \"                                        |\\n| Triggering validation manually                          \", \"                                                                                  | ................\", \"......................................................................................39            \", \"      |\\n| Triggering validation when properties change..............................................\", \"................................40              |                                                   \", \"                                                                        |\\n| Displaying validation er\", \"rors ...............................................................................................\", \".....40       |                                                                                     \", \"                                      |\\n| Highlighting a control that contains invalid data         \", \"                                                                                | ..................\", \"........................................................41                                          \", \"    |\\n| Displaying error messages...................................................................\", \"..........................................44  |                                                     \", \"                                                                      |\\n| Summary ..................\", \"....................................................................................................\", \".........45 |                                                                                       \", \"                                    |\\n| Configuration management ...................................\", \"........................................................                      | 46                  \", \"                                                                                                    \", \"  |\\n| Creating a settings class.....................................................................\", \".....................................46     |                                                       \", \"                                                                    |\\n| Adding a setting ...........\", \"....................................................................................................\", \"......47  |                                                                                         \", \"                                  |\\n| Data binding to user settings ................................\", \"..................................................................48        |                       \", \"                                                                                                    \", \"|\\n| Summary ........................................................................................\", \".......................................50 |                                                         \", \"                                                                  |\\n| Containerized microservices...\", \"........................................................................................            \", \"        | 51                                                                                        \", \"                                |\\n| Microservices...................................................\", \"......................................................................52  |                         \", \"                                                                                                  |\\n\", \"| Containerization..................................................................................\", \"...................................53   |                                                           \", \"                                                                |\\n| Communication between client and\", \" microservices ..................................................................55                 \", \"      |                                                                                             \", \"                              |\\n| Communication between microservices...............................\", \"...................................................56                   |                           \", \"                                                                                                |\\n| \", \"Summary ............................................................................................\", \"...................................58 |                                                             \", \"                                                              |\\n| Authentication and authorization .\", \".................................................................................                   \", \"    | 59                                                                                            \", \"                            |\\n| Authentication                                                      \", \"                                                                      | ............................\", \"...........................................................................................59 |\\n| Is\", \"suing bearer tokens using IdentityServer 4 .........................................................\", \".......................60           |                                                               \", \"                                                            |\\n| Adding IdentityServer to a web appli\", \"cation..................................................................................60          \", \"  |                                                                                                 \", \"                          |\\n| Configuring IdentityServer                                            \", \"                                                                    | ..............................\", \"..............................................................................61            |\\n\\n| Per\", \"forming authentication .............................................................................\", \"...............................64          |\\n|------------------------------------------------------\", \"---------------------------------------------------------------------------------------------|\\n| Aut\", \"horization..........................................................................................\", \"...............................69          |\\n| Configuring IdentityServer to perform authorization .\", \"..................................................................70                         |\\n| Mak\", \"ing access requests to APIs.........................................................................\", \"............................71             |\\n| Summary .............................................\", \"..................................................................................71         |\\n| Acc\", \"essing remote data..................................................................................\", \"................. 73                       |\\n| Introduction to Representational State Transfer......\", \"................................................................73                           |\\n| Con\", \"suming RESTful APIs ................................................................................\", \".........................74                |\\n| Making web requests .................................\", \"...................................................................................74        |\\n| Cac\", \"hing data ..........................................................................................\", \"................................81         |\\n| Managing data expiration ............................\", \".................................................................................82          |\\n| Cac\", \"hing images.........................................................................................\", \".....................................82    |\\n| Increasing resilience ...............................\", \"................................................................................83           |\\n| Ret\", \"ry pattern .........................................................................................\", \"........................................83 |\\n| Circuit breaker pattern .............................\", \".....................................................................................84      |\\n| Sum\", \"mary ...............................................................................................\", \"................................85         |\\n| Unit testing.........................................\", \"........................................................................... 86               |\\n| Dep\", \"endency injection and unit testing .................................................................\", \"...................86                      |\\n| Testing MVVMapplications.............................\", \".......................................................................87                    |\\n| Tes\", \"ting asynchronous functionality.....................................................................\", \"..........................88               |\\n| Testing INotifyPropertyChanged implementations.......\", \"................................................................88                           |\\n| Tes\", \"ting message-based communication ...................................................................\", \"....................89                     |\\n| Testing exception handling...........................\", \".................................................................................89          |\\n| Tes\", \"ting validation ....................................................................................\", \"......................................90   |\\n\\n## Preface\\n\\n## Purpose\\n\\nThis eBook provides guidance o\", \"n building cross-platform enterprise apps using Xamarin.Forms. Xamarin.Forms is a cross-platform UI \", \"toolkit that allows developers to easily create native user interface layouts that can be shared acr\", \"oss platforms, including iOS, Android, and the Universal Windows Platform (UWP). It provides a compr\", \"ehensive solution for Business to Employee (B2E), Business to Business (B2B), and Business to Consum\", \"er (B2C) apps, providing the ability to share code across all target platforms and helping to lower \", \"the total cost of ownership (TCO).\\n\\nThe guide provides architectural guidance for developing adaptab\", \"le, maintainable, and testable Xamarin.Forms enterprise apps. Guidance is provided on how to impleme\", \"nt MVVM, dependency injection, navigation, validation, and configuration management, while maintaini\", \"ng loose coupling. In addition, there's also guidance on performing authentication and authorization\", \" with IdentityServer, accessing data from containerized microservices, and unit testing.\\n\\nThe guide \", \"comes with source code for the eShopOnContainers mobile app, and source code for the eShopOnContaine\", \"rs reference app. The eShopOnContainers mobile app is a cross-platform enterprise app developed usin\", \"g Xamarin.Forms, which connects to a series of containerized microservices known as the eShopOnConta\", \"iners reference app. However, the eShopOnContainers mobile app can be configured to consume data fro\", \"m mock services for those who wish to avoid deploying the containerized microservices.\\n\\n## What's le\", \"ft out of this guide's scope\\n\\nThis guide is aimed at readers who are already familiar with Xamarin.F\", \"orms. For a detailed introduction to Xamarin.Forms, see the Xamarin.Forms documentation on the Xamar\", \"in Developer Center, and Creating Mobile Apps with Xamarin.Forms.\\n\\nThe guide is complementary to .NE\", \"T Microservices: Architecture for Containerized .NET Applications, which focuses on developing and d\", \"eploying containerized microservices. Other guides worth reading include Architecting and Developing\", \" Modern Web Applications with ASP.NET Core and Microsoft Azure, Containerized Docker Application Lif\", \"ecycle with Microsoft Platform and Tools, and Microsoft Platform and Tools for Mobile App Developmen\", \"t.\\n\\n## Who should use this guide\\n\\nThe audience for this guide is mainly developers and architects wh\", \"o would like to learn how to architect and implement cross-platform enterprise apps using Xamarin.Fo\", \"rms.\\n\\nA secondary audience is technical decision makers who would like to receive an architectural a\", \"nd technology overview before deciding on what approach to select for cross-platform enterprise app \", \"development using Xamarin.Forms.\\n\\n## How to use this guide\\n\\nThis guide focuses on building cross-pla\", \"tform enterprise apps using Xamarin.Forms. As such, it should be read in its entirety to provide a f\", \"oundation of understanding such apps and their technical considerations. The guide, along with its s\", \"ample app, can also serve as a starting point or reference for creating a new enterprise app. Use th\", \"e associated sample app as a template for the new app, or to see how to organize an app's component \", \"parts. Then, refer back to this guide for architectural guidance.\\n\\nFeel free to forward this guide t\", \"o team members to help ensure a common understanding of crossplatform enterprise app development usi\", \"ng Xamarin.Forms. Having everybody working from a common set of terminologies and underlying princip\", \"les will help ensure a consistent application of architectural patterns and practices.\\n\\n## Introduct\", \"ion\\n\\nRegardless of platform, developers of enterprise apps face several challenges:\\n\\n- App requireme\", \"nts that can change over time.\\n- New business opportunities and challenges.\\n- Ongoing feedback durin\", \"g development that can significantly affect the scope and requirements of the app.\\n\\nWith these in mi\", \"nd, it's important to build apps that can be easily modified or extended over time. Designing for su\", \"ch adaptability can be difficult as it requires an architecture that allows individual parts of the \", \"app to be independently developed and tested in isolation without affecting the rest of the app.\\n\\nMa\", \"ny enterprise apps are sufficiently complex to require more than one developer. It can be a signific\", \"ant challenge to decide how to design an app so that multiple developers can work effectively on dif\", \"ferent pieces of the app independently, while ensuring that the pieces come together seamlessly when\", \" integrated into the app.\\n\\nThe traditional approach to designing and building an app results in what\", \" is referred to as a monolithic app, where components are tightly coupled with no clear separation b\", \"etween them. Typically, this monolithic approach leads to apps that are difficult and inefficient to\", \" maintain, because it can be difficult to resolve bugs without breaking other components in the app,\", \" and it can be difficult to add new features or to replace existing features.\\n\\nAn effective remedy f\", \"or these challenges is to partition an app into discrete, loosely coupled components that can be eas\", \"ily integrated together into an app. Such an approach offers several benefits:\\n\\n- It allows individu\", \"al functionality to be developed, tested, extended, and maintained by different individuals or teams\", \".\\n- It promotes reuse and a clean separation of concerns between the app's horizontal capabilities, \", \"such as authentication and data access, and the vertical capabilities, such as app specific business\", \" functionality. This allows the dependencies and interactions between app components to be more easi\", \"ly managed.\\n- It helps maintain a separation of roles by allowing different individuals, or teams, t\", \"o focus on a specific task or piece of functionality according to their expertise. In particular, it\", \" provides a cleaner separation between the user interface and the app's business logic.\\n\\nHowever, th\", \"ere are many issues that must be resolved when partitioning an app into discrete, loosely coupled co\", \"mponents. These include:\\n\\n- Deciding how to provide a clean separation of concerns between the user \", \"interface controls and their logic. One of the most important decisions when creating a Xamarin.Form\", \"s enterprise app is whether to place business logic in code-behind files, or whether to create a cle\", \"an separation of concerns between the user interface controls and their logic, in order to\\n\\nmake the\", \" app more maintainable and testable. For more information, see Model-ViewViewModel.\\n\\n- Determining w\", \"hether to use a dependency injection container. Dependency injection containers reduce the dependenc\", \"y coupling between objects by providing a facility to construct instances of classes with their depe\", \"ndencies injected, and manage their lifetime based on the configuration of the container. For more i\", \"nformation, see Dependency injection.\\n- Choosing between platform provided eventing and loosely coup\", \"led message-based communication between components that are inconvenient to link by object and type \", \"references. For more information, see Introduction to Communicating between loosely coupled componen\", \"ts.\\n- Deciding how to navigate between pages, including how to invoke navigation, and where navigati\", \"on logic should reside. For more information, see Navigation.\\n- Determining how to validate user inp\", \"ut for correctness. The decision must include how to validate user input, and how to notify the user\", \" about validation errors. For more information, see Validation.\\n- Deciding how to perform authentica\", \"tion, and how to protect resources with authorization. For more information, see Authentication and \", \"authorization.\\n- Determining how to access remote data from web services, including how to reliably \", \"retrieve data, and how to cache data. For more information, see Accessing remote data.\\n- Deciding ho\", \"w to test the app. For more information, see Unit testing.\\n\\nThis guide provides guidance on these is\", \"sues, and focuses on the core patterns and architecture for building a cross-platform enterprise app\", \" using Xamarin.Forms. The guidance aims to help to produce adaptable, maintainable, and testable cod\", \"e, by addressing common Xamarin.Forms enterprise app development scenarios, and by separating the co\", \"ncerns of presentation, presentation logic, and entities through support for the Model-View-ViewMode\", \"l (MVVM) pattern.\\n\\n## Sample application\\n\\nThis guide includes a sample application, eShopOnContainer\", \"s, that's an online store that includes the following functionality:\\n\\n- Authenticating and authorizi\", \"ng against a backend service.\\n- Browsing a catalog of shirts, coffee mugs, and other marketing items\", \".\\n- Filtering the catalog.\\n- Ordering items from the catalog.\\n- Viewing the user's order history.\\n- \", \"Configuration of settings.\\n\\n## Sample application architecture\\n\\nFigure 1-1 provides a high-level ove\", \"rview of the architecture of the sample application.\\n\\nL\\n\\nClient apps eShop Mobile App\\n\\nXamarin.Forms\", \"\\n\\nCFF\\n\\nxPlatform O5:\\n\\nIOS\\n\\nAndroid\\n\\nWindows eshop Traditional WebApp\\n\\nHTML\\n\\neShop SPA WebApp\\n\\nTypeSc\", \"ript / Angular 2\\n\\nDocker Host\\n\\nIdentity Microservice (STS + Users]\\n\\nWeb APl\\n\\nSQL Server\\n\\nContainer d\", \"atabase\\n\\nFigure 1-1 : eShopOnContainers high-level architecture\\n\\nThe sample application ships with t\", \"hree client apps:\\n\\n- An MVC application developed with ASP.NET Core.\\n- A Single Page Application (SP\", \"A) developed with Angular 2 and Typescript. This approach for web applications avoids performing a r\", \"ound-trip to the server with each operation.\\n- A mobile app developed with Xamarin.Forms, which supp\", \"orts iOS, Android, and the Universal Windows Platform (UWP).\\n\\nFor information about the web applicat\", \"ions, see Architecting and Developing Modern Web Applications with ASP.NET Core and Microsoft Azure.\", \"\\n\\nThe sample application includes the following backend services:\\n\\n- An identity microservice, which\", \" uses ASP.NET Core Identity and IdentityServer.\\n- A catalog microservice, which is a data-driven cre\", \"ate, read, update, delete (CRUD) service that consumes an SQL Server database using EntityFramework \", \"Core.\\n- An ordering microservice, which is a domain-driven service that uses domain-driven design pa\", \"tterns.\\n- A basket microservice, which is a data-driven CRUD service that uses Redis Cache.\\n\\nThese b\", \"ackend services are implemented as microservices using ASP.NET Core MVC, and are deployed as unique \", \"containers within a single Docker host. Collectively, these backend services are referred to as the \", \"eShopOnContainers reference application. Client apps communicate with the backend services through a\", \" Representational State Transfer (REST) web interface. For more information about microservices and \", \"Docker, see Containerized microservices.\\n\\nFor information about the implementation of the backend se\", \"rvices, see .NET Microservices: Architecture for Containerized .NET Applications.\\n\\n[e] OTCONTANNERS\\n\", \"\\nE\\n\\n## Mobile app\\n\\nNET\\n\\nLE CONTAINERS\\n\\nE\\n\\n8\\n\\nVisual Studio\\n\\nT-Shirt\\n\\n[e] CONTANERS\\n\\nLOG OUT\\n\\nMY ORDE\", \"RS\\n\\nORDER NUMBER\\n\\nDATE\\n\\nThis guide focuses on building cross-platform enterprise apps using Xamarin.\", \"Forms, and uses the eShopOnContainers mobile app as an example. Figure 1-2 shows the pages from the \", \"eShopOnContainers mobile app that provide the functionality outlined earlier.\\n\\n[LOGIN |\\n\\n123\\n\\nSHIPPI\", \"NG ADDRESS\\n\\n120 E 87th Street\\n\\nSeattle, WA\\n\\n98122\\n\\nUnited States\\n\\nFigure 1-2 : The eShopOnContainers\", \" mobile app\\n\\nThe mobile app consumes the backend services provided by the eShopOnContainers referenc\", \"e application. However, it can be configured to consume data from mock services for those who wish t\", \"o avoid deploying the backend services.\\n\\nThe eShopOnContainers mobile app exercises the following Xa\", \"marin.Forms functionality:\\n\\n- XAML\\n- Controls\\n- Bindings\\n- Converters\\n- Styles\\n\\n7 / 0 7:28\\n\\nT BLUE S\", \"WEATSHIRT (M)\\n\\n$16.50\\n\\n... BLACK SWEATSHIRT (M)\\n\\n$19.95\\n\\n8\\n\\nFILTER\\n\\n7E 0 721\\n\\n7A 0 7:22\\n\\nE\\n\\n7 / 0 7:\", \"23\\n\\n- Animations\\n- Commands\\n- Behaviors\\n- Triggers\\n- Effects\\n- Custom Renderers\\n- MessagingCenter\\n- \", \"Custom Controls\\n\\nFor more information about this functionality, see the Xamarin.Forms documentation \", \"on the Xamarin Developer Center, and Creating Mobile Apps with Xamarin.Forms.\\n\\nIn addition, unit tes\", \"ts are provided for some of the classes in the eShopOnContainers mobile app.\\n\\n## Mobile app solution\", \"\\n\\nThe eShopOnContainers mobile app solution organizes the source code and other resources into proje\", \"cts. All of the projects use folders to organize the source code and other resources into categories\", \". The following table outlines the projects that make up the eShopOnContainers mobile app:\\n\\n| Projec\", \"t                              | Description                                                        \", \"                                           |\\n|--------------------------------------|---------------\", \"------------------------------------------------------------------------------------------------|\\n| \", \"eShopOnContainers.Core               | This project is the portable class library (PCL) project that\", \" contains the shared code and shared UI.         |\\n| eShopOnContainers.Droid              | This pro\", \"ject holds Android specific code and is the entry point for the Android app.                        \", \"  |\\n| eShopOnContainers.iOS                | This project holds iOS specific code and is the entry p\", \"oint for the iOS app.                                  |\\n| eShopOnContainers.UWP                | Th\", \"is project holds Universal Windows Platform (UWP) specific code and is the entry point for the Windo\", \"ws app. |\\n| eShopOnContainers.TestRunner.Droid   | This project is the Android test runner for the e\", \"ShopOnContainers.UnitTests project.                          |\\n| eShopOnContainers.TestRunner.iOS   \", \"  | This project is the iOS test runner for the eShopOnContainers.UnitTests project.                \", \"              |\\n| eShopOnContainers.TestRunner.Windows | This project is the Universal Windows Platf\", \"orm test runner for the eShopOnContainers.UnitTests project.       |\\n| eShopOnContainers.UnitTests  \", \"        | This project contains unit tests for the eShopOnContainers.Core project.                  \", \"                    |\\n\\nThe classes from the eShopOnContainers mobile app can be re-used in any Xamar\", \"in.Forms app with little or no modification.\\n\\n## eShopOnContainers.Core project\\n\\nThe eShopOnContaine\", \"rs.Core PCL project contains the following folders:\\n\\n| Folder      | Description                    \", \"                                                                               |\\n|-------------|----\", \"----------------------------------------------------------------------------------------------------\", \"-------|\\n| Animations  | Contains classes that enable animations to be consumed in XAML.            \", \"                                   |\\n| Behaviors   | Contains behaviors that are exposed to view cla\", \"sses.                                                          |\\n| Controls    | Contains custom con\", \"trols used by the app.                                                                     |\\n| Conve\", \"rters  | Contains value converters that apply custom logic to a binding.                            \", \"                   |\\n| Effects     | Contains the EntryLineColorEffect class, which is used to chang\", \"e the border color of specific Entry controls. |\\n| Exceptions  | Contains the custom ServiceAuthenti\", \"cationException .                                                          |\\n| Extensions  | Contain\", \"s extension methods for the VisualElement and IEnumerable<T> classes.                               \", \"   |\\n| Helpers     | Contains helper classes for the app.                                           \", \"                               |\\n| Models      | Contains the model classes for the app.            \", \"                                                           |\\n| Properties  | Contains AssemblyInfo.c\", \"s , a .NET assembly metadata file.                                                     |\\n| Services \", \"   | Contains interfaces and classes that implement services that are provided to the app.          \", \"               |\\n| Triggers    | Contains the BeginAnimation trigger, which is used to invoke an ani\", \"mation in XAML.                            |\\n| Validations | Contains classes involved in validating\", \" data input.                                                           |\\n| ViewModels  | Contains th\", \"e application logic that's exposed to pages.                                                       |\", \"\\n| Views       | Contains the pages for the app.                                                    \", \"                           |\\n\\n## Platform projects\\n\\nThe platform projects contain effect implementat\", \"ions, custom renderer implementations, and other platform-specific resources.\\n\\n## Summary\\n\\nXamarin's\", \" cross-platform mobile app development tools and platforms provide a comprehensive solution for B2E,\", \" B2B, and B2C mobile client apps, providing the ability to share code across all target platforms (i\", \"OS, Android, and Windows) and helping to lower the total cost of ownership. Apps can share their use\", \"r interface and app logic code, while retaining the native platform look and feel.\\n\\nDevelopers of en\", \"terprise apps face several challenges that can alter the architecture of the app during development.\", \" Therefore, it's important to build an app so that it can be modified or extended over time. Designi\", \"ng for such adaptability can be difficult, but typically involves partitioning an app into discrete,\", \" loosely coupled components that can be easily integrated together into an app.\\n\\nView\\n\\nData Binding \", \"and Commands\\n\\nSend notifications\\n\\nViewModel updates the model\\n\\n\\u2022\\n\\nSend notifications\\n\\nSauro 2.1. The\", \" MWVM nattern\\n\\n## MVVM\\n\\nThe Xamarin.Forms developer experience typically involves creating a user in\", \"terface in XAML, and then adding code-behind that operates on the user interface. As apps are modifi\", \"ed, and grow in size and scope, complex maintenance issues can arise. These issues include the tight\", \" coupling between the UI controls and the business logic, which increases the cost of making UI modi\", \"fications, and the difficulty of unit testing such code.\\n\\nThe Model-View-ViewModel (MVVM) pattern he\", \"lps to cleanly separate the business and presentation logic of an application from its user interfac\", \"e (UI). Maintaining a clean separation between application logic and the UI helps to address numerou\", \"s development issues and can make an application easier to test, maintain, and evolve. It can also g\", \"reatly improve code re-use opportunities and allows developers and UI designers to more easily colla\", \"borate when developing their respective parts of an app.\\n\\n## The MVVM pattern\\n\\nThere are three core \", \"components in the MVVM pattern: the model, the view, and the view model. Each serves a distinct purp\", \"ose. Figure 2-1 shows the relationships between the three components.\\n\\nFigure 2-1 : The MVVM pattern\", \"\\n\\nIn addition to understanding the responsibilities of each components, it's also important to under\", \"stand how they interact with each other. At a high level, the view \\\"knows about\\\" the view model, and\", \" the view model \\\"knows about\\\" the model, but the model is unaware of the view model, and the view mo\", \"del is unaware of the view. Therefore, the view model isolates the view from the model, and allows t\", \"he model to evolve independently of the view.\\n\\nThe benefits of using the MVVM pattern are as follows\", \":\\n\\n- If there's an existing model implementation that encapsulates existing business logic, it can b\", \"e difficult or risky to change it. In this scenario, the view model acts as an adapter for the model\", \" classes and enables you to avoid making any major changes to the model code.\\n\\n\\u2022\\n\\nView Model\\n\\n+\\n\\nMod\", \"el\\n\\n- Developers can create unit tests for the view model and the model, without using the view. The\", \" unit tests for the view model can exercise exactly the same functionality as used by the view.\\n- Th\", \"e app UI can be redesigned without touching the code, provided that the view is implemented entirely\", \" in XAML. Therefore, a new version of the view should work with the existing view model.\\n- Designers\", \" and developers can work independently and concurrently on their components during the development p\", \"rocess. Designers can focus on the view, while developers can work on the view model and model compo\", \"nents.\\n\\nThe key to using MVVM effectively lies in understanding how to factor app code into the corr\", \"ect classes, and in understanding how the classes interact. The following sections discuss the respo\", \"nsibilities of each of the classes in the MVVM pattern.\\n\\n## View\\n\\nThe view is responsible for defini\", \"ng the structure, layout, and appearance of what the user sees on screen. Ideally, each view is defi\", \"ned in XAML, with a limited code-behind that does not contain business logic. However, in some cases\", \", the code-behind might contain UI logic that implements visual behavior that is difficult to expres\", \"s in XAML, such as animations.\\n\\nIn a Xamarin.Forms application, a view is typically a Page -derived \", \"or ContentView -derived class. However, views can also be represented by a data template, which spec\", \"ifies the UI elements to be used to visually represent an object when it's displayed. A data templat\", \"e as a view does not have any code-behind, and is designed to bind to a specific view model type.\\n\\nT\", \"ip: Avoid enabling and disabling UI elements in the code-behind\\n\\nEnsure that view models are respons\", \"ible for defining logical state changes that affect some aspects of the view's display, such as whet\", \"her a command is available, or an indication that an operation is pending. Therefore, enable and dis\", \"able UI elements by binding to view model properties, rather than enabling and disabling them in cod\", \"e-behind.\\n\\nThere are several options for executing code on the view model in response to interaction\", \"s on the view, such as a button click or item selection. If a control supports commands, the control\", \"'s Command property can be data-bound to an ICommand property on the view model. When the control's \", \"command is invoked, the code in the view model will be executed. In addition to commands, behaviors \", \"can be attached to an object in the view and can listen for either a command to be invoked or event \", \"to be raised. In response, the behavior can then invoke an ICommand on the view model or a method on\", \" the view model.\\n\\n## ViewModel\\n\\nThe view model implements properties and commands to which the view \", \"can data bind to, and notifies the view of any state changes through change notification events. The\", \" properties and commands that the view model provides define the functionality to be offered by the \", \"UI, but the view determines how that functionality is to be displayed.\\n\\nTip: Keep the UI responsive \", \"with asynchronous operations\\n\\nMobile apps should keep the UI thread unblocked to improve the user's \", \"perception of performance. Therefore, in the view model, use asynchronous methods for I/O operations\", \" and raise events to asynchronously notify views of property changes.\\n\\nThe view model is also respon\", \"sible for coordinating the view's interactions with any model classes that are required. There's typ\", \"ically a one-to-many relationship between the view model and the model classes. The view model might\", \" choose to expose model classes directly to the view so that controls in the view can data bind dire\", \"ctly to them. In this case, the model classes will need to be designed to support data binding and c\", \"hange notification events.\\n\\nEach view model provides data from a model in a form that the view can e\", \"asily consume. To accomplish this, the view model sometimes performs data conversion. Placing this d\", \"ata conversion in the view model is a good idea because it provides properties that the view can bin\", \"d to. For example, the view model might combine the values of two properties to make it easier for d\", \"isplay by the view.\\n\\nTip: Centralize data conversions in a conversion layer\\n\\nIt's also possible to u\", \"se converters as a separate data conversion layer that sits between the view model and the view. Thi\", \"s can be necessary, for example, when data requires special formatting that the view model doesn't p\", \"rovide.\\n\\nIn order for the view model to participate in two-way data binding with the view, its prope\", \"rties must raise the PropertyChanged event. View models satisfy this requirement by implementing the\", \" INotifyPropertyChanged interface, and raising the PropertyChanged event when a property is changed.\", \"\\n\\nFor collections, the view-friendly ObservableCollection&lt;T&gt; is provided. This collection impl\", \"ements collection changed notification, relieving the developer from having to implement the INotify\", \"CollectionChanged interface on collections.\\n\\n## Model\\n\\nModel classes are non-visual classes that enc\", \"apsulate the app's data. Therefore, the model can be thought of as representing the app's domain mod\", \"el, which usually includes a data model along with business and validation logic. Examples of model \", \"objects include data transfer objects (DTOs), Plain Old CLR Objects (POCOs), and generated entity an\", \"d proxy objects.\\n\\nModel classes are typically used in conjunction with services or repositories that\", \" encapsulate data access and caching.\\n\\n## Connecting view models to views\\n\\nView models can be connec\", \"ted to views by using the data-binding capabilities of Xamarin.Forms. There are many approaches that\", \" can be used to construct views and view models and associate them at runtime. These approaches fall\", \" into two categories, known as view first composition, and view model first composition. Choosing be\", \"tween view first composition and view model first composition is an issue of preference and complexi\", \"ty. However, all approaches share the same aim, which is for the view to have a view model assigned \", \"to its BindingContext property.\\n\\nWith view first composition the app is conceptually composed of vie\", \"ws that connect to the view models they depend on. The primary benefit of this approach is that it m\", \"akes it easy to construct loosely coupled, unit testable apps because the view models have no depend\", \"ence on the views themselves. It's also easy to understand the structure of the app by following its\", \" visual structure, rather than having to track code execution to understand how classes are created \", \"and associated. In addition, view first construction aligns with the Xamarin.Forms navigation system\", \" that's responsible for constructing pages when navigation occurs, which makes a view model first co\", \"mposition complex and misaligned with the platform.\\n\\nWith view model first composition the app is co\", \"nceptually composed of view models, with a service being responsible for locating the view for a vie\", \"w model. View model first composition feels more natural to some developers, since the view creation\", \" can be abstracted away, allowing them to focus on the logical non-UI structure of the app. In addit\", \"ion, it allows view models to be created by other view models. However, this approach is often compl\", \"ex and it can become difficult to understand how the various parts of the app are created and associ\", \"ated.\\n\\nTip: Keep view models and views independent\\n\\nThe binding of views to a property in a data sou\", \"rce should be the view's principal dependency on its corresponding view model. Specifically, don't r\", \"eference view types, such as Button and ListView , from view models. By following the principles out\", \"lined here, view models can be tested in isolation, therefore reducing the likelihood of software de\", \"fects by limiting scope.\\n\\nThe following sections discuss the main approaches to connecting view mode\", \"ls to views.\\n\\n## Creating a view model declaratively\\n\\nThe simplest approach is for the view to decla\", \"ratively instantiate its corresponding view model in XAML. When the view is constructed, the corresp\", \"onding view model object will also be constructed. This approach is demonstrated in the following co\", \"de example:\\n\\n```\\n<ContentPage ... xmlns:local=\\\"clr-namespace:eShop\\\"> <ContentPage.BindingContext> <l\", \"ocal:LoginViewModel /> </ContentPage.BindingContext> ... </ContentPage>\\n```\\n\\nWhen the ContentPage is\", \" created, an instance of the LoginViewModel is automatically constructed and set as the view's Bindi\", \"ngContext .\\n\\nThis declarative construction and assignment of the view model by the view has the adva\", \"ntage that it's simple, but has the disadvantage that it requires a default (parameter-less) constru\", \"ctor in the view model.\\n\\n## Creating a view model programmatically\\n\\nA view can have code in the code\", \"-behind file that results in the view model being assigned to its BindingContext property. This is o\", \"ften accomplished in the view's constructor, as shown in the following code example:\\n\\n```\\npublic Log\", \"inView() { InitializeComponent(); BindingContext = new LoginViewModel(navigationService); }\\n```\\n\\nThe\", \" programmatic construction and assignment of the view model within the view's code-behind has the ad\", \"vantage that it's simple. However, the main disadvantage of this approach is that the view needs to \", \"provide the view model with any required dependencies. Using a dependency injection container can he\", \"lp to maintain loose coupling between the view and view model. For more information, see Dependency \", \"injection.\\n\\n## Creating a view defined as a data template\\n\\nA view can be defined as a data template \", \"and associated with a view model type. Data templates can be defined as resources, or they can be de\", \"fined inline within the control that will display the view model. The content of the control is the \", \"view model instance, and the data template is used to visually represent it. This technique is an ex\", \"ample of a situation in which the view model is instantiated first, followed by the creation of the \", \"view.\\n\\n## Automatically creating a view model with a view model locator\\n\\nA view model locator is a c\", \"ustom class that manages the instantiation of view models and their association to views. In the eSh\", \"opOnContainers mobile app, the ViewModelLocator class has an attached property, AutoWireViewModel , \", \"that's used to associate view models with views. In the view's XAML, this attached property is set t\", \"o true to indicate that the view model should be automatically connected to the view, as shown in th\", \"e following code example:\\n\\n```\\nviewModelBase:ViewModelLocator.AutoWireViewModel=\\\"true\\\"\\n```\\n\\nThe Auto\", \"WireViewModel property is a bindable property that's initialized to false , and when its value chang\", \"es the OnAutoWireViewModelChanged event handler is called. This method resolves the view model for t\", \"he view. The following code example shows how this is achieved:\\n\\n```\\nprivate static void OnAutoWireV\", \"iewModelChanged(BindableObject bindable, object oldValue, object n ewValue) { var view = bindable as\", \" Element; if (view == null) { return; } var viewType = view.GetType(); var viewName = viewType.FullN\", \"ame.Replace(\\\".Views.\\\", \\\".ViewModels.\\\"); var viewAssemblyName = viewType.GetTypeInfo().Assembly.FullN\", \"ame; var viewModelName = string.Format( CultureInfo.InvariantCulture, \\\"{0}Model, {1}\\\", viewName, vie\", \"wAssemblyName); var viewModelType = Type.GetType(viewModelName); if (viewModelType == null) { return\", \"; } var viewModel = _container.Resolve(viewModelType); view.BindingContext = viewModel; }\\n```\\n\\nThe O\", \"nAutoWireViewModelChanged method attempts to resolve the view model using a conventionbased approach\", \". This convention assumes that:\\n\\n- View models are in the same assembly as view types.\\n- Views are i\", \"n a .Views child namespace.\\n- View models are in a .ViewModels child namespace.\\n- View model names c\", \"orrespond with view names and end with \\\"ViewModel\\\".\\n\\nFinally, the OnAutoWireViewModelChanged method \", \"sets the BindingContext of the view type to the resolved view model type. For more information about\", \" resolving the view model type, see Resolution.\\n\\nThis approach has the advantage that an app has a s\", \"ingle class that is responsible for the instantiation of view models and their connection to views.\\n\", \"\\nTip: Use a view model locator for ease of substitution\\n\\nA view model locator can also be used as a \", \"point of substitution for alternate implementations of dependencies, such as for unit testing or des\", \"ign time data.\\n\\n## Updating views in response to changes in the underlying view model or model\\n\\nAll \", \"view model and model classes that are accessible to a view should implement the INotifyPropertyChang\", \"ed interface. Implementing this interface in a view model or model class allows the class to provide\", \" change notifications to any data-bound controls in the view when the underlying property value chan\", \"ges.\\n\\nApp's should be architected for the correct use of property change notification, by meeting th\", \"e following requirements:\\n\\n- Always raising a PropertyChanged event if a public property's value cha\", \"nges. Do not assume that raising the PropertyChanged event can be ignored because of knowledge of ho\", \"w XAML binding occurs.\\n- Always raising a PropertyChanged event for any calculated properties whose \", \"values are used by other properties in the view model or model.\\n- Always raising the PropertyChanged\", \" event at the end of the method that makes a property change, or when the object is known to be in a\", \" safe state. Raising the event interrupts the operation by invoking the event's handlers synchronous\", \"ly. If this happens in the middle of an operation, it might expose the object to callback functions \", \"when it is in an unsafe, partially updated state. In addition, it's possible for cascading changes t\", \"o be triggered by PropertyChanged events. Cascading changes generally require updates to be complete\", \" before the cascading change is safe to execute.\\n- Never raising a PropertyChanged event if the prop\", \"erty does not change. This means that you must compare the old and new values before raising the Pro\", \"pertyChanged event.\\n- Never raising the PropertyChanged event during a view model's constructor if y\", \"ou are initializing a property. Data-bound controls in the view will not have subscribed to receive \", \"change notifications at this point.\\n- Never raising more than one PropertyChanged event with the sam\", \"e property name argument within a single synchronous invocation of a public method of a class. For e\", \"xample, given a NumberOfItems property whose backing store is the _numberOfItems field, if a method \", \"increments _numberOfItems fifty times during the execution of a loop, it should only raise property \", \"change notification on the NumberOfItems property once, after all the work is complete. For asynchro\", \"nous methods, raise the PropertyChanged event for a given property name in each synchronous segment \", \"of an asynchronous continuation chain.\\n\\nThe eShopOnContainers mobile app uses the ExtendedBindableOb\", \"ject class to provide change notifications, which is shown in the following code example:\\n\\n```\\npubli\", \"c abstract class ExtendedBindableObject : BindableObject { public void RaisePropertyChanged<T>(Expre\", \"ssion<Func<T>> property) { var name = GetMemberInfo(property).Name; OnPropertyChanged(name); } priva\", \"te MemberInfo GetMemberInfo(Expression expression) { ... } }\\n```\\n\\nXamarin.Form's BindableObject clas\", \"s implements the INotifyPropertyChanged interface, and provides an OnPropertyChanged method. The Ext\", \"endedBindableObject class provides the RaisePropertyChanged method to invoke property change notific\", \"ation, and in doing so uses the functionality provided by the BindableObject class.\\n\\nEach view model\", \" class in the eShopOnContainers mobile app derives from the ViewModelBase class, which in turn deriv\", \"es from the ExtendedBindableObject class. Therefore, each view model class uses the RaisePropertyCha\", \"nged method in the ExtendedBindableObject class to provide property change notification. The followi\", \"ng code example shows how the eShopOnContainers mobile app invokes property change notification by u\", \"sing a lambda expression:\\n\\n```\\npublic bool IsLogin { get { return _isLogin; } set { _isLogin = value\", \"; RaisePropertyChanged(() => IsLogin); } }\\n```\\n\\nNote that using a lambda expression in this way invo\", \"lves a small performance cost because the lambda expression has to be evaluated for each call. Altho\", \"ugh the performance cost is small and would not normally impact an app, the costs can accrue when th\", \"ere are many change notifications. However, the benefit of this approach is that it provides compile\", \"-time type safety and refactoring support when renaming properties.\\n\\n## UI interaction using command\", \"s and behaviors\\n\\nIn mobile apps, actions are typically invoked in response to a user action, such as\", \" a button click, that can be implemented by creating an event handler in the code-behind file. Howev\", \"er, in the MVVM pattern, the responsibility for implementing the action lies with the view model, an\", \"d placing code in the code-behind should be avoided.\\n\\nCommands provide a convenient way to represent\", \" actions that can be bound to controls in the UI. They encapsulate the code that implements the acti\", \"on, and help to keep it decoupled from its visual representation in the view. Xamarin.Forms includes\", \" controls that can be declaratively connected to a command, and these controls will invoke the comma\", \"nd when the user interacts with the control.\\n\\nBehaviors also allow controls to be declaratively conn\", \"ected to a command. However, behaviors can be used to invoke an action that's associated with a rang\", \"e of events raised by a control. Therefore, behaviors address many of the same scenarios as command-\", \"enabled controls, while providing a greater degree of flexibility and control. In addition, behavior\", \"s can also be used to associate command objects or methods with controls that were not specifically \", \"designed to interact with commands.\\n\\n## Implementing commands\\n\\nView models typically expose command \", \"properties, for binding from the view, that are object instances that implement the ICommand interfa\", \"ce. A number of Xamarin.Forms controls provide a Command property, which can be data bound to an ICo\", \"mmand object provided by the view model. The ICommand interface defines an Execute method, which enc\", \"apsulates the operation itself, a CanExecute method, which indicates whether the command can be invo\", \"ked, and a CanExecuteChanged event that occurs when changes occur that affect whether the command sh\", \"ould execute. The Command and Command&lt;T&gt; classes, provided by Xamarin.Forms, implement the ICo\", \"mmand interface, where T is the type of the arguments to Execute and CanExecute .\\n\\nWithin a view mod\", \"el, there should be an object of type Command or Command&lt;T&gt; for each public property in the vi\", \"ew model of type ICommand . The Command or Command&lt;T&gt; constructor requires an Action callback \", \"object that's called when the ICommand.Execute method is invoked. The CanExecute method is an option\", \"al constructor parameter, and is a Func that returns a bool .\\n\\nThe following code shows how a Comman\", \"d instance, which represents a register command, is constructed by specifying a delegate to the Regi\", \"ster view model method:\\n\\n```\\npublic ICommand RegisterCommand => new Command(Register);\\n```\\n\\nThe comm\", \"and is exposed to the view through a property that returns a reference to an ICommand . When the Exe\", \"cute method is called on the Command object, it simply forwards the call to the method in the view m\", \"odel via the delegate that was specified in the Command constructor.\\n\\nAn asynchronous method can be \", \"invoked by a command by using the async and await keywords when specifying the command's Execute del\", \"egate. This indicates that the callback is a Task and should be awaited. For example, the following \", \"code shows how a Command instance, which represents a sign-in command, is constructed by specifying \", \"a delegate to the SignInAsync view model method:\\n\\n```\\npublic ICommand SignInCommand => new Command(a\", \"sync () => await SignInAsync());\\n```\\n\\nParameters can be passed to the Execute and CanExecute actions\", \" by using the Command&lt;T&gt; class to instantiate the command. For example, the following code sho\", \"ws how a Command&lt;T&gt; instance is used to indicate that the NavigateAsync method will require an\", \" argument of type string :\\n\\n```\\npublic ICommand NavigateCommand => new Command<string>(NavigateAsync\", \");\\n```\\n\\nIn both the Command and Command&lt;T&gt; classes, the delegate to the CanExecute method in e\", \"ach constructor is optional. If a delegate isn't specified, the Command will return true for CanExec\", \"ute . However, the view model can indicate a change in the command's CanExecute status by calling th\", \"e ChangeCanExecute method on the Command object. This causes the CanExecuteChanged event to be raise\", \"d. Any controls in the UI that are bound to the command will then update their enabled status to ref\", \"lect the availability of the data-bound command.\\n\\n## Invoking commands from a view\\n\\nThe following co\", \"de example shows how a Grid in the LoginView binds to the RegisterCommand in the LoginViewModel clas\", \"s by using a TapGestureRecognizer instance:\\n\\n```\\n<Grid Grid.Column=\\\"1\\\" HorizontalOptions=\\\"Center\\\"> <\", \"Label Text=\\\"REGISTER\\\" TextColor=\\\"Gray\\\"/> <Grid.GestureRecognizers> <TapGestureRecognizer Command=\\\"{B\", \"inding RegisterCommand}\\\" NumberOfTapsRequired=\\\"1\\\" /> </Grid.GestureRecognizers> </Grid>\\n```\\n\\nA comma\", \"nd parameter can also be optionally defined using the CommandParameter property. The type of the exp\", \"ected argument is specified in the Execute and CanExecute target methods. The TapGestureRecognizer w\", \"ill automatically invoke the target command when the user interacts with the attached control. The c\", \"ommand parameter, if provided, will be passed as the argument to the command's Execute delegate.\\n\\n##\", \" Implementing behaviors\\n\\nBehaviors allow functionality to be added to UI controls without having to \", \"subclass them. Instead, the functionality is implemented in a behavior class and attached to the con\", \"trol as if it was part of the control itself. Behaviors enable you to implement code that you would \", \"normally have to write as code-behind, because it directly interacts with the API of the control, in\", \" such a way that it can be concisely attached to the control, and packaged for reuse across more tha\", \"n one view or app. In the context of MVVM, behaviors are a useful approach for connecting controls t\", \"o commands.\\n\\nA behavior that's attached to a control through attached properties is known as an atta\", \"ched behavior . The behavior can then use the exposed API of the element to which it is attached to \", \"add functionality to that control, or other controls, in the visual tree of the view. The eShopOnCon\", \"tainers mobile app contains the LineColorBehavior class, which is an attached behavior. For more inf\", \"ormation about this behavior, see Displaying validation errors.\\n\\nA Xamarin.Forms behavior is a class\", \" that derives from the Behavior or Behavior&lt;T&gt; class, where T is the type of the control to wh\", \"ich the behavior should apply. These classes provide OnAttachedTo and OnDetachingFrom methods, which\", \" should be overridden to provide logic that will be executed when the behavior is attached to and de\", \"tached from controls.\\n\\nIn the eShopOnContainers mobile app, the BindableBehavior&lt;T&gt; class deri\", \"ves from the Behavior&lt;T&gt; class. The purpose of the BindableBehavior&lt;T&gt; class is to provi\", \"de a base class for Xamarin.Forms behaviors that require the BindingContext of the behavior to be se\", \"t to the attached control.\\n\\nThe BindableBehavior&lt;T&gt; class provides an overridable OnAttachedTo\", \" method that sets the BindingContext of the behavior, and an overridable OnDetachingFrom method that\", \" cleans up the BindingContext . In addition, the class stores a reference to the attached control in\", \" the AssociatedObject property.\\n\\nThe eShopOnContainers mobile app includes an EventToCommandBehavior\", \" class, which executes a command in response to an event occurring. This class derives from the Bind\", \"ableBehavior&lt;View&gt; class so that the behavior can bind to and execute an ICommand specified by\", \" a Command property when the behavior is consumed. The following code example shows the EventToComma\", \"ndBehavior class:\\n\\n```\\npublic class EventToCommandBehavior : BindableBehavior<View> { ... protected \", \"override void OnAttachedTo(View visualElement) { base.OnAttachedTo(visualElement); var events = Asso\", \"ciatedObject.GetType().GetRuntimeEvents().ToArray(); if (events.Any()) { _eventInfo = events.FirstOr\", \"Default(e => e.Name == EventName); if (_eventInfo == null) throw new ArgumentException(string.Format\", \"( \\\"EventToCommand: Can't find any event named '{0}' on attached type\\\", EventName)); AddEventHandler(\", \"_eventInfo, AssociatedObject, OnFired); } } protected override void OnDetachingFrom(View view) { if \", \"(_handler != null) _eventInfo.RemoveEventHandler(AssociatedObject, _handler); base.OnDetachingFrom(v\", \"iew); } private void AddEventHandler( EventInfo eventInfo, object item, Action<object, EventArgs> ac\", \"tion) { ... } private void OnFired(object sender, EventArgs eventArgs) { ... } }\\n```\\n\\nThe OnAttached\", \"To and OnDetachingFrom methods are used to register and deregister an event handler for the event de\", \"fined in the EventName property. Then, when the event fires, the OnFired method is invoked, which ex\", \"ecutes the command.\\n\\nThe advantage of using the EventToCommandBehavior to execute a command when an \", \"event fires, is that commands can be associated with controls that weren't designed to interact with\", \" commands. In addition, this moves event-handling code to view models, where it can be unit tested.\\n\", \"\\n## Invoking behaviors from a view\\n\\nThe EventToCommandBehavior is particularly useful for attaching \", \"a command to a control that doesn't support commands. For example, the ProfileView uses the EventToC\", \"ommandBehavior to execute the OrderDetailCommand when the ItemTapped event fires on the ListView tha\", \"t lists the user's orders, as shown in the following code:\\n\\n```\\n<ListView> <ListView.Behaviors> <beh\", \"aviors:EventToCommandBehavior EventName=\\\"ItemTapped\\\" Command=\\\"{Binding OrderDetailCommand}\\\" EventArg\", \"sConverter=\\\"{StaticResource ItemTappedEventArgsConverter}\\\" />\\n```\\n\\n| </ListView.Behaviors>   |\\n|----\", \"---------------------|\\n| ...                     |\\n| </ListView>             |\\n\\nAt runtime, the Even\", \"tToCommandBehavior will respond to interaction with the ListView . When an item is selected in the L\", \"istView , the ItemTapped event will fire, which will execute the OrderDetailCommand in the ProfileVi\", \"ewModel . By default, the event arguments for the event are passed to the command. This data is conv\", \"erted as it's passed between source and target by the converter specified in the EventArgsConverter \", \"property, which returns the Item of the ListView from the I temTappedEventArgs . Therefore, when the\", \" OrderDetailCommand is executed, the selected Order is passed as a parameter to the registered Actio\", \"n .\\n\\nFor more information about behaviors, see Behaviors on the Xamarin Developer Center.\\n\\n## Summar\", \"y\\n\\nThe Model-View-ViewModel (MVVM) pattern helps to cleanly separate the business and presentation l\", \"ogic of an application from its user interface (UI). Maintaining a clean separation between applicat\", \"ion logic and the UI helps to address numerous development issues and can make an application easier\", \" to test, maintain, and evolve. It can also greatly improve code re-use opportunities and allows dev\", \"elopers and UI designers to more easily collaborate when developing their respective parts of an app\", \".\\n\\nUsing the MVVM pattern, the UI of the app and the underlying presentation and business logic is s\", \"eparated into three separate classes: the view, which encapsulates the UI and UI logic; the view mod\", \"el, which encapsulates presentation logic and state; and the model, which encapsulates the app's bus\", \"iness logic and data.\\n\\n## Dependency injection\\n\\nTypically, a class constructor is invoked when insta\", \"ntiating an object, and any values that the object needs are passed as arguments to the constructor.\", \" This is an example of dependency injection, and specifically is known as constructor injection . Th\", \"e dependencies the object needs are injected into the constructor.\\n\\nBy specifying dependencies as in\", \"terface types, dependency injection enables decoupling of the concrete types from the code that depe\", \"nds on these types. It generally uses a container that holds a list of registrations and mappings be\", \"tween interfaces and abstract types, and the concrete types that implement or extend these types.\\n\\nT\", \"here are also other types of dependency injection, such as property setter injection , and method ca\", \"ll injection , but they are less commonly seen. Therefore, this chapter will focus solely on perform\", \"ing constructor injection with a dependency injection container.\\n\\n## Introduction to dependency inje\", \"ction\\n\\nDependency injection is a specialized version of the Inversion of Control (IoC) pattern, wher\", \"e the concern being inverted is the process of obtaining the required dependency. With dependency in\", \"jection, another class is responsible for injecting dependencies into an object at runtime. The foll\", \"owing code example shows how the ProfileViewModel class is structured when using dependency injectio\", \"n:\\n\\n```\\npublic class ProfileViewModel : ViewModelBase { private IOrderService _orderService; public \", \"ProfileViewModel(IOrderService orderService) { _orderService = orderService; } ... }\\n```\\n\\nThe Profil\", \"eViewModel constructor receives an IOrderService another class. The only dependency in the ProfileVi\", \"ewModel class is on the interface type.\\n\\ninstance as an argument, injected by\\n\\nTherefore, the Profil\", \"eViewModel class doesn't have any knowledge of the class that's responsible for instantiating the IO\", \"rderService object. The class that's responsible for instantiating the\\n\\nProfileViewModel +\\n\\nContaine\", \"r\\n\\nOrderService\\n\\nIOrderService object, and inserting it into the ProfileViewModel class, is known as\", \" the dependency injection container .\\n\\nDependency injection containers reduce the coupling between o\", \"bjects by providing a facility to instantiate class instances and manage their lifetime based on the\", \" configuration of the container. During the objects creation, the container injects any dependencies\", \" that the object requires into it. If those dependencies have not yet been created, the container cr\", \"eates and resolves their dependencies first.\\n\\nOrderService m\\n\\nNote: Dependency injection can also be\", \" implemented manually using factories. However, using a container provides additional capabilities s\", \"uch as lifetime management, and registration through assembly scanning.\\n\\nSaure 2-1. Demendencies whe\", \"n icina denendency iniertion\\n\\nThere are several advantages to using a dependency injection container\", \":\\n\\n- A container removes the need for a class to locate its dependencies and manage their lifetimes.\", \"\\n- A container allows mapping of implemented dependencies without affecting the class.\\n- A container\", \" facilitates testability by allowing dependencies to be mocked.\\n- A container increases maintainabil\", \"ity by allowing new classes to be easily added to the app.\\n\\nIn the context of a Xamarin.Forms app th\", \"at uses MVVM, a dependency injection container will typically be used for registering and resolving \", \"view models, and for registering services and injecting them into view models.\\n\\nThere are many depen\", \"dency injection containers available, with the eShopOnContainers mobile app using Autofac to manage \", \"the instantiation of view model and service classes in the app. Autofac facilitates building loosely\", \" coupled apps, and provides all of the features commonly found in dependency injection containers, i\", \"ncluding methods to register type mappings and object instances, resolve objects, manage object life\", \"times, and inject dependent objects into constructors of objects that it resolves. For more informat\", \"ion about Autofac, see Autofac on readthedocs.io.\\n\\nIn Autofac, the IContainer interface provides the\", \" dependency injection container. Figure 3-1 shows the dependencies when using this container, which \", \"instantiates an IOrderService object and injects it into the ProfileViewModel class.\\n\\nFigure 3-1: De\", \"pendencies when using dependency injection\\n\\nAt runtime, the container must know which implementation\", \" of the IOrderService interface it should instantiate, before it can instantiate a ProfileViewModel \", \"object. This involves:\\n\\n- The container deciding how to instantiate an object that implements the IO\", \"rderService interface. This is known as registration .\\n- The container instantiating the object that\", \" implements the IOrderService interface, and the ProfileViewModel object. This is known as resolutio\", \"n .\\n\\nEventually, the app will finish using the ProfileViewModel object and it will become available \", \"for garbage collection. At this point, the garbage collector should dispose of the IOrderService ins\", \"tance if other classes do not share the same instance.\\n\\nTip: Write container-agnostic code\\n\\nAlways t\", \"ry to write container-agnostic code to decouple the app from the specific dependency container being\", \" used.\\n\\n## Registration\\n\\nBefore dependencies can be injected into an object, the types of the depend\", \"encies must first be registered with the container. Registering a type typically involves passing th\", \"e container an interface and a concrete type that implements the interface.\\n\\nThere are two ways of r\", \"egistering types and objects in the container through code:\\n\\n- Register a type or mapping with the c\", \"ontainer. When required, the container will build an instance of the specified type.\\n- Register an e\", \"xisting object in the container as a singleton. When required, the container will return a reference\", \" to the existing object.\\n\\nTip: Dependency injection containers are not always suitable\\n\\nDependency i\", \"njection introduces additional complexity and requirements that might not be appropriate or useful t\", \"o small apps. If a class does not have any dependencies, or is not a dependency for other types, it \", \"might not make sense to put it in the container. In addition, if a class has a single set of depende\", \"ncies that are integral to the type and will never change, it might not make sense to put it in the \", \"container.\\n\\nThe registration of types that require dependency injection should be performed in a sin\", \"gle method in an app, and this method should be invoked early in the app's lifecycle to ensure that \", \"the app is aware of the dependencies between its classes. In the eShopOnContainers mobile app this i\", \"s performed by the ViewModelLocator class, which builds the IContainer object and is the only class \", \"in the app that holds a reference to that object. The following code example shows how the eShopOnCo\", \"ntainers mobile app declares the IContainer object in the ViewModelLocator class:\\n\\n```\\nprivate stati\", \"c IContainer _container;\\n```\\n\\nTypes and instances are registered in the RegisterDependencies method \", \"in the ViewModelLocator class. This is achieved by first creating a ContainerBuilder instance, which\", \" is demonstrated in the following code example:\\n\\n```\\nvar builder = new ContainerBuilder();\\n```\\n\\nType\", \"s and instances are then registered with the ContainerBuilder object, and the following code example\", \" demonstrates the most common form of type registration:\\n\\nbuilder.RegisterType&lt;RequestProvider&gt\", \";().As&lt;IRequestProvider&gt;();\\n\\nThe RegisterType method shown here maps an interface type to a co\", \"ncrete type. It tells the container to instantiate a RequestProvider object when it instantiates an \", \"object that requires an injection of an IRequestProvider through a constructor.\\n\\nConcrete types can \", \"also be registered directly without a mapping from an interface type, as shown in the following code\", \" example:\\n\\n```\\nbuilder.RegisterType<ProfileViewModel>();\\n```\\n\\nWhen the ProfileViewModel type is reso\", \"lved, the container will inject its required dependencies.\\n\\nAutofac also allows instance registratio\", \"n, where the container is responsible for maintaining a reference to a singleton instance of a type.\", \" For example, the following code example shows how the eShopOnContainers mobile app registers the co\", \"ncrete type to use when a ProfileViewModel instance requires an IOrderService instance:\\n\\nbuilder.Reg\", \"isterType&lt;OrderService&gt;().As&lt;IOrderService&gt;().SingleInstance();\\n\\nThe RegisterType method\", \" shown here maps an interface type to a concrete type. The SingleInstance method configures the regi\", \"stration so that every dependent object receives the same shared instance. Therefore, only a single \", \"OrderService instance will exist in the container, which is shared by objects that require an inject\", \"ion of an IOrderService through a constructor.\\n\\nInstance registration can also be performed with the\", \" RegisterInstance method, which is demonstrated in the following code example:\\n\\nbuilder.RegisterInst\", \"ance(new OrderMockService()).As&lt;IOrderService&gt;();\\n\\nThe RegisterInstance method shown here crea\", \"tes a new OrderMockService instance and registers it with the container. Therefore, only a single Or\", \"derMockService instance exists in the container, which is shared by objects that require an injectio\", \"n of an IOrderService through a constructor.\\n\\nFollowing type and instance registration, the IContain\", \"er object must be built, which is demonstrated in the following code example:\\n\\n```\\n_container = buil\", \"der.Build();\\n```\\n\\nInvoking the Build method on the ContainerBuilder instance builds a new dependency\", \" injection container that contains the registrations that have been made.\\n\\nTip : Consider an IContai\", \"ner as being immutable\\n\\nWhile Autofac provides an Update method to update registrations in an existi\", \"ng container, calling this method should be avoided where possible. There are risks to modifying a c\", \"ontainer after it's been built, particularly if the container has been used. For more information, s\", \"ee Consider a Container as Immutable on readthedocs.io.\\n\\n## Resolution\\n\\nAfter a type is registered, \", \"it can be resolved or injected as a dependency. When a type is being resolved and the container need\", \"s to create a new instance, it injects any dependencies into the instance.\\n\\nGenerally, when a type i\", \"s resolved, one of three things happens:\\n\\n1. If the type hasn't been registered, the container throw\", \"s an exception.\\n2. If the type has been registered as a singleton, the container returns the singlet\", \"on instance. If this is the first time the type is called for, the container creates it if required,\", \" and maintains a reference to it.\\n3. If the type hasn't been registered as a singleton, the containe\", \"r returns a new instance, and doesn't maintain a reference to it.\\n\\nThe following code example shows \", \"how the RequestProvider type that was previously registered with Autofac can be resolved:\\n\\n```\\nvar r\", \"equestProvider = _container.Resolve<IRequestProvider>();\\n```\\n\\nIn this example, Autofac is asked to r\", \"esolve the concrete type for the IRequestProvider type, along with any dependencies. Typically, the \", \"Resolve method is called when an instance of a specific type is required. For information about cont\", \"rolling the lifetime of resolved objects, see Managing the lifetime of resolved objects.\\n\\nThe follow\", \"ing code example shows how the eShopOnContainers mobile app instantiates view model types and their \", \"dependencies:\\n\\n```\\nvar viewModel = _container.Resolve(viewModelType);\\n```\\n\\nIn this example, Autofac \", \"is asked to resolve the view model type for a requested view model, and the container will also reso\", \"lve any dependencies. When resolving the ProfileViewModel type, the dependency to resolve is an IOrd\", \"erService object. Therefore, Autofac first constructs an OrderService object and then passes it to t\", \"he constructor of the ProfileViewModel class. For more information about how the eShopOnContainers m\", \"obile app constructs view models and associates them to views, see Automatically creating a view mod\", \"el with a view model locator.\\n\\nNote: Registering and resolving types with a container has a performa\", \"nce cost because of the container's use of reflection for creating each type, especially if dependen\", \"cies are being reconstructed for each page navigation in the app. If there are many or deep dependen\", \"cies, the cost of creation can increase significantly.\\n\\n## Managing the lifetime of resolved objects\", \"\\n\\nAfter registering a type, the default behavior for Autofac is to create a new instance of the regi\", \"stered type each time the type is resolved, or when the dependency mechanism injects instances into \", \"other classes. In this scenario, the container doesn't hold a reference to the resolved object. Howe\", \"ver, when registering an instance, the default behavior for Autofac is to manage the lifetime of the\", \" object as a singleton. Therefore, the instance remains in scope while the container is in scope, an\", \"d is disposed when the container goes out of scope and is garbage collected, or when code explicitly\", \" disposes the container.\\n\\nAn Autofac instance scope can be used to specify the singleton behavior fo\", \"r an object that Autofac creates from a registered type. Autofac instance scopes manage the object l\", \"ifetimes instantiated by the container. The default instance scope for the RegisterType method is th\", \"e InstancePerDependency scope. However, the SingleInstance scope can be used with the RegisterType m\", \"ethod, so that the container creates or returns a singleton instance of a type when calling the Reso\", \"lve method. The following code example shows how Autofac is instructed to create a singleton instanc\", \"e of the NavigationService class:\\n\\nbuilder.RegisterType&lt;NavigationService&gt;().As&lt;INavigation\", \"Service&gt;().SingleInstance();\\n\\nThe first time that the INavigationService interface is resolved, t\", \"he container creates a new NavigationService object and maintains a reference to it. On any subseque\", \"nt resolutions of the INavigationService interface, the container returns a reference to the Navigat\", \"ionService object that was previously created.\\n\\nNote: The SingleInstance scope disposes created obje\", \"cts when the container is disposed.\\n\\nAutofac includes additional instance scopes. For more informati\", \"on, see Instance Scope on readthedocs.io.\\n\\n## Summary\\n\\nDependency injection enables decoupling of co\", \"ncrete types from the code that depends on these types. It typically uses a container that holds a l\", \"ist of registrations and mappings between interfaces and abstract types, and the concrete types that\", \" implement or extend these types.\\n\\nAutofac facilitates building loosely coupled apps, and provides a\", \"ll of the features commonly found in dependency injection containers, including methods to register \", \"type mappings and object instances, resolve objects, manage object lifetimes, and inject dependent o\", \"bjects into constructors of objects it resolves.\\n\\n## Communicating between loosely coupled component\", \"s\\n\\nThe publish-subscribe pattern is a messaging pattern in which publishers send messages without ha\", \"ving knowledge of any receivers, known as subscribers. Similarly, subscribers listen for specific me\", \"ssages, without having knowledge of any publishers.\\n\\nEvents in .NET implement the publish-subscribe \", \"pattern, and are the most simple and straightforward approach for a communication layer between comp\", \"onents if loose coupling is not required, such as a control and the page that contains it. However, \", \"the publisher and subscriber lifetimes are coupled by object references to each other, and the subsc\", \"riber type must have a reference to the publisher type. This can create memory management issues, es\", \"pecially when there are short lived objects that subscribe to an event of a static or long-lived obj\", \"ect. If the event handler isn't removed, the subscriber will be kept alive by the reference to it in\", \" the publisher, and this will prevent or delay the garbage collection of the subscriber.\\n\\n## Introdu\", \"ction to MessagingCenter\\n\\nThe Xamarin.Forms MessagingCenter class implements the publish-subscribe p\", \"attern, allowing message-based communication between components that are inconvenient to link by obj\", \"ect and type references. This mechanism allows publishers and subscribers to communicate without hav\", \"ing a reference to each other, helping to reduce dependencies between components, while also allowin\", \"g components to be independently developed and tested.\\n\\nThe MessagingCenter class provides multicast\", \" publish-subscribe functionality. This means that there can be multiple publishers that publish a si\", \"ngle message, and there can be multiple subscribers listening for the same message. Figure 4-1 illus\", \"trates this relationship:\\n\\nPublisher\\n\\nPublisher\\n\\nPublisher\\n\\nMessage\\n\\nSubscriber\\n\\nSubscriber\\n\\nFigure \", \"4-1: Multicast publish-subscribe functionality\\n\\nPublishers send messages using the MessagingCenter.S\", \"end method, while subscribers listen for messages using the MessagingCenter.Subscribe method. In add\", \"ition, subscribers can also unsubscribe from message subscriptions, if required, with the MessagingC\", \"enter.Unsubscribe method.\\n\\nInternally, the MessagingCenter class uses weak references. This means th\", \"at it will not keep objects alive, and will allow them to be garbage collected. Therefore, it should\", \" only be necessary to unsubscribe from a message when a class no longer wishes to receive the messag\", \"e.\\n\\nThe eShopOnContainers mobile app uses the MessagingCenter class to communicate between loosely c\", \"oupled components. The app defines three messages:\\n\\n- The AddProduct message is published by the Cat\", \"alogViewModel class when an item is added to the shopping basket. In return, the BasketViewModel cla\", \"ss subscribes to the message and increments the number of items in the shopping basket in response. \", \"In addition, the BasketViewModel class also unsubscribes from this message.\\n- The Filter message is \", \"published by the CatalogViewModel class when the user applies a brand or type filter to the items di\", \"splayed from the catalogue. In return, the CatalogView class subscribes to the message and updates t\", \"he UI so that only items that match the filter criteria are displayed.\\n- The ChangeTab message is pu\", \"blished by the MainViewModel class when the CheckoutViewModel navigates to the MainViewModel followi\", \"ng the successful creation and submission of a new order. In return, the MainView class subscribes t\", \"o the message and updates the UI so that the My profile tab is active, to show the user's orders.\\n\\nN\", \"ote: While the MessagingCenter class permits communication between loosely-coupled classes, it does \", \"not offer the only architectural solution to this issue. For example, communication between a view m\", \"odel and a view can also be achieved by the binding engine and through property change notifications\", \". In addition, communication between two view models can also be achieved by passing data during nav\", \"igation.\\n\\nIn the eShopOnContainers mobile app, MessagingCenter is used to update in the UI in respon\", \"se to an action occurring in another class. Therefore, messages are published on the UI thread, with\", \" subscribers receiving the message on the same thread.\\n\\nTip: Marshal to the UI thread when performin\", \"g UI updates\\n\\nIf a message that's sent from a background thread is required to update the UI, proces\", \"s the message on the UI thread in the subscriber by invoking the Device.BeginInvokeOnMainThread meth\", \"od.\\n\\nFor more information about MessagingCenter , see MessagingCenter on the Xamarin Developer Cente\", \"r.\\n\\n## Defining a message\\n\\nMessagingCenter messages are strings that are used to identify messages. \", \"The following code example shows the messages defined within the eShopOnContainers mobile app:\\n\\n```\\n\", \"public class MessengerKeys { // Add product to basket public const string AddProduct = \\\"AddProduct\\\";\", \" // Filter public const string Filter = \\\"Filter\\\"; // Change selected Tab programmatically public con\", \"st string ChangeTab = \\\"ChangeTab\\\"; }\\n```\\n\\nIn this example, messages are defined using constants. The\", \" advantage of this approach is that it provides compile-time type safety and refactoring support.\\n\\n#\", \"# Publishing a message\\n\\nPublishers notify subscribers of a message with one of the MessagingCenter.S\", \"end overloads. The following code example demonstrates publishing the AddProduct message:\\n\\n```\\nMessa\", \"gingCenter.Send(this, MessengerKeys.AddProduct, catalogItem);\\n```\\n\\nIn this example, the Send method \", \"specifies three arguments:\\n\\n- The first argument specifies the sender class. The sender class must b\", \"e specified by any subscribers who wish to receive the message.\\n- The second argument specifies the \", \"message.\\n- The third argument specifies the payload data to be sent to the subscriber. In this case \", \"the payload data is a CatalogItem instance.\\n\\nThe Send method will publish the message, and its paylo\", \"ad data, using a fire-and-forget approach. Therefore, the message is sent even if there are no subsc\", \"ribers registered to receive the message. In this situation, the sent message is ignored.\\n\\nNote: The\", \" MessagingCenter.Send method can use generic parameters to control how messages are delivered. There\", \"fore, multiple messages that share a message identity but send different payload data types can be r\", \"eceived by different subscribers.\\n\\n## Subscribing to a message\\n\\nSubscribers can register to receive \", \"a message using one of the MessagingCenter.Subscribe overloads. The following code example demonstra\", \"tes how the eShopOnContainers mobile app subscribes to, and processes, the AddProduct message:\\n\\n```\\n\", \"MessagingCenter.Subscribe<CatalogViewModel, CatalogItem>( this, MessageKeys.AddProduct, async (sende\", \"r, arg) => { BadgeCount++; await AddCatalogItemAsync(arg); });\\n```\\n\\nIn this example, the Subscribe m\", \"ethod subscribes to the AddProduct message, and executes a callback delegate in response to receivin\", \"g the message. This callback delegate, specified as a lambda expression, executes code that updates \", \"the UI.\\n\\nTip: Consider using immutable payload data\\n\\nDon't attempt to modify the payload data from w\", \"ithin a callback delegate because several threads could be accessing the received data simultaneousl\", \"y. In this scenario, the payload data should be immutable to avoid concurrency errors.\\n\\nA subscriber\", \" might not need to handle every instance of a published message, and this can be controlled by the g\", \"eneric type arguments that are specified on the Subscribe method. In this example, the subscriber wi\", \"ll only receive AddProduct messages that are sent from the CatalogViewModel class, whose payload dat\", \"a is a CatalogItem instance.\\n\\n## Unsubscribing from a message\\n\\nSubscribers can unsubscribe from mess\", \"ages they no longer want to receive. This is achieved with one of the MessagingCenter.Unsubscribe ov\", \"erloads, as demonstrated in the following code example:\\n\\n```\\nMessagingCenter.Unsubscribe<CatalogView\", \"Model, CatalogItem>(this, MessengerKeys.AddProduct);\\n```\\n\\nIn this example, the Unsubscribe method sy\", \"ntax reflects the type arguments specified when subscribing to receive the AddProduct message.\\n\\n## S\", \"ummary\\n\\nThe Xamarin.Forms MessagingCenter class implements the publish-subscribe pattern, allowing m\", \"essage-based communication between components that are inconvenient to link by object and type refer\", \"ences. This mechanism allows publishers and subscribers to communicate without having a reference to\", \" each other, helping to reduce dependencies between components, while also allowing components to be\", \" independently developed and tested.\\n\\n## Navigation\\n\\nXamarin.Forms includes support for page navigat\", \"ion, which typically results from the user's interaction with the UI or from the app itself as a res\", \"ult of internal logic-driven state changes. However, navigation can be complex to implement in apps \", \"that use the Model-View-ViewModel (MVVM) pattern, as the following challenges must be met:\\n\\n- How to\", \" identify the view to be navigated to, using an approach that does not introduce tight coupling and \", \"dependencies between views.\\n- How to coordinate the process by which the view to be navigated to is \", \"instantiated and initialized. When using MVVM, the view and view model need to be instantiated and a\", \"ssociated with each other via the view's binding context. When an app is using a dependency injectio\", \"n container, the instantiation of views and view models might require a specific construction mechan\", \"ism.\\n- Whether to perform view-first navigation, or view model-first navigation. With view-first nav\", \"igation, the page to navigate to refers to the name of the view type. During navigation, the specifi\", \"ed view is instantiated, along with its corresponding view model and other dependent services. An al\", \"ternative approach is to use view model-first navigation, where the page to navigate to refers to th\", \"e name of the view model type.\\n- How to cleanly separate the navigational behavior of the app across\", \" the views and view models. The MVVM pattern provides a separation between the app's UI and its pres\", \"entation and business logic. However, the navigation behavior of an app will often span the UI and p\", \"resentations parts of the app. The user will often initiate navigation from a view, and the view wil\", \"l be replaced as a result of the navigation. However, navigation might often also need to be initiat\", \"ed or coordinated from within the view model.\\n- How to pass parameters during navigation for initial\", \"ization purposes. For example, if the user navigates to a view to update order details, the order da\", \"ta will have to be passed to the view so that it can display the correct data.\\n- How to co-ordinate \", \"navigation, to ensure that certain business rules are obeyed. For example, users might be prompted b\", \"efore navigating away from a view so that they can correct any invalid data or be prompted to submit\", \" or discard any data changes that were made within the view.\\n\\nThis chapter addresses these challenge\", \"s by presenting a NavigationService class that's used to perform view model-first page navigation.\\n\\n\", \"Note: The NavigationService used by the app is designed only to perform hierarchical navigation betw\", \"een ContentPage instances. Using the service to navigate between other page types might result in un\", \"expected behavior.\\n\\n## Navigating between pages\\n\\nNavigation logic can reside in a view's code-behind\", \", or in a data bound view model. While placing navigation logic in a view might be the simplest appr\", \"oach, it is not easily testable through unit tests. Placing navigation logic in view model classes m\", \"eans that the logic can be exercised through unit tests. In addition, the view model can then implem\", \"ent logic to control navigation to ensure that certain business rules are enforced. For example, an \", \"app might not allow the user to navigate away from a page without first ensuring that the entered da\", \"ta is valid.\\n\\nA NavigationService class is typically invoked from view models, in order to promote t\", \"estability. However, navigating to views from view models would require the view models to reference\", \" views, and particularly views that the active view model isn't associated with, which is not recomm\", \"ended. Therefore, the NavigationService presented here specifies the view model type as the target t\", \"o navigate to.\\n\\nThe eShopOnContainers mobile app uses the NavigationService class to provide view mo\", \"del-first navigation. This class implements the INavigationService interface, which is shown in the \", \"following code example:\\n\\n```\\npublic interface INavigationService { ViewModelBase PreviousPageViewMod\", \"el { get; } Task InitializeAsync(); Task NavigateToAsync<TViewModel>() where TViewModel : ViewModelB\", \"ase; Task NavigateToAsync<TViewModel>(object parameter) where TViewModel : ViewModelBase; Task Remov\", \"eLastFromBackStackAsync(); Task RemoveBackStackAsync(); }\\n```\\n\\nThis interface specifies that an impl\", \"ementing class must provide the following methods:\\n\\n| Method                        | Purpose       \", \"                                                             |\\n|-------------------------------|----\", \"------------------------------------------------------------------------|\\n| InitializeAsync         \", \"      | Performs navigation to one of two pages when the app is launched.          |\\n| NavigateToAsy\", \"nc<T>            | Performs hierarchical navigation to a specified page.                      |\\n| Na\", \"vigateToAsync<T>(parameter) | Performs hierarchical navigation to a specified page, passing a parame\", \"ter. |\\n| RemoveLastFromBackStackAsync  | Removes the previous page from the navigation stack.       \", \"                |\\n| RemoveBackStackAsync          | Removes all the previous pages from the navigati\", \"on stack.                  |\\n\\nIn addition, the INavigationService interface specifies that an implem\", \"enting class must provide a PreviousPageViewModel property. This property returns the view model typ\", \"e associated with the previous page in the navigation stack.\\n\\nNote: An INavigationService interface \", \"would usually also specify a GoBackAsync method, which is used to programmatically return to the pre\", \"vious page in the navigation stack. However, this method is missing from the eShopOnContainers mobil\", \"e app because it's not required.\\n\\n## Creating the NavigationService instance\\n\\nThe NavigationService \", \"class, which implements the INavigationService interface, is registered as a singleton with the Auto\", \"fac dependency injection container, as demonstrated in the following code example:\\n\\n```\\nbuilder.Regi\", \"sterType<NavigationService>().As<INavigationService>().SingleInstance();\\n```\\n\\nThe INavigationService\", \" interface is resolved in the ViewModelBase class constructor, as demonstrated in the following code\", \" example:\\n\\n```\\nNavigationService = ViewModelLocator.Resolve<INavigationService>();\\n```\\n\\nThis returns\", \" a reference to the NavigationService object that's stored in the Autofac dependency injection conta\", \"iner, which is created by the InitNavigation method in the App class. For more information, see Navi\", \"gating when the app is launched.\\n\\nThe ViewModelBase class stores the NavigationService instance in a\", \" NavigationService property, of type INavigationService . Therefore, all view model classes, which d\", \"erive from the ViewModelBase class, can use the NavigationService property to access the methods spe\", \"cified by the INavigationService interface. This avoids the overhead of injecting the NavigationServ\", \"ice object from the Autofac dependency injection container into each view model class.\\n\\n## Handling \", \"navigation requests\\n\\nXamarin.Forms provides the NavigationPage class, which implements a hierarchica\", \"l navigation experience in which the user is able to navigate through pages, forwards and backwards,\", \" as desired. For more information about hierarchical navigation, see Hierarchical Navigation on the \", \"Xamarin Developer Center.\\n\\nRather than use the NavigationPage class directly, the eShopOnContainers \", \"app wraps the NavigationPage class in the CustomNavigationView class, as shown in the following code\", \" example:\\n\\n```\\npublic partial class CustomNavigationView : NavigationPage { public CustomNavigationV\", \"iew() : base() { InitializeComponent(); } public CustomNavigationView(Page root) : base(root) { Init\", \"ializeComponent(); } }\\n```\\n\\nThe purpose of this wrapping is for ease of styling the NavigationPage i\", \"nstance inside the XAML file for the class.\\n\\nNavigation is performed inside view model classes by in\", \"voking one of the NavigateToAsync methods, specifying the view model type for the page being navigat\", \"ed to, as demonstrated in the following code example:\\n\\n```\\nawait NavigationService.NavigateToAsync<M\", \"ainViewModel>();\\n```\\n\\nThe following code example shows the NavigateToAsync methods provided by the N\", \"avigationService class:\\n\\n```\\npublic Task NavigateToAsync<TViewModel>() where TViewModel : ViewModelB\", \"ase { return InternalNavigateToAsync(typeof(TViewModel), null); } public Task NavigateToAsync<TViewM\", \"odel>(object parameter) where TViewModel : ViewModelBase { return InternalNavigateToAsync(typeof(TVi\", \"ewModel), parameter); }\\n```\\n\\nEach method allows any view model class that derives from the ViewModel\", \"Base class to perform hierarchical navigation by invoking the InternalNavigateToAsync method. In add\", \"ition, the second NavigateToAsync method enables navigation data to be specified as an argument that\", \"'s passed to the view model being navigated to, where it's typically used to perform initialization.\", \" For more information, see Passing parameters during navigation.\\n\\nThe InternalNavigateToAsync method\", \" executes the navigation request, and is shown in the following code example:\\n\\n```\\nprivate async Tas\", \"k InternalNavigateToAsync(Type viewModelType, object parameter) { Page page = CreatePage(viewModelTy\", \"pe, parameter); if (page is LoginView) { Application.Current.MainPage = new CustomNavigationView(pag\", \"e); } else { var navigationPage = Application.Current.MainPage as CustomNavigationView; if (navigati\", \"onPage != null) { await navigationPage.PushAsync(page); } else { Application.Current.MainPage = new \", \"CustomNavigationView(page); } } await (page.BindingContext as ViewModelBase).InitializeAsync(paramet\", \"er); } private Type GetPageTypeForViewModel(Type viewModelType) { var viewName = viewModelType.FullN\", \"ame.Replace(\\\"Model\\\", string.Empty); var viewModelAssemblyName = viewModelType.GetTypeInfo().Assembly\", \".FullName; var viewAssemblyName = string.Format( CultureInfo.InvariantCulture, \\\"{0}, {1}\\\", viewName,\", \" viewModelAssemblyName); var viewType = Type.GetType(viewAssemblyName); return viewType; } private P\", \"age CreatePage(Type viewModelType, object parameter) { Type pageType = GetPageTypeForViewModel(viewM\", \"odelType); if (pageType == null) { throw new Exception($\\\"Cannot locate page type for {viewModelType}\", \"\\\"); }\\n```\\n\\n```\\nPage page = Activator.CreateInstance(pageType) as Page; return page; }\\n```\\n\\nThe Inter\", \"nalNavigateToAsync method performs navigation to a view model by first calling the CreatePage method\", \". This method locates the view that corresponds to the specified view model type, and creates and re\", \"turns an instance of this view type. Locating the view that corresponds to the view model type uses \", \"a convention-based approach, which assumes that:\\n\\n- Views are in the same assembly as view model typ\", \"es.\\n- Views are in a .Views child namespace.\\n- View models are in a .ViewModels child namespace.\\n- V\", \"iew names correspond to view model names, with \\\"Model\\\" removed.\\n\\nWhen a view is instantiated, it's a\", \"ssociated with its corresponding view model. For more information about how this occurs, see Automat\", \"ically creating a view model with a view model locator.\\n\\nIf the view being created is a LoginView , \", \"it's wrapped inside a new instance of the CustomNavigationView class and assigned to the Application\", \".Current.MainPage property. Otherwise, the CustomNavigationView instance is retrieved, and provided \", \"that it isn't null , the PushAsync method is invoked to push the view being created onto the navigat\", \"ion stack. However, If the retrieved CustomNavigationView instance is null , the view being created \", \"is wrapped inside a new instance of the CustomNavigationView class and assigned to the\\n\\nApplication.\", \"Current.MainPage property. This mechanism ensures that during navigation, pages are added correctly \", \"to the navigation stack both when it's empty, and when it contains data.\\n\\nTip: Consider caching page\", \"s\\n\\nPage caching results in memory consumption for views that are not currently displayed. However, w\", \"ithout page caching it does mean that XAML parsing and construction of the page and its view model w\", \"ill occur every time a new page is navigated to, which can have a performance impact for a complex p\", \"age. For a well-designed page that does not use an excessive number of controls, the performance sho\", \"uld be sufficient. However, page caching might help if slow page loading times are encountered.\\n\\nAft\", \"er the view is created and navigated to, the InitializeAsync method of the view's associated view mo\", \"del is executed. For more information, see Passing parameters during navigation.\\n\\n## Navigating when\", \" the app is launched\\n\\nWhen the app is launched, the InitNavigation method in the App class is invoke\", \"d. The following code example shows this method:\\n\\n```\\nprivate Task InitNavigation() { var navigation\", \"Service = ViewModelLocator.Resolve<INavigationService>(); return navigationService.InitializeAsync()\", \"; }\\n```\\n\\nThe method creates a new NavigationService object in the Autofac dependency injection conta\", \"iner, and returns a reference to it, before invoking its InitializeAsync method.\\n\\nNote: When the INa\", \"vigationService interface is resolved by the ViewModelBase class, the container returns a reference \", \"to the NavigationService object that was created when the InitNavigation method is invoked.\\n\\nThe fol\", \"lowing code example shows the NavigationService InitializeAsync method:\\n\\n```\\npublic Task InitializeA\", \"sync() { if (string.IsNullOrEmpty(Settings.AuthAccessToken)) return NavigateToAsync<LoginViewModel>(\", \"); else return NavigateToAsync<MainViewModel>(); }\\n```\\n\\nThe MainView is navigated to if the app has \", \"a cached access token, which is used for authentication. Otherwise, the LoginView is navigated to.\\n\\n\", \"For more information about the Autofac dependency injection container, see Introduction to dependenc\", \"y injection.\\n\\n## Passing parameters during navigation\\n\\nOne of the NavigateToAsync methods, specified\", \" by the INavigationService interface, enables navigation data to be specified as an argument that's \", \"passed to the view model being navigated to, where it's typically used to perform initialization.\\n\\nF\", \"or example, the ProfileViewModel class contains an OrderDetailCommand that's executed when the user \", \"selects an order on the ProfileView page. In turn, this executes the OrderDetailAsync method, which \", \"is shown in the following code example:\\n\\n```\\nprivate async Task OrderDetailAsync(Order order) { awai\", \"t NavigationService.NavigateToAsync<OrderDetailViewModel>(order); }\\n```\\n\\nThis method invokes navigat\", \"ion to the OrderDetailViewModel , passing an Order instance that represents the order that the user \", \"selected on the ProfileView page. When the NavigationService class creates the OrderDetailView , the\", \" OrderDetailViewModel class is instantiated and assigned to the view's BindingContext . After naviga\", \"ting to the OrderDetailView , the InternalNavigateToAsync method executes the InitializeAsync method\", \" of the view's associated view model.\\n\\nThe InitializeAsync method is defined in the ViewModelBase cl\", \"ass as a method that can be overridden. This method specifies an object argument that represents the\", \" data to be passed to a view model during a navigation operation. Therefore, view model classes that\", \" want to receive data from a navigation operation provide their own implementation of the Initialize\", \"Async method to perform the required initialization. The following code example shows the Initialize\", \"Async method from the OrderDetailViewModel class:\\n\\n```\\npublic override async Task InitializeAsync(ob\", \"ject navigationData) { if (navigationData is Order) { ... Order = await _ordersService.GetOrderAsync\", \"( Convert.ToInt32(order.OrderNumber), authToken);\\n```\\n\\n```\\n... } }\\n```\\n\\nThis method retrieves the Or\", \"der instance that was passed into the view model during the navigation operation, and uses it to ret\", \"rieve the full order details from the OrderService instance.\\n\\n## Invoking navigation using behaviors\", \"\\n\\nNavigation is usually triggered from a view by a user interaction. For example, the LoginView perf\", \"orms navigation following successful authentication. The following code example shows how the naviga\", \"tion is invoked by a behavior:\\n\\n```\\n<WebView ...> <WebView.Behaviors> <behaviors:EventToCommandBehav\", \"ior EventName=\\\"Navigating\\\" EventArgsConverter=\\\"{StaticResource WebNavigatingEventArgsConverter}\\\" Com\", \"mand=\\\"{Binding NavigateCommand}\\\" /> </WebView.Behaviors> </WebView>\\n```\\n\\nAt runtime, the EventToComm\", \"andBehavior will respond to interaction with the WebView . When the WebView navigates to a web page,\", \" the Navigating event will fire, which will execute the NavigateCommand in the LoginViewModel . By d\", \"efault, the event arguments for the event are passed to the command. This data is converted as it's \", \"passed between source and target by the converter specified in the EventArgsConverter property, whic\", \"h returns the Url from the WebNavigatingEventArgs . Therefore, when the NavigationCommand is execute\", \"d, the Url of the web page is passed as a parameter to the registered Action .\\n\\nIn turn, the Navigat\", \"ionCommand executes the NavigateAsync method, which is shown in the following code example:\\n\\n```\\npri\", \"vate async Task NavigateAsync(string url) { ... await NavigationService.NavigateToAsync<MainViewMode\", \"l>(); await NavigationService.RemoveLastFromBackStackAsync(); ... }\\n```\\n\\nThis method invokes navigat\", \"ion to the MainViewModel , and following navigation, removes the LoginView page from the navigation \", \"stack.\\n\\n## Confirming or cancelling navigation\\n\\nAn app might need to interact with the user during a\", \" navigation operation, so that the user can confirm or cancel navigation. This might be necessary, f\", \"or example, when the user attempts to navigate before having fully completed a data entry page. In t\", \"his situation, an app should provide a notification that allows the user to navigate away from the p\", \"age, or to cancel the navigation operation before it occurs. This can be achieved in a view model cl\", \"ass by using the response from a notification to control whether or not navigation is invoked.\\n\\n## S\", \"ummary\\n\\nXamarin.Forms includes support for page navigation, which typically results from the user's \", \"interaction with the UI, or from the app itself, as a result of internal logic-driven state changes.\", \" However, navigation can be complex to implement in apps that use the MVVM pattern.\\n\\nThis chapter pr\", \"esented a NavigationService class, which is used to perform view model-first navigation from view mo\", \"dels. Placing navigation logic in view model classes means that the logic can be exercised through a\", \"utomated tests. In addition, the view model can then implement logic to control navigation to ensure\", \" that certain business rules are enforced.\\n\\nhe app.\\n\\nEntry gets errors to display\\n\\nsets properties\\n\\n\", \"IValidity\\n\\n## Validation\\n\\nadds\\n\\nAny app that accepts input from users should ensure that the input i\", \"s valid. An app could, for example, check for input that contains only characters in a particular ra\", \"nge, is of a certain length, or matches a particular format. Without validation, a user can supply d\", \"ata that causes the app to fail. Validation enforces business rules, and prevents an attacker from i\", \"njecting malicious data.\\n\\nIn the context of the Model-ViewModel-Model (MVVM) pattern, a view model o\", \"r model will often be required to perform data validation and signal any validation errors to the vi\", \"ew so that the user can correct them. The eShopOnContainers mobile app performs synchronous client-s\", \"ide validation of view model properties and notifies the user of any validation errors by highlighti\", \"ng the control that contains the invalid data, and by displaying error messages that inform the user\", \" of why the data is invalid. Figure 6-1 shows the classes involved in performing validation in the e\", \"ShopOnContainers mobile app.\\n\\nFigure 6-1 : Validation classes in the eShopOnContainers mobile app\\n\\nV\", \"iew model properties that require validation are of type ValidatableObject&lt;T&gt; , and each Valid\", \"atableObject&lt;T&gt; instance has validation rules added to its Validations property. Validation is\", \" invoked from the view model by calling the Validate method of the ValidatableObject&lt;T&gt;\\n\\nINoti\", \"fyPropertyChanged\\n\\ninstance, which retrieves the validation rules and executes them against the Vali\", \"datableObject&lt;T&gt; Value property. Any validation errors are placed into the Errors property of \", \"the ValidatableObject&lt;T&gt; instance, and the IsValid property of the ValidatableObject&lt;T&gt; \", \"instance is updated to indicate whether validation succeeded or failed.\\n\\nProperty change notificatio\", \"n is provided by the ExtendedBindableObject class, and so an Entry control can bind to the IsValid p\", \"roperty of ValidatableObject&lt;T&gt; instance in the view model class to be notified of whether or \", \"not the entered data is valid.\\n\\n## Specifying validation rules\\n\\nValidation rules are specified by cr\", \"eating a class that derives from the IValidationRule&lt;T&gt; interface, which is shown in the follo\", \"wing code example:\\n\\n```\\npublic interface IValidationRule<T> { string ValidationMessage { get; set; }\", \" bool Check(T value); }\\n```\\n\\nThis interface specifies that a validation rule class must provide a bo\", \"olean Check method that is used to perform the required validation, and a ValidationMessage property\", \" whose value is the validation error message that will be displayed if validation fails.\\n\\nThe follow\", \"ing code example shows the IsNotNullOrEmptyRule&lt;T&gt; validation rule, which is used to perform v\", \"alidation of the username and password entered by the user on the LoginView when using mock services\", \" in the eShopOnContainers mobile app:\\n\\n```\\npublic class IsNotNullOrEmptyRule<T> : IValidationRule<T>\", \" { public string ValidationMessage { get; set; } public bool Check(T value) { if (value == null) { r\", \"eturn false; } var str = value as string; return !string.IsNullOrWhiteSpace(str); } }\\n```\\n\\nThe Check\", \" method returns a boolean indicating whether the value argument is null , empty, or consists only of\", \" whitespace characters.\\n\\nAlthough not used by the eShopOnContainers mobile app, the following code e\", \"xample shows a validation rule for validating email addresses:\\n\\n```\\npublic class EmailRule<T> : IVal\", \"idationRule<T> { public string ValidationMessage { get; set; } public bool Check(T value) { if (valu\", \"e == null)\\n```\\n\\n```\\n{ return false; } var str = value as string; Regex regex = new Regex(@\\\"^([\\\\w\\\\.\\\\-\", \"]+)@([\\\\w\\\\-]+)((\\\\.(\\\\w){2,3})+)$\\\"); Match match = regex.Match(str); return match.Success; } }\\n```\\n\\nThe\", \" Check method returns a boolean indicating whether or not the value argument is a valid email addres\", \"s. This is achieved by searching the value argument for the first occurrence of the regular expressi\", \"on pattern specified in the Regex constructor. Whether the regular expression pattern has been found\", \" in the input string can be determined by checking the value of the Match object's Success property.\", \"\\n\\nNote: Property validation can sometimes involve dependent properties. An example of dependent prop\", \"erties is when the set of valid values for property A depends on the particular value that has been \", \"set in property B. To check that the value of property A is one of the allowed values would involve \", \"retrieving the value of property B. In addition, when the value of property B changes, property A wo\", \"uld need to be revalidated.\\n\\n## Adding validation rules to a property\\n\\nIn the eShopOnContainers mobi\", \"le app, view model properties that require validation are declared to be of type ValidatableObject&l\", \"t;T&gt;, where T is the type of the data to be validated. The following code example shows an exampl\", \"e of two such properties:\\n\\n```\\npublic ValidatableObject<string> UserName { get { return _userName; }\", \" set { _userName = value; RaisePropertyChanged(() => UserName); } } public ValidatableObject<string>\", \" Password { get { return _password; } set { _password = value; RaisePropertyChanged(() => Password);\", \" } }\\n```\\n\\nFor validation to occur, validation rules must be added to the Validations collection of e\", \"ach ValidatableObject&lt;T&gt; instance, as demonstrated in the following code example:\\n\\n```\\nprivate\", \" void AddValidations() { _userName.Validations.Add(new IsNotNullOrEmptyRule<string> { ValidationMess\", \"age = \\\"A username is required.\\\" }); _password.Validations.Add(new IsNotNullOrEmptyRule<string> { Val\", \"idationMessage = \\\"A password is required.\\\" }); }\\n```\\n\\nThis method adds the IsNotNullOrEmptyRule&lt;T\", \"&gt; validation rule to the Validations collection of each ValidatableObject&lt;T&gt; instance, spec\", \"ifying values for the validation rule's ValidationMessage property, which specifies the validation e\", \"rror message that will be displayed if validation fails.\\n\\n## Triggering validation\\n\\nThe validation a\", \"pproach used in the eShopOnContainers mobile app can manually trigger validation of a property, and \", \"automatically trigger validation when a property changes.\\n\\n## Triggering validation manually\\n\\nValida\", \"tion can be triggered manually for a view model property. For example, this occurs in the eShopOnCon\", \"tainers mobile app when the user taps the Login button on the LoginView , when using mock services. \", \"The command delegate calls the MockSignInAsync method in the LoginViewModel , which invokes validati\", \"on by executing the Validate method, which is shown in the following code example:\\n\\n```\\nprivate bool\", \" Validate() { bool isValidUser = ValidateUserName(); bool isValidPassword = ValidatePassword(); retu\", \"rn isValidUser && isValidPassword; } private bool ValidateUserName() { return _userName.Validate(); \", \"} private bool ValidatePassword() { return _password.Validate(); }\\n```\\n\\nThe Validate method performs\", \" validation of the username and password entered by the user on the LoginView , by invoking the Vali\", \"date method on each ValidatableObject&lt;T&gt; instance. The following code example shows the Valida\", \"te method from the ValidatableObject&lt;T&gt; class:\\n\\n```\\npublic bool Validate() { Errors.Clear(); I\", \"Enumerable<string> errors = _validations .Where(v => !v.Check(Value)) .Select(v => v.ValidationMessa\", \"ge);\\n```\\n\\n```\\nErrors = errors.ToList(); IsValid = !Errors.Any(); return this.IsValid; }\\n```\\n\\nThis me\", \"thod clears the Errors collection, and then retrieves any validation rules that were added to the ob\", \"ject's Validations collection. The Check method for each retrieved validation rule is executed, and \", \"the ValidationMessage property value for any validation rule that fails to validate the data is adde\", \"d to the Errors collection of the ValidatableObject&lt;T&gt; instance. Finally, the IsValid property\", \" is set, and its value is returned to the calling method, indicating whether validation succeeded or\", \" failed.\\n\\n## Triggering validation when properties change\\n\\nValidation is also automatically triggere\", \"d whenever a bound property changes. For example, when a two-way binding in the LoginView sets the U\", \"serName or Password property, validation is triggered. The following code example demonstrates how t\", \"his occurs:\\n\\n```\\n<Entry Text=\\\"{Binding UserName.Value, Mode=TwoWay}\\\"> <Entry.Behaviors> <behaviors:E\", \"ventToCommandBehavior EventName=\\\"TextChanged\\\" Command=\\\"{Binding ValidateUserNameCommand}\\\" /> </Entry\", \".Behaviors> ... </Entry>\\n```\\n\\nThe Entry control binds to the UserName.Value property of the Validata\", \"bleObject&lt;T&gt; instance, and the control's Behaviors collection has an EventToCommandBehavior in\", \"stance added to it. This behavior executes the ValidateUserNameCommand in response to the TextChange\", \"d event firing on the Entry, which is raised when the text in the Entry changes. In turn, the\\n\\nValid\", \"ateUserNameCommand delegate executes the ValidateUserName method, which executes the Validate method\", \" on the ValidatableObject&lt;T&gt; instance. Therefore, every time the user enters a character in th\", \"e Entry control for the username, validation of the entered data is performed.\\n\\nFor more information\", \" about behaviors, see Implementing behaviors.\\n\\n## Displaying validation errors\\n\\nThe eShopOnContainer\", \"s mobile app notifies the user of any validation errors by highlighting the control that contains th\", \"e invalid data with a red line, and by displaying an error message that informs the user why the dat\", \"a is invalid below the control containing the invalid data. When the invalid data is corrected, the \", \"line changes to black and the error message is removed. Figure 6-2 shows the LoginView in the eShopO\", \"nContainers mobile app when validation errors are present.\\n\\nUser name or email\\n\\n```\\nA username is re\", \"quired. Password A password is required.\\n```\\n\\nFigure 6-2: Displaying validation errors during login\\n\", \"\\n## Highlighting a control that contains invalid data\\n\\nThe LineColorBehavior attached behavior is us\", \"ed to highlight Entry controls where validation errors have occurred. The following code example sho\", \"ws how the LineColorBehavior attached behavior is attached to an Entry control:\\n\\n```\\n<Entry Text=\\\"{B\", \"inding UserName.Value, Mode=TwoWay}\\\"> <Entry.Style> <OnPlatform x:TypeArguments=\\\"Style\\\" iOS=\\\"{Static\", \"Resource EntryStyle}\\\" Android=\\\"{StaticResource EntryStyle}\\\" WinPhone=\\\"{StaticResource UwpEntryStyle}\", \"\\\"/> </Entry.Style> ... </Entry>\\n```\\n\\nThe Entry control consumes an explicit style, which is shown in\", \" the following code example:\\n\\n```\\n<Style x:Key=\\\"EntryStyle\\\" TargetType=\\\"{x:Type Entry}\\\"> ... <Setter\", \" Property=\\\"behaviors:LineColorBehavior.ApplyLineColor\\\" Value=\\\"True\\\" /> <Setter Property=\\\"behaviors:L\", \"ineColorBehavior.LineColor\\\" Value=\\\"{StaticResource BlackColor}\\\" /> ... </Style>\\n```\\n\\nThis style sets\", \" the ApplyLineColor and LineColor attached properties of the LineColorBehavior attached behavior on \", \"the Entry control. For more information about styles, see Styles on the Xamarin Developer Center.\\n\\nW\", \"hen the value of the ApplyLineColor attached property is set, or changes, the LineColorBehavior atta\", \"ched behavior executes the OnApplyLineColorChanged method, which is shown in the following code exam\", \"ple:\\n\\n```\\npublic static class LineColorBehavior { ... private static void OnApplyLineColorChanged( B\", \"indableObject bindable, object oldValue, object newValue) { var view = bindable as View; if (view ==\", \" null) { return; } bool hasLine = (bool)newValue; if (hasLine) { view.Effects.Add(new EntryLineColor\", \"Effect()); } else { var entryLineColorEffectToRemove = view.Effects.FirstOrDefault(e => e is EntryLi\", \"neColorEffect); if (entryLineColorEffectToRemove != null) { view.Effects.Remove(entryLineColorEffect\", \"ToRemove); } } } }\\n```\\n\\nThe parameters for this method provide the instance of the control that the \", \"behavior is attached to, and the old and new values of the ApplyLineColor attached property. The Ent\", \"ryLineColorEffect class is added to the control's Effects collection if the ApplyLineColor attached \", \"property is true , otherwise it's removed from the control's Effects collection. For more informatio\", \"n about behaviors, see Implementing behaviors.\\n\\nThe EntryLineColorEffect subclasses the RoutingEffec\", \"t class, and is shown in the following code example:\\n\\n```\\npublic class EntryLineColorEffect : Routin\", \"gEffect { public EntryLineColorEffect() : base(\\\"eShopOnContainers.EntryLineColorEffect\\\") { } }\\n```\\n\\n\", \"The RoutingEffect class represents a platform-independent effect that wraps an inner effect that's p\", \"latform-specific. This simplifies the effect removal process, since there is no compile-time access \", \"to the type information for a platform-specific effect. The EntryLineColorEffect calls the base clas\", \"s constructor, passing in a parameter consisting of a concatenation of the resolution group name, an\", \"d the unique ID that's specified on each platform-specific effect class.\\n\\nThe following code example\", \" shows the eShopOnContainers.EntryLineColorEffect implementation for iOS:\\n\\n```\\n[assembly: Resolution\", \"GroupName(\\\"eShopOnContainers\\\")] [assembly: ExportEffect(typeof(EntryLineColorEffect), \\\"EntryLineColo\", \"rEffect\\\")] namespace eShopOnContainers.iOS.Effects { public class EntryLineColorEffect : PlatformEff\", \"ect\\n```\\n\\n```\\n{ UITextField control; protected override void OnAttached() { try { control = Control a\", \"s UITextField; UpdateLineColor(); } catch (Exception ex) { Console.WriteLine(\\\"Can't set property on \", \"attached control. Error: \\\", ex.Message); } } protected override void OnDetached() { control = null; \", \"} protected override void OnElementPropertyChanged(PropertyChangedEventArgs args) { base.OnElementPr\", \"opertyChanged(args); if (args.PropertyName == LineColorBehavior.LineColorProperty.PropertyName || ar\", \"gs.PropertyName == \\\"Height\\\") { Initialize(); UpdateLineColor(); } } private void Initialize() { var \", \"entry = Element as Entry; if (entry != null) { Control.Bounds = new CGRect(0, 0, entry.Width, entry.\", \"Height); } } private void UpdateLineColor() { BorderLineLayer lineLayer = control.Layer.Sublayers.Of\", \"Type<BorderLineLayer>() .FirstOrDefault(); if (lineLayer == null) { lineLayer = new BorderLineLayer(\", \"); lineLayer.MasksToBounds = true; lineLayer.BorderWidth = 1.0f; control.Layer.AddSublayer(lineLayer\", \"); control.BorderStyle = UITextBorderStyle.None; } lineLayer.Frame = new CGRect(0f, Control.Frame.He\", \"ight-1f, Control.Bounds.Width, 1f); lineLayer.BorderColor = LineColorBehavior.GetLineColor(Element).\", \"ToCGColor(); control.TintColor = control.TextColor; } private class BorderLineLayer : CALayer { }\\n``\", \"`\\n\\nto inalcate thal there is no validation error. rigure o-s snows an example or tnis.\\n\\nUser name or\", \" email\\n\\nUser name or email johndoe\\n\\n```\\n} }\\n```\\n\\nThe OnAttached method retrieves the native control \", \"for the Xamarin.Forms Entry control, and updates the line color by calling the UpdateLineColor metho\", \"d. The OnElementPropertyChanged override responds to bindable property changes on the Entry control \", \"by updating the line color if the attached LineColor property changes, or the Height property of the\", \" Entry changes. For more information about effects, see Effects on the Xamarin Developer Center.\\n\\nWh\", \"en valid data is entered in the Entry control, it will apply a black line to the bottom of the contr\", \"ol, to indicate that there is no validation error. Figure 6-3 shows an example of this.\\n\\nFigure 6-3 \", \": Black line indicating no validation error\\n\\nThe Entry control also has a DataTrigger added to its T\", \"riggers collection. The following code example shows the DataTrigger :\\n\\n```\\n<Entry Text=\\\"{Binding Us\", \"erName.Value, Mode=TwoWay}\\\"> ... <Entry.Triggers> <DataTrigger TargetType=\\\"Entry\\\" Binding=\\\"{Binding \", \"UserName.IsValid}\\\" Value=\\\"False\\\"> <Setter Property=\\\"behaviors:LineColorBehavior.LineColor\\\" Value=\\\"{S\", \"taticResource ErrorColor}\\\" /> </DataTrigger> </Entry.Triggers> </Entry>\\n```\\n\\nThis DataTrigger monito\", \"rs the UserName.IsValid property, and if it's value becomes false , it executes the Setter , which c\", \"hanges the LineColor attached property of the LineColorBehavior attached behavior to red. Figure 6-4\", \" shows an example of this.\\n\\nFigure 6-4 : Red line indicating validation error\\n\\nThe line in the Entry\", \" control will remain red while the entered data is invalid, otherwise it will change to black to ind\", \"icate that the entered data is valid.\\n\\nFor more information about Triggers, see Triggers on the Xama\", \"rin Developer Center.\\n\\n## Displaying error messages\\n\\nThe UI displays validation error messages in La\", \"bel controls below each control whose data failed validation. The following code example shows the L\", \"abel that displays a validation error message if the user has not entered a valid username:\\n\\n&lt;Lab\", \"el Text=\\\"{Binding UserName.Errors, Converter={StaticResource FirstValidationErrorConverter}\\\" Style=\\\"\", \"{StaticResource ValidationErrorLabelStyle}\\\" /&gt;\\n\\nEach Label binds to the Errors property of the vi\", \"ew model object that's being validated. The Errors property is provided by the ValidatableObject&lt;\", \"T&gt; class, and is of type List&lt;string&gt;. Because the Errors property can contain multiple val\", \"idation errors, the FirstValidationErrorConverter instance is used to retrieve the first error from \", \"the collection for display.\\n\\n## Summary\\n\\nThe eShopOnContainers mobile app performs synchronous clien\", \"t-side validation of view model properties and notifies the user of any validation errors by highlig\", \"hting the control that contains the invalid data, and by displaying error messages that inform the u\", \"ser why the data is invalid.\\n\\nView model properties that require validation are of type ValidatableO\", \"bject&lt;T&gt; , and each ValidatableObject&lt;T&gt; instance has validation rules added to its Vali\", \"dations property. Validation is invoked from the view model by calling the Validate method of the Va\", \"lidatableObject&lt;T&gt; instance, which retrieves the validation rules and executes them against th\", \"e ValidatableObject&lt;T&gt; Value property. Any validation errors are placed into the Errors proper\", \"ty of the ValidatableObject&lt;T&gt; instance, and the IsValid property of the ValidatableObject&lt;\", \"T&gt; instance is updated to indicate whether validation succeeded or failed.\\n\\n## Configuration mana\", \"gement\\n\\nSettings allow the separation of data that configures the behavior of an app from the code, \", \"allowing the behavior to be changed without rebuilding the app. There are two types of settings: app\", \" settings, and user settings.\\n\\nApp settings are data that an app creates and manages. It can include\", \" data such as fixed web service endpoints, API keys, and runtime state. App settings are tied to the\", \" existence of the app and are only meaningful to that app.\\n\\nUser settings are the customizable setti\", \"ngs of an app that affect the behavior of the app and don't require frequent re-adjustment. For exam\", \"ple, an app might let the user specify where to retrieve data from, and how to display it on the scr\", \"een.\\n\\nXamarin.Forms includes a persistent dictionary that can be used to store settings data. This d\", \"ictionary can be accessed using the Application.Current.Properties property, and any data that's pla\", \"ced into it is saved when the app goes into a sleep state, and is restored when the app resumes or s\", \"tarts up again. In addition, the Application class also has a SavePropertiesAsync method that allows\", \" an app to have its settings saved when required. For more information about this dictionary, see Pr\", \"operties Dictionary on the Xamarin Developer Center.\\n\\nA downside to storing data using the Xamarin.F\", \"orms persistent dictionary is that it's not easily data bound to. Therefore, the eShopOnContainers m\", \"obile app uses the Xam.Plugins.Settings library, available from NuGet. This library provides a consi\", \"stent, type-safe, cross-platform approach for persisting and retrieving app and user settings, while\", \" using the native settings management provided by each platform. In addition, it's straightforward t\", \"o use data binding to access settings data exposed by the library.\\n\\nNote: While the Xam.Plugin.Setti\", \"ngs library can store both app and user settings, it makes no distinction between the two.\\n\\n## Creat\", \"ing a settings class\\n\\nWhen using the Xam.Plugins.Settings library, a single static class should be c\", \"reated that will contain the app and user settings required by the app. The following code example s\", \"hows the Settings class in the eShopOnContainers mobile app:\\n\\n```\\npublic static class Settings { pri\", \"vate static ISettings AppSettings { get { return CrossSettings.Current; } } ... }\\n```\\n\\nSettings can \", \"be read and written through the ISettings API, which is provided by the Xam.Plugins.Settings library\", \". This library provides a singleton that can be used to access the API, CrossSettings.Current , and \", \"an app's settings class should expose this singleton via an ISettings property.\\n\\nNote: Using directi\", \"ves for the Plugin.Settings and Plugin.Settings.Abstractions namespaces should be added to a class t\", \"hat requires access to the Xam.Plugins.Settings library types.\\n\\n## Adding a setting\\n\\nEach setting co\", \"nsists of a key, a default value, and a property. The following code example shows all three items f\", \"or a user setting that represents the base URL for the online services that the eShopOnContainers mo\", \"bile app connects to:\\n\\n```\\npublic static class Settings { ... private const string IdUrlBase = \\\"url_\", \"base\\\"; private static readonly string UrlBaseDefault = GlobalSetting.Instance.BaseEndpoint; ... publ\", \"ic static string UrlBase { get { return AppSettings.GetValueOrDefault<string>(IdUrlBase, UrlBaseDefa\", \"ult); } set { AppSettings.AddOrUpdateValue<string>(IdUrlBase, value); } } }\\n```\\n\\nThe key is always a\", \" const string that defines the key name, with the default value for the setting being a static reado\", \"nly value of the required type. Providing a default value ensures that a valid value is available if\", \" an unset setting is retrieved.\\n\\nThe UrlBase static property uses two methods from the ISettings API\", \" to read or write the setting value. The ISettings.GetValueOrDefault method is used to retrieve a se\", \"tting's value from platform-specific storage. If no value is defined for the setting, its default va\", \"lue is retrieved instead. Similarly, the ISettings.AddOrUpdateValue method is used to persist a sett\", \"ing's value to platformspecific storage.\\n\\nRather that define a default value inside the Settings cla\", \"ss, the UrlBaseDefault string obtains its value from the GlobalSetting class. The following code exa\", \"mple shows the BaseEndpoint property and UpdateEndpoint method in this class:\\n\\n```\\npublic class Glob\", \"alSetting { ... public string BaseEndpoint { get { return _baseEndpoint; } set { _baseEndpoint = val\", \"ue; UpdateEndpoint(_baseEndpoint); } } ... private void UpdateEndpoint(string baseEndpoint) { Regist\", \"erWebsite = string.Format(\\\"{0}:5105/Account/Register\\\", baseEndpoint); CatalogEndpoint = string.Forma\", \"t(\\\"{0}:5101\\\", baseEndpoint); OrdersEndpoint = string.Format(\\\"{0}:5102\\\", baseEndpoint); BasketEndpoin\", \"t = string.Format(\\\"{0}:5103\\\", baseEndpoint); IdentityEndpoint = string.Format(\\\"{0}:5105/connect/auth\", \"orize\\\", baseEndpoint); UserInfoEndpoint = string.Format(\\\"{0}:5105/connect/userinfo\\\", baseEndpoint); \", \"TokenEndpoint = string.Format(\\\"{0}:5105/connect/token\\\", baseEndpoint); LogoutEndpoint = string.Forma\", \"t(\\\"{0}:5105/connect/endsession\\\", baseEndpoint); IdentityCallback = string.Format(\\\"{0}:5105/xamarinca\", \"llback\\\", baseEndpoint); LogoutCallback = string.Format(\\\"{0}:5105/Account/Redirecting\\\", baseEndpoint)\", \"; } }\\n```\\n\\nEach time the BaseEndpoint property is set, the UpdateEndpoint method is called. This met\", \"hod updates a series of properties, all of which are based on the UrlBase user setting that's provid\", \"ed by the Settings class that represent different endpoints that the eShopOnContainers mobile app co\", \"nnects to.\\n\\n## Data binding to user settings\\n\\nIn the eShopOnContainers mobile app, the SettingsView \", \"exposes two user settings. These settings allow configuration of whether the app should retrieve dat\", \"a from microservices that are deployed as Docker containers, or whether the app should retrieve data\", \" from mock services that don't require an internet connection. When choosing to retrieve data from c\", \"ontainerized microservices, a base endpoint URL for the microservices must be specified. Figure 7-1 \", \"shows the SettingsView when the user has chosen to retrieve data from containerized microservices.\\n\\n\", \"Use Microservices/Containers from eShopOnContainers\\n\\nWhen enabling the use of microservices/containe\", \"rs, network.\\n\\nEndpoint\\n\\nFigure 7-1 : User settings exposed by the eShopOnContainers mobile app\\n\\nData\", \" binding can be used to retrieve and set settings exposed by the Settings class. This is achieved by\", \" controls on the view binding to view model properties that in turn access properties in the Setting\", \"s class, and raising a property changed notification if the settings value has changed. For informat\", \"ion about how the eShopOnContainers mobile app constructs view models and associates them to views, \", \"see Automatically creating a view model with a view model locator.\\n\\nThe following code example shows\", \" the Entry control from the SettingsView that allows the user to enter a base endpoint URL for the c\", \"ontainerized microservices:\\n\\n```\\n<Entry Text=\\\"{Binding Endpoint, Mode=TwoWay}\\\" />\\n```\\n\\nThis Entry co\", \"ntrol binds to the Endpoint property of the SettingsViewModel class, using a two-way binding. The fo\", \"llowing code example shows the Endpoint property:\\n\\n```\\npublic string Endpoint { get { return _endpoi\", \"nt; } set { _endpoint = value; if(!string.IsNullOrEmpty(_endpoint)) { UpdateEndpoint(_endpoint); } R\", \"aisePropertyChanged(() => Endpoint); } }\\n```\\n\\nWhen the Endpoint property is set the UpdateEndpoint m\", \"ethod is called, provided that the supplied value is valid, and property changed notification is rai\", \"sed. The following code example shows the UpdateEndpoint method:\\n\\n```\\nprivate void UpdateEndpoint(st\", \"ring endpoint) { Settings.UrlBase = endpoint; }\\n```\\n\\nThis method updates the UrlBase property in the\", \" Settings class with the base endpoint URL value entered by the user, which causes it to be persiste\", \"d to platform-specific storage.\\n\\nWhen the SettingsView is navigated to, the InitializeAsync method i\", \"n the SettingsViewModel class is executed. The following code example shows this method:\\n\\n```\\npublic\", \" override Task InitializeAsync(object navigationData) { ... Endpoint = Settings.UrlBase; ... }\\n```\\n\\n\", \"The method sets the Endpoint property to the value of the UrlBase property in the Settings class. Ac\", \"cessing the UrlBase property causes the Xam.Plugins.Settings library to retrieve the settings value \", \"from platform-specific storage. For information about how the InitializeAsync method is invoked, see\", \" Passing parameters during navigation.\\n\\nThis mechanism ensures that whenever a user navigates to the\", \" SettingsView , user settings are retrieved from platform-specific storage and presented through dat\", \"a binding. Then, if the user changes the settings values, data binding ensures that they are immedia\", \"tely persisted back to platform-specific storage.\\n\\n## Summary\\n\\nSettings allow the separation of data\", \" that configures the behavior of an app from the code, allowing the behavior to be changed without r\", \"ebuilding the app. App settings are data that an app creates and manages, and user settings are the \", \"customizable settings of an app that affect the behavior of the app and don't require frequent re-ad\", \"justment.\\n\\nThe Xam.Plugins.Settings library provides a consistent, type-safe, cross-platform approac\", \"h for persisting and retrieving app and user settings, and data binding can be used to access settin\", \"gs created with the library.\\n\\n## Containerized microservices\\n\\n\\u2022 Manathic nnestion coing on\\n\\nDevelopi\", \"ng client-server applications has resulted in a focus on building tiered applications that use speci\", \"fic technologies in each tier. Such applications are often referred to as monolithic applications, a\", \"nd are packaged onto hardware pre-scaled for peak loads. The main drawbacks of this development appr\", \"oach are the tight coupling between components within each tier, that individual components can't be\", \" easily scaled, and the cost of testing. A simple update can have unforeseen effects on the rest of \", \"the tier, and so a change to an application component requires its entire tier to be retested and re\", \"deployed.\\n\\nParticularly concerning in the age of the cloud, is that individual components can't be e\", \"asily scaled. A monolithic application contains domain-specific functionality, and is typically divi\", \"ded by functional layers such as front end, business logic, and data storage. A monolithic applicati\", \"on is scaled by cloning the entire application onto multiple machines, as illustrated in Figure 8-1.\", \"\\n\\nFigure 8-1 : Monolithic application scaling approach\\n\\neating instances of services across machines\", \".\\n\\nApp 1\\n\\nApp 2\\n\\n## Microservices\\n\\nMicroservices offer a different approach to application developme\", \"nt and deployment, an approach that's suited to the agility, scale, and reliability requirements of \", \"modern cloud applications. A microservices application is decomposed into independent components tha\", \"t work together to deliver the application's overall functionality. The term microservice emphasizes\", \" that applications should be composed of services small enough to reflect independent concerns, so t\", \"hat each microservice implements a single function. In addition, each microservice has well-defined \", \"contracts so that other microservices can communicate and share data with it. Typical examples of mi\", \"croservices include shopping carts, inventory processing, purchase subsystems, and payment processin\", \"g.\\n\\nMicroservices can scale-out independently, as compared to giant monolithic applications that sca\", \"le together. This means that a specific functional area, that requires more processing power or netw\", \"ork bandwidth to support demand, can be scaled rather than unnecessarily scaling-out other areas of \", \"the application. Figure 8-2 illustrates this approach, where microservices are deployed and scaled i\", \"ndependently, creating instances of services across machines.\\n\\nFigure 8-2 : Microservices applicatio\", \"n scaling approach\\n\\nMicroservice scale-out can be nearly instantaneous, allowing an application to a\", \"dapt to changing loads. For example, a single microservice in the web-facing functionality of an app\", \"lication might be the only microservice in the application that needs to scale out to handle additio\", \"nal incoming traffic.\\n\\nThe classic model for application scalability is to have a load-balanced, sta\", \"teless tier with a shared external datastore to store persistent data. Stateful microservices manage\", \" their own persistent data, usually storing it locally on the servers on which they are placed, to a\", \"void the overhead of network access and complexity of cross-service operations. This enables the fas\", \"test possible processing of data and can eliminate the need for caching systems. In addition, scalab\", \"le stateful microservices usually partition data among their instances, in order to manage data size\", \" and transfer throughput beyond which a single server can support.\\n\\nMicroservices also support indep\", \"endent updates. This loose coupling between microservices provides a rapid and reliable application \", \"evolution. Their independent, distributed nature supports rolling updates, where only a subset of in\", \"stances of a single microservice will update at any given time. Therefore, if a problem is detected,\", \" a buggy update can be rolled back, before all instances update with the faulty code or configuratio\", \"n. Similarly, microservices typically use schema versioning, so that dianeo\\n\\nclients see a consisten\", \"t version when updates are being applied, regardless of which microservice instance is being communi\", \"cated with.\\n\\nTherefore, microservice applications have many benefits over monolithic applications:\\n\\n\", \"- Each microservice is relatively small, easy to manage and evolve.\\n- Each microservice can be devel\", \"oped and deployed independently of other services.\\n- Each microservice can be scaled-out independent\", \"ly. For example, a catalog service or shopping basket service might need to be scaled-out more than \", \"an ordering service. Therefore, the resulting infrastructure will more efficiently consume resources\", \" when scaling out.\\n- Each microservice isolates any issues. For example, if there is an issue in a s\", \"ervice it only impacts that service. The other services can continue to handle requests.\\n- Each micr\", \"oservice can use the latest technologies. Because microservices are autonomous and run side-by-side,\", \" the latest technologies and frameworks can be used, rather than being forced to use an older framew\", \"ork that might be used by a monolithic application.\\n\\nHowever, a microservice based solution also has\", \" potential drawbacks:\\n\\n- Choosing how to partition an application into microservices can be challeng\", \"ing, as each microservice has to be completely autonomous, end-to-end, including responsibility for \", \"its data sources.\\n- Developers must implement inter-service communication, which adds complexity and\", \" latency to the application.\\n- Atomic transactions between multiple microservices usually aren't pos\", \"sible. Therefore, business requirements must embrace eventual consistency between microservices.\\n- I\", \"n production, there is an operational complexity in deploying and managing a system compromised of m\", \"any independent services.\\n- Direct client-to-microservice communication can make it difficult to ref\", \"actor the contracts of microservices. For example, over time how the system is partitioned into serv\", \"ices might need to change. A single service might split into two or more services, and two services \", \"might merge. When clients communicate directly with microservices, this refactoring work can break c\", \"ompatibility with client apps.\\n\\n## Containerization\\n\\nContainerization is an approach to software dev\", \"elopment in which an application and its versioned set of dependencies, plus its environment configu\", \"ration abstracted as deployment manifest files, are packaged together as a container image, tested a\", \"s a unit, and deployed to a host operating system.\\n\\nA container is an isolated, resource controlled,\", \" and portable operating environment, where an application can run without touching the resources of \", \"other containers, or the host. Therefore, a container looks and acts like a newly installed physical\", \" computer or a virtual machine.\\n\\nThere are many similarities between containers and virtual machines\", \", as illustrated in Figure 8-3.\\n\\nVirtual Machines\\n\\nApp 1\\n\\nApp 2\\n\\nBins/Libs\\n\\nGuest OS\\n\\nBins/Libs\\n\\nApp\", \" 3\\n\\nBins/Libs\\n\\nApp 1\\n\\nContainers\\n\\nApp 2\\n\\nApp 3\\n\\nFigure 8-3 : Comparison of virtual machines and cont\", \"ainers\\n\\nA container runs an operating system, has a file system, and can be accessed over a network \", \"as if it were a physical or virtual machine. However, the technology and concepts used by containers\", \" are very different from virtual machines. Virtual machines include the applications, the required d\", \"ependencies, and a full guest operating system. Containers include the application and its dependenc\", \"ies, but share the operating system with other containers, running as isolated processes on the host\", \" operating system (aside from Hyper-V containers which run inside of a special virtual machine per c\", \"ontainer). Therefore, containers share resources and typically require fewer resources than virtual \", \"machines.\\n\\nThe advantage of a container-oriented development and deployment approach is that it elim\", \"inates most of the issues that arise from inconsistent environment setups and the problems that come\", \" with them. In addition, containers permit fast application scale-up functionality by instancing new\", \" containers as required.\\n\\nThe key concepts when creating and working with containers are:\\n\\n- Contain\", \"er Host: The physical or virtual machine configured to host containers. The container host will run \", \"one or more containers.\\n- Container Image: An image consists of a union of layered filesystems stack\", \"ed on top of each other, and is the basis of a container. An image does not have state and it never \", \"changes as it's deployed to different environments.\\n- Container: A container is a runtime instance o\", \"f an image.\\n- Container OS Image: Containers are deployed from images. The container operating syste\", \"m image is the first layer in potentially many image layers that make up a container. A container op\", \"erating system is immutable, and can't be modified.\\n- Container Repository: Each time a container im\", \"age is created, the image and its dependencies are stored in a local repository. These images can be\", \" reused many times on the container host. The container images can also be stored in a public or pri\", \"vate registry, such as Docker Hub, so that they can be used across different container hosts.\\n\\nDocke\", \"r Host\\n\\nIdentity Microservice (STS+Users)\\n\\nWeb API\\n\\nSQL Server database\\n\\nContainer\\n\\nEnterprises are \", \"increasingly adopting containers when implementing microservice based applications, and Docker has b\", \"ecome the standard container implementation that has been adopted by most software platforms and clo\", \"ud vendors.\\n\\nThe eShopOnContainers reference application uses Docker to host four containerized back\", \"-end microservices, as illustrated in Figure 8-4.\\n\\nOrdering Microservice\\n\\nWeb API\\n\\nContainer\\n\\nBasket\", \" Microservice\\n\\nWeb API\\n\\nContainer\\n\\nPAtinare raforans anplication hark-and microcor\\n\\nFigure 8-4 : eSh\", \"opOnContainers reference application back-end microservices\\n\\nThe architecture of the back-end servic\", \"es in the reference application is decomposed into multiple autonomous sub-systems in the form of co\", \"llaborating microservices and containers. Each microservice provides a single area of functionality:\", \" an identity service, a catalog service, an ordering service, and a basket service.\\n\\nEach microservi\", \"ce has its own database, allowing it to be fully decoupled from the other microservices. Where neces\", \"sary, consistency between databases from different microservices is achieved using application-level\", \" events. For more information, see Communication between microservices.\\n\\nFor more information about \", \"the reference application, see .NET Microservices: Architecture for Containerized .NET Applications.\", \"\\n\\n## Communication between client and microservices\\n\\nThe eShopOnContainers mobile app communicates w\", \"ith the containerized back-end microservices using direct client-to-microservice communication, whic\", \"h is shown in Figure 8-5.\\n\\nMobile App\\n\\nFiaure 9-5: Direct client-to-microcervice communication\\n\\nBack\", \"end Microservices\\n\\nMicroservice 1\\n\\nWeb AP\\n\\nFigure 8-5 : Direct client-to-microservice communication\\n\", \"\\nWith direct client-to-microservice communication, the mobile app makes requests to each microservic\", \"e directly through its public endpoint, with a different TCP port per microservice. In production, t\", \"he endpoint would typically map to the microservice's load balancer, which distributes requests acro\", \"ss the available instances.\\n\\nTip: Consider using API gateway communication\\n\\nDirect client-to-microse\", \"rvice communication can have drawbacks when building a large and complex microservice based applicat\", \"ion, but it's more than adequate for a small application. When designing a large microservice based \", \"application with tens of microservices, consider using API gateway communication. For more informati\", \"on, see .NET Microservices: Architecture for Containerized .NET Applications.\\n\\n## Communication betw\", \"een microservices\\n\\nA microservices based application is a distributed system, potentially running on\", \" multiple machines. Each service instance is typically a process. Therefore, services must interact \", \"using an inter-process communication protocol, such as HTTP, TCP, Advanced Message Queuing Protocol \", \"(AMQP), or binary protocols, depending on the nature of each service.\\n\\nThe two common approaches for\", \" microservice-to-microservice communication are HTTP based REST communication when querying for data\", \", and lightweight asynchronous messaging when communicating updates across multiple microservices.\\n\\n\", \"Asynchronous messaging based event-driven communication is critical when propagating changes across \", \"multiple microservices. With this approach, a microservice publishes an event when something notable\", \" happens, for example, when it updates a business entity. Other microservices subscribe to these eve\", \"nts. Then, when a microservice receives an event, it updates its own business entities, which might \", \"in turn lead to more events being published. This publish-subscribe functionality is usually achieve\", \"d with an event bus.\\n\\nAn event bus allows publish-subscribe communication between microservices, wit\", \"hout requiring the components to be explicitly aware of each other, as shown in Figure 8-6.\\n\\nMicrose\", \"rvice A\\n\\nMobile App\\n\\nDocker Host\\n\\nIdentity Microservice (STS+Users)\\n\\nWeb API\\n\\nSQL Server\\n\\nContainer \", \"database\\n\\nFigure 8-6: Publish-subscribe with an event bus\\n\\nFrom an application perspective, the even\", \"t bus is simply a publish-subscribe channel exposed via an interface. However, the way the event bus\", \" is implemented can vary. For example, an event bus implementation could use RabbitMQ, Azure Service\", \" Bus, or other service buses such as NServiceBus and MassTransit. Figure 8-7 shows how an event bus \", \"is used in the eShopOnContainers reference application.\\n\\nFigure 8-7: Asynchronous event-driven commu\", \"nication in the reference application\\n\\nThe eShopOnContainers event bus, implemented using RabbitMQ, \", \"provides one-to-many asynchronous publish-subscribe functionality. This means that after publishing \", \"an event, there can be multiple subscribers listening for the same event. Figure 8-9 illustrates thi\", \"s relationship.\\n\\nMicroservice B\\n\\nUser-Profile Microservice\\n\\nWeb API Service\\n\\n3\\n\\nDatabase as\\n\\nCache e\", \"rvice\\n\\nUserUpdated event \\u2192 Buyer info\\n\\nFigure 8-9 : One-to-many communication\\n\\nThis one-to-many comm\", \"unication approach uses events to implement business transactions that span multiple services, ensur\", \"ing eventual consistency between the services. An eventual-consistent transaction consists of a seri\", \"es of distributed steps. Therefore, when the user-profile microservice receives the UpdateUser comma\", \"nd, it updates the user's details in its database and publishes the UserUpdated event to the event b\", \"us. Both the basket microservice and the ordering microservice have subscribed to receive this event\", \", and in response update their buyer information in their respective databases.\\n\\nNote: The eShopOnCo\", \"ntainers event bus, implemented using RabbitMQ, is intended to be used only as a proof of concept. F\", \"or production systems, alternative event bus implementations should be considered.\\n\\nFor information \", \"about the event bus implementation, see .NET Microservices: Architecture for Containerized .NET Appl\", \"ications.\\n\\n## Summary\\n\\nMicroservices offer an approach to application development and deployment tha\", \"t's suited to the agility, scale, and reliability requirements of modern cloud applications. One of \", \"the main advantages of microservices is that they can be scaled-out independently, which means that \", \"a specific functional area can be scaled that requires more processing power or network bandwidth to\", \" support demand, without unnecessarily scaling areas of the application that are not experiencing in\", \"creased demand.\\n\\nA container is an isolated, resource controlled, and portable operating environment\", \", where an application can run without touching the resources of other containers, or the host. Ente\", \"rprises are increasingly adopting containers when implementing microservice based applications, and \", \"Docker has become the standard container implementation that has been adopted by most software platf\", \"orms and cloud vendors.\\n\\nUpdateUser command\\n\\nDatabase\\n\\nBasket Microservice\\n\\n## Authentication and au\", \"thorization\\n\\nAuthentication is the process of obtaining identification credentials such as name and \", \"password from a user, and validating those credentials against an authority. If the credentials are \", \"valid, the entity that submitted the credentials is considered an authenticated identity. Once an id\", \"entity has been authenticated, an authorization process determines whether that identity has access \", \"to a given resource.\\n\\nThere are many approaches to integrating authentication and authorization into\", \" a Xamarin.Forms app that communicates with an ASP.NET MVC web application, including using ASP.NET \", \"Core Identity, external authentication providers such as Microsoft, Google, Facebook, or Twitter, an\", \"d authentication middleware. The eShopOnContainers mobile app performs authentication and authorizat\", \"ion with a containerized identity microservice that uses IdentityServer 4. The mobile app requests s\", \"ecurity tokens from IdentityServer, either for authenticating a user or for accessing a resource. Fo\", \"r IdentityServer to issue tokens on behalf of a user, the user must sign-in to IdentityServer. Howev\", \"er, IdentityServer doesn't provide a user interface or database for authentication. Therefore, in th\", \"e eShopOnContainers reference application, ASP.NET Core Identity is used for this purpose.\\n\\n## Authe\", \"ntication\\n\\nAuthentication is required when an application needs to know the identity of the current \", \"user. ASP.NET Core's primary mechanism for identifying users is the ASP.NET Core Identity membership\", \" system, which stores user information in a data store configured by the developer. Typically, this \", \"data store will be an EntityFramework store, though custom stores or third party packages can be use\", \"d to store identity information in Azure storage, DocumentDB, or other locations.\\n\\nFor authenticatio\", \"n scenarios that make use of a local user data store, and that persist identity information between \", \"requests via cookies (as is typical in ASP.NET MVC web applications), ASP.NET Core Identity is a sui\", \"table solution. However, cookies are not always a natural means of persisting and transmitting data.\", \" For example, an ASP.NET Core web application that exposes RESTful endpoints that are accessed from \", \"a mobile app will typically need to use bearer token authentication, since cookies can't be used in \", \"this scenario. However, bearer tokens can easily be retrieved and included in the authorization head\", \"er of web requests made from the mobile app.\\n\\nMobile App\\n\\n-\\n\\nSign-in\\n\\nSecurity token\\n\\nIdentity Micro\", \"service (STS+Users)\\n\\nWeb API\\n\\nSQL Server database\\n\\n## Issuing bearer tokens using IdentityServer 4 C\", \"ontainer\\n\\nIdentityServer 4 is an open source OpenID Connect and OAuth 2.0 framework for ASP.NET Core\", \", which can be used for many authentication and authorization scenarios including issuing security t\", \"okens for local ASP.NET Core Identity users.\\n\\nNote: OpenID Connect and OAuth 2.0 are very similar, w\", \"hile having different responsibilities.\\n\\nOpenID Connect is an authentication layer on top of the OAu\", \"th 2.0 protocol. OAuth 2 is a protocol that allows applications to request access tokens from a secu\", \"rity token service and use them to communicate with APIs. This delegation reduces complexity in both\", \" client applications and APIs since authentication and authorization can be centralized.\\n\\nThe combin\", \"ation of OpenID Connect and OAuth 2.0 combine the two fundamental security concerns of authenticatio\", \"n and API access, and IdentityServer 4 is an implementation of these protocols.\\n\\nIn applications tha\", \"t use direct client-to-microservice communication, such as the eShopOnContainers reference applicati\", \"on, a dedicated authentication microservice acting as a Security Token Service (STS) can be used to \", \"authenticate users, as shown in Figure 9-1. For more information about direct clientto-microservice \", \"communication, see Communication between client and microservices.\\n\\nFigure 9-1: Authentication by a \", \"dedicated authentication microservice\\n\\nThe eShopOnContainers mobile app communicates with the identi\", \"ty microservice, which uses IdentityServer 4 to perform authentication, and access control for APIs.\", \" Therefore, the mobile app requests tokens from IdentityServer, either for authenticating a user or \", \"for accessing a resource:\\n\\n- Authenticating users with IdentityServer is achieved by the mobile app \", \"requesting an identity token, which represents the outcome of an authentication process. At a bare m\", \"inimum, it contains an identifier for the user, and information about how and when the user authenti\", \"cated. It can also contain additional identity data.\\n- Accessing a resource with IdentityServer is a\", \"chieved by the mobile app requesting an access token, which allows access to an API resource. Client\", \"s request access tokens and forward them to the API. Access tokens contain information about the cli\", \"ent, and the user (if present). APIs then use that information to authorize access to their data.\\n\\nN\", \"ote : A client must be registered with IdentityServer before it can request tokens.\\n\\n## Adding Ident\", \"ityServer to a web application\\n\\nIn order for an ASP.NET Core web application to use IdentityServer 4\", \", it must be added to the web application's Visual Studio solution. For more information, see Setup \", \"and Overview in the IdentityServer documentation.\\n\\nDocker Host\\n\\nOnce IdentityServer is included in t\", \"he web application's Visual Studio solution, it must be added to the web application's HTTP request \", \"processing pipeline, so that it can serve requests to OpenID Connect and OAuth 2.0 endpoints. This i\", \"s achieved in the Configure method in the web application's Startup class, as demonstrated in the fo\", \"llowing code example:\\n\\n```\\npublic void Configure( IApplicationBuilder app, IHostingEnvironment env, \", \"ILoggerFactory loggerFactory) { ... app.UseIdentity(); ... }\\n```\\n\\nOrder matters in the web applicati\", \"on's HTTP request processing pipeline. Therefore, IdentityServer must be added to the pipeline befor\", \"e the UI framework that implements the login screen.\\n\\n## Configuring IdentityServer\\n\\nIdentityServer \", \"should be configured in the ConfigureServices method in the web application's Startup class by calli\", \"ng the services.AddIdentityServer method, as demonstrated in the following code example from the eSh\", \"opOnContainers reference application:\\n\\n```\\npublic void ConfigureServices(IServiceCollection services\", \") { ... services.AddIdentityServer(x => x.IssuerUri = \\\"null\\\") .AddSigningCredential(Certificate.Get(\", \")) .AddAspNetIdentity<ApplicationUser>() .AddConfigurationStore(builder => builder.UseSqlServer(conn\", \"ectionString, options => options.MigrationsAssembly(migrationsAssembly))) .AddOperationalStore(build\", \"er => builder.UseSqlServer(connectionString, options => options.MigrationsAssembly(migrationsAssembl\", \"y))) .Services.AddTransient<IProfileService, ProfileService>(); }\\n```\\n\\nAfter calling the services.Ad\", \"dIdentityServer method, additional fluent APIs are called to configure the following:\\n\\n- Credentials\", \" used for signing.\\n- API and identity resources that users might request access to.\\n- Clients that w\", \"ill be connecting to request tokens.\\n- ASP.NET Core Identity.\\n\\nTip : Dynamically load the IdentitySe\", \"rver 4 configuration\\n\\nIdentityServer 4's APIs allow for configuring IdentityServer from an in-memory\", \" list of configuration objects. In the eShopOnContainers reference application, these in-memory coll\", \"ections are hardcoded into the application. However, in production scenarios they can be loaded dyna\", \"mically from a configuration file or from a database.\\n\\nFor information about configuring IdentitySer\", \"ver to use ASP.NET Core Identity, see Using ASP.NET Core Identity in the IdentityServer documentatio\", \"n.\\n\\n## Configuring API resources\\n\\nWhen configuring API resources, the AddInMemoryApiResources method\", \" expects an IEnumerable&lt;ApiResource&gt; collection. The following code example shows the GetApis \", \"method that provides this collection in the eShopOnContainers reference application:\\n\\n```\\npublic sta\", \"tic IEnumerable<ApiResource> GetApis() { return new List<ApiResource> { new ApiResource(\\\"orders\\\", \\\"O\", \"rders Service\\\"), new ApiResource(\\\"basket\\\", \\\"Basket Service\\\") }; }\\n```\\n\\nThis method specifies that Id\", \"entityServer should protect the orders and basket APIs. Therefore, IdentityServer managed access tok\", \"ens will be required when making calls to these APIs. For more information about the ApiResource typ\", \"e, see API Resource in the IdentityServer 4 documentation.\\n\\n## Configuring identity resources\\n\\nWhen \", \"configuring identity resources, the AddInMemoryIdentityResources method expects an IEnumerable&lt;Id\", \"entityResource&gt; collection. Identity resources are data such as user ID, name, or email address. \", \"Each identity resource has a unique name, and arbitrary claim types can be assigned to it, which wil\", \"l then be included in the identity token for the user. The following code example shows the GetResou\", \"rces method that provides this collection in the eShopOnContainers reference application:\\n\\n```\\npubli\", \"c static IEnumerable<IdentityResource> GetResources() { return new List<IdentityResource> { new Iden\", \"tityResources.OpenId(), new IdentityResources.Profile() }; }\\n```\\n\\nThe OpenID Connect specification s\", \"pecifies some standard identity resources. The minimum requirement is that support is provided for e\", \"mitting a unique ID for users. This is achieved by exposing the IdentityResources.OpenId identity re\", \"source.\\n\\nNote: The IdentityResources class supports all of the scopes defined in the OpenID Connect \", \"specification (openid, email, profile, telephone, and address).\\n\\nIdentityServer also supports defini\", \"ng custom identity resources. For more information, see Defining custom identity resources in the Id\", \"entityServer documentation. For more information about the IdentityResource type, see Identity Resou\", \"rce in the IdentityServer 4 documentation.\\n\\n## Configuring clients\\n\\nClients are applications that ca\", \"n request tokens from IdentityServer. Typically, the following settings must be defined for each cli\", \"ent as a minimum:\\n\\n- A unique client ID.\\n- The allowed interactions with the token service (known as\", \" the grant type).\\n- The location where identity and access tokens are sent to (known as a redirect U\", \"RI).\\n\\n- A list of resources that the client is allowed access to (known as scopes).\\n\\nWhen configurin\", \"g clients, the AddInMemoryClients method expects an IEnumerable&lt;Client&gt; collection. The follow\", \"ing code example shows the configuration for the eShopOnContainers mobile app in the GetClients meth\", \"od that provides this collection in the eShopOnContainers reference application:\\n\\n```\\npublic static \", \"IEnumerable<Client> GetClients(Dictionary<string,string> clientsUrl) { return new List<Client> { ...\", \" new Client { ClientId = \\\"xamarin\\\", ClientName = \\\"eShop Xamarin OpenId Client\\\", AllowedGrantTypes = \", \"GrantTypes.Hybrid, ClientSecrets = { new Secret(\\\"secret\\\".Sha256()) }, RedirectUris = { clientsUrl[\\\"X\", \"amarin\\\"] }, RequireConsent = false, RequirePkce = true, PostLogoutRedirectUris = { $\\\"{clientsUrl[\\\"Xa\", \"marin\\\"]}/Account/Redirecting\\\" }, AllowedCorsOrigins = { \\\"http://eshopxamarin\\\" }, AllowedScopes = new\", \" List<string> { IdentityServerConstants.StandardScopes.OpenId, IdentityServerConstants.StandardScope\", \"s.Profile, IdentityServerConstants.StandardScopes.OfflineAccess, \\\"orders\\\", \\\"basket\\\" }, AllowOfflineA\", \"ccess = true, AllowAccessTokensViaBrowser = true }, ... }; }\\n```\\n\\nThis configuration specifies data \", \"for the following properties:\\n\\n- ClientId : A unique ID for the client.\\n- ClientName : The client di\", \"splay name, which is used for logging and the consent screen.\\n- AllowedGrantTypes : Specifies how a \", \"client wants to interact with IdentityServer. For more information see Configuring the authenticatio\", \"n flow.\\n- ClientSecrets : Specifies the client secret credentials that are used when requesting toke\", \"ns from the token endpoint.\\n- RedirectUris : Specifies the allowed URIs to which to return tokens or\", \" authorization codes.\\n- RequireConsent : Specifies whether a consent screen is required.\\n- RequirePk\", \"ce : Specifies whether clients using an authorization code must send a proof key.\\n- PostLogoutRedire\", \"ctUris : Specifies the allowed URIs to redirect to after logout.\\n\\nMobile App http://cbase endpoint&g\", \"t;:5105/connect/authorize\\n\\nauthentication response\\n\\n(authorization code and identity token)\\n\\nIdentit\", \"y Microservice (STS+Users)\\n\\nWeb API\\n\\nSQL Server\\n\\n- AllowedCorsOrigins : Specifies the origin of the \", \"client so that IdentityServer can allow crossorigin calls from the origin.\\n- AllowedScopes : Specifi\", \"es the resources the client has access to. By default, a client has no access to any resources.\\n- Al\", \"lowOfflineAccess : Specifies whether the client can request refresh tokens. Fiauro 9-2. Hiah level a\", \"verview of the cian-in nrocecc\\n\\n## Configuring the authentication flow\\n\\nThe authentication flow betw\", \"een a client and IdentityServer can be configured by specifying the grant types in the Client.Allowe\", \"dGrantTypes property. The OpenID Connect and OAuth 2.0 specifications define a number of authenticat\", \"ion flows, including:\\n\\n- Implicit. This flow is optimized for browser-based applications and should \", \"be used either for user authentication-only, or authentication and access token requests. All tokens\", \" are transmitted via the browser, and therefore advanced features like refresh tokens are not permit\", \"ted.\\n- Authorization code. This flow provides the ability to retrieve tokens on a back channel, as o\", \"pposed to the browser front channel, while also supporting client authentication.\\n- Hybrid. This flo\", \"w is a combination of the implicit and authorization code grant types. The identity token is transmi\", \"tted via the browser channel and contains the signed protocol response along with other artifacts su\", \"ch as the authorization code. After successful validation of the response, the back channel should b\", \"e used to retrieve the access and refresh token.\\n\\nTip: Use the hybrid authentication flow\\n\\nThe hybri\", \"d authentication flow mitigates a number of attacks that apply to the browser channel, and is the re\", \"commended flow for native applications that want to retrieve access tokens (and possibly refresh tok\", \"ens).\\n\\nFor more information about authentication flows, see Grant Types in the IdentityServer 4 docu\", \"mentation.\\n\\n## Performing authentication\\n\\nFor IdentityServer to issue tokens on behalf of a user, th\", \"e user must sign-in to IdentityServer. However, IdentityServer doesn't provide a user interface or d\", \"atabase for authentication. Therefore, in the eShopOnContainers reference application, ASP.NET Core \", \"Identity is used for this purpose.\\n\\nThe eShopOnContainers mobile app authenticates with IdentityServ\", \"er with the hybrid authentication flow, which is illustrated in Figure 9-2.\\n\\nFigure 9-2: High-level \", \"overview of the sign-in process\\n\\n-\\n\\nDocker Host 1\\n\\nhttp://&lt;base endpoint&gt;:5105/connect/endsess\", \"ion\\n\\n+\\n\\npost logout redirect URI\\n\\nMobile App\\n\\nIdentity Microservice (STS+Users)\\n\\nWeb API\\n\\nContainer\\n\", \"\\nSQL Server database\\n\\nA sign-in request is made to &lt;base endpoint&gt;:5105/connect/authorize . Fo\", \"llowing successful authentication, IdentityServer returns an authentication response containing an a\", \"uthorization code and an identity token. The authorization code is then sent to &lt;base endpoint&gt\", \";:5105/connect/token , which responds with access, identity, and refresh tokens.\\n\\nThe eShopOnContain\", \"ers mobile app signs-out of IdentityServer by sending a request to http://&lt;base endpoint&gt;:5105\", \"/connect/endsession , with additional parameters. After sign-out occurs, IdentityServer responds by \", \"sending a post logout redirect URI back to the mobile app. Figure 9-3 illustrates this process.\\n\\nFig\", \"ure 9-3: High-level overview of the sign-out process\\n\\nIn the eShopOnContainers mobile app, communica\", \"tion with IdentityServer is performed by the IdentityService class, which implements the IIdentitySe\", \"rvice interface. This interface specifies that the implementing class must provide CreateAuthorizati\", \"onRequest , CreateLogoutRequest , and GetTokenAsync methods.\\n\\n## Signing-in\\n\\nWhen the user taps the \", \"LOGIN button on the LoginView , the SignInCommand in the LoginViewModel class is executed, which in \", \"turn executes the SignInAsync method. The following code example shows this method:\\n\\n```\\nprivate asy\", \"nc Task SignInAsync() { ... LoginUrl = _identityService.CreateAuthorizationRequest(); IsLogin = true\", \"; ... }\\n```\\n\\nThis method invokes the CreateAuthorizationRequest method in the IdentityService class,\", \" which is shown in the following code example:\\n\\n```\\npublic string CreateAuthorizationRequest() { // \", \"Create URI to authorization endpoint var authorizeRequest = new AuthorizeRequest(GlobalSetting.Insta\", \"nce.IdentityEndpoint); // Dictionary with values for the authorize request var dic = new Dictionary<\", \"string, string>(); dic.Add(\\\"client_id\\\", GlobalSetting.Instance.ClientId); dic.Add(\\\"client_secret\\\", G\", \"lobalSetting.Instance.ClientSecret); dic.Add(\\\"response_type\\\", \\\"code id_token\\\"); dic.Add(\\\"scope\\\", \\\"op\", \"enid profile basket orders locations marketing offline_access\\\"); dic.Add(\\\"redirect_uri\\\", GlobalSetti\", \"ng.Instance.IdentityCallback); dic.Add(\\\"nonce\\\", Guid.NewGuid().ToString(\\\"N\\\")); dic.Add(\\\"code_challen\", \"ge\\\", CreateCodeChallenge()); dic.Add(\\\"code_challenge_method\\\", \\\"S256\\\");\\n```\\n\\nDocker Host 1\\n\\nARE YOU R\", \"EGISTERED?\\n\\nEMAIL\\n\\n```\\n// Add CSRF token to protect against cross-site request forgery attacks. var \", \"currentCSRFToken = Guid.NewGuid().ToString(\\\"N\\\"); dic.Add(\\\"state\\\", currentCSRFToken); var authorizeUr\", \"i = authorizeRequest.Create(dic); return authorizeUri; } \\u00b7 Remember me?\\n```\\n\\nThis method creates the\", \" URI for IdentityServer's authorization endpoint, with the required parameters. The authorization en\", \"dpoint is at /connect/authorize on port 5105 of the base endpoint exposed as a user setting. For mor\", \"e information about user settings, see Configuration management.\\n\\nNote : The attack surface of the e\", \"ShopOnContainers mobile app is reduced by implementing the Proof Key for Code Exchange (PKCE) extens\", \"ion to OAuth. PKCE protects the authorization code from being used if it's intercepted. This is achi\", \"eved by the client generating a se cret verifier, a hash of which is passed in the authorization req\", \"uest, and which is presented unhashed when redeeming the authorization code. For more information ab\", \"out PKCE, see Proof Key for Code Exchange by OAuth Public Clients on the Internet Engineering Task F\", \"orce web site.\\n\\nThe returned URI is stored in the LoginUrl property of the LoginViewModel class. Whe\", \"n the IsLogin property becomes true , the WebView in the LoginView becomes visible. The WebView data\", \" binds its Source property to the LoginUrl property of the LoginViewModel class, and so makes a sign\", \"-in request to IdentityServer when the LoginUrl property is set to IdentityServer's authorization en\", \"dpoint. When IdentityServer receives this request and the user isn't authenticated, the WebView will\", \" be redirected to the configured login page, which is shown in Figure 9-4.\\n\\nFigure 9-4: Login page d\", \"isplayed by the WebView\\n\\nOnce login is completed, the WebView will be redirected to a return URI. Th\", \"is WebView navigation will cause the NavigateAsync method in the LoginViewModel class to be executed\", \", which is shown in the following code example:\\n\\n```\\nprivate async Task NavigateAsync(string url) { \", \"... var authResponse = new AuthorizeResponse(url); if (!string.IsNullOrWhiteSpace(authResponse.Code)\", \") { var userToken = await _identityService.GetTokenAsync(authResponse.Code); string accessToken = us\", \"erToken.AccessToken; if (!string.IsNullOrWhiteSpace(accessToken)) { Settings.AuthAccessToken = acces\", \"sToken; Settings.AuthIdToken = authResponse.IdentityToken; await NavigationService.NavigateToAsync<M\", \"ainViewModel>(); await NavigationService.RemoveLastFromBackStackAsync(); } } ... }\\n```\\n\\nThis method \", \"parses the authentication response that's contained in the return URI, and provided that a valid aut\", \"horization code is present, it makes a request to IdentityServer's token endpoint, passing the autho\", \"rization code, the PKCE secret verifier, and other required parameters. The token endpoint is at /co\", \"nnect/token on port 5105 of the base endpoint exposed as a user setting. For more information about \", \"user settings, see Configuration management.\\n\\nTip : Validate return URIs Although the eShopOnContain\", \"ers mobile app doesn't validate the return URI, the best practice is to validate that the return URI\", \" refers to a known location in order to prevent open-redirect attacks.\\n\\nIf the token endpoint receiv\", \"es a valid authorization code and PKCE secret verifier, it responds with an access token, identity t\", \"oken, and refresh token. The access token (which allows access to API resources) and identity token \", \"are then stored as application settings, and page navigation is performed. Therefore, the overall ef\", \"fect in the eShopOnContainers mobile app is this: provided that users are able to successfully authe\", \"nticate with IdentityServer, they are navigated to the MainView page, which is a TabbedPage that dis\", \"plays the CatalogView as its selected tab.\\n\\nFor information about page navigation, see Navigation. F\", \"or information about how WebView navigation causes a view model method to be executed, see Invoking \", \"navigation using behaviors. For information about application settings, see Configuration management\", \".\\n\\nNote: The eShopOnContainers also allows a mock sign-in when the app is configured to use mock ser\", \"vices in the SettingsView . In this mode, the app doesn't communicate with IdentityServer, instead a\", \"llowing the user to sign-in using any credentials.\\n\\n## Signing-out\\n\\nWhen the user taps the LOG OUT b\", \"utton in the ProfileView , the LogoutCommand in the ProfileViewModel class is executed, which in tur\", \"n executes the LogoutAsync method. This method performs page navigation to the LoginView page, passi\", \"ng a LogoutParameter instance set to true as a parameter. For more information about passing paramet\", \"ers during page navigation, see Passing parameters during navigation.\\n\\nWhen a view is created and na\", \"vigated to, the InitializeAsync method of the view's associated view model is executed, which then e\", \"xecutes the Logout method of the LoginViewModel class, which is shown in the following code example:\", \"\\n\\n```\\nprivate void Logout() { var authIdToken = Settings.AuthIdToken; var logoutRequest = _identityS\", \"ervice.CreateLogoutRequest(authIdToken); if (!string.IsNullOrEmpty(logoutRequest)) { // Logout Login\", \"Url = logoutRequest; } ... }\\n```\\n\\nThis method invokes the CreateLogoutRequest method in the Identity\", \"Service class, passing the identity token retrieved from application settings as a parameter. For mo\", \"re information about application settings, see Configuration management. The following code example \", \"shows the CreateLogoutRequest method:\\n\\n```\\npublic string CreateLogoutRequest(string token) { ... ret\", \"urn string.Format(\\\"{0}?id_token_hint={1}&post_logout_redirect_uri={2}\\\", GlobalSetting.Instance.Logou\", \"tEndpoint, token, GlobalSetting.Instance.LogoutCallback); }\\n```\\n\\nThis method creates the URI to Iden\", \"tityServer's end session endpoint, with the required parameters. The end session endpoint is at /con\", \"nect/endsession on port 5105 of the base endpoint exposed as a user setting. For more information ab\", \"out user settings, see Configuration management.\\n\\nThe returned URI is stored in the LoginUrl propert\", \"y of the LoginViewModel class. While the IsLogin property is true , the WebView in the LoginView is \", \"visible. The WebView data binds its Source property to the LoginUrl property of the LoginViewModel c\", \"lass, and so makes a sign-out request to IdentityServer when the LoginUrl property is set to Identit\", \"yServer's end session endpoint. When IdentityServer receives this request, provided that the user is\", \" signed-in, sign-out occurs. Authentication is tracked with a cookie managed by the cookie authentic\", \"ation middleware from ASP.NET Core. Therefore, signing out of IdentityServer removes the authenticat\", \"ion cookie and sends a post logout redirect URI back to the client.\\n\\nIn the mobile app, the WebView \", \"will be redirected to the post logout redirect URI. This WebView navigation will cause the NavigateA\", \"sync method in the LoginViewModel class to be executed, which is shown in the following code example\", \":\\n\\n```\\nprivate async Task NavigateAsync(string url) { ... Settings.AuthAccessToken = string.Empty; S\", \"ettings.AuthIdToken = string.Empty; IsLogin = false; LoginUrl = _identityService.CreateAuthorization\", \"Request(); ... }\\n```\\n\\nThis method clears both the identity token and the access token from applicati\", \"on settings, and sets the IsLogin property to false , which causes the WebView on the LoginView page\", \" to become invisible. Finally, the LoginUrl property is set to the URI of IdentityServer's authoriza\", \"tion endpoint, with the required parameters, in preparation for the next time the user initiates a s\", \"ign-in.\\n\\nFor information about page navigation, see Navigation. For information about how WebView na\", \"vigation causes a view model method to be executed, see Invoking navigation using behaviors. For inf\", \"ormation about application settings, see Configuration management.\\n\\nNote: The eShopOnContainers also\", \" allows a mock sign-out when the app is configured to use mock services in the SettingsView . In thi\", \"s mode, the app doesn't communicate with IdentityServer, and instead clears any stored tokens from a\", \"pplication settings.\\n\\n## Authorization\\n\\nAfter authentication, ASP.NET Core web APIs often need to au\", \"thorize access, which allows a service to make APIs available to some authenticated users, but not t\", \"o all.\\n\\nRestricting access to an ASP.NET Core MVC route can be achieved by applying an Authorize att\", \"ribute to a controller or action, which limits access to the controller or action to authenticated u\", \"sers, as shown in the following code example:\\n\\n```\\n[Authorize] public class BasketController : Contr\", \"oller { ... }\\n```\\n\\nIf an unauthorized user attempts to access a controller or action that's marked w\", \"ith the Authorize attribute, the MVC framework returns a 401 (unauthorized) HTTP status code.\\n\\nNote:\", \" Parameters can be specified on the Authorize attribute to restrict an API to specific users. For mo\", \"re information, see Authorization on the Microsoft Documentation Center.\\n\\nMobile App\\n\\n. ---\\n\\nSign-in\", \"\\n\\n-\\n\\nSecurity token\\n\\n\\u2022 -\\n\\nIdentity Microservice (STS+Users)\\n\\nWeb API\\n\\nContainer\\n\\nIdentityServer can \", \"be integrated into the authorization workflow so that the access tokens it provides control authoriz\", \"ation. This approach is shown in Figure 9-5.\\n\\nOrdering Microservice\\n\\nThe eShopOnContainers mobile ap\", \"p communicates with the identity microservice and requests an access token as part of the authentica\", \"tion process. The access token is then forwarded to the APIs exposed by the ordering and basket micr\", \"oservices as part of the access requests. Access tokens contain information about the client, and th\", \"e user. APIs then use that information to authorize access to their data. For information about how \", \"to configure IdentityServer to protect APIs, see Configuring API resources.\\n\\n## Configuring Identity\", \"Server to perform authorization\\n\\nTo perform authorization with IdentityServer, its authorization mid\", \"dleware must be added to the web application's HTTP request pipeline. The middleware is added in the\", \" ConfigureAuth method in the web application's Startup class, which is invoked from the Configure me\", \"thod, and is demonstrated in the following code example from the eShopOnContainers reference applica\", \"tion:\\n\\n```\\nprotected virtual void ConfigureAuth(IApplicationBuilder app) { var identityUrl = Configu\", \"ration.GetValue<string>(\\\"IdentityUrl\\\"); app.UseIdentityServerAuthentication(new IdentityServerAuthen\", \"ticationOptions { Authority = identityUrl.ToString(), ScopeName = \\\"basket\\\", RequireHttpsMetadata = f\", \"alse }); }\\n```\\n\\nThis method ensures that the API can only be accessed with a valid access token. The\", \" middleware validates the incoming token to ensure that it's sent from a trusted issuer, and validat\", \"es that the token is valid to be used with the API that receives it. Therefore, browsing to the orde\", \"ring or basket controller will return a 401 (unauthorized) HTTP status code, indicating that an acce\", \"ss token is required.\\n\\nSQL Server database\\n\\nDocker Host\\n\\nNote: IdentityServer's authorization middle\", \"ware must be added to the web application's HTTP request pipeline before adding MVC with app.UseMvc(\", \") or app.UseMvcWithDefaultRoute() .\\n\\n## Making access requests to APIs\\n\\nWhen making requests to the \", \"ordering and basket microservices, the access token, obtained from IdentityServer during the authent\", \"ication process, must be included in the request, as shown in the following code example:\\n\\n```\\nvar a\", \"uthToken = Settings.AuthAccessToken; Order = await _ordersService.GetOrderAsync(Convert.ToInt32(orde\", \"r.OrderNumber), authToken);\\n```\\n\\nThe access token is stored as an application setting, and is retrie\", \"ved from platform-specific storage and included in the call to the GetOrderAsync method in the Order\", \"Service class.\\n\\nSimilarly, the access token must be included when sending data to an IdentityServer \", \"protected API, as shown in the following code example:\\n\\n```\\nvar authToken = Settings.AuthAccessToken\", \"; await _basketService.UpdateBasketAsync(new CustomerBasket { BuyerId = userInfo.UserId, Items = Bas\", \"ketItems.ToList() }, authToken);\\n```\\n\\nThe access token is retrieved from platform-specific storage a\", \"nd included in the call to the UpdateBasketAsync method in the BasketService class.\\n\\nThe RequestProv\", \"ider class, in the eShopOnContainers mobile app, uses the HttpClient class to make requests to the R\", \"ESTful APIs exposed by the eShopOnContainers reference application. When making requests to the orde\", \"ring and basket APIs, which require authorization, a valid access token must be included with the re\", \"quest. This is achieved by adding the access token to the headers of the HttpClient instance, as dem\", \"onstrated in the following code example:\\n\\n```\\nhttpClient.DefaultRequestHeaders.Authorization = new A\", \"uthenticationHeaderValue(\\\"Bearer\\\", token);\\n```\\n\\nThe DefaultRequestHeaders property of the HttpClient\", \" class exposes the headers that are sent with each request, and the access token is added to the Aut\", \"horization header prefixed with the string Bearer . When the request is sent to a RESTful API, the v\", \"alue of the Authorization header is extracted and validated to ensure that it's sent from a trusted \", \"issuer, and used to determine whether the user has permission to invoke the API that receives it.\\n\\nF\", \"or more information about how the eShopOnContainers mobile app makes web requests, see Accessing rem\", \"ote data.\\n\\n## Summary\\n\\nThere are many approaches to integrating authentication and authorization int\", \"o a Xamarin.Forms app that communicates with an ASP.NET MVC web application. The eShopOnContainers m\", \"obile app performs authentication and authorization with a containerized identity microservice that \", \"uses IdentityServer 4. IdentityServer is an open source OpenID Connect and OAuth 2.0 framework for A\", \"SP.NET Core that integrates with ASP.NET Core Identity to perform bearer token authentication.\\n\\nThe \", \"mobile app requests security tokens from IdentityServer, either for authenticating a user or for acc\", \"essing a resource. When accessing a resource, an access token must be included in the request to API\", \"s that require authorization. IdentityServer's middleware validates incoming access tokens to ensure\", \" that they are sent from a trusted issuer, and that they are valid to be used with the API that rece\", \"ives them.\\n\\n## Accessing remote data\\n\\nMany modern web-based solutions make use of web services, host\", \"ed by web servers, to provide functionality for remote client applications. The operations that a we\", \"b service exposes constitute a web API.\\n\\nClient apps should be able to utilize the web API without k\", \"nowing how the data or operations that the API exposes are implemented. This requires that the API a\", \"bides by common standards that enable a client app and web service to agree on which data formats to\", \" use, and the structure of the data that is exchanged between client apps and the web service.\\n\\n## I\", \"ntroduction to Representational State Transfer\\n\\nRepresentational State Transfer (REST) is an archite\", \"ctural style for building distributed systems based on hypermedia. A primary advantage of the REST m\", \"odel is that it's based on open standards and doesn't bind the implementation of the model or the cl\", \"ient apps that access it to any specific implementation. Therefore, a REST web service could be impl\", \"emented using Microsoft ASP.NET Core MVC, and client apps could be developing using any language and\", \" toolset that can generate HTTP requests and parse HTTP responses.\\n\\nThe REST model uses a navigation\", \"al scheme to represent objects and services over a network, referred to as resources. Systems that i\", \"mplement REST typically use the HTTP protocol to transmit requests to access these resources. In suc\", \"h systems, a client app submits a request in the form of a URI that identifies a resource, and an HT\", \"TP method (such as GET, POST, PUT, or DELETE) that indicates the operation to be performed on that r\", \"esource. The body of the HTTP request contains any data required to perform the operation.\\n\\nNote: RE\", \"ST defines a stateless request model. Therefore, HTTP requests must be independent and might occur i\", \"n any order.\\n\\nThe response from a REST request makes use of standard HTTP status codes. For example,\", \" a request that returns valid data should include the HTTP response code 200 (OK), while a request t\", \"hat fails to find or delete a specified resource should return a response that includes the HTTP sta\", \"tus code 404 (Not Found).\\n\\nA RESTful web API exposes a set of connected resources, and provides the \", \"core operations that enable an app to manipulate those resources and easily navigate between them. F\", \"or this reason, the URIs that constitute a typical RESTful web API are oriented towards the data tha\", \"t it exposes, and use the facilities provided by HTTP to operate on this data.\\n\\nThe data included by\", \" a client app in an HTTP request, and the corresponding response messages from the web server, could\", \" be presented in a variety of formats, known as media types. When a client app sends a request that \", \"returns data in the body of a message, it can specify the media types it can handle in the Accept he\", \"ader of the request. If the web server supports this media type, it can reply with a response that i\", \"ncludes the Content-Type header that specifies the format of the data in the body of the message. It\", \"'s then the responsibility of the client app to parse the response message and interpret the results\", \" in the message body appropriately.\\n\\nFor more information about REST, see API design and API impleme\", \"ntation on Microsoft Docs.\\n\\n## Consuming RESTful APIs\\n\\nThe eShopOnContainers mobile app uses the Mod\", \"el-View-ViewModel (MVVM) pattern, and the model elements of the pattern represent the domain entitie\", \"s used in the app. The controller and repository classes in the eShopOnContainers reference applicat\", \"ion accept and return many of these model objects. Therefore, they are used as data transfer objects\", \" (DTOs) that hold all the data that is passed between the mobile app and the containerized microserv\", \"ices. The main benefit of using DTOs to pass data to and receive data from a web service is that by \", \"transmitting more data in a single remote call, the app can reduce the number of remote calls that n\", \"eed to be made.\\n\\n## Making web requests\\n\\nThe eShopOnContainers mobile app uses the HttpClient class \", \"to make requests over HTTP, with JSON being used as the media type. This class provides functionalit\", \"y for asynchronously sending HTTP requests and receiving HTTP responses from a URI identified resour\", \"ce. The HttpResponseMessage class represents an HTTP response message received from a REST API after\", \" an HTTP request has been made. It contains information about the response, including the status cod\", \"e, headers, and any body. The HttpContent class represents the HTTP body and content headers, such a\", \"s Content-Type and Content-Encoding . The content can be read using any of the ReadAs methods, such \", \"as ReadAsStringAsync and ReadAsByteArrayAsync , depending on the format of the data.\\n\\n## Making a GE\", \"T request\\n\\nThe CatalogService class is used to manage the data retrieval process from the catalog mi\", \"croservice. In the RegisterDependencies method in the ViewModelLocator class, the CatalogService cla\", \"ss is registered as a type mapping against the ICatalogService type with the Autofac dependency inje\", \"ction container. Then, when an instance of the CatalogViewModel class is created, its constructor ac\", \"cepts an ICatalogService type, which Autofac resolves, returning an instance of the CatalogService c\", \"lass. For more information about dependency injection, see Introduction to dependency injection.\\n\\nFi\", \"gure 10-1 shows the interaction of classes that read catalog data from the catalog microservice for \", \"displaying by the CatalogView .\\n\\nCatalogViewModel\\n\\nGetCatalogAsync eShopOnContainers.Core\\n\\nRequestPr\", \"ovider\\n\\nCatalog.API\\n\\nCatalogController\\n\\nFigure 10-1 : Retrieving data from the catalog microservice\\n\", \"\\nWhen the CatalogView is navigated to, the OnInitialize method in the CatalogViewModel class is call\", \"ed. This method retrieves catalog data from the catalog microservice, as demonstrated in the followi\", \"ng code example:\\n\\n```\\npublic override async Task InitializeAsync(object navigationData) { ... Produc\", \"ts = await _productsService.GetCatalogAsync(); ... }\\n```\\n\\nThis method calls the GetCatalogAsync meth\", \"od of the CatalogService instance that was injected into the CatalogViewModel by Autofac. The follow\", \"ing code example shows the GetCatalogAsync method:\\n\\n```\\npublic async Task<ObservableCollection<Catal\", \"ogItem>> GetCatalogAsync() { UriBuilder builder = new UriBuilder(GlobalSetting.Instance.CatalogEndpo\", \"int); builder.Path = \\\"api/v1/catalog/items\\\"; string uri = builder.ToString(); CatalogRoot catalog = \", \"await _requestProvider.GetAsync<CatalogRoot>(uri); ...\\n```\\n\\n```\\nreturn catalog?.Data.ToObservableCol\", \"lection(); }\\n```\\n\\nThis method builds the URI that identifies the resource the request will be sent t\", \"o, and uses the RequestProvider class to invoke the GET HTTP method on the resource, before returnin\", \"g the results to the CatalogViewModel . The RequestProvider class contains functionality that submit\", \"s a request in the form of a URI that identifies a resource, an HTTP method that indicates the opera\", \"tion to be performed on that resource, and a body that contains any data required to perform the ope\", \"ration. For information about how the RequestProvider class is injected into the CatalogService clas\", \"s, see Introduction to dependency injection.\\n\\nThe following code example shows the GetAsync method i\", \"n the RequestProvider class:\\n\\n```\\npublic async Task<TResult> GetAsync<TResult>(string uri, string to\", \"ken = \\\"\\\") { HttpClient httpClient = CreateHttpClient(token); HttpResponseMessage response = await ht\", \"tpClient.GetAsync(uri); await HandleResponse(response); string serialized = await response.Content.R\", \"eadAsStringAsync(); TResult result = await Task.Run(() => JsonConvert.DeserializeObject<TResult>(ser\", \"ialized, _serializerSettings)); return result; }\\n```\\n\\nThis method calls the CreateHttpClient method,\", \" which returns an instance of the HttpClient class with the appropriate headers set. It then submits\", \" an asynchronous GET request to the resource identified by the URI, with the response being stored i\", \"n the HttpResponseMessage instance. The HandleResponse method is then invoked, which throws an excep\", \"tion if the response doesn't include a success HTTP status code. Then the response is read as a stri\", \"ng, converted from JSON to a CatalogRoot object, and returned to the CatalogService .\\n\\nThe CreateHtt\", \"pClient method is shown in the following code example:\\n\\n```\\nprivate HttpClient CreateHttpClient(stri\", \"ng token = \\\"\\\") { var httpClient = new HttpClient(); httpClient.DefaultRequestHeaders.Accept.Add( new\", \" MediaTypeWithQualityHeaderValue(\\\"application/json\\\")); if (!string.IsNullOrEmpty(token)) { httpClien\", \"t.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\\\"Bearer\\\", token); } return htt\", \"pClient; }\\n```\\n\\nThis method creates a new instance of the HttpClient class, and sets the Accept head\", \"er of any requests made by the HttpClient instance to application/json , which indicates that it exp\", \"ects the content of any response to be formatted using JSON. Then, if an access token was passed as \", \"an argument to the CreateHttpClient method, it's added to the Authorization header of any requests m\", \"ade by the HttpClient instance, prefixed with the string Bearer . For more information about authori\", \"zation, see Authorization.\\n\\nWhen the GetAsync method in the RequestProvider class calls HttpClient.G\", \"etAsync , the Items method in the CatalogController class in the Catalog.API project is invoked, whi\", \"ch is shown in the following code example:\\n\\n```\\n[HttpGet] [Route(\\\"[action]\\\")] public async Task<IAct\", \"ionResult> Items( [FromQuery]int pageSize = 10, [FromQuery]int pageIndex = 0) { var totalItems = awa\", \"it _catalogContext.CatalogItems .LongCountAsync(); var itemsOnPage = await _catalogContext.CatalogIt\", \"ems .OrderBy(c=>c.Name) .Skip(pageSize * pageIndex) .Take(pageSize) .ToListAsync(); itemsOnPage = Co\", \"mposePicUri(itemsOnPage); var model = new PaginatedItemsViewModel<CatalogItem>( pageIndex, pageSize,\", \" totalItems, itemsOnPage); return Ok(model); }\\n```\\n\\nThis method retrieves the catalog data from the \", \"SQL database using EntityFramework, and returns it as a response message that includes a success HTT\", \"P status code, and a collection of JSON formatted CatalogItem instances.\\n\\n## Making a POST request\\n\\n\", \"The BasketService class is used to manage the data retrieval and update process with the basket micr\", \"oservice. In the RegisterDependencies method in the ViewModelLocator class, the BasketService class \", \"is registered as a type mapping against the IBasketService type with the Autofac dependency injectio\", \"n container. Then, when an instance of the BasketViewModel class is created, its constructor accepts\", \" an IBasketService type, which Autofac resolves, returning an instance of the BasketService class. F\", \"or more information about dependency injection, see Introduction to dependency injection.\\n\\nFigure 10\", \"-2 shows the interaction of classes that send the basket data displayed by the BasketView , to the b\", \"asket microservice.\\n\\nBasketViewModel\\n\\nUpdateBasketAsync eShopOnContainers.Core\\n\\nRequestProvider\\n\\nBas\", \"ket.API\\n\\nBasketController\\n\\nFigure 10-2 : Sending data to the basket microservice\\n\\nWhen an item is ad\", \"ded to the shopping basket, the ReCalculateTotalAsync method in the BasketViewModel class is called.\", \" This method updates the total value of items in the basket, and sends the basket data to the basket\", \" microservice, as demonstrated in the following code example:\\n\\n```\\nprivate async Task ReCalculateTot\", \"alAsync() { ... await _basketService.UpdateBasketAsync(new CustomerBasket { BuyerId = userInfo.UserI\", \"d, Items = BasketItems.ToList() }, authToken); }\\n```\\n\\nThis method calls the UpdateBasketAsync method\", \" of the BasketService instance that was injected into the BasketViewModel by Autofac. The following \", \"method shows the UpdateBasketAsync method:\\n\\n```\\npublic async Task<CustomerBasket> UpdateBasketAsync(\", \"CustomerBasket customerBasket, string token) { UriBuilder builder = new UriBuilder(GlobalSetting.Ins\", \"tance.BasketEndpoint); string uri = builder.ToString();\\n```\\n\\n```\\nvar result = await _requestProvider\", \".PostAsync(uri, customerBasket, token); return result; }\\n```\\n\\nThis method builds the URI that identi\", \"fies the resource the request will be sent to, and uses the RequestProvider class to invoke the POST\", \" HTTP method on the resource, before returning the results to the BasketViewModel . Note that an acc\", \"ess token, obtained from IdentityServer during the authentication process, is required to authorize \", \"requests to the basket microservice. For more information about authorization, see Authorization.\\n\\nT\", \"he following code example shows one of the PostAsync methods in the RequestProvider class:\\n\\n```\\npubl\", \"ic async Task<TResult> PostAsync<TResult>( string uri, TResult data, string token = \\\"\\\", string heade\", \"r = \\\"\\\") { HttpClient httpClient = CreateHttpClient(token); ... var content = new StringContent(JsonC\", \"onvert.SerializeObject(data)); content.Headers.ContentType = new MediaTypeHeaderValue(\\\"application/j\", \"son\\\"); HttpResponseMessage response = await httpClient.PostAsync(uri, content); await HandleResponse\", \"(response); string serialized = await response.Content.ReadAsStringAsync(); TResult result = await T\", \"ask.Run(() => JsonConvert.DeserializeObject<TResult>(serialized, _serializerSettings)); return resul\", \"t; }\\n```\\n\\nThis method calls the CreateHttpClient method, which returns an instance of the HttpClient\", \" class with the appropriate headers set. It then submits an asynchronous POST request to the resourc\", \"e identified by the URI, with the serialized basket data being sent in JSON format, and the response\", \" being stored in the HttpResponseMessage instance. The HandleResponse method is then invoked, which \", \"throws an exception if the response doesn't include a success HTTP status code. Then, the response i\", \"s read as a string, converted from JSON to a CustomerBasket object, and returned to the BasketServic\", \"e . For more information about the CreateHttpClient method, see Making a GET request.\\n\\nWhen the Post\", \"Async method in the RequestProvider class calls HttpClient.PostAsync , the Post method in the Basket\", \"Controller class in the Basket.API project is invoked, which is shown in the following code example:\", \"\\n\\n```\\n[HttpPost] public async Task<IActionResult> Post([FromBody]CustomerBasket value) { var basket \", \"= await _repository.UpdateBasketAsync(value); return Ok(basket); }\\n```\\n\\nThis method uses an instance\", \" of the RedisBasketRepository class to persist the basket data to the Redis cache, and returns it as\", \" a response message that includes a success HTTP status code, and a JSON formatted CustomerBasket in\", \"stance.\\n\\n## Making a DELETE request\\n\\nFigure 10-3 shows the interactions of classes that delete baske\", \"t data from the basket microservice, for the CheckoutView .\\n\\nCheckoutViewModel\\n\\nClearBasketAsync eSh\", \"opOnContainers.Core\\n\\nRequestProvider\\n\\nBasket.API\\n\\nBasketController\\n\\nFigure 10-3 : Deleting data from\", \" the basket microservice\\n\\nWhen the checkout process is invoked, the CheckoutAsync method in the Chec\", \"koutViewModel class is called. This method creates a new order, before clearing the shopping basket,\", \" as demonstrated in the following code example:\\n\\n```\\nprivate async Task CheckoutAsync() { ... await \", \"_basketService.ClearBasketAsync(_shippingAddress.Id.ToString(), authToken); ... }\\n```\\n\\nThis method c\", \"alls the ClearBasketAsync method of the BasketService instance that was injected into the CheckoutVi\", \"ewModel by Autofac. The following method shows the ClearBasketAsync method:\\n\\n```\\npublic async Task C\", \"learBasketAsync(string guidUser, string token) { UriBuilder builder = new UriBuilder(GlobalSetting.I\", \"nstance.BasketEndpoint); builder.Path = guidUser; string uri = builder.ToString(); await _requestPro\", \"vider.DeleteAsync(uri, token); }\\n```\\n\\nThis method builds the URI that identifies the resource that t\", \"he request will be sent to, and uses the RequestProvider class to invoke the DELETE HTTP method on t\", \"he resource. Note that an access token, obtained from IdentityServer during the authentication proce\", \"ss, is required to authorize requests to the basket microservice. For more information about authori\", \"zation, see Authorization.\\n\\nThe following code example shows the DeleteAsync method in the RequestPr\", \"ovider class:\\n\\n```\\npublic async Task DeleteAsync(string uri, string token = \\\"\\\") { HttpClient httpCli\", \"ent = CreateHttpClient(token); await httpClient.DeleteAsync(uri); }\\n```\\n\\nThis method calls the Creat\", \"eHttpClient method, which returns an instance of the HttpClient class with the appropriate headers s\", \"et. It then submits an asynchronous DELETE request to the resource identified by the URI. For more i\", \"nformation about the CreateHttpClient method, see Making a GET request.\\n\\nWhen the DeleteAsync method\", \" in the RequestProvider class calls HttpClient.DeleteAsync , the Delete method in the BasketControll\", \"er class in the Basket.API project is invoked, which is shown in the following code example:\\n\\n```\\n[H\", \"ttpDelete(\\\"{id}\\\")] public void Delete(string id) { _repository.DeleteBasketAsync(id); }\\n```\\n\\nThis me\", \"thod uses an instance of the RedisBasketRepository class to delete the basket data from the Redis ca\", \"che.\\n\\n## Caching data\\n\\nThe performance of an app can be improved by caching frequently accessed data\", \" to fast storage that's located close to the app. If the fast storage is located closer to the app t\", \"han the original source, then caching can significantly improve response times when retrieving data.\", \"\\n\\nThe most common form of caching is read-through caching, where an app retrieves data by referencin\", \"g the cache. If the data isn't in the cache, it's retrieved from the data store and added to the cac\", \"he. Apps can implement read-through caching with the cache-aside pattern. This pattern determines wh\", \"ether the item is currently in the cache. If the item isn't in the cache, it's read from the data st\", \"ore and added to the cache. For more information, see the Cache-Aside pattern on Microsoft Docs.\\n\\nTi\", \"p: Cache data that's read frequently and that changes infrequently\\n\\nThis data can be added to the ca\", \"che on demand the first time it is retrieved by an app. This means that the app needs to fetch the d\", \"ata only once from the data store, and that subsequent access can be satisfied by using the cache.\\n\\n\", \"Distributed applications, such as the eShopOnContainers reference application, should provide either\", \" or both of the following caches:\\n\\n- A shared cache, which can be accessed by multiple processes or \", \"machines.\\n- A private cache, where data is held locally on the device running the app.\\n\\nThe eShopOnC\", \"ontainers mobile app uses a private cache, where data is held locally on the device that's running a\", \"n instance of the app. For information about the cache used by the eShopOnContainers reference appli\", \"cation, see .NET Microservices: Architecture for Containerized .NET Applications.\\n\\nTip: Think of the\", \" cache as a transient data store that could disappear at any time\\n\\nEnsure that data is maintained in\", \" the original data store as well as the cache. The chances of losing data are then minimized if the \", \"cache becomes unavailable.\\n\\n## Managing data expiration\\n\\nIt's impractical to expect that cached data\", \" will always be consistent with the original data. Data in the original data store might change afte\", \"r it's been cached, causing the cached data to become stale. Therefore, apps should implement a stra\", \"tegy that helps to ensure that the data in the cache is as upto-date as possible, but can also detec\", \"t and handle situations that arise when the data in the cache has become stale. Most caching mechani\", \"sms enable the cache to be configured to expire data, and hence reduce the period for which data mig\", \"ht be out of date.\\n\\nTip: Set a default expiration time when configuring a cache\\n\\nMany caches impleme\", \"nt expiration, which invalidates data and removes it from the cache if it's not accessed for a speci\", \"fied period. However, care must be taken when choosing the expiration period. If it's made too short\", \", data will expire too quickly and the benefits of caching will be reduced. If it's made too long, t\", \"he data risks becoming stale. Therefore, the expiration time should match the pattern of access for \", \"apps that use the data.\\n\\nWhen cached data expires, it should be removed from the cache, and the app \", \"must retrieve the data from the original data store and place it back into the cache.\\n\\nIt's also pos\", \"sible that a cache might fill up if data is allowed to remain for too long a period. Therefore, requ\", \"ests to add new items to the cache might be required to remove some items in a process known as evic\", \"tion . Caching services typically evict data on a least-recently-used basis. However, there are othe\", \"r eviction policies, including most-recently-used, and first-in-first-out. For more information, see\", \" Caching Guidance on Microsoft Docs.\\n\\n## Caching images\\n\\nThe eShopOnContainers mobile app consumes r\", \"emote product images that benefit from being cached. These images are displayed by the Image control\", \", and the CachedImage control provided by the FFImageLoading library.\\n\\nThe Xamarin.Forms Image contr\", \"ol supports caching of downloaded images. Caching is enabled by default, and will store the image lo\", \"cally for 24 hours. In addition, the expiration time can be configured with the CacheValidity proper\", \"ty. For more information, see Downloaded Image Caching on the Xamarin Developer Center.\\n\\nFFImageLoad\", \"ing's CachedImage control is a replacement for the Xamarin.Forms Image control, providing additional\", \" properties that enable supplementary functionality. Amongst this functionality, the control provide\", \"s configurable caching, while supporting error and loading image placeholders. The following code ex\", \"ample shows how the eShopOnContainers mobile app uses the CachedImage control in the ProductTemplate\", \" , which is the data template used by the ListView control in the CatalogView :\\n\\n```\\n<ffimageloading\", \":CachedImage Grid.Row=\\\"0\\\" Source=\\\"{Binding PictureUri}\\\" Aspect=\\\"AspectFill\\\"> <ffimageloading:CachedI\", \"mage.LoadingPlaceholder> <OnPlatform x:TypeArguments=\\\"ImageSource\\\"\\n```\\n\\n```\\niOS=\\\"default_product\\\" An\", \"droid=\\\"default_product\\\" WinPhone=\\\"Assets/default_product.png\\\"/> </ffimageloading:CachedImage.Loading\", \"Placeholder> <ffimageloading:CachedImage.ErrorPlaceholder> <OnPlatform x:TypeArguments=\\\"ImageSource\\\"\", \" iOS=\\\"noimage\\\" Android=\\\"noimage\\\" WinPhone=\\\"Assets/noimage.png\\\"/> </ffimageloading:CachedImage.ErrorP\", \"laceholder> </ffimageloading:CachedImage>\\n```\\n\\nThe CachedImage control sets the LoadingPlaceholder a\", \"nd ErrorPlaceholder properties to platform-specific images. The LoadingPlaceholder property specifie\", \"s the image to be displayed while the image specified by the Source property is retrieved, and the E\", \"rrorPlaceholder property specifies the image to be displayed if an error occurs when attempting to r\", \"etrieve the image specified by the Source property.\\n\\nAs the name implies, the CachedImage control ca\", \"ches remote images on the device for the time specified by the value of the CacheDuration property. \", \"When this property value isn't explicitly set, the default value of 30 days is applied.\\n\\n## Increasi\", \"ng resilience\\n\\nAll apps that communicate with remote services and resources must be sensitive to tra\", \"nsient faults. Transient faults include the momentary loss of network connectivity to services, the \", \"temporary unavailability of a service, or timeouts that arise when a service is busy. These faults a\", \"re often selfcorrecting, and if the action is repeated after a suitable delay it's likely to succeed\", \".\\n\\nTransient faults can have a huge impact on the perceived quality of an app, even if it has been t\", \"horoughly tested under all foreseeable circumstances. To ensure that an app that communicates with r\", \"emote services operates reliably, it must be able to do all of the following:\\n\\n- Detect faults when \", \"they occur, and determine if the faults are likely to be transient.\\n- Retry the operation if it dete\", \"rmines that the fault is likely to be transient and keep track of the number of times the operation \", \"was retried.\\n- Use an appropriate retry strategy, which specifies the number of retries, the delay b\", \"etween each attempt, and the actions to take after a failed attempt.\\n\\nThis transient fault handling \", \"can be achieved by wrapping all attempts to access a remote service in code that implements the retr\", \"y pattern.\\n\\n## Retry pattern\\n\\nIf an app detects a failure when it tries to send a request to a remot\", \"e service, it can handle the failure in any of the following ways:\\n\\n- Retrying the operation. The ap\", \"p could retry the failing request immediately.\\n- Retrying the operation after a delay. The app shoul\", \"d wait for a suitable amount of time before retrying the request.\\n- Cancelling the operation. The ap\", \"plication should cancel the operation and report an exception.\\n\\nThe retry strategy should be tuned t\", \"o match the business requirements of the app. For example, it's important to optimize the retry coun\", \"t and retry interval to the operation being attempted. If the operation is part of a user interactio\", \"n, the retry interval should be short and only a few retries attempted to avoid making users wait fo\", \"r a response. If the operation is part of a long running workflow, where cancelling or restarting th\", \"e workflow is expensive or time-consuming, it's appropriate to wait longer between attempts and to r\", \"etry more times.\\n\\nNote: An aggressive retry strategy with minimal delay between attempts, and a larg\", \"e number of retries, could degrade a remote service that's running close to or at capacity. In addit\", \"ion, such a retry strategy could also affect the responsiveness of the app if it's continually tryin\", \"g to perform a failing operation.\\n\\nIf a request still fails after a number of retries, it's better f\", \"or the app to prevent further requests going to the same resource and to report a failure. Then, aft\", \"er a set period, the app can make one or more requests to the resource to see if they're successful.\", \" For more information, see Circuit breaker pattern.\\n\\nTip: Never implement an endless retry mechanism\", \"\\n\\nUse a finite number of retries, or implement the Circuit Breaker pattern to allow a service to rec\", \"over.\\n\\nThe eShopOnContainers mobile app does not currently implement the retry pattern when making R\", \"ESTful web requests. However, the CachedImage control, provided by the FFImageLoading library suppor\", \"ts transient fault handling by retrying image loading. If image loading fails, further attempts will\", \" be made. The number of attempts is specified by the RetryCount property, and retries will occur aft\", \"er a delay specified by the RetryDelay property. If these property values aren't explicitly set, the\", \"ir default values are applied -3 for the RetryCount property, and 250ms for the RetryDelay property.\", \" For more information about the CachedImage control, see Caching images.\\n\\nThe eShopOnContainers refe\", \"rence application does implement the retry pattern. For more information, including a discussion of \", \"how to combine the retry pattern with the HttpClient class, see .NET Microservices: Architecture for\", \" Containerized .NET Applications.\\n\\nFor more information about the retry pattern, see the Retry patte\", \"rn on Microsoft Docs.\\n\\n## Circuit breaker pattern\\n\\nIn some situations, faults can occur due to antic\", \"ipated events that take longer to fix. These faults can range from a partial loss of connectivity to\", \" the complete failure of a service. In these situations, it's pointless for an app to retry an opera\", \"tion that's unlikely to succeed, and instead should accept that the operation has failed and handle \", \"this failure accordingly.\\n\\nThe circuit breaker pattern can prevent an app from repeatedly trying to \", \"execute an operation that's likely to fail, while also enabling the app to detect whether the fault \", \"has been resolved.\\n\\nNote: The purpose of the circuit breaker pattern is different from the retry pat\", \"tern. The retry pattern enables an app to retry an operation in the expectation that it'll succeed. \", \"The circuit breaker pattern prevents an app from performing an operation that's likely to fail.\\n\\nA c\", \"ircuit breaker acts as a proxy for operations that might fail. The proxy should monitor the number o\", \"f recent failures that have occurred, and use this information to decide whether to allow the operat\", \"ion to proceed, or to return an exception immediately.\\n\\nThe eShopOnContainers mobile app does not cu\", \"rrently implement the circuit breaker pattern. However, the eShopOnContainers does. For more informa\", \"tion, see .NET Microservices: Architecture for Containerized .NET Applications.\\n\\nTip: Combine the re\", \"try and circuit breaker patterns\\n\\nAn app can combine the retry and circuit breaker patterns by using\", \" the retry pattern to invoke an operation through a circuit breaker. However, the retry logic should\", \" be sensitive to any exceptions returned by the circuit breaker and abandon retry attempts if the ci\", \"rcuit breaker indicates that a fault is not transient.\\n\\nFor more information about the circuit break\", \"er pattern, see the Circuit Breaker pattern on Microsoft Docs.\\n\\n## Summary\\n\\nMany modern web-based so\", \"lutions make use of web services, hosted by web servers, to provide functionality for remote client \", \"applications. The operations that a web service exposes constitute a web API, and client apps should\", \" be able to utilize the web API without knowing how the data or operations that the API exposes are \", \"implemented.\\n\\nThe performance of an app can be improved by caching frequently accessed data to fast \", \"storage that's located close to the app. Apps can implement read-through caching with the cache-asid\", \"e pattern. This pattern determines whether the item is currently in the cache. If the item isn't in \", \"the cache, it's read from the data store and added to the cache.\\n\\nWhen communicating with web APIs, \", \"apps must be sensitive to transient faults. Transient faults include the momentary loss of network c\", \"onnectivity to services, the temporary unavailability of a service, or timeouts that arise when a se\", \"rvice is busy. These faults are often self-correcting, and if the action is repeated after a suitabl\", \"e delay, then it's likely to succeed. Therefore, apps should wrap all attempts to access a web API i\", \"n code that implements a transient fault handling mechanism.\\n\\n## Unit testing\\n\\nMobile apps have uniq\", \"ue problems that desktop and web-based applications don't have to worry about. Mobile users will dif\", \"fer by the devices that they use, by network connectivity, by the availability of services, and a ra\", \"nge of other factors. Therefore, mobile apps should be tested as they will be used in the real world\", \" in order to improve their quality, reliability, and performance. There are many types of testing th\", \"at should be performed on an app, including unit testing, integration testing, and user interface te\", \"sting, with unit testing being the most common form of testing.\\n\\nA unit test takes a small unit of t\", \"he app, typically a method, isolates it from the remainder of the code, and verifies that it behaves\", \" as expected. Its goal is to check that each unit of functionality performs as expected, so that err\", \"ors don't propagate throughout the app. Detecting a bug where it occurs is more efficient that obser\", \"ving the effect of a bug indirectly at a secondary point of failure.\\n\\nUnit testing has the greatest \", \"effect on code quality when it's an integral part of the software development workflow. As soon as a\", \" method has been written, unit tests should be written that verify the behavior of the method in res\", \"ponse to standard, boundary, and incorrect cases of input data, and that check any explicit or impli\", \"cit assumptions made by the code. Alternatively, with test driven development, unit tests are writte\", \"n before the code. In this scenario, unit tests act as both design documentation and functional spec\", \"ifications.\\n\\nNote: Unit tests are very effective against regression -that is, functionality that use\", \"d to work but has been disturbed by a faulty update.\\n\\nUnit tests typically use the arrange-act-asser\", \"t pattern:\\n\\n- The arrange section of the unit test method initializes objects and sets the value of \", \"the data that is passed to the method under test.\\n- The act section invokes the method under test wi\", \"th the required arguments.\\n- The assert section verifies that the action of the method under test be\", \"haves as expected.\\n\\nFollowing this pattern ensures that unit tests are readable and consistent.\\n\\n## \", \"Dependency injection and unit testing\\n\\nOne of the motivations for adopting a loosely-coupled archite\", \"cture is that it facilitates unit testing. One of the types registered with Autofac is the OrderServ\", \"ice class. The following code example shows an outline of this class:\\n\\n```\\npublic class OrderDetailV\", \"iewModel : ViewModelBase { private IOrderService _ordersService; public OrderDetailViewModel(IOrderS\", \"ervice ordersService)\\n```\\n\\n```\\n86 CHAPTER 11  |  Unit testing\\n```\\n\\n\\u2022\\n\\nIOrderService\\n\\n```\\n{ _ordersSe\", \"rvice = ordersService; } ... }\\n```\\n\\nThe OrderDetailViewModel class has a dependency on the IOrderSer\", \"vice type which the container resolves when it instantiates a OrderDetailViewModel object. However, \", \"rather than create an OrderService object to unit test the OrderDetailViewModel class, instead, repl\", \"ace the OrderService object with a mock for the purpose of the tests. Figure 10-1 illustrates this r\", \"elationship.\\n\\nFigure 10-1: Classes that implement the IOrderService interface\\n\\nThis approach allows \", \"the OrderService object to be passed into the OrderDetailViewModel class at runtime, and in the inte\", \"rests of testability, it allows the OrderMockService class to be passed into the OrderDetailViewMode\", \"l class at test time. The main advantage of this approach is that it enables unit tests to be execut\", \"ed without requiring unwieldy resources such as web services, or databases.\\n\\n## Testing MVVM applica\", \"tions\\n\\nTesting models and view models from MVVM applications is identical to testing any other class\", \"es, and the same tools and techniques -such as unit testing and mocking, can be used. However, there\", \" are some patterns that are typical to model and view model classes, that can benefit from specific \", \"unit testing techniques.\\n\\nTip: Test one thing with each unit test\\n\\nDon't be tempted to make a unit t\", \"est exercise more than one aspect of the unit's behavior. Doing so leads to tests that are difficult\", \" to read and update. It can also lead to confusion when interpreting a failure.\\n\\nThe eShopOnContaine\", \"rs mobile app uses xUnit to perform unit testing, which supports two different types of unit tests:\\n\", \"\\n- Facts are tests that are always true, which test invariant conditions.\\n- Theories are tests that \", \"are only true for a particular set of data.\\n\\nThe unit tests included with the eShopOnContainers mobi\", \"le app are fact tests, and so each unit test method is decorated with the [Fact] attribute.\\n\\nNote: x\", \"Unit tests are executed by a test runner. To execute the test runner, run the eShopOnContainers.Test\", \"Runner project for the required platform.\\n\\n## Testing asynchronous functionality\\n\\nWhen implementing \", \"the MVVM pattern, view models usually invoke operations on services, often asynchronously. Tests for\", \" code that invokes these operations typically use mocks as replacements for the actual services. The\", \" following code example demonstrates testing asynchronous functionality by passing a mock service in\", \"to a view model:\\n\\n```\\n[Fact] public async Task OrderPropertyIsNotNullAfterViewModelInitializationTes\", \"t() { var orderService = new OrderMockService(); var orderViewModel = new OrderDetailViewModel(order\", \"Service); var order = await orderService.GetOrderAsync(1, GlobalSetting.Instance.AuthToken); await o\", \"rderViewModel.InitializeAsync(order); Assert.NotNull(orderViewModel.Order); }\\n```\\n\\nThis unit test ch\", \"ecks that the Order property of the OrderDetailViewModel instance will have a value after the Initia\", \"lizeAsync method has been invoked. The InitializeAsync method is invoked when the view model's corre\", \"sponding view is navigated to. For more information about navigation, see Navigation.\\n\\nWhen the Orde\", \"rDetailViewModel instance is created, it expects an OrderService instance to be specified as an argu\", \"ment. However, the OrderService retrieves data from a web service. Therefore, an OrderMockService in\", \"stance, which is a mock version of the OrderService class, is specified as the argument to the Order\", \"DetailViewModel constructor. Then, when the view model's InitializeAsync method is invoked, which in\", \"vokes IOrderService operations, mock data is retrieved rather than communicating with a web service.\", \"\\n\\n## Testing INotifyPropertyChanged implementations\\n\\nImplementing the INotifyPropertyChanged interfa\", \"ce allows views to react to changes that originate from view models and models. These changes are no\", \"t limited to data shown in controls -they are also used to control the view, such as view model stat\", \"es that cause animations to be started or controls to be disabled.\\n\\nProperties that can be updated d\", \"irectly by the unit test can be tested by attaching an event handler to the PropertyChanged event an\", \"d checking whether the event is raised after setting a new value for the property. The following cod\", \"e example shows such a test:\\n\\n```\\n[Fact] public async Task SettingOrderPropertyShouldRaisePropertyCh\", \"anged() { bool invoked = false; var orderService = new OrderMockService(); var orderViewModel = new \", \"OrderDetailViewModel(orderService); orderViewModel.PropertyChanged += (sender, e) => {\\n```\\n\\n```\\nif (\", \"e.PropertyName.Equals(\\\"Order\\\")) invoked = true; }; var order = await orderService.GetOrderAsync(1, G\", \"lobalSetting.Instance.AuthToken); await orderViewModel.InitializeAsync(order); Assert.True(invoked);\", \" }\\n```\\n\\nThis unit test invokes the InitializeAsync method of the OrderViewModel class, which causes \", \"its Order property to be updated. The unit test will pass, provided that the PropertyChanged event i\", \"s raised for the Order property.\\n\\n## Testing message-based communication\\n\\nView models that use the M\", \"essagingCenter class to communicate between loosely-coupled classes can be unit tested by subscribin\", \"g to the message being sent by the code under test, as demonstrated in the following code example:\\n\\n\", \"```\\n[Fact] public void AddCatalogItemCommandSendsAddProductMessageTest() { bool messageReceived = fa\", \"lse; var catalogService = new CatalogMockService(); var catalogViewModel = new CatalogViewModel(cata\", \"logService); Xamarin.Forms.MessagingCenter.Subscribe<CatalogViewModel, CatalogItem>( this, MessageKe\", \"ys.AddProduct, (sender, arg) => { messageReceived = true; }); catalogViewModel.AddCatalogItemCommand\", \".Execute(null); Assert.True(messageReceived); }\\n```\\n\\nThis unit test checks that the CatalogViewModel\", \" publishes the AddProduct message in response to its AddCatalogItemCommand being executed. Because t\", \"he MessagingCenter class supports multicast message subscriptions, the unit test can subscribe to th\", \"e AddProduct message and execute a callback delegate in response to receiving it. This callback dele\", \"gate, specified as a lambda expression, sets a boolean field that's used by the Assert statement to \", \"verify the behavior of the test.\\n\\n## Testing exception handling\\n\\nUnit tests can also be written that\", \" check that specific exceptions are thrown for invalid actions or inputs, as demonstrated in the fol\", \"lowing code example:\\n\\n```\\n[Fact] public void InvalidEventNameShouldThrowArgumentExceptionText() { va\", \"r behavior = new MockEventToCommandBehavior { EventName = \\\"OnItemTapped\\\" }; var listView = new ListV\", \"iew(); Assert.Throws<ArgumentException>(() => listView.Behaviors.Add(behavior)); }\\n```\\n\\nThis unit te\", \"st will throw an exception, because the ListView control does not have an event named OnItemTapped .\", \" The Assert.Throws&lt;T&gt; method is a generic method where T is the type of the expected exception\", \". The argument passed to the Assert.Throws&lt;T&gt; method is a lambda expression that will throw th\", \"e exception. Therefore, the unit test will pass provided that the lambda expression throws an Argume\", \"ntException .\\n\\nTip : Avoid writing unit tests that examine exception message strings\\n\\nException mess\", \"age strings might change over time, and so unit tests that rely on their presence are regarded as br\", \"ittle.\\n\\n## Testing validation\\n\\nThere are two aspects to testing the validation implementation: testi\", \"ng that any validation rules are correctly implemented, and testing that the ValidatableObject&lt;T&\", \"gt; class performs as expected.\\n\\nValidation logic is usually simple to test, because it is typically\", \" a self-contained process where the output depends on the input. There should be tests on the result\", \"s of invoking the Validate method on each property that has at least one associated validation rule,\", \" as demonstrated in the following code example:\\n\\n```\\n[Fact] public void CheckValidationPassesWhenBot\", \"hPropertiesHaveDataTest() { var mockViewModel = new MockViewModel(); mockViewModel.Forename.Value = \", \"\\\"John\\\"; mockViewModel.Surname.Value = \\\"Smith\\\"; bool isValid = mockViewModel.Validate(); Assert.True(\", \"isValid); }\\n```\\n\\nThis unit test checks that validation succeeds when the two ValidatableObject&lt;T&\", \"gt; properties in the MockViewModel instance both have data.\\n\\nAs well as checking that validation su\", \"cceeds, validation unit tests should also check the values of the Value , IsValid , and Errors prope\", \"rty of each ValidatableObject&lt;T&gt; instance, to verify that the class performs as expected. The \", \"following code example demonstrates a unit test that does this:\\n\\n```\\n[Fact] public void CheckValidat\", \"ionFailsWhenOnlyForenameHasDataTest() { var mockViewModel = new MockViewModel(); mockViewModel.Foren\", \"ame.Value = \\\"John\\\"; bool isValid = mockViewModel.Validate(); Assert.False(isValid); Assert.NotNull(m\", \"ockViewModel.Forename.Value); Assert.Null(mockViewModel.Surname.Value); Assert.True(mockViewModel.Fo\", \"rename.IsValid); Assert.False(mockViewModel.Surname.IsValid); Assert.Empty(mockViewModel.Forename.Er\", \"rors); Assert.NotEmpty(mockViewModel.Surname.Errors); }\\n```\\n\\nThis unit test checks that validation f\", \"ails when the Surname property of the MockViewModel doesn't have any data, and the Value , IsValid ,\", \" and Errors property of each ValidatableObject&lt;T&gt; instance are correctly set.\\n\\n## Summary\\n\\nA u\", \"nit test takes a small unit of the app, typically a method, isolates it from the remainder of the co\", \"de, and verifies that it behaves as expected. Its goal is to check that each unit of functionality p\", \"erforms as expected, so that errors don't propagate throughout the app.\\n\\nThe behavior of an object u\", \"nder test can be isolated by replacing dependent objects with mock objects that simulate the behavio\", \"r of the dependent objects. This enables unit tests to be executed without requiring unwieldy resour\", \"ces such as web services, or databases.\\n\\nTesting models and view models from MVVM applications is id\", \"entical to testing any other classes, and the same tools and techniques can be used.\\n\\n92\\n\\nCHAPTER 11\", \"  |  Unit testing Visit our NET Architecture Center\"]"