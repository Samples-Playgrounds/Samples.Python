"[\"![](_page_0_Picture_0.jpeg)\\n\\n# Architecting Cloud-Native .NET Apps for Azure\\n\\n![](_page_0_Picture_2.\", \"jpeg)\\n\\nRobert Vettor Steve \\\"ardalis\\\" Smith\\n\\n![](_page_1_Picture_0.jpeg)\\n\\n#### **EDITION v1.0.3**\\n\\nRe\", \"fer [changelog](https://aka.ms/cn-ebook-changelog) for the book updates and community contributions.\", \"\\n\\nPUBLISHED BY\\n\\nMicrosoft Developer Division, .NET, and Visual Studio product teams\\n\\nA division of M\", \"icrosoft Corporation\\n\\nOne Microsoft Way\\n\\nRedmond, Washington 98052-6399\\n\\nCopyright \\u00a9 2023 by Microso\", \"ft Corporation\\n\\nAll rights reserved. No part of the contents of this book may be reproduced or trans\", \"mitted in any form or by any means without the written permission of the publisher.\\n\\nThis book is pr\", \"ovided \\\"as-is\\\" and expresses the author's views and opinions. The views, opinions, and information e\", \"xpressed in this book, including URL and other Internet website references, may change without notic\", \"e.\\n\\nSome examples depicted herein are provided for illustration only and are fictitious. No real ass\", \"ociation or connection is intended or should be inferred.\\n\\nMicrosoft and the trademarks listed at [h\", \"ttps://www.microsoft.com](https://www.microsoft.com/) on the \\\"Trademarks\\\" webpage are trademarks of \", \"the Microsoft group of companies.\\n\\nMac and macOS are trademarks of Apple Inc.\\n\\nThe Docker whale logo\", \" is a registered trademark of Docker, Inc. Used by permission.\\n\\nAll other marks and logos are proper\", \"ty of their respective owners.\\n\\nAuthors:\\n\\n**Rob Vettor**, Principal MTC (Microsoft Technology Center\", \") Architect for Cloud App Innovation [thinkingincloudnative.com,](https://thinkingincloudnative.com/\", \"about/) Microsoft\\n\\n**Steve \\\"ardalis\\\" Smith**, Software Architect and Trainer - [Ardalis.com](https:/\", \"/ardalis.com/)\\n\\nParticipants and Reviewers:\\n\\n**Cesar De la Torre**, Principal Program Manager, .NET \", \"team, Microsoft\\n\\n**Nish Anil**, Senior Program Manager, .NET team, Microsoft\\n\\n**Jeremy Likness**, Se\", \"nior Program Manager, .NET team, Microsoft\\n\\n**Cecil Phillip**, Senior Cloud Advocate, Microsoft\\n\\n**S\", \"umit Ghosh**, Principal Consultant at Neudesic\\n\\nEditors:\\n\\n**Maira Wenzel**, Program Manager, .NET te\", \"am, Microsoft\\n\\n![](_page_2_Picture_0.jpeg)\\n\\n**David Pine**, Senior Content Developer, .NET docs, Mic\", \"rosoft\\n\\n# Version\\n\\nThis guide has been written to cover **.NET 7** version along with many additiona\", \"l updates related to the same \\\"wave\\\" of technologies (that is, Azure and additional third-party tech\", \"nologies) coinciding in time with the .NET 7 release.\\n\\n# Who should use this guide\\n\\nThe audience for\", \" this guide is mainly developers, development leads, and architects who are interested in learning h\", \"ow to build applications designed for the cloud.\\n\\nA secondary audience is technical decision-makers \", \"who plan to choose whether to build their applications using a cloud-native approach.\\n\\n# How you can\", \" use this guide\\n\\nThis guide begins by defining cloud native and introducing a reference application \", \"built using cloudnative principles and technologies. Beyond these first two chapters, the rest of th\", \"e book is broken up into specific chapters focused on topics common to most cloud-native application\", \"s. You can jump to any of these chapters to learn about cloud-native approaches to:\\n\\n- Data and data\", \" access\\n- Communication patterns\\n- Scaling and scalability\\n- Application resiliency\\n- Monitoring and\", \" health\\n- Identity and security\\n- DevOps\\n\\nThis guide is available both in [PDF](https://dotnet.micro\", \"soft.com/download/e-book/cloud-native-azure/pdf) form and online. Feel free to forward this document\", \" or links to its online version to your team to help ensure common understanding of these topics. Mo\", \"st of these topics benefit from a consistent understanding of the underlying principles and patterns\", \", as well as the trade-offs involved in decisions related to these topics. Our goal with this docume\", \"nt is to equip teams and their leaders with the information they need to make well-informed decision\", \"s for their applications' architecture, development, and hosting.\\n\\n# Contents\\n\\n| Introduction to clo\", \"ud-native applications        | 1  |\\n|--------------------------------------------------|----|\\n| Clo\", \"ud-native computing                           | 3  |\\n| What is Cloud Native?                        \", \"    | 4  |\\n| The pillars of cloud native                      | 5  |\\n| The cloud                    \", \"                    | 5  |\\n| Modern design                                    | 6  |\\n| Microservices\", \"                                    | 9  |\\n| Containers                                       | 12 |\", \"\\n| Backing services                                 | 15 |\\n| Automation                             \", \"          | 17 |\\n| Candidate apps for cloud native                  | 19 |\\n| Modernizing legacy apps\", \"                          | 19 |\\n| Summary                                          | 21 |\\n| Introdu\", \"cing eShopOnContainers reference app      | 22 |\\n| Features and requirements                        \", \"| 23 |\\n| Overview of the code                             | 25 |\\n| Understanding microservices      \", \"                | 27 |\\n| Mapping eShopOnContainers to Azure Services      | 27 |\\n| Container orchest\", \"ration and clustering           | 28 |\\n| API Gateway                                      | 28 |\\n| D\", \"ata                                             | 29 |\\n| Event Bus                                  \", \"      | 30 |\\n| Resiliency                                       | 30 |\\n| Deploying eShopOnContainers\", \" to Azure             | 30 |\\n| Azure Kubernetes Service                         | 30 |\\n| Deploying t\", \"o Azure Kubernetes Service using Helm | 30 |\\n| Azure Functions and Logic Apps (Serverless)      | 32\", \" |\\n| Centralized configuration                        | 33 |\\n\\n| Azure App Configuration             \", \"                                     | 33 |\\n|-------------------------------------------------------\", \"-------------------|----|\\n| Azure Key Vault                                                         \", \" | 32 |\\n| Configuration in eShop                                                   | 34 |\\n| Referenc\", \"es                                                               | 34 |\\n| Scaling cloud-native appli\", \"cations                                        | 36 |\\n| Leveraging containers and orchestrators     \", \"                             | 36 |\\n| Challenges with monolithic deployments                        \", \"           | 36 |\\n| What are the benefits of containers and orchestrators?                   | 38 |\\n\", \"| What are the scaling benefits?                                           | 40 |\\n| What scenarios a\", \"re ideal for containers and orchestrators?               | 42 |\\n| When should you avoid using contai\", \"ners and orchestrators?                | 42 |\\n| Development resources                               \", \"                     | 42 |\\n| Leveraging serverless functions                                       \", \"   | 46 |\\n| What is serverless?                                                      | 47 |\\n| What c\", \"hallenges are solved by serverless?                                | 47 |\\n| What is the difference b\", \"etween a microservice and a serverless function? | 47 |\\n| What scenarios are appropriate for serverl\", \"ess?                           | 47 |\\n| When should you avoid serverless?                           \", \"             | 48 |\\n| Combining containers and serverless approaches                           | 49 \", \"|\\n| When does it make sense to use containers with serverless?               | 49 |\\n| When should yo\", \"u avoid using containers with Azure Functions?             | 49 |\\n| How to combine serverless and Do\", \"cker containers                          | 49 |\\n| How to combine serverless and Kubernetes with KEDA\", \"                       | 50 |\\n| Deploying containers in Azure                                       \", \"     | 50 |\\n| Azure Container Registry                                                 | 50 |\\n| ACR \", \"Tasks                                                                | 52 |\\n| Azure Kubernetes Servi\", \"ce                                                 | 52 |\\n| Azure Bridge to Kubernetes              \", \"                                 | 53 |\\n| Scaling containers and serverless applications            \", \"               | 53 |\\n| The simple solution: scaling up                                          | 5\", \"3 |\\n| Scaling out cloud-native apps                                            | 52 |\\n| Other contai\", \"ner deployment options                                       | 51 |\\n\\n| When does it make sense to de\", \"ploy to App Service for Containers? | 55 |\\n|--------------------------------------------------------\", \"----------|----|\\n| How to deploy to App Service for Containers                      | 55 |\\n| When do\", \"es it make sense to deploy to Azure Container Instances?  | 55 |\\n| How to deploy an app to Azure Con\", \"tainer Instances                | 55 |\\n| References                                                 \", \"      | 56 |\\n| Cloud-native communication patterns                              | 58 |\\n| Communicati\", \"on considerations                                     | 58 |\\n| Front-end client communication       \", \"                            | 60 |\\n| Simple Gateways                                                \", \"  | 62 |\\n| Azure Application Gateway                                        | 63 |\\n| Azure API Manag\", \"ement                                             | 63 |\\n| Real-time communication                  \", \"                        | 66 |\\n| Service-to-service communication                                 | \", \"67 |\\n| Queries                                                          | 68 |\\n| Commands           \", \"                                              | 71 |\\n| Events                                       \", \"                    | 74 |\\n| gRPC                                                             | 80 |\", \"\\n| What is gRPC?                                                    | 80 |\\n| gRPC Benefits          \", \"                                          | 80 |\\n| Protocol Buffers                                 \", \"                | 81 |\\n| gRPC support in .NET                                             | 81 |\\n| g\", \"RPC usage                                                       | 82 |\\n| gRPC implementation        \", \"                                      | 83 |\\n| Looking ahead                                        \", \"            | 85 |\\n| Service Mesh communication infrastructure                        | 85 |\\n| Summa\", \"ry                                                          | 86 |\\n| Cloud-native data patterns     \", \"                                  | 88 |\\n| Database-per-microservice, why?                          \", \"        | 89 |\\n| Cross-service queries                                            | 90 |\\n| Distribut\", \"ed transactions                                         | 91 |\\n| High volume data                   \", \"                              | 93 |\\n| CORS                                                         \", \"    | 03 |\\n\\n| Event sourcing                                  | 94  |\\n|-----------------------------\", \"--------------------|-----|\\n| Relational vs. NoSQL data                       | 96  |\\n| The CAP theo\", \"rem                                 | 97  |\\n| Considerations for relational vs. NoSQL systems | 99  \", \"|\\n| Database as a Service                           | 99  |\\n| Azure relational databases            \", \"          | 100 |\\n| Azure SQL Database                              | 100 |\\n| Open-source databases \", \"in Azure                  | 101 |\\n| NoSQL data in Azure                             | 102 |\\n| NewSQL\", \" databases                                | 106 |\\n| Data migration to the cloud                     \", \"| 108 |\\n| Caching in a cloud-native app                   | 108 |\\n| Why?                            \", \"                | 108 |\\n| Caching architecture                            | 109 |\\n| Azure Cache for \", \"Redis                           | 110 |\\n| Elasticsearch in a cloud-native app             | 110 |\\n| \", \"Summary                                         | 111 |\\n| Cloud-native resiliency                   \", \"      | 113 |\\n| Application resiliency patterns                 | 114 |\\n| Circuit breaker pattern   \", \"                      | 116 |\\n| Testing for resiliency                          | 117 |\\n| Azure plat\", \"form resiliency                       | 117 |\\n| Design with resiliency                          | 11\", \"8 |\\n| Design with redundancy                          | 118 |\\n| Design for scalability              \", \"            | 120 |\\n| Built-in retry in services                      | 121 |\\n| Resilient communicat\", \"ions                        | 122 |\\n| Service mesh                                    | 123 |\\n| Isti\", \"o and Envoy                                 | 124 |\\n| Integration with Azure Kubernetes Services    \", \"  | 125 |\\n| Monitoring and health                           | 126 |\\n| Observability patterns        \", \"                  | 126 |\\n\\n| When to use logging                                                    \", \" | 126 |\\n|-------------------------------------------------------------------------|-----|\\n| Challen\", \"ges with detecting and responding to potential app health issues | 130 |\\n| Challenges with reacting \", \"to critical problems in cloud-native apps      | 130 |\\n| Logging with Elastic Stack                 \", \"                             | 131 |\\n| Elastic Stack                                                \", \"           | 131 |\\n| What are the advantages of Elastic Stack?                               | 132 |\", \"\\n| Logstash                                                                | 132 |\\n| Elasticsearch  \", \"                                                         | 133 |\\n| Visualizing information with Kiba\", \"na web dashboards                      | 133 |\\n| Installing Elastic Stack on Azure                  \", \"                     | 134 |\\n| References                                                           \", \"   | 134 |\\n| Monitoring in Azure Kubernetes Services                                 | 134 |\\n| Azure\", \" Monitor for Containers                                            | 134 |\\n| Log.Finalize()         \", \"                                                 | 136 |\\n| Azure Monitor                            \", \"                               | 136 |\\n| Gathering logs and metrics                                 \", \"             | 137 |\\n| Reporting data                                                          | 137\", \" |\\n| Dashboards                                                              | 138 |\\n| Alerts       \", \"                                                           | 140 |\\n| References                     \", \"                                         | 141 |\\n| Cloud-native identity                            \", \"                       | 142 |\\n| References                                                         \", \"     | 142 |\\n| Authentication and authorization in cloud-native apps                   | 142 |\\n| Ref\", \"erences                                                              | 143 |\\n| Azure Active Director\", \"y                                                  | 143 |\\n| References                             \", \"                                 | 143 |\\n| IdentityServer for cloud-native applications             \", \"               | 144 |\\n| Common web app scenarios                                                | 1\", \"44 |\\n| Getting started                                                         | 145 |\\n| Configurati\", \"on                                                           |     |\\n| JavaScript clients           \", \"                                           |     |\\n| References                                     \", \"                         |     |\\n\\n| Cloud-native security                                           \", \"    | 147 |\\n|---------------------------------------------------------------------|-----|\\n| Azure se\", \"curity for cloud-native apps                                | 147 |\\n| Threat modeling               \", \"                                      | 148 |\\n| Principle of least privilege                        \", \"                | 148 |\\n| Penetration testing                                                 | 149 \", \"|\\n| Monitoring                                                          | 149 |\\n| Securing the build\", \"                                                  | 149 |\\n| Building secure code                    \", \"                            | 150 |\\n| Built-in security                                             \", \"      | 150 |\\n| Azure network infrastructure                                        | 150 |\\n| Role-b\", \"ased access control for restricting access to Azure resources | 152 |\\n| Security Principals         \", \"                                        | 152 |\\n| Roles                                             \", \"                  | 153 |\\n| Scopes                                                              | 15\", \"4 |\\n| Deny                                                                | 154 |\\n| Checking access \", \"                                                    | 154 |\\n| Securing secrets                      \", \"                              | 155 |\\n| Azure Key Vault                                             \", \"        | 155 |\\n| Kubernetes                                                          | 155 |\\n| Encr\", \"yption in transit and at rest                                   | 156 |\\n| Keeping secure            \", \"                                          | 160 |\\n| DevOps                                          \", \"                    | 161 |\\n| Azure DevOps                                                        | \", \"162 |\\n| GitHub Actions                                                      | 163 |\\n| Source control\", \"                                                      | 163 |\\n| Repository per microservice         \", \"                                | 164 |\\n| Single repository                                         \", \"          |     |\\n| Standard directory structure                                        |     |\\n| Ta\", \"sk management                                                     |     |\\n| CI/CD pipelines         \", \"                                            |     |\\n| Azure Builds                                  \", \"                      |     |\\n| Azure DevOps releases                                               \", \"|     |\\n\\n| Summary: Architecting cloud-native apps | 181 |\\n|----------------------------------------\", \"-|-----|\\n| References                              | 180 |\\n| DevOps Decisions                       \", \" |     |\\n| Cloud Native Application Bundles        |     |\\n| Azure CLI Scripts and Tasks            \", \" |     |\\n| Terraform                               | 176 |\\n| Azure Resource Manager templates       \", \" | 175 |\\n| Infrastructure as code                  | 175 |\\n| Implementing feature flags             \", \" | 174 |\\n| Feature flags                           | 173 |\\n| Versioning releases                    \", \" | 173 |\\n| Everybody gets a build pipeline         | 173 |\\n\\n**CHAPTER** 1\\n\\n# <span id=\\\"page-10-0\\\"></\", \"span>Introduction to cloudnative applications\\n\\nAnother day, at the office, working on \\\"the next big \", \"thing.\\\"\\n\\nYour cellphone rings. It's your friendly recruiter - the one who calls daily with exciting \", \"new opportunities.\\n\\nBut this time it's different: Start-up, equity, and plenty of funding.\\n\\nThe ment\", \"ion of the cloud, microservices, and cutting-edge technology pushes you over the edge.\\n\\nFast forward\", \" a few weeks and you're now a new employee in a design session architecting a major eCommerce applic\", \"ation. You're going to compete with the leading eCommerce sites.\\n\\nHow will you build it?\\n\\nIf you fol\", \"low the guidance from past 15 years, you'll most likely build the system shown in Figure 1.1.\\n\\n![](_\", \"page_10_Figure_9.jpeg)\\n\\n*Figure 1-1. Traditional monolithic design*\\n\\nYou construct a large core appl\", \"ication containing all of your domain logic. It includes modules such as Identity, Catalog, Ordering\", \", and more. They directly communicate with each other within a single server process. The modules sh\", \"are a large relational database. The core exposes functionality via an HTML interface and a mobile a\", \"pp.\\n\\nCongratulations! You just created a monolithic application.\\n\\nNot all is bad. Monoliths offer so\", \"me distinct advantages. For example, they're straightforward to\\u2026\\n\\n- build\\n- test\\n- deploy\\n- troubles\", \"hoot\\n- vertically scale\\n\\nMany successful apps that exist today were created as monoliths. The app is\", \" a hit and continues to evolve, iteration after iteration, adding more functionality.\\n\\nAt some point\", \", however, you begin to feel uncomfortable. You find yourself losing control of the application. As \", \"time goes on, the feeling becomes more intense, and you eventually enter a state known as the Fear C\", \"ycle:\\n\\n- The app has become so overwhelmingly complicated that no single person understands it.\\n- Yo\", \"u fear making changes each change has unintended and costly side effects.\\n- New features/fixes becom\", \"e tricky, time-consuming, and expensive to implement.\\n- Each release becomes as small as possible an\", \"d requires a full deployment of the entire application.\\n- One unstable component can crash the entir\", \"e system.\\n- New technologies and frameworks aren't an option.\\n- It's difficult to implement agile de\", \"livery methodologies.\\n- Architectural erosion sets in as the code base deteriorates with never-endin\", \"g \\\"quick fixes.\\\"\\n- Finally, the *consultants* come in and tell you to rewrite it.\\n\\n#### Sound famili\", \"ar?\\n\\nMany organizations have addressed this monolithic fear cycle by adopting a cloud-native approac\", \"h to building systems. Figure 1-2 shows the same system built applying cloud-native techniques and p\", \"ractices.\\n\\n![](_page_12_Figure_0.jpeg)\\n\\n*Figure 1-2. Cloud-native design*\\n\\nNote how the application \", \"is decomposed across a set of small isolated microservices. Each service is self-contained and encap\", \"sulates its own code, data, and dependencies. Each is deployed in a software container and managed b\", \"y a container orchestrator. Instead of a large relational database, each service owns it own datasto\", \"re, the type of which vary based upon the data needs. Note how some services depend on a relational \", \"database, but other on NoSQL databases. One service stores its state in a distributed cache. Note ho\", \"w all traffic routes through an API Gateway service that is responsible for routing traffic to the c\", \"ore back-end services and enforcing many cross-cutting concerns. Most importantly, the application t\", \"akes full advantage of the scalability, availability, and resiliency features found in modern cloud \", \"platforms.\\n\\n#### <span id=\\\"page-12-0\\\"></span>**Cloud-native computing**\\n\\nHmm\\u2026 We just used the term,\", \" *Cloud Native*. Your first thought might be, \\\"What exactly does that mean?\\\" Another industry buzzwo\", \"rd concocted by software vendors to market more stuff?\\\"\\n\\nFortunately it's far different, and hopeful\", \"ly this book will help convince you.\\n\\nWithin a short time, cloud native has become a driving trend i\", \"n the software industry. It's a new way to construct large, complex systems. The approach takes full\", \" advantage of modern software development practices, technologies, and cloud infrastructure. Cloud n\", \"ative changes the way you design, implement, deploy, and operationalize systems.\\n\\nUnlike the continu\", \"ous hype that drives our industry, cloud native is *for-real*. Consider the [Cloud Native](https://w\", \"ww.cncf.io/)  [Computing Foundation](https://www.cncf.io/) (CNCF), a consortium of over 400 major co\", \"rporations. Its charter is to make\\n\\ncloud-native computing ubiquitous across technology and cloud st\", \"acks. As one of the most influential open-source groups, it hosts many of the fastest-growing open s\", \"ource-projects in GitHub. These projects include [Kubernetes,](https://kubernetes.io/) [Prometheus,]\", \"(https://prometheus.io/) [Helm,](https://helm.sh/) [Envoy,](https://www.envoyproxy.io/) and [gRPC.](\", \"https://grpc.io/)\\n\\nThe CNCF fosters an ecosystem of open-source and vendor-neutrality. Following tha\", \"t lead, this book presents cloud-native principles, patterns, and best practices that are technology\", \" agnostic. At the same time, we discuss the services and infrastructure available in the Microsoft A\", \"zure cloud for constructing cloud-native systems.\\n\\n<span id=\\\"page-13-0\\\"></span>So, what exactly is C\", \"loud Native? Sit back, relax, and let us help you explore this new world.\\n\\n# What is Cloud Native?\\n\\n\", \"Stop what you're doing and ask your colleagues to define the term \\\"Cloud Native\\\". There's a good cha\", \"nce you'll get several different answers.\\n\\nLet's start with a simple definition:\\n\\n*Cloud-native arch\", \"itecture and technologies are an approach to designing, constructing, and operating workloads that a\", \"re built in the cloud and take full advantage of the cloud computing model.*\\n\\nThe [Cloud Native Comp\", \"uting Foundation](https://www.cncf.io/) provides the [official definition:](https://github.com/cncf/\", \"toc/blob/main/DEFINITION.md)\\n\\n*Cloud-native technologies empower organizations to build and run scal\", \"able applications in modern, dynamic environments such as public, private, and hybrid clouds. Contai\", \"ners, service meshes, microservices, immutable infrastructure, and declarative APIs exemplify this a\", \"pproach.*\\n\\n*These techniques enable loosely coupled systems that are resilient, manageable, and obse\", \"rvable. Combined with robust automation, they allow engineers to make high-impact changes frequently\", \" and predictably with minimal toil.*\\n\\nCloud native is about *speed* and *agility*. Business systems \", \"are evolving from enabling business capabilities to weapons of strategic transformation that acceler\", \"ate business velocity and growth. It's imperative to get new ideas to market immediately.\\n\\nAt the sa\", \"me time, business systems have also become increasingly complex with users demanding more. They expe\", \"ct rapid responsiveness, innovative features, and zero downtime. Performance problems, recurring err\", \"ors, and the inability to move fast are no longer acceptable. Your users will visit your competitor.\", \" Cloud-native systems are designed to embrace rapid change, large scale, and resilience.\\n\\nHere are s\", \"ome companies who have implemented cloud-native techniques. Think about the speed, agility, and scal\", \"ability they've achieved.\\n\\n| Company | Experience                                                   \", \"                   |\\n|---------|--------------------------------------------------------------------\", \"-------------|\\n| Netflix | Has 600+ services in production. Deploys 100<br>times per day.           \", \"       |\\n| Uber    | Has 1,000+ services in production. Deploys<br>several thousand times each week.\", \" |\\n\\n| Company | Experience                                 |\\n|---------|----------------------------\", \"----------------|\\n| WeChat  | Has 3,000+ services in production. Deploys |\\n|         | 1,000 times a\", \" day.                         |\\n\\nAs you can see, Netflix, Uber, and, WeChat expose cloud-native syst\", \"ems that consist of many independent services. This architectural style enables them to rapidly resp\", \"ond to market conditions. They instantaneously update small areas of a live, complex application, wi\", \"thout a full redeployment. They individually scale services as needed.\\n\\n#### <span id=\\\"page-14-0\\\"></\", \"span>**The pillars of cloud native**\\n\\nThe speed and agility of cloud native derive from many factors\", \". Foremost is *cloud infrastructure*. But there's more: Five other foundational pillars shown in Fig\", \"ure 1-3 also provide the bedrock for cloudnative systems.\\n\\n![](_page_14_Picture_4.jpeg)\\n\\n*Figure 1-3\", \". Cloud-native foundational pillars*\\n\\nLet's take some time to better understand the significance of \", \"each pillar.\\n\\n#### <span id=\\\"page-14-1\\\"></span>**The cloud**\\n\\nCloud-native systems take full advanta\", \"ge of the cloud service model.\\n\\nDesigned to thrive in a dynamic, virtualized cloud environment, thes\", \"e systems make extensive use of [Platform as a Service \\\\(PaaS\\\\)](https://azure.microsoft.com/overvie\", \"w/what-is-paas/) compute infrastructure and managed services. They treat the underlying infrastructu\", \"re as *disposable* - provisioned in minutes and resized, scaled, or destroyed on demand \\u2013 via automa\", \"tion.\\n\\nConsider the widely accepted DevOps concept of [Pets vs.](https://medium.com/@Joachim8675309/\", \"devops-concepts-pets-vs-cattle-2380b5aab313) Cattle. In a traditional data center, servers are treat\", \"ed as *Pets*: a physical machine, given a meaningful name, and *cared* for. You scale by adding more\", \" resources to the same machine (scaling up). If the server becomes sick, you nurse it back to health\", \". Should the server become unavailable, everyone notices.\\n\\nThe *Cattle* service model is different. \", \"You provision each instance as a virtual machine or container. They're identical and assigned a syst\", \"em identifier such as Service-01, Service-02, and so on. You scale by creating more of them (scaling\", \" out). When one becomes unavailable, nobody notices.\\n\\nThe cattle model embraces *immutable infrastru\", \"cture*. Servers aren't repaired or modified. If one fails or requires updating, it's destroyed and a\", \" new one is provisioned \\u2013 all done via automation.\\n\\nCloud-native systems embrace the Cattle service \", \"model. They continue to run as the infrastructure scales in or out with no regard to the machines up\", \"on which they're running.\\n\\nThe Azure cloud platform supports this type of highly elastic infrastruct\", \"ure with automatic scaling, self-healing, and monitoring capabilities.\\n\\n#### <span id=\\\"page-15-0\\\"></\", \"span>**Modern design**\\n\\nHow would you design a cloud-native app? What would your architecture look l\", \"ike? To what principles, patterns, and best practices would you adhere? What infrastructure and oper\", \"ational concerns would be important?\\n\\n#### **The Twelve-Factor Application**\\n\\nA widely accepted meth\", \"odology for constructing cloud-based applications is the [Twelve-Factor](https://12factor.net/)  [Ap\", \"plication.](https://12factor.net/) It describes a set of principles and practices that developers fo\", \"llow to construct applications optimized for modern cloud environments. Special attention is given t\", \"o portability across environments and declarative automation.\\n\\nWhile applicable to any web-based app\", \"lication, many practitioners consider Twelve-Factor a solid foundation for building cloud-native app\", \"s. Systems built upon these principles can deploy and scale rapidly and add features to react quickl\", \"y to market changes.\\n\\nThe following table highlights the Twelve-Factor methodology:\\n\\n| Factor       \", \"           | Explanation                                                                            \", \"                                                                                                    \", \"                                                           |\\n|-------------------------|------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"-----------------------------------|\\n| 1 -<br>Code Base        | A single code base for each microse\", \"rvice, stored<br>in its own repository. Tracked with version<br>control, it can deploy to multiple e\", \"nvironments<br>(QA, Staging, Production).                                                           \", \"           |\\n| 2 -<br>Dependencies     | Each microservice isolates and packages its own<br>dependen\", \"cies, embracing changes without<br>impacting the entire system.                                     \", \"                                                                                       |\\n| 3 -<br>Co\", \"nfigurations   | Configuration information is moved out of the<br>microservice and externalized thro\", \"ugh a<br>configuration management tool outside of the<br>code. The same deployment can propagate<br>\", \"across environments with the correct<br>configuration applied. |\\n| 4 -<br>Backing Services | Ancilla\", \"ry resources (data stores, caches,<br>message brokers) should be exposed via an<br>addressable URL. \", \"Doing so decouples the<br>resource from the application, enabling it to be<br>interchangeable.      \", \"                                       |\\n\\n| Factor                     | Explanation                \", \"                                                                                                    \", \"                                                                                                    \", \"                                                                                  |\\n|---------------\", \"-------------|--------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"------------------------|\\n| 5 -<br>Build, Release, Run | Each release must enforce a strict separati\", \"on<br>across the build, release, and run stages. Each<br>should be tagged with a unique ID and suppo\", \"rt<br>the ability to roll back. Modern CI/CD systems<br>help fulfill this principle.                \", \"                                                                  |\\n| 6 -<br>Processes           | E\", \"ach microservice should execute in its own<br>process, isolated from other running services.<br>Exte\", \"rnalize required state to a backing service<br>such as a distributed cache or data store.           \", \"                                                                                                    \", \"        |\\n| 7 -<br>Port Binding        | Each microservice should be self-contained with<br>its inte\", \"rfaces and functionality exposed on its<br>own port. Doing so provides isolation from<br>other micro\", \"services.                                                                                           \", \"                                                  |\\n| 8 -<br>Concurrency         | When capacity nee\", \"ds to increase, scale out<br>services horizontally across multiple identical<br>processes (copies) a\", \"s opposed to scaling-up a<br>single large instance on the most powerful<br>machine available. Develo\", \"p the application to be<br>concurrent making scaling out in cloud<br>environments seamless. |\\n| 9 -<\", \"br>Disposability       | Service instances should be disposable. Favor<br>fast startup to increase s\", \"calability opportunities<br>and graceful shutdowns to leave the system in a<br>correct state. Docker\", \" containers along with an<br>orchestrator inherently satisfy this requirement.                      \", \"                                  |\\n| 10 -<br>Dev/Prod Parity    | Keep environments across the appl\", \"ication<br>lifecycle as similar as possible, avoiding costly<br>shortcuts. Here, the adoption of con\", \"tainers can<br>greatly contribute by promoting the same<br>execution environment.                   \", \"                                                                            |\\n| 11 -<br>Logging     \", \"       | Treat logs generated by microservices as event<br>streams. Process them with an event<br>ag\", \"gregator. Propagate log data to data<br>mining/log management tools like Azure<br>Monitor or Splunk \", \"and eventually to long-term<br>archival.                                                            \", \"                  |\\n| 12 -<br>Admin Processes    | Run administrative/management tasks, such as<br>d\", \"ata cleanup or computing analytics, as one-off<br>processes. Use independent tools to invoke<br>thes\", \"e tasks from the production environment,<br>but separately from the application.                    \", \"                                                            |\\n\\nIn the book, [Beyond the Twelve-Facto\", \"r App,](https://content.pivotal.io/blog/beyond-the-twelve-factor-app) author Kevin Hoffman details e\", \"ach of the original 12 factors (written in 2011). Additionally, he discusses three extra factors tha\", \"t reflect today's modern cloud application design.\\n\\n| New Factor                            | Explan\", \"ation                                                                                               \", \"                                                                                                    \", \"                |\\n|---------------------------------------|-----------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------|\\n| 13 -<br>API Fi\", \"rst                     | Make everything a service. Assume your code<br>will be consumed by a front\", \"-end client, gateway,<br>or another service.                                                        \", \"                                                |\\n| 14 -<br>Telemetry                     | On a wor\", \"kstation, you have deep visibility into<br>your application and its behavior. In the cloud,<br>you d\", \"on't. Make sure your design includes the<br>collection of monitoring, domain-specific, and<br>health\", \"/system data. |\\n| 15 -<br>Authentication/ Authorization | Implement identity from the start. Conside\", \"r<br>RBAC (role-based access control)<br>features<br>available in public clouds.                    \", \"                                                                                |\\n\\nWe'll refer to ma\", \"ny of the 12+ factors in this chapter and throughout the book.\\n\\n#### **Azure Well-Architected Framew\", \"ork**\\n\\nDesigning and deploying cloud-based workloads can be challenging, especially when implementin\", \"g cloud-native architecture. Microsoft provides industry standard best practices to help you and you\", \"r team deliver robust cloud solutions.\\n\\nThe [Microsoft Well-Architected Framework](https://docs.micr\", \"osoft.com/azure/architecture/framework/) provides a set of guiding tenets that can be used to improv\", \"e the quality of a cloud-native workload. The framework consists of five pillars of architecture exc\", \"ellence:\\n\\n| Tenets                 | Description                                                    \", \"                                                                                                    \", \"                                                                                                    \", \"                   |\\n|------------------------|-----------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"------------------------------|\\n| Cost management        | Focus on generating incremental value ear\", \"ly.<br>Apply Build-Measure-Learn<br>principles to<br>accelerate time to market while avoiding<br>cap\", \"ital-intensive solutions. Using a pay-as-you<br>go strategy, invest as you scale out, rather than<br\", \">delivering a large investment up front. |\\n| Operational excellence | Automate the environment and o\", \"perations to<br>increase speed and reduce human error. Roll<br>problem updates back or forward quick\", \"ly.<br>Implement monitoring and diagnostics from the<br>start.                                      \", \"                                                    |\\n| Performance efficiency | Efficiently meet de\", \"mands placed on your<br>workloads. Favor horizontal scaling (scaling out)<br>and design it into your\", \" systems. Continually<br>conduct performance and load testing to<br>identify potential bottlenecks. \", \"                                                               |\\n\\n| Tenets      | Description       \", \"                                                                                                    \", \"                                                                                                    \", \"                                                           |\\n|-------------|------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"------------------------------------------------------|\\n| Reliability | Build workloads that are bot\", \"h resilient and<br>available. Resiliency enables workloads to<br>recover from failures and continue \", \"functioning.<br>Availability ensures users access to your<br>workload at all times. Design applicati\", \"ons to<br>expect failures and recover from them. |\\n| Security    | Implement security across the ent\", \"ire lifecycle of<br>an application, from design and implementation<br>to deployment and operations. \", \"Pay close<br>attention to identity management, infrastructure<br>access, application security, and d\", \"ata<br>sovereignty and encryption.          |\\n\\nTo get started, Microsoft provides a set of [online a\", \"ssessments](https://docs.microsoft.com/assessments/?mode=pre-assessment&session=local) to help you a\", \"ssess your current cloud workloads against the five well-architected pillars.\\n\\n#### <span id=\\\"page-1\", \"8-0\\\"></span>**Microservices**\\n\\nCloud-native systems embrace microservices, a popular architectural s\", \"tyle for constructing modern applications.\\n\\nBuilt as a distributed set of small, independent service\", \"s that interact through a shared fabric, microservices share the following characteristics:\\n\\n- Each \", \"implements a specific business capability within a larger domain context.\\n- Each is developed autono\", \"mously and can be deployed independently.\\n- Each is self-contained encapsulating its own data storag\", \"e technology, dependencies, and programming platform.\\n- Each runs in its own process and communicate\", \"s with others using standard communication protocols such as HTTP/HTTPS, gRPC, WebSockets, or [AMQP.\", \"](https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol)\\n- They compose together to form a\", \"n application.\\n\\nFigure 1-4 contrasts a monolithic application approach with a microservices approach\", \". Note how the monolith is composed of a layered architecture, which executes in a single process. I\", \"t typically consumes a relational database. The microservice approach, however, segregates functiona\", \"lity into independent services, each with its own logic, state, and data. Each microservice hosts it\", \"s own datastore.\\n\\n![](_page_19_Picture_0.jpeg)\\n\\n*Figure 1-4. Monolithic versus microservices archite\", \"cture*\\n\\nNote how microservices promote the **Processes** principle from the [Twelve-Factor Applicati\", \"on,](https://12factor.net/)  discussed earlier in the chapter.\\n\\n*Factor #6 specifies \\\"Each microserv\", \"ice should execute in its own process, isolated from other running services.\\\"*\\n\\n#### **Why microserv\", \"ices?**\\n\\nMicroservices provide agility.\\n\\nEarlier in the chapter, we compared an eCommerce applicatio\", \"n built as a monolith to that with microservices. In the example, we saw some clear benefits:\\n\\n- Eac\", \"h microservice has an autonomous lifecycle and can evolve independently and deploy frequently. You d\", \"on't have to wait for a quarterly release to deploy a new feature or update. You can update a small \", \"area of a live application with less risk of disrupting the entire system. The update can be made wi\", \"thout a full redeployment of the application.\\n- Each microservice can scale independently. Instead o\", \"f scaling the entire application as a single unit, you scale out only those services that require mo\", \"re processing power to meet desired performance levels and service-level agreements. Fine-grained sc\", \"aling provides for greater control of your system and helps reduce overall costs as you scale portio\", \"ns of your system, not everything.\\n\\nAn excellent reference guide for understanding microservices is \", \"[.NET Microservices: Architecture for](https://dotnet.microsoft.com/download/thank-you/microservices\", \"-architecture-ebook)  [Containerized .NET Applications](https://dotnet.microsoft.com/download/thank-\", \"you/microservices-architecture-ebook). The book deep dives into microservices design and architectur\", \"e. It's a companion for a [full-stack microservice reference architecture](https://github.com/dotnet\", \"-architecture/eShopOnContainers) available as a free download from Microsoft.\\n\\n#### **Developing mic\", \"roservices**\\n\\nMicroservices can be created upon any modern development platform.\\n\\nThe Microsoft .NET\", \" platform is an excellent choice. Free and open source, it has many built-in features that simplify \", \"microservice development. .NET is cross-platform. Applications can be built and run on Windows, macO\", \"S, and most flavors of Linux.\\n\\n.NET is highly performant and has scored well in comparison to Node.j\", \"s and other competing platforms. Interestingly, [TechEmpower](https://www.techempower.com/) conducte\", \"d an extensive set of [performance benchmarks](https://www.techempower.com/benchmarks/#section=data-\", \"r17&hw=ph&test=plaintext) across many web application platforms and frameworks. .NET scored in the t\", \"op 10 - well above Node.js and other competing platforms.\\n\\n[.NET](https://github.com/dotnet/core) is\", \" maintained by Microsoft and the .NET community on GitHub.\\n\\n#### **Microservice challenges**\\n\\nWhile \", \"distributed cloud-native microservices can provide immense agility and speed, they present many chal\", \"lenges:\\n\\n#### *Communication*\\n\\nHow will front-end client applications communicate with backed-end co\", \"re microservices? Will you allow direct communication? Or, might you abstract the back-end microserv\", \"ices with a gateway facade that provides flexibility, control, and security?\\n\\nHow will back-end core\", \" microservices communicate with each other? Will you allow direct HTTP calls that can increase coupl\", \"ing and impact performance and agility? Or might you consider decoupled messaging with queue and top\", \"ic technologies?\\n\\nCommunication is covered in the [Cloud-native communication patterns](#page-67-0) \", \"chapter.\\n\\n#### *Resiliency*\\n\\nA microservices architecture moves your system from in-process to out-o\", \"f-process network communication. In a distributed architecture, what happens when Service B isn't re\", \"sponding to a network call from Service A? Or, what happens when Service C becomes temporarily unava\", \"ilable and other services calling it become blocked?\\n\\nResiliency is covered in the [Cloud-native res\", \"iliency](#page-122-0) chapter.\\n\\n#### *Distributed Data*\\n\\nBy design, each microservice encapsulates i\", \"ts own data, exposing operations via its public interface. If so, how do you query data or implement\", \" a transaction across multiple services?\\n\\nDistributed data is covered in the [Cloud-native data patt\", \"erns](#page-97-0) chapter.\\n\\n#### *Secrets*\\n\\nHow will your microservices securely store and manage se\", \"crets and sensitive configuration data?\\n\\nSecrets are covered in detail [Cloud-native security.](#pag\", \"e-156-0)\\n\\n#### **Manage Complexity with Dapr**\\n\\n[Dapr](https://dapr.io/) is a distributed, open-sour\", \"ce application runtime. Through an architecture of pluggable components, it dramatically simplifies \", \"the *plumbing* behind distributed applications. It provides a **dynamic glue** that binds your appli\", \"cation with pre-built infrastructure capabilities and components from the Dapr runtime. Figure 1-5 s\", \"hows Dapr from 20,000 feet.\\n\\n![](_page_21_Figure_2.jpeg)\\n\\n*Figure 1-5. Dapr at 20,000 feet.*\\n\\nIn the\", \" top row of the figure, note how Dapr provides [language-specific SDKs](https://docs.dapr.io/develop\", \"ing-applications/sdks/) for popular development platforms. Dapr v1 includes support for .NET, Go, No\", \"de.js, Python, PHP, Java, and JavaScript.\\n\\nWhile language-specific SDKs enhance the developer experi\", \"ence, Dapr is platform agnostic. Under the hood, Dapr's programming model exposes capabilities throu\", \"gh standard HTTP/gRPC communication protocols. Any programming platform can call Dapr via its native\", \" HTTP and gRPC APIs.\\n\\nThe blue boxes across the center of the figure represent the Dapr building blo\", \"cks. Each exposes prebuilt plumbing code for a distributed application capability that your applicat\", \"ion can consume.\\n\\nThe components row represents a large set of pre-defined infrastructure components\", \" that your application can consume. Think of components as infrastructure code you don't have to wri\", \"te.\\n\\nThe bottom row highlights the portability of Dapr and the diverse environments across which it \", \"can run.\\n\\nMicrosoft features a free ebook [Dapr for .NET Developers](https://docs.microsoft.com/dotn\", \"et/architecture/dapr-for-net-developers/) for learning Dapr.\\n\\nLooking ahead, Dapr has the potential \", \"to have a profound impact on cloud-native application development.\\n\\n#### <span id=\\\"page-21-0\\\"></span\", \">**Containers**\\n\\nIt's natural to hear the term *container* mentioned in any *cloud native* conversat\", \"ion. In the book, [Cloud](https://www.manning.com/books/cloud-native-patterns)  [Native Patterns](ht\", \"tps://www.manning.com/books/cloud-native-patterns), author Cornelia Davis observes that, \\\"Containers\", \" are a great enabler of cloud-native\\n\\nsoftware.\\\" The Cloud Native Computing Foundation places micros\", \"ervice containerization as the first step in their [Cloud-Native Trail Map](https://raw.githubuserco\", \"ntent.com/cncf/trailmap/master/CNCF_TrailMap_latest.png) - guidance for enterprises beginning their \", \"cloud-native journey.\\n\\nContainerizing a microservice is simple and straightforward. The code, its de\", \"pendencies, and runtime are packaged into a binary called a [container image.](https://docs.docker.c\", \"om/glossary/?term=image) Images are stored in a container registry, which acts as a repository or li\", \"brary for images. A registry can be located on your development computer, in your data center, or in\", \" a public cloud. Docker itself maintains a public registry via [Docker Hub.](https://hub.docker.com/\", \") The Azure cloud features a private [container registry](https://azure.microsoft.com/services/conta\", \"iner-registry/) to store container images close to the cloud applications that will run them.\\n\\nWhen \", \"an application starts or scales, you transform the container image into a running container instance\", \". The instance runs on any computer that has a [container runtime](https://kubernetes.io/docs/setup/\", \"production-environment/container-runtimes/) engine installed. You can have as many instances of the \", \"containerized service as needed.\\n\\nFigure 1-6 shows three different microservices, each in its own co\", \"ntainer, all running on a single host.\\n\\n![](_page_22_Figure_4.jpeg)\\n\\n*Figure 1-6. Multiple container\", \"s running on a container host*\\n\\nNote how each container maintains its own set of dependencies and ru\", \"ntime, which can be different from one another. Here, we see different versions of the Product micro\", \"service running on the same host. Each container shares a slice of the underlying host operating sys\", \"tem, memory, and processor, but is isolated from one another.\\n\\nNote how well the container model emb\", \"races the **Dependencies** principle from the [Twelve-Factor](https://12factor.net/)  [Application.]\", \"(https://12factor.net/)\\n\\n*Factor #2 specifies that \\\"Each microservice isolates and packages its own \", \"dependencies, embracing changes without impacting the entire system.\\\"*\\n\\nContainers support both Linu\", \"x and Windows workloads. The Azure cloud openly embraces both. Interestingly, it's Linux, not Window\", \"s Server, that has become the more popular operating system in Azure.\\n\\nWhile several container vendo\", \"rs exist, [Docker](https://www.docker.com/) has captured the lion's share of the market. The company\", \" has been driving the software container movement. It has become the de facto standard for packaging\", \", deploying, and running cloud-native applications.\\n\\n#### **Why containers?**\\n\\nContainers provide po\", \"rtability and guarantee consistency across environments. By encapsulating everything into a single p\", \"ackage, you *isolate* the microservice and its dependencies from the underlying infrastructure.\\n\\nYou\", \" can deploy the container in any environment that hosts the Docker runtime engine. Containerized wor\", \"kloads also eliminate the expense of pre-configuring each environment with frameworks, software libr\", \"aries, and runtime engines.\\n\\nBy sharing the underlying operating system and host resources, a contai\", \"ner has a much smaller footprint than a full virtual machine. The smaller size increases the *densit\", \"y*, or number of microservices, that a given host can run at one time.\\n\\n#### **Container orchestrati\", \"on**\\n\\nWhile tools such as Docker create images and run containers, you also need tools to manage the\", \"m. Container management is done with a special software program called a **container orchestrator**.\", \" When operating at scale with many independent running containers, orchestration is essential.\\n\\nFigu\", \"re 1-7 shows management tasks that container orchestrators automate.\\n\\n![](_page_23_Picture_8.jpeg)\\n\\n\", \"*Figure 1-7. What container orchestrators do*\\n\\nThe following table describes common orchestration ta\", \"sks.\\n\\n| Tasks                  | Explanation                                                        \", \"                                   |\\n|------------------------|-------------------------------------\", \"------------------------------------------------------------------|\\n| Scheduling             | Autom\", \"atically provision container instances.                                                          |\\n|\", \" Affinity/anti-affinity | Provision containers nearby or far apart from<br>each other, helping avail\", \"ability and<br>performance. |\\n| Health monitoring      | Automatically detect and correct failures. \", \"                                                           |\\n| Failover               | Automaticall\", \"y reprovision a failed instance to a<br>healthy machine.                                  |\\n\\n| Tasks\", \"             | Explanation                                                                          \", \"                             |\\n|-------------------|------------------------------------------------\", \"-------------------------------------------------------------------|\\n| Scaling           | Automatic\", \"ally add or remove a container<br>instance to meet demand.                                          \", \"     |\\n| Networking        | Manage a networking overlay for container<br>communication.            \", \"                                           |\\n| Service Discovery | Enable containers to locate each \", \"other.                                                                           |\\n| Rolling Upgrade\", \"s  | Coordinate incremental upgrades with zero<br>downtime deployment. Automatically roll back<br>pr\", \"oblematic changes. |\\n\\nNote how container orchestrators embrace the **Disposability** and **Concurren\", \"cy** principles from the [Twelve-Factor Application.](https://12factor.net/)\\n\\n*Factor #9 specifies t\", \"hat \\\"Service instances should be disposable, favoring fast startups to increase scalability opportun\", \"ities and graceful shutdowns to leave the system in a correct state.\\\"* Docker containers along with \", \"an orchestrator inherently satisfy this requirement.\\\"\\n\\n*Factor #8 specifies that \\\"Services scale out\", \" across a large number of small identical processes (copies) as opposed to scaling-up a single large\", \" instance on the most powerful machine available.\\\"*\\n\\nWhile several container orchestrators exist, [K\", \"ubernetes](https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/) has become the de facto\", \" standard for the cloud-native world. It's a portable, extensible, open-source platform for managing\", \" containerized workloads.\\n\\nYou could host your own instance of Kubernetes, but then you'd be respons\", \"ible for provisioning and managing its resources - which can be complex. The Azure cloud features Ku\", \"bernetes as a managed service. Both [Azure Kubernetes Service \\\\(AKS\\\\)](https://azure.microsoft.com/s\", \"ervices/kubernetes-service/) and [Azure Red Hat OpenShift \\\\(ARO\\\\)](https://azure.microsoft.com/servi\", \"ces/openshift/) enable you to fully leverage the features and power of Kubernetes as a managed servi\", \"ce, without having to install and maintain it.\\n\\nContainer orchestration is covered in detail in [Sca\", \"ling Cloud-Native Applications.](#page-45-0)\\n\\n#### <span id=\\\"page-24-0\\\"></span>**Backing services**\\n\", \"\\nCloud-native systems depend upon many different ancillary resources, such as data stores, message b\", \"rokers, monitoring, and identity services. These services are known as [backing services.](https://1\", \"2factor.net/backing-services)\\n\\nFigure 1-8 shows many common backing services that cloud-native syste\", \"ms consume.\\n\\n![](_page_25_Picture_0.jpeg)\\n\\n*Figure 1-8. Common backing services*\\n\\nYou could host you\", \"r own backing services, but then you'd be responsible for licensing, provisioning, and managing thos\", \"e resources.\\n\\nCloud providers offer a rich assortment of *managed backing services.* Instead of owni\", \"ng the service, you simply consume it. The cloud provider operates the resource at scale and bears t\", \"he responsibility for performance, security, and maintenance. Monitoring, redundancy, and availabili\", \"ty are built into the service. Providers guarantee service level performance and fully support their\", \" managed services open a ticket and they fix your issue.\\n\\nCloud-native systems favor managed backing\", \" services from cloud vendors. The savings in time and labor can be significant. The operational risk\", \" of hosting your own and experiencing trouble can get expensive fast.\\n\\nA best practice is to treat a\", \" backing service as an **attached resource**, dynamically bound to a microservice with configuration\", \" information (a URL and credentials) stored in an external configuration. This guidance is spelled o\", \"ut in the [Twelve-Factor Application,](https://12factor.net/) discussed earlier in the chapter.\\n\\n*Fa\", \"ctor #4* specifies that backing services \\\"should be exposed via an addressable URL. Doing so decoupl\", \"es the resource from the application, enabling it to be interchangeable.\\\"\\n\\n*Factor #3* specifies tha\", \"t \\\"Configuration information is moved out of the microservice and externalized through a configurati\", \"on management tool outside of the code.\\\"\\n\\nWith this pattern, a backing service can be attached and d\", \"etached without code changes. You might promote a microservice from QA to a staging environment. You\", \" update the microservice configuration to point to the backing services in staging and inject the se\", \"ttings into your container through an environment variable.\\n\\nCloud vendors provide APIs for you to c\", \"ommunicate with their proprietary backing services. These libraries encapsulate the proprietary plum\", \"bing and complexity. However, communicating directly with these APIs will tightly couple your code t\", \"o that specific backing service. It's a widely accepted practice to insulate the implementation deta\", \"ils of the vendor API. Introduce an intermediation layer, or intermediate API, exposing generic oper\", \"ations to your service code and wrap the vendor code inside it. This loose coupling enables you to s\", \"wap out one backing service for another or move your code to a different cloud environment without h\", \"aving to make changes to the mainline service code. Dapr, discussed earlier, follows this model with\", \" its set of [prebuilt building blocks.](https://docs.dapr.io/developing-applications/building-blocks\", \"/)\\n\\nOn a final thought, backing services also promote the **Statelessness** principle from the [Twel\", \"ve-Factor](https://12factor.net/)  [Application,](https://12factor.net/) discussed earlier in the ch\", \"apter.\\n\\n*Factor #6* specifies that, \\\"Each microservice should execute in its own process, isolated f\", \"rom other running services. Externalize required state to a backing service such as a distributed ca\", \"che or data store.\\\"\\n\\nBacking services are discussed in [Cloud-native data patterns](#page-97-0) and \", \"[Cloud-native communication](#page-67-0)  [patterns.](#page-67-0)\\n\\n#### <span id=\\\"page-26-0\\\"></span>\", \"**Automation**\\n\\nAs you've seen, cloud-native systems embrace microservices, containers, and modern s\", \"ystem design to achieve speed and agility. But, that's only part of the story. How do you provision \", \"the cloud environments upon which these systems run? How do you rapidly deploy app features and upda\", \"tes? How do you round out the full picture?\\n\\nEnter the widely accepted practice of [Infrastructure a\", \"s Code,](https://docs.microsoft.com/devops/deliver/what-is-infrastructure-as-code) or IaC.\\n\\nWith IaC\", \", you automate platform provisioning and application deployment. You essentially apply software engi\", \"neering practices such as testing and versioning to your DevOps practices. Your infrastructure and d\", \"eployments are automated, consistent, and repeatable.\\n\\n#### **Automating infrastructure**\\n\\nTools lik\", \"e [Azure Resource Manager,](https://docs.microsoft.com/azure/azure-resource-manager/management/overv\", \"iew) [Azure Bicep,](https://docs.microsoft.com/azure/azure-resource-manager/bicep/overview) [Terrafo\", \"rm](https://www.terraform.io/) from HashiCorp, and the [Azure CLI,](https://docs.microsoft.com/cli/a\", \"zure/) enable you to declaratively script the cloud infrastructure you require. Resource names, loca\", \"tions, capacities, and secrets are parameterized and dynamic. The script is versioned and checked in\", \"to source control as an artifact of your project. You invoke the script to provision a consistent an\", \"d repeatable infrastructure across system environments, such as QA, staging, and production.\\n\\nUnder \", \"the hood, IaC is idempotent, meaning that you can run the same script over and over without side eff\", \"ects. If the team needs to make a change, they edit and rerun the script. Only the updated resources\", \" are affected.\\n\\nIn the article, [What is Infrastructure as Code](https://docs.microsoft.com/devops/d\", \"eliver/what-is-infrastructure-as-code), Author Sam Guckenheimer describes how, \\\"Teams who implement \", \"IaC can deliver stable environments rapidly and at scale. They avoid manual configuration of environ\", \"ments and enforce consistency by representing the desired state of their environments via code. Infr\", \"astructure deployments with IaC are repeatable and prevent runtime issues caused by configuration dr\", \"ift or missing dependencies. DevOps teams can work together with a unified set of\\n\\npractices and too\", \"ls to deliver applications and their supporting infrastructure rapidly, reliably, and at scale.\\\"\\n\\n##\", \"## **Automating deployments**\\n\\nThe [Twelve-Factor Application,](https://12factor.net/) discussed ear\", \"lier, calls for separate steps when transforming completed code into a running application.\\n\\n*Factor\", \" #5* specifies that \\\"Each release must enforce a strict separation across the build, release and run\", \" stages. Each should be tagged with a unique ID and support the ability to roll back.\\\"\\n\\nModern CI/CD\", \" systems help fulfill this principle. They provide separate build and delivery steps that help ensur\", \"e consistent and quality code that's readily available to users.\\n\\nFigure 1-9 shows the separation ac\", \"ross the deployment process.\\n\\n![](_page_27_Picture_6.jpeg)\\n\\n*Figure 1-9. Deployment steps in a CI/CD\", \" Pipeline*\\n\\nIn the previous figure, pay special attention to separation of tasks:\\n\\n- 1. The develope\", \"r constructs a feature in their development environment, iterating through what is called the \\\"inner\", \" loop\\\" of code, run, and debug.\\n- 2. When complete, that code is *pushed* into a code repository, su\", \"ch as GitHub, Azure DevOps, or BitBucket.\\n- 3. The push triggers a build stage that transforms the c\", \"ode into a binary artifact. The work is implemented with a [Continuous Integration \\\\(CI\\\\)](https://m\", \"artinfowler.com/articles/continuousIntegration.html) pipeline. It automatically builds, tests, and p\", \"ackages the application.\\n- 4. The release stage picks up the binary artifact, applies external appli\", \"cation and environment configuration information, and produces an immutable release. The release is \", \"deployed to a specified environment. The work is implemented with a [Continuous Delivery \\\\(CD\\\\)](htt\", \"ps://martinfowler.com/bliki/ContinuousDelivery.html) pipeline. Each release should be identifiable. \", \"You can say, \\\"This deployment is running Release 2.1.1 of the application.\\\"\\n\\n5. Finally, the release\", \"d feature is run in the target execution environment. Releases are immutable meaning that any change\", \" must create a new release.\\n\\nApplying these practices, organizations have radically evolved how they\", \" ship software. Many have moved from quarterly releases to on-demand updates. The goal is to catch p\", \"roblems early in the development cycle when they're less expensive to fix. The longer the duration b\", \"etween integrations, the more expensive problems become to resolve. With consistency in the integrat\", \"ion process, teams can commit code changes more frequently, leading to better collaboration and soft\", \"ware quality.\\n\\nInfrastructure as code and deployment automation, along with GitHub and Azure DevOps \", \"are discussed in detail in [DevOps.](#page-170-0)\\n\\n# <span id=\\\"page-28-0\\\"></span>Candidate apps for \", \"cloud native\\n\\nThink about the apps your organization needs to build. Then, look at the existing apps\", \" in your portfolio. How many of them warrant a cloud-native architecture? All of them? Perhaps some?\", \"\\n\\nApplying cost/benefit analysis, there's a good chance some wouldn't support the effort. The cost o\", \"f becoming cloud native would far exceed the business value of the application.\\n\\nWhat type of applic\", \"ation might be a candidate for cloud native?\\n\\n- Strategic enterprise systems that need to constantly\", \" evolve business capabilities/features\\n- An application that requires a high release velocity with h\", \"igh confidence\\n- A system where individual features must release *without* a full redeployment of th\", \"e entire system\\n- An application developed by teams with expertise in different technology stacks\\n- \", \"An application with components that must scale independently\\n\\nSmaller, less impactful line-of-busine\", \"ss applications might fare well with a simple monolithic architecture hosted in a Cloud PaaS environ\", \"ment.\\n\\nThen there are legacy systems. While we'd all like to build new applications, we're often res\", \"ponsible for modernizing legacy workloads that are critical to the business.\\n\\n#### <span id=\\\"page-28\", \"-1\\\"></span>**Modernizing legacy apps**\\n\\nThe free Microsoft e-book [Modernize existing .NET applicati\", \"ons with Azure cloud and Windows](https://dotnet.microsoft.com/download/thank-you/modernizing-existi\", \"ng-net-apps-ebook)  [Containers](https://dotnet.microsoft.com/download/thank-you/modernizing-existin\", \"g-net-apps-ebook) provides guidance about migrating on-premises workloads into cloud. Figure 1-10 sh\", \"ows that there isn't a single, one-size-fits-all strategy for modernizing legacy applications.\\n\\n![](\", \"_page_29_Figure_1.jpeg)\\n\\n*Figure 1-10. Strategies for migrating legacy workloads*\\n\\nMonolithic apps t\", \"hat are non-critical might benefit from a quick **lift-and-shift** [\\\\(Cloud Infrastructure-](https:/\", \"/docs.microsoft.com/dotnet/architecture/modernize-with-azure-containers/lift-and-shift-existing-apps\", \"-azure-iaas)[Ready\\\\)](https://docs.microsoft.com/dotnet/architecture/modernize-with-azure-containers\", \"/lift-and-shift-existing-apps-azure-iaas) migration. Here, the on-premises workload is rehosted to a\", \" cloud-based VM, without changes. This approach uses the [IaaS \\\\(Infrastructure as a Service\\\\) model\", \".](https://azure.microsoft.com/overview/what-is-iaas/) Azure includes several tools such as [Azure M\", \"igrate,](https://azure.microsoft.com/services/azure-migrate/) [Azure Site Recovery,](https://azure.m\", \"icrosoft.com/services/site-recovery/) and [Azure Database Migration Service](https://azure.microsoft\", \".com/campaigns/database-migration/) to help streamline the move. While this strategy can yield some \", \"cost savings, such applications typically weren't designed to unlock and leverage the benefits of cl\", \"oud computing.\\n\\nLegacy apps that are critical to the business often benefit from an enhanced **Cloud\", \" Optimized** migration. This approach includes deployment optimizations that enable key cloud servic\", \"es - without changing the core architecture of the application. For example, you might [containerize\", \"](https://docs.microsoft.com/virtualization/windowscontainers/about/) the application and deploy it \", \"to a container orchestrator, like [Azure Kubernetes Services,](https://azure.microsoft.com/services/\", \"kubernetes-service/) discussed later in this book. Once in the cloud, the application can consume cl\", \"oud backing services such as databases, message queues, monitoring, and distributed caching.\\n\\nFinall\", \"y, monolithic apps that provide strategic enterprise functions might best benefit from a *Cloud-Nati\", \"ve* approach, the subject of this book. This approach provides agility and velocity. But, it comes a\", \"t a cost of replatforming, rearchitecting, and rewriting code. Over time, a legacy application could\", \" be decomposed into microservices, containerized, and ultimately *replatformed* into a cloud-native \", \"architecture.\\n\\nIf you and your team believe a cloud-native approach is appropriate, it behooves you \", \"to rationalize the decision with your organization. What exactly is the business problem that a clou\", \"d-native approach will solve? How would it align with business needs?\\n\\n- Rapid releases of features \", \"with increased confidence?\\n- Fine-grained scalability more efficient usage of resources?\\n\\n- Improved\", \" system resiliency?\\n- Improved system performance?\\n- More visibility into operations?\\n- Blend develo\", \"pment platforms and data stores to arrive at the best tool for the job?\\n- Future-proof application i\", \"nvestment?\\n\\nThe right migration strategy depends on organizational priorities and the systems you're\", \" targeting. For many, it may be more cost effective to cloud-optimize a monolithic application or ad\", \"d coarsegrained services to an N-Tier app. In these cases, you can still make full use of cloud PaaS\", \" capabilities like the ones offered by Azure App Service.\\n\\n#### <span id=\\\"page-30-0\\\"></span>**Summar\", \"y**\\n\\nIn this chapter, we introduced cloud-native computing. We provided a definition along with the \", \"key capabilities that drive a cloud-native application. We looked at the types of applications that \", \"might justify this investment and effort.\\n\\nWith the introduction behind, we now dive into a much mor\", \"e detailed look at cloud native.\\n\\n#### **References**\\n\\n- [Cloud Native Computing Foundation](https:/\", \"/www.cncf.io/)\\n- [.NET Microservices: Architecture for Containerized .NET applications](https://dotn\", \"et.microsoft.com/download/thank-you/microservices-architecture-ebook)\\n- [Microsoft Azure Well-Archit\", \"ected Framework](https://docs.microsoft.com/azure/architecture/framework/)\\n- [Modernize existing .NE\", \"T applications with Azure cloud and Windows Containers](https://dotnet.microsoft.com/download/thank-\", \"you/modernizing-existing-net-apps-ebook)\\n- [Cloud Native Patterns by Cornelia Davis](https://www.man\", \"ning.com/books/cloud-native-patterns)\\n- [Cloud native applications: Ship faster, reduce risk, and gr\", \"ow your business](https://tanzu.vmware.com/cloud-native)\\n- [Dapr for .NET Developers](https://docs.m\", \"icrosoft.com/dotnet/architecture/dapr-for-net-developers/)\\n- [Dapr documents](https://dapr.io/)\\n- [B\", \"eyond the Twelve-Factor Application](https://content.pivotal.io/blog/beyond-the-twelve-factor-app)\\n-\", \" [What is Infrastructure as Code](https://docs.microsoft.com/devops/deliver/what-is-infrastructure-a\", \"s-code)\\n- [Uber Engineering's Micro Deploy: Deploying Daily with Confidence](https://www.uber.com/bl\", \"og/micro-deploy-code/)\\n- [How Netflix Deploys Code](https://www.infoq.com/news/2013/06/netflix/)\\n- [\", \"Overload Control for Scaling WeChat Microservices](https://www.cs.columbia.edu/~ruigu/papers/socc18-\", \"final100.pdf)\\n\\n# <span id=\\\"page-31-0\\\"></span>Introducing eShopOnContainers reference app\\n\\nMicrosoft,\", \" in partnership with leading community experts, has produced a full-featured cloud-native microservi\", \"ces reference application, eShopOnContainers. This application is built to showcase using .NET and D\", \"ocker, and optionally Azure, Kubernetes, and Visual Studio, to build an online storefront.\\n\\n![](_pag\", \"e_31_Figure_3.jpeg)\\n\\n*Figure 2-1. eShopOnContainers Sample App Screenshot.*\\n\\nBefore starting this ch\", \"apter, we recommend that you download the [eShopOnContainers reference](https://github.com/dotnet-ar\", \"chitecture/eShopOnContainers)  [application.](https://github.com/dotnet-architecture/eShopOnContaine\", \"rs) If you do so, it should be easier for you to follow along with the information presented.\\n\\n# <sp\", \"an id=\\\"page-32-0\\\"></span>Features and requirements\\n\\nLet's start with a review of the application's f\", \"eatures and requirements. The eShopOnContainers application represents an online store that sells va\", \"rious physical products like t-shirts and coffee mugs. If you've bought anything online before, the \", \"experience of using the store should be relatively familiar. Here are some of the basic features the\", \" store implements:\\n\\n- List catalog items\\n- Filter items by type\\n- Filter items by brand\\n- Add items \", \"to the shopping basket\\n- Edit or remove items from the basket\\n- Checkout\\n- Register an account\\n- Sig\", \"n in\\n- Sign out\\n- Review orders\\n\\nThe application also has the following non-functional requirements:\", \"\\n\\n- It needs to be highly available and it must scale automatically to meet increased traffic (and s\", \"cale back down once traffic subsides).\\n- It should provide easy-to-use monitoring of its health and \", \"diagnostic logs to help troubleshoot any issues it encounters.\\n- It should support an agile developm\", \"ent process, including support for continuous integration and deployment (CI/CD).\\n- In addition to t\", \"he two web front ends (traditional and Single Page Application), the application must also support m\", \"obile client apps running different kinds of operating systems.\\n- It should support cross-platform h\", \"osting and cross-platform development.\\n\\n![](_page_33_Figure_2.jpeg)\\n\\n*Figure 2-2. eShopOnContainers \", \"reference application development architecture.*\\n\\nThe eShopOnContainers application is accessible fr\", \"om web or mobile clients that access the application over HTTPS targeting either the ASP.NET Core MV\", \"C server application or an appropriate API Gateway. API Gateways offer several advantages, such as d\", \"ecoupling back-end services from individual front-end clients and providing better security. The app\", \"lication also makes use of a related pattern known as Backends-for-Frontends (BFF), which recommends\", \" creating separate API gateways for each front-end client. The reference architecture demonstrates b\", \"reaking up the API gateways based on whether the request is coming from a web or mobile client.\\n\\nThe\", \" application's functionality is broken up into many distinct microservices. There are services respo\", \"nsible for authentication and identity, listing items from the product catalog, managing users' shop\", \"ping baskets, and placing orders. Each of these separate services has its own persistent storage. Th\", \"ere's no single primary data store with which all services interact. Instead, coordination and commu\", \"nication between the services is done on an as-needed basis and by using a message bus.\\n\\nEach of the\", \" different microservices is designed differently, based on their individual requirements. This aspec\", \"t means their technology stack may differ, although they're all built using .NET and designed for th\", \"e cloud. Simpler services provide basic Create-Read-Update-Delete (CRUD) access to the underlying da\", \"ta stores, while more advanced services use Domain-Driven Design approaches and patterns to manage b\", \"usiness complexity.\\n\\n![](_page_34_Figure_1.jpeg)\\n\\n*Figure 2-3. Different kinds of microservices.*\\n\\n#\", \" <span id=\\\"page-34-0\\\"></span>Overview of the code\\n\\nBecause it uses microservices, the eShopOnContain\", \"ers app includes quite a few separate projects and solutions in its GitHub repository. In addition t\", \"o separate solutions and executable files, the various services are designed to run inside their own\", \" containers, both during local development and at run time in production. Figure 2-4 shows the full \", \"Visual Studio solution, in which the various different projects are organized.\\n\\n![](_page_35_Figure_\", \"0.jpeg)\\n\\n*Figure 2-4. Projects in Visual Studio solution.*\\n\\nThe code is organized to support the dif\", \"ferent microservices, and within each microservice, the code is broken up into domain logic, infrast\", \"ructure concerns, and user interface or service endpoint. In many cases, each service's dependencies\", \" can be fulfilled by Azure services in production, and alternative options for local development. Le\", \"t's examine how the application's requirements map to Azure services.\\n\\n# <span id=\\\"page-36-0\\\"></span\", \">Understanding microservices\\n\\nThis book focuses on cloud-native applications built using Azure techn\", \"ology. To learn more about microservices best practices and how to architect microservice-based appl\", \"ications, read the companion book, [.NET Microservices: Architecture for Containerized .NET Applicat\", \"ions.](https://dotnet.microsoft.com/download/thank-you/microservices-architecture-ebook)\\n\\n# <span id\", \"=\\\"page-36-1\\\"></span>Mapping eShopOnContainers to Azure Services\\n\\nAlthough not required, Azure is wel\", \"l-suited to supporting the eShopOnContainers because the project was built to be a cloud-native appl\", \"ication. The application is built with .NET, so it can run on Linux or Windows containers depending \", \"on the Docker host. The application is made up of multiple autonomous microservices, each with its o\", \"wn data. The different microservices showcase different approaches, ranging from simple CRUD operati\", \"ons to more complex DDD and CQRS patterns. Microservices communicate with clients over HTTP and with\", \" one another via message-based communication. The application supports multiple platforms for client\", \"s as well, since it adopts HTTP as a standard communication protocol and includes ASP.NET Core and X\", \"amarin mobile apps that run on Android, iOS, and Windows platforms.\\n\\nThe application's architecture \", \"is shown in Figure 2-5. On the left are the client apps, broken up into mobile, traditional Web, and\", \" Web Single Page Application (SPA) flavors. On the right are the serverside components that make up \", \"the system, each of which can be hosted in Docker containers and Kubernetes clusters. The traditiona\", \"l web app is powered by the ASP.NET Core MVC application shown in yellow. This app and the mobile an\", \"d web SPA applications communicate with the individual microservices through one or more API gateway\", \"s. The API gateways follow the \\\"backends for front ends\\\" (BFF) pattern, meaning that each gateway is\", \" designed to support a given front-end client. The individual microservices are listed to the right \", \"of the API gateways and include both business logic and some kind of persistence store. The differen\", \"t services make use of SQL Server databases, Redis cache instances, and MongoDB/CosmosDB stores. On \", \"the far right is the system's Event Bus, which is used for communication between the microservices.\\n\", \"\\n![](_page_37_Figure_2.jpeg)\\n\\n*Figure 2-5. The eShopOnContainers Architecture.*\\n\\nThe server-side com\", \"ponents of this architecture all map easily to Azure services.\\n\\n#### <span id=\\\"page-37-0\\\"></span>**C\", \"ontainer orchestration and clustering**\\n\\nThe application's container-hosted services, from ASP.NET C\", \"ore MVC apps to individual Catalog and Ordering microservices, can be hosted and managed in Azure Ku\", \"bernetes Service (AKS). The application can run locally on Docker and Kubernetes, and the same conta\", \"iners can then be deployed to staging and production environments hosted in AKS. This process can be\", \" automated as we'll see in the next section.\\n\\nAKS provides management services for individual cluste\", \"rs of containers. The application will deploy separate containers for each microservice in the AKS c\", \"luster, as shown in the architecture diagram above. This approach allows each individual service to \", \"scale independently according to its resource demands. Each microservice can also be deployed indepe\", \"ndently, and ideally such deployments should incur zero system downtime.\\n\\n#### <span id=\\\"page-37-1\\\">\", \"</span>**API Gateway**\\n\\nThe eShopOnContainers application has multiple front-end clients and multipl\", \"e different back-end services. There's no one-to-one correspondence between the client applications \", \"and the microservices that support them. In such a scenario, there may be a great deal of complexity\", \" when writing client software to interface with the various back-end services in a secure manner. Ea\", \"ch client would need to address this complexity on its own, resulting in duplication and many places\", \" in which to make updates as services change or new policies are implemented.\\n\\nAzure API Management \", \"(APIM) helps organizations publish APIs in a consistent, manageable fashion. APIM consists of three \", \"components: the API Gateway, and administration portal (the Azure portal), and a developer portal.\\n\\n\", \"The API Gateway accepts API calls and routes them to the appropriate back-end API. It can also provi\", \"de additional services like verification of API keys or JWT tokens and API transformation on the fly\", \" without code modifications (for instance, to accommodate clients expecting an older interface).\\n\\nTh\", \"e Azure portal is where you define the API schema and package different APIs into products. You also\", \" configure user access, view reports, and configure policies for quotas or transformations.\\n\\nThe dev\", \"eloper portal serves as the main resource for developers. It provides developers with API documentat\", \"ion, an interactive test console, and reports on their own usage. Developers also use the portal to \", \"create and manage their own accounts, including subscription and API key support.\\n\\nUsing APIM, appli\", \"cations can expose several different groups of services, each providing a back end for a particular \", \"front-end client. APIM is recommended for complex scenarios. For simpler needs, the lightweight API \", \"Gateway Ocelot can be used. The eShopOnContainers app uses Ocelot because of its simplicity and beca\", \"use it can be deployed into the same application environment as the application itself. [Learn more \", \"about eShopOnContainers, APIM, and Ocelot.](https://docs.microsoft.com/dotnet/architecture/microserv\", \"ices/architect-microservice-container-applications/direct-client-to-microservice-communication-versu\", \"s-the-api-gateway-pattern#azure-api-management)\\n\\nAnother option if your application is using AKS is \", \"to deploy the Azure Gateway Ingress Controller as a pod within your AKS cluster. This approach allow\", \"s your cluster to integrate with an Azure Application Gateway, allowing the gateway to load-balance \", \"traffic to the AKS pods. [Learn more about the Azure](https://github.com/Azure/application-gateway-k\", \"ubernetes-ingress)  [Gateway Ingress Controller for AKS.](https://github.com/Azure/application-gatew\", \"ay-kubernetes-ingress)\\n\\n#### <span id=\\\"page-38-0\\\"></span>**Data**\\n\\nThe various back-end services use\", \"d by eShopOnContainers have different storage requirements. Several microservices use SQL Server dat\", \"abases. The Basket microservice leverages a Redis cache for its persistence. The Locations microserv\", \"ice expects a MongoDB API for its data. Azure supports each of these data formats.\\n\\nFor SQL Server d\", \"atabase support, Azure has products for everything from single databases up to highly scalable SQL D\", \"atabase elastic pools. Individual microservices can be configured to communicate with their own indi\", \"vidual SQL Server databases quickly and easily. These databases can be scaled as needed to support e\", \"ach separate microservice according to its needs.\\n\\nThe eShopOnContainers application stores the user\", \"'s current shopping basket between requests. This aspect is managed by the Basket microservice that \", \"stores the data in a Redis cache. In development, this cache can be deployed in a container, while i\", \"n production it can utilize Azure Cache for Redis. Azure Cache for Redis is a fully managed service \", \"offering high performance and reliability without the need to deploy and manage Redis instances or c\", \"ontainers on your own.\\n\\nThe Locations microservice uses a MongoDB NoSQL database for its persistence\", \". During development, the database can be deployed in its own container, while in production the ser\", \"vice can leverage [Azure Cosmos DB's API for MongoDB](https://docs.microsoft.com/azure/cosmos-db/mon\", \"godb-introduction). One of the benefits of Azure Cosmos DB is its ability to leverage multiple diffe\", \"rent communication protocols, including a SQL API and common NoSQL APIs including MongoDB, Cassandra\", \", Gremlin, and Azure Table Storage. Azure Cosmos DB offers a fully managed and globally distributed \", \"database as a service that can scale to meet the needs of the services that use it.\\n\\nDistributed dat\", \"a in cloud-native applications is covered in more detail in [chapter 5.](#page-97-0)\\n\\n#### <span id=\", \"\\\"page-39-0\\\"></span>**Event Bus**\\n\\nThe application uses events to communicate changes between differe\", \"nt services. This functionality can be implemented with various implementations, and locally the eSh\", \"opOnContainers application uses [RabbitMQ.](https://www.rabbitmq.com/) When hosted in Azure, the app\", \"lication would leverage [Azure Service Bus](https://docs.microsoft.com/azure/service-bus/) for its m\", \"essaging. Azure Service Bus is a fully managed integration message broker that allows applications a\", \"nd services to communicate with one another in a decoupled, reliable, asynchronous manner. Azure Ser\", \"vice Bus supports individual queues as well as separate *topics* to support publisher-subscriber sce\", \"narios. The eShopOnContainers application would leverage topics with Azure Service Bus to support di\", \"stributing messages from one microservice to any other microservice that needed to react to a given \", \"message.\\n\\n#### <span id=\\\"page-39-1\\\"></span>**Resiliency**\\n\\nOnce deployed to production, the eShopOnC\", \"ontainers application would be able to take advantage of several Azure services available to improve\", \" its resiliency. The application publishes health checks, which can be integrated with Application I\", \"nsights to provide reporting and alerts based on the app's availability. Azure resources also provid\", \"e diagnostic logs that can be used to identify and correct bugs and performance issues. Resource log\", \"s provide detailed information on when and how different Azure resources are used by the application\", \". You'll learn more about cloud-native resiliency features in [chapter 6.](#page-122-0)\\n\\n# <span id=\", \"\\\"page-39-2\\\"></span>Deploying eShopOnContainers to Azure\\n\\nThe eShopOnContainers application can be de\", \"ployed to various Azure platforms. The recommended approach is to deploy the application to Azure Ku\", \"bernetes Services (AKS). Helm, a Kubernetes deployment tool, is available to reduce deployment compl\", \"exity. Optionally, developers may implement Azure Dev Spaces for Kubernetes to streamline their deve\", \"lopment process.\\n\\n#### <span id=\\\"page-39-3\\\"></span>**Azure Kubernetes Service**\\n\\nTo host eShop in AK\", \"S, the first step is to create an AKS cluster. To do so, you might use the Azure portal, which will \", \"walk you through the required steps. You could also create a cluster from the Azure CLI, taking care\", \" to enable Role-Based Access Control (RBAC) and application routing. The eShopOnContainers' document\", \"ation details the steps for creating your own AKS cluster. Once created, you can access and manage t\", \"he cluster from the Kubernetes dashboard.\\n\\nYou can now deploy the eShop application to the cluster u\", \"sing Helm.\\n\\n#### <span id=\\\"page-39-4\\\"></span>**Deploying to Azure Kubernetes Service using Helm**\\n\\nH\", \"elm is an application package manager tool that works directly with Kubernetes. It helps you define,\", \" install, and upgrade Kubernetes applications. While simple apps can be deployed to AKS with custom \", \"CLI scripts or simple deployment files, complex apps can contain many Kubernetes objects and benefit\", \" from Helm.\\n\\nUsing Helm, applications include text-based configuration files, called Helm charts, wh\", \"ich declaratively describe the application and configuration in Helm packages. Charts use standard Y\", \"AML-formatted\\n\\nfiles to describe a related set of Kubernetes resources. They're versioned alongside \", \"the application code they describe. Helm Charts range from simple to complex depending on the requir\", \"ements of the installation they describe.\\n\\nHelm is composed of a command-line client tool, which con\", \"sumes helm charts and launches commands to a server component named, Tiller. Tiller communicates wit\", \"h the Kubernetes API to ensure the correct provisioning of your containerized workloads. Helm is mai\", \"ntained by the Cloudnative Computing Foundation.\\n\\nThe following yaml file presents a Helm template:\\n\", \"\\n```\\napiVersion: v1\\nkind: Service\\nmetadata:\\n name: {{ .Values.app.svc.marketing }}\\n labels:\\n app: {{\", \" template \\\"marketing-api.name\\\" . }}\\n chart: {{ template \\\"marketing-api.chart\\\" . }}\\n release: {{ .Rel\", \"ease.Name }}\\n heritage: {{ .Release.Service }}\\nspec:\\n type: {{ .Values.service.type }}\\n ports:\\n - po\", \"rt: {{ .Values.service.port }}\\n targetPort: http\\n protocol: TCP\\n name: http\\n selector:\\n app: {{ temp\", \"late \\\"marketing-api.name\\\" . }}\\n release: {{ .Release.Name }}\\n```\\n\\nNote how the template describes a \", \"dynamic set of key/value pairs. When the template is invoked, values that enclosed in curly braces a\", \"re pulled in from other yaml-based configuration files.\\n\\nYou'll find the eShopOnContainers helm char\", \"ts in the /k8s/helm folder. Figure 2-6 shows how the different components of the application are org\", \"anized into a folder structure used by helm to define and managed deployments.\\n\\n![](_page_41_Picture\", \"_0.jpeg)\\n\\n*Figure 2-6. The eShopOnContainers helm folder.*\\n\\nEach individual component is installed u\", \"sing a helm install command. eShop includes a \\\"deploy all\\\" script that loops through and installs th\", \"e components using their respective helm charts. The result is a repeatable process, versioned with \", \"the application in source control, that anyone on the team can deploy to an AKS cluster with a one-l\", \"ine script command.\\n\\nNote that version 3 of Helm officially removes the need for the Tiller server c\", \"omponent. More information on this enhancement can be found [here.](https://medium.com/better-progra\", \"mming/why-is-tiller-missing-in-helm-3-2347c446714)\\n\\n#### <span id=\\\"page-41-0\\\"></span>**Azure Functio\", \"ns and Logic Apps (Serverless)**\\n\\nThe eShopOnContainers sample includes support for tracking online \", \"marketing campaigns. An Azure Function is used to track marketing campaign details for a given campa\", \"ign ID. Rather than creating a full microservice, a single Azure Function is simpler and sufficient.\", \" Azure Functions have a simple build and deployment model, especially when configured to run in Kube\", \"rnetes. Deploying the function is scripted using Azure Resource Manager (ARM) templates and the Azur\", \"e CLI. This campaign service isn't customer-facing and invokes a single operation, making it a great\", \" candidate for Azure Functions. The function requires minimal configuration, including a database co\", \"nnection string data and image base URI settings. You configure Azure Functions in the Azure portal.\", \"\\n\\n# <span id=\\\"page-42-0\\\"></span>Centralized configuration\\n\\nUnlike a monolithic app in which everythi\", \"ng runs within a single instance, a cloud-native application consists of independent services distri\", \"buted across virtual machines, containers, and geographic regions. Managing configuration settings f\", \"or dozens of interdependent services can be challenging. Duplicate copies of configuration settings \", \"across different locations are error prone and difficult to manage. Centralized configuration is a c\", \"ritical requirement for distributed cloud-native applications.\\n\\nAs discussed in Chapter 1, the Twelv\", \"e-Factor App recommendations require strict separation between code and configuration. Configuration\", \" must be stored externally from the application and read-in as needed. Storing configuration values \", \"as constants or literal values in code is a violation. The same configuration values are often be us\", \"ed by many services in the same application. Additionally, we must support the same values across mu\", \"ltiple environments, such as dev, testing, and production. The best practice is store them in a cent\", \"ralized configuration store.\\n\\nThe Azure cloud presents several great options.\\n\\n#### <span id=\\\"page-4\", \"2-1\\\"></span>**Azure App Configuration**\\n\\n[Azure App Configuration](https://docs.microsoft.com/azure/\", \"azure-app-configuration/overview) is a fully managed Azure service that stores non-secret configurat\", \"ion settings in a secure, centralized location. Stored values can be shared among multiple services \", \"and applications.\\n\\nThe service is simple to use and provides several benefits:\\n\\n- Flexible key/value\", \" representations and mappings\\n- Tagging with Azure labels\\n- Dedicated UI for management\\n- Encryption\", \" of sensitive information\\n- Querying and batch retrieval\\n\\nAzure App Configuration maintains changes \", \"made to key-value settings for seven days. The point-intime snapshot feature enables you to reconstr\", \"uct the history of a setting and even rollback for a failed deployment.\\n\\nApp Configuration automatic\", \"ally caches each setting to avoid excessive calls to the configuration store. The refresh operation \", \"waits until the cached value of a setting expires to update that setting, even when its value change\", \"s in the configuration store. The default cache expiration time is 30 seconds. You can override the \", \"expiration time.\\n\\nApp Configuration encrypts all configuration values in transit and at rest. Key na\", \"mes and labels are used as indexes for retrieving configuration data and aren't encrypted.\\n\\nAlthough\", \" App Configuration provides hardened security, Azure Key Vault is still the best place for storing a\", \"pplication secrets. Key Vault provides hardware-level encryption, granular access policies, and mana\", \"gement operations such as certificate rotation. You can create App Configuration values that referen\", \"ce secrets stored in a Key Vault.\\n\\n#### <span id=\\\"page-43-0\\\"></span>**Azure Key Vault**\\n\\nKey Vault i\", \"s a managed service for securely storing and accessing secrets. A secret is anything that you want t\", \"o tightly control access to, such as API keys, passwords, or certificates. A vault is a logical grou\", \"p of secrets.\\n\\nKey Vault greatly reduces the chances that secrets may be accidentally leaked. When u\", \"sing Key Vault, application developers no longer need to store security information in their applica\", \"tion. This practice eliminates the need to store this information inside your code. For example, an \", \"application may need to connect to a database. Instead of storing the connection string in the app's\", \" code, you can store it securely in Key Vault.\\n\\nYour applications can securely access the informatio\", \"n they need by using URIs. These URIs allow the applications to retrieve specific versions of a secr\", \"et. There's no need to write custom code to protect any of the secret information stored in Key Vaul\", \"t.\\n\\nAccess to Key Vault requires proper caller authentication and authorization. Typically, each clo\", \"udnative microservice uses a ClientId/ClientSecret combination. It's important to keep these credent\", \"ials outside source control. A best practice is to set them in the application's environment. Direct\", \" access to Key Vault from AKS can be achieved using [Key Vault FlexVolume.](https://github.com/Azure\", \"/kubernetes-keyvault-flexvol)\\n\\n#### <span id=\\\"page-43-1\\\"></span>**Configuration in eShop**\\n\\nThe eSho\", \"pOnContainers application includes local application settings files with each microservice. These fi\", \"les are checked into source control, but don't include production secrets such as connection strings\", \" or API keys. In production, individual settings may be overwritten with per-service environment var\", \"iables. Injecting secrets in environment variables is a common practice for hosted applications, but\", \" doesn't provide a central configuration store. To support centralized management of configuration s\", \"ettings, each microservice includes a setting to toggle between its use of local settings or Azure K\", \"ey Vault settings.\\n\\n#### <span id=\\\"page-43-2\\\"></span>**References**\\n\\n- [The eShopOnContainers Archit\", \"ecture](https://github.com/dotnet-architecture/eShopOnContainers/wiki/Architecture)\\n- [Orchestrating\", \" microservices and multi-container applications for high scalability and](https://docs.microsoft.com\", \"/dotnet/architecture/microservices/architect-microservice-container-applications/scalable-available-\", \"multi-container-microservice-applications)  [availability](https://docs.microsoft.com/dotnet/archite\", \"cture/microservices/architect-microservice-container-applications/scalable-available-multi-container\", \"-microservice-applications)\\n- [Azure API Management](https://docs.microsoft.com/azure/api-management\", \"/api-management-key-concepts)\\n- [Azure SQL Database Overview](https://docs.microsoft.com/azure/sql-d\", \"atabase/sql-database-technical-overview)\\n- [Azure Cache for Redis](https://azure.microsoft.com/servi\", \"ces/cache/)\\n- [Azure Cosmos DB's API for MongoDB](https://docs.microsoft.com/azure/cosmos-db/mongodb\", \"-introduction)\\n\\n- [Azure Service Bus](https://docs.microsoft.com/azure/service-bus-messaging/service\", \"-bus-messaging-overview)\\n- [Azure Monitor overview](https://docs.microsoft.com/azure/azure-monitor/o\", \"verview)\\n- [eShopOnContainers: Create Kubernetes cluster in AKS](https://github.com/dotnet-architect\", \"ure/eShopOnContainers/wiki/Deploy-to-Azure-Kubernetes-Service-(AKS)#create-kubernetes-cluster-in-aks\", \")\\n- [eShopOnContainers: Azure Dev Spaces](https://github.com/dotnet-architecture/eShopOnContainers/w\", \"iki/Azure-Dev-Spaces)\\n- [Azure Dev Spaces](https://docs.microsoft.com/azure/dev-spaces/about)\\n\\n**CHA\", \"PTER** 3\\n\\n# <span id=\\\"page-45-0\\\"></span>Scaling cloud-native applications\\n\\nOne of the most-often tou\", \"ted advantages of moving to a cloud hosting environment is scalability. Scalability, or the ability \", \"for an application to accept additional user load without compromising performance for each user. It\", \"'s most often achieved by breaking up an application into small pieces that can each be given whatev\", \"er resources they require. Cloud vendors enable massive scalability anytime and anywhere in the worl\", \"d.\\n\\nIn this chapter, we discuss technologies that enable cloud-native applications to scale to meet \", \"user demand. These technologies include:\\n\\n- Containers\\n- Orchestrators\\n- <span id=\\\"page-45-1\\\"></span\", \">\\u2022 Serverless computing\\n\\n# Leveraging containers and orchestrators\\n\\nContainers and orchestrators are\", \" designed to solve problems common to monolithic deployment approaches.\\n\\n#### <span id=\\\"page-45-2\\\"><\", \"/span>**Challenges with monolithic deployments**\\n\\nTraditionally, most applications have been deploye\", \"d as a single unit. Such applications are referred to as a monolith. This general approach of deploy\", \"ing applications as single units even if they're composed of multiple modules or assemblies is known\", \" as monolithic architecture, as shown in Figure 3-1.\\n\\n![](_page_46_Figure_0.jpeg)\\n\\n*Figure 3-1. Mono\", \"lithic architecture.*\\n\\nAlthough they have the benefit of simplicity, monolithic architectures face m\", \"any challenges:\\n\\n#### **Deployment**\\n\\nAdditionally, they require a restart of the application, which\", \" may temporarily impact availability if zero-downtime techniques are not applied while deploying.\\n\\n#\", \"### **Scaling**\\n\\nA monolithic application is hosted entirely on a single machine instance, often req\", \"uiring highcapability hardware. If any part of the monolith requires scaling, another copy of the en\", \"tire application must be deployed to another machine. With a monolith, you can't scale application c\", \"omponents individually - it's all or nothing. Scaling components that don't require scaling results \", \"in inefficient and costly resource usage.\\n\\n#### **Environment**\\n\\nMonolithic applications are typical\", \"ly deployed to a hosting environment with a pre-installed operating system, runtime, and library dep\", \"endencies. This environment may not match that upon which the application was developed or tested. I\", \"nconsistencies across application environments are a common source of problems for monolithic deploy\", \"ments.\\n\\n#### **Coupling**\\n\\nA monolithic application is likely to experience high coupling across its\", \" functional components. Without hard boundaries, system changes often result in unintended and costl\", \"y side effects. New features/fixes become tricky, time-consuming, and expensive to implement. Update\", \"s require extensive testing. Coupling also makes it difficult to refactor components or swap in alte\", \"rnative implementations. Even when constructed with a strict separation of concerns, architectural e\", \"rosion sets in as the monolithic code base deteriorates with never-ending \\\"special cases.\\\"\\n\\n#### **P\", \"latform lock-in**\\n\\nA monolithic application is constructed with a single technology stack. While off\", \"ering uniformity, this commitment can become a barrier to innovation. New features and components wi\", \"ll be built using the application's current stack - even when more modern technologies may be a bett\", \"er choice. A longer-term risk is your technology stack becoming outdated and obsolete. Rearchitectin\", \"g an entire application to a new, more modern platform is at best expensive and risky.\\n\\n#### <span i\", \"d=\\\"page-47-0\\\"></span>**What are the benefits of containers and orchestrators?**\\n\\nWe introduced conta\", \"iners in Chapter 1. We highlighted how the Cloud Native Computing Foundation (CNCF) ranks containeri\", \"zation as the first step in their [Cloud-Native Trail Map](https://raw.githubusercontent.com/cncf/tr\", \"ailmap/master/CNCF_TrailMap_latest.png) - guidance for enterprises beginning their cloud-native jour\", \"ney. In this section, we discuss the benefits of containers.\\n\\nDocker is the most popular container m\", \"anagement platform. It works with containers on both Linux or Windows. Containers provide separate b\", \"ut reproducible application environments that run the same way on any system. This aspect makes them\", \" perfect for developing and hosting cloud-native services. Containers are isolated from one another.\", \" Two containers on the same host hardware can have different versions of software, without causing c\", \"onflicts.\\n\\nContainers are defined by simple text-based files that become project artifacts and are c\", \"hecked into source control. While full servers and virtual machines require manual effort to update,\", \" containers are easily version-controlled. Apps built to run in containers can be developed, tested,\", \" and deployed using automated tools as part of a build pipeline.\\n\\nContainers are immutable. Once you\", \" define a container, you can recreate and run it exactly the same way. This immutability lends itsel\", \"f to component-based design. If some parts of an application evolve differently than others, why red\", \"eploy the entire app when you can just deploy the parts that change most frequently? Different featu\", \"res and cross-cutting concerns of an app can be broken up into separate units. Figure 3-2 shows how \", \"a monolithic app can take advantage of containers and microservices by delegating certain features o\", \"r functionality. The remaining functionality in the app itself has also been containerized.\\n\\n![](_pa\", \"ge_48_Figure_0.jpeg)\\n\\n*Figure 3-2. Decomposing a monolithic app to embrace microservices.*\\n\\nEach clo\", \"ud-native service is built and deployed in a separate container. Each can update as needed. Individu\", \"al services can be hosted on nodes with resources appropriate to each service. The environment each \", \"service runs in is immutable, shared across dev, test, and production environments, and easily versi\", \"oned. Coupling between different areas of the application occurs explicitly as calls or messages bet\", \"ween services, not compile-time dependencies within the monolith. You can also choose the technology\", \" that best suites a given capability without requiring changes to the rest of the app.\\n\\nContainerize\", \"d services require automated management. It wouldn't be feasible to manually administer a large set \", \"of independently deployed containers. For example, consider the following tasks:\\n\\n- How will contain\", \"er instances be provisioned across a cluster of many machines?\\n- Once deployed, how will containers \", \"discover and communicate with each other?\\n- How can containers scale in or out on-demand?\\n- How do y\", \"ou monitor the health of each container?\\n- How do you protect a container against hardware and softw\", \"are failures?\\n- How do upgrade containers for a live application with zero downtime?\\n\\nContainer orch\", \"estrators address and automate these and other concerns.\\n\\nIn the cloud-native eco-system, Kubernetes\", \" has become the de facto container orchestrator. It's an open-source platform managed by the Cloud N\", \"ative Computing Foundation (CNCF). Kubernetes automates the deployment, scaling, and operational con\", \"cerns of containerized workloads across a machine cluster. However, installing and managing Kubernet\", \"es is notoriously complex.\\n\\nA much better approach is to leverage Kubernetes as a managed service fr\", \"om a cloud vendor. The Azure cloud features a fully managed Kubernetes platform entitled [Azure Kube\", \"rnetes Service \\\\(AKS\\\\).](https://azure.microsoft.com/services/kubernetes-service/) AKS abstracts the\", \" complexity and operational overhead of managing Kubernetes. You consume Kubernetes as a cloud servi\", \"ce; Microsoft takes responsibility for managing and supporting it. AKS also tightly integrates with \", \"other Azure services and dev tools.\\n\\nAKS is a cluster-based technology. A pool of federated virtual \", \"machines, or nodes, is deployed to the Azure cloud. Together they form a highly available environmen\", \"t, or cluster. The cluster appears as a seamless, single entity to your cloud-native application. Un\", \"der the hood, AKS deploys your containerized services across these nodes following a predefined stra\", \"tegy that evenly distributes the load.\\n\\n#### <span id=\\\"page-49-0\\\"></span>**What are the scaling bene\", \"fits?**\\n\\nServices built on containers can leverage scaling benefits provided by orchestration tools \", \"like Kubernetes. By design containers only know about themselves. Once you have multiple containers \", \"that need to work together, you should organize them at a higher level. Organizing large numbers of \", \"containers and their shared dependencies, such as network configuration, is where orchestration tool\", \"s come in to save the day! Kubernetes creates an abstraction layer over groups of containers and org\", \"anizes them into *pods*. Pods run on worker machines referred to as *nodes*. This organized structur\", \"e is referred to as a *cluster*. Figure 3-3 shows the different components of a Kubernetes cluster.\\n\", \"\\n![](_page_49_Figure_4.jpeg)\\n\\n*Figure 3-3. Kubernetes cluster components.*\\n\\nScaling containerized wo\", \"rkloads is a key feature of container orchestrators. AKS supports automatic scaling across two dimen\", \"sions: Container instances and compute nodes. Together they give AKS the ability to quickly and effi\", \"ciently respond to spikes in demand and add additional resources. We discuss scaling in AKS later in\", \" this chapter.\\n\\n#### **Declarative versus imperative**\\n\\nKubernetes supports both declarative and imp\", \"erative configuration. The imperative approach involves running various commands that tell Kubernete\", \"s what to do each step of the way. Run this image. Delete this pod. Expose this port. With the decla\", \"rative approach, you create a configuration file, called a manifest, to describe what you want inste\", \"ad of what to do. Kubernetes reads the manifest and transforms your desired end state into actual en\", \"d state.\\n\\nImperative commands are great for learning and interactive experimentation. However, you'l\", \"l want to declaratively create Kubernetes manifest files to embrace an infrastructure as code approa\", \"ch, providing for reliable and repeatable deployments. The manifest file becomes a project artifact \", \"and is used in your CI/CD pipeline for automating Kubernetes deployments.\\n\\nIf you've already configu\", \"red your cluster using imperative commands, you can export a declarative manifest by using kubectl g\", \"et svc SERVICENAME -o yaml > service.yaml. This command produces a manifest similar to one shown bel\", \"ow:\\n\\n```\\napiVersion: v1\\nkind: Service\\nmetadata:\\n creationTimestamp: \\\"2019-09-13T13:58:47Z\\\"\\n labels:\\n\", \" component: apiserver\\n provider: kubernetes\\n name: kubernetes\\n namespace: default\\n resourceVersion: \", \"\\\"153\\\"\\n selfLink: /api/v1/namespaces/default/services/kubernetes\\n uid: 9b1fac62-d62e-11e9-8968-00155d\", \"38010d\\nspec:\\n clusterIP: 10.96.0.1\\n ports:\\n - name: https\\n port: 443\\n protocol: TCP\\n targetPort: 644\", \"3\\n sessionAffinity: None\\n type: ClusterIP\\nstatus:\\n loadBalancer: {}\\n```\\n\\nWhen using declarative conf\", \"iguration, you can preview the changes that will be made before committing them by using kubectl dif\", \"f -f FOLDERNAME against the folder where your configuration files are located. Once you're sure you \", \"want to apply the changes, run kubectl apply -f FOLDERNAME. Add -R to recursively process a folder h\", \"ierarchy.\\n\\nYou can also use declarative configuration with other Kubernetes features, one of which b\", \"eing deployments. Declarative deployments help manage releases, updates, and scaling. They instruct \", \"the Kubernetes deployment controller on how to deploy new changes, scale out load, or roll back to a\", \" previous revision. If a cluster is unstable, a declarative deployment will automatically return the\", \" cluster back to a desired state. For example, if a node should crash, the deployment mechanism will\", \" redeploy a replacement to achieve your desired state\\n\\nUsing declarative configuration allows infras\", \"tructure to be represented as code that can be checked in and versioned alongside the application co\", \"de. It provides improved change control and better support for continuous deployment using a build a\", \"nd deploy pipeline.\\n\\n#### <span id=\\\"page-51-0\\\"></span>**What scenarios are ideal for containers and \", \"orchestrators?**\\n\\nThe following scenarios are ideal for using containers and orchestrators.\\n\\n#### **\", \"Applications requiring high uptime and scalability**\\n\\nIndividual applications that have high uptime \", \"and scalability requirements are ideal candidates for cloud-native architectures using microservices\", \", containers, and orchestrators. They can be developed in containers, tested across versioned enviro\", \"nments, and deployed into production with zero downtime. The use of Kubernetes clusters ensures such\", \" apps can also scale on demand and recover automatically from node failures.\\n\\n#### **Large numbers o\", \"f applications**\\n\\nOrganizations that deploy and maintain large numbers of applications benefit from \", \"containers and orchestrators. The up front effort of setting up containerized environments and Kuber\", \"netes clusters is primarily a fixed cost. Deploying, maintaining, and updating individual applicatio\", \"ns has a cost that varies with the number of applications. Beyond a few applications, the complexity\", \" of maintaining custom applications manually exceeds the cost of implementing a solution using conta\", \"iners and orchestrators.\\n\\n#### <span id=\\\"page-51-1\\\"></span>**When should you avoid using containers \", \"and orchestrators?**\\n\\nIf you're unable to build your application following the Twelve-Factor App pri\", \"nciples, you should consider avoiding containers and orchestrators. In these cases, consider a VM-ba\", \"sed hosting platform, or possibly some hybrid system. With it, you can always spin off certain piece\", \"s of functionality into separate containers or even serverless functions.\\n\\n#### <span id=\\\"page-51-2\\\"\", \"></span>**Development resources**\\n\\nThis section shows a short list of development resources that may\", \" help you get started using containers and orchestrators for your next application. If you're lookin\", \"g for guidance on how to design your cloud-native microservices architecture app, read this book's c\", \"ompanion, [.NET](https://dotnet.microsoft.com/download/thank-you/microservices-architecture-ebook)  \", \"[Microservices: Architecture for Containerized .NET Applications.](https://dotnet.microsoft.com/down\", \"load/thank-you/microservices-architecture-ebook)\\n\\n#### **Local Kubernetes Development**\\n\\nKubernetes \", \"deployments provide great value in production environments, but can also run locally on your develop\", \"ment machine. While you may work on individual microservices independently, there may be times when \", \"you'll need to run the entire system locally - just as it will run when deployed to production. Ther\", \"e are several tools that can help: Minikube and Docker Desktop. Visual Studio also provides tooling \", \"for Docker development.\\n\\n#### **Minikube**\\n\\nWhat is Minikube? The Minikube project says \\\"Minikube im\", \"plements a local Kubernetes cluster on macOS, Linux, and Windows.\\\" Its primary goals are \\\"to be the \", \"best tool for local Kubernetes application development and to support all Kubernetes features that f\", \"it.\\\" Installing Minikube is separate from Docker, but Minikube supports different hypervisors than D\", \"ocker Desktop supports. The following Kubernetes features are currently supported by Minikube:\\n\\n- DN\", \"S\\n- NodePorts\\n- ConfigMaps and secrets\\n- Dashboards\\n- Container runtimes: Docker, rkt, CRI-O, and co\", \"ntainerd\\n- Enabling Container Network Interface (CNI)\\n- Ingress\\n\\nAfter installing Minikube, you can \", \"quickly start using it by running the minikube start command, which downloads an image and start the\", \" local Kubernetes cluster. Once the cluster is started, you interact with it using the standard Kube\", \"rnetes kubectl commands.\\n\\n#### **Docker Desktop**\\n\\nYou can also work with Kubernetes directly from D\", \"ocker Desktop on Windows. It is your only option if you're using Windows Containers, and is a great \", \"choice for non-Windows containers as well. Figure 3- 4 shows how to enable local Kubernetes support \", \"when running Docker Desktop.\\n\\n![](_page_52_Picture_12.jpeg)\\n\\n*Figure 3-4. Configuring Kubernetes in \", \"Docker Desktop.*\\n\\nDocker Desktop is the most popular tool for configuring and running containerized \", \"apps locally. When you work with Docker Desktop, you can develop locally against the exact same set \", \"of Docker container images that you'll deploy to production. Docker Desktop is designed to \\\"build, t\", \"est, and ship\\\" containerized apps locally. It supports both Linux and Windows containers. Once you p\", \"ush your images to an image registry, like Azure Container Registry or Docker Hub, AKS can pull and \", \"deploy them to production.\\n\\n#### **Visual Studio Docker Tooling**\\n\\nVisual Studio supports Docker dev\", \"elopment for web-based applications. When you create a new ASP.NET Core application, you have an opt\", \"ion to configure it with Docker support, as shown in Figure 3-5.\\n\\n![](_page_53_Picture_3.jpeg)\\n\\n*Fig\", \"ure 3-5. Visual Studio Enable Docker Support*\\n\\nWhen this option is selected, the project is created \", \"with a Dockerfile in its root, which can be used to build and host the app in a Docker container. An\", \" example Dockerfile is shown in Figure 3-6.\\n\\n```\\nFROM mcr.microsoft.com/dotnet/aspnet:7.0 AS base\\nWO\", \"RKDIR /app\\nEXPOSE 80\\nEXPOSE 443\\nFROM mcr.microsoft.com/dotnet/sdk:7.0 AS build\\nWORKDIR /src\\nCOPY [\\\"e\", \"ShopWeb/eShopWeb.csproj\\\", \\\"eShopWeb/\\\"]\\nRUN dotnet restore \\\"eShopWeb/eShopWeb.csproj\\\"\\nCOPY . .\\nWORKDI\", \"R \\\"/src/eShopWeb\\\"\\nRUN dotnet build \\\"eShopWeb.csproj\\\" -c Release -o /app/build\\nFROM build AS publish\\n\", \"RUN dotnet publish \\\"eShopWeb.csproj\\\" -c Release -o /app/publish\\n```\\n\\n```\\nFROM base AS final\\nWORKDIR \", \"/app\\nCOPY --from=publish /app/publish .\\nENTRYPOINT [\\\"dotnet\\\", \\\"eShopWeb.dll\\\"]\\n```\\n\\n*Figure 3-6. Visu\", \"al Studio generated Dockerfile*\\n\\nOnce support is added, you can run your application in a Docker con\", \"tainer in Visual Studio. Figure 3-7 shows the different run options available from a new ASP.NET Cor\", \"e project created with Docker support added.\\n\\n![](_page_54_Picture_3.jpeg)\\n\\n*Figure 3-7. Visual Stud\", \"io Docker Run Options*\\n\\nAlso, at any time you can add Docker support to an existing ASP.NET Core app\", \"lication. From the Visual Studio Solution Explorer, right-click on the project and select **Add** > \", \"**Docker Support**, as shown in Figure 3-8.\\n\\n![](_page_55_Picture_0.jpeg)\\n\\n*Figure 3-8. Adding Docke\", \"r support to Visual Studio*\\n\\n#### **Visual Studio Code Docker Tooling**\\n\\nThere are many extensions a\", \"vailable for Visual Studio Code that support Docker development.\\n\\nMicrosoft provides the [Docker for\", \" Visual Studio Code extension.](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vs\", \"code-docker) This extension simplifies the process of adding container support to applications. It s\", \"caffolds required files, builds Docker images, and enables you to debug your app inside a container.\", \" The extension features a visual explorer that makes it easy to take actions on containers and image\", \"s such as start, stop, inspect, remove, and more. The extension also supports Docker Compose enablin\", \"g you to manage multiple running containers as a single unit.\\n\\n# <span id=\\\"page-55-0\\\"></span>Leverag\", \"ing serverless functions\\n\\nIn the spectrum from managing physical machines to leveraging cloud capabi\", \"lities, serverless lives at the extreme end. Your only responsibility is your code, and you only pay\", \" when your code runs. Azure Functions provides a way to build serverless capabilities into your clou\", \"d-native applications.\\n\\n#### <span id=\\\"page-56-0\\\"></span>**What is serverless?**\\n\\nServerless is a re\", \"latively new service model of cloud computing. It doesn't mean that servers are optional - your code\", \" still runs on a server somewhere. The distinction is that the application team no longer concerns i\", \"tself with managing server infrastructure. Instead, the cloud vendor own this responsibility. The de\", \"velopment team increases its productivity by delivering business solutions to customers, not plumbin\", \"g.\\n\\nServerless computing uses event-triggered stateless containers to host your services. They can s\", \"cale out and in to meet demand as-needed. Serverless platforms like Azure Functions have tight integ\", \"ration with other Azure services like queues, events, and storage.\\n\\n#### <span id=\\\"page-56-1\\\"></span\", \">**What challenges are solved by serverless?**\\n\\nServerless platforms address many time-consuming and\", \" expensive concerns:\\n\\n- Purchasing machines and software licenses\\n- Housing, securing, configuring, \", \"and maintaining the machines and their networking, power, and A/C requirements\\n- Patching and upgrad\", \"ing operating systems and software\\n- Configuring web servers or machine services to host application\", \" software\\n- Configuring application software within its platform\\n\\nMany companies allocate large budg\", \"ets to support hardware infrastructure concerns. Moving to the cloud can help reduce these costs; sh\", \"ifting applications to serverless can help eliminate them.\\n\\n#### <span id=\\\"page-56-2\\\"></span>**What \", \"is the difference between a microservice and a serverless function?**\\n\\nTypically, a microservice enc\", \"apsulates a business capability, such as a shopping cart for an online eCommerce site. It exposes mu\", \"ltiple operations that enable a user to manage their shopping experience. A function, however, is a \", \"small, lightweight block of code that executes a single-purpose operation in response to an event. M\", \"icroservices are typically constructed to respond to requests, often from an interface. Requests can\", \" be HTTP Rest- or gRPC-based. Serverless services respond to events. Its event-driven architecture i\", \"s ideal for processing short-running, background tasks.\\n\\n#### <span id=\\\"page-56-3\\\"></span>**What sce\", \"narios are appropriate for serverless?**\\n\\nServerless exposes individual short-running functions that\", \" are invoked in response to a trigger. This makes them ideal for processing background tasks.\\n\\nAn ap\", \"plication might need to send an email as a step in a workflow. Instead of sending the notification a\", \"s part of a microservice request, place the message details onto a queue. An Azure Function can dequ\", \"eue the message and asynchronously send the email. Doing so could improve the performance and scalab\", \"ility of the microservice. [Queue-based load leveling](https://docs.microsoft.com/azure/architecture\", \"/patterns/queue-based-load-leveling) can be implemented to avoid bottlenecks related to sending the \", \"emails. Additionally, this stand-alone service could be reused as a utility across many different ap\", \"plications.\\n\\nAsynchronous messaging from queues and topics is a common pattern to trigger serverless\", \" functions. However, Azure Functions can be triggered by other events, such as changes to Azure Blob\", \" Storage. A service that supports image uploads could have an Azure Function responsible for optimiz\", \"ing the image size. The function could be triggered directly by inserts into Azure Blob Storage, kee\", \"ping complexity out of the microservice operations.\\n\\nMany services have long-running processes as pa\", \"rt of their workflows. Often these tasks are done as part of the user's interaction with the applica\", \"tion. These tasks can force the user to wait, negatively impacting their experience. Serverless comp\", \"uting provides a great way to move slower tasks outside of the user interaction loop. These tasks ca\", \"n scale with demand without requiring the entire application to scale.\\n\\n#### <span id=\\\"page-57-0\\\"></\", \"span>**When should you avoid serverless?**\\n\\nServerless solutions provision and scale on demand. When\", \" a new instance is invoked, cold starts are a common issue. A cold start is the period of time it ta\", \"kes to provision this instance. Normally, this delay might be a few seconds, but can be longer depen\", \"ding on various factors. Once provisioned, a single instance is kept alive as long as it receives pe\", \"riodic requests. But, if a service is called less frequently, Azure may remove it from memory and re\", \"quire a cold start when reinvoked. Cold starts are also required when a function scales out to a new\", \" instance.\\n\\nFigure 3-9 shows a cold-start pattern. Note the extra steps required when the app is col\", \"d.\\n\\n![](_page_57_Figure_5.jpeg)\\n\\n*Figure 3-9. Cold start versus warm start.*\\n\\nTo avoid cold starts e\", \"ntirely, you might switch from a [consumption plan to a dedicated plan.](https://azure.microsoft.com\", \"/blog/understanding-serverless-cold-start/) You can also configure one or more [pre-warmed instances\", \"](https://docs.microsoft.com/azure/azure-functions/functions-premium-plan#pre-warmed-instances) with\", \" the premium plan upgrade. In these cases, when you need to add another instance, it's already up an\", \"d ready to go. These options can help mitigate the cold start issue associated with serverless compu\", \"ting.\\n\\nCloud providers bill for serverless based on compute execution time and consumed memory. Long\", \" running operations or high memory consumption workloads aren't always the best candidates for serve\", \"rless. Serverless functions favor small chunks of work that can complete quickly. Most serverless pl\", \"atforms require individual functions to complete within a few minutes. Azure Functions defaults to a\", \" 5-minute time-out duration, which can be configured up to 10 minutes. The Azure Functions premium p\", \"lan can mitigate this issue as well, defaulting time-outs to 30 minutes with an unbounded higher lim\", \"it that can be configured. Compute time isn't calendar time. More advanced functions using the [Azur\", \"e Durable Functions framework](https://docs.microsoft.com/azure/azure-functions/durable/durable-func\", \"tions-overview?tabs=csharp) may pause execution over a course of several days. The billing is based \", \"on actual execution time - when the function wakes up and resumes processing.\\n\\nFinally, leveraging A\", \"zure Functions for application tasks adds complexity. It's wise to first architect your application \", \"with a modular, loosely coupled design. Then, identify if there are benefits serverless would offer \", \"that justify the additional complexity.\\n\\n# <span id=\\\"page-58-0\\\"></span>Combining containers and serv\", \"erless approaches\\n\\nCloud-native applications typically implement services leveraging containers and \", \"orchestration. There are often opportunities to expose some of the application's services as Azure F\", \"unctions. However, with a cloud-native app deployed to Kubernetes, it would be nice to leverage Azur\", \"e Functions within this same toolset. Fortunately, you can wrap Azure Functions inside Docker contai\", \"ners and deploy them using the same processes and tools as the rest of your Kubernetes-based app.\\n\\n#\", \"### <span id=\\\"page-58-1\\\"></span>**When does it make sense to use containers with serverless?**\\n\\nYour\", \" Azure Function has no knowledge of the platform on which it's deployed. For some scenarios, you may\", \" have specific requirements and need to customize the environment on which your function code will r\", \"un. You'll need a custom image that supports dependencies or a configuration not supported by the de\", \"fault image. In these cases, it makes sense to deploy your function in a custom Docker container.\\n\\n#\", \"### <span id=\\\"page-58-2\\\"></span>**When should you avoid using containers with Azure Functions?**\\n\\nIf\", \" you want to use consumption billing, you can't run your function in a container. What's more, if yo\", \"u deploy your function to a Kubernetes cluster, you'll no longer benefit from the built-in scaling p\", \"rovided by Azure Functions. You'll need to use Kubernetes' scaling features, described earlier in th\", \"is chapter.\\n\\n#### <span id=\\\"page-58-3\\\"></span>**How to combine serverless and Docker containers**\\n\\nT\", \"o wrap an Azure Function in a Docker container, install the [Azure Functions Core Tools](https://git\", \"hub.com/Azure/azure-functions-core-tools) and then run the following command:\\n\\nfunc init ProjectName\", \" --worker-runtime dotnet --docker\\n\\nWhen the project is created, it will include a Dockerfile and the\", \" worker runtime configured to dotnet. Now, you can create and test your function locally. Build and \", \"run it using the docker build and docker run commands. For detailed steps to get started building Az\", \"ure Functions with Docker support, see the [Create a function on Linux using a custom image](https:/\", \"/docs.microsoft.com/azure/azure-functions/functions-create-function-linux-custom-image) tutorial.\\n\\n#\", \"### <span id=\\\"page-59-0\\\"></span>**How to combine serverless and Kubernetes with KEDA**\\n\\nIn this chap\", \"ter, you've seen that the Azure Functions' platform automatically scales out to meet demand. When de\", \"ploying containerized functions to AKS, however, you lose the built-in scaling functionality. To the\", \" rescue comes [Kubernetes-based Event Driven \\\\(KEDA\\\\).](https://docs.microsoft.com/azure/azure-funct\", \"ions/functions-kubernetes-keda) It enables fine-grained autoscaling for event-driven Kubernetes work\", \"loads, including containerized functions.\\n\\nKEDA provides event-driven scaling functionality to the F\", \"unctions' runtime in a Docker container. KEDA can scale from zero instances (when no events are occu\", \"rring) out to n instances, based on load. It enables autoscaling by exposing custom metrics to the K\", \"ubernetes autoscaler (Horizontal Pod Autoscaler). Using Functions containers with KEDA makes it poss\", \"ible to replicate serverless function capabilities in any Kubernetes cluster.\\n\\nIt's worth noting tha\", \"t the KEDA project is now managed by the Cloud Native Computing Foundation (CNCF).\\n\\n# <span id=\\\"page\", \"-59-1\\\"></span>Deploying containers in Azure\\n\\nWe've discussed containers in this chapter and in chapt\", \"er 1. We've seen that containers provide many benefits to cloud-native applications, including porta\", \"bility. In the Azure cloud, you can deploy the same containerized services across staging and produc\", \"tion environments. Azure provides several options for hosting these containerized workloads:\\n\\n- Azur\", \"e Kubernetes Services (AKS)\\n- Azure Container Instance (ACI)\\n- Azure Web Apps for Containers\\n\\n#### <\", \"span id=\\\"page-59-2\\\"></span>**Azure Container Registry**\\n\\nWhen containerizing a microservice, you fir\", \"st build a container \\\"image.\\\" The image is a binary representation of the service code, dependencies\", \", and runtime. While you can manually create an image using the Docker Build command from the Docker\", \" API, a better approach is to create it as part of an automated build process.\\n\\nOnce created, contai\", \"ner images are stored in container registries. They enable you to build, store, and manage container\", \" images. There are many registries available, both public and private. Azure Container Registry (ACR\", \") is a fully managed container registry service in the Azure cloud. It persists your images inside t\", \"he Azure network, reducing the time to deploy them to Azure container hosts. You can also secure the\", \"m using the same security and identity procedures that you use for other Azure resources.\\n\\nYou creat\", \"e an Azure Container Registry using the [Azure portal,](https://docs.microsoft.com/azure/container-r\", \"egistry/container-registry-get-started-portal) [Azure CLI,](https://docs.microsoft.com/azure/contain\", \"er-registry/container-registry-get-started-azure-cli) or [PowerShell tools.](https://docs.microsoft.\", \"com/azure/container-registry/container-registry-get-started-powershell) Creating a registry in Azure\", \" is simple. It requires an Azure subscription, resource group, and a unique name. Figure 3-10 shows \", \"the basic options for creating a registry, which will be hosted at registryname.azurecr.io.\\n\\n![](_pa\", \"ge_60_Picture_1.jpeg)\\n\\n*Figure 3-10. Create container registry*\\n\\nOnce you've created the registry, y\", \"ou'll need to authenticate with it before you can use it. Typically, you'll log into the registry us\", \"ing the Azure CLI command:\\n\\n```\\naz acr login --name *registryname*\\n```\\n\\nOnce authenticated, you can \", \"use docker commands to push container images to it. Before you can do so, however, you must tag your\", \" image with the fully qualified name (URL) of your ACR login server. It will have the format *regist\", \"ryname*.azurecr.io.\\n\\ndocker tag mycontainer myregistry.azurecr.io/mycontainer:v1\\n\\nAfter you've tagge\", \"d the image, you use the docker push command to push the image to your ACR instance.\\n\\ndocker push my\", \"registry.azurecr.io/mycontainer:v1\\n\\nAfter you push an image to the registry, it's a good idea to rem\", \"ove the image from your local Docker environment, using this command:\\n\\n```\\ndocker rmi myregistry.azu\", \"recr.io/mycontainer:v1\\n```\\n\\nAs a best practice, you shouldn't manually push images to a container re\", \"gistry. Instead, use a build pipeline defined in a tool like GitHub or Azure DevOps. Learn more in t\", \"he [Cloud-Native DevOps](#page-170-0)  [chapter.](#page-170-0)\\n\\n#### <span id=\\\"page-61-0\\\"></span>**A\", \"CR Tasks**\\n\\n[ACR Tasks](https://docs.microsoft.com/azure/container-registry/container-registry-tasks\", \"-overview) is a set of features available from the Azure Container Registry. It extends your [inner-\", \"loop](https://docs.microsoft.com/dotnet/architecture/containerized-lifecycle/design-develop-containe\", \"rized-apps/docker-apps-inner-loop-workflow)  [development cycle](https://docs.microsoft.com/dotnet/a\", \"rchitecture/containerized-lifecycle/design-develop-containerized-apps/docker-apps-inner-loop-workflo\", \"w) by building and managing container images in the Azure cloud. Instead of invoking a docker build \", \"and docker push locally on your development machine, they're automatically handled by ACR Tasks in t\", \"he cloud.\\n\\nThe following AZ CLI command both builds a container image and pushes it to ACR:\\n\\n```\\n# c\", \"reate a container registry\\naz acr create --resource-group myResourceGroup --name myContainerRegistry\", \"008 --sku \\nBasic\\n```\\n\\n# build container image in ACR and push it into your container registry az acr\", \" build --image sample/hello-world:v1 --registry myContainerRegistry008 --file Dockerfile .\\n\\nAs you c\", \"an see from the previous command block, there's no need to install Docker Desktop on your developmen\", \"t machine. Additionally, you can configure ACR Task triggers to rebuild containers images on both so\", \"urce code and base image updates.\\n\\n#### <span id=\\\"page-61-1\\\"></span>**Azure Kubernetes Service**\\n\\nWe\", \" discussed Azure Kubernetes Service (AKS) at length in this chapter. We've seen that it's the de fac\", \"to container orchestrator managing containerized cloud-native applications.\\n\\nOnce you deploy an imag\", \"e to a registry, such as ACR, you can configure AKS to automatically pull and deploy it. With a CI/C\", \"D pipeline in place, you might configure a [canary release](https://martinfowler.com/bliki/CanaryRel\", \"ease.html) strategy to minimize the risk involved when rapidly deploying updates. The new version of\", \" the app is initially configured in production with no traffic routed to it. Then, the system will r\", \"oute a small percentage of users to the newly deployed version. As the team gains confidence in the \", \"new version, it can roll out more instances and retire the old. AKS easily supports this style of de\", \"ployment.\\n\\nAs with most resources in Azure, you can create an Azure Kubernetes Service cluster using\", \" the portal, command-line, or automation tools like Helm or Terraform. To get started with a new clu\", \"ster, you need to provide the following information:\\n\\n- Azure subscription\\n- Resource group\\n- Kubern\", \"etes cluster name\\n- Region\\n\\n- Kubernetes version\\n- DNS name prefix\\n- Node size\\n- Node count\\n\\nThis in\", \"formation is sufficient to get started. As part of the creation process in the Azure portal, you can\", \" also configure options for the following features of your cluster:\\n\\n- Scale\\n- Authentication\\n- Netw\", \"orking\\n- Monitoring\\n- Tags\\n\\nThis [quickstart walks through deploying an AKS cluster using the Azure \", \"portal.](https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-portal)\\n\\n#### <span id=\\\"page-62\", \"-0\\\"></span>**Azure Bridge to Kubernetes**\\n\\nCloud-native applications can grow large and complex, req\", \"uiring significant compute resources to run. In these scenarios, the entire application can't be hos\", \"ted on a development machine (especially a laptop). [Azure Bridge to Kubernetes](https://docs.micros\", \"oft.com/visualstudio/bridge/overview-bridge-to-kubernetes) addresses the shortcoming. It enables dev\", \"elopers to work with a local version of their service while hosting the entire application in an AKS\", \" development cluster.\\n\\nWhen ready, developers test their changes locally while running against the f\", \"ull application in the AKS cluster - without replicating dependencies. Under the hood, the bridge me\", \"rges code from the local machine with services in AKS. Developers can rapidly iterate and debug code\", \" directly in Kubernetes using Visual Studio or Visual Studio Code.\\n\\nGabe Monroy, former VP of Produc\", \"t Management at Microsoft, describes it well:\\n\\nImagine you're a new employee trying to fix a bug in \", \"a complex microservices application consisting of dozens of components, each with their own configur\", \"ation and backing services. To get started, you must configure your local development environment so\", \" that it can mimic production including setting up your IDE, building tool chain, containerized serv\", \"ice dependencies, a local Kubernetes environment, mocks for backing services, and more. With all the\", \" time involved setting up your development environment, fixing that first bug could take days! Or yo\", \"u could just use Bridge to Kubernetes and AKS.\\n\\n# <span id=\\\"page-62-1\\\"></span>Scaling containers and\", \" serverless applications\\n\\nThere are two ways to scale an application: up or out. The former refers t\", \"o adding capacity to a single resource, while the latter refers to adding more resources to increase\", \" capacity.\\n\\n#### <span id=\\\"page-62-2\\\"></span>**The simple solution: scaling up**\\n\\nUpgrading an exist\", \"ing host server with increased CPU, memory, disk I/O speed, and network I/O speed is known as *scali\", \"ng up*. Scaling up a cloud-native application involves choosing more capable resources from the clou\", \"d vendor. For example, you can create a new node pool with larger VMs in your Kubernetes cluster. Th\", \"en, migrate your containerized services to the new pool.\\n\\nServerless apps scale up by choosing the [\", \"premium Functions plan](https://docs.microsoft.com/azure/azure-functions/functions-scale) or premium\", \" instance sizes from a dedicated app service plan.\\n\\n#### <span id=\\\"page-63-0\\\"></span>**Scaling out c\", \"loud-native apps**\\n\\nCloud-native applications often experience large fluctuations in demand and requ\", \"ire scale on a moment's notice. They favor scaling out. Scaling out is done horizontally by adding a\", \"dditional machines (called nodes) or application instances to an existing cluster. In Kubernetes, yo\", \"u can scale manually by adjusting configuration settings for the app (for example, [scaling a node p\", \"ool\\\\)](https://docs.microsoft.com/azure/aks/use-multiple-node-pools#scale-a-node-pool-manually), or \", \"through autoscaling.\\n\\nAKS clusters can autoscale in one of two ways:\\n\\nFirst, the [Horizontal Pod Aut\", \"oscaler](https://docs.microsoft.com/azure/aks/tutorial-kubernetes-scale#autoscale-pods) monitors res\", \"ource demand and automatically scales your POD replicas to meet it. When traffic increases, addition\", \"al replicas are automatically provisioned to scale out your services. Likewise, when demand decrease\", \"s, they're removed to scale-in your services. You define the metric on which to scale, for example, \", \"CPU usage. You can also specify the minimum and maximum number of replicas to run. AKS monitors that\", \" metric and scales accordingly.\\n\\nNext, the [AKS Cluster Autoscaler](https://docs.microsoft.com/azure\", \"/aks/cluster-autoscaler) feature enables you to automatically scale compute nodes across a Kubernete\", \"s cluster to meet demand. With it, you can automatically add new VMs to the underlying Azure Virtual\", \" Machine Scale Set whenever more compute capacity of is required. It also removes nodes when no long\", \"er required.\\n\\nFigure 3-11 shows the relationship between these two scaling services.\\n\\n![](_page_63_F\", \"igure_8.jpeg)\\n\\n*Figure 3-11. Scaling out an App Service plan.*\\n\\nWorking together, both ensure an opt\", \"imal number of container instances and compute nodes to support fluctuating demand. The horizontal p\", \"od autoscaler optimizes the number of pods required. The cluster autoscaler optimizes the number of \", \"nodes required.\\n\\n#### **Scaling Azure Functions**\\n\\nAzure Functions automatically scale out upon dema\", \"nd. Server resources are dynamically allocated and removed based on the number of triggered events. \", \"You're only charged for compute resources consumed when your functions run. Billing is based upon th\", \"e number of executions, execution time, and memory used.\\n\\nWhile the default consumption plan provide\", \"s an economical and scalable solution for most apps, the premium option allows developers flexibilit\", \"y for custom Azure Functions requirements. Upgrading to the premium plan provides control over insta\", \"nce sizes, pre-warmed instances (to avoid cold start delays), and dedicated VMs.\\n\\n# <span id=\\\"page-6\", \"4-0\\\"></span>Other container deployment options\\n\\nAside from Azure Kubernetes Service (AKS), you can a\", \"lso deploy containers to Azure App Service for Containers and Azure Container Instances.\\n\\n#### <span\", \" id=\\\"page-64-1\\\"></span>**When does it make sense to deploy to App Service for Containers?**\\n\\nSimple \", \"production applications that don't require orchestration are well suited to Azure App Service for Co\", \"ntainers.\\n\\n#### <span id=\\\"page-64-2\\\"></span>**How to deploy to App Service for Containers**\\n\\nTo depl\", \"oy to [Azure App Service for Containers](https://azure.microsoft.com/services/app-service/containers\", \"/), you'll need an Azure Container Registry (ACR) instance and credentials to access it. Push your c\", \"ontainer image to the ACR repository so that your Azure App Service can pull it when needed. Once co\", \"mplete, you can configure the app for Continuous Deployment. Doing so will automatically deploy upda\", \"tes whenever the image changes in ACR.\\n\\n#### <span id=\\\"page-64-3\\\"></span>**When does it make sense t\", \"o deploy to Azure Container Instances?**\\n\\n[Azure Container Instances \\\\(ACI\\\\)](https://azure.microsof\", \"t.com/services/container-instances/) enables you to run Docker containers in a managed, serverless c\", \"loud environment, without having to set up virtual machines or clusters. It's a great solution for s\", \"hortrunning workloads that can run in an isolated container. Consider ACI for simple services, testi\", \"ng scenarios, task automation, and build jobs. ACI spins-up a container instance, performs the task,\", \" and then spins it down.\\n\\n#### <span id=\\\"page-64-4\\\"></span>**How to deploy an app to Azure Container\", \" Instances**\\n\\nTo deploy to [Azure Container Instances \\\\(ACI\\\\),](https://docs.microsoft.com/azure/con\", \"tainer-instances/) you need an Azure Container Registry (ACR) and credentials for accessing it. Once\", \" you push your container image to the repository, it's available to pull into ACI. You can work with\", \" ACI using the Azure portal or command-line interface. ACR provides tight integration with ACI. Figu\", \"re 3-12 shows how to push an individual container image to ACR.\\n\\n![](_page_65_Picture_0.jpeg)\\n\\n*Figu\", \"re 3-12. Azure Container Registry Run Instance*\\n\\nCreating an instance in ACI can be done quickly. Sp\", \"ecify the image registry, Azure resource group information, the amount of memory to allocate, and th\", \"e port on which to listen. This [quickstart shows](https://docs.microsoft.com/azure/container-instan\", \"ces/container-instances-quickstart-portal)  [how to deploy a container instance to ACI using the Azu\", \"re portal.](https://docs.microsoft.com/azure/container-instances/container-instances-quickstart-port\", \"al)\\n\\nOnce the deployment completes, find the newly deployed container's IP address and communicate w\", \"ith it over the port you specified.\\n\\nAzure Container Instances offers the fastest way to run simple \", \"container workloads in Azure. You don't need to configure an app service, orchestrator, or virtual m\", \"achine. For scenarios where you require full container orchestration, service discovery, automatic s\", \"caling, or coordinated upgrades, we recommend Azure Kubernetes Service (AKS).\\n\\n#### <span id=\\\"page-6\", \"5-0\\\"></span>**References**\\n\\n- [What is Kubernetes?](https://blog.newrelic.com/engineering/what-is-ku\", \"bernetes/)\\n- [Installing Kubernetes with Minikube](https://kubernetes.io/docs/setup/learning-environ\", \"ment/minikube/)\\n- [MiniKube vs Docker Desktop](https://medium.com/containers-101/local-kubernetes-fo\", \"r-windows-minikube-vs-docker-desktop-25a1c6d3b766)\\n- [Visual Studio Tools for Docker](https://docs.m\", \"icrosoft.com/dotnet/standard/containerized-lifecycle-architecture/design-develop-containerized-apps/\", \"visual-studio-tools-for-docker)\\n\\n- [Understanding serverless cold start](https://azure.microsoft.com\", \"/blog/understanding-serverless-cold-start/)\\n- [Pre-warmed Azure Functions instances](https://docs.mi\", \"crosoft.com/azure/azure-functions/functions-premium-plan#pre-warmed-instances)\\n- [Create a function \", \"on Linux using a custom image](https://docs.microsoft.com/azure/azure-functions/functions-create-fun\", \"ction-linux-custom-image)\\n- [Run Azure Functions in a Docker Container](https://markheath.net/post/a\", \"zure-functions-docker)\\n- [Create a function on Linux using a custom image](https://docs.microsoft.co\", \"m/azure/azure-functions/functions-create-function-linux-custom-image)\\n- [Azure Functions with Kubern\", \"etes Event Driven Autoscaling](https://docs.microsoft.com/azure/azure-functions/functions-kubernetes\", \"-keda)\\n- [Canary Release](https://martinfowler.com/bliki/CanaryRelease.html)\\n- [Azure Dev Spaces wit\", \"h VS Code](https://docs.microsoft.com/azure/dev-spaces/quickstart-netcore)\\n- [Azure Dev Spaces with \", \"Visual Studio](https://docs.microsoft.com/azure/dev-spaces/quickstart-netcore-visualstudio)\\n- [AKS M\", \"ultiple Node Pools](https://docs.microsoft.com/azure/aks/use-multiple-node-pools)\\n- [AKS Cluster Aut\", \"oscaler](https://docs.microsoft.com/azure/aks/cluster-autoscaler)\\n- [Tutorial: Scale applications in\", \" AKS](https://docs.microsoft.com/azure/aks/tutorial-kubernetes-scale)\\n- [Azure Functions scale and h\", \"osting](https://docs.microsoft.com/azure/azure-functions/functions-scale)\\n- [Azure Container Instanc\", \"es Docs](https://docs.microsoft.com/azure/container-instances/)\\n- [Deploy Container Instance from AC\", \"R](https://docs.microsoft.com/azure/container-instances/container-instances-using-azure-container-re\", \"gistry#deploy-with-azure-portal)\\n\\n**CHAPTER** 4\\n\\n# <span id=\\\"page-67-0\\\"></span>Cloud-native communic\", \"ation patterns\\n\\nWhen constructing a cloud-native system, communication becomes a significant design \", \"decision. How does a front-end client application communicate with a back-end microservice? How do b\", \"ack-end microservices communicate with each other? What are the principles, patterns, and best pract\", \"ices to consider when implementing communication in cloud-native applications?\\n\\n# <span id=\\\"page-67-\", \"1\\\"></span>Communication considerations\\n\\nIn a monolithic application, communication is straightforwar\", \"d. The code modules execute together in the same executable space (process) on a server. This approa\", \"ch can have performance advantages as everything runs together in shared memory, but results in tigh\", \"tly coupled code that becomes difficult to maintain, evolve, and scale.\\n\\nCloud-native systems implem\", \"ent a microservice-based architecture with many small, independent microservices. Each microservice \", \"executes in a separate process and typically runs inside a container that is deployed to a *cluster*\", \".\\n\\nA cluster groups a pool of virtual machines together to form a highly available environment. They\", \"'re managed with an orchestration tool, which is responsible for deploying and managing the containe\", \"rized microservices. Figure 4-1 shows a [Kubernetes](https://kubernetes.io/) cluster deployed into t\", \"he Azure cloud with the fully managed [Azure Kubernetes Services.](https://docs.microsoft.com/azure/\", \"aks/intro-kubernetes)\\n\\n![](_page_68_Picture_0.jpeg)\\n\\n*Figure 4-1. A Kubernetes cluster in Azure*\\n\\nAc\", \"ross the cluster, microservices communicate with each other through APIs and messaging technologies.\", \"\\n\\nWhile they provide many benefits, microservices are no free lunch. Local in-process method calls b\", \"etween components are now replaced with network calls. Each microservice must communicate over a net\", \"work protocol, which adds complexity to your system:\\n\\n- Network congestion, latency, and transient f\", \"aults are a constant concern.\\n- Resiliency (that is, retrying failed requests) is essential.\\n- Some \", \"calls must be [idempotent](https://www.restapitutorial.com/lessons/idempotency.html) as to keep cons\", \"istent state.\\n- Each microservice must authenticate and authorize calls.\\n- Each message must be seri\", \"alized and then deserialized which can be expensive.\\n- Message encryption/decryption becomes importa\", \"nt.\\n\\nThe book [.NET Microservices: Architecture for Containerized .NET Applications,](https://dotnet\", \".microsoft.com/download/thank-you/microservices-architecture-ebook) available for free from Microsof\", \"t, provides an in-depth coverage of communication patterns for microservice applications. In this ch\", \"apter, we provide a high-level overview of these patterns along with implementation options availabl\", \"e in the Azure cloud.\\n\\nIn this chapter, we'll first address communication between front-end applicat\", \"ions and back-end microservices. We'll then look at back-end microservices communicate with each oth\", \"er. We'll explore the up and gRPC communication technology. Finally, we'll look new innovative commu\", \"nication patterns using service mesh technology. We'll also see how the Azure cloud provides differe\", \"nt kinds of *backing services* to support cloud-native communication.\\n\\n# <span id=\\\"page-69-0\\\"></span\", \">Front-end client communication\\n\\nIn a cloud-native system, front-end clients (mobile, web, and deskt\", \"op applications) require a communication channel to interact with independent back-end microservices\", \".\\n\\nWhat are the options?\\n\\nTo keep things simple, a front-end client could *directly communicate* wit\", \"h the back-end microservices, shown in Figure 4-2.\\n\\n![](_page_69_Picture_5.jpeg)\\n\\n*Figure 4-2. Direc\", \"t client to service communication*\\n\\nWith this approach, each microservice has a public endpoint that\", \" is accessible by front-end clients. In a production environment, you'd place a load balancer in fro\", \"nt of the microservices, routing traffic proportionately.\\n\\nWhile simple to implement, direct client \", \"communication would be acceptable only for simple microservice applications. This pattern tightly co\", \"uples front-end clients to core back-end services, opening the door for many problems, including:\\n\\n-\", \" Client susceptibility to back-end service refactoring.\\n- A wider attack surface as core back-end se\", \"rvices are directly exposed.\\n- Duplication of cross-cutting concerns across each microservice.\\n- Ove\", \"rly complex client code clients must keep track of multiple endpoints and handle failures in a resil\", \"ient way.\\n\\nInstead, a widely accepted cloud design pattern is to implement an [API Gateway Service](\", \"https://docs.microsoft.com/dotnet/architecture/microservices/architect-microservice-container-applic\", \"ations/direct-client-to-microservice-communication-versus-the-api-gateway-pattern) between the front\", \"-end applications and back-end services. The pattern is shown in Figure 4-3.\\n\\n![](_page_70_Figure_1.\", \"jpeg)\\n\\n*Figure 4-3. API gateway pattern*\\n\\nIn the previous figure, note how the API Gateway service a\", \"bstracts the back-end core microservices. Implemented as a web API, it acts as a *reverse proxy*, ro\", \"uting incoming traffic to the internal microservices.\\n\\nThe gateway insulates the client from interna\", \"l service partitioning and refactoring. If you change a back-end service, you accommodate for it in \", \"the gateway without breaking the client. It's also your first line of defense for cross-cutting conc\", \"erns, such as identity, caching, resiliency, metering, and throttling. Many of these cross-cutting c\", \"oncerns can be off-loaded from the back-end core services to the gateway, simplifying the back-end s\", \"ervices.\\n\\nCare must be taken to keep the API Gateway simple and fast. Typically, business logic is k\", \"ept out of the gateway. A complex gateway risks becoming a bottleneck and eventually a monolith itse\", \"lf. Larger systems often expose multiple API Gateways segmented by client type (mobile, web, desktop\", \") or back-end functionality. The [Backend for Frontends](https://docs.microsoft.com/azure/architectu\", \"re/patterns/backends-for-frontends) pattern provides direction for implementing multiple gateways. T\", \"he pattern is shown in Figure 4-4.\\n\\n![](_page_71_Figure_0.jpeg)\\n\\n*Figure 4-4. Backend for frontend p\", \"attern*\\n\\nNote in the previous figure how incoming traffic is sent to a specific API gateway - based \", \"upon client type: web, mobile, or desktop app. This approach makes sense as the capabilities of each\", \" device differ significantly across form factor, performance, and display limitations. Typically mob\", \"ile applications expose less functionality than a browser or desktop applications. Each gateway can \", \"be optimized to match the capabilities and functionality of the corresponding device.\\n\\n#### <span id\", \"=\\\"page-71-0\\\"></span>**Simple Gateways**\\n\\nTo start, you could build your own API Gateway service. A q\", \"uick search of GitHub will provide many examples.\\n\\nFor simple .NET cloud-native applications, you mi\", \"ght consider the [Ocelot Gateway.](https://github.com/ThreeMammals/Ocelot) Open source and created f\", \"or .NET microservices, it's lightweight, fast, scalable. Like any API Gateway, its primary functiona\", \"lity is to forward incoming HTTP requests to downstream services. Additionally, it supports a wide v\", \"ariety of capabilities that are configurable in a .NET middleware pipeline.\\n\\n[YARP](https://github.c\", \"om/microsoft/reverse-proxy) (Yet Another Reverse proxy) is another open source reverse proxy led by \", \"a group of Microsoft product teams. Downloadable as a NuGet package, YARP plugs into the ASP.NET fra\", \"mework as middleware and is highly customizable. You'll find YARP [well-documented](https://microsof\", \"t.github.io/reverse-proxy/articles/getting-started.html) with various usage examples.\\n\\nFor enterpris\", \"e cloud-native applications, there are several managed Azure services that can help jump-start your \", \"efforts.\\n\\n#### <span id=\\\"page-72-0\\\"></span>**Azure Application Gateway**\\n\\nFor simple gateway require\", \"ments, you may consider [Azure Application Gateway.](https://docs.microsoft.com/azure/application-ga\", \"teway/overview) Available as an Azure [PaaS service,](https://azure.microsoft.com/overview/what-is-p\", \"aas/) it includes basic gateway features such as URL routing, SSL termination, and a Web Application\", \" Firewall. The service supports [Layer-7 load balancing](https://www.nginx.com/resources/glossary/la\", \"yer-7-load-balancing/) capabilities. With Layer 7, you can route requests based on the actual conten\", \"t of an HTTP message, not just low-level TCP network packets.\\n\\nThroughout this book, we evangelize h\", \"osting cloud-native systems in [Kubernetes.](https://www.infoworld.com/article/3268073/what-is-kuber\", \"netes-your-next-application-platform.html) A container orchestrator, Kubernetes automates the deploy\", \"ment, scaling, and operational concerns of containerized workloads. Azure Application Gateway can be\", \" configured as an API gateway for [Azure](https://azure.microsoft.com/services/kubernetes-service/) \", \" [Kubernetes Service](https://azure.microsoft.com/services/kubernetes-service/) cluster.\\n\\nThe [Appli\", \"cation Gateway Ingress Controller](https://azure.github.io/application-gateway-kubernetes-ingress/) \", \"enables Azure Application Gateway to work directly with [Azure Kubernetes Service.](https://azure.mi\", \"crosoft.com/services/kubernetes-service/) Figure 4.5 shows the architecture.\\n\\n![](_page_72_Figure_4.\", \"jpeg)\\n\\n*Figure 4-5. Application Gateway Ingress Controller*\\n\\nKubernetes includes a built-in feature \", \"that supports HTTP (Level 7) load balancing, called [Ingress.](https://kubernetes.io/docs/concepts/s\", \"ervices-networking/ingress/)  Ingress defines a set of rules for how microservice instances inside A\", \"KS can be exposed to the outside world. In the previous image, the ingress controller interprets the\", \" ingress rules configured for the cluster and automatically configures the Azure Application Gateway\", \". Based on those rules, the Application Gateway routes traffic to microservices running inside AKS. \", \"The ingress controller listens for changes to ingress rules and makes the appropriate changes to the\", \" Azure Application Gateway.\\n\\n### <span id=\\\"page-72-1\\\"></span>**Azure API Management**\\n\\nFor moderate \", \"to large-scale cloud-native systems, you may consider [Azure API Management](https://azure.microsoft\", \".com/services/api-management/). It's a cloud-based service that not only solves your API Gateway nee\", \"ds, but provides a full-featured developer and administrative experience. API Management is shown in\", \" Figure 4-6.\\n\\n![](_page_73_Picture_0.jpeg)\\n\\n*Figure 4-6. Azure API Management*\\n\\nTo start, API Manage\", \"ment exposes a gateway server that allows controlled access to back-end services based upon configur\", \"able rules and policies. These services can be in the Azure cloud, your on-prem data center, or othe\", \"r public clouds. API keys and JWT tokens determine who can do what. All traffic is logged for analyt\", \"ical purposes.\\n\\nFor developers, API Management offers a developer portal that provides access to ser\", \"vices, documentation, and sample code for invoking them. Developers can use Swagger/Open API to insp\", \"ect service endpoints and analyze their usage. The service works across the major development platfo\", \"rms: .NET, Java, Golang, and more.\\n\\nThe publisher portal exposes a management dashboard where admini\", \"strators expose APIs and manage their behavior. Service access can be granted, service health monito\", \"red, and service telemetry gathered. Administrators apply *policies* to each endpoint to affect beha\", \"vior. [Policies](https://docs.microsoft.com/azure/api-management/api-management-howto-policies) are \", \"pre-built statements that execute sequentially for each service call. Policies are configured for an\", \" inbound call, outbound call, or invoked upon an error. Policies can be applied at different service\", \" scopes as to enable deterministic ordering when combining policies. The product ships with a large \", \"number of prebuilt [policies.](https://docs.microsoft.com/azure/api-management/api-management-polici\", \"es)\\n\\nHere are examples of how policies can affect the behavior of your cloud-native services:\\n\\n- Res\", \"trict service access.\\n- Enforce authentication.\\n- Throttle calls from a single source, if necessary.\", \"\\n- Enable caching.\\n- Block calls from specific IP addresses.\\n\\n- Control the flow of the service.\\n- C\", \"onvert requests from SOAP to REST or between different data formats, such as from XML to JSON.\\n\\nAzur\", \"e API Management can expose back-end services that are hosted anywhere \\u2013 in the cloud or your data c\", \"enter. For legacy services that you may expose in your cloud-native systems, it supports both REST a\", \"nd SOAP APIs. Even other Azure services can be exposed through API Management. You could place a man\", \"aged API on top of an Azure backing service like [Azure Service Bus](https://azure.microsoft.com/ser\", \"vices/service-bus/) or [Azure Logic Apps.](https://azure.microsoft.com/services/logic-apps/)  Azure \", \"API Management doesn't include built-in load-balancing support and should be used in conjunction wit\", \"h a load-balancing service.\\n\\nAzure API Management is available across [four different tiers:](https:\", \"//azure.microsoft.com/pricing/details/api-management/)\\n\\n- Developer\\n- Basic\\n- Standard\\n- Premium\\n\\nTh\", \"e Developer tier is meant for non-production workloads and evaluation. The other tiers offer progres\", \"sively more power, features, and higher service level agreements (SLAs). The Premium tier provides [\", \"Azure Virtual Network](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview) a\", \"nd [multi-region support.](https://docs.microsoft.com/azure/api-management/api-management-howto-depl\", \"oy-multi-region) All tiers have a fixed price per hour.\\n\\nThe Azure cloud also offers a [serverless t\", \"ier](https://azure.microsoft.com/blog/announcing-azure-api-management-for-serverless-architectures/)\", \" for Azure API Management. Referred to as the *consumption pricing tier*, the service is a variant o\", \"f API Management designed around the serverless computing model. Unlike the \\\"pre-allocated\\\" pricing \", \"tiers previously shown, the consumption tier provides instant provisioning and pay-per-action pricin\", \"g.\\n\\nIt enables API Gateway features for the following use cases:\\n\\n- Microservices implemented using \", \"serverless technologies such as [Azure Functions](https://docs.microsoft.com/azure/azure-functions/f\", \"unctions-overview) and [Azure](https://azure.microsoft.com/services/logic-apps/)  [Logic Apps.](http\", \"s://azure.microsoft.com/services/logic-apps/)\\n- Azure backing service resources such as Service Bus \", \"queues and topics, Azure storage, and others.\\n- Microservices where traffic has occasional large spi\", \"kes but remains low most the time.\\n\\nThe consumption tier uses the same underlying service API Manage\", \"ment components, but employs an entirely different architecture based on dynamically allocated resou\", \"rces. It aligns perfectly with the serverless computing model:\\n\\n- No infrastructure to manage.\\n- No \", \"idle capacity.\\n- High-availability.\\n- Automatic scaling.\\n- Cost is based on actual usage.\\n\\nThe new c\", \"onsumption tier is a great choice for cloud-native systems that expose serverless resources as APIs.\", \"\\n\\n#### <span id=\\\"page-75-0\\\"></span>**Real-time communication**\\n\\nReal-time, or push, communication is\", \" another option for front-end applications that communicate with back-end cloud-native systems over \", \"HTTP. Applications, such as financial-tickers, online education, gaming, and job-progress updates, r\", \"equire instantaneous, real-time responses from the back-end. With normal HTTP communication, there's\", \" no way for the client to know when new data is available. The client must continually *poll* or sen\", \"d requests to the server. With *real-time* communication, the server can push new data to the client\", \" at any time.\\n\\nReal-time systems are often characterized by high-frequency data flows and large numb\", \"ers of concurrent client connections. Manually implementing real-time connectivity can quickly becom\", \"e complex, requiring non-trivial infrastructure to ensure scalability and reliable messaging to conn\", \"ected clients. You could find yourself managing an instance of Azure Redis Cache and a set of load b\", \"alancers configured with sticky sessions for client affinity.\\n\\n[Azure SignalR Service](https://azure\", \".microsoft.com/services/signalr-service/) is a fully managed Azure service that simplifies real-time\", \" communication for your cloud-native applications. Technical implementation details like capacity pr\", \"ovisioning, scaling, and persistent connections are abstracted away. They're handled for you with a \", \"99.9% service-level agreement. You focus on application features, not infrastructure plumbing.\\n\\nOnce\", \" enabled, a cloud-based HTTP service can push content updates directly to connected clients, includi\", \"ng browser, mobile and desktop applications. Clients are updated without the need to poll the server\", \". Azure SignalR abstracts the transport technologies that create real-time connectivity, including W\", \"ebSockets, Server-Side Events, and Long Polling. Developers focus on sending messages to all or spec\", \"ific subsets of connected clients.\\n\\nFigure 4-7 shows a set of HTTP Clients connecting to a Cloud-nat\", \"ive application with Azure SignalR enabled.\\n\\n![](_page_76_Picture_0.jpeg)\\n\\n*Figure 4-7. Azure Signal\", \"R*\\n\\nAnother advantage of Azure SignalR Service comes with implementing Serverless cloud-native servi\", \"ces. Perhaps your code is executed on demand with Azure Functions triggers. This scenario can be tri\", \"cky because your code doesn't maintain long connections with clients. Azure SignalR Service can hand\", \"le this situation since the service already manages connections for you.\\n\\nAzure SignalR Service clos\", \"ely integrates with other Azure services, such as Azure SQL Database, Service Bus, or Redis Cache, o\", \"pening up many possibilities for your cloud-native applications.\\n\\n# <span id=\\\"page-76-0\\\"></span>Serv\", \"ice-to-service communication\\n\\nMoving from the front-end client, we now address back-end microservice\", \"s communicate with each other.\\n\\nWhen constructing a cloud-native application, you'll want to be sens\", \"itive to how back-end services communicate with each other. Ideally, the less inter-service communic\", \"ation, the better. However, avoidance isn't always possible as back-end services often rely on one a\", \"nother to complete an operation.\\n\\nThere are several widely accepted approaches to implementing cross\", \"-service communication. The *type of communication interaction* will often determine the best approa\", \"ch.\\n\\nConsider the following interaction types:\\n\\n\\u2022 *Query* \\u2013 when a calling microservice requires a r\", \"esponse from a called microservice, such as, \\\"Hey, give me the buyer information for a given custome\", \"r Id.\\\"\\n\\n- *Command* when the calling microservice needs another microservice to execute an action bu\", \"t doesn't require a response, such as, \\\"Hey, just ship this order.\\\"\\n- *Event* when a microservice, c\", \"alled the publisher, raises an event that state has changed or an action has occurred. Other microse\", \"rvices, called subscribers, who are interested, can react to the event appropriately. The publisher \", \"and the subscribers aren't aware of each other.\\n\\nMicroservice systems typically use a combination of\", \" these interaction types when executing operations that require cross-service interaction. Let's tak\", \"e a close look at each and how you might implement them.\\n\\n#### <span id=\\\"page-77-0\\\"></span>**Queries\", \"**\\n\\nMany times, one microservice might need to *query* another, requiring an immediate response to c\", \"omplete an operation. A shopping basket microservice may need product information and a price to add\", \" an item to its basket. There are many approaches for implementing query operations.\\n\\n#### **Request\", \"/Response Messaging**\\n\\nOne option for implementing this scenario is for the calling back-end microse\", \"rvice to make direct HTTP requests to the microservices it needs to query, shown in Figure 4-8.\\n\\n![]\", \"(_page_77_Figure_7.jpeg)\\n\\n*Figure 4-8. Direct HTTP communication*\\n\\nWhile direct HTTP calls between m\", \"icroservices are relatively simple to implement, care should be taken to minimize this practice. To \", \"start, these calls are always *synchronous* and will block the operation until a result is returned \", \"or the request times outs. What were once self-contained, independent services, able to evolve indep\", \"endently and deploy frequently, now become coupled to each other. As coupling among microservices in\", \"crease, their architectural benefits diminish.\\n\\nExecuting an infrequent request that makes a single \", \"direct HTTP call to another microservice might be acceptable for some systems. However, high-volume \", \"calls that invoke direct HTTP calls to multiple microservices aren't advisable. They can increase la\", \"tency and negatively impact the performance, scalability, and availability of your system. Even wors\", \"e, a long series of direct HTTP communication can lead to deep and complex chains of synchronous mic\", \"roservices calls, shown in Figure 4-9:\\n\\n![](_page_78_Figure_1.jpeg)\\n\\n*Figure 4-9. Chaining HTTP quer\", \"ies*\\n\\nYou can certainly imagine the risk in the design shown in the previous image. What happens if \", \"Step #3 fails? Or Step #8 fails? How do you recover? What if Step #6 is slow because the underlying \", \"service is busy? How do you continue? Even if all works correctly, think of the latency this call wo\", \"uld incur, which is the sum of the latency of each step.\\n\\nThe large degree of coupling in the previo\", \"us image suggests the services weren't optimally modeled. It would behoove the team to revisit their\", \" design.\\n\\n#### **Materialized View pattern**\\n\\nA popular option for removing microservice coupling is\", \" the [Materialized View pattern.](https://docs.microsoft.com/azure/architecture/patterns/materialize\", \"d-view) With this pattern, a microservice stores its own local, denormalized copy of data that's own\", \"ed by other services. Instead of the Shopping Basket microservice querying the Product Catalog and P\", \"ricing microservices, it maintains its own local copy of that data. This pattern eliminates unnecess\", \"ary coupling and improves reliability and response time. The entire operation executes inside a sing\", \"le process. We explore this pattern and other data concerns in Chapter 5.\\n\\n#### **Service Aggregator\", \" Pattern**\\n\\nAnother option for eliminating microservice-to-microservice coupling is an [Aggregator m\", \"icroservice,](https://devblogs.microsoft.com/cesardelatorre/designing-and-implementing-api-gateways-\", \"with-ocelot-in-a-microservices-and-container-based-architecture/)  shown in purple in Figure 4-10.\\n\\n\", \"![](_page_79_Figure_0.jpeg)\\n\\n*Figure 4-10. Aggregator microservice*\\n\\nThe pattern isolates an operati\", \"on that makes calls to multiple back-end microservices, centralizing its logic into a specialized mi\", \"croservice. The purple checkout aggregator microservice in the previous figure orchestrates the work\", \"flow for the Checkout operation. It includes calls to several back-end microservices in a sequenced \", \"order. Data from the workflow is aggregated and returned to the caller. While it still implements di\", \"rect HTTP calls, the aggregator microservice reduces direct dependencies among back-end microservice\", \"s.\\n\\n#### **Request/Reply Pattern**\\n\\nAnother approach for decoupling synchronous HTTP messages is a [\", \"Request-Reply Pattern,](https://www.enterpriseintegrationpatterns.com/patterns/messaging/RequestRepl\", \"y.html) which uses queuing communication. Communication using a queue is always a one-way channel, w\", \"ith a producer sending the message and consumer receiving it. With this pattern, both a request queu\", \"e and response queue are implemented, shown in Figure 4-11.\\n\\n![](_page_80_Figure_0.jpeg)\\n\\n*Figure 4-\", \"11. Request-reply pattern*\\n\\nHere, the message producer creates a query-based message that contains a\", \" unique correlation ID and places it into a request queue. The consuming service dequeues the messag\", \"es, processes it and places the response into the response queue with the same correlation ID. The p\", \"roducer service dequeues the message, matches it with the correlation ID and continues processing. W\", \"e cover queues in detail in the next section.\\n\\n#### <span id=\\\"page-80-0\\\"></span>**Commands**\\n\\nAnothe\", \"r type of communication interaction is a *command*. A microservice may need another microservice to \", \"perform an action. The Ordering microservice may need the Shipping microservice to create a shipment\", \" for an approved order. In Figure 4-12, one microservice, called a Producer, sends a message to anot\", \"her microservice, the Consumer, commanding it to do something.\\n\\n![](_page_81_Figure_0.jpeg)\\n\\n*Figure\", \" 4-12. Command interaction with a queue*\\n\\nMost often, the Producer doesn't require a response and ca\", \"n *fire-and-forget* the message. If a reply is needed, the Consumer sends a separate message back to\", \" Producer on another channel. A command message is best sent asynchronously with a message queue. su\", \"pported by a lightweight message broker. In the previous diagram, note how a queue separates and dec\", \"ouples both services.\\n\\nA message queue is an intermediary construct through which a producer and con\", \"sumer pass a message. Queues implement an asynchronous, point-to-point messaging pattern. The Produc\", \"er knows where a command needs to be sent and routes appropriately. The queue guarantees that a mess\", \"age is processed by exactly one of the consumer instances that are reading from the channel. In this\", \" scenario, either the producer or consumer service can scale out without affecting the other. As wel\", \"l, technologies can be disparate on each side, meaning that we might have a Java microservice callin\", \"g a [Golang](https://golang.org/) microservice.\\n\\nIn chapter 1, we talked about *backing services*. B\", \"acking services are ancillary resources upon which cloud-native systems depend. Message queues are b\", \"acking services. The Azure cloud supports two types of message queues that your cloud-native systems\", \" can consume to implement command messaging: Azure Storage Queues and Azure Service Bus Queues.\\n\\n###\", \"# **Azure Storage Queues**\\n\\nAzure storage queues offer a simple queueing infrastructure that is fast\", \", affordable, and backed by Azure storage accounts.\\n\\n[Azure Storage Queues](https://docs.microsoft.c\", \"om/azure/storage/queues/storage-queues-introduction) feature a REST-based queuing mechanism with rel\", \"iable and persistent messaging. They provide a minimal feature set, but are inexpensive and store mi\", \"llions of messages. Their capacity ranges up to 500 TB. A single message can be up to 64 KB in size.\", \"\\n\\nYou can access messages from anywhere in the world via authenticated calls using HTTP or HTTPS. St\", \"orage queues can scale out to large numbers of concurrent clients to handle traffic spikes.\\n\\nThat sa\", \"id, there are limitations with the service:\\n\\n- Message order isn't guaranteed.\\n- A message can only \", \"persist for seven days before it's automatically removed.\\n- Support for state management, duplicate \", \"detection, or transactions isn't available.\\n\\nFigure 4-13 shows the hierarchy of an Azure Storage Que\", \"ue.\\n\\n![](_page_82_Figure_5.jpeg)\\n\\n*Figure 4-13. Storage queue hierarchy*\\n\\nIn the previous figure, no\", \"te how storage queues store their messages in the underlying Azure Storage account.\\n\\nFor developers,\", \" Microsoft provides several client and server-side libraries for Storage queue processing. Most majo\", \"r platforms are supported including .NET, Java, JavaScript, Ruby, Python, and Go. Developers should \", \"never communicate directly with these libraries. Doing so will tightly couple your microservice code\", \" to the Azure Storage Queue service. It's a better practice to insulate the implementation details o\", \"f the API. Introduce an intermediation layer, or intermediate API, that exposes generic operations a\", \"nd encapsulates the concrete library. This loose coupling enables you to swap out one queuing servic\", \"e for another without having to make changes to the mainline service code.\\n\\nAzure Storage queues are\", \" an economical option to implement command messaging in your cloudnative applications. Especially wh\", \"en a queue size will exceed 80 GB, or a simple feature set is acceptable. You only pay for the stora\", \"ge of the messages; there are no fixed hourly charges.\\n\\n#### **Azure Service Bus Queues**\\n\\nFor more \", \"complex messaging requirements, consider Azure Service Bus queues.\\n\\nSitting atop a robust message in\", \"frastructure, [Azure Service Bus](https://docs.microsoft.com/azure/service-bus-messaging/service-bus\", \"-messaging-overview) supports a *brokered messaging model*. Messages are reliably stored in a broker\", \" (the queue) until received by the consumer. The queue guarantees First-In/First-Out (FIFO) message \", \"delivery, respecting the order in which messages were added to the queue.\\n\\nThe size of a message can\", \" be much larger, up to 256 KB. Messages are persisted in the queue for an unlimited period of time. \", \"Service Bus supports not only HTTP-based calls, but also provides full\\n\\nsupport for the [AMQP protoc\", \"ol.](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-amqp-overview) AMQP is an op\", \"en-standard across vendors that supports a binary protocol and higher degrees of reliability.\\n\\nServi\", \"ce Bus provides a rich set of features, including [transaction support](https://docs.microsoft.com/a\", \"zure/service-bus-messaging/service-bus-transactions) and a [duplicate detection](https://docs.micros\", \"oft.com/azure/service-bus-messaging/duplicate-detection)  [feature](https://docs.microsoft.com/azure\", \"/service-bus-messaging/duplicate-detection). The queue guarantees \\\"at most once delivery\\\" per messag\", \"e. It automatically discards a message that has already been sent. If a producer is in doubt, it can\", \" resend the same message, and Service Bus guarantees that only one copy will be processed. Duplicate\", \" detection frees you from having to build additional infrastructure plumbing.\\n\\nTwo more enterprise f\", \"eatures are partitioning and sessions. A conventional Service Bus queue is handled by a single messa\", \"ge broker and stored in a single message store. But, [Service Bus Partitioning](https://docs.microso\", \"ft.com/azure/service-bus-messaging/service-bus-partitioning) spreads the queue across multiple messa\", \"ge brokers and message stores. The overall throughput is no longer limited by the performance of a s\", \"ingle message broker or messaging store. A temporary outage of a messaging store doesn't render a pa\", \"rtitioned queue unavailable.\\n\\n[Service Bus Sessions](https://codingcanvas.com/azure-service-bus-sess\", \"ions/) provide a way to group-related messages. Imagine a workflow scenario where messages must be p\", \"rocessed together and the operation completed at the end. To take advantage, sessions must be explic\", \"itly enabled for the queue and each related messaged must contain the same session ID.\\n\\nHowever, the\", \"re are some important caveats: Service Bus queues size is limited to 80 GB, which is much smaller th\", \"an what's available from store queues. Additionally, Service Bus queues incur a base cost and charge\", \" per operation.\\n\\nFigure 4-14 outlines the high-level architecture of a Service Bus queue.\\n\\n![](_page\", \"_83_Picture_6.jpeg)\\n\\n*Figure 4-14. Service Bus queue*\\n\\nIn the previous figure, note the point-to-poi\", \"nt relationship. Two instances of the same provider are enqueuing messages into a single Service Bus\", \" queue. Each message is consumed by only one of three consumer instances on the right. Next, we disc\", \"uss how to implement messaging where different consumers may all be interested the same message.\\n\\n##\", \"## <span id=\\\"page-83-0\\\"></span>**Events**\\n\\nMessage queuing is an effective way to implement communic\", \"ation where a producer can asynchronously send a consumer a message. However, what happens when *man\", \"y different consumers* are interested in the same message? A dedicated message queue for each consum\", \"er wouldn't scale well and would become difficult to manage.\\n\\nTo address this scenario, we move to t\", \"he third type of message interaction, the *event*. One microservice announces that an action had occ\", \"urred. Other microservices, if interested, react to the action, or event. This is also known as the \", \"[event-driven architectural style.](https://docs.microsoft.com/azure/architecture/guide/architecture\", \"-styles/event-driven)\\n\\nEventing is a two-step process. For a given state change, a microservice publ\", \"ishes an event to a message broker, making it available to any other interested microservice. The in\", \"terested microservice is notified by subscribing to the event in the message broker. You use the [Pu\", \"blish/Subscribe](https://docs.microsoft.com/azure/architecture/patterns/publisher-subscriber) patter\", \"n to implement [event-based communication.](https://docs.microsoft.com/dotnet/standard/microservices\", \"-architecture/multi-container-microservice-net-applications/integration-event-based-microservice-com\", \"munications)\\n\\nFigure 4-15 shows a shopping basket microservice publishing an event with two other mi\", \"croservices subscribing to it.\\n\\n![](_page_84_Picture_4.jpeg)\\n\\n*Figure 4-15. Event-Driven messaging*\\n\", \"\\nNote the *event bus* component that sits in the middle of the communication channel. It's a custom \", \"class that encapsulates the message broker and decouples it from the underlying application. The ord\", \"ering and inventory microservices independently operate the event with no knowledge of each other, n\", \"or the shopping basket microservice. When the registered event is published to the event bus, they a\", \"ct upon it.\\n\\nWith eventing, we move from queuing technology to *topics*. A [topic](https://docs.micr\", \"osoft.com/azure/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions) is similar\", \" to a queue, but supports a one-to-many messaging pattern. One microservice publishes a message. Mul\", \"tiple subscribing microservices can choose to receive and act upon that message. Figure 4-16 shows a\", \" topic architecture.\\n\\n![](_page_85_Figure_0.jpeg)\\n\\n*Figure 4-16. Topic architecture*\\n\\nIn the previou\", \"s figure, publishers send messages to the topic. At the end, subscribers receive messages from subsc\", \"riptions. In the middle, the topic forwards messages to subscriptions based on a set of rules, shown\", \" in dark blue boxes. Rules act as a filter that forward specific messages to a subscription. Here, a\", \" \\\"GetPrice\\\" event would be sent to the price and logging subscriptions as the logging subscription h\", \"as chosen to receive all messages. A \\\"GetInformation\\\" event would be sent to the information and log\", \"ging subscriptions.\\n\\nThe Azure cloud supports two different topic services: Azure Service Bus Topics\", \" and Azure EventGrid.\\n\\n#### **Azure Service Bus Topics**\\n\\nSitting on top of the same robust brokered\", \" message model of Azure Service Bus queues are [Azure](https://docs.microsoft.com/azure/service-bus-\", \"messaging/service-bus-dotnet-how-to-use-topics-subscriptions)  [Service Bus Topics.](https://docs.mi\", \"crosoft.com/azure/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions) A topic \", \"can receive messages from multiple independent publishers and send messages to up to 2,000 subscribe\", \"rs. Subscriptions can be dynamically added or removed at run time without stopping the system or rec\", \"reating the topic.\\n\\nMany advanced features from Azure Service Bus queues are also available for topi\", \"cs, including [Duplicate Detection](https://docs.microsoft.com/azure/service-bus-messaging/duplicate\", \"-detection) and [Transaction support.](https://docs.microsoft.com/azure/service-bus-messaging/servic\", \"e-bus-transactions) By default, Service Bus topics are handled by a single message broker and stored\", \" in a single message store. But, [Service Bus Partitioning](https://docs.microsoft.com/azure/service\", \"-bus-messaging/service-bus-partitioning) scales a topic by spreading it across many message brokers \", \"and message stores.\\n\\n[Scheduled Message Delivery](https://docs.microsoft.com/azure/service-bus-messa\", \"ging/message-sequencing) tags a message with a specific time for processing. The message won't appea\", \"r in the topic before that time. [Message Deferral](https://docs.microsoft.com/azure/service-bus-mes\", \"saging/message-deferral) enables you to defer a retrieval of a message to a later time. Both are com\", \"monly used in workflow processing scenarios where operations are processed in a particular order. Yo\", \"u can postpone processing of received messages until prior work has been completed.\\n\\nService Bus top\", \"ics are a robust and proven technology for enabling publish/subscribe communication in your cloud-na\", \"tive systems.\\n\\n#### **Azure Event Grid**\\n\\nWhile Azure Service Bus is a battle-tested messaging broke\", \"r with a full set of enterprise features, [Azure Event Grid](https://docs.microsoft.com/azure/event-\", \"grid/overview) is the new kid on the block.\\n\\nAt first glance, Event Grid may look like just another \", \"topic-based messaging system. However, it's different in many ways. Focused on event-driven workload\", \"s, it enables real-time event processing, deep Azure integration, and an open-platform - all on serv\", \"erless infrastructure. It's designed for contemporary cloud-native and serverless applications\\n\\nAs a\", \" centralized *eventing backplane*, or pipe, Event Grid reacts to events inside Azure resources and f\", \"rom your own services.\\n\\nEvent notifications are published to an Event Grid Topic, which, in turn, ro\", \"utes each event to a subscription. Subscribers map to subscriptions and consume the events. Like Ser\", \"vice Bus, Event Grid supports a *filtered subscriber model* where a subscription sets rule for the e\", \"vents it wishes to receive. Event Grid provides fast throughput with a guarantee of 10 million event\", \"s per second enabling near real-time delivery - far more than what Azure Service Bus can generate.\\n\\n\", \"A sweet spot for Event Grid is its deep integration into the fabric of Azure infrastructure. An Azur\", \"e resource, such as Cosmos DB, can publish built-in events directly to other interested Azure resour\", \"ces without the need for custom code. Event Grid can publish events from an Azure Subscription, Reso\", \"urce Group, or Service, giving developers fine-grained control over the lifecycle of cloud resources\", \". However, Event Grid isn't limited to Azure. It's an open platform that can consume custom HTTP eve\", \"nts published from applications or third-party services and route events to external subscribers.\\n\\nW\", \"hen publishing and subscribing to native events from Azure resources, no coding is required. With si\", \"mple configuration, you can integrate events from one Azure resource to another leveraging built-in \", \"plumbing for Topics and Subscriptions. Figure 4-17 shows the anatomy of Event Grid.\\n\\n![](_page_86_Fi\", \"gure_5.jpeg)\\n\\n*Figure 4-17. Event Grid anatomy*\\n\\nA major difference between EventGrid and Service Bu\", \"s is the underlying *message exchange pattern*.\\n\\nService Bus implements an older style *pull model* \", \"in which the downstream subscriber actively polls the topic subscription for new messages. On the up\", \"side, this approach gives the subscriber full control of the pace at which it processes messages. It\", \" controls when and how many messages to process at any given time. Unread messages remain in the sub\", \"scription until processed. A significant shortcoming is the latency between the time the event is ge\", \"nerated and the polling operation that pulls that message to the subscriber for processing. Also, th\", \"e overhead of constant polling for the next event consumes resources and money.\\n\\nEventGrid, however,\", \" is different. It implements a *push model* in which events are sent to the EventHandlers as receive\", \"d, giving near real-time event delivery. It also reduces cost as the service is triggered only when \", \"it's needed to consume an event \\u2013 not continually as with polling. That said, an event handler must \", \"handle the incoming load and provide throttling mechanisms to protect itself from becoming overwhelm\", \"ed. Many Azure services that consume these events, such as Azure Functions and Logic Apps provide au\", \"tomatic autoscaling capabilities to handle increased loads.\\n\\nEvent Grid is a fully managed serverles\", \"s cloud service. It dynamically scales based on your traffic and charges you only for your actual us\", \"age, not pre-purchased capacity. The first 100,000 operations per month are free \\u2013 operations being \", \"defined as event ingress (incoming event notifications), subscription delivery attempts, management \", \"calls, and filtering by subject. With 99.99% availability, EventGrid guarantees the delivery of an e\", \"vent within a 24-hour period, with built-in retry functionality for unsuccessful delivery. Undeliver\", \"ed messages can be moved to a \\\"dead-letter\\\" queue for resolution. Unlike Azure Service Bus, Event Gr\", \"id is tuned for fast performance and doesn't support features like ordered messaging, transactions, \", \"and sessions.\\n\\n#### **Streaming messages in the Azure cloud**\\n\\nAzure Service Bus and Event Grid prov\", \"ide great support for applications that expose single, discrete events like a new document has been \", \"inserted into a Cosmos DB. But, what if your cloud-native system needs to process a *stream of relat\", \"ed events*? [Event streams](https://docs.microsoft.com/archive/msdn-magazine/2015/february/microsoft\", \"-azure-the-rise-of-event-stream-oriented-systems) are more complex. They're typically time-ordered, \", \"interrelated, and must be processed as a group.\\n\\n[Azure Event Hub](https://azure.microsoft.com/servi\", \"ces/event-hubs/) is a data streaming platform and event ingestion service that collects, transforms,\", \" and stores events. It's fine-tuned to capture streaming data, such as continuous event notification\", \"s emitted from a telemetry context. The service is highly scalable and can store and [process millio\", \"ns of](https://docs.microsoft.com/azure/event-hubs/event-hubs-about)  [events per second.](https://d\", \"ocs.microsoft.com/azure/event-hubs/event-hubs-about) Shown in Figure 4-18, it's often a front door f\", \"or an event pipeline, decoupling ingest stream from event consumption.\\n\\n![](_page_88_Figure_0.jpeg)\\n\", \"\\n*Figure 4-18. Azure Event Hub*\\n\\nEvent Hub supports low latency and configurable time retention. Unl\", \"ike queues and topics, Event Hubs keep event data after it's been read by a consumer. This feature e\", \"nables other data analytic services, both internal and external, to replay the data for further anal\", \"ysis. Events stored in event hub are only deleted upon expiration of the retention period, which is \", \"one day by default, but configurable.\\n\\nEvent Hub supports common event publishing protocols includin\", \"g HTTPS and AMQP. It also supports Kafka 1.0. [Existing Kafka applications can communicate with Even\", \"t Hub](https://docs.microsoft.com/azure/event-hubs/event-hubs-for-kafka-ecosystem-overview) using th\", \"e Kafka protocol providing an alternative to managing large Kafka clusters. Many open-source cloud-n\", \"ative systems embrace Kafka.\\n\\nEvent Hubs implements message streaming through a [partitioned consume\", \"r model](https://docs.microsoft.com/azure/event-hubs/event-hubs-features) in which each consumer onl\", \"y reads a specific subset, or partition, of the message stream. This pattern enables tremendous hori\", \"zontal scale for event processing and provides other stream-focused features that are unavailable in\", \" queues and topics. A partition is an ordered sequence of events that is held in an event hub. As ne\", \"wer events arrive, they're added to the end of this sequence. Figure 4-19 shows partitioning in an E\", \"vent Hub.\\n\\n![](_page_88_Figure_5.jpeg)\\n\\n*Figure 4-19. Event Hub partitioning*\\n\\nInstead of reading fr\", \"om the same resource, each consumer group reads across a subset, or partition, of the message stream\", \".\\n\\nFor cloud-native applications that must stream large numbers of events, Azure Event Hub can be a \", \"robust and affordable solution.\\n\\n# <span id=\\\"page-89-0\\\"></span>gRPC\\n\\nSo far in this book, we've focu\", \"sed on [REST-based](https://docs.microsoft.com/azure/architecture/best-practices/api-design) communi\", \"cation. We've seen that REST is a flexible architectural style that defines CRUD-based operations ag\", \"ainst entity resources. Clients interact with resources across HTTP with a request/response communic\", \"ation model. While REST is widely implemented, a newer communication technology, gRPC, has gained tr\", \"emendous momentum across the cloud-native community.\\n\\n#### <span id=\\\"page-89-1\\\"></span>**What is gRP\", \"C?**\\n\\ngRPC is a modern, high-performance framework that evolves the age-old [remote procedure call \\\\\", \"(RPC\\\\)](https://en.wikipedia.org/wiki/Remote_procedure_call) protocol. At the application level, gRP\", \"C streamlines messaging between clients and back-end services. Originating from Google, gRPC is open\", \" source and part of the [Cloud Native Computing Foundation](https://www.cncf.io/)  [\\\\(CNCF\\\\)](https:\", \"//www.cncf.io/) ecosystem of cloud-native offerings. CNCF considers gRPC an [incubating project.](ht\", \"tps://github.com/cncf/toc/blob/main/process/graduation_criteria.md) Incubating means end users are u\", \"sing the technology in production applications, and the project has a healthy number of contributors\", \".\\n\\nA typical gRPC client app will expose a local, in-process function that implements a business ope\", \"ration. Under the covers, that local function invokes another function on a remote machine. What app\", \"ears to be a local call essentially becomes a transparent out-of-process call to a remote service. T\", \"he RPC plumbing abstracts the point-to-point networking communication, serialization, and execution \", \"between computers.\\n\\nIn cloud-native applications, developers often work across programming languages\", \", frameworks, and technologies. This *interoperability* complicates message contracts and the plumbi\", \"ng required for cross-platform communication. gRPC provides a \\\"uniform horizontal layer\\\" that abstra\", \"cts these concerns. Developers code in their native platform focused on business functionality, whil\", \"e gRPC handles communication plumbing.\\n\\ngRPC offers comprehensive support across most popular develo\", \"pment stacks, including Java, JavaScript, C#, Go, Swift, and NodeJS.\\n\\n#### <span id=\\\"page-89-2\\\"></sp\", \"an>**gRPC Benefits**\\n\\ngRPC uses HTTP/2 for its transport protocol. While compatible with HTTP 1.1, H\", \"TTP/2 features many advanced capabilities:\\n\\n- A binary framing protocol for data transport unlike HT\", \"TP 1.1, which is text based.\\n- Multiplexing support for sending multiple parallel requests over the \", \"same connection HTTP 1.1 limits processing to one request/response message at a time.\\n- Bidirectiona\", \"l full-duplex communication for sending both client requests and server responses simultaneously.\\n- \", \"Built-in streaming enabling requests and responses to asynchronously stream large data sets.\\n- Heade\", \"r compression that reduces network usage.\\n\\ngRPC is lightweight and highly performant. It can be up t\", \"o 8x faster than JSON serialization with messages 60-80% smaller. In Microsoft [Windows Communicatio\", \"n Foundation \\\\(WCF\\\\)](https://docs.microsoft.com/dotnet/framework/wcf/whats-wcf) parlance, gRPC perf\", \"ormance exceeds the speed and efficiency of the highly optimized [NetTCP bindings.](https://docs.mic\", \"rosoft.com/dotnet/api/system.servicemodel.nettcpbinding?view=netframework-4.8&preserve-view=true) Un\", \"like NetTCP, which favors the Microsoft stack, gRPC is cross-platform.\\n\\n#### <span id=\\\"page-90-0\\\"></\", \"span>**Protocol Buffers**\\n\\ngRPC embraces an open-source technology called [Protocol Buffers.](https:\", \"//developers.google.com/protocol-buffers/docs/overview) They provide a highly efficient and platform\", \"-neutral serialization format for serializing structured messages that services send to each other. \", \"Using a cross-platform Interface Definition Language (IDL), developers define a service contract for\", \" each microservice. The contract, implemented as a text-based .proto file, describes the methods, in\", \"puts, and outputs for each service. The same contract file can be used for gRPC clients and services\", \" built on different development platforms.\\n\\nUsing the proto file, the Protobuf compiler, protoc, gen\", \"erates both client and service code for your target platform. The code includes the following compon\", \"ents:\\n\\n- Strongly typed objects, shared by the client and service, that represent the service operat\", \"ions and data elements for a message.\\n- A strongly typed base class with the required network plumbi\", \"ng that the remote gRPC service can inherit and extend.\\n- A client stub that contains the required p\", \"lumbing to invoke the remote gRPC service.\\n\\nAt run time, each message is serialized as a standard Pr\", \"otobuf representation and exchanged between the client and remote service. Unlike JSON or XML, Proto\", \"buf messages are serialized as compiled binary bytes.\\n\\nThe book, [gRPC for WCF Developers,](https://\", \"docs.microsoft.com/dotnet/architecture/grpc-for-wcf-developers/) available from the Microsoft Archit\", \"ecture site, provides in-depth coverage of gRPC and Protocol Buffers.\\n\\n#### <span id=\\\"page-90-1\\\"></s\", \"pan>**gRPC support in .NET**\\n\\ngRPC is integrated into .NET Core 3.0 SDK and later. The following too\", \"ls support it:\\n\\n- Visual Studio 2022 with the ASP.NET and web development workload installed\\n- Visua\", \"l Studio Code\\n- The dotnet CLI\\n\\nThe SDK includes tooling for endpoint routing, built-in IoC, and log\", \"ging. The open-source Kestrel web server supports HTTP/2 connections. Figure 4-20 shows a Visual Stu\", \"dio 2022 template that scaffolds a skeleton project for a gRPC service. Note how .NET fully supports\", \" Windows, Linux, and macOS.\\n\\n![](_page_91_Figure_0.jpeg)\\n\\n*Figure 4-20. gRPC support in Visual Studi\", \"o 2022*\\n\\nFigure 4-21 shows the skeleton gRPC service generated from the built-in scaffolding include\", \"d in Visual Studio 2022.\\n\\n![](_page_91_Picture_3.jpeg)\\n\\n*Figure 4-21. gRPC project in Visual Studio \", \"2022*\\n\\nIn the previous figure, note the proto description file and service code. As you'll see short\", \"ly, Visual Studio generates additional configuration in both the Startup class and underlying projec\", \"t file.\\n\\n#### <span id=\\\"page-91-0\\\"></span>**gRPC usage**\\n\\nFavor gRPC for the following scenarios:\\n\\n-\", \" Synchronous backend microservice-to-microservice communication where an immediate response is requi\", \"red to continue processing.\\n- Polyglot environments that need to support mixed programming platforms\", \".\\n- Low latency and high throughput communication where performance is critical.\\n- Point-to-point re\", \"al-time communication gRPC can push messages in real time without polling and has excellent support \", \"for bi-directional streaming.\\n\\n\\u2022 Network constrained environments \\u2013 binary gRPC messages are always \", \"smaller than an equivalent text-based JSON message.\\n\\nAt the time, of this writing, gRPC is primarily\", \" used with backend services. Modern browsers can't provide the level of HTTP/2 control required to s\", \"upport a front-end gRPC client. That said, there's support for [gRPC-Web with .NET](https://devblogs\", \".microsoft.com/aspnet/grpc-web-for-net-now-available/) that enables gRPC communication from browser-\", \"based apps built with JavaScript or Blazor WebAssembly technologies. [gRPC-Web](https://github.com/g\", \"rpc/grpc/blob/master/doc/PROTOCOL-WEB.md) enables an ASP.NET Core gRPC app to support gRPC features \", \"in browser apps:\\n\\n- Strongly typed, code-generated clients\\n- Compact Protobuf messages\\n- Server stre\", \"aming\\n\\n#### <span id=\\\"page-92-0\\\"></span>**gRPC implementation**\\n\\nThe microservice reference architec\", \"ture, [eShop on Containers,](https://github.com/dotnet-architecture/eShopOnContainers) from Microsof\", \"t, shows how to implement gRPC services in .NET applications. Figure 4-22 presents the back-end arch\", \"itecture.\\n\\n![](_page_92_Figure_7.jpeg)\\n\\n*Figure 4-22. Backend architecture for eShop on Containers*\\n\", \"\\nIn the previous figure, note how eShop embraces the [Backend for Frontends pattern](https://docs.mi\", \"crosoft.com/azure/architecture/patterns/backends-for-frontends) (BFF) by exposing multiple API gatew\", \"ays. We discussed the BFF pattern earlier in this chapter. Pay close attention to the Aggregator mic\", \"roservice (in gray) that sits between the Web-Shopping API Gateway and backend Shopping microservice\", \"s. The Aggregator receives a single request from a client, dispatches it to various microservices, a\", \"ggregates the results, and sends them back to the requesting client. Such operations typically requi\", \"re synchronous communication as to produce an immediate response. In eShop, backend calls from the A\", \"ggregator are performed using gRPC as shown in Figure 4-23.\\n\\n![](_page_93_Figure_1.jpeg)\\n\\n*Figure 4-\", \"23. gRPC in eShop on Containers*\\n\\ngRPC communication requires both client and server components. In \", \"the previous figure, note how the Shopping Aggregator implements a gRPC client. The client makes syn\", \"chronous gRPC calls (in red) to backend microservices, each of which implement a gRPC server. Both t\", \"he client and server take advantage of the built-in gRPC plumbing from the .NET SDK. Client-side *st\", \"ubs* provide the plumbing to invoke remote gRPC calls. Server-side components provide gRPC plumbing \", \"that custom service classes can inherit and consume.\\n\\nMicroservices that expose both a RESTful API a\", \"nd gRPC communication require multiple endpoints to manage traffic. You would open an endpoint that \", \"listens for HTTP traffic for the RESTful calls and another for gRPC calls. The gRPC endpoint must be\", \" configured for the HTTP/2 protocol that is required for gRPC communication.\\n\\nWhile we strive to dec\", \"ouple microservices with asynchronous communication patterns, some operations require direct calls. \", \"gRPC should be the primary choice for direct synchronous communication between microservices. Its hi\", \"gh-performance communication protocol, based on HTTP/2 and protocol buffers, make it a perfect choic\", \"e.\\n\\n#### <span id=\\\"page-94-0\\\"></span>**Looking ahead**\\n\\nLooking ahead, gRPC will continue to gain tr\", \"action for cloud-native systems. The performance benefits and ease of development are compelling. Ho\", \"wever, REST will likely be around for a long time. It excels for publicly exposed APIs and for backw\", \"ard compatibility reasons.\\n\\n# <span id=\\\"page-94-1\\\"></span>Service Mesh communication infrastructure\\n\", \"\\nThroughout this chapter, we've explored the challenges of microservice communication. We said that \", \"development teams need to be sensitive to how back-end services communicate with each other. Ideally\", \", the less inter-service communication, the better. However, avoidance isn't always possible as back\", \"-end services often rely on one another to complete operations.\\n\\nWe explored different approaches fo\", \"r implementing synchronous HTTP communication and asynchronous messaging. In each of the cases, the \", \"developer is burdened with implementing communication code. Communication code is complex and time i\", \"ntensive. Incorrect decisions can lead to significant performance issues.\\n\\nA more modern approach to\", \" microservice communication centers around a new and rapidly evolving technology entitled *Service M\", \"esh*. A [service mesh](https://www.nginx.com/blog/what-is-a-service-mesh/) is a configurable infrast\", \"ructure layer with built-in capabilities to handle service-to-service communication, resiliency, and\", \" many cross-cutting concerns. It moves the responsibility for these concerns out of the microservice\", \"s and into service mesh layer. Communication is abstracted away from your microservices.\\n\\nA key comp\", \"onent of a service mesh is a proxy. In a cloud-native application, an instance of a proxy is typical\", \"ly colocated with each microservice. While they execute in separate processes, the two are closely l\", \"inked and share the same lifecycle. This pattern, known as the [Sidecar pattern,](https://docs.micro\", \"soft.com/azure/architecture/patterns/sidecar) and is shown in Figure 4-24.\\n\\n![](_page_94_Figure_7.jp\", \"eg)\\n\\n*Figure 4-24. Service mesh with a side car*\\n\\nNote in the previous figure how messages are inter\", \"cepted by a proxy that runs alongside each microservice. Each proxy can be configured with traffic r\", \"ules specific to the microservice. It understands messages and can route them across your services a\", \"nd the outside world.\\n\\nAlong with managing service-to-service communication, the Service Mesh provid\", \"es support for service discovery and load balancing.\\n\\nOnce configured, a service mesh is highly func\", \"tional. The mesh retrieves a corresponding pool of instances from a service discovery endpoint. It s\", \"ends a request to a specific service instance, recording the latency and response type of the result\", \". It chooses the instance most likely to return a fast response based on different factors, includin\", \"g the observed latency for recent requests.\\n\\nA service mesh manages traffic, communication, and netw\", \"orking concerns at the application level. It understands messages and requests. A service mesh typic\", \"ally integrates with a container orchestrator. Kubernetes supports an extensible architecture in whi\", \"ch a service mesh can be added.\\n\\nIn chapter 6, we deep-dive into Service Mesh technologies including\", \" a discussion on its architecture and available open-source implementations.\\n\\n#### <span id=\\\"page-95\", \"-0\\\"></span>**Summary**\\n\\nIn this chapter, we discussed cloud-native communication patterns. We starte\", \"d by examining how front-end clients communicate with back-end microservices. Along the way, we talk\", \"ed about API Gateway platforms and real-time communication. We then looked at how microservices comm\", \"unicate with other back-end services. We looked at both synchronous HTTP communication and asynchron\", \"ous messaging across services. We covered gRPC, an upcoming technology in the cloudnative world. Fin\", \"ally, we introduced a new and rapidly evolving technology entitled Service Mesh that can streamline \", \"microservice communication.\\n\\nSpecial emphasis was on managed Azure services that can help implement \", \"communication in cloudnative systems:\\n\\n- [Azure Application Gateway](https://docs.microsoft.com/azur\", \"e/application-gateway/overview)\\n- [Azure API Management](https://azure.microsoft.com/services/api-ma\", \"nagement/)\\n- [Azure SignalR Service](https://azure.microsoft.com/services/signalr-service/)\\n- [Azure\", \" Storage Queues](https://docs.microsoft.com/azure/storage/queues/storage-queues-introduction)\\n- [Azu\", \"re Service Bus](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overvie\", \"w)\\n- [Azure Event Grid](https://docs.microsoft.com/azure/event-grid/overview)\\n- [Azure Event Hub](ht\", \"tps://azure.microsoft.com/services/event-hubs/)\\n\\nWe next move to distributed data in cloud-native sy\", \"stems and the benefits and challenges that it presents.\\n\\n#### **References**\\n\\n- [.NET Microservices:\", \" Architecture for Containerized .NET applications](https://dotnet.microsoft.com/download/thank-you/m\", \"icroservices-architecture-ebook)\\n- [Designing Interservice Communication for Microservices](https://\", \"docs.microsoft.com/azure/architecture/microservices/design/interservice-communication)\\n- [Azure Sign\", \"alR Service, a fully managed service to add real-time functionality](https://azure.microsoft.com/blo\", \"g/azure-signalr-service-a-fully-managed-service-to-add-real-time-functionality/)\\n\\n- [Azure API Gatew\", \"ay Ingress Controller](https://azure.github.io/application-gateway-kubernetes-ingress/)\\n- [gRPC Docu\", \"mentation](https://grpc.io/docs/guides/)\\n- [gRPC for WCF Developers](https://docs.microsoft.com/dotn\", \"et/architecture/grpc-for-wcf-developers/)\\n- [Comparing gRPC Services with HTTP APIs](https://docs.mi\", \"crosoft.com/aspnet/core/grpc/comparison?view=aspnetcore-3.0&preserve-view=false)\\n- [Building gRPC Se\", \"rvices with .NET video](https://docs.microsoft.com/Shows/The-Cloud-Native-Show/Building-Microservice\", \"s-with-gRPC-and-NET)\\n\\n# <span id=\\\"page-97-0\\\"></span>Cloud-native data patterns\\n\\nAs we've seen throug\", \"hout this book, a cloud-native approach changes the way you design, deploy, and manage applications.\", \" It also changes the way you manage and store data.\\n\\nFigure 5-1 contrasts the differences.\\n\\n![](_pag\", \"e_97_Picture_4.jpeg)\\n\\n*Figure 5-1. Data management in cloud-native applications*\\n\\nExperienced develo\", \"pers will easily recognize the architecture on the left-side of figure 5-1. In this *monolithic appl\", \"ication*, business service components collocate together in a shared services tier, sharing data fro\", \"m a single relational database.\\n\\nIn many ways, a single database keeps data management simple. Query\", \"ing data across multiple tables is straightforward. Changes to data update together or they all roll\", \"back. [ACID transactions](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) guarant\", \"ee strong and immediate consistency.\\n\\nDesigning for cloud-native, we take a different approach. On t\", \"he right-side of Figure 5-1, note how business functionality segregates into small, independent micr\", \"oservices. Each microservice encapsulates a specific business capability and its own data. The monol\", \"ithic database decomposes\\n\\ninto a distributed data model with many smaller databases, each aligning \", \"with a microservice. When the smoke clears, we emerge with a design that exposes a *database per mic\", \"roservice*.\\n\\n# <span id=\\\"page-98-0\\\"></span>Database-per-microservice, why?\\n\\nThis database per micros\", \"ervice provides many benefits, especially for systems that must evolve rapidly and support massive s\", \"cale. With this model\\u2026\\n\\n- Domain data is encapsulated within the service\\n- Data schema can evolve wi\", \"thout directly impacting other services\\n- Each data store can independently scale\\n- A data store fai\", \"lure in one service won't directly impact other services\\n\\nSegregating data also enables each microse\", \"rvice to implement the data store type that is best optimized for its workload, storage needs, and r\", \"ead/write patterns. Choices include relational, document, key-value, and even graph-based data store\", \"s.\\n\\nFigure 5-2 presents the principle of polyglot persistence in a cloud-native system.\\n\\n![](_page_9\", \"8_Figure_9.jpeg)\\n\\n*Figure 5-2. Polyglot data persistence*\\n\\nNote in the previous figure how each micr\", \"oservice supports a different type of data store.\\n\\n- The product catalog microservice consumes a rel\", \"ational database to accommodate the rich relational structure of its underlying data.\\n- The shopping\", \" cart microservice consumes a distributed cache that supports its simple, keyvalue data store.\\n- The\", \" ordering microservice consumes both a NoSql document database for write operations along with a hig\", \"hly denormalized key/value store to accommodate high-volumes of read operations.\\n\\nWhile relational d\", \"atabases remain relevant for microservices with complex data, NoSQL databases have gained considerab\", \"le popularity. They provide massive scale and high availability. Their schemaless nature allows deve\", \"lopers to move away from an architecture of typed data classes and ORMs that make change expensive a\", \"nd time-consuming. We cover NoSQL databases later in this chapter.\\n\\nWhile encapsulating data into se\", \"parate microservices can increase agility, performance, and scalability, it also presents many chall\", \"enges. In the next section, we discuss these challenges along with patterns and practices to help ov\", \"ercome them.\\n\\n# <span id=\\\"page-99-0\\\"></span>Cross-service queries\\n\\nWhile microservices are independe\", \"nt and focus on specific functional capabilities, like inventory, shipping, or ordering, they freque\", \"ntly require integration with other microservices. Often the integration involves one microservice *\", \"querying* another for data. Figure 5-3 shows the scenario.\\n\\n![](_page_99_Picture_4.jpeg)\\n\\n*Figure 5-\", \"3. Querying across microservices*\\n\\nIn the preceding figure, we see a shopping basket microservice th\", \"at adds an item to a user's shopping basket. While the data store for this microservice contains bas\", \"ket and line item data, it doesn't maintain product or pricing data. Instead, those data items are o\", \"wned by the catalog and pricing microservices. This aspect presents a problem. How can the shopping \", \"basket microservice add a product to the user's shopping basket when it doesn't have product nor pri\", \"cing data in its database?\\n\\nOne option discussed in Chapter 4 is a [direct HTTP call](#page-77-0) fr\", \"om the shopping basket to the catalog and pricing microservices. However, in chapter 4, we said sync\", \"hronous HTTP calls *couple* microservices together, reducing their autonomy and diminishing their ar\", \"chitectural benefits.\\n\\nWe could also implement a request-reply pattern with separate inbound and out\", \"bound queues for each service. However, this pattern is complicated and requires plumbing to correla\", \"te request and response messages. While it does decouple the backend microservice calls, the calling\", \" service must still synchronously wait for the call to complete. Network congestion, transient fault\", \"s, or an overloaded microservice and can result in long-running and even failed operations.\\n\\nInstead\", \", a widely accepted pattern for removing cross-service dependencies is the [Materialized View](https\", \"://docs.microsoft.com/azure/architecture/patterns/materialized-view)  [Pattern,](https://docs.micros\", \"oft.com/azure/architecture/patterns/materialized-view) shown in Figure 5-4.\\n\\n![](_page_100_Figure_1.\", \"jpeg)\\n\\n*Figure 5-4. Materialized View Pattern*\\n\\nWith this pattern, you place a local data table (kno\", \"wn as a *read model*) in the shopping basket service. This table contains a denormalized copy of the\", \" data needed from the product and pricing microservices. Copying the data directly into the shopping\", \" basket microservice eliminates the need for expensive cross-service calls. With the data local to t\", \"he service, you improve the service's response time and reliability. Additionally, having its own co\", \"py of the data makes the shopping basket service more resilient. If the catalog service should becom\", \"e unavailable, it wouldn't directly impact the shopping basket service. The shopping basket can cont\", \"inue operating with the data from its own store.\\n\\nThe catch with this approach is that you now have \", \"duplicate data in your system. However, *strategically* duplicating data in cloud-native systems is \", \"an established practice and not considered an anti-pattern, or bad practice. Keep in mind that *one \", \"and only one service* can own a data set and have authority over it. You'll need to synchronize the \", \"read models when the system of record is updated. Synchronization is typically implemented via async\", \"hronous messaging with a [publish/subscribe](#page-83-0)  [pattern,](#page-83-0) as shown in Figure \", \"5.4.\\n\\n# <span id=\\\"page-100-0\\\"></span>Distributed transactions\\n\\nWhile querying data across microservi\", \"ces is difficult, implementing a transaction across several microservices is even more complex. The \", \"inherent challenge of maintaining data consistency across independent data sources in different micr\", \"oservices can't be understated. The lack of distributed transactions in cloud-native applications me\", \"ans that you must manage distributed transactions programmatically. You move from a world of *immedi\", \"ate consistency* to that of *eventual consistency*.\\n\\nFigure 5-5 shows the problem.\\n\\n![](_page_101_Fi\", \"gure_0.jpeg)\\n\\n*Figure 5-5. Implementing a transaction across microservices*\\n\\nIn the preceding figure\", \", five independent microservices participate in a distributed transaction that creates an order. Eac\", \"h microservice maintains its own data store and implements a local transaction for its store. To cre\", \"ate the order, the local transaction for *each* individual microservice must succeed, or *all* must \", \"abort and roll back the operation. While built-in transactional support is available inside each of \", \"the microservices, there's no support for a distributed transaction that would span across all five \", \"services to keep data consistent.\\n\\nInstead, you must construct this distributed transaction *program\", \"matically*.\\n\\nA popular pattern for adding distributed transactional support is the Saga pattern. It'\", \"s implemented by grouping local transactions together programmatically and sequentially invoking eac\", \"h one. If any of the local transactions fail, the Saga aborts the operation and invokes a set of [co\", \"mpensating](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction)  [trans\", \"actions.](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction) The compe\", \"nsating transactions undo the changes made by the preceding local transactions and restore data cons\", \"istency. Figure 5-6 shows a failed transaction with the Saga pattern.\\n\\n![](_page_101_Figure_5.jpeg)\\n\", \"\\n*Figure 5-6. Rolling back a transaction*\\n\\nIn the previous figure, the *Update Inventory* operation \", \"has failed in the Inventory microservice. The Saga invokes a set of compensating transactions (in re\", \"d) to adjust the inventory counts, cancel the payment and the order, and return the data for each mi\", \"croservice back to a consistent state.\\n\\nSaga patterns are typically choreographed as a series of rel\", \"ated events, or orchestrated as a set of related commands. In Chapter 4, we discussed the service ag\", \"gregator pattern that would be the foundation for an orchestrated saga implementation. We also discu\", \"ssed eventing along with Azure Service Bus and Azure Event Grid topics that would be a foundation fo\", \"r a choreographed saga implementation.\\n\\n# <span id=\\\"page-102-0\\\"></span>High volume data\\n\\nLarge cloud\", \"-native applications often support high-volume data requirements. In these scenarios, traditional da\", \"ta storage techniques can cause bottlenecks. For complex systems that deploy on a large scale, both \", \"Command and Query Responsibility Segregation (CQRS) and Event Sourcing may improve application perfo\", \"rmance.\\n\\n#### <span id=\\\"page-102-1\\\"></span>**CQRS**\\n\\n[CQRS,](https://docs.microsoft.com/azure/archit\", \"ecture/patterns/cqrs) is an architectural pattern that can help maximize performance, scalability, a\", \"nd security. The pattern separates operations that read data from those operations that write data.\\n\", \"\\nFor normal scenarios, the same entity model and data repository object are used for *both* read and\", \" write operations.\\n\\nHowever, a high volume data scenario can benefit from separate models and data t\", \"ables for reads and writes. To improve performance, the read operation could query against a highly \", \"denormalized representation of the data to avoid expensive repetitive table joins and table locks. T\", \"he *write* operation, known as a *command*, would update against a fully normalized representation o\", \"f the data that would guarantee consistency. You then need to implement a mechanism to keep both rep\", \"resentations in sync. Typically, whenever the write table is modified, it publishes an event that re\", \"plicates the modification to the read table.\\n\\nFigure 5-7 shows an implementation of the CQRS pattern\", \".\\n\\n![](_page_102_Figure_9.jpeg)\\n\\n*Figure 5-7. CQRS implementation*\\n\\nIn the previous figure, separate\", \" command and query models are implemented. Each data write operation is saved to the write store and\", \" then propagated to the read store. Pay close attention to how the data propagation process operates\", \" on the principle of [eventual consistency.](https://www.cloudcomputingpatterns.org/eventual_consist\", \"ency/) The read model eventually synchronizes with the write model, but there may be some lag in the\", \" process. We discuss eventual consistency in the next section.\\n\\nThis separation enables reads and wr\", \"ites to scale independently. Read operations use a schema optimized for queries, while the writes us\", \"e a schema optimized for updates. Read queries go against denormalized data, while complex business \", \"logic can be applied to the write model. As well, you might impose tighter security on write operati\", \"ons than those exposing reads.\\n\\nImplementing CQRS can improve application performance for cloud-nati\", \"ve services. However, it does result in a more complex design. Apply this principle carefully and st\", \"rategically to those sections of your cloud-native application that will benefit from it. For more o\", \"n CQRS, see the Microsoft book [.NET](https://docs.microsoft.com/dotnet/architecture/microservices/m\", \"icroservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns)  [Microservices: Arch\", \"itecture for Containerized .NET Applications.](https://docs.microsoft.com/dotnet/architecture/micros\", \"ervices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns)\\n\\n#### <span \", \"id=\\\"page-103-0\\\"></span>**Event sourcing**\\n\\nAnother approach to optimizing high volume data scenarios\", \" involves [Event Sourcing.](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing)\\n\\n\", \"A system typically stores the current state of a data entity. If a user changes their phone number, \", \"for example, the customer record is updated with the new number. We always know the current state of\", \" a data entity, but each update overwrites the previous state.\\n\\nIn most cases, this model works fine\", \". In high volume systems, however, overhead from transactional locking and frequent update operation\", \"s can impact database performance, responsiveness, and limit scalability.\\n\\nEvent Sourcing takes a di\", \"fferent approach to capturing data. Each operation that affects data is persisted to an event store.\", \" Instead of updating the state of a data record, we append each change to a sequential list of past \", \"events - similar to an accountant's ledger. The Event Store becomes the system of record for the dat\", \"a. It's used to propagate various materialized views within the bounded context of a microservice. F\", \"igure 5.8 shows the pattern.\\n\\n![](_page_104_Figure_0.jpeg)\\n\\n*Figure 5-8. Event Sourcing*\\n\\nIn the pre\", \"vious figure, note how each entry (in blue) for a user's shopping cart is appended to an underlying \", \"event store. In the adjoining materialized view, the system projects the current state by replaying \", \"all the events associated with each shopping cart. This view, or read model, is then exposed back to\", \" the UI. Events can also be integrated with external systems and applications or queried to determin\", \"e the current state of an entity. With this approach, you maintain history. You know not only the cu\", \"rrent state of an entity, but also how you reached this state.\\n\\nMechanically speaking, event sourcin\", \"g simplifies the write model. There are no updates or deletes. Appending each data entry as an immut\", \"able event minimizes contention, locking, and concurrency conflicts associated with relational datab\", \"ases. Building read models with the materialized view pattern enables you to decouple the view from \", \"the write model and choose the best data store to optimize the needs of your application UI.\\n\\nFor th\", \"is pattern, consider a data store that directly supports event sourcing. Azure Cosmos DB, MongoDB, C\", \"assandra, CouchDB, and RavenDB are good candidates.\\n\\nAs with all patterns and technologies, implemen\", \"t strategically and when needed. While event sourcing can provide increased performance and scalabil\", \"ity, it comes at the expense of complexity and a learning curve.\\n\\n# <span id=\\\"page-105-0\\\"></span>Rel\", \"ational vs. NoSQL data\\n\\nRelational and NoSQL are two types of database systems commonly implemented \", \"in cloud-native apps. They're built differently, store data differently, and accessed differently. I\", \"n this section, we'll look at both. Later in this chapter, we'll look at an emerging database techno\", \"logy called *NewSQL*.\\n\\n*Relational databases* have been a prevalent technology for decades. They're \", \"mature, proven, and widely implemented. Competing database products, tooling, and expertise abound. \", \"Relational databases provide a store of related data tables. These tables have a fixed schema, use S\", \"QL (Structured Query Language) to manage data, and support ACID guarantees.\\n\\n*No-SQL databases* refe\", \"r to high-performance, non-relational data stores. They excel in their ease-ofuse, scalability, resi\", \"lience, and availability characteristics. Instead of joining tables of normalized data, NoSQL stores\", \" unstructured or semi-structured data, often in key-value pairs or JSON documents. No-SQL databases \", \"typically don't provide ACID guarantees beyond the scope of a single database partition. High volume\", \" services that require sub second response time favor NoSQL datastores.\\n\\nThe impact of [NoSQL](https\", \"://www.geeksforgeeks.org/introduction-to-nosql/) technologies for distributed cloud-native systems c\", \"an't be overstated. The proliferation of new data technologies in this space has disrupted solutions\", \" that once exclusively relied on relational databases.\\n\\nNoSQL databases include several different mo\", \"dels for accessing and managing data, each suited to specific use cases. Figure 5-9 presents four co\", \"mmon models.\\n\\n![](_page_105_Figure_6.jpeg)\\n\\n*Figure 5-9: Data models for NoSQL databases*\\n\\n| Model  \", \"           | Characteristics                                                                        \", \"         |\\n|-------------------|--------------------------------------------------------------------\", \"-----------------------------|\\n| Document Store    | Data and metadata are stored hierarchically in<\", \"br>JSON-based documents inside the database.     |\\n| Key Value Store   | The simplest of the NoSQL d\", \"atabases, data is<br>represented as a collection of key-value pairs. |\\n| Wide-Column Store | Related\", \" data is stored as a set of nested<br>key/value pairs within a single column.            |\\n| Graph S\", \"tore       | Data is stored in a graph structure as node,<br>edge, and data properties.             \", \"         |\\n\\n#### <span id=\\\"page-106-0\\\"></span>**The CAP theorem**\\n\\nAs a way to understand the differ\", \"ences between these types of databases, consider the CAP theorem, a set of principles applied to dis\", \"tributed systems that store state. Figure 5-10 shows the three properties of the CAP theorem.\\n\\n![](_\", \"page_106_Picture_2.jpeg)\\n\\n*Figure 5-10. The CAP theorem*\\n\\nThe theorem states that distributed data s\", \"ystems will offer a trade-off between consistency, availability, and partition tolerance. And, that \", \"any database can only guarantee *two* of the three properties:\\n\\n- *Consistency.* Every node in the c\", \"luster responds with the most recent data, even if the system must block the request until all repli\", \"cas update. If you query a \\\"consistent system\\\" for an item that is currently updating, you'll wait f\", \"or that response until all replicas successfully update. However, you'll receive the most current da\", \"ta.\\n- *Availability.* Every node returns an immediate response, even if that response isn't the most\", \" recent data. If you query an \\\"available system\\\" for an item that is updating, you'll get the best p\", \"ossible answer the service can provide at that moment.\\n- *Partition Tolerance.* Guarantees the syste\", \"m continues to operate even if a replicated data node fails or loses connectivity with other replica\", \"ted data nodes.\\n\\nCAP theorem explains the tradeoffs associated with managing consistency and availab\", \"ility during a network partition; however tradeoffs with respect to consistency and performance also\", \" exist with the absence of a network partition. CAP theorem is often further extended to [PACELC](ht\", \"tp://www.cs.umd.edu/~abadi/papers/abadi-pacelc.pdf) to explain the tradeoffs more comprehensively.\\n\\n\", \"Relational databases typically provide consistency and availability, but not partition tolerance. Th\", \"ey're typically provisioned to a single server and scale vertically by adding more resources to the \", \"machine.\\n\\nMany relational database systems support built-in replication features where copies of the\", \" primary database can be made to other secondary server instances. Write operations are made to the \", \"primary instance and replicated to each of the secondaries. Upon a failure, the primary instance can\", \" fail over to a secondary to provide high availability. Secondaries can also be used to distribute r\", \"ead operations. While writes operations always go against the primary replica, read operations can b\", \"e routed to any of the secondaries to reduce system load.\\n\\nData can also be horizontally partitioned\", \" across multiple nodes, such as with [sharding.](https://docs.microsoft.com/azure/sql-database/sql-d\", \"atabase-elastic-scale-introduction) But, sharding dramatically increases operational overhead by spi\", \"tting data across many pieces that cannot easily communicate. It can be costly and time consuming to\", \" manage. Relational features that include table joins, transactions, and referential integrity requi\", \"re steep performance penalties in sharded deployments.\\n\\nReplication consistency and recovery point o\", \"bjectives can be tuned by configuring whether replication occurs synchronously or asynchronously. If\", \" data replicas were to lose network connectivity in a \\\"highly consistent\\\" or synchronous relational \", \"database cluster, you wouldn't be able to write to the database. The system would reject the write o\", \"peration as it can't replicate that change to the other data replica. Every data replica has to upda\", \"te before the transaction can complete.\\n\\nNoSQL databases typically support high availability and par\", \"tition tolerance. They scale out horizontally, often across commodity servers. This approach provide\", \"s tremendous availability, both within and across geographical regions at a reduced cost. You partit\", \"ion and replicate data across these machines, or nodes, providing redundancy and fault tolerance. Co\", \"nsistency is typically tuned through consensus protocols or quorum mechanisms. They provide more con\", \"trol when navigating tradeoffs between tuning synchronous versus asynchronous replication in relatio\", \"nal systems.\\n\\nIf data replicas were to lose connectivity in a \\\"highly available\\\" NoSQL database clus\", \"ter, you could still complete a write operation to the database. The database cluster would allow th\", \"e write operation and update each data replica as it becomes available. NoSQL databases that support\", \" multiple writable replicas can further strengthen high availability by avoiding the need for failov\", \"er when optimizing recovery time objective.\\n\\nModern NoSQL databases typically implement partitioning\", \" capabilities as a feature of their system design. Partition management is often built-in to the dat\", \"abase, and routing is achieved through placement hints - often called partition keys. A flexible dat\", \"a models enables the NoSQL databases to lower the burden of schema management and improve availabili\", \"ty when deploying application updates that require data model changes.\\n\\nHigh availability and massiv\", \"e scalability are often more critical to the business than relational table joins and referential in\", \"tegrity. Developers can implement techniques and patterns such as Sagas, CQRS, and asynchronous mess\", \"aging to embrace eventual consistency.\\n\\nNowadays, care must be taken when considering the CAP theore\", \"m constraints. A new type of database, called NewSQL, has emerged which extends the relational datab\", \"ase engine to support both horizontal scalability and the scalable performance of NoSQL systems.\\n\\n##\", \"## <span id=\\\"page-108-0\\\"></span>**Considerations for relational vs. NoSQL systems**\\n\\nBased upon spec\", \"ific data requirements, a cloud-native-based microservice can implement a relational, NoSQL datastor\", \"e or both.\\n\\n| Consider a NoSQL datastore when:                                                      \", \"                                                                                                    \", \"   | Consider a relational database when:                                               |\\n|---------\", \"----------------------------------------------------------------------------------------------------\", \"---------------------------------------------------------------------------------|------------------\", \"------------------------------------------------------------------|\\n| You have high volume workloads\", \" that require<br>predictable latency at large scale (for example,<br>latency measured in millisecond\", \"s while<br>performing millions of transactions per second) | Your workload volume generally fits wit\", \"hin<br>thousands of transactions per second |\\n| Your data is dynamic and frequently changes         \", \"                                                                                                    \", \"                                     | Your data is highly structured and requires<br>referential in\", \"tegrity               |\\n| Relationships can be de-normalized data<br>models                         \", \"                                                                                                    \", \"               | Relationships are expressed through table joins<br>on normalized data models       \", \"|\\n| Data retrieval is simple and expressed without<br>table joins                                   \", \"                                                                                             | You w\", \"ork with complex queries and reports                                          |\\n| Data is typically \", \"replicated across geographies<br>and requires finer control over consistency,<br>availability, and p\", \"erformance                                                             | Data is typically centraliz\", \"ed, or can be replicated<br>regions asynchronously      |\\n| Your application will be deployed to com\", \"modity<br>hardware, such as with public clouds                                                      \", \"                                                 | Your application will be deployed to large, high<\", \"br>end hardware                   |\\n\\nIn the next sections, we'll explore the options available in th\", \"e Azure cloud for storing and managing your cloud-native data.\\n\\n#### <span id=\\\"page-108-1\\\"></span>**\", \"Database as a Service**\\n\\nTo start, you could provision an Azure virtual machine and install your dat\", \"abase of choice for each service. While you'd have full control over the environment, you'd forgo ma\", \"ny built-in features of the cloud platform. You'd also be responsible for managing the virtual machi\", \"ne and database for each service. This approach could quickly become time-consuming and expensive.\\n\\n\", \"Instead, cloud-native applications favor data services exposed as a Database as a Service (DBaaS). F\", \"ully managed by a cloud vendor, these services provide built-in security, scalability, and monitorin\", \"g. Instead of owning the service, you simply consume it as a [backing service.](#page-24-0) The prov\", \"ider operates the resource at scale and bears the responsibility for performance and maintenance.\\n\\nT\", \"hey can be configured across cloud availability zones and regions to achieve high availability. They\", \" all support just-in-time capacity and a pay-as-you-go model. Azure features different kinds of mana\", \"ged data service options, each with specific benefits.\\n\\nWe'll first look at relational DBaaS service\", \"s available in Azure. You'll see that Microsoft's flagship SQL Server database is available along wi\", \"th several open-source options. Then, we'll talk about the NoSQL data services in Azure.\\n\\n#### <span\", \" id=\\\"page-109-0\\\"></span>**Azure relational databases**\\n\\nFor cloud-native microservices that require \", \"relational data, Azure offers four managed relational databases as a service (DBaaS) offerings, show\", \"n in Figure 5-11.\\n\\n![](_page_109_Figure_2.jpeg)\\n\\n*Figure 5-11. Managed relational databases availabl\", \"e in Azure*\\n\\nIn the previous figure, note how each sits upon a common DBaaS infrastructure which fea\", \"tures key capabilities at no additional cost.\\n\\nThese features are especially important to organizati\", \"ons who provision large numbers of databases, but have limited resources to administer them. You can\", \" provision an Azure database in minutes by selecting the amount of processing cores, memory, and und\", \"erlying storage. You can scale the database on-the-fly and dynamically adjust resources with little \", \"to no downtime.\\n\\n#### <span id=\\\"page-109-1\\\"></span>**Azure SQL Database**\\n\\nDevelopment teams with ex\", \"pertise in Microsoft SQL Server should consider [Azure SQL Database](https://docs.microsoft.com/azur\", \"e/sql-database/). It's a fully managed relational database-as-a-service (DBaaS) based on the Microso\", \"ft SQL Server Database Engine. The service shares many features found in the on-premises version of \", \"SQL Server and runs the latest stable version of the SQL Server Database Engine.\\n\\nFor use with a clo\", \"ud-native microservice, Azure SQL Database is available with three deployment options:\\n\\n- A Single D\", \"atabase represents a fully managed SQL Database running on an [Azure SQL](https://docs.microsoft.com\", \"/azure/sql-database/sql-database-servers)  [Database server](https://docs.microsoft.com/azure/sql-da\", \"tabase/sql-database-servers) in the Azure cloud. The database is considered *[contained](https://doc\", \"s.microsoft.com/sql/relational-databases/databases/contained-databases)* as it has no configuration \", \"dependencies on the underlying database server.\\n- A [Managed Instance](https://docs.microsoft.com/az\", \"ure/sql-database/sql-database-managed-instance) is a fully managed instance of the Microsoft SQL Ser\", \"ver Database Engine that provides near-100% compatibility with an on-premises SQL Server. This optio\", \"n supports larger databases, up to 35 TB and is placed in an [Azure Virtual Network](https://docs.mi\", \"crosoft.com/azure/virtual-network/virtual-networks-overview) for better isolation.\\n\\n\\u2022 [Azure SQL Dat\", \"abase serverless](https://docs.microsoft.com/azure/sql-database/sql-database-serverless) is a comput\", \"e tier for a single database that automatically scales based on workload demand. It bills only for t\", \"he amount of compute used per second. The service is well suited for workloads with intermittent, un\", \"predictable usage patterns, interspersed with periods of inactivity. The serverless compute tier als\", \"o automatically pauses databases during inactive periods so that only storage charges are billed. It\", \" automatically resumes when activity returns.\\n\\nBeyond the traditional Microsoft SQL Server stack, Az\", \"ure also features managed versions of three popular open-source databases.\\n\\n#### <span id=\\\"page-110-\", \"0\\\"></span>**Open-source databases in Azure**\\n\\nOpen-source relational databases have become a popular\", \" choice for cloud-native applications. Many enterprises favor them over commercial database products\", \", especially for cost savings. Many development teams enjoy their flexibility, community-backed deve\", \"lopment, and ecosystem of tools and extensions. Open-source databases can be deployed across multipl\", \"e cloud providers, helping minimize the concern of \\\"vendor lock-in.\\\"\\n\\nDevelopers can easily self-hos\", \"t any open-source database on an Azure VM. While providing full control, this approach puts you on t\", \"he hook for the management, monitoring, and maintenance of the database and VM.\\n\\nHowever, Microsoft \", \"continues its commitment to keeping Azure an \\\"open platform\\\" by offering several popular open-source\", \" databases as *fully managed* DBaaS services.\\n\\n#### **Azure Database for MySQL**\\n\\n[MySQL](https://en\", \".wikipedia.org/wiki/MySQL) is an open-source relational database and a pillar for applications built\", \" on the [LAMP software](https://en.wikipedia.org/wiki/LAMP_(software_bundle))  [stack.](https://en.w\", \"ikipedia.org/wiki/LAMP_(software_bundle)) Widely chosen for *read heavy* workloads, it's used by man\", \"y large organizations, including Facebook, Twitter, and YouTube. The community edition is available \", \"for free, while the enterprise edition requires a license purchase. Originally created in 1995, the \", \"product was purchased by Sun Microsystems in 2008. Oracle acquired Sun and MySQL in 2010.\\n\\n[Azure Da\", \"tabase for MySQL](https://azure.microsoft.com/services/mysql/) is a managed relational database serv\", \"ice based on the open-source MySQL Server engine. It uses the MySQL Community edition. The Azure MyS\", \"QL server is the administrative point for the service. It's the same MySQL server engine used for on\", \"-premises deployments. The engine can create a single database per server or multiple databases per \", \"server that share resources. You can continue to manage data using the same open-source tools withou\", \"t having to learn new skills or manage virtual machines.\\n\\n#### **Azure Database for MariaDB**\\n\\n[Mari\", \"aDB](https://mariadb.com/) Server is another popular open-source database server. It was created as \", \"a *fork* of MySQL when Oracle purchased Sun Microsystems, who owned MySQL. The intent was to ensure \", \"that MariaDB remained open-source. As MariaDB is a fork of MySQL, the data and table definitions are\", \" compatible, and the client protocols, structures, and APIs, are close-knit.\\n\\nMariaDB has a strong c\", \"ommunity and is used by many large enterprises. While Oracle continues to maintain, enhance, and sup\", \"port MySQL, the MariaDB foundation manages MariaDB, allowing public contributions to the product and\", \" documentation.\\n\\n[Azure Database for MariaDB](https://azure.microsoft.com/services/mariadb/) is a fu\", \"lly managed relational database as a service in the Azure cloud. The service is based on the MariaDB\", \" community edition server engine. It can handle mission-critical workloads with predictable performa\", \"nce and dynamic scalability.\\n\\n#### **Azure Database for PostgreSQL**\\n\\n[PostgreSQL](https://www.postg\", \"resql.org/) is an open-source relational database with over 30 years of active development. PostgreS\", \"QL has a strong reputation for reliability and data integrity. It's feature rich, SQL compliant, and\", \" considered more performant than MySQL - especially for workloads with complex queries and heavy wri\", \"tes. Many large enterprises including Apple, Red Hat, and Fujitsu have built products using PostgreS\", \"QL.\\n\\n[Azure Database for PostgreSQL](https://azure.microsoft.com/services/postgresql/) is a fully ma\", \"naged relational database service, based on the opensource Postgres database engine. The service sup\", \"ports many development platforms, including C++, Java, Python, Node, C#, and PHP. You can migrate Po\", \"stgreSQL databases to it using the commandline interface tool or Azure Data Migration Service.\\n\\nAzur\", \"e Database for PostgreSQL is available with two deployment options:\\n\\n- The [Single Server](https://d\", \"ocs.microsoft.com/azure/postgresql/concepts-servers) deployment option is a central administrative p\", \"oint for multiple databases to which you can deploy many databases. The pricing is structured per-se\", \"rver based upon cores and storage.\\n- The [Hyperscale \\\\(Citus\\\\) option](https://azure.microsoft.com/b\", \"log/get-high-performance-scaling-for-your-azure-database-workloads-with-hyperscale/) is powered by C\", \"itus Data technology. It enables high performance by *horizontally scaling* a single database across\", \" hundreds of nodes to deliver fast performance and scale. This option allows the engine to fit more \", \"data in memory, parallelize queries across hundreds of nodes, and index data faster.\\n\\n#### <span id=\", \"\\\"page-111-0\\\"></span>**NoSQL data in Azure**\\n\\nCosmos DB is a fully managed, globally distributed NoSQ\", \"L database service in the Azure cloud. It has been adopted by many large companies across the world,\", \" including Coca-Cola, Skype, ExxonMobil, and Liberty Mutual.\\n\\nIf your services require fast response\", \" from anywhere in the world, high availability, or elastic scalability, Cosmos DB is a great choice.\", \" Figure 5-12 shows Cosmos DB.\\n\\n![](_page_112_Figure_0.jpeg)\\n\\n*Figure 5-12: Overview of Azure Cosmos \", \"DB*\\n\\nThe previous figure presents many of the built-in cloud-native capabilities available in Cosmos\", \" DB. In this section, we'll take a closer look at them.\\n\\n#### **Global support**\\n\\nCloud-native appli\", \"cations often have a global audience and require global scale.\\n\\nYou can distribute Cosmos databases \", \"across regions or around the world, placing data close to your users, improving response time, and r\", \"educing latency. You can add or remove a database from a region without pausing or redeploying your \", \"services. In the background, Cosmos DB transparently replicates the data to each of the configured r\", \"egions.\\n\\nCosmos DB supports [active/active](https://kemptechnologies.com/white-papers/unfog-confusio\", \"n-active-passive-activeactive-load-balancing/) clustering at the global level, enabling you to confi\", \"gure any of your database regions to support *both writes and reads*.\\n\\nThe [Multi-region write](http\", \"s://docs.microsoft.com/azure/cosmos-db/conflict-resolution-policies) protocol is an important featur\", \"e in Cosmos DB that enables the following functionality:\\n\\n- Unlimited elastic write and read scalabi\", \"lity.\\n- 99.999% read and write availability all around the world.\\n- Guaranteed reads and writes serv\", \"ed in less than 10 milliseconds at the 99th percentile.\\n\\nWith the Cosmos DB [Multi-Homing APIs,](htt\", \"ps://docs.microsoft.com/azure/cosmos-db/distribute-data-globally) your microservice is automatically\", \" aware of the nearest Azure region and sends requests to it. The nearest region is identified by Cos\", \"mos DB without any configuration changes. Should a region become unavailable, the Multi-Homing featu\", \"re will automatically route requests to the next nearest available region.\\n\\n#### **Multi-model suppo\", \"rt**\\n\\nWhen replatforming monolithic applications to a cloud-native architecture, development teams s\", \"ometimes have to migrate open-source, NoSQL data stores. Cosmos DB can help you preserve your invest\", \"ment in these NoSQL datastores with its *multi-model* data platform. The following table shows the s\", \"upported NoSQL [compatibility APIs.](https://www.wikiwand.com/en/Cosmos_DB)\\n\\n| Provider       | Desc\", \"ription                                                                  |\\n|----------------|-------\", \"-----------------------------------------------------------------------|\\n| NoSQL API      | API for \", \"NoSQL stores data in document format                                 |\\n| Mongo DB API   | Supports M\", \"ongo DB APIs and JSON documents                                    |\\n| Gremlin API    | Supports Gre\", \"mlin API with graph-based nodes<br>and edge data representations |\\n| Cassandra API  | Supports Casan\", \"dra API for wide-column data<br>representations                |\\n| Table API      | Supports Azure T\", \"able Storage with premium<br>enhancements                    |\\n| PostgreSQL API | Managed service fo\", \"r running PostgreSQL at any<br>scale                       |\\n\\nDevelopment teams can migrate existing\", \" Mongo, Gremlin, or Cassandra databases into Cosmos DB with minimal changes to data or code. For new\", \" apps, development teams can choose among opensource options or the built-in SQL API model.\\n\\nInterna\", \"lly, Cosmos stores the data in a simple struct format made up of primitive data types. For each requ\", \"est, the database engine translates the primitive data into the model representation you've selected\", \".\\n\\nIn the previous table, note the [Table API](https://docs.microsoft.com/azure/cosmos-db/table-intr\", \"oduction) option. This API is an evolution of Azure Table Storage. Both share the same underlying ta\", \"ble model, but the Cosmos DB Table API adds premium enhancements not available in the Azure Storage \", \"API. The following table contrasts the features.\\n\\n| Feature                                         \", \"                   | Azure Table Storage                                                            \", \"                                                      | Azure Cosmos DB                             \", \"                                   |\\n|--------------------------------------------------------------\", \"------|---------------------------------------------------------------------------------------------\", \"-----------------------------------------|----------------------------------------------------------\", \"----------------------|\\n| Latency                                                            | Fast \", \"                                                                                                    \", \"                            | Single-digit millisecond latency for reads and<br>writes anywhere in t\", \"he world |\\n| Throughp<br>ut                                                     | Limit of 20,000 op\", \"erations per table<br>Unlimited operations per table                                                \", \"               |                                                                                |\\n| \", \"Global<br>Distributio<br>n                                         | Single region with optional sin\", \"gle<br>Turnkey distributions to all regions with<br>secondary read region<br>automatic failover     \", \"  |                                                                                |\\n| Indexing<br>A\", \"vailable for partition and row key<br>properties only |                                             \", \"                                                                                         | Automatic\", \" indexing of all properties                                           |\\n| Pricing                   \", \"                                         | Optimized for cold workloads (low<br>Optimized for hot wo\", \"rkloads (high<br>throughput : storage ratio)<br>throughput : storage ratio) |                       \", \"                                                         |\\n\\nMicroservices that consume Azure Table s\", \"torage can easily migrate to the Cosmos DB Table API. No code changes are required.\\n\\n#### **Tunable \", \"consistency**\\n\\nEarlier in the *Relational vs. NoSQL* section, we discussed the subject of *data cons\", \"istency*. Data consistency refers to the *integrity* of your data. Cloud-native services with distri\", \"buted data rely on replication and must make a fundamental tradeoff between read consistency, availa\", \"bility, and latency.\\n\\nMost distributed databases allow developers to choose between two consistency \", \"models: strong consistency and eventual consistency. *Strong consistency* is the gold standard of da\", \"ta programmability. It guarantees that a query will always return the most current data - even if th\", \"e system must incur latency waiting for an update to replicate across all database copies. While a d\", \"atabase configured for *eventual consistency* will return data immediately, even if that data isn't \", \"the most current copy. The latter option enables higher availability, greater scale, and increased p\", \"erformance.\\n\\nAzure Cosmos DB offers five well-defined [consistency models](https://docs.microsoft.co\", \"m/azure/cosmos-db/consistency-levels) shown in Figure 5-13.\\n\\n![](_page_114_Figure_4.jpeg)\\n\\n*Figure 5\", \"-13: Cosmos DB Consistency Levels*\\n\\nThese options enable you to make precise choices and granular tr\", \"adeoffs for consistency, availability, and the performance for your data. The levels are presented i\", \"n the following table.\\n\\n| Consistency Level | Description                                           \", \"                                                                             |\\n|-------------------|\", \"----------------------------------------------------------------------------------------------------\", \"--------------------------------|\\n| Eventual          | No ordering guarantee for reads. Replicas wi\", \"ll<br>eventually converge.                                                             |\\n| Constant \", \"Prefix   | Reads are still eventual, but data is returned in<br>the ordering in which it is written.\", \"                                          |\\n| Session           | Guarantees you can read any data w\", \"ritten<br>during the current session. It is the default<br>consistency level.                    |\\n|\", \" Bounded Staleness | Reads trail writes by interval that you specify.                               \", \"                                                    |\\n| Strong            | Reads are guaranteed to \", \"return most recent<br>committed version of an item. A client never<br>sees an uncommitted or partial\", \" read. |\\n\\nIn the article [Getting Behind the 9-Ball: Cosmos DB Consistency Levels Explained,](https:\", \"//blog.jeremylikness.com/blog/2018-03-23_getting-behind-the-9ball-cosmosdb-consistency-levels/) Micr\", \"osoft Program Manager Jeremy Likness provides an excellent explanation of the five models.\\n\\n#### **P\", \"artitioning**\\n\\nAzure Cosmos DB embraces automatic [partitioning](https://docs.microsoft.com/azure/co\", \"smos-db/partitioning-overview) to scale a database to meet the performance needs of your cloud-nativ\", \"e services.\\n\\nYou manage data in Cosmos DB data by creating databases, containers, and items.\\n\\nContai\", \"ners live in a Cosmos DB database and represent a schema-agnostic grouping of items. Items are the d\", \"ata that you add to the container. They're represented as documents, rows, nodes, or edges. All item\", \"s added to a container are automatically indexed.\\n\\nTo partition the container, items are divided int\", \"o distinct subsets called logical partitions. Logical partitions are populated based on the value of\", \" a partition key that is associated with each item in a container. Figure 5-14 shows two containers \", \"each with a logical partition based on a partition key value.\\n\\n![](_page_115_Figure_2.jpeg)\\n\\n*Figure\", \" 5-14: Cosmos DB partitioning mechanics*\\n\\nNote in the previous figure how each item includes a parti\", \"tion key of either 'city' or 'airport'. The key determines the item's logical partition. Items with \", \"a city code are assigned to the container on the left, and items with an airport code, to the contai\", \"ner on the right. Combining the partition key value with the ID value creates an item's index, which\", \" uniquely identifies the item.\\n\\nInternally, Cosmos DB automatically manages the placement of [logica\", \"l partitions](https://docs.microsoft.com/azure/cosmos-db/partition-data) on physical partitions to s\", \"atisfy the scalability and performance needs of the container. As application throughput and storage\", \" requirements increase, Azure Cosmos DB redistributes logical partitions across a greater number of \", \"servers. Redistribution operations are managed by Cosmos DB and invoked without interruption or down\", \"time.\\n\\n#### <span id=\\\"page-115-0\\\"></span>**NewSQL databases**\\n\\n*NewSQL* is an emerging database tech\", \"nology that combines the distributed scalability of NoSQL with the ACID guarantees of a relational d\", \"atabase. NewSQL databases are important for business systems that must process high-volumes of data,\", \" across distributed environments, with full transactional support and ACID compliance. While a NoSQL\", \" database can provide massive scalability, it does not guarantee data consistency. Intermittent prob\", \"lems from inconsistent data can place a burden on the development team. Developers must construct sa\", \"feguards into their microservice code to manage problems caused by inconsistent data.\\n\\nThe Cloud Nat\", \"ive Computing Foundation (CNCF) features several NewSQL database projects.\\n\\n| Project      | Charact\", \"eristics                                                                                            \", \"                                                                                                    \", \"                                                                                                    \", \"                                                                            |\\n|--------------|------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"------------------------------------------------------------------------------|\\n| Cockroach DB | An \", \"ACID-compliant, relational database that<br>scales globally. Add a new node to a cluster and<br>Cock\", \"roachDB takes care of balancing the data<br>across instances and geographies. It creates,<br>manages\", \", and distributes replicas to ensure<br>reliability. It's open source and freely available.         \", \"                                                                                |\\n| TiDB         | A\", \"n open-source database that supports Hybrid<br>Transactional and Analytical Processing (HTAP)<br>wor\", \"kloads. It is MySQL-compatible and features<br>horizontal scalability, strong consistency, and<br>hi\", \"gh availability. TiDB acts like a MySQL server.<br>You can continue to<br>use existing MySQL client<\", \"br>libraries, without requiring extensive code<br>changes to your application.    |\\n| YugabyteDB   |\", \" An open source, high-performance, distributed<br>SQL database. It supports low query latency,<br>re\", \"silience against failures, and global data<br>distribution. YugabyteDB is PostgreSQL<br>compatible a\", \"nd handles scale-out RDBMS and<br>internet-scale OLTP workloads. The product also<br>supports NoSQL \", \"and is compatible with<br>Cassandra.                                                |\\n| Vitess      \", \" | Vitess is a database solution for deploying,<br>scaling, and managing large clusters of MySQL<br>\", \"instances. It can run in a public or private cloud<br>architecture. Vitess combines and extends many\", \"<br>important MySQL features and features both<br>vertical and horizontal sharding support.<br>Origi\", \"nated by YouTube, Vitess has been serving<br>all YouTube database traffic since 2011. |\\n\\nThe open-so\", \"urce projects in the previous figure are available from the Cloud Native Computing Foundation. Three\", \" of the offerings are full database products, which include .NET support. The other, Vitess, is a da\", \"tabase clustering system that horizontally scales large clusters of MySQL instances.\\n\\nA key design g\", \"oal for NewSQL databases is to work natively in Kubernetes, taking advantage of the platform's resil\", \"iency and scalability.\\n\\nNewSQL databases are designed to thrive in ephemeral cloud environments wher\", \"e underlying virtual machines can be restarted or rescheduled at a moment's notice. The databases ar\", \"e designed to survive node failures without data loss nor downtime. CockroachDB, for example, is abl\", \"e to survive a machine loss by maintaining three consistent replicas of any data across the nodes in\", \" a cluster.\\n\\nKubernetes uses a *Services construct* to allow a client to address a group of identica\", \"l NewSQL databases processes from a single DNS entry. By decoupling the database instances from the \", \"address of the service with which it's associated, we can scale without disrupting existing applicat\", \"ion instances. Sending a request to any service at a given time will always yield the same result.\\n\\n\", \"In this scenario, all database instances are equal. There are no primary or secondary relationships.\", \" Techniques like *consensus replication* found in CockroachDB allow any database node to handle any \", \"request. If the node that receives a load-balanced request has the data it needs locally, it respond\", \"s immediately. If not, the node becomes a gateway and forwards the request to the appropriate nodes \", \"to get the correct answer. From the client's perspective, every database node is the same: They appe\", \"ar as a single *logical* database with the consistency guarantees of a single-machine system, despit\", \"e having dozens or even hundreds of nodes that are working behind the scenes.\\n\\nFor a detailed look a\", \"t the mechanics behind NewSQL databases, see the [DASH: Four Properties of](https://thenewstack.io/d\", \"ash-four-properties-of-kubernetes-native-databases/)  [Kubernetes-Native Databases](https://thenewst\", \"ack.io/dash-four-properties-of-kubernetes-native-databases/) article.\\n\\n#### <span id=\\\"page-117-0\\\"></\", \"span>**Data migration to the cloud**\\n\\nOne of the more time-consuming tasks is migrating data from on\", \"e data platform to another. The [Azure Data Migration Service](https://azure.microsoft.com/services/\", \"database-migration/) can help expedite such efforts. It can migrate data from several external datab\", \"ase sources into Azure Data platforms with minimal downtime. Target platforms include the following \", \"services:\\n\\n- Azure SQL Database\\n- Azure Database for MySQL\\n- Azure Database for MariaDB\\n- Azure Data\", \"base for PostgreSQL\\n- Azure Cosmos DB\\n\\nThe service provides recommendations to guide you through the\", \" changes required to execute a migration, both small or large.\\n\\n# <span id=\\\"page-117-1\\\"></span>Cachi\", \"ng in a cloud-native app\\n\\nThe benefits of caching are well understood. The technique works by tempor\", \"arily copying frequently accessed data from a backend data store to *fast storage* that's located cl\", \"oser to the application. Caching is often implemented where\\u2026\\n\\n- Data remains relatively static.\\n- Da\", \"ta access is slow, especially compared to the speed of the cache.\\n- Data is subject to high levels o\", \"f contention.\\n\\n#### <span id=\\\"page-117-2\\\"></span>**Why?**\\n\\nAs discussed in the [Microsoft caching gu\", \"idance,](https://docs.microsoft.com/azure/architecture/best-practices/caching) caching can increase \", \"performance, scalability, and availability for individual microservices and the system as a whole. I\", \"t reduces the latency and contention of handling large volumes of concurrent requests to a data stor\", \"e. As data volume and the number of users increase, the greater the benefits of caching become.\\n\\nCac\", \"hing is most effective when a client repeatedly reads data that is immutable or that changes infrequ\", \"ently. Examples include reference information such as product and pricing information, or shared sta\", \"tic resources that are costly to construct.\\n\\nWhile microservices should be stateless, a distributed \", \"cache can support concurrent access to session state data when absolutely required.\\n\\nAlso consider c\", \"aching to avoid repetitive computations. If an operation transforms data or performs a complicated c\", \"alculation, cache the result for subsequent requests.\\n\\n#### <span id=\\\"page-118-0\\\"></span>**Caching a\", \"rchitecture**\\n\\nCloud native applications typically implement a distributed caching architecture. The\", \" cache is hosted as a cloud-based [backing service,](#page-24-0) separate from the microservices. Fi\", \"gure 5-15 shows the architecture.\\n\\n![](_page_118_Figure_5.jpeg)\\n\\n*Figure 5-15: Caching in a cloud na\", \"tive app*\\n\\nIn the previous figure, note how the cache is independent of and shared by the microservi\", \"ces. In this scenario, the cache is invoked by the [API Gateway.](#page-69-0) As discussed in chapte\", \"r 4, the gateway serves as a front end for all incoming requests. The distributed cache increases sy\", \"stem responsiveness by returning cached data whenever possible. Additionally, separating the cache f\", \"rom the services allows the cache to scale up or out independently to meet increased traffic demands\", \".\\n\\nThe previous figure presents a common caching pattern known as the [cache-aside pattern.](https:/\", \"/docs.microsoft.com/azure/architecture/patterns/cache-aside) For an incoming request, you first quer\", \"y the cache (step #1) for a response. If found, the data is returned immediately. If the data doesn'\", \"t exist in the cache (known as a [cache miss](https://www.techopedia.com/definition/6308/cache-miss)\", \"), it's retrieved from a local database in a downstream service (step #2). It's then written to the \", \"cache for future requests (step #3), and returned to the caller. Care must be taken to periodically \", \"evict cached data so that the system remains timely and consistent.\\n\\nAs a shared cache grows, it mig\", \"ht prove beneficial to partition its data across multiple nodes. Doing so can help minimize contenti\", \"on and improve scalability. Many Caching services support the ability to dynamically add and remove \", \"nodes and rebalance data across partitions. This approach typically involves clustering. Clustering \", \"exposes a collection of federated nodes as a seamless, single cache. Internally, however, the data i\", \"s dispersed across the nodes following a predefined distribution strategy that balances the load eve\", \"nly.\\n\\n#### <span id=\\\"page-119-0\\\"></span>**Azure Cache for Redis**\\n\\n[Azure Cache for Redis](https://a\", \"zure.microsoft.com/services/cache/) is a secure data caching and messaging broker service, fully man\", \"aged by Microsoft. Consumed as a Platform as a Service (PaaS) offering, it provides high throughput \", \"and lowlatency access to data. The service is accessible to any application within or outside of Azu\", \"re.\\n\\nThe Azure Cache for Redis service manages access to open-source Redis servers hosted across Azu\", \"re data centers. The service acts as a facade providing management, access control, and security. Th\", \"e service natively supports a rich set of data structures, including strings, hashes, lists, and set\", \"s. If your application already uses Redis, it will work as-is with Azure Cache for Redis.\\n\\nAzure Cac\", \"he for Redis is more than a simple cache server. It can support a number of scenarios to enhance a m\", \"icroservices architecture:\\n\\n- An in-memory data store\\n- A distributed non-relational database\\n- A me\", \"ssage broker\\n- A configuration or discovery server\\n\\nFor advanced scenarios, a copy of the cached dat\", \"a can be [persisted to disk.](https://docs.microsoft.com/azure/azure-cache-for-redis/cache-how-to-pr\", \"emium-persistence) If a catastrophic event disables both the primary and replica caches, the cache i\", \"s reconstructed from the most recent snapshot.\\n\\nAzure Redis Cache is available across a number of pr\", \"edefined configurations and pricing tiers. The [Premium tier](https://docs.microsoft.com/azure/azure\", \"-cache-for-redis/cache-overview#service-tiers) features many enterprise-level features such as clust\", \"ering, data persistence, georeplication, and virtual-network isolation.\\n\\n# <span id=\\\"page-119-1\\\"></s\", \"pan>Elasticsearch in a cloud-native app\\n\\nElasticsearch is a distributed search and analytics system \", \"that enables complex search capabilities across diverse types of data. It's open source and widely p\", \"opular. Consider how the following companies integrate Elasticsearch into their application:\\n\\n- [Wik\", \"ipedia](https://blog.wikimedia.org/2014/01/06/wikimedia-moving-to-elasticsearch/) for full-text and \", \"incremental (search as you type) searching.\\n- [GitHub](https://www.elastic.co/customers/github) to i\", \"ndex and expose over 8 million code repositories.\\n- [Docker](https://www.elastic.co/customers/docker\", \") for making its container library discoverable.\\n\\nElasticsearch is built on top of the [Apache Lucen\", \"e](https://lucene.apache.org/core/) full-text search engine. Lucene provides highperformance documen\", \"t indexing and querying. It indexes data with an inverted indexing scheme \\u2013 instead of mapping pages\", \" to keywords, it maps keywords to pages just like a glossary at the end of a book. Lucene has powerf\", \"ul query syntax capabilities and can query data by:\\n\\n- Term (a full word)\\n- Prefix (starts-with word\", \")\\n- Wildcard (using \\\"\\\\*\\\" or \\\"?\\\" filters)\\n- Phrase (a sequence of text in a document)\\n- Boolean value\", \" (complex searches combining queries)\\n\\nWhile Lucene provides low-level plumbing for searching, Elast\", \"icsearch provides the server that sits on top of Lucene. Elasticsearch adds higher-level functionali\", \"ty to simplify working Lucene, including a RESTful API to access Lucene's indexing and searching fun\", \"ctionality. It also provides a distributed infrastructure capable of massive scalability, fault tole\", \"rance, and high availability.\\n\\nFor larger cloud-native applications with complex search requirements\", \", Elasticsearch is available as managed service in Azure. The Microsoft Azure Marketplace features p\", \"reconfigured templates which developers can use to deploy an Elasticsearch cluster on Azure.\\n\\nFrom t\", \"he Microsoft Azure Marketplace, developers can use preconfigured templates built to quickly deploy a\", \"n Elasticsearch cluster on Azure. Using the Azure-managed offering, you can deploy up to 50 data nod\", \"es, 20 coordinating nodes, and three dedicated master nodes.\\n\\n#### <span id=\\\"page-120-0\\\"></span>**Su\", \"mmary**\\n\\nThis chapter presented a detailed look at data in cloud-native systems. We started by contr\", \"asting data storage in monolithic applications with data storage patterns in cloud-native systems. W\", \"e looked at data patterns implemented in cloud-native systems, including cross-service queries, dist\", \"ributed transactions, and patterns to deal with high-volume systems. We contrasted SQL with NoSQL da\", \"ta. We looked at data storage options available in Azure that include both Microsoft-centric and ope\", \"nsource options. Finally, we discussed caching and Elasticsearch in a cloud-native application.\\n\\n###\", \"# **References**\\n\\n- [Command and Query Responsibility Segregation \\\\(CQRS\\\\) pattern](https://docs.mic\", \"rosoft.com/azure/architecture/patterns/cqrs)\\n- [Event Sourcing pattern](https://docs.microsoft.com/a\", \"zure/architecture/patterns/event-sourcing)\\n- [Why isn't RDBMS Partition Tolerant in CAP Theorem and \", \"why is it Available?](https://stackoverflow.com/questions/36404765/why-isnt-rdbms-partition-tolerant\", \"-in-cap-theorem-and-why-is-it-available)\\n- [Materialized View](https://docs.microsoft.com/azure/arch\", \"itecture/patterns/materialized-view)\\n- [All you really need to know about open source databases](htt\", \"ps://www.ibm.com/blogs/systems/all-you-really-need-to-know-about-open-source-databases/)\\n- [Compensa\", \"ting Transaction pattern](https://docs.microsoft.com/azure/architecture/patterns/compensating-transa\", \"ction)\\n- [Saga Pattern](https://microservices.io/patterns/data/saga.html)\\n- [Saga Patterns | How to \", \"implement business transactions using microservices](https://blog.couchbase.com/saga-pattern-impleme\", \"nt-business-transactions-using-microservices-part/)\\n- [Compensating Transaction pattern](https://doc\", \"s.microsoft.com/azure/architecture/patterns/compensating-transaction)\\n- [Getting Behind the 9-Ball: \", \"Cosmos DB Consistency Levels Explained](https://blog.jeremylikness.com/blog/2018-03-23_getting-behin\", \"d-the-9ball-cosmosdb-consistency-levels/)\\n- [On RDBMS, NoSQL and NewSQL databases. Interview with Jo\", \"hn Ryan](http://www.odbms.org/blog/2018/03/on-rdbms-nosql-and-newsql-databases-interview-with-john-r\", \"yan/)\\n\\n- [SQL vs NoSQL vs NewSQL: The Full Comparison](https://www.xenonstack.com/blog/sql-vs-nosql-\", \"vs-newsql/)\\n- [DASH: Four Properties of Kubernetes-Native Databases](https://thenewstack.io/dash-fou\", \"r-properties-of-kubernetes-native-databases/)\\n- [CockroachDB](https://www.cockroachlabs.com/)\\n- [TiD\", \"B](https://pingcap.com/en/)\\n- [YugabyteDB](https://www.yugabyte.com/)\\n- [Vitess](https://vitess.io/)\", \"\\n- [Elasticsearch: The Definitive Guide](https://shop.oreilly.com/product/0636920028505.do)\\n- [Intro\", \"duction to Apache Lucene](https://www.baeldung.com/lucene)\\n\\n# <span id=\\\"page-122-0\\\"></span>Cloud-nat\", \"ive resiliency\\n\\nResiliency is the ability of your system to react to failure and still remain functi\", \"onal. It's not about avoiding failure, but accepting failure and constructing your cloud-native serv\", \"ices to respond to it. You want to return to a fully functioning state quickly as possible.\\n\\nUnlike \", \"traditional monolithic applications, where everything runs together in a single process, cloudnative\", \" systems embrace a distributed architecture as shown in Figure 6-1:\\n\\n![](_page_122_Figure_4.jpeg)\\n\\n*\", \"Figure 6-1. Distributed cloud-native environment*\\n\\nIn the previous figure, each microservice and clo\", \"ud-based [backing service](https://12factor.net/backing-services) execute in a separate process, acr\", \"oss server infrastructure, communicating via network-based calls.\\n\\nOperating in this environment, a \", \"service must be sensitive to many different challenges:\\n\\n- Unexpected network latency the time for a\", \" service request to travel to the receiver and back.\\n- [Transient faults](https://docs.microsoft.com\", \"/azure/architecture/best-practices/transient-faults) short-lived network connectivity errors.\\n- Bloc\", \"kage by a long-running synchronous operation.\\n- A host process that has crashed and is being restart\", \"ed or moved.\\n- An overloaded microservice that can't respond for a short time.\\n- An in-flight orches\", \"trator operation such as a rolling upgrade or moving a service from one node to another.\\n\\n\\u2022 Hardware\", \" failures.\\n\\nCloud platforms can detect and mitigate many of these infrastructure issues. It may rest\", \"art, scale out, and even redistribute your service to a different node. However, to take full advant\", \"age of this built-in protection, you must design your services to react to it and thrive in this dyn\", \"amic environment.\\n\\nIn the following sections, we'll explore defensive techniques that your service a\", \"nd managed cloud resources can leverage to minimize downtime and disruption.\\n\\n# <span id=\\\"page-123-0\", \"\\\"></span>Application resiliency patterns\\n\\nThe first line of defense is application resiliency.\\n\\nWhil\", \"e you could invest considerable time writing your own resiliency framework, such products already ex\", \"ist. [Polly](https://old.dotnetfoundation.org/projects/polly) is a comprehensive .NET resilience and\", \" transient-fault-handling library that allows developers to express resiliency policies in a fluent \", \"and thread-safe manner. Polly targets applications built with either .NET Framework or .NET 7. The f\", \"ollowing table describes the resiliency features, called policies, available in the Polly Library. T\", \"hey can be applied individually or grouped together.\\n\\n| Policy          | Experience                \", \"                                                                           |\\n|-----------------|----\", \"--------------------------------------------------------------------------------------------------|\\n\", \"| Retry           | Configures retry operations on designated<br>operations.                        \", \"                     |\\n| Circuit Breaker | Blocks requested operations for a predefined<br>period wh\", \"en faults exceed a configured<br>threshold  |\\n| Timeout         | Places limit on the duration for w\", \"hich a caller<br>can wait for a response.                          |\\n| Bulkhead        | Constrains \", \"actions to fixed-size resource pool to<br>prevent failing calls from swamping a resource. |\\n| Cache \", \"          | Stores responses automatically.                                                         \", \"             |\\n| Fallback        | Defines structured behavior upon a failure.                      \", \"                                    |\\n\\nNote how in the previous figure the resiliency policies apply\", \" to request messages, whether coming from an external client or back-end service. The goal is to com\", \"pensate the request for a service that might be momentarily unavailable. These short-lived interrupt\", \"ions typically manifest themselves with the HTTP status codes shown in the following table.\\n\\n| HTTP \", \"Status Code | Cause                                                 |\\n|------------------|----------\", \"---------------------------------------------|\\n| 404              | Not Found                       \", \"                      |\\n| 408              | Request timeout                                       |\", \"\\n| 429              | Too many requests (you've most likely been throttled) |\\n| 502              | B\", \"ad gateway                                           |\\n| 503              | Service unavailable     \", \"                              |\\n\\n| HTTP Status Code | Cause           |\\n|------------------|--------\", \"---------|\\n| 504              | Gateway timeout |\\n\\nQuestion: Would you retry an HTTP Status Code of \", \"403 - Forbidden? No. Here, the system is functioning properly, but informing the caller that they ar\", \"en't authorized to perform the requested operation. Care must be taken to retry only those operation\", \"s caused by failures.\\n\\nAs recommended in Chapter 1, Microsoft developers constructing cloud-native a\", \"pplications should target the .NET platform. Version 2.1 introduced the [HTTPClientFactory](https://\", \"www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore) library for creating HTTP Clien\", \"t instances for interacting with URL-based resources. Superseding the original HTTPClient class, the\", \" factory class supports many enhanced features, one of which is [tight integration](https://docs.mic\", \"rosoft.com/dotnet/architecture/microservices/implement-resilient-applications/implement-http-call-re\", \"tries-exponential-backoff-polly) with the Polly resiliency library. With it, you can easily define r\", \"esiliency policies in the application Startup class to handle partial failures and connectivity issu\", \"es.\\n\\nNext, let's expand on retry and circuit breaker patterns.\\n\\n#### **Retry pattern**\\n\\nIn a distrib\", \"uted cloud-native environment, calls to services and cloud resources can fail because of transient (\", \"short-lived) failures, which typically correct themselves after a brief period of time. Implementing\", \" a retry strategy helps a cloud-native service mitigate these scenarios.\\n\\nThe [Retry pattern](https:\", \"//docs.microsoft.com/azure/architecture/patterns/retry) enables a service to retry a failed request \", \"operation a (configurable) number of times with an exponentially increasing wait time. Figure 6-2 sh\", \"ows a retry in action.\\n\\n![](_page_124_Figure_7.jpeg)\\n\\n*Figure 6-2. Retry pattern in action*\\n\\nIn the \", \"previous figure, a retry pattern has been implemented for a request operation. It's configured to al\", \"low up to four retries before failing with a backoff interval (wait time) starting at two seconds, w\", \"hich exponentially doubles for each subsequent attempt.\\n\\n\\u2022 The first invocation fails and returns an\", \" HTTP status code of 500. The application waits for two seconds and retries the call.\\n\\n- The second \", \"invocation also fails and returns an HTTP status code of 500. The application now doubles the backof\", \"f interval to four seconds and retries the call.\\n- Finally, the third call succeeds.\\n- In this scena\", \"rio, the retry operation would have attempted up to four retries while doubling the backoff duration\", \" before failing the call.\\n- Had the 4th retry attempt failed, a fallback policy would be invoked to \", \"gracefully handle the problem.\\n\\nIt's important to increase the backoff period before retrying the ca\", \"ll to allow the service time to selfcorrect. It's a best practice to implement an exponentially incr\", \"easing backoff (doubling the period on each retry) to allow adequate correction time.\\n\\n#### <span id\", \"=\\\"page-125-0\\\"></span>**Circuit breaker pattern**\\n\\nWhile the retry pattern can help salvage a request\", \" entangled in a partial failure, there are situations where failures can be caused by unanticipated \", \"events that will require longer periods of time to resolve. These faults can range in severity from \", \"a partial loss of connectivity to the complete failure of a service. In these situations, it's point\", \"less for an application to continually retry an operation that is unlikely to succeed.\\n\\nTo make thin\", \"gs worse, executing continual retry operations on a non-responsive service can move you into a self-\", \"imposed denial of service scenario where you flood your service with continual calls exhausting reso\", \"urces such as memory, threads and database connections, causing failure in unrelated parts of the sy\", \"stem that use the same resources.\\n\\nIn these situations, it would be preferable for the operation to \", \"fail immediately and only attempt to invoke the service if it's likely to succeed.\\n\\nThe [Circuit Bre\", \"aker pattern](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker) can prevent an\", \" application from repeatedly trying to execute an operation that's likely to fail. After a pre-defin\", \"ed number of failed calls, it blocks all traffic to the service. Periodically, it will allow a trial\", \" call to determine whether the fault has resolved. Figure 6-3 shows the Circuit Breaker pattern in a\", \"ction.\\n\\n![](_page_126_Figure_0.jpeg)\\n\\n*Figure 6-3. Circuit breaker pattern in action*\\n\\nIn the previo\", \"us figure, a Circuit Breaker pattern has been added to the original retry pattern. Note how after 10\", \"0 failed requests, the circuit breakers opens and no longer allows calls to the service. The CheckCi\", \"rcuit value, set at 30 seconds, specifies how often the library allows one request to proceed to the\", \" service. If that call succeeds, the circuit closes and the service is once again available to traff\", \"ic.\\n\\nKeep in mind that the intent of the Circuit Breaker pattern is *different* than that of the Ret\", \"ry pattern. The Retry pattern enables an application to retry an operation in the expectation that i\", \"t will succeed. The Circuit Breaker pattern prevents an application from doing an operation that is \", \"likely to fail. Typically, an application will *combine* these two patterns by using the Retry patte\", \"rn to invoke an operation through a circuit breaker.\\n\\n#### <span id=\\\"page-126-0\\\"></span>**Testing fo\", \"r resiliency**\\n\\nTesting for resiliency cannot always be done the same way that you test application \", \"functionality (by running unit tests, integration tests, and so on). Instead, you must test how the \", \"end-to-end workload performs under failure conditions, which only occur intermittently. For example:\", \" inject failures by crashing processes, expired certificates, make dependent services unavailable et\", \"c. Frameworks like [chaos-monkey](https://github.com/Netflix/chaosmonkey) can be used for such chaos\", \" testing.\\n\\nApplication resiliency is a must for handling problematic requested operations. But, it's\", \" only half of the story. Next, we cover resiliency features available in the Azure cloud.\\n\\n# <span i\", \"d=\\\"page-126-1\\\"></span>Azure platform resiliency\\n\\nBuilding a reliable application in the cloud is dif\", \"ferent from traditional on-premises application development. While historically you purchased higher\", \"-end hardware to scale up, in a cloud environment you scale out. Instead of trying to prevent failur\", \"es, the goal is to minimize their effects and keep the system stable.\\n\\nThat said, reliable cloud app\", \"lications display distinct characteristics:\\n\\n- They're resilient, recover gracefully from problems, \", \"and continue to function.\\n- They're highly available (HA) and run as designed in a healthy state wit\", \"h no significant downtime.\\n\\nUnderstanding how these characteristics work together - and how they aff\", \"ect cost - is essential to building a reliable cloud-native application. We'll next look at ways tha\", \"t you can build resiliency and availability into your cloud-native applications leveraging features \", \"from the Azure cloud.\\n\\n#### <span id=\\\"page-127-0\\\"></span>**Design with resiliency**\\n\\nWe've said resi\", \"liency enables your application to react to failure and still remain functional. The whitepaper, [Re\", \"silience in Azure whitepaper,](https://azure.microsoft.com/mediahandler/files/resourcefiles/resilien\", \"ce-in-azure-whitepaper/Resilience%20in%20Azure.pdf) provides guidance for achieving resilience in th\", \"e Azure platform. Here are some key recommendations:\\n\\n- *Hardware failure.* Build redundancy into th\", \"e application by deploying components across different fault domains. For example, ensure that Azure\", \" VMs are placed in different racks by using Availability Sets.\\n- *Datacenter failure.* Build redunda\", \"ncy into the application with fault isolation zones across datacenters. For example, ensure that Azu\", \"re VMs are placed in different fault-isolated datacenters by using Azure Availability Zones.\\n- *Regi\", \"onal failure.* Replicate the data and components into another region so that applications can be qui\", \"ckly recovered. For example, use Azure Site Recovery to replicate Azure VMs to another Azure region.\", \"\\n- *Heavy load.* Load balance across instances to handle spikes in usage. For example, put two or mo\", \"re Azure VMs behind a load balancer to distribute traffic to all VMs.\\n- *Accidental data deletion or\", \" corruption.* Back up data so it can be restored if there's any deletion or corruption. For example,\", \" use Azure Backup to periodically back up your Azure VMs.\\n\\n#### <span id=\\\"page-127-1\\\"></span>**Desig\", \"n with redundancy**\\n\\nFailures vary in scope of impact. A hardware failure, such as a failed disk, ca\", \"n affect a single node in a cluster. A failed network switch could affect an entire server rack. Les\", \"s common failures, such as loss of power, could disrupt a whole datacenter. Rarely, an entire region\", \" becomes unavailable.\\n\\n[Redundancy](https://docs.microsoft.com/azure/architecture/guide/design-princ\", \"iples/redundancy) is one way to provide application resilience. The exact level of redundancy needed\", \" depends upon your business requirements and will affect both the cost and complexity of your system\", \". For example, a multi-region deployment is more expensive and more complex to manage than a single-\", \"region deployment. You'll need operational procedures to manage failover and failback. The additiona\", \"l cost and complexity might be justified for some business scenarios, but not others.\\n\\nTo architect \", \"redundancy, you need to identify the critical paths in your application, and then determine if there\", \"'s redundancy at each point in the path? If a subsystem should fail, will the application fail over \", \"to something else? Finally, you need a clear understanding of those features built into the Azure cl\", \"oud platform that you can leverage to meet your redundancy requirements. Here are recommendations fo\", \"r architecting redundancy:\\n\\n- *Deploy multiple instances of services.* If your application depends o\", \"n a single instance of a service, it creates a single point of failure. Provisioning multiple instan\", \"ces improves both resiliency and scalability. When hosting in Azure Kubernetes Service, you can decl\", \"aratively configure redundant instances (replica sets) in the Kubernetes manifest file. The replica \", \"count value can be managed programmatically, in the portal, or through autoscaling features.\\n- *Leve\", \"raging a load balancer.* Load-balancing distributes your application's requests to healthy service i\", \"nstances and automatically removes unhealthy instances from rotation. When deploying to Kubernetes, \", \"load balancing can be specified in the Kubernetes manifest file in the Services section.\\n- *Plan for\", \" multiregion deployment.* If you deploy your application to a single region, and that region becomes\", \" unavailable, your application will also become unavailable. This may be unacceptable under the term\", \"s of your application's service level agreements. Instead, consider deploying your application and i\", \"ts services across multiple regions. For example, an Azure Kubernetes Service (AKS) cluster is deplo\", \"yed to a single region. To protect your system from a regional failure, you might deploy your applic\", \"ation to multiple AKS clusters across different regions and use the [Paired Regions](https://docs.mi\", \"crosoft.com/azure/virtual-machines/regions#region-pairs) feature to coordinate platform updates and \", \"prioritize recovery efforts.\\n- *Enable [geo-replication.](https://docs.microsoft.com/azure/sql-datab\", \"ase/sql-database-active-geo-replication)* Geo-replication for services such as Azure SQL Database an\", \"d Cosmos DB will create secondary replicas of your data across multiple regions. While both services\", \" will automatically replicate data within the same region, geo-replication protects you against a re\", \"gional outage by enabling you to fail over to a secondary region. Another best practice for geo-repl\", \"ication centers around storing container images. To deploy a service in AKS, you need to store and p\", \"ull the image from a repository. Azure Container Registry integrates with AKS and can securely store\", \" container images. To improve performance and availability, consider geo-replicating your images to \", \"a registry in each region where you have an AKS cluster. Each AKS cluster then pulls container image\", \"s from the local container registry in its region as shown in Figure 6-4:\\n\\n![](_page_128_Figure_5.jp\", \"eg)\\n\\n*Figure 6-4. Replicated resources across regions*\\n\\n\\u2022 *Implement a DNS traffic load balancer.* [\", \"Azure Traffic Manager](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview) pr\", \"ovides high-availability for critical applications by load-balancing at the DNS level. It can route \", \"traffic to different regions based on geography, cluster response time, and even application endpoin\", \"t health. For example, Azure Traffic Manager can direct customers to the closest AKS cluster and app\", \"lication instance. If you have multiple AKS clusters in different regions, use Traffic Manager to co\", \"ntrol how traffic flows to the applications that run in each cluster. Figure 6-5 shows this scenario\", \".\\n\\n![](_page_129_Picture_1.jpeg)\\n\\n*Figure 6-5. AKS and Azure Traffic Manager*\\n\\n#### <span id=\\\"page-1\", \"29-0\\\"></span>**Design for scalability**\\n\\nThe cloud thrives on scaling. The ability to increase/decre\", \"ase system resources to address increasing/decreasing system load is a key tenet of the Azure cloud.\", \" But, to effectively scale an application, you need an understanding of the scaling features of each\", \" Azure service that you include in your application. Here are recommendations for effectively implem\", \"enting scaling in your system.\\n\\n- *Design for scaling.* An application must be designed for scaling.\", \" To start, services should be stateless so that requests can be routed to any instance. Having state\", \"less services also means that adding or removing an instance doesn't adversely impact current users.\", \"\\n- *Partition workloads*. Decomposing domains into independent, self-contained microservices enable \", \"each service to scale independently of others. Typically, services will have different scalability n\", \"eeds and requirements. Partitioning enables you to scale only what needs to be scaled without the un\", \"necessary cost of scaling an entire application.\\n- *Favor scale-out.* Cloud-based applications favor\", \" scaling out resources as opposed to scaling up. Scaling out (also known as horizontal scaling) invo\", \"lves adding more service resources to an existing system to meet and share a desired level of perfor\", \"mance. Scaling up (also known\\n\\nas vertical scaling) involves replacing existing resources with more \", \"powerful hardware (more disk, memory, and processing cores). Scaling out can be invoked automaticall\", \"y with the autoscaling features available in some Azure cloud resources. Scaling out across multiple\", \" resources also adds redundancy to the overall system. Finally scaling up a single resource is typic\", \"ally more expensive than scaling out across many smaller resources. Figure 6-6 shows the two approac\", \"hes:\\n\\n![](_page_130_Picture_1.jpeg)\\n\\n*Figure 6-6. Scale up versus scale out*\\n\\n- *Scale proportionall\", \"y.* When scaling a service, think in terms of *resource sets*. If you were to dramatically scale out\", \" a specific service, what impact would that have on back-end data stores, caches and dependent servi\", \"ces? Some resources such as Cosmos DB can scale out proportionally, while many others can't. You wan\", \"t to ensure that you don't scale out a resource to a point where it will exhaust other associated re\", \"sources.\\n- *Avoid affinity.* A best practice is to ensure a node doesn't require local affinity, oft\", \"en referred to as a *sticky session*. A request should be able to route to any instance. If you need\", \" to persist state, it should be saved to a distributed cache, such as [Azure Redis cache.](https://a\", \"zure.microsoft.com/services/cache/)\\n- *Take advantage of platform autoscaling features.* Use built-i\", \"n autoscaling features whenever possible, rather than custom or third-party mechanisms. Where possib\", \"le, use scheduled scaling rules to ensure that resources are available without a startup delay, but \", \"add reactive autoscaling to the rules as appropriate, to cope with unexpected changes in demand. For\", \" more information, see [Autoscaling guidance.](https://docs.microsoft.com/azure/architecture/best-pr\", \"actices/auto-scaling)\\n- *Scale out aggressively.* A final practice would be to scale out aggressivel\", \"y so that you can quickly meet immediate spikes in traffic without losing business. And, then scale \", \"in (that is, remove unneeded instances) conservatively to keep the system stable. A simple way to im\", \"plement this is to set the cool down period, which is the time to wait between scaling operations, t\", \"o five minutes for adding resources and up to 15 minutes for removing instances.\\n\\n#### <span id=\\\"pag\", \"e-130-0\\\"></span>**Built-in retry in services**\\n\\nWe encouraged the best practice of implementing prog\", \"rammatic retry operations in an earlier section. Keep in mind that many Azure services and their cor\", \"responding client SDKs also include retry\\n\\nmechanisms. The following list summarizes retry features \", \"in the many of the Azure services that are discussed in this book:\\n\\n- *Azure Cosmos DB.* The [Docume\", \"ntClient](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.documentclient) cla\", \"ss from the client API automatically retires failed attempts. The number of retries and maximum wait\", \" time are configurable. Exceptions thrown by the client API are either requests that exceed the retr\", \"y policy or non-transient errors.\\n- *Azure Redis Cache.* The Redis StackExchange client uses a conne\", \"ction manager class that includes retries on failed attempts. The number of retries, specific retry \", \"policy and wait time are all configurable.\\n- *Azure Service Bus.* The Service Bus client exposes a [\", \"RetryPolicy class](xref:Microsoft.ServiceBus.RetryPolicy) that can be configured with a back-off int\", \"erval, retry count, and [TerminationTimeBuffer,](https://docs.microsoft.com/dotnet/api/microsoft.ser\", \"vicebus.retryexponential.terminationtimebuffer) which specifies the maximum time an operation can ta\", \"ke. The default policy is nine maximum retry attempts with a 30 second backoff period between attemp\", \"ts.\\n- *Azure SQL Database.* Retry support is provided when using the [Entity Framework Core](https:/\", \"/docs.microsoft.com/ef/core/miscellaneous/connection-resiliency) library.\\n- *Azure Storage.* The sto\", \"rage client library support retry operations. The strategies vary across Azure storage tables, blobs\", \", and queues. As well, alternate retries switch between primary and secondary storage services locat\", \"ions when the geo-redundancy feature is enabled.\\n- *Azure Event Hubs.* The Event Hub client library \", \"features a RetryPolicy property, which includes a configurable exponential backoff feature.\\n\\n# <span\", \" id=\\\"page-131-0\\\"></span>Resilient communications\\n\\nThroughout this book, we've embraced a microservic\", \"e-based architectural approach. While such an architecture provides important benefits, it presents \", \"many challenges:\\n\\n- *Out-of-process network communication.* Each microservice communicates over a ne\", \"twork protocol that introduces network congestion, latency, and transient faults.\\n- *Service discove\", \"ry.* How do microservices discover and communicate with each other when running across a cluster of \", \"machines with their own IP addresses and ports?\\n- *Resiliency.* How do you manage short-lived failur\", \"es and keep the system stable?\\n- *Load balancing.* How does inbound traffic get distributed across m\", \"ultiple instances of a microservice?\\n- *Security.* How are security concerns such as transport-level\", \" encryption and certificate management enforced?\\n- *Distributed Monitoring.* How do you correlate an\", \"d capture traceability and monitoring for a single request across multiple consuming microservices?\\n\", \"\\nYou can address these concerns with different libraries and frameworks, but the implementation can \", \"be expensive, complex, and time-consuming. You also end up with infrastructure concerns coupled to b\", \"usiness logic.\\n\\n#### <span id=\\\"page-132-0\\\"></span>**Service mesh**\\n\\nA better approach is an evolving\", \" technology entitled *Service Mesh*. A [service mesh](https://www.nginx.com/blog/what-is-a-service-m\", \"esh/) is a configurable infrastructure layer with built-in capabilities to handle service communicat\", \"ion and the other challenges mentioned above. It decouples these concerns by moving them into a serv\", \"ice proxy. The proxy is deployed into a separate process (called a [sidecar\\\\)](https://docs.microsof\", \"t.com/azure/architecture/patterns/sidecar) to provide isolation from business code. However, the sid\", \"ecar is linked to the service - it's created with it and shares its lifecycle. Figure 6-7 shows this\", \" scenario.\\n\\n![](_page_132_Figure_2.jpeg)\\n\\n*Figure 6-7. Service mesh with a side car*\\n\\nIn the previou\", \"s figure, note how the proxy intercepts and manages communication among the microservices and the cl\", \"uster.\\n\\nA service mesh is logically split into two disparate components: A [data plane](https://blog\", \".envoyproxy.io/service-mesh-data-plane-vs-control-plane-2774e720f7fc) an[d control plane.](https://b\", \"log.envoyproxy.io/service-mesh-data-plane-vs-control-plane-2774e720f7fc) Figure 6-8 shows these comp\", \"onents and their responsibilities.\\n\\n![](_page_133_Figure_0.jpeg)\\n\\n*Figure 6-8. Service mesh control \", \"and data plane*\\n\\nOnce configured, a service mesh is highly functional. It can retrieve a correspondi\", \"ng pool of instances from a service discovery endpoint. The mesh can then send a request to a specif\", \"ic instance, recording the latency and response type of the result. A mesh can choose the instance m\", \"ost likely to return a fast response based on many factors, including its observed latency for recen\", \"t requests.\\n\\nIf an instance is unresponsive or fails, the mesh will retry the request on another ins\", \"tance. If it returns errors, a mesh will evict the instance from the load-balancing pool and restate\", \" it after it heals. If a request times out, a mesh can fail and then retry the request. A mesh captu\", \"res and emits metrics and distributed tracing to a centralized metrics system.\\n\\n#### <span id=\\\"page-\", \"133-0\\\"></span>**Istio and Envoy**\\n\\nWhile a few service mesh options currently exist, [Istio](https:/\", \"/istio.io/docs/concepts/what-is-istio/) is the most popular at the time of this writing. Istio is a \", \"joint venture from IBM, Google, and Lyft. It's an open-source offering that can be integrated into a\", \" new or existing distributed application. The technology provides a consistent and complete solution\", \" to secure, connect, and monitor microservices. Its features include:\\n\\n- Secure service-to-service c\", \"ommunication in a cluster with strong identity-based authentication and authorization.\\n- Automatic l\", \"oad balancing for HTTP, [gRPC,](https://grpc.io/) WebSocket, and TCP traffic.\\n- Fine-grained control\", \" of traffic behavior with rich routing rules, retries, failovers, and fault injection.\\n- A pluggable\", \" policy layer and configuration API supporting access controls, rate limits, and quotas.\\n- Automatic\", \" metrics, logs, and traces for all traffic within a cluster, including cluster ingress and egress.\\n\\n\", \"A key component for an Istio implementation is a proxy service entitled the [Envoy proxy.](https://w\", \"ww.envoyproxy.io/docs/envoy/latest/intro/what_is_envoy) It runs alongside each service and provides \", \"a platform-agnostic foundation for the following features:\\n\\n- Dynamic service discovery.\\n- Load bala\", \"ncing.\\n\\n- TLS termination.\\n- HTTP and gRPC proxies.\\n- Circuit breaker resiliency.\\n- Health checks.\\n-\", \" Rolling updates with [canary](https://martinfowler.com/bliki/CanaryRelease.html) deployments.\\n\\nAs p\", \"reviously discussed, Envoy is deployed as a sidecar to each microservice in the cluster.\\n\\n#### <span\", \" id=\\\"page-134-0\\\"></span>**Integration with Azure Kubernetes Services**\\n\\nThe Azure cloud embraces Ist\", \"io and provides direct support for it within Azure Kubernetes Services. The following links can help\", \" you get started:\\n\\n- [Installing Istio in AKS](https://docs.microsoft.com/azure/aks/istio-install)\\n-\", \" [Using AKS and Istio](https://docs.microsoft.com/azure/aks/istio-scenario-routing)\\n\\n#### **Referenc\", \"es**\\n\\n- [Polly](https://old.dotnetfoundation.org/projects/polly)\\n- [Retry pattern](https://docs.micr\", \"osoft.com/azure/architecture/patterns/retry)\\n- [Circuit Breaker pattern](https://docs.microsoft.com/\", \"azure/architecture/patterns/circuit-breaker)\\n- [Resilience in Azure whitepaper](https://azure.micros\", \"oft.com/mediahandler/files/resourcefiles/resilience-in-azure-whitepaper/Resilience%20in%20Azure.pdf)\", \"\\n- [network latency](https://www.techopedia.com/definition/8553/network-latency)\\n- [Redundancy](http\", \"s://docs.microsoft.com/azure/architecture/guide/design-principles/redundancy)\\n- [geo-replication](ht\", \"tps://docs.microsoft.com/azure/sql-database/sql-database-active-geo-replication)\\n- [Azure Traffic Ma\", \"nager](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview)\\n- [Autoscaling gui\", \"dance](https://docs.microsoft.com/azure/architecture/best-practices/auto-scaling)\\n- [Istio](https://\", \"istio.io/docs/concepts/what-is-istio/)\\n- [Envoy proxy](https://www.envoyproxy.io/docs/envoy/latest/i\", \"ntro/what_is_envoy)\\n\\n# <span id=\\\"page-135-0\\\"></span>Monitoring and health\\n\\nMicroservices and cloud-n\", \"ative applications go hand in hand with good DevOps practices. DevOps is many things to many people \", \"but perhaps one of the better definitions comes from cloud advocate and DevOps evangelist Donovan Br\", \"own:\\n\\n\\\"DevOps is the union of people, process, and products to enable continuous delivery of value t\", \"o our end users.\\\"\\n\\nUnfortunately, with terse definitions, there's always room to say more things. On\", \"e of the key components of DevOps is ensuring that the applications running in production are functi\", \"oning properly and efficiently. To gauge the health of the application in production, it's necessary\", \" to monitor the various logs and metrics being produced from the servers, hosts, and the application\", \" proper. The number of different services running in support of a cloud-native application makes mon\", \"itoring the health of individual components and the application as a whole a critical challenge.\\n\\n# \", \"<span id=\\\"page-135-1\\\"></span>Observability patterns\\n\\nJust as patterns have been developed to aid in \", \"the layout of code in applications, there are patterns for operating applications in a reliable way.\", \" Three useful patterns in maintaining applications have emerged: **logging**, **monitoring**, and **\", \"alerts**.\\n\\n#### <span id=\\\"page-135-2\\\"></span>**When to use logging**\\n\\nNo matter how careful we are, \", \"applications almost always behave in unexpected ways in production. When users report problems with \", \"an application, it's useful to be able to see what was going on with the app when the problem occurr\", \"ed. One of the most tried and true ways of capturing information about what an application is doing \", \"while it's running is to have the application write down what it's doing. This process is known as l\", \"ogging. Anytime failures or problems occur in production, the goal should be to reproduce the condit\", \"ions under which the failures occurred, in a non-production environment. Having good logging in plac\", \"e provides a roadmap for developers to follow in order to duplicate problems in an environment that \", \"can be tested and experimented with.\\n\\n#### **Challenges when logging with cloud-native applications*\", \"*\\n\\nIn traditional applications, log files are typically stored on the local machine. In fact, on Uni\", \"x-like operating systems, there's a folder structure defined to hold any logs, typically under /var/\", \"log.\\n\\n![](_page_136_Picture_1.jpeg)\\n\\n*Figure 7-1. Logging to a file in a monolithic app.*\\n\\nThe usefu\", \"lness of logging to a flat file on a single machine is vastly reduced in a cloud environment. Applic\", \"ations producing logs may not have access to the local disk or the local disk may be highly transien\", \"t as containers are shuffled around physical machines. Even simple scaling up of monolithic applicat\", \"ions across multiple nodes can make it challenging to locate the appropriate file-based log file.\\n\\n!\", \"[](_page_136_Picture_5.jpeg)\\n\\n*Figure 7-2. Logging to files in a scaled monolithic app.*\\n\\nCloud-nati\", \"ve applications developed using a microservices architecture also pose some challenges for file-base\", \"d loggers. User requests may now span multiple services that are run on different machines\\n\\nand may \", \"include serverless functions with no access to a local file system at all. It would be very challeng\", \"ing to correlate the logs from a user or a session across these many services and machines.\\n\\n![](_pa\", \"ge_137_Figure_2.jpeg)\\n\\n*Figure 7-3. Logging to local files in a microservices app.*\\n\\nFinally, the nu\", \"mber of users in some cloud-native applications is high. Imagine that each user generates a hundred \", \"lines of log messages when they log into an application. In isolation, that is manageable, but multi\", \"ply that over 100,000 users and the volume of logs becomes large enough that specialized tools are n\", \"eeded to support effective use of the logs.\\n\\n#### **Logging in cloud-native applications**\\n\\nEvery pr\", \"ogramming language has tooling that permits writing logs, and typically the overhead for writing the\", \"se logs is low. Many of the logging libraries provide logging different kinds of criticalities, whic\", \"h can be tuned at run time. For instance, the [Serilog library](https://serilog.net/) is a popular s\", \"tructured logging library for .NET that provides the following logging levels:\\n\\n- Verbose\\n- Debug\\n- \", \"Information\\n- Warning\\n- Error\\n- Fatal\\n\\nThese different log levels provide granularity in logging. Wh\", \"en the application is functioning properly in production, it may be configured to only log important\", \" messages. When the application is\\n\\nmisbehaving, then the log level can be increased so more verbose\", \" logs are gathered. This balances performance against ease of debugging.\\n\\nThe high performance of lo\", \"gging tools and the tunability of verbosity should encourage developers to log frequently. Many favo\", \"r a pattern of logging the entry and exit of each method. This approach may sound like overkill, but\", \" it's infrequent that developers will wish for less logging. In fact, it's not uncommon to perform d\", \"eployments for the sole purpose of adding logging around a problematic method. Err on the side of to\", \"o much logging and not on too little. Some tools can be used to automatically provide this kind of l\", \"ogging.\\n\\nBecause of the challenges associated with using file-based logs in cloud-native apps, centr\", \"alized logs are preferred. Logs are collected by the applications and shipped to a central logging a\", \"pplication which indexes and stores the logs. This class of system can ingest tens of gigabytes of l\", \"ogs every day.\\n\\nIt's also helpful to follow some standard practices when building logging that spans\", \" many services. For instance, generating a [correlation ID](https://blog.rapid7.com/2016/12/23/the-v\", \"alue-of-correlation-ids/) at the start of a lengthy interaction, and then logging it in each message\", \" that is related to that interaction, makes it easier to search for all related messages. One need o\", \"nly find a single message and extract the correlation ID to find all the related messages. Another e\", \"xample is ensuring that the log format is the same for every service, whatever the language or loggi\", \"ng library it uses. This standardization makes reading logs much easier. Figure 7-4 demonstrates how\", \" a microservices architecture can leverage centralized logging as part of its workflow.\\n\\n![](_page_1\", \"38_Figure_5.jpeg)\\n\\n*Figure 7-4. Logs from various sources are ingested into a centralized log store.\", \"*\\n\\n#### <span id=\\\"page-139-0\\\"></span>**Challenges with detecting and responding to potential app hea\", \"lth issues**\\n\\nSome applications aren't mission critical. Maybe they're only used internally, and whe\", \"n a problem occurs, the user can contact the team responsible and the application can be restarted. \", \"However, customers often have higher expectations for the applications they consume. You should know\", \" when problems occur with your application *before* users do, or before users notify you. Otherwise,\", \" the first you know about a problem may be when you notice an angry deluge of social media posts der\", \"iding your application or even your organization.\\n\\nSome scenarios you may need to consider include:\\n\", \"\\n- One service in your application keeps failing and restarting, resulting in intermittent slow resp\", \"onses.\\n- At some times of the day, your application's response time is slow.\\n- After a recent deploy\", \"ment, load on the database has tripled.\\n\\nImplemented properly, monitoring can let you know about con\", \"ditions that will lead to problems, letting you address underlying conditions before they result in \", \"any significant user impact.\\n\\n#### **Monitoring cloud-native apps**\\n\\nSome centralized logging system\", \"s take on an additional role of collecting telemetry outside of pure logs. They can collect metrics,\", \" such as time to run a database query, average response time from a web server, and even CPU load av\", \"erages and memory pressure as reported by the operating system. In conjunction with the logs, these \", \"systems can provide a holistic view of the health of nodes in the system and the application as a wh\", \"ole.\\n\\nThe metric-gathering capabilities of the monitoring tools can also be fed manually from within\", \" the application. Business flows that are of particular interest such as new users signing up or ord\", \"ers being placed, may be instrumented such that they increment a counter in the central monitoring s\", \"ystem. This aspect unlocks the monitoring tools to not only monitor the health of the application bu\", \"t the health of the business.\\n\\nQueries can be constructed in the log aggregation tools to look for c\", \"ertain statistics or patterns, which can then be displayed in graphical form, on custom dashboards. \", \"Frequently, teams will invest in large, wall-mounted displays that rotate through the statistics rel\", \"ated to an application. This way, it's simple to see the problems as they occur.\\n\\nCloud-native monit\", \"oring tools provide real-time telemetry and insight into apps regardless of whether they're single-p\", \"rocess monolithic applications or distributed microservice architectures. They include tools that al\", \"low collection of data from the app as well as tools for querying and displaying information about t\", \"he app's health.\\n\\n#### <span id=\\\"page-139-1\\\"></span>**Challenges with reacting to critical problems \", \"in cloud-native apps**\\n\\nIf you need to react to problems with your application, you need some way to\", \" alert the right personnel. This is the third cloud-native application observability pattern and dep\", \"ends on logging and monitoring. Your application needs to have logging in place to allow problems to\", \" be diagnosed, and\\n\\nin some cases to feed into monitoring tools. It needs monitoring to aggregate ap\", \"plication metrics and health data in one place. Once this has been established, rules can be created\", \" that will trigger alerts when certain metrics fall outside of acceptable levels.\\n\\nGenerally, alerts\", \" are layered on top of monitoring such that certain conditions trigger appropriate alerts to notify \", \"team members of urgent problems. Some scenarios that may require alerts include:\\n\\n- One of your appl\", \"ication's services is not responding after 1 minute of downtime.\\n- Your application is returning uns\", \"uccessful HTTP responses to more than 1% of requests.\\n- Your application's average response time for\", \" key endpoints exceeds 2000 ms.\\n\\n#### **Alerts in cloud-native apps**\\n\\nYou can craft queries against\", \" the monitoring tools to look for known failure conditions. For instance, queries could search throu\", \"gh the incoming logs for indications of HTTP status code 500, which indicates a problem on a web ser\", \"ver. As soon as one of these is detected, then an e-mail or an SMS could be sent to the owner of the\", \" originating service who can begin to investigate.\\n\\nTypically, though, a single 500 error isn't enou\", \"gh to determine that a problem has occurred. It could mean that a user mistyped their password or en\", \"tered some malformed data. The alert queries can be crafted to only fire when a larger than average \", \"number of 500 errors are detected.\\n\\nOne of the most damaging patterns in alerting is to fire too man\", \"y alerts for humans to investigate. Service owners will rapidly become desensitized to errors that t\", \"hey've previously investigated and found to be benign. Then, when true errors occur, they'll be lost\", \" in the noise of hundreds of false positives. The parable of the [Boy Who Cried Wolf](https://en.wik\", \"ipedia.org/wiki/The_Boy_Who_Cried_Wolf) is frequently told to children to warn them of this very dan\", \"ger. It's important to ensure that the alerts that do fire are indicative of a real problem.\\n\\n# <spa\", \"n id=\\\"page-140-0\\\"></span>Logging with Elastic Stack\\n\\nThere are many good centralized logging tools a\", \"nd they vary in cost from being free, open-source tools, to more expensive options. In many cases, t\", \"he free tools are as good as or better than the paid offerings. One such tool is a combination of th\", \"ree open-source components: Elasticsearch, Logstash, and Kibana.\\n\\nCollectively these tools are known\", \" as the Elastic Stack or ELK stack.\\n\\n#### <span id=\\\"page-140-1\\\"></span>**Elastic Stack**\\n\\nThe Elasti\", \"c Stack is a powerful option for gathering information from a Kubernetes cluster. Kubernetes support\", \"s sending logs to an Elasticsearch endpoint, and for the [most part,](https://www.elastic.co/guide/e\", \"n/kibana/master/logging-configuration.html) all you need to get started is to set the environment va\", \"riables as shown in Figure 7-5:\\n\\nKUBE\\\\_LOGGING\\\\_DESTINATION=elasticsearch KUBE\\\\_ENABLE\\\\_NODE\\\\_LOGGIN\", \"G=true\\n\\n*Figure 7-5. Configuration variables for Kubernetes*\\n\\nThis step will install Elasticsearch o\", \"n the cluster and target sending all the cluster logs to it.\\n\\n![](_page_141_Figure_0.jpeg)\\n\\n*Figure \", \"7-6. An example of a Kibana dashboard showing the results of a query against logs that are ingested \", \"from Kubernetes*\\n\\n#### <span id=\\\"page-141-0\\\"></span>**What are the advantages of Elastic Stack?**\\n\\nE\", \"lastic Stack provides centralized logging in a low-cost, scalable, cloud-friendly manner. Its user i\", \"nterface streamlines data analysis so you can spend your time gleaning insights from your data inste\", \"ad of fighting with a clunky interface. It supports a wide variety of inputs so as your distributed \", \"application spans more and different kinds of services, you can expect to continue to be able to fee\", \"d log and metric data into the system. The Elastic Stack also supports fast searches even across lar\", \"ge data sets, making it possible even for large applications to log detailed data and still be able \", \"to have visibility into it in a performant fashion.\\n\\n#### <span id=\\\"page-141-1\\\"></span>**Logstash**\\n\", \"\\nThe first component is [Logstash.](https://www.elastic.co/products/logstash) This tool is used to g\", \"ather log information from a large variety of different sources. For instance, Logstash can read log\", \"s from disk and also receive messages from logging libraries like [Serilog.](https://serilog.net/) L\", \"ogstash can do some basic filtering and expansion on the logs as they arrive. For instance, if your \", \"logs contain IP addresses then Logstash may be configured to do a geographical lookup and obtain a c\", \"ountry/region or even city of origin for that message.\\n\\nSerilog is a logging library for .NET langua\", \"ges, which allows for parameterized logging. Instead of generating a textual log message that embeds\", \" fields, parameters are kept separate. This library allows for more intelligent filtering and search\", \"ing. A sample Serilog configuration for writing to Logstash appears in Figure 7-7.\\n\\n```\\nvar log = ne\", \"w LoggerConfiguration()\\n .WriteTo.Http(\\\"http://localhost:8080\\\")\\n .CreateLogger();\\n```\\n\\n*Figure 7-7. \", \"Serilog config for writing log information directly to logstash over HTTP*\\n\\nLogstash would use a con\", \"figuration like the one shown in Figure 7-8.\\n\\n```\\ninput {\\n http {\\n #default host 0.0.0.0:8080\\n codec\", \" => json\\n }\\n}\\noutput {\\n elasticsearch {\\n hosts => \\\"elasticsearch:9200\\\"\\n index=>\\\"sales-%{+xxxx.ww}\\\"\\n \", \"}\\n}\\n```\\n\\n*Figure 7-8. A Logstash configuration for consuming logs from Serilog*\\n\\nFor scenarios where\", \" extensive log manipulation isn't needed there's an alternative to Logstash known as [Beats.](https:\", \"//www.elastic.co/products/beats) Beats is a family of tools that can gather a wide variety of data f\", \"rom logs to network data and uptime information. Many applications will use both Logstash and Beats.\", \"\\n\\nOnce the logs have been gathered by Logstash, it needs somewhere to put them. While Logstash suppo\", \"rts many different outputs, one of the more exciting ones is Elasticsearch.\\n\\n#### <span id=\\\"page-142\", \"-0\\\"></span>**Elasticsearch**\\n\\nElasticsearch is a powerful search engine that can index logs as they \", \"arrive. It makes running queries against the logs quick. Elasticsearch can handle huge quantities of\", \" logs and, in extreme cases, can be scaled out across many nodes.\\n\\nLog messages that have been craft\", \"ed to contain parameters or that have had parameters split from them through Logstash processing, ca\", \"n be queried directly as Elasticsearch preserves this information.\\n\\nA query that searches for the to\", \"p 10 pages visited by jill@example.com, appears in Figure 7-9.\\n\\n```\\n\\\"query\\\": {\\n \\\"match\\\": {\\n \\\"user\\\": \", \"\\\"jill@example.com\\\"\\n }\\n },\\n \\\"aggregations\\\": {\\n \\\"top_10_pages\\\": {\\n \\\"terms\\\": {\\n \\\"field\\\": \\\"page\\\",\\n \\\"size\", \"\\\": 10\\n }\\n }\\n }\\n```\\n\\n*Figure 7-9. An Elasticsearch query for finding top 10 pages visited by a user*\\n\", \"\\n#### <span id=\\\"page-142-1\\\"></span>**Visualizing information with Kibana web dashboards**\\n\\nThe final\", \" component of the stack is Kibana. This tool is used to provide interactive visualizations in a web \", \"dashboard. Dashboards may be crafted even by users who are non-technical. Most data that is resident\", \" in the Elasticsearch index, can be included in the Kibana dashboards. Individual users may\\n\\nhave di\", \"fferent dashboard desires and Kibana enables this customization through allowing userspecific dashbo\", \"ards.\\n\\n#### <span id=\\\"page-143-0\\\"></span>**Installing Elastic Stack on Azure**\\n\\nThe Elastic stack ca\", \"n be installed on Azure in many ways. As always, it's possible to [provision virtual](https://docs.m\", \"icrosoft.com/azure/virtual-machines/linux/tutorial-elasticsearch)  [machines and install Elastic Sta\", \"ck on them directly.](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-elasticsearch\", \") This option is preferred by some experienced users as it offers the highest degree of customizabil\", \"ity. Deploying on infrastructure as a service introduces significant management overhead forcing tho\", \"se who take that path to take ownership of all the tasks associated with infrastructure as a service\", \" such as securing the machines and keeping up-to-date with patches.\\n\\nAn option with less overhead is\", \" to make use of one of the many Docker containers on which the Elastic Stack has already been config\", \"ured. These containers can be dropped into an existing Kubernetes cluster and run alongside applicat\", \"ion code. The [sebp/elk](https://elk-docker.readthedocs.io/) container is a well-documented and test\", \"ed Elastic Stack container.\\n\\nAnother option is a [recently announced ELK-as-a-service offering.](htt\", \"ps://devops.com/logz-io-unveils-azure-open-source-elk-monitoring-solution/)\\n\\n#### <span id=\\\"page-143\", \"-1\\\"></span>**References**\\n\\n\\u2022 [Install Elastic Stack on Azure](https://docs.microsoft.com/azure/virtu\", \"al-machines/linux/tutorial-elasticsearch)\\n\\n# <span id=\\\"page-143-2\\\"></span>Monitoring in Azure Kubern\", \"etes Services\\n\\nThe built-in logging in Kubernetes is primitive. However, there are some great option\", \"s for getting the logs out of Kubernetes and into a place where they can be properly analyzed. If yo\", \"u need to monitor your AKS clusters, configuring Elastic Stack for Kubernetes is a great solution.\\n\\n\", \"#### <span id=\\\"page-143-3\\\"></span>**Azure Monitor for Containers**\\n\\n[Azure Monitor for Containers](h\", \"ttps://docs.microsoft.com/azure/azure-monitor/insights/container-insights-overview) supports consumi\", \"ng logs from not just Kubernetes but also from other orchestration engines such as DC/OS, Docker Swa\", \"rm, and Red Hat OpenShift.\\n\\n![](_page_144_Figure_0.jpeg)\\n\\n*Figure 7-10. Consuming logs from various \", \"containers*\\n\\n[Prometheus](https://prometheus.io/) is a popular open source metric monitoring solutio\", \"n. It is part of the Cloud Native Compute Foundation. Typically, using Prometheus requires managing \", \"a Prometheus server with its own store. However, [Azure Monitor for Containers provides direct integ\", \"ration with Prometheus](https://docs.microsoft.com/azure/azure-monitor/insights/container-insights-p\", \"rometheus-integration)  [metrics endpoints,](https://docs.microsoft.com/azure/azure-monitor/insights\", \"/container-insights-prometheus-integration) so a separate server is not required.\\n\\nLog and metric in\", \"formation is gathered not just from the containers running in the cluster but also from the cluster \", \"hosts themselves. It allows correlating log information from the two making it much easier to track \", \"down an error.\\n\\nInstalling the log collectors differs on [Windows](https://docs.microsoft.com/azure/\", \"azure-monitor/insights/containers#configure-a-log-analytics-windows-agent-for-kubernetes) and [Linux\", \"](https://docs.microsoft.com/azure/azure-monitor/insights/containers#configure-a-log-analytics-linux\", \"-agent-for-kubernetes) clusters. But in both cases the log collection is implemented as a Kubernetes\", \" [DaemonSet,](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/) meaning that the\", \" log collector is run as a container on each of the nodes.\\n\\nNo matter which orchestrator or operatin\", \"g system is running the Azure Monitor daemon, the log information is forwarded to the same Azure Mon\", \"itor tools with which users are familiar. This approach ensures a parallel experience in environment\", \"s that mix different log sources such as a hybrid Kubernetes/Azure Functions environment.\\n\\n![](_page\", \"_145_Figure_0.jpeg)\\n\\n*Figure 7-11. A sample dashboard showing logging and metric information from ma\", \"ny running containers.*\\n\\n#### <span id=\\\"page-145-0\\\"></span>**Log.Finalize()**\\n\\nLogging is one of the\", \" most overlooked and yet most important parts of deploying any application at scale. As the size and\", \" complexity of applications increase, then so does the difficulty of debugging them. Having top qual\", \"ity logs available makes debugging much easier and moves it from the realm of \\\"nearly impossible\\\" to\", \" \\\"a pleasant experience\\\".\\n\\n# <span id=\\\"page-145-1\\\"></span>Azure Monitor\\n\\nNo other cloud provider has\", \" as mature of a cloud application monitoring solution than that found in Azure. Azure Monitor is an \", \"umbrella name for a collection of tools designed to provide visibility into the state of your system\", \". It helps you understand how your cloud-native services are performing and proactively identifies i\", \"ssues affecting them. Figure 7-12 presents a high level of view of Azure Monitor.\\n\\n![](_page_146_Fig\", \"ure_0.jpeg)\\n\\n*Figure 7-12. High-level view of Azure Monitor.*\\n\\n#### <span id=\\\"page-146-0\\\"></span>**G\", \"athering logs and metrics**\\n\\nThe first step in any monitoring solution is to gather as much data as \", \"possible. The more data gathered, the deeper the insights. Instrumenting systems has traditionally b\", \"een difficult. Simple Network Management Protocol (SNMP) was the gold standard protocol for collecti\", \"ng machine level information, but it required a great deal of knowledge and configuration. Fortunate\", \"ly, much of this hard work has been eliminated as the most common metrics are gathered automatically\", \" by Azure Monitor.\\n\\nApplication level metrics and events aren't possible to instrument automatically\", \" because they're specific to the application being deployed. In order to gather these metrics, there\", \" are [SDKs and APIs](https://docs.microsoft.com/azure/azure-monitor/app/api-custom-events-metrics)  \", \"[available](https://docs.microsoft.com/azure/azure-monitor/app/api-custom-events-metrics) to directl\", \"y report such information, such as when a customer signs up or completes an order. Exceptions can al\", \"so be captured and reported back into Azure Monitor via Application Insights. The SDKs support most \", \"every language found in Cloud Native Applications including Go, Python, JavaScript, and the .NET lan\", \"guages.\\n\\nThe ultimate goal of gathering information about the state of your application is to ensure\", \" that your end users have a good experience. What better way to tell if users are experiencing issue\", \"s than doing [outside-in web tests?](https://docs.microsoft.com/azure/azure-monitor/app/monitor-web-\", \"app-availability) These tests can be as simple as pinging your website from locations around the wor\", \"ld or as involved as having agents log into the site and simulate user actions.\\n\\n#### <span id=\\\"page\", \"-146-1\\\"></span>**Reporting data**\\n\\nOnce the data is gathered, it can be manipulated, summarized, and\", \" plotted into charts, which allow users to instantly see when there are problems. These charts can b\", \"e gathered into dashboards or into Workbooks, a multi-page report designed to tell a story about som\", \"e aspect of the system.\\n\\nNo modern application would be complete without some artificial intelligenc\", \"e or machine learning. To this end, data [can be passed](https://www.youtube.com/watch?v=Cuza-I1g9tw\", \") to the various machine learning tools in Azure to allow you to extract trends and information that\", \" would otherwise be hidden.\\n\\nApplication Insights provides a powerful (SQL-like) query language call\", \"ed *Kusto* that can query records, summarize them, and even plot charts. For example, the following \", \"query will locate all records for the month of November 2007, group them by state, and plot the top \", \"10 as a pie chart.\\n\\n```\\nStormEvents\\n| where StartTime >= datetime(2007-11-01) and StartTime < dateti\", \"me(2007-12-01)\\n| summarize count() by State\\n| top 10 by count_\\n| render piechart\\n```\\n\\nFigure 7-13 sh\", \"ows the results of this Application Insights Query.\\n\\n![](_page_147_Figure_4.jpeg)\\n\\n*Figure 7-13. App\", \"lication Insights query results.*\\n\\nThere is a [playground for experimenting with Kusto](https://data\", \"explorer.azure.com/clusters/help/databases/Samples) queries. Reading [sample queries](https://docs.m\", \"icrosoft.com/azure/kusto/query/samples) can also be instructive.\\n\\n#### <span id=\\\"page-147-0\\\"></span>\", \"**Dashboards**\\n\\nThere are several different dashboard technologies that may be used to surface the i\", \"nformation from Azure Monitor. Perhaps the simplest is to just run queries in Application Insights a\", \"nd [plot the data](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-app-dashboards)  [i\", \"nto a chart.](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-app-dashboards)\\n\\n![](_pa\", \"ge_148_Figure_0.jpeg)\\n\\n*Figure 7-14. An example of Application Insights charts embedded in the main \", \"Azure Dashboard.*\\n\\nThese charts can then be embedded in the Azure portal proper through use of the d\", \"ashboard feature. For users with more exacting requirements, such as being able to drill down into s\", \"everal tiers of data, Azure Monitor data is available to [Power BI.](https://powerbi.microsoft.com/)\", \" Power BI is an industry-leading, enterprise class, business intelligence tool that can aggregate da\", \"ta from many different data sources.\\n\\n![](_page_149_Figure_0.jpeg)\\n\\n*Figure 7-15. An example Power B\", \"I dashboard.*\\n\\n#### <span id=\\\"page-149-0\\\"></span>**Alerts**\\n\\nSometimes, having data dashboards is in\", \"sufficient. If nobody is awake to watch the dashboards, then it can still be many hours before a pro\", \"blem is addressed, or even detected. To this end, Azure Monitor also provides a top notch [alerting \", \"solution.](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-overview) Alerts can be tr\", \"iggered by a wide range of conditions including:\\n\\n- Metric values\\n- Log search queries\\n- Activity Lo\", \"g events\\n- Health of the underlying Azure platform\\n- Tests for web site availability\\n\\nWhen triggered\", \", the alerts can perform a wide variety of tasks. On the simple side, the alerts may just send an e-\", \"mail notification to a mailing list or a text message to an individual. More involved alerts\\n\\nmight \", \"trigger a workflow in a tool such as PagerDuty, which is aware of who is on call for a particular ap\", \"plication. Alerts can trigger actions in [Microsoft Flow](https://flow.microsoft.com/) unlocking nea\", \"r limitless possibilities for workflows.\\n\\nAs common causes of alerts are identified, the alerts can \", \"be enhanced with details about the common causes of the alerts and the steps to take to resolve them\", \". Highly mature cloud-native application deployments may opt to kick off self-healing tasks, which p\", \"erform actions such as removing failing nodes from a scale set or triggering an autoscaling activity\", \". Eventually it may no longer be necessary to wake up on-call personnel at 2AM to resolve a live-sit\", \"e issue as the system will be able to adjust itself to compensate or at least limp along until someb\", \"ody arrives at work the next morning.\\n\\nAzure Monitor automatically leverages machine learning to und\", \"erstand the normal operating parameters of deployed applications. This approach enables it to detect\", \" services that are operating outside of their normal parameters. For instance, the typical weekday t\", \"raffic on the site might be 10,000 requests per minute. And then, on a given week, suddenly the numb\", \"er of requests hits a highly unusual 20,000 requests per minute. [Smart Detection](https://docs.micr\", \"osoft.com/azure/azure-monitor/app/proactive-diagnostics) will notice this deviation from the norm an\", \"d trigger an alert. At the same time, the trend analysis is smart enough to avoid firing false posit\", \"ives when the traffic load is expected.\\n\\n#### <span id=\\\"page-150-0\\\"></span>**References**\\n\\n\\u2022 [Azure \", \"Monitor](https://docs.microsoft.com/azure/azure-monitor/overview)\\n\\n# <span id=\\\"page-151-0\\\"></span>Cl\", \"oud-native identity\\n\\nMost software applications need to have some knowledge of the user or process t\", \"hat is calling them. The user or process interacting with an application is known as a security prin\", \"cipal, and the process of authenticating and authorizing these principals is known as identity manag\", \"ement, or simply *identity*. Simple applications may include all of their identity management within\", \" the application, but this approach doesn't scale well with many applications and many kinds of secu\", \"rity principals. Windows supports the use of Active Directory to provide centralized authentication \", \"and authorization.\\n\\nWhile this solution is effective within corporate networks, it isn't designed fo\", \"r use by users or applications that are outside of the AD domain. With the growth of Internet-based \", \"applications and the rise of cloud-native apps, security models have evolved.\\n\\nIn today's cloud-nati\", \"ve identity model, architecture is assumed to be distributed. Apps can be deployed anywhere and may \", \"communicate with other apps anywhere. Clients may communicate with these apps from anywhere, and in \", \"fact, clients may consist of any combination of platforms and devices. Cloud-native identity solutio\", \"ns use open standards to achieve secure application access from clients. These clients range from hu\", \"man users on PCs or phones, to other apps hosted anywhere online, to set-top boxes and IOT devices r\", \"unning any software platform anywhere in the world.\\n\\nModern cloud-native identity solutions typicall\", \"y use access tokens that are issued by a secure token service/server (STS) to a security principal o\", \"nce their identity is determined. The access token, typically a JSON Web Token (JWT), includes *clai\", \"ms* about the security principal. These claims will minimally include the user's identity but may al\", \"so include other claims that can be used by applications to determine the level of access to grant t\", \"he principal.\\n\\nTypically, the STS is only responsible for authenticating the principal. Determining \", \"their level of access to resources is left to other parts of the application.\\n\\n# <span id=\\\"page-151-\", \"1\\\"></span>References\\n\\n\\u2022 [Microsoft identity platform](https://docs.microsoft.com/azure/active-direct\", \"ory/develop/)\\n\\n# <span id=\\\"page-151-2\\\"></span>Authentication and authorization in cloud-native apps\\n\", \"\\n*Authentication* is the process of determining the identity of a security principal. *Authorization\", \"* is the act of granting an authenticated principal permission to perform an action or access a reso\", \"urce. Sometimes authentication is shortened to AuthN and authorization is shortened to AuthZ. Cloudn\", \"ative applications need to rely on open HTTP-based protocols to authenticate security principals sin\", \"ce both clients and applications could be running anywhere in the world on any platform or device. T\", \"he only common factor is HTTP.\\n\\nMany organizations still rely on local authentication services like \", \"Active Directory Federation Services (ADFS). While this approach has traditionally served organizati\", \"ons well for on premises authentication needs, cloud-native applications benefit from systems design\", \"ed specifically for the cloud. A recent 2019 United Kingdom National Cyber Security Centre (NCSC) ad\", \"visory states that \\\"organizations using Azure AD as their primary authentication source will actuall\", \"y lower their risk compared to ADFS.\\\" Some reasons outlined in [this analysis](https://oxfordcompute\", \"rgroup.com/resources/o365-security-native-cloud-authentication/) include:\\n\\n- Access to full set of M\", \"icrosoft credential protection technologies.\\n- Most organizations are already relying on Azure AD to\", \" some extent.\\n- Double hashing of NTLM hashes ensures compromise won't allow credentials that work i\", \"n local Active Directory.\\n\\n#### <span id=\\\"page-152-0\\\"></span>**References**\\n\\n- [Authentication basic\", \"s](https://docs.microsoft.com/azure/active-directory/develop/authentication-scenarios)\\n- [Access tok\", \"ens and claims](https://docs.microsoft.com/azure/active-directory/develop/access-tokens)\\n- <span id=\", \"\\\"page-152-1\\\"></span>\\u2022 [It may be time to ditch your on premises authentication services](https://oxf\", \"ordcomputergroup.com/resources/o365-security-native-cloud-authentication/)\\n\\n# Azure Active Directory\", \"\\n\\nMicrosoft Azure Active Directory (Azure AD) offers identity and access management as a service. Cu\", \"stomers use it to configure and maintain who users are, what information to store about them, who ca\", \"n access that information, who can manage it, and what apps can access it. AAD can authenticate user\", \"s for applications configured to use it, providing a single sign-on (SSO) experience. It can be used\", \" on its own or be integrated with Windows AD running on premises.\\n\\nAzure AD is built for the cloud. \", \"It's truly a cloud-native identity solution that uses a REST-based Graph API and OData syntax for qu\", \"eries, unlike Windows AD, which uses LDAP. On premises Active Directory can sync user attributes to \", \"the cloud using Identity Sync Services, allowing all authentication to take place in the cloud using\", \" Azure AD. Alternately, authentication can be configured via Connect to pass back to local Active Di\", \"rectory via ADFS to be completed by Windows AD on premises.\\n\\nAzure AD supports company branded sign-\", \"in screens, multi-factory authentication, and cloud-based application proxies that are used to provi\", \"de SSO for applications hosted on premises. It offers different kinds of security reporting and aler\", \"t capabilities.\\n\\n#### <span id=\\\"page-152-2\\\"></span>**References**\\n\\n\\u2022 [Microsoft identity platform](h\", \"ttps://docs.microsoft.com/azure/active-directory/develop/)\\n\\n# <span id=\\\"page-153-0\\\"></span>IdentityS\", \"erver for cloud-native applications\\n\\nIdentityServer is an authentication server that implements Open\", \"ID Connect (OIDC) and OAuth 2.0 standards for ASP.NET Core. It's designed to provide a common way to\", \" authenticate requests to all of your applications, whether they're web, native, mobile, or API endp\", \"oints. IdentityServer can be used to implement Single Sign-On (SSO) for multiple applications and ap\", \"plication types. It can be used to authenticate actual users via sign-in forms and similar user inte\", \"rfaces as well as service-based authentication that typically involves token issuance, verification,\", \" and renewal without any user interface. IdentityServer is designed to be a customizable solution. E\", \"ach instance is typically customized to suit an individual organization and/or set of applications' \", \"needs.\\n\\n#### <span id=\\\"page-153-1\\\"></span>**Common web app scenarios**\\n\\nTypically, applications need\", \" to support some or all of the following scenarios:\\n\\n- Human users accessing web applications with a\", \" browser.\\n- Human users accessing back-end Web APIs from browser-based apps.\\n- Human users on mobile\", \"/native clients accessing back-end Web APIs.\\n- Other applications accessing back-end Web APIs (witho\", \"ut an active user or user interface).\\n- Any application may need to interact with other Web APIs, us\", \"ing its own identity or delegating to the user's identity.\\n\\n![](_page_153_Figure_9.jpeg)\\n\\n*Figure 8-\", \"1. Application types and scenarios.*\\n\\nIn each of these scenarios, the exposed functionality needs to\", \" be secured against unauthorized use. At a minimum, this typically requires authenticating the user \", \"or principal making a request for a resource. This authentication may use one of several common prot\", \"ocols such as SAML2p, WS-Fed, or OpenID Connect. Communicating with APIs typically uses the OAuth2 p\", \"rotocol and its support for security tokens. Separating these critical cross-cutting security concer\", \"ns and their implementation details from the applications themselves ensures consistency and improve\", \"s security and maintainability.\\n\\nOutsourcing these concerns to a dedicated product like IdentityServ\", \"er helps the requirement for every application to solve these problems itself.\\n\\nIdentityServer provi\", \"des middleware that runs within an ASP.NET Core application and adds support for OpenID Connect and \", \"OAuth2 (see [supported specifications\\\\)](https://docs.duendesoftware.com/identityserver/v6/overview/\", \"specs/). Organizations would create their own ASP.NET Core app using IdentityServer middleware to ac\", \"t as the STS for all of their token-based security protocols. The IdentityServer middleware exposes \", \"endpoints to support standard functionality, including:\\n\\n- Authorize (authenticate the end user)\\n- T\", \"oken (request a token programmatically)\\n- Discovery (metadata about the server)\\n- User Info (get use\", \"r information with a valid access token)\\n- Device Authorization (used to start device flow authoriza\", \"tion)\\n- Introspection (token validation)\\n- Revocation (token revocation)\\n- End Session (trigger sing\", \"le sign-out across all apps)\\n\\n#### <span id=\\\"page-154-0\\\"></span>**Getting started**\\n\\nIdentityServer4\", \" is available under dual license:\\n\\n- RPL lets you use the IdentityServer4 free if used in open-sourc\", \"e work\\n- Paid lets you use the IdentityServer4 in a commercial scenario\\n\\nFor more information about \", \"pricing, see the official product's [pricing page.](https://duendesoftware.com/products/identityserv\", \"er)\\n\\nYou can add it to your applications using its NuGet packages. The main package is [IdentityServ\", \"er4,](https://www.nuget.org/packages/IdentityServer4/)  which has been downloaded over four million \", \"times. The base package doesn't include any user interface code and only supports in-memory configur\", \"ation. To use it with a database, you'll also want a data provider like [IdentityServer4.EntityFrame\", \"work,](https://www.nuget.org/packages/IdentityServer4.EntityFramework) which uses Entity Framework C\", \"ore to store configuration and operational data for IdentityServer. For user interface, you can copy\", \" files from the [Quickstart UI repository](https://github.com/IdentityServer/IdentityServer4.Quickst\", \"art.UI) into your ASP.NET Core MVC application to add support for sign in and sign out using Identit\", \"yServer middleware.\\n\\n#### <span id=\\\"page-154-1\\\"></span>**Configuration**\\n\\nIdentityServer supports di\", \"fferent kinds of protocols and social authentication providers that can be configured as part of eac\", \"h custom installation. This is typically done in the ASP.NET Core application's Program class (or in\", \" the Startup class in the ConfigureServices method). The configuration involves specifying the suppo\", \"rted protocols and the paths to the servers and endpoints that will be used. Figure 8-2 shows an exa\", \"mple configuration taken from the IdentityServer4 Quickstart UI project:\\n\\n```\\npublic class Startup\\n{\", \"\\n public void ConfigureServices(IServiceCollection services)\\n {\\n services.AddMvc();\\n```\\n\\n```\\n // som\", \"e details omitted\\n services.AddIdentityServer();\\n services.AddAuthentication()\\n .AddGoogle(\\\"Google\\\",\", \" options =>\\n {\\n options.SignInScheme =\\nIdentityServerConstants.ExternalCookieAuthenticationScheme;\\n \", \"options.ClientId = \\\"<insert here>\\\";\\n options.ClientSecret = \\\"<insert here>\\\";\\n })\\n .AddOpenIdConnect(\", \"\\\"demoidsrv\\\", \\\"IdentityServer\\\", options =>\\n {\\n options.SignInScheme =\\nIdentityServerConstants.Externa\", \"lCookieAuthenticationScheme;\\n options.SignOutScheme = IdentityServerConstants.SignoutScheme;\\n option\", \"s.Authority = \\\"https://demo.identityserver.io/\\\";\\n options.ClientId = \\\"implicit\\\";\\n options.ResponseTy\", \"pe = \\\"id_token\\\";\\n options.SaveTokens = true;\\n options.CallbackPath = new PathString(\\\"/signin-idsrv\\\")\", \";\\n options.SignedOutCallbackPath = new PathString(\\\"/signout-callback-idsrv\\\");\\n options.RemoteSignOut\", \"Path = new PathString(\\\"/signout-idsrv\\\");\\n options.TokenValidationParameters = new TokenValidationPar\", \"ameters\\n {\\n NameClaimType = \\\"name\\\",\\n RoleClaimType = \\\"role\\\"\\n };\\n });\\n }\\n}\\n```\\n\\n*Figure 8-2. Configur\", \"ing IdentityServer.*\\n\\n#### <span id=\\\"page-155-0\\\"></span>**JavaScript clients**\\n\\nMany cloud-native ap\", \"plications use server-side APIs and rich client single page applications (SPAs) on the front end. Id\", \"entityServer ships a [JavaScript client](https://docs.duendesoftware.com/identityserver/v6/quickstar\", \"ts/js_clients/) (oidc-client.js) via NPM that can be added to SPAs to enable them to use IdentitySer\", \"ver for sign in, sign out, and token-based authentication of web APIs.\\n\\n#### <span id=\\\"page-155-1\\\"><\", \"/span>**References**\\n\\n- [IdentityServer documentation](https://docs.duendesoftware.com/identityserve\", \"r/v6/)\\n- [Application types](https://docs.microsoft.com/azure/active-directory/develop/app-types)\\n- \", \"[JavaScript OIDC client](https://docs.duendesoftware.com/identityserver/v6/quickstarts/js_clients/)\\n\", \"\\n# <span id=\\\"page-156-0\\\"></span>Cloud-native security\\n\\nNot a day goes by where the news doesn't cont\", \"ain some story about a company being hacked or somehow losing their customers' data. Even countries/\", \"regions aren't immune to the problems created by treating security as an afterthought. For years, co\", \"mpanies have treated the security of customer data and, in fact, their entire networks as something \", \"of a \\\"nice to have\\\". Windows servers were left unpatched, ancient versions of PHP kept running, and \", \"MongoDB databases left wide open to the world.\\n\\nHowever, there are starting to be real-world consequ\", \"ences for not maintaining a security mindset when building and deploying applications. Many companie\", \"s learned the hard way what can happen when servers and desktops aren't patched during the 2017 outb\", \"reak of [NotPetya.](https://www.wired.com/story/notpetya-cyberattack-ukraine-russia-code-crashed-the\", \"-world/) The cost of these attacks has easily reached into the billions, with some estimates putting\", \" the losses from this single attack at 10 billion US dollars.\\n\\nEven governments aren't immune to hac\", \"king incidents. The city of Baltimore was held ransom by [criminals](https://www.vox.com/recode/2019\", \"/5/21/18634505/baltimore-ransom-robbinhood-mayor-jack-young-hackers) making it impossible for citize\", \"ns to pay their bills or use city services.\\n\\nThere has also been an increase in legislation that man\", \"dates certain data protections for personal data. In Europe, GDPR has been in effect for more than a\", \" year and, more recently, California passed their own version called CCDA, which comes into effect J\", \"anuary 1, 2020. The fines under GDPR can be so punishing as to put companies out of business. Google\", \" has already been fined 50 million Euros for violations, but that's just a drop in the bucket compar\", \"ed with the potential fines.\\n\\n<span id=\\\"page-156-1\\\"></span>In short, security is serious business.\\n\\n\", \"# Azure security for cloud-native apps\\n\\nCloud-native applications can be both easier and more diffic\", \"ult to secure than traditional applications. On the downside, you need to secure more smaller applic\", \"ations and dedicate more energy to build out the security infrastructure. The heterogeneous nature o\", \"f programming languages and styles in most service deployments also means you need to pay more atten\", \"tion to security bulletins from many different providers.\\n\\nOn the flip side, smaller services, each \", \"with their own data store, limit the scope of an attack. If an attacker compromises one system, it's\", \" probably more difficult for the attacker to make the jump to another system than it is in a monolit\", \"hic application. Process boundaries are strong boundaries. Also, if a database backup gets exposed, \", \"then the damage is more limited, as that database contains only a subset of data and is unlikely to \", \"contain personal data.\\n\\n#### <span id=\\\"page-157-0\\\"></span>**Threat modeling**\\n\\nNo matter if the adva\", \"ntages outweigh the disadvantages of cloud-native applications, the same holistic security mindset m\", \"ust be followed. Security and secure thinking must be part of every step of the development and oper\", \"ations story. When planning an application ask questions like:\\n\\n- What would be the impact of this d\", \"ata being lost?\\n- How can we limit the damage from bad data being injected into this service?\\n- Who \", \"should have access to this data?\\n- Are there auditing policies in place around the development and r\", \"elease process?\\n\\nAll these questions are part of a process called [threat modeling.](https://docs.mi\", \"crosoft.com/azure/security/azure-security-threat-modeling-tool) This process tries to answer the que\", \"stion of what threats there are to the system, how likely the threats are, and the potential damage \", \"from them.\\n\\nOnce the list of threats has been established, you need to decide whether they're worth \", \"mitigating. Sometimes a threat is so unlikely and expensive to plan for that it isn't worth spending\", \" energy on it. For instance, some state level actor could inject changes into the design of a proces\", \"s that is used by millions of devices. Now, instead of running a certain piece of code in [Ring 3,](\", \"https://en.wikipedia.org/wiki/Protection_ring) that code is run in Ring 0. This process allows an ex\", \"ploit that can bypass the hypervisor and run the attack code on the bare metal machines, allowing at\", \"tacks on all the virtual machines that are running on that hardware.\\n\\nThe altered processors are dif\", \"ficult to detect without a microscope and advanced knowledge of the on silicon design of that proces\", \"sor. This scenario is unlikely to happen and expensive to mitigate, so probably no threat model woul\", \"d recommend building exploit protection for it.\\n\\nMore likely threats, such as broken access controls\", \" permitting Id incrementing attacks (replacing Id=2 with Id=3 in the URL) or SQL injection, are more\", \" attractive to build protections against. The mitigations for these threats are quite reasonable to \", \"build and prevent embarrassing security holes that smear the company's reputation.\\n\\n#### <span id=\\\"p\", \"age-157-1\\\"></span>**Principle of least privilege**\\n\\nOne of the founding ideas in computer security i\", \"s the Principle of Least Privilege (POLP). It's actually a foundational idea in most any form of sec\", \"urity be it digital or physical. In short, the principle is that any user or process should have the\", \" smallest number of rights possible to execute its task.\\n\\nAs an example, think of the tellers at a b\", \"ank: accessing the safe is an uncommon activity. So, the average teller can't open the safe themselv\", \"es. To gain access, they need to escalate their request through a bank manager, who performs additio\", \"nal security checks.\\n\\nIn a computer system, a fantastic example is the rights of a user connecting t\", \"o a database. In many cases, there's a single user account used to both build the database structure\", \" and run the application. Except in extreme cases, the account running the application doesn't need \", \"the ability to update schema information. There should be several accounts that provide different le\", \"vels of privilege. The application should only use the permission level that grants read and writes \", \"access to the data in the tables. This kind of protection would eliminate attacks that aimed to drop\", \" database tables or introduce malicious triggers.\\n\\nAlmost every part of building a cloud-native appl\", \"ication can benefit from remembering the principle of least privilege. You can find it at play when \", \"setting up firewalls, network security groups, roles, and scopes in Role-based access control (RBAC)\", \".\\n\\n#### <span id=\\\"page-158-0\\\"></span>**Penetration testing**\\n\\nAs applications become more complicate\", \"d the number of attack vectors increases at an alarming rate. Threat modeling is flawed in that it t\", \"ends to be executed by the same people building the system. In the same way that many developers hav\", \"e trouble envisioning user interactions and then build unusable user interfaces, most developers hav\", \"e difficulty seeing every attack vector. It's also possible that the developers building the system \", \"aren't well versed in attack methodologies and miss something crucial.\\n\\nPenetration testing or \\\"pen \", \"testing\\\" involves bringing in external actors to attempt to attack the system. These attackers may b\", \"e an external consulting company or other developers with good security knowledge from another part \", \"of the business. They're given carte blanche to attempt to subvert the system. Frequently, they'll f\", \"ind extensive security holes that need to be patched. Sometimes the attack vector will be something \", \"totally unexpected like exploiting a phishing attack against the CEO.\\n\\nAzure itself is constantly un\", \"dergoing attacks from a [team of hackers inside Microsoft.](https://azure.microsoft.com/resources/vi\", \"deos/red-vs-blue-internal-security-penetration-testing-of-microsoft-azure/) Over the years, they've \", \"been the first to find dozens of potentially catastrophic attack vectors, closing them before they c\", \"an be exploited externally. The more tempting a target, the more likely that eternal actors will att\", \"empt to exploit it and there are a few targets in the world more tempting than Azure.\\n\\n#### <span id\", \"=\\\"page-158-1\\\"></span>**Monitoring**\\n\\nShould an attacker attempt to penetrate an application, there s\", \"hould be some warning of it. Frequently, attacks can be spotted by examining the logs from services.\", \" Attacks leave telltale signs that can be spotted before they succeed. For instance, an attacker att\", \"empting to guess a password will make many requests to a login system. Monitoring around the login s\", \"ystem can detect weird patterns that are out of line with the typical access pattern. This monitorin\", \"g can be turned into an alert that can, in turn, alert an operations person to activate some sort of\", \" countermeasure. A highly mature monitoring system might even take action based on these deviations \", \"proactively adding rules to block requests or throttle responses.\\n\\n#### <span id=\\\"page-158-2\\\"></span\", \">**Securing the build**\\n\\nOne place where security is often overlooked is around the build process. N\", \"ot only should the build run security checks, such as scanning for insecure code or checked-in crede\", \"ntials, but the build itself should be secure. If the build server is compromised, then it provides \", \"a fantastic vector for introducing arbitrary code into the product.\\n\\nImagine that an attacker is loo\", \"king to steal the passwords of people signing into a web application. They could introduce a build s\", \"tep that modifies the checked-out code to mirror any login request to another server. The next time \", \"code goes through the build, it's silently updated. The source code vulnerability scanning won't cat\", \"ch this vulnerability as it runs before the build. Equally, nobody will\\n\\ncatch it in a code review b\", \"ecause the build steps live on the build server. The exploited code will go to production where it c\", \"an harvest passwords. Probably there's no audit log of the build process changes, or at least nobody\", \" monitoring the audit.\\n\\nThis scenario is a perfect example of a seemingly low-value target that can \", \"be used to break into the system. Once an attacker breaches the perimeter of the system, they can st\", \"art working on finding ways to elevate their permissions to the point that they can cause real harm \", \"anywhere they like.\\n\\n#### <span id=\\\"page-159-0\\\"></span>**Building secure code**\\n\\n.NET Framework is a\", \"lready a quite secure framework. It avoids some of the pitfalls of unmanaged code, such as walking o\", \"ff the ends of arrays. Work is actively done to fix security holes as they're discovered. There's ev\", \"en a [bug bounty program](https://www.microsoft.com/msrc/bounty) that pays researchers to find issue\", \"s in the framework and report them instead of exploiting them.\\n\\nThere are many ways to make .NET cod\", \"e more secure. Following guidelines such as the [Secure coding](https://docs.microsoft.com/dotnet/st\", \"andard/security/secure-coding-guidelines)  [guidelines for .NET](https://docs.microsoft.com/dotnet/s\", \"tandard/security/secure-coding-guidelines) article is a reasonable step to take to ensure that the c\", \"ode is secure from the ground up. The [OWASP top 10](https://owasp.org/www-project-top-ten/) is anot\", \"her invaluable guide to build secure code.\\n\\nThe build process is a good place to put scanning tools \", \"to detect problems in source code before they make it into production. Most every project has depend\", \"encies on some other packages. A tool that can scan for outdated packages will catch problems in a n\", \"ightly build. Even when building Docker images, it's useful to check and make sure that the base ima\", \"ge doesn't have known vulnerabilities. Another thing to check is that nobody has accidentally checke\", \"d in credentials.\\n\\n#### <span id=\\\"page-159-1\\\"></span>**Built-in security**\\n\\nAzure is designed to bal\", \"ance usability and security for most users. Different users are going to have different security req\", \"uirements, so they need to fine-tune their approach to cloud security. Microsoft publishes a great d\", \"eal of security information in the [Trust Center.](https://azure.microsoft.com/support/trust-center/\", \") This resource should be the first stop for those professionals interested in understanding how the\", \" built-in attack mitigation technologies work.\\n\\nWithin the Azure portal, the [Azure Advisor](https:/\", \"/azure.microsoft.com/services/advisor/) is a system that is constantly scanning an environment and m\", \"aking recommendations. Some of these recommendations are designed to save users money, but others ar\", \"e designed to identify potentially insecure configurations, such as having a storage container open \", \"to the world and not protected by a Virtual Network.\\n\\n#### <span id=\\\"page-159-2\\\"></span>**Azure netw\", \"ork infrastructure**\\n\\nIn an on-premises deployment environment, a great deal of energy is dedicated \", \"to setting up networking. Setting up routers, switches, and the such is complicated work. Networks a\", \"llow certain resources to talk to other resources and prevent access in some cases. A frequent netwo\", \"rk rule is to restrict access to the production environment from the development environment on the \", \"off chance that a half-developed piece of code runs awry and deletes a swath of data.\\n\\nOut of the bo\", \"x, most PaaS Azure resources have only the most basic and permissive networking setup. For instance,\", \" anybody on the Internet can access an app service. New SQL Server instances typically\\n\\ncome restric\", \"ted, so that external parties can't access them, but the IP address ranges used by Azure itself are \", \"permitted through. So, while the SQL server is protected from external threats, an attacker only nee\", \"ds to set up an Azure bridgehead from where they can launch attacks against all SQL instances on Azu\", \"re.\\n\\nFortunately, most Azure resources can be placed into an Azure Virtual Network that allows fineg\", \"rained access control. Similar to the way that on-premises networks establish private networks that \", \"are protected from the wider world, virtual networks are islands of private IP addresses that are lo\", \"cated within the Azure network.\\n\\n![](_page_160_Picture_2.jpeg)\\n\\n*Figure 9-1. A virtual network in Az\", \"ure.*\\n\\nIn the same way that on-premises networks have a firewall governing access to the network, yo\", \"u can establish a similar firewall at the boundary of the virtual network. By default, all the resou\", \"rces on a virtual network can still talk to the Internet. It's only incoming connections that requir\", \"e some form of explicit firewall exception.\\n\\nWith the network established, internal resources like s\", \"torage accounts can be set up to only allow for access by resources that are also on the Virtual Net\", \"work. This firewall provides an extra level of security, should the keys for that storage account be\", \" leaked, attackers wouldn't be able to connect to it to exploit the leaked keys. This scenario is an\", \"other example of the principle of least privilege.\\n\\nThe nodes in an Azure Kubernetes cluster can par\", \"ticipate in a virtual network just like other resources that are more native to Azure. This function\", \"ality is called [Azure Container Networking Interface.](https://github.com/Azure/azure-container-net\", \"working/blob/master/docs/cni.md) In effect, it allocates a subnet within the virtual network on whic\", \"h virtual machines and container images are allocated.\\n\\nContinuing down the path of illustrating the\", \" principle of least privilege, not every resource within a Virtual Network needs to talk to every ot\", \"her resource. For instance, in an application that provides a web API over a storage account and a S\", \"QL database, it's unlikely that the database and the storage account need to talk to one another. An\", \"y data sharing between them would go through the web application. So, a [network security group \\\\(NS\", \"G\\\\)](https://docs.microsoft.com/azure/virtual-network/security-overview) could be used to deny traff\", \"ic between the two services.\\n\\nA policy of denying communication between resources can be annoying to\", \" implement, especially coming from a background of using Azure without traffic restrictions. On some\", \" other clouds, the concept of network security groups is much more prevalent. For instance, the defa\", \"ult policy on AWS is that resources can't communicate among themselves until enabled by rules in an \", \"NSG. While slower to develop this, a more restrictive environment provides a more secure default. Ma\", \"king use of proper DevOps practices, especially using [Azure Resource Manager or Terraform](#page-18\", \"4-0) to manage permissions can make controlling the rules easier.\\n\\nVirtual Networks can also be usef\", \"ul when setting up communication between on-premises and cloud resources. A virtual private network \", \"can be used to seamlessly attach the two networks together. This approach allows running a virtual n\", \"etwork without any sort of gateway for scenarios where all the users are on-site. There are a number\", \" of technologies that can be used to establish this network. The simplest is to use a [site-to-site \", \"VPN](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways?toc=%252fazure%252fv\", \"irtual-network%252ftoc.json#s2smulti) that can be established between many routers and Azure. Traffi\", \"c is encrypted and tunneled over the Internet at the same cost per byte as any other traffic. For sc\", \"enarios where more bandwidth or more security is desirable, Azure offers a service called [Express](\", \"https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways?toc=%252fazure%252fvirtua\", \"l-network%252ftoc.json#ExpressRoute)  [Route](https://docs.microsoft.com/azure/vpn-gateway/vpn-gatew\", \"ay-about-vpngateways?toc=%252fazure%252fvirtual-network%252ftoc.json#ExpressRoute) that uses a priva\", \"te circuit between an on-premises network and Azure. It's more costly and difficult to establish but\", \" also more secure.\\n\\n#### <span id=\\\"page-161-0\\\"></span>**Role-based access control for restricting ac\", \"cess to Azure resources**\\n\\nRBAC is a system that provides an identity to applications running in Azu\", \"re. Applications can access resources using this identity instead of or in addition to using keys or\", \" passwords.\\n\\n#### <span id=\\\"page-161-1\\\"></span>**Security Principals**\\n\\nThe first component in RBAC \", \"is a security principal. A security principal can be a user, group, service principal, or managed id\", \"entity.\\n\\n![](_page_161_Picture_7.jpeg)\\n\\n*Figure 9-2. Different types of security principals.*\\n\\n- Use\", \"r Any user who has an account in Azure Active Directory is a user.\\n- Group A collection of users fro\", \"m Azure Active Directory. As a member of a group, a user takes on the roles of that group in additio\", \"n to their own.\\n- Service principal A security identity under which services or applications run.\\n\\n\\u2022\", \" Managed identity - An Azure Active Directory identity managed by Azure. Managed identities are typi\", \"cally used when developing cloud applications that manage the credentials for authenticating to Azur\", \"e services.\\n\\nThe security principal can be applied to most any resource. This aspect means that it's\", \" possible to assign a security principal to a container running within Azure Kubernetes, allowing it\", \" to access secrets stored in Key Vault. An Azure Function could take on a permission allowing it to \", \"talk to an Active Directory instance to validate a JWT for a calling user. Once services are enabled\", \" with a service principal, their permissions can be managed granularly using roles and scopes.\\n\\n####\", \" <span id=\\\"page-162-0\\\"></span>**Roles**\\n\\nA security principal can take on many roles or, using a mor\", \"e sartorial analogy, wear many hats. Each role defines a series of permissions such as \\\"Read message\", \"s from Azure Service Bus endpoint\\\". The effective permission set of a security principal is the comb\", \"ination of all the permissions assigned to all the roles that a security principal has. Azure has a \", \"large number of built-in roles and users can define their own roles.\\n\\n![](_page_162_Figure_4.jpeg)\\n\\n\", \"*Figure 9-3. RBAC role definitions.*\\n\\nBuilt into Azure are also a number of high-level roles such as\", \" Owner, Contributor, Reader, and User Account Administrator. With the Owner role, a security princip\", \"al can access all resources and assign permissions to others. A contributor has the same level of ac\", \"cess to all resources but they can't assign permissions. A Reader can only view existing Azure resou\", \"rces and a User Account Administrator can manage access to Azure resources.\\n\\nMore granular built-in \", \"roles such as [DNS Zone Contributor](https://docs.microsoft.com/azure/role-based-access-control/buil\", \"t-in-roles#dns-zone-contributor) have rights limited to a single service. Security principals can ta\", \"ke on any number of roles.\\n\\n#### <span id=\\\"page-163-0\\\"></span>**Scopes**\\n\\nRoles can be applied to a \", \"restricted set of resources within Azure. For instance, applying scope to the previous example of re\", \"ading from a Service Bus queue, you can narrow the permission to a single queue: \\\"Read messages from\", \" Azure Service Bus endpoint blah.servicebus.windows.net/queue1\\\"\\n\\nThe scope can be as narrow as a sin\", \"gle resource or it can be applied to an entire resource group, subscription, or even management grou\", \"p.\\n\\nWhen testing if a security principal has certain permission, the combination of role and scope a\", \"re taken into account. This combination provides a powerful authorization mechanism.\\n\\n#### <span id=\", \"\\\"page-163-1\\\"></span>**Deny**\\n\\nPreviously, only \\\"allow\\\" rules were permitted for RBAC. This behavior \", \"made some scopes complicated to build. For instance, allowing a security principal access to all sto\", \"rage accounts except one required granting explicit permission to a potentially endless list of stor\", \"age accounts. Every time a new storage account was created, it would have to be added to this list o\", \"f accounts. This added management overhead that certainly wasn't desirable.\\n\\nDeny rules take precede\", \"nce over allow rules. Now representing the same \\\"allow all but one\\\" scope could be represented as tw\", \"o rules \\\"allow all\\\" and \\\"deny this one specific one\\\". Deny rules not only ease management but allow \", \"for resources that are extra secure by denying access to everybody.\\n\\n#### <span id=\\\"page-163-2\\\"></sp\", \"an>**Checking access**\\n\\nAs you can imagine, having a large number of roles and scopes can make figur\", \"ing out the effective permission of a service principal quite difficult. Piling deny rules on top of\", \" that, only serves to increase the complexity. Fortunately, there's a [permissions calculator](https\", \"://docs.microsoft.com/azure/role-based-access-control/check-access) that can show the effective perm\", \"issions for any service principal. It's typically found under the IAM tab in the portal, as shown in\", \" Figure 9-3.\\n\\n![](_page_163_Figure_9.jpeg)\\n\\n*Figure 9-4. Permission calculator for an app service.*\\n\", \"\\n#### <span id=\\\"page-164-0\\\"></span>**Securing secrets**\\n\\nPasswords and certificates are a common att\", \"ack vector for attackers. Password-cracking hardware can do a brute-force attack and try to guess bi\", \"llions of passwords per second. So it's important that the passwords that are used to access resourc\", \"es are strong, with a large variety of characters. These passwords are exactly the kind of passwords\", \" that are near impossible to remember. Fortunately, the passwords in Azure don't actually need to be\", \" known by any human.\\n\\nMany security [experts suggest](https://www.troyhunt.com/password-managers-don\", \"t-have-to-be-perfect-they-just-have-to-be-better-than-not-having-one/) that using a password manager\", \" to keep your own passwords is the best approach. While it centralizes your passwords in one locatio\", \"n, it also allows using highly complex passwords and ensuring they're unique for each account. The s\", \"ame system exists within Azure: a central store for secrets.\\n\\n#### <span id=\\\"page-164-1\\\"></span>**Az\", \"ure Key Vault**\\n\\nAzure Key Vault provides a centralized location to store passwords for things such \", \"as databases, API keys, and certificates. Once a secret is entered into the Vault, it's never shown \", \"again and the commands to extract and view it are purposefully complicated. The information in the s\", \"afe is protected using either software encryption or FIPS 140-2 Level 2 validated Hardware Security \", \"Modules.\\n\\nAccess to the key vault is provided through RBACs, meaning that not just any user can acce\", \"ss the information in the vault. Say a web application wishes to access the database connection stri\", \"ng stored in Azure Key Vault. To gain access, applications need to run using a service principal. Un\", \"der this assumed role, they can read the secrets from the safe. There are a number of different secu\", \"rity settings that can further limit the access that an application has to the vault, so that it can\", \"'t update secrets but only read them.\\n\\nAccess to the key vault can be monitored to ensure that only \", \"the expected applications are accessing the vault. The logs can be integrated back into Azure Monito\", \"r, unlocking the ability to set up alerts when unexpected conditions are encountered.\\n\\n#### <span id\", \"=\\\"page-164-2\\\"></span>**Kubernetes**\\n\\nWithin Kubernetes, there's a similar service for maintaining sm\", \"all pieces of secret information. Kubernetes Secrets can be set via the typical kubectl executable.\\n\", \"\\nCreating a secret is as simple as finding the base64 version of the values to be stored:\\n\\n```\\necho \", \"-n 'admin' | base64\\nYWRtaW4=\\necho -n '1f2d1e2e67df' | base64\\nMWYyZDFlMmU2N2Rm\\n```\\n\\nThen adding it to\", \" a secrets file named secret.yml for example that looks similar to the following example:\\n\\n```\\napiVe\", \"rsion: v1\\nkind: Secret\\nmetadata:\\n name: mysecret\\n```\\n\\ntype**:** Opaque\\n\\ndata**:**\\n\\nusername**:** YWR\", \"taW4=\\n\\npassword**:** MWYyZDFlMmU2N2Rm\\n\\nFinally, this file can be loaded into Kubernetes by running t\", \"he following command:\\n\\nkubectl apply -f ./secret.yaml\\n\\nThese secrets can then be mounted into volume\", \"s or exposed to container processes through environment variables. The [Twelve-factor app](https://1\", \"2factor.net/) approach to building applications suggests using the lowest common denominator to tran\", \"smit settings to an application. Environment variables are the lowest common denominator, because th\", \"ey're supported no matter the operating system or application.\\n\\nAn alternative to use the built-in K\", \"ubernetes secrets is to access the secrets in Azure Key Vault from within Kubernetes. The simplest w\", \"ay to do this is to assign an RBAC role to the container looking to load secrets. The application ca\", \"n then use the Azure Key Vault APIs to access the secrets. However, this approach requires modificat\", \"ions to the code and doesn't follow the pattern of using environment variables. Instead, it's possib\", \"le to inject values into a container. This approach is actually more secure than using the Kubernete\", \"s secrets directly, as they can be accessed by users on the cluster.\\n\\n#### <span id=\\\"page-165-0\\\"></s\", \"pan>**Encryption in transit and at rest**\\n\\nKeeping data safe is important whether it's on disk or tr\", \"ansiting between various different services. The most effective way to keep data from leaking is to \", \"encrypt it into a format that can't be easily read by others. Azure supports a wide range of encrypt\", \"ion options.\\n\\n#### **In transit**\\n\\nThere are several ways to encrypt traffic on the network in Azure\", \". The access to Azure services is typically done over connections that use Transport Layer Security \", \"(TLS). For instance, all the connections to the Azure APIs require TLS connections. Equally, connect\", \"ions to endpoints in Azure storage can be restricted to work only over TLS encrypted connections.\\n\\nT\", \"LS is a complicated protocol and simply knowing that the connection is using TLS isn't sufficient to\", \" ensure security. For instance, TLS 1.0 is chronically insecure, and TLS 1.1 isn't much better. Even\", \" within the versions of TLS, there are various settings that can make the connections easier to decr\", \"ypt. The best course of action is to check and see if the server connection is using up-to-date and \", \"well configured protocols.\\n\\nThis check can be done by an external service such as SSL labs' SSL Serv\", \"er Test. A test run against a typical Azure endpoint, in this case a service bus endpoint, yields a \", \"near perfect score of A.\\n\\nEven services like Azure SQL databases use TLS encryption to keep data hid\", \"den. The interesting part about encrypting the data in transit using TLS is that it isn't possible, \", \"even for Microsoft, to listen in on the connection between computers running TLS. This should provid\", \"e comfort for companies concerned that their data may be at risk from Microsoft proper or even a sta\", \"te actor with more resources than the standard attacker.\\n\\n![](_page_166_Figure_3.jpeg)\\n\\n*Figure 9-5.\", \" SSL labs report showing a score of A for a Service Bus endpoint.*\\n\\nWhile this level of encryption i\", \"sn't going to be sufficient for all time, it should inspire confidence that Azure TLS connections ar\", \"e quite secure. Azure will continue to evolve its security standards as encryption improves. It's ni\", \"ce to know that there's somebody watching the security standards and updating Azure as they improve.\", \"\\n\\n#### **At rest**\\n\\nIn any application, there are a number of places where data rests on the disk. T\", \"he application code itself is loaded from some storage mechanism. Most applications also use some ki\", \"nd of a database such as SQL Server, Cosmos DB, or even the amazingly price-efficient Table Storage.\", \" These databases all use heavily encrypted storage to ensure that nobody other than the applications\", \" with proper permissions can read your data. Even the system operators can't read data that has been\", \" encrypted. So customers can remain confident their secret information remains secret.\\n\\n#### **Stora\", \"ge**\\n\\nThe underpinning of much of Azure is the Azure Storage engine. Virtual machine disks are mount\", \"ed on top of Azure Storage. Azure Kubernetes Service runs on virtual machines that, themselves, are \", \"hosted on Azure Storage. Even serverless technologies, such as Azure Functions Apps and Azure Contai\", \"ner Instances, run out of disk that is part of Azure Storage.\\n\\nIf Azure Storage is well encrypted, t\", \"hen it provides for a foundation for most everything else to also be encrypted. Azure Storage [is en\", \"crypted](https://docs.microsoft.com/azure/storage/common/storage-service-encryption) with [FIPS 140-\", \"2](https://en.wikipedia.org/wiki/FIPS_140) compliant [256-bit AES.](https://en.wikipedia.org/wiki/Ad\", \"vanced_Encryption_Standard) This is a wellregarded encryption technology having been the subject of \", \"extensive academic scrutiny over the last 20 or so years. At present, there's no known practical att\", \"ack that would allow someone without knowledge of the key to read data encrypted by AES.\\n\\nBy default\", \", the keys used for encrypting Azure Storage are managed by Microsoft. There are extensive protectio\", \"ns in place to ensure to prevent malicious access to these keys. However, users with particular encr\", \"yption requirements can also [provide their own storage keys](https://docs.microsoft.com/azure/stora\", \"ge/common/storage-encryption-keys-powershell) that are managed in Azure Key Vault. These keys can be\", \" revoked at any time, which would effectively render the contents of the Storage account using them \", \"inaccessible.\\n\\nVirtual machines use encrypted storage, but it's possible to provide another layer of\", \" encryption by using technologies like BitLocker on Windows or DM-Crypt on Linux. These technologies\", \" mean that even if the disk image was leaked off of storage, it would remain near impossible to read\", \" it.\\n\\n#### **Azure SQL**\\n\\nDatabases hosted on Azure SQL use a technology called [Transparent Data En\", \"cryption \\\\(TDE\\\\)](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparen\", \"t-data-encryption) to ensure data remains encrypted. It's enabled by default on all newly created SQ\", \"L databases, but must be enabled manually for legacy databases. TDE executes real-time encryption an\", \"d decryption of not just the database, but also the backups and transaction logs.\\n\\nThe encryption pa\", \"rameters are stored in the master database and, on startup, are read into memory for the remaining o\", \"perations. This means that the master database must remain unencrypted. The actual key is managed by\", \" Microsoft. However, users with exacting security requirements may provide their own key in Key Vaul\", \"t in much the same way as is done for Azure Storage. The Key Vault provides for such services as key\", \" rotation and revocation.\\n\\nThe \\\"Transparent\\\" part of TDS comes from the fact that there aren't clien\", \"t changes needed to use an encrypted database. While this approach provides for good security, leaki\", \"ng the database password is enough for users to be able to decrypt the data. There's another approac\", \"h that encrypts individual columns or tables in a database. [Always Encrypted](https://docs.microsof\", \"t.com/azure/sql-database/sql-database-always-encrypted-azure-key-vault) ensures that at no point the\", \" encrypted data appears in plain text inside the database.\\n\\nSetting up this tier of encryption requi\", \"res running through a wizard in SQL Server Management Studio to select the sort of encryption and wh\", \"ere in Key Vault to store the associated keys.\\n\\n![](_page_168_Figure_0.jpeg)\\n\\n*Figure 9-6. Selecting\", \" columns in a table to be encrypted using Always Encrypted.*\\n\\nClient applications that read informat\", \"ion from these encrypted columns need to make special allowances to read encrypted data. Connection \", \"strings need to be updated with Column Encryption Setting=Enabled and client credentials must be ret\", \"rieved from the Key Vault. The SQL Server client must then be primed with the column encryption keys\", \". Once that is done, the remaining actions use the standard interfaces to SQL Client. That is, tools\", \" like Dapper and Entity Framework, which are built on top of SQL Client, will continue to work witho\", \"ut changes. Always Encrypted may not yet be available for every SQL Server driver on every language.\", \"\\n\\nThe combination of TDE and Always Encrypted, both of which can be used with client-specific keys, \", \"ensures that even the most exacting encryption requirements are supported.\\n\\n#### **Cosmos DB**\\n\\nCosm\", \"os DB is the newest database provided by Microsoft in Azure. It has been built from the ground up wi\", \"th security and cryptography in mind. AES-256bit encryption is standard for all Cosmos DB\\n\\ndatabases\", \" and can't be disabled. Coupled with the TLS 1.2 requirement for communication, the entire storage s\", \"olution is encrypted.\\n\\n![](_page_169_Figure_1.jpeg)\\n\\n*Figure 9-7. The flow of data encryption within\", \" Cosmos DB.*\\n\\nWhile Cosmos DB doesn't provide for supplying customer encryption keys, there has been\", \" significant work done by the team to ensure it remains PCI-DSS compliant without that. Cosmos DB al\", \"so doesn't support any sort of single column encryption similar to Azure SQL's Always Encrypted yet.\", \"\\n\\n#### <span id=\\\"page-169-0\\\"></span>**Keeping secure**\\n\\nAzure has all the tools necessary to release\", \" a highly secure product. However, a chain is only as strong as its weakest link. If the application\", \"s deployed on top of Azure aren't developed with a proper security mindset and good security audits,\", \" then they become the weak link in the chain. There are many great static analysis tools, encryption\", \" libraries, and security practices that can be used to ensure that the software installed on Azure i\", \"s as secure as Azure itself. Examples include [static analysis tools,](https://www.mend.io/sca/)  [e\", \"ncryption libraries,](https://www.libressl.org/) and [security practices.](https://azure.microsoft.c\", \"om/resources/videos/red-vs-blue-internal-security-penetration-testing-of-microsoft-azure/)\\n\\n# <span \", \"id=\\\"page-170-0\\\"></span>DevOps\\n\\nThe favorite mantra of software consultants is to answer \\\"It depends\\\"\", \" to any question posed. It isn't because software consultants are fond of not taking a position. It'\", \"s because there's no one true answer to any questions in software. There's no absolute right and wro\", \"ng, but rather a balance between opposites.\\n\\nTake, for instance, the two major schools of developing\", \" web applications: Single Page Applications (SPAs) versus server-side applications. On the one hand,\", \" the user experience tends to be better with SPAs and the amount of traffic to the web server can be\", \" minimized making it possible to host them on something as simple as static hosting. On the other ha\", \"nd, SPAs tend to be slower to develop and more difficult to test. Which one is the right choice? Wel\", \"l, it depends on your situation.\\n\\nCloud-native applications aren't immune to that same dichotomy. Th\", \"ey have clear advantages in terms of speed of development, stability, and scalability, but managing \", \"them can be quite a bit more difficult.\\n\\nYears ago, it wasn't uncommon for the process of moving an \", \"application from development to production to take a month, or even more. Companies released softwar\", \"e on a 6-month or even every year cadence. One needs to look no further than Microsoft Windows to ge\", \"t an idea for the cadence of releases that were acceptable before the ever-green days of Windows 10.\", \" Five years passed between Windows XP and Vista, a further three between Vista and Windows 7.\\n\\nIt's \", \"now fairly well established that being able to release software rapidly gives fast-moving companies \", \"a huge market advantage over their more sloth-like competitors. It's for that reason that major upda\", \"tes to Windows 10 are now approximately every six months.\\n\\nThe patterns and practices that enable fa\", \"ster, more reliable releases to deliver value to the business are collectively known as DevOps. They\", \" consist of a wide range of ideas spanning the entire software development life cycle from specifyin\", \"g an application all the way up to delivering and operating that application.\\n\\nDevOps emerged before\", \" microservices and it's likely that the movement towards smaller, more fit to purpose services would\", \"n't have been possible without DevOps to make releasing and operating not just one but many applicat\", \"ions in production easier.\\n\\n![](_page_171_Figure_0.jpeg)\\n\\n*Figure 10-1 - DevOps and microservices.*\\n\", \"\\nThrough good DevOps practices, it's possible to realize the advantages of cloud-native applications\", \" without suffocating under a mountain of work actually operating the applications.\\n\\nThere's no golde\", \"n hammer when it comes to DevOps. Nobody can sell a complete and allencompassing solution for releas\", \"ing and operating high-quality applications. This is because each application is wildly different fr\", \"om all others. However, there are tools that can make DevOps a far less daunting proposition. One of\", \" these tools is known as Azure DevOps.\\n\\n# <span id=\\\"page-171-0\\\"></span>Azure DevOps\\n\\nAzure DevOps ha\", \"s a long pedigree. It can trace its roots back to when Team Foundation Server first moved online and\", \" through the various name changes: Visual Studio Online and Visual Studio Team Services. Through the\", \" years, however, it has become far more than its predecessors.\\n\\nAzure DevOps is divided into five ma\", \"jor components:\\n\\n![](_page_171_Picture_7.jpeg)\\n\\n*Figure 10-2 - Azure DevOps.*\\n\\n**Azure Repos** - Sou\", \"rce code management that supports the venerable Team Foundation Version Control (TFVC) and the indus\", \"try favorite [Git.](https://en.wikipedia.org/wiki/Git) Pull requests provide a way to enable social \", \"coding by fostering discussion of changes as they're made.\\n\\n**Azure Boards** - Provides an issue and\", \" work item tracking tool that strives to allow users to pick the workflows that work best for them. \", \"It comes with a number of pre-configured templates including ones to support SCRUM and Kanban styles\", \" of development.\\n\\n**Azure Pipelines** - A build and release management system that supports tight in\", \"tegration with Azure. Builds can be run on various platforms from Windows to Linux to macOS. Build a\", \"gents may be provisioned in the cloud or on-premises.\\n\\n**Azure Test Plans** - No QA person will be l\", \"eft behind with the test management and exploratory testing support offered by the Test Plans featur\", \"e.\\n\\n**Azure Artifacts** - An artifact feed that allows companies to create their own, internal, vers\", \"ions of NuGet, npm, and others. It serves a double purpose of acting as a cache of upstream packages\", \" if there's a failure of a centralized repository.\\n\\nThe top-level organizational unit in Azure DevOp\", \"s is known as a Project. Within each project the various components, such as Azure Artifacts, can be\", \" turned on and off. Each of these components provides different advantages for cloud-native applicat\", \"ions. The three most useful are repositories, boards, and pipelines. If users want to manage their s\", \"ource code in another repository stack, such as GitHub, but still take advantage of Azure Pipelines \", \"and other components, that's perfectly possible.\\n\\nFortunately, development teams have many options w\", \"hen selecting a repository. One of them is GitHub.\\n\\n# <span id=\\\"page-172-0\\\"></span>GitHub Actions\\n\\nF\", \"ounded in 2009, GitHub is a widely popular web-based repository for hosting projects, documentation,\", \" and code. Many large tech companies, such as Apple, Amazon, Google, and mainstream corporations use\", \" GitHub. GitHub uses the open-source, distributed version control system named Git as its foundation\", \". On top, it then adds its own set of features, including defect tracking, feature and pull requests\", \", tasks management, and wikis for each code base.\\n\\nAs GitHub evolves, it too is adding DevOps featur\", \"es. For example, GitHub has its own continuous integration/continuous delivery (CI/CD) pipeline, cal\", \"led GitHub Actions. GitHub Actions is a community-powered workflow automation tool. It lets DevOps t\", \"eams integrate with their existing tooling, mix and match new products, and hook into their software\", \" lifecycle, including existing CI/CD partners.\\\"\\n\\nGitHub has over 40 million users, making it the lar\", \"gest host of source code in the world. In October of 2018, Microsoft purchased GitHub. Microsoft has\", \" pledged that GitHub will remain an [open platform](https://techcrunch.com/2018/06/04/microsoft-prom\", \"ises-to-keep-github-independent-and-open/) that any developer can plug into and extend. It continues\", \" to operate as an independent company. GitHub offers plans for enterprise, team, professional, and f\", \"ree accounts.\\n\\n# <span id=\\\"page-172-1\\\"></span>Source control\\n\\nOrganizing the code for a cloud-native\", \" application can be challenging. Instead of a single giant application, the cloud-native application\", \"s tend to be made up of a web of smaller applications that talk with one another. As with all things\", \" in computing, the best arrangement of code remains an open question. There are examples of successf\", \"ul applications using different kinds of layouts, but two variants seem to have the most popularity.\", \"\\n\\nBefore getting down into the actual source control itself, it's probably worth deciding on how man\", \"y projects are appropriate. Within a single project, there's support for multiple repositories, and \", \"build pipelines. Boards are a little more complicated, but there too, the tasks can easily be assign\", \"ed to multiple teams within a single project. It's possible to support hundreds, even thousands of d\", \"evelopers, out of a single Azure DevOps project. Doing so is likely the best approach as it provides\", \" a single place for all developer to work out of and reduces the confusion of finding that one appli\", \"cation when developers are unsure in which project in which it resides.\\n\\nSplitting up code for micro\", \"services within the Azure DevOps project can be slightly more challenging.\\n\\n![](_page_173_Picture_3.\", \"jpeg)\\n\\n*Figure 10-3 - One vs. many repositories.*\\n\\n#### <span id=\\\"page-173-0\\\"></span>**Repository pe\", \"r microservice**\\n\\nAt first glance, this approach seems like the most logical approach to splitting u\", \"p the source code for microservices. Each repository can contain the code needed to build the one mi\", \"croservice. The advantages to this approach are readily visible:\\n\\n- 1. Instructions for building and\", \" maintaining the application can be added to a README file at the root of each repository. When flip\", \"ping through the repositories, it's easy to find these instructions, reducing spin-up time for devel\", \"opers.\\n- 2. Every service is located in a logical place, easily found by knowing the name of the ser\", \"vice.\\n- 3. Builds can easily be set up such that they're only triggered when a change is made to the\", \" owning repository.\\n- 4. The number of changes coming into a repository is limited to the small numb\", \"er of developers working on the project.\\n\\n- 5. Security is easy to set up by restricting the reposit\", \"ories to which developers have read and write permissions.\\n- 6. Repository level settings can be cha\", \"nged by the owning team with a minimum of discussion with others.\\n\\nOne of the key ideas behind micro\", \"services is that services should be siloed and separated from each other. When using Domain Driven D\", \"esign to decide on the boundaries for services the services act as transactional boundaries. Databas\", \"e updates shouldn't span multiple services. This collection of related data is referred to as a boun\", \"ded context. This idea is reflected by the isolation of microservice data to a database separate and\", \" autonomous from the rest of the services. It makes a great deal of sense to carry this idea all the\", \" way through to the source code.\\n\\nHowever, this approach isn't without its issues. One of the more g\", \"narly development problems of our time is managing dependencies. Consider the number of files that m\", \"ake up the average node\\\\_modules directory. A fresh install of something like create-react-app is li\", \"kely to bring with it thousands of packages. The question of how to manage these dependencies is a d\", \"ifficult one.\\n\\nIf a dependency is updated, then downstream packages must also update this dependency\", \". Unfortunately, that takes development work so, invariably, the node\\\\_modules directory ends up wit\", \"h multiple versions of a single package, each one a dependency of some other package that is version\", \"ed at a slightly different cadence. When deploying an application, which version of a dependency sho\", \"uld be used? The version that is currently in production? The version that is currently in Beta but \", \"is likely to be in production by the time the consumer makes it to production? Difficult problems th\", \"at aren't resolved by just using microservices.\\n\\nThere are libraries that are depended upon by a wid\", \"e variety of projects. By dividing the microservices up with one in each repository the internal dep\", \"endencies can best be resolved by using the internal repository, Azure Artifacts. Builds for librari\", \"es will push their latest versions into Azure Artifacts for internal consumption. The downstream pro\", \"ject must still be manually updated to take a dependency on the newly updated packages.\\n\\nAnother dis\", \"advantage presents itself when moving code between services. Although it would be nice to believe th\", \"at the first division of an application into microservices is 100% correct, the reality is that rare\", \"ly we're so prescient as to make no service division mistakes. Thus, functionality and the code that\", \" drives it will need to move from service to service: repository to repository. When leaping from on\", \"e repository to another, the code loses its history. There are many cases, especially in the event o\", \"f an audit, where having full history on a piece of code is invaluable.\\n\\nThe final and most importan\", \"t disadvantage is coordinating changes. In a true microservices application, there should be no depl\", \"oyment dependencies between services. It should be possible to deploy services A, B, and C in any or\", \"der as they have loose coupling. In reality, however, there are times when it's desirable to make a \", \"change that crosses multiple repositories at the same time. Some examples include updating a library\", \" to close a security hole or changing a communication protocol used by all services.\\n\\nTo do a cross-\", \"repository change requires a commit to each repository be made in succession. Each change in each re\", \"pository will need to be pull-requested and reviewed separately. This activity can be difficult to c\", \"oordinate.\\n\\nAn alternative to using many repositories is to put all the source code together in a gi\", \"ant, all knowing, single repository.\\n\\n#### <span id=\\\"page-175-0\\\"></span>**Single repository**\\n\\nIn th\", \"is approach, sometimes referred to as a [monorepository,](https://danluu.com/monorepo/) all the sour\", \"ce code for every service is put into the same repository. At first, this approach seems like a terr\", \"ible idea likely to make dealing with source code unwieldy. There are, however, some marked advantag\", \"es to working this way.\\n\\nThe first advantage is that it's easier to manage dependencies between proj\", \"ects. Instead of relying on some external artifact feed, projects can directly import one another. T\", \"his means that updates are instant, and conflicting versions are likely to be found at compile time \", \"on the developer's workstation. In effect, shifting some of the integration testing left.\\n\\nWhen movi\", \"ng code between projects, it's now easier to preserve the history as the files will be detected as h\", \"aving been moved rather than being rewritten.\\n\\nAnother advantage is that wide ranging changes that c\", \"ross service boundaries can be made in a single commit. This activity reduces the overhead of having\", \" potentially dozens of changes to review individually.\\n\\nThere are many tools that can perform static\", \" analysis of code to detect insecure programming practices or problematic use of APIs. In a multi-re\", \"pository world, each repository will need to be iterated over to find the problems in them. The sing\", \"le repository allows running the analysis all in one place.\\n\\nThere are also many disadvantages to th\", \"e single repository approach. One of the most worrying ones is that having a single repository raise\", \"s security concerns. If the contents of a repository are leaked in a repository per service model, t\", \"he amount of code lost is minimal. With a single repository, everything the company owns could be lo\", \"st. There have been many examples in the past of this happening and derailing entire game developmen\", \"t efforts. Having multiple repositories exposes less surface area, which is a desirable trait in mos\", \"t security practices.\\n\\nThe size of the single repository is likely to become unmanageable rapidly. T\", \"his presents some interesting performance implications. It may become necessary to use specialized t\", \"ools such as [Virtual](https://github.com/Microsoft/VFSForGit)  [File System for Git,](https://githu\", \"b.com/Microsoft/VFSForGit) which was originally designed to improve the experience for developers on\", \" the Windows team.\\n\\nFrequently the argument for using a single repository boils down to an argument \", \"that Facebook or Google use this method for source code arrangement. If the approach is good enough \", \"for these companies, then, surely, it's the correct approach for all companies. The truth of the mat\", \"ter is that few companies operate on anything like the scale of Facebook or Google. The problems tha\", \"t occur at those scales are different from those most developers will face. What is good for the goo\", \"se may not be good for the gander.\\n\\nIn the end, either solution can be used to host the source code \", \"for microservices. However, in most cases, the management, and engineering overhead of operating in \", \"a single repository isn't worth the meager advantages. Splitting code up over multiple repositories \", \"encourages better separation of concerns and encourages autonomy among development teams.\\n\\n#### <spa\", \"n id=\\\"page-176-0\\\"></span>**Standard directory structure**\\n\\nRegardless of the single versus multiple \", \"repositories debate each service will have its own directory. One of the best optimizations to allow\", \" developers to cross between projects quickly is to maintain a standard directory structure.\\n\\n![](_p\", \"age_176_Picture_2.jpeg)\\n\\n*Figure 10-4 - Standard directory structure.*\\n\\nWhenever a new project is cr\", \"eated, a template that puts in place the correct structure should be used. This template can also in\", \"clude such useful items as a skeleton README file and an azurepipelines.yml. In any microservice arc\", \"hitecture, a high degree of variance between projects makes bulk operations against the services mor\", \"e difficult.\\n\\nThere are many tools that can provide templating for an entire directory, containing s\", \"everal source code directories. [Yeoman](https://yeoman.io/) is popular in the JavaScript world and \", \"GitHub have recently released [Repository Templates,](https://github.blog/2019-06-06-generate-new-re\", \"positories-with-repository-templates/) which provide much of the same functionality.\\n\\n# <span id=\\\"pa\", \"ge-176-1\\\"></span>Task management\\n\\nManaging tasks in any project can be difficult. Up front there are\", \" countless questions to be answered about the sort of workflows to set up to ensure optimal develope\", \"r productivity.\\n\\nCloud-native applications tend to be smaller than traditional software products or \", \"at least they're divided into smaller services. Tracking of issues or tasks related to these service\", \"s remains as important as with any other software project. Nobody wants to lose track of some work i\", \"tem or explain to a customer that their issue wasn't properly logged. Boards are configured at the p\", \"roject level but within each project, areas can be defined. These allow breaking down issues across \", \"several components. The advantage to keeping all the work for the entire application in one place is\", \" that it's easy to move work items from one team to another as they're understood better.\\n\\nAzure Dev\", \"Ops comes with a number of popular templates pre-configured. In the most basic configuration, all th\", \"at is needed to know is what's in the backlog, what people are working on, and what's done. It's imp\", \"ortant to have this visibility into the process of building software, so that work can be prioritize\", \"d and completed tasks reported to the customer. Of course, few software projects stick to a process \", \"as simple as to do, doing, and done. It doesn't take long for people to start adding steps like QA o\", \"r Detailed Specification to the process.\\n\\nOne of the more important parts of Agile methodologies is \", \"self-introspection at regular intervals. These reviews are meant to provide insight into what proble\", \"ms the team is facing and how they can be improved. Frequently, this means changing the flow of issu\", \"es and features through the development process. So, it's perfectly healthy to expand the layouts of\", \" the boards with additional stages.\\n\\nThe stages in the boards aren't the only organizational tool. D\", \"epending on the configuration of the board, there's a hierarchy of work items. The most granular ite\", \"m that can appear on a board is a task. Out of the box a task contains fields for a title, descripti\", \"on, a priority, an estimate of the amount of work remaining and the ability to link to other work it\", \"ems or development items (branches, commits, pull requests, builds, and so forth). Work items can be\", \" classified into different areas of the application and different iterations (sprints) to make findi\", \"ng them easier.\\n\\n![](_page_177_Picture_3.jpeg)\\n\\n*Figure 10-5 - Task in Azure DevOps.*\\n\\nThe descripti\", \"on field supports the normal styles you'd expect (bold, italic underscore and strike through) and th\", \"e ability to insert images. This makes it a powerful tool for use when specifying work or bugs.\\n\\nTas\", \"ks can be rolled up into features, which define a larger unit of work. Features, in turn, can be [ro\", \"lled](https://docs.microsoft.com/azure/devops/boards/backlogs/define-features-epics?view=azure-devop\", \"s&preserve-view=true)  [up into epics.](https://docs.microsoft.com/azure/devops/boards/backlogs/defi\", \"ne-features-epics?view=azure-devops&preserve-view=true) Classifying tasks in this hierarchy makes it\", \" much easier to understand how close a large feature is to rolling out.\\n\\n![](_page_178_Picture_0.jpe\", \"g)\\n\\n*Figure 10-6 - Work item in Azure DevOps.*\\n\\nThere are different kinds of views into the issues i\", \"n Azure Boards. Items that aren't yet scheduled appear in the backlog. From there, they can be assig\", \"ned to a sprint. A sprint is a time box during which it's expected some quantity of work will be com\", \"pleted. This work can include tasks but also the resolution of tickets. Once there, the entire sprin\", \"t can be managed from the Sprint board section. This view shows how work is progressing and includes\", \" a burn down chart to give an ever-updating estimate of if the sprint will be successful.\\n\\n![](_page\", \"_178_Picture_3.jpeg)\\n\\n*Figure 10-7 - Board in Azure DevOps.*\\n\\nBy now, it should be apparent that the\", \"re's a great deal of power in the Boards in Azure DevOps. For developers, there are easy views of wh\", \"at is being worked on. For project managers views into upcoming work as well as an overview of exist\", \"ing work. For managers, there are plenty of reports about resourcing and capacity. Unfortunately, th\", \"ere's nothing magical about cloud-native applications that eliminate the need to track work. But if \", \"you must track work, there are a few places where the experience is better than in Azure DevOps.\\n\\n# \", \"<span id=\\\"page-178-0\\\"></span>CI/CD pipelines\\n\\nAlmost no change in the software development life cycl\", \"e has been so revolutionary as the advent of continuous integration (CI) and continuous delivery (CD\", \"). Building and running automated tests against the source code of a project as soon as a change is \", \"checked in catches mistakes early. Prior to the advent of continuous integration builds, it wouldn't\", \" be uncommon to pull code from the\\n\\nrepository and find that it didn't pass tests or couldn't even b\", \"e built. This resulted in tracking down the source of the breakage.\\n\\nTraditionally shipping software\", \" to the production environment required extensive documentation and a list of steps. Each one of the\", \"se steps needed to be manually completed in a very error prone process.\\n\\n![](_page_179_Picture_2.jpe\", \"g)\\n\\n*Figure 10-8 - Checklist.*\\n\\nThe sister of continuous integration is continuous delivery in which\", \" the freshly built packages are deployed to an environment. The manual process can't scale to match \", \"the speed of development so automation becomes more important. Checklists are replaced by scripts th\", \"at can execute the same tasks faster and more accurately than any human.\\n\\nThe environment to which c\", \"ontinuous delivery delivers might be a test environment or, as is being done by many major technolog\", \"y companies, it could be the production environment. The latter requires an investment in high-quali\", \"ty tests that can give confidence that a change isn't going to break production for users. In the sa\", \"me way that continuous integration caught issues in the code early continuous delivery catches issue\", \"s in the deployment process early.\\n\\nThe importance of automating the build and delivery process is a\", \"ccentuated by cloud-native applications. Deployments happen more frequently and to more environments\", \" so manually deploying borders on impossible.\\n\\n#### <span id=\\\"page-179-0\\\"></span>**Azure Builds**\\n\\nA\", \"zure DevOps provides a set of tools to make continuous integration and deployment easier than ever. \", \"These tools are located under Azure Pipelines. The first of them is Azure Builds, which is a tool fo\", \"r running YAML-based build definitions at scale. Users can either bring their own build machines (gr\", \"eat for if the build requires a meticulously set up environment) or use a machine from a constantly \", \"refreshed pool of Azure hosted virtual machines. These hosted build agents come pre-installed with a\", \" wide range of development tools for not just .NET development but for everything from Java to Pytho\", \"n to iPhone development.\\n\\nDevOps includes a wide range of out of the box build definitions that can \", \"be customized for any build. The build definitions are defined in a file called azure-pipelines.yml \", \"and checked into the repository so they can be versioned along with the source code. This makes it m\", \"uch easier to make changes to the build pipeline in a branch as the changes can be checked into just\", \" that branch. An example azurepipelines.yml for building an ASP.NET web application on full framewor\", \"k is show in Figure 10-9.\\n\\n```\\nname: $(rev:r)\\nvariables:\\n version: 9.2.0.$(Build.BuildNumber)\\n solut\", \"ion: Portals.sln\\n artifactName: drop\\n buildPlatform: any cpu\\n buildConfiguration: release\\npool:\\n nam\", \"e: Hosted VisualStudio\\n demands:\\n - msbuild\\n - visualstudio\\n - vstest\\nsteps:\\n- task: NuGetToolInstal\", \"ler@0\\n displayName: 'Use NuGet 4.4.1'\\n inputs:\\n versionSpec: 4.4.1\\n- task: NuGetCommand@2\\n displayNa\", \"me: 'NuGet restore'\\n inputs:\\n restoreSolution: '$(solution)'\\n- task: VSBuild@1\\n displayName: 'Build \", \"solution'\\n inputs:\\n solution: '$(solution)'\\n msbuildArgs: '-p:DeployOnBuild=true -p:WebPublishMethod\", \"=Package -\\np:PackageAsSingleFile=true -p:SkipInvalidConfigurations=true -\\np:PackageLocation=\\\"$(build\", \".artifactstagingdirectory)\\\\\\\\\\\"'\\n platform: '$(buildPlatform)'\\n configuration: '$(buildConfiguration)'\", \"\\n- task: VSTest@2\\n displayName: 'Test Assemblies'\\n inputs:\\n testAssemblyVer2: |\\n **\\\\$(buildConfigura\", \"tion)\\\\**\\\\*test*.dll\\n !**\\\\obj\\\\**\\n !**\\\\*testadapter.dll\\n platform: '$(buildPlatform)'\\n configuration: \", \"'$(buildConfiguration)'\\n- task: CopyFiles@2\\n displayName: 'Copy UI Test Files to: $(build.artifactst\", \"agingdirectory)'\\n inputs:\\n```\\n\\n```\\n SourceFolder: UITests\\n TargetFolder: '$(build.artifactstagingdir\", \"ectory)/uitests'\\n- task: PublishBuildArtifacts@1\\n displayName: 'Publish Artifact'\\n inputs:\\n PathtoPu\", \"blish: '$(build.artifactstagingdirectory)'\\n ArtifactName: '$(artifactName)'\\n condition: succeededOrF\", \"ailed()\\n```\\n\\n*Figure 10-9 - A sample azure-pipelines.yml*\\n\\nThis build definition uses a number of bu\", \"ilt-in tasks that make creating builds as simple as building a Lego set (simpler than the giant Mill\", \"ennium Falcon). For instance, the NuGet task restores NuGet packages, while the VSBuild task calls t\", \"he Visual Studio build tools to perform the actual compilation. There are hundreds of different task\", \"s available in Azure DevOps, with thousands more that are maintained by the community. It's likely t\", \"hat no matter what build tasks you're looking to run, somebody has built one already.\\n\\nBuilds can be\", \" triggered manually, by a check-in, on a schedule, or by the completion of another build. In most ca\", \"ses, building on every check-in is desirable. Builds can be filtered so that different builds run ag\", \"ainst different parts of the repository or against different branches. This allows for scenarios lik\", \"e running fast builds with reduced testing on pull requests and running a full regression suite agai\", \"nst the trunk on a nightly basis.\\n\\nThe end result of a build is a collection of files known as build\", \" artifacts. These artifacts can be passed along to the next step in the build process or added to an\", \" Azure Artifacts feed, so they can be consumed by other builds.\\n\\n#### <span id=\\\"page-181-0\\\"></span>*\", \"*Azure DevOps releases**\\n\\nBuilds take care of compiling the software into a shippable package, but t\", \"he artifacts still need to be pushed out to a testing environment to complete continuous delivery. F\", \"or this, Azure DevOps uses a separate tool called Releases. The Releases tool makes use of the same \", \"tasks' library that were available to the Build but introduce a concept of \\\"stages\\\". A stage is an i\", \"solated environment into which the package is installed. For instance, a product might make use of a\", \" development, a QA, and a production environment. Code is continuously delivered into the developmen\", \"t environment where automated tests can be run against it. Once those tests pass the release moves o\", \"nto the QA environment for manual testing. Finally, the code is pushed to production where it's visi\", \"ble to everybody.\\n\\n![](_page_181_Figure_7.jpeg)\\n\\n*Figure 10-10 - Release pipeline*\\n\\nEach stage in th\", \"e build can be automatically triggered by the completion of the previous phase. In many cases, howev\", \"er, this isn't desirable. Moving code into production might require approval from somebody. The Rele\", \"ases tool supports this by allowing approvers at each step of the release pipeline. Rules can be set\", \" up such that a specific person or group of people must sign off on a release before it makes into p\", \"roduction. These gates allow for manual quality checks and also for compliance with any regulatory r\", \"equirements related to control what goes into production.\\n\\n#### <span id=\\\"page-182-0\\\"></span>**Every\", \"body gets a build pipeline**\\n\\nThere's no cost to configuring many build pipelines, so it's advantage\", \"ous to have at least one build pipeline per microservice. Ideally, microservices are independently d\", \"eployable to any environment so having each one able to be released via its own pipeline without rel\", \"easing a mass of unrelated code is perfect. Each pipeline can have its own set of approvals allowing\", \" for variations in build process for each service.\\n\\n#### <span id=\\\"page-182-1\\\"></span>**Versioning r\", \"eleases**\\n\\nOne drawback to using the Releases functionality is that it can't be defined in a checked\", \"-in azurepipelines.yml file. There are many reasons you might want to do that from having per-branch\", \" release definitions to including a release skeleton in your project template. Fortunately, work is \", \"ongoing to shift some of the stages support into the Build component. This will be known as multi-st\", \"age build and the [first version is available now!](https://devblogs.microsoft.com/devops/whats-new-\", \"with-azure-pipelines/)\\n\\n# <span id=\\\"page-182-2\\\"></span>Feature flags\\n\\nIn chapter 1, we affirmed that\", \" cloud native is much about speed and agility. Users expect rapid responsiveness, innovative feature\", \"s, and zero downtime. Feature flags are a modern deployment technique that helps increase agility fo\", \"r cloud-native applications. They enable you to deploy new features into a production environment, b\", \"ut restrict their availability. With the flick of a switch, you can activate a new feature for speci\", \"fic users without restarting the app or deploying new code. They separate the release of new feature\", \"s from their code deployment.\\n\\nFeature flags are built upon conditional logic that control visibilit\", \"y of functionality for users at run time. In modern cloud-native systems, it's common to deploy new \", \"features into production early, but test them with a limited audience. As confidence increases, the \", \"feature can be incrementally rolled out to wider audiences.\\n\\nOther use cases for feature flags inclu\", \"de:\\n\\n- Restrict premium functionality to specific customer groups willing to pay higher subscription\", \" fees.\\n- Stabilize a system by quickly deactivating a problem feature, avoiding the risks of a rollb\", \"ack or immediate hotfix.\\n- Disable an optional feature with high resource consumption during peak us\", \"age periods.\\n- Conduct experimental feature releases to small user segments to validate feasibility \", \"and popularity.\\n\\nFeature flags also promote trunk-based development. It's a source-control branching\", \" model where developers collaborate on features in a single branch. The approach minimizes the risk \", \"and complexity of merging large numbers of long-running feature branches. Features are unavailable u\", \"ntil activated.\\n\\n#### <span id=\\\"page-183-0\\\"></span>**Implementing feature flags**\\n\\nAt its core, a fe\", \"ature flag is a reference to a simple decision object. It returns a Boolean state of on or off. The \", \"flag typically wraps a block of code that encapsulates a feature capability. The state of the flag d\", \"etermines whether that code block executes for a given user. Figure 10-11 shows the implementation.\\n\", \"\\n```\\nif (featureFlag) {\\n // Run this code block if the featureFlag value is true\\n} else {\\n // Run th\", \"is code block if the featureFlag value is false\\n}\\n```\\n\\n*Figure 10-11 - Simple feature flag implement\", \"ation.*\\n\\nNote how this approach separates the decision logic from the feature code.\\n\\nIn chapter 1, w\", \"e discussed the Twelve-Factor App. The guidance recommended keeping configuration settings external \", \"from application executable code. When needed, settings can be read in from the external source. Fea\", \"ture flag configuration values should also be independent from their codebase. By externalizing flag\", \" configuration in a separate repository, you can change flag state without modifying and redeploying\", \" the application.\\n\\n[Azure App Configuration](https://docs.microsoft.com/azure/azure-app-configuratio\", \"n/overview) provides a centralized repository for feature flags. With it, you define different kinds\", \" of feature flags and manipulate their states quickly and confidently. You add the App Configuration\", \" client libraries to your application to enable feature flag functionality. Various programming lang\", \"uage frameworks are supported.\\n\\nFeature flags can be easily implemented in an [ASP.NET Core service.\", \"](https://docs.microsoft.com/azure/azure-app-configuration/use-feature-flags-dotnet-core) Installing\", \" the .NET Feature Management libraries and App Configuration provider enable you to declaratively ad\", \"d feature flags to your code. They enable FeatureGate attributes so that you don't have to manually \", \"write if statements across your codebase.\\n\\nOnce configured in your Startup class, you can add featur\", \"e flag functionality at the controller, action, or middleware level. Figure 10-12 presents controlle\", \"r and action implementation:\\n\\n```\\n[FeatureGate(MyFeatureFlags.FeatureA)]\\npublic class ProductControl\", \"ler : Controller\\n{\\n ...\\n}\\n[FeatureGate(MyFeatureFlags.FeatureA)]\\npublic IActionResult UpdateProductS\", \"tatus()\\n{\\n return ObjectResult(ProductDto);\\n}\\n```\\n\\n*Figure 10-12 - Feature flag implementation in a \", \"controller and action.*\\n\\nIf a feature flag is disabled, the user will receive a 404 (Not Found) stat\", \"us code with no response body. Feature flags can also be injected directly into C# classes. Figure 1\", \"0-13 shows feature flag injection:\\n\\n```\\npublic class ProductController : Controller\\n{\\n private reado\", \"nly IFeatureManager _featureManager;\\n public ProductController(IFeatureManager featureManager)\\n {\\n _\", \"featureManager = featureManager;\\n }\\n}\\n```\\n\\n*Figure 10-13 - Feature flag injection into a class.*\\n\\nTh\", \"e Feature Management libraries manage the feature flag lifecycle behind the scenes. For example, to \", \"minimize high numbers of calls to the configuration store, the libraries cache flag states for a spe\", \"cified duration. They can guarantee the immutability of flag states during a request call. They also\", \" offer a Point-in-time snapshot. You can reconstruct the history of any key-value and provide its pa\", \"st value at any moment within the previous seven days.\\n\\n# <span id=\\\"page-184-0\\\"></span>Infrastructur\", \"e as code\\n\\nCloud-native systems embrace microservices, containers, and modern system design to achie\", \"ve speed and agility. They provide automated build and release stages to ensure consistent and quali\", \"ty code. But, that's only part of the story. How do you provision the cloud environments upon which \", \"these systems run?\\n\\nModern cloud-native applications embrace the widely accepted practice of [Infras\", \"tructure as Code,](https://docs.microsoft.com/devops/deliver/what-is-infrastructure-as-code) or IaC.\", \" With IaC, you automate platform provisioning. You essentially apply software engineering practices \", \"such as testing and versioning to your DevOps practices. Your infrastructure and deployments are aut\", \"omated, consistent, and repeatable. Just as continuous delivery automated the traditional model of m\", \"anual deployments, Infrastructure as Code (IaC) is evolving how application environments are managed\", \".\\n\\nTools like Azure Resource Manager (ARM), Terraform, and the Azure Command Line Interface (CLI) en\", \"able you to declaratively script the cloud infrastructure you require.\\n\\n#### <span id=\\\"page-184-1\\\"><\", \"/span>**Azure Resource Manager templates**\\n\\nARM stands for [Azure Resource Manager](https://docs.mic\", \"rosoft.com/azure/azure-resource-manager/management/overview). It's an API provisioning engine that i\", \"s built into Azure and exposed as an API service. ARM enables you to deploy, update, delete, and man\", \"age the resources contained in Azure resource group in a single, coordinated operation. You provide \", \"the engine with a JSON-based template that specifies the resources you require and their configurati\", \"on. ARM automatically orchestrates the deployment in the correct order respecting dependencies. The \", \"engine ensures idempotency. If a desired resource already exists with the same configuration, provis\", \"ioning will be ignored.\\n\\nAzure Resource Manager templates are a JSON-based language for defining var\", \"ious resources in Azure. The basic schema looks something like Figure 10-14.\\n\\n```\\n{\\n \\\"$schema\\\": \\\"htt\", \"ps://schema.management.azure.com/schemas/2015-01-\\n```\\n\\n```\\n01/deploymentTemplate.json#\\\",\\n \\\"contentVe\", \"rsion\\\": \\\"\\\",\\n \\\"apiProfile\\\": \\\"\\\",\\n \\\"parameters\\\": { },\\n \\\"variables\\\": { },\\n \\\"functions\\\": [ ],\\n \\\"resources\", \"\\\": [ ],\\n \\\"outputs\\\": { }\\n}\\n```\\n\\n*Figure 10-14 - The schema for a Resource Manager template*\\n\\nWithin t\", \"his template, one might define a storage container inside the resources section like so:\\n\\n```\\n\\\"resou\", \"rces\\\": [\\n {\\n \\\"type\\\": \\\"Microsoft.Storage/storageAccounts\\\",\\n \\\"name\\\": \\\"[variables('storageAccountName')\", \"]\\\",\\n \\\"location\\\": \\\"[parameters('location')]\\\",\\n \\\"apiVersion\\\": \\\"2018-07-01\\\",\\n \\\"sku\\\": {\\n \\\"name\\\": \\\"[param\", \"eters('storageAccountType')]\\\"\\n },\\n \\\"kind\\\": \\\"StorageV2\\\",\\n \\\"properties\\\": {}\\n }\\n ],\\n```\\n\\n*Figure 10-15 \", \"- An example of a storage account defined in a Resource Manager template*\\n\\nAn ARM template can be pa\", \"rameterized with dynamic environment and configuration information. Doing so enables it to be reused\", \" to define different environments, such as development, QA, or production. Normally, the template cr\", \"eates all resources within a single Azure resource group. It's possible to define multiple resource \", \"groups in a single Resource Manager template, if needed. You can delete all resources in an environm\", \"ent by deleting the resource group itself. Cost analysis can also be run at the resource group level\", \", allowing for quick accounting of how much each environment is costing.\\n\\nThere are many examples of\", \" ARM templates available in the [Azure Quickstart Templates](https://github.com/Azure/azure-quicksta\", \"rt-templates) project on GitHub. They can help accelerate creating a new template or modifying an ex\", \"isting one.\\n\\nResource Manager templates can be run in many of ways. Perhaps the simplest way is to s\", \"imply paste them into the Azure portal. For experimental deployments, this method can be quick. They\", \" can also be run as part of a build or release process in Azure DevOps. There are tasks that will le\", \"verage connections into Azure to run the templates. Changes to Resource Manager templates are applie\", \"d incrementally, meaning that to add a new resource requires just adding it to the template. The too\", \"ling will reconcile differences between the current resources and those defined in the template. Res\", \"ources will then be created or altered so they match what is defined in the template.\\n\\n#### <span id\", \"=\\\"page-185-0\\\"></span>**Terraform**\\n\\nCloud-native applications are often constructed to be cloud agno\", \"stic. Being so means the application isn't tightly coupled to a particular cloud vendor and can be d\", \"eployed to any public cloud.\\n\\n[Terraform](https://www.terraform.io/) is a commercial templating tool\", \" that can provision cloud-native applications across all the major cloud players: Azure, Google Clou\", \"d Platform, AWS, and AliCloud. Instead of using JSON as the template definition language, it uses th\", \"e slightly more terse HCL (Hashicorp Configuration Language).\\n\\nAn example Terraform file that does t\", \"he same as the previous Resource Manager template (Figure 10- 15) is shown in Figure 10-16:\\n\\n```\\npro\", \"vider \\\"azurerm\\\" {\\n version = \\\"=1.28.0\\\"\\n}\\nresource \\\"azurerm_resource_group\\\" \\\"testrg\\\" {\\n name = \\\"produ\", \"ction\\\"\\n location = \\\"West US\\\"\\n}\\nresource \\\"azurerm_storage_account\\\" \\\"testsa\\\" {\\n name = \\\"${var.storageA\", \"ccountName}\\\"\\n resource_group_name = \\\"${azurerm_resource_group.testrg.name}\\\"\\n location = \\\"${var.regio\", \"n}\\\"\\n account_tier = \\\"${var.tier}\\\"\\n account_replication_type = \\\"${var.replicationType}\\\"\\n}\\n```\\n\\n*Figur\", \"e 10-16 - An example of a Resource Manager template*\\n\\nTerraform also provides intuitive error messag\", \"es for problem templates. There's also a handy validate task that can be used in the build phase to \", \"catch template errors early.\\n\\nAs with Resource Manager templates, command-line tools are available t\", \"o deploy Terraform templates. There are also community-created tasks in Azure Pipelines that can val\", \"idate and apply Terraform templates.\\n\\nSometimes Terraform and ARM templates output meaningful values\", \", such as a connection string to a newly created database. This information can be captured in the b\", \"uild pipeline and used in subsequent tasks.\\n\\n#### <span id=\\\"page-186-0\\\"></span>**Azure CLI Scripts a\", \"nd Tasks**\\n\\nFinally, you can leverage [Azure CLI](https://docs.microsoft.com/cli/azure/) to declarat\", \"ively script your cloud infrastructure. Azure CLI scripts can be created, found, and shared to provi\", \"sion and configure almost any Azure resource. The CLI is simple to use with a gentle learning curve.\", \" Scripts are executed within either PowerShell or Bash. They're also straightforward to debug, espec\", \"ially when compared with ARM templates.\\n\\nAzure CLI scripts work well when you need to tear down and \", \"redeploy your infrastructure. Updating an existing environment can be tricky. Many CLI commands aren\", \"'t idempotent. That means they'll recreate the resource each time they're run, even if the resource \", \"already exists. It's always possible to add code that checks for the existence of each resource befo\", \"re creating it. But, doing so, your script can become bloated and difficult to manage.\\n\\nThese script\", \"s can also be embedded in Azure DevOps pipelines as Azure CLI tasks. Executing the pipeline invokes \", \"the script.\\n\\nFigure 10-17 shows a YAML snippet that lists the version of Azure CLI and the details o\", \"f the subscription. Note how Azure CLI commands are included in an inline script.\\n\\n```\\n- task: Azure\", \"CLI@2\\n displayName: Azure CLI\\n inputs:\\n azureSubscription: <Name of the Azure Resource Manager servi\", \"ce connection>\\n scriptType: ps\\n scriptLocation: inlineScript\\n inlineScript: |\\n az --version\\n az acco\", \"unt show\\n```\\n\\n*Figure 10-17 - Azure CLI script*\\n\\nIn the article, [What is Infrastructure as Code](ht\", \"tps://docs.microsoft.com/devops/deliver/what-is-infrastructure-as-code), Author Sam Guckenheimer des\", \"cribes how, \\\"Teams who implement IaC can deliver stable environments rapidly and at scale. Teams avo\", \"id manual configuration of environments and enforce consistency by representing the desired state of\", \" their environments via code. Infrastructure deployments with IaC are repeatable and prevent runtime\", \" issues caused by configuration drift or missing dependencies. DevOps teams can work together with a\", \" unified set of practices and tools to deliver applications and their supporting infrastructure rapi\", \"dly, reliably, and at scale.\\\"\\n\\n# <span id=\\\"page-187-0\\\"></span>Cloud Native Application Bundles\\n\\nA ke\", \"y property of cloud-native applications is that they leverage the capabilities of the cloud to speed\", \" up development. This design often means that a full application uses different kinds of technologie\", \"s. Applications may be shipped in Docker containers, some services may use Azure Functions, while ot\", \"her parts may run directly on virtual machines allocated on large metal servers with hardware GPU ac\", \"celeration. No two cloud-native applications are the same, so it's been difficult to provide a singl\", \"e mechanism for shipping them.\\n\\nThe Docker containers may run on Kubernetes using a Helm Chart for d\", \"eployment. The Azure Functions may be allocated using Terraform templates. Finally, the virtual mach\", \"ines may be allocated using Terraform but built out using Ansible. This is a large variety of techno\", \"logies and there has been no way to package them all together into a reasonable package. Until now.\\n\", \"\\nCloud Native Application Bundles (CNABs) are a joint effort by many community-minded companies such\", \" as Microsoft, Docker, and HashiCorp to develop a specification to package distributed applications.\", \"\\n\\nThe effort was announced in December of 2018, so there's still a fair bit of work to do to expose \", \"the effort to the greater community. However, there's already an [open specification](https://github\", \".com/deislabs/cnab-spec) and a reference implementation known as [Duffle.](https://duffle.sh/) This \", \"tool, which was written in Go, is a joint effort between Docker and Microsoft.\\n\\nThe CNABs can contai\", \"n different kinds of installation technologies. This aspect allows things like Helm Charts, Terrafor\", \"m templates, and Ansible Playbooks to coexist in the same package. Once built, the packages are self\", \"-contained and portable; they can be installed from a USB stick. The packages are cryptographically \", \"signed to ensure they originate from the party they claim.\\n\\nThe core of a CNAB is a file called bund\", \"le.json. This file defines the contents of the bundle, be they Terraform or images or anything else.\", \" Figure 11-9 defines a CNAB that invokes some Terraform. Notice, however, that it actually defines a\", \"n invocation image that is used to invoke the Terraform. When packaged up, the Docker file that is l\", \"ocated in the *cnab* directory is built into a Docker image, which will be included in the bundle. H\", \"aving Terraform installed inside a Docker container in the bundle means that users don't need to hav\", \"e Terraform installed on their machine to run the bundling.\\n\\n```\\n{\\n \\\"name\\\": \\\"terraform\\\",\\n \\\"version\\\":\", \" \\\"0.1.0\\\",\\n \\\"schemaVersion\\\": \\\"v1.0.0-WD\\\",\\n \\\"parameters\\\": {\\n \\\"backend\\\": {\\n \\\"type\\\": \\\"boolean\\\",\\n \\\"defaul\", \"tValue\\\": false,\\n \\\"destination\\\": {\\n \\\"env\\\": \\\"TF_VAR_backend\\\"\\n }\\n }\\n },\\n \\\"invocationImages\\\": [\\n {\\n \\\"ima\", \"geType\\\": \\\"docker\\\",\\n \\\"image\\\": \\\"cnab/terraform:latest\\\"\\n }\\n ],\\n \\\"credentials\\\": {\\n \\\"tenant_id\\\": {\\n \\\"env\\\"\", \": \\\"TF_VAR_tenant_id\\\"\\n },\\n \\\"client_id\\\": {\\n \\\"env\\\": \\\"TF_VAR_client_id\\\"\\n },\\n \\\"client_secret\\\": {\\n \\\"env\\\": \", \"\\\"TF_VAR_client_secret\\\"\\n },\\n \\\"subscription_id\\\": {\\n \\\"env\\\": \\\"TF_VAR_subscription_id\\\"\\n },\\n \\\"ssh_authoriz\", \"ed_key\\\": {\\n \\\"env\\\": \\\"TF_VAR_ssh_authorized_key\\\"\\n }\\n },\\n \\\"actions\\\": {\\n \\\"status\\\": {\\n \\\"modifies\\\": true\\n \", \"}\\n }\\n}\\n```\\n\\n*Figure 10-18 - An example Terraform file*\\n\\nThe bundle.json also defines a set of parame\", \"ters that are passed down into the Terraform. Parameterization of the bundle allows for installation\", \" in various different environments.\\n\\nThe CNAB format is also flexible, allowing it to be used agains\", \"t any cloud. It can even be used against on-premises solutions such as [OpenStack.](https://www.open\", \"stack.org/)\\n\\n#### <span id=\\\"page-189-0\\\"></span>**DevOps Decisions**\\n\\nThere are so many great tools i\", \"n the DevOps space these days and even more fantastic books and papers on how to succeed. A favorite\", \" book to get started on the DevOps journey is [The Phoenix](https://www.oreilly.com/library/view/the\", \"-phoenix-project/9781457191350/)  [Project,](https://www.oreilly.com/library/view/the-phoenix-projec\", \"t/9781457191350/) which follows the transformation of a fictional company from NoOps to DevOps. One \", \"thing is for certain: DevOps is no longer a \\\"nice to have\\\" when deploying complex, Cloud Native Appl\", \"ications. It's a requirement and should be planned for and resourced at the start of any project.\\n\\n#\", \"### <span id=\\\"page-189-1\\\"></span>**References**\\n\\n- [Azure DevOps](https://azure.microsoft.com/servic\", \"es/devops/)\\n- [Azure Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/manag\", \"ement/overview)\\n- [Terraform](https://www.terraform.io/)\\n- [Azure CLI](https://docs.microsoft.com/cl\", \"i/azure/)\\n\\n# <span id=\\\"page-190-0\\\"></span>Summary: Architecting cloud-native apps\\n\\nIn summary, here \", \"are important conclusions from this guide:\\n\\n- **Cloud-native** is about designing modern application\", \"s that embrace rapid change, large scale, and resilience, in modern, dynamic environments such as pu\", \"blic, private, and hybrid clouds.\\n- The **[Cloud Native Computing Foundation](https://www.cncf.io/) \", \"(CNCF)** is an influential open-source consortium of over 300 major corporations. It's responsible f\", \"or driving the adoption of cloud-native computing across technology and cloud stacks.\\n- **CNCF guide\", \"lines** recommend that cloud-native applications embrace six important pillars as shown in Figure 11\", \"-1:\\n\\n![](_page_190_Figure_7.jpeg)\\n\\n**Figure 11-1**. Cloud-native foundational pillars\\n\\n- These cloud\", \"-native pillars include:\\n  - The cloud and its underlying service model\\n  - Modern design principles\", \"\\n  - Microservices\\n  - Containerization and container orchestration\\n  - Cloud-based backing services\", \", such as databases and message brokers\\n  - Automation, including Infrastructure as Code and code de\", \"ployment\\n\\n- **Kubernetes** is the hosting environment of choice for most cloud-native applications. \", \"Smaller, simple services are sometimes hosted in serverless platforms, such as Azure Functions. Amon\", \"g many key automation features, both environments provide automatic scaling to handle fluctuating wo\", \"rkload volumes.\\n- **Service communication** becomes a significant design decision when constructing \", \"a cloudnative application. Applications typically expose an API gateway to manage front-end client c\", \"ommunication. Then backend microservices strive to communicate with each other implementing asynchro\", \"nous communication patterns, when possible.\\n- **gRPC** is a modern, high-performance framework that \", \"evolves the age-old remote procedure call (RPC) protocol. Cloud-native applications often embrace gR\", \"PC to streamline messaging between back-end services. gRPC uses HTTP/2 for its transport protocol. I\", \"t can be up to 8x faster than JSON serialization with message sizes 60-80% smaller. gRPC is open sou\", \"rce and managed by the Cloud Native Computing Foundation (CNCF).\\n- **Distributed data** is a model o\", \"ften implemented by cloud-native applications. Applications segregate business functionality into sm\", \"all, independent microservices. Each microservice encapsulates its own dependencies, data, and state\", \". The classic shared database model evolves into one of many smaller databases, each aligning with a\", \" microservice. When the smoke clears, we emerge with a design that exposes a database-per-microservi\", \"ce model.\\n- **No-SQL databases** refer to high-performance, non-relational data stores. They excel i\", \"n their ease-of-use, scalability, resilience, and availability characteristics. High volume services\", \" that require sub second response time favor NoSQL datastores. The proliferation of NoSQL technologi\", \"es for distributed cloud-native systems can't be overstated.\\n- **NewSQL** is an emerging database te\", \"chnology that combines the distributed scalability of NoSQL and the ACID guarantees of a relational \", \"database. NewSQL databases target business systems that must process high-volumes of data, across di\", \"stributed environments, with full transactional/ACID compliance. The Cloud Native Computing Foundati\", \"on (CNCF) features several NewSQL database projects.\\n- **Resiliency** is the ability of your system \", \"to react to failure and still remain functional. Cloudnative systems embrace distributed architectur\", \"e where failure is inevitable. Applications must be constructed to respond elegantly to failure and \", \"quickly return to a fully functioning state.\\n- **Service meshes** are a configurable infrastructure \", \"layer with built-in capabilities to handle service communication and other cross-cutting challenges.\", \" They decouple cross-cutting responsibilities from your business code. These responsibilities move i\", \"nto a service proxy. Referred to as the Sidecar pattern, the proxy is deployed into a separate proce\", \"ss to provide isolation from your business code.\\n- **Observability** is a key design consideration f\", \"or cloud-native applications. As services are distributed across a cluster of nodes, centralized log\", \"ging, monitoring, and alerts, become mandatory. Azure Monitor is a collection of cloud-based tools d\", \"esigned to provide visibility into the state of your system.\\n\\n- **Infrastructure as Code** is a wide\", \"ly accepted practice that automates platform provisioning. Your infrastructure and deployments are a\", \"utomated, consistent, and repeatable. Tools like Azure Resource Manager, Terraform, and the Azure CL\", \"I, enable you to declaratively script the cloud infrastructure you require.\\n- **Code automation** is\", \" a requirement for cloud-native applications. Modern CI/CD systems help fulfill this principle. They\", \" provide separate build and deployment steps that help ensure consistent and quality code. The build\", \" stage transforms the code into a binary artifact. The release stage picks up the binary artifact, a\", \"pplies external environment configuration, and deploys it to a specified environment. Azure DevOps a\", \"nd GitHub are full-featured DevOps environments.\"]"