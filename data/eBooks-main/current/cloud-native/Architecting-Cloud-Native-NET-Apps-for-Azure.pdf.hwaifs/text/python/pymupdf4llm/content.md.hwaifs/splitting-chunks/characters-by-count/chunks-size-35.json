"[\"**EDITION v1.0.3**\\n\\n\\n[Refer changelog](https://aka.ms/cn-ebook-changelog) for the book updates and c\", \"ommunity contributions.\\n\\n\\nPUBLISHED BY\\n\\n\\nMicrosoft Developer Division, .NET, and Visual Studio produ\", \"ct teams\\n\\n\\nA division of Microsoft Corporation\\n\\n\\nOne Microsoft Way\\n\\n\\nRedmond, Washington 98052-6399\\n\", \"\\n\\nCopyright \\u00a9 2023 by Microsoft Corporation\\n\\n\\nAll rights reserved. No part of the contents of this b\", \"ook may be reproduced or transmitted in any\\nform or by any means without the written permission of t\", \"he publisher.\\n\\n\\nThis book is provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The vie\", \"ws, opinions, and\\ninformation expressed in this book, including URL and other Internet website refer\", \"ences, may change\\nwithout notice.\\n\\n\\nSome examples depicted herein are provided for illustration only\", \" and are fictitious. No real association\\nor connection is intended or should be inferred.\\n\\n\\n[Microso\", \"ft and the trademarks listed at https://www.microsoft.com](https://www.microsoft.com/) on the \\u201cTrade\", \"marks\\u201d webpage are\\ntrademarks of the Microsoft group of companies.\\n\\n\\nMac and macOS are trademarks of\", \" Apple Inc.\\n\\n\\nThe Docker whale logo is a registered trademark of Docker, Inc. Used by permission.\\n\\n\\n\", \"All other marks and logos are property of their respective owners.\\n\\n\\nAuthors:\\n\\n\\n**Rob Vettor**, Prin\", \"cipal MTC (Microsoft Technology Center) Architect for Cloud App Innovation [thinkingincloudnative.co\", \"m, Microsoft](https://thinkingincloudnative.com/about/)\\n\\n\\n**Steve \\u201cardalis\\u201d Smith** [, Software Arch\", \"itect and Trainer - Ardalis.com](https://ardalis.com/)\\n\\n\\nParticipants and Reviewers:\\n\\n\\n**Cesar De la\", \" Torre**, Principal Program Manager, .NET team, Microsoft\\n\\n\\n**Nish Anil**, Senior Program Manager, .\", \"NET team, Microsoft\\n\\n\\n**Jeremy Likness**, Senior Program Manager, .NET team, Microsoft\\n\\n\\n**Cecil Phi\", \"llip**, Senior Cloud Advocate, Microsoft\\n\\n\\n**Sumit Ghosh**, Principal Consultant at Neudesic\\n\\n\\nEdito\", \"rs:\\n\\n\\n**Maira Wenzel**, Program Manager, .NET team, Microsoft\\n\\n\\n**David Pine**, Senior Content Devel\", \"oper, .NET docs, Microsoft\\n### Version\\n\\n\\nThis guide has been written to cover **.NET 7** version alo\", \"ng with many additional updates related to\\nthe same \\u201cwave\\u201d of technologies (that is, Azure and addit\", \"ional third-party technologies) coinciding in\\ntime with the .NET 7 release.\\n### Who should use this \", \"guide\\n\\n\\nThe audience for this guide is mainly developers, development leads, and architects who are\\n\", \"interested in learning how to build applications designed for the cloud.\\n\\n\\nA secondary audience is t\", \"echnical decision-makers who plan to choose whether to build their\\napplications using a cloud-native\", \" approach.\\n### How you can use this guide\\n\\n\\nThis guide begins by defining cloud native and introduci\", \"ng a reference application built using cloudnative principles and technologies. Beyond these first t\", \"wo chapters, the rest of the book is broken up\\ninto specific chapters focused on topics common to mo\", \"st cloud-native applications. You can jump to\\nany of these chapters to learn about cloud-native appr\", \"oaches to:\\n\\n\\n  - Data and data access\\n\\n  - Communication patterns\\n\\n  - Scaling and scalability\\n\\n  - \", \"Application resiliency\\n\\n  - Monitoring and health\\n\\n  - Identity and security\\n\\n  - DevOps\\n\\n\\n[This gui\", \"de is available both in PDF](https://dotnet.microsoft.com/download/e-book/cloud-native-azure/pdf) fo\", \"rm and online. Feel free to forward this document or links to its\\nonline version to your team to hel\", \"p ensure common understanding of these topics. Most of these\\ntopics benefit from a consistent unders\", \"tanding of the underlying principles and patterns, as well as\\nthe trade-offs involved in decisions r\", \"elated to these topics. Our goal with this document is to equip\\nteams and their leaders with the inf\", \"ormation they need to make well-informed decisions for their\\napplications\\u2019 architecture, development\", \", and hosting.\\n\\n\\n## Contents\\n\\n**Introduction to cloud-native applications ..........................\", \".................................................. 1**\\n\\n\\nCloud-native computing ....................\", \"....................................................................................................\", \".......................... 3\\n\\n\\nWhat is Cloud Native? ...............................................\", \"....................................................................................................\", \"......... 4\\n\\n\\nThe pillars of cloud native ..........................................................\", \"...................................................................................... 5\\n\\n\\nThe cloud\", \" ...................................................................................................\", \"............................................................................. 5\\n\\n\\nModern design ....\", \"....................................................................................................\", \"............................................................. 6\\n\\n\\nMicroservices ....................\", \"....................................................................................................\", \"................................................ 9\\n\\n\\nContainers ....................................\", \"....................................................................................................\", \"................................... 12\\n\\n\\nBacking services ..........................................\", \"....................................................................................................\", \".................. 15\\n\\n\\nAutomation .................................................................\", \"....................................................................................................\", \".... 17\\n\\n\\nCandidate apps for cloud native ..........................................................\", \"........................................................................... 19\\n\\n\\nModernizing legacy \", \"apps ...............................................................................................\", \"............................................... 19\\n\\n\\nSummary .......................................\", \"....................................................................................................\", \"................................... 21\\n\\n\\n**Introducing eShopOnContainers reference app .............\", \"................................................... 22**\\n\\n\\nFeatures and requirements ...............\", \"....................................................................................................\", \"............................ 23\\n\\n\\nOverview of the code .............................................\", \"....................................................................................................\", \"......... 25\\n\\n\\nUnderstanding microservices .........................................................\", \".................................................................................. 27\\n\\n\\nMapping eSho\", \"pOnContainers to Azure Services ....................................................................\", \"................................. 27\\n\\n\\nContainer orchestration and clustering ......................\", \"............................................................................................. 28\\n\\n\\nA\", \"PI Gateway .........................................................................................\", \".............................................................................. 28\\n\\n\\nData ...........\", \"....................................................................................................\", \"........................................................................ 29\\n\\n\\nEvent Bus ............\", \"....................................................................................................\", \"............................................................. 30\\n\\n\\nResiliency ......................\", \"....................................................................................................\", \"................................................... 30\\n\\n\\nDeploying eShopOnContainers to Azure ......\", \"....................................................................................................\", \".......... 30\\n\\n\\nAzure Kubernetes Service ...........................................................\", \".................................................................................. 30\\n\\n\\nDeploying to\", \" Azure Kubernetes Service using Helm ...............................................................\", \".......................... 30\\n\\n\\nAzure Functions and Logic Apps (Serverless) ........................\", \"............................................................................... 32\\n\\n\\nCentralized con\", \"figuration .........................................................................................\", \"......................................................... 33\\n\\n\\ni Contents\\n\\n\\nAzure App Configuration \", \"....................................................................................................\", \".......................................... 33\\n\\n\\nAzure Key Vault ....................................\", \"....................................................................................................\", \"......................... 34\\n\\n\\nConfiguration in eShop ..............................................\", \"....................................................................................................\", \" 34\\n\\n\\nReferences ...................................................................................\", \"........................................................................................ 34\\n\\n\\n**Scal\", \"ing cloud-native applications ......................................................................\", \".................. 36**\\n\\n\\nLeveraging containers and orchestrators ..................................\", \".................................................................................. 36\\n\\n\\nChallenges w\", \"ith monolithic deployments .........................................................................\", \"..................................... 36\\n\\n\\nWhat are the benefits of containers and orchestrators? ..\", \"................................................................................ 38\\n\\n\\nWhat are the s\", \"caling benefits? ...................................................................................\", \"................................................. 40\\n\\n\\nWhat scenarios are ideal for containers and o\", \"rchestrators?........................................................................... 42\\n\\n\\nWhen s\", \"hould you avoid using containers and orchestrators? ................................................\", \"....................... 42\\n\\n\\nDevelopment resources .................................................\", \"................................................................................................ 42\\n\", \"\\n\\nLeveraging serverless functions ..................................................................\", \".................................................................... 46\\n\\n\\nWhat is serverless? ......\", \"....................................................................................................\", \"................................................. 47\\n\\n\\nWhat challenges are solved by serverless? ...\", \"....................................................................................................\", \"..... 47\\n\\n\\nWhat is the difference between a microservice and a serverless function? ................\", \"............................. 47\\n\\n\\nWhat scenarios are appropriate for serverless? ..................\", \"................................................................................. 47\\n\\n\\nWhen should y\", \"ou avoid serverless? ...............................................................................\", \"........................................... 48\\n\\n\\nCombining containers and serverless approaches ....\", \".............................................................................................. 49\\n\\n\\n\", \"When does it make sense to use containers with serverless? .........................................\", \"............................... 49\\n\\n\\nWhen should you avoid using containers with Azure Functions? ..\", \".............................................................. 49\\n\\n\\nHow to combine serverless and Do\", \"cker containers ....................................................................................\", \"....... 49\\n\\n\\nHow to combine serverless and Kubernetes with KEDA ....................................\", \".............................................. 50\\n\\n\\nDeploying containers in Azure ..................\", \"....................................................................................................\", \".................. 50\\n\\n\\nAzure Container Registry ...................................................\", \"........................................................................................... 50\\n\\n\\nACR\", \" Tasks .............................................................................................\", \"............................................................................... 52\\n\\n\\nAzure Kubernete\", \"s Service ..........................................................................................\", \"................................................... 52\\n\\n\\nAzure Bridge to Kubernetes ................\", \"....................................................................................................\", \"..................... 53\\n\\n\\nScaling containers and serverless applications ..........................\", \"............................................................................... 53\\n\\n\\nThe simple solu\", \"tion: scaling up ...................................................................................\", \"............................................... 53\\n\\n\\nScaling out cloud-native apps .................\", \"....................................................................................................\", \"............... 54\\n\\n\\nOther container deployment options ............................................\", \"............................................................................... 55\\n\\n\\nii Contents\\n\\n\\nW\", \"hen does it make sense to deploy to App Service for Containers? ....................................\", \"..................... 55\\n\\n\\nHow to deploy to App Service for Containers .............................\", \"......................................................................... 55\\n\\n\\nWhen does it make sen\", \"se to deploy to Azure Container Instances? .........................................................\", \". 55\\n\\n\\nHow to deploy an app to Azure Container Instances ...........................................\", \"............................................. 55\\n\\n\\nReferences ......................................\", \"....................................................................................................\", \"................................. 56\\n\\n\\n**Cloud-native communication patterns .......................\", \"........................................................ 58**\\n\\n\\nCommunication considerations .......\", \"....................................................................................................\", \"........................... 58\\n\\n\\nFront-end client communication ....................................\", \"................................................................................................ 60\\n\", \"\\n\\nSimple Gateways ..................................................................................\", \"............................................................................ 62\\n\\n\\nAzure Application \", \"Gateway ............................................................................................\", \".............................................. 63\\n\\n\\nAzure API Management ...........................\", \"....................................................................................................\", \".................. 63\\n\\n\\nReal-time communication ....................................................\", \"........................................................................................ 66\\n\\n\\nServic\", \"e-to-service communication .........................................................................\", \"....................................................... 67\\n\\n\\nQueries ...............................\", \"....................................................................................................\", \".............................................. 68\\n\\n\\nCommands .......................................\", \"....................................................................................................\", \"............................... 71\\n\\n\\nEvents ........................................................\", \"....................................................................................................\", \"........................ 74\\n\\n\\ngRPC .................................................................\", \"....................................................................................................\", \"...................... 80\\n\\n\\nWhat is gRPC? ..........................................................\", \"....................................................................................................\", \"..... 80\\n\\n\\ngRPC Benefits ...........................................................................\", \"......................................................................................... 80\\n\\n\\nProto\", \"col Buffers ........................................................................................\", \"........................................................................ 81\\n\\n\\ngRPC support in .NET .\", \"....................................................................................................\", \"................................................ 81\\n\\n\\ngRPC usage ...................................\", \"....................................................................................................\", \".................................. 82\\n\\n\\ngRPC implementation ........................................\", \"....................................................................................................\", \"........ 83\\n\\n\\nLooking ahead ........................................................................\", \"........................................................................................... 85\\n\\n\\nSer\", \"vice Mesh communication infrastructure .............................................................\", \"................................................ 85\\n\\n\\nSummary ......................................\", \"....................................................................................................\", \".................................... 86\\n\\n\\n**Cloud-native data patterns .............................\", \"..................................................................... 88**\\n\\n\\nDatabase-per-microservi\", \"ce, why? ...........................................................................................\", \"....................................... 89\\n\\n\\nCross-service queries .................................\", \"....................................................................................................\", \"...................... 90\\n\\n\\nDistributed transactions ...............................................\", \"....................................................................................................\", \".. 91\\n\\n\\nHigh volume data ...........................................................................\", \"...................................................................................... 93\\n\\n\\nCQRS ...\", \"....................................................................................................\", \".............................................................................. 93\\n\\n\\niii Contents\\n\\n\\nE\", \"vent sourcing ......................................................................................\", \"............................................................................. 94\\n\\n\\nRelational vs. No\", \"SQL data ...........................................................................................\", \"...................................................... 96\\n\\n\\nThe CAP theorem ........................\", \"....................................................................................................\", \"................................. 97\\n\\n\\nConsiderations for relational vs. NoSQL systems .............\", \"................................................................................... 99\\n\\n\\nDatabase as\", \" a Service .........................................................................................\", \"............................................................ 99\\n\\n\\nAzure relational databases .......\", \"....................................................................................................\", \".............................. 100\\n\\n\\nAzure SQL Database.............................................\", \"....................................................................................................\", \"..... 100\\n\\n\\nOpen-source databases in Azure .........................................................\", \".................................................................... 101\\n\\n\\nNoSQL data in Azure .....\", \"....................................................................................................\", \"........................................... 102\\n\\n\\nNewSQL databases .................................\", \"....................................................................................................\", \"................... 106\\n\\n\\nData migration to the cloud ..............................................\", \"........................................................................................ 108\\n\\n\\nCachi\", \"ng in a cloud-native app ...........................................................................\", \"............................................................ 108\\n\\n\\nWhy? ............................\", \"....................................................................................................\", \".................................................... 108\\n\\n\\nCaching architecture ....................\", \"....................................................................................................\", \"............................. 109\\n\\n\\nAzure Cache for Redis ..........................................\", \"....................................................................................................\", \".... 110\\n\\n\\nElasticsearch in a cloud-native app .....................................................\", \"........................................................................ 110\\n\\n\\nSummary .............\", \"....................................................................................................\", \"........................................................... 111\\n\\n\\n**Cloud-native resiliency ........\", \"............................................................................................... 113*\", \"*\\n\\n\\nApplication resiliency patterns ................................................................\", \"...................................................................... 114\\n\\n\\nCircuit breaker pattern\", \" ...................................................................................................\", \".............................................. 116\\n\\n\\nTesting for resiliency ........................\", \"....................................................................................................\", \"......................... 117\\n\\n\\nAzure platform resiliency ..........................................\", \"....................................................................................................\", \"... 117\\n\\n\\nDesign with resiliency ...................................................................\", \"................................................................................ 118\\n\\n\\nDesign with r\", \"edundancy...........................................................................................\", \"................................................... 118\\n\\n\\nDesign for scalability ...................\", \"....................................................................................................\", \".............................. 120\\n\\n\\nBuilt-in retry in services ....................................\", \"....................................................................................................\", \"....... 121\\n\\n\\nResilient communications .............................................................\", \"................................................................................... 122\\n\\n\\nService me\", \"sh .................................................................................................\", \"................................................................... 123\\n\\n\\nIstio and Envoy ..........\", \"....................................................................................................\", \".................................................. 124\\n\\n\\nIntegration with Azure Kubernetes Services \", \"....................................................................................................\", \"... 125\\n\\n\\n**Monitoring and health ..................................................................\", \"...................................... 126**\\n\\n\\nObservability patterns ..............................\", \"....................................................................................................\", \"..................... 126\\n\\n\\niv Contents\\n\\n\\nWhen to use logging ......................................\", \"....................................................................................................\", \".......... 126\\n\\n\\nChallenges with detecting and responding to potential app health issues ...........\", \"................................ 130\\n\\n\\nChallenges with reacting to critical problems in cloud-native\", \" apps .......................................................... 130\\n\\n\\nLogging with Elastic Stack ..\", \"....................................................................................................\", \"......................................... 131\\n\\n\\nElastic Stack ......................................\", \"....................................................................................................\", \"............................ 131\\n\\n\\nWhat are the advantages of Elastic Stack? .......................\", \"................................................................................... 132\\n\\n\\nLogstash .\", \"....................................................................................................\", \"........................................................................ 132\\n\\n\\nElasticsearch .......\", \"....................................................................................................\", \".......................................................... 133\\n\\n\\nVisualizing information with Kibana\", \" web dashboards ....................................................................................\", \" 133\\n\\n\\nInstalling Elastic Stack on Azure ...........................................................\", \".................................................................... 134\\n\\n\\nReferences ..............\", \"....................................................................................................\", \"....................................................... 134\\n\\n\\nMonitoring in Azure Kubernetes Service\", \"s ..................................................................................................\", \"............... 134\\n\\n\\nAzure Monitor for Containers .................................................\", \".................................................................................. 134\\n\\n\\nLog.Finaliz\", \"e() ................................................................................................\", \".................................................................... 136\\n\\n\\nAzure Monitor ...........\", \"....................................................................................................\", \"....................................................... 136\\n\\n\\nGathering logs and metrics ...........\", \"....................................................................................................\", \"......................... 137\\n\\n\\nReporting data .....................................................\", \"....................................................................................................\", \"....... 137\\n\\n\\nDashboards ...........................................................................\", \"............................................................................................ 138\\n\\n\\nA\", \"lerts ..............................................................................................\", \"..................................................................................... 140\\n\\n\\nReferenc\", \"es .................................................................................................\", \"........................................................................ 141\\n\\n\\n**Cloud-native identi\", \"ty .................................................................................................\", \"......... 142**\\n\\n\\nReferences .......................................................................\", \"....................................................................................................\", \".. 142\\n\\n\\nAuthentication and authorization in cloud-native apps .....................................\", \"................................................ 142\\n\\n\\nReferences ..................................\", \"....................................................................................................\", \"................................... 143\\n\\n\\nAzure Active Directory ...................................\", \"....................................................................................................\", \"............... 143\\n\\n\\nReferences ...................................................................\", \"....................................................................................................\", \".. 143\\n\\n\\nIdentityServer for cloud-native applications ..............................................\", \".............................................................. 144\\n\\n\\nCommon web app scenarios ......\", \"....................................................................................................\", \"........................... 144\\n\\n\\nGetting started ..................................................\", \"....................................................................................................\", \".......... 145\\n\\n\\nConfiguration .....................................................................\", \".............................................................................................. 145\\n\\n\", \"\\nJavaScript clients ................................................................................\", \"............................................................................ 146\\n\\n\\nReferences ......\", \"....................................................................................................\", \"............................................................... 146\\n\\n\\nv Contents\\n\\n\\n**Cloud-native se\", \"curity .............................................................................................\", \"............. 147**\\n\\n\\nAzure security for cloud-native apps .........................................\", \"................................................................................. 147\\n\\n\\nThreat model\", \"ing ................................................................................................\", \"............................................................. 148\\n\\n\\nPrinciple of least privilege ...\", \"....................................................................................................\", \".................................... 148\\n\\n\\nPenetration testing .....................................\", \"....................................................................................................\", \"............... 149\\n\\n\\nMonitoring ...................................................................\", \"....................................................................................................\", \". 149\\n\\n\\nSecuring the build .........................................................................\", \"................................................................................. 149\\n\\n\\nBuilding sec\", \"ure code ...........................................................................................\", \"......................................................... 150\\n\\n\\nBuilt-in security ..................\", \"....................................................................................................\", \"......................................... 150\\n\\n\\nAzure network infrastructure .......................\", \"....................................................................................................\", \".......... 150\\n\\n\\nRole-based access control for restricting access to Azure resources................\", \"........................................ 152\\n\\n\\nSecurity Principals .................................\", \"....................................................................................................\", \"..................... 152\\n\\n\\nRoles ..................................................................\", \"....................................................................................................\", \".............. 153\\n\\n\\nScopes ........................................................................\", \"....................................................................................................\", \".... 154\\n\\n\\nDeny ....................................................................................\", \"................................................................................................ 154\", \"\\n\\n\\nChecking access .................................................................................\", \"............................................................................. 154\\n\\n\\nSecuring secrets\", \" ...................................................................................................\", \"........................................................... 155\\n\\n\\nAzure Key Vault ..................\", \"....................................................................................................\", \"......................................... 155\\n\\n\\nKubernetes .........................................\", \"....................................................................................................\", \"........................... 155\\n\\n\\nEncryption in transit and at rest ................................\", \"............................................................................................... 156\\n\", \"\\n\\nKeeping secure ...................................................................................\", \"............................................................................. 160\\n\\n\\n**DevOps .......\", \"....................................................................................................\", \"...................... 161**\\n\\n\\nAzure DevOps ........................................................\", \"....................................................................................................\", \"........... 162\\n\\n\\nGitHub Actions ...................................................................\", \".................................................................................................. 1\", \"63\\n\\n\\nSource control ................................................................................\", \"...................................................................................... 163\\n\\n\\nReposit\", \"ory per microservice ...............................................................................\", \"....................................................... 164\\n\\n\\nSingle repository ....................\", \"....................................................................................................\", \".................................... 166\\n\\n\\nStandard directory structure ............................\", \"....................................................................................................\", \"...... 167\\n\\n\\nTask management .......................................................................\", \"....................................................................................... 167\\n\\n\\nCI/CD \", \"pipelines ..........................................................................................\", \".......................................................................... 169\\n\\n\\nAzure Builds ......\", \"....................................................................................................\", \"............................................................ 170\\n\\n\\nAzure DevOps releases ...........\", \"....................................................................................................\", \"................................. 172\\n\\n\\nvi Contents\\n\\n\\nEverybody gets a build pipeline ..............\", \"....................................................................................................\", \"............. 173\\n\\n\\nVersioning releases ............................................................\", \"............................................................................................ 173\\n\\n\\nF\", \"eature flags .......................................................................................\", \".................................................................................. 173\\n\\n\\nImplementin\", \"g feature flags ....................................................................................\", \".................................................... 174\\n\\n\\nInfrastructure as code ..................\", \"....................................................................................................\", \"................................. 175\\n\\n\\nAzure Resource Manager templates ...........................\", \"........................................................................................... 175\\n\\n\\nTe\", \"rraform ............................................................................................\", \"............................................................................... 176\\n\\n\\nAzure CLI Scri\", \"pts and Tasks.......................................................................................\", \"................................................. 177\\n\\n\\nCloud Native Application Bundles ...........\", \"....................................................................................................\", \"................ 178\\n\\n\\nDevOps Decisions ............................................................\", \".............................................................................................. 180\\n\\n\", \"\\nReferences ........................................................................................\", \"................................................................................. 180\\n\\n\\n**Summary: A\", \"rchitecting cloud-native apps ......................................................................\", \". 181**\\n\\n\\nvii Contents\\n\\n\\n**CHAPTER**\\n# 1\\n\\n## Introduction to cloud- native applications\\n\\n\\nAnother da\", \"y, at the office, working on \\u201cthe next big thing.\\u201d\\n\\n\\nYour cellphone rings. It\\u2019s your friendly recrui\", \"ter - the one who calls daily with exciting new\\nopportunities.\\n\\n\\nBut this time it\\u2019s different: Start\", \"-up, equity, and plenty of funding.\\n\\n\\nThe mention of the cloud, microservices, and cutting-edge tech\", \"nology pushes you over the edge.\\n\\n\\nFast forward a few weeks and you\\u2019re now a new employee in a desig\", \"n session architecting a major\\neCommerce application. You\\u2019re going to compete with the leading eComm\", \"erce sites.\\n\\n\\nHow will you build it?\\n\\n\\nIf you follow the guidance from past 15 years, you\\u2019ll most li\", \"kely build the system shown in Figure 1.1.\\n\\n\\n_Figure 1-1. Traditional monolithic design_\\n\\n\\nYou const\", \"ruct a large core application containing all of your domain logic. It includes modules such as\\nIdent\", \"ity, Catalog, Ordering, and more. They directly communicate with each other within a single\\nserver p\", \"rocess. The modules share a large relational database. The core exposes functionality via an\\nHTML in\", \"terface and a mobile app.\\n\\n\\nCongratulations! You just created a monolithic application.\\n\\n\\nNot all is\", \" bad. Monoliths offer some distinct advantages. For example, they\\u2019re straightforward to\\u2026\\n\\n\\n1 CHAPTER\", \" 1 | Introduction to cloud-native applications\\n\\n\\n  - build\\n\\n  - test\\n\\n  - deploy\\n\\n  - troubleshoot\\n\\n\", \"  - vertically scale\\n\\n\\nMany successful apps that exist today were created as monoliths. The app is a\", \" hit and continues to\\nevolve, iteration after iteration, adding more functionality.\\n\\n\\nAt some point,\", \" however, you begin to feel uncomfortable. You find yourself losing control of the\\napplication. As t\", \"ime goes on, the feeling becomes more intense, and you eventually enter a state\\nknown as the Fear Cy\", \"cle:\\n\\n\\n  - The app has become so overwhelmingly complicated that no single person understands it.\\n\\n \", \" - You fear making changes - each change has unintended and costly side effects.\\n\\n  - New features/f\", \"ixes become tricky, time-consuming, and expensive to implement.\\n\\n  - Each release becomes as small a\", \"s possible and requires a full deployment of the entire\\napplication.\\n\\n  - One unstable component can\", \" crash the entire system.\\n\\n  - New technologies and frameworks aren\\u2019t an option.\\n\\n  - It\\u2019s difficult\", \" to implement agile delivery methodologies.\\n\\n  - Architectural erosion sets in as the code base dete\", \"riorates with never-ending \\u201cquick fixes.\\u201d\\n\\n  - Finally, the _consultants_ come in and tell you to re\", \"write it.\\n\\n\\nSound familiar?\\n\\n\\nMany organizations have addressed this monolithic fear cycle by adopti\", \"ng a cloud-native approach to\\nbuilding systems. Figure 1-2 shows the same system built applying clou\", \"d-native techniques and\\npractices.\\n\\n\\n2 CHAPTER 1 | Introduction to cloud-native applications\\n\\n\\n_Figu\", \"re 1-2. Cloud-native design_\\n\\n\\nNote how the application is decomposed across a set of small isolated\", \" microservices. Each service is\\nself-contained and encapsulates its own code, data, and dependencies\", \". Each is deployed in a software\\ncontainer and managed by a container orchestrator. Instead of a lar\", \"ge relational database, each\\nservice owns it own datastore, the type of which vary based upon the da\", \"ta needs. Note how some\\nservices depend on a relational database, but other on NoSQL databases. One \", \"service stores its state\\nin a distributed cache. Note how all traffic routes through an API Gateway \", \"service that is responsible\\nfor routing traffic to the core back-end services and enforcing many cro\", \"ss-cutting concerns. Most\\nimportantly, the application takes full advantage of the scalability, avai\", \"lability, and resiliency features\\nfound in modern cloud platforms.\\n\\n#### **Cloud-native computing**\\n\", \"\\n\\nHmm\\u2026 We just used the term, _Cloud Native_ . Your first thought might be, \\u201cWhat exactly does that\\n\", \"mean?\\u201d Another industry buzzword concocted by software vendors to market more stuff?\\u201d\\n\\n\\nFortunately \", \"it\\u2019s far different, and hopefully this book will help convince you.\\n\\n\\nWithin a short time, cloud nat\", \"ive has become a driving trend in the software industry. It\\u2019s a new way\\nto construct large, complex \", \"systems. The approach takes full advantage of modern software\\ndevelopment practices, technologies, a\", \"nd cloud infrastructure. Cloud native changes the way you\\ndesign, implement, deploy, and operational\", \"ize systems.\\n\\n\\nUnlike the continuous hype that drives our industry, cloud native is _for-real_ [. Co\", \"nsider the Cloud Native](https://www.cncf.io/)\\n[Computing Foundation](https://www.cncf.io/) (CNCF), \", \"a consortium of over 400 major corporations. Its charter is to make\\n\\n\\n3 CHAPTER 1 | Introduction to \", \"cloud-native applications\\n\\n\\ncloud-native computing ubiquitous across technology and cloud stacks. As\", \" one of the most influential\\nopen-source groups, it hosts many of the fastest-growing open source-pr\", \"ojects in GitHub. These\\n[projects include Kubernetes, Prometheus,](https://kubernetes.io/) [Helm, En\", \"voy, and gRPC.](https://helm.sh/)\\n\\n\\nThe CNCF fosters an ecosystem of open-source and vendor-neutrali\", \"ty. Following that lead, this book\\npresents cloud-native principles, patterns, and best practices th\", \"at are technology agnostic. At the\\nsame time, we discuss the services and infrastructure available i\", \"n the Microsoft Azure cloud for\\nconstructing cloud-native systems.\\n\\n\\nSo, what exactly is Cloud Nativ\", \"e? Sit back, relax, and let us help you explore this new world.\\n\\n### What is Cloud Native?\\n\\n\\nStop wh\", \"at you\\u2019re doing and ask your colleagues to define the term \\u201cCloud Native\\u201d. There\\u2019s a good\\nchance you\", \"\\u2019ll get several different answers.\\n\\n\\nLet\\u2019s start with a simple definition:\\n\\n\\n_Cloud-native architect\", \"ure and technologies are an approach to designing, constructing, and operating_\\n_workloads that are \", \"built in the cloud and take full advantage of the cloud computing model._\\n\\n\\n[The Cloud Native Comput\", \"ing Foundation provides the official definition:](https://www.cncf.io/)\\n\\n\\n_Cloud-native technologies\", \" empower organizations to build and run scalable applications in modern,_\\n_dynamic environments such\", \" as public, private, and hybrid clouds. Containers, service meshes,_\\n_microservices, immutable infra\", \"structure, and declarative APIs exemplify this approach._\\n\\n\\n_These techniques enable loosely coupled\", \" systems that are resilient, manageable, and observable._\\n_Combined with robust automation, they all\", \"ow engineers to make high-impact changes frequently and_\\n_predictably with minimal toil._\\n\\n\\nCloud na\", \"tive is about _speed_ and _agility_ . Business systems are evolving from enabling business\\ncapabilit\", \"ies to weapons of strategic transformation that accelerate business velocity and growth. It\\u2019s\\nimpera\", \"tive to get new ideas to market immediately.\\n\\n\\nAt the same time, business systems have also become i\", \"ncreasingly complex with users demanding\\nmore. They expect rapid responsiveness, innovative features\", \", and zero downtime. Performance\\nproblems, recurring errors, and the inability to move fast are no l\", \"onger acceptable. Your users will visit\\nyour competitor. Cloud-native systems are designed to embrac\", \"e rapid change, large scale, and\\nresilience.\\n\\n\\nHere are some companies who have implemented cloud-na\", \"tive techniques. Think about the speed,\\nagility, and scalability they\\u2019ve achieved.\\n\\n|Company|Experie\", \"nce|\\n|---|---|\\n|Netflix|Has 600+ services in production. Deploys 100<br>times per day.|\\n|Uber|Has 1,\", \"000+ services in production. Deploys<br>several thousand times each week.|\\n\\n\\n\\n4 CHAPTER 1 | Introduc\", \"tion to cloud-native applications\\n\\n\\n|Company|Experience|\\n|---|---|\\n|WeChat|Has 3,000+ services in pr\", \"oduction. Deploys<br>1,000 times a day.|\\n\\n\\nAs you can see, Netflix, Uber, and, WeChat expose cloud-n\", \"ative systems that consist of many\\nindependent services. This architectural style enables them to ra\", \"pidly respond to market conditions.\\nThey instantaneously update small areas of a live, complex appli\", \"cation, without a full redeployment.\\nThey individually scale services as needed.\\n\\n#### **The pillars\", \" of cloud native**\\n\\n\\nThe speed and agility of cloud native derive from many factors. Foremost is _cl\", \"oud infrastructure_ . But\\nthere\\u2019s more: Five other foundational pillars shown in Figure 1-3 also pro\", \"vide the bedrock for cloudnative systems.\\n\\n\\n_Figure 1-3. Cloud-native foundational pillars_\\n\\n\\nLet\\u2019s \", \"take some time to better understand the significance of each pillar.\\n\\n#### **The cloud**\\n\\n\\nCloud-nat\", \"ive systems take full advantage of the cloud service model.\\n\\n\\nDesigned to thrive in a dynamic, virtu\", \"alized cloud environment, these systems make extensive use of\\n[Platform as a Service (PaaS) compute \", \"infrastructure and managed services. They treat the underlying](https://azure.microsoft.com/overview\", \"/what-is-paas/)\\ninfrastructure as _disposable_ - provisioned in minutes and resized, scaled, or dest\", \"royed on demand \\u2013\\nvia automation.\\n\\n\\n[Consider the widely accepted DevOps concept of Pets vs. Cattle.\", \" In a traditional data center, servers](https://medium.com/@Joachim8675309/devops-concepts-pets-vs-c\", \"attle-2380b5aab313)\\nare treated as _Pets_ : a physical machine, given a meaningful name, and _cared_\", \" for. You scale by adding\\nmore resources to the same machine (scaling up). If the server becomes sic\", \"k, you nurse it back to\\nhealth. Should the server become unavailable, everyone notices.\\n\\n\\nThe _Cattl\", \"e_ service model is different. You provision each instance as a virtual machine or container.\\nThey\\u2019r\", \"e identical and assigned a system identifier such as Service-01, Service-02, and so on. You scale\\nby\", \" creating more of them (scaling out). When one becomes unavailable, nobody notices.\\n\\n\\n5 CHAPTER 1 | \", \"Introduction to cloud-native applications\\n\\n\\nThe cattle model embraces _immutable infrastructure_ . S\", \"ervers aren\\u2019t repaired or modified. If one fails or\\nrequires updating, it\\u2019s destroyed and a new one \", \"is provisioned \\u2013 all done via automation.\\n\\n\\nCloud-native systems embrace the Cattle service model. T\", \"hey continue to run as the infrastructure\\nscales in or out with no regard to the machines upon which\", \" they\\u2019re running.\\n\\n\\nThe Azure cloud platform supports this type of highly elastic infrastructure wit\", \"h automatic scaling,\\nself-healing, and monitoring capabilities.\\n\\n#### **Modern design**\\n\\n\\nHow would \", \"you design a cloud-native app? What would your architecture look like? To what\\nprinciples, patterns,\", \" and best practices would you adhere? What infrastructure and operational\\nconcerns would be importan\", \"t?\\n\\n\\n**The Twelve-Factor Application**\\n\\n\\n[A widely accepted methodology for constructing cloud-based\", \" applications is the Twelve-Factor](https://12factor.net/)\\n[Application. It describes a set of princ\", \"iples and practices that developers follow to construct](https://12factor.net/)\\napplications optimiz\", \"ed for modern cloud environments. Special attention is given to portability across\\nenvironments and \", \"declarative automation.\\n\\n\\nWhile applicable to any web-based application, many practitioners consider\", \" Twelve-Factor a solid\\nfoundation for building cloud-native apps. Systems built upon these principle\", \"s can deploy and scale\\nrapidly and add features to react quickly to market changes.\\n\\n\\nThe following \", \"table highlights the Twelve-Factor methodology:\\n\\n|Factor|Explanation|\\n|---|---|\\n|1 - Code Base|A sin\", \"gle code base for each microservice, stored<br>in its own repository. Tracked with version<br>contro\", \"l, it can deploy to multiple environments<br>(QA, Staging, Production).|\\n|2 - Dependencies|Each micr\", \"oservice isolates and packages its own<br>dependencies, embracing changes without<br>impacting the e\", \"ntire system.|\\n|3 - Configurations|Configuration information is moved out of the<br>microservice and\", \" externalized through a<br>configuration management tool outside of the<br>code. The same deployment\", \" can propagate<br>across environments with the correct<br>configuration applied.|\\n|4 - Backing Servi\", \"ces|Ancillary resources (data stores, caches,<br>message brokers) should be exposed via an<br>addres\", \"sable URL. Doing so decouples the<br>resource from the application, enabling it to be<br>interchange\", \"able.|\\n\\n\\n\\n6 CHAPTER 1 | Introduction to cloud-native applications\\n\\n\\n|Factor|Explanation|\\n|---|---|\\n|\", \"5 - Build, Release, Run|Each release must enforce a strict separation<br>across the build, release, \", \"and run stages. Each<br>should be tagged with a unique ID and support<br>the ability to roll back. M\", \"odern CI/CD systems<br>help fulfill this principle.|\\n|6 - Processes|Each microservice should execute\", \" in its own<br>process, isolated from other running services.<br>Externalize required state to a bac\", \"king service<br>such as a distributed cache or data store.|\\n|7 - Port Binding|Each microservice shou\", \"ld be self-contained with<br>its interfaces and functionality exposed on its<br>own port. Doing so p\", \"rovides isolation from<br>other microservices.|\\n|8 - Concurrency|When capacity needs to increase, sc\", \"ale out<br>services horizontally across multiple identical<br>processes (copies) as opposed to scali\", \"ng-up a<br>single large instance on the most powerful<br>machine available. Develop the application \", \"to be<br>concurrent making scaling out in cloud<br>environments seamless.|\\n|9 - Disposability|Servic\", \"e instances should be disposable. Favor<br>fast startup to increase scalability opportunities<br>and\", \" graceful shutdowns to leave the system in a<br>correct state. Docker containers along with an<br>or\", \"chestrator inherently satisfy this requirement.|\\n|10 - Dev/Prod Parity|Keep environments across the \", \"application<br>lifecycle as similar as possible, avoiding costly<br>shortcuts. Here, the adoption of\", \" containers can<br>greatly contribute by promoting the same<br>execution environment.|\\n|11 - Logging\", \"|Treat logs generated by microservices as event<br>streams. Process them with an event<br>aggregator\", \". Propagate log data to data-<br>mining/log management tools like Azure<br>Monitor or Splunk and eve\", \"ntually to long-term<br>archival.|\\n|12 - Admin Processes|Run administrative/management tasks, such a\", \"s<br>data cleanup or computing analytics, as one-off<br>processes. Use independent tools to invoke<b\", \"r>these tasks from the production environment,<br>but separately from the application.|\\n\\n\\n7 CHAPTER \", \"1 | Introduction to cloud-native applications\\n\\n\\n[In the book, Beyond the Twelve-Factor App, author K\", \"evin Hoffman details each of the original 12](https://content.pivotal.io/blog/beyond-the-twelve-fact\", \"or-app)\\nfactors (written in 2011). Additionally, he discusses three extra factors that reflect today\", \"\\u2019s modern\\ncloud application design.\\n\\n|New Factor|Explanation|\\n|---|---|\\n|13 - API First|Make everyth\", \"ing a service. Assume your code<br>will be consumed by a front-end client, gateway,<br>or another se\", \"rvice.|\\n|14 - Telemetry|On a workstation, you have deep visibility into<br>your application and its \", \"behavior. In the cloud,<br>you don\\u2019t. Make sure your design includes the<br>collection of monitoring\", \", domain-specific, and<br>health/system data.|\\n|15 - Authentication/ Authorization|Implement identit\", \"y from the start. Consider<br>RBAC (role-based access control) features<br>available in public cloud\", \"s.|\\n\\n\\n\\nWe\\u2019ll refer to many of the 12+ factors in this chapter and throughout the book.\\n\\n\\n**Azure Wel\", \"l-Architected Framework**\\n\\n\\nDesigning and deploying cloud-based workloads can be challenging, especi\", \"ally when implementing\\ncloud-native architecture. Microsoft provides industry standard best practice\", \"s to help you and your\\nteam deliver robust cloud solutions.\\n\\n\\n[The Microsoft Well-Architected Framew\", \"ork provides a set of guiding tenets that can be used to](https://docs.microsoft.com/azure/architect\", \"ure/framework/)\\nimprove the quality of a cloud-native workload. The framework consists of five pilla\", \"rs of architecture\\nexcellence:\\n\\n|Tenets|Description|\\n|---|---|\\n|Cost management|Focus on generating \", \"incremental value early.<br>Apply_Build-Measure-Learn_ principles to<br>accelerate time to market wh\", \"ile avoiding<br>capital-intensive solutions. Using a pay-as-you-<br>go strategy, invest as you scale\", \" out, rather than<br>delivering a large investment up front.|\\n|Operational excellence|Automate the e\", \"nvironment and operations to<br>increase speed and reduce human error. Roll<br>problem updates back \", \"or forward quickly.<br>Implement monitoring and diagnostics from the<br>start.|\\n|Performance efficie\", \"ncy|Efficiently meet demands placed on your<br>workloads. Favor horizontal scaling (scaling out)<br>\", \"and design it into your systems. Continually<br>conduct performance and load testing to<br>identify \", \"potential bottlenecks.|\\n\\n\\n\\n8 CHAPTER 1 | Introduction to cloud-native applications\\n\\n\\n|Tenets|Descrip\", \"tion|\\n|---|---|\\n|Reliability|Build workloads that are both resilient and<br>available. Resiliency en\", \"ables workloads to<br>recover from failures and continue functioning.<br>Availability ensures users \", \"access to your<br>workload at all times. Design applications to<br>expect failures and recover from \", \"them.|\\n|Security|Implement security across the entire lifecycle of<br>an application, from design an\", \"d implementation<br>to deployment and operations. Pay close<br>attention to identity management, inf\", \"rastructure<br>access, application security, and data<br>sovereignty and encryption.|\\n\\n\\n[To get star\", \"ted, Microsoft provides a set of online assessments](https://docs.microsoft.com/assessments/?mode=pr\", \"e-assessment&session=local) to help you assess your current cloud\\nworkloads against the five well-ar\", \"chitected pillars.\\n\\n#### **Microservices**\\n\\n\\nCloud-native systems embrace microservices, a popular a\", \"rchitectural style for constructing modern\\napplications.\\n\\n\\nBuilt as a distributed set of small, inde\", \"pendent services that interact through a shared fabric,\\nmicroservices share the following characteri\", \"stics:\\n\\n\\n  - Each implements a specific business capability within a larger domain context.\\n\\n\\n  - Ea\", \"ch is developed autonomously and can be deployed independently.\\n\\n\\n  - Each is self-contained encapsu\", \"lating its own data storage technology, dependencies, and\\nprogramming platform.\\n\\n\\n  - Each runs in i\", \"ts own process and communicates with others using standard communication\\n[protocols such as HTTP/HTT\", \"PS, gRPC, WebSockets, or AMQP.](https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol)\\n\\n\\n \", \" - They compose together to form an application.\\n\\n\\nFigure 1-4 contrasts a monolithic application app\", \"roach with a microservices approach. Note how the\\nmonolith is composed of a layered architecture, wh\", \"ich executes in a single process. It typically\\nconsumes a relational database. The microservice appr\", \"oach, however, segregates functionality into\\nindependent services, each with its own logic, state, a\", \"nd data. Each microservice hosts its own\\ndatastore.\\n\\n\\n9 CHAPTER 1 | Introduction to cloud-native app\", \"lications\\n\\n\\n_Figure 1-4. Monolithic versus microservices architecture_\\n\\n\\nNote how microservices prom\", \"ote the **Processes** [principle from the Twelve-Factor Application,](https://12factor.net/)\\ndiscuss\", \"ed earlier in the chapter.\\n\\n\\n_Factor #6 specifies \\u201cEach microservice should execute in its own proce\", \"ss, isolated from other running_\\n_services.\\u201d_\\n\\n\\n**Why microservices?**\\n\\n\\nMicroservices provide agili\", \"ty.\\n\\n\\nEarlier in the chapter, we compared an eCommerce application built as a monolith to that with\\n\", \"microservices. In the example, we saw some clear benefits:\\n\\n\\n  - Each microservice has an autonomous\", \" lifecycle and can evolve independently and deploy\\nfrequently. You don\\u2019t have to wait for a quarterl\", \"y release to deploy a new feature or update.\\nYou can update a small area of a live application with \", \"less risk of disrupting the entire system.\\nThe update can be made without a full redeployment of the\", \" application.\\n\\n\\n  - Each microservice can scale independently. Instead of scaling the entire applica\", \"tion as a single\\nunit, you scale out only those services that require more processing power to meet \", \"desired\\nperformance levels and service-level agreements. Fine-grained scaling provides for greater\\nc\", \"ontrol of your system and helps reduce overall costs as you scale portions of your system,\\nnot every\", \"thing.\\n\\n\\n[An excellent reference guide for understanding microservices is .NET Microservices: Archit\", \"ecture for](https://dotnet.microsoft.com/download/thank-you/microservices-architecture-ebook)\\n[Conta\", \"inerized .NET Applications. The book deep dives into microservices design and architecture. It\\u2019s](ht\", \"tps://dotnet.microsoft.com/download/thank-you/microservices-architecture-ebook)\\n[a companion for a f\", \"ull-stack microservice reference architecture](https://github.com/dotnet-architecture/eShopOnContain\", \"ers) available as a free download from\\nMicrosoft.\\n\\n\\n**Developing microservices**\\n\\n\\nMicroservices can\", \" be created upon any modern development platform.\\n\\n\\n10 CHAPTER 1 | Introduction to cloud-native appl\", \"ications\\n\\n\\nThe Microsoft .NET platform is an excellent choice. Free and open source, it has many bui\", \"lt-in features\\nthat simplify microservice development. .NET is cross-platform. Applications can be b\", \"uilt and run on\\nWindows, macOS, and most flavors of Linux.\\n\\n\\n.NET is highly performant and has score\", \"d well in comparison to Node.js and other competing\\n[platforms. Interestingly, TechEmpower conducted\", \" an extensive set of performance benchmarks across](https://www.techempower.com/)\\nmany web applicati\", \"on platforms and frameworks. .NET scored in the top 10 - well above Node.js and\\nother competing plat\", \"forms.\\n\\n\\n[.NET](https://github.com/dotnet/core) is maintained by Microsoft and the .NET community on\", \" GitHub.\\n\\n\\n**Microservice challenges**\\n\\n\\nWhile distributed cloud-native microservices can provide im\", \"mense agility and speed, they present\\nmany challenges:\\n\\n\\n_**Communication**_\\n\\nHow will front-end cli\", \"ent applications communicate with backed-end core microservices? Will you\\nallow direct communication\", \"? Or, might you abstract the back-end microservices with a gateway\\nfacade that provides flexibility,\", \" control, and security?\\n\\n\\nHow will back-end core microservices communicate with each other? Will you\", \" allow direct HTTP calls\\nthat can increase coupling and impact performance and agility? Or might you\", \" consider decoupled\\nmessaging with queue and topic technologies?\\n\\n\\nCommunication is covered in the C\", \"loud-native communication patterns chapter.\\n\\n\\n_**Resiliency**_\\n\\n\\nA microservices architecture moves \", \"your system from in-process to out-of-process network\\ncommunication. In a distributed architecture, \", \"what happens when Service B isn\\u2019t responding to a\\nnetwork call from Service A? Or, what happens when\", \" Service C becomes temporarily unavailable and\\nother services calling it become blocked?\\n\\n\\nResilienc\", \"y is covered in the Cloud-native resiliency chapter.\\n\\n\\n_**Distributed Data**_\\n\\n\\nBy design, each micr\", \"oservice encapsulates its own data, exposing operations via its public interface. If\\nso, how do you \", \"query data or implement a transaction across multiple services?\\n\\n\\nDistributed data is covered in the\", \" Cloud-native data patterns chapter.\\n\\n\\n_**Secrets**_\\n\\n\\nHow will your microservices securely store an\", \"d manage secrets and sensitive configuration data?\\n\\n\\nSecrets are covered in detail Cloud-native secu\", \"rity.\\n\\n\\n11 CHAPTER 1 | Introduction to cloud-native applications\\n\\n\\n**Manage Complexity with Dapr**\\n\\n\", \"\\n[Dapr](https://dapr.io/) is a distributed, open-source application runtime. Through an architecture\", \" of pluggable\\ncomponents, it dramatically simplifies the _plumbing_ behind distributed applications.\", \" It provides a\\n**dynamic glue** that binds your application with pre-built infrastructure capabiliti\", \"es and components\\nfrom the Dapr runtime. Figure 1-5 shows Dapr from 20,000 feet.\\n\\n\\n_Figure 1-5. Dapr\", \" at 20,000 feet._\\n\\n\\n[In the top row of the figure, note how Dapr provides language-specific SDKs for\", \" popular development](https://docs.dapr.io/developing-applications/sdks/)\\nplatforms. Dapr v1 include\", \"s support for .NET, Go, Node.js, Python, PHP, Java, and JavaScript.\\n\\n\\nWhile language-specific SDKs e\", \"nhance the developer experience, Dapr is platform agnostic. Under the\\nhood, Dapr\\u2019s programming model\", \" exposes capabilities through standard HTTP/gRPC communication\\nprotocols. Any programming platform c\", \"an call Dapr via its native HTTP and gRPC APIs.\\n\\n\\nThe blue boxes across the center of the figure rep\", \"resent the Dapr building blocks. Each exposes prebuilt plumbing code for a distributed application c\", \"apability that your application can consume.\\n\\n\\nThe components row represents a large set of pre-defi\", \"ned infrastructure components that your\\napplication can consume. Think of components as infrastructu\", \"re code you don\\u2019t have to write.\\n\\n\\nThe bottom row highlights the portability of Dapr and the diverse\", \" environments across which it can\\nrun.\\n\\n\\n[Microsoft features a free ebook Dapr for .NET Developers](\", \"https://docs.microsoft.com/dotnet/architecture/dapr-for-net-developers/) for learning Dapr.\\n\\n\\nLookin\", \"g ahead, Dapr has the potential to have a profound impact on cloud-native application\\ndevelopment.\\n\\n\", \"#### **Containers**\\n\\n\\nIt\\u2019s natural to hear the term _container_ mentioned in any _cloud native_ [con\", \"versation. In the book, Cloud](https://www.manning.com/books/cloud-native-patterns)\\n[Native Patterns\", \", author Cornelia Davis observes that, \\u201cContainers are a great enabler of cloud-native](https://www.\", \"manning.com/books/cloud-native-patterns)\\n\\n\\n12 CHAPTER 1 | Introduction to cloud-native applications\\n\", \"\\n\\nsoftware.\\u201d The Cloud Native Computing Foundation places microservice containerization as the first\", \"\\n[step in their Cloud-Native Trail Map - guidance for enterprises beginning their cloud-native journ\", \"ey.](https://raw.githubusercontent.com/cncf/trailmap/master/CNCF_TrailMap_latest.png)\\n\\n\\nContainerizi\", \"ng a microservice is simple and straightforward. The code, its dependencies, and runtime\\n[are packag\", \"ed into a binary called a container image. Images are stored in a container registry, which](https:/\", \"/docs.docker.com/glossary/?term=image)\\nacts as a repository or library for images. A registry can be\", \" located on your development computer, in\\n[your data center, or in a public cloud. Docker itself mai\", \"ntains a public registry via Docker Hub. The](https://hub.docker.com/)\\n[Azure cloud features a priva\", \"te container registry](https://azure.microsoft.com/services/container-registry/) to store container \", \"images close to the cloud\\napplications that will run them.\\n\\n\\nWhen an application starts or scales, y\", \"ou transform the container image into a running container\\n[instance. The instance runs on any comput\", \"er that has a container runtime](https://kubernetes.io/docs/setup/production-environment/container-r\", \"untimes/) engine installed. You can\\nhave as many instances of the containerized service as needed.\\n\\n\", \"\\nFigure 1-6 shows three different microservices, each in its own container, all running on a single \", \"host.\\n\\n\\n_Figure 1-6. Multiple containers running on a container host_\\n\\n\\nNote how each container main\", \"tains its own set of dependencies and runtime, which can be different\\nfrom one another. Here, we see\", \" different versions of the Product microservice running on the same\\nhost. Each container shares a sl\", \"ice of the underlying host operating system, memory, and processor,\\nbut is isolated from one another\", \".\\n\\n\\nNote how well the container model embraces the **Dependencies** [principle from the Twelve-Facto\", \"r](https://12factor.net/)\\n[Application.](https://12factor.net/)\\n\\n\\n_Factor #2 specifies that \\u201cEach mi\", \"croservice isolates and packages its own dependencies, embracing_\\n_changes without impacting the ent\", \"ire system.\\u201d_\\n\\n\\nContainers support both Linux and Windows workloads. The Azure cloud openly embraces\", \" both.\\nInterestingly, it\\u2019s Linux, not Windows Server, that has become the more popular operating sys\", \"tem in\\nAzure.\\n\\n\\n13 CHAPTER 1 | Introduction to cloud-native applications\\n\\n\\n[While several container \", \"vendors exist, Docker](https://www.docker.com/) has captured the lion\\u2019s share of the market. The\\ncom\", \"pany has been driving the software container movement. It has become the de facto standard for\\npacka\", \"ging, deploying, and running cloud-native applications.\\n\\n\\n**Why containers?**\\n\\n\\nContainers provide p\", \"ortability and guarantee consistency across environments. By encapsulating\\neverything into a single \", \"package, you _isolate_ the microservice and its dependencies from the\\nunderlying infrastructure.\\n\\n\\nY\", \"ou can deploy the container in any environment that hosts the Docker runtime engine. Containerized\\nw\", \"orkloads also eliminate the expense of pre-configuring each environment with frameworks, software\\nli\", \"braries, and runtime engines.\\n\\n\\nBy sharing the underlying operating system and host resources, a con\", \"tainer has a much smaller\\nfootprint than a full virtual machine. The smaller size increases the _den\", \"sity_, or number of\\nmicroservices, that a given host can run at one time.\\n\\n\\n**Container orchestratio\", \"n**\\n\\n\\nWhile tools such as Docker create images and run containers, you also need tools to manage the\", \"m.\\nContainer management is done with a special software program called a **container orchestrator** \", \".\\nWhen operating at scale with many independent running containers, orchestration is essential.\\n\\n\\nFi\", \"gure 1-7 shows management tasks that container orchestrators automate.\\n\\n\\n_Figure 1-7. What container\", \" orchestrators do_\\n\\n\\nThe following table describes common orchestration tasks.\\n\\n|Tasks|Explanation|\\n\", \"|---|---|\\n|Scheduling|Automatically provision container instances.|\\n|Affinity/anti-affinity|Provisio\", \"n containers nearby or far apart from<br>each other, helping availability and<br>performance.|\\n|Heal\", \"th monitoring|Automatically detect and correct failures.|\\n|Failover|Automatically reprovision a fail\", \"ed instance to a<br>healthy machine.|\\n\\n\\n\\n14 CHAPTER 1 | Introduction to cloud-native applications\\n\\n\\n\", \"|Tasks|Explanation|\\n|---|---|\\n|Scaling|Automatically add or remove a container<br>instance to meet d\", \"emand.|\\n|Networking|Manage a networking overlay for container<br>communication.|\\n|Service Discovery|\", \"Enable containers to locate each other.|\\n|Rolling Upgrades|Coordinate incremental upgrades with zero\", \"<br>downtime deployment. Automatically roll back<br>problematic changes.|\\n\\n\\nNote how container orche\", \"strators embrace the **Disposability** and **Concurrency** principles from the\\n[Twelve-Factor Applic\", \"ation.](https://12factor.net/)\\n\\n\\n_Factor #9 specifies that \\u201cService instances should be disposable, \", \"favoring fast startups to increase_\\n_scalability opportunities and graceful shutdowns to leave the s\", \"ystem in a correct state.\\u201d_ Docker\\ncontainers along with an orchestrator inherently satisfy this req\", \"uirement.\\u201d\\n\\n\\n_Factor #8 specifies that \\u201cServices scale out across a large number of small identical \", \"processes (copies) as_\\n_opposed to scaling-up a single large instance on the most powerful machine a\", \"vailable.\\u201d_\\n\\n\\n[While several container orchestrators exist, Kubernetes](https://kubernetes.io/docs/c\", \"oncepts/overview/what-is-kubernetes/) has become the de facto standard for the\\ncloud-native world. I\", \"t\\u2019s a portable, extensible, open-source platform for managing containerized\\nworkloads.\\n\\n\\nYou could h\", \"ost your own instance of Kubernetes, but then you\\u2019d be responsible for provisioning and\\nmanaging its\", \" resources - which can be complex. The Azure cloud features Kubernetes as a managed\\n[service. Both A\", \"zure Kubernetes Service (AKS) and Azure Red Hat OpenShift (ARO)](https://azure.microsoft.com/service\", \"s/kubernetes-service/) enable you to fully\\nleverage the features and power of Kubernetes as a manage\", \"d service, without having to install and\\nmaintain it.\\n\\n\\nContainer orchestration is covered in detail\", \" in Scaling Cloud-Native Applications.\\n\\n#### **Backing services**\\n\\n\\nCloud-native systems depend upon\", \" many different ancillary resources, such as data stores, message\\n[brokers, monitoring, and identity\", \" services. These services are known as backing services.](https://12factor.net/backing-services)\\n\\n\\nF\", \"igure 1-8 shows many common backing services that cloud-native systems consume.\\n\\n\\n15 CHAPTER 1 | Int\", \"roduction to cloud-native applications\\n\\n\\n_Figure 1-8. Common backing services_\\n\\n\\nYou could host your\", \" own backing services, but then you\\u2019d be responsible for licensing, provisioning,\\nand managing those\", \" resources.\\n\\n\\nCloud providers offer a rich assortment of _managed backing services._ Instead of owni\", \"ng the service,\\nyou simply consume it. The cloud provider operates the resource at scale and bears t\", \"he responsibility\\nfor performance, security, and maintenance. Monitoring, redundancy, and availabili\", \"ty are built into the\\nservice. Providers guarantee service level performance and fully support their\", \" managed services open a ticket and they fix your issue.\\n\\n\\nCloud-native systems favor managed backin\", \"g services from cloud vendors. The savings in time and\\nlabor can be significant. The operational ris\", \"k of hosting your own and experiencing trouble can get\\nexpensive fast.\\n\\n\\nA best practice is to treat\", \" a backing service as an **attached resource**, dynamically bound to a\\nmicroservice with configurati\", \"on information (a URL and credentials) stored in an external\\n[configuration. This guidance is spelle\", \"d out in the Twelve-Factor Application, discussed earlier in the](https://12factor.net/)\\nchapter.\\n\\n\\n\", \"_Factor #4_ specifies that backing services \\u201cshould be exposed via an addressable URL. Doing so\\ndeco\", \"uples the resource from the application, enabling it to be interchangeable.\\u201d\\n\\n\\n_Factor #3_ specifies\", \" that \\u201cConfiguration information is moved out of the microservice and externalized\\nthrough a configu\", \"ration management tool outside of the code.\\u201d\\n\\n\\nWith this pattern, a backing service can be attached \", \"and detached without code changes. You might\\npromote a microservice from QA to a staging environment\", \". You update the microservice\\nconfiguration to point to the backing services in staging and inject t\", \"he settings into your container\\nthrough an environment variable.\\n\\n\\n16 CHAPTER 1 | Introduction to cl\", \"oud-native applications\\n\\n\\nCloud vendors provide APIs for you to communicate with their proprietary b\", \"acking services. These\\nlibraries encapsulate the proprietary plumbing and complexity. However, commu\", \"nicating directly with\\nthese APIs will tightly couple your code to that specific backing service. It\", \"\\u2019s a widely accepted practice\\nto insulate the implementation details of the vendor API. Introduce an\", \" intermediation layer, or\\nintermediate API, exposing generic operations to your service code and wra\", \"p the vendor code inside\\nit. This loose coupling enables you to swap out one backing service for ano\", \"ther or move your code to\\na different cloud environment without having to make changes to the mainli\", \"ne service code. Dapr,\\n[discussed earlier, follows this model with its set of prebuilt building bloc\", \"ks.](https://docs.dapr.io/developing-applications/building-blocks/)\\n\\n\\nOn a final thought, backing se\", \"rvices also promote the **Statelessness** [principle from the Twelve-Factor](https://12factor.net/)\\n\", \"[Application, discussed earlier in the chapter.](https://12factor.net/)\\n\\n\\n_Factor #6_ specifies that\", \", \\u201cEach microservice should execute in its own process, isolated from other\\nrunning services. Extern\", \"alize required state to a backing service such as a distributed cache or data\\nstore.\\u201d\\n\\n\\nBacking serv\", \"ices are discussed in Cloud-native data patterns and Cloud-native communication\\npatterns.\\n\\n#### **Au\", \"tomation**\\n\\n\\nAs you\\u2019ve seen, cloud-native systems embrace microservices, containers, and modern syst\", \"em design\\nto achieve speed and agility. But, that\\u2019s only part of the story. How do you provision the\", \" cloud\\nenvironments upon which these systems run? How do you rapidly deploy app features and updates\", \"?\\nHow do you round out the full picture?\\n\\n\\n[Enter the widely accepted practice of Infrastructure as \", \"Code, or IaC.](https://docs.microsoft.com/devops/deliver/what-is-infrastructure-as-code)\\n\\n\\nWith IaC,\", \" you automate platform provisioning and application deployment. You essentially apply\\nsoftware engin\", \"eering practices such as testing and versioning to your DevOps practices. Your\\ninfrastructure and de\", \"ployments are automated, consistent, and repeatable.\\n\\n\\n**Automating infrastructure**\\n\\n\\n[Tools like A\", \"zure Resource Manager, Azure Bicep,](https://docs.microsoft.com/azure/azure-resource-manager/managem\", \"ent/overview) [Terraform](https://www.terraform.io/) [from HashiCorp, and the Azure CLI, enable](htt\", \"ps://docs.microsoft.com/cli/azure/)\\nyou to declaratively script the cloud infrastructure you require\", \". Resource names, locations, capacities,\\nand secrets are parameterized and dynamic. The script is ve\", \"rsioned and checked into source control\\nas an artifact of your project. You invoke the script to pro\", \"vision a consistent and repeatable\\ninfrastructure across system environments, such as QA, staging, a\", \"nd production.\\n\\n\\nUnder the hood, IaC is idempotent, meaning that you can run the same script over an\", \"d over without\\nside effects. If the team needs to make a change, they edit and rerun the script. Onl\", \"y the updated\\nresources are affected.\\n\\n\\n[In the article, What is Infrastructure as Code, Author Sam \", \"Guckenheimer describes how, \\u201cTeams who](https://docs.microsoft.com/devops/deliver/what-is-infrastruc\", \"ture-as-code)\\nimplement IaC can deliver stable environments rapidly and at scale. They avoid manual \", \"configuration\\nof environments and enforce consistency by representing the desired state of their env\", \"ironments via\\ncode. Infrastructure deployments with IaC are repeatable and prevent runtime issues ca\", \"used by\\nconfiguration drift or missing dependencies. DevOps teams can work together with a unified s\", \"et of\\n\\n\\n17 CHAPTER 1 | Introduction to cloud-native applications\\n\\n\\npractices and tools to deliver ap\", \"plications and their supporting infrastructure rapidly, reliably, and at\\nscale.\\u201d\\n\\n\\n**Automating depl\", \"oyments**\\n\\n\\n[The Twelve-Factor Application, discussed earlier, calls for separate steps when transfo\", \"rming](https://12factor.net/)\\ncompleted code into a running application.\\n\\n\\n_Factor #5_ specifies tha\", \"t \\u201cEach release must enforce a strict separation across the build, release and run\\nstages. Each shou\", \"ld be tagged with a unique ID and support the ability to roll back.\\u201d\\n\\n\\nModern CI/CD systems help ful\", \"fill this principle. They provide separate build and delivery steps that\\nhelp ensure consistent and \", \"quality code that\\u2019s readily available to users.\\n\\n\\nFigure 1-9 shows the separation across the deploym\", \"ent process.\\n\\n\\n_Figure 1-9. Deployment steps in a CI/CD Pipeline_\\n\\n\\nIn the previous figure, pay spec\", \"ial attention to separation of tasks:\\n\\n\\n1. The developer constructs a feature in their development e\", \"nvironment, iterating through what\\nis called the \\u201cinner loop\\u201d of code, run, and debug.\\n\\n2. When comp\", \"lete, that code is _pushed_ into a code repository, such as GitHub, Azure DevOps, or\\nBitBucket.\\n\\n3. \", \"The push triggers a build stage that transforms the code into a binary artifact. The work is\\n[implem\", \"ented with a Continuous Integration (CI)](https://martinfowler.com/articles/continuousIntegration.ht\", \"ml) pipeline. It automatically builds, tests, and\\npackages the application.\\n\\n4. The release stage pi\", \"cks up the binary artifact, applies external application and environment\\nconfiguration information, \", \"and produces an immutable release. The release is deployed to a\\n[specified environment. The work is \", \"implemented with a Continuous Delivery (CD) pipeline.](https://martinfowler.com/bliki/ContinuousDeli\", \"very.html)\\nEach release should be identifiable. You can say, \\u201cThis deployment is running Release 2.1\", \".1 of\\nthe application.\\u201d\\n\\n\\n18 CHAPTER 1 | Introduction to cloud-native applications\\n\\n\\n5. Finally, the\", \" released feature is run in the target execution environment. Releases are\\nimmutable meaning that an\", \"y change must create a new release.\\n\\n\\nApplying these practices, organizations have radically evolved\", \" how they ship software. Many have\\nmoved from quarterly releases to on-demand updates. The goal is t\", \"o catch problems early in the\\ndevelopment cycle when they\\u2019re less expensive to fix. The longer the d\", \"uration between integrations,\\nthe more expensive problems become to resolve. With consistency in the\", \" integration process, teams\\ncan commit code changes more frequently, leading to better collaboration\", \" and software quality.\\n\\n\\nInfrastructure as code and deployment automation, along with GitHub and Azu\", \"re DevOps are\\ndiscussed in detail in DevOps.\\n\\n### Candidate apps for cloud native\\n\\n\\nThink about the \", \"apps your organization needs to build. Then, look at the existing apps in your\\nportfolio. How many o\", \"f them warrant a cloud-native architecture? All of them? Perhaps some?\\n\\n\\nApplying cost/benefit analy\", \"sis, there\\u2019s a good chance some wouldn\\u2019t support the effort. The cost of\\nbecoming cloud native would\", \" far exceed the business value of the application.\\n\\n\\nWhat type of application might be a candidate f\", \"or cloud native?\\n\\n\\n  - Strategic enterprise systems that need to constantly evolve business capabili\", \"ties/features\\n\\n\\n  - An application that requires a high release velocity - with high confidence\\n\\n\\n  \", \"- A system where individual features must release _without_ a full redeployment of the entire\\nsystem\", \"\\n\\n\\n  - An application developed by teams with expertise in different technology stacks\\n\\n\\n  - An appl\", \"ication with components that must scale independently\\n\\n\\nSmaller, less impactful line-of-business app\", \"lications might fare well with a simple monolithic\\narchitecture hosted in a Cloud PaaS environment.\\n\", \"\\n\\nThen there are legacy systems. While we\\u2019d all like to build new applications, we\\u2019re often responsi\", \"ble\\nfor modernizing legacy workloads that are critical to the business.\\n\\n#### **Modernizing legacy a\", \"pps**\\n\\n\\n[The free Microsoft e-book Modernize existing .NET applications with Azure cloud and Windows\", \"](https://dotnet.microsoft.com/download/thank-you/modernizing-existing-net-apps-ebook)\\n[Containers](\", \"https://dotnet.microsoft.com/download/thank-you/modernizing-existing-net-apps-ebook) provides guidan\", \"ce about migrating on-premises workloads into cloud. Figure 1-10 shows\\nthat there isn\\u2019t a single, on\", \"e-size-fits-all strategy for modernizing legacy applications.\\n\\n\\n19 CHAPTER 1 | Introduction to cloud\", \"-native applications\\n\\n\\n_Figure 1-10. Strategies for migrating legacy workloads_\\n\\n\\nMonolithic apps th\", \"at are non-critical might benefit from a quick **lift-and-shift** [(Cloud Infrastructure-](https://d\", \"ocs.microsoft.com/dotnet/architecture/modernize-with-azure-containers/lift-and-shift-existing-apps-a\", \"zure-iaas)\\n[Ready) migration. Here, the on-premises workload is rehosted to a cloud-based VM, withou\", \"t changes.](https://docs.microsoft.com/dotnet/architecture/modernize-with-azure-containers/lift-and-\", \"shift-existing-apps-azure-iaas)\\n[This approach uses the IaaS (Infrastructure as a Service) model. Az\", \"ure includes several tools such as](https://azure.microsoft.com/overview/what-is-iaas/)\\n[Azure Migra\", \"te,](https://azure.microsoft.com/services/azure-migrate/) [Azure Site Recovery, and Azure Database M\", \"igration Service](https://azure.microsoft.com/services/site-recovery/) to help streamline the\\nmove. \", \"While this strategy can yield some cost savings, such applications typically weren\\u2019t designed to\\nunl\", \"ock and leverage the benefits of cloud computing.\\n\\n\\nLegacy apps that are critical to the business of\", \"ten benefit from an enhanced **Cloud Optimized**\\nmigration. This approach includes deployment optimi\", \"zations that enable key cloud services - without\\n[changing the core architecture of the application.\", \" For example, you might containerize the application](https://docs.microsoft.com/virtualization/wind\", \"owscontainers/about/)\\n[and deploy it to a container orchestrator, like Azure Kubernetes Services, di\", \"scussed later in this book.](https://azure.microsoft.com/services/kubernetes-service/)\\nOnce in the c\", \"loud, the application can consume cloud backing services such as databases, message\\nqueues, monitori\", \"ng, and distributed caching.\\n\\n\\nFinally, monolithic apps that provide strategic enterprise functions \", \"might best benefit from a _Cloud-_\\n_Native_ approach, the subject of this book. This approach provid\", \"es agility and velocity. But, it comes at\\na cost of replatforming, rearchitecting, and rewriting cod\", \"e. Over time, a legacy application could be\\ndecomposed into microservices, containerized, and ultima\", \"tely _replatformed_ into a cloud-native\\narchitecture.\\n\\n\\nIf you and your team believe a cloud-native \", \"approach is appropriate, it behooves you to rationalize\\nthe decision with your organization. What ex\", \"actly is the business problem that a cloud-native\\napproach will solve? How would it align with busin\", \"ess needs?\\n\\n\\n  - Rapid releases of features with increased confidence?\\n\\n\\n  - Fine-grained scalabilit\", \"y - more efficient usage of resources?\\n\\n\\n20 CHAPTER 1 | Introduction to cloud-native applications\\n\\n\\n\", \"  - Improved system resiliency?\\n\\n\\n  - Improved system performance?\\n\\n\\n  - More visibility into operat\", \"ions?\\n\\n\\n  - Blend development platforms and data stores to arrive at the best tool for the job?\\n\\n\\n  \", \"- Future-proof application investment?\\n\\n\\nThe right migration strategy depends on organizational prio\", \"rities and the systems you\\u2019re targeting.\\nFor many, it may be more cost effective to cloud-optimize a\", \" monolithic application or add coarsegrained services to an N-Tier app. In these cases, you can stil\", \"l make full use of cloud PaaS capabilities\\nlike the ones offered by Azure App Service.\\n\\n#### **Summa\", \"ry**\\n\\n\\nIn this chapter, we introduced cloud-native computing. We provided a definition along with th\", \"e key\\ncapabilities that drive a cloud-native application. We looked at the types of applications tha\", \"t might\\njustify this investment and effort.\\n\\n\\nWith the introduction behind, we now dive into a much \", \"more detailed look at cloud native.\\n\\n\\n**References**\\n\\n\\n  - [Cloud Native Computing Foundation](https\", \"://www.cncf.io/)\\n\\n\\n  - [.NET Microservices: Architecture for Containerized .NET applications](https:\", \"//dotnet.microsoft.com/download/thank-you/microservices-architecture-ebook)\\n\\n\\n  - [Microsoft Azure W\", \"ell-Architected Framework](https://docs.microsoft.com/azure/architecture/framework/)\\n\\n\\n  - [Moderniz\", \"e existing .NET applications with Azure cloud and Windows Containers](https://dotnet.microsoft.com/d\", \"ownload/thank-you/modernizing-existing-net-apps-ebook)\\n\\n\\n  - [Cloud Native Patterns by Cornelia Davi\", \"s](https://www.manning.com/books/cloud-native-patterns)\\n\\n\\n  - [Cloud native applications: Ship faste\", \"r, reduce risk, and grow your business](https://tanzu.vmware.com/cloud-native)\\n\\n\\n  - [Dapr for .NET \", \"Developers](https://docs.microsoft.com/dotnet/architecture/dapr-for-net-developers/)\\n\\n\\n  - [Dapr doc\", \"uments](https://dapr.io/)\\n\\n\\n  - [Beyond the Twelve-Factor Application](https://content.pivotal.io/bl\", \"og/beyond-the-twelve-factor-app)\\n\\n\\n  - [What is Infrastructure as Code](https://docs.microsoft.com/d\", \"evops/deliver/what-is-infrastructure-as-code)\\n\\n\\n  - [Uber Engineering\\u2019s Micro Deploy: Deploying Dail\", \"y with Confidence](https://www.uber.com/blog/micro-deploy-code/)\\n\\n\\n  - [How Netflix Deploys Code](ht\", \"tps://www.infoq.com/news/2013/06/netflix/)\\n\\n\\n  - [Overload Control for Scaling WeChat Microservices]\", \"(https://www.cs.columbia.edu/~ruigu/papers/socc18-final100.pdf)\\n\\n\\n21 CHAPTER 1 | Introduction to clo\", \"ud-native applications\\n\\n\\n**CHAPTER**\\n# 2\\n\\n## Introducing eShopOnContainers reference app\\n\\n\\nMicrosoft\", \", in partnership with leading community experts, has produced a full-featured cloud-native\\nmicroserv\", \"ices reference application, eShopOnContainers. This application is built to showcase using\\n.NET and \", \"Docker, and optionally Azure, Kubernetes, and Visual Studio, to build an online storefront.\\n\\n\\n_Figur\", \"e 2-1. eShopOnContainers Sample App Screenshot._\\n\\n\\n22 CHAPTER 2 | Introducing eShopOnContainers refe\", \"rence app\\n\\n\\n[Before starting this chapter, we recommend that you download the eShopOnContainers refe\", \"rence](https://github.com/dotnet-architecture/eShopOnContainers)\\n[application. If you do so, it shou\", \"ld be easier for you to follow along with the information presented.](https://github.com/dotnet-arch\", \"itecture/eShopOnContainers)\\n\\n### Features and requirements\\n\\n\\nLet\\u2019s start with a review of the applic\", \"ation\\u2019s features and requirements. The eShopOnContainers\\napplication represents an online store that\", \" sells various physical products like t-shirts and coffee\\nmugs. If you\\u2019ve bought anything online bef\", \"ore, the experience of using the store should be relatively\\nfamiliar. Here are some of the basic fea\", \"tures the store implements:\\n\\n\\n  - List catalog items\\n\\n  - Filter items by type\\n\\n  - Filter items by \", \"brand\\n\\n  - Add items to the shopping basket\\n\\n  - Edit or remove items from the basket\\n\\n  - Checkout\\n\", \"\\n  - Register an account\\n\\n  - Sign in\\n\\n  - Sign out\\n\\n  - Review orders\\n\\nThe application also has the\", \" following non-functional requirements:\\n\\n\\n  - It needs to be highly available and it must scale auto\", \"matically to meet increased traffic (and\\nscale back down once traffic subsides).\\n\\n  - It should prov\", \"ide easy-to-use monitoring of its health and diagnostic logs to help\\ntroubleshoot any issues it enco\", \"unters.\\n\\n  - It should support an agile development process, including support for continuous integr\", \"ation\\nand deployment (CI/CD).\\n\\n  - In addition to the two web front ends (traditional and Single Pag\", \"e Application), the\\napplication must also support mobile client apps running different kinds of oper\", \"ating\\nsystems.\\n\\n  - It should support cross-platform hosting and cross-platform development.\\n\\n\\n23 CH\", \"APTER 2 | Introducing eShopOnContainers reference app\\n\\n\\n_Figure 2-2. eShopOnContainers reference app\", \"lication development architecture._\\n\\n\\nThe eShopOnContainers application is accessible from web or mo\", \"bile clients that access the\\napplication over HTTPS targeting either the ASP.NET Core MVC server app\", \"lication or an appropriate\\nAPI Gateway. API Gateways offer several advantages, such as decoupling ba\", \"ck-end services from\\nindividual front-end clients and providing better security. The application als\", \"o makes use of a related\\npattern known as Backends-for-Frontends (BFF), which recommends creating se\", \"parate API gateways\\nfor each front-end client. The reference architecture demonstrates breaking up t\", \"he API gateways\\nbased on whether the request is coming from a web or mobile client.\\n\\n\\nThe applicatio\", \"n\\u2019s functionality is broken up into many distinct microservices. There are services\\nresponsible for \", \"authentication and identity, listing items from the product catalog, managing users\\u2019\\nshopping basket\", \"s, and placing orders. Each of these separate services has its own persistent storage.\\nThere\\u2019s no si\", \"ngle primary data store with which all services interact. Instead, coordination and\\ncommunication be\", \"tween the services is done on an as-needed basis and by using a message bus.\\n\\n\\nEach of the different\", \" microservices is designed differently, based on their individual requirements. This\\naspect means th\", \"eir technology stack may differ, although they\\u2019re all built using .NET and designed for\\nthe cloud. S\", \"impler services provide basic Create-Read-Update-Delete (CRUD) access to the underlying\\ndata stores,\", \" while more advanced services use Domain-Driven Design approaches and patterns to\\nmanage business co\", \"mplexity.\\n\\n\\n24 CHAPTER 2 | Introducing eShopOnContainers reference app\\n\\n\\n_Figure 2-3. Different kind\", \"s of microservices._\\n\\n### Overview of the code\\n\\n\\nBecause it uses microservices, the eShopOnContainer\", \"s app includes quite a few separate projects and\\nsolutions in its GitHub repository. In addition to \", \"separate solutions and executable files, the various\\nservices are designed to run inside their own c\", \"ontainers, both during local development and at run\\ntime in production. Figure 2-4 shows the full Vi\", \"sual Studio solution, in which the various different\\nprojects are organized.\\n\\n\\n25 CHAPTER 2 | Introd\", \"ucing eShopOnContainers reference app\\n\\n\\n26 CHAPTER 2 | Introducing eShopOnContainers reference app\\n\\n\", \"\\n_Figure 2-4. Projects in Visual Studio solution._\\n\\n\\nThe code is organized to support the different \", \"microservices, and within each microservice, the code is\\nbroken up into domain logic, infrastructure\", \" concerns, and user interface or service endpoint. In many\\ncases, each service\\u2019s dependencies can be\", \" fulfilled by Azure services in production, and alternative\\noptions for local development. Let\\u2019s exa\", \"mine how the application\\u2019s requirements map to Azure\\nservices.\\n\\n### Understanding microservices\\n\\n\\nTh\", \"is book focuses on cloud-native applications built using Azure technology. To learn more about\\nmicro\", \"services best practices and how to architect microservice-based applications, read the\\n[companion bo\", \"ok, .NET Microservices: Architecture for Containerized .NET Applications.](https://dotnet.microsoft.\", \"com/download/thank-you/microservices-architecture-ebook)\\n\\n### Mapping eShopOnContainers to Azure Ser\", \"vices\\n\\n\\nAlthough not required, Azure is well-suited to supporting the eShopOnContainers because the \", \"project\\nwas built to be a cloud-native application. The application is built with .NET, so it can ru\", \"n on Linux or\\nWindows containers depending on the Docker host. The application is made up of multipl\", \"e\\nautonomous microservices, each with its own data. The different microservices showcase different\\na\", \"pproaches, ranging from simple CRUD operations to more complex DDD and CQRS patterns.\\nMicroservices \", \"communicate with clients over HTTP and with one another via message-based\\ncommunication. The applica\", \"tion supports multiple platforms for clients as well, since it adopts HTTP\\nas a standard communicati\", \"on protocol and includes ASP.NET Core and Xamarin mobile apps that run\\non Android, iOS, and Windows \", \"platforms.\\n\\n\\nThe application\\u2019s architecture is shown in Figure 2-5. On the left are the client apps,\", \" broken up into\\nmobile, traditional Web, and Web Single Page Application (SPA) flavors. On the right\", \" are the serverside components that make up the system, each of which can be hosted in Docker contai\", \"ners and\\nKubernetes clusters. The traditional web app is powered by the ASP.NET Core MVC application\", \" shown\\nin yellow. This app and the mobile and web SPA applications communicate with the individual\\nm\", \"icroservices through one or more API gateways. The API gateways follow the \\u201cbackends for front\\nends\\u201d\", \" (BFF) pattern, meaning that each gateway is designed to support a given front-end client. The\\nindiv\", \"idual microservices are listed to the right of the API gateways and include both business logic\\nand \", \"some kind of persistence store. The different services make use of SQL Server databases, Redis\\ncache\", \" instances, and MongoDB/CosmosDB stores. On the far right is the system\\u2019s Event Bus, which is\\nused f\", \"or communication between the microservices.\\n\\n\\n27 CHAPTER 2 | Introducing eShopOnContainers reference\", \" app\\n\\n\\n_Figure 2-5. The eShopOnContainers Architecture._\\n\\n\\nThe server-side components of this archit\", \"ecture all map easily to Azure services.\\n\\n#### **Container orchestration and clustering**\\n\\n\\nThe appl\", \"ication\\u2019s container-hosted services, from ASP.NET Core MVC apps to individual Catalog and\\nOrdering m\", \"icroservices, can be hosted and managed in Azure Kubernetes Service (AKS). The\\napplication can run l\", \"ocally on Docker and Kubernetes, and the same containers can then be deployed\\nto staging and product\", \"ion environments hosted in AKS. This process can be automated as we\\u2019ll see in\\nthe next section.\\n\\n\\nAK\", \"S provides management services for individual clusters of containers. The application will deploy\\nse\", \"parate containers for each microservice in the AKS cluster, as shown in the architecture diagram\\nabo\", \"ve. This approach allows each individual service to scale independently according to its resource\\nde\", \"mands. Each microservice can also be deployed independently, and ideally such deployments\\nshould inc\", \"ur zero system downtime.\\n\\n#### **API Gateway**\\n\\n\\nThe eShopOnContainers application has multiple fron\", \"t-end clients and multiple different back-end\\nservices. There\\u2019s no one-to-one correspondence between\", \" the client applications and the microservices\\nthat support them. In such a scenario, there may be a\", \" great deal of complexity when writing client\\nsoftware to interface with the various back-end servic\", \"es in a secure manner. Each client would need to\\naddress this complexity on its own, resulting in du\", \"plication and many places in which to make updates\\nas services change or new policies are implemente\", \"d.\\n\\n\\nAzure API Management (APIM) helps organizations publish APIs in a consistent, manageable fashio\", \"n.\\nAPIM consists of three components: the API Gateway, and administration portal (the Azure portal),\", \"\\nand a developer portal.\\n\\n\\n28 CHAPTER 2 | Introducing eShopOnContainers reference app\\n\\n\\nThe API Gate\", \"way accepts API calls and routes them to the appropriate back-end API. It can also\\nprovide additiona\", \"l services like verification of API keys or JWT tokens and API transformation on the\\nfly without cod\", \"e modifications (for instance, to accommodate clients expecting an older interface).\\n\\n\\nThe Azure por\", \"tal is where you define the API schema and package different APIs into products. You\\nalso configure \", \"user access, view reports, and configure policies for quotas or transformations.\\n\\n\\nThe developer por\", \"tal serves as the main resource for developers. It provides developers with API\\ndocumentation, an in\", \"teractive test console, and reports on their own usage. Developers also use the\\nportal to create and\", \" manage their own accounts, including subscription and API key support.\\n\\n\\nUsing APIM, applications c\", \"an expose several different groups of services, each providing a back end\\nfor a particular front-end\", \" client. APIM is recommended for complex scenarios. For simpler needs, the\\nlightweight API Gateway O\", \"celot can be used. The eShopOnContainers app uses Ocelot because of its\\nsimplicity and because it ca\", \"n be deployed into the same application environment as the application\\n[itself. Learn more about eSh\", \"opOnContainers, APIM, and Ocelot.](https://docs.microsoft.com/dotnet/architecture/microservices/arch\", \"itect-microservice-container-applications/direct-client-to-microservice-communication-versus-the-api\", \"-gateway-pattern#azure-api-management)\\n\\n\\nAnother option if your application is using AKS is to deplo\", \"y the Azure Gateway Ingress Controller as a\\npod within your AKS cluster. This approach allows your c\", \"luster to integrate with an Azure Application\\n[Gateway, allowing the gateway to load-balance traffic\", \" to the AKS pods. Learn more about the Azure](https://github.com/Azure/application-gateway-kubernete\", \"s-ingress)\\n[Gateway Ingress Controller for AKS.](https://github.com/Azure/application-gateway-kubern\", \"etes-ingress)\\n\\n#### **Data**\\n\\n\\nThe various back-end services used by eShopOnContainers have differen\", \"t storage requirements.\\nSeveral microservices use SQL Server databases. The Basket microservice leve\", \"rages a Redis cache for\\nits persistence. The Locations microservice expects a MongoDB API for its da\", \"ta. Azure supports each\\nof these data formats.\\n\\n\\nFor SQL Server database support, Azure has products\", \" for everything from single databases up to\\nhighly scalable SQL Database elastic pools. Individual m\", \"icroservices can be configured to\\ncommunicate with their own individual SQL Server databases quickly\", \" and easily. These databases can\\nbe scaled as needed to support each separate microservice according\", \" to its needs.\\n\\n\\nThe eShopOnContainers application stores the user\\u2019s current shopping basket between\", \" requests. This\\naspect is managed by the Basket microservice that stores the data in a Redis cache. \", \"In development,\\nthis cache can be deployed in a container, while in production it can utilize Azure \", \"Cache for Redis.\\nAzure Cache for Redis is a fully managed service offering high performance and reli\", \"ability without the\\nneed to deploy and manage Redis instances or containers on your own.\\n\\n\\nThe Locat\", \"ions microservice uses a MongoDB NoSQL database for its persistence. During\\ndevelopment, the databas\", \"e can be deployed in its own container, while in production the service can\\n[leverage Azure Cosmos D\", \"B\\u2019s API for MongoDB. One of the benefits of Azure Cosmos DB is its ability](https://docs.microsoft.c\", \"om/azure/cosmos-db/mongodb-introduction)\\nto leverage multiple different communication protocols, inc\", \"luding a SQL API and common NoSQL\\nAPIs including MongoDB, Cassandra, Gremlin, and Azure Table Storag\", \"e. Azure Cosmos DB offers a\\nfully managed and globally distributed database as a service that can sc\", \"ale to meet the needs of the\\nservices that use it.\\n\\n\\nDistributed data in cloud-native applications i\", \"s covered in more detail in chapter 5.\\n\\n\\n29 CHAPTER 2 | Introducing eShopOnContainers reference app\\n\", \"\\n\\n#### **Event Bus**\\n\\nThe application uses events to communicate changes between different services.\", \" This functionality can\\nbe implemented with various implementations, and locally the eShopOnContaine\", \"rs application uses\\n[RabbitMQ. When hosted in Azure, the application would leverage Azure Service Bu\", \"s for its messaging.](https://www.rabbitmq.com/)\\nAzure Service Bus is a fully managed integration me\", \"ssage broker that allows applications and services\\nto communicate with one another in a decoupled, r\", \"eliable, asynchronous manner. Azure Service Bus\\nsupports individual queues as well as separate _topi\", \"cs_ to support publisher-subscriber scenarios. The\\neShopOnContainers application would leverage topi\", \"cs with Azure Service Bus to support distributing\\nmessages from one microservice to any other micros\", \"ervice that needed to react to a given message.\\n\\n#### **Resiliency**\\n\\n\\nOnce deployed to production, \", \"the eShopOnContainers application would be able to take advantage\\nof several Azure services availabl\", \"e to improve its resiliency. The application publishes health checks,\\nwhich can be integrated with A\", \"pplication Insights to provide reporting and alerts based on the app\\u2019s\\navailability. Azure resources\", \" also provide diagnostic logs that can be used to identify and correct bugs\\nand performance issues. \", \"Resource logs provide detailed information on when and how different Azure\\nresources are used by the\", \" application. You\\u2019ll learn more about cloud-native resiliency features in\\nchapter 6.\\n\\n### Deploying \", \"eShopOnContainers to Azure\\n\\n\\nThe eShopOnContainers application can be deployed to various Azure plat\", \"forms. The recommended\\napproach is to deploy the application to Azure Kubernetes Services (AKS). Hel\", \"m, a Kubernetes\\ndeployment tool, is available to reduce deployment complexity. Optionally, developer\", \"s may\\nimplement Azure Dev Spaces for Kubernetes to streamline their development process.\\n\\n#### **Azu\", \"re Kubernetes Service**\\n\\n\\nTo host eShop in AKS, the first step is to create an AKS cluster. To do so\", \", you might use the Azure\\nportal, which will walk you through the required steps. You could also cre\", \"ate a cluster from the Azure\\nCLI, taking care to enable Role-Based Access Control (RBAC) and applica\", \"tion routing. The\\neShopOnContainers\\u2019 documentation details the steps for creating your own AKS clust\", \"er. Once created,\\nyou can access and manage the cluster from the Kubernetes dashboard.\\n\\n\\nYou can now\", \" deploy the eShop application to the cluster using Helm.\\n\\n#### **Deploying to Azure Kubernetes Servi\", \"ce using Helm**\\n\\n\\nHelm is an application package manager tool that works directly with Kubernetes. I\", \"t helps you define,\\ninstall, and upgrade Kubernetes applications. While simple apps can be deployed \", \"to AKS with custom\\nCLI scripts or simple deployment files, complex apps can contain many Kubernetes \", \"objects and benefit\\nfrom Helm.\\n\\n\\nUsing Helm, applications include text-based configuration files, ca\", \"lled Helm charts, which declaratively\\ndescribe the application and configuration in Helm packages. C\", \"harts use standard YAML-formatted\\n\\n\\n30 CHAPTER 2 | Introducing eShopOnContainers reference app\\n\\n\\nfil\", \"es to describe a related set of Kubernetes resources. They\\u2019re versioned alongside the application\\nco\", \"de they describe. Helm Charts range from simple to complex depending on the requirements of the\\ninst\", \"allation they describe.\\n\\n\\nHelm is composed of a command-line client tool, which consumes helm charts\", \" and launches\\ncommands to a server component named, Tiller. Tiller communicates with the Kubernetes \", \"API to\\nensure the correct provisioning of your containerized workloads. Helm is maintained by the Cl\", \"oudnative Computing Foundation.\\n\\n\\nThe following yaml file presents a Helm template:\\n\\n\\nNote how the t\", \"emplate describes a dynamic set of key/value pairs. When the template is invoked,\\nvalues that enclos\", \"ed in curly braces are pulled in from other yaml-based configuration files.\\n\\n\\nYou\\u2019ll find the eShopO\", \"nContainers helm charts in the /k8s/helm folder. Figure 2-6 shows how the\\ndifferent components of th\", \"e application are organized into a folder structure used by helm to define\\nand managed deployments.\\n\", \"\\n\\n31 CHAPTER 2 | Introducing eShopOnContainers reference app\\n\\n\\n_Figure 2-6. The eShopOnContainers he\", \"lm folder._\\n\\n\\nEach individual component is installed using a helm install command. eShop includes a \", \"\\u201cdeploy all\\u201d\\nscript that loops through and installs the components using their respective helm chart\", \"s. The result is\\na repeatable process, versioned with the application in source control, that anyone\", \" on the team can\\ndeploy to an AKS cluster with a one-line script command.\\n\\n\\nNote that version 3 of H\", \"elm officially removes the need for the Tiller server component. More\\n[information on this enhanceme\", \"nt can be found here.](https://medium.com/better-programming/why-is-tiller-missing-in-helm-3-2347c44\", \"6714)\\n\\n#### **Azure Functions and Logic Apps (Serverless)**\\n\\n\\nThe eShopOnContainers sample includes \", \"support for tracking online marketing campaigns. An Azure\\nFunction is used to track marketing campai\", \"gn details for a given campaign ID. Rather than creating a\\n\\n\\n32 CHAPTER 2 | Introducing eShopOnConta\", \"iners reference app\\n\\n\\nfull microservice, a single Azure Function is simpler and sufficient. Azure Fu\", \"nctions have a simple build\\nand deployment model, especially when configured to run in Kubernetes. D\", \"eploying the function is\\nscripted using Azure Resource Manager (ARM) templates and the Azure CLI. Th\", \"is campaign service\\nisn\\u2019t customer-facing and invokes a single operation, making it a great candidat\", \"e for Azure Functions.\\nThe function requires minimal configuration, including a database connection \", \"string data and image\\nbase URI settings. You configure Azure Functions in the Azure portal.\\n\\n### Cen\", \"tralized configuration\\n\\n\\nUnlike a monolithic app in which everything runs within a single instance, \", \"a cloud-native application\\nconsists of independent services distributed across virtual machines, con\", \"tainers, and geographic\\nregions. Managing configuration settings for dozens of interdependent servic\", \"es can be challenging.\\nDuplicate copies of configuration settings across different locations are err\", \"or prone and difficult to\\nmanage. Centralized configuration is a critical requirement for distribute\", \"d cloud-native applications.\\n\\n\\nAs discussed in Chapter 1, the Twelve-Factor App recommendations requ\", \"ire strict separation between\\ncode and configuration. Configuration must be stored externally from t\", \"he application and read-in as\\nneeded. Storing configuration values as constants or literal values in\", \" code is a violation. The same\\nconfiguration values are often be used by many services in the same a\", \"pplication. Additionally, we\\nmust support the same values across multiple environments, such as dev,\", \" testing, and production. The\\nbest practice is store them in a centralized configuration store.\\n\\n\\nTh\", \"e Azure cloud presents several great options.\\n\\n#### **Azure App Configuration**\\n\\n\\n[Azure App Configu\", \"ration](https://docs.microsoft.com/azure/azure-app-configuration/overview) is a fully managed Azure \", \"service that stores non-secret configuration\\nsettings in a secure, centralized location. Stored valu\", \"es can be shared among multiple services and\\napplications.\\n\\n\\nThe service is simple to use and provid\", \"es several benefits:\\n\\n\\n  - Flexible key/value representations and mappings\\n\\n  - Tagging with Azure l\", \"abels\\n\\n  - Dedicated UI for management\\n\\n  - Encryption of sensitive information\\n\\n  - Querying and ba\", \"tch retrieval\\n\\n\\nAzure App Configuration maintains changes made to key-value settings for seven days.\", \" The point-intime snapshot feature enables you to reconstruct the history of a setting and even roll\", \"back for a failed\\ndeployment.\\n\\n\\nApp Configuration automatically caches each setting to avoid excessi\", \"ve calls to the configuration\\nstore. The refresh operation waits until the cached value of a setting\", \" expires to update that setting,\\neven when its value changes in the configuration store. The default\", \" cache expiration time is 30\\nseconds. You can override the expiration time.\\n\\n\\n33 CHAPTER 2 | Introdu\", \"cing eShopOnContainers reference app\\n\\n\\nApp Configuration encrypts all configuration values in transi\", \"t and at rest. Key names and labels are\\nused as indexes for retrieving configuration data and aren\\u2019t\", \" encrypted.\\n\\n\\nAlthough App Configuration provides hardened security, Azure Key Vault is still the be\", \"st place for\\nstoring application secrets. Key Vault provides hardware-level encryption, granular acc\", \"ess policies, and\\nmanagement operations such as certificate rotation. You can create App Configurati\", \"on values that\\nreference secrets stored in a Key Vault.\\n\\n#### **Azure Key Vault**\\n\\n\\nKey Vault is a m\", \"anaged service for securely storing and accessing secrets. A secret is anything that you\\nwant to tig\", \"htly control access to, such as API keys, passwords, or certificates. A vault is a logical group\\nof \", \"secrets.\\n\\n\\nKey Vault greatly reduces the chances that secrets may be accidentally leaked. When using\", \" Key Vault,\\napplication developers no longer need to store security information in their application\", \". This practice\\neliminates the need to store this information inside your code. For example, an appl\", \"ication may need\\nto connect to a database. Instead of storing the connection string in the app\\u2019s cod\", \"e, you can store it\\nsecurely in Key Vault.\\n\\n\\nYour applications can securely access the information t\", \"hey need by using URIs. These URIs allow the\\napplications to retrieve specific versions of a secret.\", \" There\\u2019s no need to write custom code to protect\\nany of the secret information stored in Key Vault.\\n\", \"\\n\\nAccess to Key Vault requires proper caller authentication and authorization. Typically, each cloud\", \"native microservice uses a ClientId/ClientSecret combination. It\\u2019s important to keep these credentia\", \"ls\\noutside source control. A best practice is to set them in the application\\u2019s environment. Direct a\", \"ccess to\\n[Key Vault from AKS can be achieved using Key Vault FlexVolume.](https://github.com/Azure/k\", \"ubernetes-keyvault-flexvol)\\n\\n#### **Configuration in eShop**\\n\\n\\nThe eShopOnContainers application inc\", \"ludes local application settings files with each microservice.\\nThese files are checked into source c\", \"ontrol, but don\\u2019t include production secrets such as connection\\nstrings or API keys. In production, \", \"individual settings may be overwritten with per-service environment\\nvariables. Injecting secrets in \", \"environment variables is a common practice for hosted applications, but\\ndoesn\\u2019t provide a central co\", \"nfiguration store. To support centralized management of configuration\\nsettings, each microservice in\", \"cludes a setting to toggle between its use of local settings or Azure Key\\nVault settings.\\n\\n#### **Re\", \"ferences**\\n\\n\\n  - [The eShopOnContainers Architecture](https://github.com/dotnet-architecture/eShopOn\", \"Containers/wiki/Architecture)\\n\\n  - [Orchestrating microservices and multi-container applications for\", \" high scalability and](https://docs.microsoft.com/dotnet/architecture/microservices/architect-micros\", \"ervice-container-applications/scalable-available-multi-container-microservice-applications)\\n[availab\", \"ility](https://docs.microsoft.com/dotnet/architecture/microservices/architect-microservice-container\", \"-applications/scalable-available-multi-container-microservice-applications)\\n\\n  - [Azure API Manageme\", \"nt](https://docs.microsoft.com/azure/api-management/api-management-key-concepts)\\n\\n  - [Azure SQL Dat\", \"abase Overview](https://docs.microsoft.com/azure/sql-database/sql-database-technical-overview)\\n\\n  - \", \"[Azure Cache for Redis](https://azure.microsoft.com/services/cache/)\\n\\n  - [Azure Cosmos DB\\u2019s API for\", \" MongoDB](https://docs.microsoft.com/azure/cosmos-db/mongodb-introduction)\\n\\n\\n34 CHAPTER 2 | Introduc\", \"ing eShopOnContainers reference app\\n\\n\\n  - [Azure Service Bus](https://docs.microsoft.com/azure/servi\", \"ce-bus-messaging/service-bus-messaging-overview)\\n\\n  - [Azure Monitor overview](https://docs.microsof\", \"t.com/azure/azure-monitor/overview)\\n\\n  - [eShopOnContainers: Create Kubernetes cluster in AKS](https\", \"://github.com/dotnet-architecture/eShopOnContainers/wiki/Deploy-to-Azure-Kubernetes-Service-(AKS)#cr\", \"eate-kubernetes-cluster-in-aks)\\n\\n  - [eShopOnContainers: Azure Dev Spaces](https://github.com/dotnet\", \"-architecture/eShopOnContainers/wiki/Azure-Dev-Spaces)\\n\\n  - [Azure Dev Spaces](https://docs.microsof\", \"t.com/azure/dev-spaces/about)\\n\\n\\n35 CHAPTER 2 | Introducing eShopOnContainers reference app\\n\\n\\n**CHAPT\", \"ER**\\n# 3\\n\\n## Scaling cloud-native applications\\n\\n\\nOne of the most-often touted advantages of moving t\", \"o a cloud hosting environment is scalability.\\nScalability, or the ability for an application to acce\", \"pt additional user load without compromising\\nperformance for each user. It\\u2019s most often achieved by \", \"breaking up an application into small pieces\\nthat can each be given whatever resources they require.\", \" Cloud vendors enable massive scalability\\nanytime and anywhere in the world.\\n\\n\\nIn this chapter, we d\", \"iscuss technologies that enable cloud-native applications to scale to meet user\\ndemand. These techno\", \"logies include:\\n\\n\\n  - Containers\\n\\n  - Orchestrators\\n\\n  - Serverless computing\\n\\n### Leveraging contai\", \"ners and orchestrators\\n\\n\\nContainers and orchestrators are designed to solve problems common to monol\", \"ithic deployment\\napproaches.\\n\\n#### **Challenges with monolithic deployments**\\n\\n\\nTraditionally, most \", \"applications have been deployed as a single unit. Such applications are referred to\\nas a monolith. T\", \"his general approach of deploying applications as single units even if they\\u2019re\\ncomposed of multiple \", \"modules or assemblies is known as monolithic architecture, as shown in Figure\\n3-1.\\n\\n\\n36 CHAPTER 3 | \", \"Scaling cloud-native applications\\n\\n\\n_Figure 3-1. Monolithic architecture._\\n\\n\\nAlthough they have the \", \"benefit of simplicity, monolithic architectures face many challenges:\\n\\n\\n**Deployment**\\n\\n\\nAdditionall\", \"y, they require a restart of the application, which may temporarily impact availability if\\nzero-down\", \"time techniques are not applied while deploying.\\n\\n\\n**Scaling**\\n\\n\\nA monolithic application is hosted \", \"entirely on a single machine instance, often requiring highcapability hardware. If any part of the m\", \"onolith requires scaling, another copy of the entire application\\nmust be deployed to another machine\", \". With a monolith, you can\\u2019t scale application components\\nindividually - it\\u2019s all or nothing. Scalin\", \"g components that don\\u2019t require scaling results in inefficient and\\ncostly resource usage.\\n\\n\\n**Enviro\", \"nment**\\n\\n\\nMonolithic applications are typically deployed to a hosting environment with a pre-install\", \"ed operating\\nsystem, runtime, and library dependencies. This environment may not match that upon whi\", \"ch the\\napplication was developed or tested. Inconsistencies across application environments are a co\", \"mmon\\nsource of problems for monolithic deployments.\\n\\n\\n**Coupling**\\n\\n\\nA monolithic application is lik\", \"ely to experience high coupling across its functional components.\\nWithout hard boundaries, system ch\", \"anges often result in unintended and costly side effects. New\\nfeatures/fixes become tricky, time-con\", \"suming, and expensive to implement. Updates require extensive\\ntesting. Coupling also makes it diffic\", \"ult to refactor components or swap in alternative\\nimplementations. Even when constructed with a stri\", \"ct separation of concerns, architectural erosion\\nsets in as the monolithic code base deteriorates wi\", \"th never-ending \\u201cspecial cases.\\u201d\\n\\n\\n37 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\n**Platform loc\", \"k-in**\\n\\n\\nA monolithic application is constructed with a single technology stack. While offering unif\", \"ormity, this\\ncommitment can become a barrier to innovation. New features and components will be buil\", \"t using\\nthe application\\u2019s current stack - even when more modern technologies may be a better choice.\", \" A\\nlonger-term risk is your technology stack becoming outdated and obsolete. Rearchitecting an entir\", \"e\\napplication to a new, more modern platform is at best expensive and risky.\\n\\n#### **What are the be\", \"nefits of containers and orchestrators?**\\n\\n\\nWe introduced containers in Chapter 1. We highlighted ho\", \"w the Cloud Native Computing Foundation\\n[(CNCF) ranks containerization as the first step in their Cl\", \"oud-Native Trail Map](https://raw.githubusercontent.com/cncf/trailmap/master/CNCF_TrailMap_latest.pn\", \"g) - guidance for\\nenterprises beginning their cloud-native journey. In this section, we discuss the \", \"benefits of containers.\\n\\n\\nDocker is the most popular container management platform. It works with co\", \"ntainers on both Linux or\\nWindows. Containers provide separate but reproducible application environm\", \"ents that run the same\\nway on any system. This aspect makes them perfect for developing and hosting \", \"cloud-native services.\\nContainers are isolated from one another. Two containers on the same host har\", \"dware can have\\ndifferent versions of software, without causing conflicts.\\n\\n\\nContainers are defined b\", \"y simple text-based files that become project artifacts and are checked into\\nsource control. While f\", \"ull servers and virtual machines require manual effort to update, containers are\\neasily version-cont\", \"rolled. Apps built to run in containers can be developed, tested, and deployed\\nusing automated tools\", \" as part of a build pipeline.\\n\\n\\nContainers are immutable. Once you define a container, you can recre\", \"ate and run it exactly the same\\nway. This immutability lends itself to component-based design. If so\", \"me parts of an application evolve\\ndifferently than others, why redeploy the entire app when you can \", \"just deploy the parts that change\\nmost frequently? Different features and cross-cutting concerns of \", \"an app can be broken up into\\nseparate units. Figure 3-2 shows how a monolithic app can take advantag\", \"e of containers and\\nmicroservices by delegating certain features or functionality. The remaining fun\", \"ctionality in the app\\nitself has also been containerized.\\n\\n\\n38 CHAPTER 3 | Scaling cloud-native appl\", \"ications\\n\\n\\n_Figure 3-2. Decomposing a monolithic app to embrace microservices._\\n\\n\\nEach cloud-native \", \"service is built and deployed in a separate container. Each can update as needed.\\nIndividual service\", \"s can be hosted on nodes with resources appropriate to each service. The\\nenvironment each service ru\", \"ns in is immutable, shared across dev, test, and production environments,\\nand easily versioned. Coup\", \"ling between different areas of the application occurs explicitly as calls or\\nmessages between servi\", \"ces, not compile-time dependencies within the monolith. You can also choose\\nthe technology that best\", \" suites a given capability without requiring changes to the rest of the app.\\n\\n\\nContainerized service\", \"s require automated management. It wouldn\\u2019t be feasible to manually administer\\na large set of indepe\", \"ndently deployed containers. For example, consider the following tasks:\\n\\n\\n  - How will container ins\", \"tances be provisioned across a cluster of many machines?\\n\\n  - Once deployed, how will containers dis\", \"cover and communicate with each other?\\n\\n  - How can containers scale in or out on-demand?\\n\\n  - How d\", \"o you monitor the health of each container?\\n\\n  - How do you protect a container against hardware and\", \" software failures?\\n\\n  - How do upgrade containers for a live application with zero downtime?\\n\\n\\nCont\", \"ainer orchestrators address and automate these and other concerns.\\n\\n\\nIn the cloud-native eco-system,\", \" Kubernetes has become the de facto container orchestrator. It\\u2019s an\\nopen-source platform managed by \", \"the Cloud Native Computing Foundation (CNCF). Kubernetes\\nautomates the deployment, scaling, and oper\", \"ational concerns of containerized workloads across a\\nmachine cluster. However, installing and managi\", \"ng Kubernetes is notoriously complex.\\n\\n\\n39 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\nA much be\", \"tter approach is to leverage Kubernetes as a managed service from a cloud vendor. The\\n[Azure cloud f\", \"eatures a fully managed Kubernetes platform entitled Azure Kubernetes Service (AKS).](https://azure.\", \"microsoft.com/services/kubernetes-service/)\\nAKS abstracts the complexity and operational overhead of\", \" managing Kubernetes. You consume\\nKubernetes as a cloud service; Microsoft takes responsibility for \", \"managing and supporting it. AKS also\\ntightly integrates with other Azure services and dev tools.\\n\\n\\nA\", \"KS is a cluster-based technology. A pool of federated virtual machines, or nodes, is deployed to the\", \"\\nAzure cloud. Together they form a highly available environment, or cluster. The cluster appears as \", \"a\\nseamless, single entity to your cloud-native application. Under the hood, AKS deploys your\\ncontain\", \"erized services across these nodes following a predefined strategy that evenly distributes the\\nload.\", \"\\n\\n#### **What are the scaling benefits?**\\n\\n\\nServices built on containers can leverage scaling benefi\", \"ts provided by orchestration tools like\\nKubernetes. By design containers only know about themselves.\", \" Once you have multiple containers\\nthat need to work together, you should organize them at a higher \", \"level. Organizing large numbers of\\ncontainers and their shared dependencies, such as network configu\", \"ration, is where orchestration tools\\ncome in to save the day! Kubernetes creates an abstraction laye\", \"r over groups of containers and\\norganizes them into _pods_ . Pods run on worker machines referred to\", \" as _nodes_ . This organized structure\\nis referred to as a _cluster_ . Figure 3-3 shows the differen\", \"t components of a Kubernetes cluster.\\n\\n\\n_Figure 3-3. Kubernetes cluster components._\\n\\n\\nScaling conta\", \"inerized workloads is a key feature of container orchestrators. AKS supports automatic\\nscaling acros\", \"s two dimensions: Container instances and compute nodes. Together they give AKS the\\nability to quick\", \"ly and efficiently respond to spikes in demand and add additional resources. We\\ndiscuss scaling in A\", \"KS later in this chapter.\\n\\n\\n40 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\n**Declarative versus \", \"imperative**\\n\\n\\nKubernetes supports both declarative and imperative configuration. The imperative app\", \"roach involves\\nrunning various commands that tell Kubernetes what to do each step of the way. Run th\", \"is image.\\nDelete this pod. Expose this port. With the declarative approach, you create a configurati\", \"on file, called\\na manifest, to describe what you want instead of what to do. Kubernetes reads the ma\", \"nifest and\\ntransforms your desired end state into actual end state.\\n\\n\\nImperative commands are great \", \"for learning and interactive experimentation. However, you\\u2019ll want to\\ndeclaratively create Kubernete\", \"s manifest files to embrace an infrastructure as code approach,\\nproviding for reliable and repeatabl\", \"e deployments. The manifest file becomes a project artifact and is\\nused in your CI/CD pipeline for a\", \"utomating Kubernetes deployments.\\n\\n\\nIf you\\u2019ve already configured your cluster using imperative comma\", \"nds, you can export a declarative\\nmanifest by using kubectl get svc SERVICENAME -o yaml > service.ya\", \"ml. This command produces a\\nmanifest similar to one shown below:\\n\\n\\nWhen using declarative configurat\", \"ion, you can preview the changes that will be made before\\ncommitting them by using kubectl diff -f F\", \"OLDERNAME against the folder where your configuration\\nfiles are located. Once you\\u2019re sure you want t\", \"o apply the changes, run kubectl apply -f FOLDERNAME.\\nAdd -R to recursively process a folder hierarc\", \"hy.\\n\\n\\nYou can also use declarative configuration with other Kubernetes features, one of which being\\n\", \"deployments. Declarative deployments help manage releases, updates, and scaling. They instruct the\\nK\", \"ubernetes deployment controller on how to deploy new changes, scale out load, or roll back to a\\nprev\", \"ious revision. If a cluster is unstable, a declarative deployment will automatically return the clus\", \"ter\\nback to a desired state. For example, if a node should crash, the deployment mechanism will rede\", \"ploy\\na replacement to achieve your desired state\\n\\n\\n41 CHAPTER 3 | Scaling cloud-native applications\\n\", \"\\n\\nUsing declarative configuration allows infrastructure to be represented as code that can be checke\", \"d in\\nand versioned alongside the application code. It provides improved change control and better\\nsu\", \"pport for continuous deployment using a build and deploy pipeline.\\n\\n#### **What scenarios are ideal \", \"for containers and orchestrators?**\\n\\n\\nThe following scenarios are ideal for using containers and orc\", \"hestrators.\\n\\n\\n**Applications requiring high uptime and scalability**\\n\\n\\nIndividual applications that \", \"have high uptime and scalability requirements are ideal candidates for\\ncloud-native architectures us\", \"ing microservices, containers, and orchestrators. They can be developed\\nin containers, tested across\", \" versioned environments, and deployed into production with zero\\ndowntime. The use of Kubernetes clus\", \"ters ensures such apps can also scale on demand and recover\\nautomatically from node failures.\\n\\n\\n**La\", \"rge numbers of applications**\\n\\n\\nOrganizations that deploy and maintain large numbers of applications\", \" benefit from containers and\\norchestrators. The up front effort of setting up containerized environm\", \"ents and Kubernetes clusters is\\nprimarily a fixed cost. Deploying, maintaining, and updating individ\", \"ual applications has a cost that\\nvaries with the number of applications. Beyond a few applications, \", \"the complexity of maintaining\\ncustom applications manually exceeds the cost of implementing a soluti\", \"on using containers and\\norchestrators.\\n\\n#### **When should you avoid using containers and orchestrat\", \"ors?**\\n\\n\\nIf you\\u2019re unable to build your application following the Twelve-Factor App principles, you \", \"should\\nconsider avoiding containers and orchestrators. In these cases, consider a VM-based hosting p\", \"latform,\\nor possibly some hybrid system. With it, you can always spin off certain pieces of function\", \"ality into\\nseparate containers or even serverless functions.\\n\\n#### **Development resources**\\n\\n\\nThis \", \"section shows a short list of development resources that may help you get started using\\ncontainers a\", \"nd orchestrators for your next application. If you\\u2019re looking for guidance on how to\\ndesign your clo\", \"ud-native microservices architecture app, read this book\\u2019s companion, .NET\\n[Microservices: Architect\", \"ure for Containerized .NET Applications.](https://dotnet.microsoft.com/download/thank-you/microservi\", \"ces-architecture-ebook)\\n\\n\\n**Local Kubernetes Development**\\n\\n\\nKubernetes deployments provide great va\", \"lue in production environments, but can also run locally on\\nyour development machine. While you may \", \"work on individual microservices independently, there\\nmay be times when you\\u2019ll need to run the entir\", \"e system locally - just as it will run when deployed to\\nproduction. There are several tools that can\", \" help: Minikube and Docker Desktop. Visual Studio also\\nprovides tooling for Docker development.\\n\\n\\n42\", \" CHAPTER 3 | Scaling cloud-native applications\\n\\n\\n**Minikube**\\n\\n\\nWhat is Minikube? The Minikube proje\", \"ct says \\u201cMinikube implements a local Kubernetes cluster on\\nmacOS, Linux, and Windows.\\u201d Its primary g\", \"oals are \\u201cto be the best tool for local Kubernetes\\napplication development and to support all Kubern\", \"etes features that fit.\\u201d Installing Minikube is\\nseparate from Docker, but Minikube supports differen\", \"t hypervisors than Docker Desktop supports.\\nThe following Kubernetes features are currently supporte\", \"d by Minikube:\\n\\n\\n  - DNS\\n\\n  - NodePorts\\n\\n  - ConfigMaps and secrets\\n\\n  - Dashboards\\n\\n  - Container r\", \"untimes: Docker, rkt, CRI-O, and containerd\\n\\n  - Enabling Container Network Interface (CNI)\\n\\n  - Ing\", \"ress\\n\\n\\nAfter installing Minikube, you can quickly start using it by running the minikube start comma\", \"nd, which\\ndownloads an image and start the local Kubernetes cluster. Once the cluster is started, yo\", \"u interact\\nwith it using the standard Kubernetes kubectl commands.\\n\\n\\n**Docker Desktop**\\n\\n\\nYou can al\", \"so work with Kubernetes directly from Docker Desktop on Windows. It is your only option if\\nyou\\u2019re us\", \"ing Windows Containers, and is a great choice for non-Windows containers as well. Figure 34 shows ho\", \"w to enable local Kubernetes support when running Docker Desktop.\\n\\n\\n_Figure 3-4. Configuring Kuberne\", \"tes in Docker Desktop._\\n\\n\\n43 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\nDocker Desktop is the m\", \"ost popular tool for configuring and running containerized apps locally.\\nWhen you work with Docker D\", \"esktop, you can develop locally against the exact same set of Docker\\ncontainer images that you\\u2019ll de\", \"ploy to production. Docker Desktop is designed to \\u201cbuild, test, and\\nship\\u201d containerized apps locally\", \". It supports both Linux and Windows containers. Once you push your\\nimages to an image registry, lik\", \"e Azure Container Registry or Docker Hub, AKS can pull and deploy\\nthem to production.\\n\\n\\n**Visual Stu\", \"dio Docker Tooling**\\n\\n\\nVisual Studio supports Docker development for web-based applications. When yo\", \"u create a new\\nASP.NET Core application, you have an option to configure it with Docker support, as \", \"shown in Figure\\n3-5.\\n\\n\\n_Figure 3-5. Visual Studio Enable Docker Support_\\n\\n\\nWhen this option is selec\", \"ted, the project is created with a Dockerfile in its root, which can be used to\\nbuild and host the a\", \"pp in a Docker container. An example Dockerfile is shown in Figure 3-6.\\n\\n\\n44 CHAPTER 3 | Scaling clo\", \"ud-native applications\\n\\n\\n_Figure 3-6. Visual Studio generated Dockerfile_\\n\\n\\nOnce support is added, y\", \"ou can run your application in a Docker container in Visual Studio. Figure 3-7\\nshows the different r\", \"un options available from a new ASP.NET Core project created with Docker\\nsupport added.\\n\\n\\n_Figure 3-\", \"7. Visual Studio Docker Run Options_\\n\\n\\nAlso, at any time you can add Docker support to an existing A\", \"SP.NET Core application. From the\\nVisual Studio Solution Explorer, right-click on the project and se\", \"lect **Add** - **Docker Support**, as shown\\nin Figure 3-8.\\n\\n\\n45 CHAPTER 3 | Scaling cloud-native app\", \"lications\\n\\n\\n_Figure 3-8. Adding Docker support to Visual Studio_\\n\\n\\n**Visual Studio Code Docker Tooli\", \"ng**\\n\\n\\nThere are many extensions available for Visual Studio Code that support Docker development.\\n\\n\", \"\\n[Microsoft provides the Docker for Visual Studio Code extension. This extension simplifies the proc\", \"ess](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker)\\nof adding cont\", \"ainer support to applications. It scaffolds required files, builds Docker images, and\\nenables you to\", \" debug your app inside a container. The extension features a visual explorer that makes\\nit easy to t\", \"ake actions on containers and images such as start, stop, inspect, remove, and more. The\\nextension a\", \"lso supports Docker Compose enabling you to manage multiple running containers as a\\nsingle unit.\\n\\n##\", \"# Leveraging serverless functions\\n\\n\\nIn the spectrum from managing physical machines to leveraging cl\", \"oud capabilities, serverless lives at\\nthe extreme end. Your only responsibility is your code, and yo\", \"u only pay when your code runs. Azure\\nFunctions provides a way to build serverless capabilities into\", \" your cloud-native applications.\\n\\n\\n46 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\n#### **What is\", \" serverless?**\\n\\nServerless is a relatively new service model of cloud computing. It doesn\\u2019t mean tha\", \"t servers are\\noptional - your code still runs on a server somewhere. The distinction is that the app\", \"lication team no\\nlonger concerns itself with managing server infrastructure. Instead, the cloud vend\", \"or own this\\nresponsibility. The development team increases its productivity by delivering business s\", \"olutions to\\ncustomers, not plumbing.\\n\\n\\nServerless computing uses event-triggered stateless container\", \"s to host your services. They can scale\\nout and in to meet demand as-needed. Serverless platforms li\", \"ke Azure Functions have tight\\nintegration with other Azure services like queues, events, and storage\", \".\\n\\n#### **What challenges are solved by serverless?**\\n\\n\\nServerless platforms address many time-consu\", \"ming and expensive concerns:\\n\\n\\n  - Purchasing machines and software licenses\\n\\n  - Housing, securing,\", \" configuring, and maintaining the machines and their networking, power,\\nand A/C requirements\\n\\n  - Pa\", \"tching and upgrading operating systems and software\\n\\n  - Configuring web servers or machine services\", \" to host application software\\n\\n  - Configuring application software within its platform\\n\\n\\nMany compa\", \"nies allocate large budgets to support hardware infrastructure concerns. Moving to the\\ncloud can hel\", \"p reduce these costs; shifting applications to serverless can help eliminate them.\\n\\n#### **What is t\", \"he difference between a microservice and a serverless** **function?**\\n\\n\\nTypically, a microservice en\", \"capsulates a business capability, such as a shopping cart for an online\\neCommerce site. It exposes m\", \"ultiple operations that enable a user to manage their shopping\\nexperience. A function, however, is a\", \" small, lightweight block of code that executes a single-purpose\\noperation in response to an event. \", \"Microservices are typically constructed to respond to requests,\\noften from an interface. Requests ca\", \"n be HTTP Rest- or gRPC-based. Serverless services respond to\\nevents. Its event-driven architecture \", \"is ideal for processing short-running, background tasks.\\n\\n#### **What scenarios are appropriate for \", \"serverless?**\\n\\n\\nServerless exposes individual short-running functions that are invoked in response t\", \"o a trigger. This\\nmakes them ideal for processing background tasks.\\n\\n\\nAn application might need to s\", \"end an email as a step in a workflow. Instead of sending the\\nnotification as part of a microservice \", \"request, place the message details onto a queue. An Azure\\nFunction can dequeue the message and async\", \"hronously send the email. Doing so could improve the\\n[performance and scalability of the microservic\", \"e. Queue-based load leveling can be implemented to](https://docs.microsoft.com/azure/architecture/pa\", \"tterns/queue-based-load-leveling)\\navoid bottlenecks related to sending the emails. Additionally, thi\", \"s stand-alone service could be reused\\nas a utility across many different applications.\\n\\n\\n47 CHAPTER \", \"3 | Scaling cloud-native applications\\n\\n\\nAsynchronous messaging from queues and topics is a common pa\", \"ttern to trigger serverless functions.\\nHowever, Azure Functions can be triggered by other events, su\", \"ch as changes to Azure Blob Storage. A\\nservice that supports image uploads could have an Azure Funct\", \"ion responsible for optimizing the\\nimage size. The function could be triggered directly by inserts i\", \"nto Azure Blob Storage, keeping\\ncomplexity out of the microservice operations.\\n\\n\\nMany services have \", \"long-running processes as part of their workflows. Often these tasks are done as\\npart of the user\\u2019s \", \"interaction with the application. These tasks can force the user to wait, negatively\\nimpacting their\", \" experience. Serverless computing provides a great way to move slower tasks outside\\nof the user inte\", \"raction loop. These tasks can scale with demand without requiring the entire\\napplication to scale.\\n\\n\", \"#### **When should you avoid serverless?**\\n\\n\\nServerless solutions provision and scale on demand. Whe\", \"n a new instance is invoked, cold starts are a\\ncommon issue. A cold start is the period of time it t\", \"akes to provision this instance. Normally, this delay\\nmight be a few seconds, but can be longer depe\", \"nding on various factors. Once provisioned, a single\\ninstance is kept alive as long as it receives p\", \"eriodic requests. But, if a service is called less frequently,\\nAzure may remove it from memory and r\", \"equire a cold start when reinvoked. Cold starts are also\\nrequired when a function scales out to a ne\", \"w instance.\\n\\n\\nFigure 3-9 shows a cold-start pattern. Note the extra steps required when the app is c\", \"old.\\n\\n\\n_Figure 3-9. Cold start versus warm start._\\n\\n\\n[To avoid cold starts entirely, you might switc\", \"h from a consumption plan to a dedicated plan. You can](https://azure.microsoft.com/blog/understandi\", \"ng-serverless-cold-start/)\\n[also configure one or more pre-warmed instances](https://docs.microsoft.\", \"com/azure/azure-functions/functions-premium-plan#pre-warmed-instances) with the premium plan upgrade\", \". In these cases,\\nwhen you need to add another instance, it\\u2019s already up and ready to go. These opti\", \"ons can help\\nmitigate the cold start issue associated with serverless computing.\\n\\n\\n48 CHAPTER 3 | Sc\", \"aling cloud-native applications\\n\\n\\nCloud providers bill for serverless based on compute execution tim\", \"e and consumed memory. Long\\nrunning operations or high memory consumption workloads aren\\u2019t always th\", \"e best candidates for\\nserverless. Serverless functions favor small chunks of work that can complete \", \"quickly. Most serverless\\nplatforms require individual functions to complete within a few minutes. Az\", \"ure Functions defaults to a\\n5-minute time-out duration, which can be configured up to 10 minutes. Th\", \"e Azure Functions premium\\nplan can mitigate this issue as well, defaulting time-outs to 30 minutes w\", \"ith an unbounded higher\\nlimit that can be configured. Compute time isn\\u2019t calendar time. More advance\", \"d functions using the\\n[Azure Durable Functions framework may pause execution over a course of severa\", \"l days. The billing is](https://docs.microsoft.com/azure/azure-functions/durable/durable-functions-o\", \"verview?tabs=csharp)\\nbased on actual execution time - when the function wakes up and resumes process\", \"ing.\\n\\n\\nFinally, leveraging Azure Functions for application tasks adds complexity. It\\u2019s wise to first\", \" architect\\nyour application with a modular, loosely coupled design. Then, identify if there are bene\", \"fits serverless\\nwould offer that justify the additional complexity.\\n\\n### Combining containers and se\", \"rverless approaches\\n\\n\\nCloud-native applications typically implement services leveraging containers a\", \"nd orchestration. There\\nare often opportunities to expose some of the application\\u2019s services as Azur\", \"e Functions. However,\\nwith a cloud-native app deployed to Kubernetes, it would be nice to leverage A\", \"zure Functions within\\nthis same toolset. Fortunately, you can wrap Azure Functions inside Docker con\", \"tainers and deploy\\nthem using the same processes and tools as the rest of your Kubernetes-based app.\", \"\\n\\n#### **When does it make sense to use containers with serverless?**\\n\\n\\nYour Azure Function has no k\", \"nowledge of the platform on which it\\u2019s deployed. For some scenarios,\\nyou may have specific requireme\", \"nts and need to customize the environment on which your function\\ncode will run. You\\u2019ll need a custom\", \" image that supports dependencies or a configuration not\\nsupported by the default image. In these ca\", \"ses, it makes sense to deploy your function in a custom\\nDocker container.\\n\\n#### **When should you av\", \"oid using containers with Azure Functions?**\\n\\n\\nIf you want to use consumption billing, you can\\u2019t run\", \" your function in a container. What\\u2019s more, if you\\ndeploy your function to a Kubernetes cluster, you\", \"\\u2019ll no longer benefit from the built-in scaling\\nprovided by Azure Functions. You\\u2019ll need to use Kube\", \"rnetes\\u2019 scaling features, described earlier in this\\nchapter.\\n\\n#### **How to combine serverless and D\", \"ocker containers**\\n\\n\\n[To wrap an Azure Function in a Docker container, install the Azure Functions C\", \"ore Tools and then run](https://github.com/Azure/azure-functions-core-tools)\\nthe following command:\\n\", \"\\n```\\nfunc init ProjectName --worker-runtime dotnet --docker\\n\\n```\\n\\nWhen the project is created, it wi\", \"ll include a Dockerfile and the worker runtime configured to dotnet.\\nNow, you can create and test yo\", \"ur function locally. Build and run it using the docker build and docker\\n\\n\\n49 CHAPTER 3 | Scaling clo\", \"ud-native applications\\n\\n\\nrun commands. For detailed steps to get started building Azure Functions wi\", \"th Docker support, see\\n[the Create a function on Linux using a custom image tutorial.](https://docs.\", \"microsoft.com/azure/azure-functions/functions-create-function-linux-custom-image)\\n\\n#### **How to com\", \"bine serverless and Kubernetes with KEDA**\\n\\n\\nIn this chapter, you\\u2019ve seen that the Azure Functions\\u2019 \", \"platform automatically scales out to meet\\ndemand. When deploying containerized functions to AKS, how\", \"ever, you lose the built-in scaling\\n[functionality. To the rescue comes Kubernetes-based Event Drive\", \"n (KEDA). It enables fine-grained](https://docs.microsoft.com/azure/azure-functions/functions-kubern\", \"etes-keda)\\nautoscaling for event-driven Kubernetes workloads, including containerized functions.\\n\\n\\nK\", \"EDA provides event-driven scaling functionality to the Functions\\u2019 runtime in a Docker container.\\nKED\", \"A can scale from zero instances (when no events are occurring) out to n instances, based on load.\\nIt\", \" enables autoscaling by exposing custom metrics to the Kubernetes autoscaler (Horizontal Pod\\nAutosca\", \"ler). Using Functions containers with KEDA makes it possible to replicate serverless function\\ncapabi\", \"lities in any Kubernetes cluster.\\n\\n\\nIt\\u2019s worth noting that the KEDA project is now managed by the Cl\", \"oud Native Computing Foundation\\n(CNCF).\\n\\n### Deploying containers in Azure\\n\\n\\nWe\\u2019ve discussed contain\", \"ers in this chapter and in chapter 1. We\\u2019ve seen that containers provide many\\nbenefits to cloud-nati\", \"ve applications, including portability. In the Azure cloud, you can deploy the\\nsame containerized se\", \"rvices across staging and production environments. Azure provides several\\noptions for hosting these \", \"containerized workloads:\\n\\n\\n  - Azure Kubernetes Services (AKS)\\n\\n  - Azure Container Instance (ACI)\\n\\n\", \"  - Azure Web Apps for Containers\\n\\n#### **Azure Container Registry**\\n\\n\\nWhen containerizing a microse\", \"rvice, you first build a container \\u201cimage.\\u201d The image is a binary\\nrepresentation of the service code\", \", dependencies, and runtime. While you can manually create an\\nimage using the Docker Build command f\", \"rom the Docker API, a better approach is to create it as part\\nof an automated build process.\\n\\n\\nOnce \", \"created, container images are stored in container registries. They enable you to build, store, and\\nm\", \"anage container images. There are many registries available, both public and private. Azure\\nContaine\", \"r Registry (ACR) is a fully managed container registry service in the Azure cloud. It persists\\nyour \", \"images inside the Azure network, reducing the time to deploy them to Azure container hosts.\\nYou can \", \"also secure them using the same security and identity procedures that you use for other\\nAzure resour\", \"ces.\\n\\n\\n[You create an Azure Container Registry using the Azure portal,](https://docs.microsoft.com/a\", \"zure/container-registry/container-registry-get-started-portal) [Azure CLI, or PowerShell tools.](htt\", \"ps://docs.microsoft.com/azure/container-registry/container-registry-get-started-azure-cli)\\nCreating \", \"a registry in Azure is simple. It requires an Azure subscription, resource group, and a unique\\n\\n\\n50 \", \"CHAPTER 3 | Scaling cloud-native applications\\n\\n\\nname. Figure 3-10 shows the basic options for creati\", \"ng a registry, which will be hosted at\\nregistryname.azurecr.io.\\n\\n\\n_Figure 3-10. Create container reg\", \"istry_\\n\\n\\nOnce you\\u2019ve created the registry, you\\u2019ll need to authenticate with it before you can use it\", \". Typically,\\nyou\\u2019ll log into the registry using the Azure CLI command:\\n\\n```\\naz acr login --name *reg\", \"istryname*\\n\\n```\\n\\nOnce authenticated, you can use docker commands to push container images to it. Bef\", \"ore you can do\\nso, however, you must tag your image with the fully qualified name (URL) of your ACR \", \"login server. It\\nwill have the format _registryname_ .azurecr.io.\\n\\n```\\ndocker tag mycontainer myregi\", \"stry.azurecr.io/mycontainer:v1\\n\\n```\\n\\nAfter you\\u2019ve tagged the image, you use the docker push command \", \"to push the image to your ACR\\ninstance.\\n\\n```\\ndocker push myregistry.azurecr.io/mycontainer:v1\\n\\n```\\n\\n\", \"51 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\nAfter you push an image to the registry, it\\u2019s a g\", \"ood idea to remove the image from your local Docker\\nenvironment, using this command:\\n\\n```\\ndocker rmi\", \" myregistry.azurecr.io/mycontainer:v1\\n\\n```\\n\\nAs a best practice, you shouldn\\u2019t manually push images t\", \"o a container registry. Instead, use a build\\npipeline defined in a tool like GitHub or Azure DevOps.\", \" Learn more in the Cloud-Native DevOps\\nchapter.\\n\\n#### **ACR Tasks**\\n\\n\\n[ACR Tasks](https://docs.micro\", \"soft.com/azure/container-registry/container-registry-tasks-overview) [is a set of features available\", \" from the Azure Container Registry. It extends your inner-loop](https://docs.microsoft.com/dotnet/ar\", \"chitecture/containerized-lifecycle/design-develop-containerized-apps/docker-apps-inner-loop-workflow\", \")\\n[development cycle](https://docs.microsoft.com/dotnet/architecture/containerized-lifecycle/design-\", \"develop-containerized-apps/docker-apps-inner-loop-workflow) by building and managing container image\", \"s in the Azure cloud. Instead of\\ninvoking a docker build and docker push locally on your development\", \" machine, they\\u2019re automatically\\nhandled by ACR Tasks in the cloud.\\n\\n\\nThe following AZ CLI command bo\", \"th builds a container image and pushes it to ACR:\\n\\n```\\n# create a container registry\\naz acr create -\", \"-resource-group myResourceGroup --name myContainerRegistry008 --sku\\nBasic\\n\\n# build container image i\", \"n ACR and push it into your container registry\\naz acr build --image sample/hello-world:v1 --registry\", \" myContainerRegistry008 --file\\nDockerfile .\\n\\n```\\n\\nAs you can see from the previous command block, th\", \"ere\\u2019s no need to install Docker Desktop on your\\ndevelopment machine. Additionally, you can configure\", \" ACR Task triggers to rebuild containers images\\non both source code and base image updates.\\n\\n#### **\", \"Azure Kubernetes Service**\\n\\n\\nWe discussed Azure Kubernetes Service (AKS) at length in this chapter. \", \"We\\u2019ve seen that it\\u2019s the de\\nfacto container orchestrator managing containerized cloud-native applica\", \"tions.\\n\\n\\nOnce you deploy an image to a registry, such as ACR, you can configure AKS to automatically\", \" pull and\\n[deploy it. With a CI/CD pipeline in place, you might configure a canary release](https://\", \"martinfowler.com/bliki/CanaryRelease.html) strategy to minimize\\nthe risk involved when rapidly deplo\", \"ying updates. The new version of the app is initially configured in\\nproduction with no traffic route\", \"d to it. Then, the system will route a small percentage of users to the\\nnewly deployed version. As t\", \"he team gains confidence in the new version, it can roll out more\\ninstances and retire the old. AKS \", \"easily supports this style of deployment.\\n\\n\\nAs with most resources in Azure, you can create an Azure\", \" Kubernetes Service cluster using the portal,\\ncommand-line, or automation tools like Helm or Terrafo\", \"rm. To get started with a new cluster, you\\nneed to provide the following information:\\n\\n\\n  - Azure su\", \"bscription\\n\\n  - Resource group\\n\\n  - Kubernetes cluster name\\n\\n  - Region\\n\\n\\n52 CHAPTER 3 | Scaling clo\", \"ud-native applications\\n\\n\\n  - Kubernetes version\\n\\n  - DNS name prefix\\n\\n  - Node size\\n\\n  - Node count\\n\", \"\\nThis information is sufficient to get started. As part of the creation process in the Azure portal,\", \" you can\\nalso configure options for the following features of your cluster:\\n\\n\\n  - Scale\\n\\n  - Authent\", \"ication\\n\\n  - Networking\\n\\n  - Monitoring\\n\\n  - Tags\\n\\n[This quickstart walks through deploying an AKS c\", \"luster using the Azure portal.](https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-portal)\\n\", \"\\n#### **Azure Bridge to Kubernetes**\\n\\n\\nCloud-native applications can grow large and complex, requiri\", \"ng significant compute resources to\\nrun. In these scenarios, the entire application can\\u2019t be hosted \", \"on a development machine (especially a\\n[laptop). Azure Bridge to Kubernetes addresses the shortcomin\", \"g. It enables developers to work with a](https://docs.microsoft.com/visualstudio/bridge/overview-bri\", \"dge-to-kubernetes)\\nlocal version of their service while hosting the entire application in an AKS dev\", \"elopment cluster.\\n\\n\\nWhen ready, developers test their changes locally while running against the full\", \" application in the AKS\\ncluster - without replicating dependencies. Under the hood, the bridge merge\", \"s code from the local\\nmachine with services in AKS. Developers can rapidly iterate and debug code di\", \"rectly in Kubernetes\\nusing Visual Studio or Visual Studio Code.\\n\\n\\nGabe Monroy, former VP of Product \", \"Management at Microsoft, describes it well:\\n\\n\\nImagine you\\u2019re a new employee trying to fix a bug in a\", \" complex microservices application consisting\\nof dozens of components, each with their own configura\", \"tion and backing services. To get started, you\\nmust configure your local development environment so \", \"that it can mimic production including setting\\nup your IDE, building tool chain, containerized servi\", \"ce dependencies, a local Kubernetes environment,\\nmocks for backing services, and more. With all the \", \"time involved setting up your development\\nenvironment, fixing that first bug could take days! Or you\", \" could just use Bridge to Kubernetes and\\nAKS.\\n\\n### Scaling containers and serverless applications\\n\\n\\n\", \"There are two ways to scale an application: up or out. The former refers to adding capacity to a sin\", \"gle\\nresource, while the latter refers to adding more resources to increase capacity.\\n\\n#### **The sim\", \"ple solution: scaling up**\\n\\n\\nUpgrading an existing host server with increased CPU, memory, disk I/O \", \"speed, and network I/O\\nspeed is known as _scaling up_ . Scaling up a cloud-native application involv\", \"es choosing more capable\\n\\n\\n53 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\nresources from the clo\", \"ud vendor. For example, you can create a new node pool with larger VMs in\\nyour Kubernetes cluster. T\", \"hen, migrate your containerized services to the new pool.\\n\\n\\n[Serverless apps scale up by choosing th\", \"e premium Functions plan](https://docs.microsoft.com/azure/azure-functions/functions-scale) or premi\", \"um instance sizes from a\\ndedicated app service plan.\\n\\n#### **Scaling out cloud-native apps**\\n\\n\\nCloud\", \"-native applications often experience large fluctuations in demand and require scale on a\\nmoment\\u2019s n\", \"otice. They favor scaling out. Scaling out is done horizontally by adding additional\\nmachines (calle\", \"d nodes) or application instances to an existing cluster. In Kubernetes, you can scale\\n[manually by \", \"adjusting configuration settings for the app (for example, scaling a node pool), or](https://docs.mi\", \"crosoft.com/azure/aks/use-multiple-node-pools#scale-a-node-pool-manually)\\nthrough autoscaling.\\n\\n\\nAKS\", \" clusters can autoscale in one of two ways:\\n\\n\\n[First, the Horizontal Pod Autoscaler monitors resourc\", \"e demand and automatically scales your POD](https://docs.microsoft.com/azure/aks/tutorial-kubernetes\", \"-scale#autoscale-pods)\\nreplicas to meet it. When traffic increases, additional replicas are automati\", \"cally provisioned to scale\\nout your services. Likewise, when demand decreases, they\\u2019re removed to sc\", \"ale-in your services. You\\ndefine the metric on which to scale, for example, CPU usage. You can also \", \"specify the minimum and\\nmaximum number of replicas to run. AKS monitors that metric and scales accor\", \"dingly.\\n\\n\\n[Next, the AKS Cluster Autoscaler feature enables you to automatically scale compute nodes\", \" across a](https://docs.microsoft.com/azure/aks/cluster-autoscaler)\\nKubernetes cluster to meet deman\", \"d. With it, you can automatically add new VMs to the underlying\\nAzure Virtual Machine Scale Set when\", \"ever more compute capacity of is required. It also removes\\nnodes when no longer required.\\n\\n\\nFigure 3\", \"-11 shows the relationship between these two scaling services.\\n\\n\\n_Figure 3-11. Scaling out an App Se\", \"rvice plan._\\n\\n\\n54 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\nWorking together, both ensure an o\", \"ptimal number of container instances and compute nodes to\\nsupport fluctuating demand. The horizontal\", \" pod autoscaler optimizes the number of pods required.\\nThe cluster autoscaler optimizes the number o\", \"f nodes required.\\n\\n\\n**Scaling Azure Functions**\\n\\n\\nAzure Functions automatically scale out upon deman\", \"d. Server resources are dynamically allocated and\\nremoved based on the number of triggered events. Y\", \"ou\\u2019re only charged for compute resources\\nconsumed when your functions run. Billing is based upon the\", \" number of executions, execution time,\\nand memory used.\\n\\n\\nWhile the default consumption plan provide\", \"s an economical and scalable solution for most apps, the\\npremium option allows developers flexibilit\", \"y for custom Azure Functions requirements. Upgrading to\\nthe premium plan provides control over insta\", \"nce sizes, pre-warmed instances (to avoid cold start\\ndelays), and dedicated VMs.\\n\\n### Other containe\", \"r deployment options\\n\\n\\nAside from Azure Kubernetes Service (AKS), you can also deploy containers to \", \"Azure App Service for\\nContainers and Azure Container Instances.\\n\\n#### **When does it make sense to d\", \"eploy to App Service for Containers?**\\n\\n\\nSimple production applications that don\\u2019t require orchestra\", \"tion are well suited to Azure App Service\\nfor Containers.\\n\\n#### **How to deploy to App Service for C\", \"ontainers**\\n\\n\\n[To deploy to Azure App Service for Containers, you\\u2019ll need an Azure Container Registr\", \"y (ACR) instance](https://azure.microsoft.com/services/app-service/containers/)\\nand credentials to a\", \"ccess it. Push your container image to the ACR repository so that your Azure App\\nService can pull it\", \" when needed. Once complete, you can configure the app for Continuous\\nDeployment. Doing so will auto\", \"matically deploy updates whenever the image changes in ACR.\\n\\n#### **When does it make sense to deplo\", \"y to Azure Container Instances?**\\n\\n\\n[Azure Container Instances (ACI) enables you to run Docker conta\", \"iners in a managed, serverless cloud](https://azure.microsoft.com/services/container-instances/)\\nenv\", \"ironment, without having to set up virtual machines or clusters. It\\u2019s a great solution for shortrunn\", \"ing workloads that can run in an isolated container. Consider ACI for simple services, testing\\nscena\", \"rios, task automation, and build jobs. ACI spins-up a container instance, performs the task, and\\nthe\", \"n spins it down.\\n\\n#### **How to deploy an app to Azure Container Instances**\\n\\n\\n[To deploy to Azure C\", \"ontainer Instances (ACI), you need an Azure Container Registry (ACR) and](https://docs.microsoft.com\", \"/azure/container-instances/)\\ncredentials for accessing it. Once you push your container image to the\", \" repository, it\\u2019s available to pull\\ninto ACI. You can work with ACI using the Azure portal or comman\", \"d-line interface. ACR provides tight\\nintegration with ACI. Figure 3-12 shows how to push an individu\", \"al container image to ACR.\\n\\n\\n55 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\n_Figure 3-12. Azure \", \"Container Registry Run Instance_\\n\\n\\nCreating an instance in ACI can be done quickly. Specify the imag\", \"e registry, Azure resource group\\n[information, the amount of memory to allocate, and the port on whi\", \"ch to listen. This quickstart shows](https://docs.microsoft.com/azure/container-instances/container-\", \"instances-quickstart-portal)\\n[how to deploy a container instance to ACI using the Azure portal.](htt\", \"ps://docs.microsoft.com/azure/container-instances/container-instances-quickstart-portal)\\n\\n\\nOnce the \", \"deployment completes, find the newly deployed container\\u2019s IP address and communicate\\nwith it over th\", \"e port you specified.\\n\\n\\nAzure Container Instances offers the fastest way to run simple container wor\", \"kloads in Azure. You don\\u2019t\\nneed to configure an app service, orchestrator, or virtual machine. For s\", \"cenarios where you require full\\ncontainer orchestration, service discovery, automatic scaling, or co\", \"ordinated upgrades, we\\nrecommend Azure Kubernetes Service (AKS).\\n\\n#### **References**\\n\\n\\n  - [What is\", \" Kubernetes?](https://blog.newrelic.com/engineering/what-is-kubernetes/)\\n\\n  - [Installing Kubernetes\", \" with Minikube](https://kubernetes.io/docs/setup/learning-environment/minikube/)\\n\\n  - [MiniKube vs D\", \"ocker Desktop](https://medium.com/containers-101/local-kubernetes-for-windows-minikube-vs-docker-des\", \"ktop-25a1c6d3b766)\\n\\n  - [Visual Studio Tools for Docker](https://docs.microsoft.com/dotnet/standard/\", \"containerized-lifecycle-architecture/design-develop-containerized-apps/visual-studio-tools-for-docke\", \"r)\\n\\n\\n56 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\n  - [Understanding serverless cold start](ht\", \"tps://azure.microsoft.com/blog/understanding-serverless-cold-start/)\\n\\n  - [Pre-warmed Azure Function\", \"s instances](https://docs.microsoft.com/azure/azure-functions/functions-premium-plan#pre-warmed-inst\", \"ances)\\n\\n  - [Create a function on Linux using a custom image](https://docs.microsoft.com/azure/azure\", \"-functions/functions-create-function-linux-custom-image)\\n\\n  - [Run Azure Functions in a Docker Conta\", \"iner](https://markheath.net/post/azure-functions-docker)\\n\\n  - [Create a function on Linux using a cu\", \"stom image](https://docs.microsoft.com/azure/azure-functions/functions-create-function-linux-custom-\", \"image)\\n\\n  - [Azure Functions with Kubernetes Event Driven Autoscaling](https://docs.microsoft.com/az\", \"ure/azure-functions/functions-kubernetes-keda)\\n\\n  - [Canary Release](https://martinfowler.com/bliki/\", \"CanaryRelease.html)\\n\\n  - [Azure Dev Spaces with VS Code](https://docs.microsoft.com/azure/dev-spaces\", \"/quickstart-netcore)\\n\\n  - [Azure Dev Spaces with Visual Studio](https://docs.microsoft.com/azure/dev\", \"-spaces/quickstart-netcore-visualstudio)\\n\\n  - [AKS Multiple Node Pools](https://docs.microsoft.com/a\", \"zure/aks/use-multiple-node-pools)\\n\\n  - [AKS Cluster Autoscaler](https://docs.microsoft.com/azure/aks\", \"/cluster-autoscaler)\\n\\n  - [Tutorial: Scale applications in AKS](https://docs.microsoft.com/azure/aks\", \"/tutorial-kubernetes-scale)\\n\\n  - [Azure Functions scale and hosting](https://docs.microsoft.com/azur\", \"e/azure-functions/functions-scale)\\n\\n  - [Azure Container Instances Docs](https://docs.microsoft.com/\", \"azure/container-instances/)\\n\\n  - [Deploy Container Instance from ACR](https://docs.microsoft.com/azu\", \"re/container-instances/container-instances-using-azure-container-registry#deploy-with-azure-portal)\\n\", \"\\n\\n57 CHAPTER 3 | Scaling cloud-native applications\\n\\n\\n**CHAPTER**\\n# 4\\n\\n## Cloud-native communication \", \"patterns\\n\\n\\nWhen constructing a cloud-native system, communication becomes a significant design decis\", \"ion. How\\ndoes a front-end client application communicate with a back-end microservice? How do back-e\", \"nd\\nmicroservices communicate with each other? What are the principles, patterns, and best practices \", \"to\\nconsider when implementing communication in cloud-native applications?\\n\\n### Communication conside\", \"rations\\n\\n\\nIn a monolithic application, communication is straightforward. The code modules execute to\", \"gether in\\nthe same executable space (process) on a server. This approach can have performance advant\", \"ages as\\neverything runs together in shared memory, but results in tightly coupled code that becomes \", \"difficult\\nto maintain, evolve, and scale.\\n\\n\\nCloud-native systems implement a microservice-based arch\", \"itecture with many small, independent\\nmicroservices. Each microservice executes in a separate proces\", \"s and typically runs inside a container\\nthat is deployed to a _cluster_ .\\n\\n\\nA cluster groups a pool \", \"of virtual machines together to form a highly available environment. They\\u2019re\\nmanaged with an orchest\", \"ration tool, which is responsible for deploying and managing the\\n[containerized microservices. Figur\", \"e 4-1 shows a Kubernetes](https://kubernetes.io/) cluster deployed into the Azure cloud\\n[with the fu\", \"lly managed Azure Kubernetes Services.](https://docs.microsoft.com/azure/aks/intro-kubernetes)\\n\\n\\n58 \", \"CHAPTER 4 | Cloud-native communication patterns\\n\\n\\n_Figure 4-1. A Kubernetes cluster in Azure_\\n\\n\\nAcro\", \"ss the cluster, microservices communicate with each other through APIs and messaging\\ntechnologies.\\n\\n\", \"\\nWhile they provide many benefits, microservices are no free lunch. Local in-process method calls\\nbe\", \"tween components are now replaced with network calls. Each microservice must communicate over\\na netw\", \"ork protocol, which adds complexity to your system:\\n\\n\\n  - Network congestion, latency, and transient\", \" faults are a constant concern.\\n\\n\\n  - Resiliency (that is, retrying failed requests) is essential.\\n\\n\", \"\\n  - [Some calls must be idempotent](https://www.restapitutorial.com/lessons/idempotency.html) as to\", \" keep consistent state.\\n\\n\\n  - Each microservice must authenticate and authorize calls.\\n\\n\\n  - Each me\", \"ssage must be serialized and then deserialized - which can be expensive.\\n\\n\\n  - Message encryption/de\", \"cryption becomes important.\\n\\n\\n[The book .NET Microservices: Architecture for Containerized .NET Appl\", \"ications, available for free from](https://dotnet.microsoft.com/download/thank-you/microservices-arc\", \"hitecture-ebook)\\nMicrosoft, provides an in-depth coverage of communication patterns for microservice\", \" applications. In\\nthis chapter, we provide a high-level overview of these patterns along with implem\", \"entation options\\navailable in the Azure cloud.\\n\\n\\nIn this chapter, we\\u2019ll first address communication \", \"between front-end applications and back-end\\nmicroservices. We\\u2019ll then look at back-end microservices\", \" communicate with each other. We\\u2019ll explore\\n\\n\\n59 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\nt\", \"he up and gRPC communication technology. Finally, we\\u2019ll look new innovative communication\\npatterns u\", \"sing service mesh technology. We\\u2019ll also see how the Azure cloud provides different kinds\\nof _backin\", \"g services_ to support cloud-native communication.\\n\\n### Front-end client communication\\n\\n\\nIn a cloud-\", \"native system, front-end clients (mobile, web, and desktop applications) require a\\ncommunication cha\", \"nnel to interact with independent back-end microservices.\\n\\n\\nWhat are the options?\\n\\n\\nTo keep things s\", \"imple, a front-end client could _directly communicate_ with the back-end microservices,\\nshown in Fig\", \"ure 4-2.\\n\\n\\n_Figure 4-2. Direct client to service communication_\\n\\n\\nWith this approach, each microserv\", \"ice has a public endpoint that is accessible by front-end clients. In\\na production environment, you\\u2019\", \"d place a load balancer in front of the microservices, routing traffic\\nproportionately.\\n\\n\\nWhile simp\", \"le to implement, direct client communication would be acceptable only for simple\\nmicroservice applic\", \"ations. This pattern tightly couples front-end clients to core back-end services,\\nopening the door f\", \"or many problems, including:\\n\\n\\n  - Client susceptibility to back-end service refactoring.\\n\\n  - A wid\", \"er attack surface as core back-end services are directly exposed.\\n\\n  - Duplication of cross-cutting \", \"concerns across each microservice.\\n\\n  - Overly complex client code - clients must keep track of mult\", \"iple endpoints and handle failures\\nin a resilient way.\\n\\n\\n60 CHAPTER 4 | Cloud-native communication p\", \"atterns\\n\\n\\n[Instead, a widely accepted cloud design pattern is to implement an API Gateway Service be\", \"tween the](https://docs.microsoft.com/dotnet/architecture/microservices/architect-microservice-conta\", \"iner-applications/direct-client-to-microservice-communication-versus-the-api-gateway-pattern)\\nfront-\", \"end applications and back-end services. The pattern is shown in Figure 4-3.\\n\\n\\n_Figure 4-3. API gatew\", \"ay pattern_\\n\\n\\nIn the previous figure, note how the API Gateway service abstracts the back-end core m\", \"icroservices.\\nImplemented as a web API, it acts as a _reverse proxy_, routing incoming traffic to th\", \"e internal\\nmicroservices.\\n\\n\\nThe gateway insulates the client from internal service partitioning and \", \"refactoring. If you change a\\nback-end service, you accommodate for it in the gateway without breakin\", \"g the client. It\\u2019s also your\\nfirst line of defense for cross-cutting concerns, such as identity, cac\", \"hing, resiliency, metering, and\\nthrottling. Many of these cross-cutting concerns can be off-loaded f\", \"rom the back-end core services to\\nthe gateway, simplifying the back-end services.\\n\\n\\nCare must be tak\", \"en to keep the API Gateway simple and fast. Typically, business logic is kept out of\\nthe gateway. A \", \"complex gateway risks becoming a bottleneck and eventually a monolith itself. Larger\\nsystems often e\", \"xpose multiple API Gateways segmented by client type (mobile, web, desktop) or\\n[back-end functionali\", \"ty. The Backend for Frontends](https://docs.microsoft.com/azure/architecture/patterns/backends-for-f\", \"rontends) pattern provides direction for implementing\\nmultiple gateways. The pattern is shown in Fig\", \"ure 4-4.\\n\\n\\n61 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\n_Figure 4-4. Backend for frontend pa\", \"ttern_\\n\\n\\nNote in the previous figure how incoming traffic is sent to a specific API gateway - based \", \"upon client\\ntype: web, mobile, or desktop app. This approach makes sense as the capabilities of each\", \" device differ\\nsignificantly across form factor, performance, and display limitations. Typically mob\", \"ile applications\\nexpose less functionality than a browser or desktop applications. Each gateway can \", \"be optimized to\\nmatch the capabilities and functionality of the corresponding device.\\n\\n#### **Simple\", \" Gateways**\\n\\n\\nTo start, you could build your own API Gateway service. A quick search of GitHub will \", \"provide many\\nexamples.\\n\\n\\n[For simple .NET cloud-native applications, you might consider the Ocelot G\", \"ateway. Open source and](https://github.com/ThreeMammals/Ocelot)\\ncreated for .NET microservices, it\\u2019\", \"s lightweight, fast, scalable. Like any API Gateway, its primary\\nfunctionality is to forward incomin\", \"g HTTP requests to downstream services. Additionally, it supports a\\nwide variety of capabilities tha\", \"t are configurable in a .NET middleware pipeline.\\n\\n\\n[YARP](https://github.com/microsoft/reverse-prox\", \"y) (Yet Another Reverse proxy) is another open source reverse proxy led by a group of Microsoft\\nprod\", \"uct teams. Downloadable as a NuGet package, YARP plugs into the ASP.NET framework as\\n[middleware and\", \" is highly customizable. You\\u2019ll find YARP well-documented](https://microsoft.github.io/reverse-proxy\", \"/articles/getting-started.html) with various usage\\nexamples.\\n\\n\\nFor enterprise cloud-native applicati\", \"ons, there are several managed Azure services that can help\\njump-start your efforts.\\n\\n\\n62 CHAPTER 4 \", \"| Cloud-native communication patterns\\n\\n\\n#### **Azure Application Gateway**\\n\\n[For simple gateway requ\", \"irements, you may consider Azure Application Gateway. Available as an Azure](https://docs.microsoft.\", \"com/azure/application-gateway/overview)\\n[PaaS service, it includes basic gateway features such as UR\", \"L routing, SSL termination, and a Web](https://azure.microsoft.com/overview/what-is-paas/)\\n[Applicat\", \"ion Firewall. The service supports Layer-7 load balancing](https://www.nginx.com/resources/glossary/\", \"layer-7-load-balancing/) capabilities. With Layer 7, you can\\nroute requests based on the actual cont\", \"ent of an HTTP message, not just low-level TCP network\\npackets.\\n\\n\\n[Throughout this book, we evangeli\", \"ze hosting cloud-native systems in Kubernetes. A container](https://www.infoworld.com/article/326807\", \"3/what-is-kubernetes-your-next-application-platform.html)\\norchestrator, Kubernetes automates the dep\", \"loyment, scaling, and operational concerns of\\n[containerized workloads. Azure Application Gateway ca\", \"n be configured as an API gateway for Azure](https://azure.microsoft.com/services/kubernetes-service\", \"/)\\n[Kubernetes Service](https://azure.microsoft.com/services/kubernetes-service/) cluster.\\n\\n\\n[The Ap\", \"plication Gateway Ingress Controller enables Azure Application Gateway to work directly with](https:\", \"//azure.github.io/application-gateway-kubernetes-ingress/)\\n[Azure Kubernetes Service. Figure 4.5 sho\", \"ws the architecture.](https://azure.microsoft.com/services/kubernetes-service/)\\n\\n\\n_Figure 4-5. Appli\", \"cation Gateway Ingress Controller_\\n\\n\\n[Kubernetes includes a built-in feature that supports HTTP (Lev\", \"el 7) load balancing, called Ingress.](https://kubernetes.io/docs/concepts/services-networking/ingre\", \"ss/)\\nIngress defines a set of rules for how microservice instances inside AKS can be exposed to the \", \"outside\\nworld. In the previous image, the ingress controller interprets the ingress rules configured\", \" for the\\ncluster and automatically configures the Azure Application Gateway. Based on those rules, t\", \"he\\nApplication Gateway routes traffic to microservices running inside AKS. The ingress controller li\", \"stens\\nfor changes to ingress rules and makes the appropriate changes to the Azure Application Gatewa\", \"y.\\n\\n#### **Azure API Management**\\n\\n\\n[For moderate to large-scale cloud-native systems, you may consi\", \"der Azure API Management. It\\u2019s a](https://azure.microsoft.com/services/api-management/)\\ncloud-based \", \"service that not only solves your API Gateway needs, but provides a full-featured\\ndeveloper and admi\", \"nistrative experience. API Management is shown in Figure 4-6.\\n\\n\\n63 CHAPTER 4 | Cloud-native communic\", \"ation patterns\\n\\n\\n_Figure 4-6. Azure API Management_\\n\\n\\nTo start, API Management exposes a gateway ser\", \"ver that allows controlled access to back-end\\nservices based upon configurable rules and policies. T\", \"hese services can be in the Azure cloud, your\\non-prem data center, or other public clouds. API keys \", \"and JWT tokens determine who can do what. All\\ntraffic is logged for analytical purposes.\\n\\n\\nFor devel\", \"opers, API Management offers a developer portal that provides access to services,\\ndocumentation, and\", \" sample code for invoking them. Developers can use Swagger/Open API to\\ninspect service endpoints and\", \" analyze their usage. The service works across the major development\\nplatforms: .NET, Java, Golang, \", \"and more.\\n\\n\\nThe publisher portal exposes a management dashboard where administrators expose APIs and\", \"\\nmanage their behavior. Service access can be granted, service health monitored, and service telemet\", \"ry\\ngathered. Administrators apply _policies_ [to each endpoint to affect behavior. Policies](https:/\", \"/docs.microsoft.com/azure/api-management/api-management-howto-policies) are pre-built\\nstatements tha\", \"t execute sequentially for each service call. Policies are configured for an inbound call,\\noutbound \", \"call, or invoked upon an error. Policies can be applied at different service scopes as to\\nenable det\", \"erministic ordering when combining policies. The product ships with a large number of\\n[prebuilt poli\", \"cies.](https://docs.microsoft.com/azure/api-management/api-management-policies)\\n\\n\\nHere are examples \", \"of how policies can affect the behavior of your cloud-native services:\\n\\n\\n  - Restrict service access\", \".\\n\\n  - Enforce authentication.\\n\\n\\n  - Throttle calls from a single source, if necessary.\\n\\n  - Enable \", \"caching.\\n\\n  - Block calls from specific IP addresses.\\n\\n\\n64 CHAPTER 4 | Cloud-native communication pa\", \"tterns\\n\\n\\n  - Control the flow of the service.\\n\\n  - Convert requests from SOAP to REST or between dif\", \"ferent data formats, such as from XML to\\nJSON.\\n\\n\\nAzure API Management can expose back-end services t\", \"hat are hosted anywhere \\u2013 in the cloud or your\\ndata center. For legacy services that you may expose \", \"in your cloud-native systems, it supports both\\nREST and SOAP APIs. Even other Azure services can be \", \"exposed through API Management. You could\\n[place a managed API on top of an Azure backing service li\", \"ke Azure Service Bus or Azure Logic Apps.](https://azure.microsoft.com/services/service-bus/)\\nAzure \", \"API Management doesn\\u2019t include built-in load-balancing support and should be used in\\nconjunction wit\", \"h a load-balancing service.\\n\\n\\n[Azure API Management is available across four different tiers:](https\", \"://azure.microsoft.com/pricing/details/api-management/)\\n\\n\\n  - Developer\\n\\n  - Basic\\n\\n  - Standard\\n\\n  \", \"- Premium\\n\\n\\nThe Developer tier is meant for non-production workloads and evaluation. The other tiers\", \" offer\\nprogressively more power, features, and higher service level agreements (SLAs). The Premium t\", \"ier\\n[provides Azure Virtual Network and multi-region support. All tiers have a fixed price per hour.\", \"](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview)\\n\\n\\n[The Azure cloud als\", \"o offers a serverless tier](https://azure.microsoft.com/blog/announcing-azure-api-management-for-ser\", \"verless-architectures/) for Azure API Management. Referred to as the\\n_consumption pricing tier_, the\", \" service is a variant of API Management designed around the serverless\\ncomputing model. Unlike the \\u201c\", \"pre-allocated\\u201d pricing tiers previously shown, the consumption tier\\nprovides instant provisioning an\", \"d pay-per-action pricing.\\n\\n\\nIt enables API Gateway features for the following use cases:\\n\\n\\n  - [Micr\", \"oservices implemented using serverless technologies such as Azure Functions and Azure](https://docs.\", \"microsoft.com/azure/azure-functions/functions-overview)\\n[Logic Apps.](https://azure.microsoft.com/se\", \"rvices/logic-apps/)\\n\\n  - Azure backing service resources such as Service Bus queues and topics, Azur\", \"e storage, and\\nothers.\\n\\n  - Microservices where traffic has occasional large spikes but remains low \", \"most the time.\\n\\n\\nThe consumption tier uses the same underlying service API Management components, bu\", \"t employs\\nan entirely different architecture based on dynamically allocated resources. It aligns per\", \"fectly with the\\nserverless computing model:\\n\\n\\n  - No infrastructure to manage.\\n\\n  - No idle capacity\", \".\\n\\n  - High-availability.\\n\\n  - Automatic scaling.\\n\\n  - Cost is based on actual usage.\\n\\nThe new consu\", \"mption tier is a great choice for cloud-native systems that expose serverless resources\\nas APIs.\\n\\n\\n6\", \"5 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\n#### **Real-time communication**\\n\\nReal-time, or \", \"push, communication is another option for front-end applications that communicate\\nwith back-end clou\", \"d-native systems over HTTP. Applications, such as financial-tickers, online\\neducation, gaming, and j\", \"ob-progress updates, require instantaneous, real-time responses from the\\nback-end. With normal HTTP \", \"communication, there\\u2019s no way for the client to know when new data is\\navailable. The client must con\", \"tinually _poll_ or send requests to the server. With _real-time_\\ncommunication, the server can push \", \"new data to the client at any time.\\n\\n\\nReal-time systems are often characterized by high-frequency da\", \"ta flows and large numbers of\\nconcurrent client connections. Manually implementing real-time connect\", \"ivity can quickly become\\ncomplex, requiring non-trivial infrastructure to ensure scalability and rel\", \"iable messaging to connected\\nclients. You could find yourself managing an instance of Azure Redis Ca\", \"che and a set of load\\nbalancers configured with sticky sessions for client affinity.\\n\\n\\n[Azure Signal\", \"R Service](https://azure.microsoft.com/services/signalr-service/) is a fully managed Azure service t\", \"hat simplifies real-time communication for\\nyour cloud-native applications. Technical implementation \", \"details like capacity provisioning, scaling,\\nand persistent connections are abstracted away. They\\u2019re\", \" handled for you with a 99.9% service-level\\nagreement. You focus on application features, not infras\", \"tructure plumbing.\\n\\n\\nOnce enabled, a cloud-based HTTP service can push content updates directly to c\", \"onnected clients,\\nincluding browser, mobile and desktop applications. Clients are updated without th\", \"e need to poll the\\nserver. Azure SignalR abstracts the transport technologies that create real-time \", \"connectivity, including\\nWebSockets, Server-Side Events, and Long Polling. Developers focus on sendin\", \"g messages to all or\\nspecific subsets of connected clients.\\n\\n\\nFigure 4-7 shows a set of HTTP Clients\", \" connecting to a Cloud-native application with Azure SignalR\\nenabled.\\n\\n\\n66 CHAPTER 4 | Cloud-native \", \"communication patterns\\n\\n\\n_Figure 4-7. Azure SignalR_\\n\\n\\nAnother advantage of Azure SignalR Service co\", \"mes with implementing Serverless cloud-native\\nservices. Perhaps your code is executed on demand with\", \" Azure Functions triggers. This scenario can\\nbe tricky because your code doesn\\u2019t maintain long conne\", \"ctions with clients. Azure SignalR Service can\\nhandle this situation since the service already manag\", \"es connections for you.\\n\\n\\nAzure SignalR Service closely integrates with other Azure services, such a\", \"s Azure SQL Database,\\nService Bus, or Redis Cache, opening up many possibilities for your cloud-nati\", \"ve applications.\\n\\n### Service-to-service communication\\n\\n\\nMoving from the front-end client, we now ad\", \"dress back-end microservices communicate with each\\nother.\\n\\n\\nWhen constructing a cloud-native applica\", \"tion, you\\u2019ll want to be sensitive to how back-end services\\ncommunicate with each other. Ideally, the\", \" less inter-service communication, the better. However,\\navoidance isn\\u2019t always possible as back-end \", \"services often rely on one another to complete an\\noperation.\\n\\n\\nThere are several widely accepted app\", \"roaches to implementing cross-service communication. The _type_\\n_of communication interaction_ will \", \"often determine the best approach.\\n\\n\\nConsider the following interaction types:\\n\\n\\n  - _Query_  - when\", \" a calling microservice requires a response from a called microservice, such as,\\n\\u201cHey, give me the b\", \"uyer information for a given customer Id.\\u201d\\n\\n\\n67 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\n  \", \"- _Command_  - when the calling microservice needs another microservice to execute an action\\nbut doe\", \"sn\\u2019t require a response, such as, \\u201cHey, just ship this order.\\u201d\\n\\n\\n  - _Event_  - when a microservice,\", \" called the publisher, raises an event that state has changed or an\\naction has occurred. Other micro\", \"services, called subscribers, who are interested, can react to\\nthe event appropriately. The publishe\", \"r and the subscribers aren\\u2019t aware of each other.\\n\\n\\nMicroservice systems typically use a combination\", \" of these interaction types when executing\\noperations that require cross-service interaction. Let\\u2019s \", \"take a close look at each and how you might\\nimplement them.\\n\\n#### **Queries**\\n\\n\\nMany times, one micr\", \"oservice might need to _query_ another, requiring an immediate response to\\ncomplete an operation. A \", \"shopping basket microservice may need product information and a price to\\nadd an item to its basket. \", \"There are many approaches for implementing query operations.\\n\\n\\n**Request/Response Messaging**\\n\\n\\nOne \", \"option for implementing this scenario is for the calling back-end microservice to make direct\\nHTTP r\", \"equests to the microservices it needs to query, shown in Figure 4-8.\\n\\n\\n_Figure 4-8. Direct HTTP comm\", \"unication_\\n\\n\\nWhile direct HTTP calls between microservices are relatively simple to implement, care \", \"should be\\ntaken to minimize this practice. To start, these calls are always _synchronous_ and will b\", \"lock the\\noperation until a result is returned or the request times outs. What were once self-contain\", \"ed,\\nindependent services, able to evolve independently and deploy frequently, now become coupled to\\n\", \"each other. As coupling among microservices increase, their architectural benefits diminish.\\n\\n\\n68 CH\", \"APTER 4 | Cloud-native communication patterns\\n\\n\\nExecuting an infrequent request that makes a single \", \"direct HTTP call to another microservice might be\\nacceptable for some systems. However, high-volume \", \"calls that invoke direct HTTP calls to multiple\\nmicroservices aren\\u2019t advisable. They can increase la\", \"tency and negatively impact the performance,\\nscalability, and availability of your system. Even wors\", \"e, a long series of direct HTTP communication can\\nlead to deep and complex chains of synchronous mic\", \"roservices calls, shown in Figure 4-9:\\n\\n\\n_Figure 4-9. Chaining HTTP queries_\\n\\n\\nYou can certainly ima\", \"gine the risk in the design shown in the previous image. What happens if Step\\n#3 fails? Or Step #8 f\", \"ails? How do you recover? What if Step #6 is slow because the underlying service\\nis busy? How do you\", \" continue? Even if all works correctly, think of the latency this call would incur,\\nwhich is the sum\", \" of the latency of each step.\\n\\n\\nThe large degree of coupling in the previous image suggests the serv\", \"ices weren\\u2019t optimally modeled.\\nIt would behoove the team to revisit their design.\\n\\n\\n**Materialized \", \"View pattern**\\n\\n\\n[A popular option for removing microservice coupling is the Materialized View patte\", \"rn. With this](https://docs.microsoft.com/azure/architecture/patterns/materialized-view)\\npattern, a \", \"microservice stores its own local, denormalized copy of data that\\u2019s owned by other services.\\nInstead\", \" of the Shopping Basket microservice querying the Product Catalog and Pricing microservices,\\nit main\", \"tains its own local copy of that data. This pattern eliminates unnecessary coupling and\\nimproves rel\", \"iability and response time. The entire operation executes inside a single process. We\\nexplore this p\", \"attern and other data concerns in Chapter 5.\\n\\n\\n**Service Aggregator Pattern**\\n\\n\\n[Another option for \", \"eliminating microservice-to-microservice coupling is an Aggregator microservice,](https://devblogs.m\", \"icrosoft.com/cesardelatorre/designing-and-implementing-api-gateways-with-ocelot-in-a-microservices-a\", \"nd-container-based-architecture/)\\nshown in purple in Figure 4-10.\\n\\n\\n69 CHAPTER 4 | Cloud-native comm\", \"unication patterns\\n\\n\\n_Figure 4-10. Aggregator microservice_\\n\\n\\nThe pattern isolates an operation that\", \" makes calls to multiple back-end microservices, centralizing its\\nlogic into a specialized microserv\", \"ice. The purple checkout aggregator microservice in the previous\\nfigure orchestrates the workflow fo\", \"r the Checkout operation. It includes calls to several back-end\\nmicroservices in a sequenced order. \", \"Data from the workflow is aggregated and returned to the caller.\\nWhile it still implements direct HT\", \"TP calls, the aggregator microservice reduces direct dependencies\\namong back-end microservices.\\n\\n\\n**\", \"Request/Reply Pattern**\\n\\n\\n[Another approach for decoupling synchronous HTTP messages is a Request-Re\", \"ply Pattern, which uses](https://www.enterpriseintegrationpatterns.com/patterns/messaging/RequestRep\", \"ly.html)\\nqueuing communication. Communication using a queue is always a one-way channel, with a prod\", \"ucer\\nsending the message and consumer receiving it. With this pattern, both a request queue and resp\", \"onse\\nqueue are implemented, shown in Figure 4-11.\\n\\n\\n70 CHAPTER 4 | Cloud-native communication patter\", \"ns\\n\\n\\n_Figure 4-11. Request-reply pattern_\\n\\n\\nHere, the message producer creates a query-based message\", \" that contains a unique correlation ID and\\nplaces it into a request queue. The consuming service deq\", \"ueues the messages, processes it and places\\nthe response into the response queue with the same corre\", \"lation ID. The producer service dequeues\\nthe message, matches it with the correlation ID and continu\", \"es processing. We cover queues in detail\\nin the next section.\\n\\n#### **Commands**\\n\\n\\nAnother type of c\", \"ommunication interaction is a _command_ . A microservice may need another\\nmicroservice to perform an\", \" action. The Ordering microservice may need the Shipping microservice to\\ncreate a shipment for an ap\", \"proved order. In Figure 4-12, one microservice, called a Producer, sends a\\nmessage to another micros\", \"ervice, the Consumer, commanding it to do something.\\n\\n\\n71 CHAPTER 4 | Cloud-native communication pat\", \"terns\\n\\n\\n_Figure 4-12. Command interaction with a queue_\\n\\n\\nMost often, the Producer doesn\\u2019t require a\", \" response and can _fire-and-forget_ the message. If a reply is\\nneeded, the Consumer sends a separate\", \" message back to Producer on another channel. A command\\nmessage is best sent asynchronously with a m\", \"essage queue. supported by a lightweight message\\nbroker. In the previous diagram, note how a queue s\", \"eparates and decouples both services.\\n\\n\\nA message queue is an intermediary construct through which a\", \" producer and consumer pass a\\nmessage. Queues implement an asynchronous, point-to-point messaging pa\", \"ttern. The Producer\\nknows where a command needs to be sent and routes appropriately. The queue guara\", \"ntees that a\\nmessage is processed by exactly one of the consumer instances that are reading from the\", \" channel. In\\nthis scenario, either the producer or consumer service can scale out without affecting \", \"the other. As\\nwell, technologies can be disparate on each side, meaning that we might have a Java mi\", \"croservice\\n[calling a Golang](https://golang.org/) microservice.\\n\\n\\nIn chapter 1, we talked about _ba\", \"cking services_ . Backing services are ancillary resources upon which\\ncloud-native systems depend. M\", \"essage queues are backing services. The Azure cloud supports two\\ntypes of message queues that your c\", \"loud-native systems can consume to implement command\\nmessaging: Azure Storage Queues and Azure Servi\", \"ce Bus Queues.\\n\\n\\n**Azure Storage Queues**\\n\\n\\nAzure storage queues offer a simple queueing infrastruct\", \"ure that is fast, affordable, and backed by\\nAzure storage accounts.\\n\\n\\n[Azure Storage Queues](https:/\", \"/docs.microsoft.com/azure/storage/queues/storage-queues-introduction) feature a REST-based queuing m\", \"echanism with reliable and persistent\\nmessaging. They provide a minimal feature set, but are inexpen\", \"sive and store millions of messages.\\nTheir capacity ranges up to 500 TB. A single message can be up \", \"to 64 KB in size.\\n\\n\\nYou can access messages from anywhere in the world via authenticated calls using\", \" HTTP or HTTPS.\\nStorage queues can scale out to large numbers of concurrent clients to handle traffi\", \"c spikes.\\n\\n\\n72 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\nThat said, there are limitations wi\", \"th the service:\\n\\n\\n  - Message order isn\\u2019t guaranteed.\\n\\n\\n  - A message can only persist for seven day\", \"s before it\\u2019s automatically removed.\\n\\n\\n  - Support for state management, duplicate detection, or tra\", \"nsactions isn\\u2019t available.\\n\\n\\nFigure 4-13 shows the hierarchy of an Azure Storage Queue.\\n\\n\\n_Figure 4-\", \"13. Storage queue hierarchy_\\n\\n\\nIn the previous figure, note how storage queues store their messages \", \"in the underlying Azure Storage\\naccount.\\n\\n\\nFor developers, Microsoft provides several client and ser\", \"ver-side libraries for Storage queue\\nprocessing. Most major platforms are supported including .NET, \", \"Java, JavaScript, Ruby, Python, and\\nGo. Developers should never communicate directly with these libr\", \"aries. Doing so will tightly couple\\nyour microservice code to the Azure Storage Queue service. It\\u2019s \", \"a better practice to insulate the\\nimplementation details of the API. Introduce an intermediation lay\", \"er, or intermediate API, that exposes\\ngeneric operations and encapsulates the concrete library. This\", \" loose coupling enables you to swap out\\none queuing service for another without having to make chang\", \"es to the mainline service code.\\n\\n\\nAzure Storage queues are an economical option to implement comman\", \"d messaging in your cloudnative applications. Especially when a queue size will exceed 80 GB, or a s\", \"imple feature set is\\nacceptable. You only pay for the storage of the messages; there are no fixed ho\", \"urly charges.\\n\\n\\n**Azure Service Bus Queues**\\n\\n\\nFor more complex messaging requirements, consider Azu\", \"re Service Bus queues.\\n\\n\\n[Sitting atop a robust message infrastructure, Azure Service Bus](https://d\", \"ocs.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview) supports a _brokered m\", \"essaging model_ .\\nMessages are reliably stored in a broker (the queue) until received by the consume\", \"r. The queue\\nguarantees First-In/First-Out (FIFO) message delivery, respecting the order in which me\", \"ssages were\\nadded to the queue.\\n\\n\\nThe size of a message can be much larger, up to 256 KB. Messages a\", \"re persisted in the queue for an\\nunlimited period of time. Service Bus supports not only HTTP-based \", \"calls, but also provides full\\n\\n\\n73 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\n[support for th\", \"e AMQP protocol. AMQP is an open-standard across vendors that supports a binary](https://docs.micros\", \"oft.com/azure/service-bus-messaging/service-bus-amqp-overview)\\nprotocol and higher degrees of reliab\", \"ility.\\n\\n\\n[Service Bus provides a rich set of features, including transaction support](https://docs.m\", \"icrosoft.com/azure/service-bus-messaging/service-bus-transactions) [and a duplicate detection](https\", \"://docs.microsoft.com/azure/service-bus-messaging/duplicate-detection)\\n[feature. The queue guarantee\", \"s \\u201cat most once delivery\\u201d per message. It automatically discards a](https://docs.microsoft.com/azure\", \"/service-bus-messaging/duplicate-detection)\\nmessage that has already been sent. If a producer is in \", \"doubt, it can resend the same message, and\\nService Bus guarantees that only one copy will be process\", \"ed. Duplicate detection frees you from\\nhaving to build additional infrastructure plumbing.\\n\\n\\nTwo mor\", \"e enterprise features are partitioning and sessions. A conventional Service Bus queue is\\n[handled by\", \" a single message broker and stored in a single message store. But, Service Bus Partitioning](https:\", \"//docs.microsoft.com/azure/service-bus-messaging/service-bus-partitioning)\\nspreads the queue across \", \"multiple message brokers and message stores. The overall throughput is no\\nlonger limited by the perf\", \"ormance of a single message broker or messaging store. A temporary\\noutage of a messaging store doesn\", \"\\u2019t render a partitioned queue unavailable.\\n\\n\\n[Service Bus Sessions](https://codingcanvas.com/azure-s\", \"ervice-bus-sessions/) provide a way to group-related messages. Imagine a workflow scenario where\\nmes\", \"sages must be processed together and the operation completed at the end. To take advantage,\\nsessions\", \" must be explicitly enabled for the queue and each related messaged must contain the same\\nsession ID\", \".\\n\\n\\nHowever, there are some important caveats: Service Bus queues size is limited to 80 GB, which is\", \" much\\nsmaller than what\\u2019s available from store queues. Additionally, Service Bus queues incur a base\", \" cost\\nand charge per operation.\\n\\n\\nFigure 4-14 outlines the high-level architecture of a Service Bus \", \"queue.\\n\\n\\n_Figure 4-14. Service Bus queue_\\n\\n\\nIn the previous figure, note the point-to-point relation\", \"ship. Two instances of the same provider are\\nenqueuing messages into a single Service Bus queue. Eac\", \"h message is consumed by only one of three\\nconsumer instances on the right. Next, we discuss how to \", \"implement messaging where different\\nconsumers may all be interested the same message.\\n\\n#### **Events\", \"**\\n\\n\\nMessage queuing is an effective way to implement communication where a producer can\\nasynchronou\", \"sly send a consumer a message. However, what happens when _many different consumers_\\n\\n\\n74 CHAPTER 4 \", \"| Cloud-native communication patterns\\n\\n\\nare interested in the same message? A dedicated message queu\", \"e for each consumer wouldn\\u2019t scale\\nwell and would become difficult to manage.\\n\\n\\nTo address this scen\", \"ario, we move to the third type of message interaction, the _event_ . One\\nmicroservice announces tha\", \"t an action had occurred. Other microservices, if interested, react to the\\n[action, or event. This i\", \"s also known as the event-driven architectural style.](https://docs.microsoft.com/azure/architecture\", \"/guide/architecture-styles/event-driven)\\n\\n\\nEventing is a two-step process. For a given state change,\", \" a microservice publishes an event to a\\nmessage broker, making it available to any other interested \", \"microservice. The interested microservice\\n[is notified by subscribing to the event in the message br\", \"oker. You use the Publish/Subscribe pattern](https://docs.microsoft.com/azure/architecture/patterns/\", \"publisher-subscriber)\\n[to implement event-based communication.](https://docs.microsoft.com/dotnet/st\", \"andard/microservices-architecture/multi-container-microservice-net-applications/integration-event-ba\", \"sed-microservice-communications)\\n\\n\\nFigure 4-15 shows a shopping basket microservice publishing an ev\", \"ent with two other microservices\\nsubscribing to it.\\n\\n\\n_Figure 4-15. Event-Driven messaging_\\n\\n\\nNote t\", \"he _event bus_ component that sits in the middle of the communication channel. It\\u2019s a custom\\nclass t\", \"hat encapsulates the message broker and decouples it from the underlying application. The\\nordering a\", \"nd inventory microservices independently operate the event with no knowledge of each\\nother, nor the \", \"shopping basket microservice. When the registered event is published to the event bus,\\nthey act upon\", \" it.\\n\\n\\nWith eventing, we move from queuing technology to _topics_ [. A topic is similar to a queue, \", \"but supports](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-dotnet-how-to-use-t\", \"opics-subscriptions)\\na one-to-many messaging pattern. One microservice publishes a message. Multiple\", \" subscribing\\nmicroservices can choose to receive and act upon that message. Figure 4-16 shows a topi\", \"c\\narchitecture.\\n\\n\\n75 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\n_Figure 4-16. Topic architect\", \"ure_\\n\\n\\nIn the previous figure, publishers send messages to the topic. At the end, subscribers receiv\", \"e\\nmessages from subscriptions. In the middle, the topic forwards messages to subscriptions based on \", \"a\\nset of rules, shown in dark blue boxes. Rules act as a filter that forward specific messages to a\\n\", \"subscription. Here, a \\u201cGetPrice\\u201d event would be sent to the price and logging subscriptions as the\\nl\", \"ogging subscription has chosen to receive all messages. A \\u201cGetInformation\\u201d event would be sent to\\nth\", \"e information and logging subscriptions.\\n\\n\\nThe Azure cloud supports two different topic services: Az\", \"ure Service Bus Topics and Azure EventGrid.\\n\\n\\n**Azure Service Bus Topics**\\n\\n\\n[Sitting on top of the \", \"same robust brokered message model of Azure Service Bus queues are Azure](https://docs.microsoft.com\", \"/azure/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions)\\n[Service Bus Topics\", \". A topic can receive messages from multiple independent publishers and send](https://docs.microsoft\", \".com/azure/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions)\\nmessages to up \", \"to 2,000 subscribers. Subscriptions can be dynamically added or removed at run time\\nwithout stopping\", \" the system or recreating the topic.\\n\\n\\nMany advanced features from Azure Service Bus queues are also\", \" available for topics, including\\n[Duplicate Detection](https://docs.microsoft.com/azure/service-bus-\", \"messaging/duplicate-detection) [and Transaction support. By default, Service Bus topics are handled \", \"by a single](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-transactions)\\n[messa\", \"ge broker and stored in a single message store. But, Service Bus Partitioning](https://docs.microsof\", \"t.com/azure/service-bus-messaging/service-bus-partitioning) scales a topic by\\nspreading it across ma\", \"ny message brokers and message stores.\\n\\n\\n[Scheduled Message Delivery tags a message with a specific \", \"time for processing. The message won\\u2019t](https://docs.microsoft.com/azure/service-bus-messaging/messa\", \"ge-sequencing)\\n[appear in the topic before that time. Message Deferral](https://docs.microsoft.com/a\", \"zure/service-bus-messaging/message-deferral) enables you to defer a retrieval of a message\\nto a late\", \"r time. Both are commonly used in workflow processing scenarios where operations are\\nprocessed in a \", \"particular order. You can postpone processing of received messages until prior work\\nhas been complet\", \"ed.\\n\\n\\nService Bus topics are a robust and proven technology for enabling publish/subscribe communica\", \"tion\\nin your cloud-native systems.\\n\\n\\n**Azure Event Grid**\\n\\n\\nWhile Azure Service Bus is a battle-test\", \"ed messaging broker with a full set of enterprise features,\\n[Azure Event Grid](https://docs.microsof\", \"t.com/azure/event-grid/overview) is the new kid on the block.\\n\\n\\n76 CHAPTER 4 | Cloud-native communic\", \"ation patterns\\n\\n\\nAt first glance, Event Grid may look like just another topic-based messaging system\", \". However, it\\u2019s\\ndifferent in many ways. Focused on event-driven workloads, it enables real-time even\", \"t processing,\\ndeep Azure integration, and an open-platform - all on serverless infrastructure. It\\u2019s \", \"designed for\\ncontemporary cloud-native and serverless applications\\n\\n\\nAs a centralized _eventing back\", \"plane_, or pipe, Event Grid reacts to events inside Azure resources and\\nfrom your own services.\\n\\n\\nEv\", \"ent notifications are published to an Event Grid Topic, which, in turn, routes each event to a\\nsubsc\", \"ription. Subscribers map to subscriptions and consume the events. Like Service Bus, Event Grid\\nsuppo\", \"rts a _filtered subscriber model_ where a subscription sets rule for the events it wishes to receive\", \".\\nEvent Grid provides fast throughput with a guarantee of 10 million events per second enabling near\", \"\\nreal-time delivery - far more than what Azure Service Bus can generate.\\n\\n\\nA sweet spot for Event Gr\", \"id is its deep integration into the fabric of Azure infrastructure. An Azure\\nresource, such as Cosmo\", \"s DB, can publish built-in events directly to other interested Azure resources without the need for \", \"custom code. Event Grid can publish events from an Azure Subscription,\\nResource Group, or Service, g\", \"iving developers fine-grained control over the lifecycle of cloud\\nresources. However, Event Grid isn\", \"\\u2019t limited to Azure. It\\u2019s an open platform that can consume custom\\nHTTP events published from applic\", \"ations or third-party services and route events to external\\nsubscribers.\\n\\n\\nWhen publishing and subsc\", \"ribing to native events from Azure resources, no coding is required. With\\nsimple configuration, you \", \"can integrate events from one Azure resource to another leveraging built-in\\nplumbing for Topics and \", \"Subscriptions. Figure 4-17 shows the anatomy of Event Grid.\\n\\n\\n_Figure 4-17. Event Grid anatomy_\\n\\n\\n77\", \" CHAPTER 4 | Cloud-native communication patterns\\n\\n\\nA major difference between EventGrid and Service \", \"Bus is the underlying _message exchange pattern_ .\\n\\n\\nService Bus implements an older style _pull mod\", \"el_ in which the downstream subscriber actively polls\\nthe topic subscription for new messages. On th\", \"e upside, this approach gives the subscriber full control\\nof the pace at which it processes messages\", \". It controls when and how many messages to process at\\nany given time. Unread messages remain in the\", \" subscription until processed. A significant\\nshortcoming is the latency between the time the event i\", \"s generated and the polling operation that\\npulls that message to the subscriber for processing. Also\", \", the overhead of constant polling for the\\nnext event consumes resources and money.\\n\\n\\nEventGrid, how\", \"ever, is different. It implements a _push model_ in which events are sent to the\\nEventHandlers as re\", \"ceived, giving near real-time event delivery. It also reduces cost as the service is\\ntriggered only \", \"when it\\u2019s needed to consume an event \\u2013 not continually as with polling. That said, an\\nevent handler \", \"must handle the incoming load and provide throttling mechanisms to protect itself\\nfrom becoming over\", \"whelmed. Many Azure services that consume these events, such as Azure\\nFunctions and Logic Apps provi\", \"de automatic autoscaling capabilities to handle increased loads.\\n\\n\\nEvent Grid is a fully managed ser\", \"verless cloud service. It dynamically scales based on your traffic and\\ncharges you only for your act\", \"ual usage, not pre-purchased capacity. The first 100,000 operations per\\nmonth are free \\u2013 operations \", \"being defined as event ingress (incoming event notifications),\\nsubscription delivery attempts, manag\", \"ement calls, and filtering by subject. With 99.99% availability,\\nEventGrid guarantees the delivery o\", \"f an event within a 24-hour period, with built-in retry functionality\\nfor unsuccessful delivery. Und\", \"elivered messages can be moved to a \\u201cdead-letter\\u201d queue for resolution.\\nUnlike Azure Service Bus, Ev\", \"ent Grid is tuned for fast performance and doesn\\u2019t support features like\\nordered messaging, transact\", \"ions, and sessions.\\n\\n\\n**Streaming messages in the Azure cloud**\\n\\n\\nAzure Service Bus and Event Grid p\", \"rovide great support for applications that expose single, discrete\\nevents like a new document has be\", \"en inserted into a Cosmos DB. But, what if your cloud-native\\nsystem needs to process a _stream of re\", \"lated events_ [? Event streams](https://docs.microsoft.com/archive/msdn-magazine/2015/february/micro\", \"soft-azure-the-rise-of-event-stream-oriented-systems) are more complex. They\\u2019re typically\\ntime-order\", \"ed, interrelated, and must be processed as a group.\\n\\n\\n[Azure Event Hub](https://azure.microsoft.com/\", \"services/event-hubs/) is a data streaming platform and event ingestion service that collects, transf\", \"orms,\\nand stores events. It\\u2019s fine-tuned to capture streaming data, such as continuous event notific\", \"ations\\n[emitted from a telemetry context. The service is highly scalable and can store and process m\", \"illions of](https://docs.microsoft.com/azure/event-hubs/event-hubs-about)\\n[events per second. Shown \", \"in Figure 4-18, it\\u2019s often a front door for an event pipeline, decoupling](https://docs.microsoft.co\", \"m/azure/event-hubs/event-hubs-about)\\ningest stream from event consumption.\\n\\n\\n78 CHAPTER 4 | Cloud-na\", \"tive communication patterns\\n\\n\\n_Figure 4-18. Azure Event Hub_\\n\\n\\nEvent Hub supports low latency and co\", \"nfigurable time retention. Unlike queues and topics, Event\\nHubs keep event data after it\\u2019s been read\", \" by a consumer. This feature enables other data analytic\\nservices, both internal and external, to re\", \"play the data for further analysis. Events stored in event hub\\nare only deleted upon expiration of t\", \"he retention period, which is one day by default, but\\nconfigurable.\\n\\n\\nEvent Hub supports common even\", \"t publishing protocols including HTTPS and AMQP. It also supports\\n[Kafka 1.0. Existing Kafka applica\", \"tions can communicate with Event Hub](https://docs.microsoft.com/azure/event-hubs/event-hubs-for-kaf\", \"ka-ecosystem-overview) using the Kafka protocol\\nproviding an alternative to managing large Kafka clu\", \"sters. Many open-source cloud-native systems\\nembrace Kafka.\\n\\n\\n[Event Hubs implements message streami\", \"ng through a partitioned consumer model](https://docs.microsoft.com/azure/event-hubs/event-hubs-feat\", \"ures) in which each\\nconsumer only reads a specific subset, or partition, of the message stream. This\", \" pattern enables\\ntremendous horizontal scale for event processing and provides other stream-focused \", \"features that are\\nunavailable in queues and topics. A partition is an ordered sequence of events tha\", \"t is held in an event\\nhub. As newer events arrive, they\\u2019re added to the end of this sequence. Figure\", \" 4-19 shows partitioning\\nin an Event Hub.\\n\\n\\n_Figure 4-19. Event Hub partitioning_\\n\\n\\nInstead of readi\", \"ng from the same resource, each consumer group reads across a subset, or partition,\\nof the message s\", \"tream.\\n\\n\\n79 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\nFor cloud-native applications that mus\", \"t stream large numbers of events, Azure Event Hub can be a\\nrobust and affordable solution.\\n\\n### gRPC\", \"\\n\\n\\n[So far in this book, we\\u2019ve focused on REST-based](https://docs.microsoft.com/azure/architecture/\", \"best-practices/api-design) communication. We\\u2019ve seen that REST is a flexible\\narchitectural style tha\", \"t defines CRUD-based operations against entity resources. Clients interact with\\nresources across HTT\", \"P with a request/response communication model. While REST is widely\\nimplemented, a newer communicati\", \"on technology, gRPC, has gained tremendous momentum across\\nthe cloud-native community.\\n\\n#### **What \", \"is gRPC?**\\n\\n\\n[gRPC is a modern, high-performance framework that evolves the age-old remote procedure\", \" call (RPC)](https://en.wikipedia.org/wiki/Remote_procedure_call)\\nprotocol. At the application level\", \", gRPC streamlines messaging between clients and back-end services.\\n[Originating from Google, gRPC i\", \"s open source and part of the Cloud Native Computing Foundation](https://www.cncf.io/)\\n[(CNCF)](http\", \"s://www.cncf.io/) [ecosystem of cloud-native offerings. CNCF considers gRPC an incubating project. I\", \"ncubating](https://github.com/cncf/toc/blob/main/process/graduation_criteria.md)\\nmeans end users are\", \" using the technology in production applications, and the project has a healthy\\nnumber of contributo\", \"rs.\\n\\n\\nA typical gRPC client app will expose a local, in-process function that implements a business\\n\", \"operation. Under the covers, that local function invokes another function on a remote machine. What\\n\", \"appears to be a local call essentially becomes a transparent out-of-process call to a remote service\", \".\\nThe RPC plumbing abstracts the point-to-point networking communication, serialization, and\\nexecuti\", \"on between computers.\\n\\n\\nIn cloud-native applications, developers often work across programming langu\", \"ages, frameworks, and\\ntechnologies. This _interoperability_ complicates message contracts and the pl\", \"umbing required for\\ncross-platform communication. gRPC provides a \\u201cuniform horizontal layer\\u201d that ab\", \"stracts these\\nconcerns. Developers code in their native platform focused on business functionality, \", \"while gRPC\\nhandles communication plumbing.\\n\\n\\ngRPC offers comprehensive support across most popular d\", \"evelopment stacks, including Java,\\nJavaScript, C#, Go, Swift, and NodeJS.\\n\\n#### **gRPC Benefits**\\n\\n\\n\", \"gRPC uses HTTP/2 for its transport protocol. While compatible with HTTP 1.1, HTTP/2 features many\\nad\", \"vanced capabilities:\\n\\n\\n  - A binary framing protocol for data transport - unlike HTTP 1.1, which is \", \"text based.\\n\\n  - Multiplexing support for sending multiple parallel requests over the same connectio\", \"n - HTTP\\n1.1 limits processing to one request/response message at a time.\\n\\n  - Bidirectional full-du\", \"plex communication for sending both client requests and server responses\\nsimultaneously.\\n\\n  - Built-\", \"in streaming enabling requests and responses to asynchronously stream large data sets.\\n\\n  - Header c\", \"ompression that reduces network usage.\\n\\n\\n80 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\ngRPC i\", \"s lightweight and highly performant. It can be up to 8x faster than JSON serialization with\\n[message\", \"s 60-80% smaller. In Microsoft Windows Communication Foundation (WCF)](https://docs.microsoft.com/do\", \"tnet/framework/wcf/whats-wcf) parlance, gRPC\\n[performance exceeds the speed and efficiency of the hi\", \"ghly optimized NetTCP bindings. Unlike](https://docs.microsoft.com/dotnet/api/system.servicemodel.ne\", \"ttcpbinding?view=netframework-4.8&preserve-view=true)\\nNetTCP, which favors the Microsoft stack, gRPC\", \" is cross-platform.\\n\\n#### **Protocol Buffers**\\n\\n\\n[gRPC embraces an open-source technology called Pro\", \"tocol Buffers. They provide a highly efficient](https://developers.google.com/protocol-buffers/docs/\", \"overview)\\nand platform-neutral serialization format for serializing structured messages that service\", \"s send to\\neach other. Using a cross-platform Interface Definition Language (IDL), developers define \", \"a service\\ncontract for each microservice. The contract, implemented as a text-based .proto file, des\", \"cribes the\\nmethods, inputs, and outputs for each service. The same contract file can be used for gRP\", \"C clients and\\nservices built on different development platforms.\\n\\n\\nUsing the proto file, the Protobu\", \"f compiler, protoc, generates both client and service code for your\\ntarget platform. The code includ\", \"es the following components:\\n\\n\\n  - Strongly typed objects, shared by the client and service, that re\", \"present the service operations\\nand data elements for a message.\\n\\n  - A strongly typed base class wit\", \"h the required network plumbing that the remote gRPC service\\ncan inherit and extend.\\n\\n  - A client s\", \"tub that contains the required plumbing to invoke the remote gRPC service.\\n\\nAt run time, each messag\", \"e is serialized as a standard Protobuf representation and exchanged between\\nthe client and remote se\", \"rvice. Unlike JSON or XML, Protobuf messages are serialized as compiled\\nbinary bytes.\\n\\n\\n[The book, g\", \"RPC for WCF Developers, available from the Microsoft Architecture site, provides in-depth](https://d\", \"ocs.microsoft.com/dotnet/architecture/grpc-for-wcf-developers/)\\ncoverage of gRPC and Protocol Buffer\", \"s.\\n\\n#### **gRPC support in .NET**\\n\\n\\ngRPC is integrated into .NET Core 3.0 SDK and later. The followi\", \"ng tools support it:\\n\\n\\n  - Visual Studio 2022 with the ASP.NET and web development workload installe\", \"d\\n\\n  - Visual Studio Code\\n\\n  - The dotnet CLI\\n\\n\\nThe SDK includes tooling for endpoint routing, built\", \"-in IoC, and logging. The open-source Kestrel web\\nserver supports HTTP/2 connections. Figure 4-20 sh\", \"ows a Visual Studio 2022 template that scaffolds a\\nskeleton project for a gRPC service. Note how .NE\", \"T fully supports Windows, Linux, and macOS.\\n\\n\\n81 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\n_\", \"Figure 4-20. gRPC support in Visual Studio 2022_\\n\\n\\nFigure 4-21 shows the skeleton gRPC service gener\", \"ated from the built-in scaffolding included in\\nVisual Studio 2022.\\n\\n\\n_Figure 4-21. gRPC project in V\", \"isual Studio 2022_\\n\\n\\nIn the previous figure, note the proto description file and service code. As yo\", \"u\\u2019ll see shortly, Visual\\nStudio generates additional configuration in both the Startup class and und\", \"erlying project file.\\n\\n#### **gRPC usage**\\n\\n\\nFavor gRPC for the following scenarios:\\n\\n\\n  - Synchrono\", \"us backend microservice-to-microservice communication where an immediate\\nresponse is required to con\", \"tinue processing.\\n\\n  - Polyglot environments that need to support mixed programming platforms.\\n\\n  - \", \"Low latency and high throughput communication where performance is critical.\\n\\n  - Point-to-point rea\", \"l-time communication - gRPC can push messages in real time without\\npolling and has excellent support\", \" for bi-directional streaming.\\n\\n\\n82 CHAPTER 4 | Cloud-native communication patterns\\n\\n\\n  - Network co\", \"nstrained environments \\u2013 binary gRPC messages are always smaller than an\\nequivalent text-based JSON \", \"message.\\n\\n\\nAt the time, of this writing, gRPC is primarily used with backend services. Modern browse\", \"rs can\\u2019t\\nprovide the level of HTTP/2 control required to support a front-end gRPC client. That said,\", \" there\\u2019s\\n[support for gRPC-Web with .NET that enables gRPC communication from browser-based apps bui\", \"lt](https://devblogs.microsoft.com/aspnet/grpc-web-for-net-now-available/)\\n[with JavaScript or Blazo\", \"r WebAssembly technologies. gRPC-Web](https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-WEB.md) \", \"enables an ASP.NET Core gRPC app\\nto support gRPC features in browser apps:\\n\\n\\n  - Strongly typed, cod\", \"e-generated clients\\n\\n  - Compact Protobuf messages\\n\\n  - Server streaming\\n\\n#### **gRPC implementation\", \"**\\n\\n\\n[The microservice reference architecture, eShop on Containers, from Microsoft, shows how to](ht\", \"tps://github.com/dotnet-architecture/eShopOnContainers)\\nimplement gRPC services in .NET applications\", \". Figure 4-22 presents the back-end architecture.\\n\\n\\n_Figure 4-22. Backend architecture for eShop on \", \"Containers_\\n\\n\\n[In the previous figure, note how eShop embraces the Backend for Frontends pattern](ht\", \"tps://docs.microsoft.com/azure/architecture/patterns/backends-for-frontends) (BFF) by\\nexposing multi\", \"ple API gateways. We discussed the BFF pattern earlier in this chapter. Pay close\\n\\n\\n83 CHAPTER 4 | C\", \"loud-native communication patterns\\n\\n\\nattention to the Aggregator microservice (in gray) that sits be\", \"tween the Web-Shopping API Gateway\\nand backend Shopping microservices. The Aggregator receives a sin\", \"gle request from a client,\\ndispatches it to various microservices, aggregates the results, and sends\", \" them back to the requesting\\nclient. Such operations typically require synchronous communication as \", \"to produce an immediate\\nresponse. In eShop, backend calls from the Aggregator are performed using gR\", \"PC as shown in Figure\\n4-23.\\n\\n\\n_Figure 4-23. gRPC in eShop on Containers_\\n\\n\\ngRPC communication requir\", \"es both client and server components. In the previous figure, note how\\nthe Shopping Aggregator imple\", \"ments a gRPC client. The client makes synchronous gRPC calls (in red)\\nto backend microservices, each\", \" of which implement a gRPC server. Both the client and server take\\nadvantage of the built-in gRPC pl\", \"umbing from the .NET SDK. Client-side _stubs_ provide the plumbing\\nto invoke remote gRPC calls. Serv\", \"er-side components provide gRPC plumbing that custom service\\nclasses can inherit and consume.\\n\\n\\nMicr\", \"oservices that expose both a RESTful API and gRPC communication require multiple endpoints to\\nmanage\", \" traffic. You would open an endpoint that listens for HTTP traffic for the RESTful calls and\\nanother\", \" for gRPC calls. The gRPC endpoint must be configured for the HTTP/2 protocol that is\\nrequired for g\", \"RPC communication.\\n\\n\\nWhile we strive to decouple microservices with asynchronous communication patte\", \"rns, some\\noperations require direct calls. gRPC should be the primary choice for direct synchronous\\n\", \"communication between microservices. Its high-performance communication protocol, based on\\nHTTP/2 an\", \"d protocol buffers, make it a perfect choice.\\n\\n\\n84 CHAPTER 4 | Cloud-native communication patterns\\n\\n\", \"\\n#### **Looking ahead**\\n\\nLooking ahead, gRPC will continue to gain traction for cloud-native systems\", \". The performance\\nbenefits and ease of development are compelling. However, REST will likely be arou\", \"nd for a long time.\\nIt excels for publicly exposed APIs and for backward compatibility reasons.\\n\\n###\", \" Service Mesh communication infrastructure\\n\\n\\nThroughout this chapter, we\\u2019ve explored the challenges \", \"of microservice communication. We said that\\ndevelopment teams need to be sensitive to how back-end s\", \"ervices communicate with each other.\\nIdeally, the less inter-service communication, the better. Howe\", \"ver, avoidance isn\\u2019t always possible as\\nback-end services often rely on one another to complete oper\", \"ations.\\n\\n\\nWe explored different approaches for implementing synchronous HTTP communication and\\nasync\", \"hronous messaging. In each of the cases, the developer is burdened with implementing\\ncommunication c\", \"ode. Communication code is complex and time intensive. Incorrect decisions can\\nlead to significant p\", \"erformance issues.\\n\\n\\nA more modern approach to microservice communication centers around a new and r\", \"apidly evolving\\ntechnology entitled _Service Mesh_ [. A service mesh](https://www.nginx.com/blog/wha\", \"t-is-a-service-mesh/) is a configurable infrastructure layer with built-in\\ncapabilities to handle se\", \"rvice-to-service communication, resiliency, and many cross-cutting concerns.\\nIt moves the responsibi\", \"lity for these concerns out of the microservices and into service mesh layer.\\nCommunication is abstr\", \"acted away from your microservices.\\n\\n\\nA key component of a service mesh is a proxy. In a cloud-nativ\", \"e application, an instance of a proxy is\\ntypically colocated with each microservice. While they exec\", \"ute in separate processes, the two are\\n[closely linked and share the same lifecycle. This pattern, k\", \"nown as the Sidecar pattern, and is shown in](https://docs.microsoft.com/azure/architecture/patterns\", \"/sidecar)\\nFigure 4-24.\\n\\n\\n_Figure 4-24. Service mesh with a side car_\\n\\n\\n85 CHAPTER 4 | Cloud-native c\", \"ommunication patterns\\n\\n\\nNote in the previous figure how messages are intercepted by a proxy that run\", \"s alongside each\\nmicroservice. Each proxy can be configured with traffic rules specific to the micro\", \"service. It\\nunderstands messages and can route them across your services and the outside world.\\n\\n\\nAl\", \"ong with managing service-to-service communication, the Service Mesh provides support for\\nservice di\", \"scovery and load balancing.\\n\\n\\nOnce configured, a service mesh is highly functional. The mesh retriev\", \"es a corresponding pool of\\ninstances from a service discovery endpoint. It sends a request to a spec\", \"ific service instance, recording\\nthe latency and response type of the result. It chooses the instanc\", \"e most likely to return a fast\\nresponse based on different factors, including the observed latency f\", \"or recent requests.\\n\\n\\nA service mesh manages traffic, communication, and networking concerns at the \", \"application level. It\\nunderstands messages and requests. A service mesh typically integrates with a \", \"container orchestrator.\\nKubernetes supports an extensible architecture in which a service mesh can b\", \"e added.\\n\\n\\nIn chapter 6, we deep-dive into Service Mesh technologies including a discussion on its a\", \"rchitecture\\nand available open-source implementations.\\n\\n#### **Summary**\\n\\n\\nIn this chapter, we discu\", \"ssed cloud-native communication patterns. We started by examining how\\nfront-end clients communicate \", \"with back-end microservices. Along the way, we talked about API\\nGateway platforms and real-time comm\", \"unication. We then looked at how microservices communicate\\nwith other back-end services. We looked a\", \"t both synchronous HTTP communication and\\nasynchronous messaging across services. We covered gRPC, a\", \"n upcoming technology in the cloudnative world. Finally, we introduced a new and rapidly evolving te\", \"chnology entitled Service Mesh that\\ncan streamline microservice communication.\\n\\n\\nSpecial emphasis wa\", \"s on managed Azure services that can help implement communication in cloudnative systems:\\n\\n\\n  - [Azu\", \"re Application Gateway](https://docs.microsoft.com/azure/application-gateway/overview)\\n\\n  - [Azure A\", \"PI Management](https://azure.microsoft.com/services/api-management/)\\n\\n  - [Azure SignalR Service](ht\", \"tps://azure.microsoft.com/services/signalr-service/)\\n\\n  - [Azure Storage Queues](https://docs.micros\", \"oft.com/azure/storage/queues/storage-queues-introduction)\\n\\n  - [Azure Service Bus](https://docs.micr\", \"osoft.com/azure/service-bus-messaging/service-bus-messaging-overview)\\n\\n  - [Azure Event Grid](https:\", \"//docs.microsoft.com/azure/event-grid/overview)\\n\\n  - [Azure Event Hub](https://azure.microsoft.com/s\", \"ervices/event-hubs/)\\n\\n\\nWe next move to distributed data in cloud-native systems and the benefits and\", \" challenges that it\\npresents.\\n\\n\\n**References**\\n\\n\\n  - [.NET Microservices: Architecture for Container\", \"ized .NET applications](https://dotnet.microsoft.com/download/thank-you/microservices-architecture-e\", \"book)\\n\\n\\n  - [Designing Interservice Communication for Microservices](https://docs.microsoft.com/azur\", \"e/architecture/microservices/design/interservice-communication)\\n\\n\\n  - [Azure SignalR Service, a full\", \"y managed service to add real-time functionality](https://azure.microsoft.com/blog/azure-signalr-ser\", \"vice-a-fully-managed-service-to-add-real-time-functionality/)\\n\\n\\n86 CHAPTER 4 | Cloud-native communic\", \"ation patterns\\n\\n\\n  - [Azure API Gateway Ingress Controller](https://azure.github.io/application-gate\", \"way-kubernetes-ingress/)\\n\\n\\n  - [gRPC Documentation](https://grpc.io/docs/guides/)\\n\\n\\n  - [gRPC for WC\", \"F Developers](https://docs.microsoft.com/dotnet/architecture/grpc-for-wcf-developers/)\\n\\n\\n  - [Compar\", \"ing gRPC Services with HTTP APIs](https://docs.microsoft.com/aspnet/core/grpc/comparison?view=aspnet\", \"core-3.0&preserve-view=false)\\n\\n\\n  - [Building gRPC Services with .NET video](https://docs.microsoft.\", \"com/Shows/The-Cloud-Native-Show/Building-Microservices-with-gRPC-and-NET)\\n\\n\\n87 CHAPTER 4 | Cloud-nat\", \"ive communication patterns\\n\\n\\n**CHAPTER**\\n# 5\\n\\n## Cloud-native data patterns\\n\\n\\nAs we\\u2019ve seen througho\", \"ut this book, a cloud-native approach changes the way you design, deploy,\\nand manage applications. I\", \"t also changes the way you manage and store data.\\n\\n\\nFigure 5-1 contrasts the differences.\\n\\n\\n_Figure \", \"5-1. Data management in cloud-native applications_\\n\\n\\nExperienced developers will easily recognize th\", \"e architecture on the left-side of figure 5-1. In this\\n_monolithic application_, business service co\", \"mponents collocate together in a shared services tier,\\nsharing data from a single relational databas\", \"e.\\n\\n\\nIn many ways, a single database keeps data management simple. Querying data across multiple tab\", \"les\\n[is straightforward. Changes to data update together or they all rollback. ACID transactions gua\", \"rantee](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties)\\nstrong and immediate cons\", \"istency.\\n\\n\\nDesigning for cloud-native, we take a different approach. On the right-side of Figure 5-1\", \", note how\\nbusiness functionality segregates into small, independent microservices. Each microservic\", \"e\\nencapsulates a specific business capability and its own data. The monolithic database decomposes\\n\\n\", \"\\n88 CHAPTER 5 | Cloud-native data patterns\\n\\n\\ninto a distributed data model with many smaller databas\", \"es, each aligning with a microservice. When\\nthe smoke clears, we emerge with a design that exposes a\", \" _database per microservice_ .\\n\\n### Database-per-microservice, why?\\n\\n\\nThis database per microservice\", \" provides many benefits, especially for systems that must evolve rapidly\\nand support massive scale. \", \"With this model\\u2026\\n\\n\\n  - Domain data is encapsulated within the service\\n\\n  - Data schema can evolve wi\", \"thout directly impacting other services\\n\\n  - Each data store can independently scale\\n\\n  - A data sto\", \"re failure in one service won\\u2019t directly impact other services\\n\\n\\nSegregating data also enables each \", \"microservice to implement the data store type that is best\\noptimized for its workload, storage needs\", \", and read/write patterns. Choices include relational,\\ndocument, key-value, and even graph-based dat\", \"a stores.\\n\\n\\nFigure 5-2 presents the principle of polyglot persistence in a cloud-native system.\\n\\n\\n_F\", \"igure 5-2. Polyglot data persistence_\\n\\n\\nNote in the previous figure how each microservice supports a\", \" different type of data store.\\n\\n\\n  - The product catalog microservice consumes a relational database\", \" to accommodate the rich\\nrelational structure of its underlying data.\\n\\n  - The shopping cart microse\", \"rvice consumes a distributed cache that supports its simple, keyvalue data store.\\n\\n  - The ordering \", \"microservice consumes both a NoSql document database for write operations\\nalong with a highly denorm\", \"alized key/value store to accommodate high-volumes of read\\noperations.\\n\\n\\n89 CHAPTER 5 | Cloud-native\", \" data patterns\\n\\n\\nWhile relational databases remain relevant for microservices with complex data, NoS\", \"QL databases\\nhave gained considerable popularity. They provide massive scale and high availability. \", \"Their\\nschemaless nature allows developers to move away from an architecture of typed data classes an\", \"d\\nORMs that make change expensive and time-consuming. We cover NoSQL databases later in this\\nchapter\", \".\\n\\n\\nWhile encapsulating data into separate microservices can increase agility, performance, and scal\", \"ability,\\nit also presents many challenges. In the next section, we discuss these challenges along wi\", \"th patterns\\nand practices to help overcome them.\\n\\n### Cross-service queries\\n\\n\\nWhile microservices ar\", \"e independent and focus on specific functional capabilities, like inventory,\\nshipping, or ordering, \", \"they frequently require integration with other microservices. Often the\\nintegration involves one mic\", \"roservice _querying_ another for data. Figure 5-3 shows the scenario.\\n\\n\\n_Figure 5-3. Querying across\", \" microservices_\\n\\n\\nIn the preceding figure, we see a shopping basket microservice that adds an item t\", \"o a user\\u2019s shopping\\nbasket. While the data store for this microservice contains basket and line item\", \" data, it doesn\\u2019t\\nmaintain product or pricing data. Instead, those data items are owned by the catal\", \"og and pricing\\nmicroservices. This aspect presents a problem. How can the shopping basket microservi\", \"ce add a\\nproduct to the user\\u2019s shopping basket when it doesn\\u2019t have product nor pricing data in its \", \"database?\\n\\n\\nOne option discussed in Chapter 4 is a direct HTTP call from the shopping basket to the \", \"catalog and\\npricing microservices. However, in chapter 4, we said synchronous HTTP calls _couple_ mi\", \"croservices\\ntogether, reducing their autonomy and diminishing their architectural benefits.\\n\\n\\nWe cou\", \"ld also implement a request-reply pattern with separate inbound and outbound queues for\\neach service\", \". However, this pattern is complicated and requires plumbing to correlate request and\\nresponse messa\", \"ges. While it does decouple the backend microservice calls, the calling service must\\nstill synchrono\", \"usly wait for the call to complete. Network congestion, transient faults, or an\\noverloaded microserv\", \"ice and can result in long-running and even failed operations.\\n\\n\\n90 CHAPTER 5 | Cloud-native data pa\", \"tterns\\n\\n\\n[Instead, a widely accepted pattern for removing cross-service dependencies is the Material\", \"ized View](https://docs.microsoft.com/azure/architecture/patterns/materialized-view)\\n[Pattern, shown\", \" in Figure 5-4.](https://docs.microsoft.com/azure/architecture/patterns/materialized-view)\\n\\n\\n_Figure\", \" 5-4. Materialized View Pattern_\\n\\n\\nWith this pattern, you place a local data table (known as a _read\", \" model_ ) in the shopping basket service.\\nThis table contains a denormalized copy of the data needed\", \" from the product and pricing\\nmicroservices. Copying the data directly into the shopping basket micr\", \"oservice eliminates the need for\\nexpensive cross-service calls. With the data local to the service, \", \"you improve the service\\u2019s response\\ntime and reliability. Additionally, having its own copy of the da\", \"ta makes the shopping basket service\\nmore resilient. If the catalog service should become unavailabl\", \"e, it wouldn\\u2019t directly impact the\\nshopping basket service. The shopping basket can continue operati\", \"ng with the data from its own\\nstore.\\n\\n\\nThe catch with this approach is that you now have duplicate d\", \"ata in your system. However,\\n_strategically_ duplicating data in cloud-native systems is an establis\", \"hed practice and not considered an\\nanti-pattern, or bad practice. Keep in mind that _one and only on\", \"e service_ can own a data set and have\\nauthority over it. You\\u2019ll need to synchronize the read models\", \" when the system of record is updated.\\nSynchronization is typically implemented via asynchronous mes\", \"saging with a publish/subscribe\\npattern, as shown in Figure 5.4.\\n\\n### Distributed transactions\\n\\n\\nWhi\", \"le querying data across microservices is difficult, implementing a transaction across several\\nmicros\", \"ervices is even more complex. The inherent challenge of maintaining data consistency across\\nindepend\", \"ent data sources in different microservices can\\u2019t be understated. The lack of distributed\\ntransactio\", \"ns in cloud-native applications means that you must manage distributed transactions\\nprogrammatically\", \". You move from a world of _immediate consistency_ to that of _eventual consistency_ .\\n\\n\\nFigure 5-5 \", \"shows the problem.\\n\\n\\n91 CHAPTER 5 | Cloud-native data patterns\\n\\n\\n_Figure 5-5. Implementing a transac\", \"tion across microservices_\\n\\n\\nIn the preceding figure, five independent microservices participate in \", \"a distributed transaction that\\ncreates an order. Each microservice maintains its own data store and \", \"implements a local transaction\\nfor its store. To create the order, the local transaction for _each_ \", \"individual microservice must succeed,\\nor _all_ must abort and roll back the operation. While built-i\", \"n transactional support is available inside\\neach of the microservices, there\\u2019s no support for a dist\", \"ributed transaction that would span across all\\nfive services to keep data consistent.\\n\\n\\nInstead, you\", \" must construct this distributed transaction _programmatically_ .\\n\\n\\nA popular pattern for adding dis\", \"tributed transactional support is the Saga pattern. It\\u2019s implemented\\nby grouping local transactions \", \"together programmatically and sequentially invoking each one. If any\\n[of the local transactions fail\", \", the Saga aborts the operation and invokes a set of compensating](https://docs.microsoft.com/azure/\", \"architecture/patterns/compensating-transaction)\\n[transactions. The compensating transactions undo th\", \"e changes made by the preceding local](https://docs.microsoft.com/azure/architecture/patterns/compen\", \"sating-transaction)\\ntransactions and restore data consistency. Figure 5-6 shows a failed transaction\", \" with the Saga pattern.\\n\\n\\n_Figure 5-6. Rolling back a transaction_\\n\\n\\n92 CHAPTER 5 | Cloud-native dat\", \"a patterns\\n\\n\\nIn the previous figure, the _Update Inventory_ operation has failed in the Inventory mi\", \"croservice. The\\nSaga invokes a set of compensating transactions (in red) to adjust the inventory cou\", \"nts, cancel the\\npayment and the order, and return the data for each microservice back to a consisten\", \"t state.\\n\\n\\nSaga patterns are typically choreographed as a series of related events, or orchestrated \", \"as a set of\\nrelated commands. In Chapter 4, we discussed the service aggregator pattern that would b\", \"e the\\nfoundation for an orchestrated saga implementation. We also discussed eventing along with Azur\", \"e\\nService Bus and Azure Event Grid topics that would be a foundation for a choreographed saga\\nimplem\", \"entation.\\n\\n### High volume data\\n\\n\\nLarge cloud-native applications often support high-volume data req\", \"uirements. In these scenarios,\\ntraditional data storage techniques can cause bottlenecks. For comple\", \"x systems that deploy on a large\\nscale, both Command and Query Responsibility Segregation (CQRS) and\", \" Event Sourcing may improve\\napplication performance.\\n\\n#### **CQRS**\\n\\n\\n[CQRS, is an architectural pat\", \"tern that can help maximize performance, scalability, and security. The](https://docs.microsoft.com/\", \"azure/architecture/patterns/cqrs)\\npattern separates operations that read data from those operations \", \"that write data.\\n\\n\\nFor normal scenarios, the same entity model and data repository object are used f\", \"or _both_ read and\\nwrite operations.\\n\\n\\nHowever, a high volume data scenario can benefit from separat\", \"e models and data tables for reads\\nand writes. To improve performance, the read operation could quer\", \"y against a highly denormalized\\nrepresentation of the data to avoid expensive repetitive table joins\", \" and table locks. The _write_\\noperation, known as a _command_, would update against a fully normaliz\", \"ed representation of the data\\nthat would guarantee consistency. You then need to implement a mechani\", \"sm to keep both\\nrepresentations in sync. Typically, whenever the write table is modified, it publish\", \"es an event that\\nreplicates the modification to the read table.\\n\\n\\nFigure 5-7 shows an implementation\", \" of the CQRS pattern.\\n\\n\\n_Figure 5-7. CQRS implementation_\\n\\n\\n93 CHAPTER 5 | Cloud-native data pattern\", \"s\\n\\n\\nIn the previous figure, separate command and query models are implemented. Each data write\\nopera\", \"tion is saved to the write store and then propagated to the read store. Pay close attention to\\n[how \", \"the data propagation process operates on the principle of eventual consistency. The read model](http\", \"s://www.cloudcomputingpatterns.org/eventual_consistency/)\\neventually synchronizes with the write mod\", \"el, but there may be some lag in the process. We discuss\\neventual consistency in the next section.\\n\\n\", \"\\nThis separation enables reads and writes to scale independently. Read operations use a schema\\noptim\", \"ized for queries, while the writes use a schema optimized for updates. Read queries go against\\ndenor\", \"malized data, while complex business logic can be applied to the write model. As well, you\\nmight imp\", \"ose tighter security on write operations than those exposing reads.\\n\\n\\nImplementing CQRS can improve \", \"application performance for cloud-native services. However, it does\\nresult in a more complex design.\", \" Apply this principle carefully and strategically to those sections of\\n[your cloud-native applicatio\", \"n that will benefit from it. For more on CQRS, see the Microsoft book .NET](https://docs.microsoft.c\", \"om/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cq\", \"rs-ddd-patterns)\\n[Microservices: Architecture for Containerized .NET Applications.](https://docs.mic\", \"rosoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microse\", \"rvice-cqrs-ddd-patterns)\\n\\n#### **Event sourcing**\\n\\n\\n[Another approach to optimizing high volume data\", \" scenarios involves Event Sourcing.](https://docs.microsoft.com/azure/architecture/patterns/event-so\", \"urcing)\\n\\n\\nA system typically stores the current state of a data entity. If a user changes their phon\", \"e number, for\\nexample, the customer record is updated with the new number. We always know the curren\", \"t state of a\\ndata entity, but each update overwrites the previous state.\\n\\n\\nIn most cases, this model\", \" works fine. In high volume systems, however, overhead from transactional\\nlocking and frequent updat\", \"e operations can impact database performance, responsiveness, and limit\\nscalability.\\n\\n\\nEvent Sourcin\", \"g takes a different approach to capturing data. Each operation that affects data is\\npersisted to an \", \"event store. Instead of updating the state of a data record, we append each change to\\na sequential l\", \"ist of past events - similar to an accountant\\u2019s ledger. The Event Store becomes the\\nsystem of record\", \" for the data. It\\u2019s used to propagate various materialized views within the bounded\\ncontext of a mic\", \"roservice. Figure 5.8 shows the pattern.\\n\\n\\n94 CHAPTER 5 | Cloud-native data patterns\\n\\n\\n_Figure 5-8. \", \"Event Sourcing_\\n\\n\\nIn the previous figure, note how each entry (in blue) for a user\\u2019s shopping cart i\", \"s appended to an\\nunderlying event store. In the adjoining materialized view, the system projects the\", \" current state by\\nreplaying all the events associated with each shopping cart. This view, or read mo\", \"del, is then exposed\\nback to the UI. Events can also be integrated with external systems and applica\", \"tions or queried to\\ndetermine the current state of an entity. With this approach, you maintain histo\", \"ry. You know not only\\nthe current state of an entity, but also how you reached this state.\\n\\n\\nMechani\", \"cally speaking, event sourcing simplifies the write model. There are no updates or deletes.\\nAppendin\", \"g each data entry as an immutable event minimizes contention, locking, and concurrency\\nconflicts ass\", \"ociated with relational databases. Building read models with the materialized view pattern\\nenables y\", \"ou to decouple the view from the write model and choose the best data store to optimize\\nthe needs of\", \" your application UI.\\n\\n\\nFor this pattern, consider a data store that directly supports event sourcin\", \"g. Azure Cosmos DB,\\nMongoDB, Cassandra, CouchDB, and RavenDB are good candidates.\\n\\n\\nAs with all patt\", \"erns and technologies, implement strategically and when needed. While event sourcing\\ncan provide inc\", \"reased performance and scalability, it comes at the expense of complexity and a\\nlearning curve.\\n\\n\\n95\", \" CHAPTER 5 | Cloud-native data patterns\\n\\n\\n### Relational vs. NoSQL data\\n\\nRelational and NoSQL are tw\", \"o types of database systems commonly implemented in cloud-native\\napps. They\\u2019re built differently, st\", \"ore data differently, and accessed differently. In this section, we\\u2019ll look\\nat both. Later in this c\", \"hapter, we\\u2019ll look at an emerging database technology called _NewSQL_ .\\n\\n\\n_Relational databases_ hav\", \"e been a prevalent technology for decades. They\\u2019re mature, proven, and\\nwidely implemented. Competing\", \" database products, tooling, and expertise abound. Relational\\ndatabases provide a store of related d\", \"ata tables. These tables have a fixed schema, use SQL\\n(Structured Query Language) to manage data, an\", \"d support ACID guarantees.\\n\\n\\n_No-SQL databases_ refer to high-performance, non-relational data store\", \"s. They excel in their ease-ofuse, scalability, resilience, and availability characteristics. Instea\", \"d of joining tables of normalized data,\\nNoSQL stores unstructured or semi-structured data, often in \", \"key-value pairs or JSON documents. NoSQL databases typically don\\u2019t provide ACID guarantees beyond th\", \"e scope of a single database\\npartition. High volume services that require sub second response time f\", \"avor NoSQL datastores.\\n\\n\\n[The impact of NoSQL technologies for distributed cloud-native systems can\\u2019\", \"t be overstated. The](https://www.geeksforgeeks.org/introduction-to-nosql/)\\nproliferation of new dat\", \"a technologies in this space has disrupted solutions that once exclusively\\nrelied on relational data\", \"bases.\\n\\n\\nNoSQL databases include several different models for accessing and managing data, each suit\", \"ed to\\nspecific use cases. Figure 5-9 presents four common models.\\n\\n\\n_Figure 5-9: Data models for NoS\", \"QL databases_\\n\\n|Model|Characteristics|\\n|---|---|\\n|Document Store|Data and metadata are stored hierar\", \"chically in<br>JSON-based documents inside the database.|\\n|Key Value Store|The simplest of the NoSQL\", \" databases, data is<br>represented as a collection of key-value pairs.|\\n|Wide-Column Store|Related d\", \"ata is stored as a set of nested-<br>key/value pairs within a single column.|\\n|Graph Store|Data is s\", \"tored in a graph structure as node,<br>edge, and data properties.|\\n\\n\\n\\n96 CHAPTER 5 | Cloud-native da\", \"ta patterns\\n\\n\\n#### **The CAP theorem**\\n\\nAs a way to understand the differences between these types o\", \"f databases, consider the CAP theorem,\\na set of principles applied to distributed systems that store\", \" state. Figure 5-10 shows the three\\nproperties of the CAP theorem.\\n\\n\\n_Figure 5-10. The CAP theorem_\\n\", \"\\n\\nThe theorem states that distributed data systems will offer a trade-off between consistency,\\navail\", \"ability, and partition tolerance. And, that any database can only guarantee _two_ of the three\\nprope\", \"rties:\\n\\n\\n  - _Consistency._ Every node in the cluster responds with the most recent data, even if th\", \"e system\\nmust block the request until all replicas update. If you query a \\u201cconsistent system\\u201d for an\", \" item\\nthat is currently updating, you\\u2019ll wait for that response until all replicas successfully upda\", \"te.\\nHowever, you\\u2019ll receive the most current data.\\n\\n\\n  - _Availability._ Every node returns an immed\", \"iate response, even if that response isn\\u2019t the most\\nrecent data. If you query an \\u201cavailable system\\u201d \", \"for an item that is updating, you\\u2019ll get the best\\npossible answer the service can provide at that mo\", \"ment.\\n\\n\\n  - _Partition Tolerance._ Guarantees the system continues to operate even if a replicated d\", \"ata\\nnode fails or loses connectivity with other replicated data nodes.\\n\\n\\nCAP theorem explains the tr\", \"adeoffs associated with managing consistency and availability during a\\nnetwork partition; however tr\", \"adeoffs with respect to consistency and performance also exist with the\\n[absence of a network partit\", \"ion. CAP theorem is often further extended to PACELC](http://www.cs.umd.edu/~abadi/papers/abadi-pace\", \"lc.pdf) to explain the\\ntradeoffs more comprehensively.\\n\\n\\nRelational databases typically provide cons\", \"istency and availability, but not partition tolerance. They\\u2019re\\ntypically provisioned to a single ser\", \"ver and scale vertically by adding more resources to the machine.\\n\\n\\n97 CHAPTER 5 | Cloud-native data\", \" patterns\\n\\n\\nMany relational database systems support built-in replication features where copies of t\", \"he primary\\ndatabase can be made to other secondary server instances. Write operations are made to th\", \"e primary\\ninstance and replicated to each of the secondaries. Upon a failure, the primary instance c\", \"an fail over\\nto a secondary to provide high availability. Secondaries can also be used to distribute\", \" read operations.\\nWhile writes operations always go against the primary replica, read operations can\", \" be routed to any of\\nthe secondaries to reduce system load.\\n\\n\\n[Data can also be horizontally partiti\", \"oned across multiple nodes, such as with sharding. But, sharding](https://docs.microsoft.com/azure/s\", \"ql-database/sql-database-elastic-scale-introduction)\\ndramatically increases operational overhead by \", \"spitting data across many pieces that cannot easily\\ncommunicate. It can be costly and time consuming\", \" to manage. Relational features that include table\\njoins, transactions, and referential integrity re\", \"quire steep performance penalties in sharded\\ndeployments.\\n\\n\\nReplication consistency and recovery poi\", \"nt objectives can be tuned by configuring whether replication\\noccurs synchronously or asynchronously\", \". If data replicas were to lose network connectivity in a \\u201chighly\\nconsistent\\u201d or synchronous relatio\", \"nal database cluster, you wouldn\\u2019t be able to write to the database.\\nThe system would reject the wri\", \"te operation as it can\\u2019t replicate that change to the other data replica.\\nEvery data replica has to \", \"update before the transaction can complete.\\n\\n\\nNoSQL databases typically support high availability an\", \"d partition tolerance. They scale out\\nhorizontally, often across commodity servers. This approach pr\", \"ovides tremendous availability, both\\nwithin and across geographical regions at a reduced cost. You p\", \"artition and replicate data across\\nthese machines, or nodes, providing redundancy and fault toleranc\", \"e. Consistency is typically tuned\\nthrough consensus protocols or quorum mechanisms. They provide mor\", \"e control when navigating\\ntradeoffs between tuning synchronous versus asynchronous replication in re\", \"lational systems.\\n\\n\\nIf data replicas were to lose connectivity in a \\u201chighly available\\u201d NoSQL databas\", \"e cluster, you could still\\ncomplete a write operation to the database. The database cluster would al\", \"low the write operation and\\nupdate each data replica as it becomes available. NoSQL databases that s\", \"upport multiple writable\\nreplicas can further strengthen high availability by avoiding the need for \", \"failover when optimizing\\nrecovery time objective.\\n\\n\\nModern NoSQL databases typically implement parti\", \"tioning capabilities as a feature of their system\\ndesign. Partition management is often built-in to \", \"the database, and routing is achieved through\\nplacement hints - often called partition keys. A flexi\", \"ble data models enables the NoSQL databases to\\nlower the burden of schema management and improve ava\", \"ilability when deploying application\\nupdates that require data model changes.\\n\\n\\nHigh availability an\", \"d massive scalability are often more critical to the business than relational table\\njoins and refere\", \"ntial integrity. Developers can implement techniques and patterns such as Sagas,\\nCQRS, and asynchron\", \"ous messaging to embrace eventual consistency.\\n\\n\\nNowadays, care must be taken when considering the C\", \"AP theorem constraints. A new type of\\ndatabase, called NewSQL, has emerged which extends the relatio\", \"nal database engine to support both\\nhorizontal scalability and the scalable performance of NoSQL sys\", \"tems.\\n\\n\\n98 CHAPTER 5 | Cloud-native data patterns\\n\\n\\n#### **Considerations for relational vs. NoSQL s\", \"ystems**\\n\\nBased upon specific data requirements, a cloud-native-based microservice can implement a r\", \"elational,\\nNoSQL datastore or both.\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n|Consider a NoSQL datastore when:|Consider a relatio\", \"nal database when:|\\n|---|---|\\n|You have high volume workloads that require<br>predictable latency at\", \" large scale (for example,<br>latency measured in milliseconds while<br>performing millions of trans\", \"actions per second)|Your workload volume generally fits within<br>thousands of transactions per seco\", \"nd|\\n|Your data is dynamic and frequently changes|Your data is highly structured and requires<br>refe\", \"rential integrity|\\n|Relationships can be de-normalized data<br>models|Relationships are expressed th\", \"rough table joins<br>on normalized data models|\\n|Data retrieval is simple and expressed without<br>t\", \"able joins|You work with complex queries and reports|\\n|Data is typically replicated across geographi\", \"es<br>and requires finer control over consistency,<br>availability, and performance|Data is typicall\", \"y centralized, or can be replicated<br>regions asynchronously|\\n|Your application will be deployed to\", \" commodity<br>hardware, such as with public clouds|Your application will be deployed to large, high-\", \"<br>end hardware|\\n\\n\\n\\nIn the next sections, we\\u2019ll explore the options available in the Azure cloud fo\", \"r storing and managing\\nyour cloud-native data.\\n\\n#### **Database as a Service**\\n\\n\\nTo start, you could\", \" provision an Azure virtual machine and install your database of choice for each\\nservice. While you\\u2019\", \"d have full control over the environment, you\\u2019d forgo many built-in features of the\\ncloud platform. \", \"You\\u2019d also be responsible for managing the virtual machine and database for each\\nservice. This appro\", \"ach could quickly become time-consuming and expensive.\\n\\n\\nInstead, cloud-native applications favor da\", \"ta services exposed as a Database as a Service (DBaaS).\\nFully managed by a cloud vendor, these servi\", \"ces provide built-in security, scalability, and monitoring.\\nInstead of owning the service, you simpl\", \"y consume it as a backing service. The provider operates the\\nresource at scale and bears the respons\", \"ibility for performance and maintenance.\\n\\n\\nThey can be configured across cloud availability zones an\", \"d regions to achieve high availability. They\\nall support just-in-time capacity and a pay-as-you-go m\", \"odel. Azure features different kinds of\\nmanaged data service options, each with specific benefits.\\n\\n\", \"\\nWe\\u2019ll first look at relational DBaaS services available in Azure. You\\u2019ll see that Microsoft\\u2019s flags\", \"hip SQL\\nServer database is available along with several open-source options. Then, we\\u2019ll talk about \", \"the NoSQL\\ndata services in Azure.\\n\\n\\n99 CHAPTER 5 | Cloud-native data patterns\\n\\n\\n#### **Azure relatio\", \"nal databases**\\n\\nFor cloud-native microservices that require relational data, Azure offers four mana\", \"ged relational\\ndatabases as a service (DBaaS) offerings, shown in Figure 5-11.\\n\\n\\n_Figure 5-11. Manag\", \"ed relational databases available in Azure_\\n\\n\\nIn the previous figure, note how each sits upon a comm\", \"on DBaaS infrastructure which features key\\ncapabilities at no additional cost.\\n\\n\\nThese features are \", \"especially important to organizations who provision large numbers of databases,\\nbut have limited res\", \"ources to administer them. You can provision an Azure database in minutes by\\nselecting the amount of\", \" processing cores, memory, and underlying storage. You can scale the\\ndatabase on-the-fly and dynamic\", \"ally adjust resources with little to no downtime.\\n\\n#### **Azure SQL Database**\\n\\n\\n[Development teams \", \"with expertise in Microsoft SQL Server should consider Azure SQL Database. It\\u2019s a](https://docs.micr\", \"osoft.com/azure/sql-database/)\\nfully managed relational database-as-a-service (DBaaS) based on the M\", \"icrosoft SQL Server Database\\nEngine. The service shares many features found in the on-premises versi\", \"on of SQL Server and runs the\\nlatest stable version of the SQL Server Database Engine.\\n\\n\\nFor use wit\", \"h a cloud-native microservice, Azure SQL Database is available with three deployment\\noptions:\\n\\n\\n  - \", \"[A Single Database represents a fully managed SQL Database running on an Azure SQL](https://docs.mic\", \"rosoft.com/azure/sql-database/sql-database-servers)\\n[Database server](https://docs.microsoft.com/azu\", \"re/sql-database/sql-database-servers) in the Azure cloud. The database is considered _[contained](ht\", \"tps://docs.microsoft.com/sql/relational-databases/databases/contained-databases)_ as it has no\\nconfi\", \"guration dependencies on the underlying database server.\\n\\n\\n  - [A Managed Instance is a fully manage\", \"d instance of the Microsoft SQL Server Database Engine](https://docs.microsoft.com/azure/sql-databas\", \"e/sql-database-managed-instance)\\nthat provides near-100% compatibility with an on-premises SQL Serve\", \"r. This option supports\\n[larger databases, up to 35 TB and is placed in an Azure Virtual Network](ht\", \"tps://docs.microsoft.com/azure/virtual-network/virtual-networks-overview) for better isolation.\\n\\n\\n10\", \"0 CHAPTER 5 | Cloud-native data patterns\\n\\n\\n  - [Azure SQL Database serverless is a compute tier for \", \"a single database that automatically](https://docs.microsoft.com/azure/sql-database/sql-database-ser\", \"verless)\\nscales based on workload demand. It bills only for the amount of compute used per second.\\nT\", \"he service is well suited for workloads with intermittent, unpredictable usage patterns,\\nintersperse\", \"d with periods of inactivity. The serverless compute tier also automatically pauses\\ndatabases during\", \" inactive periods so that only storage charges are billed. It automatically\\nresumes when activity re\", \"turns.\\n\\n\\nBeyond the traditional Microsoft SQL Server stack, Azure also features managed versions of \", \"three\\npopular open-source databases.\\n\\n#### **Open-source databases in Azure**\\n\\n\\nOpen-source relation\", \"al databases have become a popular choice for cloud-native applications. Many\\nenterprises favor them\", \" over commercial database products, especially for cost savings. Many\\ndevelopment teams enjoy their \", \"flexibility, community-backed development, and ecosystem of tools\\nand extensions. Open-source databa\", \"ses can be deployed across multiple cloud providers, helping\\nminimize the concern of \\u201cvendor lock-in\", \".\\u201d\\n\\n\\nDevelopers can easily self-host any open-source database on an Azure VM. While providing full\\nc\", \"ontrol, this approach puts you on the hook for the management, monitoring, and maintenance of\\nthe da\", \"tabase and VM.\\n\\n\\nHowever, Microsoft continues its commitment to keeping Azure an \\u201copen platform\\u201d by \", \"offering\\nseveral popular open-source databases as _fully managed_ DBaaS services.\\n\\n\\n**Azure Database\", \" for MySQL**\\n\\n\\n[MySQL](https://en.wikipedia.org/wiki/MySQL) [is an open-source relational database a\", \"nd a pillar for applications built on the LAMP software](https://en.wikipedia.org/wiki/LAMP_(softwar\", \"e_bundle))\\n[stack. Widely chosen for](https://en.wikipedia.org/wiki/LAMP_(software_bundle)) _read he\", \"avy_ workloads, it\\u2019s used by many large organizations, including\\nFacebook, Twitter, and YouTube. The\", \" community edition is available for free, while the enterprise\\nedition requires a license purchase. \", \"Originally created in 1995, the product was purchased by Sun\\nMicrosystems in 2008. Oracle acquired S\", \"un and MySQL in 2010.\\n\\n\\n[Azure Database for MySQL is a managed relational database service based on \", \"the open-source](https://azure.microsoft.com/services/mysql/)\\nMySQL Server engine. It uses the MySQL\", \" Community edition. The Azure MySQL server is the\\nadministrative point for the service. It\\u2019s the sam\", \"e MySQL server engine used for on-premises\\ndeployments. The engine can create a single database per \", \"server or multiple databases per server that\\nshare resources. You can continue to manage data using \", \"the same open-source tools without having\\nto learn new skills or manage virtual machines.\\n\\n\\n**Azure \", \"Database for MariaDB**\\n\\n\\n[MariaDB](https://mariadb.com/) Server is another popular open-source datab\", \"ase server. It was created as a _fork_ of MySQL\\nwhen Oracle purchased Sun Microsystems, who owned My\", \"SQL. The intent was to ensure that MariaDB\\nremained open-source. As MariaDB is a fork of MySQL, the \", \"data and table definitions are compatible,\\nand the client protocols, structures, and APIs, are close\", \"-knit.\\n\\n\\n101 CHAPTER 5 | Cloud-native data patterns\\n\\n\\nMariaDB has a strong community and is used by \", \"many large enterprises. While Oracle continues to\\nmaintain, enhance, and support MySQL, the MariaDB \", \"foundation manages MariaDB, allowing public\\ncontributions to the product and documentation.\\n\\n\\n[Azure\", \" Database for MariaDB is a fully managed relational database as a service in the Azure cloud. The](h\", \"ttps://azure.microsoft.com/services/mariadb/)\\nservice is based on the MariaDB community edition serv\", \"er engine. It can handle mission-critical\\nworkloads with predictable performance and dynamic scalabi\", \"lity.\\n\\n\\n**Azure Database for PostgreSQL**\\n\\n\\n[PostgreSQL](https://www.postgresql.org/) is an open-sou\", \"rce relational database with over 30 years of active development.\\nPostgreSQL has a strong reputation\", \" for reliability and data integrity. It\\u2019s feature rich, SQL compliant,\\nand considered more performan\", \"t than MySQL - especially for workloads with complex queries and\\nheavy writes. Many large enterprise\", \"s including Apple, Red Hat, and Fujitsu have built products using\\nPostgreSQL.\\n\\n\\n[Azure Database for \", \"PostgreSQL is a fully managed relational database service, based on the open-](https://azure.microso\", \"ft.com/services/postgresql/)\\nsource Postgres database engine. The service supports many development \", \"platforms, including C++,\\nJava, Python, Node, C#, and PHP. You can migrate PostgreSQL databases to i\", \"t using the commandline interface tool or Azure Data Migration Service.\\n\\n\\nAzure Database for Postgre\", \"SQL is available with two deployment options:\\n\\n\\n  - [The Single Server deployment option is a centra\", \"l administrative point for multiple databases](https://docs.microsoft.com/azure/postgresql/concepts-\", \"servers)\\nto which you can deploy many databases. The pricing is structured per-server based upon\\ncor\", \"es and storage.\\n\\n\\n  - [The Hyperscale (Citus) option is powered by Citus Data technology. It enables\", \" high](https://azure.microsoft.com/blog/get-high-performance-scaling-for-your-azure-database-workloa\", \"ds-with-hyperscale/)\\nperformance by _horizontally scaling_ a single database across hundreds of node\", \"s to deliver fast\\nperformance and scale. This option allows the engine to fit more data in memory, p\", \"arallelize\\nqueries across hundreds of nodes, and index data faster.\\n\\n#### **NoSQL data in Azure**\\n\\n\\n\", \"Cosmos DB is a fully managed, globally distributed NoSQL database service in the Azure cloud. It has\", \"\\nbeen adopted by many large companies across the world, including Coca-Cola, Skype, ExxonMobil,\\nand \", \"Liberty Mutual.\\n\\n\\nIf your services require fast response from anywhere in the world, high availabili\", \"ty, or elastic\\nscalability, Cosmos DB is a great choice. Figure 5-12 shows Cosmos DB.\\n\\n\\n102 CHAPTER \", \"5 | Cloud-native data patterns\\n\\n\\n_Figure 5-12: Overview of Azure Cosmos DB_\\n\\n\\nThe previous figure pr\", \"esents many of the built-in cloud-native capabilities available in Cosmos DB. In\\nthis section, we\\u2019ll\", \" take a closer look at them.\\n\\n\\n**Global support**\\n\\n\\nCloud-native applications often have a global au\", \"dience and require global scale.\\n\\n\\nYou can distribute Cosmos databases across regions or around the \", \"world, placing data close to your\\nusers, improving response time, and reducing latency. You can add \", \"or remove a database from a\\nregion without pausing or redeploying your services. In the background, \", \"Cosmos DB transparently\\nreplicates the data to each of the configured regions.\\n\\n\\n[Cosmos DB supports\", \" active/active clustering at the global level, enabling you to configure any of your](https://kempte\", \"chnologies.com/white-papers/unfog-confusion-active-passive-activeactive-load-balancing/)\\ndatabase re\", \"gions to support _both writes and reads_ .\\n\\n\\n[The Multi-region write](https://docs.microsoft.com/azu\", \"re/cosmos-db/conflict-resolution-policies) protocol is an important feature in Cosmos DB that enable\", \"s the following\\nfunctionality:\\n\\n\\n  - Unlimited elastic write and read scalability.\\n\\n\\n  - 99.999% rea\", \"d and write availability all around the world.\\n\\n\\n  - Guaranteed reads and writes served in less than\", \" 10 milliseconds at the 99th percentile.\\n\\n\\n[With the Cosmos DB Multi-Homing APIs, your microservice \", \"is automatically aware of the nearest](https://docs.microsoft.com/azure/cosmos-db/distribute-data-gl\", \"obally)\\nAzure region and sends requests to it. The nearest region is identified by Cosmos DB without\", \" any\\nconfiguration changes. Should a region become unavailable, the Multi-Homing feature will\\nautoma\", \"tically route requests to the next nearest available region.\\n\\n\\n**Multi-model support**\\n\\n\\nWhen replat\", \"forming monolithic applications to a cloud-native architecture, development teams\\nsometimes have to \", \"migrate open-source, NoSQL data stores. Cosmos DB can help you preserve your\\n\\n\\n103 CHAPTER 5 | Cloud\", \"-native data patterns\\n\\n\\ninvestment in these NoSQL datastores with its _multi-model_ data platform. T\", \"he following table shows\\n[the supported NoSQL compatibility APIs.](https://www.wikiwand.com/en/Cosmo\", \"s_DB)\\n\\n|Provider|Description|\\n|---|---|\\n|NoSQL API|API for NoSQL stores data in document format|\\n|Mo\", \"ngo DB API|Supports Mongo DB APIs and JSON documents|\\n|Gremlin API|Supports Gremlin API with graph-b\", \"ased nodes<br>and edge data representations|\\n|Cassandra API|Supports Casandra API for wide-column da\", \"ta<br>representations|\\n|Table API|Supports Azure Table Storage with premium<br>enhancements|\\n|Postgr\", \"eSQL API|Managed service for running PostgreSQL at any<br>scale|\\n\\n\\n\\nDevelopment teams can migrate ex\", \"isting Mongo, Gremlin, or Cassandra databases into Cosmos DB\\nwith minimal changes to data or code. F\", \"or new apps, development teams can choose among opensource options or the built-in SQL API model.\\n\\n\\n\", \"Internally, Cosmos stores the data in a simple struct format made up of primitive data types. For ea\", \"ch\\nrequest, the database engine translates the primitive data into the model representation you\\u2019ve\\ns\", \"elected.\\n\\n\\n[In the previous table, note the Table API](https://docs.microsoft.com/azure/cosmos-db/ta\", \"ble-introduction) option. This API is an evolution of Azure Table Storage. Both\\nshare the same under\", \"lying table model, but the Cosmos DB Table API adds premium enhancements\\nnot available in the Azure \", \"Storage API. The following table contrasts the features.\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n|Feature|Azure Table Storage|Az\", \"ure Cosmos DB|\\n|---|---|---|\\n|Latency|Fast|Single-digit millisecond latency for reads and<br>writes \", \"anywhere in the world|\\n|Throughp<br>ut|Limit of 20,000 operations per table|Unlimited operations per\", \" table|\\n|Global<br>Distributio<br>n|Single region with optional single<br>secondary read region|Turn\", \"key distributions to all regions with<br>automatic failover|\\n|Indexing|Available for partition and r\", \"ow key<br>properties only|Automatic indexing of all properties|\\n|Pricing|Optimized for cold workload\", \"s (low<br>throughput : storage ratio)|Optimized for hot workloads (high<br>throughput : storage rati\", \"o)|\\n\\n\\n\\nMicroservices that consume Azure Table storage can easily migrate to the Cosmos DB Table API.\", \" No\\ncode changes are required.\\n\\n\\n104 CHAPTER 5 | Cloud-native data patterns\\n\\n\\n**Tunable consistency*\", \"*\\n\\n\\nEarlier in the _Relational vs. NoSQL_ section, we discussed the subject of _data consistency_ . \", \"Data\\nconsistency refers to the _integrity_ of your data. Cloud-native services with distributed data\", \" rely on\\nreplication and must make a fundamental tradeoff between read consistency, availability, an\", \"d latency.\\n\\n\\nMost distributed databases allow developers to choose between two consistency\\nmodels: s\", \"trong consistency and eventual consistency. _Strong consistency_ is the gold standard of data\\nprogra\", \"mmability. It guarantees that a query will always return the most current data - even if the\\nsystem \", \"must incur latency waiting for an update to replicate across all database copies. While a\\ndatabase c\", \"onfigured for _eventual consistency_ will return data immediately, even if that data isn\\u2019t the\\nmost \", \"current copy. The latter option enables higher availability, greater scale, and increased\\nperformanc\", \"e.\\n\\n\\n[Azure Cosmos DB offers five well-defined consistency models](https://docs.microsoft.com/azure/\", \"cosmos-db/consistency-levels) shown in Figure 5-13.\\n\\n\\n_Figure 5-13: Cosmos DB Consistency Levels_\\n\\n\\n\", \"These options enable you to make precise choices and granular tradeoffs for consistency, availabilit\", \"y,\\nand the performance for your data. The levels are presented in the following table.\\n\\n|Consistency\", \" Level|Description|\\n|---|---|\\n|Eventual|No ordering guarantee for reads. Replicas will<br>eventually\", \" converge.|\\n|Constant Prefix|Reads are still eventual, but data is returned in<br>the ordering in wh\", \"ich it is written.|\\n|Session|Guarantees you can read any data written<br>during the current session.\", \" It is the default<br>consistency level.|\\n|Bounded Staleness|Reads trail writes by interval that you\", \" specify.|\\n|Strong|Reads are guaranteed to return most recent<br>committed version of an item. A cli\", \"ent never<br>sees an uncommitted or partial read.|\\n\\n\\n\\n[In the article Getting Behind the 9-Ball: Cos\", \"mos DB Consistency Levels Explained, Microsoft Program](https://blog.jeremylikness.com/blog/2018-03-\", \"23_getting-behind-the-9ball-cosmosdb-consistency-levels/)\\nManager Jeremy Likness provides an excelle\", \"nt explanation of the five models.\\n\\n\\n**Partitioning**\\n\\n\\n[Azure Cosmos DB embraces automatic partitio\", \"ning](https://docs.microsoft.com/azure/cosmos-db/partitioning-overview) to scale a database to meet \", \"the performance\\nneeds of your cloud-native services.\\n\\n\\nYou manage data in Cosmos DB data by creating\", \" databases, containers, and items.\\n\\n\\n105 CHAPTER 5 | Cloud-native data patterns\\n\\n\\nContainers live in\", \" a Cosmos DB database and represent a schema-agnostic grouping of items. Items\\nare the data that you\", \" add to the container. They\\u2019re represented as documents, rows, nodes, or edges.\\nAll items added to a\", \" container are automatically indexed.\\n\\n\\nTo partition the container, items are divided into distinct \", \"subsets called logical partitions. Logical\\npartitions are populated based on the value of a partitio\", \"n key that is associated with each item in a\\ncontainer. Figure 5-14 shows two containers each with a\", \" logical partition based on a partition key\\nvalue.\\n\\n\\n_Figure 5-14: Cosmos DB partitioning mechanics_\", \"\\n\\n\\nNote in the previous figure how each item includes a partition key of either \\u2018city\\u2019 or \\u2018airport\\u2019.\", \" The key\\ndetermines the item\\u2019s logical partition. Items with a city code are assigned to the contain\", \"er on the left,\\nand items with an airport code, to the container on the right. Combining the partiti\", \"on key value with\\nthe ID value creates an item\\u2019s index, which uniquely identifies the item.\\n\\n\\n[Inter\", \"nally, Cosmos DB automatically manages the placement of logical partitions](https://docs.microsoft.c\", \"om/azure/cosmos-db/partition-data) on physical\\npartitions to satisfy the scalability and performance\", \" needs of the container. As application throughput\\nand storage requirements increase, Azure Cosmos D\", \"B redistributes logical partitions across a greater\\nnumber of servers. Redistribution operations are\", \" managed by Cosmos DB and invoked without\\ninterruption or downtime.\\n\\n#### **NewSQL databases**\\n\\n\\n_Ne\", \"wSQL_ is an emerging database technology that combines the distributed scalability of NoSQL with\\nthe\", \" ACID guarantees of a relational database. NewSQL databases are important for business systems\\nthat \", \"must process high-volumes of data, across distributed environments, with full transactional\\nsupport \", \"and ACID compliance. While a NoSQL database can provide massive scalability, it does not\\nguarantee d\", \"ata consistency. Intermittent problems from inconsistent data can place a burden on the\\ndevelopment \", \"team. Developers must construct safeguards into their microservice code to manage\\nproblems caused by\", \" inconsistent data.\\n\\n\\nThe Cloud Native Computing Foundation (CNCF) features several NewSQL database \", \"projects.\\n\\n\\n106 CHAPTER 5 | Cloud-native data patterns\\n\\n\\n|Project|Characteristics|\\n|---|---|\\n|Cockro\", \"ach DB|An ACID-compliant, relational database that<br>scales globally. Add a new node to a cluster a\", \"nd<br>CockroachDB takes care of balancing the data<br>across instances and geographies. It creates,<\", \"br>manages, and distributes replicas to ensure<br>reliability. It\\u2019s open source and freely available\", \".|\\n|TiDB|An open-source database that supports Hybrid<br>Transactional and Analytical Processing (HT\", \"AP)<br>workloads. It is MySQL-compatible and features<br>horizontal scalability, strong consistency,\", \" and<br>high availability. TiDB acts like a MySQL server.<br>You can continue to use existing MySQL \", \"client<br>libraries, without requiring extensive code<br>changes to your application.|\\n|YugabyteDB|A\", \"n open source, high-performance, distributed<br>SQL database. It supports low query latency,<br>resi\", \"lience against failures, and global data<br>distribution. YugabyteDB is PostgreSQL-<br>compatible an\", \"d handles scale-out RDBMS and<br>internet-scale OLTP workloads. The product also<br>supports NoSQL a\", \"nd is compatible with<br>Cassandra.|\\n|Vitess|Vitess is a database solution for deploying,<br>scaling\", \", and managing large clusters of MySQL<br>instances. It can run in a public or private cloud<br>arch\", \"itecture. Vitess combines and extends many<br>important MySQL features and features both<br>vertical\", \" and horizontal sharding support.<br>Originated by YouTube, Vitess has been serving<br>all YouTube d\", \"atabase traffic since 2011.|\\n\\n\\nThe open-source projects in the previous figure are available from th\", \"e Cloud Native Computing\\nFoundation. Three of the offerings are full database products, which includ\", \"e .NET support. The other,\\nVitess, is a database clustering system that horizontally scales large cl\", \"usters of MySQL instances.\\n\\n\\nA key design goal for NewSQL databases is to work natively in Kubernete\", \"s, taking advantage of the\\nplatform\\u2019s resiliency and scalability.\\n\\n\\nNewSQL databases are designed to\", \" thrive in ephemeral cloud environments where underlying virtual\\nmachines can be restarted or resche\", \"duled at a moment\\u2019s notice. The databases are designed to\\nsurvive node failures without data loss no\", \"r downtime. CockroachDB, for example, is able to survive a\\nmachine loss by maintaining three consist\", \"ent replicas of any data across the nodes in a cluster.\\n\\n\\nKubernetes uses a _Services construct_ to \", \"allow a client to address a group of identical NewSQL\\ndatabases processes from a single DNS entry. B\", \"y decoupling the database instances from the address\\n\\n\\n107 CHAPTER 5 | Cloud-native data patterns\\n\\n\\n\", \"of the service with which it\\u2019s associated, we can scale without disrupting existing application inst\", \"ances.\\nSending a request to any service at a given time will always yield the same result.\\n\\n\\nIn this\", \" scenario, all database instances are equal. There are no primary or secondary relationships.\\nTechni\", \"ques like _consensus replication_ found in CockroachDB allow any database node to handle any\\nrequest\", \". If the node that receives a load-balanced request has the data it needs locally, it responds\\nimmed\", \"iately. If not, the node becomes a gateway and forwards the request to the appropriate nodes\\nto get \", \"the correct answer. From the client\\u2019s perspective, every database node is the same: They appear\\nas a\", \" single _logical_ database with the consistency guarantees of a single-machine system, despite\\nhavin\", \"g dozens or even hundreds of nodes that are working behind the scenes.\\n\\n\\n[For a detailed look at the\", \" mechanics behind NewSQL databases, see the DASH: Four Properties of](https://thenewstack.io/dash-fo\", \"ur-properties-of-kubernetes-native-databases/)\\n[Kubernetes-Native Databases article.](https://thenew\", \"stack.io/dash-four-properties-of-kubernetes-native-databases/)\\n\\n#### **Data migration to the cloud**\", \"\\n\\n\\nOne of the more time-consuming tasks is migrating data from one data platform to another. The\\n[Az\", \"ure Data Migration Service can help expedite such efforts. It can migrate data from several external\", \"](https://azure.microsoft.com/services/database-migration/)\\ndatabase sources into Azure Data platfor\", \"ms with minimal downtime. Target platforms include the\\nfollowing services:\\n\\n\\n  - Azure SQL Database\\n\", \"\\n  - Azure Database for MySQL\\n\\n  - Azure Database for MariaDB\\n\\n  - Azure Database for PostgreSQL\\n\\n  \", \"- Azure Cosmos DB\\n\\n\\nThe service provides recommendations to guide you through the changes required t\", \"o execute a\\nmigration, both small or large.\\n\\n### Caching in a cloud-native app\\n\\n\\nThe benefits of cac\", \"hing are well understood. The technique works by temporarily copying frequently\\naccessed data from a\", \" backend data store to _fast storage_ that\\u2019s located closer to the application.\\nCaching is often imp\", \"lemented where\\u2026\\n\\n\\n  - Data remains relatively static.\\n\\n  - Data access is slow, especially compared \", \"to the speed of the cache.\\n\\n  - Data is subject to high levels of contention.\\n\\n#### **Why?**\\n\\n\\n[As d\", \"iscussed in the Microsoft caching guidance, caching can increase performance, scalability, and](http\", \"s://docs.microsoft.com/azure/architecture/best-practices/caching)\\navailability for individual micros\", \"ervices and the system as a whole. It reduces the latency and\\ncontention of handling large volumes o\", \"f concurrent requests to a data store. As data volume and the\\nnumber of users increase, the greater \", \"the benefits of caching become.\\n\\n\\n108 CHAPTER 5 | Cloud-native data patterns\\n\\n\\nCaching is most effec\", \"tive when a client repeatedly reads data that is immutable or that changes\\ninfrequently. Examples in\", \"clude reference information such as product and pricing information, or\\nshared static resources that\", \" are costly to construct.\\n\\n\\nWhile microservices should be stateless, a distributed cache can support\", \" concurrent access to session\\nstate data when absolutely required.\\n\\n\\nAlso consider caching to avoid \", \"repetitive computations. If an operation transforms data or performs a\\ncomplicated calculation, cach\", \"e the result for subsequent requests.\\n\\n#### **Caching architecture**\\n\\n\\nCloud native applications typ\", \"ically implement a distributed caching architecture. The cache is hosted\\nas a cloud-based backing se\", \"rvice, separate from the microservices. Figure 5-15 shows the architecture.\\n\\n\\n_Figure 5-15: Caching \", \"in a cloud native app_\\n\\n\\nIn the previous figure, note how the cache is independent of and shared by \", \"the microservices. In this\\nscenario, the cache is invoked by the API Gateway. As discussed in chapte\", \"r 4, the gateway serves as a\\nfront end for all incoming requests. The distributed cache increases sy\", \"stem responsiveness by\\nreturning cached data whenever possible. Additionally, separating the cache f\", \"rom the services allows\\nthe cache to scale up or out independently to meet increased traffic demands\", \".\\n\\n\\n[The previous figure presents a common caching pattern known as the cache-aside pattern. For an]\", \"(https://docs.microsoft.com/azure/architecture/patterns/cache-aside)\\nincoming request, you first que\", \"ry the cache (step #1) for a response. If found, the data is returned\\n[immediately. If the data does\", \"n\\u2019t exist in the cache (known as a cache miss), it\\u2019s retrieved from a local](https://www.techopedia.\", \"com/definition/6308/cache-miss)\\ndatabase in a downstream service (step #2). It\\u2019s then written to the\", \" cache for future requests (step #3),\\nand returned to the caller. Care must be taken to periodically\", \" evict cached data so that the system\\nremains timely and consistent.\\n\\n\\nAs a shared cache grows, it m\", \"ight prove beneficial to partition its data across multiple nodes. Doing\\nso can help minimize conten\", \"tion and improve scalability. Many Caching services support the ability to\\n\\n\\n109 CHAPTER 5 | Cloud-n\", \"ative data patterns\\n\\n\\ndynamically add and remove nodes and rebalance data across partitions. This ap\", \"proach typically\\ninvolves clustering. Clustering exposes a collection of federated nodes as a seamle\", \"ss, single cache.\\nInternally, however, the data is dispersed across the nodes following a predefined\", \" distribution strategy\\nthat balances the load evenly.\\n\\n#### **Azure Cache for Redis**\\n\\n\\n[Azure Cache\", \" for Redis](https://azure.microsoft.com/services/cache/) is a secure data caching and messaging brok\", \"er service, fully managed by\\nMicrosoft. Consumed as a Platform as a Service (PaaS) offering, it prov\", \"ides high throughput and lowlatency access to data. The service is accessible to any application wit\", \"hin or outside of Azure.\\n\\n\\nThe Azure Cache for Redis service manages access to open-source Redis ser\", \"vers hosted across Azure\\ndata centers. The service acts as a facade providing management, access con\", \"trol, and security. The\\nservice natively supports a rich set of data structures, including strings, \", \"hashes, lists, and sets. If your\\napplication already uses Redis, it will work as-is with Azure Cache\", \" for Redis.\\n\\n\\nAzure Cache for Redis is more than a simple cache server. It can support a number of s\", \"cenarios to\\nenhance a microservices architecture:\\n\\n\\n  - An in-memory data store\\n\\n  - A distributed n\", \"on-relational database\\n\\n  - A message broker\\n\\n  - A configuration or discovery server\\n\\n\\n[For advance\", \"d scenarios, a copy of the cached data can be persisted to disk. If a catastrophic event](https://do\", \"cs.microsoft.com/azure/azure-cache-for-redis/cache-how-to-premium-persistence)\\ndisables both the pri\", \"mary and replica caches, the cache is reconstructed from the most recent\\nsnapshot.\\n\\n\\nAzure Redis Cac\", \"he is available across a number of predefined configurations and pricing tiers. The\\n[Premium tier](h\", \"ttps://docs.microsoft.com/azure/azure-cache-for-redis/cache-overview#service-tiers) features many en\", \"terprise-level features such as clustering, data persistence, georeplication, and virtual-network is\", \"olation.\\n\\n### Elasticsearch in a cloud-native app\\n\\n\\nElasticsearch is a distributed search and analyt\", \"ics system that enables complex search capabilities\\nacross diverse types of data. It\\u2019s open source a\", \"nd widely popular. Consider how the following\\ncompanies integrate Elasticsearch into their applicati\", \"on:\\n\\n\\n  - [Wikipedia](https://blog.wikimedia.org/2014/01/06/wikimedia-moving-to-elasticsearch/) for \", \"full-text and incremental (search as you type) searching.\\n\\n  - [GitHub](https://www.elastic.co/custo\", \"mers/github) to index and expose over 8 million code repositories.\\n\\n\\n  - [Docker](https://www.elasti\", \"c.co/customers/docker) for making its container library discoverable.\\n\\n\\n[Elasticsearch is built on t\", \"op of the Apache Lucene](https://lucene.apache.org/core/) full-text search engine. Lucene provides h\", \"ighperformance document indexing and querying. It indexes data with an inverted indexing scheme \\u2013\\nin\", \"stead of mapping pages to keywords, it maps keywords to pages just like a glossary at the end of a\\nb\", \"ook. Lucene has powerful query syntax capabilities and can query data by:\\n\\n\\n110 CHAPTER 5 | Cloud-na\", \"tive data patterns\\n\\n\\n  - Term (a full word)\\n\\n  - Prefix (starts-with word)\\n\\n  - Wildcard (using \\u201c*\\u201d \", \"or \\u201c?\\u201d filters)\\n\\n  - Phrase (a sequence of text in a document)\\n\\n  - Boolean value (complex searches \", \"combining queries)\\n\\n\\nWhile Lucene provides low-level plumbing for searching, Elasticsearch provides \", \"the server that sits on\\ntop of Lucene. Elasticsearch adds higher-level functionality to simplify wor\", \"king Lucene, including a\\nRESTful API to access Lucene\\u2019s indexing and searching functionality. It als\", \"o provides a distributed\\ninfrastructure capable of massive scalability, fault tolerance, and high av\", \"ailability.\\n\\n\\nFor larger cloud-native applications with complex search requirements, Elasticsearch i\", \"s available as\\nmanaged service in Azure. The Microsoft Azure Marketplace features preconfigured temp\", \"lates which\\ndevelopers can use to deploy an Elasticsearch cluster on Azure.\\n\\n\\nFrom the Microsoft Azu\", \"re Marketplace, developers can use preconfigured templates built to quickly\\ndeploy an Elasticsearch \", \"cluster on Azure. Using the Azure-managed offering, you can deploy up to 50\\ndata nodes, 20 coordinat\", \"ing nodes, and three dedicated master nodes.\\n\\n#### **Summary**\\n\\n\\nThis chapter presented a detailed l\", \"ook at data in cloud-native systems. We started by contrasting data\\nstorage in monolithic applicatio\", \"ns with data storage patterns in cloud-native systems. We looked at\\ndata patterns implemented in clo\", \"ud-native systems, including cross-service queries, distributed\\ntransactions, and patterns to deal w\", \"ith high-volume systems. We contrasted SQL with NoSQL data.\\nWe looked at data storage options availa\", \"ble in Azure that include both Microsoft-centric and opensource options. Finally, we discussed cachi\", \"ng and Elasticsearch in a cloud-native application.\\n\\n\\n**References**\\n\\n\\n  - [Command and Query Respon\", \"sibility Segregation (CQRS) pattern](https://docs.microsoft.com/azure/architecture/patterns/cqrs)\\n\\n\\n\", \"  - [Event Sourcing pattern](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing)\\n\", \"\\n\\n  - [Why isn\\u2019t RDBMS Partition Tolerant in CAP Theorem and why is it Available?](https://stackover\", \"flow.com/questions/36404765/why-isnt-rdbms-partition-tolerant-in-cap-theorem-and-why-is-it-available\", \")\\n\\n\\n  - [Materialized View](https://docs.microsoft.com/azure/architecture/patterns/materialized-view\", \")\\n\\n\\n  - [All you really need to know about open source databases](https://www.ibm.com/blogs/systems/\", \"all-you-really-need-to-know-about-open-source-databases/)\\n\\n\\n  - [Compensating Transaction pattern](h\", \"ttps://docs.microsoft.com/azure/architecture/patterns/compensating-transaction)\\n\\n\\n  - [Saga Pattern]\", \"(https://microservices.io/patterns/data/saga.html)\\n\\n\\n  - [Saga Patterns | How to implement business \", \"transactions using microservices](https://blog.couchbase.com/saga-pattern-implement-business-transac\", \"tions-using-microservices-part/)\\n\\n\\n  - [Compensating Transaction pattern](https://docs.microsoft.com\", \"/azure/architecture/patterns/compensating-transaction)\\n\\n\\n  - [Getting Behind the 9-Ball: Cosmos DB C\", \"onsistency Levels Explained](https://blog.jeremylikness.com/blog/2018-03-23_getting-behind-the-9ball\", \"-cosmosdb-consistency-levels/)\\n\\n\\n  - [On RDBMS, NoSQL and NewSQL databases. Interview with John Ryan\", \"](http://www.odbms.org/blog/2018/03/on-rdbms-nosql-and-newsql-databases-interview-with-john-ryan/)\\n\\n\", \"\\n111 CHAPTER 5 | Cloud-native data patterns\\n\\n\\n  - [SQL vs NoSQL vs NewSQL: The Full Comparison](http\", \"s://www.xenonstack.com/blog/sql-vs-nosql-vs-newsql/)\\n\\n\\n  - [DASH: Four Properties of Kubernetes-Nati\", \"ve Databases](https://thenewstack.io/dash-four-properties-of-kubernetes-native-databases/)\\n\\n\\n  - [Co\", \"ckroachDB](https://www.cockroachlabs.com/)\\n\\n\\n  - [TiDB](https://pingcap.com/en/)\\n\\n\\n  - [YugabyteDB](\", \"https://www.yugabyte.com/)\\n\\n\\n  - [Vitess](https://vitess.io/)\\n\\n\\n  - [Elasticsearch: The Definitive G\", \"uide](https://shop.oreilly.com/product/0636920028505.do)\\n\\n\\n  - [Introduction to Apache Lucene](https\", \"://www.baeldung.com/lucene)\\n\\n\\n112 CHAPTER 5 | Cloud-native data patterns\\n\\n\\n**CHAPTER**\\n# 6\\n\\n## Cloud\", \"-native resiliency\\n\\n\\nResiliency is the ability of your system to react to failure and still remain f\", \"unctional. It\\u2019s not about\\navoiding failure, but accepting failure and constructing your cloud-native\", \" services to respond to it.\\nYou want to return to a fully functioning state quickly as possible.\\n\\n\\nU\", \"nlike traditional monolithic applications, where everything runs together in a single process, cloud\", \"native systems embrace a distributed architecture as shown in Figure 6-1:\\n\\n\\n_Figure 6-1. Distributed\", \" cloud-native environment_\\n\\n\\n[In the previous figure, each microservice and cloud-based backing serv\", \"ice](https://12factor.net/backing-services) execute in a separate\\nprocess, across server infrastruct\", \"ure, communicating via network-based calls.\\n\\n\\nOperating in this environment, a service must be sensi\", \"tive to many different challenges:\\n\\n\\n  - Unexpected network latency - the time for a service request\", \" to travel to the receiver and back.\\n\\n\\n  - [Transient faults](https://docs.microsoft.com/azure/archi\", \"tecture/best-practices/transient-faults)  - short-lived network connectivity errors.\\n\\n\\n  - Blockage \", \"by a long-running synchronous operation.\\n\\n\\n  - A host process that has crashed and is being restarte\", \"d or moved.\\n\\n\\n  - An overloaded microservice that can\\u2019t respond for a short time.\\n\\n\\n  - An in-flight\", \" orchestrator operation such as a rolling upgrade or moving a service from one\\nnode to another.\\n\\n\\n11\", \"3 CHAPTER 6 | Cloud-native resiliency\\n\\n\\n  - Hardware failures.\\n\\n\\nCloud platforms can detect and miti\", \"gate many of these infrastructure issues. It may restart, scale out,\\nand even redistribute your serv\", \"ice to a different node. However, to take full advantage of this built-in\\nprotection, you must desig\", \"n your services to react to it and thrive in this dynamic environment.\\n\\n\\nIn the following sections, \", \"we\\u2019ll explore defensive techniques that your service and managed cloud\\nresources can leverage to min\", \"imize downtime and disruption.\\n\\n### Application resiliency patterns\\n\\n\\nThe first line of defense is a\", \"pplication resiliency.\\n\\n\\nWhile you could invest considerable time writing your own resiliency framew\", \"ork, such products\\n[already exist. Polly](https://old.dotnetfoundation.org/projects/polly) is a comp\", \"rehensive .NET resilience and transient-fault-handling library that allows\\ndevelopers to express res\", \"iliency policies in a fluent and thread-safe manner. Polly targets applications\\nbuilt with either .N\", \"ET Framework or .NET 7. The following table describes the resiliency features, called\\npolicies, avai\", \"lable in the Polly Library. They can be applied individually or grouped together.\\n\\n|Policy|Experienc\", \"e|\\n|---|---|\\n|Retry|Configures retry operations on designated<br>operations.|\\n|Circuit Breaker|Block\", \"s requested operations for a predefined<br>period when faults exceed a configured<br>threshold|\\n|Tim\", \"eout|Places limit on the duration for which a caller<br>can wait for a response.|\\n|Bulkhead|Constrai\", \"ns actions to fixed-size resource pool to<br>prevent failing calls from swamping a resource.|\\n|Cache\", \"|Stores responses automatically.|\\n|Fallback|Defines structured behavior upon a failure.|\\n\\n\\n\\nNote how\", \" in the previous figure the resiliency policies apply to request messages, whether coming\\nfrom an ex\", \"ternal client or back-end service. The goal is to compensate the request for a service that\\nmight be\", \" momentarily unavailable. These short-lived interruptions typically manifest themselves with\\nthe HTT\", \"P status codes shown in the following table.\\n\\n|HTTP Status Code|Cause|\\n|---|---|\\n|404|Not Found|\\n|40\", \"8|Request timeout|\\n|429|Too many requests (you\\u2019ve most likely been throttled)|\\n|502|Bad gateway|\\n|50\", \"3|Service unavailable|\\n\\n\\n\\n114 CHAPTER 6 | Cloud-native resiliency\\n\\n\\n|HTTP Status Code|Cause|\\n|---|--\", \"-|\\n|504|Gateway timeout|\\n\\n\\nQuestion: Would you retry an HTTP Status Code of 403 - Forbidden? No. Her\", \"e, the system is\\nfunctioning properly, but informing the caller that they aren\\u2019t authorized to perfo\", \"rm the requested\\noperation. Care must be taken to retry only those operations caused by failures.\\n\\n\\n\", \"As recommended in Chapter 1, Microsoft developers constructing cloud-native applications should\\n[tar\", \"get the .NET platform. Version 2.1 introduced the HTTPClientFactory](https://www.stevejgordon.co.uk/\", \"introduction-to-httpclientfactory-aspnetcore) library for creating HTTP Client\\ninstances for interac\", \"ting with URL-based resources. Superseding the original HTTPClient class, the\\n[factory class support\", \"s many enhanced features, one of which is tight integration](https://docs.microsoft.com/dotnet/archi\", \"tecture/microservices/implement-resilient-applications/implement-http-call-retries-exponential-backo\", \"ff-polly) with the Polly\\nresiliency library. With it, you can easily define resiliency policies in t\", \"he application Startup class to\\nhandle partial failures and connectivity issues.\\n\\n\\nNext, let\\u2019s expan\", \"d on retry and circuit breaker patterns.\\n\\n\\n**Retry pattern**\\n\\n\\nIn a distributed cloud-native environ\", \"ment, calls to services and cloud resources can fail because of\\ntransient (short-lived) failures, wh\", \"ich typically correct themselves after a brief period of time.\\nImplementing a retry strategy helps a\", \" cloud-native service mitigate these scenarios.\\n\\n\\n[The Retry pattern](https://docs.microsoft.com/azu\", \"re/architecture/patterns/retry) enables a service to retry a failed request operation a (configurabl\", \"e) number of\\ntimes with an exponentially increasing wait time. Figure 6-2 shows a retry in action.\\n\\n\", \"\\n_Figure 6-2. Retry pattern in action_\\n\\n\\nIn the previous figure, a retry pattern has been implemente\", \"d for a request operation. It\\u2019s configured to\\nallow up to four retries before failing with a backoff\", \" interval (wait time) starting at two seconds, which\\nexponentially doubles for each subsequent attem\", \"pt.\\n\\n\\n  - The first invocation fails and returns an HTTP status code of 500. The application waits f\", \"or two\\nseconds and retries the call.\\n\\n\\n115 CHAPTER 6 | Cloud-native resiliency\\n\\n\\n  - The second invo\", \"cation also fails and returns an HTTP status code of 500. The application now\\ndoubles the backoff in\", \"terval to four seconds and retries the call.\\n\\n  - Finally, the third call succeeds.\\n\\n  - In this sce\", \"nario, the retry operation would have attempted up to four retries while doubling\\nthe backoff durati\", \"on before failing the call.\\n\\n  - Had the 4th retry attempt failed, a fallback policy would be invoke\", \"d to gracefully handle the\\nproblem.\\n\\n\\nIt\\u2019s important to increase the backoff period before retrying \", \"the call to allow the service time to selfcorrect. It\\u2019s a best practice to implement an exponentiall\", \"y increasing backoff (doubling the period on\\neach retry) to allow adequate correction time.\\n\\n#### **\", \"Circuit breaker pattern**\\n\\n\\nWhile the retry pattern can help salvage a request entangled in a partia\", \"l failure, there are situations\\nwhere failures can be caused by unanticipated events that will requi\", \"re longer periods of time to\\nresolve. These faults can range in severity from a partial loss of conn\", \"ectivity to the complete failure of\\na service. In these situations, it\\u2019s pointless for an applicatio\", \"n to continually retry an operation that is\\nunlikely to succeed.\\n\\n\\nTo make things worse, executing c\", \"ontinual retry operations on a non-responsive service can move\\nyou into a self-imposed denial of ser\", \"vice scenario where you flood your service with continual calls\\nexhausting resources such as memory,\", \" threads and database connections, causing failure in unrelated\\nparts of the system that use the sam\", \"e resources.\\n\\n\\nIn these situations, it would be preferable for the operation to fail immediately and\", \" only attempt to\\ninvoke the service if it\\u2019s likely to succeed.\\n\\n\\n[The Circuit Breaker pattern can pr\", \"event an application from repeatedly trying to execute an operation](https://docs.microsoft.com/azur\", \"e/architecture/patterns/circuit-breaker)\\nthat\\u2019s likely to fail. After a pre-defined number of failed\", \" calls, it blocks all traffic to the service.\\nPeriodically, it will allow a trial call to determine \", \"whether the fault has resolved. Figure 6-3 shows the\\nCircuit Breaker pattern in action.\\n\\n\\n116 CHAPTE\", \"R 6 | Cloud-native resiliency\\n\\n\\n_Figure 6-3. Circuit breaker pattern in action_\\n\\n\\nIn the previous fi\", \"gure, a Circuit Breaker pattern has been added to the original retry pattern. Note how\\nafter 100 fai\", \"led requests, the circuit breakers opens and no longer allows calls to the service. The\\nCheckCircuit\", \" value, set at 30 seconds, specifies how often the library allows one request to proceed to\\nthe serv\", \"ice. If that call succeeds, the circuit closes and the service is once again available to traffic.\\n\\n\", \"\\nKeep in mind that the intent of the Circuit Breaker pattern is _different_ than that of the Retry p\", \"attern.\\nThe Retry pattern enables an application to retry an operation in the expectation that it wi\", \"ll succeed.\\nThe Circuit Breaker pattern prevents an application from doing an operation that is like\", \"ly to fail.\\nTypically, an application will _combine_ these two patterns by using the Retry pattern t\", \"o invoke an\\noperation through a circuit breaker.\\n\\n#### **Testing for resiliency**\\n\\n\\nTesting for resi\", \"liency cannot always be done the same way that you test application functionality (by\\nrunning unit t\", \"ests, integration tests, and so on). Instead, you must test how the end-to-end workload\\nperforms und\", \"er failure conditions, which only occur intermittently. For example: inject failures by\\ncrashing pro\", \"cesses, expired certificates, make dependent services unavailable etc. Frameworks like\\n[chaos-monkey\", \"](https://github.com/Netflix/chaosmonkey) can be used for such chaos testing.\\n\\n\\nApplication resilien\", \"cy is a must for handling problematic requested operations. But, it\\u2019s only half of the\\nstory. Next, \", \"we cover resiliency features available in the Azure cloud.\\n\\n### Azure platform resiliency\\n\\n\\nBuilding\", \" a reliable application in the cloud is different from traditional on-premises application\\ndevelopme\", \"nt. While historically you purchased higher-end hardware to scale up, in a cloud\\nenvironment you sca\", \"le out. Instead of trying to prevent failures, the goal is to minimize their effects\\nand keep the sy\", \"stem stable.\\n\\n\\n117 CHAPTER 6 | Cloud-native resiliency\\n\\n\\nThat said, reliable cloud applications disp\", \"lay distinct characteristics:\\n\\n\\n  - They\\u2019re resilient, recover gracefully from problems, and continu\", \"e to function.\\n\\n  - They\\u2019re highly available (HA) and run as designed in a healthy state with no sig\", \"nificant\\ndowntime.\\n\\n\\nUnderstanding how these characteristics work together - and how they affect cos\", \"t - is essential to\\nbuilding a reliable cloud-native application. We\\u2019ll next look at ways that you c\", \"an build resiliency and\\navailability into your cloud-native applications leveraging features from th\", \"e Azure cloud.\\n\\n#### **Design with resiliency**\\n\\n\\nWe\\u2019ve said resiliency enables your application to \", \"react to failure and still remain functional. The\\n[whitepaper, Resilience in Azure whitepaper, provi\", \"des guidance for achieving resilience in the Azure](https://azure.microsoft.com/mediahandler/files/r\", \"esourcefiles/resilience-in-azure-whitepaper/Resilience%20in%20Azure.pdf)\\nplatform. Here are some key\", \" recommendations:\\n\\n\\n  - _Hardware failure._ Build redundancy into the application by deploying compo\", \"nents across\\ndifferent fault domains. For example, ensure that Azure VMs are placed in different rac\", \"ks by\\nusing Availability Sets.\\n\\n\\n  - _Datacenter failure._ Build redundancy into the application wit\", \"h fault isolation zones across\\ndatacenters. For example, ensure that Azure VMs are placed in differe\", \"nt fault-isolated\\ndatacenters by using Azure Availability Zones.\\n\\n\\n  - _Regional failure._ Replicate\", \" the data and components into another region so that applications\\ncan be quickly recovered. For exam\", \"ple, use Azure Site Recovery to replicate Azure VMs to\\nanother Azure region.\\n\\n\\n  - _Heavy load._ Loa\", \"d balance across instances to handle spikes in usage. For example, put two or\\nmore Azure VMs behind \", \"a load balancer to distribute traffic to all VMs.\\n\\n\\n  - _Accidental data deletion or corruption._ Ba\", \"ck up data so it can be restored if there\\u2019s any\\ndeletion or corruption. For example, use Azure Backu\", \"p to periodically back up your Azure\\nVMs.\\n\\n#### **Design with redundancy**\\n\\n\\nFailures vary in scope \", \"of impact. A hardware failure, such as a failed disk, can affect a single node in a\\ncluster. A faile\", \"d network switch could affect an entire server rack. Less common failures, such as loss of\\npower, co\", \"uld disrupt a whole datacenter. Rarely, an entire region becomes unavailable.\\n\\n\\n[Redundancy](https:/\", \"/docs.microsoft.com/azure/architecture/guide/design-principles/redundancy) is one way to provide app\", \"lication resilience. The exact level of redundancy needed\\ndepends upon your business requirements an\", \"d will affect both the cost and complexity of your\\nsystem. For example, a multi-region deployment is\", \" more expensive and more complex to manage\\nthan a single-region deployment. You\\u2019ll need operational \", \"procedures to manage failover and failback.\\nThe additional cost and complexity might be justified fo\", \"r some business scenarios, but not others.\\n\\n\\nTo architect redundancy, you need to identify the criti\", \"cal paths in your application, and then\\ndetermine if there\\u2019s redundancy at each point in the path? I\", \"f a subsystem should fail, will the\\napplication fail over to something else? Finally, you need a cle\", \"ar understanding of those features built\\n\\n\\n118 CHAPTER 6 | Cloud-native resiliency\\n\\n\\ninto the Azure \", \"cloud platform that you can leverage to meet your redundancy requirements. Here are\\nrecommendations \", \"for architecting redundancy:\\n\\n\\n  - _Deploy multiple instances of services._ If your application depe\", \"nds on a single instance of a\\nservice, it creates a single point of failure. Provisioning multiple i\", \"nstances improves both\\nresiliency and scalability. When hosting in Azure Kubernetes Service, you can\", \" declaratively\\nconfigure redundant instances (replica sets) in the Kubernetes manifest file. The rep\", \"lica count\\nvalue can be managed programmatically, in the portal, or through autoscaling features.\\n\\n\\n\", \"  - _Leveraging a load balancer._ Load-balancing distributes your application\\u2019s requests to healthy\\n\", \"service instances and automatically removes unhealthy instances from rotation. When\\ndeploying to Kub\", \"ernetes, load balancing can be specified in the Kubernetes manifest file in\\nthe Services section.\\n\\n\\n\", \"  - _Plan for multiregion deployment._ If you deploy your application to a single region, and that\\nr\", \"egion becomes unavailable, your application will also become unavailable. This may be\\nunacceptable u\", \"nder the terms of your application\\u2019s service level agreements. Instead, consider\\ndeploying your appl\", \"ication and its services across multiple regions. For example, an Azure\\nKubernetes Service (AKS) clu\", \"ster is deployed to a single region. To protect your system from a\\nregional failure, you might deplo\", \"y your application to multiple AKS clusters across different\\n[regions and use the Paired Regions](ht\", \"tps://docs.microsoft.com/azure/virtual-machines/regions#region-pairs) feature to coordinate platform\", \" updates and prioritize\\nrecovery efforts.\\n\\n\\n  - _[Enable geo-replication.](https://docs.microsoft.co\", \"m/azure/sql-database/sql-database-active-geo-replication)_ Geo-replication for services such as Azur\", \"e SQL Database and Cosmos\\nDB will create secondary replicas of your data across multiple regions. Wh\", \"ile both services will\\nautomatically replicate data within the same region, geo-replication protects\", \" you against a\\nregional outage by enabling you to fail over to a secondary region. Another best prac\", \"tice for\\ngeo-replication centers around storing container images. To deploy a service in AKS, you\\nne\", \"ed to store and pull the image from a repository. Azure Container Registry integrates with\\nAKS and c\", \"an securely store container images. To improve performance and availability,\\nconsider geo-replicatin\", \"g your images to a registry in each region where you have an AKS\\ncluster. Each AKS cluster then pull\", \"s container images from the local container registry in its\\nregion as shown in Figure 6-4:\\n\\n\\n_Figure\", \" 6-4. Replicated resources across regions_\\n\\n\\n119 CHAPTER 6 | Cloud-native resiliency\\n\\n\\n  - _Implemen\", \"t a DNS traffic load balancer._ [Azure Traffic Manager](https://docs.microsoft.com/azure/traffic-man\", \"ager/traffic-manager-overview) provides high-availability for\\ncritical applications by load-balancin\", \"g at the DNS level. It can route traffic to different regions\\nbased on geography, cluster response t\", \"ime, and even application endpoint health. For\\nexample, Azure Traffic Manager can direct customers t\", \"o the closest AKS cluster and\\napplication instance. If you have multiple AKS clusters in different r\", \"egions, use Traffic\\nManager to control how traffic flows to the applications that run in each cluste\", \"r. Figure 6-5\\nshows this scenario.\\n\\n\\n_Figure 6-5. AKS and Azure Traffic Manager_\\n\\n#### **Design for \", \"scalability**\\n\\n\\nThe cloud thrives on scaling. The ability to increase/decrease system resources to a\", \"ddress\\nincreasing/decreasing system load is a key tenet of the Azure cloud. But, to effectively scal\", \"e an\\napplication, you need an understanding of the scaling features of each Azure service that you i\", \"nclude\\nin your application. Here are recommendations for effectively implementing scaling in your sy\", \"stem.\\n\\n\\n  - _Design for scaling._ An application must be designed for scaling. To start, services sh\", \"ould be\\nstateless so that requests can be routed to any instance. Having stateless services also mea\", \"ns\\nthat adding or removing an instance doesn\\u2019t adversely impact current users.\\n\\n\\n  - _Partition work\", \"loads_ . Decomposing domains into independent, self-contained microservices\\nenable each service to s\", \"cale independently of others. Typically, services will have different\\nscalability needs and requirem\", \"ents. Partitioning enables you to scale only what needs to be\\nscaled without the unnecessary cost of\", \" scaling an entire application.\\n\\n\\n  - _Favor scale-out._ Cloud-based applications favor scaling out \", \"resources as opposed to scaling\\nup. Scaling out (also known as horizontal scaling) involves adding m\", \"ore service resources to\\nan existing system to meet and share a desired level of performance. Scalin\", \"g up (also known\\n\\n\\n120 CHAPTER 6 | Cloud-native resiliency\\n\\n\\nas vertical scaling) involves replacing\", \" existing resources with more powerful hardware (more\\ndisk, memory, and processing cores). Scaling o\", \"ut can be invoked automatically with the\\nautoscaling features available in some Azure cloud resource\", \"s. Scaling out across multiple\\nresources also adds redundancy to the overall system. Finally scaling\", \" up a single resource is\\ntypically more expensive than scaling out across many smaller resources. Fi\", \"gure 6-6 shows the\\ntwo approaches:\\n\\n\\n_Figure 6-6. Scale up versus scale out_\\n\\n\\n  - _Scale proportion\", \"ally._ When scaling a service, think in terms of _resource sets_ . If you were to\\ndramatically scale\", \" out a specific service, what impact would that have on back-end data\\nstores, caches and dependent s\", \"ervices? Some resources such as Cosmos DB can scale out\\nproportionally, while many others can\\u2019t. You\", \" want to ensure that you don\\u2019t scale out a\\nresource to a point where it will exhaust other associate\", \"d resources.\\n\\n\\n  - _Avoid affinity._ A best practice is to ensure a node doesn\\u2019t require local affin\", \"ity, often referred\\nto as a _sticky session_ . A request should be able to route to any instance. If\", \" you need to persist\\n[state, it should be saved to a distributed cache, such as Azure Redis cache.](\", \"https://azure.microsoft.com/services/cache/)\\n\\n\\n  - _Take advantage of platform autoscaling features.\", \"_ Use built-in autoscaling features whenever\\npossible, rather than custom or third-party mechanisms.\", \" Where possible, use scheduled\\nscaling rules to ensure that resources are available without a startu\", \"p delay, but add reactive\\nautoscaling to the rules as appropriate, to cope with unexpected changes i\", \"n demand. For\\n[more information, see Autoscaling guidance.](https://docs.microsoft.com/azure/archite\", \"cture/best-practices/auto-scaling)\\n\\n\\n  - _Scale out aggressively._ A final practice would be to scal\", \"e out aggressively so that you can\\nquickly meet immediate spikes in traffic without losing business.\", \" And, then scale in (that is,\\nremove unneeded instances) conservatively to keep the system stable. A\", \" simple way to\\nimplement this is to set the cool down period, which is the time to wait between scal\", \"ing\\noperations, to five minutes for adding resources and up to 15 minutes for removing instances.\\n\\n#\", \"### **Built-in retry in services**\\n\\n\\nWe encouraged the best practice of implementing programmatic re\", \"try operations in an earlier section.\\nKeep in mind that many Azure services and their corresponding \", \"client SDKs also include retry\\n\\n\\n121 CHAPTER 6 | Cloud-native resiliency\\n\\n\\nmechanisms. The following\", \" list summarizes retry features in the many of the Azure services that are\\ndiscussed in this book:\\n\\n\", \"\\n  - _Azure Cosmos DB._ [The DocumentClient](https://docs.microsoft.com/dotnet/api/microsoft.azure.d\", \"ocuments.client.documentclient) class from the client API automatically retires failed\\nattempts. The\", \" number of retries and maximum wait time are configurable. Exceptions thrown\\nby the client API are e\", \"ither requests that exceed the retry policy or non-transient errors.\\n\\n\\n  - _Azure Redis Cache._ The \", \"Redis StackExchange client uses a connection manager class that\\nincludes retries on failed attempts.\", \" The number of retries, specific retry policy and wait time\\nare all configurable.\\n\\n\\n  - _Azure Servi\", \"ce Bus._ [The Service Bus client exposes a RetryPolicy class](xref:Microsoft.ServiceBus.RetryPolicy)\", \" that can be configured\\n[with a back-off interval, retry count, and TerminationTimeBuffer, which spe\", \"cifies the maximum](https://docs.microsoft.com/dotnet/api/microsoft.servicebus.retryexponential.term\", \"inationtimebuffer)\\ntime an operation can take. The default policy is nine maximum retry attempts wit\", \"h a 30second backoff period between attempts.\\n\\n\\n  - _Azure SQL Database._ [Retry support is provided\", \" when using the Entity Framework Core library.](https://docs.microsoft.com/ef/core/miscellaneous/con\", \"nection-resiliency)\\n\\n\\n  - _Azure Storage._ The storage client library support retry operations. The \", \"strategies vary across\\nAzure storage tables, blobs, and queues. As well, alternate retries switch be\", \"tween primary and\\nsecondary storage services locations when the geo-redundancy feature is enabled.\\n\\n\", \"\\n  - _Azure Event Hubs._ The Event Hub client library features a RetryPolicy property, which include\", \"s\\na configurable exponential backoff feature.\\n\\n### Resilient communications\\n\\n\\nThroughout this book, \", \"we\\u2019ve embraced a microservice-based architectural approach. While such an\\narchitecture provides impo\", \"rtant benefits, it presents many challenges:\\n\\n\\n  - _Out-of-process network communication._ Each micr\", \"oservice communicates over a network\\nprotocol that introduces network congestion, latency, and trans\", \"ient faults.\\n\\n\\n  - _Service discovery._ How do microservices discover and communicate with each othe\", \"r when\\nrunning across a cluster of machines with their own IP addresses and ports?\\n\\n\\n  - _Resiliency\", \"._ How do you manage short-lived failures and keep the system stable?\\n\\n\\n  - _Load balancing._ How do\", \"es inbound traffic get distributed across multiple instances of a\\nmicroservice?\\n\\n\\n  - _Security._ Ho\", \"w are security concerns such as transport-level encryption and certificate\\nmanagement enforced?\\n\\n\\n  \", \"- _Distributed Monitoring._  - How do you correlate and capture traceability and monitoring for a\\nsi\", \"ngle request across multiple consuming microservices?\\n\\n\\nYou can address these concerns with differen\", \"t libraries and frameworks, but the implementation can\\nbe expensive, complex, and time-consuming. Yo\", \"u also end up with infrastructure concerns coupled to\\nbusiness logic.\\n\\n\\n122 CHAPTER 6 | Cloud-native\", \" resiliency\\n\\n\\n#### **Service mesh**\\n\\nA better approach is an evolving technology entitled _Service M\", \"esh_ [. A service mesh](https://www.nginx.com/blog/what-is-a-service-mesh/) is a configurable\\ninfras\", \"tructure layer with built-in capabilities to handle service communication and the other\\nchallenges m\", \"entioned above. It decouples these concerns by moving them into a service proxy. The\\n[proxy is deplo\", \"yed into a separate process (called a sidecar) to provide isolation from business code.](https://doc\", \"s.microsoft.com/azure/architecture/patterns/sidecar)\\nHowever, the sidecar is linked to the service -\", \" it\\u2019s created with it and shares its lifecycle. Figure 6-7\\nshows this scenario.\\n\\n\\n_Figure 6-7. Servi\", \"ce mesh with a side car_\\n\\n\\nIn the previous figure, note how the proxy intercepts and manages communi\", \"cation among the\\nmicroservices and the cluster.\\n\\n\\n[A service mesh is logically split into two dispar\", \"ate components: A data plane](https://blog.envoyproxy.io/service-mesh-data-plane-vs-control-plane-27\", \"74e720f7fc) [and control plane. Figure](https://blog.envoyproxy.io/service-mesh-data-plane-vs-contro\", \"l-plane-2774e720f7fc)\\n6-8 shows these components and their responsibilities.\\n\\n\\n123 CHAPTER 6 | Cloud\", \"-native resiliency\\n\\n\\n_Figure 6-8. Service mesh control and data plane_\\n\\n\\nOnce configured, a service \", \"mesh is highly functional. It can retrieve a corresponding pool of instances\\nfrom a service discover\", \"y endpoint. The mesh can then send a request to a specific instance, recording\\nthe latency and respo\", \"nse type of the result. A mesh can choose the instance most likely to return a\\nfast response based o\", \"n many factors, including its observed latency for recent requests.\\n\\n\\nIf an instance is unresponsive\", \" or fails, the mesh will retry the request on another instance. If it returns\\nerrors, a mesh will ev\", \"ict the instance from the load-balancing pool and restate it after it heals. If a\\nrequest times out,\", \" a mesh can fail and then retry the request. A mesh captures and emits metrics and\\ndistributed traci\", \"ng to a centralized metrics system.\\n\\n#### **Istio and Envoy**\\n\\n\\n[While a few service mesh options cu\", \"rrently exist, Istio](https://istio.io/docs/concepts/what-is-istio/) is the most popular at the time\", \" of this writing.\\nIstio is a joint venture from IBM, Google, and Lyft. It\\u2019s an open-source offering \", \"that can be integrated\\ninto a new or existing distributed application. The technology provides a con\", \"sistent and complete\\nsolution to secure, connect, and monitor microservices. Its features include:\\n\\n\", \"\\n  - Secure service-to-service communication in a cluster with strong identity-based\\nauthentication \", \"and authorization.\\n\\n  - [Automatic load balancing for HTTP, gRPC, WebSocket, and TCP traffic.](https\", \"://grpc.io/)\\n\\n  - Fine-grained control of traffic behavior with rich routing rules, retries, failove\", \"rs, and fault\\ninjection.\\n\\n  - A pluggable policy layer and configuration API supporting access contr\", \"ols, rate limits, and\\nquotas.\\n\\n  - Automatic metrics, logs, and traces for all traffic within a clus\", \"ter, including cluster ingress and\\negress.\\n\\n\\n[A key component for an Istio implementation is a proxy\", \" service entitled the Envoy proxy. It runs](https://www.envoyproxy.io/docs/envoy/latest/intro/what_i\", \"s_envoy)\\nalongside each service and provides a platform-agnostic foundation for the following featur\", \"es:\\n\\n\\n  - Dynamic service discovery.\\n\\n  - Load balancing.\\n\\n\\n124 CHAPTER 6 | Cloud-native resiliency\\n\", \"\\n\\n  - TLS termination.\\n\\n  - HTTP and gRPC proxies.\\n\\n  - Circuit breaker resiliency.\\n\\n  - Health chec\", \"ks.\\n\\n  - [Rolling updates with canary](https://martinfowler.com/bliki/CanaryRelease.html) deployment\", \"s.\\n\\n\\nAs previously discussed, Envoy is deployed as a sidecar to each microservice in the cluster.\\n\\n#\", \"### **Integration with Azure Kubernetes Services**\\n\\n\\nThe Azure cloud embraces Istio and provides dir\", \"ect support for it within Azure Kubernetes Services.\\nThe following links can help you get started:\\n\\n\", \"\\n  - [Installing Istio in AKS](https://docs.microsoft.com/azure/aks/istio-install)\\n\\n  - [Using AKS a\", \"nd Istio](https://docs.microsoft.com/azure/aks/istio-scenario-routing)\\n\\n\\n**References**\\n\\n\\n  - [Polly\", \"](https://old.dotnetfoundation.org/projects/polly)\\n\\n\\n  - [Retry pattern](https://docs.microsoft.com/\", \"azure/architecture/patterns/retry)\\n\\n\\n  - [Circuit Breaker pattern](https://docs.microsoft.com/azure/\", \"architecture/patterns/circuit-breaker)\\n\\n\\n  - [Resilience in Azure whitepaper](https://azure.microsof\", \"t.com/mediahandler/files/resourcefiles/resilience-in-azure-whitepaper/Resilience%20in%20Azure.pdf)\\n\\n\", \"\\n  - [network latency](https://www.techopedia.com/definition/8553/network-latency)\\n\\n\\n  - [Redundancy\", \"](https://docs.microsoft.com/azure/architecture/guide/design-principles/redundancy)\\n\\n\\n  - [geo-repli\", \"cation](https://docs.microsoft.com/azure/sql-database/sql-database-active-geo-replication)\\n\\n\\n  - [Az\", \"ure Traffic Manager](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview)\\n\\n\\n  \", \"- [Autoscaling guidance](https://docs.microsoft.com/azure/architecture/best-practices/auto-scaling)\\n\", \"\\n\\n  - [Istio](https://istio.io/docs/concepts/what-is-istio/)\\n\\n\\n  - [Envoy proxy](https://www.envoypr\", \"oxy.io/docs/envoy/latest/intro/what_is_envoy)\\n\\n\\n125 CHAPTER 6 | Cloud-native resiliency\\n\\n\\n**CHAPTER*\", \"*\\n# 7\\n\\n## Monitoring and health\\n\\n\\nMicroservices and cloud-native applications go hand in hand with g\", \"ood DevOps practices. DevOps is\\nmany things to many people but perhaps one of the better definitions\", \" comes from cloud advocate\\nand DevOps evangelist Donovan Brown:\\n\\n\\n\\u201cDevOps is the union of people, pr\", \"ocess, and products to enable continuous delivery of value to our\\nend users.\\u201d\\n\\n\\nUnfortunately, with \", \"terse definitions, there\\u2019s always room to say more things. One of the key\\ncomponents of DevOps is en\", \"suring that the applications running in production are functioning\\nproperly and efficiently. To gaug\", \"e the health of the application in production, it\\u2019s necessary to monitor\\nthe various logs and metric\", \"s being produced from the servers, hosts, and the application proper. The\\nnumber of different servic\", \"es running in support of a cloud-native application makes monitoring the\\nhealth of individual compon\", \"ents and the application as a whole a critical challenge.\\n\\n### Observability patterns\\n\\n\\nJust as patt\", \"erns have been developed to aid in the layout of code in applications, there are patterns\\nfor operat\", \"ing applications in a reliable way. Three useful patterns in maintaining applications have\\nemerged: \", \"**logging**, **monitoring**, and **alerts** .\\n\\n#### **When to use logging**\\n\\n\\nNo matter how careful \", \"we are, applications almost always behave in unexpected ways in production.\\nWhen users report proble\", \"ms with an application, it\\u2019s useful to be able to see what was going on with\\nthe app when the proble\", \"m occurred. One of the most tried and true ways of capturing information\\nabout what an application i\", \"s doing while it\\u2019s running is to have the application write down what it\\u2019s\\ndoing. This process is kn\", \"own as logging. Anytime failures or problems occur in production, the goal\\nshould be to reproduce th\", \"e conditions under which the failures occurred, in a non-production\\nenvironment. Having good logging\", \" in place provides a roadmap for developers to follow in order to\\nduplicate problems in an environme\", \"nt that can be tested and experimented with.\\n\\n\\n**Challenges when logging with cloud-native applicati\", \"ons**\\n\\n\\nIn traditional applications, log files are typically stored on the local machine. In fact, o\", \"n Unix-like\\noperating systems, there\\u2019s a folder structure defined to hold any logs, typically under \", \"/var/log.\\n\\n\\n126 CHAPTER 7 | Monitoring and health\\n\\n\\n_Figure 7-1. Logging to a file in a monolithic a\", \"pp._\\n\\n\\nThe usefulness of logging to a flat file on a single machine is vastly reduced in a cloud env\", \"ironment.\\nApplications producing logs may not have access to the local disk or the local disk may be\", \" highly\\ntransient as containers are shuffled around physical machines. Even simple scaling up of mon\", \"olithic\\napplications across multiple nodes can make it challenging to locate the appropriate file-ba\", \"sed log\\nfile.\\n\\n\\n_Figure 7-2. Logging to files in a scaled monolithic app._\\n\\n\\nCloud-native applicatio\", \"ns developed using a microservices architecture also pose some challenges for\\nfile-based loggers. Us\", \"er requests may now span multiple services that are run on different machines\\n\\n\\n127 CHAPTER 7 | Moni\", \"toring and health\\n\\n\\nand may include serverless functions with no access to a local file system at al\", \"l. It would be very\\nchallenging to correlate the logs from a user or a session across these many ser\", \"vices and machines.\\n\\n\\n_Figure 7-3. Logging to local files in a microservices app._\\n\\n\\nFinally, the nu\", \"mber of users in some cloud-native applications is high. Imagine that each user\\ngenerates a hundred \", \"lines of log messages when they log into an application. In isolation, that is\\nmanageable, but multi\", \"ply that over 100,000 users and the volume of logs becomes large enough that\\nspecialized tools are n\", \"eeded to support effective use of the logs.\\n\\n\\n**Logging in cloud-native applications**\\n\\n\\nEvery progr\", \"amming language has tooling that permits writing logs, and typically the overhead for\\nwriting these \", \"logs is low. Many of the logging libraries provide logging different kinds of criticalities,\\n[which \", \"can be tuned at run time. For instance, the Serilog library](https://serilog.net/) is a popular stru\", \"ctured logging library\\nfor .NET that provides the following logging levels:\\n\\n\\n  - Verbose\\n\\n  - Debug\", \"\\n\\n  - Information\\n\\n  - Warning\\n\\n  - Error\\n\\n  - Fatal\\n\\n\\nThese different log levels provide granularit\", \"y in logging. When the application is functioning properly\\nin production, it may be configured to on\", \"ly log important messages. When the application is\\n\\n\\n128 CHAPTER 7 | Monitoring and health\\n\\n\\nmisbeha\", \"ving, then the log level can be increased so more verbose logs are gathered. This balances\\nperforman\", \"ce against ease of debugging.\\n\\n\\nThe high performance of logging tools and the tunability of verbosit\", \"y should encourage developers to\\nlog frequently. Many favor a pattern of logging the entry and exit \", \"of each method. This approach may\\nsound like overkill, but it\\u2019s infrequent that developers will wish\", \" for less logging. In fact, it\\u2019s not\\nuncommon to perform deployments for the sole purpose of adding \", \"logging around a problematic\\nmethod. Err on the side of too much logging and not on too little. Some\", \" tools can be used to\\nautomatically provide this kind of logging.\\n\\n\\nBecause of the challenges associ\", \"ated with using file-based logs in cloud-native apps, centralized logs\\nare preferred. Logs are colle\", \"cted by the applications and shipped to a central logging application\\nwhich indexes and stores the l\", \"ogs. This class of system can ingest tens of gigabytes of logs every day.\\n\\n\\nIt\\u2019s also helpful to fol\", \"low some standard practices when building logging that spans many services.\\n[For instance, generatin\", \"g a correlation ID](https://blog.rapid7.com/2016/12/23/the-value-of-correlation-ids/) at the start o\", \"f a lengthy interaction, and then logging it in\\neach message that is related to that interaction, ma\", \"kes it easier to search for all related messages. One\\nneed only find a single message and extract th\", \"e correlation ID to find all the related messages.\\nAnother example is ensuring that the log format i\", \"s the same for every service, whatever the language\\nor logging library it uses. This standardization\", \" makes reading logs much easier. Figure 7-4\\ndemonstrates how a microservices architecture can levera\", \"ge centralized logging as part of its\\nworkflow.\\n\\n\\n_Figure 7-4. Logs from various sources are ingeste\", \"d into a centralized log store._\\n\\n\\n129 CHAPTER 7 | Monitoring and health\\n\\n\\n#### **Challenges with de\", \"tecting and responding to potential app health** **issues**\\n\\nSome applications aren\\u2019t mission critic\", \"al. Maybe they\\u2019re only used internally, and when a problem\\noccurs, the user can contact the team res\", \"ponsible and the application can be restarted. However,\\ncustomers often have higher expectations for\", \" the applications they consume. You should know when\\nproblems occur with your application _before_ u\", \"sers do, or before users notify you. Otherwise, the first\\nyou know about a problem may be when you n\", \"otice an angry deluge of social media posts deriding\\nyour application or even your organization.\\n\\n\\nS\", \"ome scenarios you may need to consider include:\\n\\n\\n  - One service in your application keeps failing \", \"and restarting, resulting in intermittent slow\\nresponses.\\n\\n  - At some times of the day, your applic\", \"ation\\u2019s response time is slow.\\n\\n  - After a recent deployment, load on the database has tripled.\\n\\n\\nI\", \"mplemented properly, monitoring can let you know about conditions that will lead to problems,\\nlettin\", \"g you address underlying conditions before they result in any significant user impact.\\n\\n\\n**Monitorin\", \"g cloud-native apps**\\n\\n\\nSome centralized logging systems take on an additional role of collecting te\", \"lemetry outside of pure\\nlogs. They can collect metrics, such as time to run a database query, averag\", \"e response time from a\\nweb server, and even CPU load averages and memory pressure as reported by the\", \" operating system.\\nIn conjunction with the logs, these systems can provide a holistic view of the he\", \"alth of nodes in the\\nsystem and the application as a whole.\\n\\n\\nThe metric-gathering capabilities of t\", \"he monitoring tools can also be fed manually from within the\\napplication. Business flows that are of\", \" particular interest such as new users signing up or orders being\\nplaced, may be instrumented such t\", \"hat they increment a counter in the central monitoring system.\\nThis aspect unlocks the monitoring to\", \"ols to not only monitor the health of the application but the\\nhealth of the business.\\n\\n\\nQueries can \", \"be constructed in the log aggregation tools to look for certain statistics or patterns, which\\ncan th\", \"en be displayed in graphical form, on custom dashboards. Frequently, teams will invest in large,\\nwal\", \"l-mounted displays that rotate through the statistics related to an application. This way, it\\u2019s simp\", \"le\\nto see the problems as they occur.\\n\\n\\nCloud-native monitoring tools provide real-time telemetry an\", \"d insight into apps regardless of whether\\nthey\\u2019re single-process monolithic applications or distribu\", \"ted microservice architectures. They include\\ntools that allow collection of data from the app as wel\", \"l as tools for querying and displaying\\ninformation about the app\\u2019s health.\\n\\n#### **Challenges with r\", \"eacting to critical problems in cloud-native apps**\\n\\n\\nIf you need to react to problems with your app\", \"lication, you need some way to alert the right\\npersonnel. This is the third cloud-native application\", \" observability pattern and depends on logging and\\nmonitoring. Your application needs to have logging\", \" in place to allow problems to be diagnosed, and\\n\\n\\n130 CHAPTER 7 | Monitoring and health\\n\\n\\nin some c\", \"ases to feed into monitoring tools. It needs monitoring to aggregate application metrics and\\nhealth \", \"data in one place. Once this has been established, rules can be created that will trigger alerts\\nwhe\", \"n certain metrics fall outside of acceptable levels.\\n\\n\\nGenerally, alerts are layered on top of monit\", \"oring such that certain conditions trigger appropriate\\nalerts to notify team members of urgent probl\", \"ems. Some scenarios that may require alerts include:\\n\\n\\n  - One of your application\\u2019s services is not\", \" responding after 1 minute of downtime.\\n\\n  - Your application is returning unsuccessful HTTP respons\", \"es to more than 1% of requests.\\n\\n  - Your application\\u2019s average response time for key endpoints exce\", \"eds 2000 ms.\\n\\n\\n**Alerts in cloud-native apps**\\n\\n\\nYou can craft queries against the monitoring tools \", \"to look for known failure conditions. For instance,\\nqueries could search through the incoming logs f\", \"or indications of HTTP status code 500, which\\nindicates a problem on a web server. As soon as one of\", \" these is detected, then an e-mail or an SMS\\ncould be sent to the owner of the originating service w\", \"ho can begin to investigate.\\n\\n\\nTypically, though, a single 500 error isn\\u2019t enough to determine that \", \"a problem has occurred. It could\\nmean that a user mistyped their password or entered some malformed \", \"data. The alert queries can be\\ncrafted to only fire when a larger than average number of 500 errors \", \"are detected.\\n\\n\\nOne of the most damaging patterns in alerting is to fire too many alerts for humans \", \"to investigate.\\nService owners will rapidly become desensitized to errors that they\\u2019ve previously in\", \"vestigated and\\nfound to be benign. Then, when true errors occur, they\\u2019ll be lost in the noise of hun\", \"dreds of false\\n[positives. The parable of the Boy Who Cried Wolf](https://en.wikipedia.org/wiki/The_\", \"Boy_Who_Cried_Wolf) is frequently told to children to warn them of this\\nvery danger. It\\u2019s important \", \"to ensure that the alerts that do fire are indicative of a real problem.\\n\\n### Logging with Elastic S\", \"tack\\n\\n\\nThere are many good centralized logging tools and they vary in cost from being free, open-sou\", \"rce\\ntools, to more expensive options. In many cases, the free tools are as good as or better than th\", \"e paid\\nofferings. One such tool is a combination of three open-source components: Elasticsearch, Log\", \"stash,\\nand Kibana.\\n\\n\\nCollectively these tools are known as the Elastic Stack or ELK stack.\\n\\n#### **E\", \"lastic Stack**\\n\\n\\nThe Elastic Stack is a powerful option for gathering information from a Kubernetes \", \"cluster. Kubernetes\\n[supports sending logs to an Elasticsearch endpoint, and for the most part, all \", \"you need to get started](https://www.elastic.co/guide/en/kibana/master/logging-configuration.html)\\ni\", \"s to set the environment variables as shown in Figure 7-5:\\n\\n```\\nKUBE_LOGGING_DESTINATION=elasticsear\", \"ch\\nKUBE_ENABLE_NODE_LOGGING=true\\n\\n```\\n\\n_Figure 7-5. Configuration variables for Kubernetes_\\n\\n\\nThis s\", \"tep will install Elasticsearch on the cluster and target sending all the cluster logs to it.\\n\\n\\n131 C\", \"HAPTER 7 | Monitoring and health\\n\\n\\n_Figure 7-6. An example of a Kibana dashboard showing the results\", \" of a query against logs that are ingested from_\\n_Kubernetes_\\n\\n#### **What are the advantages of Ela\", \"stic Stack?**\\n\\n\\nElastic Stack provides centralized logging in a low-cost, scalable, cloud-friendly m\", \"anner. Its user\\ninterface streamlines data analysis so you can spend your time gleaning insights fro\", \"m your data\\ninstead of fighting with a clunky interface. It supports a wide variety of inputs so as \", \"your distributed\\napplication spans more and different kinds of services, you can expect to continue \", \"to be able to feed\\nlog and metric data into the system. The Elastic Stack also supports fast searche\", \"s even across large\\ndata sets, making it possible even for large applications to log detailed data a\", \"nd still be able to have\\nvisibility into it in a performant fashion.\\n\\n#### **Logstash**\\n\\n\\n[The first\", \" component is Logstash. This tool is used to gather log information from a large variety of](https:/\", \"/www.elastic.co/products/logstash)\\ndifferent sources. For instance, Logstash can read logs from disk\", \" and also receive messages from\\n[logging libraries like Serilog. Logstash can do some basic filterin\", \"g and expansion on the logs as they](https://serilog.net/)\\narrive. For instance, if your logs contai\", \"n IP addresses then Logstash may be configured to do a\\ngeographical lookup and obtain a country/regi\", \"on or even city of origin for that message.\\n\\n\\nSerilog is a logging library for .NET languages, which\", \" allows for parameterized logging. Instead of\\ngenerating a textual log message that embeds fields, p\", \"arameters are kept separate. This library allows\\nfor more intelligent filtering and searching. A sam\", \"ple Serilog configuration for writing to Logstash\\nappears in Figure 7-7.\\n\\n\\n_Figure 7-7. Serilog conf\", \"ig for writing log information directly to logstash over HTTP_\\n\\n\\nLogstash would use a configuration \", \"like the one shown in Figure 7-8.\\n\\n\\n132 CHAPTER 7 | Monitoring and health\\n\\n\\n_Figure 7-8. A Logstash \", \"configuration for consuming logs from Serilog_\\n\\n\\nFor scenarios where extensive log manipulation isn\\u2019\", \"t needed there\\u2019s an alternative to Logstash known\\n[as Beats. Beats is a family of tools that can gat\", \"her a wide variety of data from logs to network data](https://www.elastic.co/products/beats)\\nand upt\", \"ime information. Many applications will use both Logstash and Beats.\\n\\n\\nOnce the logs have been gathe\", \"red by Logstash, it needs somewhere to put them. While Logstash\\nsupports many different outputs, one\", \" of the more exciting ones is Elasticsearch.\\n\\n#### **Elasticsearch**\\n\\n\\nElasticsearch is a powerful s\", \"earch engine that can index logs as they arrive. It makes running queries\\nagainst the logs quick. El\", \"asticsearch can handle huge quantities of logs and, in extreme cases, can be\\nscaled out across many \", \"nodes.\\n\\n\\nLog messages that have been crafted to contain parameters or that have had parameters split\", \" from\\nthem through Logstash processing, can be queried directly as Elasticsearch preserves this info\", \"rmation.\\n\\n\\nA query that searches for the top 10 pages visited by jill@example.com, appears in Figure\", \" 7-9.\\n\\n\\n_Figure 7-9. An Elasticsearch query for finding top 10 pages visited by a user_\\n\\n#### **Visu\", \"alizing information with Kibana web dashboards**\\n\\n\\nThe final component of the stack is Kibana. This \", \"tool is used to provide interactive visualizations in a\\nweb dashboard. Dashboards may be crafted eve\", \"n by users who are non-technical. Most data that is\\nresident in the Elasticsearch index, can be incl\", \"uded in the Kibana dashboards. Individual users may\\n\\n\\n133 CHAPTER 7 | Monitoring and health\\n\\n\\nhave d\", \"ifferent dashboard desires and Kibana enables this customization through allowing userspecific dashb\", \"oards.\\n\\n#### **Installing Elastic Stack on Azure**\\n\\n\\n[The Elastic stack can be installed on Azure in\", \" many ways. As always, it\\u2019s possible to provision virtual](https://docs.microsoft.com/azure/virtual-\", \"machines/linux/tutorial-elasticsearch)\\n[machines and install Elastic Stack on them directly. This op\", \"tion is preferred by some experienced users](https://docs.microsoft.com/azure/virtual-machines/linux\", \"/tutorial-elasticsearch)\\nas it offers the highest degree of customizability. Deploying on infrastruc\", \"ture as a service introduces\\nsignificant management overhead forcing those who take that path to tak\", \"e ownership of all the tasks\\nassociated with infrastructure as a service such as securing the machin\", \"es and keeping up-to-date with\\npatches.\\n\\n\\nAn option with less overhead is to make use of one of the \", \"many Docker containers on which the\\nElastic Stack has already been configured. These containers can \", \"be dropped into an existing\\n[Kubernetes cluster and run alongside application code. The sebp/elk](ht\", \"tps://elk-docker.readthedocs.io/) container is a well-documented\\nand tested Elastic Stack container.\", \"\\n\\n\\n[Another option is a recently announced ELK-as-a-service offering.](https://devops.com/logz-io-un\", \"veils-azure-open-source-elk-monitoring-solution/)\\n\\n#### **References**\\n\\n\\n  - [Install Elastic Stack \", \"on Azure](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-elasticsearch)\\n\\n### Monit\", \"oring in Azure Kubernetes Services\\n\\n\\nThe built-in logging in Kubernetes is primitive. However, there\", \" are some great options for getting the\\nlogs out of Kubernetes and into a place where they can be pr\", \"operly analyzed. If you need to monitor\\nyour AKS clusters, configuring Elastic Stack for Kubernetes \", \"is a great solution.\\n\\n#### **Azure Monitor for Containers**\\n\\n\\n[Azure Monitor for Containers supports\", \" consuming logs from not just Kubernetes but also from other](https://docs.microsoft.com/azure/azure\", \"-monitor/insights/container-insights-overview)\\norchestration engines such as DC/OS, Docker Swarm, an\", \"d Red Hat OpenShift.\\n\\n\\n134 CHAPTER 7 | Monitoring and health\\n\\n\\n_Figure 7-10. Consuming logs from var\", \"ious containers_\\n\\n\\n[Prometheus](https://prometheus.io/) is a popular open source metric monitoring s\", \"olution. It is part of the Cloud Native\\nCompute Foundation. Typically, using Prometheus requires man\", \"aging a Prometheus server with its\\n[own store. However, Azure Monitor for Containers provides direct\", \" integration with Prometheus](https://docs.microsoft.com/azure/azure-monitor/insights/container-insi\", \"ghts-prometheus-integration)\\n[metrics endpoints, so a separate server is not required.](https://docs\", \".microsoft.com/azure/azure-monitor/insights/container-insights-prometheus-integration)\\n\\n\\nLog and met\", \"ric information is gathered not just from the containers running in the cluster but also\\nfrom the cl\", \"uster hosts themselves. It allows correlating log information from the two making it much\\neasier to \", \"track down an error.\\n\\n\\n[Installing the log collectors differs on Windows](https://docs.microsoft.com\", \"/azure/azure-monitor/insights/containers#configure-a-log-analytics-windows-agent-for-kubernetes) [an\", \"d Linux](https://docs.microsoft.com/azure/azure-monitor/insights/containers#configure-a-log-analytic\", \"s-linux-agent-for-kubernetes) clusters. But in both cases the log collection\\n[is implemented as a Ku\", \"bernetes DaemonSet, meaning that the log collector is run as a container on](https://kubernetes.io/d\", \"ocs/concepts/workloads/controllers/daemonset/)\\neach of the nodes.\\n\\n\\nNo matter which orchestrator or \", \"operating system is running the Azure Monitor daemon, the log\\ninformation is forwarded to the same A\", \"zure Monitor tools with which users are familiar. This approach\\nensures a parallel experience in env\", \"ironments that mix different log sources such as a hybrid\\nKubernetes/Azure Functions environment.\\n\\n\\n\", \"135 CHAPTER 7 | Monitoring and health\\n\\n\\n_Figure 7-11. A sample dashboard showing logging and metric \", \"information from many running containers._\\n\\n#### **Log.Finalize()**\\n\\n\\nLogging is one of the most ove\", \"rlooked and yet most important parts of deploying any application at\\nscale. As the size and complexi\", \"ty of applications increase, then so does the difficulty of debugging\\nthem. Having top quality logs \", \"available makes debugging much easier and moves it from the realm of\\n\\u201cnearly impossible\\u201d to \\u201ca pleas\", \"ant experience\\u201d.\\n\\n### Azure Monitor\\n\\n\\nNo other cloud provider has as mature of a cloud application m\", \"onitoring solution than that found in\\nAzure. Azure Monitor is an umbrella name for a collection of t\", \"ools designed to provide visibility into\\nthe state of your system. It helps you understand how your \", \"cloud-native services are performing and\\nproactively identifies issues affecting them. Figure 7-12 p\", \"resents a high level of view of Azure Monitor.\\n\\n\\n136 CHAPTER 7 | Monitoring and health\\n\\n\\n_Figure 7-1\", \"2. High-level view of Azure Monitor._\\n\\n#### **Gathering logs and metrics**\\n\\n\\nThe first step in any m\", \"onitoring solution is to gather as much data as possible. The more data\\ngathered, the deeper the ins\", \"ights. Instrumenting systems has traditionally been difficult. Simple\\nNetwork Management Protocol (S\", \"NMP) was the gold standard protocol for collecting machine level\\ninformation, but it required a grea\", \"t deal of knowledge and configuration. Fortunately, much of this\\nhard work has been eliminated as th\", \"e most common metrics are gathered automatically by Azure\\nMonitor.\\n\\n\\nApplication level metrics and e\", \"vents aren\\u2019t possible to instrument automatically because they\\u2019re\\n[specific to the application being\", \" deployed. In order to gather these metrics, there are SDKs and APIs](https://docs.microsoft.com/azu\", \"re/azure-monitor/app/api-custom-events-metrics)\\n[available](https://docs.microsoft.com/azure/azure-m\", \"onitor/app/api-custom-events-metrics) to directly report such information, such as when a customer s\", \"igns up or completes an order.\\nExceptions can also be captured and reported back into Azure Monitor \", \"via Application Insights. The\\nSDKs support most every language found in Cloud Native Applications in\", \"cluding Go, Python,\\nJavaScript, and the .NET languages.\\n\\n\\nThe ultimate goal of gathering information\", \" about the state of your application is to ensure that your\\nend users have a good experience. What b\", \"etter way to tell if users are experiencing issues than doing\\n[outside-in web tests? These tests can\", \" be as simple as pinging your website from locations around the](https://docs.microsoft.com/azure/az\", \"ure-monitor/app/monitor-web-app-availability)\\nworld or as involved as having agents log into the sit\", \"e and simulate user actions.\\n\\n#### **Reporting data**\\n\\n\\nOnce the data is gathered, it can be manipul\", \"ated, summarized, and plotted into charts, which allow\\nusers to instantly see when there are problem\", \"s. These charts can be gathered into dashboards or into\\nWorkbooks, a multi-page report designed to t\", \"ell a story about some aspect of the system.\\n\\n\\n137 CHAPTER 7 | Monitoring and health\\n\\n\\nNo modern app\", \"lication would be complete without some artificial intelligence or machine learning. To\\n[this end, d\", \"ata can be passed to the various machine learning tools in Azure to allow you to extract](https://ww\", \"w.youtube.com/watch?v=Cuza-I1g9tw)\\ntrends and information that would otherwise be hidden.\\n\\n\\nApplicat\", \"ion Insights provides a powerful (SQL-like) query language called _Kusto_ that can query\\nrecords, su\", \"mmarize them, and even plot charts. For example, the following query will locate all records\\nfor the\", \" month of November 2007, group them by state, and plot the top 10 as a pie chart.\\n\\n\\nFigure 7-13 show\", \"s the results of this Application Insights Query.\\n\\n\\n_Figure 7-13. Application Insights query results\", \"._\\n\\n\\n[There is a playground for experimenting with Kusto queries. Reading sample queries can also be\", \"](https://dataexplorer.azure.com/clusters/help/databases/Samples)\\ninstructive.\\n\\n#### **Dashboards**\\n\", \"\\n\\nThere are several different dashboard technologies that may be used to surface the information fro\", \"m\\n[Azure Monitor. Perhaps the simplest is to just run queries in Application Insights and plot the d\", \"ata](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-app-dashboards)\\n[into a chart.](h\", \"ttps://docs.microsoft.com/azure/azure-monitor/learn/tutorial-app-dashboards)\\n\\n\\n138 CHAPTER 7 | Monit\", \"oring and health\\n\\n\\n_Figure 7-14. An example of Application Insights charts embedded in the main Azur\", \"e Dashboard._\\n\\n\\nThese charts can then be embedded in the Azure portal proper through use of the dash\", \"board feature.\\nFor users with more exacting requirements, such as being able to drill down into seve\", \"ral tiers of data,\\n[Azure Monitor data is available to Power BI. Power BI is an industry-leading, en\", \"terprise class, business](https://powerbi.microsoft.com/)\\nintelligence tool that can aggregate data \", \"from many different data sources.\\n\\n\\n139 CHAPTER 7 | Monitoring and health\\n\\n\\n_Figure 7-15. An example\", \" Power BI dashboard._\\n\\n#### **Alerts**\\n\\n\\nSometimes, having data dashboards is insufficient. If nobod\", \"y is awake to watch the dashboards, then\\nit can still be many hours before a problem is addressed, o\", \"r even detected. To this end, Azure Monitor\\n[also provides a top notch alerting solution. Alerts can\", \" be triggered by a wide range of conditions](https://docs.microsoft.com/azure/azure-monitor/platform\", \"/alerts-overview)\\nincluding:\\n\\n\\n  - Metric values\\n\\n  - Log search queries\\n\\n  - Activity Log events\\n\\n \", \" - Health of the underlying Azure platform\\n\\n  - Tests for web site availability\\n\\n\\nWhen triggered, th\", \"e alerts can perform a wide variety of tasks. On the simple side, the alerts may just\\nsend an e-mail\", \" notification to a mailing list or a text message to an individual. More involved alerts\\n\\n\\n140 CHAPT\", \"ER 7 | Monitoring and health\\n\\n\\nmight trigger a workflow in a tool such as PagerDuty, which is aware \", \"of who is on call for a particular\\n[application. Alerts can trigger actions in Microsoft Flow](https\", \"://flow.microsoft.com/) unlocking near limitless possibilities for\\nworkflows.\\n\\n\\nAs common causes of \", \"alerts are identified, the alerts can be enhanced with details about the common\\ncauses of the alerts\", \" and the steps to take to resolve them. Highly mature cloud-native application\\ndeployments may opt t\", \"o kick off self-healing tasks, which perform actions such as removing failing\\nnodes from a scale set\", \" or triggering an autoscaling activity. Eventually it may no longer be necessary\\nto wake up on-call \", \"personnel at 2AM to resolve a live-site issue as the system will be able to adjust\\nitself to compens\", \"ate or at least limp along until somebody arrives at work the next morning.\\n\\n\\nAzure Monitor automati\", \"cally leverages machine learning to understand the normal operating\\nparameters of deployed applicati\", \"ons. This approach enables it to detect services that are operating\\noutside of their normal paramete\", \"rs. For instance, the typical weekday traffic on the site might be\\n10,000 requests per minute. And t\", \"hen, on a given week, suddenly the number of requests hits a highly\\n[unusual 20,000 requests per min\", \"ute. Smart Detection](https://docs.microsoft.com/azure/azure-monitor/app/proactive-diagnostics) will\", \" notice this deviation from the norm and\\ntrigger an alert. At the same time, the trend analysis is s\", \"mart enough to avoid firing false positives\\nwhen the traffic load is expected.\\n\\n#### **References**\\n\", \"\\n\\n  - [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview)\\n\\n\\n141 CHAPTER 7 | Mon\", \"itoring and health\\n\\n\\n**CHAPTER**\\n# 8\\n\\n## Cloud-native identity\\n\\n\\nMost software applications need to \", \"have some knowledge of the user or process that is calling them.\\nThe user or process interacting wit\", \"h an application is known as a security principal, and the process of\\nauthenticating and authorizing\", \" these principals is known as identity management, or simply _identity_ .\\nSimple applications may in\", \"clude all of their identity management within the application, but this\\napproach doesn\\u2019t scale well \", \"with many applications and many kinds of security principals. Windows\\nsupports the use of Active Dir\", \"ectory to provide centralized authentication and authorization.\\n\\n\\nWhile this solution is effective w\", \"ithin corporate networks, it isn\\u2019t designed for use by users or\\napplications that are outside of the\", \" AD domain. With the growth of Internet-based applications and\\nthe rise of cloud-native apps, securi\", \"ty models have evolved.\\n\\n\\nIn today\\u2019s cloud-native identity model, architecture is assumed to be dist\", \"ributed. Apps can be\\ndeployed anywhere and may communicate with other apps anywhere. Clients may com\", \"municate with\\nthese apps from anywhere, and in fact, clients may consist of any combination of platf\", \"orms and\\ndevices. Cloud-native identity solutions use open standards to achieve secure application a\", \"ccess from\\nclients. These clients range from human users on PCs or phones, to other apps hosted anyw\", \"here\\nonline, to set-top boxes and IOT devices running any software platform anywhere in the world.\\n\\n\", \"\\nModern cloud-native identity solutions typically use access tokens that are issued by a secure toke\", \"n\\nservice/server (STS) to a security principal once their identity is determined. The access token, \", \"typically\\na JSON Web Token (JWT), includes _claims_ about the security principal. These claims will \", \"minimally\\ninclude the user\\u2019s identity but may also include other claims that can be used by applicat\", \"ions to\\ndetermine the level of access to grant the principal.\\n\\n\\nTypically, the STS is only responsib\", \"le for authenticating the principal. Determining their level of access\\nto resources is left to other\", \" parts of the application.\\n\\n### References\\n\\n\\n  - [Microsoft identity platform](https://docs.microsof\", \"t.com/azure/active-directory/develop/)\\n\\n### Authentication and authorization in cloud-native apps\\n\\n\\n\", \"_Authentication_ is the process of determining the identity of a security principal. _Authorization_\", \" is the act\\nof granting an authenticated principal permission to perform an action or access a resou\", \"rce.\\nSometimes authentication is shortened to AuthN and authorization is shortened to AuthZ. Cloud\\n\\n\", \"142 CHAPTER 8 | Cloud-native identity\\n\\n\\nnative applications need to rely on open HTTP-based protocol\", \"s to authenticate security principals\\nsince both clients and applications could be running anywhere \", \"in the world on any platform or device.\\nThe only common factor is HTTP.\\n\\n\\nMany organizations still r\", \"ely on local authentication services like Active Directory Federation Services\\n(ADFS). While this ap\", \"proach has traditionally served organizations well for on premises authentication\\nneeds, cloud-nativ\", \"e applications benefit from systems designed specifically for the cloud. A recent\\n2019 United Kingdo\", \"m National Cyber Security Centre (NCSC) advisory states that \\u201corganizations using\\nAzure AD as their \", \"primary authentication source will actually lower their risk compared to ADFS.\\u201d\\n[Some reasons outlin\", \"ed in this analysis](https://oxfordcomputergroup.com/resources/o365-security-native-cloud-authentica\", \"tion/) include:\\n\\n\\n  - Access to full set of Microsoft credential protection technologies.\\n\\n  - Most \", \"organizations are already relying on Azure AD to some extent.\\n\\n  - Double hashing of NTLM hashes ens\", \"ures compromise won\\u2019t allow credentials that work in\\nlocal Active Directory.\\n\\n#### **References**\\n\\n\\n\", \"  - [Authentication basics](https://docs.microsoft.com/azure/active-directory/develop/authentication\", \"-scenarios)\\n\\n  - [Access tokens and claims](https://docs.microsoft.com/azure/active-directory/develo\", \"p/access-tokens)\\n\\n  - [It may be time to ditch your on premises authentication services](https://oxf\", \"ordcomputergroup.com/resources/o365-security-native-cloud-authentication/)\\n\\n### Azure Active Directo\", \"ry\\n\\n\\nMicrosoft Azure Active Directory (Azure AD) offers identity and access management as a service.\", \"\\nCustomers use it to configure and maintain who users are, what information to store about them, who\", \"\\ncan access that information, who can manage it, and what apps can access it. AAD can authenticate\\nu\", \"sers for applications configured to use it, providing a single sign-on (SSO) experience. It can be u\", \"sed\\non its own or be integrated with Windows AD running on premises.\\n\\n\\nAzure AD is built for the clo\", \"ud. It\\u2019s truly a cloud-native identity solution that uses a REST-based Graph\\nAPI and OData syntax fo\", \"r queries, unlike Windows AD, which uses LDAP. On premises Active Directory\\ncan sync user attributes\", \" to the cloud using Identity Sync Services, allowing all authentication to take\\nplace in the cloud u\", \"sing Azure AD. Alternately, authentication can be configured via Connect to pass\\nback to local Activ\", \"e Directory via ADFS to be completed by Windows AD on premises.\\n\\n\\nAzure AD supports company branded \", \"sign-in screens, multi-factory authentication, and cloud-based\\napplication proxies that are used to \", \"provide SSO for applications hosted on premises. It offers\\ndifferent kinds of security reporting and\", \" alert capabilities.\\n\\n#### **References**\\n\\n\\n  - [Microsoft identity platform](https://docs.microsoft\", \".com/azure/active-directory/develop/)\\n\\n\\n143 CHAPTER 8 | Cloud-native identity\\n\\n\\n### IdentityServer f\", \"or cloud-native applications\\n\\nIdentityServer is an authentication server that implements OpenID Conn\", \"ect (OIDC) and OAuth 2.0\\nstandards for ASP.NET Core. It\\u2019s designed to provide a common way to authen\", \"ticate requests to all of\\nyour applications, whether they\\u2019re web, native, mobile, or API endpoints. \", \"IdentityServer can be used to\\nimplement Single Sign-On (SSO) for multiple applications and applicati\", \"on types. It can be used to\\nauthenticate actual users via sign-in forms and similar user interfaces \", \"as well as service-based\\nauthentication that typically involves token issuance, verification, and re\", \"newal without any user\\ninterface. IdentityServer is designed to be a customizable solution. Each ins\", \"tance is typically\\ncustomized to suit an individual organization and/or set of applications\\u2019 needs.\\n\", \"\\n#### **Common web app scenarios**\\n\\n\\nTypically, applications need to support some or all of the foll\", \"owing scenarios:\\n\\n\\n  - Human users accessing web applications with a browser.\\n\\n  - Human users acces\", \"sing back-end Web APIs from browser-based apps.\\n\\n  - Human users on mobile/native clients accessing \", \"back-end Web APIs.\\n\\n  - Other applications accessing back-end Web APIs (without an active user or us\", \"er interface).\\n\\n  - Any application may need to interact with other Web APIs, using its own identity\", \" or\\ndelegating to the user\\u2019s identity.\\n\\n\\n_Figure 8-1. Application types and scenarios._\\n\\n\\nIn each of\", \" these scenarios, the exposed functionality needs to be secured against unauthorized use. At\\na minim\", \"um, this typically requires authenticating the user or principal making a request for a resource.\\nTh\", \"is authentication may use one of several common protocols such as SAML2p, WS-Fed, or OpenID\\nConnect.\", \" Communicating with APIs typically uses the OAuth2 protocol and its support for security\\ntokens. Sep\", \"arating these critical cross-cutting security concerns and their implementation details from\\nthe app\", \"lications themselves ensures consistency and improves security and maintainability.\\n\\n\\n144 CHAPTER 8 \", \"| Cloud-native identity\\n\\n\\nOutsourcing these concerns to a dedicated product like IdentityServer help\", \"s the requirement for every\\napplication to solve these problems itself.\\n\\n\\nIdentityServer provides mi\", \"ddleware that runs within an ASP.NET Core application and adds support\\n[for OpenID Connect and OAuth\", \"2 (see supported specifications). Organizations would create their own](https://docs.duendesoftware.\", \"com/identityserver/v6/overview/specs/)\\nASP.NET Core app using IdentityServer middleware to act as th\", \"e STS for all of their token-based\\nsecurity protocols. The IdentityServer middleware exposes endpoin\", \"ts to support standard\\nfunctionality, including:\\n\\n\\n  - Authorize (authenticate the end user)\\n\\n  - To\", \"ken (request a token programmatically)\\n\\n  - Discovery (metadata about the server)\\n\\n  - User Info (ge\", \"t user information with a valid access token)\\n\\n  - Device Authorization (used to start device flow a\", \"uthorization)\\n\\n  - Introspection (token validation)\\n\\n  - Revocation (token revocation)\\n\\n  - End Sess\", \"ion (trigger single sign-out across all apps)\\n\\n#### **Getting started**\\n\\n\\nIdentityServer4 is availab\", \"le under dual license:\\n\\n\\n  - RPL - lets you use the IdentityServer4 free if used in open-source work\", \"\\n\\n  - Paid - lets you use the IdentityServer4 in a commercial scenario\\n\\n\\n[For more information about\", \" pricing, see the official product\\u2019s pricing page.](https://duendesoftware.com/products/identityserv\", \"er)\\n\\n\\n[You can add it to your applications using its NuGet packages. The main package is IdentitySer\", \"ver4,](https://www.nuget.org/packages/IdentityServer4/)\\nwhich has been downloaded over four million \", \"times. The base package doesn\\u2019t include any user\\ninterface code and only supports in-memory configur\", \"ation. To use it with a database, you\\u2019ll also want\\n[a data provider like IdentityServer4.EntityFrame\", \"work, which uses Entity Framework Core to store](https://www.nuget.org/packages/IdentityServer4.Enti\", \"tyFramework)\\nconfiguration and operational data for IdentityServer. For user interface, you can copy\", \" files from the\\n[Quickstart UI repository](https://github.com/IdentityServer/IdentityServer4.Quickst\", \"art.UI) into your ASP.NET Core MVC application to add support for sign in and sign\\nout using Identit\", \"yServer middleware.\\n\\n#### **Configuration**\\n\\n\\nIdentityServer supports different kinds of protocols a\", \"nd social authentication providers that can be\\nconfigured as part of each custom installation. This \", \"is typically done in the ASP.NET Core application\\u2019s\\nProgram class (or in the Startup class in the Co\", \"nfigureServices method). The configuration involves\\nspecifying the supported protocols and the paths\", \" to the servers and endpoints that will be used.\\nFigure 8-2 shows an example configuration taken fro\", \"m the IdentityServer4 Quickstart UI project:\\n\\n\\n145 CHAPTER 8 | Cloud-native identity\\n\\n\\n_Figure 8-2. \", \"Configuring IdentityServer._\\n\\n#### **JavaScript clients**\\n\\n\\nMany cloud-native applications use serve\", \"r-side APIs and rich client single page applications (SPAs) on\\n[the front end. IdentityServer ships \", \"a JavaScript client](https://docs.duendesoftware.com/identityserver/v6/quickstarts/js_clients/) (oid\", \"c-client.js) via NPM that can be added to\\nSPAs to enable them to use IdentityServer for sign in, sig\", \"n out, and token-based authentication of\\nweb APIs.\\n\\n#### **References**\\n\\n\\n  - [IdentityServer docume\", \"ntation](https://docs.duendesoftware.com/identityserver/v6/)\\n\\n  - [Application types](https://docs.m\", \"icrosoft.com/azure/active-directory/develop/app-types)\\n\\n  - [JavaScript OIDC client](https://docs.du\", \"endesoftware.com/identityserver/v6/quickstarts/js_clients/)\\n\\n\\n146 CHAPTER 8 | Cloud-native identity\\n\", \"\\n\\n**CHAPTER**\\n# 9\\n\\n## Cloud-native security\\n\\n\\nNot a day goes by where the news doesn\\u2019t contain some \", \"story about a company being hacked or\\nsomehow losing their customers\\u2019 data. Even countries/regions a\", \"ren\\u2019t immune to the problems created\\nby treating security as an afterthought. For years, companies h\", \"ave treated the security of customer\\ndata and, in fact, their entire networks as something of a \\u201cnic\", \"e to have\\u201d. Windows servers were left\\nunpatched, ancient versions of PHP kept running, and MongoDB d\", \"atabases left wide open to the\\nworld.\\n\\n\\nHowever, there are starting to be real-world consequences fo\", \"r not maintaining a security mindset\\nwhen building and deploying applications. Many companies learne\", \"d the hard way what can happen\\n[when servers and desktops aren\\u2019t patched during the 2017 outbreak of\", \" NotPetya. The cost of these](https://www.wired.com/story/notpetya-cyberattack-ukraine-russia-code-c\", \"rashed-the-world/)\\nattacks has easily reached into the billions, with some estimates putting the los\", \"ses from this single\\nattack at 10 billion US dollars.\\n\\n\\nEven governments aren\\u2019t immune to hacking in\", \"cidents. The city of Baltimore was held ransom by\\n[criminals](https://www.vox.com/recode/2019/5/21/1\", \"8634505/baltimore-ransom-robbinhood-mayor-jack-young-hackers) making it impossible for citizens to p\", \"ay their bills or use city services.\\n\\n\\nThere has also been an increase in legislation that mandates \", \"certain data protections for personal\\ndata. In Europe, GDPR has been in effect for more than a year \", \"and, more recently, California passed\\ntheir own version called CCDA, which comes into effect January\", \" 1, 2020. The fines under GDPR can be\\nso punishing as to put companies out of business. Google has a\", \"lready been fined 50 million Euros for\\nviolations, but that\\u2019s just a drop in the bucket compared wit\", \"h the potential fines.\\n\\n\\nIn short, security is serious business.\\n\\n### Azure security for cloud-nativ\", \"e apps\\n\\n\\nCloud-native applications can be both easier and more difficult to secure than traditional \", \"applications.\\nOn the downside, you need to secure more smaller applications and dedicate more energy\", \" to build\\nout the security infrastructure. The heterogeneous nature of programming languages and sty\", \"les in\\nmost service deployments also means you need to pay more attention to security bulletins from\", \" many\\ndifferent providers.\\n\\n\\nOn the flip side, smaller services, each with their own data store, lim\", \"it the scope of an attack. If an\\nattacker compromises one system, it\\u2019s probably more difficult for t\", \"he attacker to make the jump to\\nanother system than it is in a monolithic application. Process bound\", \"aries are strong boundaries. Also,\\nif a database backup gets exposed, then the damage is more limite\", \"d, as that database contains only a\\nsubset of data and is unlikely to contain personal data.\\n\\n\\n147 C\", \"HAPTER 9 | Cloud-native security\\n\\n\\n#### **Threat modeling**\\n\\nNo matter if the advantages outweigh th\", \"e disadvantages of cloud-native applications, the same\\nholistic security mindset must be followed. S\", \"ecurity and secure thinking must be part of every step of\\nthe development and operations story. When\", \" planning an application ask questions like:\\n\\n\\n  - What would be the impact of this data being lost?\", \"\\n\\n  - How can we limit the damage from bad data being injected into this service?\\n\\n  - Who should ha\", \"ve access to this data?\\n\\n  - Are there auditing policies in place around the development and release\", \" process?\\n\\n\\n[All these questions are part of a process called threat modeling. This process tries to\", \" answer the](https://docs.microsoft.com/azure/security/azure-security-threat-modeling-tool)\\nquestion\", \" of what threats there are to the system, how likely the threats are, and the potential damage\\nfrom \", \"them.\\n\\n\\nOnce the list of threats has been established, you need to decide whether they\\u2019re worth miti\", \"gating.\\nSometimes a threat is so unlikely and expensive to plan for that it isn\\u2019t worth spending ene\", \"rgy on it.\\nFor instance, some state level actor could inject changes into the design of a process th\", \"at is used by\\n[millions of devices. Now, instead of running a certain piece of code in Ring 3, that \", \"code is run in Ring](https://en.wikipedia.org/wiki/Protection_ring)\\n0. This process allows an exploi\", \"t that can bypass the hypervisor and run the attack code on the bare\\nmetal machines, allowing attack\", \"s on all the virtual machines that are running on that hardware.\\n\\n\\nThe altered processors are diffic\", \"ult to detect without a microscope and advanced knowledge of the on\\nsilicon design of that processor\", \". This scenario is unlikely to happen and expensive to mitigate, so\\nprobably no threat model would r\", \"ecommend building exploit protection for it.\\n\\n\\nMore likely threats, such as broken access controls p\", \"ermitting Id incrementing attacks (replacing Id=2\\nwith Id=3 in the URL) or SQL injection, are more a\", \"ttractive to build protections against. The\\nmitigations for these threats are quite reasonable to bu\", \"ild and prevent embarrassing security holes\\nthat smear the company\\u2019s reputation.\\n\\n#### **Principle o\", \"f least privilege**\\n\\n\\nOne of the founding ideas in computer security is the Principle of Least Privi\", \"lege (POLP). It\\u2019s actually a\\nfoundational idea in most any form of security be it digital or physica\", \"l. In short, the principle is that\\nany user or process should have the smallest number of rights pos\", \"sible to execute its task.\\n\\n\\nAs an example, think of the tellers at a bank: accessing the safe is an\", \" uncommon activity. So, the\\naverage teller can\\u2019t open the safe themselves. To gain access, they need\", \" to escalate their request\\nthrough a bank manager, who performs additional security checks.\\n\\n\\nIn a c\", \"omputer system, a fantastic example is the rights of a user connecting to a database. In many\\ncases,\", \" there\\u2019s a single user account used to both build the database structure and run the application.\\nEx\", \"cept in extreme cases, the account running the application doesn\\u2019t need the ability to update\\nschema\", \" information. There should be several accounts that provide different levels of privilege. The\\nappli\", \"cation should only use the permission level that grants read and writes access to the data in the\\nta\", \"bles. This kind of protection would eliminate attacks that aimed to drop database tables or\\nintroduc\", \"e malicious triggers.\\n\\n\\n148 CHAPTER 9 | Cloud-native security\\n\\n\\nAlmost every part of building a clou\", \"d-native application can benefit from remembering the principle\\nof least privilege. You can find it \", \"at play when setting up firewalls, network security groups, roles, and\\nscopes in Role-based access c\", \"ontrol (RBAC).\\n\\n#### **Penetration testing**\\n\\n\\nAs applications become more complicated the number of\", \" attack vectors increases at an alarming rate.\\nThreat modeling is flawed in that it tends to be exec\", \"uted by the same people building the system. In\\nthe same way that many developers have trouble envis\", \"ioning user interactions and then build\\nunusable user interfaces, most developers have difficulty se\", \"eing every attack vector. It\\u2019s also possible\\nthat the developers building the system aren\\u2019t well ver\", \"sed in attack methodologies and miss\\nsomething crucial.\\n\\n\\nPenetration testing or \\u201cpen testing\\u201d invol\", \"ves bringing in external actors to attempt to attack the\\nsystem. These attackers may be an external \", \"consulting company or other developers with good\\nsecurity knowledge from another part of the busines\", \"s. They\\u2019re given carte blanche to attempt to\\nsubvert the system. Frequently, they\\u2019ll find extensive \", \"security holes that need to be patched.\\nSometimes the attack vector will be something totally unexpe\", \"cted like exploiting a phishing attack\\nagainst the CEO.\\n\\n\\n[Azure itself is constantly undergoing att\", \"acks from a team of hackers inside Microsoft. Over the years,](https://azure.microsoft.com/resources\", \"/videos/red-vs-blue-internal-security-penetration-testing-of-microsoft-azure/)\\nthey\\u2019ve been the firs\", \"t to find dozens of potentially catastrophic attack vectors, closing them before\\nthey can be exploit\", \"ed externally. The more tempting a target, the more likely that eternal actors will\\nattempt to explo\", \"it it and there are a few targets in the world more tempting than Azure.\\n\\n#### **Monitoring**\\n\\n\\nShou\", \"ld an attacker attempt to penetrate an application, there should be some warning of it.\\nFrequently, \", \"attacks can be spotted by examining the logs from services. Attacks leave telltale signs\\nthat can be\", \" spotted before they succeed. For instance, an attacker attempting to guess a password\\nwill make man\", \"y requests to a login system. Monitoring around the login system can detect weird\\npatterns that are \", \"out of line with the typical access pattern. This monitoring can be turned into an\\nalert that can, i\", \"n turn, alert an operations person to activate some sort of countermeasure. A highly\\nmature monitori\", \"ng system might even take action based on these deviations proactively adding rules\\nto block request\", \"s or throttle responses.\\n\\n#### **Securing the build**\\n\\n\\nOne place where security is often overlooked\", \" is around the build process. Not only should the build\\nrun security checks, such as scanning for in\", \"secure code or checked-in credentials, but the build itself\\nshould be secure. If the build server is\", \" compromised, then it provides a fantastic vector for introducing\\narbitrary code into the product.\\n\\n\", \"\\nImagine that an attacker is looking to steal the passwords of people signing into a web application\", \".\\nThey could introduce a build step that modifies the checked-out code to mirror any login request t\", \"o\\nanother server. The next time code goes through the build, it\\u2019s silently updated. The source code\\n\", \"vulnerability scanning won\\u2019t catch this vulnerability as it runs before the build. Equally, nobody w\", \"ill\\n\\n\\n149 CHAPTER 9 | Cloud-native security\\n\\n\\ncatch it in a code review because the build steps live\", \" on the build server. The exploited code will go to\\nproduction where it can harvest passwords. Proba\", \"bly there\\u2019s no audit log of the build process\\nchanges, or at least nobody monitoring the audit.\\n\\n\\nTh\", \"is scenario is a perfect example of a seemingly low-value target that can be used to break into the\\n\", \"system. Once an attacker breaches the perimeter of the system, they can start working on finding\\nway\", \"s to elevate their permissions to the point that they can cause real harm anywhere they like.\\n\\n#### \", \"**Building secure code**\\n\\n\\n.NET Framework is already a quite secure framework. It avoids some of the\", \" pitfalls of unmanaged\\ncode, such as walking off the ends of arrays. Work is actively done to fix se\", \"curity holes as they\\u2019re\\n[discovered. There\\u2019s even a bug bounty program](https://www.microsoft.com/ms\", \"rc/bounty) that pays researchers to find issues in the framework\\nand report them instead of exploiti\", \"ng them.\\n\\n\\n[There are many ways to make .NET code more secure. Following guidelines such as the Secu\", \"re coding](https://docs.microsoft.com/dotnet/standard/security/secure-coding-guidelines)\\n[guidelines\", \" for .NET](https://docs.microsoft.com/dotnet/standard/security/secure-coding-guidelines) article is \", \"a reasonable step to take to ensure that the code is secure from the\\n[ground up. The OWASP top 10 is\", \" another invaluable guide to build secure code.](https://owasp.org/www-project-top-ten/)\\n\\n\\nThe build\", \" process is a good place to put scanning tools to detect problems in source code before they\\nmake it\", \" into production. Most every project has dependencies on some other packages. A tool that\\ncan scan f\", \"or outdated packages will catch problems in a nightly build. Even when building Docker\\nimages, it\\u2019s \", \"useful to check and make sure that the base image doesn\\u2019t have known vulnerabilities.\\nAnother thing \", \"to check is that nobody has accidentally checked in credentials.\\n\\n#### **Built-in security**\\n\\n\\nAzure\", \" is designed to balance usability and security for most users. Different users are going to have\\ndif\", \"ferent security requirements, so they need to fine-tune their approach to cloud security. Microsoft\\n\", \"[publishes a great deal of security information in the Trust Center. This resource should be the fir\", \"st](https://azure.microsoft.com/support/trust-center/)\\nstop for those professionals interested in un\", \"derstanding how the built-in attack mitigation\\ntechnologies work.\\n\\n\\n[Within the Azure portal, the Az\", \"ure Advisor](https://azure.microsoft.com/services/advisor/) is a system that is constantly scanning \", \"an environment and\\nmaking recommendations. Some of these recommendations are designed to save users \", \"money, but\\nothers are designed to identify potentially insecure configurations, such as having a sto\", \"rage container\\nopen to the world and not protected by a Virtual Network.\\n\\n#### **Azure network infra\", \"structure**\\n\\n\\nIn an on-premises deployment environment, a great deal of energy is dedicated to setti\", \"ng up\\nnetworking. Setting up routers, switches, and the such is complicated work. Networks allow cer\", \"tain\\nresources to talk to other resources and prevent access in some cases. A frequent network rule \", \"is to\\nrestrict access to the production environment from the development environment on the off chan\", \"ce\\nthat a half-developed piece of code runs awry and deletes a swath of data.\\n\\n\\nOut of the box, most\", \" PaaS Azure resources have only the most basic and permissive networking setup.\\nFor instance, anybod\", \"y on the Internet can access an app service. New SQL Server instances typically\\n\\n\\n150 CHAPTER 9 | Cl\", \"oud-native security\\n\\n\\ncome restricted, so that external parties can\\u2019t access them, but the IP addres\", \"s ranges used by Azure\\nitself are permitted through. So, while the SQL server is protected from exte\", \"rnal threats, an attacker\\nonly needs to set up an Azure bridgehead from where they can launch attack\", \"s against all SQL\\ninstances on Azure.\\n\\n\\nFortunately, most Azure resources can be placed into an Azur\", \"e Virtual Network that allows finegrained access control. Similar to the way that on-premises networ\", \"ks establish private networks that\\nare protected from the wider world, virtual networks are islands \", \"of private IP addresses that are\\nlocated within the Azure network.\\n\\n\\n_Figure 9-1. A virtual network \", \"in Azure._\\n\\n\\nIn the same way that on-premises networks have a firewall governing access to the netwo\", \"rk, you can\\nestablish a similar firewall at the boundary of the virtual network. By default, all the\", \" resources on a\\nvirtual network can still talk to the Internet. It\\u2019s only incoming connections that \", \"require some form of\\nexplicit firewall exception.\\n\\n\\nWith the network established, internal resources\", \" like storage accounts can be set up to only allow for\\naccess by resources that are also on the Virt\", \"ual Network. This firewall provides an extra level of\\nsecurity, should the keys for that storage acc\", \"ount be leaked, attackers wouldn\\u2019t be able to connect to\\nit to exploit the leaked keys. This scenari\", \"o is another example of the principle of least privilege.\\n\\n\\nThe nodes in an Azure Kubernetes cluster\", \" can participate in a virtual network just like other resources\\n[that are more native to Azure. This\", \" functionality is called Azure Container Networking Interface. In](https://github.com/Azure/azure-co\", \"ntainer-networking/blob/master/docs/cni.md)\\neffect, it allocates a subnet within the virtual network\", \" on which virtual machines and container images\\nare allocated.\\n\\n\\nContinuing down the path of illustr\", \"ating the principle of least privilege, not every resource within a\\nVirtual Network needs to talk to\", \" every other resource. For instance, in an application that provides a\\n\\n\\n151 CHAPTER 9 | Cloud-nativ\", \"e security\\n\\n\\nweb API over a storage account and a SQL database, it\\u2019s unlikely that the database and \", \"the storage\\naccount need to talk to one another. Any data sharing between them would go through the \", \"web\\n[application. So, a network security group (NSG) could be used to deny traffic between the two](\", \"https://docs.microsoft.com/azure/virtual-network/security-overview)\\nservices.\\n\\n\\nA policy of denying \", \"communication between resources can be annoying to implement, especially\\ncoming from a background of\", \" using Azure without traffic restrictions. On some other clouds, the\\nconcept of network security gro\", \"ups is much more prevalent. For instance, the default policy on AWS is\\nthat resources can\\u2019t communic\", \"ate among themselves until enabled by rules in an NSG. While slower\\nto develop this, a more restrict\", \"ive environment provides a more secure default. Making use of proper\\nDevOps practices, especially us\", \"ing Azure Resource Manager or Terraform to manage permissions can\\nmake controlling the rules easier.\", \"\\n\\n\\nVirtual Networks can also be useful when setting up communication between on-premises and cloud\\nr\", \"esources. A virtual private network can be used to seamlessly attach the two networks together. This\", \"\\napproach allows running a virtual network without any sort of gateway for scenarios where all the\\nu\", \"sers are on-site. There are a number of technologies that can be used to establish this network. The\", \"\\n[simplest is to use a site-to-site VPN that can be established between many routers and Azure. Traf\", \"fic](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways?toc=%252fazure%252fv\", \"irtual-network%252ftoc.json#s2smulti)\\nis encrypted and tunneled over the Internet at the same cost p\", \"er byte as any other traffic. For\\n[scenarios where more bandwidth or more security is desirable, Azu\", \"re offers a service called Express](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-v\", \"pngateways?toc=%252fazure%252fvirtual-network%252ftoc.json#ExpressRoute)\\n[Route](https://docs.micros\", \"oft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways?toc=%252fazure%252fvirtual-network%252ftoc.j\", \"son#ExpressRoute) that uses a private circuit between an on-premises network and Azure. It\\u2019s more co\", \"stly and\\ndifficult to establish but also more secure.\\n\\n#### **Role-based access control for restrict\", \"ing access to Azure resources**\\n\\n\\nRBAC is a system that provides an identity to applications running\", \" in Azure. Applications can access\\nresources using this identity instead of or in addition to using \", \"keys or passwords.\\n\\n#### **Security Principals**\\n\\n\\nThe first component in RBAC is a security princip\", \"al. A security principal can be a user, group, service\\nprincipal, or managed identity.\\n\\n\\n_Figure 9-2\", \". Different types of security principals._\\n\\n\\n  - User - Any user who has an account in Azure Active \", \"Directory is a user.\\n\\n  - Group - A collection of users from Azure Active Directory. As a member of \", \"a group, a user\\ntakes on the roles of that group in addition to their own.\\n\\n  - Service principal - \", \"A security identity under which services or applications run.\\n\\n\\n152 CHAPTER 9 | Cloud-native securit\", \"y\\n\\n\\n  - Managed identity - An Azure Active Directory identity managed by Azure. Managed identities\\na\", \"re typically used when developing cloud applications that manage the credentials for\\nauthenticating \", \"to Azure services.\\n\\n\\nThe security principal can be applied to most any resource. This aspect means t\", \"hat it\\u2019s possible to\\nassign a security principal to a container running within Azure Kubernetes, all\", \"owing it to access secrets\\nstored in Key Vault. An Azure Function could take on a permission allowin\", \"g it to talk to an Active\\nDirectory instance to validate a JWT for a calling user. Once services are\", \" enabled with a service\\nprincipal, their permissions can be managed granularly using roles and scope\", \"s.\\n\\n#### **Roles**\\n\\n\\nA security principal can take on many roles or, using a more sartorial analogy,\", \" wear many hats. Each\\nrole defines a series of permissions such as \\u201cRead messages from Azure Service\", \" Bus endpoint\\u201d. The\\neffective permission set of a security principal is the combination of all the p\", \"ermissions assigned to all\\nthe roles that a security principal has. Azure has a large number of buil\", \"t-in roles and users can define\\ntheir own roles.\\n\\n\\n_Figure 9-3. RBAC role definitions._\\n\\n\\nBuilt into\", \" Azure are also a number of high-level roles such as Owner, Contributor, Reader, and User\\nAccount Ad\", \"ministrator. With the Owner role, a security principal can access all resources and assign\\npermissio\", \"ns to others. A contributor has the same level of access to all resources but they can\\u2019t assign\\nperm\", \"issions. A Reader can only view existing Azure resources and a User Account Administrator can\\nmanage\", \" access to Azure resources.\\n\\n\\n[More granular built-in roles such as DNS Zone Contributor](https://do\", \"cs.microsoft.com/azure/role-based-access-control/built-in-roles#dns-zone-contributor) have rights li\", \"mited to a single service.\\nSecurity principals can take on any number of roles.\\n\\n\\n153 CHAPTER 9 | Cl\", \"oud-native security\\n\\n\\n#### **Scopes**\\n\\nRoles can be applied to a restricted set of resources within \", \"Azure. For instance, applying scope to the\\nprevious example of reading from a Service Bus queue, you\", \" can narrow the permission to a single\\nqueue: \\u201cRead messages from Azure Service Bus endpoint blah.se\", \"rvicebus.windows.net/queue1\\u201d\\n\\n\\nThe scope can be as narrow as a single resource or it can be applied \", \"to an entire resource group,\\nsubscription, or even management group.\\n\\n\\nWhen testing if a security pr\", \"incipal has certain permission, the combination of role and scope are\\ntaken into account. This combi\", \"nation provides a powerful authorization mechanism.\\n\\n#### **Deny**\\n\\n\\nPreviously, only \\u201callow\\u201d rules \", \"were permitted for RBAC. This behavior made some scopes complicated\\nto build. For instance, allowing\", \" a security principal access to all storage accounts except one required\\ngranting explicit permissio\", \"n to a potentially endless list of storage accounts. Every time a new storage\\naccount was created, i\", \"t would have to be added to this list of accounts. This added management\\noverhead that certainly was\", \"n\\u2019t desirable.\\n\\n\\nDeny rules take precedence over allow rules. Now representing the same \\u201callow all b\", \"ut one\\u201d scope\\ncould be represented as two rules \\u201callow all\\u201d and \\u201cdeny this one specific one\\u201d. Deny r\", \"ules not only\\nease management but allow for resources that are extra secure by denying access to eve\", \"rybody.\\n\\n#### **Checking access**\\n\\n\\nAs you can imagine, having a large number of roles and scopes ca\", \"n make figuring out the effective\\npermission of a service principal quite difficult. Piling deny rul\", \"es on top of that, only serves to increase\\n[the complexity. Fortunately, there\\u2019s a permissions calcu\", \"lator](https://docs.microsoft.com/azure/role-based-access-control/check-access) that can show the ef\", \"fective permissions\\nfor any service principal. It\\u2019s typically found under the IAM tab in the portal,\", \" as shown in Figure 9-3.\\n\\n\\n_Figure 9-4. Permission calculator for an app service._\\n\\n\\n154 CHAPTER 9 |\", \" Cloud-native security\\n\\n\\n#### **Securing secrets**\\n\\nPasswords and certificates are a common attack v\", \"ector for attackers. Password-cracking hardware can\\ndo a brute-force attack and try to guess billion\", \"s of passwords per second. So it\\u2019s important that the\\npasswords that are used to access resources ar\", \"e strong, with a large variety of characters. These\\npasswords are exactly the kind of passwords that\", \" are near impossible to remember. Fortunately, the\\npasswords in Azure don\\u2019t actually need to be know\", \"n by any human.\\n\\n\\n[Many security experts suggest that using a password manager to keep your own pass\", \"words is the](https://www.troyhunt.com/password-managers-dont-have-to-be-perfect-they-just-have-to-b\", \"e-better-than-not-having-one/)\\nbest approach. While it centralizes your passwords in one location, i\", \"t also allows using highly complex\\npasswords and ensuring they\\u2019re unique for each account. The same \", \"system exists within Azure: a\\ncentral store for secrets.\\n\\n#### **Azure Key Vault**\\n\\n\\nAzure Key Vault\", \" provides a centralized location to store passwords for things such as databases, API\\nkeys, and cert\", \"ificates. Once a secret is entered into the Vault, it\\u2019s never shown again and the\\ncommands to extrac\", \"t and view it are purposefully complicated. The information in the safe is\\nprotected using either so\", \"ftware encryption or FIPS 140-2 Level 2 validated Hardware Security\\nModules.\\n\\n\\nAccess to the key vau\", \"lt is provided through RBACs, meaning that not just any user can access the\\ninformation in the vault\", \". Say a web application wishes to access the database connection string stored\\nin Azure Key Vault. T\", \"o gain access, applications need to run using a service principal. Under this\\nassumed role, they can\", \" read the secrets from the safe. There are a number of different security\\nsettings that can further \", \"limit the access that an application has to the vault, so that it can\\u2019t update\\nsecrets but only read\", \" them.\\n\\n\\nAccess to the key vault can be monitored to ensure that only the expected applications are \", \"accessing\\nthe vault. The logs can be integrated back into Azure Monitor, unlocking the ability to se\", \"t up alerts\\nwhen unexpected conditions are encountered.\\n\\n#### **Kubernetes**\\n\\n\\nWithin Kubernetes, th\", \"ere\\u2019s a similar service for maintaining small pieces of secret information.\\nKubernetes Secrets can b\", \"e set via the typical kubectl executable.\\n\\n\\nCreating a secret is as simple as finding the base64 ver\", \"sion of the values to be stored:\\n\\n\\nThen adding it to a secrets file named secret.yml for example tha\", \"t looks similar to the following\\nexample:\\n\\n\\n155 CHAPTER 9 | Cloud-native security\\n\\n\\nFinally, this fi\", \"le can be loaded into Kubernetes by running the following command:\\n\\n```\\nkubectl apply -f ./secret.ya\", \"ml\\n\\n```\\n\\nThese secrets can then be mounted into volumes or exposed to container processes through\\n[e\", \"nvironment variables. The Twelve-factor app](https://12factor.net/) approach to building application\", \"s suggests using the\\nlowest common denominator to transmit settings to an application. Environment v\", \"ariables are the\\nlowest common denominator, because they\\u2019re supported no matter the operating system\", \" or\\napplication.\\n\\n\\nAn alternative to use the built-in Kubernetes secrets is to access the secrets in\", \" Azure Key Vault from\\nwithin Kubernetes. The simplest way to do this is to assign an RBAC role to th\", \"e container looking to\\nload secrets. The application can then use the Azure Key Vault APIs to access\", \" the secrets. However,\\nthis approach requires modifications to the code and doesn\\u2019t follow the patte\", \"rn of using environment\\nvariables. Instead, it\\u2019s possible to inject values into a container. This ap\", \"proach is actually more secure\\nthan using the Kubernetes secrets directly, as they can be accessed b\", \"y users on the cluster.\\n\\n#### **Encryption in transit and at rest**\\n\\n\\nKeeping data safe is important\", \" whether it\\u2019s on disk or transiting between various different services.\\nThe most effective way to ke\", \"ep data from leaking is to encrypt it into a format that can\\u2019t be easily read\\nby others. Azure suppo\", \"rts a wide range of encryption options.\\n\\n\\n**In transit**\\n\\n\\nThere are several ways to encrypt traffic\", \" on the network in Azure. The access to Azure services is\\ntypically done over connections that use T\", \"ransport Layer Security (TLS). For instance, all the\\nconnections to the Azure APIs require TLS conne\", \"ctions. Equally, connections to endpoints in Azure\\nstorage can be restricted to work only over TLS e\", \"ncrypted connections.\\n\\n\\nTLS is a complicated protocol and simply knowing that the connection is usin\", \"g TLS isn\\u2019t sufficient to\\nensure security. For instance, TLS 1.0 is chronically insecure, and TLS 1.\", \"1 isn\\u2019t much better. Even within\\nthe versions of TLS, there are various settings that can make the c\", \"onnections easier to decrypt. The\\nbest course of action is to check and see if the server connection\", \" is using up-to-date and well\\nconfigured protocols.\\n\\n\\nThis check can be done by an external service \", \"such as SSL labs\\u2019 SSL Server Test. A test run against a\\ntypical Azure endpoint, in this case a servi\", \"ce bus endpoint, yields a near perfect score of A.\\n\\n\\nEven services like Azure SQL databases use TLS \", \"encryption to keep data hidden. The interesting part\\nabout encrypting the data in transit using TLS \", \"is that it isn\\u2019t possible, even for Microsoft, to listen in on\\nthe connection between computers runn\", \"ing TLS. This should provide comfort for companies\\nconcerned that their data may be at risk from Mic\", \"rosoft proper or even a state actor with more\\nresources than the standard attacker.\\n\\n\\n156 CHAPTER 9 \", \"| Cloud-native security\\n\\n\\n_Figure 9-5. SSL labs report showing a score of A for a Service Bus endpoi\", \"nt._\\n\\n\\nWhile this level of encryption isn\\u2019t going to be sufficient for all time, it should inspire c\", \"onfidence that\\nAzure TLS connections are quite secure. Azure will continue to evolve its security st\", \"andards as\\nencryption improves. It\\u2019s nice to know that there\\u2019s somebody watching the security standa\", \"rds and\\nupdating Azure as they improve.\\n\\n\\n**At rest**\\n\\n\\nIn any application, there are a number of pl\", \"aces where data rests on the disk. The application code\\nitself is loaded from some storage mechanism\", \". Most applications also use some kind of a database\\nsuch as SQL Server, Cosmos DB, or even the amaz\", \"ingly price-efficient Table Storage. These databases\\nall use heavily encrypted storage to ensure tha\", \"t nobody other than the applications with proper\\npermissions can read your data. Even the system ope\", \"rators can\\u2019t read data that has been encrypted.\\nSo customers can remain confident their secret infor\", \"mation remains secret.\\n\\n\\n**Storage**\\n\\n\\nThe underpinning of much of Azure is the Azure Storage engine\", \". Virtual machine disks are mounted\\non top of Azure Storage. Azure Kubernetes Service runs on virtua\", \"l machines that, themselves, are\\nhosted on Azure Storage. Even serverless technologies, such as Azur\", \"e Functions Apps and Azure\\nContainer Instances, run out of disk that is part of Azure Storage.\\n\\n\\nIf \", \"Azure Storage is well encrypted, then it provides for a foundation for most everything else to also\\n\", \"[be encrypted. Azure Storage is encrypted](https://docs.microsoft.com/azure/storage/common/storage-s\", \"ervice-encryption) [with FIPS 140-2](https://en.wikipedia.org/wiki/FIPS_140) [compliant 256-bit AES.\", \" This is a well-](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard)\\nregarded encryption te\", \"chnology having been the subject of extensive academic scrutiny over the last\\n20 or so years. At pre\", \"sent, there\\u2019s no known practical attack that would allow someone without\\nknowledge of the key to rea\", \"d data encrypted by AES.\\n\\n\\nBy default, the keys used for encrypting Azure Storage are managed by Mic\", \"rosoft. There are extensive\\nprotections in place to ensure to prevent malicious access to these keys\", \". However, users with\\n[particular encryption requirements can also provide their own storage keys th\", \"at are managed in Azure](https://docs.microsoft.com/azure/storage/common/storage-encryption-keys-pow\", \"ershell)\\n\\n\\n157 CHAPTER 9 | Cloud-native security\\n\\n\\nKey Vault. These keys can be revoked at any time,\", \" which would effectively render the contents of the\\nStorage account using them inaccessible.\\n\\n\\nVirtu\", \"al machines use encrypted storage, but it\\u2019s possible to provide another layer of encryption by\\nusing\", \" technologies like BitLocker on Windows or DM-Crypt on Linux. These technologies mean that\\neven if t\", \"he disk image was leaked off of storage, it would remain near impossible to read it.\\n\\n\\n**Azure SQL**\", \"\\n\\n\\n[Databases hosted on Azure SQL use a technology called Transparent Data Encryption (TDE) to ensur\", \"e](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparent-data-encrypti\", \"on)\\ndata remains encrypted. It\\u2019s enabled by default on all newly created SQL databases, but must be\\n\", \"enabled manually for legacy databases. TDE executes real-time encryption and decryption of not just\\n\", \"the database, but also the backups and transaction logs.\\n\\n\\nThe encryption parameters are stored in t\", \"he master database and, on startup, are read into memory\\nfor the remaining operations. This means th\", \"at the master database must remain unencrypted. The\\nactual key is managed by Microsoft. However, use\", \"rs with exacting security requirements may provide\\ntheir own key in Key Vault in much the same way a\", \"s is done for Azure Storage. The Key Vault provides\\nfor such services as key rotation and revocation\", \".\\n\\n\\nThe \\u201cTransparent\\u201d part of TDS comes from the fact that there aren\\u2019t client changes needed to use\", \" an\\nencrypted database. While this approach provides for good security, leaking the database passwor\", \"d is\\nenough for users to be able to decrypt the data. There\\u2019s another approach that encrypts individ\", \"ual\\n[columns or tables in a database. Always Encrypted](https://docs.microsoft.com/azure/sql-databas\", \"e/sql-database-always-encrypted-azure-key-vault) ensures that at no point the encrypted data\\nappears\", \" in plain text inside the database.\\n\\n\\nSetting up this tier of encryption requires running through a \", \"wizard in SQL Server Management Studio\\nto select the sort of encryption and where in Key Vault to st\", \"ore the associated keys.\\n\\n\\n158 CHAPTER 9 | Cloud-native security\\n\\n\\n_Figure 9-6. Selecting columns in\", \" a table to be encrypted using Always Encrypted._\\n\\n\\nClient applications that read information from t\", \"hese encrypted columns need to make special\\nallowances to read encrypted data. Connection strings ne\", \"ed to be updated with Column Encryption\\nSetting=Enabled and client credentials must be retrieved fro\", \"m the Key Vault. The SQL Server client\\nmust then be primed with the column encryption keys. Once tha\", \"t is done, the remaining actions use\\nthe standard interfaces to SQL Client. That is, tools like Dapp\", \"er and Entity Framework, which are built\\non top of SQL Client, will continue to work without changes\", \". Always Encrypted may not yet be\\navailable for every SQL Server driver on every language.\\n\\n\\nThe com\", \"bination of TDE and Always Encrypted, both of which can be used with client-specific keys,\\nensures t\", \"hat even the most exacting encryption requirements are supported.\\n\\n\\n**Cosmos DB**\\n\\n\\nCosmos DB is the\", \" newest database provided by Microsoft in Azure. It has been built from the ground\\nup with security \", \"and cryptography in mind. AES-256bit encryption is standard for all Cosmos DB\\n\\n\\n159 CHAPTER 9 | Clou\", \"d-native security\\n\\n\\ndatabases and can\\u2019t be disabled. Coupled with the TLS 1.2 requirement for commun\", \"ication, the entire\\nstorage solution is encrypted.\\n\\n\\n_Figure 9-7. The flow of data encryption within\", \" Cosmos DB._\\n\\n\\nWhile Cosmos DB doesn\\u2019t provide for supplying customer encryption keys, there has bee\", \"n significant\\nwork done by the team to ensure it remains PCI-DSS compliant without that. Cosmos DB a\", \"lso doesn\\u2019t\\nsupport any sort of single column encryption similar to Azure SQL\\u2019s Always Encrypted yet\", \".\\n\\n#### **Keeping secure**\\n\\n\\nAzure has all the tools necessary to release a highly secure product. H\", \"owever, a chain is only as strong\\nas its weakest link. If the applications deployed on top of Azure \", \"aren\\u2019t developed with a proper\\nsecurity mindset and good security audits, then they become the weak \", \"link in the chain. There are\\nmany great static analysis tools, encryption libraries, and security pr\", \"actices that can be used to ensure\\n[that the software installed on Azure is as secure as Azure itsel\", \"f. Examples include static analysis tools,](https://www.mend.io/sca/)\\n[encryption libraries, and sec\", \"urity practices.](https://www.libressl.org/)\\n\\n\\n160 CHAPTER 9 | Cloud-native security\\n\\n\\n**CHAPTER**\\n#\", \" 10\\n\\n## DevOps\\n\\n\\nThe favorite mantra of software consultants is to answer \\u201cIt depends\\u201d to any questi\", \"on posed. It isn\\u2019t\\nbecause software consultants are fond of not taking a position. It\\u2019s because ther\", \"e\\u2019s no one true\\nanswer to any questions in software. There\\u2019s no absolute right and wrong, but rather\", \" a balance\\nbetween opposites.\\n\\n\\nTake, for instance, the two major schools of developing web applicat\", \"ions: Single Page Applications\\n(SPAs) versus server-side applications. On the one hand, the user exp\", \"erience tends to be better with\\nSPAs and the amount of traffic to the web server can be minimized ma\", \"king it possible to host them\\non something as simple as static hosting. On the other hand, SPAs tend\", \" to be slower to develop and\\nmore difficult to test. Which one is the right choice? Well, it depends\", \" on your situation.\\n\\n\\nCloud-native applications aren\\u2019t immune to that same dichotomy. They have clea\", \"r advantages in\\nterms of speed of development, stability, and scalability, but managing them can be \", \"quite a bit more\\ndifficult.\\n\\n\\nYears ago, it wasn\\u2019t uncommon for the process of moving an application\", \" from development to\\nproduction to take a month, or even more. Companies released software on a 6-mo\", \"nth or even every\\nyear cadence. One needs to look no further than Microsoft Windows to get an idea f\", \"or the cadence of\\nreleases that were acceptable before the ever-green days of Windows 10. Five years\", \" passed between\\nWindows XP and Vista, a further three between Vista and Windows 7.\\n\\n\\nIt\\u2019s now fairly\", \" well established that being able to release software rapidly gives fast-moving companies\\na huge mar\", \"ket advantage over their more sloth-like competitors. It\\u2019s for that reason that major\\nupdates to Win\", \"dows 10 are now approximately every six months.\\n\\n\\nThe patterns and practices that enable faster, mor\", \"e reliable releases to deliver value to the business\\nare collectively known as DevOps. They consist \", \"of a wide range of ideas spanning the entire software\\ndevelopment life cycle from specifying an appl\", \"ication all the way up to delivering and operating that\\napplication.\\n\\n\\nDevOps emerged before microse\", \"rvices and it\\u2019s likely that the movement towards smaller, more fit to\\npurpose services wouldn\\u2019t have\", \" been possible without DevOps to make releasing and operating not\\njust one but many applications in \", \"production easier.\\n\\n\\n161 CHAPTER 10 | DevOps\\n\\n\\n_Figure 10-1 - DevOps and microservices._\\n\\n\\nThrough g\", \"ood DevOps practices, it\\u2019s possible to realize the advantages of cloud-native applications\\nwithout s\", \"uffocating under a mountain of work actually operating the applications.\\n\\n\\nThere\\u2019s no golden hammer \", \"when it comes to DevOps. Nobody can sell a complete and allencompassing solution for releasing and o\", \"perating high-quality applications. This is because each\\napplication is wildly different from all ot\", \"hers. However, there are tools that can make DevOps a far less\\ndaunting proposition. One of these to\", \"ols is known as Azure DevOps.\\n\\n### Azure DevOps\\n\\n\\nAzure DevOps has a long pedigree. It can trace its\", \" roots back to when Team Foundation Server first\\nmoved online and through the various name changes: \", \"Visual Studio Online and Visual Studio Team\\nServices. Through the years, however, it has become far \", \"more than its predecessors.\\n\\n\\nAzure DevOps is divided into five major components:\\n\\n\\n_Figure 10-2 - A\", \"zure DevOps._\\n\\n\\n**Azure Repos** - Source code management that supports the venerable Team Foundation\", \" Version\\n[Control (TFVC) and the industry favorite Git. Pull requests provide a way to enable social\", \" coding by](https://en.wikipedia.org/wiki/Git)\\nfostering discussion of changes as they\\u2019re made.\\n\\n\\n16\", \"2 CHAPTER 10 | DevOps\\n\\n\\n**Azure Boards** - Provides an issue and work item tracking tool that strive\", \"s to allow users to pick the\\nworkflows that work best for them. It comes with a number of pre-config\", \"ured templates including\\nones to support SCRUM and Kanban styles of development.\\n\\n\\n**Azure Pipelines\", \"** - A build and release management system that supports tight integration with Azure.\\nBuilds can be\", \" run on various platforms from Windows to Linux to macOS. Build agents may be\\nprovisioned in the clo\", \"ud or on-premises.\\n\\n\\n**Azure Test Plans** - No QA person will be left behind with the test managemen\", \"t and exploratory\\ntesting support offered by the Test Plans feature.\\n\\n\\n**Azure Artifacts** - An arti\", \"fact feed that allows companies to create their own, internal, versions of\\nNuGet, npm, and others. I\", \"t serves a double purpose of acting as a cache of upstream packages if\\nthere\\u2019s a failure of a centra\", \"lized repository.\\n\\n\\nThe top-level organizational unit in Azure DevOps is known as a Project. Within \", \"each project the\\nvarious components, such as Azure Artifacts, can be turned on and off. Each of thes\", \"e components\\nprovides different advantages for cloud-native applications. The three most useful are \", \"repositories,\\nboards, and pipelines. If users want to manage their source code in another repository\", \" stack, such as\\nGitHub, but still take advantage of Azure Pipelines and other components, that\\u2019s per\", \"fectly possible.\\n\\n\\nFortunately, development teams have many options when selecting a repository. One\", \" of them is\\nGitHub.\\n\\n### GitHub Actions\\n\\n\\nFounded in 2009, GitHub is a widely popular web-based repo\", \"sitory for hosting projects,\\ndocumentation, and code. Many large tech companies, such as Apple, Amaz\", \"on, Google, and\\nmainstream corporations use GitHub. GitHub uses the open-source, distributed version\", \" control system\\nnamed Git as its foundation. On top, it then adds its own set of features, including\", \" defect tracking,\\nfeature and pull requests, tasks management, and wikis for each code base.\\n\\n\\nAs Gi\", \"tHub evolves, it too is adding DevOps features. For example, GitHub has its own continuous\\nintegrati\", \"on/continuous delivery (CI/CD) pipeline, called GitHub Actions. GitHub Actions is a\\ncommunity-powere\", \"d workflow automation tool. It lets DevOps teams integrate with their existing\\ntooling, mix and matc\", \"h new products, and hook into their software lifecycle, including existing CI/CD\\npartners.\\u201d\\n\\n\\nGitHub\", \" has over 40 million users, making it the largest host of source code in the world. In October of\\n[2\", \"018, Microsoft purchased GitHub. Microsoft has pledged that GitHub will remain an open platform](htt\", \"ps://techcrunch.com/2018/06/04/microsoft-promises-to-keep-github-independent-and-open/)\\nthat any dev\", \"eloper can plug into and extend. It continues to operate as an independent company.\\nGitHub offers pl\", \"ans for enterprise, team, professional, and free accounts.\\n\\n### Source control\\n\\n\\nOrganizing the code\", \" for a cloud-native application can be challenging. Instead of a single giant\\napplication, the cloud\", \"-native applications tend to be made up of a web of smaller applications that\\ntalk with one another.\", \" As with all things in computing, the best arrangement of code remains an open\\n\\n\\n163 CHAPTER 10 | De\", \"vOps\\n\\n\\nquestion. There are examples of successful applications using different kinds of layouts, but\", \" two\\nvariants seem to have the most popularity.\\n\\n\\nBefore getting down into the actual source control\", \" itself, it\\u2019s probably worth deciding on how many\\nprojects are appropriate. Within a single project,\", \" there\\u2019s support for multiple repositories, and build\\npipelines. Boards are a little more complicate\", \"d, but there too, the tasks can easily be assigned to\\nmultiple teams within a single project. It\\u2019s p\", \"ossible to support hundreds, even thousands of\\ndevelopers, out of a single Azure DevOps project. Doi\", \"ng so is likely the best approach as it provides a\\nsingle place for all developer to work out of and\", \" reduces the confusion of finding that one application\\nwhen developers are unsure in which project i\", \"n which it resides.\\n\\n\\nSplitting up code for microservices within the Azure DevOps project can be sli\", \"ghtly more challenging.\\n\\n\\n_Figure 10-3 - One vs. many repositories._\\n\\n#### **Repository per microser\", \"vice**\\n\\n\\nAt first glance, this approach seems like the most logical approach to splitting up the sou\", \"rce code for\\nmicroservices. Each repository can contain the code needed to build the one microservic\", \"e. The\\nadvantages to this approach are readily visible:\\n\\n\\n1. Instructions for building and maintaini\", \"ng the application can be added to a README file at\\nthe root of each repository. When flipping throu\", \"gh the repositories, it\\u2019s easy to find these\\ninstructions, reducing spin-up time for developers.\\n\\n2.\", \" Every service is located in a logical place, easily found by knowing the name of the service.\\n\\n3. B\", \"uilds can easily be set up such that they\\u2019re only triggered when a change is made to the\\nowning repo\", \"sitory.\\n\\n4. The number of changes coming into a repository is limited to the small number of develop\", \"ers\\nworking on the project.\\n\\n\\n164 CHAPTER 10 | DevOps\\n\\n\\n5. Security is easy to set up by restricting\", \" the repositories to which developers have read and\\nwrite permissions.\\n\\n6. Repository level settings\", \" can be changed by the owning team with a minimum of discussion\\nwith others.\\n\\nOne of the key ideas b\", \"ehind microservices is that services should be siloed and separated from each\\nother. When using Doma\", \"in Driven Design to decide on the boundaries for services the services act as\\ntransactional boundari\", \"es. Database updates shouldn\\u2019t span multiple services. This collection of related\\ndata is referred t\", \"o as a bounded context. This idea is reflected by the isolation of microservice data to\\na database s\", \"eparate and autonomous from the rest of the services. It makes a great deal of sense to\\ncarry this i\", \"dea all the way through to the source code.\\n\\n\\nHowever, this approach isn\\u2019t without its issues. One o\", \"f the more gnarly development problems of our\\ntime is managing dependencies. Consider the number of \", \"files that make up the average\\nnode_modules directory. A fresh install of something like create-reac\", \"t-app is likely to bring with it\\nthousands of packages. The question of how to manage these dependen\", \"cies is a difficult one.\\n\\n\\nIf a dependency is updated, then downstream packages must also update thi\", \"s dependency.\\nUnfortunately, that takes development work so, invariably, the node_modules directory \", \"ends up with\\nmultiple versions of a single package, each one a dependency of some other package that\", \" is\\nversioned at a slightly different cadence. When deploying an application, which version of a\\ndep\", \"endency should be used? The version that is currently in production? The version that is currently\\ni\", \"n Beta but is likely to be in production by the time the consumer makes it to production? Difficult\\n\", \"problems that aren\\u2019t resolved by just using microservices.\\n\\n\\nThere are libraries that are depended u\", \"pon by a wide variety of projects. By dividing the microservices\\nup with one in each repository the \", \"internal dependencies can best be resolved by using the internal\\nrepository, Azure Artifacts. Builds\", \" for libraries will push their latest versions into Azure Artifacts for\\ninternal consumption. The do\", \"wnstream project must still be manually updated to take a dependency\\non the newly updated packages.\\n\", \"\\n\\nAnother disadvantage presents itself when moving code between services. Although it would be nice\\n\", \"to believe that the first division of an application into microservices is 100% correct, the reality\", \" is that\\nrarely we\\u2019re so prescient as to make no service division mistakes. Thus, functionality and \", \"the code that\\ndrives it will need to move from service to service: repository to repository. When le\", \"aping from one\\nrepository to another, the code loses its history. There are many cases, especially i\", \"n the event of an\\naudit, where having full history on a piece of code is invaluable.\\n\\n\\nThe final and\", \" most important disadvantage is coordinating changes. In a true microservices\\napplication, there sho\", \"uld be no deployment dependencies between services. It should be possible to\\ndeploy services A, B, a\", \"nd C in any order as they have loose coupling. In reality, however, there are\\ntimes when it\\u2019s desira\", \"ble to make a change that crosses multiple repositories at the same time. Some\\nexamples include upda\", \"ting a library to close a security hole or changing a communication protocol\\nused by all services.\\n\\n\", \"\\nTo do a cross-repository change requires a commit to each repository be made in succession. Each\\nch\", \"ange in each repository will need to be pull-requested and reviewed separately. This activity can be\", \"\\ndifficult to coordinate.\\n\\n\\n165 CHAPTER 10 | DevOps\\n\\n\\nAn alternative to using many repositories is t\", \"o put all the source code together in a giant, all knowing,\\nsingle repository.\\n\\n#### **Single reposi\", \"tory**\\n\\n\\n[In this approach, sometimes referred to as a monorepository, all the source code for every\", \" service is](https://danluu.com/monorepo/)\\nput into the same repository. At first, this approach see\", \"ms like a terrible idea likely to make dealing\\nwith source code unwieldy. There are, however, some m\", \"arked advantages to working this way.\\n\\n\\nThe first advantage is that it\\u2019s easier to manage dependenci\", \"es between projects. Instead of relying on\\nsome external artifact feed, projects can directly import\", \" one another. This means that updates are\\ninstant, and conflicting versions are likely to be found a\", \"t compile time on the developer\\u2019s workstation.\\nIn effect, shifting some of the integration testing l\", \"eft.\\n\\n\\nWhen moving code between projects, it\\u2019s now easier to preserve the history as the files will \", \"be\\ndetected as having been moved rather than being rewritten.\\n\\n\\nAnother advantage is that wide rangi\", \"ng changes that cross service boundaries can be made in a\\nsingle commit. This activity reduces the o\", \"verhead of having potentially dozens of changes to review\\nindividually.\\n\\n\\nThere are many tools that \", \"can perform static analysis of code to detect insecure programming\\npractices or problematic use of A\", \"PIs. In a multi-repository world, each repository will need to be\\niterated over to find the problems\", \" in them. The single repository allows running the analysis all in one\\nplace.\\n\\n\\nThere are also many \", \"disadvantages to the single repository approach. One of the most worrying ones\\nis that having a sing\", \"le repository raises security concerns. If the contents of a repository are leaked in\\na repository p\", \"er service model, the amount of code lost is minimal. With a single repository,\\neverything the compa\", \"ny owns could be lost. There have been many examples in the past of this\\nhappening and derailing ent\", \"ire game development efforts. Having multiple repositories exposes less\\nsurface area, which is a des\", \"irable trait in most security practices.\\n\\n\\nThe size of the single repository is likely to become unm\", \"anageable rapidly. This presents some\\n[interesting performance implications. It may become necessary\", \" to use specialized tools such as Virtual](https://github.com/Microsoft/VFSForGit)\\n[File System for \", \"Git, which was originally designed to improve the experience for developers on the](https://github.c\", \"om/Microsoft/VFSForGit)\\nWindows team.\\n\\n\\nFrequently the argument for using a single repository boils \", \"down to an argument that Facebook or\\nGoogle use this method for source code arrangement. If the appr\", \"oach is good enough for these\\ncompanies, then, surely, it\\u2019s the correct approach for all companies. \", \"The truth of the matter is that few\\ncompanies operate on anything like the scale of Facebook or Goog\", \"le. The problems that occur at\\nthose scales are different from those most developers will face. What\", \" is good for the goose may not\\nbe good for the gander.\\n\\n\\nIn the end, either solution can be used to \", \"host the source code for microservices. However, in most\\ncases, the management, and engineering over\", \"head of operating in a single repository isn\\u2019t worth the\\nmeager advantages. Splitting code up over m\", \"ultiple repositories encourages better separation of\\nconcerns and encourages autonomy among developm\", \"ent teams.\\n\\n\\n166 CHAPTER 10 | DevOps\\n\\n\\n#### **Standard directory structure**\\n\\nRegardless of the sing\", \"le versus multiple repositories debate each service will have its own directory.\\nOne of the best opt\", \"imizations to allow developers to cross between projects quickly is to maintain a\\nstandard directory\", \" structure.\\n\\n\\n_Figure 10-4 - Standard directory structure._\\n\\n\\nWhenever a new project is created, a t\", \"emplate that puts in place the correct structure should be used.\\nThis template can also include such\", \" useful items as a skeleton README file and an azurepipelines.yml. In any microservice architecture,\", \" a high degree of variance between projects makes bulk\\noperations against the services more difficul\", \"t.\\n\\n\\nThere are many tools that can provide templating for an entire directory, containing several so\", \"urce\\n[code directories. Yeoman is popular in the JavaScript world and GitHub have recently released]\", \"(https://yeoman.io/)\\n[Repository Templates, which provide much of the same functionality.](https://g\", \"ithub.blog/2019-06-06-generate-new-repositories-with-repository-templates/)\\n\\n### Task management\\n\\n\\nM\", \"anaging tasks in any project can be difficult. Up front there are countless questions to be answered\", \"\\nabout the sort of workflows to set up to ensure optimal developer productivity.\\n\\n\\nCloud-native appl\", \"ications tend to be smaller than traditional software products or at least they\\u2019re\\ndivided into smal\", \"ler services. Tracking of issues or tasks related to these services remains as important\\nas with any\", \" other software project. Nobody wants to lose track of some work item or explain to a\\ncustomer that \", \"their issue wasn\\u2019t properly logged. Boards are configured at the project level but within\\neach proje\", \"ct, areas can be defined. These allow breaking down issues across several components. The\\nadvantage \", \"to keeping all the work for the entire application in one place is that it\\u2019s easy to move work\\nitems\", \" from one team to another as they\\u2019re understood better.\\n\\n\\n167 CHAPTER 10 | DevOps\\n\\n\\nAzure DevOps com\", \"es with a number of popular templates pre-configured. In the most basic\\nconfiguration, all that is n\", \"eeded to know is what\\u2019s in the backlog, what people are working on, and\\nwhat\\u2019s done. It\\u2019s important \", \"to have this visibility into the process of building software, so that work\\ncan be prioritized and c\", \"ompleted tasks reported to the customer. Of course, few software projects\\nstick to a process as simp\", \"le as to do, doing, and done. It doesn\\u2019t take long for people to start adding\\nsteps like QA or Detai\", \"led Specification to the process.\\n\\n\\nOne of the more important parts of Agile methodologies is self-i\", \"ntrospection at regular intervals.\\nThese reviews are meant to provide insight into what problems the\", \" team is facing and how they can\\nbe improved. Frequently, this means changing the flow of issues and\", \" features through the\\ndevelopment process. So, it\\u2019s perfectly healthy to expand the layouts of the b\", \"oards with additional\\nstages.\\n\\n\\nThe stages in the boards aren\\u2019t the only organizational tool. Depend\", \"ing on the configuration of the\\nboard, there\\u2019s a hierarchy of work items. The most granular item tha\", \"t can appear on a board is a task.\\nOut of the box a task contains fields for a title, description, a\", \" priority, an estimate of the amount of\\nwork remaining and the ability to link to other work items o\", \"r development items (branches, commits,\\npull requests, builds, and so forth). Work items can be clas\", \"sified into different areas of the application\\nand different iterations (sprints) to make finding th\", \"em easier.\\n\\n\\n_Figure 10-5 - Task in Azure DevOps._\\n\\n\\nThe description field supports the normal style\", \"s you\\u2019d expect (bold, italic underscore and strike\\nthrough) and the ability to insert images. This m\", \"akes it a powerful tool for use when specifying work\\nor bugs.\\n\\n\\n[Tasks can be rolled up into feature\", \"s, which define a larger unit of work. Features, in turn, can be rolled](https://docs.microsoft.com/\", \"azure/devops/boards/backlogs/define-features-epics?view=azure-devops&preserve-view=true)\\n[up into ep\", \"ics. Classifying tasks in this hierarchy makes it much easier to understand how close a large](https\", \"://docs.microsoft.com/azure/devops/boards/backlogs/define-features-epics?view=azure-devops&preserve-\", \"view=true)\\nfeature is to rolling out.\\n\\n\\n168 CHAPTER 10 | DevOps\\n\\n\\n_Figure 10-6 - Work item in Azure \", \"DevOps._\\n\\n\\nThere are different kinds of views into the issues in Azure Boards. Items that aren\\u2019t yet\", \" scheduled\\nappear in the backlog. From there, they can be assigned to a sprint. A sprint is a time b\", \"ox during\\nwhich it\\u2019s expected some quantity of work will be completed. This work can include tasks b\", \"ut also the\\nresolution of tickets. Once there, the entire sprint can be managed from the Sprint boar\", \"d section. This\\nview shows how work is progressing and includes a burn down chart to give an ever-up\", \"dating\\nestimate of if the sprint will be successful.\\n\\n\\n_Figure 10-7 - Board in Azure DevOps._\\n\\n\\nBy n\", \"ow, it should be apparent that there\\u2019s a great deal of power in the Boards in Azure DevOps. For\\ndeve\", \"lopers, there are easy views of what is being worked on. For project managers views into\\nupcoming wo\", \"rk as well as an overview of existing work. For managers, there are plenty of reports\\nabout resourci\", \"ng and capacity. Unfortunately, there\\u2019s nothing magical about cloud-native applications\\nthat elimina\", \"te the need to track work. But if you must track work, there are a few places where the\\nexperience i\", \"s better than in Azure DevOps.\\n\\n### CI/CD pipelines\\n\\n\\nAlmost no change in the software development l\", \"ife cycle has been so revolutionary as the advent of\\ncontinuous integration (CI) and continuous deli\", \"very (CD). Building and running automated tests\\nagainst the source code of a project as soon as a ch\", \"ange is checked in catches mistakes early. Prior to\\nthe advent of continuous integration builds, it \", \"wouldn\\u2019t be uncommon to pull code from the\\n\\n\\n169 CHAPTER 10 | DevOps\\n\\n\\nrepository and find that it d\", \"idn\\u2019t pass tests or couldn\\u2019t even be built. This resulted in tracking down\\nthe source of the breakag\", \"e.\\n\\n\\nTraditionally shipping software to the production environment required extensive documentation \", \"and\\na list of steps. Each one of these steps needed to be manually completed in a very error prone\\np\", \"rocess.\\n\\n\\n_Figure 10-8 - Checklist._\\n\\n\\nThe sister of continuous integration is continuous delivery i\", \"n which the freshly built packages are\\ndeployed to an environment. The manual process can\\u2019t scale to\", \" match the speed of development so\\nautomation becomes more important. Checklists are replaced by scr\", \"ipts that can execute the same\\ntasks faster and more accurately than any human.\\n\\n\\nThe environment to\", \" which continuous delivery delivers might be a test environment or, as is being\\ndone by many major t\", \"echnology companies, it could be the production environment. The latter\\nrequires an investment in hi\", \"gh-quality tests that can give confidence that a change isn\\u2019t going to\\nbreak production for users. I\", \"n the same way that continuous integration caught issues in the code\\nearly continuous delivery catch\", \"es issues in the deployment process early.\\n\\n\\nThe importance of automating the build and delivery pro\", \"cess is accentuated by cloud-native\\napplications. Deployments happen more frequently and to more env\", \"ironments so manually deploying\\nborders on impossible.\\n\\n#### **Azure Builds**\\n\\n\\nAzure DevOps provide\", \"s a set of tools to make continuous integration and deployment easier than\\never. These tools are loc\", \"ated under Azure Pipelines. The first of them is Azure Builds, which is a tool\\nfor running YAML-base\", \"d build definitions at scale. Users can either bring their own build machines\\n(great for if the buil\", \"d requires a meticulously set up environment) or use a machine from a constantly\\nrefreshed pool of A\", \"zure hosted virtual machines. These hosted build agents come pre-installed with a\\n\\n\\n170 CHAPTER 10 |\", \" DevOps\\n\\n\\nwide range of development tools for not just .NET development but for everything from Java\", \" to\\nPython to iPhone development.\\n\\n\\nDevOps includes a wide range of out of the box build definitions\", \" that can be customized for any build.\\nThe build definitions are defined in a file called azure-pipe\", \"lines.yml and checked into the repository so\\nthey can be versioned along with the source code. This \", \"makes it much easier to make changes to the\\nbuild pipeline in a branch as the changes can be checked\", \" into just that branch. An example azurepipelines.yml for building an ASP.NET web application on ful\", \"l framework is show in Figure 10-9.\\n\\n\\n171 CHAPTER 10 | DevOps\\n\\n\\n_Figure 10-9 - A sample azure-pipeli\", \"nes.yml_\\n\\n\\nThis build definition uses a number of built-in tasks that make creating builds as simple\", \" as building a\\nLego set (simpler than the giant Millennium Falcon). For instance, the NuGet task res\", \"tores NuGet\\npackages, while the VSBuild task calls the Visual Studio build tools to perform the actu\", \"al compilation.\\nThere are hundreds of different tasks available in Azure DevOps, with thousands more\", \" that are\\nmaintained by the community. It\\u2019s likely that no matter what build tasks you\\u2019re looking to\", \" run,\\nsomebody has built one already.\\n\\n\\nBuilds can be triggered manually, by a check-in, on a schedu\", \"le, or by the completion of another build.\\nIn most cases, building on every check-in is desirable. B\", \"uilds can be filtered so that different builds run\\nagainst different parts of the repository or agai\", \"nst different branches. This allows for scenarios like\\nrunning fast builds with reduced testing on p\", \"ull requests and running a full regression suite against\\nthe trunk on a nightly basis.\\n\\n\\nThe end res\", \"ult of a build is a collection of files known as build artifacts. These artifacts can be passed\\nalon\", \"g to the next step in the build process or added to an Azure Artifacts feed, so they can be\\nconsumed\", \" by other builds.\\n\\n#### **Azure DevOps releases**\\n\\n\\nBuilds take care of compiling the software into \", \"a shippable package, but the artifacts still need to be\\npushed out to a testing environment to compl\", \"ete continuous delivery. For this, Azure DevOps uses a\\nseparate tool called Releases. The Releases t\", \"ool makes use of the same tasks\\u2019 library that were\\navailable to the Build but introduce a concept of\", \" \\u201cstages\\u201d. A stage is an isolated environment into\\nwhich the package is installed. For instance, a p\", \"roduct might make use of a development, a QA, and a\\nproduction environment. Code is continuously del\", \"ivered into the development environment where\\nautomated tests can be run against it. Once those test\", \"s pass the release moves onto the QA\\nenvironment for manual testing. Finally, the code is pushed to \", \"production where it\\u2019s visible to\\neverybody.\\n\\n\\n_Figure 10-10 - Release pipeline_\\n\\n\\nEach stage in the \", \"build can be automatically triggered by the completion of the previous phase. In\\nmany cases, however\", \", this isn\\u2019t desirable. Moving code into production might require approval from\\nsomebody. The Releas\", \"es tool supports this by allowing approvers at each step of the release pipeline.\\nRules can be set u\", \"p such that a specific person or group of people must sign off on a release before it\\n\\n\\n172 CHAPTER \", \"10 | DevOps\\n\\n\\nmakes into production. These gates allow for manual quality checks and also for compli\", \"ance with any\\nregulatory requirements related to control what goes into production.\\n\\n#### **Everybod\", \"y gets a build pipeline**\\n\\n\\nThere\\u2019s no cost to configuring many build pipelines, so it\\u2019s advantageou\", \"s to have at least one build\\npipeline per microservice. Ideally, microservices are independently dep\", \"loyable to any environment so\\nhaving each one able to be released via its own pipeline without relea\", \"sing a mass of unrelated code is\\nperfect. Each pipeline can have its own set of approvals allowing f\", \"or variations in build process for\\neach service.\\n\\n#### **Versioning releases**\\n\\n\\nOne drawback to usi\", \"ng the Releases functionality is that it can\\u2019t be defined in a checked-in azurepipelines.yml file. T\", \"here are many reasons you might want to do that from having per-branch release\\ndefinitions to includ\", \"ing a release skeleton in your project template. Fortunately, work is ongoing to\\nshift some of the s\", \"tages support into the Build component. This will be known as multi-stage build\\n[and the first versi\", \"on is available now!](https://devblogs.microsoft.com/devops/whats-new-with-azure-pipelines/)\\n\\n### Fe\", \"ature flags\\n\\n\\nIn chapter 1, we affirmed that cloud native is much about speed and agility. Users exp\", \"ect rapid\\nresponsiveness, innovative features, and zero downtime. Feature flags are a modern deploym\", \"ent\\ntechnique that helps increase agility for cloud-native applications. They enable you to deploy n\", \"ew\\nfeatures into a production environment, but restrict their availability. With the flick of a swit\", \"ch, you can\\nactivate a new feature for specific users without restarting the app or deploying new co\", \"de. They\\nseparate the release of new features from their code deployment.\\n\\n\\nFeature flags are built \", \"upon conditional logic that control visibility of functionality for users at run\\ntime. In modern clo\", \"ud-native systems, it\\u2019s common to deploy new features into production early, but\\ntest them with a li\", \"mited audience. As confidence increases, the feature can be incrementally rolled out\\nto wider audien\", \"ces.\\n\\n\\nOther use cases for feature flags include:\\n\\n\\n  - Restrict premium functionality to specific c\", \"ustomer groups willing to pay higher subscription\\nfees.\\n\\n  - Stabilize a system by quickly deactivat\", \"ing a problem feature, avoiding the risks of a rollback or\\nimmediate hotfix.\\n\\n  - Disable an optiona\", \"l feature with high resource consumption during peak usage periods.\\n\\n  - Conduct experimental featur\", \"e releases to small user segments to validate feasibility and\\npopularity.\\n\\n\\nFeature flags also promo\", \"te trunk-based development. It\\u2019s a source-control branching model where\\ndevelopers collaborate on fe\", \"atures in a single branch. The approach minimizes the risk and complexity\\nof merging large numbers o\", \"f long-running feature branches. Features are unavailable until activated.\\n\\n\\n173 CHAPTER 10 | DevOps\", \"\\n\\n\\n#### **Implementing feature flags**\\n\\nAt its core, a feature flag is a reference to a simple decis\", \"ion object. It returns a Boolean state of on or\\noff. The flag typically wraps a block of code that e\", \"ncapsulates a feature capability. The state of the flag\\ndetermines whether that code block executes \", \"for a given user. Figure 10-11 shows the\\nimplementation.\\n\\n\\n_Figure 10-11 - Simple feature flag imple\", \"mentation._\\n\\n\\nNote how this approach separates the decision logic from the feature code.\\n\\n\\nIn chapte\", \"r 1, we discussed the Twelve-Factor App. The guidance recommended keeping configuration\\nsettings ext\", \"ernal from application executable code. When needed, settings can be read in from the\\nexternal sourc\", \"e. Feature flag configuration values should also be independent from their codebase. By\\nexternalizin\", \"g flag configuration in a separate repository, you can change flag state without modifying\\nand redep\", \"loying the application.\\n\\n\\n[Azure App Configuration](https://docs.microsoft.com/azure/azure-app-confi\", \"guration/overview) provides a centralized repository for feature flags. With it, you define\\ndifferen\", \"t kinds of feature flags and manipulate their states quickly and confidently. You add the App\\nConfig\", \"uration client libraries to your application to enable feature flag functionality. Various\\nprogrammi\", \"ng language frameworks are supported.\\n\\n\\n[Feature flags can be easily implemented in an ASP.NET Core \", \"service. Installing the .NET Feature](https://docs.microsoft.com/azure/azure-app-configuration/use-f\", \"eature-flags-dotnet-core)\\nManagement libraries and App Configuration provider enable you to declarat\", \"ively add feature flags to\\nyour code. They enable FeatureGate attributes so that you don\\u2019t have to m\", \"anually write if statements\\nacross your codebase.\\n\\n\\nOnce configured in your Startup class, you can a\", \"dd feature flag functionality at the controller, action,\\nor middleware level. Figure 10-12 presents \", \"controller and action implementation:\\n\\n\\n_Figure 10-12 - Feature flag implementation in a controller \", \"and action._\\n\\n\\nIf a feature flag is disabled, the user will receive a 404 (Not Found) status code wi\", \"th no response body.\\n\\n\\nFeature flags can also be injected directly into C# classes. Figure 10-13 sho\", \"ws feature flag injection:\\n\\n\\n174 CHAPTER 10 | DevOps\\n\\n\\n_Figure 10-13 - Feature flag injection into a\", \" class._\\n\\n\\nThe Feature Management libraries manage the feature flag lifecycle behind the scenes. For\", \" example,\\nto minimize high numbers of calls to the configuration store, the libraries cache flag sta\", \"tes for a\\nspecified duration. They can guarantee the immutability of flag states during a request ca\", \"ll. They also\\noffer a Point-in-time snapshot. You can reconstruct the history of any key-value and p\", \"rovide its past\\nvalue at any moment within the previous seven days.\\n\\n### Infrastructure as code\\n\\n\\nCl\", \"oud-native systems embrace microservices, containers, and modern system design to achieve speed\\nand \", \"agility. They provide automated build and release stages to ensure consistent and quality code.\\nBut,\", \" that\\u2019s only part of the story. How do you provision the cloud environments upon which these\\nsystems\", \" run?\\n\\n\\n[Modern cloud-native applications embrace the widely accepted practice of Infrastructure as \", \"Code, or](https://docs.microsoft.com/devops/deliver/what-is-infrastructure-as-code)\\nIaC. With IaC, y\", \"ou automate platform provisioning. You essentially apply software engineering\\npractices such as test\", \"ing and versioning to your DevOps practices. Your infrastructure and\\ndeployments are automated, cons\", \"istent, and repeatable. Just as continuous delivery automated the\\ntraditional model of manual deploy\", \"ments, Infrastructure as Code (IaC) is evolving how application\\nenvironments are managed.\\n\\n\\nTools li\", \"ke Azure Resource Manager (ARM), Terraform, and the Azure Command Line Interface (CLI)\\nenable you to\", \" declaratively script the cloud infrastructure you require.\\n\\n#### **Azure Resource Manager templates\", \"**\\n\\n\\n[ARM stands for Azure Resource Manager. It\\u2019s an API provisioning engine that is built into Azur\", \"e and](https://docs.microsoft.com/azure/azure-resource-manager/management/overview)\\nexposed as an AP\", \"I service. ARM enables you to deploy, update, delete, and manage the resources\\ncontained in Azure re\", \"source group in a single, coordinated operation. You provide the engine with a\\nJSON-based template t\", \"hat specifies the resources you require and their configuration. ARM\\nautomatically orchestrates the \", \"deployment in the correct order respecting dependencies. The engine\\nensures idempotency. If a desire\", \"d resource already exists with the same configuration, provisioning\\nwill be ignored.\\n\\n\\nAzure Resourc\", \"e Manager templates are a JSON-based language for defining various resources in\\nAzure. The basic sch\", \"ema looks something like Figure 10-14.\\n\\n\\n175 CHAPTER 10 | DevOps\\n\\n\\n_Figure 10-14 - The schema for a \", \"Resource Manager template_\\n\\n\\nWithin this template, one might define a storage container inside the r\", \"esources section like so:\\n\\n\\n_Figure 10-15 - An example of a storage account defined in a Resource Ma\", \"nager template_\\n\\n\\nAn ARM template can be parameterized with dynamic environment and configuration in\", \"formation.\\nDoing so enables it to be reused to define different environments, such as development, Q\", \"A, or\\nproduction. Normally, the template creates all resources within a single Azure resource group.\", \" It\\u2019s\\npossible to define multiple resource groups in a single Resource Manager template, if needed. \", \"You\\ncan delete all resources in an environment by deleting the resource group itself. Cost analysis \", \"can also\\nbe run at the resource group level, allowing for quick accounting of how much each environm\", \"ent is\\ncosting.\\n\\n\\n[There are many examples of ARM templates available in the Azure Quickstart Templa\", \"tes project on](https://github.com/Azure/azure-quickstart-templates)\\nGitHub. They can help accelerat\", \"e creating a new template or modifying an existing one.\\n\\n\\nResource Manager templates can be run in m\", \"any of ways. Perhaps the simplest way is to simply paste\\nthem into the Azure portal. For experimenta\", \"l deployments, this method can be quick. They can also be\\nrun as part of a build or release process \", \"in Azure DevOps. There are tasks that will leverage\\nconnections into Azure to run the templates. Cha\", \"nges to Resource Manager templates are applied\\nincrementally, meaning that to add a new resource req\", \"uires just adding it to the template. The tooling\\nwill reconcile differences between the current res\", \"ources and those defined in the template. Resources\\nwill then be created or altered so they match wh\", \"at is defined in the template.\\n\\n#### **Terraform**\\n\\n\\nCloud-native applications are often constructed\", \" to be cloud agnostic. Being so means the application\\nisn\\u2019t tightly coupled to a particular cloud ve\", \"ndor and can be deployed to any public cloud.\\n\\n\\n176 CHAPTER 10 | DevOps\\n\\n\\n[Terraform](https://www.te\", \"rraform.io/) is a commercial templating tool that can provision cloud-native applications across all\", \" the\\nmajor cloud players: Azure, Google Cloud Platform, AWS, and AliCloud. Instead of using JSON as \", \"the\\ntemplate definition language, it uses the slightly more terse HCL (Hashicorp Configuration Langu\", \"age).\\n\\n\\nAn example Terraform file that does the same as the previous Resource Manager template (Figu\", \"re 1015) is shown in Figure 10-16:\\n\\n\\n_Figure 10-16 - An example of a Resource Manager template_\\n\\n\\nTe\", \"rraform also provides intuitive error messages for problem templates. There\\u2019s also a handy validate\\n\", \"task that can be used in the build phase to catch template errors early.\\n\\n\\nAs with Resource Manager \", \"templates, command-line tools are available to deploy Terraform\\ntemplates. There are also community-\", \"created tasks in Azure Pipelines that can validate and apply\\nTerraform templates.\\n\\n\\nSometimes Terraf\", \"orm and ARM templates output meaningful values, such as a connection string to a\\nnewly created datab\", \"ase. This information can be captured in the build pipeline and used in\\nsubsequent tasks.\\n\\n#### **Az\", \"ure CLI Scripts and Tasks**\\n\\n\\n[Finally, you can leverage Azure CLI](https://docs.microsoft.com/cli/a\", \"zure/) to declaratively script your cloud infrastructure. Azure CLI scripts\\ncan be created, found, a\", \"nd shared to provision and configure almost any Azure resource. The CLI is\\nsimple to use with a gent\", \"le learning curve. Scripts are executed within either PowerShell or Bash.\\nThey\\u2019re also straightforwa\", \"rd to debug, especially when compared with ARM templates.\\n\\n\\nAzure CLI scripts work well when you nee\", \"d to tear down and redeploy your infrastructure. Updating\\nan existing environment can be tricky. Man\", \"y CLI commands aren\\u2019t idempotent. That means they\\u2019ll\\nrecreate the resource each time they\\u2019re run, ev\", \"en if the resource already exists. It\\u2019s always possible to\\nadd code that checks for the existence of\", \" each resource before creating it. But, doing so, your script\\ncan become bloated and difficult to ma\", \"nage.\\n\\n\\nThese scripts can also be embedded in Azure DevOps pipelines as Azure CLI tasks. Executing t\", \"he\\npipeline invokes the script.\\n\\n\\n177 CHAPTER 10 | DevOps\\n\\n\\nFigure 10-17 shows a YAML snippet that l\", \"ists the version of Azure CLI and the details of the\\nsubscription. Note how Azure CLI commands are i\", \"ncluded in an inline script.\\n\\n\\n_Figure 10-17 - Azure CLI script_\\n\\n\\n[In the article, What is Infrastr\", \"ucture as Code, Author Sam Guckenheimer describes how, \\u201cTeams who](https://docs.microsoft.com/devops\", \"/deliver/what-is-infrastructure-as-code)\\nimplement IaC can deliver stable environments rapidly and a\", \"t scale. Teams avoid manual\\nconfiguration of environments and enforce consistency by representing th\", \"e desired state of their\\nenvironments via code. Infrastructure deployments with IaC are repeatable a\", \"nd prevent runtime issues\\ncaused by configuration drift or missing dependencies. DevOps teams can wo\", \"rk together with a\\nunified set of practices and tools to deliver applications and their supporting i\", \"nfrastructure rapidly,\\nreliably, and at scale.\\u201d\\n\\n### Cloud Native Application Bundles\\n\\n\\nA key proper\", \"ty of cloud-native applications is that they leverage the capabilities of the cloud to speed\\nup deve\", \"lopment. This design often means that a full application uses different kinds of technologies.\\nAppli\", \"cations may be shipped in Docker containers, some services may use Azure Functions, while\\nother part\", \"s may run directly on virtual machines allocated on large metal servers with hardware GPU\\naccelerati\", \"on. No two cloud-native applications are the same, so it\\u2019s been difficult to provide a single\\nmechan\", \"ism for shipping them.\\n\\n\\nThe Docker containers may run on Kubernetes using a Helm Chart for deployme\", \"nt. The Azure\\nFunctions may be allocated using Terraform templates. Finally, the virtual machines ma\", \"y be allocated\\nusing Terraform but built out using Ansible. This is a large variety of technologies \", \"and there has been\\nno way to package them all together into a reasonable package. Until now.\\n\\n\\nCloud\", \" Native Application Bundles (CNABs) are a joint effort by many community-minded companies\\nsuch as Mi\", \"crosoft, Docker, and HashiCorp to develop a specification to package distributed\\napplications.\\n\\n\\nThe\", \" effort was announced in December of 2018, so there\\u2019s still a fair bit of work to do to expose the\\n[\", \"effort to the greater community. However, there\\u2019s already an open specification and a reference](htt\", \"ps://github.com/deislabs/cnab-spec)\\n[implementation known as Duffle. This tool, which was written in\", \" Go, is a joint effort between Docker](https://duffle.sh/)\\nand Microsoft.\\n\\n\\nThe CNABs can contain di\", \"fferent kinds of installation technologies. This aspect allows things like Helm\\nCharts, Terraform te\", \"mplates, and Ansible Playbooks to coexist in the same package. Once built, the\\npackages are self-con\", \"tained and portable; they can be installed from a USB stick. The packages are\\ncryptographically sign\", \"ed to ensure they originate from the party they claim.\\n\\n\\n178 CHAPTER 10 | DevOps\\n\\n\\nThe core of a CNA\", \"B is a file called bundle.json. This file defines the contents of the bundle, be they\\nTerraform or i\", \"mages or anything else. Figure 11-9 defines a CNAB that invokes some Terraform.\\nNotice, however, tha\", \"t it actually defines an invocation image that is used to invoke the Terraform.\\nWhen packaged up, th\", \"e Docker file that is located in the _cnab_ directory is built into a Docker image,\\nwhich will be in\", \"cluded in the bundle. Having Terraform installed inside a Docker container in the\\nbundle means that \", \"users don\\u2019t need to have Terraform installed on their machine to run the bundling.\\n\\n\\n_Figure 10-18 -\", \" An example Terraform file_\\n\\n\\nThe bundle.json also defines a set of parameters that are passed down \", \"into the Terraform.\\nParameterization of the bundle allows for installation in various different envi\", \"ronments.\\n\\n\\nThe CNAB format is also flexible, allowing it to be used against any cloud. It can even \", \"be used against\\n[on-premises solutions such as OpenStack.](https://www.openstack.org/)\\n\\n\\n179 CHAPTER\", \" 10 | DevOps\\n\\n\\n#### **DevOps Decisions**\\n\\nThere are so many great tools in the DevOps space these da\", \"ys and even more fantastic books and\\n[papers on how to succeed. A favorite book to get started on th\", \"e DevOps journey is The Phoenix](https://www.oreilly.com/library/view/the-phoenix-project/9781457191\", \"350/)\\n[Project, which follows the transformation of a fictional company from NoOps to DevOps. One th\", \"ing is](https://www.oreilly.com/library/view/the-phoenix-project/9781457191350/)\\nfor certain: DevOps\", \" is no longer a \\u201cnice to have\\u201d when deploying complex, Cloud Native Applications.\\nIt\\u2019s a requirement\", \" and should be planned for and resourced at the start of any project.\\n\\n#### **References**\\n\\n\\n  - [Az\", \"ure DevOps](https://azure.microsoft.com/services/devops/)\\n\\n  - [Azure Resource Manager](https://docs\", \".microsoft.com/azure/azure-resource-manager/management/overview)\\n\\n  - [Terraform](https://www.terraf\", \"orm.io/)\\n\\n  - [Azure CLI](https://docs.microsoft.com/cli/azure/)\\n\\n\\n180 CHAPTER 10 | DevOps\\n\\n\\n**CHAPT\", \"ER**\\n# 11\\n\\n## Summary: Architecting cloud-native apps\\n\\n\\nIn summary, here are important conclusions f\", \"rom this guide:\\n\\n\\n  - **Cloud-native** is about designing modern applications that embrace rapid cha\", \"nge, large scale,\\nand resilience, in modern, dynamic environments such as public, private, and hybri\", \"d clouds.\\n\\n\\n  - The **[Cloud Native Computing Foundation (CNCF)](https://www.cncf.io/)** is an influ\", \"ential open-source consortium\\nof over 300 major corporations. It\\u2019s responsible for driving the adopt\", \"ion of cloud-native\\ncomputing across technology and cloud stacks.\\n\\n\\n  - **CNCF guidelines** recommen\", \"d that cloud-native applications embrace six important pillars as\\nshown in Figure 11-1:\\n\\n\\n**Figure 1\", \"1-1** . Cloud-native foundational pillars\\n\\n\\n  - These cloud-native pillars include:\\n\\n\\n     - The clo\", \"ud and its underlying service model\\n\\n     - Modern design principles\\n\\n     - Microservices\\n\\n     - C\", \"ontainerization and container orchestration\\n\\n     - Cloud-based backing services, such as databases \", \"and message brokers\\n\\n     - Automation, including Infrastructure as Code and code deployment\\n\\n\\n181 C\", \"HAPTER 11 | Summary: Architecting cloud-native apps\\n\\n\\n  - **Kubernetes** is the hosting environment \", \"of choice for most cloud-native applications. Smaller,\\nsimple services are sometimes hosted in serve\", \"rless platforms, such as Azure Functions. Among\\nmany key automation features, both environments prov\", \"ide automatic scaling to handle\\nfluctuating workload volumes.\\n\\n\\n  - **Service communication** become\", \"s a significant design decision when constructing a cloudnative application. Applications typically \", \"expose an API gateway to manage front-end client\\ncommunication. Then backend microservices strive to\", \" communicate with each other\\nimplementing asynchronous communication patterns, when possible.\\n\\n\\n  - \", \"**gRPC** is a modern, high-performance framework that evolves the age-old remote procedure\\ncall (RPC\", \") protocol. Cloud-native applications often embrace gRPC to streamline messaging\\nbetween back-end se\", \"rvices. gRPC uses HTTP/2 for its transport protocol. It can be up to 8x\\nfaster than JSON serializati\", \"on with message sizes 60-80% smaller. gRPC is open source and\\nmanaged by the Cloud Native Computing \", \"Foundation (CNCF).\\n\\n\\n  - **Distributed data** is a model often implemented by cloud-native applicati\", \"ons. Applications\\nsegregate business functionality into small, independent microservices. Each micro\", \"service\\nencapsulates its own dependencies, data, and state. The classic shared database model\\nevolve\", \"s into one of many smaller databases, each aligning with a microservice. When the\\nsmoke clears, we e\", \"merge with a design that exposes a database-per-microservice model.\\n\\n\\n  - **No-SQL databases** refer\", \" to high-performance, non-relational data stores. They excel in their\\nease-of-use, scalability, resi\", \"lience, and availability characteristics. High volume services that\\nrequire sub second response time\", \" favor NoSQL datastores. The proliferation of NoSQL\\ntechnologies for distributed cloud-native system\", \"s can\\u2019t be overstated.\\n\\n\\n  - **NewSQL** is an emerging database technology that combines the distrib\", \"uted scalability of\\nNoSQL and the ACID guarantees of a relational database. NewSQL databases target \", \"business\\nsystems that must process high-volumes of data, across distributed environments, with full\\n\", \"transactional/ACID compliance. The Cloud Native Computing Foundation (CNCF) features\\nseveral NewSQL \", \"database projects.\\n\\n\\n  - **Resiliency** is the ability of your system to react to failure and still \", \"remain functional. Cloudnative systems embrace distributed architecture where failure is inevitable.\", \" Applications must\\nbe constructed to respond elegantly to failure and quickly return to a fully func\", \"tioning state.\\n\\n\\n  - **Service meshes** are a configurable infrastructure layer with built-in capabi\", \"lities to handle\\nservice communication and other cross-cutting challenges. They decouple cross-cutti\", \"ng\\nresponsibilities from your business code. These responsibilities move into a service proxy.\\nRefer\", \"red to as the Sidecar pattern, the proxy is deployed into a separate process to provide\\nisolation fr\", \"om your business code.\\n\\n\\n  - **Observability** is a key design consideration for cloud-native applic\", \"ations. As services are\\ndistributed across a cluster of nodes, centralized logging, monitoring, and \", \"alerts, become\\nmandatory. Azure Monitor is a collection of cloud-based tools designed to provide vis\", \"ibility\\ninto the state of your system.\\n\\n\\n182 CHAPTER 11 | Summary: Architecting cloud-native apps\\n\\n\\n\", \"  - **Infrastructure as Code** is a widely accepted practice that automates platform provisioning.\\nY\", \"our infrastructure and deployments are automated, consistent, and repeatable. Tools like\\nAzure Resou\", \"rce Manager, Terraform, and the Azure CLI, enable you to declaratively script the\\ncloud infrastructu\", \"re you require.\\n\\n\\n  - **Code automation** is a requirement for cloud-native applications. Modern CI/\", \"CD systems help\\nfulfill this principle. They provide separate build and deployment steps that help e\", \"nsure\\nconsistent and quality code. The build stage transforms the code into a binary artifact. The\\nr\", \"elease stage picks up the binary artifact, applies external environment configuration, and\\ndeploys i\", \"t to a specified environment. Azure DevOps and GitHub are full-featured DevOps\\nenvironments.\\n\\n\\n183 C\", \"HAPTER 11 | Summary: Architecting cloud-native apps\\n\\n\\n\"]"