"[\"<!-- image -->\\n\\n<!-- image -->\\n\\n## EDITION v1.0.3\\n\\nRefer changelog for the book updates and communit\", \"y contributions.\\n\\nPUBLISHED BY\\n\\nMicrosoft Developer Division, .NET, and Visual Studio product teams\\n\", \"\\nA division of Microsoft Corporation\\n\\nOne Microsoft Way\\n\\nRedmond, Washington 98052-6399\\n\\nCopyright \\u00a9\", \" 2023 by Microsoft Corporation\\n\\nAll rights reserved. No part of the contents of this book may be rep\", \"roduced or transmitted in any form or by any means without the written permission of the publisher.\\n\", \"\\nThis book is provided 'as -is' and expresses the author's views and opinions. The views, opinions, \", \"and information expressed in this book, including URL and other Internet website references, may cha\", \"nge without notice.\\n\\nSome examples depicted herein are provided for illustration only and are fictit\", \"ious. No real association or connection is intended or should be inferred.\\n\\nMicrosoft and the tradem\", \"arks listed at https://www.microsoft.com on the 'Trademarks' webpage are trademarks of the Microsoft\", \" group of companies.\\n\\nMac and macOS are trademarks of Apple Inc.\\n\\nThe Docker whale logo is a registe\", \"red trademark of Docker, Inc. Used by permission.\\n\\nAll other marks and logos are property of their r\", \"espective owners.\\n\\nAuthors:\\n\\nRob Vettor , Principal MTC (Microsoft Technology Center) Architect for \", \"Cloud App Innovation thinkingincloudnative.com, Microsoft\\n\\nSteve 'ardalis' Smith , Software Architec\", \"t and Trainer - Ardalis.com\\n\\nParticipants and Reviewers:\\n\\nCesar De la Torre , Principal Program Mana\", \"ger, .NET team, Microsoft\\n\\nNish Anil , Senior Program Manager, .NET team, Microsoft\\n\\nJeremy Likness\\n\", \"\\n, Senior Program Manager, .NET team, Microsoft\\n\\nCecil Phillip , Senior Cloud Advocate, Microsoft\\n\\nS\", \"umit Ghosh , Principal Consultant at Neudesic\\n\\nEditors:\\n\\nMaira Wenzel , Program Manager, .NET team, \", \"Microsoft\\n\\n<!-- image -->\\n\\nDavid Pine , Senior Content Developer, .NET docs, Microsoft\\n\\n## Version\\n\\n\", \"This guide has been written to cover .NET 7 version along with many additional updates related to th\", \"e same 'wave' of technologies (that is, Azure and additional third -party technologies) coinciding i\", \"n time with the .NET 7 release.\\n\\n## Who should use this guide\\n\\nThe audience for this guide is mainly\", \" developers, development leads, and architects who are interested in learning how to build applicati\", \"ons designed for the cloud.\\n\\nA secondary audience is technical decision-makers who plan to choose wh\", \"ether to build their applications using a cloud-native approach.\\n\\n## How you can use this guide\\n\\nThi\", \"s guide begins by defining cloud native and introducing a reference application built using cloudnat\", \"ive principles and technologies. Beyond these first two chapters, the rest of the book is broken up \", \"into specific chapters focused on topics common to most cloud-native applications. You can jump to a\", \"ny of these chapters to learn about cloud-native approaches to:\\n\\n- Data and data access\\n- Communicat\", \"ion patterns\\n- Scaling and scalability\\n- Application resiliency\\n- Monitoring and health\\n- Identity a\", \"nd security\\n- DevOps\\n\\nThis guide is available both in PDF form and online. Feel free to forward this\", \" document or links to its online version to your team to help ensure common understanding of these t\", \"opics. Most of these topics benefit from a consistent understanding of the underlying principles and\", \" patterns, as well as the trade-offs involved in decisions related to these topics. Our goal with th\", \"is document is to equip teams and their leaders with the information they need to make well-informed\", \" decisions for their applications' architecture, development, and hos ting.\\n\\n<!-- image -->\\n\\n## Cont\", \"ents\\n\\n| Introduction to cloud-native applications...................................................\", \".........................                                                                          |\", \" 1   |\\n|--------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"|-----|\\n| Cloud-native computing ...................................................................\", \"...............................................................................3                    \", \" |     |\\n| What is Cloud Native?....................................................................\", \"........................................................................................4           \", \"  |     |\\n| The pillars of cloud native.............................................................\", \"...................................................................................5                \", \"   |     |\\n| The cloud..............................................................................\", \"..................................................................................................5 \", \"    |     |\\n| Modern design.........................................................................\", \"............................................................................................6       \", \"     |     |\\n| Microservices .......................................................................\", \".................................................................................................9  \", \"      |     |\\n| Containers..........................................................................\", \".................................................................................................12 \", \"       |     |\\n| Backing services...................................................................\", \".............................................................................................15     \", \"        |     |\\n| Automation........................................................................\", \".................................................................................................17 \", \"         |     |\\n| Candidate apps for cloud native..................................................\", \"...................................................................................                 \", \"          | 19  |\\n| Modernizing legacy apps.........................................................\", \".....................................................................................19             \", \"           |     |\\n| Summary........................................................................\", \"....................................................................................................\", \"..21        |     |\\n| Introducing eShopOnContainers reference app ..................................\", \"..............................                                                                      \", \"             | 22  |\\n| Features and requirements....................................................\", \"...........................................................................................         \", \"              | 23  |\\n| Overview of the code........................................................\", \"..................................................................................................  \", \"               | 25  |\\n| Understanding microservices................................................\", \"...........................................................................................         \", \"                | 27  |\\n| Mapping eShopOnContainers to Azure Services...............................\", \"......................................................................                              \", \"                 | 27  |\\n| Container orchestration and clustering...................................\", \"................................................................................28                  \", \"                  |     |\\n| API Gateway ............................................................\", \"....................................................................................................\", \".......28          |     |\\n| Data ..................................................................\", \"....................................................................................................\", \".................29 |     |\\n| Event Bus.............................................................\", \"....................................................................................................\", \"............30       |     |\\n| Resiliency...........................................................\", \"....................................................................................................\", \"..............30      |     |\\n| Deploying eShopOnContainers to Azure................................\", \"....................................................................................                \", \"                       | 30  |\\n| Azure Kubernetes Service ..........................................\", \"...................................................................................................3\", \"0                       |     |\\n| Deploying to Azure Kubernetes Service using Helm..................\", \".......................................................................30                           \", \"                         |     |\\n| Azure Functions and Logic Apps (Serverless) .....................\", \"..................................................................................32                \", \"                          |     |\\n| Centralized configuration.......................................\", \"....................................................................................................\", \".......                    | 33  |\\n\\n| Azure App Configuration ......................................\", \"....................................................................................................\", \"....33                |    |\\n|----------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"---------------|----|\\n| Azure Key Vault.............................................................\", \"....................................................................................................\", \"34      |    |\\n| Configuration in eShop.............................................................\", \".....................................................................................34             \", \" |    |\\n| References................................................................................\", \"...........................................................................................34 |    |\", \"\\n| Scaling cloud-native applications................................................................\", \"........................                                                               | 36 |\\n| Leve\", \"raging containers and orchestrators.................................................................\", \"...................................................                             | 36 |\\n| Challenges \", \"with monolithic deployments.........................................................................\", \".....................................36                                  |    |\\n| What are the benef\", \"its of containers and orchestrators?................................................................\", \"..................38                                              |    |\\n| What are the scaling bene\", \"fits?...............................................................................................\", \".....................................40                    |    |\\n| What scenarios are ideal for con\", \"tainers and orchestrators?..........................................................................\", \".42                                                 |    |\\n| When should you avoid using containers \", \"and orchestrators?.......................................................................42         \", \"                                             |    |\\n| Development resources.........................\", \"....................................................................................................\", \"....................42                |    |\\n| Leveraging serverless functions .....................\", \"....................................................................................................\", \".............                  | 46 |\\n| What is serverless?.........................................\", \"....................................................................................................\", \"..............47        |    |\\n| What challenges are solved by serverless?..........................\", \"..................................................................................47                \", \"                 |    |\\n| What is the difference between a microservice and a serverless function? .\", \"............................................47                                                      \", \"          |    |\\n| What scenarios are appropriate for serverless?...................................\", \"................................................................47                                  \", \"   |    |\\n| When should you avoid serverless?.......................................................\", \"...................................................................48                           |   \", \" |\\n| Combining containers and serverless approaches.................................................\", \".................................................                                        | 49 |\\n| Wh\", \"en does it make sense to use containers with serverless?............................................\", \"............................49                                                    |    |\\n| When shou\", \"ld you avoid using containers with Azure Functions?.................................................\", \"...............49                                                          |    |\\n| How to combine s\", \"erverless and Docker containers.....................................................................\", \"......................49                                            |    |\\n| How to combine serverle\", \"ss and Kubernetes with KEDA.........................................................................\", \".........50                                                  |    |\\n| Deploying containers in Azure \", \"....................................................................................................\", \"....................................                  | 50 |\\n| Azure Container Registry ............\", \"....................................................................................................\", \"..............................50               |    |\\n| ACR Tasks...................................\", \"....................................................................................................\", \".....................................52 |    |\\n| Azure Kubernetes Service ..........................\", \"....................................................................................................\", \"...............52                |    |\\n| Azure Bridge to Kubernetes................................\", \"....................................................................................................\", \".....53                   |    |\\n| Scaling containers and serverless applications...................\", \"......................................................................................              \", \"                   | 53 |\\n| The simple solution: scaling up.........................................\", \".........................................................................................53         \", \"            |    |\\n| Scaling out cloud-native apps .................................................\", \"...................................................................................54               \", \"     |    |\\n| Other container deployment options....................................................\", \".......................................................................                           | \", \"55 |\\n\\n| When does it make sense to deploy to App Service for                                        \", \"                                                                                                    \", \"| Containers?.........................................................55   |\\n|----------------------\", \"----------------------------------------------------------------------------------------------------\", \"-----------------------------------------------------------------------|----------------------------\", \"----------------------------------------------|\\n| How to deploy to App Service for Containers.......\", \"...............................................................................................55   \", \"                                          |                                                         \", \"                 |\\n| When does it make sense to deploy to Azure Container Instances? ...............\", \"...........................................55                                                       \", \"             |                                                                          |\\n| How to d\", \"eploy an app to Azure Container Instances...........................................................\", \".............................55                                                     |               \", \"                                                           |\\n| References...........................\", \"....................................................................................................\", \"............................................56         |                                            \", \"                              |\\n| Cloud-native communication patterns ..............................\", \".................................................                                                   \", \"                          | 58                                                                      \", \" |\\n| Communication considerations ..................................................................\", \"....................................................................                             | 5\", \"8                                                                       |\\n| Front-end client communi\", \"cation..............................................................................................\", \"......................................                              | 60                            \", \"                                           |\\n| Simple Gateways .....................................\", \"....................................................................................................\", \".....................62                |                                                            \", \"              |\\n| Azure Application Gateway.........................................................\", \".................................................................................63                 \", \"          |                                                                          |\\n| Azure API M\", \"anagement...........................................................................................\", \"......................................................63                         |                  \", \"                                                        |\\n| Real-time communication ................\", \"....................................................................................................\", \"........................66                          |                                               \", \"                           |\\n| Service-to-service communication ....................................\", \"............................................................................................        \", \"                       | 67                                                                       |\\n\", \"| Queries ..........................................................................................\", \".......................................................................................68     |     \", \"                                                                     |\\n| Commands...................\", \"....................................................................................................\", \"...................................................71            |                                  \", \"                                        |\\n| Events..................................................\", \"....................................................................................................\", \"..............................74    |                                                               \", \"           |\\n| gRPC.................................................................................\", \"....................................................................................................\", \"...... | 80                                                                       |\\n| What is gRPC? \", \"....................................................................................................\", \"...............................................................80             |                     \", \"                                                     |\\n| gRPC Benefits .............................\", \"....................................................................................................\", \"...................................80            |                                                  \", \"                        |\\n| Protocol Buffers .......................................................\", \"....................................................................................................\", \".....81             |                                                                          |\\n| g\", \"RPC support in .NET ................................................................................\", \".....................................................................81                    |        \", \"                                                                  |\\n| gRPC usage....................\", \"....................................................................................................\", \".................................................82           |                                     \", \"                                     |\\n| gRPC implementation .......................................\", \"....................................................................................................\", \".........83                      |                                                                  \", \"        |\\n| Looking ahead...........................................................................\", \"........................................................................................85          \", \"    |                                                                          |\\n| Service Mesh comm\", \"unication infrastructure ...........................................................................\", \"..................................                                         | 85                     \", \"                                                  |\\n| Summary.......................................\", \"....................................................................................................\", \"...................................86         |                                                     \", \"                     |\\n| Cloud-native data patterns ................................................\", \"..................................................                                                  \", \"                 | 88                                                                       |\\n| Data\", \"base-per-microservice, why?.........................................................................\", \".........................................................                               | 89        \", \"                                                               |\\n| Cross-service queries............\", \"....................................................................................................\", \"...........................................                | 90                                     \", \"                                  |\\n| Distributed transactions......................................\", \"....................................................................................................\", \"...........                   | 91                                                                  \", \"     |\\n| High volume data ..........................................................................\", \".......................................................................................             \", \" | 93                                                                       |\\n| CQRS................\", \"....................................................................................................\", \".................................................................93     |                           \", \"                                               |\\n\\n| Event sourcing..................................\", \"....................................................................................................\", \".............................94         |    |\\n|----------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"-------------------------------------|----|\\n| Relational vs. NoSQL data ............................\", \"....................................................................................................\", \".................                 | 96 |\\n| The CAP theorem..........................................\", \"....................................................................................................\", \"...............97              |    |\\n| Considerations for relational vs. NoSQL systems.............\", \"...................................................................................99               \", \"                            |    |\\n| Database as a Service..........................................\", \"....................................................................................................\", \".......99                |    |\\n| Azure relational databases .......................................\", \"..................................................................................................10\", \"0                     |    |\\n| Azure SQL Database...................................................\", \"...................................................................................................1\", \"00                 |    |\\n| Open-source databases in Azure..........................................\", \"...................................................................................101              \", \"                |    |\\n| NoSQL data in Azure .......................................................\", \".............................................................................................102    \", \"             |    |\\n| NewSQL databases..............................................................\", \"..........................................................................................106       \", \"          |    |\\n| Data migration to the cloud .....................................................\", \".................................................................................108                \", \"       |    |\\n| Caching in a cloud-native app.......................................................\", \"................................................................................108                 \", \"    |    |\\n| Why?...................................................................................\", \".................................................................................................108\", \" |    |\\n| Caching architecture......................................................................\", \"...............................................................................109                | \", \"   |\\n| Azure Cache for Redis .......................................................................\", \"...........................................................................110                 |    \", \"|\\n| Elasticsearch in a cloud-native app ............................................................\", \".................................................................110                        |    |\\n|\", \" Summary............................................................................................\", \"................................................................................111      |    |\\n| Cl\", \"oud-native resiliency ..............................................................................\", \".........................113                                                          |    |\\n| Appli\", \"cation resiliency patterns .........................................................................\", \".............................................................114                   |    |\\n| Circuit \", \"breaker pattern.....................................................................................\", \"............................................................116                 |    |\\n| Testing for\", \" resiliency.........................................................................................\", \"............................................................117              |    |\\n| Azure platform\", \" resiliency ........................................................................................\", \".........................................................117              |    |\\n| Design with resil\", \"iency...............................................................................................\", \"....................................................118                |    |\\n| Design with redundan\", \"cy..................................................................................................\", \"............................................118                     |    |\\n| Design for scalability.\", \"....................................................................................................\", \"................................................120              |    |\\n| Built-in retry in services\", \" ...................................................................................................\", \"............................................121               |    |\\n| Resilient communications.....\", \"....................................................................................................\", \".......................................122                 |    |\\n| Service mesh....................\", \"....................................................................................................\", \"............................................123         |    |\\n| Istio and Envoy....................\", \"....................................................................................................\", \"........................................124          |    |\\n| Integration with Azure Kubernetes Serv\", \"ices ...............................................................................................\", \"........125                                       |    |\\n| Monitoring and health....................\", \"....................................................................................126             \", \"                                               |    |\\n| Observability patterns......................\", \"....................................................................................................\", \".............................126            |    |\\n\\n| When to use logging...........................\", \"....................................................................................................\", \".....................126                    |\\n|-----------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"--------------------------------------|\\n| Challenges with detecting and responding to potential app \", \"health issues ...........................................130                                        \", \"                                |\\n| Challenges with reacting to critical problems in cloud-native ap\", \"ps..........................................................130                                     \", \"                          |\\n| Logging with Elastic Stack............................................\", \"...................................................................................................1\", \"31                  |\\n| Elastic Stack ..............................................................\", \"....................................................................................................\", \"....131       |\\n| What are the advantages of Elastic Stack? ........................................\", \"..................................................................132                               \", \"        |\\n| Logstash................................................................................\", \".............................................................................................132    \", \"  |\\n| Elasticsearch ................................................................................\", \".....................................................................................133        |\\n| \", \"Visualizing information with Kibana web dashboards .................................................\", \"...................................133                                                    |\\n| Instal\", \"ling Elastic Stack on Azure.........................................................................\", \"......................................................134                           |\\n| References..\", \"....................................................................................................\", \"...................................................................134        |\\n| Monitoring in Azur\", \"e Kubernetes Services...............................................................................\", \"..................................134                                   |\\n| Azure Monitor for Contai\", \"ners ...............................................................................................\", \"....................................134                           |\\n| Log.Finalize() ...............\", \"....................................................................................................\", \".................................................136        |\\n| Azure Monitor.......................\", \"....................................................................................................\", \"...........................................136        |\\n| Gathering logs and metrics................\", \"....................................................................................................\", \"....................137                         |\\n| Reporting data .................................\", \"....................................................................................................\", \"...........................137            |\\n| Dashboards............................................\", \"....................................................................................................\", \".......................138          |\\n| Alerts .....................................................\", \"....................................................................................................\", \"..........................140 |\\n| References........................................................\", \"....................................................................................................\", \".............141        |\\n| Cloud-native identity ..................................................\", \"........................................................142                                         \", \"                  |\\n| References ...................................................................\", \"....................................................................................................\", \"......142   |\\n| Authentication and authorization in cloud-native apps ..............................\", \".......................................................142                                          \", \"      |\\n| References................................................................................\", \".........................................................................................143        \", \"|\\n| Azure Active Directory .........................................................................\", \".............................................................................143              |\\n| Re\", \"ferences............................................................................................\", \".............................................................................143        |\\n| Identity\", \"Server for cloud-native applications................................................................\", \"............................................144                                   |\\n| Common web app\", \" scenarios..........................................................................................\", \"...........................................144                              |\\n| Getting started ....\", \"....................................................................................................\", \"........................................................145           |\\n| Configuration.............\", \"....................................................................................................\", \"..................................................145           |\\n| JavaScript clients .............\", \"....................................................................................................\", \"...........................................146            |\\n| References............................\", \"....................................................................................................\", \".........................................146        |\\n\\n| Cloud-native                               \", \"                                                                                                    \", \"                                              | security............................................\", \"..............................................................147                               |\\n|-\", \"----------------------------------------------------------------------------------------------------\", \"-----------------------------------------------------------------------------------------|----------\", \"----------------------------------------------------------------------------------------------------\", \"---------------------------------------|\\n| Azure security for cloud-native apps.....................\", \"....................................................................................................\", \".147                            |                                                                   \", \"                                                                                  |\\n| Threat modelin\", \"g...................................................................................................\", \"..........................................................148              |                        \", \"                                                                                                    \", \"                         |\\n| Principle of least privilege...........................................\", \"................................................................................................148 \", \"                  |                                                                                 \", \"                                                                    |\\n| Penetration testing.........\", \"....................................................................................................\", \"...........................................149               |                                      \", \"                                                                                                    \", \"           |\\n| Monitoring...........................................................................\", \".............................................................................................149    \", \"    |                                                                                               \", \"                                                      |\\n| Securing the build........................\", \"....................................................................................................\", \"..............................149              |                                                    \", \"                                                                                                 |\\n|\", \" Building secure code ..............................................................................\", \"......................................................................150                 |         \", \"                                                                                                    \", \"                                        |\\n| Built-in security ......................................\", \"....................................................................................................\", \".....................150         |                                                                  \", \"                                                                                   |\\n| Azure network\", \" infrastructure.....................................................................................\", \"................................................150                         |                       \", \"                                                                                                    \", \"                          |\\n| Role-based access control for restricting access to Azure resources...\", \".....................................................152                                            \", \"                   |                                                                                \", \"                                                                     |\\n| Security Principals........\", \"....................................................................................................\", \"..............................................152             |                                     \", \"                                                                                                    \", \"            |\\n| Roles...............................................................................\", \"....................................................................................................\", \".153 |                                                                                              \", \"                                                       |\\n| Scopes ..................................\", \"....................................................................................................\", \"..........................................154   |                                                   \", \"                                                                                                  |\\n\", \"| Deny .............................................................................................\", \".......................................................................................154 |        \", \"                                                                                                    \", \"                                         |\\n| Checking access........................................\", \"....................................................................................................\", \"..................154             |                                                                 \", \"                                                                                    |\\n| Securing sec\", \"rets................................................................................................\", \"..............................................................155            |                      \", \"                                                                                                    \", \"                           |\\n| Azure Key Vault......................................................\", \"....................................................................................................\", \".....155            |                                                                               \", \"                                                                      |\\n| Kubernetes................\", \"....................................................................................................\", \"....................................................155        |                                    \", \"                                                                                                    \", \"             |\\n| Encryption in transit and at rest .................................................\", \"..............................................................................156                   \", \"      |                                                                                             \", \"                                                        |\\n| Keeping secure..........................\", \"....................................................................................................\", \"..................................160            |                                                  \", \"                                                                                                   |\", \"\\n| DevOps ..........................................................................................\", \".......................................161                                                  |       \", \"                                                                                                    \", \"                                          |\\n| Azure DevOps..........................................\", \"....................................................................................................\", \".........................162       |                                                                \", \"                                                                                     |\\n| GitHub Acti\", \"ons.................................................................................................\", \"....................................................................163       |                     \", \"                                                                                                    \", \"                            |\\n| Source control......................................................\", \"....................................................................................................\", \"............163      |                                                                              \", \"                                                                       |\\n| Repository per microservi\", \"ce .................................................................................................\", \".....................................164                        |                                   \", \"                                                                                                    \", \"              |\\n| Single repository ................................................................\", \"............................................................................................166     \", \"       |                                                                                            \", \"                                                         |\\n| Standard directory structure...........\", \"....................................................................................................\", \".......................167                        |                                                 \", \"                                                                                                    \", \"|\\n| Task management.................................................................................\", \".............................................................................167             |      \", \"                                                                                                    \", \"                                           |\\n| CI/CD pipelines .....................................\", \"....................................................................................................\", \"...........................169      |                                                               \", \"                                                                                      |\\n| Azure Buil\", \"ds..................................................................................................\", \"....................................................................170        |                    \", \"                                                                                                    \", \"                             |\\n| Azure DevOps releases                                              \", \"                                                                                                    \", \"                      | ............................................................................\", \"....................................................................172 |\\n\\n| Everybody gets a build \", \"pipeline............................................................................................\", \"...................................173                          |\\n|---------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"-------------------------------------------------------|\\n| Versioning releases......................\", \"....................................................................................................\", \"..............................173             |\\n| Feature flags ....................................\", \"....................................................................................................\", \".................................173 |\\n| Implementing feature flags.................................\", \"....................................................................................................\", \"...174                      |\\n| Infrastructure as code .............................................\", \"....................................................................................................\", \"......175          |\\n| Azure Resource Manager templates ............................................\", \"..........................................................................175                       \", \"          |\\n| Terraform.............................................................................\", \"..............................................................................................176   \", \" |\\n| Azure CLI Scripts and Tasks....................................................................\", \"....................................................................177                     |\\n| Clou\", \"d Native Application Bundles .......................................................................\", \"........................................................178                        |\\n| DevOps Decisi\", \"ons ................................................................................................\", \"..........................................................180             |\\n| References............\", \"....................................................................................................\", \".........................................................180     |\\n| Summary: Architecting cloud-nat\", \"ive apps .......................................................................181                 \", \"                                                        |\\n\\n\\u0413\\n\\n1\\n\\nClient app\\n\\nMobile\\n\\nTraditional web\", \" app\\n\\nHTML\\n\\nDatabase\\n\\nRelational\\n\\n## Introduction to cloudnative applications Marketing Location\\n\\nAn\", \"other day, at the office, working on 'the next big thing.'\\n\\nYour cellphone rings. It's your friendly\", \" recruiter - the one who calls daily with exciting new opportunities.\\n\\nBut this time it's different:\", \" Start -up, equity, and plenty of funding.\\n\\nThe mention of the cloud, microservices, and cutting-edg\", \"e technology pushes you over the edge.\\n\\nFast forward a few weeks and you're now a new employee in a \", \"design session architecting a major eCommerce application. You're going to compete with the leading \", \"eCommerce sites.\\n\\nHow will you build it?\\n\\nIf you follow the guidance from past 15 years, you'll most\", \" likely build the system shown in Figure 1.1.\\n\\nFigure 1-1. Traditional monolithic design\\n\\n<!-- image\", \" -->\\n\\nYou construct a large core application containing all of your domain logic. It includes module\", \"s such as Identity, Catalog, Ordering, and more. They directly communicate with each other within a \", \"single server process. The modules share a large relational database. The core exposes functionality\", \" via an HTML interface and a mobile app.\\n\\nCongratulations! You just created a monolithic application\", \".\\n\\nNot all is bad. Monoliths offer some distinct advantages. For example, they're straightforward to\", \"\\u2026\\n\\nMonolithic server process\\n\\nModules\\n\\nAPI\\n\\nIdentity\\n\\nCatalog\\n\\n- build\\n- test\\n- deploy\\n- troubleshoo\", \"t\\n- vertically scale\\n\\nMany successful apps that exist today were created as monoliths. The app is a \", \"hit and continues to evolve, iteration after iteration, adding more functionality.\\n\\nAt some point, h\", \"owever, you begin to feel uncomfortable. You find yourself losing control of the application. As tim\", \"e goes on, the feeling becomes more intense, and you eventually enter a state known as the Fear Cycl\", \"e:\\n\\n- The app has become so overwhelmingly complicated that no single person understands it.\\n- You f\", \"ear making changes - each change has unintended and costly side effects.\\n- New features/fixes become\", \" tricky, time-consuming, and expensive to implement.\\n- Each release becomes as small as possible and\", \" requires a full deployment of the entire application.\\n- One unstable component can crash the entire\", \" system.\\n- New technologies and frameworks aren't an option.\\n- It's difficult to implement agile del\", \"ivery methodologies.\\n- Architectural erosion sets in as the code base deteriorates with neverending \", \"'quick fixes.'\\n- Finally, the consultants come in and tell you to rewrite it.\\n\\n## Sound familiar?\\n\\nM\", \"any organizations have addressed this monolithic fear cycle by adopting a cloud-native approach to b\", \"uilding systems. Figure 1-2 shows the same system built applying cloud-native techniques and practic\", \"es.\\n\\nClient apps\\n\\nMobile app\\n\\nTraditional Web app\\n\\nHTML\\n\\nSPA Web app\\n\\nTypeScript/Angular 2\\n\\nIdentity\", \" microservice (STS+users)\\n\\nRelational database\\n\\nCatalog microservice\\n\\nFigure 1-2. Cloud-native desig\", \"n\\n\\n<!-- image -->\\n\\nNote how the application is decomposed across a set of small isolated microservic\", \"es. Each service is self-contained and encapsulates its own code, data, and dependencies. Each is de\", \"ployed in a software container and managed by a container orchestrator. Instead of a large relationa\", \"l database, each service owns it own datastore, the type of which vary based upon the data needs. No\", \"te how some services depend on a relational database, but other on NoSQL databases. One service stor\", \"es its state in a distributed cache. Note how all traffic routes through an API Gateway service that\", \" is responsible for routing traffic to the core back-end services and enforcing many cross-cutting c\", \"oncerns. Most importantly, the application takes full advantage of the scalability, availability, an\", \"d resiliency features found in modern cloud platforms.\\n\\n## Cloud-native computing\\n\\nHmm\\u2026 We just used\", \" the term, Cloud Native . Your first thought might be, 'What exactly does that mean?' Another indust\", \"ry buzzword concocted by software vendors to market more stuff?'\\n\\nFortunately it's far different, an\", \"d hopefully this book will help convince you.\\n\\nWithin a short time, cloud native has become a drivin\", \"g trend in the software industry. It's a new way to construct large, complex systems. The approach t\", \"akes full advantage of modern software development practices, technologies, and cloud infrastructure\", \". Cloud native changes the way you design, implement, deploy, and operationalize systems.\\n\\nUnlike th\", \"e continuous hype that drives our industry, cloud native is for-real . Consider the Cloud Native Com\", \"puting Foundation (CNCF), a consortium of over 400 major corporations. Its charter is to make\\n\\nDocke\", \"r Host\\n\\ncloud-native computing ubiquitous across technology and cloud stacks. As one of the most inf\", \"luential open-source groups, it hosts many of the fastest-growing open source-projects in GitHub. Th\", \"ese projects include Kubernetes, Prometheus, Helm, Envoy, and gRPC.\\n\\nThe CNCF fosters an ecosystem o\", \"f open-source and vendor-neutrality. Following that lead, this book presents cloud-native principles\", \", patterns, and best practices that are technology agnostic. At the same time, we discuss the servic\", \"es and infrastructure available in the Microsoft Azure cloud for constructing cloud-native systems.\\n\", \"\\nSo, what exactly is Cloud Native? Sit back, relax, and let us help you explore this new world.\\n\\n## \", \"What is Cloud Native?\\n\\nStop what you're doing and ask your colleagues to define the term 'Cloud Nati\", \"ve'. There's a good chance you'll get several different answers.\\n\\nLet's start with a simple definiti\", \"on:\\n\\nCloud-native architecture and technologies are an approach to designing, constructing, and oper\", \"ating workloads that are built in the cloud and take full advantage of the cloud computing model.\\n\\nT\", \"he Cloud Native Computing Foundation provides the official definition:\\n\\nCloud-native technologies em\", \"power organizations to build and run scalable applications in modern, dynamic environments such as p\", \"ublic, private, and hybrid clouds. Containers, service meshes, microservices, immutable infrastructu\", \"re, and declarative APIs exemplify this approach.\\n\\nThese techniques enable loosely coupled systems t\", \"hat are resilient, manageable, and observable. Combined with robust automation, they allow engineers\", \" to make high-impact changes frequently and predictably with minimal toil.\\n\\nCloud native is about sp\", \"eed and agility . Business systems are evolving from enabling business capabilities to weapons of st\", \"rategic transformation that accelerate business velocity and growth. It's imperative to get new idea\", \"s to market immediately.\\n\\nAt the same time, business systems have also become increasingly complex w\", \"ith users demanding more. They expect rapid responsiveness, innovative features, and zero downtime. \", \"Performance problems, recurring errors, and the inability to move fast are no longer acceptable. You\", \"r users will visit your competitor. Cloud-native systems are designed to embrace rapid change, large\", \" scale, and resilience.\\n\\nHere are some companies who have implemented cloud-native techniques. Think\", \" about the speed, agility, and scalability they've achieved.\\n\\n| Company   | Experience              \", \"                                                     |\\n|-----------|--------------------------------\", \"----------------------------------------------|\\n| Netflix   | Has 600+ services in production. Deplo\", \"ys 100 times per day.                  |\\n| Uber      | Has 1,000+ services in production. Deploys se\", \"veral thousand times each week. |\\n\\nMicro services\\n\\nModern\\n\\nDesign\\n\\n| Company   | Experience         \", \"                                           |\\n|-----------|------------------------------------------\", \"---------------------|\\n| WeChat    | Has 3,000+ services in production. Deploys 1,000 times a day. |\", \"\\n\\nBacking\\n\\nAutomation\\n\\nAs you can see, Netflix, Uber, and, WeChat expose cloud-native systems that c\", \"onsist of many independent services. This architectural style enables them to rapidly respond to mar\", \"ket conditions. They instantaneously update small areas of a live, complex application, without a fu\", \"ll redeployment. They individually scale services as needed.\\n\\n## The pillars of cloud native\\n\\nThe sp\", \"eed and agility of cloud native derive from many factors. Foremost is cloud infrastructure . But the\", \"re's more: Five other foundational pillars shown in Figure 1 -3 also provide the bedrock for cloudna\", \"tive systems.\\n\\nFigure 1-3. Cloud-native foundational pillars\\n\\n<!-- image -->\\n\\nLet's take some time t\", \"o better understand the significance of each pillar.\\n\\n## The cloud\\n\\nCloud-native systems take full a\", \"dvantage of the cloud service model.\\n\\nDesigned to thrive in a dynamic, virtualized cloud environment\", \", these systems make extensive use of Platform as a Service (PaaS) compute infrastructure and manage\", \"d services. They treat the underlying infrastructure as disposable - provisioned in minutes and resi\", \"zed, scaled, or destroyed on demand -via automation.\\n\\nConsider the widely accepted DevOps concept of\", \" Pets vs. Cattle. In a traditional data center, servers are treated as Pets : a physical machine, gi\", \"ven a meaningful name, and cared for. You scale by adding more resources to the same machine (scalin\", \"g up). If the server becomes sick, you nurse it back to health. Should the server become unavailable\", \", everyone notices.\\n\\nThe Cattle service model is different. You provision each instance as a virtual\", \" machine or container. They're identical and assigned a system identifier such as Service -01, Servi\", \"ce-02, and so on. You scale by creating more of them (scaling out). When one becomes unavailable, no\", \"body notices.\\n\\nContainers\\n\\nThe cattle model embraces immutable infrastructure . Servers aren't repai\", \"red or modified. If one fails or requires updating, it's destroyed and a new one is provisioned all \", \"done via automation.\\n\\nCloud-native systems embrace the Cattle service model. They continue to run as\", \" the infrastructure scales in or out with no regard to the machines upon which they're running.\\n\\nThe\", \" Azure cloud platform supports this type of highly elastic infrastructure with automatic scaling, se\", \"lf-healing, and monitoring capabilities.\\n\\n## Modern design\\n\\nHow would you design a cloud-native app?\", \" What would your architecture look like? To what principles, patterns, and best practices would you \", \"adhere? What infrastructure and operational concerns would be important?\\n\\n## The Twelve-Factor Appli\", \"cation\\n\\nA widely accepted methodology for constructing cloud-based applications is the Twelve-Factor\", \" Application. It describes a set of principles and practices that developers follow to construct app\", \"lications optimized for modern cloud environments. Special attention is given to portability across \", \"environments and declarative automation.\\n\\nWhile applicable to any web-based application, many practi\", \"tioners consider Twelve-Factor a solid foundation for building cloud-native apps. Systems built upon\", \" these principles can deploy and scale rapidly and add features to react quickly to market changes.\\n\", \"\\nThe following table highlights the Twelve-Factor methodology:\\n\\n| Factor               | Explanation\", \"                                                                                                    \", \"                                                                                                    \", \"                    |\\n|----------------------|------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"------------------------------------------------------------------------------|\\n| 1 - Code Base     \", \"   | A single code base for each microservice, stored in its own repository. Tracked with version co\", \"ntrol, it can deploy to multiple environments (QA, Staging, Production).                            \", \"                                    |\\n| 2 - Dependencies     | Each microservice isolates and packag\", \"es its own dependencies, embracing changes without impacting the entire system.                     \", \"                                                                                              |\\n| 3 \", \"- Configurations   | Configuration information is moved out of the microservice and externalized thr\", \"ough a configuration management tool outside of the code. The same deployment can propagate across e\", \"nvironments with the correct configuration applied. |\\n| 4 - Backing Services | Ancillary resources (\", \"data stores, caches, message brokers) should be exposed via an addressable URL. Doing so decouples t\", \"he resource from the application, enabling it to be interchangeable.                                \", \"          |\\n\\n| Factor                  | Explanation                                                \", \"                                                                                                    \", \"                                                                                                    \", \"                                |\\n|-------------------------|---------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"-----------------------------------------------------|\\n| 5 - Build, Release, Run | Each release must\", \" enforce a strict separation across the build, release, and run stages. Each should be tagged with a\", \" unique ID and support the ability to roll back. Modern CI/CD systems help fulfill this principle.  \", \"                                                                          |\\n| 6 - Processes         \", \"  | Each microservice should execute in its own process, isolated from other running services. Exter\", \"nalize required state to a backing service such as a distributed cache or data store.               \", \"                                                                                               |\\n| 7\", \" - Port Binding        | Each microservice should be self-contained with its interfaces and function\", \"ality exposed on its own port. Doing so provides isolation from other microservices.                \", \"                                                                                                    \", \"                |\\n| 8 - Concurrency         | When capacity needs to increase, scale out services ho\", \"rizontally across multiple identical processes (copies) as opposed to scaling-up a single large inst\", \"ance on the most powerful machine available. Develop the application to be concurrent making scaling\", \" out in cloud environments seamless. |\\n| 9 - Disposability       | Service instances should be dispo\", \"sable. Favor fast startup to increase scalability opportunities and graceful shutdowns to leave the \", \"system in a correct state. Docker containers along with an orchestrator inherently satisfy this requ\", \"irement.                                                  |\\n| 10 - Dev/Prod Parity    | Keep environ\", \"ments across the application lifecycle as similar as possible, avoiding costly shortcuts. Here, the \", \"adoption of containers can greatly contribute by promoting the same execution environment.          \", \"                                                                               |\\n| 11 - Logging     \", \"       | Treat logs generated by microservices as event streams. Process them with an event aggregat\", \"or. Propagate log data to data- mining/log management tools like Azure Monitor or Splunk and eventua\", \"lly to long-term archival.                                                                          \", \"|\\n| 12 - Admin Processes    | Run administrative/management tasks, such as data cleanup or computing\", \" analytics, as one-off processes. Use independent tools to invoke these tasks from the production en\", \"vironment, but separately from the application.                                                     \", \"                     |\\n\\nIn the book, Beyond the Twelve-Factor App, author Kevin Hoffman details each\", \" of the original 12 factors (written in 2011). Additionally, he discusses three extra factors that r\", \"eflect today's modern cloud application design.\\n\\n| New Factor                         | Explanation \", \"                                                                                                    \", \"                                                                                                  |\\n\", \"|------------------------------------|--------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"-------------------------------------------------|\\n| 13 - API First                     | Make every\", \"thing a service. Assume your code will be consumed by a front-end client, gateway, or another servic\", \"e.                                                                                                  \", \"|\\n| 14 - Telemetry                     | On a workstation, you have deep visibility into your applic\", \"ation and its behavior. In the cloud, you don't. Make sure your design includes the collection of mo\", \"nitoring, domain-specific, and health/system data. |\\n| 15 - Authentication/ Authorization | Implemen\", \"t identity from the start. Consider RBAC (role-based access control) features available in public cl\", \"ouds.                                                                                               \", \"  |\\n\\nWe'll refer to many of the 12+ factors in this chapter and throughout the book.\\n\\n## Azure Well-\", \"Architected Framework\\n\\nDesigning and deploying cloud-based workloads can be challenging, especially \", \"when implementing cloud-native architecture. Microsoft provides industry standard best practices to \", \"help you and your team deliver robust cloud solutions.\\n\\nThe Microsoft Well-Architected Framework pro\", \"vides a set of guiding tenets that can be used to improve the quality of a cloud-native workload. Th\", \"e framework consists of five pillars of architecture excellence:\\n\\n| Tenets                 | Descrip\", \"tion                                                                                                \", \"                                                                                                    \", \"                                                          |\\n|------------------------|--------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------|\\n| Cost management        | Focus on generating\", \" incremental value early. Apply Build-Measure-Learn principles to accelerate time to market while av\", \"oiding capital-intensive solutions. Using a pay-as-you- go strategy, invest as you scale out, rather\", \" than delivering a large investment up front. |\\n| Operational excellence | Automate the environment \", \"and operations to increase speed and reduce human error. Roll problem updates back or forward quickl\", \"y. Implement monitoring and diagnostics from the start.                                             \", \"                                        |\\n| Performance efficiency | Efficiently meet demands placed\", \" on your workloads. Favor horizontal scaling (scaling out) and design it into your systems. Continua\", \"lly conduct performance and load testing to identify potential bottlenecks.                         \", \"                                  |\\n\\n| Tenets      | Description                                    \", \"                                                                                                    \", \"                                                                                                    \", \"               |\\n|-------------|--------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"-----------------------------------------------------------------------------------------------|\\n| R\", \"eliability | Build workloads that are both resilient and available. Resiliency enables workloads to \", \"recover from failures and continue functioning. Availability ensures users access to your workload a\", \"t all times. Design applications to expect failures and recover from them. |\\n| Security    | Impleme\", \"nt security across the entire lifecycle of an application, from design and implementation to deploym\", \"ent and operations. Pay close attention to identity management, infrastructure access, application s\", \"ecurity, and data sovereignty and encryption.          |\\n\\nTo get started, Microsoft provides a set o\", \"f online assessments to help you assess your current cloud workloads against the five well-architect\", \"ed pillars.\\n\\n## Microservices\\n\\nCloud-native systems embrace microservices, a popular architectural s\", \"tyle for constructing modern applications.\\n\\nBuilt as a distributed set of small, independent service\", \"s that interact through a shared fabric, microservices share the following characteristics:\\n\\n- Each \", \"implements a specific business capability within a larger domain context.\\n- Each is developed autono\", \"mously and can be deployed independently.\\n- Each is self-contained encapsulating its own data storag\", \"e technology, dependencies, and programming platform.\\n- Each runs in its own process and communicate\", \"s with others using standard communication protocols such as HTTP/HTTPS, gRPC, WebSockets, or AMQP.\\n\", \"- They compose together to form an application.\\n\\nFigure 1-4 contrasts a monolithic application appro\", \"ach with a microservices approach. Note how the monolith is composed of a layered architecture, whic\", \"h executes in a single process. It typically consumes a relational database. The microservice approa\", \"ch, however, segregates functionality into independent services, each with its own logic, state, and\", \" data. Each microservice hosts its own datastore.\\n\\nWeb Tier\\n\\nServices Tier\\n\\nData Tier\\n\\nMonolithic Ap\", \"proach\\n\\nMobile apps\\n\\nMicroservice\\n\\nMicroservices Approach\\n\\nFigure 1-4. Monolithic versus microservic\", \"es architecture\\n\\n<!-- image -->\\n\\nNote how microservices promote the Processes principle from the Twe\", \"lve-Factor Application, discussed earlier in the chapter.\\n\\nFactor #6 specifies 'Each microservice sh\", \"ould execute in its own process, isolated from other running services.'\\n\\n## Why microservices?\\n\\nMicr\", \"oservices provide agility.\\n\\nEarlier in the chapter, we compared an eCommerce application built as a \", \"monolith to that with microservices. In the example, we saw some clear benefits:\\n\\n- Each microservic\", \"e has an autonomous lifecycle and can evolve independently and deploy frequently. You don't have to \", \"wait for a quarterly release to deploy a new feature or update. You can update a small area of a liv\", \"e application with less risk of disrupting the entire system. The update can be made without a full \", \"redeployment of the application.\\n- Each microservice can scale independently. Instead of scaling the\", \" entire application as a single unit, you scale out only those services that require more processing\", \" power to meet desired performance levels and service-level agreements. Fine-grained scaling provide\", \"s for greater control of your system and helps reduce overall costs as you scale portions of your sy\", \"stem, not everything.\\n\\nAn excellent reference guide for understanding microservices is .NET Microser\", \"vices: Architecture for Containerized .NET Applications . The book deep dives into microservices des\", \"ign and architecture. It's a companion for a full-stack microservice reference architecture availabl\", \"e as a free download from Microsoft.\\n\\n## Developing microservices\\n\\nMicroservices can be created upon\", \" any modern development platform.\\n\\nWeb Apps\\n\\n<!-- image -->\\n\\nThe Microsoft .NET platform is an excel\", \"lent choice. Free and open source, it has many built-in features that simplify microservice developm\", \"ent. .NET is cross-platform. Applications can be built and run on Windows, macOS, and most flavors o\", \"f Linux.\\n\\n.NET is highly performant and has scored well in comparison to Node.js and other competing\", \" platforms. Interestingly, TechEmpower conducted an extensive set of performance benchmarks across m\", \"any web application platforms and frameworks. .NET scored in the top 10 - well above Node.js and oth\", \"er competing platforms.\\n\\n.NET is maintained by Microsoft and the .NET community on GitHub.\\n\\n## Micro\", \"service challenges\\n\\nWhile distributed cloud-native microservices can provide immense agility and spe\", \"ed, they present many challenges:\\n\\n## Communication\\n\\nHow will front-end client applications communic\", \"ate with backed-end core microservices? Will you allow direct communication? Or, might you abstract \", \"the back-end microservices with a gateway facade that provides flexibility, control, and security?\\n\\n\", \"How will back-end core microservices communicate with each other? Will you allow direct HTTP calls t\", \"hat can increase coupling and impact performance and agility? Or might you consider decoupled messag\", \"ing with queue and topic technologies?\\n\\nCommunication is covered in the Cloud-native communication p\", \"atterns chapter.\\n\\n## Resiliency\\n\\nA microservices architecture moves your system from in-process to o\", \"ut-of-process network communication. In a distributed architecture, what happens when Service B isn'\", \"t responding to a network call from Service A? Or, what happens when Service C becomes temporarily u\", \"navailable and other services calling it become blocked?\\n\\nResiliency is covered in the Cloud-native \", \"resiliency chapter.\\n\\n## Distributed Data\\n\\nBy design, each microservice encapsulates its own data, ex\", \"posing operations via its public interface. If so, how do you query data or implement a transaction \", \"across multiple services?\\n\\nDistributed data is covered in the Cloud-native data patterns chapter.\\n\\n#\", \"# Secrets\\n\\nHow will your microservices securely store and manage secrets and sensitive configuration\", \" data?\\n\\nSecrets are covered in detail Cloud-native security.\\n\\n* Appand dapr\\n\\nruntime\\n\\n*Components\\n\\n*\", \" Hosting platform runtime\\n\\nAny code or framework...\\n\\nApplication code\\n\\nMicroservices written in\\n\\n= G\", \"O\\n\\nnodeo\\n\\n\\u00bf python\\n\\n## Manage Complexity with Dapr\\n\\ngRPC API\\n\\nDapr is a distributed, open-source app\", \"lication runtime. Through an architecture of pluggable components, it dramatically simplifies the pl\", \"umbing behind distributed applications. It provides a dynamic glue that binds your application with \", \"pre-built infrastructure capabilities and components from the Dapr runtime. Figure 1-5 shows Dapr fr\", \"om 20,000 feet.\\n\\nFigure 1-5. Dapr at 20,000 feet.\\n\\n<!-- image -->\\n\\nIn the top row of the figure, not\", \"e how Dapr provides language-specific SDKs for popular development platforms. Dapr v1 includes suppo\", \"rt for .NET, Go, Node.js, Python, PHP, Java, and JavaScript.\\n\\nWhile language-specific SDKs enhance t\", \"he developer experience, Dapr is platform agnostic. Under the hood, Dapr's programming model exposes\", \" capabilities through standard HTTP/gRPC communication protocols. Any programming platform can call \", \"Dapr via its native HTTP and gRPC APIs.\\n\\nThe blue boxes across the center of the figure represent th\", \"e Dapr building blocks. Each exposes prebuilt plumbing code for a distributed application capability\", \" that your application can consume.\\n\\nThe components row represents a large set of pre-defined infras\", \"tructure components that your application can consume. Think of components as infrastructure code yo\", \"u don't have to write.\\n\\nThe bottom row highlights the portability of Dapr and the diverse environmen\", \"ts across which it can run.\\n\\nMicrosoft features a free ebook Dapr for .NET Developers for learning D\", \"apr.\\n\\nLooking ahead, Dapr has the potential to have a profound impact on cloud-native application de\", \"velopment.\\n\\n## Containers\\n\\nIt's natural to hear the term container mentioned in any cloud native con\", \"versation. In the book, Cloud Native Patterns , author Cornelia Davis observes that, 'Containers are\", \" a great enabler of cloud -native\\n\\n.NET\\n\\n\\u203a \\u203a Java\\n\\nContainer\\n\\nProduct:1.0\\n\\nLib-L\\n\\nContainer\\n\\nBasket:\", \"2.0\\n\\nContainer\\n\\nProduct:2.0\\n\\nsoftware.' The Cloud Native Computing Foundation places microservice co\", \"ntainerization as the first step in their Cloud-Native Trail Map - guidance for enterprises beginnin\", \"g their cloud-native journey.\\n\\nContainerizing a microservice is simple and straightforward. The code\", \", its dependencies, and runtime are packaged into a binary called a container image. Images are stor\", \"ed in a container registry, which acts as a repository or library for images. A registry can be loca\", \"ted on your development computer, in your data center, or in a public cloud. Docker itself maintains\", \" a public registry via Docker Hub. The Azure cloud features a private container registry to store co\", \"ntainer images close to the cloud applications that will run them. Docker\\n\\nRuntime\\n\\nWhen an applicat\", \"ion starts or scales, you transform the container image into a running container instance. The insta\", \"nce runs on any computer that has a container runtime engine installed. You can have as many instanc\", \"es of the containerized service as needed.\\n\\nFigure 1-6 shows three different microservices, each in \", \"its own container, all running on a single host.\\n\\nFigure 1-6. Multiple containers running on a conta\", \"iner host\\n\\n<!-- image -->\\n\\nNote how each container maintains its own set of dependencies and runtime\", \", which can be different from one another. Here, we see different versions of the Product microservi\", \"ce running on the same host. Each container shares a slice of the underlying host operating system, \", \"memory, and processor, but is isolated from one another.\\n\\nNote how well the container model embraces\", \" the Dependencies principle from the Twelve-Factor Application.\\n\\nFactor #2 specifies that 'Each micr\", \"oservice isolates and packages its own dependencies, embracing changes without impacting the entire \", \"system.'\\n\\nContainers support both Linux and Windows workloads. The Azure cloud openly embraces both.\", \" Interestingly, it's Linux, not Windows Server, that has become the more popular operating system in\", \" Azure.\\n\\nScheduling\\n\\nFailover\\n\\nAffinity/anti-affinity\\n\\nHealth monitoring\\n\\nScaling\\n\\nWhile several con\", \"tainer vendors exist, Docker has captured the lion's share of the market. The company has been drivi\", \"ng the software container movement. It has become the de facto standard for packaging, deploying, an\", \"d running cloud-native applications.\\n\\nNetworking\\n\\n## Why containers?\\n\\nContainers provide portability\", \" and guarantee consistency across environments. By encapsulating everything into a single package, y\", \"ou isolate the microservice and its dependencies from the underlying infrastructure.\\n\\nYou can deploy\", \" the container in any environment that hosts the Docker runtime engine. Containerized workloads also\", \" eliminate the expense of pre-configuring each environment with frameworks, software libraries, and \", \"runtime engines.\\n\\nBy sharing the underlying operating system and host resources, a container has a m\", \"uch smaller footprint than a full virtual machine. The smaller size increases the density , or numbe\", \"r of microservices, that a given host can run at one time.\\n\\n## Container orchestration\\n\\nWhile tools \", \"such as Docker create images and run containers, you also need tools to manage them. Container manag\", \"ement is done with a special software program called a container orchestrator . When operating at sc\", \"ale with many independent running containers, orchestration is essential.\\n\\nFigure 1-7 shows manageme\", \"nt tasks that container orchestrators automate.\\n\\nFigure 1-7. What container orchestrators do\\n\\n<!-- i\", \"mage -->\\n\\nThe following table describes common orchestration tasks.\\n\\n| Tasks                  | Expl\", \"anation                                                                                     |\\n|-----\", \"-------------------|--------------------------------------------------------------------------------\", \"-----------------|\\n| Scheduling             | Automatically provision container instances.          \", \"                                          |\\n| Affinity/anti-affinity | Provision containers nearby o\", \"r far apart from each other, helping availability and performance. |\\n| Health monitoring      | Auto\", \"matically detect and correct failures.                                                      |\\n| Fail\", \"over               | Automatically reprovision a failed instance to a healthy machine.              \", \"                 |\\n\\nService discovery\\n\\nRolling upgrades\\n\\n| Tasks             | Explanation          \", \"                                                                                       |\\n|----------\", \"---------|------------------------------------------------------------------------------------------\", \"-------------------|\\n| Scaling           | Automatically add or remove a container instance to meet \", \"demand.                                            |\\n| Networking        | Manage a networking overl\", \"ay for container communication.                                                    |\\n| Service Disco\", \"very | Enable containers to locate each other.                                                      \", \"               |\\n| Rolling Upgrades  | Coordinate incremental upgrades with zero downtime deployment\", \". Automatically roll back problematic changes. |\\n\\nNote how container orchestrators embrace the Dispo\", \"sability and Concurrency principles from the Twelve-Factor Application.\\n\\nFactor #9 specifies that 'S\", \"ervice instances should be disposable, favoring fast startups to increase scalability opportunities \", \"and graceful shutdowns to leave the system in a correct state.' Docker containers along with an orch\", \"estrator inherently satisfy this requirement.'\\n\\nFactor #8 specifies that 'Services scale out across \", \"a large number of small identical processes (copies) as opposed to scalingup a single large instance\", \" on the most powerful machine available.'\\n\\nWhile several container orchestrators exist, Kubernetes h\", \"as become the de facto standard for the cloudnative world. It's a portable, extensible, open -source\", \" platform for managing containerized workloads.\\n\\nYou could host your own instance of Kubernetes, but\", \" then you'd be responsible for provisioning and managing its resources - which can be complex. The A\", \"zure cloud features Kubernetes as a managed service. Both Azure Kubernetes Service (AKS) and Azure R\", \"ed Hat OpenShift (ARO) enable you to fully leverage the features and power of Kubernetes as a manage\", \"d service, without having to install and maintain it.\\n\\nContainer orchestration is covered in detail \", \"in Scaling Cloud-Native Applications.\\n\\n## Backing services\\n\\nCloud-native systems depend upon many di\", \"fferent ancillary resources, such as data stores, message brokers, monitoring, and identity services\", \". These services are known as backing services.\\n\\nFigure 1-8 shows many common backing services that \", \"cloud-native systems consume.\\n\\nStorage\\n\\nServices\\n\\nStreaming\\n\\nServices\\n\\nMonitoring\\n\\n&lt; - -\\n\\nSecurit\", \"y\\n\\nServices\\n\\nFigure 1-8. Common backing services\\n\\n<!-- image -->\\n\\nYou could host your own backing se\", \"rvices, but then you'd be responsible for licensing, provisioning, and managing those resources.\\n\\nCl\", \"oud providers offer a rich assortment of managed backing services. Instead of owning the service, yo\", \"u simply consume it. The cloud provider operates the resource at scale and bears the responsibility \", \"for performance, security, and maintenance. Monitoring, redundancy, and availability are built into \", \"the service. Providers guarantee service level performance and fully support their managed services \", \"open a ticket and they fix your issue.\\n\\nCloud-native systems favor managed backing services from clo\", \"ud vendors. The savings in time and labor can be significant. The operational risk of hosting your o\", \"wn and experiencing trouble can get expensive fast.\\n\\nA best practice is to treat a backing service a\", \"s an attached resource , dynamically bound to a microservice with configuration information (a URL a\", \"nd credentials) stored in an external configuration. This guidance is spelled out in the Twelve-Fact\", \"or Application, discussed earlier in the chapter.\\n\\nFactor #4 specifies that backing services 'should\", \" be exposed via an addressable URL. Doing so decouples the resource from the application, enabling i\", \"t to be interchangeable.'\\n\\nFactor #3 specifies that 'Configuration information is moved out of the m\", \"icroservice and externalized through a configuration management tool outside of the code.'\\n\\nWith thi\", \"s pattern, a backing service can be attached and detached without code changes. You might promote a \", \"microservice from QA to a staging environment. You update the microservice configuration to point to\", \" the backing services in staging and inject the settings into your container through an environment \", \"variable.\\n\\nBacking\\n\\nServices\\n\\nCloud vendors provide APIs for you to communicate with their proprieta\", \"ry backing services. These libraries encapsulate the proprietary plumbing and complexity. However, c\", \"ommunicating directly with these APIs will tightly couple your code to that specific b acking servic\", \"e. It's a widely accepted practice to insulate the implementation details of the vendor API. Introdu\", \"ce an intermediation layer, or intermediate API, exposing generic operations to your service code an\", \"d wrap the vendor code inside it. This loose coupling enables you to swap out one backing service fo\", \"r another or move your code to a different cloud environment without having to make changes to the m\", \"ainline service code. Dapr, discussed earlier, follows this model with its set of prebuilt building \", \"blocks.\\n\\nOn a final thought, backing services also promote the Statelessness principle from the Twel\", \"ve-Factor Application, discussed earlier in the chapter.\\n\\nFactor #6 specifies that, 'Each microservi\", \"ce should execute in its own process, isolated from other running services. Externalize required sta\", \"te to a backing service such as a distributed cache or data store.'\\n\\nBacking services are discussed \", \"in Cloud-native data patterns and Cloud-native communication patterns.\\n\\n## Automation\\n\\nAs you've see\", \"n, cloud -native systems embrace microservices, containers, and modern system design to achieve spee\", \"d and agility. But, that's only part of the story. How do you provision the cloud environments upon \", \"which these systems run? How do you rapidly deploy app features and updates? How do you round out th\", \"e full picture?\\n\\nEnter the widely accepted practice of Infrastructure as Code, or IaC.\\n\\nWith IaC, yo\", \"u automate platform provisioning and application deployment. You essentially apply software engineer\", \"ing practices such as testing and versioning to your DevOps practices. Your infrastructure and deplo\", \"yments are automated, consistent, and repeatable.\\n\\n## Automating infrastructure\\n\\nTools like Azure Re\", \"source Manager, Azure Bicep, Terraform from HashiCorp, and the Azure CLI, enable you to declarativel\", \"y script the cloud infrastructure you require. Resource names, locations, capacities, and secrets ar\", \"e parameterized and dynamic. The script is versioned and checked into source control as an artifact \", \"of your project. You invoke the script to provision a consistent and repeatable infrastructure acros\", \"s system environments, such as QA, staging, and production.\\n\\nUnder the hood, IaC is idempotent, mean\", \"ing that you can run the same script over and over without side effects. If the team needs to make a\", \" change, they edit and rerun the script. Only the updated resources are affected.\\n\\nIn the article, W\", \"hat is Infrastructure as Code , Author Sam Guckenheimer describes how, 'Teams who implement IaC can \", \"deliver stable environments rapidly and at scale. They avoid manual configuration of environments an\", \"d enforce consistency by representing the desired state of their environments via code. Infrastructu\", \"re deployments with IaC are repeatable and prevent runtime issues caused by configuration drift or m\", \"issing dependencies. DevOps teams can work together with a unified set of\\n\\n2\\n\\nApplication code repo\\n\", \"\\n(SCC)\\n\\n3\\n\\nBuild, CI, integrate, test\\n\\nCD, deploy practices and tools to deliver applications and th\", \"eir supporting infrastructure rapidly, reliably, and at scale.'\\n\\n## Automating deployments\\n\\nPush\\n\\n1\\n\", \"\\nThe Twelve-Factor Application, discussed earlier, calls for separate steps when transforming comple\", \"ted code into a running application.\\n\\nInner loop run,\\n\\nFactor #5 specifies that 'Each release must e\", \"nforce a strict separation across the build, release and run stages. Each should be tagged with a un\", \"ique ID and support the ability to roll back.'\\n\\ndebug\\n\\nModern CI/CD systems help fulfill this princi\", \"ple. They provide separate build and delivery steps that help ensure consistent and quality code tha\", \"t's readily available to users.\\n\\nFigure 1-9 shows the separation across the deployment process.\\n\\nFig\", \"ure 1-9. Deployment steps in a CI/CD Pipeline\\n\\n<!-- image -->\\n\\nIn the previous figure, pay special a\", \"ttention to separation of tasks:\\n\\n1. The developer constructs a feature in their development environ\", \"ment, iterating through what is called the 'inner loop' of code, run, and debug.\\n2. When complete, t\", \"hat code is pushed into a code repository, such as GitHub, Azure DevOps, or BitBucket.\\n3. The push t\", \"riggers a build stage that transforms the code into a binary artifact. The work is implemented with \", \"a Continuous Integration (CI) pipeline. It automatically builds, tests, and packages the application\", \".\\n4. The release stage picks up the binary artifact, applies external application and environment co\", \"nfiguration information, and produces an immutable release. The release is deployed to a specified e\", \"nvironment. The work is implemented with a Continuous Delivery (CD) pipeline. Each release should be\", \" identifiable. You can say, 'This deployment is running Release 2.1.1 of the application.'\\n\\n5\\n\\nRun\\n\\n\", \"5. Finally, the released feature is run in the target execution environment. Releases are immutable \", \"meaning that any change must create a new release.\\n\\nApplying these practices, organizations have rad\", \"ically evolved how they ship software. Many have moved from quarterly releases to on-demand updates.\", \" The goal is to catch problems early in the development cycle when they're less expensive to fix. Th\", \"e longer the duration between integrations, the more expensive problems become to resolve. With cons\", \"istency in the integration process, teams can commit code changes more frequently, leading to better\", \" collaboration and software quality.\\n\\nInfrastructure as code and deployment automation, along with G\", \"itHub and Azure DevOps are discussed in detail in DevOps.\\n\\n## Candidate apps for cloud native\\n\\nThink\", \" about the apps your organization needs to build. Then, look at the existing apps in your portfolio.\", \" How many of them warrant a cloud-native architecture? All of them? Perhaps some?\\n\\nApplying cost/ben\", \"efit analysis, there's a good chance some wouldn't support the effort. The cost of becoming cloud na\", \"tive would far exceed the business value of the application.\\n\\nWhat type of application might be a ca\", \"ndidate for cloud native?\\n\\n- Strategic enterprise systems that need to constantly evolve business ca\", \"pabilities/features\\n- An application that requires a high release velocity - with high confidence\\n- \", \"A system where individual features must release without a full redeployment of the entire system\\n- A\", \"n application developed by teams with expertise in different technology stacks\\n- An application with\", \" components that must scale independently\\n\\nSmaller, less impactful line-of-business applications mig\", \"ht fare well with a simple monolithic architecture hosted in a Cloud PaaS environment.\\n\\nThen there a\", \"re legacy systems. While we'd all like to build new applications, we're often responsible for modern\", \"izing legacy workloads that are critical to the business.\\n\\n## Modernizing legacy apps\\n\\nThe free Micr\", \"osoft e-book Modernize existing .NET applications with Azure cloud and Windows Containers provides g\", \"uidance about migrating on-premises workloads into cloud. Figure 1-10 shows that there isn't a singl\", \"e, one -size-fits-all strategy for modernizing legacy applications.\\n\\nExisting\\n\\nNET Framework\\n\\nThe Jo\", \"urney to the Cloud\\n\\nMigrate apps &amp; services Rehost , Infrastructure-\\n\\non-premises\\n\\nOn-Premises\\n\\n\", \"Infrastructure Plotform\\n\\nFigure 1-10. Strategies for migrating legacy workloads\\n\\n<!-- image -->\\n\\nMon\", \"olithic apps that are non-critical might benefit from a quick lift-and-shift (Cloud InfrastructureRe\", \"ady) migration. Here, the on-premises workload is rehosted to a cloud-based VM, without changes. Thi\", \"s approach uses the IaaS (Infrastructure as a Service) model. Azure includes several tools such as A\", \"zure Migrate, Azure Site Recovery, and Azure Database Migration Service to help streamline the move.\", \" While this strategy can yield some cost savings, such applications typically weren't designed to un\", \"lock and leverage the benefits of cloud computing.\\n\\nLegacy apps that are critical to the business of\", \"ten benefit from an enhanced Cloud Optimized migration. This approach includes deployment optimizati\", \"ons that enable key cloud services - without changing the core architecture of the application. For \", \"example, you might containerize the application and deploy it to a container orchestrator, like Azur\", \"e Kubernetes Services, discussed later in this book. Once in the cloud, the application can consume \", \"cloud backing services such as databases, message queues, monitoring, and distributed caching.\\n\\nFina\", \"lly, monolithic apps that provide strategic enterprise functions might best benefit from a CloudNati\", \"ve approach, the subject of this book. This approach provides agility and velocity. But, it comes at\", \" a cost of replatforming, rearchitecting, and rewriting code. Over time, a legacy application could \", \"be decomposed into microservices, containerized, and ultimately replatformed into a cloud-native arc\", \"hitecture.\\n\\nIf you and your team believe a cloud-native approach is appropriate, it behooves you to \", \"rationalize the decision with your organization. What exactly is the business problem that a cloud-n\", \"ative approach will solve? How would it align with business needs?\\n\\n- Rapid releases of features wit\", \"h increased confidence?\\n- Fine-grained scalability - more efficient usage of resources?\\n\\nModernize\\n\\n\", \"- Improved system resiliency?\\n- Improved system performance?\\n- More visibility into operations?\\n- Bl\", \"end development platforms and data stores to arrive at the best tool for the job?\\n- Future-proof app\", \"lication investment?\\n\\nThe right migration strategy depends on organizational priorities and the syst\", \"ems you're targeting. For many, it may be more cost effective to cloud-optimize a monolithic applica\", \"tion or add coarsegrained services to an N-Tier app. In these cases, you can still make full use of \", \"cloud PaaS capabilities like the ones offered by Azure App Service.\\n\\n## Summary\\n\\nIn this chapter, we\", \" introduced cloud-native computing. We provided a definition along with the key capabilities that dr\", \"ive a cloud-native application. We looked at the types of applications that might justify this inves\", \"tment and effort.\\n\\nWith the introduction behind, we now dive into a much more detailed look at cloud\", \" native.\\n\\n## References\\n\\n- Cloud Native Computing Foundation\\n- .NET Microservices: Architecture for \", \"Containerized .NET applications\\n- Microsoft Azure Well-Architected Framework\\n- Modernize existing .N\", \"ET applications with Azure cloud and Windows Containers\\n- Cloud Native Patterns by Cornelia Davis\\n- \", \"Cloud native applications: Ship faster, reduce risk, and grow your business\\n- Dapr for .NET Develope\", \"rs\\n- Dapr documents\\n- Beyond the Twelve-Factor Application\\n- What is Infrastructure as Code\\n- Uber E\", \"ngineering's Micro Deploy: Deploying Daily with Confidence\\n- How Netflix Deploys Code\\n- Overload Con\", \"trol for Scaling WeChat Microservices\\n\\n+\\n\\nNot secure host.docker.internal:5104/catalog\\n\\n[eShop]\\n\\non \", \"containers\\n\\nBrand\\n\\nAll eShopOnContainers - SPA\\n\\n.NET\\n\\n## Introducing eShopOnContainers reference app\", \" On sale this weekend TS Showing 12 of 14 products - Page 1 - 2 Next\\n\\n.NET\\n\\nONET\\n\\nMicrosoft, in part\", \"nership with leading community experts, has produced a full-featured cloud-native microservices refe\", \"rence application, eShopOnContainers. This application is built to showcase using .NET and Docker, a\", \"nd optionally Azure, Kubernetes, and Visual Studio, to build an online storefront.\\n\\nFigure 2-1. eSho\", \"pOnContainers Sample App Screenshot.\\n\\n<!-- image -->\\n\\nLOGIN\\n\\nBefore starting this chapter, we recomm\", \"end that you download the eShopOnContainers reference application. If you do so, it should be easier\", \" for you to follow along with the information presented.\\n\\n## Features and requirements\\n\\nLet's start \", \"with a review of the application's features and requirements. The eShopOnContainers application repr\", \"esents an online store that sells various physical products like t-shirts and coffee mugs. If you've\", \" bought anything online before, the experience of using the store should be r elatively familiar. He\", \"re are some of the basic features the store implements:\\n\\n- List catalog items\\n- Filter items by type\", \"\\n- Filter items by brand\\n- Add items to the shopping basket\\n- Edit or remove items from the basket\\n-\", \" Checkout\\n- Register an account\\n- Sign in\\n- Sign out\\n- Review orders\\n\\nThe application also has the f\", \"ollowing non-functional requirements:\\n\\n- It needs to be highly available and it must scale automatic\", \"ally to meet increased traffic (and scale back down once traffic subsides).\\n- It should provide easy\", \"-to-use monitoring of its health and diagnostic logs to help troubleshoot any issues it encounters.\\n\", \"- It should support an agile development process, including support for continuous integration and d\", \"eployment (CI/CD).\\n- In addition to the two web front ends (traditional and Single Page Application)\", \", the application must also support mobile client apps running different kinds of operating systems.\", \"\\n- It should support cross-platform hosting and cross-platform development.\\n\\nClient apps eShop mobil\", \"e app\\n\\nXamarin.Forms\\n\\nC#\\n\\nxPlat. OS:\\n\\niOS\\n\\nAndroid\\n\\nWindows eShop traditional Web app\\n\\nK\\n\\neShop SPA \", \"Web app\\n\\nTypeScript/Angular 2\\n\\nIdentity microservice (STS+users)\\n\\nSQL Server database\\n\\nAPI Gateways/\", \"BFF Catalog microservice SQL Server\\n\\nFigure 2-2. eShopOnContainers reference application development\", \" architecture.\\n\\n<!-- image -->\\n\\nThe eShopOnContainers application is accessible from web or mobile c\", \"lients that access the application over HTTPS targeting either the ASP.NET Core MVC server applicati\", \"on or an appropriate API Gateway. API Gateways offer several advantages, such as decoupling back-end\", \" services from individual front-end clients and providing better security. The application also make\", \"s use of a related pattern known as Backends-for-Frontends (BFF), which recommends creating separate\", \" API gateways for each front-end client. The reference architecture demonstrates breaking up the API\", \" gateways based on whether the request is coming from a web or mobile client.\\n\\nThe application's fun\", \"ctionality is broken up into many distinct microservices. There are services responsible for authent\", \"ication and identity, listing items from the product catalog, managing users' shopping baskets, and \", \"placing orders. Each of these separate services has its own persistent storage. There's no single pr\", \"imary data store with which all services interact. Instead, coordination and communication between t\", \"he services is done on an as-needed basis and by using a message bus.\\n\\nEach of the different microse\", \"rvices is designed differently, based on their individual requirements. This aspect means their tech\", \"nology stack may differ, although they're all built using .NET and designed for the cloud. Simpler s\", \"ervices provide basic Create-Read-Update-Delete (CRUD) access to the underlying data stores, while m\", \"ore advanced services use Domain-Driven Design approaches and patterns to manage business complexity\", \".\\n\\neShopOnContainers reference application\\n\\n(Development environment architecture)\\n\\n-\\n\\n\\u2022 Docker Host\", \"\\n\\nDifferent types of microservices\\n\\nIdentity Microservice (STS+ Users)\\n\\nSQL Server\\n\\nWeb API\\n\\nContain\", \"er database\\n\\n/ Catalog Microservice\\n\\nWeb API\\n\\nContainer\\n\\nOrdering Microservice\\n\\nWeb API\\n\\nContainer\\n\\n\", \"/ Basket Microservice\\n\\nWeb APl\\n\\nContaine:\\n\\nFigure 2-3. Different kinds of microservices.\\n\\n<!-- image\", \" -->\\n\\n## Overview of the code\\n\\nBecause it uses microservices, the eShopOnContainers app includes qui\", \"te a few separate projects and solutions in its GitHub repository. In addition to separate solutions\", \" and executable files, the various services are designed to run inside their own containers, both du\", \"ring local development and at run time in production. Figure 2-4 shows the full Visual Studio soluti\", \"on, in which the various different projects are organized.\\n\\nASP.NET Core Identity\\n\\nExample using\\n\\n&a\", \"mp; Identity STS\\n\\nExample of a simple\\n\\nSolution Explorer\\n\\nSearch Solution Explorer (CtrI+:)\\n\\n\\u0432 Solut\", \"ion 'eShopOnContainers-ServicesAndWebApps' (31 of 31 projects)\\n\\n\\u2022 Solution Items\\n\\nD sc\\n\\nApiGateways\\n\", \"\\nBuildingBlocks\\n\\nServices\\n\\nWeb Apps\\n\\nP\\n\\n\\u2022 tests\\n\\n\\u2192 Service Tests docker-compose\\n\\nP-\\n\\n<!-- image -->\\n\", \"\\nFigure 2-4. Projects in Visual Studio solution.\\n\\nThe code is organized to support the different mic\", \"roservices, and within each microservice, the code is broken up into domain logic, infrastructure co\", \"ncerns, and user interface or service endpoint. In many cases, each service's dependencies can be fu\", \"lfilled by Azure services in production, and alternative options for local development. Let's examin\", \"e how the application's requirements map to Azure services.\\n\\n## Understanding microservices\\n\\nThis bo\", \"ok focuses on cloud-native applications built using Azure technology. To learn more about microservi\", \"ces best practices and how to architect microservice-based applications, read the companion book, .N\", \"ET Microservices: Architecture for Containerized .NET Applications.\\n\\n## Mapping eShopOnContainers to\", \" Azure Services\\n\\nAlthough not required, Azure is well-suited to supporting the eShopOnContainers bec\", \"ause the project was built to be a cloud-native application. The application is built with .NET, so \", \"it can run on Linux or Windows containers depending on the Docker host. The application is made up o\", \"f multiple autonomous microservices, each with its own data. The different microservices showcase di\", \"fferent approaches, ranging from simple CRUD operations to more complex DDD and CQRS patterns. Micro\", \"services communicate with clients over HTTP and with one another via message-based communication. Th\", \"e application supports multiple platforms for clients as well, since it adopts HTTP as a standard co\", \"mmunication protocol and includes ASP.NET Core and Xamarin mobile apps that run on Android, iOS, and\", \" Windows platforms.\\n\\nThe application's architecture is shown in Figure 2 -5. On the left are the cli\", \"ent apps, broken up into mobile, traditional Web, and Web Single Page Application (SPA) flavors. On \", \"the right are the serverside components that make up the system, each of which can be hosted in Dock\", \"er containers and Kubernetes clusters. The traditional web app is powered by the ASP.NET Core MVC ap\", \"plication shown in yellow. This app and the mobile and web SPA applications communicate with the ind\", \"ividual microservices through one or more API gateways. The API gateways follow the 'backends for fr\", \"ont ends' (BFF) pattern, meaning that each gateway is designed to support a given front -end client.\", \" The individual microservices are listed to the right of the API gateways and include both business \", \"logic and some kind of persistence store. The different services make use of SQL Server databases, R\", \"edis cache instances, and MongoDB/CosmosDB stores. On the far right is the system's Event Bus, which\", \" is used for communication between the microservices.\\n\\n- - \\u2014\\n\\nClient apps eShop mobile app\\n\\nXamarin.\", \"Forms\\n\\nC#\\n\\nxPlat. OS:\\n\\niOs\\n\\nAndroid\\n\\nWindows eShop traditional Web app\\n\\neShop SPA Web app\\n\\nTypeScrip\", \"t/Angular eShopOnContainers reference application\\n\\n(Development environment architecture)\\n\\n| Docker \", \"Host\\n\\nIdentity microservice (STS+users)\\n\\nSQL Server\\n\\n## database\\n\\nAPI Gateways / BFF Catalog microse\", \"rvice SQL Server\\n\\n\\u20220\\n\\ndatabase\\n\\nFigure 2-5. The eShopOnContainers Architecture.\\n\\n<!-- image -->\\n\\nThe\", \" server-side components of this architecture all map easily to Azure services.\\n\\n## Container orchest\", \"ration and clustering\\n\\nThe application's container -hosted services, from ASP.NET Core MVC apps to i\", \"ndividual Catalog and Ordering microservices, can be hosted and managed in Azure Kubernetes Service \", \"(AKS). The application can run locally on Docker and Kubernetes, and the same containers can then be\", \" deployed to staging and production environments hosted in AKS. This process can be automated as we'\", \"ll see in the next section.\\n\\nAKS provides management services for individual clusters of containers.\", \" The application will deploy separate containers for each microservice in the AKS cluster, as shown \", \"in the architecture diagram above. This approach allows each individual service to scale independent\", \"ly according to its resource demands. Each microservice can also be deployed independently, and idea\", \"lly such deployments should incur zero system downtime.\\n\\n## API Gateway\\n\\nThe eShopOnContainers appli\", \"cation has multiple front-end clients and multiple different back-end services. There's no one -to-o\", \"ne correspondence between the client applications and the microservices that support them. In such a\", \" scenario, there may be a great deal of complexity when writing client software to interface with th\", \"e various back-end services in a secure manner. Each client would need to address this complexity on\", \" its own, resulting in duplication and many places in which to make updates as services change or ne\", \"w policies are implemented.\\n\\nAzure API Management (APIM) helps organizations publish APIs in a consi\", \"stent, manageable fashion. APIM consists of three components: the API Gateway, and administration po\", \"rtal (the Azure portal), and a developer portal.\\n\\nRabbitMO\\n\\nThe API Gateway accepts API calls and ro\", \"utes them to the appropriate back-end API. It can also provide additional services like verification\", \" of API keys or JWT tokens and API transformation on the fly without code modifications (for instanc\", \"e, to accommodate clients expecting an older interface).\\n\\nThe Azure portal is where you define the A\", \"PI schema and package different APIs into products. You also configure user access, view reports, an\", \"d configure policies for quotas or transformations.\\n\\nThe developer portal serves as the main resourc\", \"e for developers. It provides developers with API documentation, an interactive test console, and re\", \"ports on their own usage. Developers also use the portal to create and manage their own accounts, in\", \"cluding subscription and API key support.\\n\\nUsing APIM, applications can expose several different gro\", \"ups of services, each providing a back end for a particular front-end client. APIM is recommended fo\", \"r complex scenarios. For simpler needs, the lightweight API Gateway Ocelot can be used. The eShopOnC\", \"ontainers app uses Ocelot because of its simplicity and because it can be deployed into the same app\", \"lication environment as the application itself. Learn more about eShopOnContainers, APIM, and Ocelot\", \".\\n\\nAnother option if your application is using AKS is to deploy the Azure Gateway Ingress Controller\", \" as a pod within your AKS cluster. This approach allows your cluster to integrate with an Azure Appl\", \"ication Gateway, allowing the gateway to load-balance traffic to the AKS pods. Learn more about the \", \"Azure Gateway Ingress Controller for AKS.\\n\\n## Data\\n\\nThe various back-end services used by eShopOnCon\", \"tainers have different storage requirements. Several microservices use SQL Server databases. The Bas\", \"ket microservice leverages a Redis cache for its persistence. The Locations microservice expects a M\", \"ongoDB API for its data. Azure supports each of these data formats.\\n\\nFor SQL Server database support\", \", Azure has products for everything from single databases up to highly scalable SQL Database elastic\", \" pools. Individual microservices can be configured to communicate with their own individual SQL Serv\", \"er databases quickly and easily. These databases can be scaled as needed to support each separate mi\", \"croservice according to its needs.\\n\\nThe eShopOnContainers application stores the user's current shop\", \"ping basket between requests. This aspect is managed by the Basket microservice that stores the data\", \" in a Redis cache. In development, this cache can be deployed in a container, while in production it\", \" can utilize Azure Cache for Redis. Azure Cache for Redis is a fully managed service offering high p\", \"erformance and reliability without the need to deploy and manage Redis instances or containers on yo\", \"ur own.\\n\\nThe Locations microservice uses a MongoDB NoSQL database for its persistence. During develo\", \"pment, the database can be deployed in its own container, while in production the service can levera\", \"ge Azure Cosmos DB's API for MongoDB . One of the benefits of Azure Cosmos DB is its ability to leve\", \"rage multiple different communication protocols, including a SQL API and common NoSQL APIs including\", \" MongoDB, Cassandra, Gremlin, and Azure Table Storage. Azure Cosmos DB offers a fully managed and gl\", \"obally distributed database as a service that can scale to meet the needs of the services that use i\", \"t.\\n\\nDistributed data in cloud-native applications is covered in more detail in chapter 5.\\n\\n## Event \", \"Bus\\n\\nThe application uses events to communicate changes between different services. This functionali\", \"ty can be implemented with various implementations, and locally the eShopOnContainers application us\", \"es RabbitMQ. When hosted in Azure, the application would leverage Azure Service Bus for its messagin\", \"g. Azure Service Bus is a fully managed integration message broker that allows applications and serv\", \"ices to communicate with one another in a decoupled, reliable, asynchronous manner. Azure Service Bu\", \"s supports individual queues as well as separate topics to support publisher-subscriber scenarios. T\", \"he eShopOnContainers application would leverage topics with Azure Service Bus to support distributin\", \"g messages from one microservice to any other microservice that needed to react to a given message.\\n\", \"\\n## Resiliency\\n\\nOnce deployed to production, the eShopOnContainers application would be able to take\", \" advantage of several Azure services available to improve its resiliency. The application publishes \", \"health checks, which can be integrated with Application Insights to prov ide reporting and alerts ba\", \"sed on the app's availability. Azure resources also provide diagnostic logs that can be used to iden\", \"tify and correct bugs and performance issues. Resource logs provide detailed information on when and\", \" how different Azure resource s are used by the application. You'll learn more about cloud -native r\", \"esiliency features in chapter 6.\\n\\n## Deploying eShopOnContainers to Azure\\n\\nThe eShopOnContainers app\", \"lication can be deployed to various Azure platforms. The recommended approach is to deploy the appli\", \"cation to Azure Kubernetes Services (AKS). Helm, a Kubernetes deployment tool, is available to reduc\", \"e deployment complexity. Optionally, developers may implement Azure Dev Spaces for Kubernetes to str\", \"eamline their development process.\\n\\n## Azure Kubernetes Service\\n\\nTo host eShop in AKS, the first ste\", \"p is to create an AKS cluster. To do so, you might use the Azure portal, which will walk you through\", \" the required steps. You could also create a cluster from the Azure CLI, taking care to enable Role-\", \"Based Access Control (RBAC) and application routing. The eShopOnContainers' documentation details th\", \"e steps for creating your own AKS cluster. Once created, you can access and manage the cluster from \", \"the Kubernetes dashboard.\\n\\nYou can now deploy the eShop application to the cluster using Helm.\\n\\n## D\", \"eploying to Azure Kubernetes Service using Helm\\n\\nHelm is an application package manager tool that wo\", \"rks directly with Kubernetes. It helps you define, install, and upgrade Kubernetes applications. Whi\", \"le simple apps can be deployed to AKS with custom CLI scripts or simple deployment files, complex ap\", \"ps can contain many Kubernetes objects and benefit from Helm.\\n\\nUsing Helm, applications include text\", \"-based configuration files, called Helm charts, which declaratively describe the application and con\", \"figuration in Helm packages. Charts use standard YAML-formatted\\n\\nfiles to describe a related set of \", \"Kubernetes resources. They're versioned alongside the application code they describe. Helm Charts ra\", \"nge from simple to complex depending on the requirements of the installation they describe.\\n\\nHelm is\", \" composed of a command-line client tool, which consumes helm charts and launches commands to a serve\", \"r component named, Tiller. Tiller communicates with the Kubernetes API to ensure the correct provisi\", \"oning of your containerized workloads. Helm is maintained by the Cloudnative Computing Foundation.\\n\\n\", \"The following yaml file presents a Helm template:\\n\\n```\\napiVersion : v1 kind : Service metadata : nam\", \"e : { { .Values.app.svc.marketing } } labels : app : { { template \\\"marketing-api.name\\\" . } } chart :\", \" { { template \\\"marketing-api.chart\\\" . } } release : { { .Release.Name } } heritage : { { .Release.Se\", \"rvice } } spec : type : { { .Values.service.type } } ports : -port : { { .Values.service.port } } ta\", \"rgetPort : http protocol : TCP name : http selector : app : { { template \\\"marketing-api.name\\\" . } } \", \"release : { { .Release.Name } }\\n```\\n\\nNote how the template describes a dynamic set of key/value pair\", \"s. When the template is invoked, values that enclosed in curly braces are pulled in from other yaml-\", \"based configuration files.\\n\\nYou'll find the eShopOnContainers helm charts in the /k8s/helm folder. F\", \"igure 2 -6 shows how the different components of the application are organized into a folder structu\", \"re used by helm to define and managed deployments.\\n\\nBranch: dev - eShopOnContainers / k8s / helm /\\n\\n\", \"mvelosop Add option to use local images for k&amp;s deployment\\n\\n\\u2022 apigwmm\\n\\n\\u2022 apigwms\\n\\n\\u2022 apigwwm\\n\\n\\u2022 a\", \"pigwws\\n\\n\\u2022 basket-api\\n\\n\\u2022 basket-data\\n\\n\\u2022 catalog-api\\n\\n\\u2022 eshop-common\\n\\n\\u2022 identity-api\\n\\n\\u2022 istio\\n\\n\\u2022 keyst\", \"ore-data\\n\\n\\u2022 locations-api\\n\\n\\u2022 marketing-api\\n\\n\\u2022 mobileshoppingagg\\n\\n\\u2022 nosql-data\\n\\n\\u2022 ordering-api\\n\\n\\u2022 ord\", \"ering-backgroundtasks\\n\\n\\u2022 ordering-signalrhub\\n\\n\\u2022 payment-api\\n\\n\\u2022 rabbitmq\\n\\n\\u2022 sql-data\\n\\n\\u2022 webhooks-api\\n\", \"\\n\\u2022 webhooks-web\\n\\n\\u2022 webmvc\\n\\n\\u2022 webshoppingagg\\n\\n\\u2022 webspa\\n\\n\\u2022 webstatus devspaces scripts\\n\\nUpload files\\n\\n\", \"Find file\\n\\nHistory\\n\\nLatest commit faa7546 13 days ago\\n\\n6 months ago\\n\\nFigure 2-6. The eShopOnContaine\", \"rs helm folder.\\n\\n<!-- image -->\\n\\nEach individual component is installed using a helm install command\", \". eShop includes a 'deploy all' script that loops through and installs the components using their re\", \"spective helm charts. The result is a repeatable process, versioned with the application in source c\", \"ontrol, that anyone on the team can deploy to an AKS cluster with a one-line script command.\\n\\nNote t\", \"hat version 3 of Helm officially removes the need for the Tiller server component. More information \", \"on this enhancement can be found here.\\n\\n## Azure Functions and Logic Apps (Serverless)\\n\\nThe eShopOnC\", \"ontainers sample includes support for tracking online marketing campaigns. An Azure Function is used\", \" to track marketing campaign details for a given campaign ID. Rather than creating a\\n\\nCreate new fil\", \"e\\n\\nfull microservice, a single Azure Function is simpler and sufficient. Azure Functions have a simp\", \"le build and deployment model, especially when configured to run in Kubernetes. Deploying the functi\", \"on is scripted using Azure Resource Manager (ARM) templates and the Azure CLI. This campaign service\", \" isn't customer -facing and invokes a single operation, making it a great candidate for Azure Functi\", \"ons. The function requires minimal configuration, including a database connection string data and im\", \"age base URI settings. You configure Azure Functions in the Azure portal.\\n\\n## Centralized configurat\", \"ion\\n\\nUnlike a monolithic app in which everything runs within a single instance, a cloud-native appli\", \"cation consists of independent services distributed across virtual machines, containers, and geograp\", \"hic regions. Managing configuration settings for dozens of interdependent services can be challengin\", \"g. Duplicate copies of configuration settings across different locations are error prone and difficu\", \"lt to manage. Centralized configuration is a critical requirement for distributed cloud-native appli\", \"cations.\\n\\nAs discussed in Chapter 1, the Twelve-Factor App recommendations require strict separation\", \" between code and configuration. Configuration must be stored externally from the application and re\", \"ad-in as needed. Storing configuration values as constants or literal values in code is a violation.\", \" The same configuration values are often be used by many services in the same application. Additiona\", \"lly, we must support the same values across multiple environments, such as dev, testing, and product\", \"ion. The best practice is store them in a centralized configuration store.\\n\\nThe Azure cloud presents\", \" several great options.\\n\\n## Azure App Configuration\\n\\nAzure App Configuration is a fully managed Azur\", \"e service that stores non-secret configuration settings in a secure, centralized location. Stored va\", \"lues can be shared among multiple services and applications.\\n\\nThe service is simple to use and provi\", \"des several benefits:\\n\\n- Flexible key/value representations and mappings\\n- Tagging with Azure labels\", \"\\n- Dedicated UI for management\\n- Encryption of sensitive information\\n- Querying and batch retrieval\\n\", \"\\nAzure App Configuration maintains changes made to key-value settings for seven days. The point-inti\", \"me snapshot feature enables you to reconstruct the history of a setting and even rollback for a fail\", \"ed deployment.\\n\\nApp Configuration automatically caches each setting to avoid excessive calls to the \", \"configuration store. The refresh operation waits until the cached value of a setting expires to upda\", \"te that setting, even when its value changes in the configuration store. The default cache expiratio\", \"n time is 30 seconds. You can override the expiration time.\\n\\nApp Configuration encrypts all configur\", \"ation values in transit and at rest. Key names and labels are used as indexes for retrieving configu\", \"ration data and aren't encrypted.\\n\\nAlthough App Configuration provides hardened security, Azure Key \", \"Vault is still the best place for storing application secrets. Key Vault provides hardware-level enc\", \"ryption, granular access policies, and management operations such as certificate rotation. You can c\", \"reate App Configuration values that reference secrets stored in a Key Vault.\\n\\n## Azure Key Vault\\n\\nKe\", \"y Vault is a managed service for securely storing and accessing secrets. A secret is anything that y\", \"ou want to tightly control access to, such as API keys, passwords, or certificates. A vault is a log\", \"ical group of secrets.\\n\\nKey Vault greatly reduces the chances that secrets may be accidentally leake\", \"d. When using Key Vault, application developers no longer need to store security information in thei\", \"r application. This practice eliminates the need to store this information inside your code. For exa\", \"mple, an application may need to connect to a database. Instead of storing the connection string in \", \"the app's code, you can store it securely in Key Vault.\\n\\nYour applications can securely access the i\", \"nformation they need by using URIs. These URIs allow the applications to retrieve specific versions \", \"of a secret. There's no need to write custom code to protect any of the secret information stored in\", \" Key Vault.\\n\\nAccess to Key Vault requires proper caller authentication and authorization. Typically,\", \" each cloudnative microservice uses a ClientId/ClientSecret combination. It's important to keep thes\", \"e credentials outside source control. A best practice is to set them in the application's environmen\", \"t. Direct access to Key Vault from AKS can be achieved using Key Vault FlexVolume.\\n\\n## Configuration\", \" in eShop\\n\\nThe eShopOnContainers application includes local application settings files with each mic\", \"roservice. These files are checked into source control, but don't include production secrets such as\", \" connection strings or API keys. In production, individual settings may be overwritten with per-serv\", \"ice environment variables. Injecting secrets in environment variables is a common practice for hoste\", \"d applications, but doesn't provide a central configuration store. To support centralized management\", \" of configuration settings, each microservice includes a setting to toggle between its use of local \", \"settings or Azure Key Vault settings.\\n\\n## References\\n\\n- The eShopOnContainers Architecture\\n- Orchest\", \"rating microservices and multi-container applications for high scalability and availability\\n- Azure \", \"API Management\\n- Azure SQL Database Overview\\n- Azure Cache for Redis\\n- Azure Cosmos DB's API for Mon\", \"goDB\\n\\n- Azure Service Bus\\n- Azure Monitor overview\\n- eShopOnContainers: Create Kubernetes cluster in\", \" AKS\\n- eShopOnContainers: Azure Dev Spaces\\n- Azure Dev Spaces\\n\\n## Scaling cloud-native applications\\n\", \"\\nOne of the most-often touted advantages of moving to a cloud hosting environment is scalability. Sc\", \"alability, or the ability for an application to accept additional user load without compromising per\", \"formance for each user. It's most often achieved by break ing up an application into small pieces th\", \"at can each be given whatever resources they require. Cloud vendors enable massive scalability anyti\", \"me and anywhere in the world.\\n\\nIn this chapter, we discuss technologies that enable cloud-native app\", \"lications to scale to meet user demand. These technologies include:\\n\\n- Containers\\n- Orchestrators\\n- \", \"Serverless computing\\n\\n## Leveraging containers and orchestrators\\n\\nContainers and orchestrators are d\", \"esigned to solve problems common to monolithic deployment approaches.\\n\\n## Challenges with monolithic\", \" deployments\\n\\nTraditionally, most applications have been deployed as a single unit. Such application\", \"s are referred to as a monolith. This general approach of deploying applications as single units eve\", \"n if they're composed of multiple modules or assemblies is known as monolithic architecture, as show\", \"n in Figure 3-1.\\n\\nClient app\\n\\nMobile\\n\\nTraditional web app\\n\\nHTML\\n\\nMonolithic server process\\n\\nModules\\n\", \"\\nFigure 3-1. Monolithic architecture.\\n\\n<!-- image -->\\n\\nAlthough they have the benefit of simplicity,\", \" monolithic architectures face many challenges:\\n\\n## Deployment\\n\\nAdditionally, they require a restart\", \" of the application, which may temporarily impact availability if zero-downtime techniques are not a\", \"pplied while deploying.\\n\\n## Scaling\\n\\nA monolithic application is hosted entirely on a single machine\", \" instance, often requiring highcapability hardware. If any part of the monolith requires scaling, an\", \"other copy of the entire application must be deployed to another machine. With a monolith, you can't\", \" scale application components individually it's all or nothing. Scaling components that don't requir\", \"e scaling results in inefficient and costly resource usage.\\n\\n## Environment\\n\\nMonolithic applications\", \" are typically deployed to a hosting environment with a pre-installed operating system, runtime, and\", \" library dependencies. This environment may not match that upon which the application was developed \", \"or tested. Inconsistencies across application environments are a common source of problems for monol\", \"ithic deployments.\\n\\n## Coupling\\n\\nA monolithic application is likely to experience high coupling acro\", \"ss its functional components. Without hard boundaries, system changes often result in unintended and\", \" costly side effects. New features/fixes become tricky, time-consuming, and expensive to implement. \", \"Updates require extensive testing. Coupling also makes it difficult to refactor components or swap i\", \"n alternative implementations. Even when constructed with a strict separation of concerns, architect\", \"ural erosion sets in as the monolithic code base deteriorates with neverending 'special cases.'\\n\\nAPI\", \"\\n\\nDatabase\\n\\n## Platform lock-in\\n\\nA monolithic application is constructed with a single technology st\", \"ack. While offering uniformity, this commitment can become a barrier to innovation. New features and\", \" components will be built using the application's current stack - even when more modern technologies\", \" may be a better choice. A longer-term risk is your technology stack becoming outdated and obsolete.\", \" Rearchitecting an entire application to a new, more modern platform is at best expensive and risky.\", \"\\n\\n## What are the benefits of containers and orchestrators?\\n\\nWe introduced containers in Chapter 1. \", \"We highlighted how the Cloud Native Computing Foundation (CNCF) ranks containerization as the first \", \"step in their Cloud-Native Trail Map - guidance for enterprises beginning their cloud-native journey\", \". In this section, we discuss the benefits of containers.\\n\\nDocker is the most popular container mana\", \"gement platform. It works with containers on both Linux or Windows. Containers provide separate but \", \"reproducible application environments that run the same way on any system. This aspect makes them pe\", \"rfect for developing and hosting cloud-native services. Containers are isolated from one another. Tw\", \"o containers on the same host hardware can have different versions of software, without causing conf\", \"licts.\\n\\nContainers are defined by simple text-based files that become project artifacts and are chec\", \"ked into source control. While full servers and virtual machines require manual effort to update, co\", \"ntainers are easily version-controlled. Apps built to run in containers can be developed, tested, an\", \"d deployed using automated tools as part of a build pipeline.\\n\\nContainers are immutable. Once you de\", \"fine a container, you can recreate and run it exactly the same way. This immutability lends itself t\", \"o component-based design. If some parts of an application evolve differently than others, why redepl\", \"oy the entire app when you can just deploy the parts that change most frequently? Different features\", \" and cross-cutting concerns of an app can be broken up into separate units. Figure 3-2 shows how a m\", \"onolithic app can take advantage of containers and microservices by delegating certain features or f\", \"unctionality. The remaining functionality in the app itself has also been containerized.\\n\\nClient app\", \"s\\n\\nMobile app\\n\\nTraditional Web app\\n\\nHTML\\n\\nSPA Web app\\n\\nTypeScript/Angular 2\\n\\nIdentity microservice (\", \"STS+users)\\n\\nRelational database\\n\\nCatalog microservice\\n\\nFigure 3-2. Decomposing a monolithic app to e\", \"mbrace microservices.\\n\\n<!-- image -->\\n\\nEach cloud-native service is built and deployed in a separate\", \" container. Each can update as needed. Individual services can be hosted on nodes with resources app\", \"ropriate to each service. The environment each service runs in is immutable, shared across dev, test\", \", and production environments, and easily versioned. Coupling between different areas of the applica\", \"tion occurs explicitly as calls or messages between services, not compile-time dependencies within t\", \"he monolith. You can also choose the technology that best suites a given capability without requirin\", \"g changes to the rest of the app.\\n\\nContainerized services require automated management. It wouldn't \", \"be feasible to manually administer a large set of independently deployed containers. For example, co\", \"nsider the following tasks:\\n\\n- How will container instances be provisioned across a cluster of many \", \"machines?\\n- Once deployed, how will containers discover and communicate with each other?\\n- How can c\", \"ontainers scale in or out on-demand?\\n- How do you monitor the health of each container?\\n- How do you\", \" protect a container against hardware and software failures?\\n- How do upgrade containers for a live \", \"application with zero downtime?\\n\\nContainer orchestrators address and automate these and other concer\", \"ns.\\n\\nIn the cloud-native ecosystem, Kubernetes has become the de facto container orchestrator. It's \", \"an open-source platform managed by the Cloud Native Computing Foundation (CNCF). Kubernetes automate\", \"s the deployment, scaling, and operational concerns of containerized workloads across a machine clus\", \"ter. However, installing and managing Kubernetes is notoriously complex.\\n\\nDocker Host\\n\\nKubernetes\\n\\nA\", \"zure\\n\\nA much better approach is to leverage Kubernetes as a managed service from a cloud vendor. The\", \" Azure cloud features a fully managed Kubernetes platform entitled Azure Kubernetes Service (AKS). A\", \"KS abstracts the complexity and operational overhead of managing Kubernetes. You consume Kubernetes \", \"as a cloud service; Microsoft takes responsibility for managing and supporting it. AKS also tightly \", \"integrates with other Azure services and dev tools. Node\\n\\nAKS is a cluster-based technology. A pool \", \"of federated virtual machines, or nodes, is deployed to the Azure cloud. Together they form a highly\", \" available environment, or cluster. The cluster appears as a seamless, single entity to your cloud-n\", \"ative application. Under the hood, AKS deploys your containerized services across these nodes follow\", \"ing a predefined strategy that evenly distributes the load.\\n\\n## What are the scaling benefits?\\n\\nServ\", \"ices built on containers can leverage scaling benefits provided by orchestration tools like Kubernet\", \"es. By design containers only know about themselves. Once you have multiple containers that need to \", \"work together, you should organize them at a higher level. Organizing large numbers of containers an\", \"d their shared dependencies, such as network configuration, is where orchestration tools come in to \", \"save the day! Kubernetes creates an abstraction layer over groups of containers and organizes them i\", \"nto pods . Pods run on worker machines referred to as nodes . This organized structure is referred t\", \"o as a cluster . Figure 3-3 shows the different components of a Kubernetes cluster.\\n\\nFigure 3-3. Kub\", \"ernetes cluster components.\\n\\n<!-- image -->\\n\\nScaling containerized workloads is a key feature of con\", \"tainer orchestrators. AKS supports automatic scaling across two dimensions: Container instances and \", \"compute nodes. Together they give AKS the ability to quickly and efficiently respond to spikes in de\", \"mand and add additional resources. We discuss scaling in AKS later in this chapter.\\n\\nKubernetes Mast\", \"er\\n\\n## Declarative versus imperative\\n\\nKubernetes supports both declarative and imperative configurat\", \"ion. The imperative approach involves running various commands that tell Kubernetes what to do each \", \"step of the way. Run this image. Delete this pod. Expose this port. With the declarative approach, y\", \"ou create a configuration file, called a manifest, to describe what you want instead of what to do. \", \"Kubernetes reads the manifest and transforms your desired end state into actual end state.\\n\\nImperati\", \"ve commands are great for learning and interactive experimentation. However, you'll want to declarat\", \"ively create Kubernetes manifest files to embrace an infrastructure as code approach, providing for \", \"reliable and repeatable deployments. The manifest file becomes a project artifact and is used in you\", \"r CI/CD pipeline for automating Kubernetes deployments.\\n\\nIf you've already configured your cluster u\", \"sing imperative commands, you can export a declarative manifest by using kubectl get svc SERVICENAME\", \" -o yaml &gt; service.yaml. This command produces a manifest similar to one shown below:\\n\\n```\\napiVer\", \"sion : v1 kind : Service metadata : creationTimestamp : \\\"2019-09-13T13:58:47Z\\\" labels : component : \", \"apiserver provider : kubernetes name : kubernetes namespace : default resourceVersion : \\\"153\\\" selfLi\", \"nk : /api/v1/namespaces/default/services/kubernetes uid : 9b1fac62-d62e-11e9-8968-00155d38010d spec \", \": clusterIP : 10.96.0.1 ports : -name : https port : 443 protocol : TCP targetPort : 6443 sessionAff\", \"inity : None type : ClusterIP status : loadBalancer : {}\\n```\\n\\nWhen using declarative configuration, \", \"you can preview the changes that will be made before committing them by using kubectl diff -f FOLDER\", \"NAME against the folder where your configuration files are located. Once you're sure you want to app\", \"ly the changes, ru n kubectl apply -f FOLDERNAME. Add -R to recursively process a folder hierarchy.\\n\", \"\\nYou can also use declarative configuration with other Kubernetes features, one of which being deplo\", \"yments. Declarative deployments help manage releases, updates, and scaling. They instruct the Kubern\", \"etes deployment controller on how to deploy new changes, scale out load, or roll back to a previous \", \"revision. If a cluster is unstable, a declarative deployment will automatically return the cluster b\", \"ack to a desired state. For example, if a node should crash, the deployment mechanism will redeploy \", \"a replacement to achieve your desired state\\n\\nUsing declarative configuration allows infrastructure t\", \"o be represented as code that can be checked in and versioned alongside the application code. It pro\", \"vides improved change control and better support for continuous deployment using a build and deploy \", \"pipeline.\\n\\n## What scenarios are ideal for containers and orchestrators?\\n\\nThe following scenarios ar\", \"e ideal for using containers and orchestrators.\\n\\n## Applications requiring high uptime and scalabili\", \"ty\\n\\nIndividual applications that have high uptime and scalability requirements are ideal candidates \", \"for cloud-native architectures using microservices, containers, and orchestrators. They can be devel\", \"oped in containers, tested across versioned environments, and deployed into production with zero dow\", \"ntime. The use of Kubernetes clusters ensures such apps can also scale on demand and recover automat\", \"ically from node failures.\\n\\n## Large numbers of applications\\n\\nOrganizations that deploy and maintain\", \" large numbers of applications benefit from containers and orchestrators. The up front effort of set\", \"ting up containerized environments and Kubernetes clusters is primarily a fixed cost. Deploying, mai\", \"ntaining, and updating individual applications has a cost that varies with the number of application\", \"s. Beyond a few applications, the complexity of maintaining custom applications manually exceeds the\", \" cost of implementing a solution using containers and orchestrators.\\n\\n## When should you avoid using\", \" containers and orchestrators?\\n\\nIf you're unable to build your application following the Twelve -Fac\", \"tor App principles, you should consider avoiding containers and orchestrators. In these cases, consi\", \"der a VM-based hosting platform, or possibly some hybrid system. With it, you can always spin off ce\", \"rtain pieces of functionality into separate containers or even serverless functions.\\n\\n## Development\", \" resources\\n\\nThis section shows a short list of development resources that may help you get started u\", \"sing containers and orchestrators for your next application. If you're looking for guidance on how t\", \"o design your cloud-native microservices architecture app, read this book's companion, .NET Microser\", \"vices: Architecture for Containerized .NET Applications.\\n\\n## Local Kubernetes Development\\n\\nKubernete\", \"s deployments provide great value in production environments, but can also run locally on your devel\", \"opment machine. While you may work on individual microservices independently, there may be times whe\", \"n you'll need to run the entire system locally - just as it will run when deployed to production. Th\", \"ere are several tools that can help: Minikube and Docker Desktop. Visual Studio also provides toolin\", \"g for Docker development.\\n\\nsit docker\\n\\nSettings\\n\\nGeneral\\n\\n## Minikube\\n\\nKubernetes v1.21.3\\n\\n\\u2022 Enable \", \"Kubernetes\\n\\nWhat is Minikube? The Minikube project says 'Minikube implements a local Kubernetes clus\", \"ter on macOS, Linux, and Windows.' Its primary goals are 'to be the best tool for local Kubernetes a\", \"pplication development and to support all Kubernetes features that f it.' Installing Minikube is sep\", \"arate from Docker, but Minikube supports different hypervisors than Docker Desktop supports. The fol\", \"lowing Kubernetes features are currently supported by Minikube: Reset Kubernetes Cluster\\n\\n- DNS\\n- No\", \"dePorts\\n- ConfigMaps and secrets\\n- Dashboards\\n- Container runtimes: Docker, rkt, CRI-O, and containe\", \"rd\\n- Enabling Container Network Interface (CNI)\\n- Ingress\\n\\nAfter installing Minikube, you can quickl\", \"y start using it by running the minikube start command, which downloads an image and start the local\", \" Kubernetes cluster. Once the cluster is started, you interact with it using the standard Kubernetes\", \" kubectl commands.\\n\\n## Docker Desktop\\n\\nYou can also work with Kubernetes directly from Docker Deskto\", \"p on Windows. It is your only option if you're using Windows Containers, and is a great choice for n\", \"on -Windows containers as well. Figure 34 shows how to enable local Kubernetes support when running \", \"Docker Desktop.\\n\\nFigure 3-4. Configuring Kubernetes in Docker Desktop.\\n\\n<!-- image -->\\n\\nUpgrade O ro\", \"bertor\\n\\nCancel\\n\\nApply &amp; Restart\\n\\nX\\n\\nAdditional information\\n\\nASP.NET Core Web APIc*\\n\\nFramework f\\n\", \"\\nAuthentication type O\\n\\nNone\\n\\n[Z Enable Docker O\\n\\nDocker OS O\\n\\nLinux\\n\\nDocker Desktop is the most pop\", \"ular tool for configuring and running containerized apps locally. When you work with Docker Desktop,\", \" you can develop locally against the exact same set of Docker container images that you'll deploy to\", \" production. Docker Desktop is designed to 'build, test, and ship' containerized apps locally. It su\", \"pports both Linux and Windows containers. Once you push your images to an image registry, like Azure\", \" Container Registry or Docker Hub, AKS can pull and deploy them to production.\\n\\n/ Use controllers (u\", \"ncheck to use minimal APIs) O\\n\\n## Visual Studio Docker Tooling\\n\\nVisual Studio supports Docker develo\", \"pment for web-based applications. When you create a new ASP.NET Core application, you have an option\", \" to configure it with Docker support, as shown in Figure 3-5. Back Create\\n\\nFigure 3-5. Visual Studio\", \" Enable Docker Support\\n\\n<!-- image -->\\n\\nWhen this option is selected, the project is created with a \", \"Dockerfile in its root, which can be used to build and host the app in a Docker container. An exampl\", \"e Dockerfile is shown in Figure 3-6.\\n\\n```\\nFROM mcr.microsoft.com/dotnet/aspnet:7.0 AS base WORKDIR /\", \"app EXPOSE 80 EXPOSE 443 FROM mcr.microsoft.com/dotnet/sdk:7.0 AS build WORKDIR /src COPY [\\\"eShopWeb\", \"/eShopWeb.csproj\\\", \\\"eShopWeb/\\\"] RUN dotnet restore \\\"eShopWeb/eShopWeb.csproj\\\" COPY . . WORKDIR \\\"/src\", \"/eShopWeb\\\" RUN dotnet build \\\"eShopWeb.csproj\\\" -c Release -o /app/build FROM build AS publish RUN dot\", \"net publish \\\"eShopWeb.csproj\\\" -c Release -o /app/publish\\n```\\n\\nLinux macOS\\n\\nWindows\\n\\nCloud\\n\\nService\\n\\n\", \"Web\\n\\nX\\n\\nDebug *\\n\\nAny CPU\\n\\n\\u2022 Docker api\\\\_sample\\\\_app\\n\\nIIS Express\\n\\nDocker\\n\\nWSL\\n\\nFigure 3-6. Visual St\", \"udio generated Dockerfile\\n\\n<!-- image -->\\n\\nOnce support is added, you can run your application in a \", \"Docker container in Visual Studio. Figure 3-7 shows the different run options available from a new A\", \"SP.NET Core project created with Docker support added.\\n\\nFigure 3-7. Visual Studio Docker Run Options\", \"\\n\\n<!-- image -->\\n\\nAlso, at any time you can add Docker support to an existing ASP.NET Core applicati\", \"on. From the Visual Studio Solution Explorer, right-click on the project and select Add &gt; Docker \", \"Support , as shown in Figure 3-8.\\n\\nDocker -\\n\\nNew Item...\\n\\nExisting Item...\\n\\nNew Scaffolded Item...\\n\\n\", \"New Folder\\n\\nApplication Insights Telemetry...\\n\\nContainer Orchestrator Support...\\n\\nDocker Support...\\n\", \"\\nClient-Side Library...\\n\\nNew Azure WebJob Project\\n\\nExisting Project as Azure WebJob\\n\\nProject Referen\", \"ce...\\n\\nShared Project Reference...\\n\\nCOM Reference...\\n\\nService Reference...\\n\\nConnected Service\\n\\nClass\", \"...\\n\\nNew EditorConfig\\n\\nBuild\\n\\nRebuild\\n\\nClean\\n\\nSolution Explorer\\n\\nSearch Solution Explorer (Ctri+:)\\n\\n\", \"Solution 'api-sample-app' (1 of 1 project)\\n\\n= -pi-sample-app\\n\\n\\u203a Connected Services\\n\\n9 Dependencies\\n\\n\", \"\\u2022 Properties\\n\\nFigure 3-8. Adding Docker support to Visual Studio\\n\\n<!-- image -->\\n\\n## Visual Studio C\", \"ode Docker Tooling\\n\\nThere are many extensions available for Visual Studio Code that support Docker d\", \"evelopment.\\n\\nMicrosoft provides the Docker for Visual Studio Code extension. This extension simplifi\", \"es the process of adding container support to applications. It scaffolds required files, builds Dock\", \"er images, and enables you to debug your app inside a container. The extension features a visual exp\", \"lorer that makes it easy to take actions on containers and images such as start, stop, inspect, remo\", \"ve, and more. The extension also supports Docker Compose enabling you to manage multiple running con\", \"tainers as a single unit.\\n\\n## Leveraging serverless functions\\n\\nIn the spectrum from managing physica\", \"l machines to leveraging cloud capabilities, serverless lives at the extreme end. Your only responsi\", \"bility is your code, and you only pay when your code runs. Azure Functions provides a way to build s\", \"erverless capabilities into your cloud-native applications.\\n\\n- 00\\n\\n4 X\\n\\n## What is serverless?\\n\\nServ\", \"erless is a relatively new service model of cloud computing. It doesn't mean that servers are option\", \"al - your code still runs on a server somewhere. The distinction is that the application team no lon\", \"ger concerns itself with managing server infrastructure. Instead, the cloud vendor own this responsi\", \"bility. The development team increases its productivity by delivering business solutions to customer\", \"s, not plumbing.\\n\\nServerless computing uses event-triggered stateless containers to host your servic\", \"es. They can scale out and in to meet demand as-needed. Serverless platforms like Azure Functions ha\", \"ve tight integration with other Azure services like queues, events, and storage.\\n\\n## What challenges\", \" are solved by serverless?\\n\\nServerless platforms address many time-consuming and expensive concerns:\", \"\\n\\n- Purchasing machines and software licenses\\n- Housing, securing, configuring, and maintaining the \", \"machines and their networking, power, and A/C requirements\\n- Patching and upgrading operating system\", \"s and software\\n- Configuring web servers or machine services to host application software\\n- Configur\", \"ing application software within its platform\\n\\nMany companies allocate large budgets to support hardw\", \"are infrastructure concerns. Moving to the cloud can help reduce these costs; shifting applications \", \"to serverless can help eliminate them.\\n\\n## What is the difference between a microservice and a serve\", \"rless function?\\n\\nTypically, a microservice encapsulates a business capability, such as a shopping ca\", \"rt for an online eCommerce site. It exposes multiple operations that enable a user to manage their s\", \"hopping experience. A function, however, is a small, lightweight block of code that executes a singl\", \"e-purpose operation in response to an event. Microservices are typically constructed to respond to r\", \"equests, often from an interface. Requests can be HTTP Rest- or gRPC-based. Serverless services resp\", \"ond to events. Its event-driven architecture is ideal for processing short-running, background tasks\", \".\\n\\n## What scenarios are appropriate for serverless?\\n\\nServerless exposes individual short-running fu\", \"nctions that are invoked in response to a trigger. This makes them ideal for processing background t\", \"asks.\\n\\nAn application might need to send an email as a step in a workflow. Instead of sending the no\", \"tification as part of a microservice request, place the message details onto a queue. An Azure Funct\", \"ion can dequeue the message and asynchronously send the email. Doing so could improve the performanc\", \"e and scalability of the microservice. Queue-based load leveling can be implemented to avoid bottlen\", \"ecks related to sending the emails. Additionally, this stand-alone service could be reused as a util\", \"ity across many different applications.\\n\\nAzure allocates unspecialized\\n\\nserver\\n\\nAzure allocates unsp\", \"ecialized\\n\\nserve\\n\\nWorker becomes\\n\\nspecialized\\n\\nWhen App is Cold\\n\\nFunctions runtime resets\\n\\nFunctions\", \" loaded into\\n\\nmemory\\n\\nAsynchronous messaging from queues and topics is a common pattern to trigger s\", \"erverless functions. However, Azure Functions can be triggered by other events, such as changes to A\", \"zure Blob Storage. A service that supports image uploads could have an Azure Function responsible fo\", \"r optimizing the image size. The function could be triggered directly by inserts into Azure Blob Sto\", \"rage, keeping complexity out of the microservice operations.\\n\\nMany services have long-running proces\", \"ses as part of their workflows. Often these tasks are done as part of the user's interaction with th\", \"e application. These tasks can force the user to wait, negatively impacting their experience. Server\", \"less computing provides a great way to move slower tasks outside of the user interaction loop. These\", \" tasks can scale with demand without requiring the entire application to scale. files read\\n\\nApp sett\", \"ings\\n\\nExtensions\\n\\n## When should you avoid serverless?\\n\\nServerless solutions provision and scale on \", \"demand. When a new instance is invoked, cold starts are a common issue. A cold start is the period o\", \"f time it takes to provision this instance. Normally, this delay might be a few seconds, but can be \", \"longer depending on various factors. Once provisioned, a single instance is kept alive as long as it\", \" receives periodic requests. But, if a service is called less frequently, Azure may remove it from m\", \"emory and require a cold start when reinvoked. Cold starts are also required when a function scales \", \"out to a new instance.\\n\\nFigure 3-9 shows a cold-start pattern. Note the extra steps required when th\", \"e app is cold.\\n\\nFigure 3-9. Cold start versus warm start.\\n\\n<!-- image -->\\n\\nTo avoid cold starts enti\", \"rely, you might switch from a consumption plan to a dedicated plan. You can also configure one or mo\", \"re pre-warmed instances with the premium plan upgrade. In these cases, when you need to add another \", \"instance, it's already up and ready to go. These options can help mitigate the cold start issue asso\", \"ciated with serverless computing.\\n\\nCode runs\\n\\nCloud providers bill for serverless based on compute e\", \"xecution time and consumed memory. Long running operations or high memory consumption workloads aren\", \"'t always the best candidates for serverless. Serverless functions favor small chunks of work that c\", \"an complete quickly. Most serverless platforms require individual functions to complete within a few\", \" minutes. Azure Functions defaults to a 5-minute time-out duration, which can be configured up to 10\", \" minutes. The Azure Functions premium plan can mitigate this issue as well, defaulting time-outs to \", \"30 minutes with an unbounded higher limit that can be configured. Compute time isn't calendar time. \", \"More advanced functions using the Azure Durable Functions framework may pause execution over a cours\", \"e of several days. The billing is based on actual execution time - when the function wakes up and re\", \"sumes processing.\\n\\nFinally, leveraging Azure Functions for application tasks adds complexity. It's w\", \"ise to first architect your application with a modular, loosely coupled design. Then, identify if th\", \"ere are benefits serverless would offer that justify the additional complexity.\\n\\n## Combining contai\", \"ners and serverless approaches\\n\\nCloud-native applications typically implement services leveraging co\", \"ntainers and orchestration. There are often opportunities to expose some of the application's servic\", \"es as Azure Functions. However, with a cloud-native app deployed to Kubernetes, it would be nice to \", \"leverage Azure Functions within this same toolset. Fortunately, you can wrap Azure Functions inside \", \"Docker containers and deploy them using the same processes and tools as the rest of your Kubernetes-\", \"based app.\\n\\n## When does it make sense to use containers with serverless?\\n\\nYour Azure Function has n\", \"o knowledge of the platform on which it's deployed. For some scenarios, you may have specific requir\", \"ements and need to customize the environment on which your function code will run. You'll need a cus\", \"tom image that supports depende ncies or a configuration not supported by the default image. In thes\", \"e cases, it makes sense to deploy your function in a custom Docker container.\\n\\n## When should you av\", \"oid using containers with Azure Functions?\\n\\nIf you want to use consumption billing, you can't run yo\", \"ur function in a container. What's more, if you deploy your function to a Kubernetes cluster, you'll\", \" no longer benefit from the built -in scaling provided by Azure Functions. You'll need to use Kubern\", \"etes' scaling features, described earlier in this chapter.\\n\\n## How to combine serverless and Docker \", \"containers\\n\\nTo wrap an Azure Function in a Docker container, install the Azure Functions Core Tools \", \"and then run the following command:\\n\\nfunc init ProjectName --worker-runtime dotnet --docker\\n\\nWhen th\", \"e project is created, it will include a Dockerfile and the worker runtime configured to dotnet. Now,\", \" you can create and test your function locally. Build and run it using the docker build and docker\\n\\n\", \"run commands. For detailed steps to get started building Azure Functions with Docker support, see th\", \"e Create a function on Linux using a custom image tutorial.\\n\\n## How to combine serverless and Kubern\", \"etes with KEDA\\n\\nIn this chapter, you've seen that the Azure Functions' platform automatically scales\", \" out to meet demand. When deploying containerized functions to AKS, however, you lose the built-in s\", \"caling functionality. To the rescue comes Kubernetes-based Event Driven (KEDA). It enables fine-grai\", \"ned autoscaling for event-driven Kubernetes workloads, including containerized functions.\\n\\nKEDA prov\", \"ides eventdriven scaling functionality to the Functions' runtime in a Docker container. KEDA can sca\", \"le from zero instances (when no events are occurring) out to n instances, based on load. It enables \", \"autoscaling by exposing custom metrics to the Kubernetes autoscaler (Horizontal Pod Autoscaler). Usi\", \"ng Functions containers with KEDA makes it possible to replicate serverless function capabilities in\", \" any Kubernetes cluster.\\n\\nIt's worth noting that the KEDA project is now managed by the Cloud Native\", \" Computing Foundation (CNCF).\\n\\n## Deploying containers in Azure\\n\\nWe've discussed containers in this \", \"chapter and in chapter 1. We've seen that containers provide many benefits to cloud-native applicati\", \"ons, including portability. In the Azure cloud, you can deploy the same containerized services acros\", \"s staging and production environments. Azure provides several options for hosting these containerize\", \"d workloads:\\n\\n- Azure Kubernetes Services (AKS)\\n- Azure Container Instance (ACI)\\n- Azure Web Apps fo\", \"r Containers\\n\\n## Azure Container Registry\\n\\nWhen containerizing a microservice, you first build a con\", \"tainer 'image.' The image is a binary representation of the service code, dependencies, and runtime.\", \" While you can manually create an image using the Docker Build command from the Docker API, a better\", \" approach is to create it as part of an automated build process.\\n\\nOnce created, container images are\", \" stored in container registries. They enable you to build, store, and manage container images. There\", \" are many registries available, both public and private. Azure Container Registry (ACR) is a fully m\", \"anaged container registry service in the Azure cloud. It persists your images inside the Azure netwo\", \"rk, reducing the time to deploy them to Azure container hosts. You can also secure them using the sa\", \"me security and identity procedures that you use for other Azure resources.\\n\\nYou create an Azure Con\", \"tainer Registry using the Azure portal, Azure CLI, or PowerShell tools. Creating a registry in Azure\", \" is simple. It requires an Azure subscription, resource group, and a unique\\n\\nCreate container regist\", \"ry\\n\\n* Registry name name. Figure 3-10 shows the basic options for creating a registry, which will be\", \" hosted at registryname.azurecr.io.\\n\\n* Subscription\\n\\nVisual Studio Ultimate with MSDN\\n\\n* Resource gr\", \"oup\\n\\n(New) myResourceGroup\\n\\nCreate new\\n\\n* Location\\n\\nWest US\\n\\n* Admin user O\\n\\nEnable\\n\\n* SKU 0\\n\\nBasic\\n\", \"\\nCreate\\n\\nFigure 3-10. Create container registry\\n\\n<!-- image -->\\n\\nOnce you've created the registry, y\", \"ou'll need to authenticate with it before you can use it. Typically, you'll log into the registry us\", \"ing the Azure CLI command:\\n\\n```\\naz acr login --name *registryname*\\n```\\n\\nOnce authenticated, you can \", \"use docker commands to push container images to it. Before you can do so, however, you must tag your\", \" image with the fully qualified name (URL) of your ACR login server. It will have the format registr\", \"yname .azurecr.io.\\n\\ndocker tag mycontainer myregistry.azurecr.io/mycontainer:v1\\n\\nAfter you've tagged\", \" the image, you use the docker push command to push the image to your ACR instance.\\n\\ndocker push myr\", \"egistry.azurecr.io/mycontainer:v1\\n\\n\\u2022\\n\\nX\\n\\nAfter you push an image to the registry, it's a good idea t\", \"o remove the image from your local Docker environment, using this command:\\n\\ndocker rmi myregistry.az\", \"urecr.io/mycontainer:v1\\n\\nAs a best practice, you shouldn't manually push images to a container regis\", \"try. Instead, use a build pipeline defined in a tool like GitHub or Azure DevOps. Learn more in the \", \"Cloud-Native DevOps chapter.\\n\\n## ACR Tasks\\n\\nACR Tasks is a set of features available from the Azure \", \"Container Registry. It extends your inner-loop development cycle by building and managing container \", \"images in the Azure cloud. Instead of invoking a docker build and docker push locally on your develo\", \"pment machine, they're automatically handled by ACR Tasks in the cloud.\\n\\nThe following AZ CLI comman\", \"d both builds a container image and pushes it to ACR:\\n\\n# create a container registry az acr create -\", \"-resource-group myResourceGroup --name myContainerRegistry008 --sku Basic\\n\\n# build container image i\", \"n ACR and push it into your container registry az acr build --image sample/hello-world:v1  --registr\", \"y myContainerRegistry008 --file Dockerfile .\\n\\nAs you can see from the previous command block, there'\", \"s no need to install Docker Desktop on your development machine. Additionally, you can configure ACR\", \" Task triggers to rebuild containers images on both source code and base image updates.\\n\\n## Azure Ku\", \"bernetes Service\\n\\nWe discussed Azure Kubernetes Service (AKS) at length in this chapter. We've seen \", \"that it's the de facto container orchestrator managing containerized cloud-native applications.\\n\\nOnc\", \"e you deploy an image to a registry, such as ACR, you can configure AKS to automatically pull and de\", \"ploy it. With a CI/CD pipeline in place, you might configure a canary release strategy to minimize t\", \"he risk involved when rapidly deploying updates. The new version of the app is initially configured \", \"in production with no traffic routed to it. Then, the system will route a small percentage of users \", \"to the newly deployed version. As the team gains confidence in the new version, it can roll out more\", \" instances and retire the old. AKS easily supports this style of deployment.\\n\\nAs with most resources\", \" in Azure, you can create an Azure Kubernetes Service cluster using the portal, command-line, or aut\", \"omation tools like Helm or Terraform. To get started with a new cluster, you need to provide the fol\", \"lowing information:\\n\\n- Azure subscription\\n- Resource group\\n- Kubernetes cluster name\\n- Region\\n\\n- Kub\", \"ernetes version\\n- DNS name prefix\\n- Node size\\n- Node count\\n\\nThis information is sufficient to get st\", \"arted. As part of the creation process in the Azure portal, you can also configure options for the f\", \"ollowing features of your cluster:\\n\\n- Scale\\n- Authentication\\n- Networking\\n- Monitoring\\n- Tags\\n\\nThis \", \"quickstart walks through deploying an AKS cluster using the Azure portal.\\n\\n## Azure Bridge to Kubern\", \"etes\\n\\nCloud-native applications can grow large and complex, requiring significant compute resources \", \"to run. In these scenarios, the entire application can't be hosted on a development machine (especia\", \"lly a laptop). Azure Bridge to Kubernetes addresses the shortcoming. It enables developers to work w\", \"ith a local version of their service while hosting the entire application in an AKS development clus\", \"ter.\\n\\nWhen ready, developers test their changes locally while running against the full application i\", \"n the AKS cluster - without replicating dependencies. Under the hood, the bridge merges code from th\", \"e local machine with services in AKS. Developers can rapidly iterate and debug code directly in Kube\", \"rnetes using Visual Studio or Visual Studio Code.\\n\\nGabe Monroy, former VP of Product Management at M\", \"icrosoft, describes it well:\\n\\nImagine you're a new employee trying to fix a bug in a complex microse\", \"rvices application consisting of dozens of components, each with their own configuration and backing\", \" services. To get started, you must configure your local development environment so that it can mimi\", \"c production including setting up your IDE, building tool chain, containerized service dependencies,\", \" a local Kubernetes environment, mocks for backing services, and more. With all the time involved se\", \"tting up your development environment, fixing that first bug could take days! Or you could just use \", \"Bridge to Kubernetes and AKS.\\n\\n## Scaling containers and serverless applications\\n\\nThere are two ways\", \" to scale an application: up or out. The former refers to adding capacity to a single resource, whil\", \"e the latter refers to adding more resources to increase capacity.\\n\\n## The simple solution: scaling \", \"up\\n\\nUpgrading an existing host server with increased CPU, memory, disk I/O speed, and network I/O sp\", \"eed is known as scaling up . Scaling up a cloud-native application involves choosing more capable\\n\\nA\", \"zure Kubernetes Service (AKS) cluster resources from the cloud vendor. For example, you can create a\", \" new node pool with larger VMs in your Kubernetes cluster. Then, migrate your containerized services\", \" to the new pool.\\n\\nServerless apps scale up by choosing the premium Functions plan or premium instan\", \"ce sizes from a dedicated app service plan. Node Node Node\\n\\n## Scaling out cloud-native apps\\n\\nCloud-\", \"native applications often experience large fluctuations in demand and require scale on a moment's no\", \"tice. They favor scaling out. Scaling out is done horizontally by adding additional machines (called\", \" nodes) or application instances to an existing cluster. In Kubernetes, you can scale manually by ad\", \"justing configuration settings for the app (for example, scaling a node pool), or through autoscalin\", \"g.\\n\\nAKS clusters can autoscale in one of two ways:\\n\\nFirst, the Horizontal Pod Autoscaler monitors re\", \"source demand and automatically scales your POD replicas to meet it. When traffic increases, additio\", \"nal replicas are automatically provisioned to scale out your services. Likewise, when demand decreas\", \"es, they're removed to scale -in your services. You define the metric on which to scale, for example\", \", CPU usage. You can also specify the minimum and maximum number of replicas to run. AKS monitors th\", \"at metric and scales accordingly.\\n\\nNext, the AKS Cluster Autoscaler feature enables you to automatic\", \"ally scale compute nodes across a Kubernetes cluster to meet demand. With it, you can automatically \", \"add new VMs to the underlying Azure Virtual Machine Scale Set whenever more compute capacity of is r\", \"equired. It also removes nodes when no longer required.\\n\\nFigure 3-11 shows the relationship between \", \"these two scaling services.\\n\\nFigure 3-11. Scaling out an App Service plan.\\n\\n<!-- image -->\\n\\nWorking \", \"together, both ensure an optimal number of container instances and compute nodes to support fluctuat\", \"ing demand. The horizontal pod autoscaler optimizes the number of pods required. The cluster autosca\", \"ler optimizes the number of nodes required.\\n\\n## Scaling Azure Functions\\n\\nAzure Functions automatical\", \"ly scale out upon demand. Server resources are dynamically allocated and removed based on the number\", \" of triggered events. You're only charged for compute resources consumed when your functions run. Bi\", \"lling is based upon the number of executions, execution time, and memory used.\\n\\nWhile the default co\", \"nsumption plan provides an economical and scalable solution for most apps, the premium option allows\", \" developers flexibility for custom Azure Functions requirements. Upgrading to the premium plan provi\", \"des control over instance sizes, pre-warmed instances (to avoid cold start delays), and dedicated VM\", \"s.\\n\\n## Other container deployment options\\n\\nAside from Azure Kubernetes Service (AKS), you can also d\", \"eploy containers to Azure App Service for Containers and Azure Container Instances.\\n\\n## When does it\", \" make sense to deploy to App Service for Containers?\\n\\nSimple production applications that don't requ\", \"ire orchestration are well suited to Azure App Service for Containers.\\n\\n## How to deploy to App Serv\", \"ice for Containers\\n\\nTo deploy to Azure App Service for Containers , you'll need an Azure Container R\", \"egistry (ACR) instance and credentials to access it. Push your container image to the ACR repository\", \" so that your Azure App Service can pull it when needed. Once complete, you can configure the app fo\", \"r Continuous Deployment. Doing so will automatically deploy updates whenever the image changes in AC\", \"R.\\n\\n## When does it make sense to deploy to Azure Container Instances?\\n\\nAzure Container Instances (A\", \"CI) enables you to run Docker containers in a managed, serverless cloud environment, without having \", \"to set up virtual machines or clusters. It's a great solution for short -running workloads that can \", \"run in an isolated container. Consider ACI for simple services, testing scenarios, task automation, \", \"and build jobs. ACI spins-up a container instance, performs the task, and then spins it down.\\n\\n## Ho\", \"w to deploy an app to Azure Container Instances\\n\\nTo deploy to Azure Container Instances (ACI), you n\", \"eed an Azure Container Registry (ACR) and credentials for accessing it. Once you push your container\", \" image to the repository, it's available to pull into ACI. You can work with ACI using the Azure por\", \"tal or command-line interface. ACR provides tight integration with ACI. Figure 3-12 shows how to pus\", \"h an individual container image to ACR.\\n\\nmyregistry - Repositories\\n\\nContainer registry\\n\\n\\u2022 Search (Ct\", \"ri+/)\\n\\n\\u20ac Overview\\n\\n\\u2022 Activity log iM Access control (IAM)\\n\\nTags\\n\\n&amp; Quick start\\n\\nSETTINGS\\n\\nAccess\", \" keys\\n\\nLocks\\n\\n\\u2022 Automation script\\n\\nSERVICES\\n\\ni Repositories\\n\\n&amp; Webhooks\\n\\nReplications (Preview)\\n\", \"\\nSUPPORT + TROUBLESHOOTING\\n\\n\\u2022 New support request\\n\\n\\u00a9 Refresh\\n\\nO Search to filter repositories ....\\n\\n\", \"Tags myregistry azurecr.io/aci-helloworld\\n\\n\\u00a9 Refresh\\n\\nP Search to filter tags ...\\n\\nFigure 3-12. Azur\", \"e Container Registry Run Instance\\n\\n<!-- image -->\\n\\nCreating an instance in ACI can be done quickly. \", \"Specify the image registry, Azure resource group information, the amount of memory to allocate, and \", \"the port on which to listen. This quickstart shows how to deploy a container instance to ACI using t\", \"he Azure portal.\\n\\nOnce the deployment completes, find the newly deployed container's IP address and \", \"communicate with it over the port you specified.\\n\\nAzure Container Instances offers the fastest way t\", \"o run simple container workloads in Azure. You don't need to configure an app service, orchestrator,\", \" or virtual machine. For scenarios where you require full container orchestration, service discovery\", \", automatic scaling, or coordinated upgrades, we recommend Azure Kubernetes Service (AKS).\\n\\n## Refer\", \"ences\\n\\n- What is Kubernetes?\\n- Installing Kubernetes with Minikube\\n- MiniKube vs Docker Desktop\\n- Vi\", \"sual Studio Tools for Docker\\n\\n* \\u00d7\\n\\n\\u00b7 Understanding serverless cold start \\u00b7 Pre-warmed Azure Function\", \"s instances \\u00b7 Create a function on Linux using a custom image \\u00b7 Run Azure Functions in a Docker Cont\", \"ainer \\u00b7 Create a function on Linux using a custom image \\u00b7 Azure Functions with Kubernetes Event Driv\", \"en Autoscaling \\u00b7 Canary Release \\u00b7 Azure Dev Spaces with VS Code \\u00b7 Azure Dev Spaces with Visual Studi\", \"o \\u00b7 AKS Multiple Node Pools \\u00b7 AKS Cluster Autoscaler \\u00b7 Tutorial: Scale applications in AKS \\u00b7 Azure F\", \"unctions scale and hosting \\u00b7 Azure Container Instances Docs \\u00b7 Deploy Container Instance from ACR\\n\\n##\", \" Cloud-native communication patterns\\n\\nWhen constructing a cloud-native system, communication becomes\", \" a significant design decision. How does a front-end client application communicate with a back-end \", \"microservice? How do back-end microservices communicate with each other? What are the principles, pa\", \"tterns, and best practices to consider when implementing communication in cloud-native applications?\", \"\\n\\n## Communication considerations\\n\\nIn a monolithic application, communication is straightforward. Th\", \"e code modules execute together in the same executable space (process) on a server. This approach ca\", \"n have performance advantages as everything runs together in shared memory, but results in tightly c\", \"oupled code that becomes difficult to maintain, evolve, and scale.\\n\\nCloud-native systems implement a\", \" microservice-based architecture with many small, independent microservices. Each microservice execu\", \"tes in a separate process and typically runs inside a container that is deployed to a cluster .\\n\\nA c\", \"luster groups a pool of virtual machines together to form a highly available environment. They're ma\", \"naged with an orchestration tool, which is responsible for deploying and managing the containerized \", \"microservices. Figure 4-1 shows a Kubernetes cluster deployed into the Azure cloud with the fully ma\", \"naged Azure Kubernetes Services.\\n\\nKubernetes\\n\\nNode\\n\\nNode\\n\\nMaster Node\\n\\nDNS\\n\\nScheduler\\n\\nFigure 4-1. A\", \" Kubernetes cluster in Azure\\n\\n<!-- image -->\\n\\nAcross the cluster, microservices communicate with eac\", \"h other through APIs and messaging technologies.\\n\\nWhile they provide many benefits, microservices ar\", \"e no free lunch. Local in-process method calls between components are now replaced with network call\", \"s. Each microservice must communicate over a network protocol, which adds complexity to your system:\", \"\\n\\n- Network congestion, latency, and transient faults are a constant concern.\\n- Resiliency (that is,\", \" retrying failed requests) is essential.\\n- Some calls must be idempotent as to keep consistent state\", \".\\n- Each microservice must authenticate and authorize calls.\\n- Each message must be serialized and t\", \"hen deserialized - which can be expensive.\\n- Message encryption/decryption becomes important.\\n\\nThe b\", \"ook .NET Microservices: Architecture for Containerized .NET Applications, available for free from Mi\", \"crosoft, provides an in-depth coverage of communication patterns for microservice applications. In t\", \"his chapter, we provide a high-level overview of these patterns along with implementation options av\", \"ailable in the Azure cloud.\\n\\nIn this chapter, we'll first address communication between front -end a\", \"pplications and back-end microservices. We'll then look at back -end microservices communicate with \", \"each other. We'll explore\\n\\nClient apps\\n\\nMobile app\\n\\nWeb app\\n\\nMicroservice 1\\n\\nWeb API\\n\\nthe up and gRP\", \"C communication technology. Finally, we'll look new innovative communication patterns using service \", \"mesh technology. We'll also see how the Azure cloud provides different kinds of backing services to \", \"support cloud-native communication.\\n\\nMicroservice 2\\n\\nWeb API\\n\\n## Front-end client communication\\n\\nIn \", \"a cloud-native system, front-end clients (mobile, web, and desktop applications) require a communica\", \"tion channel to interact with independent back-end microservices.\\n\\n## What are the options?\\n\\nCloud c\", \"ontainer\\n\\nTo keep things simple, a front-end client could directly communicate with the back-end mic\", \"roservices, shown in Figure 4-2.\\n\\nFigure 4-2. Direct client to service communication\\n\\n<!-- image -->\", \"\\n\\nWith this approach, each microservice has a public endpoint that is accessible by front-end client\", \"s. In a production environment, you'd place a load balancer in front of the microservices, routing t\", \"raffic proportionately.\\n\\nWhile simple to implement, direct client communication would be acceptable \", \"only for simple microservice applications. This pattern tightly couples front-end clients to core ba\", \"ck-end services, opening the door for many problems, including:\\n\\n- Client susceptibility to back-end\", \" service refactoring.\\n- A wider attack surface as core back-end services are directly exposed.\\n- Dup\", \"lication of cross-cutting concerns across each microservice.\\n- Overly complex client code - clients \", \"must keep track of multiple endpoints and handle failures in a resilient way.\\n\\nJSON\\n\\nInstead, a wide\", \"ly accepted cloud design pattern is to implement an API Gateway Service between the front-end applic\", \"ations and back-end services. The pattern is shown in Figure 4-3.\\n\\nJavaScript/Angular.js\\n\\nTraditiona\", \"l web app\\n\\nBrowser\\n\\nHTML\\n\\nFigure 4-3. API gateway pattern\\n\\n<!-- image -->\\n\\nIn the previous figure, n\", \"ote how the API Gateway service abstracts the back-end core microservices. Implemented as a web API,\", \" it acts as a reverse proxy , routing incoming traffic to the internal microservices.\\n\\nThe gateway i\", \"nsulates the client from internal service partitioning and refactoring. If you change a backend serv\", \"ice, you accommodate for it in the gateway without breaking the client. It's also your first line of\", \" defense for cross-cutting concerns, such as identity, caching, resiliency, metering, and throttling\", \". Many of these cross-cutting concerns can be off-loaded from the back-end core services to the gate\", \"way, simplifying the back-end services.\\n\\nCare must be taken to keep the API Gateway simple and fast.\", \" Typically, business logic is kept out of the gateway. A complex gateway risks becoming a bottleneck\", \" and eventually a monolith itself. Larger systems often expose multiple API Gateways segmented by cl\", \"ient type (mobile, web, desktop) or back-end functionality. The Backend for Frontends pattern provid\", \"es direction for implementing multiple gateways. The pattern is shown in Figure 4-4.\\n\\n-\\n\\nCloud\\n\\nMicr\", \"oservice 1\\n\\nWeb API\\n\\nWeb app\\n\\nMobile app\\n\\nDesktop app\\n\\nI Cloud\\n\\nWeb app\\n\\n(Microservice 1\\n\\nWeb AP!\\n\\n<\", \"!-- image -->\\n\\nHTML\\n\\nJSON\\n\\nJSON\\n\\nFigure 4-4. Backend for frontend pattern\\n\\nNote in the previous figu\", \"re how incoming traffic is sent to a specific API gateway - based upon client type: web, mobile, or \", \"desktop app. This approach makes sense as the capabilities of each device differ significantly acros\", \"s form factor, performance, and display limitations. Typically mobile applications expose less funct\", \"ionality than a browser or desktop applications. Each gateway can be optimized to match the capabili\", \"ties and functionality of the corresponding device.\\n\\n## Simple Gateways\\n\\nTo start, you could build y\", \"our own API Gateway service. A quick search of GitHub will provide many examples.\\n\\nFor simple .NET c\", \"loud-native applications, you might consider the Ocelot Gateway. Open source and created for .NET mi\", \"croservices, it's lightweight, fast, scalable. Like any API Gateway, its primary functionality is to\", \" forward incoming HTTP requests to downstream services. Additionally, it supports a wide variety of \", \"capabilities that are configurable in a .NET middleware pipeline.\\n\\nYARP (Yet Another Reverse proxy) \", \"is another open source reverse proxy led by a group of Microsoft product teams. Downloadable as a Nu\", \"Get package, YARP plugs into the ASP.NET framework as middleware and is highly customizable. You'll \", \"find YARP well-documented with various usage examples.\\n\\nFor enterprise cloud-native applications, th\", \"ere are several managed Azure services that can help jump-start your efforts.\\n\\nAPI gateway\\n\\nFront-En\", \"d\\n\\nClient\\n\\nCloud\\n\\n## Azure Application Gateway\\n\\nMicroservice 1\\n\\nWeb API\\n\\ncontainer\\n\\nFor simple gatew\", \"ay requirements, you may consider Azure Application Gateway. Available as an Azure PaaS service, it \", \"includes basic gateway features such as URL routing, SSL termination, and a Web Application Firewall\", \". The service supports Layer-7 load balancing capabilities. With Layer 7, you can route requests bas\", \"ed on the actual content of an HTTP message, not just low-level TCP network packets. Microservice 3\\n\", \"\\nWeb AP!\\n\\nThroughout this book, we evangelize hosting cloud-native systems in Kubernetes. A containe\", \"r orchestrator, Kubernetes automates the deployment, scaling, and operational concerns of containeri\", \"zed workloads. Azure Application Gateway can be configured as an API gateway for Azure Kubernetes Se\", \"rvice cluster.\\n\\nThe Application Gateway Ingress Controller enables Azure Application Gateway to work\", \" directly with Azure Kubernetes Service. Figure 4.5 shows the architecture.\\n\\nFigure 4-5. Application\", \" Gateway Ingress Controller\\n\\n<!-- image -->\\n\\nKubernetes includes a built-in feature that supports HT\", \"TP (Level 7) load balancing, called Ingress. Ingress defines a set of rules for how microservice ins\", \"tances inside AKS can be exposed to the outside world. In the previous image, the ingress controller\", \" interprets the ingress rules configured for the cluster and automatically configures the Azure Appl\", \"ication Gateway. Based on those rules, the Application Gateway routes traffic to microservices runni\", \"ng inside AKS. The ingress controller listens for changes to ingress rules and makes the appropriate\", \" changes to the Azure Application Gateway.\\n\\n## Azure API Management\\n\\nFor moderate to large-scale clo\", \"ud-native systems, you may consider Azure API Management . It's a cloud-based service that not only \", \"solves your API Gateway needs, but provides a full-featured developer and administrative experience.\", \" API Management is shown in Figure 4-6.\\n\\nAzure Kubernetes\\n\\nService Cluster\\n\\nDevelopers\\n\\nApplications\", \"\\n\\nAdministrators\\n\\nI Cloud\\n\\nFigure 4-6. Azure API Management\\n\\n<!-- image -->\\n\\nTo start, API Managemen\", \"t exposes a gateway server that allows controlled access to back-end services based upon configurabl\", \"e rules and policies. These services can be in the Azure cloud, your on-prem data center, or other p\", \"ublic clouds. API keys and JWT tokens determine who can do what. All traffic is logged for analytica\", \"l purposes.\\n\\nFor developers, API Management offers a developer portal that provides access to servic\", \"es, documentation, and sample code for invoking them. Developers can use Swagger/Open API to inspect\", \" service endpoints and analyze their usage. The service works across the major development platforms\", \": .NET, Java, Golang, and more.\\n\\nThe publisher portal exposes a management dashboard where administr\", \"ators expose APIs and manage their behavior. Service access can be granted, service health monitored\", \", and service telemetry gathered. Administrators apply policies to each endpoint to affect behavior.\", \" Policies are pre-built statements that execute sequentially for each service call. Policies are con\", \"figured for an inbound call, outbound call, or invoked upon an error. Policies can be applied at dif\", \"ferent service scopes as to enable deterministic ordering when combining policies. The product ships\", \" with a large number of prebuilt policies.\\n\\nHere are examples of how policies can affect the behavio\", \"r of your cloud-native services:\\n\\n- Restrict service access.\\n- Enforce authentication.\\n- Throttle ca\", \"lls from a single source, if necessary.\\n- Enable caching.\\n- Block calls from specific IP addresses.\\n\", \"\\n- Control the flow of the service.\\n- Convert requests from SOAP to REST or between different data f\", \"ormats, such as from XML to JSON.\\n\\nAzure API Management can expose back-end services that are hosted\", \" anywhere -in the cloud or your data center. For legacy services that you may expose in your cloud-n\", \"ative systems, it supports both REST and SOAP APIs. Even other Azure services can be exposed through\", \" API Management. You could place a managed API on top of an Azure backing service like Azure Service\", \" Bus or Azure Logic Apps. Azure API Management doesn't include built -in load-balancing support and \", \"should be used in conjunction with a load-balancing service.\\n\\nAzure API Management is available acro\", \"ss four different tiers:\\n\\n- Developer\\n- Basic\\n- Standard\\n- Premium\\n\\nThe Developer tier is meant for \", \"non-production workloads and evaluation. The other tiers offer progressively more power, features, a\", \"nd higher service level agreements (SLAs). The Premium tier provides Azure Virtual Network and multi\", \"-region support. All tiers have a fixed price per hour.\\n\\nThe Azure cloud also offers a serverless ti\", \"er for Azure API Management. Referred to as the consumption pricing tier , the service is a variant \", \"of API Management designed around the serverless computing model. Unlike the 'pre -allocated' pricin\", \"g tiers previously shown, the consumption tier provides instant provisioning and pay-per-action pric\", \"ing.\\n\\nIt enables API Gateway features for the following use cases:\\n\\n- Microservices implemented usin\", \"g serverless technologies such as Azure Functions and Azure Logic Apps.\\n- Azure backing service reso\", \"urces such as Service Bus queues and topics, Azure storage, and others.\\n- Microservices where traffi\", \"c has occasional large spikes but remains low most the time.\\n\\nThe consumption tier uses the same und\", \"erlying service API Management components, but employs an entirely different architecture based on d\", \"ynamically allocated resources. It aligns perfectly with the serverless computing model:\\n\\n- No infra\", \"structure to manage.\\n- No idle capacity.\\n- High-availability.\\n- Automatic scaling.\\n- Cost is based o\", \"n actual usage.\\n\\nThe new consumption tier is a great choice for cloud-native systems that expose ser\", \"verless resources as APIs.\\n\\n## Real-time communication\\n\\nReal-time, or push, communication is another\", \" option for front-end applications that communicate with back-end cloud-native systems over HTTP. Ap\", \"plications, such as financial-tickers, online education, gaming, and job-progress updates, require i\", \"nstantaneous, real-time responses from the backend. With normal HTTP communication, there's no way f\", \"or the client to know when new data is available. The client must continually poll or send requests \", \"to the server. With real-time communication, the server can push new data to the client at any time.\", \"\\n\\nReal-time systems are often characterized by high-frequency data flows and large numbers of concur\", \"rent client connections. Manually implementing real-time connectivity can quickly become complex, re\", \"quiring non-trivial infrastructure to ensure scalability and reliable messaging to connected clients\", \". You could find yourself managing an instance of Azure Redis Cache and a set of load balancers conf\", \"igured with sticky sessions for client affinity.\\n\\nAzure SignalR Service is a fully managed Azure ser\", \"vice that simplifies real-time communication for your cloud-native applications. Technical implement\", \"ation details like capacity provisioning, scaling, and persistent connections are abstracted away. T\", \"hey're handled for you with a 99.9% service-level agreement. You focus on application features, not \", \"infrastructure plumbing.\\n\\nOnce enabled, a cloud-based HTTP service can push content updates directly\", \" to connected clients, including browser, mobile and desktop applications. Clients are updated witho\", \"ut the need to poll the server. Azure SignalR abstracts the transport technologies that create real-\", \"time connectivity, including WebSockets, Server-Side Events, and Long Polling. Developers focus on s\", \"ending messages to all or specific subsets of connected clients.\\n\\nFigure 4-7 shows a set of HTTP Cli\", \"ents connecting to a Cloud-native application with Azure SignalR enabled.\\n\\nClient 1 SPA Web app\\n\\nJav\", \"aScript/Angular.js\\n\\nClient 2 SPA Web app\\n\\nJavaScript/Angular.js\\n\\nClient 3 SPA Web app\\n\\nJavaScript/An\", \"gular.js\\n\\n\\u2022 Cloud\\n\\nFigure 4-7. Azure SignalR\\n\\n<!-- image -->\\n\\nAnother advantage of Azure SignalR Ser\", \"vice comes with implementing Serverless cloud-native services. Perhaps your code is executed on dema\", \"nd with Azure Functions triggers. This scenario can be tricky because your code doesn't maintain lon\", \"g connections with clients. Azure SignalR Service can handle this situation since the service alread\", \"y manages connections for you.\\n\\nAzure SignalR Service closely integrates with other Azure services, \", \"such as Azure SQL Database, Service Bus, or Redis Cache, opening up many possibilities for your clou\", \"d-native applications.\\n\\n## Service-to-service communication\\n\\nMoving from the front-end client, we no\", \"w address back-end microservices communicate with each other.\\n\\nWhen constructing a cloudnative appli\", \"cation, you'll want to be sensitive to how back -end services communicate with each other. Ideally, \", \"the less inter-service communication, the better. However, avoidance isn't always possible as back-e\", \"nd services often rely on one another to complete an operation.\\n\\nThere are several widely accepted a\", \"pproaches to implementing cross-service communication. The type of communication interaction will of\", \"ten determine the best approach.\\n\\nConsider the following interaction types:\\n\\n- Query -when a calling\", \" microservice requires a response from a called microservice, such as, 'Hey, give me the buyer infor\", \"mation for a given customer Id.'\\n\\nMobile app\\n\\nSPA web app\\n\\n/ Cloud\\n\\n## Queries\\n\\n(Product Catalog\\n\\nMi\", \"croservice\\n\\n- Command -when the calling microservice needs another microservice to execute an action\", \" but doesn't require a response, such as, 'Hey, just ship this order.'\\n- Event -when a microservice,\", \" called the publisher, raises an event that state has changed or an action has occurred. Other micro\", \"services, called subscribers, who are interested, can react to the event appropriately. The publishe\", \"r and the subscribers aren't awar e of each other.\\n\\nMicroservice systems typically use a combination\", \" of these interaction types when executing operations that require crossservice interaction. Let's t\", \"ake a close look at each and how you might implement them.\\n\\nPricing\\n\\nMicroservice\\n\\nMany times, one m\", \"icroservice might need to query another, requiring an immediate response to complete an operation. A\", \" shopping basket microservice may need product information and a price to add an item to its basket.\", \" There are many approaches for implementing query operations.\\n\\n## Request/Response Messaging\\n\\nOne op\", \"tion for implementing this scenario is for the calling back-end microservice to make direct HTTP req\", \"uests to the microservices it needs to query, shown in Figure 4-8.\\n\\nFigure 4-8. Direct HTTP communic\", \"ation\\n\\n<!-- image -->\\n\\nWhile direct HTTP calls between microservices are relatively simple to implem\", \"ent, care should be taken to minimize this practice. To start, these calls are always synchronous an\", \"d will block the operation until a result is returned or the request times outs. What were once self\", \"-contained, independent services, able to evolve independently and deploy frequently, now become cou\", \"pled to each other. As coupling among microservices increase, their architectural benefits diminish.\", \"\\n\\nMobile app\\n\\nJSON\\n\\nSPA web app\\n\\nJSON\\n\\nJavaScript/Angularjs\\n\\nAdd\\n\\nItem http://\\n\\nExecuting an infrequ\", \"ent request that makes a single direct HTTP call to another microservice might be acceptable for som\", \"e systems. However, high-volume calls that invoke direct HTTP calls to multiple microservices aren't\", \" advisable. They can increase latenc y and negatively impact the performance, scalability, and avail\", \"ability of your system. Even worse, a long series of direct HTTP communication can lead to deep and \", \"complex chains of synchronous microservices calls, shown in Figure 4-9:\\n\\nFigure 4-9. Chaining HTTP q\", \"ueries\\n\\n<!-- image -->\\n\\nYou can certainly imagine the risk in the design shown in the previous image\", \". What happens if Step #3 fails? Or Step #8 fails? How do you recover? What if Step #6 is slow becau\", \"se the underlying service is busy? How do you continue? Even if all works correctly, think of the la\", \"tency this call would incur, which is the sum of the latency of each step.\\n\\nThe large degree of coup\", \"ling in the previous image suggests the services weren't optimally modeled. It would behoove the tea\", \"m to revisit their design.\\n\\n## Materialized View pattern\\n\\nA popular option for removing microservice\", \" coupling is the Materialized View pattern. With this pattern, a microservice stores its own local, \", \"denormalized copy of data that's owned by other services. Instead of the Shopping Basket microservic\", \"e querying the Product Catalog and Pricing microservices, it maintains its own local copy of that da\", \"ta. This pattern eliminates unnecessary coupling and improves reliability and response time. The ent\", \"ire operation executes inside a single process. We explore this pattern and other data concerns in C\", \"hapter 5.\\n\\n## Service Aggregator Pattern\\n\\nAnother option for eliminating microservice-to-microservic\", \"e coupling is an Aggregator microservice, shown in purple in Figure 4-10.\\n\\n\\u0413\\n\\nCloud\\n\\n- -\\n\\nAPI Gatewa\", \"y\\n\\n1\\n\\nShopping Basket\\n\\nMicroservice\\n\\nMobile app\\n\\nSPA web app\\n\\nJavaScript/Angular.js\\n\\nProduct Lookup \", \"http:/l\\n\\nProduct Catalog\\n\\nMicroservice\\n\\nFigure 4-10. Aggregator microservice\\n\\n<!-- image -->\\n\\nThe pa\", \"ttern isolates an operation that makes calls to multiple back-end microservices, centralizing its lo\", \"gic into a specialized microservice. The purple checkout aggregator microservice in the previous fig\", \"ure orchestrates the workflow for the Checkout operation. It includes calls to several back-end micr\", \"oservices in a sequenced order. Data from the workflow is aggregated and returned to the caller. Whi\", \"le it still implements direct HTTP calls, the aggregator microservice reduces direct dependencies am\", \"ong back-end microservices.\\n\\n## Request/Reply Pattern\\n\\nAnother approach for decoupling synchronous H\", \"TTP messages is a Request-Reply Pattern, which uses queuing communication. Communication using a que\", \"ue is always a one-way channel, with a producer sending the message and consumer receiving it. With \", \"this pattern, both a request queue and response queue are implemented, shown in Figure 4-11.\\n\\n| Clou\", \"d\\n\\nCheckout\\n\\n\\u0413\\n\\nCloud\\n\\nAPI Gateway\\n\\nService\\n\\nRequest Message\\n\\nProduct Id = 557\\n\\nFigure 4-11. Request\", \"-reply pattern\\n\\n<!-- image -->\\n\\nHere, the message producer creates a query-based message that contai\", \"ns a unique correlation ID and places it into a request queue. The consuming service dequeues the me\", \"ssages, processes it and places the response into the response queue with the same correlation ID. T\", \"he producer service dequeues the message, matches it with the correlation ID and continues processin\", \"g. We cover queues in detail in the next section.\\n\\n## Commands\\n\\nAnother type of communication intera\", \"ction is a command . A microservice may need another microservice to perform an action. The Ordering\", \" microservice may need the Shipping microservice to create a shipment for an approved order. In Figu\", \"re 4-12, one microservice, called a Producer, sends a message to another microservice, the Consumer,\", \" commanding it to do something.\\n\\nhoppingBasket Microservice \\\\\\n\\nCloud\\n\\nAPI Gateway\\n\\nService\\n\\nFigure 4\", \"-12. Command interaction with a queue\\n\\n<!-- image -->\\n\\nMost often, the Producer doesn't require a re\", \"sponse and can fire-and-forget the message. If a reply is needed, the Consumer sends a separate mess\", \"age back to Producer on another channel. A command message is best sent asynchronously with a messag\", \"e queue. supported by a lightweight message broker. In the previous diagram, note how a queue separa\", \"tes and decouples both services.\\n\\nA message queue is an intermediary construct through which a produ\", \"cer and consumer pass a message. Queues implement an asynchronous, point-to-point messaging pattern.\", \" The Producer knows where a command needs to be sent and routes appropriately. The queue guarantees \", \"that a message is processed by exactly one of the consumer instances that are reading from the chann\", \"el. In this scenario, either the producer or consumer service can scale out without affecting the ot\", \"her. As well, technologies can be disparate on each side, meaning that we might have a Java microser\", \"vice calling a Golang microservice.\\n\\nIn chapter 1, we talked about backing services . Backing servic\", \"es are ancillary resources upon which cloud-native systems depend. Message queues are backing servic\", \"es. The Azure cloud supports two types of message queues that your cloud-native systems can consume \", \"to implement command messaging: Azure Storage Queues and Azure Service Bus Queues.\\n\\n## Azure Storage\", \" Queues\\n\\nAzure storage queues offer a simple queueing infrastructure that is fast, affordable, and b\", \"acked by Azure storage accounts.\\n\\nAzure Storage Queues feature a REST-based queuing mechanism with r\", \"eliable and persistent messaging. They provide a minimal feature set, but are inexpensive and store \", \"millions of messages. Their capacity ranges up to 500 TB. A single message can be up to 64 KB in siz\", \"e.\\n\\nYou can access messages from anywhere in the world via authenticated calls using HTTP or HTTPS. \", \"Storage queues can scale out to large numbers of concurrent clients to handle traffic spikes.\\n\\nQueue\", \" 1\\n\\nThat said, there are limitations with the service:\\n\\n- Message order isn't guaranteed.\\n\\nQueue 2\\n\\n\", \"- A message can only persist for seven days before it's automatically removed.\\n- Support for state m\", \"anagement, duplicate detection, or transactions isn't available.\\n\\nFigure 4-13 shows the hierarchy of\", \" an Azure Storage Queue.\\n\\nFigure 4-13. Storage queue hierarchy\\n\\n<!-- image -->\\n\\nIn the previous figu\", \"re, note how storage queues store their messages in the underlying Azure Storage account.\\n\\nFor devel\", \"opers, Microsoft provides several client and server-side libraries for Storage queue processing. Mos\", \"t major platforms are supported including .NET, Java, JavaScript, Ruby, Python, and Go. Developers s\", \"hould never communicate directly with these libraries. Doing so will tightly couple your microservic\", \"e code to the Azure Storage Queue service. It's a better practice to insulate the implementation det\", \"ails of the API. Introduce an intermediation layer, or intermediate API, that exposes generic operat\", \"ions and encapsulates the concrete library. This loose coupling enables you to swap out one queuing \", \"service for another without having to make changes to the mainline service code.\\n\\nAzure Storage queu\", \"es are an economical option to implement command messaging in your cloudnative applications. Especia\", \"lly when a queue size will exceed 80 GB, or a simple feature set is acceptable. You only pay for the\", \" storage of the messages; there are no fixed hourly charges.\\n\\n## Azure Service Bus Queues\\n\\nFor more \", \"complex messaging requirements, consider Azure Service Bus queues.\\n\\nSitting atop a robust message in\", \"frastructure, Azure Service Bus supports a brokered messaging model . Messages are reliably stored i\", \"n a broker (the queue) until received by the consumer. The queue guarantees First-In/First-Out (FIFO\", \") message delivery, respecting the order in which messages were added to the queue.\\n\\nThe size of a m\", \"essage can be much larger, up to 256 KB. Messages are persisted in the queue for an unlimited period\", \" of time. Service Bus supports not only HTTP-based calls, but also provides full\\n\\nMessage 1\\n\\nMessage\", \" 2\\n\\nProvider 1\\n\\nsupport for the AMQP protocol. AMQP is an open-standard across vendors that supports\", \" a binary protocol and higher degrees of reliability.\\n\\nService Bus provides a rich set of features, \", \"including transaction support and a duplicate detection feature . The queue guarantees 'at most once\", \" delivery' per message. It automatically discards a message that has already been sent. If a produce\", \"r is in doubt, it can resend the same message, and Service Bus guarantees that only one copy will be\", \" processed. Duplicate detection frees you from having to build additional infrastructure plumbing.\\n\\n\", \"Two more enterprise features are partitioning and sessions. A conventional Service Bus queue is hand\", \"led by a single message broker and stored in a single message store. But, Service Bus Partitioning s\", \"preads the queue across multiple message brokers and message stores. The overall throughput is no lo\", \"nger limited by the performance of a single message broker or messaging store. A temporary outage of\", \" a messaging store doesn't render a partitioned queue unavailable.\\n\\nService Bus Sessions provide a w\", \"ay to group-related messages. Imagine a workflow scenario where messages must be processed together \", \"and the operation completed at the end. To take advantage, sessions must be explicitly enabled for t\", \"he queue and each related messaged must contain the same session ID.\\n\\nHowever, there are some import\", \"ant caveats: Service Bus queues size is limited to 80 GB, which is much smaller than what's availabl\", \"e from store queues. Additionally, Service Bus queues incur a base cost and charge per operation.\\n\\nF\", \"igure 4-14 outlines the high-level architecture of a Service Bus queue.\\n\\nFigure 4-14. Service Bus qu\", \"eue\\n\\n<!-- image -->\\n\\nIn the previous figure, note the point-to-point relationship. Two instances of \", \"the same provider are enqueuing messages into a single Service Bus queue. Each message is consumed b\", \"y only one of three consumer instances on the right. Next, we discuss how to implement messaging whe\", \"re different consumers may all be interested the same message.\\n\\n## Events\\n\\nMessage queuing is an eff\", \"ective way to implement communication where a producer can asynchronously send a consumer a message.\", \" However, what happens when many different consumers\\n\\nService Bus\\n\\nConsumer 1\\n\\n\\u0413\\n\\nCloud\\n\\nAPI Gateway\", \"\\n\\nService\\n\\nOrdering Microservice are interested in the same message? A dedicated message queue for e\", \"ach consumer wouldn't scale well and would become difficult to manage. Checkout Event \\u2192 Create Order\", \"\\n\\nCheckout\\n\\nEvent Bus\\n\\nTo address this scenario, we move to the third type of message interaction, t\", \"he event . One microservice announces that an action had occurred. Other microservices, if intereste\", \"d, react to the action, or event. This is also known as the event-driven architectural style. comman\", \"d\\n\\nService\\n\\nEventing is a two-step process. For a given state change, a microservice publishes an ev\", \"ent to a message broker, making it available to any other interested microservice. The interested mi\", \"croservice is notified by subscribing to the event in the message broker. You use the Publish/Subscr\", \"ibe pattern to implement event-based communication.\\n\\nFigure 4-15 shows a shopping basket microservic\", \"e publishing an event with two other microservices subscribing to it.\\n\\nFigure 4-15. Event-Driven mes\", \"saging\\n\\n<!-- image -->\\n\\nNote the event bus component that sits in the middle of the communication ch\", \"annel. It's a custom class that encapsulates the message broker and decouples it from the underlying\", \" application. The ordering and inventory microservices independently operate the event with no knowl\", \"edge of each other, nor the shopping basket microservice. When the registered event is published to \", \"the event bus, they act upon it.\\n\\nWith eventing, we move from queuing technology to topics . A topic\", \" is similar to a queue, but supports a one-to-many messaging pattern. One microservice publishes a m\", \"essage. Multiple subscribing microservices can choose to receive and act upon that message. Figure 4\", \"-16 shows a topic architecture.\\n\\n4\\n\\nPublisher 1\\n\\nPublisher 2\\n\\n\\\"GetPriceRule\\\"\\n\\nPrice Subscription\\n\\nFi\", \"gure 4-16. Topic architecture\\n\\n<!-- image -->\\n\\nIn the previous figure, publishers send messages to t\", \"he topic. At the end, subscribers receive messages from subscriptions. In the middle, the topic forw\", \"ards messages to subscriptions based on a set of rules, shown in dark blue boxes. Rules act as a fil\", \"ter that forward specific messages to a subscription. Here, a 'GetPrice' event would be sent to the \", \"price and logging subscriptions as the logging subsc ription has chosen to receive all messages. A '\", \"GetInformation' event would be sent to the information and logging subscriptions.\\n\\nThe Azure cloud s\", \"upports two different topic services: Azure Service Bus Topics and Azure EventGrid.\\n\\n## Azure Servic\", \"e Bus Topics\\n\\nSitting on top of the same robust brokered message model of Azure Service Bus queues a\", \"re Azure Service Bus Topics. A topic can receive messages from multiple independent publishers and s\", \"end messages to up to 2,000 subscribers. Subscriptions can be dynamically added or removed at run ti\", \"me without stopping the system or recreating the topic.\\n\\nMany advanced features from Azure Service B\", \"us queues are also available for topics, including Duplicate Detection and Transaction support. By d\", \"efault, Service Bus topics are handled by a single message broker and stored in a single message sto\", \"re. But, Service Bus Partitioning scales a topic by spreading it across many message brokers and mes\", \"sage stores.\\n\\nScheduled Message Delivery tags a message with a specific time for processing. The mes\", \"sage won't appear in the topic before that time. Message Deferral enables you to defer a retrieval o\", \"f a message to a later time. Both are commonly used in workflow processing scenarios where operation\", \"s are processed in a particular order. You can postpone processing of received messages until prior \", \"work has been completed.\\n\\nService Bus topics are a robust and proven technology for enabling publish\", \"/subscribe communication in your cloud-native systems.\\n\\n## Azure Event Grid\\n\\nWhile Azure Service Bus\", \" is a battle-tested messaging broker with a full set of enterprise features, Azure Event Grid is the\", \" new kid on the block.\\n\\nBlob Storage\\n\\nAt first glance, Event Grid may look like just another topicba\", \"sed messaging system. However, it's different in many ways. Focused on event-driven workloads, it en\", \"ables real-time event processing, deep Azure integration, and an open-platform all on serverless inf\", \"rastructure. It's designed for contemporary cloud-native and serverless applications Azure Automatio\", \"n\\n\\nAs a centralized eventing backplane , or pipe, Event Grid reacts to events inside Azure resources\", \" and from your own services. WebHooks\\n\\nEvent notifications are published to an Event Grid Topic, whi\", \"ch, in turn, routes each event to a subscription. Subscribers map to subscriptions and consume the e\", \"vents. Like Service Bus, Event Grid supports a filtered subscriber model where a subscription sets r\", \"ule for the events it wishes to receive. Event Grid provides fast throughput with a guarantee of 10 \", \"million events per second enabling near real-time delivery - far more than what Azure Service Bus ca\", \"n generate.\\n\\nA sweet spot for Event Grid is its deep integration into the fabric of Azure infrastruc\", \"ture. An Azure resource, such as Cosmos DB, can publish built-in events directly to other interested\", \" Azure resources without the need for custom code. Event Grid can publish events from an Azure Subsc\", \"ription, Resource Group, or Service, giving developers fine-grained control over the lifecycle of cl\", \"oud resources. However, Event Grid isn't limited to Azure. It's an open platform that can consume cu\", \"stom HTTP events published from applications or third-party services and route events to external su\", \"bscribers.\\n\\nWhen publishing and subscribing to native events from Azure resources, no coding is requ\", \"ired. With simple configuration, you can integrate events from one Azure resource to another leverag\", \"ing built-in plumbing for Topics and Subscriptions. Figure 4-17 shows the anatomy of Event Grid.\\n\\nFi\", \"gure 4-17. Event Grid anatomy\\n\\n<!-- image -->\\n\\nTopics\\n\\nEvent Subscriptions\\n\\nA major difference betwe\", \"en EventGrid and Service Bus is the underlying message exchange pattern .\\n\\nService Bus implements an\", \" older style pull model in which the downstream subscriber actively polls the topic subscription for\", \" new messages. On the upside, this approach gives the subscriber full control of the pace at which i\", \"t processes messages. It controls when and how many messages to process at any given time. Unread me\", \"ssages remain in the subscription until processed. A significant shortcoming is the latency between \", \"the time the event is generated and the polling operation that pulls that message to the subscriber \", \"for processing. Also, the overhead of constant polling for the next event consumes resources and mon\", \"ey.\\n\\nEventGrid, however, is different. It implements a push model in which events are sent to the Ev\", \"entHandlers as received, giving near real-time event delivery. It also reduces cost as the service i\", \"s triggered only when it's needed to consume an event not continually as with polling. That said, an\", \" event handler must handle the incoming load and provide throttling mechanisms to protect itself fro\", \"m becoming overwhelmed. Many Azure services that consume these events, such as Azure Functions and L\", \"ogic Apps provide automatic autoscaling capabilities to handle increased loads.\\n\\nEvent Grid is a ful\", \"ly managed serverless cloud service. It dynamically scales based on your traffic and charges you onl\", \"y for your actual usage, not pre-purchased capacity. The first 100,000 operations per month are free\", \" -operations being defined as event ingress (incoming event notifications), subscription delivery at\", \"tempts, management calls, and filtering by subject. With 99.99% availability, EventGrid guarantees t\", \"he delivery of an event within a 24-hour period, with built-in retry functionality for unsuc cessful\", \" delivery. Undelivered messages can be moved to a 'dead -letter' queue for resolution. Unlike Azure \", \"Service Bus, Event Grid is tuned for fast performance and doesn't support features like ordered mess\", \"aging, transactions, and sessions.\\n\\n## Streaming messages in the Azure cloud\\n\\nAzure Service Bus and \", \"Event Grid provide great support for applications that expose single, discrete events like a new doc\", \"ument has been inserted into a Cosmos DB. But, what if your cloud-native system needs to process a s\", \"tream of related events ? Event streams are more complex. They're typically time-ordered, interrelat\", \"ed, and must be processed as a group.\\n\\nAzure Event Hub is a data streaming platform and event ingest\", \"ion service that collects, transforms, and stores events. It's fine -tuned to capture streaming data\", \", such as continuous event notifications emitted from a telemetry context. The service is highly sca\", \"lable and can store and process millions of events per second. Shown in Figure 418, it's often a fro\", \"nt door for an event pipeline, decoupling ingest stream from event consumption.\\n\\nEvent\\n\\nProducer\\n\\nEv\", \"ent Producers\\n\\nEvent\\n\\nProducer\\n\\nEvent\\n\\nProducer\\n\\nEvent\\n\\nConsumer\\n\\nAzure Event Hubs\\n\\nPartition 1\\n\\nCon\", \"sumer\\n\\nGroup\\n\\nFigure 4-18. Azure Event Hub\\n\\n<!-- image -->\\n\\nEvent Hub supports low latency and confi\", \"gurable time retention. Unlike queues and topics, Event Hubs keep event data after it's been read by\", \" a consumer. This feature enables other data analytic services, both internal and external, to repla\", \"y the data for further analysis. Events stored in event hub are only deleted upon expiration of the \", \"retention period, which is one day by default, but configurable.\\n\\nEvent Hub supports common event pu\", \"blishing protocols including HTTPS and AMQP. It also supports Kafka 1.0. Existing Kafka applications\", \" can communicate with Event Hub using the Kafka protocol providing an alternative to managing large \", \"Kafka clusters. Many open-source cloud-native systems embrace Kafka.\\n\\nEvent Hubs implements message \", \"streaming through a partitioned consumer model in which each consumer only reads a specific subset, \", \"or partition, of the message stream. This pattern enables tremendous horizontal scale for event proc\", \"essing and provides other stream-focused features that are unavailable in queues and topics. A parti\", \"tion is an ordered sequence of events that is held in an event hub. As newer events arrive, they're \", \"added to the end of this sequence. Figure 4-19 shows partitioning in an Event Hub.\\n\\nFigure 4-19. Eve\", \"nt Hub partitioning\\n\\n<!-- image -->\\n\\nInstead of reading from the same resource, each consumer group \", \"reads across a subset, or partition, of the message stream.\\n\\nEvent\\n\\nEvent Receivers\\n\\nFor cloud-nativ\", \"e applications that must stream large numbers of events, Azure Event Hub can be a robust and afforda\", \"ble solution.\\n\\n## gRPC\\n\\nSo far in this book, we've focused on REST-based communication. We've seen t\", \"hat REST is a flexible architectural style that defines CRUD-based operations against entity resourc\", \"es. Clients interact with resources across HTTP with a request/response communication model. While R\", \"EST is widely implemented, a newer communication technology, gRPC, has gained tremendous momentum ac\", \"ross the cloud-native community.\\n\\n## What is gRPC?\\n\\ngRPC is a modern, high-performance framework tha\", \"t evolves the age-old remote procedure call (RPC) protocol. At the application level, gRPC streamlin\", \"es messaging between clients and back-end services. Originating from Google, gRPC is open source and\", \" part of the Cloud Native Computing Foundation (CNCF) ecosystem of cloud-native offerings. CNCF cons\", \"iders gRPC an incubating project. Incubating means end users are using the technology in production \", \"applications, and the project has a healthy number of contributors.\\n\\nA typical gRPC client app will \", \"expose a local, in-process function that implements a business operation. Under the covers, that loc\", \"al function invokes another function on a remote machine. What appears to be a local call essentiall\", \"y becomes a transparent out-of-process call to a remote service. The RPC plumbing abstracts the poin\", \"t-to-point networking communication, serialization, and execution between computers.\\n\\nIn cloud-nativ\", \"e applications, developers often work across programming languages, frameworks, and technologies. Th\", \"is interoperability complicates message contracts and the plumbing required for crossplatform commun\", \"ication. gRPC provides a 'uniform horizontal layer' that abstracts these concerns. Developers code i\", \"n their native platform focused on business functionality, while gRPC handles communication plumbing\", \".\\n\\ngRPC offers comprehensive support across most popular development stacks, including Java, JavaScr\", \"ipt, C#, Go, Swift, and NodeJS.\\n\\n## gRPC Benefits\\n\\ngRPC uses HTTP/2 for its transport protocol. Whil\", \"e compatible with HTTP 1.1, HTTP/2 features many advanced capabilities:\\n\\n- A binary framing protocol\", \" for data transport - unlike HTTP 1.1, which is text based.\\n- Multiplexing support for sending multi\", \"ple parallel requests over the same connection - HTTP 1.1 limits processing to one request/response \", \"message at a time.\\n- Bidirectional full-duplex communication for sending both client requests and se\", \"rver responses simultaneously.\\n- Built-in streaming enabling requests and responses to asynchronousl\", \"y stream large data sets.\\n- Header compression that reduces network usage.\\n\\ngRPC is lightweight and \", \"highly performant. It can be up to 8x faster than JSON serialization with messages 60-80% smaller. I\", \"n Microsoft Windows Communication Foundation (WCF) parlance, gRPC performance exceeds the speed and \", \"efficiency of the highly optimized NetTCP bindings. Unlike NetTCP, which favors the Microsoft stack,\", \" gRPC is cross-platform.\\n\\n## Protocol Buffers\\n\\ngRPC embraces an open-source technology called Protoc\", \"ol Buffers. They provide a highly efficient and platform-neutral serialization format for serializin\", \"g structured messages that services send to each other. Using a cross-platform Interface Definition \", \"Language (IDL), developers define a service contract for each microservice. The contract, implemente\", \"d as a text-based .proto file, describes the methods, inputs, and outputs for each service. The same\", \" contract file can be used for gRPC clients and services built on different development platforms.\\n\\n\", \"Using the proto file, the Protobuf compiler, protoc, generates both client and service code for your\", \" target platform. The code includes the following components:\\n\\n- Strongly typed objects, shared by t\", \"he client and service, that represent the service operations and data elements for a message.\\n- A st\", \"rongly typed base class with the required network plumbing that the remote gRPC service can inherit \", \"and extend.\\n- A client stub that contains the required plumbing to invoke the remote gRPC service.\\n\\n\", \"At run time, each message is serialized as a standard Protobuf representation and exchanged between \", \"the client and remote service. Unlike JSON or XML, Protobuf messages are serialized as compiled bina\", \"ry bytes.\\n\\nThe book, gRPC for WCF Developers, available from the Microsoft Architecture site, provid\", \"es in-depth coverage of gRPC and Protocol Buffers.\\n\\n## gRPC support in .NET\\n\\ngRPC is integrated into\", \" .NET Core 3.0 SDK and later. The following tools support it:\\n\\n- Visual Studio 2022 with the ASP.NET\", \" and web development workload installed\\n- Visual Studio Code\\n- The dotnet CLI\\n\\nThe SDK includes tool\", \"ing for endpoint routing, built-in IoC, and logging. The open-source Kestrel web server supports HTT\", \"P/2 connections. Figure 4-20 shows a Visual Studio 2022 template that scaffolds a skeleton project f\", \"or a gRPC service. Note how .NET fully supports Windows, Linux, and macOS.\\n\\nSolution Explorer\\n\\nSearc\", \"h Solution Explorer (Ctri+:)\\n\\na Solution 'GrpcServicel\\\" (1 of 1 project)\\n\\nCreate a new project\\n\\n@ Co\", \"nnected Services\\n\\n88 Dependencies\\n\\nRecent project templates\\n\\n5 Properties gic ASP.NET Core gRPC Serv\", \"ice\\n\\n\\u2022 E Protos\\n\\n\\u2022 greet.proto\\n\\nFo ASP.NET Core Web API\\n\\n\\u2022 E Services\\n\\n\\u2022 C# GreeterService.cs\\n\\n\\u2022 app\", \"settings.json\\n\\n\\u203a Azure Functions\\n\\n\\u2022 C# Program.cs\\n\\nFigure 4-20. gRPC support in Visual Studio 2022\\n\\n\", \"<!-- image -->\\n\\nFigure 4-21 shows the skeleton gRPC service generated from the built-in scaffolding \", \"included in Visual Studio 2022.\\n\\nFigure 4-21. gRPC project in Visual Studio 2022\\n\\n<!-- image -->\\n\\nIn\", \" the previous figure, note the proto description file and service code. As you'll see shortly, Visua\", \"l Studio generates additional configuration in both the Startup class and underlying project file.\\n\\n\", \"## gRPC usage\\n\\nFavor gRPC for the following scenarios:\\n\\n- Synchronous backend microservice-to-micros\", \"ervice communication where an immediate response is required to continue processing.\\n- Polyglot envi\", \"ronments that need to support mixed programming platforms.\\n- Low latency and high throughput communi\", \"cation where performance is critical.\\n- Point-to-point real-time communication - gRPC can push messa\", \"ges in real time without polling and has excellent support for bi-directional streaming.\\n\\ngrpc\\n\\nAll \", \"languages\\n\\nP\\n\\nAll platforms\\n\\nAll project types\\n\\nClear all\\n\\nX\\n\\nAPI Gateways / BFF\\n\\n\\\"Shopping\\\"\\n\\n- Netw\", \"ork constrained environments -binary gRPC messages are always smaller than an equivalent text-based \", \"JSON message.\\n\\nAt the time, of this writing, gRPC is primarily used with backend services. Modern br\", \"owsers can't provide the level of HTTP/2 control required to support a frontend gRPC client. That sa\", \"id, there's support for gRPC-Web with .NET that enables gRPC communication from browser-based apps b\", \"uilt with JavaScript or Blazor WebAssembly technologies. gRPC-Web enables an ASP.NET Core gRPC app t\", \"o support gRPC features in browser apps:\\n\\n- Strongly typed, code-generated clients\\n- Compact Protobu\", \"f messages\\n- Server streaming\\n\\n## gRPC implementation\\n\\n\\\"Marketing\\\"\\n\\nmicroservices\\n\\nThe microservice \", \"reference architecture, eShop on Containers, from Microsoft, shows how to implement gRPC services in\", \" .NET applications. Figure 4-22 presents the back-end architecture.\\n\\nWeb-Marketing\\n\\nFigure 4-22. Bac\", \"kend architecture for eShop on Containers\\n\\n<!-- image -->\\n\\nIn the previous figure, note how eShop em\", \"braces the Backend for Frontends pattern (BFF) by exposing multiple API gateways. We discussed the B\", \"FF pattern earlier in this chapter. Pay close\\n\\nCloud\\n\\nHTTP/2\\n\\n--'GRPG\\n\\ngRPC\\n\\nServer\\n\\nOrdering\\n\\nMicro\", \"service attention to the Aggregator microservice (in gray) that sits between the Web-Shopping API Ga\", \"teway and backend Shopping microservices. The Aggregator receives a single request from a client, di\", \"spatches it to various microservices, aggregates the results, and sends them back to the requesting \", \"client. Such operations typically require synchronous communication as to produce an immediate respo\", \"nse. In eShop, backend calls from the Aggregator are performed using gRPC as shown in Figure 4-23.\\n\\n\", \"Microservice\\n\\nFigure 4-23. gRPC in eShop on Containers\\n\\n<!-- image -->\\n\\ngRPC communication requires \", \"both client and server components. In the previous figure, note how the Shopping Aggregator implemen\", \"ts a gRPC client. The client makes synchronous gRPC calls (in red) to backend microservices, each of\", \" which implement a gRPC server. Both the client and server take advantage of the built-in gRPC plumb\", \"ing from the .NET SDK. Client-side stubs provide the plumbing to invoke remote gRPC calls. Server-si\", \"de components provide gRPC plumbing that custom service classes can inherit and consume.\\n\\nMicroservi\", \"ces that expose both a RESTful API and gRPC communication require multiple endpoints to manage traff\", \"ic. You would open an endpoint that listens for HTTP traffic for the RESTful calls and another for g\", \"RPC calls. The gRPC endpoint must be configured for the HTTP/2 protocol that is required for gRPC co\", \"mmunication.\\n\\nWhile we strive to decouple microservices with asynchronous communication patterns, so\", \"me operations require direct calls. gRPC should be the primary choice for direct synchronous communi\", \"cation between microservices. Its high-performance communication protocol, based on HTTP/2 and proto\", \"col buffers, make it a perfect choice.\\n\\nCloud\\n\\nSidecar Proxy\\n\\nHTTP\\n\\n## Looking ahead\\n\\nMicroservice\\n\\n\", \"Sidecar Proxy\\n\\nMicroservice\\n\\nSidecar Proxy\\n\\nMicroservice\\n\\nLooking ahead, gRPC will continue to gain \", \"traction for cloud-native systems. The performance benefits and ease of development are compelling. \", \"However, REST will likely be around for a long time. It excels for publicly exposed APIs and for bac\", \"kward compatibility reasons.\\n\\nSidecar Proxy\\n\\nSidecar Proxy\\n\\nSidecar Proxy\\n\\n## Service Mesh communica\", \"tion infrastructure\\n\\nThroughout this chapter, we've explored the challenges of microservice communic\", \"ation. We said that development teams need to be sensitive to how back-end services communicate with\", \" each other. Ideally, the less interservice communication, the better. However, avoidance isn't alwa\", \"ys possible as back-end services often rely on one another to complete operations.\\n\\nWe explored diff\", \"erent approaches for implementing synchronous HTTP communication and asynchronous messaging. In each\", \" of the cases, the developer is burdened with implementing communication code. Communication code is\", \" complex and time intensive. Incorrect decisions can lead to significant performance issues.\\n\\nA more\", \" modern approach to microservice communication centers around a new and rapidly evolving technology \", \"entitled Service Mesh . A service mesh is a configurable infrastructure layer with built-in capabili\", \"ties to handle service-to-service communication, resiliency, and many cross-cutting concerns. It mov\", \"es the responsibility for these concerns out of the microservices and into service mesh layer. Commu\", \"nication is abstracted away from your microservices.\\n\\nA key component of a service mesh is a proxy. \", \"In a cloud-native application, an instance of a proxy is typically colocated with each microservice.\", \" While they execute in separate processes, the two are closely linked and share the same lifecycle. \", \"This pattern, known as the Sidecar pattern, and is shown in Figure 4-24.\\n\\nFigure 4-24. Service mesh \", \"with a side car\\n\\n<!-- image -->\\n\\ngRPC\\n\\nNote in the previous figure how messages are intercepted by a\", \" proxy that runs alongside each microservice. Each proxy can be configured with traffic rules specif\", \"ic to the microservice. It understands messages and can route them across your services and the outs\", \"ide world.\\n\\nAlong with managing service-to-service communication, the Service Mesh provides support \", \"for service discovery and load balancing.\\n\\nOnce configured, a service mesh is highly functional. The\", \" mesh retrieves a corresponding pool of instances from a service discovery endpoint. It sends a requ\", \"est to a specific service instance, recording the latency and response type of the result. It choose\", \"s the instance most likely to return a fast response based on different factors, including the obser\", \"ved latency for recent requests.\\n\\nA service mesh manages traffic, communication, and networking conc\", \"erns at the application level. It understands messages and requests. A service mesh typically integr\", \"ates with a container orchestrator. Kubernetes supports an extensible architecture in which a servic\", \"e mesh can be added.\\n\\nIn chapter 6, we deep-dive into Service Mesh technologies including a discussi\", \"on on its architecture and available open-source implementations.\\n\\n## Summary\\n\\nIn this chapter, we d\", \"iscussed cloud-native communication patterns. We started by examining how front-end clients communic\", \"ate with back-end microservices. Along the way, we talked about API Gateway platforms and real-time \", \"communication. We then looked at how microservices communicate with other back-end services. We look\", \"ed at both synchronous HTTP communication and asynchronous messaging across services. We covered gRP\", \"C, an upcoming technology in the cloudnative world. Finally, we introduced a new and rapidly evolvin\", \"g technology entitled Service Mesh that can streamline microservice communication.\\n\\nSpecial emphasis\", \" was on managed Azure services that can help implement communication in cloudnative systems:\\n\\n- Azur\", \"e Application Gateway\\n- Azure API Management\\n- Azure SignalR Service\\n- Azure Storage Queues\\n- Azure \", \"Service Bus\\n- Azure Event Grid\\n- Azure Event Hub\\n\\nWe next move to distributed data in cloud-native s\", \"ystems and the benefits and challenges that it presents.\\n\\n## References\\n\\n- .NET Microservices: Archi\", \"tecture for Containerized .NET applications\\n- Designing Interservice Communication for Microservices\", \"\\n- Azure SignalR Service, a fully managed service to add real-time functionality\\n\\n- Azure API Gatewa\", \"y Ingress Controller\\n- gRPC Documentation\\n- gRPC for WCF Developers\\n- Comparing gRPC Services with H\", \"TTP APIs\\n- Building gRPC Services with .NET video\\n\\nMonolithic Application\\n\\nMy Web Application\\n\\nWeb A\", \"pps\\n\\nMobile Apps\\n\\nCloud-Native Application ty Web Application\\n\\nWeb Apps\\n\\nMobile Apps\\n\\n## Cloud-nativ\", \"e data patterns\\n\\nService\\n\\nService\\n\\nService\\n\\nAs we've seen throughout this book, a cloud -native appr\", \"oach changes the way you design, deploy, and manage applications. It also changes the way you manage\", \" and store data.\\n\\nFigure 5-1 contrasts the differences.\\n\\nData Store\\n\\nSingle, shared database\\n\\nData S\", \"tore\\n\\nData Store\\n\\nFigure 5-1. Data management in cloud-native applications\\n\\n<!-- image -->\\n\\n<!-- ima\", \"ge -->\\n\\nExperienced developers will easily recognize the architecture on the left-side of figure 5-1\", \". In this monolithic application , business service components collocate together in a shared servic\", \"es tier, sharing data from a single relational database.\\n\\nIn many ways, a single database keeps data\", \" management simple. Querying data across multiple tables is straightforward. Changes to data update \", \"together or they all rollback. ACID transactions guarantee strong and immediate consistency.\\n\\nDesign\", \"ing for cloud-native, we take a different approach. On the right-side of Figure 5-1, note how busine\", \"ss functionality segregates into small, independent microservices. Each microservice encapsulates a \", \"specific business capability and its own data. The monolithic database decomposes\\n\\nMicroservice\\n\\nMob\", \"ile app\\n\\nProduct Catalog\\n\\nMicroservice into a distributed data model with many smaller databases, ea\", \"ch aligning with a microservice. When the smoke clears, we emerge with a design that exposes a datab\", \"ase per microservice .\\n\\nJSON\\n\\nSPA web app\\n\\nAPI Gateway\\n\\nOrdering\\n\\n## Database-per-microservice, why?\", \"\\n\\n2\\n\\n3\\n\\nThis database per microservice provides many benefits, especially for systems that must evol\", \"ve rapidly and support massive scale. With this model\\u2026\\n\\n- Domain data is encapsulated within the ser\", \"vice\\n- Data schema can evolve without directly impacting other services\\n- Each data store can indepe\", \"ndently scale\\n- A data store failure in one service won't directly impact other services L\\n\\nSegregat\", \"ing data also enables each microservice to implement the data store type that is best optimized for \", \"its workload, storage needs, and read/write patterns. Choices include relational, document, key-valu\", \"e, and even graph-based data stores.\\n\\nFigure 5-2 presents the principle of polyglot persistence in a\", \" cloud-native system.\\n\\nFigure 5-2. Polyglot data persistence\\n\\n<!-- image -->\\n\\nNote in the previous f\", \"igure how each microservice supports a different type of data store.\\n\\n- The product catalog microser\", \"vice consumes a relational database to accommodate the rich relational structure of its underlying d\", \"ata.\\n- The shopping cart microservice consumes a distributed cache that supports its simple, keyvalu\", \"e data store.\\n- The ordering microservice consumes both a NoSql document database for write operatio\", \"ns along with a highly denormalized key/value store to accommodate high-volumes of read operations.\\n\", \"\\n4\\n\\n{\\n\\n}\\n\\nJavaScript/Angularjs\\n\\nCloud\\n\\nSQL\\n\\n1\\n\\nBasket\\n\\nLineltem owned by\\n\\nProduct\\n\\nWhile relational \", \"databases remain relevant for microservices with complex data, NoSQL databases have gained considera\", \"ble popularity. They provide massive scale and high availability. Their schemaless nature allows dev\", \"elopers to move away from an architecture of typed data classes and ORMs that make change expensive \", \"and time-consuming. We cover NoSQL databases later in this chapter.\\n\\nPrice\\n\\nWhile encapsulating data\", \" into separate microservices can increase agility, performance, and scalability, it also presents ma\", \"ny challenges. In the next section, we discuss these challenges along with patterns and practices to\", \" help overcome them.\\n\\n## Cross-service queries\\n\\nWhile microservices are independent and focus on spe\", \"cific functional capabilities, like inventory, shipping, or ordering, they frequently require integr\", \"ation with other microservices. Often the integration involves one microservice querying another for\", \" data. Figure 5-3 shows the scenario.\\n\\nFigure 5-3. Querying across microservices\\n\\n<!-- image -->\\n\\nIn\", \" the preceding figure, we see a shopping basket microservice that adds an item to a user's shopping \", \"basket. While the data store for this microservice contains basket and line item data, it doesn't ma\", \"intain product or pricing data. Instead, those data items are owned by the catalog and pricing micro\", \"services. This aspect presents a problem. How can the shopping basket microservice add a product to \", \"the user's shopping basket when it doesn't have product nor pricing data in its database?\\n\\nOne optio\", \"n discussed in Chapter 4 is a direct HTTP call from the shopping basket to the catalog and pricing m\", \"icroservices. However, in chapter 4, we said synchronous HTTP calls couple microservices together, r\", \"educing their autonomy and diminishing their architectural benefits.\\n\\nWe could also implement a requ\", \"est-reply pattern with separate inbound and outbound queues for each service. However, this pattern \", \"is complicated and requires plumbing to correlate request and response messages. While it does decou\", \"ple the backend microservice calls, the calling service must still synchronously wait for the call t\", \"o complete. Network congestion, transient faults, or an overloaded microservice and can result in lo\", \"ng-running and even failed operations.\\n\\nBasket\\n\\nLineltem syncs\\n\\nProduct\\n\\nInstead, a widely accepted \", \"pattern for removing cross-service dependencies is the Materialized View Pattern, shown in Figure 5-\", \"4.\\n\\nSynes\\n\\n<!-- image -->\\n\\nProduct/Pricing\\n\\nShopping Basket Service\\n\\nFigure 5-4. Materialized View P\", \"attern\\n\\nWith this pattern, you place a local data table (known as a read model ) in the shopping bas\", \"ket service. This table contains a denormalized copy of the data needed from the product and pricing\", \" microservices. Copying the data directly into the shopping basket microservice eliminates the need \", \"for expensive cross-service calls. With the data local to the service, you improve the service's res\", \"ponse time and reliability. Additionally, having its own copy of the data makes the shopping basket \", \"service more resilien t. If the catalog service should become unavailable, it wouldn't directly impa\", \"ct the shopping basket service. The shopping basket can continue operating with the data from its ow\", \"n store.\\n\\nThe catch with this approach is that you now have duplicate data in your system. However, \", \"strategically duplicating data in cloud-native systems is an established practice and not considered\", \" an anti-pattern, or bad practice. Keep in mind that one and only one service can own a data set and\", \" have authority over it. You'll need to synchronize the read models when the system of record is upd\", \"ated. Synchronization is typically implemented via asynchronous messaging with a publish/subscribe p\", \"attern, as shown in Figure 5.4.\\n\\n## Distributed transactions\\n\\nWhile querying data across microservic\", \"es is difficult, implementing a transaction across several microservices is even more complex. The i\", \"nherent challenge of maintaining data consistency across independent data sources in different micro\", \"services can't be understated. The lack of distributed transactions in cloud-native applications mea\", \"ns that you must manage distributed transactions programmatically. You move from a world of immediat\", \"e consistency to that of eventual consistency .\\n\\nFigure 5-5 shows the problem.\\n\\nOrder\\n\\nOrder\\n\\nServic\", \"e\\n\\nService\\n\\nCreate\\n\\nCreate\\n\\nPending\\n\\nPending\\n\\nOrder\\n\\nOrder\\n\\nComplete\\n\\nOrder\\n\\nCancel\\n\\nOrder\\n\\nComplete\", \"\\n\\nOrder\\n\\nPayment\\n\\nPayment\\n\\nService\\n\\nInventory\\n\\nInventory\\n\\nService\\n\\nShipping\\n\\nShipping\\n\\nService\\n\\nNoti\", \"fication\\n\\nNotification\\n\\nService\\n\\nService\\n\\nService\\n\\nService\\n\\nService\\n\\nFigure 5-5. Implementing a tran\", \"saction across microservices\\n\\n<!-- image -->\\n\\nIn the preceding figure, five independent microservice\", \"s participate in a distributed transaction that creates an order. Each microservice maintains its ow\", \"n data store and implements a local transaction for its store. To create the order, the local transa\", \"ction for each individual microservice must succeed, or all must abort and roll back the operation. \", \"While built-in transactional support is available inside each of the microservices, there's no suppo\", \"rt for a distributed transaction that would span across al l five services to keep data consistent.\\n\", \"\\nInstead, you must construct this distributed transaction programmatically .\\n\\nA popular pattern for \", \"adding distributed transactional support is the Saga pattern. It's implemented by grouping local tra\", \"nsactions together programmatically and sequentially invoking each one. If any of the local transact\", \"ions fail, the Saga aborts the operation and invokes a set of compensating transactions. The compens\", \"ating transactions undo the changes made by the preceding local transactions and restore data consis\", \"tency. Figure 5-6 shows a failed transaction with the Saga pattern.\\n\\nFigure 5-6. Rolling back a tran\", \"saction\\n\\n<!-- image -->\\n\\nUser\\n\\nInterface\\n\\nCommand\\n\\nCommand\\n\\nModel\\n\\nWrite Store\\n\\n(Tables)\\n\\nIn the pre\", \"vious figure, the Update Inventory operation has failed in the Inventory microservice. The Saga invo\", \"kes a set of compensating transactions (in red) to adjust the inventory counts, cancel the payment a\", \"nd the order, and return the data for each microservice back to a consistent state.\\n\\nSaga patterns a\", \"re typically choreographed as a series of related events, or orchestrated as a set of related comman\", \"ds. In Chapter 4, we discussed the service aggregator pattern that would be the foundation for an or\", \"chestrated saga implementation. We also discussed eventing along with Azure Service Bus and Azure Ev\", \"ent Grid topics that would be a foundation for a choreographed saga implementation.\\n\\n## High volume \", \"data\\n\\nLarge cloud-native applications often support high-volume data requirements. In these scenario\", \"s, traditional data storage techniques can cause bottlenecks. For complex systems that deploy on a l\", \"arge scale, both Command and Query Responsibility Segregation (CQRS) and Event Sourcing may improve \", \"application performance.\\n\\n## CQRS\\n\\nCQRS, is an architectural pattern that can help maximize performa\", \"nce, scalability, and security. The pattern separates operations that read data from those operation\", \"s that write data.\\n\\nFor normal scenarios, the same entity model and data repository object are used \", \"for both read and write operations.\\n\\nHowever, a high volume data scenario can benefit from separate \", \"models and data tables for reads and writes. To improve performance, the read operation could query \", \"against a highly denormalized representation of the data to avoid expensive repetitive table joins a\", \"nd table locks. The write operation, known as a command , would update against a fully normalized re\", \"presentation of the data that would guarantee consistency. You then need to implement a mechanism to\", \" keep both representations in sync. Typically, whenever the write table is modified, it publishes an\", \" event that replicates the modification to the read table.\\n\\nFigure 5-7 shows an implementation of th\", \"e CQRS pattern.\\n\\nFigure 5-7. CQRS implementation\\n\\n<!-- image -->\\n\\nIn the previous figure, separate c\", \"ommand and query models are implemented. Each data write operation is saved to the write store and t\", \"hen propagated to the read store. Pay close attention to how the data propagation process operates o\", \"n the principle of eventual consistency. The read model eventually synchronizes with the write model\", \", but there may be some lag in the process. We discuss eventual consistency in the next section.\\n\\nTh\", \"is separation enables reads and writes to scale independently. Read operations use a schema optimize\", \"d for queries, while the writes use a schema optimized for updates. Read queries go against denormal\", \"ized data, while complex business logic can be applied to the write model. As well, you might impose\", \" tighter security on write operations than those exposing reads.\\n\\nImplementing CQRS can improve appl\", \"ication performance for cloud-native services. However, it does result in a more complex design. App\", \"ly this principle carefully and strategically to those sections of your cloud-native application tha\", \"t will benefit from it. For more on CQRS, see the Microsoft book .NET Microservices: Architecture fo\", \"r Containerized .NET Applications.\\n\\n## Event sourcing\\n\\nAnother approach to optimizing high volume da\", \"ta scenarios involves Event Sourcing.\\n\\nA system typically stores the current state of a data entity.\", \" If a user changes their phone number, for example, the customer record is updated with the new numb\", \"er. We always know the current state of a data entity, but each update overwrites the previous state\", \".\\n\\nIn most cases, this model works fine. In high volume systems, however, overhead from transactiona\", \"l locking and frequent update operations can impact database performance, responsiveness, and limit \", \"scalability.\\n\\nEvent Sourcing takes a different approach to capturing data. Each operation that affec\", \"ts data is persisted to an event store. Instead of updating the state of a data record, we append ea\", \"ch change to a sequential list of past events - similar to an accounta nt's ledger. The Event Store \", \"becomes the system of record for the data. It's used to propagate various materialized views within \", \"the bounded context of a microservice. Figure 5.8 shows the pattern.\\n\\nPresentation\\n\\nCart created\\n\\nIt\", \"em 1 added\\n\\nItem 2 added\\n\\nItem 1 removed\\n\\nShipping information added\\n\\nPersisted events\\n\\nEvent store\\n\", \"\\nSome options for consuming events\\n\\nFigure 5-8. Event Sourcing\\n\\n<!-- image -->\\n\\nIn the previous figu\", \"re, note how each entry (in blue) for a user's shopping cart is appended to an underlying event stor\", \"e. In the adjoining materialized view, the system projects the current state by replaying all the ev\", \"ents associated with each shopping cart. This view, or read model, is then exposed back to the UI. E\", \"vents can also be integrated with external systems and applications or queried to determine the curr\", \"ent state of an entity. With this approach, you maintain history. You know not only the current stat\", \"e of an entity, but also how you reached this state.\\n\\nMechanically speaking, event sourcing simplifi\", \"es the write model. There are no updates or deletes. Appending each data entry as an immutable event\", \" minimizes contention, locking, and concurrency conflicts associated with relational databases. Buil\", \"ding read models with the materialized view pattern enables you to decouple the view from the write \", \"model and choose the best data store to optimize the needs of your application UI.\\n\\nFor this pattern\", \", consider a data store that directly supports event sourcing. Azure Cosmos DB, MongoDB, Cassandra, \", \"CouchDB, and RavenDB are good candidates.\\n\\nAs with all patterns and technologies, implement strategi\", \"cally and when needed. While event sourcing can provide increased performance and scalability, it co\", \"mes at the expense of complexity and a learning curve.\\n\\nDocument\\n\\nStore value\\n\\nvalue value\\n\\n## Relat\", \"ional vs. NoSQL data value\\n\\nGraph\\n\\nRelational and NoSQL are two types of database systems commonly i\", \"mplemented in cloud-native apps. They're built differently, store data differently, and accessed dif\", \"ferently. In this section, we'll look at both. Later in this chapter, we'll look at an emer ging dat\", \"abase technology called NewSQL .\\n\\nRelational databases have been a prevalent technology for decades.\", \" They're mature, proven, and widely implemented. Competing database products, tooling, and expertise\", \" abound. Relational databases provide a store of related data tables. These tables have a fixed sche\", \"ma, use SQL (Structured Query Language) to manage data, and support ACID guarantees.\\n\\nNo-SQL databas\", \"es refer to high-performance, non-relational data stores. They excel in their ease-ofuse, scalabilit\", \"y, resilience, and availability characteristics. Instead of joining tables of normalized data, NoSQL\", \" stores unstructured or semi-structured data, often in key-value pairs or JSON documents. NoSQL data\", \"bases typically don't provide ACID guarantees beyond the scope of a single database partition. High \", \"volume services that require sub second response time favor NoSQL datastores.\\n\\nThe impact of NoSQL t\", \"echnologies for distributed cloudnative systems can't be overstated. The proliferation of new data t\", \"echnologies in this space has disrupted solutions that once exclusively relied on relational databas\", \"es.\\n\\nNoSQL databases include several different models for accessing and managing data, each suited t\", \"o specific use cases. Figure 5-9 presents four common models.\\n\\n<!-- image -->\\n\\n<!-- image -->\\n\\nFigur\", \"e 5-9: Data models for NoSQL databases\\n\\n| Model             | Characteristics                       \", \"                                                       |\\n|-------------------|----------------------\", \"------------------------------------------------------------------------|\\n| Document Store    | Data\", \" and metadata are stored hierarchically in JSON-based documents inside the database.     |\\n| Key Val\", \"ue Store   | The simplest of the NoSQL databases, data is represented as a collection of key-value p\", \"airs. |\\n| Wide-Column Store | Related data is stored as a set of nested- key/value pairs within a si\", \"ngle column.           |\\n| Graph Store       | Data is stored in a graph structure as node, edge, an\", \"d data properties.                      |\\n\\n<!-- image -->\\n\\n<!-- image -->\\n\\n## The CAP theorem\\n\\nAs a \", \"way to understand the differences between these types of databases, consider the CAP theorem, a set \", \"of principles applied to distributed systems that store state. Figure 5-10 shows the three propertie\", \"s of the CAP theorem.\\n\\nPartition\\n\\nFigure 5-10. The CAP theorem\\n\\n<!-- image -->\\n\\nThe theorem states t\", \"hat distributed data systems will offer a trade-off between consistency, availability, and partition\", \" tolerance. And, that any database can only guarantee two of the three properties:\\n\\n- Consistency. E\", \"very node in the cluster responds with the most recent data, even if the system must block the reque\", \"st until all replicas update. If you query a 'consistent system' for an item that is currently updat\", \"ing, you'll wait for that response until all replicas successfully update. However, you'll receive t\", \"he most current data.\\n- Availability. Every node returns an immediate response, even if that respons\", \"e isn't the most recent data. If you query an 'available system' for an item that is updating, you'l\", \"l get the best possible answer the service can provide at that moment.\\n- Partition Tolerance. Guaran\", \"tees the system continues to operate even if a replicated data node fails or loses connectivity with\", \" other replicated data nodes.\\n\\nCAP theorem explains the tradeoffs associated with managing consisten\", \"cy and availability during a network partition; however tradeoffs with respect to consistency and pe\", \"rformance also exist with the absence of a network partition. CAP theorem is often further extended \", \"to PACELC to explain the tradeoffs more comprehensively.\\n\\nRelational databases typically provide con\", \"sistency and availability, but not partition tolerance. They're typically provisioned to a single se\", \"rver and scale vertically by adding more resources to the machine.\\n\\nMany relational database systems\", \" support built-in replication features where copies of the primary database can be made to other sec\", \"ondary server instances. Write operations are made to the primary instance and replicated to each of\", \" the secondaries. Upon a failure, the primary instance can fail over to a secondary to provide high \", \"availability. Secondaries can also be used to distribute read operations. While writes operations al\", \"ways go against the primary replica, read operations can be routed to any of the secondaries to redu\", \"ce system load.\\n\\nData can also be horizontally partitioned across multiple nodes, such as with shard\", \"ing. But, sharding dramatically increases operational overhead by spitting data across many pieces t\", \"hat cannot easily communicate. It can be costly and time consuming to manage. Relational features th\", \"at include table joins, transactions, and referential integrity require steep performance penalties \", \"in sharded deployments.\\n\\nReplication consistency and recovery point objectives can be tuned by confi\", \"guring whether replication occurs synchronously or asynchronously. If data replicas were to lose net\", \"work connectivity in a 'highly consistent' or synchronous relational database cluster, you wouldn't \", \"be able to write to the database. The system would reject the write operation as it can't replicate \", \"that change to the other data replica. Every data replica has to update before the transaction can c\", \"omplete.\\n\\nNoSQL databases typically support high availability and partition tolerance. They scale ou\", \"t horizontally, often across commodity servers. This approach provides tremendous availability, both\", \" within and across geographical regions at a reduced cost. You partition and replicate data across t\", \"hese machines, or nodes, providing redundancy and fault tolerance. Consistency is typically tuned th\", \"rough consensus protocols or quorum mechanisms. They provide more control when navigating tradeoffs \", \"between tuning synchronous versus asynchronous replication in relational systems.\\n\\nIf data replicas \", \"were to lose connectivity in a 'highly available' NoSQL database cluster, you could still complete a\", \" write operation to the database. The database cluster would allow the write operation and update ea\", \"ch data replica as it becomes available. NoSQL databases that support multiple writable replicas can\", \" further strengthen high availability by avoiding the need for failover when optimizing recovery tim\", \"e objective.\\n\\nModern NoSQL databases typically implement partitioning capabilities as a feature of t\", \"heir system design. Partition management is often built-in to the database, and routing is achieved \", \"through placement hints - often called partition keys. A flexible data models enables the NoSQL data\", \"bases to lower the burden of schema management and improve availability when deploying application u\", \"pdates that require data model changes.\\n\\nHigh availability and massive scalability are often more cr\", \"itical to the business than relational table joins and referential integrity. Developers can impleme\", \"nt techniques and patterns such as Sagas, CQRS, and asynchronous messaging to embrace eventual consi\", \"stency.\\n\\nNowadays, care must be taken when considering the CAP theorem constraints. A new type of da\", \"tabase, called NewSQL, has emerged which extends the relational database engine to support both hori\", \"zontal scalability and the scalable performance of NoSQL systems.\\n\\n## Considerations for relational \", \"vs. NoSQL systems\\n\\nBased upon specific data requirements, a cloud-native-based microservice can impl\", \"ement a relational, NoSQL datastore or both.\\n\\n| Consider a NoSQL datastore when:                    \", \"                                                                                                    \", \"                            | Consider a relational database when:                                  \", \"          |\\n|---------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------|-----\", \"----------------------------------------------------------------------------|\\n| You have high volume\", \" workloads that require predictable latency at large scale (for example, latency measured in millise\", \"conds while performing millions of transactions per second) | Your workload volume generally fits wi\", \"thin thousands of transactions per second |\\n| Your data is dynamic and frequently changes           \", \"                                                                                                    \", \"                          | Your data is highly structured and requires referential integrity       \", \"        |\\n| Relationships can be de-normalized data models                                          \", \"                                                                                            | Relati\", \"onships are expressed through table joins on normalized data models       |\\n| Data retrieval is simp\", \"le and expressed without table joins                                                                \", \"                                                          | You work with complex queries and report\", \"s                                       |\\n| Data is typically replicated across geographies and requ\", \"ires finer control over consistency, availability, and performance                                  \", \"                        | Data is typically centralized, or can be replicated regions asynchronously\", \"      |\\n| Your application will be deployed to commodity hardware, such as with public clouds       \", \"                                                                                          | Your app\", \"lication will be deployed to large, high- end hardware                  |\\n\\nIn the next sections, we'\", \"ll explore the options available in the Azure cloud for storing and managing your cloud-native data.\", \"\\n\\n## Database as a Service\\n\\nTo start, you could provision an Azure virtual machine and install your \", \"database of choice for each service. While you'd have full control over the environment, you'd forgo\", \" many built -in features of the cloud platform. You'd also be responsible for managin g the virtual \", \"machine and database for each service. This approach could quickly become time-consuming and expensi\", \"ve.\\n\\nInstead, cloud-native applications favor data services exposed as a Database as a Service (DBaa\", \"S). Fully managed by a cloud vendor, these services provide built-in security, scalability, and moni\", \"toring. Instead of owning the service, you simply consume it as a backing service. The provider oper\", \"ates the resource at scale and bears the responsibility for performance and maintenance.\\n\\nThey can b\", \"e configured across cloud availability zones and regions to achieve high availability. They all supp\", \"ort just-in-time capacity and a pay-as-you-go model. Azure features different kinds of managed data \", \"service options, each with specific benefits.\\n\\nWe'll first look at relational DBaaS services availab\", \"le in Azure. You'll see that Microsoft's flagship SQL Server database is available along with severa\", \"l opensource options. Then, we'll talk about the NoSQL data services in Azure.\\n\\nSQL Database\\n\\nSQL\\n\\nM\", \"ySQL\\n\\nMy\\n\\nMariaDB\\n\\nPostgreSQL\\n\\nBuilt-in high availability with a 99.99% service level agreement\\n\\n\\u2022 A\", \"utomatic upgrades, patching, and backups\\n\\n## Azure relational databases\\n\\nFor cloud-native microservi\", \"ces that require relational data, Azure offers four managed relational databases as a service (DBaaS\", \") offerings, shown in Figure 5-11.\\n\\nFigure 5-11. Managed relational databases available in Azure\\n\\n<!\", \"-- image -->\\n\\nIn the previous figure, note how each sits upon a common DBaaS infrastructure which fe\", \"atures key capabilities at no additional cost.\\n\\nThese features are especially important to organizat\", \"ions who provision large numbers of databases, but have limited resources to administer them. You ca\", \"n provision an Azure database in minutes by selecting the amount of processing cores, memory, and un\", \"derlying storage. You can scale the database on-the-fly and dynamically adjust resources with little\", \" to no downtime.\\n\\n## Azure SQL Database\\n\\nDevelopment teams with expertise in Microsoft SQL Server sh\", \"ould consider Azure SQL Database . It's a fully managed relational database-as-a-service (DBaaS) bas\", \"ed on the Microsoft SQL Server Database Engine. The service shares many features found in the on-pre\", \"mises version of SQL Server and runs the latest stable version of the SQL Server Database Engine.\\n\\nF\", \"or use with a cloud-native microservice, Azure SQL Database is available with three deployment optio\", \"ns:\\n\\n- A Single Database represents a fully managed SQL Database running on an Azure SQL Database se\", \"rver in the Azure cloud. The database is considered contained as it has no configuration dependencie\", \"s on the underlying database server.\\n- A Managed Instance is a fully managed instance of the Microso\", \"ft SQL Server Database Engine that provides near-100% compatibility with an on-premises SQL Server. \", \"This option supports larger databases, up to 35 TB and is placed in an Azure Virtual Network for bet\", \"ter isolation.\\n\\n- Azure SQL Database serverless is a compute tier for a single database that automat\", \"ically scales based on workload demand. It bills only for the amount of compute used per second. The\", \" service is well suited for workloads with intermittent, unpredictable usage patterns, interspersed \", \"with periods of inactivity. The serverless compute tier also automatically pauses databases during i\", \"nactive periods so that only storage charges are billed. It automatically resumes when activity retu\", \"rns.\\n\\nBeyond the traditional Microsoft SQL Server stack, Azure also features managed versions of thr\", \"ee popular open-source databases.\\n\\n## Open-source databases in Azure\\n\\nOpen-source relational databas\", \"es have become a popular choice for cloud-native applications. Many enterprises favor them over comm\", \"ercial database products, especially for cost savings. Many development teams enjoy their flexibilit\", \"y, community-backed development, and ecosystem of tools and extensions. Open-source databases can be\", \" deployed across multiple cloud providers, helping minimize the concern of 'vendor lock -in.'\\n\\nDevel\", \"opers can easily self-host any open-source database on an Azure VM. While providing full control, th\", \"is approach puts you on the hook for the management, monitoring, and maintenance of the database and\", \" VM.\\n\\nHowever, Microsoft continues its commitment to keeping Azure an 'open platform' by offering se\", \"veral popular open-source databases as fully managed DBaaS services.\\n\\n## Azure Database for MySQL\\n\\nM\", \"ySQL is an open-source relational database and a pillar for applications built on the LAMP software \", \"stack. Widely chosen for read heavy workloads, it's used by many large organizations, including Face\", \"book, Twitter, and YouTube. The community edition is available for free, while the enterprise editio\", \"n requires a license purchase. Originally created in 1995, the product was purchased by Sun Microsys\", \"tems in 2008. Oracle acquired Sun and MySQL in 2010.\\n\\nAzure Database for MySQL is a managed relation\", \"al database service based on the open-source MySQL Server engine. It uses the MySQL Community editio\", \"n. The Azure MySQL server is the administrative point for the service. It's the same MySQL server en\", \"gine used for on -premises deployments. The engine can create a single database per server or multip\", \"le databases per server that share resources. You can continue to manage data using the same open-so\", \"urce tools without having to learn new skills or manage virtual machines.\\n\\n## Azure Database for Mar\", \"iaDB\\n\\nMariaDB Server is another popular open-source database server. It was created as a fork of MyS\", \"QL when Oracle purchased Sun Microsystems, who owned MySQL. The intent was to ensure that MariaDB re\", \"mained open-source. As MariaDB is a fork of MySQL, the data and table definitions are compatible, an\", \"d the client protocols, structures, and APIs, are close-knit.\\n\\nMariaDB has a strong community and is\", \" used by many large enterprises. While Oracle continues to maintain, enhance, and support MySQL, the\", \" MariaDB foundation manages MariaDB, allowing public contributions to the product and documentation.\", \"\\n\\nAzure Database for MariaDB is a fully managed relational database as a service in the Azure cloud.\", \" The service is based on the MariaDB community edition server engine. It can handle mission-critical\", \" workloads with predictable performance and dynamic scalability.\\n\\n## Azure Database for PostgreSQL\\n\\n\", \"PostgreSQL is an open-source relational database with over 30 years of active development. PostgreSQ\", \"L has a strong reputation for reliability and data integrity. It's feature rich, SQL compliant, and \", \"considered more performant than MySQL - especially for workloads with complex queries and heavy writ\", \"es. Many large enterprises including Apple, Red Hat, and Fujitsu have built products using PostgreSQ\", \"L.\\n\\nAzure Database for PostgreSQL is a fully managed relational database service, based on the opens\", \"ource Postgres database engine. The service supports many development platforms, including C++, Java\", \", Python, Node, C#, and PHP. You can migrate PostgreSQL databases to it using the commandline interf\", \"ace tool or Azure Data Migration Service.\\n\\nAzure Database for PostgreSQL is available with two deplo\", \"yment options:\\n\\n- The Single Server deployment option is a central administrative point for multiple\", \" databases to which you can deploy many databases. The pricing is structured per-server based upon c\", \"ores and storage.\\n- The Hyperscale (Citus) option is powered by Citus Data technology. It enables hi\", \"gh performance by horizontally scaling a single database across hundreds of nodes to deliver fast pe\", \"rformance and scale. This option allows the engine to fit more data in memory, parallelize queries a\", \"cross hundreds of nodes, and index data faster.\\n\\n## NoSQL data in Azure\\n\\nCosmos DB is a fully manage\", \"d, globally distributed NoSQL database service in the Azure cloud. It has been adopted by many large\", \" companies across the world, including Coca-Cola, Skype, ExxonMobil, and Liberty Mutual.\\n\\nIf your se\", \"rvices require fast response from anywhere in the world, high availability, or elastic scalability, \", \"Cosmos DB is a great choice. Figure 5-12 shows Cosmos DB.\\n\\n(LEAF}\\n\\nSQL\\n\\nTurnkey global distribution\\n\", \"\\nMongoDB\\n\\nTable API\\n\\n\\u2022 OOO\\n\\nColumn-family\\n\\nGremlin\\n\\n\\u2022\\n\\nFigure 5-12: Overview of Azure Cosmos DB\\n\\n<!-\", \"- image -->\\n\\nThe previous figure presents many of the built-in cloud-native capabilities available i\", \"n Cosmos DB. In this section, we'll take a closer look at them.\\n\\n## Global support\\n\\nCloud-native app\", \"lications often have a global audience and require global scale.\\n\\nYou can distribute Cosmos database\", \"s across regions or around the world, placing data close to your users, improving response time, and\", \" reducing latency. You can add or remove a database from a region without pausing or redeploying you\", \"r services. In the background, Cosmos DB transparently replicates the data to each of the configured\", \" regions.\\n\\nCosmos DB supports active/active clustering at the global level, enabling you to configur\", \"e any of your database regions to support both writes and reads .\\n\\nThe Multi-region write protocol i\", \"s an important feature in Cosmos DB that enables the following functionality:\\n\\n- Unlimited elastic w\", \"rite and read scalability.\\n- 99.999% read and write availability all around the world.\\n- Guaranteed \", \"reads and writes served in less than 10 milliseconds at the 99th percentile.\\n\\nWith the Cosmos DB Mul\", \"ti-Homing APIs, your microservice is automatically aware of the nearest Azure region and sends reque\", \"sts to it. The nearest region is identified by Cosmos DB without any configuration changes. Should a\", \" region become unavailable, the Multi-Homing feature will automatically route requests to the next n\", \"earest available region.\\n\\n## Multi-model support\\n\\nWhen replatforming monolithic applications to a cl\", \"oud-native architecture, development teams sometimes have to migrate open-source, NoSQL data stores.\", \" Cosmos DB can help you preserve your cassandra\\n\\nFuture AP/s\\n\\ninvestment in these NoSQL datastores w\", \"ith its multi-model data platform. The following table shows the supported NoSQL compatibility APIs.\", \"\\n\\n| Provider       | Description                                                               |\\n|--\", \"--------------|---------------------------------------------------------------------------|\\n| NoSQL \", \"API      | API for NoSQL stores data in document format                              |\\n| Mongo DB AP\", \"I   | Supports Mongo DB APIs and JSON documents                                 |\\n| Gremlin API    |\", \" Supports Gremlin API with graph-based nodes and edge data representations |\\n| Cassandra API  | Supp\", \"orts Casandra API for wide-column data representations                |\\n| Table API      | Supports \", \"Azure Table Storage with premium enhancements                    |\\n| PostgreSQL API | Managed servic\", \"e for running PostgreSQL at any scale                       |\\n\\nDevelopment teams can migrate existin\", \"g Mongo, Gremlin, or Cassandra databases into Cosmos DB with minimal changes to data or code. For ne\", \"w apps, development teams can choose among opensource options or the built-in SQL API model.\\n\\nIntern\", \"ally, Cosmos stores the data in a simple struct format made up of primitive data types. For each req\", \"uest, the database engine translates the primitive data into the model representation you've selecte\", \"d.\\n\\nIn the previous table, note the Table API option. This API is an evolution of Azure Table Storag\", \"e. Both share the same underlying table model, but the Cosmos DB Table API adds premium enhancements\", \" not available in the Azure Storage API. The following table contrasts the features.\\n\\n| Feature     \", \"         | Azure Table Storage                                           | Azure Cosmos DB          \", \"                                                   |\\n|----------------------|-----------------------\", \"----------------------------------------|-----------------------------------------------------------\", \"------------------|\\n| Latency              | Fast                                                   \", \"       | Single-digit millisecond latency for reads and writes anywhere in the world |\\n| Throughp ut\", \"          | Limit of 20,000 operations per table                          | Unlimited operations per\", \" table                                              |\\n| Global Distributio n | Single region with op\", \"tional single secondary read region      | Turnkey distributions to all regions with automatic failo\", \"ver                |\\n| Indexing             | Available for partition and row key properties only   \", \"        | Automatic indexing of all properties                                        |\\n| Pricing   \", \"           | Optimized for cold workloads (low throughput : storage ratio) | Optimized for hot workl\", \"oads (high throughput : storage ratio)               |\\n\\nMicroservices that consume Azure Table stora\", \"ge can easily migrate to the Cosmos DB Table API. No code changes are required.\\n\\nStrong\\n\\nBounded Sta\", \"leness\\n\\nStronger Consistency\\n\\nSession\\n\\nConsistent Prefix\\n\\nEventual\\n\\nWeaker Consistency\\n\\nHigher avail\", \"ability, lower latency, higher throughput\\n\\n## Tunable consistency\\n\\nEarlier in the Relational vs. NoS\", \"QL section, we discussed the subject of data consistency . Data consistency refers to the integrity \", \"of your data. Cloud-native services with distributed data rely on replication and must make a fundam\", \"ental tradeoff between read consistency, availability, and latency.\\n\\nMost distributed databases allo\", \"w developers to choose between two consistency models: strong consistency and eventual consistency. \", \"Strong consistency is the gold standard of data programmability. It guarantees that a query will alw\", \"ays return the most current data - even if the system must incur latency waiting for an update to re\", \"plicate across all database copies. While a database configured for eventual consistency will return\", \" data immediately, even if that data isn't the most current copy. The latter option enables higher a\", \"vailability, greater scale, and increased performance.\\n\\nAzure Cosmos DB offers five well-defined con\", \"sistency models shown in Figure 5-13.\\n\\nFigure 5-13: Cosmos DB Consistency Levels\\n\\n<!-- image -->\\n\\nTh\", \"ese options enable you to make precise choices and granular tradeoffs for consistency, availability,\", \" and the performance for your data. The levels are presented in the following table.\\n\\n| Consistency \", \"Level   | Description                                                                               \", \"                                   |\\n|---------------------|----------------------------------------\", \"--------------------------------------------------------------------------------------|\\n| Eventual  \", \"          | No ordering guarantee for reads. Replicas will eventually converge.                     \", \"                                     |\\n| Constant Prefix     | Reads are still eventual, but data is\", \" returned in the ordering in which it is written.                                       |\\n| Session \", \"            | Guarantees you can read any data written during the current session. It is the default\", \" consistency level.                    |\\n| Bounded Staleness   | Reads trail writes by interval that\", \" you specify.                                                                             |\\n| Strong\", \"              | Reads are guaranteed to return most recent committed version of an item. A client ne\", \"ver sees an uncommitted or partial read. |\\n\\nIn the article Getting Behind the 9-Ball: Cosmos DB Cons\", \"istency Levels Explained, Microsoft Program Manager Jeremy Likness provides an excellent explanation\", \" of the five models.\\n\\n## Partitioning\\n\\nAzure Cosmos DB embraces automatic partitioning to scale a da\", \"tabase to meet the performance needs of your cloud-native services.\\n\\nYou manage data in Cosmos DB da\", \"ta by creating databases, containers, and items.\\n\\n\\\"city\\\": \\\"London\\\"\\n\\nContainer\\n\\nContainer\\n\\nContainers\", \" live in a Cosmos DB database and represent a schema-agnostic grouping of items. Items are the data \", \"that you add to the container. They're represented as documents, rows, nodes, or edges. All items ad\", \"ded to a container are automatically indexed. Logical\\n\\nPartitions\\n\\nTo partition the container, items\", \" are divided into distinct subsets called logical partitions. Logical partitions are populated based\", \" on the value of a partition key that is associated with each item in a container. Figure 5-14 shows\", \" two containers each with a logical partition based on a partition key value.\\n\\nPhysical\\n\\nFigure 5-14\", \": Cosmos DB partitioning mechanics\\n\\n<!-- image -->\\n\\nNote in the previous figure how each item includ\", \"es a partition key of either 'city' or 'airport'. The key determines the item's logical partition. I\", \"tems with a city code are assigned to the container on the left, and items with an airport code, to \", \"the container on the right. Combining the partition key value with the ID value creates an item's in\", \"dex, which uniquely identifies the item.\\n\\nInternally, Cosmos DB automatically manages the placement \", \"of logical partitions on physical partitions to satisfy the scalability and performance needs of the\", \" container. As application throughput and storage requirements increase, Azure Cosmos DB redistribut\", \"es logical partitions across a greater number of servers. Redistribution operations are managed by C\", \"osmos DB and invoked without interruption or downtime.\\n\\n## NewSQL databases\\n\\nNewSQL is an emerging d\", \"atabase technology that combines the distributed scalability of NoSQL with the ACID guarantees of a \", \"relational database. NewSQL databases are important for business systems that must process high-volu\", \"mes of data, across distributed environments, with full transactional support and ACID compliance. W\", \"hile a NoSQL database can provide massive scalability, it does not guarantee data consistency. Inter\", \"mittent problems from inconsistent data can place a burden on the development team. Developers must \", \"construct safeguards into their microservice code to manage problems caused by inconsistent data.\\n\\nT\", \"he Cloud Native Computing Foundation (CNCF) features several NewSQL database projects.\\n\\nDatabase\\n\\n| \", \"Project      | Characteristics                                                                      \", \"                                                                                                    \", \"                                                                                                    \", \"                                                                             |\\n|--------------|-----\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------|\\n| Cockroach DB | An ACID-compliant, rela\", \"tional database that scales globally. Add a new node to a cluster and CockroachDB takes care of bala\", \"ncing the data across instances and geographies. It creates, manages, and distributes replicas to en\", \"sure reliability. It's open sourc e and freely available.                                           \", \"                                       |\\n| TiDB         | An open-source database that supports Hybr\", \"id Transactional and Analytical Processing (HTAP) workloads. It is MySQL-compatible and features hor\", \"izontal scalability, strong consistency, and high availability. TiDB acts like a MySQL server. You c\", \"an continue to use existing MySQL client libraries, without requiring extensive code changes to your\", \" application.       |\\n| YugabyteDB   | An open source, high-performance, distributed SQL database. I\", \"t supports low query latency, resilience against failures, and global data distribution. YugabyteDB \", \"is PostgreSQL- compatible and handles scale-out RDBMS and internet-scale OLTP workloads. The product\", \" also supports NoSQL and is compatible with Cassandra.                                              \", \" |\\n| Vitess       | Vitess is a database solution for deploying, scaling, and managing large cluster\", \"s of MySQL instances. It can run in a public or private cloud architecture. Vitess combines and exte\", \"nds many important MySQL features and features both vertical and horizontal sharding support. Origin\", \"ated by YouTube, Vitess has been serving all YouTube database traffic since 2011. |\\n\\nThe open-source\", \" projects in the previous figure are available from the Cloud Native Computing Foundation. Three of \", \"the offerings are full database products, which include .NET support. The other, Vitess, is a databa\", \"se clustering system that horizontally scales large clusters of MySQL instances.\\n\\nA key design goal \", \"for NewSQL databases is to work natively in Kubernetes, taking advantage of the platform's resilienc\", \"y and scalability.\\n\\nNewSQL databases are designed to thrive in ephemeral cloud environments where un\", \"derlying virtual machines can be restarted or rescheduled at a moment's notice. The databases are de\", \"signed to survive node failures without data loss nor downtime. CockroachDB, for example, is able to\", \" survive a machine loss by maintaining three consistent replicas of any data across the nodes in a c\", \"luster.\\n\\nKubernetes uses a Services construct to allow a client to address a group of identical NewS\", \"QL databases processes from a single DNS entry. By decoupling the database instances from the addres\", \"s\\n\\nof the service with which it's associated, we can scale without disrupting existing application i\", \"nstances. Sending a request to any service at a given time will always yield the same result.\\n\\nIn th\", \"is scenario, all database instances are equal. There are no primary or secondary relationships. Tech\", \"niques like consensus replication found in CockroachDB allow any database node to handle any request\", \". If the node that receives a load-balanced request has the data it needs locally, it responds immed\", \"iately. If not, the node becomes a gateway and forwards the request to the appropriate nodes to get \", \"the correct answer. From the client's perspective, every database node is the same: They appear as a\", \" single logical database with the consistency guarantees of a single-machine system, despite having \", \"dozens or even hundreds of nodes that are working behind the scenes.\\n\\nFor a detailed look at the mec\", \"hanics behind NewSQL databases, see the DASH: Four Properties of Kubernetes-Native Databases article\", \".\\n\\n## Data migration to the cloud\\n\\nOne of the more time-consuming tasks is migrating data from one d\", \"ata platform to another. The Azure Data Migration Service can help expedite such efforts. It can mig\", \"rate data from several external database sources into Azure Data platforms with minimal downtime. Ta\", \"rget platforms include the following services:\\n\\n- Azure SQL Database\\n- Azure Database for MySQL\\n- Az\", \"ure Database for MariaDB\\n- Azure Database for PostgreSQL\\n- Azure Cosmos DB\\n\\nThe service provides rec\", \"ommendations to guide you through the changes required to execute a migration, both small or large.\\n\", \"\\n## Caching in a cloud-native app\\n\\nThe benefits of caching are well understood. The technique works \", \"by temporarily copying frequently accessed data from a backend data store to fast storage that's loc\", \"ated closer to the application. Caching is often implemented where\\u2026\\n\\n- Data remains relatively stati\", \"c.\\n- Data access is slow, especially compared to the speed of the cache.\\n- Data is subject to high l\", \"evels of contention.\\n\\n## Why?\\n\\nAs discussed in the Microsoft caching guidance, caching can increase \", \"performance, scalability, and availability for individual microservices and the system as a whole. I\", \"t reduces the latency and contention of handling large volumes of concurrent requests to a data stor\", \"e. As data volume and the number of users increase, the greater the benefits of caching become.\\n\\nCli\", \"ent Web app\\n\\nCloud\\n\\n## Caching architecture\\n\\nCloud native applications typically implement a distrib\", \"uted caching architecture. The cache is hosted as a cloud-based backing service, separate from the m\", \"icroservices. Figure 5-15 shows the architecture.\\n\\nFigure 5-15: Caching in a cloud native app\\n\\n<!-- \", \"image -->\\n\\nIn the previous figure, note how the cache is independent of and shared by the microservi\", \"ces. In this scenario, the cache is invoked by the API Gateway. As discussed in chapter 4, the gatew\", \"ay serves as a front end for all incoming requests. The distributed cache increases system responsiv\", \"eness by returning cached data whenever possible. Additionally, separating the cache from the servic\", \"es allows the cache to scale up or out independently to meet increased traffic demands.\\n\\nThe previou\", \"s figure presents a common caching pattern known as the cache-aside pattern. For an incoming request\", \", you first query the cache (step #1) for a response. If found, the data is returned immediately. If\", \" the data doesn't exist in the cache (known as a cache miss ), it's retrieved from a local database \", \"in a downstream service (step #2). It's then written to the cache for future requests (step #3), and\", \" returned to the caller. Care must be taken to periodically evict cached data so that the system rem\", \"ains timely and consistent.\\n\\nAs a shared cache grows, it might prove beneficial to partition its dat\", \"a across multiple nodes. Doing so can help minimize contention and improve scalability. Many Caching\", \" services support the ability to\\n\\nCache\\n\\nAzure\\n\\nTable\\n\\nCaching is most effective when a client repea\", \"tedly reads data that is immutable or that changes infrequently. Examples include reference informat\", \"ion such as product and pricing information, or shared static resources that are costly to construct\", \". Web API Azure\\n\\nCosmos\\n\\nWhile microservices should be stateless, a distributed cache can support co\", \"ncurrent access to session state data when absolutely required. container\\n\\nAlso consider caching to \", \"avoid repetitive computations. If an operation transforms data or performs a complicated calculation\", \", cache the result for subsequent requests. 5QL\\n\\nAzure\\n\\nDatabase\\n\\nMicroservice 1\\n\\nWeb AP\\n\\ncontainer\\n\", \"\\ndynamically add and remove nodes and rebalance data across partitions. This approach typically invo\", \"lves clustering. Clustering exposes a collection of federated nodes as a seamless, single cache. Int\", \"ernally, however, the data is dispersed across the nodes following a predefined distribution strateg\", \"y that balances the load evenly.\\n\\n## Azure Cache for Redis\\n\\nAzure Cache for Redis is a secure data c\", \"aching and messaging broker service, fully managed by Microsoft. Consumed as a Platform as a Service\", \" (PaaS) offering, it provides high throughput and lowlatency access to data. The service is accessib\", \"le to any application within or outside of Azure.\\n\\nThe Azure Cache for Redis service manages access \", \"to open-source Redis servers hosted across Azure data centers. The service acts as a facade providin\", \"g management, access control, and security. The service natively supports a rich set of data structu\", \"res, including strings, hashes, lists, and sets. If your application already uses Redis, it will wor\", \"k as-is with Azure Cache for Redis.\\n\\nAzure Cache for Redis is more than a simple cache server. It ca\", \"n support a number of scenarios to enhance a microservices architecture:\\n\\n- An in-memory data store\\n\", \"- A distributed non-relational database\\n- A message broker\\n- A configuration or discovery server\\n\\nFo\", \"r advanced scenarios, a copy of the cached data can be persisted to disk. If a catastrophic event di\", \"sables both the primary and replica caches, the cache is reconstructed from the most recent snapshot\", \".\\n\\nAzure Redis Cache is available across a number of predefined configurations and pricing tiers. Th\", \"e Premium tier features many enterprise-level features such as clustering, data persistence, georepl\", \"ication, and virtual-network isolation.\\n\\n## Elasticsearch in a cloud-native app\\n\\nElasticsearch is a \", \"distributed search and analytics system that enables complex search capabilities across diverse type\", \"s of data. It's open source and widely popular. Consider how the following companies integrate Elast\", \"icsearch into their application:\\n\\n- Wikipedia for full-text and incremental (search as you type) sea\", \"rching.\\n- GitHub to index and expose over 8 million code repositories.\\n- Docker for making its conta\", \"iner library discoverable.\\n\\nElasticsearch is built on top of the Apache Lucene full-text search engi\", \"ne. Lucene provides highperformance document indexing and querying. It indexes data with an inverted\", \" indexing scheme -instead of mapping pages to keywords, it maps keywords to pages just like a glossa\", \"ry at the end of a book. Lucene has powerful query syntax capabilities and can query data by:\\n\\n- Ter\", \"m (a full word)\\n- Prefix (starts-with word)\\n- Wildcard (using '*' or '?' filters)\\n- Phrase (a sequen\", \"ce of text in a document)\\n- Boolean value (complex searches combining queries)\\n\\nWhile Lucene provide\", \"s low-level plumbing for searching, Elasticsearch provides the server that sits on top of Lucene. El\", \"asticsearch adds higher-level functionality to simplify working Lucene, including a RESTful API to a\", \"ccess Lucene's indexing and searchin g functionality. It also provides a distributed infrastructure \", \"capable of massive scalability, fault tolerance, and high availability.\\n\\nFor larger cloud-native app\", \"lications with complex search requirements, Elasticsearch is available as managed service in Azure. \", \"The Microsoft Azure Marketplace features preconfigured templates which developers can use to deploy \", \"an Elasticsearch cluster on Azure.\\n\\nFrom the Microsoft Azure Marketplace, developers can use preconf\", \"igured templates built to quickly deploy an Elasticsearch cluster on Azure. Using the Azure-managed \", \"offering, you can deploy up to 50 data nodes, 20 coordinating nodes, and three dedicated master node\", \"s.\\n\\n## Summary\\n\\nThis chapter presented a detailed look at data in cloud-native systems. We started b\", \"y contrasting data storage in monolithic applications with data storage patterns in cloud-native sys\", \"tems. We looked at data patterns implemented in cloud-native systems, including cross-service querie\", \"s, distributed transactions, and patterns to deal with high-volume systems. We contrasted SQL with N\", \"oSQL data. We looked at data storage options available in Azure that include both Microsoft-centric \", \"and opensource options. Finally, we discussed caching and Elasticsearch in a cloud-native applicatio\", \"n.\\n\\n## References\\n\\n- Command and Query Responsibility Segregation (CQRS) pattern\\n- Event Sourcing pa\", \"ttern\\n- Why isn't RDBMS Partition Tolerant in CAP Theorem and why is it Available?\\n- Materialized Vi\", \"ew\\n- All you really need to know about open source databases\\n- Compensating Transaction pattern\\n- Sa\", \"ga Pattern\\n- Saga Patterns | How to implement business transactions using microservices\\n- Compensati\", \"ng Transaction pattern\\n- Getting Behind the 9-Ball: Cosmos DB Consistency Levels Explained\\n- On RDBM\", \"S, NoSQL and NewSQL databases. Interview with John Ryan\\n\\n\\u00b7 SQL vs NoSQL vs NewSQL: The Full Comparis\", \"on \\u00b7 DASH: Four Properties of Kubernetes-Native Databases \\u00b7 CockroachDB \\u00b7 TiDB \\u00b7 YugabyteDB \\u00b7 Vitess\", \" \\u00b7 Elasticsearch: The Definitive Guide \\u00b7 Introduction to Apache Lucene\\n\\nClient Mobile App\\n\\nClient SP\", \"A Web app\\n\\nBrowser\\n\\nJSON\\n\\nBack end\\n\\nCaching\\n\\nBacking Service\\n\\nMicroservice\\n\\n.....\\n\\n## Cloud-native r\", \"esiliency\\n\\nSQL\\n\\nMicroservice\\n\\nResiliency is the ability of your system to react to failure and still\", \" remain functional. It's not about avoiding failure, but accepting failure and constructing your clo\", \"ud-native services to respond to it. You want to return to a fully functioning state quickly as poss\", \"ible.\\n\\nUnlike traditional monolithic applications, where everything runs together in a single proces\", \"s, cloudnative systems embrace a distributed architecture as shown in Figure 6-1:\\n\\nFigure 6-1. Distr\", \"ibuted cloud-native environment\\n\\n<!-- image -->\\n\\nIn the previous figure, each microservice and cloud\", \"-based backing service execute in a separate process, across server infrastructure, communicating vi\", \"a network-based calls.\\n\\nOperating in this environment, a service must be sensitive to many different\", \" challenges:\\n\\n- Unexpected network latency - the time for a service request to travel to the receive\", \"r and back.\\n- Transient faults - short-lived network connectivity errors.\\n- Blockage by a long-runni\", \"ng synchronous operation.\\n- A host process that has crashed and is being restarted or moved.\\n- An ov\", \"erloaded microservice that can't respond for a short time.\\n- An in-flight orchestrator operation suc\", \"h as a rolling upgrade or moving a service from one node to another.\\n\\n{}\\n\\nDocument Database\\n\\nBacking\", \" Service\\n\\n- Hardware failures.\\n\\nCloud platforms can detect and mitigate many of these infrastructure\", \" issues. It may restart, scale out, and even redistribute your service to a different node. However,\", \" to take full advantage of this built-in protection, you must design your services to react to it an\", \"d thrive in this dynamic environment.\\n\\nIn the following sections, we'll explore defensive techniques\", \" that your service and managed cloud resources can leverage to minimize downtime and disruption.\\n\\n##\", \" Application resiliency patterns\\n\\nThe first line of defense is application resiliency.\\n\\nWhile you co\", \"uld invest considerable time writing your own resiliency framework, such products already exist. Pol\", \"ly is a comprehensive .NET resilience and transient-fault-handling library that allows developers to\", \" express resiliency policies in a fluent and thread-safe manner. Polly targets applications built wi\", \"th either .NET Framework or .NET 7. The following table describes the resiliency features, called po\", \"licies, available in the Polly Library. They can be applied individually or grouped together.\\n\\n| Pol\", \"icy          | Experience                                                                           \", \"             |\\n|-----------------|------------------------------------------------------------------\", \"---------------------------------|\\n| Retry           | Configures retry operations on designated ope\", \"rations.                                             |\\n| Circuit Breaker | Blocks requested operatio\", \"ns for a predefined period when faults exceed a configured threshold     |\\n| Timeout         | Place\", \"s limit on the duration for which a caller can wait for a response.                          |\\n| Bul\", \"khead        | Constrains actions to fixed-size resource pool to prevent failing calls from swamping\", \" a resource. |\\n| Cache           | Stores responses automatically.                                  \", \"                                 |\\n| Fallback        | Defines structured behavior upon a failure.  \", \"                                                     |\\n\\nNote how in the previous figure the resilien\", \"cy policies apply to request messages, whether coming from an external client or back-end service. T\", \"he goal is to compensate the request for a service that might be momentarily unavailable. These shor\", \"t-lived interruptions typically manifest themselves with the HTTP status codes shown in the followin\", \"g table.\\n\\n|   HTTP Status Code | Cause                                                 |\\n|----------\", \"----------|-------------------------------------------------------|\\n|                404 | Not Found\", \"                                             |\\n|                408 | Request timeout               \", \"                        |\\n|                429 | Too many requests (you've most likely been throttle\", \"d) |\\n|                502 | Bad gateway                                           |\\n|               \", \" 503 | Service unavailable                                   |\\n\\nClient Mobile App\\n\\nClient SPA Web ap\", \"p\\n\\nBrowser\\n\\nJSON\\n\\nBack end\\n\\nRetries = 4\\n\\nDuration = 2 sec\\n\\nResiliency Configuration\\n\\n|   HTTP Status\", \" Code | Cause           |\\n|--------------------|-----------------|\\n|                504 | Gateway ti\", \"meout |\\n\\nQuestion: Would you retry an HTTP Status Code of 403 - Forbidden? No. Here, the system is f\", \"unctioning properly, but informing the caller that they aren't authorized to perform the requested o\", \"peration. Care must be taken to retry only those operations caused by failures.\\n\\nAs recommended in C\", \"hapter 1, Microsoft developers constructing cloud-native applications should target the .NET platfor\", \"m. Version 2.1 introduced the HTTPClientFactory library for creating HTTP Client instances for inter\", \"acting with URL-based resources. Superseding the original HTTPClient class, the factory class suppor\", \"ts many enhanced features, one of which is tight integration with the Polly resiliency library. With\", \" it, you can easily define resiliency policies in the application Startup class to handle partial fa\", \"ilures and connectivity issues.\\n\\nNext, let's expand on retry and circuit breaker patterns.\\n\\n## Retry\", \" pattern\\n\\nIn a distributed cloud-native environment, calls to services and cloud resources can fail \", \"because of transient (short-lived) failures, which typically correct themselves after a brief period\", \" of time. Implementing a retry strategy helps a cloud-native service mitigate these scenarios.\\n\\nThe \", \"Retry pattern enables a service to retry a failed request operation a (configurable) number of times\", \" with an exponentially increasing wait time. Figure 6-2 shows a retry in action.\\n\\nFigure 6-2. Retry \", \"pattern in action\\n\\n<!-- image -->\\n\\nIn the previous figure, a retry pattern has been implemented for \", \"a request operation. It's configured to allow up to four retries before failing with a backoff inter\", \"val (wait time) starting at two seconds, which exponentially doubles for each subsequent attempt.\\n\\n-\", \" The first invocation fails and returns an HTTP status code of 500. The application waits for two se\", \"conds and retries the call.\\n\\n- The second invocation also fails and returns an HTTP status code of 5\", \"00. The application now doubles the backoff interval to four seconds and retries the call.\\n- Finally\", \", the third call succeeds.\\n- In this scenario, the retry operation would have attempted up to four r\", \"etries while doubling the backoff duration before failing the call.\\n- Had the 4th retry attempt fail\", \"ed, a fallback policy would be invoked to gracefully handle the problem.\\n\\nIt's important to increase\", \" the backoff period before retrying the call to allow the service time to self -correct. It's a best\", \" practice to implement an exponentially increasing backoff (doubling the period on each retry) to al\", \"low adequate correction time.\\n\\n## Circuit breaker pattern\\n\\nWhile the retry pattern can help salvage \", \"a request entangled in a partial failure, there are situations where failures can be caused by unant\", \"icipated events that will require longer periods of time to resolve. These faults can range in sever\", \"ity from a partial loss of connectivity to the complete failure of a service. In these situations, i\", \"t's pointless for an application to continually retry an operation that is unlikely to succeed.\\n\\nTo \", \"make things worse, executing continual retry operations on a non-responsive service can move you int\", \"o a self-imposed denial of service scenario where you flood your service with continual calls exhaus\", \"ting resources such as memory, threads and database connections, causing failure in unrelated parts \", \"of the system that use the same resources.\\n\\nIn these situations, it would be preferable for the oper\", \"ation to fail immediately and only attempt to invoke the service if it's likely to succeed.\\n\\nThe Cir\", \"cuit Breaker pattern can prevent an application from repeatedly trying to execute an operation that'\", \"s likely to fail. After a pre -defined number of failed calls, it blocks all traffic to the service.\", \" Periodically, it will allow a trial call to determine whether the fault has resolved. Figure 6-3 sh\", \"ows the Circuit Breaker pattern in action.\\n\\nClient Mobile App\\n\\nClient SPA Web app\\n\\nBrowser\\n\\nJSON\\n\\nJS\", \"ON\\n\\nHTML\\n\\nRetries = 4\\n\\nDuration = 2 sec\\n\\nExceptionsAllowed = 100\\n\\nCheckCircuit = 30 seconds\\n\\nResilie\", \"ncy Configuration\\n\\nFigure 6-3. Circuit breaker pattern in action\\n\\n<!-- image -->\\n\\nIn the previous fi\", \"gure, a Circuit Breaker pattern has been added to the original retry pattern. Note how after 100 fai\", \"led requests, the circuit breakers opens and no longer allows calls to the service. The CheckCircuit\", \" value, set at 30 seconds, specifies how often the library allows one request to proceed to the serv\", \"ice. If that call succeeds, the circuit closes and the service is once again available to traffic.\\n\\n\", \"Keep in mind that the intent of the Circuit Breaker pattern is different than that of the Retry patt\", \"ern. The Retry pattern enables an application to retry an operation in the expectation that it will \", \"succeed. The Circuit Breaker pattern prevents an application from doing an operation that is likely \", \"to fail. Typically, an application will combine these two patterns by using the Retry pattern to inv\", \"oke an operation through a circuit breaker.\\n\\n## Testing for resiliency\\n\\nTesting for resiliency canno\", \"t always be done the same way that you test application functionality (by running unit tests, integr\", \"ation tests, and so on). Instead, you must test how the end-to-end workload performs under failure c\", \"onditions, which only occur intermittently. For example: inject failures by crashing processes, expi\", \"red certificates, make dependent services unavailable etc. Frameworks like chaos-monkey can be used \", \"for such chaos testing.\\n\\nApplication resiliency is a must for handling problematic requested operati\", \"ons. But, it's only half of the story. Next, we cover resiliency features available in the Azure clo\", \"ud.\\n\\n## Azure platform resiliency\\n\\nBuilding a reliable application in the cloud is different from tr\", \"aditional on-premises application development. While historically you purchased higher-end hardware \", \"to scale up, in a cloud environment you scale out. Instead of trying to prevent failures, the goal i\", \"s to minimize their effects and keep the system stable.\\n\\nBack end\\n\\nThat said, reliable cloud applica\", \"tions display distinct characteristics:\\n\\n- They're resilient, recover gracefully from problems, and \", \"continue to function.\\n- They're highly available (HA) and run as designed in a healthy state with no\", \" significant downtime.\\n\\nUnderstanding how these characteristics work together - and how they affect \", \"cost - is essential to building a reliable cloudnative application. We'll next look at ways that you\", \" can build resiliency and availability into your cloud-native applications leveraging features from \", \"the Azure cloud.\\n\\n## Design with resiliency\\n\\nWe've said resiliency enables your application to react\", \" to failure and still remain functional. The whitepaper, Resilience in Azure whitepaper, provides gu\", \"idance for achieving resilience in the Azure platform. Here are some key recommendations:\\n\\n- Hardwar\", \"e failure. Build redundancy into the application by deploying components across different fault doma\", \"ins. For example, ensure that Azure VMs are placed in different racks by using Availability Sets.\\n- \", \"Datacenter failure. Build redundancy into the application with fault isolation zones across datacent\", \"ers. For example, ensure that Azure VMs are placed in different fault-isolated datacenters by using \", \"Azure Availability Zones.\\n- Regional failure. Replicate the data and components into another region \", \"so that applications can be quickly recovered. For example, use Azure Site Recovery to replicate Azu\", \"re VMs to another Azure region.\\n- Heavy load. Load balance across instances to handle spikes in usag\", \"e. For example, put two or more Azure VMs behind a load balancer to distribute traffic to all VMs.\\n-\", \" Accidental data deletion or corruption. Back up data so it can be restored if there's any deletion \", \"or corruption. For example, use Azure Backup to periodically back up your Azure VMs.\\n\\n## Design with\", \" redundancy\\n\\nFailures vary in scope of impact. A hardware failure, such as a failed disk, can affect\", \" a single node in a cluster. A failed network switch could affect an entire server rack. Less common\", \" failures, such as loss of power, could disrupt a whole datacenter. Rarely, an entire region becomes\", \" unavailable.\\n\\nRedundancy is one way to provide application resilience. The exact level of redundanc\", \"y needed depends upon your business requirements and will affect both the cost and complexity of you\", \"r system. For example, a multi-region deployment is more expensive and more complex to manage than a\", \" singleregion deployment. You'll need operational procedures to manage failover and failback. The ad\", \"ditional cost and complexity might be justified for some business scenarios, but not others.\\n\\nTo arc\", \"hitect redundancy, you need to identify the critical paths in your application, and then determine i\", \"f there's redundancy at each point in the path? If a subsystem should fail, will the application fai\", \"l over to something else? Finally, you need a clear understanding of those features built\\n\\nSQL\\n\\nWest\", \" US\\n\\nSQL\\n\\nCanada\\n\\nCentral\\n\\nSQL\\n\\nEurope into the Azure cloud platform that you can leverage to meet y\", \"our redundancy requirements. Here are recommendations for architecting redundancy:\\n\\nEast US\\n\\n- Deplo\", \"y multiple instances of services. If your application depends on a single instance of a service, it \", \"creates a single point of failure. Provisioning multiple instances improves both resiliency and scal\", \"ability. When hosting in Azure Kubernetes Service, you can declaratively configure redundant instanc\", \"es (replica sets) in the Kubernetes manifest file. The replica count value can be managed programmat\", \"ically, in the portal, or through autoscaling features.\\n- Leveraging a load balancer. Loadbalancing \", \"distributes your application's requests to healthy service instances and automatically removes unhea\", \"lthy instances from rotation. When deploying to Kubernetes, load balancing can be specified in the K\", \"ubernetes manifest file in the Services section.\\n- Plan for multiregion deployment. If you deploy yo\", \"ur application to a single region, and that region becomes unavailable, your application will also b\", \"ecome unavailable. This may be unacceptable under the terms of your application's service level agre\", \"ements. Instead, consider deploying your application and its services across multiple regions. For e\", \"xample, an Azure Kubernetes Service (AKS) cluster is deployed to a single region. To protect your sy\", \"stem from a regional failure, you might deploy your application to multiple AKS clusters across diff\", \"erent regions and use the Paired Regions feature to coordinate platform updates and prioritize recov\", \"ery efforts.\\n- Enable geo-replication. Geo-replication for services such as Azure SQL Database and C\", \"osmos DB will create secondary replicas of your data across multiple regions. While both services wi\", \"ll automatically replicate data within the same region, geo-replication protects you against a regio\", \"nal outage by enabling you to fail over to a secondary region. Another best practice for geo-replica\", \"tion centers around storing container images. To deploy a service in AKS, you need to store and pull\", \" the image from a repository. Azure Container Registry integrates with AKS and can securely store co\", \"ntainer images. To improve performance and availability, consider geo-replicating your images to a r\", \"egistry in each region where you have an AKS cluster. Each AKS cluster then pulls container images f\", \"rom the local container registry in its region as shown in Figure 6-4:\\n\\nFigure 6-4. Replicated resou\", \"rces across regions\\n\\n<!-- image -->\\n\\nWest \\u2022\\n\\nSQL\\n\\nNetwork\\n\\nInfrastructure\\n\\nAzure\\n\\nTraffic Manager\\n\\n-\", \" Implement a DNS traffic load balancer. Azure Traffic Manager provides high-availability for critica\", \"l applications by load-balancing at the DNS level. It can route traffic to different regions based o\", \"n geography, cluster response time, and even application endpoint health. For example, Azure Traffic\", \" Manager can direct customers to the closest AKS cluster and application instance. If you have multi\", \"ple AKS clusters in different regions, use Traffic Manager to control how traffic flows to the appli\", \"cations that run in each cluster. Figure 6-5 shows this scenario. Load Balancer\\n\\nFigure 6-5. AKS and\", \" Azure Traffic Manager\\n\\n<!-- image -->\\n\\n## Design for scalability\\n\\nThe cloud thrives on scaling. The\", \" ability to increase/decrease system resources to address increasing/decreasing system load is a key\", \" tenet of the Azure cloud. But, to effectively scale an application, you need an understanding of th\", \"e scaling features of each Azure service that you include in your application. Here are recommendati\", \"ons for effectively implementing scaling in your system.\\n\\n- Design for scaling. An application must \", \"be designed for scaling. To start, services should be stateless so that requests can be routed to an\", \"y instance. Having stateless services also means that adding or removing an instance doesn't adverse\", \"ly impact current users.\\n- Partition workloads . Decomposing domains into independent, self-containe\", \"d microservices enable each service to scale independently of others. Typically, services will have \", \"different scalability needs and requirements. Partitioning enables you to scale only what needs to b\", \"e scaled without the unnecessary cost of scaling an entire application.\\n- Favor scale-out. Cloud-bas\", \"ed applications favor scaling out resources as opposed to scaling up. Scaling out (also known as hor\", \"izontal scaling) involves adding more service resources to an existing system to meet and share a de\", \"sired level of performance. Scaling up (also known\\n\\nScale Up (vertical scaling)\\n\\nIncrease capacity b\", \"y adding\\n\\nRAM/CPU/Disk to a single resource\\n\\nas vertical scaling) involves replacing existing resour\", \"ces with more powerful hardware (more disk, memory, and processing cores). Scaling out can be invoke\", \"d automatically with the autoscaling features available in some Azure cloud resources. Scaling out a\", \"cross multiple resources also adds redundancy to the overall system. Finally scaling up a single res\", \"ource is typically more expensive than scaling out across many smaller resources. Figure 6-6 shows t\", \"he two approaches:\\n\\nFigure 6-6. Scale up versus scale out\\n\\n<!-- image -->\\n\\n- Scale proportionally. W\", \"hen scaling a service, think in terms of resource sets . If you were to dramatically scale out a spe\", \"cific service, what impact would that have on back-end data stores, caches and dependent services? S\", \"ome resources such as Cosmos DB can scale out proportionally, while many others can't. You want to e\", \"nsure that you don't scale out a resource to a point where it will exhaust other associated resource\", \"s.\\n- Avoid affinity. A best practice is to ensure a node doesn't require local affinity, often refer\", \"red to as a sticky session . A request should be able to route to any instance. If you need to persi\", \"st state, it should be saved to a distributed cache, such as Azure Redis cache.\\n- Take advantage of \", \"platform autoscaling features. Use built-in autoscaling features whenever possible, rather than cust\", \"om or third-party mechanisms. Where possible, use scheduled scaling rules to ensure that resources a\", \"re available without a startup delay, but add reactive autoscaling to the rules as appropriate, to c\", \"ope with unexpected changes in demand. For more information, see Autoscaling guidance.\\n- Scale out a\", \"ggressively. A final practice would be to scale out aggressively so that you can quickly meet immedi\", \"ate spikes in traffic without losing business. And, then scale in (that is, remove unneeded instance\", \"s) conservatively to keep the system stable. A simple way to implement this is to set the cool down \", \"period, which is the time to wait between scaling operations, to five minutes for adding resources a\", \"nd up to 15 minutes for removing instances.\\n\\n## Built-in retry in services\\n\\nWe encouraged the best p\", \"ractice of implementing programmatic retry operations in an earlier section. Keep in mind that many \", \"Azure services and their corresponding client SDKs also include retry\\n\\nScale Out (horizontal scaling\", \")\\n\\nIncrease capacity by adding resources\\n\\nmechanisms. The following list summarizes retry features i\", \"n the many of the Azure services that are discussed in this book:\\n\\n- Azure Cosmos DB. The DocumentCl\", \"ient class from the client API automatically retires failed attempts. The number of retries and maxi\", \"mum wait time are configurable. Exceptions thrown by the client API are either requests that exceed \", \"the retry policy or non-transient errors.\\n- Azure Redis Cache. The Redis StackExchange client uses a\", \" connection manager class that includes retries on failed attempts. The number of retries, specific \", \"retry policy and wait time are all configurable.\\n- Azure Service Bus. The Service Bus client exposes\", \" a RetryPolicy class that can be configured with a back-off interval, retry count, and TerminationTi\", \"meBuffer, which specifies the maximum time an operation can take. The default policy is nine maximum\", \" retry attempts with a 30second backoff period between attempts.\\n- Azure SQL Database. Retry support\", \" is provided when using the Entity Framework Core library.\\n- Azure Storage. The storage client libra\", \"ry support retry operations. The strategies vary across Azure storage tables, blobs, and queues. As \", \"well, alternate retries switch between primary and secondary storage services locations when the geo\", \"-redundancy feature is enabled.\\n- Azure Event Hubs. The Event Hub client library features a RetryPol\", \"icy property, which includes a configurable exponential backoff feature.\\n\\n## Resilient communication\", \"s\\n\\nThroughout this book, we've embraced a microservice -based architectural approach. While such an \", \"architecture provides important benefits, it presents many challenges:\\n\\n- Out-of-process network com\", \"munication. Each microservice communicates over a network protocol that introduces network congestio\", \"n, latency, and transient faults.\\n- Service discovery. How do microservices discover and communicate\", \" with each other when running across a cluster of machines with their own IP addresses and ports?\\n- \", \"Resiliency. How do you manage short-lived failures and keep the system stable?\\n- Load balancing. How\", \" does inbound traffic get distributed across multiple instances of a microservice?\\n- Security. How a\", \"re security concerns such as transport-level encryption and certificate management enforced?\\n- Distr\", \"ibuted Monitoring. - How do you correlate and capture traceability and monitoring for a single reque\", \"st across multiple consuming microservices?\\n\\nYou can address these concerns with different libraries\", \" and frameworks, but the implementation can be expensive, complex, and time-consuming. You also end \", \"up with infrastructure concerns coupled to business logic.\\n\\nCloud\\n\\nSidecar Proxy\\n\\n## Service mesh\\n\\nM\", \"icroservice\\n\\nSidecar Proxy\\n\\nMicroservice\\n\\nSidecar Proxy\\n\\nMicroservice\\n\\nA better approach is an evolv\", \"ing technology entitled Service Mesh . A service mesh is a configurable infrastructure layer with bu\", \"ilt-in capabilities to handle service communication and the other challenges mentioned above. It dec\", \"ouples these concerns by moving them into a service proxy. The proxy is deployed into a separate pro\", \"cess (called a sidecar) to provide isolation from business code. However, the sidecar is linked to t\", \"he service it's created with it and shares its lifecycle. Figure 6 -7 shows this scenario.\\n\\nMicroser\", \"vice\\n\\nFigure 6-7. Service mesh with a side car\\n\\n<!-- image -->\\n\\nIn the previous figure, note how the\", \" proxy intercepts and manages communication among the microservices and the cluster.\\n\\nA service mesh\", \" is logically split into two disparate components: A data plane and control plane. Figure 6-8 shows \", \"these components and their responsibilities.\\n\\nMicroservice\\n\\nHTTP\\n\\ngRPC\\n\\nC#\\n\\nService 1\\n\\nSidecar Proxy\", \"\\n\\nManagement\\n\\nMonitoring\\n\\nProvisioning\\n\\nScaling\\n\\nFigure 6-8. Service mesh control and data plane\\n\\n<!\", \"-- image -->\\n\\nOnce configured, a service mesh is highly functional. It can retrieve a corresponding \", \"pool of instances from a service discovery endpoint. The mesh can then send a request to a specific \", \"instance, recording the latency and response type of the result. A mesh can choose the instance most\", \" likely to return a fast response based on many factors, including its observed latency for recent r\", \"equests.\\n\\nIf an instance is unresponsive or fails, the mesh will retry the request on another instan\", \"ce. If it returns errors, a mesh will evict the instance from the load-balancing pool and restate it\", \" after it heals. If a request times out, a mesh can fail and then retry the request. A mesh captures\", \" and emits metrics and distributed tracing to a centralized metrics system.\\n\\n## Istio and Envoy\\n\\nWhi\", \"le a few service mesh options currently exist, Istio is the most popular at the time of this writing\", \". Istio is a joint venture from IBM, Google, and Lyft. It's an open -source offering that can be int\", \"egrated into a new or existing distributed application. The technology provides a consistent and com\", \"plete solution to secure, connect, and monitor microservices. Its features include:\\n\\n- Secure servic\", \"e-to-service communication in a cluster with strong identity-based authentication and authorization.\", \"\\n- Automatic load balancing for HTTP, gRPC, WebSocket, and TCP traffic.\\n- Fine-grained control of tr\", \"affic behavior with rich routing rules, retries, failovers, and fault injection.\\n- A pluggable polic\", \"y layer and configuration API supporting access controls, rate limits, and quotas.\\n- Automatic metri\", \"cs, logs, and traces for all traffic within a cluster, including cluster ingress and egress.\\n\\nA key \", \"component for an Istio implementation is a proxy service entitled the Envoy proxy. It runs alongside\", \" each service and provides a platform-agnostic foundation for the following features:\\n\\n- Dynamic ser\", \"vice discovery.\\n- Load balancing.\\n\\nControl Plane\\n\\n- TLS termination.\\n- HTTP and gRPC proxies.\\n- Circ\", \"uit breaker resiliency.\\n- Health checks.\\n- Rolling updates with canary deployments.\\n\\nAs previously d\", \"iscussed, Envoy is deployed as a sidecar to each microservice in the cluster.\\n\\n## Integration with A\", \"zure Kubernetes Services\\n\\nThe Azure cloud embraces Istio and provides direct support for it within A\", \"zure Kubernetes Services. The following links can help you get started:\\n\\n- Installing Istio in AKS\\n-\", \" Using AKS and Istio\\n\\n## References\\n\\n- Polly\\n- Retry pattern\\n- Circuit Breaker pattern\\n- Resilience \", \"in Azure whitepaper\\n- network latency\\n- Redundancy\\n- geo-replication\\n- Azure Traffic Manager\\n- Autos\", \"caling guidance\\n- Istio\\n- Envoy proxy\\n\\n## Monitoring and health\\n\\nMicroservices and cloud-native appl\", \"ications go hand in hand with good DevOps practices. DevOps is many things to many people but perhap\", \"s one of the better definitions comes from cloud advocate and DevOps evangelist Donovan Brown:\\n\\n'Dev\", \"Ops is the union of people, process, and products to enable continuous delivery of value to our end \", \"users.'\\n\\nUnfortunately, with terse definitions, there's always room to say more things. One of the k\", \"ey components of DevOps is ensuring that the applications running in production are functioning prop\", \"erly and efficiently. To gauge the health of the application in p roduction, it's necessary to monit\", \"or the various logs and metrics being produced from the servers, hosts, and the application proper. \", \"The number of different services running in support of a cloud-native application makes monitoring t\", \"he health of individual components and the application as a whole a critical challenge.\\n\\n## Observab\", \"ility patterns\\n\\nJust as patterns have been developed to aid in the layout of code in applications, t\", \"here are patterns for operating applications in a reliable way. Three useful patterns in maintaining\", \" applications have emerged: logging , monitoring , and alerts .\\n\\n## When to use logging\\n\\nNo matter h\", \"ow careful we are, applications almost always behave in unexpected ways in production. When users re\", \"port problems with an application, it's useful to be able to see what was going on with the app when\", \" the problem occurred. One of the most tried and true ways of capturing information about what an ap\", \"plication is doing while it's running is to have the application write down what it's doing. This pr\", \"ocess is known as logging. Anytime failures or problems occur in production, the goal should be to r\", \"eproduce the conditions under which the failures occurred, in a non-production environment. Having g\", \"ood logging in place provides a roadmap for developers to follow in order to duplicate problems in a\", \"n environment that can be tested and experimented with.\\n\\n## Challenges when logging with cloud-nativ\", \"e applications\\n\\nIn traditional applications, log files are typically stored on the local machine. In\", \" fact, on Unix-like operating systems, there's a folder structure defined to hold any logs, typicall\", \"y under /var/log.\\n\\nMonolithic App (scaled out)\\n\\nNode 1\\n\\n- - 7\\n\\nASP.NET MVC app\\n\\nUl Endpoints\\n\\nBusine\", \"ss Logic\\n\\nData Access Logic\\n\\nA\\n\\nLogfile\\n\\nMonolithic App\\n\\n## ASP.NET MVC app Node 2 ASP.NET MVC app N\", \"ode 3 ASP.NET MVC app\\n\\nData Access Logic\\n\\nFigure 7-1. Logging to a file in a monolithic app.\\n\\n<!-- i\", \"mage -->\\n\\nThe usefulness of logging to a flat file on a single machine is vastly reduced in a cloud \", \"environment. Applications producing logs may not have access to the local disk or the local disk may\", \" be highly transient as containers are shuffled around physical machines. Even simple scaling up of \", \"monolithic applications across multiple nodes can make it challenging to locate the appropriate file\", \"-based log file.\\n\\nFigure 7-2. Logging to files in a scaled monolithic app.\\n\\n<!-- image -->\\n\\nCloud-na\", \"tive applications developed using a microservices architecture also pose some challenges for file-ba\", \"sed loggers. User requests may now span multiple services that are run on different machines\\n\\nClient\", \"\\n\\nRequest\\n\\nLocal Log File per Service and may include serverless functions with no access to a local\", \" file system at all. It would be very challenging to correlate the logs from a user or a session acr\", \"oss these many services and machines.\\n\\n## container \\\\_ Local logfile ' container Local logfile,\\n\\nMic\", \"roservice 2\\n\\nFigure 7-3. Logging to local files in a microservices app.\\n\\n<!-- image -->\\n\\nFinally, th\", \"e number of users in some cloud-native applications is high. Imagine that each user generates a hund\", \"red lines of log messages when they log into an application. In isolation, that is manageable, but m\", \"ultiply that over 100,000 users and the volume of logs becomes large enough that specialized tools a\", \"re needed to support effective use of the logs.\\n\\n## Logging in cloud-native applications\\n\\nEvery prog\", \"ramming language has tooling that permits writing logs, and typically the overhead for writing these\", \" logs is low. Many of the logging libraries provide logging different kinds of criticalities, which \", \"can be tuned at run time. For instance, the Serilog library is a popular structured logging library \", \"for .NET that provides the following logging levels:\\n\\n- Verbose\\n- Debug\\n- Information\\n- Warning\\n- Er\", \"ror\\n- Fatal\\n\\nThese different log levels provide granularity in logging. When the application is func\", \"tioning properly in production, it may be configured to only log important messages. When the applic\", \"ation is\\n\\nBackend\\n\\n1\\n\\n| UpdatePrice command\\n\\nDatabase\\n\\n2\\n\\n3\\n\\nImplementing centralized logging misbeh\", \"aving, then the log level can be increased so more verbose logs are gathered. This balances performa\", \"nce against ease of debugging. cache Service 2\\n\\nThe high performance of logging tools and the tunabi\", \"lity of verbosity should encourage developers to log frequently. Many favor a pattern of logging the\", \" entry and exit of each method. This approach may sound like overkill, but it's infrequent that deve\", \"lopers will wish for less logging. In fact, it's not uncommon to perform deployments for the sole pu\", \"rpose of adding logging around a problematic method. Err on the side of too much logging and not on \", \"too little. Some tools can be used to automatically provide this kind of logging. Database Service N\", \"\\n\\nA\\n\\nBecause of the challenges associated with using file-based logs in cloud-native apps, centraliz\", \"ed logs are preferred. Logs are collected by the applications and shipped to a central logging appli\", \"cation which indexes and stores the logs. This class of system can ingest tens of gigabytes of logs \", \"every day.\\n\\nIt's also helpful to follow some standard practices when building logging that spans man\", \"y services. For instance, generating a correlation ID at the start of a lengthy interaction, and the\", \"n logging it in each message that is related to that interaction, makes it easier to search for all \", \"related messages. One need only find a single message and extract the correlation ID to find all the\", \" related messages. Another example is ensuring that the log format is the same for every service, wh\", \"atever the language or logging library it uses. This standardization makes reading logs much easier.\", \" Figure 7-4 demonstrates how a microservices architecture can leverage centralized logging as part o\", \"f its workflow.\\n\\nFigure 7-4. Logs from various sources are ingested into a centralized log store.\\n\\n<\", \"!-- image -->\\n\\n## Challenges with detecting and responding to potential app health issues\\n\\nSome appl\", \"ications aren't mission critical. Maybe they're only used internally, and when a problem occurs, the\", \" user can contact the team responsible and the application can be restarted. However, customers ofte\", \"n have higher expectations for the applications they consume. You should know when problems occur wi\", \"th your application before users do, or before users notify you. Otherwise, the first you know about\", \" a problem may be when you notice an angry deluge of social media posts deriding your application or\", \" even your organization.\\n\\nSome scenarios you may need to consider include:\\n\\n- One service in your ap\", \"plication keeps failing and restarting, resulting in intermittent slow responses.\\n- At some times of\", \" the day, your application's response time is slow.\\n- After a recent deployment, load on the databas\", \"e has tripled.\\n\\nImplemented properly, monitoring can let you know about conditions that will lead to\", \" problems, letting you address underlying conditions before they result in any significant user impa\", \"ct.\\n\\n## Monitoring cloud-native apps\\n\\nSome centralized logging systems take on an additional role of\", \" collecting telemetry outside of pure logs. They can collect metrics, such as time to run a database\", \" query, average response time from a web server, and even CPU load averages and memory pressure as r\", \"eported by the operating system. In conjunction with the logs, these systems can provide a holistic \", \"view of the health of nodes in the system and the application as a whole.\\n\\nThe metric-gathering capa\", \"bilities of the monitoring tools can also be fed manually from within the application. Business flow\", \"s that are of particular interest such as new users signing up or orders being placed, may be instru\", \"mented such that they increment a counter in the central monitoring system. This aspect unlocks the \", \"monitoring tools to not only monitor the health of the application but the health of the business.\\n\\n\", \"Queries can be constructed in the log aggregation tools to look for certain statistics or patterns, \", \"which can then be displayed in graphical form, on custom dashboards. Frequently, teams will invest i\", \"n large, wall-mounted displays that rotate through the s tatistics related to an application. This w\", \"ay, it's simple to see the problems as they occur.\\n\\nCloud-native monitoring tools provide real-time \", \"telemetry and insight into apps regardless of whether they're single -process monolithic application\", \"s or distributed microservice architectures. They include tools that allow collection of data from t\", \"he app as well as tools for querying and displaying information about the app's health.\\n\\n## Challeng\", \"es with reacting to critical problems in cloud-native apps\\n\\nIf you need to react to problems with yo\", \"ur application, you need some way to alert the right personnel. This is the third cloud-native appli\", \"cation observability pattern and depends on logging and monitoring. Your application needs to have l\", \"ogging in place to allow problems to be diagnosed, and\\n\\nin some cases to feed into monitoring tools.\", \" It needs monitoring to aggregate application metrics and health data in one place. Once this has be\", \"en established, rules can be created that will trigger alerts when certain metrics fall outside of a\", \"cceptable levels.\\n\\nGenerally, alerts are layered on top of monitoring such that certain conditions t\", \"rigger appropriate alerts to notify team members of urgent problems. Some scenarios that may require\", \" alerts include:\\n\\n- One of your application's services is not responding after 1 minute of downtime.\", \"\\n- Your application is returning unsuccessful HTTP responses to more than 1% of requests.\\n- Your app\", \"lication's average response time for key endpoints exceeds 2000 ms.\\n\\n## Alerts in cloud-native apps\\n\", \"\\nYou can craft queries against the monitoring tools to look for known failure conditions. For instan\", \"ce, queries could search through the incoming logs for indications of HTTP status code 500, which in\", \"dicates a problem on a web server. As soon as one of these is detected, then an e-mail or an SMS cou\", \"ld be sent to the owner of the originating service who can begin to investigate.\\n\\nTypically, though,\", \" a single 500 error isn't enough to determine that a problem has occurred. It could mean that a user\", \" mistyped their password or entered some malformed data. The alert queries can be crafted to only fi\", \"re when a larger than average number of 500 errors are detected.\\n\\nOne of the most damaging patterns \", \"in alerting is to fire too many alerts for humans to investigate. Service owners will rapidly become\", \" desensitized to errors that they've previously investigated and found to be benign. Then, when true\", \" errors occur, they'll be lost in the noise of hundreds of false positives. The parable of the Boy W\", \"ho Cried Wolf is frequently told to children to warn them of this very danger. It's important to ens\", \"ure that the alerts that do fire are indicative of a real problem.\\n\\n## Logging with Elastic Stack\\n\\nT\", \"here are many good centralized logging tools and they vary in cost from being free, open-source tool\", \"s, to more expensive options. In many cases, the free tools are as good as or better than the paid o\", \"fferings. One such tool is a combination of three open-source components: Elasticsearch, Logstash, a\", \"nd Kibana.\\n\\nCollectively these tools are known as the Elastic Stack or ELK stack.\\n\\n## Elastic Stack\\n\", \"\\nThe Elastic Stack is a powerful option for gathering information from a Kubernetes cluster. Kuberne\", \"tes supports sending logs to an Elasticsearch endpoint, and for the most part, all you need to get s\", \"tarted is to set the environment variables as shown in Figure 7-5:\\n\\nKUBE\\\\_LOGGING\\\\_DESTINATION=elast\", \"icsearch KUBE\\\\_ENABLE\\\\_NODE\\\\_LOGGING=true\\n\\nFigure 7-5. Configuration variables for Kubernetes\\n\\nThis \", \"step will install Elasticsearch on the cluster and target sending all the cluster logs to it.\\n\\nB\\n\\n*\\n\", \"\\n88,833 hits\\n\\nSearch\\u2026.. (e.g. status:200 AND extension:PHP)\\n\\nAdd a filter +\\n\\neshops-*\\n\\nSelected Fiel\", \"ds\\n\\n?\\n\\n\\\\_source\\n\\nAvailable Fields\\n\\n\\u2022 @timestamp t @version\\n\\nt \\\\_id t \\\\_index\\n\\n\\\\_score t \\\\_type\\n\\nt e.\", \"Level t e.MessageTempl...\\n\\nNew Save Open\\n\\nMarch 19th 2019, 15:33:34.099 - March 19th 2019, 15:48:34.\", \"099 \\u2014\\n\\nAuto\\n\\nFigure 7-6. An example of a Kibana dashboard showing the results of a query against log\", \"s that are ingested from Kubernetes\\n\\n<!-- image -->\\n\\n## What are the advantages of Elastic Stack?\\n\\nE\", \"lastic Stack provides centralized logging in a low-cost, scalable, cloud-friendly manner. Its user i\", \"nterface streamlines data analysis so you can spend your time gleaning insights from your data inste\", \"ad of fighting with a clunky interface. It supports a wide variety of inputs so as your distributed \", \"application spans more and different kinds of services, you can expect to continue to be able to fee\", \"d log and metric data into the system. The Elastic Stack also supports fast searches even across lar\", \"ge data sets, making it possible even for large applications to log detailed data and still be able \", \"to have visibility into it in a performant fashion.\\n\\n## Logstash\\n\\nThe first component is Logstash. T\", \"his tool is used to gather log information from a large variety of different sources. For instance, \", \"Logstash can read logs from disk and also receive messages from logging libraries like Serilog. Logs\", \"tash can do some basic filtering and expansion on the logs as they arrive. For instance, if your log\", \"s contain IP addresses then Logstash may be configured to do a geographical lookup and obtain a coun\", \"try/region or even city of origin for that message.\\n\\nSerilog is a logging library for .NET languages\", \", which allows for parameterized logging. Instead of generating a textual log message that embeds fi\", \"elds, parameters are kept separate. This library allows for more intelligent filtering and searching\", \". A sample Serilog configuration for writing to Logstash appears in Figure 7-7.\\n\\n```\\nvar log = new L\", \"oggerConfiguration() .WriteTo.Http(\\\"http://localhost:8080\\\") .CreateLogger();\\n```\\n\\nFigure 7-7. Serilo\", \"g config for writing log information directly to logstash over HTTP\\n\\nLogstash would use a configurat\", \"ion like the one shown in Figure 7-8.\\n\\nShare\\n\\n\\u2022 Last 15 minutes\\n\\nUses lucene query syntax\\n\\n```\\ninput\", \" { http { #default host 0.0.0.0:8080 codec => json } } output { elasticsearch { hosts => \\\"elasticsea\", \"rch:9200\\\" index=>\\\"sales-%{+xxxx.ww}\\\" } }\\n```\\n\\nFigure 7-8. A Logstash configuration for consuming log\", \"s from Serilog\\n\\nFor scenarios where extensive log manipulation isn't needed there's an alternative t\", \"o Logstash known as Beats. Beats is a family of tools that can gather a wide variety of data from lo\", \"gs to network data and uptime information. Many applications will use both Logstash and Beats.\\n\\nOnce\", \" the logs have been gathered by Logstash, it needs somewhere to put them. While Logstash supports ma\", \"ny different outputs, one of the more exciting ones is Elasticsearch.\\n\\n## Elasticsearch\\n\\nElasticsear\", \"ch is a powerful search engine that can index logs as they arrive. It makes running queries against \", \"the logs quick. Elasticsearch can handle huge quantities of logs and, in extreme cases, can be scale\", \"d out across many nodes.\\n\\nLog messages that have been crafted to contain parameters or that have had\", \" parameters split from them through Logstash processing, can be queried directly as Elasticsearch pr\", \"eserves this information.\\n\\nA query that searches for the top 10 pages visited by jill@example.com, a\", \"ppears in Figure 7-9.\\n\\n```\\n\\\"query\\\": { \\\"match\\\": { \\\"user\\\": \\\"jill@example.com\\\" } } , \\\"aggregations\\\": { \", \"\\\"top_10_pages\\\": { \\\"terms\\\": { \\\"field\\\": \\\"page\\\", \\\"size\\\": 10 } } }\\n```\\n\\nFigure 7-9. An Elasticsearch que\", \"ry for finding top 10 pages visited by a user\\n\\n## Visualizing information with Kibana web dashboards\", \"\\n\\nThe final component of the stack is Kibana. This tool is used to provide interactive visualization\", \"s in a web dashboard. Dashboards may be crafted even by users who are non-technical. Most data that \", \"is resident in the Elasticsearch index, can be included in the Kibana dashboards. Individual users m\", \"ay\\n\\nhave different dashboard desires and Kibana enables this customization through allowing userspec\", \"ific dashboards.\\n\\n## Installing Elastic Stack on Azure\\n\\nThe Elastic stack can be installed on Azure \", \"in many ways. As always, it's possible to provision virtual machines and install Elastic Stack on th\", \"em directly. This option is preferred by some experienced users as it offers the highest degree of c\", \"ustomizability. Deploying on infrastructure as a service introduces significant management overhead \", \"forcing those who take that path to take ownership of all the tasks associated with infrastructure a\", \"s a service such as securing the machines and keeping up-to-date with patches.\\n\\nAn option with less \", \"overhead is to make use of one of the many Docker containers on which the Elastic Stack has already \", \"been configured. These containers can be dropped into an existing Kubernetes cluster and run alongsi\", \"de application code. The sebp/elk container is a well-documented and tested Elastic Stack container.\", \"\\n\\nAnother option is a recently announced ELK-as-a-service offering.\\n\\n## References\\n\\n- Install Elasti\", \"c Stack on Azure\\n\\n## Monitoring in Azure Kubernetes Services\\n\\nThe built-in logging in Kubernetes is \", \"primitive. However, there are some great options for getting the logs out of Kubernetes and into a p\", \"lace where they can be properly analyzed. If you need to monitor your AKS clusters, configuring Elas\", \"tic Stack for Kubernetes is a great solution.\\n\\n## Azure Monitor for Containers\\n\\nAzure Monitor for Co\", \"ntainers supports consuming logs from not just Kubernetes but also from other orchestration engines \", \"such as DC/OS, Docker Swarm, and Red Hat OpenShift.\\n\\nOther Clouds\\n\\nVM\\n\\nVM with agent\\n\\nFigure 7-10. C\", \"onsuming logs from various containers\\n\\n<!-- image -->\\n\\nPrometheus is a popular open source metric mo\", \"nitoring solution. It is part of the Cloud Native Compute Foundation. Typically, using Prometheus re\", \"quires managing a Prometheus server with its own store. However, Azure Monitor for Containers provid\", \"es direct integration with Prometheus metrics endpoints, so a separate server is not required.\\n\\nLog \", \"and metric information is gathered not just from the containers running in the cluster but also from\", \" the cluster hosts themselves. It allows correlating log information from the two making it much eas\", \"ier to track down an error.\\n\\nInstalling the log collectors differs on Windows and Linux clusters. Bu\", \"t in both cases the log collection is implemented as a Kubernetes DaemonSet, meaning that the log co\", \"llector is run as a container on each of the nodes.\\n\\nNo matter which orchestrator or operating syste\", \"m is running the Azure Monitor daemon, the log information is forwarded to the same Azure Monitor to\", \"ols with which users are familiar. This approach ensures a parallel experience in environments that \", \"mix different log sources such as a hybrid Kubernetes/Azure Functions environment.\\n\\nLocall\\n\\nVM\\n\\nVM w\", \"ith agent\\n\\nAzure\\n\\nAzure\\n\\nContainers(contosoretail-it)\\n\\n\\u00a9 Refresh\\n\\n@ Solution Settings\\n\\nIP Logs\\n\\n2/26\", \"/19 13:08 - 2/27/19 13:08\\n\\nCONTAINER IMAGES INVENTORY\\n\\n60\\n\\n39\\n\\nTotal Images kubernetes-d... v1.10.1\\n\", \"\\noms ciprod112920\\\\_\\n\\noms ciprod101620\\\\_\\n\\nk8s-dns-kub...\\n\\n1,14.13\\n\\nkubernetes-d... v1.10.0\\n\\nkube-svc-\", \"red. v1.02\\n\\nbusybox latest\\n\\nhop-tunnel-fr... v1.92-14.04\\n\\nhyperkube-a.. v199\\n\\nnginx\\n\\n1.13.12-alpine\\n\", \"\\nSee all.\\n\\nImage Type Count\\n\\nCOUNT\\n\\nCONTAINERS STATUS\\n\\n7\\n\\nTotal Container Nodes\\n\\n300\\n\\nTotal Running \", \"Containers\\n\\nCONTAINER CPU PERFORMANCE\\n\\nCPU Usage Over Time\\n\\n40%\\n\\nFigure 7-11. A sample dashboard sho\", \"wing logging and metric information from many running containers.\\n\\n<!-- image -->\\n\\n## Log.Finalize()\", \"\\n\\nLogging is one of the most overlooked and yet most important parts of deploying any application at\", \" scale. As the size and complexity of applications increase, then so does the difficulty of debuggin\", \"g them. Having top quality logs available makes debugging much easier and moves it from the realm of\", \" 'nearly impossible' to 'a pleasant experience'.\\n\\n## Azure Monitor\\n\\nNo other cloud provider has as m\", \"ature of a cloud application monitoring solution than that found in Azure. Azure Monitor is an umbre\", \"lla name for a collection of tools designed to provide visibility into the state of your system. It \", \"helps you understand how your cloud-native services are performing and proactively identifies issues\", \" affecting them. Figure 7-12 presents a high level of view of Azure Monitor.\\n\\nCONTAINER PROCESS\\n\\nCon\", \"tainer Process Counts\\n\\nCONTAINER MEMORY PERFORMANCE\\n\\nMemory Usage Over Time\\n\\nApplication\\n\\nOperating \", \"System\\n\\nAzure Resources\\n\\nAzure Subscription\\n\\nAzure Tenant\\n\\nCustom Sources\\n\\nAzure Monitor \\u2022\\n\\nInsights\", \"\\n\\nApplication\\n\\nContainer\\n\\nVM\\n\\nMonitoring\\n\\nSolutions\\n\\nFigure 7-12. High-level view of Azure Monitor.\\n\", \"\\n<!-- image -->\\n\\n## Gathering logs and metrics\\n\\nThe first step in any monitoring solution is to gath\", \"er as much data as possible. The more data gathered, the deeper the insights. Instrumenting systems \", \"has traditionally been difficult. Simple Network Management Protocol (SNMP) was the gold standard pr\", \"otocol for collecting machine level information, but it required a great deal of knowledge and confi\", \"guration. Fortunately, much of this hard work has been eliminated as the most common metrics are gat\", \"hered automatically by Azure Monitor.\\n\\nApplication level metrics and events aren't possible to instr\", \"ument automatically because they're specific to the application being deployed. In order to gather t\", \"hese metrics, there are SDKs and APIs available to directly report such information, such as when a \", \"customer signs up or completes an order. Exceptions can also be captured and reported back into Azur\", \"e Monitor via Application Insights. The SDKs support most every language found in Cloud Native Appli\", \"cations including Go, Python, JavaScript, and the .NET languages.\\n\\nThe ultimate goal of gathering in\", \"formation about the state of your application is to ensure that your end users have a good experienc\", \"e. What better way to tell if users are experiencing issues than doing outside-in web tests? These t\", \"ests can be as simple as pinging your website from locations around the world or as involved as havi\", \"ng agents log into the site and simulate user actions.\\n\\n## Reporting data\\n\\nOnce the data is gathered\", \", it can be manipulated, summarized, and plotted into charts, which allow users to instantly see whe\", \"n there are problems. These charts can be gathered into dashboards or into Workbooks, a multi-page r\", \"eport designed to tell a story about some aspect of the system.\\n\\n&lt; Graph\\n\\n# Table 1\\n\\nHAWAII: 10.5\", \"8%\\n\\nKENTUCKY: 7.68%\\\\_\\n\\nGEORGIA: 15.36%\\n\\nCOLORADO: 7.25%\\n\\nALABAMA: 8.12%\\n\\n\\u2022 Done (0.819 s)\\n\\n123\\n\\n10 r\", \"ecords\\n\\n-o ALABAMA\\n\\n-- COLORADO\\n\\n-- GEORGIA\\n\\n-- HAWAII\\n\\n-- KENTUCKY\\n\\n-- MONTANA\\n\\nNo modern applicati\", \"on would be complete without some artificial intelligence or machine learning. To this end, data can\", \" be passed to the various machine learning tools in Azure to allow you to extract trends and informa\", \"tion that would otherwise be hidden.\\n\\nApplication Insights provides a powerful (SQL-like) query lang\", \"uage called Kusto that can query records, summarize them, and even plot charts. For example, the fol\", \"lowing query will locate all records for the month of November 2007, group them by state, and plot t\", \"he top 10 as a pie chart.\\n\\nFigure 7-13 shows the results of this Application Insights Query.\\n\\n<!-- i\", \"mage -->\\n\\nFigure 7-13. Application Insights query results.\\n\\n<!-- image -->\\n\\nThere is a playground fo\", \"r experimenting with Kusto queries. Reading sample queries can also be instructive.\\n\\n## Dashboards\\n\\n\", \"There are several different dashboard technologies that may be used to surface the information from \", \"Azure Monitor. Perhaps the simplest is to just run queries in Application Insights and plot the data\", \" into a chart.\\n\\nFabrikam v + New dashboard 7 Upload Download Edit \\u00a9 Unshare / Full screen D Clone \\u2022 \", \"Delete\\n\\nUTC Time: Past 24 hours\\n\\nFabrikam\\n\\nDaily Statistics\\n\\nEdit\\n\\nThis dashboard includes daily usa\", \"ge and performance statisties for the Fabrikam application\\n\\nAnalytics\\n\\nNAME\\n\\nGET Home/Index\\n\\nGET /\\n\\n\", \"GET /FabrikamProd/Content/fonts/segoew.|\\n\\nGET /FabrikamProd/Content/fonts/segoew...\\n\\nGET ServiceTick\", \"ets/Index\\n\\nGET /Content/fonts/segoewp-light-webfon... 5.86 K\\n\\nGET /Content/fonts/segoewp-webfont.eot\", \"\\n\\nServer response time\\n\\n13.33min\\n\\nFigure 7-14. An example of Application Insights charts embedded in\", \" the main Azure Dashboard.\\n\\n<!-- image -->\\n\\nThese charts can then be embedded in the Azure portal pr\", \"oper through use of the dashboard feature. For users with more exacting requirements, such as being \", \"able to drill down into several tiers of data, Azure Monitor data is available to Power BI. Power BI\", \" is an industry-leading, enterprise class, business intelligence tool that can aggregate data from m\", \"any different data sources.\\n\\nSum Server requests\\n\\n=\\n\\nPower Bl\\n\\nAzure Audit Logs Billing @ Share Dash\", \"board\\n\\nAsk a question about the data on this dashboard\\n\\nEvents by Resource Type\\n\\nOPERATIONAUINSIGHTS\", \"\\n\\nSQL\\n\\nINSIGHTS\\n\\nEvents by Caller\\n\\n65217SPCC3087D778\\\\_\\n\\nk@microsorte- o@microsoftc.\\n\\nEvents by Level\", \" level\\n\\nEvents Over Time\\n\\n200\\n\\nEvents by Status\\n\\nFigure 7-15. An example Power BI dashboard.\\n\\n<!-- i\", \"mage -->\\n\\n## Alerts\\n\\nSometimes, having data dashboards is insufficient. If nobody is awake to watch \", \"the dashboards, then it can still be many hours before a problem is addressed, or even detected. To \", \"this end, Azure Monitor also provides a top notch alerting solution. Alerts can be triggered by a wi\", \"de range of conditions including:\\n\\n- Metric values\\n- Log search queries\\n- Activity Log events\\n- Heal\", \"th of the underlying Azure platform\\n- Tests for web site availability\\n\\nWhen triggered, the alerts ca\", \"n perform a wide variety of tasks. On the simple side, the alerts may just send an e-mail notificati\", \"on to a mailing list or a text message to an individual. More involved alerts\\n\\nGet me started\\n\\nAzure\", \" Audit Logs Billing\\n\\nmight trigger a workflow in a tool such as PagerDuty, which is aware of who is \", \"on call for a particular application. Alerts can trigger actions in Microsoft Flow unlocking near li\", \"mitless possibilities for workflows.\\n\\nAs common causes of alerts are identified, the alerts can be e\", \"nhanced with details about the common causes of the alerts and the steps to take to resolve them. Hi\", \"ghly mature cloud-native application deployments may opt to kick off self-healing tasks, which perfo\", \"rm actions such as removing failing nodes from a scale set or triggering an autoscaling activity. Ev\", \"entually it may no longer be necessary to wake up on-call personnel at 2AM to resolve a live-site is\", \"sue as the system will be able to adjust itself to compensate or at least limp along until somebody \", \"arrives at work the next morning.\\n\\nAzure Monitor automatically leverages machine learning to underst\", \"and the normal operating parameters of deployed applications. This approach enables it to detect ser\", \"vices that are operating outside of their normal parameters. For instance, the typical weekday traff\", \"ic on the site might be 10,000 requests per minute. And then, on a given week, suddenly the number o\", \"f requests hits a highly unusual 20,000 requests per minute. Smart Detection will notice this deviat\", \"ion from the norm and trigger an alert. At the same time, the trend analysis is smart enough to avoi\", \"d firing false positives when the traffic load is expected.\\n\\n## References\\n\\n- Azure Monitor\\n\\n## Clou\", \"d-native identity\\n\\nMost software applications need to have some knowledge of the user or process tha\", \"t is calling them. The user or process interacting with an application is known as a security princi\", \"pal, and the process of authenticating and authorizing these principals is known as identity managem\", \"ent, or simply identity . Simple applications may include all of their identity management within th\", \"e application, but this approach doesn't scale well with many applications and many kinds of securit\", \"y principals. Windows supports the use of Active Directory to provide centralized authentication and\", \" authorization.\\n\\nWhile this solution is effective within corporate networks, it isn't designed for u\", \"se by users or applications that are outside of the AD domain. With the growth of Internet-based app\", \"lications and the rise of cloud-native apps, security models have evolved.\\n\\nIn today's cloud -native\", \" identity model, architecture is assumed to be distributed. Apps can be deployed anywhere and may co\", \"mmunicate with other apps anywhere. Clients may communicate with these apps from anywhere, and in fa\", \"ct, clients may consist of any combination of platforms and devices. Cloud-native identity solutions\", \" use open standards to achieve secure application access from clients. These clients range from huma\", \"n users on PCs or phones, to other apps hosted anywhere online, to set-top boxes and IOT devices run\", \"ning any software platform anywhere in the world.\\n\\nModern cloud-native identity solutions typically \", \"use access tokens that are issued by a secure token service/server (STS) to a security principal onc\", \"e their identity is determined. The access token, typically a JSON Web Token (JWT), includes claims \", \"about the security principal. These claims will minimally include the user's identity but may also i\", \"nclude other claims that can be used by applications to determine the level of access to grant the p\", \"rincipal.\\n\\nTypically, the STS is only responsible for authenticating the principal. Determining thei\", \"r level of access to resources is left to other parts of the application.\\n\\n## References\\n\\n- Microsof\", \"t identity platform\\n\\n## Authentication and authorization in cloud-native apps\\n\\nAuthentication is the\", \" process of determining the identity of a security principal. Authorization is the act of granting a\", \"n authenticated principal permission to perform an action or access a resource. Sometimes authentica\", \"tion is shortened to AuthN and authorization is shortened to AuthZ. Cloud-\\n\\nnative applications need\", \" to rely on open HTTP-based protocols to authenticate security principals since both clients and app\", \"lications could be running anywhere in the world on any platform or device. The only common factor i\", \"s HTTP.\\n\\nMany organizations still rely on local authentication services like Active Directory Federa\", \"tion Services (ADFS). While this approach has traditionally served organizations well for on premise\", \"s authentication needs, cloud-native applications benefit from systems designed specifically for the\", \" cloud. A recent 2019 United Kingdom National Cyber Security Centre (NCSC) advisory states that 'org\", \"anizations using Azure AD as their primary authentication source will actually lower their risk comp\", \"ared to ADFS.' Some reasons outlined in this analysis include:\\n\\n- Access to full set of Microsoft cr\", \"edential protection technologies.\\n- Most organizations are already relying on Azure AD to some exten\", \"t.\\n- Double hashing of NTLM hashes ensures compromise won't allow credentials that work in local Act\", \"ive Directory.\\n\\n## References\\n\\n- Authentication basics\\n- Access tokens and claims\\n- It may be time t\", \"o ditch your on premises authentication services\\n\\n## Azure Active Directory\\n\\nMicrosoft Azure Active \", \"Directory (Azure AD) offers identity and access management as a service. Customers use it to configu\", \"re and maintain who users are, what information to store about them, who can access that information\", \", who can manage it, and what apps can access it. AAD can authenticate users for applications config\", \"ured to use it, providing a single sign-on (SSO) experience. It can be used on its own or be integra\", \"ted with Windows AD running on premises.\\n\\nAzure AD is built for the cloud. It's truly a cloud -nativ\", \"e identity solution that uses a REST-based Graph API and OData syntax for queries, unlike Windows AD\", \", which uses LDAP. On premises Active Directory can sync user attributes to the cloud using Identity\", \" Sync Services, allowing all authentication to take place in the cloud using Azure AD. Alternately, \", \"authentication can be configured via Connect to pass back to local Active Directory via ADFS to be c\", \"ompleted by Windows AD on premises.\\n\\nAzure AD supports company branded sign-in screens, multi-factor\", \"y authentication, and cloud-based application proxies that are used to provide SSO for applications \", \"hosted on premises. It offers different kinds of security reporting and alert capabilities.\\n\\n## Refe\", \"rences\\n\\n- Microsoft identity platform\\n\\nBrowser\\n\\n## IdentityServer for cloud-native applications web \", \"APls\\n\\nIdentityServer is an authentication server that implements OpenID Connect (OIDC) and OAuth 2.0\", \" standards for ASP.NET Core. It's designed to provide a common way to authenticate requests to all o\", \"f your applications, whether they're web, native, mobile, or API endpoints. IdentityServer can be us\", \"ed to implement Single Sign-On (SSO) for multiple applications and application types. It can be used\", \" to authenticate actual users via sign-in forms and similar user interfaces as well as service-based\", \" authentication that typically involves token issuance, verification, and renewal without any user i\", \"nterface. IdentityServer is designed to be a customizable solution. Each instance is typically custo\", \"mized to suit an individual organization and/or set of applications' needs.\\n\\n## Common web app scena\", \"rios\\n\\nTypically, applications need to support some or all of the following scenarios:\\n\\n- Human users\", \" accessing web applications with a browser.\\n- Human users accessing back-end Web APIs from browser-b\", \"ased apps.\\n- Human users on mobile/native clients accessing back-end Web APIs.\\n- Other applications \", \"accessing back-end Web APIs (without an active user or user interface).\\n- Any application may need t\", \"o interact with other Web APIs, using its own identity or delegating to the user's identity.\\n\\nFigure\", \" 8-1. Application types and scenarios.\\n\\n<!-- image -->\\n\\nIn each of these scenarios, the exposed func\", \"tionality needs to be secured against unauthorized use. At a minimum, this typically requires authen\", \"ticating the user or principal making a request for a resource. This authentication may use one of s\", \"everal common protocols such as SAML2p, WS-Fed, or OpenID Connect. Communicating with APIs typically\", \" uses the OAuth2 protocol and its support for security tokens. Separating these critical cross-cutti\", \"ng security concerns and their implementation details from the applications themselves ensures consi\", \"stency and improves security and maintainability.\\n\\nOutsourcing these concerns to a dedicated product\", \" like IdentityServer helps the requirement for every application to solve these problems itself.\\n\\nId\", \"entityServer provides middleware that runs within an ASP.NET Core application and adds support for O\", \"penID Connect and OAuth2 (see supported specifications). Organizations would create their own ASP.NE\", \"T Core app using IdentityServer middleware to act as the STS for all of their token-based security p\", \"rotocols. The IdentityServer middleware exposes endpoints to support standard functionality, includi\", \"ng:\\n\\n- Authorize (authenticate the end user)\\n- Token (request a token programmatically)\\n- Discovery \", \"(metadata about the server)\\n- User Info (get user information with a valid access token)\\n- Device Au\", \"thorization (used to start device flow authorization)\\n- Introspection (token validation)\\n- Revocatio\", \"n (token revocation)\\n- End Session (trigger single sign-out across all apps)\\n\\n## Getting started\\n\\nId\", \"entityServer4 is available under dual license:\\n\\n- RPL - lets you use the IdentityServer4 free if use\", \"d in open-source work\\n- Paid - lets you use the IdentityServer4 in a commercial scenario\\n\\nFor more i\", \"nformation about pricing, see the official product's pricing page.\\n\\nYou can add it to your applicati\", \"ons using its NuGet packages. The main package is IdentityServer4, which has been downloaded over fo\", \"ur million times. The base package doesn't include any user interface code and only supports inmemor\", \"y configuration. To use it with a database, you'll also want a data provider like IdentityServer4.En\", \"tityFramework, which uses Entity Framework Core to store configuration and operational data for Iden\", \"tityServer. For user interface, you can copy files from the Quickstart UI repository into your ASP.N\", \"ET Core MVC application to add support for sign in and sign out using IdentityServer middleware.\\n\\n##\", \" Configuration\\n\\nIdentityServer supports different kinds of protocols and social authentication provi\", \"ders that can be configured as part of each custom installation. This is typically done in the ASP.N\", \"ET Core application's Program class (or in the Startup class in the ConfigureServices method). The c\", \"onfiguration involves specifying the supported protocols and the paths to the servers and endpoints \", \"that will be used. Figure 8-2 shows an example configuration taken from the IdentityServer4 Quicksta\", \"rt UI project:\\n\\n```\\npublic class Startup { public void ConfigureServices(IServiceCollection services\", \") { services.AddMvc();\\n```\\n\\n```\\n// some details omitted services.AddIdentityServer(); services.AddAu\", \"thentication() .AddGoogle(\\\"Google\\\", options => { options.SignInScheme = IdentityServerConstants.Exte\", \"rnalCookieAuthenticationScheme; options.ClientId = \\\"<insert here>\\\"; options.ClientSecret = \\\"<insert \", \"here>\\\"; }) .AddOpenIdConnect(\\\"demoidsrv\\\", \\\"IdentityServer\\\", options => { options.SignInScheme = Iden\", \"tityServerConstants.ExternalCookieAuthenticationScheme; options.SignOutScheme = IdentityServerConsta\", \"nts.SignoutScheme; options.Authority = \\\"https://demo.identityserver.io/\\\"; options.ClientId = \\\"implic\", \"it\\\"; options.ResponseType = \\\"id_token\\\"; options.SaveTokens = true ; options.CallbackPath = new PathS\", \"tring(\\\"/signin-idsrv\\\"); options.SignedOutCallbackPath = new PathString(\\\"/signout-callback-idsrv\\\"); o\", \"ptions.RemoteSignOutPath = new PathString(\\\"/signout-idsrv\\\"); options.TokenValidationParameters = new\", \" TokenValidationParameters { NameClaimType = \\\"name\\\", RoleClaimType = \\\"role\\\" }; }); } }\\n```\\n\\nFigure 8\", \"-2. Configuring IdentityServer.\\n\\n## JavaScript clients\\n\\nMany cloud-native applications use server-si\", \"de APIs and rich client single page applications (SPAs) on the front end. IdentityServer ships a Jav\", \"aScript client (oidc-client.js) via NPM that can be added to SPAs to enable them to use IdentityServ\", \"er for sign in, sign out, and token-based authentication of web APIs.\\n\\n## References\\n\\n- IdentityServ\", \"er documentation\\n- Application types\\n- JavaScript OIDC client\\n\\n## Cloud-native security\\n\\nNot a day g\", \"oes by where the news doesn't contain some story about a company being hacked or somehow losing thei\", \"r customers' data. Even countries/regions aren't immune to the problems created by treating security\", \" as an afterthought. For years, companies have treated the security of customer data and, in fact, t\", \"heir entire networks as something of a 'nice to have'. Windows servers were left unpatched, ancient \", \"versions of PHP kept running, and MongoDB databases left wide open to the world.\\n\\nHowever, there are\", \" starting to be real-world consequences for not maintaining a security mindset when building and dep\", \"loying applications. Many companies learned the hard way what can happen when servers and desktops a\", \"ren't patched during the 2017 outbreak of NotPetya. The cost of these attacks has easily reached int\", \"o the billions, with some estimates putting the losses from this single attack at 10 billion US doll\", \"ars.\\n\\nEven governments aren't immune to hacking incidents. The city of Baltimore was held ransom by \", \"criminals making it impossible for citizens to pay their bills or use city services.\\n\\nThere has also\", \" been an increase in legislation that mandates certain data protections for personal data. In Europe\", \", GDPR has been in effect for more than a year and, more recently, California passed their own versi\", \"on called CCDA, which comes into effect January 1, 2020. The fines under GDPR can be so punishing as\", \" to put companies out of business. Google has already been fined 50 million Euros for violations, bu\", \"t that's just a drop in the bucket compared with the potential fines.\\n\\nIn short, security is serious\", \" business.\\n\\n## Azure security for cloud-native apps\\n\\nCloud-native applications can be both easier an\", \"d more difficult to secure than traditional applications. On the downside, you need to secure more s\", \"maller applications and dedicate more energy to build out the security infrastructure. The heterogen\", \"eous nature of programming languages and styles in most service deployments also means you need to p\", \"ay more attention to security bulletins from many different providers.\\n\\nOn the flip side, smaller se\", \"rvices, each with their own data store, limit the scope of an attack. If an attacker compromises one\", \" system, it's probably more difficult for the attacker to make the jump to another system than it is\", \" in a monolithic application. Process boundaries are strong boundaries. Also, if a database backup g\", \"ets exposed, then the damage is more limited, as that database contains only a subset of data and is\", \" unlikely to contain personal data.\\n\\n## Threat modeling\\n\\nNo matter if the advantages outweigh the di\", \"sadvantages of cloud-native applications, the same holistic security mindset must be followed. Secur\", \"ity and secure thinking must be part of every step of the development and operations story. When pla\", \"nning an application ask questions like:\\n\\n- What would be the impact of this data being lost?\\n- How \", \"can we limit the damage from bad data being injected into this service?\\n- Who should have access to \", \"this data?\\n- Are there auditing policies in place around the development and release process?\\n\\nAll t\", \"hese questions are part of a process called threat modeling. This process tries to answer the questi\", \"on of what threats there are to the system, how likely the threats are, and the potential damage fro\", \"m them.\\n\\nOnce the list of threats has been established, you need to decide whether they're worth mit\", \"igating. Sometimes a threat is so unlikely and expensive to plan for that it isn't worth spending en\", \"ergy on it. For instance, some state level actor could inject changes into the design of a process t\", \"hat is used by millions of devices. Now, instead of running a certain piece of code in Ring 3, that \", \"code is run in Ring 0. This process allows an exploit that can bypass the hypervisor and run the att\", \"ack code on the bare metal machines, allowing attacks on all the virtual machines that are running o\", \"n that hardware.\\n\\nThe altered processors are difficult to detect without a microscope and advanced k\", \"nowledge of the on silicon design of that processor. This scenario is unlikely to happen and expensi\", \"ve to mitigate, so probably no threat model would recommend building exploit protection for it.\\n\\nMor\", \"e likely threats, such as broken access controls permitting Id incrementing attacks (replacing Id=2 \", \"with Id=3 in the URL) or SQL injection, are more attractive to build protections against. The mitiga\", \"tions for these threats are quite reasonable to build and prevent embarrassing security holes that s\", \"mear the company's reputation.\\n\\n## Principle of least privilege\\n\\nOne of the founding ideas in comput\", \"er security is the Principle of Least Privilege (POLP). It's actually a foundational idea in most an\", \"y form of security be it digital or physical. In short, the principle is that any user or process sh\", \"ould have the smallest number of rights possible to execute its task.\\n\\nAs an example, think of the t\", \"ellers at a bank: accessing the safe is an uncommon activity. So, the average teller can't open the \", \"safe themselves. To gain access, they need to escalate their request through a bank manager, who per\", \"forms additional security checks.\\n\\nIn a computer system, a fantastic example is the rights of a user\", \" connecting to a database. In many cases, there's a single user account used to both build the datab\", \"ase structure and run the application. Except in extreme cases, the account running the app lication\", \" doesn't need the ability to update schema information. There should be several accounts that provid\", \"e different levels of privilege. The application should only use the permission level that grants re\", \"ad and writes access to the data in the tables. This kind of protection would eliminate attacks that\", \" aimed to drop database tables or introduce malicious triggers.\\n\\nAlmost every part of building a clo\", \"ud-native application can benefit from remembering the principle of least privilege. You can find it\", \" at play when setting up firewalls, network security groups, roles, and scopes in Role-based access \", \"control (RBAC).\\n\\n## Penetration testing\\n\\nAs applications become more complicated the number of attac\", \"k vectors increases at an alarming rate. Threat modeling is flawed in that it tends to be executed b\", \"y the same people building the system. In the same way that many developers have trouble envisioning\", \" user interactions and then build unusable user interfaces, most developers have difficulty seeing e\", \"very attack vector. It's also possible that the developers building the system aren't well versed in\", \" attack methodologies and miss something crucial.\\n\\nPenetration testing or 'pen testing' involves bri\", \"nging in external actors to attempt to attack the system. These attackers may be an external consult\", \"ing company or other developers with good security knowledge from another part of the business. They\", \"'re giv en carte blanche to attempt to subvert the system. Frequently, they'll find extensive securi\", \"ty holes that need to be patched. Sometimes the attack vector will be something totally unexpected l\", \"ike exploiting a phishing attack against the CEO.\\n\\nAzure itself is constantly undergoing attacks fro\", \"m a team of hackers inside Microsoft. Over the years, they've been the first to find dozens of poten\", \"tially catastrophic attack vectors, closing them before they can be exploited externally. The more t\", \"empting a target, the more likely that eternal actors will attempt to exploit it and there are a few\", \" targets in the world more tempting than Azure.\\n\\n## Monitoring\\n\\nShould an attacker attempt to penetr\", \"ate an application, there should be some warning of it. Frequently, attacks can be spotted by examin\", \"ing the logs from services. Attacks leave telltale signs that can be spotted before they succeed. Fo\", \"r instance, an attacker attempting to guess a password will make many requests to a login system. Mo\", \"nitoring around the login system can detect weird patterns that are out of line with the typical acc\", \"ess pattern. This monitoring can be turned into an alert that can, in turn, alert an operations pers\", \"on to activate some sort of countermeasure. A highly mature monitoring system might even take action\", \" based on these deviations proactively adding rules to block requests or throttle responses.\\n\\n## Sec\", \"uring the build\\n\\nOne place where security is often overlooked is around the build process. Not only \", \"should the build run security checks, such as scanning for insecure code or checked-in credentials, \", \"but the build itself should be secure. If the build server is compromised, then it provides a fantas\", \"tic vector for introducing arbitrary code into the product.\\n\\nImagine that an attacker is looking to \", \"steal the passwords of people signing into a web application. They could introduce a build step that\", \" modifies the checked-out code to mirror any login request to another server. The next time code goe\", \"s through the bui ld, it's silently updated. The source code vulnerability scanning won't catch this\", \" vulnerability as it runs before the build. Equally, nobody will\\n\\ncatch it in a code review because \", \"the build steps live on the build server. The exploited code will go to production where it can harv\", \"est passwords. Probably there's no audit log of the build process changes, or at least nobody monito\", \"ring the audit.\\n\\nThis scenario is a perfect example of a seemingly low-value target that can be used\", \" to break into the system. Once an attacker breaches the perimeter of the system, they can start wor\", \"king on finding ways to elevate their permissions to the point that they can cause real harm anywher\", \"e they like.\\n\\n## Building secure code\\n\\n.NET Framework is already a quite secure framework. It avoids\", \" some of the pitfalls of unmanaged code, such as walking off the ends of arrays. Work is actively do\", \"ne to fix security holes as they're discovered. There's even a bug bounty program that pays research\", \"ers to find issues in the framework and report them instead of exploiting them.\\n\\nThere are many ways\", \" to make .NET code more secure. Following guidelines such as the Secure coding guidelines for .NET a\", \"rticle is a reasonable step to take to ensure that the code is secure from the ground up. The OWASP \", \"top 10 is another invaluable guide to build secure code.\\n\\nThe build process is a good place to put s\", \"canning tools to detect problems in source code before they make it into production. Most every proj\", \"ect has dependencies on some other packages. A tool that can scan for outdated packages will catch p\", \"roblems in a nightly build. Even when building Docker images, it's useful to check and make sure tha\", \"t the base image doesn't have known vulnerabilities. Another thing to check is that nobody has accid\", \"entally checked in credentials.\\n\\n## Built-in security\\n\\nAzure is designed to balance usability and se\", \"curity for most users. Different users are going to have different security requirements, so they ne\", \"ed to fine-tune their approach to cloud security. Microsoft publishes a great deal of security infor\", \"mation in the Trust Center. This resource should be the first stop for those professionals intereste\", \"d in understanding how the built-in attack mitigation technologies work.\\n\\nWithin the Azure portal, t\", \"he Azure Advisor is a system that is constantly scanning an environment and making recommendations. \", \"Some of these recommendations are designed to save users money, but others are designed to identify \", \"potentially insecure configurations, such as having a storage container open to the world and not pr\", \"otected by a Virtual Network.\\n\\n## Azure network infrastructure\\n\\nIn an on-premises deployment environ\", \"ment, a great deal of energy is dedicated to setting up networking. Setting up routers, switches, an\", \"d the such is complicated work. Networks allow certain resources to talk to other resources and prev\", \"ent access in some cases. A frequent network rule is to restrict access to the production environmen\", \"t from the development environment on the off chance that a half-developed piece of code runs awry a\", \"nd deletes a swath of data.\\n\\nOut of the box, most PaaS Azure resources have only the most basic and \", \"permissive networking setup. For instance, anybody on the Internet can access an app service. New SQ\", \"L Server instances typically\\n\\nInternet come restricted, so that external parties can't access them, \", \"but the IP address ranges used by Azure itself are permitted through. So, while the SQL server is pr\", \"otected from external threats, an attacker only needs to set up an Azure bridgehead from where they \", \"can launch attacks against all SQL instances on Azure.\\n\\nGateway\\n\\nFortunately, most Azure resources c\", \"an be placed into an Azure Virtual Network that allows finegrained access control. Similar to the wa\", \"y that on-premises networks establish private networks that are protected from the wider world, virt\", \"ual networks are islands of private IP addresses that are located within the Azure network.\\n\\nFigure \", \"9-1. A virtual network in Azure.\\n\\n<!-- image -->\\n\\nIn the same way that on-premises networks have a f\", \"irewall governing access to the network, you can establish a similar firewall at the boundary of the\", \" virtual network. By default, all the resources on a virtual network can still talk to the Internet.\", \" It's only incoming connections that require some form of explicit firewall exception.\\n\\nWith the net\", \"work established, internal resources like storage accounts can be set up to only allow for access by\", \" resources that are also on the Virtual Network. This firewall provides an extra level of security, \", \"should the keys for that storage account be leaked, attackers wouldn't be able to connect to it to e\", \"xploit the leaked keys. This scenario is another example of the principle of least privilege.\\n\\nThe n\", \"odes in an Azure Kubernetes cluster can participate in a virtual network just like other resources t\", \"hat are more native to Azure. This functionality is called Azure Container Networking Interface. In \", \"effect, it allocates a subnet within the virtual network on which virtual machines and container ima\", \"ges are allocated.\\n\\nContinuing down the path of illustrating the principle of least privilege, not e\", \"very resource within a Virtual Network needs to talk to every other resource. For instance, in an ap\", \"plication that provides a\\n\\nUser\\n\\nSecurity principal web API over a storage account and a SQL databas\", \"e, it's unlikely that the database and the storage account need to talk to one another. Any data sha\", \"ring between them would go through the web application. So, a network security group (NSG) could be \", \"used to deny traffic between the two services.\\n\\nA policy of denying communication between resources \", \"can be annoying to implement, especially coming from a background of using Azure without traffic res\", \"trictions. On some other clouds, the concept of network security groups is much more prevalent. For \", \"instance, the default policy on AWS is that resources can't communicate among themselves until enabl\", \"ed by rules in an NSG. While slower to develop this, a more restrictive environment provides a more \", \"secure default. Making use of proper DevOps practices, especially using Azure Resource Manager or Te\", \"rraform to manage permissions can make controlling the rules easier.\\n\\nVirtual Networks can also be u\", \"seful when setting up communication between on-premises and cloud resources. A virtual private netwo\", \"rk can be used to seamlessly attach the two networks together. This approach allows running a virtua\", \"l network without any sort of gateway for scenarios where all the users are on-site. There are a num\", \"ber of technologies that can be used to establish this network. The simplest is to use a site-to-sit\", \"e VPN that can be established between many routers and Azure. Traffic is encrypted and tunneled over\", \" the Internet at the same cost per byte as any other traffic. For scenarios where more bandwidth or \", \"more security is desirable, Azure offers a service called Express Route that uses a private circuit \", \"between an onpremises network and Azure. It's more costly and difficult to establish but also more s\", \"ecure.\\n\\n## Role-based access control for restricting access to Azure resources\\n\\nRBAC is a system tha\", \"t provides an identity to applications running in Azure. Applications can access resources using thi\", \"s identity instead of or in addition to using keys or passwords.\\n\\n## Security Principals\\n\\nThe first \", \"component in RBAC is a security principal. A security principal can be a user, group, service princi\", \"pal, or managed identity.\\n\\nFigure 9-2. Different types of security principals.\\n\\n<!-- image -->\\n\\n- Us\", \"er - Any user who has an account in Azure Active Directory is a user.\\n- Group - A collection of user\", \"s from Azure Active Directory. As a member of a group, a user takes on the roles of that group in ad\", \"dition to their own.\\n- Service principal - A security identity under which services or applications \", \"run.\\n\\nOwner\\n\\nContributor\\n\\nReader\\n\\nBackup Operator\\n\\n2 Role definition\\n\\nContributor\\n\\n- Managed identit\", \"y - An Azure Active Directory identity managed by Azure. Managed identities are typically used when \", \"developing cloud applications that manage the credentials for authenticating to Azure services.\\n\\nThe\", \" security principal can be applied to most any resource. This aspect means that it's possible to ass\", \"ign a security principal to a container running within Azure Kubernetes, allowing it to access secre\", \"ts stored in Key Vault. An Azure Function could take on a permission allowing it to talk to an Activ\", \"e Directory instance to validate a JWT for a calling user. Once services are enabled with a service \", \"principal, their permissions can be managed granularly using roles and scopes.\\n\\nReader Support Ticke\", \"ts\\n\\n## Roles\\n\\nA security principal can take on many roles or, using a more sartorial analogy, wear m\", \"any hats. Each role defines a series of permissions such as 'Read messages from Azure Service Bus en\", \"dpoint'. The effective permission set of a security principal is the combination of all the permissi\", \"ons assigned to all the roles that a security principal has. Azure has a large number of built-in ro\", \"les and users can define their own roles.\\n\\nFigure 9-3. RBAC role definitions.\\n\\n<!-- image -->\\n\\nBuilt\", \" into Azure are also a number of high-level roles such as Owner, Contributor, Reader, and User Accou\", \"nt Administrator. With the Owner role, a security principal can access all resources and assign perm\", \"issions to others. A contributor has the same level of access to all resources but they can't assign\", \" permissions. A Reader can only view existing Azure resources and a User Account Administrator can m\", \"anage access to Azure resources.\\n\\nMore granular built-in roles such as DNS Zone Contributor have rig\", \"hts limited to a single service. Security principals can take on any number of roles.\\n\\n\\\"/\\\"\\n\\n+ Add\\n\\n=\", \"= Edit columns Refresh\\n\\nCheck access\\n\\nI Removel\\n\\nRoles\\n\\nAdd a role assignment\\n\\nGrant access to resou\", \"rces at this scope by assigning a role to a user, group, service\\n\\nprincipal, or managed identity.\\n\\nR\", \"ole assignments Deny assignments Classic administrators\\n\\nCheck access\\n\\nReview the level of access a \", \"user, group, service principal, or managed identity has to this resource. Learn more I\\n\\nFind 0\\n\\n## S\", \"copes\\n\\nAzure AD user, group, or service principal\\n\\nView role assignments\\n\\nView the users, groups, se\", \"rvice principals assignments granting them access at this\\n\\nRoles can be applied to a restricted set \", \"of resources within Azure. For instance, applying scope to the previous example of reading from a Se\", \"rvice Bus queue, you can narrow the permission to a single queue: 'Read messages from Azure Service \", \"Bus endpoint blah.servicebus.windows.net/queue1'\\n\\nThe scope can be as narrow as a single resource or\", \" it can be applied to an entire resource group, subscription, or even management group. View the use\", \"rs, groups, service principals\\n\\nView\\n\\nLearn more Z\\n\\nWhen testing if a security principal has certain\", \" permission, the combination of role and scope are taken into account. This combination provides a p\", \"owerful authorization mechanism.\\n\\n## Deny\\n\\nPreviously, only 'allow' rules were permitted for RBAC. T\", \"his behavior made some scopes complicated to build. For instance, allowing a security principal acce\", \"ss to all storage accounts except one required granting explicit permission to a potentially endless\", \" list of storage accounts. Every time a new storage account was created, it would have to be added t\", \"o this list of accounts. This added management overhead that certainly wasn't desirable.\\n\\nDeny rules\", \" take precedence over allow rules. Now representing the same 'allow all but one' scope could be repr\", \"esented as two rules 'allow all' and 'deny this one specific one'. Deny rules not only ease manageme\", \"nt but allow for resources that are extra secure by denying access to everybody.\\n\\n## Checking access\", \"\\n\\nAs you can imagine, having a large number of roles and scopes can make figuring out the effective \", \"permission of a service principal quite difficult. Piling deny rules on top of that, only serves to \", \"increase the complexity. Fortunately, there's a permissions calculator that can show the effective p\", \"ermissions for any service principal. It's typically found under the IAM tab in the portal, as shown\", \" in Figure 9 -3.\\n\\nFigure 9-4. Permission calculator for an app service.\\n\\n<!-- image -->\\n\\nand managed\", \" identities that have role iM\\n\\n## Securing secrets\\n\\nPasswords and certificates are a common attack v\", \"ector for attackers. Password-cracking hardware can do a bruteforce attack and try to guess billions\", \" of passwords per second. So it's important that the passwords that are used to access resources are\", \" strong, with a large variety of characters. These passwords are exactly the kind of passwords that \", \"are near impossible to remember. Fortunately, the passwords in Azure don't actually need to be known\", \" by any human.\\n\\nMany security experts suggest that using a password manager to keep your own passwor\", \"ds is the best approach. While it centralizes your passwords in one location, it also allows using h\", \"ighly complex passwords and ensuring they're unique for each account. The same system exists within \", \"A zure: a central store for secrets.\\n\\n## Azure Key Vault\\n\\nAzure Key Vault provides a centralized loc\", \"ation to store passwords for things such as databases, API keys, and certificates. Once a secret is \", \"entered into the Vault, it's never shown again and the commands to extract and view it are purposefu\", \"lly complicated. The information in the safe is protected using either software encryption or FIPS 1\", \"40-2 Level 2 validated Hardware Security Modules.\\n\\nAccess to the key vault is provided through RBACs\", \", meaning that not just any user can access the information in the vault. Say a web application wish\", \"es to access the database connection string stored in Azure Key Vault. To gain access, applications \", \"need to run using a service principal. Under this assumed role, they can read the secrets from the s\", \"afe. There are a number of different security settings that can further limit the access that an app\", \"lication has to the vault, so that it can't update secrets but only read them.\\n\\nAccess to the key va\", \"ult can be monitored to ensure that only the expected applications are accessing the vault. The logs\", \" can be integrated back into Azure Monitor, unlocking the ability to set up alerts when unexpected c\", \"onditions are encountered.\\n\\n## Kubernetes\\n\\nWithin Kubernetes, there's a similar service for maintain\", \"ing small pieces of secret information. Kubernetes Secrets can be set via the typical kubectl execut\", \"able.\\n\\nCreating a secret is as simple as finding the base64 version of the values to be stored:\\n\\n```\", \"\\necho -n 'admin' | base64 YWRtaW4= echo -n '1f2d1e2e67df' | base64 MWYyZDFlMmU2N2Rm\\n```\\n\\nThen adding\", \" it to a secrets file named secret.yml for example that looks similar to the following example:\\n\\n```\", \"\\napiVersion : v1 kind : Secret metadata : name : mysecret\\n```\\n\\n| type : Opaque   |\\n|----------------\", \"-|\\n\\nFinally, this file can be loaded into Kubernetes by running the following command:\\n\\n| apply -f .\", \"/secret.yaml   | kubectl   |\\n|--------------------------|-----------|\\n\\nThese secrets can then be mou\", \"nted into volumes or exposed to container processes through environment variables. The Twelve-factor\", \" app approach to building applications suggests using the lowest common denominator to transmit sett\", \"ings to an application. Environment variables are the lowest common denominator, because they're sup\", \"ported no matter the operating system or application.\\n\\nAn alternative to use the built-in Kubernetes\", \" secrets is to access the secrets in Azure Key Vault from within Kubernetes. The simplest way to do \", \"this is to assign an RBAC role to the container looking to load secrets. The application can then us\", \"e the Azure Key Vault APIs to access the secrets. However, this approach requires modifications to t\", \"he code and doesn't follow the pattern of using environment variables. Instead, it's possible to inj\", \"ect values into a container. This approach is actually more secure than using the Kubernetes secrets\", \" directly, as they can be accessed by users on the cluster.\\n\\n## Encryption in transit and at rest\\n\\nK\", \"eeping data safe is important whether it's on disk or transiting between various different services.\", \" The most effective way to keep data from leaking is to encrypt it into a format that can't be easil\", \"y read by others. Azure supports a wide range of encryption options.\\n\\n## In transit\\n\\nThere are sever\", \"al ways to encrypt traffic on the network in Azure. The access to Azure services is typically done o\", \"ver connections that use Transport Layer Security (TLS). For instance, all the connections to the Az\", \"ure APIs require TLS connections. Equally, connections to endpoints in Azure storage can be restrict\", \"ed to work only over TLS encrypted connections.\\n\\nTLS is a complicated protocol and simply knowing th\", \"at the connection is using TLS isn't sufficient to ensure security. For instance, TLS 1.0 is chronic\", \"ally insecure, and TLS 1.1 isn't much better. Even within the versions of TLS, there are various set\", \"tings that can make the connections easier to decrypt. The best course of action is to check and see\", \" if the server connection is using up-to-date and well configured protocols.\\n\\nThis check can be done\", \" by an external service such as SSL labs' SSL Server Test. A test run against a typical Azure endpoi\", \"nt, in this case a service bus endpoint, yields a near perfect score of A.\\n\\nEven services like Azure\", \" SQL databases use TLS encryption to keep data hidden. The interesting part about encrypting the dat\", \"a in transit using TLS is that it isn't possible, even for Microsoft, to listen in on the connection\", \" between computers running TLS. This should provide comfort for companies concerned that their data \", \"may be at risk from Microsoft proper or even a state actor with more resources than the standard att\", \"acker.\\n\\nSSL Report: todeletesoon.servicebus.windows.net (23.99.80.186)\\n\\nAssessed on: Sun, 09 Jun 201\", \"9 05:15:43 UTC | Hide | Clear cache\\n\\nSummary\\n\\n## Overall Rating\\n\\nCertificate\\n\\nFigure 9-5. SSL labs r\", \"eport showing a score of A for a Service Bus endpoint.\\n\\n<!-- image -->\\n\\nWhile this level of encrypti\", \"on isn't going to be sufficient for all time, it should inspire confidence that Azure TLS connection\", \"s are quite secure. Azure will continue to evolve its security standards as encryption improves. It'\", \"s nice to know that there's somebody watching the security standards and updating Azure as they impr\", \"ove.\\n\\n## At rest\\n\\nIn any application, there are a number of places where data rests on the disk. The\", \" application code itself is loaded from some storage mechanism. Most applications also use some kind\", \" of a database such as SQL Server, Cosmos DB, or even the amazingly price-efficient Table Storage. T\", \"hese databases all use heavily encrypted storage to ensure that nobody other than the applications w\", \"ith proper permissions can read your data. Even the system operators can't read data that has been e\", \"ncrypted. So customers can remain confident their secret information remains secret.\\n\\n## Storage\\n\\nTh\", \"e underpinning of much of Azure is the Azure Storage engine. Virtual machine disks are mounted on to\", \"p of Azure Storage. Azure Kubernetes Service runs on virtual machines that, themselves, are hosted o\", \"n Azure Storage. Even serverless technologies, such as Azure Functions Apps and Azure Container Inst\", \"ances, run out of disk that is part of Azure Storage.\\n\\nIf Azure Storage is well encrypted, then it p\", \"rovides for a foundation for most everything else to also be encrypted. Azure Storage is encrypted w\", \"ith FIPS 140-2 compliant 256-bit AES. This is a wellregarded encryption technology having been the s\", \"ubject of extensive academic scrutiny over the last 20 or so years. At present, there's no known pra\", \"ctical attack that would allow someone without knowledge of the key to read data encrypted by AES.\\n\\n\", \"By default, the keys used for encrypting Azure Storage are managed by Microsoft. There are extensive\", \" protections in place to ensure to prevent malicious access to these keys. However, users with parti\", \"cular encryption requirements can also provide their own storage keys that are managed in Azure\\n\\nSca\", \"n Another \\u00bb\\n\\nKey Vault. These keys can be revoked at any time, which would effectively render the co\", \"ntents of the Storage account using them inaccessible.\\n\\nVirtual machines use encrypted storage, but \", \"it's possible to provide another layer of encryption by using technologies like BitLocker on Windows\", \" or DM-Crypt on Linux. These technologies mean that even if the disk image was leaked off of storage\", \", it would remain near impossible to read it.\\n\\n## Azure SQL\\n\\nDatabases hosted on Azure SQL use a tec\", \"hnology called Transparent Data Encryption (TDE) to ensure data remains encrypted. It's enabled by d\", \"efault on all newly created SQL databases, but must be enabled manually for legacy databases. TDE ex\", \"ecutes real-time encryption and decryption of not just the database, but also the backups and transa\", \"ction logs.\\n\\nThe encryption parameters are stored in the master database and, on startup, are read i\", \"nto memory for the remaining operations. This means that the master database must remain unencrypted\", \". The actual key is managed by Microsoft. However, users with exacting security requirements may pro\", \"vide their own key in Key Vault in much the same way as is done for Azure Storage. The Key Vault pro\", \"vides for such services as key rotation and revocation.\\n\\nThe 'Transparent' part of TDS comes from th\", \"e fact that there aren't client changes needed to use an encrypted database. While this approach pro\", \"vides for good security, leaking the database password is enough for users to be able to decrypt the\", \" data. There' s another approach that encrypts individual columns or tables in a database. Always En\", \"crypted ensures that at no point the encrypted data appears in plain text inside the database.\\n\\nSett\", \"ing up this tier of encryption requires running through a wizard in SQL Server Management Studio to \", \"select the sort of encryption and where in Key Vault to store the associated keys.\\n\\nAlways Encrypted\", \"\\n\\nColumn Selection\\n\\nIntroduction\\n\\nColumn Selection\\n\\nMaster Key Configuration\\n\\nValidation\\n\\nSummary\\n\\nR\", \"esults\\n\\nFigure 9-6. Selecting columns in a table to be encrypted using Always Encrypted.\\n\\n<!-- image\", \" -->\\n\\nClient applications that read information from these encrypted columns need to make special al\", \"lowances to read encrypted data. Connection strings need to be updated with Column Encryption Settin\", \"g=Enabled and client credentials must be retrieved from the Key Vault. The SQL Server client must th\", \"en be primed with the column encryption keys. Once that is done, the remaining actions use the stand\", \"ard interfaces to SQL Client. That is, tools like Dapper and Entity Framework, which are built on to\", \"p of SQL Client, will continue to work without changes. Always Encrypted may not yet be available fo\", \"r every SQL Server driver on every language.\\n\\nThe combination of TDE and Always Encrypted, both of w\", \"hich can be used with client-specific keys, ensures that even the most exacting encryption requireme\", \"nts are supported.\\n\\n## Cosmos DB\\n\\nCosmos DB is the newest database provided by Microsoft in Azure. I\", \"t has been built from the ground up with security and cryptography in mind. AES-256bit encryption is\", \" standard for all Cosmos DB\\n\\nSecret Store\\n\\nStores Sk\\n\\nDeploy Sk databases and can't be disabled. Cou\", \"pled with the TLS 1.2 requirement for communication, the entire storage solution is encrypted.\\n\\nSk[E\", \"ncryption keyk]\\n\\nFigure 9-7. The flow of data encryption within Cosmos DB.\\n\\n<!-- image -->\\n\\nWhile Co\", \"smos DB doesn't provide for supplying customer encryption keys, there has been significant work done\", \" by the team to ensure it remains PCIDSS compliant without that. Cosmos DB also doesn't support any \", \"sort of single column encryption similar to Azu re SQL's Always Encrypted yet.\\n\\n## Keeping secure\\n\\nA\", \"zure has all the tools necessary to release a highly secure product. However, a chain is only as str\", \"ong as its weakest link. If the applications deployed on top of Azure aren't developed with a proper\", \" security mindset and good security audits, then they become the weak link in the chain. There are m\", \"any great static analysis tools, encryption libraries, and security practices that can be used to en\", \"sure that the software installed on Azure is as secure as Azure itself. Examples include static anal\", \"ysis tools, encryption libraries, and security practices.\\n\\n## DevOps\\n\\nThe favorite mantra of softwar\", \"e consultants is to answer 'It depends' to any question posed. It isn't because software consultants\", \" are fond of not taking a position. It's because there's no one true answer to any questions in soft\", \"ware. There's no absolute right and wrong, but rather a balance between opposites.\\n\\nTake, for instan\", \"ce, the two major schools of developing web applications: Single Page Applications (SPAs) versus ser\", \"ver-side applications. On the one hand, the user experience tends to be better with SPAs and the amo\", \"unt of traffic to the web server can be minimized making it possible to host them on something as si\", \"mple as static hosting. On the other hand, SPAs tend to be slower to develop and more difficult to t\", \"est. Which one is the right choice? Well, it depends on your situation.\\n\\nCloudnative applications ar\", \"en't immune to that same dichotomy. They have clear advantages in terms of speed of development, sta\", \"bility, and scalability, but managing them can be quite a bit more difficult.\\n\\nYears ago, it wasn't \", \"uncommon for the process of moving an application from development to production to take a month, or\", \" even more. Companies released software on a 6-month or even every year cadence. One needs to look n\", \"o further than Microsoft Windows to get an idea for the cadence of releases that were acceptable bef\", \"ore the ever-green days of Windows 10. Five years passed between Windows XP and Vista, a further thr\", \"ee between Vista and Windows 7.\\n\\nIt's now fairly well established that being able to release softwar\", \"e rapidly gives fast -moving companies a huge market advantage over their more slothlike competitors\", \". It's for that reason that major updates to Windows 10 are now approximately every six months.\\n\\nThe\", \" patterns and practices that enable faster, more reliable releases to deliver value to the business \", \"are collectively known as DevOps. They consist of a wide range of ideas spanning the entire software\", \" development life cycle from specifying an application all the way up to delivering and operating th\", \"at application.\\n\\nDevOps emerged before microservices and it's likely that the movement towards small\", \"er, more fit to purpose services wouldn't have been possible without DevOps to make releasing and op\", \"erating not just one but many applications in production easier.\\n\\n\\u2022 microservices\\n\\nSearch term\\n\\nUnit\", \"ed States\\n\\nAzure\\n\\nBoards\\n\\nInterest over time i\\n\\n100\\n\\n75\\n\\n50\\n\\n25\\n\\nMay 1, 2009\\n\\n: \\\"\\n\\nDevOps\\n\\nSearch te\", \"rm\\n\\nAll categories\\n\\n:\\n\\n+ Add comparison\\n\\nFigure 10-1 - DevOps and microservices.\\n\\n<!-- image -->\\n\\nTh\", \"rough good DevOps practices, it's possible to realize the advantages of cloud -native applications w\", \"ithout suffocating under a mountain of work actually operating the applications.\\n\\nThere's no golden \", \"hammer when it comes to DevOps. Nobody can sell a complete and all -encompassing solution for releas\", \"ing and operating high-quality applications. This is because each application is wildly different fr\", \"om all others. However, there are tools that can make DevOps a far less daunting proposition. One of\", \" these tools is known as Azure DevOps.\\n\\n## Azure DevOps\\n\\nAzure DevOps has a long pedigree. It can tr\", \"ace its roots back to when Team Foundation Server first moved online and through the various name ch\", \"anges: Visual Studio Online and Visual Studio Team Services. Through the years, however, it has beco\", \"me far more than its predecessors.\\n\\nAzure DevOps is divided into five major components:\\n\\nFigure 10-2\", \" - Azure DevOps.\\n\\n<!-- image -->\\n\\nAzure Repos - Source code management that supports the venerable T\", \"eam Foundation Version Control (TFVC) and the industry favorite Git. Pull requests provide a way to \", \"enable social coding by fostering discussion of changes as they're made.\\n\\nAverage\\n\\nAzure Boards - Pr\", \"ovides an issue and work item tracking tool that strives to allow users to pick the workflows that w\", \"ork best for them. It comes with a number of pre-configured templates including ones to support SCRU\", \"M and Kanban styles of development.\\n\\nAzure Pipelines - A build and release management system that su\", \"pports tight integration with Azure. Builds can be run on various platforms from Windows to Linux to\", \" macOS. Build agents may be provisioned in the cloud or on-premises.\\n\\nAzure Test Plans - No QA perso\", \"n will be left behind with the test management and exploratory testing support offered by the Test P\", \"lans feature.\\n\\nAzure Artifacts - An artifact feed that allows companies to create their own, interna\", \"l, versions of NuGet, npm, and others. It serves a double purpose of acting as a cache of upstream p\", \"ackages if there's a failure of a centralized repository.\\n\\nThe top-level organizational unit in Azur\", \"e DevOps is known as a Project. Within each project the various components, such as Azure Artifacts,\", \" can be turned on and off. Each of these components provides different advantages for cloud-native a\", \"pplications. The three most useful are repositories, boards, and pipelines. If users want to manage \", \"their source code in another repository stack, such as GitHub, but still take advantage of Azure Pip\", \"elines and other components, that's perfectly possible.\\n\\nFortunately, development teams have many op\", \"tions when selecting a repository. One of them is GitHub.\\n\\n## GitHub Actions\\n\\nFounded in 2009, GitHu\", \"b is a widely popular web-based repository for hosting projects, documentation, and code. Many large\", \" tech companies, such as Apple, Amazon, Google, and mainstream corporations use GitHub. GitHub uses \", \"the open-source, distributed version control system named Git as its foundation. On top, it then add\", \"s its own set of features, including defect tracking, feature and pull requests, tasks management, a\", \"nd wikis for each code base.\\n\\nAs GitHub evolves, it too is adding DevOps features. For example, GitH\", \"ub has its own continuous integration/continuous delivery (CI/CD) pipeline, called GitHub Actions. G\", \"itHub Actions is a community-powered workflow automation tool. It lets DevOps teams integrate with t\", \"heir existing tooling, mix and match new products, and hook into their software lifecycle, including\", \" existing CI/CD partners.'\\n\\nGitHub has over 40 million users, making it the largest host of source c\", \"ode in the world. In October of 2018, Microsoft purchased GitHub. Microsoft has pledged that GitHub \", \"will remain an open platform that any developer can plug into and extend. It continues to operate as\", \" an independent company. GitHub offers plans for enterprise, team, professional, and free accounts.\\n\", \"\\n## Source control\\n\\nOrganizing the code for a cloud-native application can be challenging. Instead o\", \"f a single giant application, the cloud-native applications tend to be made up of a web of smaller a\", \"pplications that talk with one another. As with all things in computing, the best arrangement of cod\", \"e remains an open\\n\\nquestion. There are examples of successful applications using different kinds of \", \"layouts, but two variants seem to have the most popularity.\\n\\nBefore getting down into the actual sou\", \"rce control itself, it's probably worth deciding on how many projects are appropriate. Within a sing\", \"le project, there's support for multiple repositories, and build pipelines. Boards are a little more\", \" complicated, but there too, the tasks can easily be assigned to multiple teams within a single proj\", \"ect. It's possible to support hundreds, even thousands of developers, out of a single Azure DevOps p\", \"roject. Doing so is likely the best approach as it provides a single place for all developer to work\", \" out of and reduces the confusion of finding that one application when developers are unsure in whic\", \"h project in which it resides.\\n\\nSplitting up code for microservices within the Azure DevOps project \", \"can be slightly more challenging.\\n\\nFigure 10-3 - One vs. many repositories.\\n\\n<!-- image -->\\n\\n## Repo\", \"sitory per microservice\\n\\nAt first glance, this approach seems like the most logical approach to spli\", \"tting up the source code for microservices. Each repository can contain the code needed to build the\", \" one microservice. The advantages to this approach are readily visible:\\n\\n1. Instructions for buildin\", \"g and maintaining the application can be added to a README file at the root of each repository. When\", \" flipping through the repositories, it's easy to find these instructions, reducing spin-up time for \", \"developers.\\n2. Every service is located in a logical place, easily found by knowing the name of the \", \"service.\\n3. Builds can easily be set up such that they're only triggered when a change is made to th\", \"e owning repository.\\n4. The number of changes coming into a repository is limited to the small numbe\", \"r of developers working on the project.\\n\\n5. Security is easy to set up by restricting the repositori\", \"es to which developers have read and write permissions.\\n6. Repository level settings can be changed \", \"by the owning team with a minimum of discussion with others.\\n\\nOne of the key ideas behind microservi\", \"ces is that services should be siloed and separated from each other. When using Domain Driven Design\", \" to decide on the boundaries for services the services act as transactional boundaries. Database upd\", \"ates shouldn't spa n multiple services. This collection of related data is referred to as a bounded \", \"context. This idea is reflected by the isolation of microservice data to a database separate and aut\", \"onomous from the rest of the services. It makes a great deal of sense to carry this idea all the way\", \" through to the source code.\\n\\nHowever, this approach isn't without its issues. One of the more gnarl\", \"y development problems of our time is managing dependencies. Consider the number of files that make \", \"up the average node\\\\_modules directory. A fresh install of something like create-react-app is likely\", \" to bring with it thousands of packages. The question of how to manage these dependencies is a diffi\", \"cult one.\\n\\nIf a dependency is updated, then downstream packages must also update this dependency. Un\", \"fortunately, that takes development work so, invariably, the node\\\\_modules directory ends up with mu\", \"ltiple versions of a single package, each one a dependency of some other package that is versioned a\", \"t a slightly different cadence. When deploying an application, which version of a dependency should \", \"be used? The version that is currently in production? The version that is currently in Beta but is l\", \"ikely to be in production by the time the consumer makes it to production? Difficult problems that a\", \"ren't resolved by just using microservices.\\n\\nThere are libraries that are depended upon by a wide va\", \"riety of projects. By dividing the microservices up with one in each repository the internal depende\", \"ncies can best be resolved by using the internal repository, Azure Artifacts. Builds for libraries w\", \"ill push their latest versions into Azure Artifacts for internal consumption. The downstream project\", \" must still be manually updated to take a dependency on the newly updated packages.\\n\\nAnother disadva\", \"ntage presents itself when moving code between services. Although it would be nice to believe that t\", \"he first division of an application into microservices is 100% correct, the reality is that rarely w\", \"e're so prescient as to make no service d ivision mistakes. Thus, functionality and the code that dr\", \"ives it will need to move from service to service: repository to repository. When leaping from one r\", \"epository to another, the code loses its history. There are many cases, especially in the event of a\", \"n audit, where having full history on a piece of code is invaluable.\\n\\nThe final and most important d\", \"isadvantage is coordinating changes. In a true microservices application, there should be no deploym\", \"ent dependencies between services. It should be possible to deploy services A, B, and C in any order\", \" as they have loose coupling. In reality, however, there are times when it's desirable to make a cha\", \"nge that crosses multiple repositories at the same time. Some examples include updating a library to\", \" close a security hole or changing a communication protocol used by all services.\\n\\nTo do a cross-rep\", \"ository change requires a commit to each repository be made in succession. Each change in each repos\", \"itory will need to be pull-requested and reviewed separately. This activity can be difficult to coor\", \"dinate.\\n\\nAn alternative to using many repositories is to put all the source code together in a giant\", \", all knowing, single repository.\\n\\n## Single repository\\n\\nIn this approach, sometimes referred to as \", \"a monorepository, all the source code for every service is put into the same repository. At first, t\", \"his approach seems like a terrible idea likely to make dealing with source code unwieldy. There are,\", \" however, some marked advantages to working this way.\\n\\nThe first advantage is that it's easier to ma\", \"nage dependencies between projects. Instead of relying on some external artifact feed, projects can \", \"directly import one another. This means that updates are instant, and conflicting versions are likel\", \"y to be fou nd at compile time on the developer's workstation. In effect, shifting some of the integ\", \"ration testing left.\\n\\nWhen moving code between projects, it's now easier to preserve the history as \", \"the files will be detected as having been moved rather than being rewritten.\\n\\nAnother advantage is t\", \"hat wide ranging changes that cross service boundaries can be made in a single commit. This activity\", \" reduces the overhead of having potentially dozens of changes to review individually.\\n\\nThere are man\", \"y tools that can perform static analysis of code to detect insecure programming practices or problem\", \"atic use of APIs. In a multi-repository world, each repository will need to be iterated over to find\", \" the problems in them. The single repository allows running the analysis all in one place.\\n\\nThere ar\", \"e also many disadvantages to the single repository approach. One of the most worrying ones is that h\", \"aving a single repository raises security concerns. If the contents of a repository are leaked in a \", \"repository per service model, the amount of code lost is minimal. With a single repository, everythi\", \"ng the company owns could be lost. There have been many examples in the past of this happening and d\", \"erailing entire game development efforts. Having multiple repositories exposes less surface area, wh\", \"ich is a desirable trait in most security practices.\\n\\nThe size of the single repository is likely to\", \" become unmanageable rapidly. This presents some interesting performance implications. It may become\", \" necessary to use specialized tools such as Virtual File System for Git, which was originally design\", \"ed to improve the experience for developers on the Windows team.\\n\\nFrequently the argument for using \", \"a single repository boils down to an argument that Facebook or Google use this method for source cod\", \"e arrangement. If the approach is good enough for these companies, then, surely, it's the correct ap\", \"proach for all compani es. The truth of the matter is that few companies operate on anything like th\", \"e scale of Facebook or Google. The problems that occur at those scales are different from those most\", \" developers will face. What is good for the goose may not be good for the gander.\\n\\nIn the end, eithe\", \"r solution can be used to host the source code for microservices. However, in most cases, the manage\", \"ment, and engineering overhead of operating in a single repository isn't worth the meager advantages\", \". Splitting code up over multiple repositories encourages better separation of concerns and encourag\", \"es autonomy among development teams.\\n\\nV\\n\\nservices email Service\\n\\nARM templates\\n\\n## Standard director\", \"y structure\\n\\nRegardless of the single versus multiple repositories debate each service will have its\", \" own directory. One of the best optimizations to allow developers to cross between projects quickly \", \"is to maintain a standard directory structure.\\n\\nsrc tests\\n\\nARM templates build scripts\\n\\nSrC\\n\\ntests\\n\\n\", \"Figure 10-4 - Standard directory structure.\\n\\n<!-- image -->\\n\\nWhenever a new project is created, a te\", \"mplate that puts in place the correct structure should be used. This template can also include such \", \"useful items as a skeleton README file and an azurepipelines.yml. In any microservice architecture, \", \"a high degree of variance between projects makes bulk operations against the services more difficult\", \".\\n\\nThere are many tools that can provide templating for an entire directory, containing several sour\", \"ce code directories. Yeoman is popular in the JavaScript world and GitHub have recently released Rep\", \"ository Templates, which provide much of the same functionality.\\n\\n## Task management\\n\\nManaging tasks\", \" in any project can be difficult. Up front there are countless questions to be answered about the so\", \"rt of workflows to set up to ensure optimal developer productivity.\\n\\nCloudnative applications tend t\", \"o be smaller than traditional software products or at least they're divided into smaller services. T\", \"racking of issues or tasks related to these services remains as important as with any other software\", \" project. Nobody wants to lose track of some work item or explain to a customer that their issue was\", \"n't properly logged. Boards are configured at the project level but within each project, areas can b\", \"e defined. These allow breaking down issues across several components. The advan tage to keeping all\", \" the work for the entire application in one place is that it's easy to move work items from one team\", \" to another as they're understood better.\\n\\nWork Items\\n\\n1 NEW TASK *\\n\\nAdd \\\"remember me\\\" button to log\", \"in screen\\n\\nSimon Timms\\n\\nState\\n\\n\\u2022 To Do\\n\\nReason\\n\\nDescription checkbox clicked.\\n\\nUser Name:\\n\\nPassword:\", \"\\n\\n\\u2022 0 comments\\n\\nAdd tag\\n\\nA Save\\n\\nAzure DevOps comes with a number of popular templates pre-configure\", \"d. In the most basic configuration, all that is needed to know is what's in the backlog, what people\", \" are working on, and what's done. It's important to have this visibility into the process of buildin\", \"g software, so that work can be prioritized and completed tasks reported to the customer. Of course,\", \" few software projects stick to a process as simple as to do, doing, and done. It doesn't take long \", \"for people to start adding steps like QA or Detailed Specification to the process. + Add link + Add \", \"link v\\n\\nOne of the more important parts of Agile methodologies is self-introspection at regular inte\", \"rvals. These reviews are meant to provide insight into what problems the team is facing and how they\", \" can be improved. Frequently, this means changing the flow of issues and features through the develo\", \"pment process. So, it's perfectly healthy to expand the layouts of the boards with additional stages\", \".\\n\\nThe stages in the boards aren't the only organizational tool. Depending on the configuration of t\", \"he board, there's a hierarchy of work items. The most granular item that can appear on a board is a \", \"task. Out of the box a task contains fields for a title, description, a priority, an estimate of the\", \" amount of work remaining and the ability to link to other work items or development items (branches\", \", commits, pull requests, builds, and so forth). Work items can be classified into different areas o\", \"f the application and different iterations (sprints) to make finding them easier.\\n\\nFigure 10-5 - Tas\", \"k in Azure DevOps.\\n\\n<!-- image -->\\n\\nThe description field supports the normal styles you'd expect (b\", \"old, italic underscore and strike through) and the ability to insert images. This makes it a powerfu\", \"l tool for use when specifying work or bugs.\\n\\nTasks can be rolled up into features, which define a l\", \"arger unit of work. Features, in turn, can be rolled up into epics. Classifying tasks in this hierar\", \"chy makes it much easier to understand how close a large feature is to rolling out.\\n\\n\\u2022 Back to Work \", \"Items\\n\\nO, AzureCamp2019 Team v\\n\\nAll processes &gt; Basic\\n\\nWork item types\\n\\nBacklog levels\\n\\nTaskboard\", \" Backlog Capacity\\n\\nNamel\\n\\n\\u00bf Collapse all\\n\\n\\u2022 Epic\\n\\n\\u2022 Unparented\\n\\n\\u00a1 Issue\\n\\nTask\\n\\n5f Test Case\\n\\n\\u2022 Test \", \"Plan\\n\\nCA Test Suite\\n\\nProjects\\n\\n+ New Work Item\\n\\nTo Do 8 h\\n\\n\\u2022 2 Add \\\"remember me\\\"\\n\\nbutton to login sc\", \"reen\\n\\n<!-- image -->\\n\\n8 h\\n\\nFigure 10-6 - Work item in Azure DevOps.\\n\\nThere are different kinds of vi\", \"ews into the issues in Azure Boards. Items that aren't yet scheduled appear in the backlog. From the\", \"re, they can be assigned to a sprint. A sprint is a time box during which it's expected some quantit\", \"y of work will be complet ed. This work can include tasks but also the resolution of tickets. Once t\", \"here, the entire sprint can be managed from the Sprint board section. This view shows how work is pr\", \"ogressing and includes a burn down chart to give an ever-updating estimate of if the sprint will be \", \"successful.\\n\\nFigure 10-7 - Board in Azure DevOps.\\n\\n<!-- image -->\\n\\nBy now, it should be apparent tha\", \"t there's a great deal of power in the Boards in Azure DevOps. For developers, there are easy views \", \"of what is being worked on. For project managers views into upcoming work as well as an overview of \", \"existing work. For managers, there are plenty of reports about resourcing and capacity. Unfortunatel\", \"y, there's nothing magical about cloud -native applications that eliminate the need to track work. B\", \"ut if you must track work, there are a few places where the experience is better than in Azure DevOp\", \"s.\\n\\n## CI/CD pipelines\\n\\nAlmost no change in the software development life cycle has been so revoluti\", \"onary as the advent of continuous integration (CI) and continuous delivery (CD). Building and runnin\", \"g automated tests against the source code of a project as soon as a change is checked in catches mis\", \"takes early. Prior to the advent of continuous integration builds, it wouldn't be uncommon to pull c\", \"ode from the\\n\\nDescription\\n\\nDoing\\n\\nJune 8 - June 29.\\n\\n15 work days remaining\\n\\n\\u00a9 Help\\n\\nT Filter by wor\", \"k item type nam\\n\\nO Sprint 1 \\u00d7 8 Person A v = |\\n\\nDone\\n\\nEpics can be defined as a large piece of work \", \"that has one common objective. Use an Epic to track the progress of complex featur....\\n\\nrepository a\", \"nd find that it didn't pass tests or couldn't even be built. This resulted in tracking down the sour\", \"ce of the breakage.\\n\\nTraditionally shipping software to the production environment required extensiv\", \"e documentation and a list of steps. Each one of these steps needed to be manually completed in a ve\", \"ry error prone process.\\n\\nFigure 10-8 - Checklist.\\n\\n<!-- image -->\\n\\nThe sister of continuous integrat\", \"ion is continuous delivery in which the freshly built packages are deployed to an environment. The m\", \"anual process can't scale to match the speed of development so automation becomes more important. Ch\", \"ecklists are replaced by scripts that can execute the same tasks faster and more accurately than any\", \" human.\\n\\nThe environment to which continuous delivery delivers might be a test environment or, as is\", \" being done by many major technology companies, it could be the production environment. The latter r\", \"equires an investment in high-quality tests that can give confide nce that a change isn't going to b\", \"reak production for users. In the same way that continuous integration caught issues in the code ear\", \"ly continuous delivery catches issues in the deployment process early.\\n\\nThe importance of automating\", \" the build and delivery process is accentuated by cloud-native applications. Deployments happen more\", \" frequently and to more environments so manually deploying borders on impossible.\\n\\n## Azure Builds\\n\\n\", \"Azure DevOps provides a set of tools to make continuous integration and deployment easier than ever.\", \" These tools are located under Azure Pipelines. The first of them is Azure Builds, which is a tool f\", \"or running YAML-based build definitions at scale. Users can either bring their own build machines (g\", \"reat for if the build requires a meticulously set up environment) or use a machine from a constantly\", \" refreshed pool of Azure hosted virtual machines. These hosted build agents come pre-installed with \", \"a\\n\\nwide range of development tools for not just .NET development but for everything from Java to Pyt\", \"hon to iPhone development.\\n\\nDevOps includes a wide range of out of the box build definitions that ca\", \"n be customized for any build. The build definitions are defined in a file called azure-pipelines.ym\", \"l and checked into the repository so they can be versioned along with the source code. This makes it\", \" much easier to make changes to the build pipeline in a branch as the changes can be checked into ju\", \"st that branch. An example azurepipelines.yml for building an ASP.NET web application on full framew\", \"ork is show in Figure 10-9.\\n\\n```\\nname : $(rev:r) variables : version : 9.2.0.$(Build.BuildNumber) so\", \"lution : Portals.sln artifactName : drop buildPlatform : any cpu buildConfiguration : release pool :\", \" name : Hosted VisualStudio demands : -msbuild -visualstudio -vstest steps : -task : NuGetToolInstal\", \"ler@0 displayName : 'Use NuGet 4.4.1' inputs : versionSpec : 4.4.1 -task : NuGetCommand@2 displayNam\", \"e : 'NuGet restore' inputs : restoreSolution : '$(solution)' -task : VSBuild@1 displayName : 'Build \", \"solution' inputs : solution : '$(solution)' msbuildArgs : '-p:DeployOnBuild=true -p:WebPublishMethod\", \"=Package p:PackageAsSingleFile=true -p:SkipInvalidConfigurations=true p:PackageLocation=\\\"$(build.art\", \"ifactstagingdirectory)\\\\\\\\\\\"' platform : '$(buildPlatform)' configuration : '$(buildConfiguration)' -ta\", \"sk : VSTest@2 displayName : 'Test Assemblies' inputs : testAssemblyVer2 : | **\\\\$(buildConfiguration)\", \"\\\\**\\\\*test*.dll !**\\\\obj\\\\** !**\\\\*testadapter.dll platform : '$(buildPlatform)' configuration : '$(buil\", \"dConfiguration)' -task : CopyFiles@2 displayName : 'Copy UI Test Files to: $(build.artifactstagingdi\", \"rectory)' inputs :\\n```\\n\\nR\\n\\nDevelop\\n\\n1 job, 1 task\\n\\nQA\\n\\n1 job, 1 task\\n\\nProduction\\n\\n1 job, 1 task\\n\\n```\", \"\\nSourceFolder : UITests TargetFolder : '$(build.artifactstagingdirectory)/uitests' -task : PublishBu\", \"ildArtifacts@1 displayName : 'Publish Artifact' inputs : PathtoPublish : '$(build.artifactstagingdir\", \"ectory)' ArtifactName : '$(artifactName)' condition : succeededOrFailed()\\n```\\n\\nFigure 10-9 - A sampl\", \"e azure-pipelines.yml\\n\\nThis build definition uses a number of built-in tasks that make creating buil\", \"ds as simple as building a Lego set (simpler than the giant Millennium Falcon). For instance, the Nu\", \"Get task restores NuGet packages, while the VSBuild task calls the Visual Studio build tools to perf\", \"orm the actual compilation. There are hundreds of different tasks available in Azure DevOps, with th\", \"ousands more that are maintained by the community. It's likely that no matter what build tasks you'r\", \"e looking to run, somebody has built one already.\\n\\nBuilds can be triggered manually, by a check-in, \", \"on a schedule, or by the completion of another build. In most cases, building on every check-in is d\", \"esirable. Builds can be filtered so that different builds run against different parts of the reposit\", \"ory or against different branches. This allows for scenarios like running fast builds with reduced t\", \"esting on pull requests and running a full regression suite against the trunk on a nightly basis.\\n\\nT\", \"he end result of a build is a collection of files known as build artifacts. These artifacts can be p\", \"assed along to the next step in the build process or added to an Azure Artifacts feed, so they can b\", \"e consumed by other builds.\\n\\n## Azure DevOps releases\\n\\nBuilds take care of compiling the software in\", \"to a shippable package, but the artifacts still need to be pushed out to a testing environment to co\", \"mplete continuous delivery. For this, Azure DevOps uses a separate tool called Releases. The Release\", \"s tool make s use of the same tasks' library that were available to the Build but introduce a concep\", \"t of 'stages'. A stage is an isolated environment into which the package is installed. For instance,\", \" a product might make use of a development, a QA, and a production environment. Code is continuously\", \" delivered into the development environment where automated tests can be run against it. Once those \", \"tests pass the release moves onto the QA environment for manual testing. Finally, the code is pushed\", \" to production where it' s visible to everybody.\\n\\nFigure 10-10 - Release pipeline\\n\\n<!-- image -->\\n\\nE\", \"ach stage in the build can be automatically triggered by the completion of the previous phase. In ma\", \"ny cases, however, this isn't desirable. Moving code into production might require approval from som\", \"ebody. The Releases tool supports this by allowing approvers at each step of the release pipeline. R\", \"ules can be set up such that a specific person or group of people must sign off on a release before \", \"it\\n\\nmakes into production. These gates allow for manual quality checks and also for compliance with \", \"any regulatory requirements related to control what goes into production.\\n\\n## Everybody gets a build\", \" pipeline\\n\\nThere's no cost to configuring many build pipelines, so it's advantageous to have at leas\", \"t one build pipeline per microservice. Ideally, microservices are independently deployable to any en\", \"vironment so having each one able to be released via its own pipeline without releasing a mass of un\", \"related code is perfect. Each pipeline can have its own set of approvals allowing for variations in \", \"build process for each service.\\n\\n## Versioning releases\\n\\nOne drawback to using the Releases function\", \"ality is that it can't be defined in a checked -in azurepipelines.yml file. There are many reasons y\", \"ou might want to do that from having per-branch release definitions to including a release skeleton \", \"in your project template. Fortunately, work is ongoing to shift some of the stages support into the \", \"Build component. This will be known as multi-stage build and the first version is available now!\\n\\n##\", \" Feature flags\\n\\nIn chapter 1, we affirmed that cloud native is much about speed and agility. Users e\", \"xpect rapid responsiveness, innovative features, and zero downtime. Feature flags are a modern deplo\", \"yment technique that helps increase agility for cloud-native applications. They enable you to deploy\", \" new features into a production environment, but restrict their availability. With the flick of a sw\", \"itch, you can activate a new feature for specific users without restarting the app or deploying new \", \"code. They separate the release of new features from their code deployment.\\n\\nFeature flags are built\", \" upon conditional logic that control visibility of functionality for users at run time. In modern cl\", \"oudnative systems, it's common to deploy new features into production early, but test them with a li\", \"mited audience. As confidence increases, the feature can be incrementally rolled out to wider audien\", \"ces.\\n\\nOther use cases for feature flags include:\\n\\n- Restrict premium functionality to specific custo\", \"mer groups willing to pay higher subscription fees.\\n- Stabilize a system by quickly deactivating a p\", \"roblem feature, avoiding the risks of a rollback or immediate hotfix.\\n- Disable an optional feature \", \"with high resource consumption during peak usage periods.\\n- Conduct experimental feature releases to\", \" small user segments to validate feasibility and popularity.\\n\\nFeature flags also promote trunkbased \", \"development. It's a source -control branching model where developers collaborate on features in a si\", \"ngle branch. The approach minimizes the risk and complexity of merging large numbers of long-running\", \" feature branches. Features are unavailable until activated.\\n\\n## Implementing feature flags\\n\\nAt its \", \"core, a feature flag is a reference to a simple decision object. It returns a Boolean state of on or\", \" off. The flag typically wraps a block of code that encapsulates a feature capability. The state of \", \"the flag determines whether that code block executes for a given user. Figure 10-11 shows the implem\", \"entation.\\n\\n```\\nif (featureFlag) { // Run this code block if the featureFlag value is true } else { /\", \"/ Run this code block if the featureFlag value is false }\\n```\\n\\nFigure 10-11 - Simple feature flag im\", \"plementation.\\n\\nNote how this approach separates the decision logic from the feature code.\\n\\nIn chapte\", \"r 1, we discussed the Twelve-Factor App. The guidance recommended keeping configuration settings ext\", \"ernal from application executable code. When needed, settings can be read in from the external sourc\", \"e. Feature flag configuration values should also be independent from their codebase. By externalizin\", \"g flag configuration in a separate repository, you can change flag state without modifying and redep\", \"loying the application.\\n\\nAzure App Configuration provides a centralized repository for feature flags\", \". With it, you define different kinds of feature flags and manipulate their states quickly and confi\", \"dently. You add the App Configuration client libraries to your application to enable feature flag fu\", \"nctionality. Various programming language frameworks are supported.\\n\\nFeature flags can be easily imp\", \"lemented in an ASP.NET Core service. Installing the .NET Feature Management libraries and App Config\", \"uration provider enable you to declaratively add feature flags to your code. They enable FeatureGate\", \" attributes so that you don't have to manually write if statements across your codebase.\\n\\nOnce confi\", \"gured in your Startup class, you can add feature flag functionality at the controller, action, or mi\", \"ddleware level. Figure 10-12 presents controller and action implementation:\\n\\n```\\n[FeatureGate(MyFeat\", \"ureFlags.FeatureA)] public class ProductController : Controller { ... } [FeatureGate(MyFeatureFlags.\", \"FeatureA)] public IActionResult UpdateProductStatus() { return ObjectResult(ProductDto); }\\n```\\n\\nFigu\", \"re 10-12 - Feature flag implementation in a controller and action.\\n\\nIf a feature flag is disabled, t\", \"he user will receive a 404 (Not Found) status code with no response body. Feature flags can also be \", \"injected directly into C# classes. Figure 10-13 shows feature flag injection:\\n\\n```\\npublic class Prod\", \"uctController : Controller { private readonly IFeatureManager _featureManager; public ProductControl\", \"ler(IFeatureManager featureManager) { _featureManager = featureManager; } }\\n```\\n\\nFigure 10-13 - Feat\", \"ure flag injection into a class.\\n\\nThe Feature Management libraries manage the feature flag lifecycle\", \" behind the scenes. For example, to minimize high numbers of calls to the configuration store, the l\", \"ibraries cache flag states for a specified duration. They can guarantee the immutability of flag sta\", \"tes during a request call. They also offer a Point-in-time snapshot. You can reconstruct the history\", \" of any key-value and provide its past value at any moment within the previous seven days.\\n\\n## Infra\", \"structure as code\\n\\nCloud-native systems embrace microservices, containers, and modern system design \", \"to achieve speed and agility. They provide automated build and release stages to ensure consistent a\", \"nd quality code. But, that's only part of the story. How do you provision t he cloud environments up\", \"on which these systems run?\\n\\nModern cloud-native applications embrace the widely accepted practice o\", \"f Infrastructure as Code, or IaC. With IaC, you automate platform provisioning. You essentially appl\", \"y software engineering practices such as testing and versioning to your DevOps practices. Your infra\", \"structure and deployments are automated, consistent, and repeatable. Just as continuous delivery aut\", \"omated the traditional model of manual deployments, Infrastructure as Code (IaC) is evolving how app\", \"lication environments are managed.\\n\\nTools like Azure Resource Manager (ARM), Terraform, and the Azur\", \"e Command Line Interface (CLI) enable you to declaratively script the cloud infrastructure you requi\", \"re.\\n\\n## Azure Resource Manager templates\\n\\nARM stands for Azure Resource Manager . It's an API provis\", \"ioning engine that is built into Azure and exposed as an API service. ARM enables you to deploy, upd\", \"ate, delete, and manage the resources contained in Azure resource group in a single, coordinated ope\", \"ration. You provide the engine with a JSON-based template that specifies the resources you require a\", \"nd their configuration. ARM automatically orchestrates the deployment in the correct order respectin\", \"g dependencies. The engine ensures idempotency. If a desired resource already exists with the same c\", \"onfiguration, provisioning will be ignored.\\n\\nAzure Resource Manager templates are a JSON-based langu\", \"age for defining various resources in Azure. The basic schema looks something like Figure 10-14.\\n\\n``\", \"`\\n{ \\\"$schema\\\": \\\"https://schema.management.azure.com/schemas/2015-01-\\n```\\n\\n```\\n01/deploymentTemplate.\", \"json#\\\", \\\"contentVersion\\\": \\\"\\\", \\\"apiProfile\\\": \\\"\\\", \\\"parameters\\\": {  }, \\\"variables\\\": {  }, \\\"functions\\\": \", \"[  ], \\\"resources\\\": [  ], \\\"outputs\\\": {  } }\\n```\\n\\nFigure 10-14 - The schema for a Resource Manager tem\", \"plate\\n\\nWithin this template, one might define a storage container inside the resources section like \", \"so:\\n\\n```\\n\\\"resources\\\": [ { \\\"type\\\": \\\"Microsoft.Storage/storageAccounts\\\", \\\"name\\\": \\\"[variables('storageA\", \"ccountName')]\\\", \\\"location\\\": \\\"[parameters('location')]\\\", \\\"apiVersion\\\": \\\"2018-07-01\\\", \\\"sku\\\": { \\\"name\\\":\", \" \\\"[parameters('storageAccountType')]\\\" }, \\\"kind\\\": \\\"StorageV2\\\", \\\"properties\\\": {} } ] ,\\n```\\n\\nFigure 10-\", \"15 - An example of a storage account defined in a Resource Manager template\\n\\nAn ARM template can be \", \"parameterized with dynamic environment and configuration information. Doing so enables it to be reus\", \"ed to define different environments, such as development, QA, or production. Normally, the template \", \"creates all resources within a si ngle Azure resource group. It's possible to define multiple resour\", \"ce groups in a single Resource Manager template, if needed. You can delete all resources in an envir\", \"onment by deleting the resource group itself. Cost analysis can also be run at the resource group le\", \"vel, allowing for quick accounting of how much each environment is costing.\\n\\nThere are many examples\", \" of ARM templates available in the Azure Quickstart Templates project on GitHub. They can help accel\", \"erate creating a new template or modifying an existing one.\\n\\nResource Manager templates can be run i\", \"n many of ways. Perhaps the simplest way is to simply paste them into the Azure portal. For experime\", \"ntal deployments, this method can be quick. They can also be run as part of a build or release proce\", \"ss in Azure DevOps. There are tasks that will leverage connections into Azure to run the templates. \", \"Changes to Resource Manager templates are applied incrementally, meaning that to add a new resource \", \"requires just adding it to the template. The tooling will reconcile differences between the current \", \"resources and those defined in the template. Resources will then be created or altered so they match\", \" what is defined in the template.\\n\\n## Terraform\\n\\nCloud-native applications are often constructed to \", \"be cloud agnostic. Being so means the application isn't tightly coupled to a particular cloud vendor\", \" and can be deployed to any public cloud.\\n\\nTerraform is a commercial templating tool that can provis\", \"ion cloud-native applications across all the major cloud players: Azure, Google Cloud Platform, AWS,\", \" and AliCloud. Instead of using JSON as the template definition language, it uses the slightly more \", \"terse HCL (Hashicorp Configuration Language).\\n\\nAn example Terraform file that does the same as the p\", \"revious Resource Manager template (Figure 1015) is shown in Figure 10-16:\\n\\n```\\nprovider \\\"azurerm\\\" { \", \"version = \\\"=1.28.0\\\" } resource \\\"azurerm_resource_group\\\" \\\"testrg\\\" { name     = \\\"production\\\" location \", \"= \\\"West US\\\" } resource \\\"azurerm_storage_account\\\" \\\"testsa\\\" { name                     = \\\"${var.storag\", \"eAccountName}\\\" resource_group_name      = \\\"${azurerm_resource_group.testrg.name}\\\" location          \", \"       = \\\"${var.region}\\\" account_tier             = \\\"${var.tier}\\\" account_replication_type = \\\"${var.\", \"replicationType}\\\" }\\n```\\n\\nFigure 10-16 - An example of a Resource Manager template\\n\\nTerraform also pr\", \"ovides intuitive error messages for problem templates. There's also a handy validate task that can b\", \"e used in the build phase to catch template errors early.\\n\\nAs with Resource Manager templates, comma\", \"nd-line tools are available to deploy Terraform templates. There are also community-created tasks in\", \" Azure Pipelines that can validate and apply Terraform templates.\\n\\nSometimes Terraform and ARM templ\", \"ates output meaningful values, such as a connection string to a newly created database. This informa\", \"tion can be captured in the build pipeline and used in subsequent tasks.\\n\\n## Azure CLI Scripts and T\", \"asks\\n\\nFinally, you can leverage Azure CLI to declaratively script your cloud infrastructure. Azure C\", \"LI scripts can be created, found, and shared to provision and configure almost any Azure resource. T\", \"he CLI is simple to use with a gentle learning curve. Scripts are executed within either PowerShell \", \"or Bash. They're also straightforward to debug, especially when compared with ARM templates.\\n\\nAzure \", \"CLI scripts work well when you need to tear down and redeploy your infrastructure. Updating an exist\", \"ing environment can be tricky. Many CLI commands aren't idempotent. That means they'll recreate the \", \"resource each time they're run, even if the resource already exists. It's always possible to add cod\", \"e that checks for the existence of each resource before creating it. But, doing so, your script can \", \"become bloated and difficult to manage.\\n\\nThese scripts can also be embedded in Azure DevOps pipeline\", \"s as Azure CLI tasks. Executing the pipeline invokes the script.\\n\\nFigure 10-17 shows a YAML snippet \", \"that lists the version of Azure CLI and the details of the subscription. Note how Azure CLI commands\", \" are included in an inline script.\\n\\n```\\n-task : AzureCLI@2 displayName : Azure CLI inputs : azureSub\", \"scription : <Name of the Azure Resource Manager service connection> scriptType : ps scriptLocation :\", \" inlineScript inlineScript : | az --version az account show\\n```\\n\\nFigure 10-17 - Azure CLI script\\n\\nIn\", \" the article, What is Infrastructure as Code , Author Sam Guckenheimer describes how, 'Teams who imp\", \"lement IaC can deliver stable environments rapidly and at scale. Teams avoid manual configuration of\", \" environments and enforce consistency by representing the desired state of their environments via co\", \"de. Infrastructure deployments with IaC are repeatable and prevent runtime issues caused by configur\", \"ation drift or missing dependencies. DevOps teams can work together with a unified set of practices \", \"and tools to deliver applications and their supporting infrastructure rapidly, reliably, and at scal\", \"e.'\\n\\n## Cloud Native Application Bundles\\n\\nA key property of cloud-native applications is that they l\", \"everage the capabilities of the cloud to speed up development. This design often means that a full a\", \"pplication uses different kinds of technologies. Applications may be shipped in Docker containers, s\", \"ome services may use Azure Functions, while other parts may run directly on virtual machines allocat\", \"ed on large metal servers with hardware GPU acceleration. No two cloudnative applications are the sa\", \"me, so it's been difficult to provide a single mechanism for shipping them.\\n\\nThe Docker containers m\", \"ay run on Kubernetes using a Helm Chart for deployment. The Azure Functions may be allocated using T\", \"erraform templates. Finally, the virtual machines may be allocated using Terraform but built out usi\", \"ng Ansible. This is a large variety of technologies and there has been no way to package them all to\", \"gether into a reasonable package. Until now.\\n\\nCloud Native Application Bundles (CNABs) are a joint e\", \"ffort by many community-minded companies such as Microsoft, Docker, and HashiCorp to develop a speci\", \"fication to package distributed applications.\\n\\nThe effort was announced in December of 2018, so ther\", \"e's still a fair bit of work to do to expose the effort to the greater community. However, there's a\", \"lready an open specification and a reference implementation known as Duffle. This tool, which was wr\", \"itten in Go, is a joint effort between Docker and Microsoft.\\n\\nThe CNABs can contain different kinds \", \"of installation technologies. This aspect allows things like Helm Charts, Terraform templates, and A\", \"nsible Playbooks to coexist in the same package. Once built, the packages are self-contained and por\", \"table; they can be installed from a USB stick. The packages are cryptographically signed to ensure t\", \"hey originate from the party they claim.\\n\\nThe core of a CNAB is a file called bundle.json. This file\", \" defines the contents of the bundle, be they Terraform or images or anything else. Figure 11-9 defin\", \"es a CNAB that invokes some Terraform. Notice, however, that it actually defines an invocation image\", \" that is used to invoke the Terraform. When packaged up, the Docker file that is located in the cnab\", \" directory is built into a Docker image, which will be included in the bundle. Having Terraform inst\", \"alled inside a Docker container in the bundle means th at users don't need to have Terraform install\", \"ed on their machine to run the bundling.\\n\\n```\\n{ \\\"name\\\": \\\"terraform\\\", \\\"version\\\": \\\"0.1.0\\\", \\\"schemaVers\", \"ion\\\": \\\"v1.0.0-WD\\\", \\\"parameters\\\": { \\\"backend\\\": { \\\"type\\\": \\\"boolean\\\", \\\"defaultValue\\\": false , \\\"destinat\", \"ion\\\": { \\\"env\\\": \\\"TF_VAR_backend\\\" } } }, \\\"invocationImages\\\": [ { \\\"imageType\\\": \\\"docker\\\", \\\"image\\\": \\\"cnab\", \"/terraform:latest\\\" } ], \\\"credentials\\\": { \\\"tenant_id\\\": { \\\"env\\\": \\\"TF_VAR_tenant_id\\\" }, \\\"client_id\\\": { \", \"\\\"env\\\": \\\"TF_VAR_client_id\\\" }, \\\"client_secret\\\": { \\\"env\\\": \\\"TF_VAR_client_secret\\\" }, \\\"subscription_id\\\": \", \"{ \\\"env\\\": \\\"TF_VAR_subscription_id\\\" }, \\\"ssh_authorized_key\\\": { \\\"env\\\": \\\"TF_VAR_ssh_authorized_key\\\" } },\", \" \\\"actions\\\": { \\\"status\\\": { \\\"modifies\\\": true } } }\\n```\\n\\nFigure 10-18 - An example Terraform file\\n\\nThe \", \"bundle.json also defines a set of parameters that are passed down into the Terraform. Parameterizati\", \"on of the bundle allows for installation in various different environments.\\n\\nThe CNAB format is also\", \" flexible, allowing it to be used against any cloud. It can even be used against on-premises solutio\", \"ns such as OpenStack.\\n\\n## DevOps Decisions\\n\\nThere are so many great tools in the DevOps space these \", \"days and even more fantastic books and papers on how to succeed. A favorite book to get started on t\", \"he DevOps journey is The Phoenix Project, which follows the transformation of a fictional company fr\", \"om NoOps to DevOps. One thing is for certain: DevOps is no longer a 'nice to have' when deploying co\", \"mplex, Cloud Native Applications. It's a requirement and should be planned for and resourced at the \", \"start of any project.\\n\\n## References\\n\\n- Azure DevOps\\n- Azure Resource Manager\\n- Terraform\\n- Azure CL\", \"I\\n\\nMicro services\\n\\nModern\\n\\nDesign\\n\\nContainers\\n\\nBacking\\n\\nServices\\n\\n## Summary: Architecting cloud-nat\", \"ive apps\\n\\nIn summary, here are important conclusions from this guide:\\n\\n- Cloud-native is about desig\", \"ning modern applications that embrace rapid change, large scale, and resilience, in modern, dynamic \", \"environments such as public, private, and hybrid clouds.\\n- The Cloud Native Computing Foundation (CN\", \"CF) is an influential open-source consortium of over 300 major corporations. It's responsible for dr\", \"iving the adoption of cloud -native computing across technology and cloud stacks.\\n- CNCF guidelines \", \"recommend that cloud-native applications embrace six important pillars as shown in Figure 11-1:\\n- Th\", \"ese cloud-native pillars include:\\n- -The cloud and its underlying service model\\n- -Modern design pri\", \"nciples\\n- -Microservices\\n- -Containerization and container orchestration\\n- -Cloud-based backing serv\", \"ices, such as databases and message brokers\\n- -Automation, including Infrastructure as Code and code\", \" deployment\\n\\nFigure 11-1 . Cloud-native foundational pillars\\n\\n<!-- image -->\\n\\n<!-- image -->\\n\\n- Kube\", \"rnetes is the hosting environment of choice for most cloud-native applications. Smaller, simple serv\", \"ices are sometimes hosted in serverless platforms, such as Azure Functions. Among many key automatio\", \"n features, both environments provide automatic scaling to handle fluctuating workload volumes.\\n- Se\", \"rvice communication becomes a significant design decision when constructing a cloudnative applicatio\", \"n. Applications typically expose an API gateway to manage front-end client communication. Then backe\", \"nd microservices strive to communicate with each other implementing asynchronous communication patte\", \"rns, when possible.\\n- gRPC is a modern, high-performance framework that evolves the age-old remote p\", \"rocedure call (RPC) protocol. Cloud-native applications often embrace gRPC to streamline messaging b\", \"etween back-end services. gRPC uses HTTP/2 for its transport protocol. It can be up to 8x faster tha\", \"n JSON serialization with message sizes 60-80% smaller. gRPC is open source and managed by the Cloud\", \" Native Computing Foundation (CNCF).\\n- Distributed data is a model often implemented by cloud-native\", \" applications. Applications segregate business functionality into small, independent microservices. \", \"Each microservice encapsulates its own dependencies, data, and state. The classic shared database mo\", \"del evolves into one of many smaller databases, each aligning with a microservice. When the smoke cl\", \"ears, we emerge with a design that exposes a database-per-microservice model.\\n- No-SQL databases ref\", \"er to high-performance, non-relational data stores. They excel in their ease-of-use, scalability, re\", \"silience, and availability characteristics. High volume services that require sub second response ti\", \"me favor NoSQL datastores. The proliferation of NoSQL technologies for distributed cloudnative syste\", \"ms can't be overstated.\\n- NewSQL is an emerging database technology that combines the distributed sc\", \"alability of NoSQL and the ACID guarantees of a relational database. NewSQL databases target busines\", \"s systems that must process high-volumes of data, across distributed environments, with full transac\", \"tional/ACID compliance. The Cloud Native Computing Foundation (CNCF) features several NewSQL databas\", \"e projects.\\n- Resiliency is the ability of your system to react to failure and still remain function\", \"al. Cloudnative systems embrace distributed architecture where failure is inevitable. Applications m\", \"ust be constructed to respond elegantly to failure and quickly return to a fully functioning state.\\n\", \"- Service meshes are a configurable infrastructure layer with built-in capabilities to handle servic\", \"e communication and other cross-cutting challenges. They decouple cross-cutting responsibilities fro\", \"m your business code. These responsibilities move into a service proxy. Referred to as the Sidecar p\", \"attern, the proxy is deployed into a separate process to provide isolation from your business code.\\n\", \"- Observability is a key design consideration for cloud-native applications. As services are distrib\", \"uted across a cluster of nodes, centralized logging, monitoring, and alerts, become mandatory. Azure\", \" Monitor is a collection of cloud-based tools designed to provide visibility into the state of your \", \"system.\\n\\n- Infrastructure as Code is a widely accepted practice that automates platform provisioning\", \". Your infrastructure and deployments are automated, consistent, and repeatable. Tools like Azure Re\", \"source Manager, Terraform, and the Azure CLI, enable you to declaratively script the cloud infrastru\", \"cture you require.\\n- Code automation is a requirement for cloud-native applications. Modern CI/CD sy\", \"stems help fulfill this principle. They provide separate build and deployment steps that help ensure\", \" consistent and quality code. The build stage transforms the code into a binary artifact. The releas\", \"e stage picks up the binary artifact, applies external environment configuration, and deploys it to \", \"a specified environment. Azure DevOps and GitHub are full-featured DevOps environments.\"]"