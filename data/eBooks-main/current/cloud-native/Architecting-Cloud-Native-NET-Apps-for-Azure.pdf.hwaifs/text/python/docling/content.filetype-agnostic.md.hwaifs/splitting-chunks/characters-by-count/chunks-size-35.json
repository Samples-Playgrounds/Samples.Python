"[\"<!-- image -->\\n\\n## Architecting Cloud-Native .NET Apps for Azure\\n\\n<!-- image -->\\n\\n## EDITION v1.0.3\\n\", \"\\nRefer changelog for the book updates and community contributions.\\n\\nPUBLISHED BY\\n\\nMicrosoft Develope\", \"r Division, .NET, and Visual Studio product teams\\n\\nA division of Microsoft Corporation\\n\\nOne Microsof\", \"t Way\\n\\nRedmond, Washington 98052-6399\\n\\nCopyright \\u00a9 2023 by Microsoft Corporation\\n\\nAll rights reserve\", \"d. No part of the contents of this book may be reproduced or transmitted in any form or by any means\", \" without the written permission of the publisher.\\n\\nThis book is provided \\\"as-is\\\" and expresses the a\", \"uthor's views and opinions. The views, opinions, and information expressed in this book, including U\", \"RL and other Internet website references, may change without notice.\\n\\nSome examples depicted herein \", \"are provided for illustration only and are fictitious. No real association or connection is intended\", \" or should be inferred.\\n\\nMicrosoft and the trademarks listed at https://www.microsoft.com on the \\\"Tr\", \"ademarks\\\" webpage are trademarks of the Microsoft group of companies.\\n\\nMac and macOS are trademarks \", \"of Apple Inc.\\n\\nThe Docker whale logo is a registered trademark of Docker, Inc. Used by permission.\\n\\n\", \"All other marks and logos are property of their respective owners.\\n\\nAuthors:\\n\\nRob Vettor, Principal \", \"MTC (Microsoft Technology Center) Architect for Cloud App Innovation thinkingincloudnative.com, Micr\", \"osoft\\n\\nSteve \\u201cardalis\\u201d Smith, Software Architect and Trainer - Ardalis.com\\n\\nParticipants and Reviewe\", \"rs:\\n\\nCesar De la Torre, Principal Program Manager, .NET team, Microsoft\\n\\nNish Anil, Senior Program M\", \"anager, .NET team, Microsoft\\n\\nJeremy Likness, Senior Program Manager, .NET team, Microsoft\\n\\nCecil Ph\", \"illip, Senior Cloud Advocate, Microsoft\\n\\nSumit Ghosh, Principal Consultant at Neudesic\\n\\nEditors:\\n\\nMa\", \"ira Wenzel, Program Manager, .NET team, Microsoft\\n\\n<!-- image -->\\n\\nDavid Pine, Senior Content Develo\", \"per, .NET docs, Microsoft\\n\\n## Version\\n\\nThis guide has been written to cover .NET 7 version along wit\", \"h many additional updates related to the same \\\"wave\\\" of technologies (that is, Azure and additional \", \"third-party technologies) coinciding in time with the .NET 7 release.\\n\\n## Who should use this guide\\n\", \"\\nThe audience for this guide is mainly developers, development leads, and architects who are interes\", \"ted in learning how to build applications designed for the cloud.\\n\\nA secondary audience is technical\", \" decision-makers who plan to choose whether to build their applications using a cloud-native approac\", \"h.\\n\\n## How you can use this guide\\n\\nThis guide begins by defining cloud native and introducing a refe\", \"rence application built using cloudnative principles and technologies. Beyond these first two chapte\", \"rs, the rest of the book is broken up into specific chapters focused on topics common to most cloud-\", \"native applications. You can jump to any of these chapters to learn about cloud-native approaches to\", \":\\n\\n- Data and data access\\n- Communication patterns\\n- Scaling and scalability\\n- Application resilienc\", \"y\\n- Monitoring and health\\n- Identity and security\\n- DevOps\\n\\nThis guide is available both in PDF form\", \" and online. Feel free to forward this document or links to its online version to your team to help \", \"ensure common understanding of these topics. Most of these topics benefit from a consistent understa\", \"nding of the underlying principles and patterns, as well as the trade -offs involved in decisions re\", \"lated to these topics. Our goal with this document is to equip teams and their leaders with the info\", \"rmation they need to make well-informed decisions for their applications' architecture, development,\", \" and hosting.\\n\\n<!-- image -->\\n\\n## Contents\\n\\n| Introduction to cloud - native applications ..........\", \"..................................................................                                  \", \"                                       | 1                                                          \", \"                             |\\n|--------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"--------------------------|-------------------------------------------------------------------------\", \"----------------|\\n| Cloud - native computing  ......................................................\", \".......... ................................................................ ..................      \", \"             | 3                                                                                    \", \"   |\\n| What is Cloud Native? ................................ ................................ .....\", \"...........................................................                                         \", \"| ............................ 4                                                          |\\n| The pi\", \"llars of cloud native ................................................................ .............\", \"...................................................                                    | ...........\", \"..... 5                                                                      |\\n| The cloud .........\", \"....................... ................................................................ ...........\", \".....................................................                     | ................ 5      \", \"                                                                |\\n| Modern design ..................\", \".............. ................................................................ ....................\", \"............................................                 | ..... 6                              \", \"                                                   |\\n| Microservices  ..............................\", \".. ................................................................                                 \", \"                                                | ..................................................\", \".............. ........ 9             |\\n| Containers  ................................ .............\", \"................................................... ................................................\", \"................                   | ...........  12                                                \", \"                         |\\n| Backing services ................................ .....................\", \"........................................... ................................ .......................\", \".........             | 15                                                                          \", \"            |\\n| Automation ................................ ........................................\", \"........................ ................................................................           \", \"         | .........  17                                                                           |\", \"\\n| Candidate apps for cloud native ................................................................ \", \"................................................................                                | ..\", \"...  19                                                                               |\\n| Modernizin\", \"g legacy apps ................................................................ .....................\", \"........................................... ..............                         | 19             \", \"                                                                         |\\n| Summary ...............\", \"................. ................................................................                  \", \"                                                                      | ............................\", \".................................... ..............  21     |\\n| Introducing eShopOnContainers refere\", \"nce app  ................................................................                           \", \"                                                         | 22                                       \", \"                                               |\\n| Features and requirements  ......................\", \".......................................... .........................................................\", \"....... ...............                     | 23                                                    \", \"                                  |\\n| Overview of the code  ................................ .......\", \"......................... ................................................................ .........\", \".................              | 25                                                                 \", \"                     |\\n| Understanding microservices ...............................................\", \"................. ................................................................ ...........      \", \"                  | 27                                                                              \", \"        |\\n| Mapping eShopOnContainers to Azure Services ................................ ...........\", \".....................................................                                               \", \"     | .....  27                                                                               |\\n| C\", \"ontainer orchestration and clustering ................................ .............................\", \"................................... ...................                                     | 28    \", \"                                                                                  |\\n| API Gateway  .\", \"............................... ................................................................ ...\", \".............................................................                  | .......  28        \", \"                                                                     |\\n| Data  .....................\", \"........... ................................................................ .......................\", \"......................................... ....................... | 29                              \", \"                                                        |\\n| Event Bus  .............................\", \"... ................................................................ ...............................\", \".................................                    | .............  30                            \", \"                                           |\\n| Resiliency ................................ .........\", \"....................................................... ............................................\", \"....................                    | .............  30                                         \", \"                              |\\n| Deploying eShopOnContainers to Azure .............................\", \"... ................................................................ ....................           \", \"                           | 30                                                                     \", \"                 |\\n| Azure Kubernetes Service  .....................................................\", \"........... ................................................................                        \", \"              | .............  30                                                                   \", \"    |\\n| Deploying to Azure Kubernetes Service using Helm  ..........................................\", \"......................                                                                              \", \" | .........................  30                                                           |\\n| Azure\", \" Functions and Logic Apps (Serverless)  ................................                            \", \"                                                                                        | ..........\", \"...................................................... .......  32            |\\n| Centralized config\", \"uration ................................................................                            \", \"                                                                           | .......................\", \"......................................... ..................  33 |\\n\\n| Azure App Configuration  .....\", \"........................................................... ........................................\", \"........................ ..............                 | 33                              |\\n|-------\", \"----------------------------------------------------------------------------------------------------\", \"--------------------------------------------------------------------------------|-------------------\", \"--------------|\\n| Azure Key Vault ................................ .................................\", \"............................... ................................................................    \", \"    | .  34                           |\\n| Configuration in eShop ...................................\", \"............................. ................................................................ .....\", \".............               | 34                              |\\n| References .......................\", \"......... ................................................................ .........................\", \"....................................... ........... | 34                              |\\n| Scaling cl\", \"oud-native applications ............................................................................\", \"............                                                                | 36                    \", \"          |\\n| Leveraging containers and orchestrators ................................ .............\", \"................................................... ....................                            \", \"| 36                              |\\n| Challenges with monolithic deployments  ......................\", \".......... ................................................................ ..............          \", \"                        | 36                              |\\n| What are the benefits of containers an\", \"d orchestrators?  ................................................................ .................\", \".                                               | 38                              |\\n| What are the s\", \"caling benefits? ................................................................ ..................\", \"..............................................                          | ....  40                  \", \"      |\\n| What scenarios are ideal for containers and orchestrators? ...............................\", \"................................. ...........                                                   | 42\", \"                              |\\n| When should you avoid using containers and orchestrators? ........\", \"........................................................                                            \", \"                    | .......  42                     |\\n| Development resources ....................\", \"............................................ .......................................................\", \"......... .................                 | 42                              |\\n| Leveraging serverl\", \"ess functions  ................................................................ ....................\", \"............................................                        | ......  46                    \", \"  |\\n| What is serverless? ................................ ................................ ........\", \"........................................................ ...........................        | 47    \", \"                          |\\n| What challenges are solved by serverless?  ...........................\", \"..... ................................................................ ............                 \", \"                | 47                              |\\n| What is the difference between a microservice \", \"and a serverless function?  ................................ .............                          \", \"                                        | 47                              |\\n| What scenarios are app\", \"ropriate for serverless? ................................ ..........................................\", \"......................                                          | ...  47                         |\\n\", \"| When should you avoid serverless? ................................ ...............................\", \"................................. ..........................                            | 48        \", \"                      |\\n| Combining containers and serverless approaches ...........................\", \"..... ................................................................                              \", \"            | ..  49                          |\\n| When does it make sense to use containers with ser\", \"verless? ................................................................                           \", \"                                    | ........  49                    |\\n| When should you avoid usin\", \"g containers with Azure Functions?  ................................ ...............................\", \".                                                           | 49                              |\\n| Ho\", \"w to combine serverless and Docker containers  .....................................................\", \"........... ...........................                                             | 49            \", \"                  |\\n| How to combine serverless and Kubernetes with KEDA  ..........................\", \"...................................... ..................                                           \", \"        | 50                              |\\n| Deploying containers in Azure  .......................\", \"......................................... ..........................................................\", \"...... ........                 | 50                              |\\n| Azure Container Registry  ....\", \"............................................................ .......................................\", \"......................... ..............                | 50                              |\\n| ACR Ta\", \"sks  ................................ ..............................................................\", \".. ................................................................             | ............  52  \", \"              |\\n| Azure Kubernetes Service  ........................................................\", \"........ ................................................................ .............             \", \"    | 52                              |\\n| Azure Bridge to Kubernetes ...............................\", \"................................. ................................................................  \", \"                            | .........  53                   |\\n| Scaling containers and serverless \", \"applications  ................................ .....................................................\", \"...........                                         | .........  53                   |\\n| The simple\", \" solution: scaling up  ................................................................ ............\", \"....................................................                        | ..  53                \", \"          |\\n| Scaling out cloud-native apps  .......................................................\", \"......... ................................................................                          \", \"| ....  54                        |\\n| Other container deployment options  ..........................\", \"...... ................................................................                             \", \"                        | ...........................  55 |\\n\\n| When does it make sense to deploy to \", \"App Service for Containers?  ................................                                       \", \"                                                           | .........................  55          \", \"                                                    |\\n|---------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------|-----------------------------------------------\", \"---------------------------------------------|\\n| How to deploy to App Service for Containers .......\", \"......................... ................................................................          \", \"                                             | ......  55                                           \", \"                                      |\\n| When does it make sense to deploy to Azure Container Insta\", \"nces?  ................................ ..........................                                  \", \"                                      | 55                                                          \", \"                               |\\n| How to deploy an app to Azure Container Instances ...............\", \"................................................. ........................                          \", \"                               | 55                                                                 \", \"                        |\\n| References ................................ ............................\", \".................................... ...............................................................\", \". ...........           | 56                                                                        \", \"                 |\\n| Cloud - native communication patterns  ........................................\", \".......................................                                                             \", \"                 | 58                                                                               \", \"          |\\n| Communication considerations  ........................................................\", \"........ ................................................................                           \", \"          | ......  58                                                                              \", \"   |\\n| Front - end client communication ............................................................\", \".... ................................................................                               \", \"   | ....  60                                                                                   |\\n| \", \"Simple Gateways  ................................ ..................................................\", \".............. ................................ ..............................                  | 62\", \"                                                                                         |\\n| Azure A\", \"pplication Gateway ................................................................ ................\", \"................................................ ..........                              | 63       \", \"                                                                                  |\\n| Azure API Mana\", \"gement ................................................................ ............................\", \".................................... .................                            | 63              \", \"                                                                           |\\n| Real - time communica\", \"tion  ................................................................ .............................\", \"................................... ............                           | 66                     \", \"                                                                    |\\n| Service - to - service commu\", \"nication  ................................................................ .........................\", \"....... ................................                            | 67                            \", \"                                                             |\\n| Queries  ..........................\", \"...... ................................................................ ............................\", \".................................... .................       | 68                                   \", \"                                                      |\\n| Commands ................................ \", \"................................................................ ...................................\", \"............................. ..........              | 71                                          \", \"                                               |\\n| Events ................................ .........\", \"....................................................... ............................................\", \".................... ....................      | 74                                                 \", \"                                        |\\n| gRPC ...................................................\", \"............. ................................ .....................................................\", \"........... ........................... | 80                                                        \", \"                                 |\\n| What is gRPC?  ................................ ...............\", \"................................................. ..................................................\", \"..............                   | ...  80                                                          \", \"                          |\\n| gRPC Benefits  ................................ ......................\", \".......................................... .........................................................\", \".......                   | ....  80                                                                \", \"                   |\\n| Protocol Buffers  ................................ ..........................\", \"...................................... ................................ ............................\", \"....               | 81                                                                             \", \"            |\\n| gRPC support in .NET  ..............................................................\", \".. ................................................................ .....................           \", \"            | 81                                                                                    \", \"     |\\n| gRPC usage ................................ ...............................................\", \"................. ................................................................                  \", \"     | .........  82                                                                              |\\n\", \"| gRPC implementation  ................................................................ ............\", \".................................................... ....................                         | \", \"83                                                                                         |\\n| Looki\", \"ng ahead ................................ ..........................................................\", \"...... ................................................................                    | ...  85\", \"                                                                                    |\\n| Service Mesh\", \" communication infrastructure  ................................ ....................................\", \"............................ .............                                          | 85            \", \"                                                                             |\\n| Summary ...........\", \"..................... ................................................................ .............\", \"................................................... ..............           | 86                   \", \"                                                                      |\\n| Cloud - native data patter\", \"ns  ................................................................................................\", \"..                                                                    | 88                          \", \"                                                               |\\n| Database - per - microservice, wh\", \"y?  ................................................................ ...............................\", \".................................                              | ..  89                             \", \"                                                        |\\n| Cross - service queries ................\", \"................ ................................ ..................................................\", \".............. ...........................              | 90                                        \", \"                                                 |\\n| Distributed transactions  .....................\", \"........................................... ........................................................\", \"........ .....................                   | 91                                               \", \"                                          |\\n| High volume data  ................................ ...\", \"............................................................. ......................................\", \"..........................                | .  93                                                   \", \"                                   |\\n| CQRS  ................................ ......................\", \"..........................................                                                          \", \"                                   | ...............................................................\", \". .....................  93 |\\n\\n| Event sourcing ................................ ...................\", \".............................................                                                       \", \"                      | ................................................................ ...  94    \", \"                 |\\n|--------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------|-----------------------------------------------------------------------------------------\", \"-----|\\n| Relational vs. NoSQL data  ................................................................\", \" ................................................................ .................               | \", \"96                                                                                           |\\n| The\", \" CAP theorem  ................................ .....................................................\", \"........... ................................ .............................            | 97          \", \"                                                                                 |\\n| Considerations \", \"for relational vs. NoSQL systems ................................ ................................ .\", \"...............................                                           | 99                      \", \"                                                                     |\\n| Database as a Service  ....\", \"............................................................ .......................................\", \"......................... .....................               | 99                                  \", \"                                                         |\\n| Azure relational databases  ...........\", \"..................................................... ..............................................\", \".................. .........                      | 100                                             \", \"                                             |\\n| Azure SQL Database ................................\", \" ................................ ................................................................ .\", \".....................                 | 100                                                         \", \"                                 |\\n| Open - source databases in Azure ..............................\", \".................................. ................................ .............................   \", \"                          | 101                                                                     \", \"                     |\\n| NoSQL data in Azure  ......................................................\", \".......... ................................................................ ....................    \", \"              | 102                                                                                 \", \"         |\\n| NewSQL databases ................................ ................................ ....\", \"............................................................ ........................               \", \"  | 106                                                                                          |\\n|\", \" Data migration to the cloud  ................................................................ .....\", \"...........................................................                               | ...... 1\", \"08                                                                                   |\\n| Caching in \", \"a cloud-native app ................................................................ ................\", \"................................................                              | ....... 108         \", \"                                                                         |\\n| Why? ..................\", \".............. ................................................................ ....................\", \"............................................ .................... | 108                             \", \"                                                             |\\n| Caching architecture ..............\", \".................................................. .................................................\", \"............... .....................                 | 109                                         \", \"                                                 |\\n| Azure Cache for Redis  ........................\", \"........................................ ...........................................................\", \"..... ..................                  | 110                                                     \", \"                                     |\\n| Elasticsearch in a cloud - native app  ....................\", \"............................................ ................................ ......................\", \".......                       | 110                                                                 \", \"                         |\\n| Summary ................................ ..............................\", \"..................................                                                                  \", \"                  | ................................................................ ............ 11\", \"1            |\\n| Cloud - native resiliency  ........................................................\", \"...............................................                                                     \", \"      | 113                                                                                         \", \" |\\n| Application resiliency patterns  ..............................................................\", \".. ................................................................                           | ....\", \".. 114                                                                                   |\\n| Circuit\", \" breaker pattern ................................................................ ..................\", \".............................................. .................                  | 116             \", \"                                                                             |\\n| Testing for resilie\", \"ncy ................................................................ ...............................\", \"................................. .....................               | 117                         \", \"                                                                 |\\n| Azure platform resiliency  ....\", \"............................................................ .......................................\", \"......................... .................               | 117                                     \", \"                                                     |\\n| Design with resiliency ....................\", \"............................................ .......................................................\", \"......... ...................                 | 118                                                 \", \"                                         |\\n| Design with redundancy ................................\", \"................................ ................................................................ ..\", \"............                      | 118                                                             \", \"                             |\\n| Design for scalability ............................................\", \".................... ................................................................ ..............\", \".......               | 120                                                                         \", \"                 |\\n| Built - in retry in services  .................................................\", \"............... ................................................................ ...............    \", \"          | 121                                                                                     \", \"     |\\n| Resilient communications ................................................................  \", \"                                                                                                  | \", \"................................................................ ................ 122        |\\n| Ser\", \"vice mesh  ................................ ........................................................\", \"........ ................................................................             | .... 123    \", \"                                                                                 |\\n| Istio and Envoy\", \" ................................ ................................................................  \", \"                                                                          | ........................\", \"........................................ 124                         |\\n| Integration with Azure Kube\", \"rnetes Services  ................................ ..................................................\", \"..............                                                | ....... 125                         \", \"                                                         |\\n| Monitoring and health .................\", \".......................................................................................             \", \"                                                  | 126                                             \", \"                                             |\\n| Observability patterns ............................\", \".... ................................                                                               \", \"                                      | ............................................................\", \".... ....................... 126 |\\n\\n| When to use logging ..........................................\", \"...................... ................................................................ ............\", \"........                     | 126           |\\n|----------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------|---------------|\\n| Challenges with detecting and responding\", \" to potential app health issues  ................................ ...........                       \", \"                                                   | 130           |\\n| Challenges with reacting to c\", \"ritical problems in cloud-native apps ................................ ..........................   \", \"                                                              | 130           |\\n| Logging with Elast\", \"ic Stack ................................................................ ..........................\", \"...................................... ...............                   | 131           |\\n| Elastic\", \" Stack  ................................ ...........................................................\", \"..... ................................................................              | ...... 131    \", \"|\\n| What are the advantages of Elastic Stack?  ................................ ....................\", \"............................................ ..........                                        | 132\", \"           |\\n| Logstash ................................ ...........................................\", \"..................... ................................................................ .............\", \"      | 132           |\\n| Elasticsearch  ................................ ..........................\", \"...................................... .............................................................\", \"...              | ..... 133     |\\n| Visualizing information with Kibana web dashboards  ...........\", \"..................................................... ....................                          \", \"                            | 133           |\\n| Installing Elastic Stack on Azure ..................\", \".............................................. .....................................................\", \"..........                             | 134           |\\n| References ..............................\", \".. ................................................................ ................................\", \"................................                  | ......... 134 |\\n| Monitoring in Azure Kubernetes\", \" Services ................................ .........................................................\", \"....... .................                                    | 134           |\\n| Azure Monitor for C\", \"ontainers  ................................................................ ........................\", \"........................................                                | ... 134       |\\n| Log.Fina\", \"lize()  ................................ ...........................................................\", \"..... ................................................................             | .... 136      |\", \"\\n| Azure Monitor ................................ ..................................................\", \".............. ................................................................               | ....\", \".. 136    |\\n| Gathering logs and metrics ...........................................................\", \"..... ................................................................ ........                     \", \"     | 137           |\\n| Reporting data  ................................ ..........................\", \"...................................... .............................................................\", \"...             | 137           |\\n| Dashboards ................................ ....................\", \"............................................ .......................................................\", \".........                  | ....... 138   |\\n| Alerts  ................................ ............\", \".................................................... ...............................................\", \"................. ................... | 140           |\\n| References ...............................\", \". ................................................................ .................................\", \"...............................                  | ......... 141 |\\n| Cloud - native identity  ......\", \"....................................................................................................\", \"                                                            | 142           |\\n| References  ........\", \"........................ ................................................................ ..........\", \"...................................................... .............   | 142           |\\n| Authentic\", \"ation and authorization in cloud - native apps  ....................................................\", \"............ .....................                                                | 142           |\\n\", \"| References ................................ ......................................................\", \".......... ................................................................ .........        | 143  \", \"         |\\n| Azure Active Directory  ................................ ..............................\", \".. ................................................................ ......................          \", \"    | 143           |\\n| References ................................ ................................\", \"................................ ................................................................   \", \"               | ......... 143 |\\n| IdentityServer for cloud-native applications ....................\", \"............ ................................................................ ............          \", \"                          | 144           |\\n| Common web app scenarios  ............................\", \".................................... ...............................................................\", \".                                    | ..... 144     |\\n| Getting started  ..........................\", \"...... ................................................................ ............................\", \"....................................            | 145           |\\n| Configuration ..................\", \".............. ................................................................ ....................\", \"............................................               | ... 145       |\\n| JavaScript clients  .\", \"............................... ................................................................ ...\", \"............................. ............................            | 146           |\\n| References\", \" ................................ ................................................................ .\", \"...............................................................                  | ......... 146 |\\n\\n\", \"| Cloud - native security ..........................................................................\", \"................................                                                            | 147   \", \"               |\\n|----------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"---------|----------------------|\\n| Azure security for cloud-native apps  ..........................\", \"...................................... ................................ ..........................  \", \"                          | 147                  |\\n| Threat modeling  ..............................\", \".. ................................................................ ................................\", \" .............................             | 148                  |\\n| Principle of least privilege .\", \"............................................................... ....................................\", \"............................ ...........                    | 148                  |\\n| Penetration t\", \"esting ................................ ................................ ...........................\", \"..................................... ........................               | 149                  \", \"|\\n| Monitoring ................................ ....................................................\", \"............ ................................................................ ........        | 149 \", \"                 |\\n| Securing the build ................................ ...........................\", \"..................................... ................................ ..........................   \", \"           | 149                  |\\n| Building secure code  ........................................\", \"........................ ................................................................ ..........\", \"..........                  | 150                  |\\n| Built - in security  ........................\", \"........ ................................................................ ..........................\", \".....................................        | 150                  |\\n| Azure network infrastructure\", \" ................................................................ ..................................\", \"..............................                                | ..... 150            |\\n| Role - base\", \"d access control for restricting access to Azure resources ................................ ........\", \"................                                                               | 152                \", \"  |\\n| Security Principals  ................................ ........................................\", \"........................ ................................ ..........................            | 15\", \"2                  |\\n| Roles ................................ ......................................\", \".......................... ................................................................ ........\", \"............ | 153                  |\\n| Scopes  ................................ ...................\", \"............................................. ......................................................\", \".......... ................   | 154                  |\\n| Deny  ................................ ....\", \"............................................................ .......................................\", \"......................... .................... | 154                  |\\n| Checking access ..........\", \"...................... ................................................................ ............\", \".................... ..............................             | 154                  |\\n| Securing \", \"secrets ................................ ...........................................................\", \"..... ................................ ..............................            | 155              \", \"    |\\n| Azure Key Vault ................................ ...........................................\", \"..................... ...............................................................             | \", \"155                  |\\n| Kubernetes ................................ ...............................\", \"................................. ................................................................  \", \"               | ........ 155         |\\n| Encryption in transit and at rest ........................\", \"........................................ ...........................................................\", \"....                            | 156                  |\\n| Keeping secure ..........................\", \"...... ................................................................ ............................\", \"....................................             | 160                  |\\n| DevOps  ................\", \"....................................................................................................\", \".............                                                     | 161                  |\\n| Azure D\", \"evOps ................................ .............................................................\", \"... ................................................................               | ....... 162    \", \"      |\\n| GitHub Actions ................................ ..........................................\", \"...................... ................................................................             \", \"| ..... 163            |\\n| Source control ................................ .........................\", \"....................................... ............................................................\", \"....             | ...... 163           |\\n| Repository per microservice  ...........................\", \"..................................... ..............................................................\", \"..                                | ...... 164           |\\n| Single repository  ....................\", \"............ ................................................................ ......................\", \".......... ............................            | 166                  |\\n| Standard directory str\", \"ucture ................................................................ ............................\", \"....................................                                | ...... 167           |\\n| Task \", \"management  ................................ .......................................................\", \"......... ................................ ..............................            | 167          \", \"        |\\n| CI/CD pipelines  ................................ ......................................\", \".......................... ................................................................         \", \"  | .... 169             |\\n| Azure Builds ................................ .........................\", \"....................................... ............................................................\", \"....               | ...... 170           |\\n| Azure DevOps releases  ...............................\", \"................................. ................................................................  \", \"                                    | ................ 172 |\\n\\n| Everybody gets a build pipeline ....\", \"............................................................ .......................................\", \"........................ 173                            |\\n|-----------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------|\\n| Versioning releases ........................\", \"........ ................................ ..........................................................\", \"...... ........................ 173             |\\n| Feature flags  ................................ \", \"................................................................ ...................................\", \"............................. ......... 173 |\\n| Implementing feature flags .........................\", \"....................................... ............................................................\", \".... ........ 174                       |\\n| Infrastructure as code  ................................\", \" ................................ ................................................................ .\", \"...................... 175          |\\n| Azure Resource Manager templates  ..........................\", \"...... ................................................................ ...................... 175  \", \"                                |\\n| Terraform ................................ .....................\", \"........................................... ........................................................\", \"........ ........... 176    |\\n| Azure CLI Scripts and Tasks ........................................\", \"........................ ................................................................ ........ 1\", \"77                      |\\n| Cloud Native Application Bundles  ......................................\", \".......................... ............................................................... 178      \", \"                    |\\n| DevOps Decisions  ................................ .........................\", \"....................................... ................................ .......................... \", \"180             |\\n| References ................................ ....................................\", \"............................ ................................................................ ......\", \"... 180     |\\n| Summary: Architecting cloud-native apps  ...........................................\", \"............................  181                                                                   \", \"        |\\n\\n\\u0413\\n\\n1\\n\\nClient app\\n\\nMobile\\n\\nTraditional web app\\n\\nDatabase\\n\\nRelational\\n\\n## Introduction to c\", \"loud -native applications Marketing Location\\n\\nAnother day, at the office, working on \\u201cthe next big t\", \"hing.\\u201d\\n\\nYour cellphone rings. It's your friendly recruiter - the one who calls daily with exciting n\", \"ew opportunities.\\n\\nBut this time it's different: Start -up, equity, and plenty of funding.\\n\\nThe ment\", \"ion of the cloud, microservices, and cutting-edge technology pushes you over the edge.\\n\\nFast forward\", \" a few weeks and you're now a new employee in a design session architecting a major eCommerce applic\", \"ation. You're going to compete with the leading eCommerce sites.\\n\\nHow will you build it?\\n\\nIf you fol\", \"low the guidance from past 15 years, you\\u2019ll most likely build the system shown in Figure 1.1.\\n\\nFigur\", \"e 1 -1. Traditional monolithic design\\n\\n<!-- image -->\\n\\nYou construct a large core application contai\", \"ning all of your domain logic. It includes modules such as Identity, Catalog, Ordering, and more. Th\", \"ey directly communicate with each other within a single server process. The modules share a large re\", \"lational database. The core exposes functionality via an HTML interface and a mobile app.\\n\\nCongratul\", \"ations! You just created a monolithic application.\\n\\nNot all is bad. Monoliths offer some distinct ad\", \"vantages. For example, they\\u2019re straightforward to\\u2026\\n\\nMonolithic server process\\n\\nModules\\n\\nAPI\\n\\nIdentit\", \"y\\n\\nCatalog\\n\\n- build\\n- test\\n- deploy\\n- troubleshoot\\n- vertically scale\\n\\nMany successful apps that exi\", \"st today were created as monoliths. The app is a hit and continues to evolve, iteration after iterat\", \"ion, adding more functionality.\\n\\nAt some point, however, you begin to feel uncomfortable. You find y\", \"ourself losing control of the application. As time goes on, the feeling becomes more intense, and yo\", \"u eventually enter a state known as the Fear Cycle:\\n\\n- The app has become so overwhelmingly complica\", \"ted that no single person understands it.\\n- You fear making changes - each change has unintended and\", \" costly side effects.\\n- New features/fixes become tricky, time-consuming, and expensive to implement\", \".\\n- Each release becomes as small as possible and requires a full deployment of the entire applicati\", \"on.\\n- One unstable component can crash the entire system.\\n- New technologies and frameworks aren't a\", \"n option.\\n- It's difficult to implement agile delivery methodologies.\\n- Architectural erosion sets i\", \"n as the code base deteriorates with never -ending \\\"quick fixes.\\\"\\n- Finally, the consultants come in\", \" and tell you to rewrite it.\\n\\n## Sound familiar?\\n\\nMany organizations have addressed this monolithic \", \"fear cycle by adopting a cloud-native approach to building systems. Figure 1-2 shows the same system\", \" built applying cloud-native techniques and practices.\\n\\nClient apps\\n\\nMobile app\\n\\nTraditional Web app\", \"\\n\\nHTML\\n\\nSPA Web app\\n\\nTypeScript/Angular 2\\n\\nIdentity microservice (STS+users)\\n\\nRelational database\\n\\nC\", \"atalog microservice\\n\\nFigure 1 -2. Cloud -native design\\n\\n<!-- image -->\\n\\nNote how the application is \", \"decomposed across a set of small isolated microservices. Each service is self -contained and encapsu\", \"lates its own code, data, and dependencies. Each is deployed in a software container and managed by \", \"a container orchestrator. Instead of a large relational database, each service owns it own datastore\", \", the type of which vary based upon the data needs. Note how some services depend on a relational da\", \"tabase, but other on NoSQL databases. One service stores its state in a distributed cache. Note how \", \"all traffic routes through an API Gateway service that is responsible for routing traffic to the cor\", \"e back-end services and enforcing many cross-cutting concerns. Most importantly, the application tak\", \"es full advantage of the scalability, availability, and resiliency features found in modern cloud pl\", \"atforms.\\n\\n## Cloud -native computing\\n\\nHmm\\u2026 We just used the term, Cloud Native. Your first thought m\", \"ight be, \\\"What exactly does that mean?\\\" Another industry buzzword concocted by software vendors to m\", \"arket more stuff?\\\"\\n\\nFortunately it\\u2019s far different, and hopefully this book will help convince you.\\n\", \"\\nWithin a short time, cloud native has become a driving trend in the software industry. It's a new w\", \"ay to construct large, complex systems. The approach takes full advantage of modern software develop\", \"ment practices, technologies, and cloud infrastructure. Cloud native changes the way you design, imp\", \"lement, deploy, and operationalize systems.\\n\\nUnlike the continuous hype that drives our industry, cl\", \"oud native is for-real. Consider the Cloud Native Computing Foundation (CNCF), a consortium of over \", \"400 major corporations. Its charter is to make\\n\\nDocker Host\\n\\ncloud -native computing ubiquitous acro\", \"ss technology and cloud stacks. As one of the most influential open -source groups, it hosts many of\", \" the fastest-growing open source-projects in GitHub. These projects include Kubernetes , Prometheus \", \", Helm , Envoy, and gRPC .\\n\\nThe CNCF fosters an ecosystem of open-source and vendor-neutrality. Foll\", \"owing that lead, this book presents cloud-native principles, patterns, and best practices that are t\", \"echnology agnostic. At the same time, we discuss the services and infrastructure available in the Mi\", \"crosoft Azure cloud for constructing cloud-native systems.\\n\\nSo, what exactly is Cloud Native? Sit ba\", \"ck, relax, and let us help you explore this new world.\\n\\n## What is Cloud Native?\\n\\nStop what you're d\", \"oing and ask your colleagues to define the term \\\"Cloud Native\\\". There's a good chance you'll get sev\", \"eral different answers.\\n\\nLet\\u2019s start with a simple definition:\\n\\nCloud -native architecture and techn\", \"ologies are an approach to designing, constructing, and operating workloads that are built in the cl\", \"oud and take full advantage of the cloud computing model.\\n\\nThe Cloud Native Computing Foundation pro\", \"vides the official definition:\\n\\nCloud -native technologies empower organizations to build and run sc\", \"alable applications in modern, dynamic environments such as public, private, and hybrid clouds. Cont\", \"ainers, service meshes, microservices, immutable infrastructure, and declarative APIs exemplify this\", \" approach.\\n\\nThese techniques enable loosely coupled systems that are resilient, manageable, and obse\", \"rvable. Combined with robust automation, they allow engineers to make high-impact changes frequently\", \" and predictably with minimal toil.\\n\\nCloud native is about speed and agility. Business systems are e\", \"volving from enabling business capabilities to weapons of strategic transformation that accelerate b\", \"usiness velocity and growth. It's imperative to get new ideas to market immediately.\\n\\nAt the same ti\", \"me, business systems have also become increasingly complex with users demanding more. They expect ra\", \"pid responsiveness, innovative features, and zero downtime. Performance problems, recurring errors, \", \"and the inability to move fast are no longer acceptable. Your users will visit your competitor. Clou\", \"d-native systems are designed to embrace rapid change, large scale, and resilience.\\n\\nHere are some c\", \"ompanies who have implemented cloud-native techniques. Think about the speed, agility, and scalabili\", \"ty they've achieved.\\n\\n| Company   | Experience                                                      \", \"              |\\n|-----------|-----------------------------------------------------------------------\", \"--------|\\n| Netflix   | Has 600+ services in production. Deploys 100  times per day.                \", \"  |\\n| Uber      | Has 1,000+ services in production. Deploys  several thousand times each week. |\\n\\nM\", \"icro services\\n\\nModern\\n\\nDesign\\n\\n| Company                  | Experience                              \", \"                       |\\n|--------------------------|-----------------------------------------------\", \"-----------------|\\n| WeChat  Cloud Native App | Has 3,000+ services in production. Deploys  1,000 ti\", \"mes a day. |\\n\\nBacking\\n\\nAutomation\\n\\nAs you can see, Netflix, Uber, and, WeChat expose cloud-native sy\", \"stems that consist of many independent services. This architectural style enables them to rapidly re\", \"spond to market conditions. They instantaneously update small areas of a live, complex application, \", \"without a full redeployment. They individually scale services as needed.\\n\\n## The pillars of cloud na\", \"tive\\n\\nThe speed and agility of cloud native derive from many factors. Foremost is cloud infrastructu\", \"re. But there's more: Five other foundational pillars shown in Figure 1-3 also provide the bedrock f\", \"or cloudnative systems.\\n\\nFigure 1 -3. Cloud -native foundational pillars\\n\\n<!-- image -->\\n\\nLet\\u2019s take\", \" some time to better understand the significance of each pillar.\\n\\n## The cloud\\n\\nCloud -native system\", \"s take full advantage of the cloud service model.\\n\\nDesigned to thrive in a dynamic, virtualized clou\", \"d environment, these systems make extensive use of Platform as a Service (PaaS) compute infrastructu\", \"re and managed services. They treat the underlying infrastructure as disposable - provisioned in min\", \"utes and resized, scaled, or destroyed on demand \\u2013 via automation.\\n\\nConsider the widely accepted Dev\", \"Ops concept of Pets vs. Cattle. In a traditional data center, servers are treated as Pets: a physica\", \"l machine, given a meaningful name, and cared for. You scale by adding more resources to the same ma\", \"chine (scaling up). If the server becomes sick, you nurse it back to health. Should the server becom\", \"e unavailable, everyone notices.\\n\\nThe Cattle service model is different. You provision each instance\", \" as a virtual machine or container. They're identical and assigned a system identifier such as Servi\", \"ce-01, Service-02, and so on. You scale by creating more of them (scaling out). When one becomes una\", \"vailable, nobody notices.\\n\\nContainers\\n\\nThe cattle model embraces immutable infrastructure. Servers a\", \"ren't repaired or modified. If one fails or requires updating, it's destroyed and a new one is provi\", \"sioned \\u2013 all done via automation.\\n\\nCloud -native systems embrace the Cattle service model. They cont\", \"inue to run as the infrastructure scales in or out with no regard to the machines upon which they're\", \" running.\\n\\nThe Azure cloud platform supports this type of highly elastic infrastructure with automat\", \"ic scaling, self -healing, and monitoring capabilities.\\n\\n## Modern design\\n\\nHow would you design a cl\", \"oud-native app? What would your architecture look like? To what principles, patterns, and best pract\", \"ices would you adhere? What infrastructure and operational concerns would be important?\\n\\n## The Twel\", \"ve -Factor Application\\n\\nA widely accepted methodology for constructing cloud-based applications is t\", \"he Twelve-Factor Application. It describes a set of principles and practices that developers follow \", \"to construct applications optimized for modern cloud environments. Special attention is given to por\", \"tability across environments and declarative automation.\\n\\nWhile applicable to any web-based applicat\", \"ion, many practitioners consider Twelve-Factor a solid foundation for building cloud-native apps. Sy\", \"stems built upon these principles can deploy and scale rapidly and add features to react quickly to \", \"market changes .\\n\\nThe following table highlights the Twelve-Factor methodology:\\n\\n| Factor           \", \"      | Explanation                                                                                 \", \"                                                                                                    \", \"                                            |\\n|------------------------|----------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"---------|\\n| 1  -  Code Base        | A single code base for each microservice, stored  in its own r\", \"epository. Tracked with version  control, it can deploy to multiple environments  (QA, Staging, Prod\", \"uction).                                                                  |\\n| 2  -  Dependencies    \", \" | Each microservice isolates and packages its own  dependencies, embracing changes without  impacti\", \"ng the entire system.                                                                               \", \"                                       |\\n| 3  -  Configurations   | Configuration information is mov\", \"ed out of the  microservice and externalized through a  configuration management tool outside of the\", \"  code. The same deployment can propagate  across environments with the correct  configuration appli\", \"ed. |\\n| 4  -  Backing Services | Ancillary resources (data stores, caches,  message brokers) should \", \"be exposed via an  addressable URL. Doing so decouples the  resource from the application, enabling \", \"it to be  interchangeable.                                           |\\n\\n| Factor                    \", \"| Explanation                                                                                       \", \"                                                                                                    \", \"                                                                                                   |\", \"\\n|---------------------------|----------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------|\\n| 5  -  Build, Release, Run | Each release must enforce a strict separ\", \"ation  across the build, release, and run stages. Each  should be tagged with a unique ID and suppor\", \"t  the ability to roll back. Modern CI/CD systems  help fulfill this principle.                     \", \"                                                         |\\n| 6  -  Processes           | Each micros\", \"ervice should execute in its own  process, isolated from other running services.  Externalize requir\", \"ed state to a backing service  such as a distributed cache or data store.                           \", \"                                                                                      |\\n| 7  -  Port\", \" Binding        | Each microservice should be self-contained with  its interfaces and functionality \", \"exposed on its  own port. Doing so provides isolation from  other microservices.                    \", \"                                                                                                    \", \"               |\\n| 8  -  Concurrency         | When capacity needs to increase, scale out  services \", \"horizontally across multiple identical  processes (copies) as opposed to scaling-up a  single large \", \"instance on the most powerful  machine available. Develop the application to be  concurrent making s\", \"caling out in cloud  environments seamless. |\\n| 9  -  Disposability       | Service instances should\", \" be disposable. Favor  fast startup to increase scalability opportunities  and graceful shutdowns to\", \" leave the system in a  correct state. Docker containers along with an  orchestrator inherently sati\", \"sfy this requirement.                                                    |\\n| 10  -  Dev/Prod Parity \", \"   | Keep environments across the application  lifecycle as similar as possible, avoiding costly  sh\", \"ortcuts. Here, the adoption of containers can  greatly contribute by promoting the same  execution e\", \"nvironment.                                                                                         \", \"  |\\n| 11  -  Logging            | Treat logs generated by microservices as event  streams. Process t\", \"hem with an event  aggregator. Propagate log data to data\\u0002 mining/log management tools like Azure  M\", \"onitor or Splunk and eventually to long-term  archival.                                             \", \"                               |\\n| 12  -  Admin Processes    | Run administrative/management tasks, \", \"such as  data cleanup or computing analytics, as one-off  processes. Use independent tools to invoke\", \"  these tasks from the production environment,  but separately from the application.                \", \"                                                            |\\n\\nIn the book, Beyond the Twelve-Factor\", \" App, author Kevin Hoffman details each of the original 12 factors (written in 2011). Additionally, \", \"he discusses three extra factors that reflect today's modern cloud application design.\\n\\n| New Factor\", \"                           | Explanation                                                            \", \"                                                                                                    \", \"                                           |\\n|--------------------------------------|---------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"|\\n| 13  -  API First                     | Make everything a service. Assume your code  will be cons\", \"umed by a front-end client, gateway,  or another service.                                           \", \"                                                         |\\n| 14  -  Telemetry                     | \", \"On a workstation, you have deep visibility into  your application and its behavior. In the cloud,  y\", \"ou don\\u2019t. Make sure your design includes the  collection of monitoring, domain-specific, and  health\", \"/system data. |\\n| 15  -  Authentication/ Authorization | Implement identity from the start. Consider\", \"  RBAC (role-based access control) features  available in public clouds.                            \", \"                                                                       |\\n\\nWe\\u2019ll refer to many of the\", \" 12+ factors in this chapter and throughout the book.\\n\\n## Azure Well -Architected Framework\\n\\nDesigni\", \"ng and deploying cloud-based workloads can be challenging, especially when implementing cloud -nativ\", \"e architecture. Microsoft provides industry standard best practices to help you and your team delive\", \"r robust cloud solutions.\\n\\nThe Microsoft Well -Architected Framework provides a set of guiding tenet\", \"s that can be used to improve the quality of a cloud-native workload. The framework consists of five\", \" pillars of architecture excellence:\\n\\n| Tenets                 | Description                        \", \"                                                                                                    \", \"                                                                                                    \", \"                                  |\\n|------------------------|--------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"--------------------------------|\\n| Cost management        | Focus on generating incremental value e\", \"arly.  Apply Build-Measure-Learn principles to  accelerate time to market while avoiding  capital-in\", \"tensive solutions. Using a pay-as-you\\u0002 go strategy, invest as you scale out, rather than  delivering\", \" a large investment up front. |\\n| Operational excellence | Automate the environment and operations t\", \"o  increase speed and reduce human error. Roll  problem updates back or forward quickly.  Implement \", \"monitoring and diagnostics from the  start.                                                         \", \"                            |\\n| Performance efficiency | Efficiently meet demands placed on your  wo\", \"rkloads. Favor horizontal scaling (scaling out)  and design it into your systems. Continually  condu\", \"ct performance and load testing to  identify potential bottlenecks.                                 \", \"                          |\\n\\n| Tenets      | Description                                            \", \"                                                                                                    \", \"                                                                                                    \", \"            |\\n|-------------|-----------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"-------------------------------------------------------------------------------------------------|\\n|\", \" Reliability | Build workloads that are both resilient and  available. Resiliency enables workloads \", \"to  recover from failures and continue functioning.  Availability ensures users access to your  work\", \"load at all times. Design applications to  expect failures and recover from them. |\\n| Security    | \", \"Implement security across the entire lifecycle of  an application, from design and implementation  t\", \"o deployment and operations. Pay close  attention to identity management, infrastructure  access, ap\", \"plication security, and data  sovereignty and encryption.          |\\n\\nTo get started, Microsoft prov\", \"ides a set of online assessments to help you assess your current cloud workloads against the five we\", \"ll-architected pillars.\\n\\n## Microservices\\n\\nCloud -native systems embrace microservices, a popular ar\", \"chitectural style for constructing modern applications.\\n\\nBuilt as a distributed set of small, indepe\", \"ndent services that interact through a shared fabric, microservices share the following characterist\", \"ics:\\n\\n- Each implements a specific business capability within a larger domain context.\\n- Each is dev\", \"eloped autonomously and can be deployed independently.\\n- Each is self -contained encapsulating its o\", \"wn data storage technology, dependencies, and programming platform.\\n- Each runs in its own process a\", \"nd communicates with others using standard communication protocols such as HTTP/HTTPS, gRPC, WebSock\", \"ets, or AMQP .\\n- They compose together to form an application.\\n\\nFigure 1-4 contrasts a monolithic ap\", \"plication approach with a microservices approach. Note how the monolith is composed of a layered arc\", \"hitecture, which executes in a single process. It typically consumes a relational database. The micr\", \"oservice approach, however, segregates functionality into independent services, each with its own lo\", \"gic, state, and data. Each microservice hosts its own datastore.\\n\\nWeb Tier\\n\\nServices Tier\\n\\nData Tier\", \"\\n\\nMonolithic Approach\\n\\nMobile apps\\n\\nMicroservice\\n\\nMicroservices Approach\\n\\nFigure 1 -4. Monolithic ve\", \"rsus microservices architecture\\n\\n<!-- image -->\\n\\nNote how microservices promote the Processes princi\", \"ple from the Twelve-Factor Application , discussed earlier in the chapter.\\n\\nFactor #6 specifies \\\"Eac\", \"h microservice should execute in its own process, isolated from other running services.\\\"\\n\\n## Why mic\", \"roservices?\\n\\nMicroservices provide agility.\\n\\nEarlier in the chapter, we compared an eCommerce applic\", \"ation built as a monolith to that with microservices. In the example, we saw some clear benefits:\\n\\n-\", \" Each microservice has an autonomous lifecycle and can evolve independently and deploy frequently. Y\", \"ou don't have to wait for a quarterly release to deploy a new feature or update. You can update a sm\", \"all area of a live application with less risk of disrupting the entire system. The update can be mad\", \"e without a full redeployment of the application.\\n- Each microservice can scale independently. Inste\", \"ad of scaling the entire application as a single unit, you scale out only those services that requir\", \"e more processing power to meet desired performance levels and service-level agreements. Fine-graine\", \"d scaling provides for greater control of your system and helps reduce overall costs as you scale po\", \"rtions of your system, not everything.\\n\\nAn excellent reference guide for understanding microservices\", \" is .NET Microservices: Architecture for Containerized .NET Applications. The book deep dives into m\", \"icroservices design and architecture. It's a companion for a full-stack microservice reference archi\", \"tecture available as a free download from Microsoft.\\n\\n## Developing microservices\\n\\nMicroservices can\", \" be created upon any modern development platform.\\n\\nWeb Apps\\n\\n<!-- image -->\\n\\nThe Microsoft .NET plat\", \"form is an excellent choice. Free and open source, it has many built-in features that simplify micro\", \"service development. .NET is cross-platform. Applications can be built and run on Windows, macOS, an\", \"d most flavors of Linux.\\n\\n.NET is highly performant and has scored well in comparison to Node.js and\", \" other competing platforms. Interestingly, TechEmpower conducted an extensive set of performance ben\", \"chmarks across many web application platforms and frameworks. .NET scored in the top 10 - well above\", \" Node.js and other competing platforms.\\n\\n.NET is maintained by Microsoft and the .NET community on G\", \"itHub.\\n\\n## Microservice challenges\\n\\nWhile distributed cloud -native microservices can provide immens\", \"e agility and speed, they present many challenges:\\n\\n## Communication\\n\\nHow will front -end client app\", \"lications communicate with backed-end core microservices? Will you allow direct communication? Or, m\", \"ight you abstract the back-end microservices with a gateway facade that provides flexibility, contro\", \"l, and security?\\n\\nHow will back -end core microservices communicate with each other? Will you allow \", \"direct HTTP calls that can increase coupling and impact performance and agility? Or might you consid\", \"er decoupled messaging with queue and topic technologies?\\n\\nCommunication is covered in the Cloud -na\", \"tive communication patterns chapter.\\n\\n## Resiliency\\n\\nA microservices architecture moves your system \", \"from in-process to out-of-process network communication. In a distributed architecture, what happens\", \" when Service B isn't responding to a network call from Service A? Or, what happens when Service C b\", \"ecomes temporarily unavailable and other services calling it become blocked?\\n\\nResiliency is covered \", \"in the Cloud-native resiliency chapter.\\n\\n## Distributed Data\\n\\nBy design, each microservice encapsula\", \"tes its own data, exposing operations via its public interface. If so, how do you query data or impl\", \"ement a transaction across multiple services?\\n\\nDistributed data is covered in the Cloud -native data\", \" patterns chapter.\\n\\n## Secrets\\n\\nHow will your microservices securely store and manage secrets and se\", \"nsitive configuration data?\\n\\nSecrets are covered in detail Cloud -native security .\\n\\n* Appand dapr\\n\\n\", \"runtime\\n\\n*Components\\n\\n* Hosting platform runtime\\n\\nAny code or framework...\\n\\nApplication code\\n\\nMicros\", \"ervices written in\\n\\n= GO\\n\\nnodeo\\n\\n\\u00bf python\\n\\n## Manage Complexity with Dapr\\n\\ngRPC API\\n\\nDapr is a distr\", \"ibuted, open-source application runtime. Through an architecture of pluggable components, it dramati\", \"cally simplifies the plumbing behind distributed applications. It provides a dynamic glue that binds\", \" your application with pre-built infrastructure capabilities and components from the Dapr runtime. F\", \"igure 1-5 shows Dapr from 20,000 feet.\\n\\nFigure 1 -5. Dapr at 20,000 feet.\\n\\n<!-- image -->\\n\\nIn the to\", \"p row of the figure, note how Dapr provides language-specific SDKs for popular development platforms\", \". Dapr v1 includes support for .NET, Go, Node.js, Python, PHP, Java, and JavaScript.\\n\\nWhile language\", \"-specific SDKs enhance the developer experience, Dapr is platform agnostic. Under the hood, Dapr's p\", \"rogramming model exposes capabilities through standard HTTP/gRPC communication protocols. Any progra\", \"mming platform can call Dapr via its native HTTP and gRPC APIs.\\n\\nThe blue boxes across the center of\", \" the figure represent the Dapr building blocks. Each exposes prebuilt plumbing code for a distribute\", \"d application capability that your application can consume.\\n\\nThe components row represents a large s\", \"et of pre-defined infrastructure components that your application can consume. Think of components a\", \"s infrastructure code you don't have to write.\\n\\nThe bottom row highlights the portability of Dapr an\", \"d the diverse environments across which it can run.\\n\\nMicrosoft features a free ebook Dapr for .NET D\", \"evelopers for learning Dapr.\\n\\nLooking ahead, Dapr has the potential to have a profound impact on clo\", \"ud-native application development.\\n\\n## Containers\\n\\nIt's natural to hear the term container mentioned\", \" in any cloud native conversation. In the book, Cloud Native Patterns, author Cornelia Davis observe\", \"s that, \\\"Containers are a great enabler of cloud-native\\n\\n.NET\\n\\n\\u203a \\u203a Java\\n\\nContainer\\n\\nProduct:1.0\\n\\nLib\", \"-L\\n\\nContainer\\n\\nBasket:2.0\\n\\nContainer\\n\\nProduct:2.0\\n\\nsoftware.\\\" The Cloud Native Computing Foundation \", \"places microservice containerization as the first step in their Cloud-Native Trail Map - guidance fo\", \"r enterprises beginning their cloud-native journey.\\n\\nContainerizing a microservice is simple and str\", \"aightforward. The code, its dependencies, and runtime are packaged into a binary called a container \", \"image. Images are stored in a container registry, which acts as a repository or library for images. \", \"A registry can be located on your development computer, in your data center, or in a public cloud. D\", \"ocker itself maintains a public registry via Docker Hub. The Azure cloud features a private containe\", \"r registry to store container images close to the cloud applications that will run them. Docker\\n\\nRun\", \"time\\n\\nWhen an application starts or scales, you transform the container image into a running contain\", \"er instance. The instance runs on any computer that has a container runtime engine installed. You ca\", \"n have as many instances of the containerized service as needed.\\n\\nFigure 1-6 shows three different m\", \"icroservices, each in its own container, all running on a single host.\\n\\nFigure 1 -6. Multiple contai\", \"ners running on a container host\\n\\n<!-- image -->\\n\\nNote how each container maintains its own set of d\", \"ependencies and runtime, which can be different from one another. Here, we see different versions of\", \" the Product microservice running on the same host. Each container shares a slice of the underlying \", \"host operating system, memory, and processor, but is isolated from one another.\\n\\nNote how well the c\", \"ontainer model embraces the Dependencies principle from the Twelve-Factor Application .\\n\\nFactor #2 s\", \"pecifies that \\\"Each microservice isolates and packages its own dependencies, embracing changes witho\", \"ut impacting the entire system.\\\"\\n\\nContainers support both Linux and Windows workloads. The Azure clo\", \"ud openly embraces both. Interestingly, it's Linux, not Windows Server, that has become the more pop\", \"ular operating system in Azure.\\n\\nScheduling\\n\\nFailover\\n\\nAffinity/anti-affinity\\n\\nHealth monitoring\\n\\nSc\", \"aling\\n\\nWhile several container vendors exist, Docker has captured the lion's share of the market. Th\", \"e company has been driving the software container movement. It has become the de facto standard for \", \"packaging, deploying, and running cloud-native applications.\\n\\nNetworking\\n\\n## Why containers?\\n\\nContai\", \"ners provide portability and guarantee consistency across environments. By encapsulating everything \", \"into a single package, you isolate the microservice and its dependencies from the underlying infrast\", \"ructure.\\n\\nYou can deploy the container in any environment that hosts the Docker runtime engine. Cont\", \"ainerized workloads also eliminate the expense of pre-configuring each environment with frameworks, \", \"software libraries, and runtime engines.\\n\\nBy sharing the underlying operating system and host resour\", \"ces, a container has a much smaller footprint than a full virtual machine. The smaller size increase\", \"s the density, or number of microservices, that a given host can run at one time.\\n\\n## Container orch\", \"estration\\n\\nWhile tools such as Docker create images and run containers, you also need tools to manag\", \"e them. Container management is done with a special software program called a container orchestrator\", \" . When operating at scale with many independent running containers, orchestration is essential.\\n\\nFi\", \"gure 1-7 shows management tasks that container orchestrators automate.\\n\\nFigure 1 -7. What container \", \"orchestrators do\\n\\n<!-- image -->\\n\\nThe following table describes common orchestration tasks.\\n\\n| Tasks\", \"                  | Explanation                                                                     \", \"                  |\\n|------------------------|------------------------------------------------------\", \"---------------------------------------------|\\n| Scheduling             | Automatically provision co\", \"ntainer instances.                                                      |\\n| Affinity/anti-affinity |\", \" Provision containers nearby or far apart from  each other, helping availability and  performance. |\", \"\\n| Health monitoring      | Automatically detect and correct failures.                              \", \"                          |\\n| Failover               | Automatically reprovision a failed instance t\", \"o a  healthy machine.                                |\\n\\nService discovery\\n\\nRolling upgrades\\n\\n| Tasks\", \"             | Explanation                                                                          \", \"                         |\\n|-------------------|----------------------------------------------------\", \"-----------------------------------------------------------|\\n| Scaling           | Automatically add\", \" or remove a container  instance to meet demand.                                             |\\n| Net\", \"working        | Manage a networking overlay for container  communication.                          \", \"                           |\\n| Service Discovery | Enable containers to locate each other.          \", \"                                                             |\\n| Rolling Upgrades  | Coordinate incr\", \"emental upgrades with zero  downtime deployment. Automatically roll back  problematic changes. |\\n\\nNo\", \"te how container orchestrators embrace the Disposability and Concurrency principles from the Twelve \", \"-Factor Application .\\n\\nFactor #9 specifies that \\\"Service instances should be disposable, favoring fa\", \"st startups to increase scalability opportunities and graceful shutdowns to leave the system in a co\", \"rrect state.\\\" Docker containers along with an orchestrator inherently satisfy this requirement.\\\"\\n\\nFa\", \"ctor #8 specifies that \\\"Services scale out across a large number of small identical processes (copie\", \"s) as opposed to scaling-up a single large instance on the most powerful machine available.\\\"\\n\\nWhile \", \"several container orchestrators exist, Kubernetes has become the de facto standard for the cloud -na\", \"tive world. It's a portable, extensible, open-source platform for managing containerized workloads.\\n\", \"\\nYou could host your own instance of Kubernetes, but then you'd be responsible for provisioning and \", \"managing its resources - which can be complex. The Azure cloud features Kubernetes as a managed serv\", \"ice. Both Azure Kubernetes Service (AKS) and Azure Red Hat OpenShift (ARO) enable you to fully lever\", \"age the features and power of Kubernetes as a managed service, without having to install and maintai\", \"n it.\\n\\nContainer orchestration is covered in detail in Scaling Cloud-Native Applications .\\n\\n## Backi\", \"ng services\\n\\nCloud -native systems depend upon many different ancillary resources, such as data stor\", \"es, message brokers, monitoring, and identity services. These services are known as backing services\", \" .\\n\\nFigure 1-8 shows many common backing services that cloud-native systems consume.\\n\\nStorage\\n\\nServi\", \"ces\\n\\nStreaming\\n\\nServices\\n\\nMonitoring\\n\\n&lt; - -\\n\\nSecurity\\n\\nServices\\n\\nFigure 1 -8. Common backing serv\", \"ices\\n\\n<!-- image -->\\n\\nYou could host your own backing services, but then you'd be responsible for li\", \"censing, provisioning, and managing those resources.\\n\\nCloud providers offer a rich assortment of man\", \"aged backing services. Instead of owning the service, you simply consume it. The cloud provider oper\", \"ates the resource at scale and bears the responsibility for performance, security, and maintenance. \", \"Monitoring, redundancy, and availability are built into the service. Providers guarantee service lev\", \"el performance and fully support their managed services open a ticket and they fix your issue.\\n\\nClou\", \"d -native systems favor managed backing services from cloud vendors. The savings in time and labor c\", \"an be significant. The operational risk of hosting your own and experiencing trouble can get expensi\", \"ve fast.\\n\\nA best practice is to treat a backing service as an attached resource, dynamically bound t\", \"o a microservice with configuration information (a URL and credentials) stored in an external config\", \"uration. This guidance is spelled out in the Twelve-Factor Application, discussed earlier in the cha\", \"pter.\\n\\nFactor #4 specifies that backing services \\\"should be exposed via an addressable URL. Doing so\", \" decouples the resource from the application, enabling it to be interchangeable.\\\"\\n\\nFactor #3 specifi\", \"es that \\\"Configuration information is moved out of the microservice and externalized through a confi\", \"guration management tool outside of the code.\\\"\\n\\nWith this pattern, a backing service can be attached\", \" and detached without code changes. You might promote a microservice from QA to a staging environmen\", \"t. You update the microservice configuration to point to the backing services in staging and inject \", \"the settings into your container through an environment variable.\\n\\nBacking\\n\\nServices\\n\\nCloud vendors \", \"provide APIs for you to communicate with their proprietary backing services. These libraries encapsu\", \"late the proprietary plumbing and complexity. However, communicating directly with these APIs will t\", \"ightly couple your code to that specific backing service. It's a widely accepted practice to insulat\", \"e the implementation details of the vendor API. Introduce an intermediation layer, or intermediate A\", \"PI, exposing generic operations to your service code and wrap the vendor code inside it. This loose \", \"coupling enables you to swap out one backing service for another or move your code to a different cl\", \"oud environment without having to make changes to the mainline service code. Dapr, discussed earlier\", \", follows this model with its set of prebuilt building blocks .\\n\\nOn a final thought, backing service\", \"s also promote the Statelessness principle from the Twelve-Factor Application, discussed earlier in \", \"the chapter.\\n\\nFactor #6 specifies that, \\\"Each microservice should execute in its own process, isolat\", \"ed from other running services. Externalize required state to a backing service such as a distribute\", \"d cache or data store.\\\"\\n\\nBacking services are discussed in Cloud-native data patterns and Cloud-nati\", \"ve communication patterns .\\n\\n## Automation\\n\\nAs you've seen, cloud-native systems embrace microservic\", \"es, containers, and modern system design to achieve speed and agility. But, that's only part of the \", \"story. How do you provision the cloud environments upon which these systems run? How do you rapidly \", \"deploy app features and updates? How do you round out the full picture?\\n\\nEnter the widely accepted p\", \"ractice of Infrastructure as Code, or IaC.\\n\\nWith IaC, you automate platform provisioning and applica\", \"tion deployment. You essentially apply software engineering practices such as testing and versioning\", \" to your DevOps practices. Your infrastructure and deployments are automated, consistent, and repeat\", \"able.\\n\\n## Automating infrastructure\\n\\nTools like Azure Resource Manager , Azure Bicep , Terraform fro\", \"m HashiCorp, and the Azure CLI, enable you to declaratively script the cloud infrastructure you requ\", \"ire. Resource names, locations, capacities, and secrets are parameterized and dynamic. The script is\", \" versioned and checked into source control as an artifact of your project. You invoke the script to \", \"provision a consistent and repeatable infrastructure across system environments, such as QA, staging\", \", and production.\\n\\nUnder the hood, IaC is idempotent, meaning that you can run the same script over \", \"and over without side effects. If the team needs to make a change, they edit and rerun the script. O\", \"nly the updated resources are affected.\\n\\nIn the article, What is Infrastructure as Code, Author Sam \", \"Guckenheimer describes how, \\\"Teams who implement IaC can deliver stable environments rapidly and at \", \"scale. They avoid manual configuration of environments and enforce consistency by representing the d\", \"esired state of their environments via code. Infrastructure deployments with IaC are repeatable and \", \"prevent runtime issues caused by configuration drift or missing dependencies. DevOps teams can work \", \"together with a unified set of\\n\\n2\\n\\nApplication code repo\\n\\n(SCC)\\n\\n3\\n\\nBuild, CI, integrate, test\\n\\nCD, \", \"deploy practices and tools to deliver applications and their supporting infrastructure rapidly, reli\", \"ably, and at scale.\\\"\\n\\n## Automating deployments\\n\\nPush\\n\\n1\\n\\nThe Twelve -Factor Application, discussed \", \"earlier, calls for separate steps when transforming completed code into a running application.\\n\\nInne\", \"r loop run,\\n\\nFactor #5 specifies that \\\"Each release must enforce a strict separation across the buil\", \"d, release and run stages. Each should be tagged with a unique ID and support the ability to roll ba\", \"ck.\\\"\\n\\ndebug\\n\\nModern CI/CD systems help fulfill this principle. They provide separate build and deliv\", \"ery steps that help ensure consistent and quality code that's readily available to users.\\n\\nFigure 1-\", \"9 shows the separation across the deployment process.\\n\\nFigure 1 -9. Deployment steps in a CI/CD Pipe\", \"line\\n\\n<!-- image -->\\n\\nIn the previous figure, pay special attention to separation of tasks:\\n\\n1. The \", \"developer constructs a feature in their development environment, iterating through what is called th\", \"e \\\"inner loop\\\" of code, run, and debug.\\n2. When complete, that code is pushed into a code repository\", \", such as GitHub, Azure DevOps, or BitBucket.\\n3. The push triggers a build stage that transforms the\", \" code into a binary artifact. The work is implemented with a Continuous Integration (CI) pipeline. I\", \"t automatically builds, tests, and packages the application.\\n4. The release stage picks up the binar\", \"y artifact, applies external application and environment configuration information, and produces an \", \"immutable release. The release is deployed to a specified environment. The work is implemented with \", \"a Continuous Delivery (CD) pipeline. Each release should be identifiable. You can say, \\\"This deploym\", \"ent is running Release 2.1.1 of the application.\\\"\\n\\n5\\n\\nRun\\n\\n5. Finally, the released feature is run i\", \"n the target execution environment. Releases are immutable meaning that any change must create a new\", \" release.\\n\\nApplying these practices, organizations have radically evolved how they ship software. Ma\", \"ny have moved from quarterly releases to on-demand updates. The goal is to catch problems early in t\", \"he development cycle when they're less expensive to fix. The longer the duration between integration\", \"s, the more expensive problems become to resolve. With consistency in the integration process, teams\", \" can commit code changes more frequently, leading to better collaboration and software quality.\\n\\nInf\", \"rastructure as code and deployment automation, along with GitHub and Azure DevOps are discussed in d\", \"etail in DevOps .\\n\\n## Candidate apps for cloud native\\n\\nThink about the apps your organization needs \", \"to build. Then, look at the existing apps in your portfolio. How many of them warrant a cloud-native\", \" architecture? All of them? Perhaps some?\\n\\nApplying cost/benefit analysis, there's a good chance som\", \"e wouldn't support the effort. The cost of becoming cloud native would far exceed the business value\", \" of the application.\\n\\nWhat type of application might be a candidate for cloud native?\\n\\n- Strategic e\", \"nterprise systems that need to constantly evolve business capabilities/features\\n- An application tha\", \"t requires a high release velocity - with high confidence\\n- A system where individual features must \", \"release without a full redeployment of the entire system\\n- An application developed by teams with ex\", \"pertise in different technology stacks\\n- An application with components that must scale independentl\", \"y\\n\\nSmaller, less impactful line-of-business applications might fare well with a simple monolithic ar\", \"chitecture hosted in a Cloud PaaS environment.\\n\\nThen there are legacy systems. While we'd all like t\", \"o build new applications, we're often responsible for modernizing legacy workloads that are critical\", \" to the business.\\n\\n## Modernizing legacy apps\\n\\nThe free Microsoft e -book Modernize existing .NET ap\", \"plications with Azure cloud and Windows Containers provides guidance about migrating on-premises wor\", \"kloads into cloud. Figure 1-10 shows that there isn't a single, one-size-fits-all strategy for moder\", \"nizing legacy applications.\\n\\nExisting\\n\\nNET Framework\\n\\nThe Journey to the Cloud\\n\\nMigrate apps &amp; s\", \"ervices Rehost , Infrastructure-\\n\\non-premises\\n\\nOn-Premises\\n\\nInfrastructure Plotform\\n\\nFigure 1 -10. S\", \"trategies for migrating legacy workloads\\n\\n<!-- image -->\\n\\nMonolithic apps that are non-critical migh\", \"t benefit from a quick lift-and-shift (Cloud InfrastructureReady) migration. Here, the on-premises w\", \"orkload is rehosted to a cloud-based VM, without changes. This approach uses the IaaS (Infrastructur\", \"e as a Service) model. Azure includes several tools such as Azure Migrate , Azure Site Recovery, and\", \" Azure Database Migration Service to help streamline the move. While this strategy can yield some co\", \"st savings, such applications typically weren't designed to unlock and leverage the benefits of clou\", \"d computing.\\n\\nLegacy apps that are critical to the business often benefit from an enhanced Cloud Opt\", \"imized migration. This approach includes deployment optimizations that enable key cloud services - w\", \"ithout changing the core architecture of the application. For example, you might containerize the ap\", \"plication and deploy it to a container orchestrator, like Azure Kubernetes Services, discussed later\", \" in this book. Once in the cloud, the application can consume cloud backing services such as databas\", \"es, message queues, monitoring, and distributed caching.\\n\\nFinally, monolithic apps that provide stra\", \"tegic enterprise functions might best benefit from a CloudNative approach, the subject of this book.\", \" This approach provides agility and velocity. But, it comes at a cost of replatforming, rearchitecti\", \"ng, and rewriting code. Over time, a legacy application could be decomposed into microservices, cont\", \"ainerized, and ultimately replatformed into a cloud-native architecture.\\n\\nIf you and your team belie\", \"ve a cloud-native approach is appropriate, it behooves you to rationalize the decision with your org\", \"anization. What exactly is the business problem that a cloud-native approach will solve? How would i\", \"t align with business needs?\\n\\n- Rapid releases of features with increased confidence?\\n- Fine -graine\", \"d scalability - more efficient usage of resources?\\n\\nModernize\\n\\n- Improved system resiliency?\\n- Impro\", \"ved system performance?\\n- More visibility into operations?\\n- Blend development platforms and data st\", \"ores to arrive at the best tool for the job?\\n- Future -proof application investment?\\n\\nThe right migr\", \"ation strategy depends on organizational priorities and the systems you're targeting. For many, it m\", \"ay be more cost effective to cloud-optimize a monolithic application or add coarsegrained services t\", \"o an N-Tier app. In these cases, you can still make full use of cloud PaaS capabilities like the one\", \"s offered by Azure App Service.\\n\\n## Summary\\n\\nIn this chapter, we introduced cloud-native computing. \", \"We provided a definition along with the key capabilities that drive a cloud-native application. We l\", \"ooked at the types of applications that might justify this investment and effort.\\n\\nWith the introduc\", \"tion behind, we now dive into a much more detailed look at cloud native.\\n\\n## References\\n\\n- Cloud Nat\", \"ive Computing Foundation\\n- .NET Microservices: Architecture for Containerized .NET applications\\n- Mi\", \"crosoft Azure Well -Architected Framework\\n- Modernize existing .NET applications with Azure cloud an\", \"d Windows Containers\\n- Cloud Native Patterns by Cornelia Davis\\n- Cloud native applications: Ship fas\", \"ter, reduce risk, and grow your business\\n- Dapr for .NET Developers\\n- Dapr documents\\n- Beyond the Tw\", \"elve-Factor Application\\n- What is Infrastructure as Code\\n- Uber Engineering's Micro Deploy: Deployin\", \"g Daily with Confidence\\n- How Netflix Deploys Code\\n- Overload Control for Scaling WeChat Microservic\", \"es\\n\\n+\\n\\nNot secure host.docker.internal:5104/catalog\\n\\n[eShop]\\n\\non containers\\n\\nBrand\\n\\nAll eShopOnConta\", \"iners - SPA\\n\\n.NET\\n\\n## Introducing eShopOnContainers reference app TS Showing 12 of 14 products - Pag\", \"e 1 - 2 Next\\n\\nONET\\n\\nMicrosoft, in partnership with leading community experts, has produced a full-fe\", \"atured cloud-native microservices reference application, eShopOnContainers. This application is buil\", \"t to showcase using .NET and Docker, and optionally Azure, Kubernetes, and Visual Studio, to build a\", \"n online storefront.\\n\\nFigure 2 -1. eShopOnContainers Sample App Screenshot.\\n\\n<!-- image -->\\n\\nLOGIN\\n\\n\", \"Before starting this chapter, we recommend that you download the eShopOnContainers reference applica\", \"tion. If you do so, it should be easier for you to follow along with the information presented.\\n\\n## \", \"Features and requirements\\n\\nLet's start with a review of the application's features and requirements.\", \" The eShopOnContainers application represents an online store that sells various physical products l\", \"ike t-shirts and coffee mugs. If you've bought anything online before, the experience of using the s\", \"tore should be relatively familiar. Here are some of the basic features the store implements:\\n\\n- Lis\", \"t catalog items\\n- Filter items by type\\n- Filter items by brand\\n- Add items to the shopping basket\\n- \", \"Edit or remove items from the basket\\n- Checkout\\n- Register an account\\n- Sign in\\n- Sign out\\n- Review \", \"orders\\n\\nThe application also has the following non-functional requirements:\\n\\n- It needs to be highly\", \" available and it must scale automatically to meet increased traffic (and scale back down once traff\", \"ic subsides).\\n- It should provide easy-to-use monitoring of its health and diagnostic logs to help t\", \"roubleshoot any issues it encounters.\\n- It should support an agile development process, including su\", \"pport for continuous integration and deployment (CI/CD).\\n- In addition to the two web front ends (tr\", \"aditional and Single Page Application), the application must also support mobile client apps running\", \" different kinds of operating systems.\\n- It should support cross-platform hosting and cross-platform\", \" development.\\n\\nClient apps eShop mobile app\\n\\nXamarin.Forms\\n\\nC#\\n\\nxPlat. OS:\\n\\niOS\\n\\nAndroid\\n\\nWindows eS\", \"hop traditional Web app\\n\\nK\\n\\neShop SPA Web app\\n\\nTypeScript/Angular 2\\n\\nIdentity microservice (STS+user\", \"s)\\n\\nSQL Server database\\n\\nAPI Gateways/BFF Catalog microservice SQL Server\\n\\nFigure 2 -2. eShopOnConta\", \"iners reference application development architecture.\\n\\n<!-- image -->\\n\\nThe eShopOnContainers applica\", \"tion is accessible from web or mobile clients that access the application over HTTPS targeting eithe\", \"r the ASP.NET Core MVC server application or an appropriate API Gateway. API Gateways offer several \", \"advantages, such as decoupling back-end services from individual front -end clients and providing be\", \"tter security. The application also makes use of a related pattern known as Backends-for-Frontends (\", \"BFF), which recommends creating separate API gateways for each front -end client. The reference arch\", \"itecture demonstrates breaking up the API gateways based on whether the request is coming from a web\", \" or mobile client.\\n\\nThe application's functionality is broken up into many distinct microservices. T\", \"here are services responsible for authentication and identity, listing items from the product catalo\", \"g, managing users' shopping baskets, and placing orders. Each of these separate services has its own\", \" persistent storage. There's no single primary data store with which all services interact. Instead,\", \" coordination and communication between the services is done on an as -needed basis and by using a m\", \"essage bus.\\n\\nEach of the different microservices is designed differently, based on their individual \", \"requirements. This aspect means their technology stack may differ, although they're all built using \", \".NET and designed for the cloud. Simpler services provide basic Create-Read-Update-Delete (CRUD) acc\", \"ess to the underlying data stores, while more advanced services use Domain-Driven Design approaches \", \"and patterns to manage business complexity.\\n\\neShopOnContainers reference application\\n\\n(Development e\", \"nvironment architecture)\\n\\n-\\n\\n\\u2022 Docker Host\\n\\nDifferent types of microservices\\n\\nIdentity Microservice \", \"(STS+ Users)\\n\\nSQL Server\\n\\nWeb API\\n\\nContainer database\\n\\n/ Catalog Microservice\\n\\nWeb API\\n\\nContainer\\n\\nO\", \"rdering Microservice\\n\\nWeb API\\n\\nContainer\\n\\n/ Basket Microservice\\n\\nWeb APl\\n\\nContaine:\\n\\nFigure 2 -3. Di\", \"fferent kinds of microservices.\\n\\n<!-- image -->\\n\\n## Overview of the code\\n\\nBecause it uses microservi\", \"ces, the eShopOnContainers app includes quite a few separate projects and solutions in its GitHub re\", \"pository. In addition to separate solutions and executable files, the various services are designed \", \"to run inside their own containers, both during local development and at run time in production. Fig\", \"ure 2-4 shows the full Visual Studio solution, in which the various different projects are organized\", \".\\n\\nASP.NET Core Identity\\n\\nExample using\\n\\n&amp; Identity STS\\n\\nExample of a simple\\n\\nSolution Explorer\\n\", \"\\nSearch Solution Explorer (CtrI+:)\\n\\n\\u0432 Solution 'eShopOnContainers-ServicesAndWebApps' (31 of 31 proj\", \"ects)\\n\\n\\u2022 Solution Items\\n\\nD sc\\n\\nApiGateways\\n\\nBuildingBlocks\\n\\nServices\\n\\nWeb Apps\\n\\nP\\n\\n\\u2022 tests\\n\\n\\u2192 Servic\", \"e Tests docker-compose\\n\\nP-\\n\\n<!-- image -->\\n\\nFigure 2 -4. Projects in Visual Studio solution.\\n\\nThe co\", \"de is organized to support the different microservices, and within each microservice, the code is br\", \"oken up into domain logic, infrastructure concerns, and user interface or service endpoint. In many \", \"cases, each service's dependencies can be fulfilled by Azure services in production, and alternative\", \" options for local development. Let's examine how the application's requirements map to Azure servic\", \"es.\\n\\n## Understanding microservices\\n\\nThis book focuses on cloud -native applications built using Azu\", \"re technology. To learn more about microservices best practices and how to architect microservice-ba\", \"sed applications, read the companion book, .NET Microservices: Architecture for Containerized .NET A\", \"pplications .\\n\\n## Mapping eShopOnContainers to Azure Services\\n\\nAlthough not required, Azure is well-\", \"suited to supporting the eShopOnContainers because the project was built to be a cloud -native appli\", \"cation. The application is built with .NET, so it can run on Linux or Windows containers depending o\", \"n the Docker host. The application is made up of multiple autonomous microservices, each with its ow\", \"n data. The different microservices showcase different approaches, ranging from simple CRUD operatio\", \"ns to more complex DDD and CQRS patterns. Microservices communicate with clients over HTTP and with \", \"one another via message-based communication. The application supports multiple platforms for clients\", \" as well, since it adopts HTTP as a standard communication protocol and includes ASP.NET Core and Xa\", \"marin mobile apps that run on Android, iOS, and Windows platforms.\\n\\nThe application's architecture i\", \"s shown in Figure 2-5. On the left are the client apps, broken up into mobile, traditional Web, and \", \"Web Single Page Application (SPA) flavors. On the right are the serverside components that make up t\", \"he system, each of which can be hosted in Docker containers and Kubernetes clusters. The traditional\", \" web app is powered by the ASP.NET Core MVC application shown in yellow. This app and the mobile and\", \" web SPA applications communicate with the individual microservices through one or more API gateways\", \". The API gateways follow the \\\"backends for front ends\\\" (BFF) pattern, meaning that each gateway is \", \"designed to support a given front-end client. The individual microservices are listed to the right o\", \"f the API gateways and include both business logic and some kind of persistence store. The different\", \" services make use of SQL Server databases, Redis cache instances, and MongoDB/CosmosDB stores. On t\", \"he far right is the system's Event Bus, which is used for communication between the microservices.\\n\\n\", \"- - \\u2014\\n\\nClient apps eShop mobile app\\n\\nXamarin.Forms\\n\\nC#\\n\\nxPlat. OS:\\n\\niOs\\n\\nAndroid\\n\\nWindows eShop trad\", \"itional Web app\\n\\neShop SPA Web app\\n\\nTypeScript/Angular eShopOnContainers reference application\\n\\n(Dev\", \"elopment environment architecture)\\n\\n| Docker Host\\n\\nIdentity microservice (STS+users)\\n\\nSQL Server\\n\\n##\", \" database\\n\\nAPI Gateways / BFF Catalog microservice SQL Server\\n\\n\\u20220\\n\\ndatabase\\n\\nFigure 2 -5. The eShopO\", \"nContainers Architecture.\\n\\n<!-- image -->\\n\\nThe server -side components of this architecture all map \", \"easily to Azure services.\\n\\n## Container orchestration and clustering\\n\\nThe application's container-ho\", \"sted services, from ASP.NET Core MVC apps to individual Catalog and Ordering microservices, can be h\", \"osted and managed in Azure Kubernetes Service (AKS). The application can run locally on Docker and K\", \"ubernetes, and the same containers can then be deployed to staging and production environments hoste\", \"d in AKS. This process can be automated as we'll see in the next section.\\n\\nAKS provides management s\", \"ervices for individual clusters of containers. The application will deploy separate containers for e\", \"ach microservice in the AKS cluster, as shown in the architecture diagram above. This approach allow\", \"s each individual service to scale independently according to its resource demands. Each microservic\", \"e can also be deployed independently, and ideally such deployments should incur zero system downtime\", \".\\n\\n## API Gateway\\n\\nThe eShopOnContainers application has multiple front-end clients and multiple dif\", \"ferent back-end services. There's no one -to -one correspondence between the client applications and\", \" the microservices that support them. In such a scenario, there may be a great deal of complexity wh\", \"en writing client software to interface with the various back -end services in a secure manner. Each\", \" client would need to address this complexity on its own, resulting in duplication and many places i\", \"n which to make updates as services change or new policies are implemented.\\n\\nAzure API Management (A\", \"PIM) helps organizations publish APIs in a consistent, manageable fashion. APIM consists of three co\", \"mponents: the API Gateway, and administration portal (the Azure portal), and a developer portal.\\n\\nRa\", \"bbitMO\\n\\nThe API Gateway accepts API calls and routes them to the appropriate back-end API. It can al\", \"so provide additional services like verification of API keys or JWT tokens and API transformation on\", \" the fly without code modifications (for instance, to accommodate clients expecting an older interfa\", \"ce).\\n\\nThe Azure portal is where you define the API schema and package different APIs into products. \", \"You also configure user access, view reports, and configure policies for quotas or transformations.\\n\", \"\\nThe developer portal serves as the main resource for developers. It provides developers with API do\", \"cumentation, an interactive test console, and reports on their own usage. Developers also use the po\", \"rtal to create and manage their own accounts, including subscription and API key support.\\n\\nUsing API\", \"M, applications can expose several different groups of services, each providing a back end for a par\", \"ticular front-end client. APIM is recommended for complex scenarios. For simpler needs, the lightwei\", \"ght API Gateway Ocelot can be used. The eShopOnContainers app uses Ocelot because of its simplicity \", \"and because it can be deployed into the same application environment as the application itself. Lear\", \"n more about eShopOnContainers, APIM, and Ocelot.\\n\\nAnother option if your application is using AKS i\", \"s to deploy the Azure Gateway Ingress Controller as a pod within your AKS cluster. This approach all\", \"ows your cluster to integrate with an Azure Application Gateway, allowing the gateway to load-balanc\", \"e traffic to the AKS pods. Learn more about the Azure Gateway Ingress Controller for AKS .\\n\\n## Data\\n\", \"\\nThe various back -end services used by eShopOnContainers have different storage requirements. Sever\", \"al microservices use SQL Server databases. The Basket microservice leverages a Redis cache for its p\", \"ersistence. The Locations microservice expects a MongoDB API for its data. Azure supports each of th\", \"ese data formats.\\n\\nFor SQL Server database support, Azure has products for everything from single da\", \"tabases up to highly scalable SQL Database elastic pools. Individual microservices can be configured\", \" to communicate with their own individual SQL Server databases quickly and easily. These databases c\", \"an be scaled as needed to support each separate microservice according to its needs.\\n\\nThe eShopOnCon\", \"tainers application stores the user's current shopping basket between requests. This aspect is manag\", \"ed by the Basket microservice that stores the data in a Redis cache. In development, this cache can \", \"be deployed in a container, while in production it can utilize Azure Cache for Redis. Azure Cache fo\", \"r Redis is a fully managed service offering high performance and reliability without the need to dep\", \"loy and manage Redis instances or containers on your own.\\n\\nThe Locations microservice uses a MongoDB\", \" NoSQL database for its persistence. During development, the database can be deployed in its own con\", \"tainer, while in production the service can leverage Azure Cosmos DB's API for MongoDB. One of the b\", \"enefits of Azure Cosmos DB is its ability to leverage multiple different communication protocols, in\", \"cluding a SQL API and common NoSQL APIs including MongoDB, Cassandra, Gremlin, and Azure Table Stora\", \"ge. Azure Cosmos DB offers a fully managed and globally distributed database as a service that can s\", \"cale to meet the needs of the services that use it.\\n\\nDistributed data in cloud -native applications \", \"is covered in more detail in chapter 5 .\\n\\n## Event Bus\\n\\nThe application uses events to communicate c\", \"hanges between different services. This functionality can be implemented with various implementation\", \"s, and locally the eShopOnContainers application uses RabbitMQ. When hosted in Azure, the applicatio\", \"n would leverage Azure Service Bus for its messaging. Azure Service Bus is a fully managed integrati\", \"on message broker that allows applications and services to communicate with one another in a decoupl\", \"ed, reliable, asynchronous manner. Azure Service Bus supports individual queues as well as separate \", \"topics to support publisher-subscriber scenarios. The eShopOnContainers application would leverage t\", \"opics with Azure Service Bus to support distributing messages from one microservice to any other mic\", \"roservice that needed to react to a given message.\\n\\n## Resiliency\\n\\nOnce deployed to production, the \", \"eShopOnContainers application would be able to take advantage of several Azure services available to\", \" improve its resiliency. The application publishes health checks, which can be integrated with Appli\", \"cation Insights to provide reporting and alerts based on the app's availability. Azure resources als\", \"o provide diagnostic logs that can be used to identify and correct bugs and performance issues. Reso\", \"urce logs provide detailed information on when and how different Azure resources are used by the app\", \"lication. You'll learn more about cloud-native resiliency features in chapter 6 .\\n\\n## Deploying eSho\", \"pOnContainers to Azure\\n\\nThe eShopOnContainers application can be deployed to various Azure platforms\", \". The recommended approach is to deploy the application to Azure Kubernetes Services (AKS). Helm, a \", \"Kubernetes deployment tool, is available to reduce deployment complexity. Optionally, developers may\", \" implement Azure Dev Spaces for Kubernetes to streamline their development process.\\n\\n## Azure Kubern\", \"etes Service\\n\\nTo host eShop in AKS, the first step is to create an AKS cluster. To do so, you might \", \"use the Azure portal, which will walk you through the required steps. You could also create a cluste\", \"r from the Azure CLI, taking care to enable Role-Based Access Control (RBAC) and application routing\", \". The eShopOnContainers' documentation details the steps for creating your own AKS cluster. Once cre\", \"ated, you can access and manage the cluster from the Kubernetes dashboard.\\n\\nYou can now deploy the e\", \"Shop application to the cluster using Helm.\\n\\n## Deploying to Azure Kubernetes Service using Helm\\n\\nHe\", \"lm is an application package manager tool that works directly with Kubernetes. It helps you define, \", \"install, and upgrade Kubernetes applications. While simple apps can be deployed to AKS with custom C\", \"LI scripts or simple deployment files, complex apps can contain many Kubernetes objects and benefit \", \"from Helm.\\n\\nUsing Helm, applications include text-based configuration files, called Helm charts, whi\", \"ch declaratively describe the application and configuration in Helm packages. Charts use standard YA\", \"ML-formatted\\n\\nfiles to describe a related set of Kubernetes resources. They're versioned alongside t\", \"he application code they describe. Helm Charts range from simple to complex depending on the require\", \"ments of the installation they describe.\\n\\nHelm is composed of a command-line client tool, which cons\", \"umes helm charts and launches commands to a server component named, Tiller. Tiller communicates with\", \" the Kubernetes API to ensure the correct provisioning of your containerized workloads. Helm is main\", \"tained by the Cloudnative Computing Foundation.\\n\\nThe following yaml file presents a Helm template:\\n\\n\", \"```\\napiVersion: v1 kind: Service metadata: name: {{ .Values.app.svc.marketing }} labels: app: {{ tem\", \"plate \\\"marketing-api.name\\\" . }} chart: {{ template \\\"marketing-api.chart\\\" . }} release: {{ .Release.N\", \"ame }} heritage: {{ .Release.Service }} spec: type: {{ .Values.service.type }} ports: -port: {{ .Val\", \"ues.service.port }} targetPort: http protocol: TCP name: http selector: app: {{ template \\\"marketing-\", \"api.name\\\" . }} release: {{ .Release.Name }}\\n```\\n\\nNote how the template describes a dynamic set of ke\", \"y/value pairs. When the template is invoked, values that enclosed in curly braces are pulled in from\", \" other yaml-based configuration files.\\n\\nYou'll find the eShopOnContainers helm charts in the /k8s/he\", \"lm folder. Figure 2-6 shows how the different components of the application are organized into a fol\", \"der structure used by helm to define and managed deployments.\\n\\nBranch: dev - eShopOnContainers / k8s\", \" / helm /\\n\\nmvelosop Add option to use local images for k&amp;s deployment\\n\\n\\u2022 apigwmm\\n\\n\\u2022 apigwms\\n\\n\\u2022 a\", \"pigwwm\\n\\n\\u2022 apigwws\\n\\n\\u2022 basket-api\\n\\n\\u2022 basket-data\\n\\n\\u2022 catalog-api\\n\\n\\u2022 eshop-common\\n\\n\\u2022 identity-api\\n\\n\\u2022 ist\", \"io\\n\\n\\u2022 keystore-data\\n\\n\\u2022 locations-api\\n\\n\\u2022 marketing-api\\n\\n\\u2022 mobileshoppingagg\\n\\n\\u2022 nosql-data\\n\\n\\u2022 ordering\", \"-api\\n\\n\\u2022 ordering-backgroundtasks\\n\\n\\u2022 ordering-signalrhub\\n\\n\\u2022 payment-api\\n\\n\\u2022 rabbitmq\\n\\n\\u2022 sql-data\\n\\n\\u2022 we\", \"bhooks-api\\n\\n\\u2022 webhooks-web\\n\\n\\u2022 webmvc\\n\\n\\u2022 webshoppingagg\\n\\n\\u2022 webspa\\n\\n\\u2022 webstatus devspaces scripts\\n\\nUpl\", \"oad files\\n\\nFind file\\n\\nHistory\\n\\nLatest commit faa7546 13 days ago\\n\\n6 months ago\\n\\nFigure 2 -6. The eSh\", \"opOnContainers helm folder.\\n\\n<!-- image -->\\n\\nEach individual component is installed using a helm ins\", \"tall command. eShop includes a \\\"deploy all\\\" script that loops through and installs the components us\", \"ing their respective helm charts. The result is a repeatable process, versioned with the application\", \" in source control, that anyone on the team can deploy to an AKS cluster with a one-line script comm\", \"and.\\n\\nNote that version 3 of Helm officially removes the need for the Tiller server component. More \", \"information on this enhancement can be found here .\\n\\n## Azure Functions and Logic Apps (Serverless)\\n\", \"\\nThe eShopOnContainers sample includes support for tracking online marketing campaigns. An Azure Fun\", \"ction is used to track marketing campaign details for a given campaign ID. Rather than creating a\\n\\nC\", \"reate new file\\n\\nfull microservice, a single Azure Function is simpler and sufficient. Azure Function\", \"s have a simple build and deployment model, especially when configured to run in Kubernetes. Deployi\", \"ng the function is scripted using Azure Resource Manager (ARM) templates and the Azure CLI. This cam\", \"paign service isn't customer -facing and invokes a single operation, making it a great candidate for\", \" Azure Functions. The function requires minimal configuration, including a database connection strin\", \"g data and image base URI settings. You configure Azure Functions in the Azure portal.\\n\\n## Centraliz\", \"ed configuration\\n\\nUnlike a monolithic app in which everything runs within a single instance, a cloud\", \"-native application consists of independent services distributed across virtual machines, containers\", \", and geographic regions. Managing configuration settings for dozens of interdependent services can \", \"be challenging. Duplicate copies of configuration settings across different locations are error pron\", \"e and difficult to manage. Centralized configuration is a critical requirement for distributed cloud\", \"-native applications.\\n\\nAs discussed in Chapter 1, the Twelve-Factor App recommendations require stri\", \"ct separation between code and configuration. Configuration must be stored externally from the appli\", \"cation and read-in as needed. Storing configuration values as constants or literal values in code is\", \" a violation. The same configuration values are often be used by many services in the same applicati\", \"on. Additionally, we must support the same values across multiple environments, such as dev, testing\", \", and production. The best practice is store them in a centralized configuration store.\\n\\nThe Azure c\", \"loud presents several great options.\\n\\n## Azure App Configuration\\n\\nAzure App Configuration is a fully\", \" managed Azure service that stores non-secret configuration settings in a secure, centralized locati\", \"on. Stored values can be shared among multiple services and applications.\\n\\nThe service is simple to \", \"use and provides several benefits:\\n\\n- Flexible key/value representations and mappings\\n- Tagging with\", \" Azure labels\\n- Dedicated UI for management\\n- Encryption of sensitive information\\n- Querying and bat\", \"ch retrieval\\n\\nAzure App Configuration maintains changes made to key-value settings for seven days. T\", \"he point-intime snapshot feature enables you to reconstruct the history of a setting and even rollba\", \"ck for a failed deployment.\\n\\nApp Configuration automatically caches each setting to avoid excessive \", \"calls to the configuration store. The refresh operation waits until the cached value of a setting ex\", \"pires to update that setting, even when its value changes in the configuration store. The default ca\", \"che expiration time is 30 seconds. You can override the expiration time.\\n\\nApp Configuration encrypts\", \" all configuration values in transit and at rest. Key names and labels are used as indexes for retri\", \"eving configuration data and aren't encrypted.\\n\\nAlthough App Configuration provides hardened securit\", \"y, Azure Key Vault is still the best place for storing application secrets. Key Vault provides hardw\", \"are-level encryption, granular access policies, and management operations such as certificate rotati\", \"on. You can create App Configuration values that reference secrets stored in a Key Vault.\\n\\n## Azure \", \"Key Vault\\n\\nKey Vault is a managed service for securely storing and accessing secrets. A secret is an\", \"ything that you want to tightly control access to, such as API keys, passwords, or certificates. A v\", \"ault is a logical group of secrets.\\n\\nKey Vault greatly reduces the chances that secrets may be accid\", \"entally leaked. When using Key Vault, application developers no longer need to store security inform\", \"ation in their application. This practice eliminates the need to store this information inside your \", \"code. For example, an application may need to connect to a database. Instead of storing the connecti\", \"on string in the app's code, you can store it securely in Key Vault.\\n\\nYour applications can securely\", \" access the information they need by using URIs. These URIs allow the applications to retrieve speci\", \"fic versions of a secret. There's no need to write custom code to protect any of the secret informat\", \"ion stored in Key Vault.\\n\\nAccess to Key Vault requires proper caller authentication and authorizatio\", \"n. Typically, each cloudnative microservice uses a ClientId/ClientSecret combination. It's important\", \" to keep these credentials outside source control. A best practice is to set them in the application\", \"'s environment. Direct access to Key Vault from AKS can be achieved using Key Vault FlexVolume .\\n\\n##\", \" Configuration in eShop\\n\\nThe eShopOnContainers application includes local application settings files\", \" with each microservice. These files are checked into source control, but don't include production s\", \"ecrets such as connection strings or API keys. In production, individual settings may be overwritten\", \" with per-service environment variables. Injecting secrets in environment variables is a common prac\", \"tice for hosted applications, but doesn't provide a central configuration store. To support centrali\", \"zed management of configuration settings, each microservice includes a setting to toggle between its\", \" use of local settings or Azure Key Vault settings.\\n\\n## References\\n\\n- The eShopOnContainers Architec\", \"ture\\n- Orchestrating microservices and multi-container applications for high scalability and availab\", \"ility\\n- Azure API Management\\n- Azure SQL Database Overview\\n- Azure Cache for Redis\\n- Azure Cosmos DB\", \"'s API for MongoDB\\n\\n- Azure Service Bus\\n- Azure Monitor overview\\n- eShopOnContainers: Create Kuberne\", \"tes cluster in AKS\\n- eShopOnContainers: Azure Dev Spaces\\n- Azure Dev Spaces\\n\\n## Scaling cloud -nativ\", \"e applications\\n\\nOne of the most -often touted advantages of moving to a cloud hosting environment is\", \" scalability. Scalability, or the ability for an application to accept additional user load without \", \"compromising performance for each user. It's most often achieved by breaking up an application into \", \"small pieces that can each be given whatever resources they require. Cloud vendors enable massive sc\", \"alability anytime and anywhere in the world.\\n\\nIn this chapter, we discuss technologies that enable c\", \"loud-native applications to scale to meet user demand. These technologies include:\\n\\n- Containers\\n- O\", \"rchestrators\\n- Serverless computing\\n\\n## Leveraging containers and orchestrators\\n\\nContainers and orch\", \"estrators are designed to solve problems common to monolithic deployment approaches.\\n\\n## Challenges \", \"with monolithic deployments\\n\\nTraditionally, most applications have been deployed as a single unit. S\", \"uch applications are referred to as a monolith. This general approach of deploying applications as s\", \"ingle units even if they're composed of multiple modules or assemblies is known as monolithic archit\", \"ecture, as shown in Figure 3 -1.\\n\\nClient app\\n\\nMobile\\n\\nTraditional web app\\n\\nHTML\\n\\nMonolithic server p\", \"rocess\\n\\nModules\\n\\nFigure 3 -1. Monolithic architecture.\\n\\n<!-- image -->\\n\\nAlthough they have the benef\", \"it of simplicity, monolithic architectures face many challenges:\\n\\n## Deployment\\n\\nAdditionally, they \", \"require a restart of the application, which may temporarily impact availability if zero-downtime tec\", \"hniques are not applied while deploying.\\n\\n## Scaling\\n\\nA monolithic application is hosted entirely on\", \" a single machine instance, often requiring highcapability hardware. If any part of the monolith req\", \"uires scaling, another copy of the entire application must be deployed to another machine. With a mo\", \"nolith, you can't scale application components individually - it's all or nothing. Scaling component\", \"s that don't require scaling results in inefficient and costly resource usage.\\n\\n## Environment\\n\\nMono\", \"lithic applications are typically deployed to a hosting environment with a pre-installed operating s\", \"ystem, runtime, and library dependencies. This environment may not match that upon which the applica\", \"tion was developed or tested. Inconsistencies across application environments are a common source of\", \" problems for monolithic deployments.\\n\\n## Coupling\\n\\nA monolithic application is likely to experience\", \" high coupling across its functional components. Without hard boundaries, system changes often resul\", \"t in unintended and costly side effects. New features/fixes become tricky, time-consuming, and expen\", \"sive to implement. Updates require extensive testing. Coupling also makes it difficult to refactor c\", \"omponents or swap in alternative implementations. Even when constructed with a strict separation of \", \"concerns, architectural erosion sets in as the monolithic code base deteriorates with never -ending \", \"\\\"special cases.\\\"\\n\\nAPI\\n\\nDatabase\\n\\n## Platform lock -in\\n\\nA monolithic application is constructed with \", \"a single technology stack. While offering uniformity, this commitment can become a barrier to innova\", \"tion. New features and components will be built using the application's current stack - even when mo\", \"re modern technologies may be a better choice. A longer-term risk is your technology stack becoming \", \"outdated and obsolete. Rearchitecting an entire application to a new, more modern platform is at bes\", \"t expensive and risky.\\n\\n## What are the benefits of containers and orchestrators?\\n\\nWe introduced con\", \"tainers in Chapter 1. We highlighted how the Cloud Native Computing Foundation (CNCF) ranks containe\", \"rization as the first step in their Cloud-Native Trail Map - guidance for enterprises beginning thei\", \"r cloud-native journey. In this section, we discuss the benefits of containers.\\n\\nDocker is the most \", \"popular container management platform. It works with containers on both Linux or Windows. Containers\", \" provide separate but reproducible application environments that run the same way on any system. Thi\", \"s aspect makes them perfect for developing and hosting cloud-native services. Containers are isolate\", \"d from one another. Two containers on the same host hardware can have different versions of software\", \", without causing conflicts.\\n\\nContainers are defined by simple text-based files that become project \", \"artifacts and are checked into source control. While full servers and virtual machines require manua\", \"l effort to update, containers are easily version-controlled. Apps built to run in containers can be\", \" developed, tested, and deployed using automated tools as part of a build pipeline.\\n\\nContainers are \", \"immutable. Once you define a container, you can recreate and run it exactly the same way. This immut\", \"ability lends itself to component-based design. If some parts of an application evolve differently t\", \"han others, why redeploy the entire app when you can just deploy the parts that change most frequent\", \"ly? Different features and cross-cutting concerns of an app can be broken up into separate units. Fi\", \"gure 3-2 shows how a monolithic app can take advantage of containers and microservices by delegating\", \" certain features or functionality. The remaining functionality in the app itself has also been cont\", \"ainerized.\\n\\nClient apps\\n\\nMobile app\\n\\nTraditional Web app\\n\\nHTML\\n\\nSPA Web app\\n\\nTypeScript/Angular 2\\n\\nI\", \"dentity microservice (STS+users)\\n\\nRelational database\\n\\nCatalog microservice\\n\\nFigure 3 -2. Decomposin\", \"g a monolithic app to embrace microservices.\\n\\n<!-- image -->\\n\\nEach cloud -native service is built an\", \"d deployed in a separate container. Each can update as needed. Individual services can be hosted on \", \"nodes with resources appropriate to each service. The environment each service runs in is immutable,\", \" shared across dev, test, and production environments, and easily versioned. Coupling between differ\", \"ent areas of the application occurs explicitly as calls or messages between services, not compile-ti\", \"me dependencies within the monolith. You can also choose the technology that best suites a given cap\", \"ability without requiring changes to the rest of the app.\\n\\nContainerized services require automated \", \"management. It wouldn't be feasible to manually administer a large set of independently deployed con\", \"tainers. For example, consider the following tasks:\\n\\n- How will container instances be provisioned a\", \"cross a cluster of many machines?\\n- Once deployed, how will containers discover and communicate with\", \" each other?\\n- How can containers scale in or out on -demand?\\n- How do you monitor the health of eac\", \"h container?\\n- How do you protect a container against hardware and software failures?\\n- How do upgra\", \"de containers for a live application with zero downtime?\\n\\nContainer orchestrators address and automa\", \"te these and other concerns.\\n\\nIn the cloud -native eco -system, Kubernetes has become the de facto c\", \"ontainer orchestrator. It's an open -source platform managed by the Cloud Native Computing Foundatio\", \"n (CNCF). Kubernetes automates the deployment, scaling, and operational concerns of containerized wo\", \"rkloads across a machine cluster. However, installing and managing Kubernetes is notoriously complex\", \".\\n\\nDocker Host\\n\\nKubernetes\\n\\nAzure\\n\\nA much better approach is to leverage Kubernetes as a managed ser\", \"vice from a cloud vendor. The Azure cloud features a fully managed Kubernetes platform entitled Azur\", \"e Kubernetes Service (AKS) . AKS abstracts the complexity and operational overhead of managing Kuber\", \"netes. You consume Kubernetes as a cloud service; Microsoft takes responsibility for managing and su\", \"pporting it. AKS also tightly integrates with other Azure services and dev tools. Node\\n\\nAKS is a clu\", \"ster -based technology. A pool of federated virtual machines, or nodes, is deployed to the Azure clo\", \"ud. Together they form a highly available environment, or cluster. The cluster appears as a seamless\", \", single entity to your cloud-native application. Under the hood, AKS deploys your containerized ser\", \"vices across these nodes following a predefined strategy that evenly distributes the load.\\n\\n## What \", \"are the scaling benefits?\\n\\nServices built on containers can leverage scaling benefits provided by or\", \"chestration tools like Kubernetes. By design containers only know about themselves. Once you have mu\", \"ltiple containers that need to work together, you should organize them at a higher level. Organizing\", \" large numbers of containers and their shared dependencies, such as network configuration, is where \", \"orchestration tools come in to save the day! Kubernetes creates an abstraction layer over groups of \", \"containers and organizes them into pods. Pods run on worker machines referred to as nodes. This orga\", \"nized structure is referred to as a cluster. Figure 3-3 shows the different components of a Kubernet\", \"es cluster.\\n\\nFigure 3 -3. Kubernetes cluster components.\\n\\n<!-- image -->\\n\\nScaling containerized work\", \"loads is a key feature of container orchestrators. AKS supports automatic scaling across two dimensi\", \"ons: Container instances and compute nodes. Together they give AKS the ability to quickly and effici\", \"ently respond to spikes in demand and add additional resources. We discuss scaling in AKS later in t\", \"his chapter.\\n\\nKubernetes Master\\n\\n## Declarative versus imperative\\n\\nKubernetes supports both declarat\", \"ive and imperative configuration. The imperative approach involves running various commands that tel\", \"l Kubernetes what to do each step of the way. Run this image. Delete this pod. Expose this port. Wit\", \"h the declarative approach, you create a configuration file, called a manifest, to describe what you\", \" want instead of what to do. Kubernetes reads the manifest and transforms your desired end state int\", \"o actual end state.\\n\\nImperative commands are great for learning and interactive experimentation. How\", \"ever, you'll want to declaratively create Kubernetes manifest files to embrace an infrastructure as \", \"code approach, providing for reliable and repeatable deployments. The manifest file becomes a projec\", \"t artifact and is used in your CI/CD pipeline for automating Kubernetes deployments.\\n\\nIf you've alre\", \"ady configured your cluster using imperative commands, you can export a declarative manifest by usin\", \"g kubectl get svc SERVICENAME -o yaml &gt; service.yaml. This command produces a manifest similar to\", \" one shown below:\\n\\n```\\napiVersion: v1 kind: Service metadata: creationTimestamp: \\\"2019-09-13T13:58:4\", \"7Z\\\" labels: component: apiserver provider: kubernetes name: kubernetes namespace: default resourceVe\", \"rsion: \\\"153\\\" selfLink: /api/v1/namespaces/default/services/kubernetes uid: 9b1fac62 -d62e -11e9 -896\", \"8 -00155d38010d spec: clusterIP: 10.96.0.1 ports: -name: https port: 443 protocol: TCP targetPort: 6\", \"443 sessionAffinity: None type: ClusterIP status: loadBalancer: {}\\n```\\n\\nWhen using declarative confi\", \"guration, you can preview the changes that will be made before committing them by using kubectl diff\", \" -f FOLDERNAME against the folder where your configuration files are located. Once you're sure you w\", \"ant to apply the changes, run kubectl apply -f FOLDERNAME. Add -R to recursively process a folder hi\", \"erarchy.\\n\\nYou can also use declarative configuration with other Kubernetes features, one of which be\", \"ing deployments. Declarative deployments help manage releases, updates, and scaling. They instruct t\", \"he Kubernetes deployment controller on how to deploy new changes, scale out load, or roll back to a \", \"previous revision. If a cluster is unstable, a declarative deployment will automatically return the \", \"cluster back to a desired state. For example, if a node should crash, the deployment mechanism will \", \"redeploy a replacement to achieve your desired state\\n\\nUsing declarative configuration allows infrast\", \"ructure to be represented as code that can be checked in and versioned alongside the application cod\", \"e. It provides improved change control and better support for continuous deployment using a build an\", \"d deploy pipeline.\\n\\n## What scenarios are ideal for containers and orchestrators?\\n\\nThe following sce\", \"narios are ideal for using containers and orchestrators.\\n\\n## Applications requiring high uptime and \", \"scalability\\n\\nIndividual applications that have high uptime and scalability requirements are ideal ca\", \"ndidates for cloud -native architectures using microservices, containers, and orchestrators. They ca\", \"n be developed in containers, tested across versioned environments, and deployed into production wit\", \"h zero downtime. The use of Kubernetes clusters ensures such apps can also scale on demand and recov\", \"er automatically from node failures.\\n\\n## Large numbers of applications\\n\\nOrganizations that deploy an\", \"d maintain large numbers of applications benefit from containers and orchestrators. The up front eff\", \"ort of setting up containerized environments and Kubernetes clusters is primarily a fixed cost. Depl\", \"oying, maintaining, and updating individual applications has a cost that varies with the number of a\", \"pplications. Beyond a few applications, the complexity of maintaining custom applications manually e\", \"xceeds the cost of implementing a solution using containers and orchestrators.\\n\\n## When should you a\", \"void using containers and orchestrators?\\n\\nIf you're unable to build your application following the T\", \"welve-Factor App principles, you should consider avoiding containers and orchestrators. In these cas\", \"es, consider a VM-based hosting platform, or possibly some hybrid system. With it, you can always sp\", \"in off certain pieces of functionality into separate containers or even serverless functions.\\n\\n## De\", \"velopment resources\\n\\nThis section shows a short list of development resources that may help you get \", \"started using containers and orchestrators for your next application. If you're looking for guidance\", \" on how to design your cloud-native microservices architecture app, read this book's companion, .NET\", \" Microservices: Architecture for Containerized .NET Applications .\\n\\n## Local Kubernetes Development\\n\", \"\\nKubernetes deployments provide great value in production environments, but can also run locally on \", \"your development machine. While you may work on individual microservices independently, there may be\", \" times when you'll need to run the entire system locally - just as it will run when deployed to prod\", \"uction. There are several tools that can help: Minikube and Docker Desktop. Visual Studio also provi\", \"des tooling for Docker development.\\n\\nsit docker\\n\\nSettings\\n\\nGeneral\\n\\n## Minikube\\n\\nKubernetes v1.21.3\\n\", \"\\n\\u2022 Enable Kubernetes\\n\\nWhat is Minikube? The Minikube project says \\\"Minikube implements a local Kuber\", \"netes cluster on macOS, Linux, and Windows.\\\" Its primary goals are \\\"to be the best tool for local Ku\", \"bernetes application development and to support all Kubernetes features that fit.\\\" Installing Miniku\", \"be is separate from Docker, but Minikube supports different hypervisors than Docker Desktop supports\", \". The following Kubernetes features are currently supported by Minikube: Reset Kubernetes Cluster\\n\\n-\", \" DNS\\n- NodePorts\\n- ConfigMaps and secrets\\n- Dashboards\\n- Container runtimes: Docker, rkt, CRI-O, and\", \" containerd\\n- Enabling Container Network Interface (CNI)\\n- Ingress\\n\\nAfter installing Minikube, you c\", \"an quickly start using it by running the minikube start command, which downloads an image and start \", \"the local Kubernetes cluster. Once the cluster is started, you interact with it using the standard K\", \"ubernetes kubectl commands.\\n\\n## Docker Desktop\\n\\nYou can also work with Kubernetes directly from Dock\", \"er Desktop on Windows. It is your only option if you're using Windows Containers, and is a great cho\", \"ice for non-Windows containers as well. Figure 34 shows how to enable local Kubernetes support when \", \"running Docker Desktop.\\n\\nFigure 3 -4. Configuring Kubernetes in Docker Desktop.\\n\\n<!-- image -->\\n\\nUpg\", \"rade O robertor\\n\\nCancel\\n\\nApply &amp; Restart\\n\\nX\\n\\nAdditional information\\n\\nASP.NET Core Web APIc*\\n\\nFra\", \"mework f\\n\\nAuthentication type O\\n\\nNone\\n\\n[Z Enable Docker O\\n\\nDocker OS O\\n\\nLinux\\n\\nDocker Desktop is the\", \" most popular tool for configuring and running containerized apps locally. When you work with Docker\", \" Desktop, you can develop locally against the exact same set of Docker container images that you'll \", \"deploy to production. Docker Desktop is designed to \\\"build, test, and ship\\\" containerized apps local\", \"ly. It supports both Linux and Windows containers. Once you push your images to an image registry, l\", \"ike Azure Container Registry or Docker Hub, AKS can pull and deploy them to production.\\n\\n/ Use contr\", \"ollers (uncheck to use minimal APIs) O\\n\\n## Visual Studio Docker Tooling\\n\\nVisual Studio supports Dock\", \"er development for web-based applications. When you create a new ASP.NET Core application, you have \", \"an option to configure it with Docker support, as shown in Figure 3 -5. Back Create\\n\\nFigure 3 -5. Vi\", \"sual Studio Enable Docker Support\\n\\n<!-- image -->\\n\\nWhen this option is selected, the project is crea\", \"ted with a Dockerfile in its root, which can be used to build and host the app in a Docker container\", \". An example Dockerfile is shown in Figure 3-6.\\n\\n```\\nFROM mcr.microsoft.com/dotnet/aspnet:7.0 AS bas\", \"e WORKDIR /app EXPOSE 80 EXPOSE 443 FROM mcr.microsoft.com/dotnet/sdk:7.0 AS build WORKDIR /src COPY\", \" [\\\"eShopWeb/eShopWeb.csproj\\\" , \\\"eShopWeb/\\\"] RUN dotnet restore \\\"eShopWeb/eShopWeb.csproj\\\" COPY . . W\", \"ORKDIR \\\"/src/eShopWeb\\\" RUN dotnet build \\\"eShopWeb.csproj\\\" -c Release -o /app/build FROM build AS pub\", \"lish RUN dotnet publish \\\"eShopWeb.csproj\\\" -c Release -o /app/publish\\n```\\n\\nLinux macOS\\n\\nWindows\\n\\nClou\", \"d\\n\\nService\\n\\nWeb\\n\\nX\\n\\nDebug *\\n\\nAny CPU\\n\\n\\u2022 Docker api\\\\_sample\\\\_app\\n\\nIIS Express\\n\\nDocker\\n\\nWSL\\n\\nFigure 3 \", \"-6. Visual Studio generated Dockerfile\\n\\n<!-- image -->\\n\\nOnce support is added, you can run your appl\", \"ication in a Docker container in Visual Studio. Figure 3-7 shows the different run options available\", \" from a new ASP.NET Core project created with Docker support added.\\n\\nFigure 3 -7. Visual Studio Dock\", \"er Run Options\\n\\n<!-- image -->\\n\\nAlso, at any time you can add Docker support to an existing ASP.NET \", \"Core application. From the Visual Studio Solution Explorer, right-click on the project and select Ad\", \"d &gt; Docker Support, as shown in Figure 3-8.\\n\\nDocker -\\n\\nNew Item...\\n\\nExisting Item...\\n\\nNew Scaffol\", \"ded Item...\\n\\nNew Folder\\n\\nApplication Insights Telemetry...\\n\\nContainer Orchestrator Support...\\n\\nDocke\", \"r Support...\\n\\nClient-Side Library...\\n\\nNew Azure WebJob Project\\n\\nExisting Project as Azure WebJob\\n\\nPr\", \"oject Reference...\\n\\nShared Project Reference...\\n\\nCOM Reference...\\n\\nService Reference...\\n\\nConnected S\", \"ervice\\n\\nClass...\\n\\nNew EditorConfig\\n\\nBuild\\n\\nRebuild\\n\\nClean\\n\\nSolution Explorer\\n\\nSearch Solution Explor\", \"er (Ctri+:)\\n\\nSolution 'api-sample-app' (1 of 1 project)\\n\\n= -pi-sample-app\\n\\n\\u203a Connected Services\\n\\n9 D\", \"ependencies\\n\\n\\u2022 Properties\\n\\nFigure 3 -8. Adding Docker support to Visual Studio\\n\\n<!-- image -->\\n\\n## V\", \"isual Studio Code Docker Tooling\\n\\nThere are many extensions available for Visual Studio Code that su\", \"pport Docker development.\\n\\nMicrosoft provides the Docker for Visual Studio Code extension. This exte\", \"nsion simplifies the process of adding container support to applications. It scaffolds required file\", \"s, builds Docker images, and enables you to debug your app inside a container. The extension feature\", \"s a visual explorer that makes it easy to take actions on containers and images such as start, stop,\", \" inspect, remove, and more. The extension also supports Docker Compose enabling you to manage multip\", \"le running containers as a single unit.\\n\\n## Leveraging serverless functions\\n\\nIn the spectrum from ma\", \"naging physical machines to leveraging cloud capabilities, serverless lives at the extreme end. Your\", \" only responsibility is your code, and you only pay when your code runs. Azure Functions provides a \", \"way to build serverless capabilities into your cloud-native applications.\\n\\n- 00\\n\\n4 X\\n\\n## What is ser\", \"verless?\\n\\nServerless is a relatively new service model of cloud computing. It doesn't mean that serv\", \"ers are optional - your code still runs on a server somewhere. The distinction is that the applicati\", \"on team no longer concerns itself with managing server infrastructure. Instead, the cloud vendor own\", \" this responsibility. The development team increases its productivity by delivering business solutio\", \"ns to customers, not plumbing.\\n\\nServerless computing uses event-triggered stateless containers to ho\", \"st your services. They can scale out and in to meet demand as -needed. Serverless platforms like Azu\", \"re Functions have tight integration with other Azure services like queues, events, and storage.\\n\\n## \", \"What challenges are solved by serverless?\\n\\nServerless platforms address many time-consuming and expe\", \"nsive concerns:\\n\\n- Purchasing machines and software licenses\\n- Housing, securing, configuring, and m\", \"aintaining the machines and their networking, power, and A/C requirements\\n- Patching and upgrading o\", \"perating systems and software\\n- Configuring web servers or machine services to host application soft\", \"ware\\n- Configuring application software within its platform\\n\\nMany companies allocate large budgets t\", \"o support hardware infrastructure concerns. Moving to the cloud can help reduce these costs; shiftin\", \"g applications to serverless can help eliminate them.\\n\\n## What is the difference between a microserv\", \"ice and a serverless function?\\n\\nTypically, a microservice encapsulates a business capability, such a\", \"s a shopping cart for an online eCommerce site. It exposes multiple operations that enable a user to\", \" manage their shopping experience. A function, however, is a small, lightweight block of code that e\", \"xecutes a single-purpose operation in response to an event. Microservices are typically constructed \", \"to respond to requests, often from an interface. Requests can be HTTP Rest- or gRPC-based. Serverles\", \"s services respond to events. Its event -driven architecture is ideal for processing short-running, \", \"background tasks.\\n\\n## What scenarios are appropriate for serverless?\\n\\nServerless exposes individual \", \"short-running functions that are invoked in response to a trigger. This makes them ideal for process\", \"ing background tasks.\\n\\nAn application might need to send an email as a step in a workflow. Instead o\", \"f sending the notification as part of a microservice request, place the message details onto a queue\", \". An Azure Function can dequeue the message and asynchronously send the email. Doing so could improv\", \"e the performance and scalability of the microservice. Queue-based load leveling can be implemented \", \"to avoid bottlenecks related to sending the emails. Additionally, this stand-alone service could be \", \"reused as a utility across many different applications.\\n\\nAzure allocates unspecialized\\n\\nserver\\n\\nAzur\", \"e allocates unspecialized\\n\\nserve\\n\\nWorker becomes\\n\\nspecialized\\n\\nWhen App is Cold\\n\\nFunctions runtime r\", \"esets\\n\\nFunctions loaded into\\n\\nmemory\\n\\nAsynchronous messaging from queues and topics is a common patt\", \"ern to trigger serverless functions. However, Azure Functions can be triggered by other events, such\", \" as changes to Azure Blob Storage. A service that supports image uploads could have an Azure Functio\", \"n responsible for optimizing the image size. The function could be triggered directly by inserts int\", \"o Azure Blob Storage, keeping complexity out of the microservice operations.\\n\\nMany services have lon\", \"g-running processes as part of their workflows. Often these tasks are done as part of the user's int\", \"eraction with the application. These tasks can force the user to wait, negatively impacting their ex\", \"perience. Serverless computing provides a great way to move slower tasks outside of the user interac\", \"tion loop. These tasks can scale with demand without requiring the entire application to scale. file\", \"s read\\n\\nApp settings\\n\\nExtensions\\n\\n## When should you avoid serverless?\\n\\nServerless solutions provisi\", \"on and scale on demand. When a new instance is invoked, cold starts are a common issue. A cold start\", \" is the period of time it takes to provision this instance. Normally, this delay might be a few seco\", \"nds, but can be longer depending on various factors. Once provisioned, a single instance is kept ali\", \"ve as long as it receives periodic requests. But, if a service is called less frequently, Azure may \", \"remove it from memory and require a cold start when reinvoked. Cold starts are also required when a \", \"function scales out to a new instance.\\n\\nFigure 3-9 shows a cold-start pattern. Note the extra steps \", \"required when the app is cold.\\n\\nFigure 3 -9. Cold start versus warm start.\\n\\n<!-- image -->\\n\\nTo avoid\", \" cold starts entirely, you might switch from a consumption plan to a dedicated plan. You can also co\", \"nfigure one or more pre-warmed instances with the premium plan upgrade. In these cases, when you nee\", \"d to add another instance, it's already up and ready to go. These options can help mitigate the cold\", \" start issue associated with serverless computing.\\n\\nCode runs\\n\\nCloud providers bill for serverless b\", \"ased on compute execution time and consumed memory. Long running operations or high memory consumpti\", \"on workloads aren't always the best candidates for serverless. Serverless functions favor small chun\", \"ks of work that can complete quickly. Most serverless platforms require individual functions to comp\", \"lete within a few minutes. Azure Functions defaults to a 5 -minute time -out duration, which can be \", \"configured up to 10 minutes. The Azure Functions premium plan can mitigate this issue as well, defau\", \"lting time-outs to 30 minutes with an unbounded higher limit that can be configured. Compute time is\", \"n't calendar time. More advanced functions using the Azure Durable Functions framework may pause exe\", \"cution over a course of several days. The billing is based on actual execution time -when the functi\", \"on wakes up and resumes processing.\\n\\nFinally, leveraging Azure Functions for application tasks adds \", \"complexity. It's wise to first architect your application with a modular, loosely coupled design. Th\", \"en, identify if there are benefits serverless would offer that justify the additional complexity.\\n\\n#\", \"# Combining containers and serverless approaches\\n\\nCloud -native applications typically implement ser\", \"vices leveraging containers and orchestration. There are often opportunities to expose some of the a\", \"pplication's services as Azure Functions. However, with a cloud -native app deployed to Kubernetes, \", \"it would be nice to leverage Azure Functions within this same toolset. Fortunately, you can wrap Azu\", \"re Functions inside Docker containers and deploy them using the same processes and tools as the rest\", \" of your Kubernetes-based app.\\n\\n## When does it make sense to use containers with serverless?\\n\\nYour \", \"Azure Function has no knowledge of the platform on which it's deployed. For some scenarios, you may \", \"have specific requirements and need to customize the environment on which your function code will ru\", \"n. You'll need a custom image that supports dependencies or a configuration not supported by the def\", \"ault image. In these cases, it makes sense to deploy your function in a custom Docker container.\\n\\n##\", \" When should you avoid using containers with Azure Functions?\\n\\nIf you want to use consumption billin\", \"g, you can't run your function in a container. What's more, if you deploy your function to a Kuberne\", \"tes cluster, you'll no longer benefit from the built-in scaling provided by Azure Functions. You'll \", \"need to use Kubernetes' scaling features, described earlier in this chapter.\\n\\n## How to combine serv\", \"erless and Docker containers\\n\\nTo wrap an Azure Function in a Docker container, install the Azure Fun\", \"ctions Core Tools and then run the following command:\\n\\nfunc init ProjectName --worker-runtime dotnet\", \" --docker\\n\\nWhen the project is created, it will include a Dockerfile and the worker runtime configur\", \"ed to dotnet. Now, you can create and test your function locally. Build and run it using the docker \", \"build and docker\\n\\nrun commands. For detailed steps to get started building Azure Functions with Dock\", \"er support, see the Create a function on Linux using a custom image tutorial.\\n\\n## How to combine ser\", \"verless and Kubernetes with KEDA\\n\\nIn this chapter, you've seen that the Azure Functions' platform au\", \"tomatically scales out to meet demand. When deploying containerized functions to AKS, however, you l\", \"ose the built-in scaling functionality. To the rescue comes Kubernetes-based Event Driven (KEDA). It\", \" enables fine-grained autoscaling for event-driven Kubernetes workloads, including containerized fun\", \"ctions.\\n\\nKEDA provides event-driven scaling functionality to the Functions' runtime in a Docker cont\", \"ainer. KEDA can scale from zero instances (when no events are occurring) out to n instances, based o\", \"n load. It enables autoscaling by exposing custom metrics to the Kubernetes autoscaler (Horizontal P\", \"od Autoscaler). Using Functions containers with KEDA makes it possible to replicate serverless funct\", \"ion capabilities in any Kubernetes cluster.\\n\\nIt's worth noting that the KEDA project is now managed \", \"by the Cloud Native Computing Foundation (CNCF).\\n\\n## Deploying containers in Azure\\n\\nWe've discussed \", \"containers in this chapter and in chapter 1. We've seen that containers provide many benefits to clo\", \"ud -native applications, including portability. In the Azure cloud, you can deploy the same containe\", \"rized services across staging and production environments. Azure provides several options for hostin\", \"g these containerized workloads:\\n\\n- Azure Kubernetes Services (AKS)\\n- Azure Container Instance (ACI)\", \"\\n- Azure Web Apps for Containers\\n\\n## Azure Container Registry\\n\\nWhen containerizing a microservice, y\", \"ou first build a container \\\"image.\\\" The image is a binary representation of the service code, depend\", \"encies, and runtime. While you can manually create an image using the Docker Build command from the \", \"Docker API, a better approach is to create it as part of an automated build process.\\n\\nOnce created, \", \"container images are stored in container registries. They enable you to build, store, and manage con\", \"tainer images. There are many registries available, both public and private. Azure Container Registr\", \"y (ACR) is a fully managed container registry service in the Azure cloud. It persists your images in\", \"side the Azure network, reducing the time to deploy them to Azure container hosts. You can also secu\", \"re them using the same security and identity procedures that you use for other Azure resources.\\n\\nYou\", \" create an Azure Container Registry using the Azure portal , Azure CLI, or PowerShell tools . Creati\", \"ng a registry in Azure is simple. It requires an Azure subscription, resource group, and a unique\\n\\nC\", \"reate container registry\\n\\n* Registry name name. Figure 3-10 shows the basic options for creating a r\", \"egistry, which will be hosted at registryname.azurecr.io. \\\"azurecrio\\n\\n* Subscription\\n\\nVisual Studio \", \"Ultimate with MSDN\\n\\n* Resource group\\n\\n(New) myResourceGroup\\n\\nCreate new\\n\\n* Location\\n\\nWest US\\n\\n* Admi\", \"n user O\\n\\nEnable\\n\\n* SKU 0\\n\\nBasic\\n\\nCreate\\n\\nFigure 3 -10. Create container registry\\n\\n<!-- image -->\\n\\nO\", \"nce you've created the registry, you'll need to authenticate with it before you can use it. Typicall\", \"y, you'll log into the registry using the Azure CLI command:\\n\\n```\\naz acr login --name *registryname*\", \"\\n```\\n\\nOnce authenticated, you can use docker commands to push container images to it. Before you can\", \" do so, however, you must tag your image with the fully qualified name (URL) of your ACR login serve\", \"r. It will have the format registryname.azurecr.io.\\n\\ndocker tag mycontainer myregistry.azurecr.io/my\", \"container:v1\\n\\nAfter you've tagged the image, you use the docker push command to push the image to yo\", \"ur ACR instance.\\n\\ndocker push myregistry.azurecr.io/mycontainer:v1\\n\\n\\u2022\\n\\nX\\n\\nAfter you push an image to\", \" the registry, it's a good idea to remove the image from your local Docker environment, using this c\", \"ommand:\\n\\ndocker rmi myregistry.azurecr.io/mycontainer:v1\\n\\nAs a best practice, you shouldn't manually\", \" push images to a container registry. Instead, use a build pipeline defined in a tool like GitHub or\", \" Azure DevOps. Learn more in the Cloud-Native DevOps chapter .\\n\\n## ACR Tasks\\n\\nACR Tasks is a set of \", \"features available from the Azure Container Registry. It extends your inner-loop development cycle b\", \"y building and managing container images in the Azure cloud. Instead of invoking a docker build and \", \"docker push locally on your development machine, they're automatically handled by ACR Tasks in the c\", \"loud.\\n\\nThe following AZ CLI command both builds a container image and pushes it to ACR:\\n\\n# create a \", \"container registry az acr create --resource-group myResourceGroup --name myContainerRegistry008 --sk\", \"u Basic\\n\\n# build container image in ACR and push it into your container registry az acr build --imag\", \"e sample/hello-world:v1 --registry myContainerRegistry008 --file Dockerfile .\\n\\nAs you can see from t\", \"he previous command block, there's no need to install Docker Desktop on your development machine. Ad\", \"ditionally, you can configure ACR Task triggers to rebuild containers images on both source code and\", \" base image updates.\\n\\n## Azure Kubernetes Service\\n\\nWe discussed Azure Kubernetes Service (AKS) at le\", \"ngth in this chapter. We've seen that it's the de facto container orchestrator managing containerize\", \"d cloud-native applications.\\n\\nOnce you deploy an image to a registry, such as ACR, you can configure\", \" AKS to automatically pull and deploy it. With a CI/CD pipeline in place, you might configure a cana\", \"ry release strategy to minimize the risk involved when rapidly deploying updates. The new version of\", \" the app is initially configured in production with no traffic routed to it. Then, the system will r\", \"oute a small percentage of users to the newly deployed version. As the team gains confidence in the \", \"new version, it can roll out more instances and retire the old. AKS easily supports this style of de\", \"ployment.\\n\\nAs with most resources in Azure, you can create an Azure Kubernetes Service cluster using\", \" the portal, command -line, or automation tools like Helm or Terraform. To get started with a new cl\", \"uster, you need to provide the following information:\\n\\n- Azure subscription\\n- Resource group\\n- Kuber\", \"netes cluster name\\n- Region\\n\\n- Kubernetes version\\n- DNS name prefix\\n- Node size\\n- Node count\\n\\nThis i\", \"nformation is sufficient to get started. As part of the creation process in the Azure portal, you ca\", \"n also configure options for the following features of your cluster:\\n\\n- Scale\\n- Authentication\\n- Net\", \"working\\n- Monitoring\\n- Tags\\n\\nThis quickstart walks through deploying an AKS cluster using the Azure \", \"portal .\\n\\n## Azure Bridge to Kubernetes\\n\\nCloud -native applications can grow large and complex, requ\", \"iring significant compute resources to run. In these scenarios, the entire application can't be host\", \"ed on a development machine (especially a laptop). Azure Bridge to Kubernetes addresses the shortcom\", \"ing. It enables developers to work with a local version of their service while hosting the entire ap\", \"plication in an AKS development cluster.\\n\\nWhen ready, developers test their changes locally while ru\", \"nning against the full application in the AKS cluster -without replicating dependencies. Under the h\", \"ood, the bridge merges code from the local machine with services in AKS. Developers can rapidly iter\", \"ate and debug code directly in Kubernetes using Visual Studio or Visual Studio Code.\\n\\nGabe Monroy, f\", \"ormer VP of Product Management at Microsoft, describes it well:\\n\\nImagine you're a new employee tryin\", \"g to fix a bug in a complex microservices application consisting of dozens of components, each with \", \"their own configuration and backing services. To get started, you must configure your local developm\", \"ent environment so that it can mimic production including setting up your IDE, building tool chain, \", \"containerized service dependencies, a local Kubernetes environment, mocks for backing services, and \", \"more. With all the time involved setting up your development environment, fixing that first bug coul\", \"d take days! Or you could just use Bridge to Kubernetes and AKS.\\n\\n## Scaling containers and serverle\", \"ss applications\\n\\nThere are two ways to scale an application: up or out. The former refers to adding \", \"capacity to a single resource, while the latter refers to adding more resources to increase capacity\", \".\\n\\n## The simple solution: scaling up\\n\\nUpgrading an existing host server with increased CPU, memory,\", \" disk I/O speed, and network I/O speed is known as scaling up. Scaling up a cloud-native application\", \" involves choosing more capable\\n\\nAzure Kubernetes Service (AKS) cluster resources from the cloud ven\", \"dor. For example, you can create a new node pool with larger VMs in your Kubernetes cluster. Then, m\", \"igrate your containerized services to the new pool.\\n\\nServerless apps scale up by choosing the premiu\", \"m Functions plan or premium instance sizes from a dedicated app service plan. Node Node Node\\n\\n## Sca\", \"ling out cloud-native apps\\n\\nCloud -native applications often experience large fluctuations in demand\", \" and require scale on a moment's notice. They favor scaling out. Scaling out is done horizontally by\", \" adding additional machines (called nodes) or application instances to an existing cluster. In Kuber\", \"netes, you can scale manually by adjusting configuration settings for the app (for example, scaling \", \"a node pool), or through autoscaling.\\n\\nAKS clusters can autoscale in one of two ways:\\n\\nFirst, the Ho\", \"rizontal Pod Autoscaler monitors resource demand and automatically scales your POD replicas to meet \", \"it. When traffic increases, additional replicas are automatically provisioned to scale out your serv\", \"ices. Likewise, when demand decreases, they're removed to scale-in your services. You define the met\", \"ric on which to scale, for example, CPU usage. You can also specify the minimum and maximum number o\", \"f replicas to run. AKS monitors that metric and scales accordingly.\\n\\nNext, the AKS Cluster Autoscale\", \"r feature enables you to automatically scale compute nodes across a Kubernetes cluster to meet deman\", \"d. With it, you can automatically add new VMs to the underlying Azure Virtual Machine Scale Set when\", \"ever more compute capacity of is required. It also removes nodes when no longer required.\\n\\nFigure 3-\", \"11 shows the relationship between these two scaling services.\\n\\nFigure 3 -11. Scaling out an App Serv\", \"ice plan.\\n\\n<!-- image -->\\n\\nWorking together, both ensure an optimal number of container instances an\", \"d compute nodes to support fluctuating demand. The horizontal pod autoscaler optimizes the number of\", \" pods required. The cluster autoscaler optimizes the number of nodes required.\\n\\n## Scaling Azure Fun\", \"ctions\\n\\nAzure Functions automatically scale out upon demand. Server resources are dynamically alloca\", \"ted and removed based on the number of triggered events. You're only charged for compute resources c\", \"onsumed when your functions run. Billing is based upon the number of executions, execution time, and\", \" memory used.\\n\\nWhile the default consumption plan provides an economical and scalable solution for m\", \"ost apps, the premium option allows developers flexibility for custom Azure Functions requirements. \", \"Upgrading to the premium plan provides control over instance sizes, pre-warmed instances (to avoid c\", \"old start delays), and dedicated VMs.\\n\\n## Other container deployment options\\n\\nAside from Azure Kuber\", \"netes Service (AKS), you can also deploy containers to Azure App Service for Containers and Azure Co\", \"ntainer Instances.\\n\\n## When does it make sense to deploy to App Service for Containers?\\n\\nSimple prod\", \"uction applications that don't require orchestration are well suited to Azure App Service for Contai\", \"ners.\\n\\n## How to deploy to App Service for Containers\\n\\nTo deploy to Azure App Service for Containers\", \", you'll need an Azure Container Registry (ACR) instance and credentials to access it. Push your con\", \"tainer image to the ACR repository so that your Azure App Service can pull it when needed. Once comp\", \"lete, you can configure the app for Continuous Deployment. Doing so will automatically deploy update\", \"s whenever the image changes in ACR.\\n\\n## When does it make sense to deploy to Azure Container Instan\", \"ces?\\n\\nAzure Container Instances (ACI) enables you to run Docker containers in a managed, serverless \", \"cloud environment, without having to set up virtual machines or clusters. It's a great solution for \", \"shortrunning workloads that can run in an isolated container. Consider ACI for simple services, test\", \"ing scenarios, task automation, and build jobs. ACI spins-up a container instance, performs the task\", \", and then spins it down.\\n\\n## How to deploy an app to Azure Container Instances\\n\\nTo deploy to Azure \", \"Container Instances (ACI), you need an Azure Container Registry (ACR) and credentials for accessing \", \"it. Once you push your container image to the repository, it's available to pull into ACI. You can w\", \"ork with ACI using the Azure portal or command-line interface. ACR provides tight integration with A\", \"CI. Figure 3-12 shows how to push an individual container image to ACR.\\n\\nmyregistry - Repositories\\n\\n\", \"Container registry\\n\\n\\u2022 Search (Ctri+/)\\n\\n\\u20ac Overview\\n\\n\\u2022 Activity log iM Access control (IAM)\\n\\nTags\\n\\n&am\", \"p; Quick start\\n\\nSETTINGS\\n\\nAccess keys\\n\\nLocks\\n\\n\\u2022 Automation script\\n\\nSERVICES\\n\\ni Repositories\\n\\n&amp; W\", \"ebhooks\\n\\nReplications (Preview)\\n\\nSUPPORT + TROUBLESHOOTING\\n\\n\\u2022 New support request\\n\\n\\u00a9 Refresh\\n\\nO Sear\", \"ch to filter repositories ....\\n\\nTags myregistry azurecr.io/aci-helloworld\\n\\n\\u00a9 Refresh\\n\\nP Search to fi\", \"lter tags ...\\n\\nFigure 3 -12. Azure Container Registry Run Instance\\n\\n<!-- image -->\\n\\nCreating an inst\", \"ance in ACI can be done quickly. Specify the image registry, Azure resource group information, the a\", \"mount of memory to allocate, and the port on which to listen. This quickstart shows how to deploy a \", \"container instance to ACI using the Azure portal .\\n\\nOnce the deployment completes, find the newly de\", \"ployed container's IP address and communicate with it over the port you specified.\\n\\nAzure Container \", \"Instances offers the fastest way to run simple container workloads in Azure. You don't need to confi\", \"gure an app service, orchestrator, or virtual machine. For scenarios where you require full containe\", \"r orchestration, service discovery, automatic scaling, or coordinated upgrades, we recommend Azure K\", \"ubernetes Service (AKS).\\n\\n## References\\n\\n- What is Kubernetes?\\n- Installing Kubernetes with Minikube\", \"\\n- MiniKube vs Docker Desktop\\n- Visual Studio Tools for Docker\\n\\n* \\u00d7\\n\\n\\u00b7 Understanding serverless cold\", \" start \\u00b7 Pre -warmed Azure Functions instances \\u00b7 Create a function on Linux using a custom image \\u00b7 R\", \"un Azure Functions in a Docker Container \\u00b7 Create a function on Linux using a custom image \\u00b7 Azure F\", \"unctions with Kubernetes Event Driven Autoscaling \\u00b7 Canary Release \\u00b7 Azure Dev Spaces with VS Code \\u00b7\", \" Azure Dev Spaces with Visual Studio \\u00b7 AKS Multiple Node Pools \\u00b7 AKS Cluster Autoscaler \\u00b7 Tutorial: \", \"Scale applications in AKS \\u00b7 Azure Functions scale and hosting \\u00b7 Azure Container Instances Docs \\u00b7 Dep\", \"loy Container Instance from ACR\\n\\n## Cloud -native communication patterns\\n\\nWhen constructing a cloud-\", \"native system, communication becomes a significant design decision. How does a front -end client app\", \"lication communicate with a back-end microservice? How do back-end microservices communicate with ea\", \"ch other? What are the principles, patterns, and best practices to consider when implementing commun\", \"ication in cloud-native applications?\\n\\n## Communication considerations\\n\\nIn a monolithic application,\", \" communication is straightforward. The code modules execute together in the same executable space (p\", \"rocess) on a server. This approach can have performance advantages as everything runs together in sh\", \"ared memory, but results in tightly coupled code that becomes difficult to maintain, evolve, and sca\", \"le.\\n\\nCloud -native systems implement a microservice-based architecture with many small, independent \", \"microservices. Each microservice executes in a separate process and typically runs inside a containe\", \"r that is deployed to a cluster .\\n\\nA cluster groups a pool of virtual machines together to form a hi\", \"ghly available environment. They're managed with an orchestration tool, which is responsible for dep\", \"loying and managing the containerized microservices. Figure 4-1 shows a Kubernetes cluster deployed \", \"into the Azure cloud with the fully managed Azure Kubernetes Services .\\n\\nKubernetes\\n\\nNode\\n\\nNode\\n\\nMas\", \"ter Node\\n\\nDNS\\n\\nScheduler\\n\\nFigure 4 -1. A Kubernetes cluster in Azure\\n\\n<!-- image -->\\n\\nAcross the clu\", \"ster, microservices communicate with each other through APIs and messaging technologies.\\n\\nWhile they\", \" provide many benefits, microservices are no free lunch. Local in-process method calls between compo\", \"nents are now replaced with network calls. Each microservice must communicate over a network protoco\", \"l, which adds complexity to your system:\\n\\n- Network congestion, latency, and transient faults are a \", \"constant concern.\\n- Resiliency (that is, retrying failed requests) is essential.\\n- Some calls must b\", \"e idempotent as to keep consistent state.\\n- Each microservice must authenticate and authorize calls.\", \"\\n- Each message must be serialized and then deserialized - which can be expensive.\\n- Message encrypt\", \"ion/decryption becomes important.\\n\\nThe book .NET Microservices: Architecture for Containerized .NET \", \"Applications, available for free from Microsoft, provides an in-depth coverage of communication patt\", \"erns for microservice applications. In this chapter, we provide a high-level overview of these patte\", \"rns along with implementation options available in the Azure cloud.\\n\\nIn this chapter, we'll first ad\", \"dress communication between front-end applications and back-end microservices. We'll then look at ba\", \"ck -end microservices communicate with each other. We'll explore\\n\\nClient apps\\n\\nMobile app\\n\\nWeb app\\n\\n\", \"Microservice 1\\n\\nWeb API\\n\\nthe up and gRPC communication technology. Finally, we'll look new innovativ\", \"e communication patterns using service mesh technology. We'll also see how the Azure cloud provides \", \"different kinds of backing services to support cloud-native communication.\\n\\nWeb API\\n\\n## Front -end c\", \"lient communication\\n\\nIn a cloud -native system, front-end clients (mobile, web, and desktop applicat\", \"ions) require a communication channel to interact with independent back-end microservices.\\n\\n## What \", \"are the options?\\n\\nCloud container\\n\\nTo keep things simple, a front-end client could directly communic\", \"ate with the back-end microservices, shown in Figure 4-2.\\n\\nFigure 4 -2. Direct client to service com\", \"munication\\n\\n<!-- image -->\\n\\nWith this approach, each microservice has a public endpoint that is acce\", \"ssible by front-end clients. In a production environment, you'd place a load balancer in front of th\", \"e microservices, routing traffic proportionately.\\n\\nWhile simple to implement, direct client communic\", \"ation would be acceptable only for simple microservice applications. This pattern tightly couples fr\", \"ont-end clients to core back-end services, opening the door for many problems, including:\\n\\n- Client \", \"susceptibility to back-end service refactoring.\\n- A wider attack surface as core back -end services \", \"are directly exposed.\\n- Duplication of cross-cutting concerns across each microservice.\\n- Overly com\", \"plex client code - clients must keep track of multiple endpoints and handle failures in a resilient \", \"way.\\n\\nMobile app\\n\\nJSON\\n\\nInstead, a widely accepted cloud design pattern is to implement an API Gatew\", \"ay Service between the front -end applications and back-end services. The pattern is shown in Figure\", \" 4-3.\\n\\nJavaScript/Angular.js\\n\\nTraditional web app\\n\\nBrowser\\n\\nHTML\\n\\nFigure 4 -3. API gateway pattern\\n\\n\", \"<!-- image -->\\n\\nIn the previous figure, note how the API Gateway service abstracts the back-end core\", \" microservices. Implemented as a web API, it acts as a reverse proxy, routing incoming traffic to th\", \"e internal microservices.\\n\\nThe gateway insulates the client from internal service partitioning and r\", \"efactoring. If you change a back -end service, you accommodate for it in the gateway without breakin\", \"g the client. It's also your first line of defense for cross -cutting concerns, such as identity, ca\", \"ching, resiliency, metering, and throttling. Many of these cross-cutting concerns can be off-loaded \", \"from the back-end core services to the gateway, simplifying the back-end services.\\n\\nCare must be tak\", \"en to keep the API Gateway simple and fast. Typically, business logic is kept out of the gateway. A \", \"complex gateway risks becoming a bottleneck and eventually a monolith itself. Larger systems often e\", \"xpose multiple API Gateways segmented by client type (mobile, web, desktop) or back -end functionali\", \"ty. The Backend for Frontends pattern provides direction for implementing multiple gateways. The pat\", \"tern is shown in Figure 4-4.\\n\\n-\\n\\nCloud\\n\\nMicroservice 1\\n\\nWeb API\\n\\nWeb app\\n\\nMobile app\\n\\nDesktop app\\n\\nI\", \" Cloud\\n\\nWeb app\\n\\n(Microservice 1\\n\\nWeb AP!\\n\\n<!-- image -->\\n\\nHTML\\n\\nJSON\\n\\nJSON\\n\\nFigure 4 -4. Backend fo\", \"r frontend pattern\\n\\nNote in the previous figure how incoming traffic is sent to a specific API gatew\", \"ay - based upon client type: web, mobile, or desktop app. This approach makes sense as the capabilit\", \"ies of each device differ significantly across form factor, performance, and display limitations. Ty\", \"pically mobile applications expose less functionality than a browser or desktop applications. Each g\", \"ateway can be optimized to match the capabilities and functionality of the corresponding device.\\n\\n##\", \" Simple Gateways\\n\\nTo start, you could build your own API Gateway service. A quick search of GitHub w\", \"ill provide many examples.\\n\\nFor simple .NET cloud-native applications, you might consider the Ocelot\", \" Gateway. Open source and created for .NET microservices, it's lightweight, fast, scalable. Like any\", \" API Gateway, its primary functionality is to forward incoming HTTP requests to downstream services.\", \" Additionally, it supports a wide variety of capabilities that are configurable in a .NET middleware\", \" pipeline.\\n\\nYARP (Yet Another Reverse proxy) is another open source reverse proxy led by a group of \", \"Microsoft product teams. Downloadable as a NuGet package, YARP plugs into the ASP.NET framework as m\", \"iddleware and is highly customizable. You'll find YARP well-documented with various usage examples.\\n\", \"\\nFor enterprise cloud-native applications, there are several managed Azure services that can help ju\", \"mp-start your efforts.\\n\\nAPI gateway\\n\\nFront-End\\n\\nClient\\n\\nCloud\\n\\n## Azure Application Gateway\\n\\nMicrose\", \"rvice 1\\n\\nWeb API\\n\\ncontainer\\n\\nFor simple gateway requirements, you may consider Azure Application Gat\", \"eway. Available as an Azure PaaS service, it includes basic gateway features such as URL routing, SS\", \"L termination, and a Web Application Firewall. The service supports Layer-7 load balancing capabilit\", \"ies. With Layer 7, you can route requests based on the actual content of an HTTP message, not just l\", \"ow-level TCP network packets. Microservice 3\\n\\nWeb AP!\\n\\nThroughout this book, we evangelize hosting c\", \"loud-native systems in Kubernetes. A container orchestrator, Kubernetes automates the deployment, sc\", \"aling, and operational concerns of containerized workloads. Azure Application Gateway can be configu\", \"red as an API gateway for Azure Kubernetes Service cluster.\\n\\nThe Application Gateway Ingress Control\", \"ler enables Azure Application Gateway to work directly with Azure Kubernetes Service. Figure 4.5 sho\", \"ws the architecture.\\n\\nFigure 4 -5. Application Gateway Ingress Controller\\n\\n<!-- image -->\\n\\nKubernete\", \"s includes a built -in feature that supports HTTP (Level 7) load balancing, called Ingress . Ingress\", \" defines a set of rules for how microservice instances inside AKS can be exposed to the outside worl\", \"d. In the previous image, the ingress controller interprets the ingress rules configured for the clu\", \"ster and automatically configures the Azure Application Gateway. Based on those rules, the Applicati\", \"on Gateway routes traffic to microservices running inside AKS. The ingress controller listens for ch\", \"anges to ingress rules and makes the appropriate changes to the Azure Application Gateway.\\n\\n## Azure\", \" API Management\\n\\nFor moderate to large-scale cloud-native systems, you may consider Azure API Manage\", \"ment. It's a cloud -based service that not only solves your API Gateway needs, but provides a full-f\", \"eatured developer and administrative experience. API Management is shown in Figure 4-6.\\n\\nAzure Kuber\", \"netes\\n\\nService Cluster\\n\\nDevelopers\\n\\nApplications\\n\\nAdministrators\\n\\nI Cloud\\n\\nFigure 4 -6. Azure API Ma\", \"nagement\\n\\n<!-- image -->\\n\\nTo start, API Management exposes a gateway server that allows controlled a\", \"ccess to back-end services based upon configurable rules and policies. These services can be in the \", \"Azure cloud, your on-prem data center, or other public clouds. API keys and JWT tokens determine who\", \" can do what. All traffic is logged for analytical purposes.\\n\\nFor developers, API Management offers \", \"a developer portal that provides access to services, documentation, and sample code for invoking the\", \"m. Developers can use Swagger/Open API to inspect service endpoints and analyze their usage. The ser\", \"vice works across the major development platforms: .NET, Java, Golang, and more.\\n\\nThe publisher port\", \"al exposes a management dashboard where administrators expose APIs and manage their behavior. Servic\", \"e access can be granted, service health monitored, and service telemetry gathered. Administrators ap\", \"ply policies to each endpoint to affect behavior. Policies are pre-built statements that execute seq\", \"uentially for each service call. Policies are configured for an inbound call, outbound call, or invo\", \"ked upon an error. Policies can be applied at different service scopes as to enable deterministic or\", \"dering when combining policies. The product ships with a large number of prebuilt policies .\\n\\nHere a\", \"re examples of how policies can affect the behavior of your cloud-native services:\\n\\n- Restrict servi\", \"ce access.\\n- Enforce authentication.\\n- Throttle calls from a single source, if necessary.\\n- Enable c\", \"aching.\\n- Block calls from specific IP addresses.\\n\\n- Control the flow of the service.\\n- Convert requ\", \"ests from SOAP to REST or between different data formats, such as from XML to JSON.\\n\\nAzure API Manag\", \"ement can expose back-end services that are hosted anywhere \\u2013 in the cloud or your data center. For \", \"legacy services that you may expose in your cloud-native systems, it supports both REST and SOAP API\", \"s. Even other Azure services can be exposed through API Management. You could place a managed API on\", \" top of an Azure backing service like Azure Service Bus or Azure Logic Apps . Azure API Management d\", \"oesn't include built-in load-balancing support and should be used in conjunction with a load-balanci\", \"ng service.\\n\\nAzure API Management is available across four different tiers:\\n\\n- Developer\\n- Basic\\n- S\", \"tandard\\n- Premium\\n\\nThe Developer tier is meant for non-production workloads and evaluation. The othe\", \"r tiers offer progressively more power, features, and higher service level agreements (SLAs). The Pr\", \"emium tier provides Azure Virtual Network and multi-region support. All tiers have a fixed price per\", \" hour.\\n\\nThe Azure cloud also offers a serverless tier for Azure API Management. Referred to as the c\", \"onsumption pricing tier, the service is a variant of API Management designed around the serverless c\", \"omputing model. Unlike the \\\"pre-allocated\\\" pricing tiers previously shown, the consumption tier prov\", \"ides instant provisioning and pay-per-action pricing.\\n\\nIt enables API Gateway features for the follo\", \"wing use cases:\\n\\n- Microservices implemented using serverless technologies such as Azure Functions a\", \"nd Azure Logic Apps .\\n- Azure backing service resources such as Service Bus queues and topics, Azure\", \" storage, and others.\\n- Microservices where traffic has occasional large spikes but remains low most\", \" the time.\\n\\nThe consumption tier uses the same underlying service API Management components, but emp\", \"loys an entirely different architecture based on dynamically allocated resources. It aligns perfectl\", \"y with the serverless computing model:\\n\\n- No infrastructure to manage.\\n- No idle capacity.\\n- High-av\", \"ailability.\\n- Automatic scaling.\\n- Cost is based on actual usage.\\n\\nThe new consumption tier is a gre\", \"at choice for cloud-native systems that expose serverless resources as APIs.\\n\\n## Real -time communic\", \"ation\\n\\nReal -time, or push, communication is another option for front-end applications that communic\", \"ate with back -end cloud -native systems over HTTP. Applications, such as financial-tickers, online \", \"education, gaming, and job-progress updates, require instantaneous, real-time responses from the bac\", \"k -end. With normal HTTP communication, there's no way for the client to know when new data is avail\", \"able. The client must continually poll or send requests to the server. With real-time communication,\", \" the server can push new data to the client at any time.\\n\\nReal -time systems are often characterized\", \" by high-frequency data flows and large numbers of concurrent client connections. Manually implement\", \"ing real-time connectivity can quickly become complex, requiring non-trivial infrastructure to ensur\", \"e scalability and reliable messaging to connected clients. You could find yourself managing an insta\", \"nce of Azure Redis Cache and a set of load balancers configured with sticky sessions for client affi\", \"nity.\\n\\nAzure SignalR Service is a fully managed Azure service that simplifies real-time communicatio\", \"n for your cloud-native applications. Technical implementation details like capacity provisioning, s\", \"caling, and persistent connections are abstracted away. They're handled for you with a 99.9% service\", \"-level agreement. You focus on application features, not infrastructure plumbing.\\n\\nOnce enabled, a c\", \"loud-based HTTP service can push content updates directly to connected clients, including browser, m\", \"obile and desktop applications. Clients are updated without the need to poll the server. Azure Signa\", \"lR abstracts the transport technologies that create real-time connectivity, including WebSockets, Se\", \"rver-Side Events, and Long Polling. Developers focus on sending messages to all or specific subsets \", \"of connected clients.\\n\\nFigure 4-7 shows a set of HTTP Clients connecting to a Cloud-native applicati\", \"on with Azure SignalR enabled.\\n\\nClient 1 SPA Web app\\n\\nJavaScript/Angular.js\\n\\nClient 2 SPA Web app\\n\\nJ\", \"avaScript/Angular.js\\n\\nClient 3 SPA Web app\\n\\nJavaScript/Angular.js\\n\\n\\u2022 Cloud\\n\\nFigure 4 -7. Azure Signa\", \"lR\\n\\n<!-- image -->\\n\\nAnother advantage of Azure SignalR Service comes with implementing Serverless cl\", \"oud-native services. Perhaps your code is executed on demand with Azure Functions triggers. This sce\", \"nario can be tricky because your code doesn't maintain long connections with clients. Azure SignalR \", \"Service can handle this situation since the service already manages connections for you.\\n\\nAzure Sign\", \"alR Service closely integrates with other Azure services, such as Azure SQL Database, Service Bus, o\", \"r Redis Cache, opening up many possibilities for your cloud-native applications.\\n\\n## Service -to -se\", \"rvice communication\\n\\nMoving from the front-end client, we now address back-end microservices communi\", \"cate with each other.\\n\\nWhen constructing a cloud-native application, you'll want to be sensitive to \", \"how back-end services communicate with each other. Ideally, the less inter-service communication, th\", \"e better. However, avoidance isn't always possible as back-end services often rely on one another to\", \" complete an operation.\\n\\nThere are several widely accepted approaches to implementing cross-service \", \"communication. The type of communication interaction will often determine the best approach.\\n\\nConsid\", \"er the following interaction types:\\n\\n- Query \\u2013 when a calling microservice requires a response from \", \"a called microservice, such as, \\\"Hey, give me the buyer information for a given customer Id.\\\"\\n\\nMobil\", \"e app\\n\\n(Product Catalog\\n\\nMicroservice\\n\\n- Command \\u2013 when the calling microservice needs another micro\", \"service to execute an action but doesn't require a response, such as, \\\"Hey, just ship this order.\\\" 2\", \"\\n\\nJSON\\n\\nSPA web app\\n\\n- Event \\u2013 when a microservice, called the publisher, raises an event that state\", \" has changed or an action has occurred. Other microservices, called subscribers, who are interested,\", \" can react to the event appropriately. The publisher and the subscribers aren't aware of each other.\", \"\\n\\nMicroservice systems typically use a combination of these interaction types when executing operati\", \"ons that require cross-service interaction. Let's take a close look at each and how you might implem\", \"ent them.\\n\\nPricing\\n\\nMicroservice\\n\\nMany times, one microservice might need to query another, requirin\", \"g an immediate response to complete an operation. A shopping basket microservice may need product in\", \"formation and a price to add an item to its basket. There are many approaches for implementing query\", \" operations.\\n\\n## Request/Response Messaging\\n\\nOne option for implementing this scenario is for the ca\", \"lling back-end microservice to make direct HTTP requests to the microservices it needs to query, sho\", \"wn in Figure 4-8.\\n\\nFigure 4 -8. Direct HTTP communication\\n\\n<!-- image -->\\n\\nWhile direct HTTP calls b\", \"etween microservices are relatively simple to implement, care should be taken to minimize this pract\", \"ice. To start, these calls are always synchronous and will block the operation until a result is ret\", \"urned or the request times outs. What were once self-contained, independent services, able to evolve\", \" independently and deploy frequently, now become coupled to each other. As coupling among microservi\", \"ces increase, their architectural benefits diminish.\\n\\n/ Cloud\\n\\n## Queries\\n\\nMobile app\\n\\nJSON\\n\\nSPA web\", \" app\\n\\nJSON\\n\\nJavaScript/Angularjs\\n\\nAdd\\n\\nItem http://\\n\\nExecuting an infrequent request that makes a si\", \"ngle direct HTTP call to another microservice might be acceptable for some systems. However, high-vo\", \"lume calls that invoke direct HTTP calls to multiple microservices aren't advisable. They can increa\", \"se latency and negatively impact the performance, scalability, and availability of your system. Even\", \" worse, a long series of direct HTTP communication can lead to deep and complex chains of synchronou\", \"s microservices calls, shown in Figure 4-9:\\n\\nFigure 4 -9. Chaining HTTP queries\\n\\n<!-- image -->\\n\\nYou\", \" can certainly imagine the risk in the design shown in the previous image. What happens if Step #3 f\", \"ails? Or Step #8 fails? How do you recover? What if Step #6 is slow because the underlying service i\", \"s busy? How do you continue? Even if all works correctly, think of the latency this call would incur\", \", which is the sum of the latency of each step.\\n\\nThe large degree of coupling in the previous image \", \"suggests the services weren't optimally modeled. It would behoove the team to revisit their design.\\n\", \"\\n## Materialized View pattern\\n\\nA popular option for removing microservice coupling is the Materializ\", \"ed View pattern. With this pattern, a microservice stores its own local, denormalized copy of data t\", \"hat's owned by other services. Instead of the Shopping Basket microservice querying the Product Cata\", \"log and Pricing microservices, it maintains its own local copy of that data. This pattern eliminates\", \" unnecessary coupling and improves reliability and response time. The entire operation executes insi\", \"de a single process. We explore this pattern and other data concerns in Chapter 5.\\n\\n## Service Aggre\", \"gator Pattern\\n\\nAnother option for eliminating microservice-to-microservice coupling is an Aggregator\", \" microservice , shown in purple in Figure 4-10.\\n\\n\\u0413\\n\\nCloud\\n\\n- -\\n\\nAPI Gateway\\n\\n1\\n\\nShopping Basket\\n\\nMic\", \"roservice\\n\\nMobile app\\n\\nSPA web app\\n\\nJavaScript/Angular.js\\n\\nProduct Lookup http:/l\\n\\nProduct Catalog\\n\\n\", \"Microservice\\n\\nFigure 4 -10. Aggregator microservice\\n\\n<!-- image -->\\n\\nThe pattern isolates an operati\", \"on that makes calls to multiple back-end microservices, centralizing its logic into a specialized mi\", \"croservice. The purple checkout aggregator microservice in the previous figure orchestrates the work\", \"flow for the Checkout operation. It includes calls to several back-end microservices in a sequenced \", \"order. Data from the workflow is aggregated and returned to the caller. While it still implements di\", \"rect HTTP calls, the aggregator microservice reduces direct dependencies among back-end microservice\", \"s.\\n\\n## Request/Reply Pattern\\n\\nAnother approach for decoupling synchronous HTTP messages is a Request\", \"-Reply Pattern, which uses queuing communication. Communication using a queue is always a one-way ch\", \"annel, with a producer sending the message and consumer receiving it. With this pattern, both a requ\", \"est queue and response queue are implemented, shown in Figure 4-11.\\n\\n| Cloud\\n\\nCheckout\\n\\n\\u0413\\n\\nCloud\\n\\nAP\", \"I Gateway\\n\\nService\\n\\nRequest Message\\n\\nProduct Id = 557\\n\\nFigure 4 -11. Request -reply pattern\\n\\n<!-- im\", \"age -->\\n\\nHere, the message producer creates a query-based message that contains a unique correlation\", \" ID and places it into a request queue. The consuming service dequeues the messages, processes it an\", \"d places the response into the response queue with the same correlation ID. The producer service deq\", \"ueues the message, matches it with the correlation ID and continues processing. We cover queues in d\", \"etail in the next section.\\n\\n## Commands\\n\\nAnother type of communication interaction is a command. A m\", \"icroservice may need another microservice to perform an action. The Ordering microservice may need t\", \"he Shipping microservice to create a shipment for an approved order. In Figure 4-12, one microservic\", \"e, called a Producer, sends a message to another microservice, the Consumer, commanding it to do som\", \"ething.\\n\\nhoppingBasket Microservice \\\\\\n\\nCloud\\n\\nAPI Gateway\\n\\nService\\n\\nFigure 4 -12. Command interactio\", \"n with a queue\\n\\n<!-- image -->\\n\\nMost often, the Producer doesn't require a response and can fire-and\", \"-forget the message. If a reply is needed, the Consumer sends a separate message back to Producer on\", \" another channel. A command message is best sent asynchronously with a message queue. supported by a\", \" lightweight message broker. In the previous diagram, note how a queue separates and decouples both \", \"services.\\n\\nA message queue is an intermediary construct through which a producer and consumer pass a\", \" message. Queues implement an asynchronous, point-to-point messaging pattern. The Producer knows whe\", \"re a command needs to be sent and routes appropriately. The queue guarantees that a message is proce\", \"ssed by exactly one of the consumer instances that are reading from the channel. In this scenario, e\", \"ither the producer or consumer service can scale out without affecting the other. As well, technolog\", \"ies can be disparate on each side, meaning that we might have a Java microservice calling a Golang m\", \"icroservice.\\n\\nIn chapter 1, we talked about backing services. Backing services are ancillary resourc\", \"es upon which cloud -native systems depend. Message queues are backing services. The Azure cloud sup\", \"ports two types of message queues that your cloud-native systems can consume to implement command me\", \"ssaging: Azure Storage Queues and Azure Service Bus Queues.\\n\\n## Azure Storage Queues\\n\\nAzure storage \", \"queues offer a simple queueing infrastructure that is fast, affordable, and backed by Azure storage \", \"accounts.\\n\\nAzure Storage Queues feature a REST-based queuing mechanism with reliable and persistent \", \"messaging. They provide a minimal feature set, but are inexpensive and store millions of messages. T\", \"heir capacity ranges up to 500 TB. A single message can be up to 64 KB in size.\\n\\nYou can access mess\", \"ages from anywhere in the world via authenticated calls using HTTP or HTTPS. Storage queues can scal\", \"e out to large numbers of concurrent clients to handle traffic spikes.\\n\\nQueue 1\\n\\nThat said, there ar\", \"e limitations with the service:\\n\\n- Message order isn't guaranteed.\\n- A message can only persist for \", \"seven days before it's automatically removed.\\n- Support for state management, duplicate detection, o\", \"r transactions isn't available.\\n\\nFigure 4-13 shows the hierarchy of an Azure Storage Queue.\\n\\nFigure \", \"4 -13. Storage queue hierarchy\\n\\n<!-- image -->\\n\\nIn the previous figure, note how storage queues stor\", \"e their messages in the underlying Azure Storage account.\\n\\nFor developers, Microsoft provides severa\", \"l client and server-side libraries for Storage queue processing. Most major platforms are supported \", \"including .NET, Java, JavaScript, Ruby, Python, and Go. Developers should never communicate directly\", \" with these libraries. Doing so will tightly couple your microservice code to the Azure Storage Queu\", \"e service. It's a better practice to insulate the implementation details of the API. Introduce an in\", \"termediation layer, or intermediate API, that exposes generic operations and encapsulates the concre\", \"te library. This loose coupling enables you to swap out one queuing service for another without havi\", \"ng to make changes to the mainline service code.\\n\\nAzure Storage queues are an economical option to i\", \"mplement command messaging in your cloudnative applications. Especially when a queue size will excee\", \"d 80 GB, or a simple feature set is acceptable. You only pay for the storage of the messages; there \", \"are no fixed hourly charges.\\n\\n## Azure Service Bus Queues\\n\\nFor more complex messaging requirements, \", \"consider Azure Service Bus queues.\\n\\nSitting atop a robust message infrastructure, Azure Service Bus \", \"supports a brokered messaging model . Messages are reliably stored in a broker (the queue) until rec\", \"eived by the consumer. The queue guarantees First-In/First-Out (FIFO) message delivery, respecting t\", \"he order in which messages were added to the queue.\\n\\nThe size of a message can be much larger, up to\", \" 256 KB. Messages are persisted in the queue for an unlimited period of time. Service Bus supports n\", \"ot only HTTP-based calls, but also provides full\\n\\nMessage 1\\n\\nMessage 2\\n\\nProvider 1\\n\\nsupport for the \", \"AMQP protocol. AMQP is an open-standard across vendors that supports a binary protocol and higher de\", \"grees of reliability.\\n\\nService Bus provides a rich set of features, including transaction support an\", \"d a duplicate detection feature. The queue guarantees \\\"at most once delivery\\\" per message. It automa\", \"tically discards a message that has already been sent. If a producer is in doubt, it can resend the \", \"same message, and Service Bus guarantees that only one copy will be processed. Duplicate detection f\", \"rees you from having to build additional infrastructure plumbing.\\n\\nTwo more enterprise features are \", \"partitioning and sessions. A conventional Service Bus queue is handled by a single message broker an\", \"d stored in a single message store. But, Service Bus Partitioning spreads the queue across multiple \", \"message brokers and message stores. The overall throughput is no longer limited by the performance o\", \"f a single message broker or messaging store. A temporary outage of a messaging store doesn't render\", \" a partitioned queue unavailable.\\n\\nService Bus Sessions provide a way to group-related messages. Ima\", \"gine a workflow scenario where messages must be processed together and the operation completed at th\", \"e end. To take advantage, sessions must be explicitly enabled for the queue and each related message\", \"d must contain the same session ID.\\n\\nHowever, there are some important caveats: Service Bus queues s\", \"ize is limited to 80 GB, which is much smaller than what's available from store queues. Additionally\", \", Service Bus queues incur a base cost and charge per operation.\\n\\nFigure 4-14 outlines the high-leve\", \"l architecture of a Service Bus queue.\\n\\nFigure 4 -14. Service Bus queue\\n\\n<!-- image -->\\n\\nIn the prev\", \"ious figure, note the point-to-point relationship. Two instances of the same provider are enqueuing \", \"messages into a single Service Bus queue. Each message is consumed by only one of three consumer ins\", \"tances on the right. Next, we discuss how to implement messaging where different consumers may all b\", \"e interested the same message.\\n\\n## Events\\n\\nMessage queuing is an effective way to implement communic\", \"ation where a producer can asynchronously send a consumer a message. However, what happens when many\", \" different consumers\\n\\nService Bus\\n\\nConsumer 1\\n\\n\\u0413\\n\\nCloud\\n\\nAPI Gateway\\n\\nService\\n\\nOrdering Microservice\", \" are interested in the same message? A dedicated message queue for each consumer wouldn't scale well\", \" and would become difficult to manage. Checkout Event \\u2192 Create Order\\n\\nCheckout\\n\\n4\\n\\nTo address this s\", \"cenario, we move to the third type of message interaction, the event. One microservice announces tha\", \"t an action had occurred. Other microservices, if interested, react to the action, or event. This is\", \" also known as the event-driven architectural style .\\n\\nService\\n\\nEventing is a two-step process. For \", \"a given state change, a microservice publishes an event to a message broker, making it available to \", \"any other interested microservice. The interested microservice is notified by subscribing to the eve\", \"nt in the message broker. You use the Publish/Subscribe pattern to implement event-based communicati\", \"on .\\n\\nFigure 4-15 shows a shopping basket microservice publishing an event with two other microservi\", \"ces subscribing to it.\\n\\nFigure 4 -15. Event -Driven messaging\\n\\n<!-- image -->\\n\\nNote the event bus co\", \"mponent that sits in the middle of the communication channel. It's a custom class that encapsulates \", \"the message broker and decouples it from the underlying application. The ordering and inventory micr\", \"oservices independently operate the event with no knowledge of each other, nor the shopping basket m\", \"icroservice. When the registered event is published to the event bus, they act upon it.\\n\\nWith eventi\", \"ng, we move from queuing technology to topics. A topic is similar to a queue, but supports a one-to \", \"-many messaging pattern. One microservice publishes a message. Multiple subscribing microservices ca\", \"n choose to receive and act upon that message. Figure 4-16 shows a topic architecture.\\n\\nPublisher 1\\n\", \"\\nPublisher 2\\n\\n\\\"GetPriceRule\\\"\\n\\nPrice Subscription\\n\\nFigure 4 -16. Topic architecture\\n\\n<!-- image -->\\n\\n\", \"In the previous figure, publishers send messages to the topic. At the end, subscribers receive messa\", \"ges from subscriptions. In the middle, the topic forwards messages to subscriptions based on a set o\", \"f rules, shown in dark blue boxes. Rules act as a filter that forward specific messages to a subscri\", \"ption. Here, a \\\"GetPrice\\\" event would be sent to the price and logging subscriptions as the logging \", \"subscription has chosen to receive all messages. A \\\"GetInformation\\\" event would be sent to the infor\", \"mation and logging subscriptions.\\n\\nThe Azure cloud supports two different topic services: Azure Serv\", \"ice Bus Topics and Azure EventGrid.\\n\\n## Azure Service Bus Topics\\n\\nSitting on top of the same robust \", \"brokered message model of Azure Service Bus queues are Azure Service Bus Topics. A topic can receive\", \" messages from multiple independent publishers and send messages to up to 2,000 subscribers. Subscri\", \"ptions can be dynamically added or removed at run time without stopping the system or recreating the\", \" topic.\\n\\nMany advanced features from Azure Service Bus queues are also available for topics, includi\", \"ng Duplicate Detection and Transaction support. By default, Service Bus topics are handled by a sing\", \"le message broker and stored in a single message store. But, Service Bus Partitioning scales a topic\", \" by spreading it across many message brokers and message stores.\\n\\nScheduled Message Delivery tags a \", \"message with a specific time for processing. The message won't appear in the topic before that time.\", \" Message Deferral enables you to defer a retrieval of a message to a later time. Both are commonly u\", \"sed in workflow processing scenarios where operations are processed in a particular order. You can p\", \"ostpone processing of received messages until prior work has been completed.\\n\\nService Bus topics are\", \" a robust and proven technology for enabling publish/subscribe communication in your cloud-native sy\", \"stems.\\n\\n## Azure Event Grid\\n\\nWhile Azure Service Bus is a battle -tested messaging broker with a ful\", \"l set of enterprise features, Azure Event Grid is the new kid on the block.\\n\\nBlob Storage\\n\\nAt first \", \"glance, Event Grid may look like just another topic-based messaging system. However, it's different \", \"in many ways. Focused on event-driven workloads, it enables real-time event processing, deep Azure i\", \"ntegration, and an open-platform - all on serverless infrastructure. It's designed for contemporary \", \"cloud-native and serverless applications Azure Automation\\n\\nAs a centralized eventing backplane, or p\", \"ipe, Event Grid reacts to events inside Azure resources and from your own services. WebHooks\\n\\nEvent \", \"notifications are published to an Event Grid Topic, which, in turn, routes each event to a subscript\", \"ion. Subscribers map to subscriptions and consume the events. Like Service Bus, Event Grid supports \", \"a filtered subscriber model where a subscription sets rule for the events it wishes to receive. Even\", \"t Grid provides fast throughput with a guarantee of 10 million events per second enabling near real \", \"-time delivery - far more than what Azure Service Bus can generate.\\n\\nA sweet spot for Event Grid is \", \"its deep integration into the fabric of Azure infrastructure. An Azure resource, such as Cosmos DB, \", \"can publish built-in events directly to other interested Azure resources without the need for custom\", \" code. Event Grid can publish events from an Azure Subscription, Resource Group, or Service, giving \", \"developers fine-grained control over the lifecycle of cloud resources. However, Event Grid isn't lim\", \"ited to Azure. It's an open platform that can consume custom HTTP events published from applications\", \" or third-party services and route events to external subscribers.\\n\\nWhen publishing and subscribing \", \"to native events from Azure resources, no coding is required. With simple configuration, you can int\", \"egrate events from one Azure resource to another leveraging built-in plumbing for Topics and Subscri\", \"ptions. Figure 4-17 shows the anatomy of Event Grid.\\n\\nFigure 4 -17. Event Grid anatomy\\n\\n<!-- image -\", \"->\\n\\nTopics\\n\\nEvent Subscriptions\\n\\nA major difference between EventGrid and Service Bus is the underly\", \"ing message exchange pattern .\\n\\nService Bus implements an older style pull model in which the downst\", \"ream subscriber actively polls the topic subscription for new messages. On the upside, this approach\", \" gives the subscriber full control of the pace at which it processes messages. It controls when and \", \"how many messages to process at any given time. Unread messages remain in the subscription until pro\", \"cessed. A significant shortcoming is the latency between the time the event is generated and the pol\", \"ling operation that pulls that message to the subscriber for processing. Also, the overhead of const\", \"ant polling for the next event consumes resources and money.\\n\\nEventGrid, however, is different. It i\", \"mplements a push model in which events are sent to the EventHandlers as received, giving near real-t\", \"ime event delivery. It also reduces cost as the service is triggered only when it's needed to consum\", \"e an event \\u2013 not continually as with polling. That said, an event handler must handle the incoming l\", \"oad and provide throttling mechanisms to protect itself from becoming overwhelmed. Many Azure servic\", \"es that consume these events, such as Azure Functions and Logic Apps provide automatic autoscaling c\", \"apabilities to handle increased loads.\\n\\nEvent Grid is a fully managed serverless cloud service. It d\", \"ynamically scales based on your traffic and charges you only for your actual usage, not pre-purchase\", \"d capacity. The first 100,000 operations per month are free \\u2013 operations being defined as event ingr\", \"ess (incoming event notifications), subscription delivery attempts, management calls, and filtering \", \"by subject. With 99.99% availability, EventGrid guarantees the delivery of an event within a 24-hour\", \" period, with built-in retry functionality for unsuccessful delivery. Undelivered messages can be mo\", \"ved to a \\\"dead-letter\\\" queue for resolution. Unlike Azure Service Bus, Event Grid is tuned for fast \", \"performance and doesn't support features like ordered messaging, transactions, and sessions.\\n\\n## Str\", \"eaming messages in the Azure cloud\\n\\nAzure Service Bus and Event Grid provide great support for appli\", \"cations that expose single, discrete events like a new document has been inserted into a Cosmos DB. \", \"But, what if your cloud-native system needs to process a stream of related events? Event streams are\", \" more complex. They're typically time -ordered, interrelated, and must be processed as a group.\\n\\nAzu\", \"re Event Hub is a data streaming platform and event ingestion service that collects, transforms, and\", \" stores events. It's fine -tuned to capture streaming data, such as continuous event notifications e\", \"mitted from a telemetry context. The service is highly scalable and can store and process millions o\", \"f events per second. Shown in Figure 4-18, it's often a front door for an event pipeline, decoupling\", \" ingest stream from event consumption.\\n\\nEvent\\n\\nProducer\\n\\nEvent Producers\\n\\nEvent\\n\\nProducer\\n\\nEvent\\n\\nPr\", \"oducer\\n\\nEvent\\n\\nConsumer\\n\\nAzure Event Hubs\\n\\nPartition 1\\n\\nConsumer\\n\\nGroup\\n\\nFigure 4 -18. Azure Event H\", \"ub\\n\\n<!-- image -->\\n\\nEvent Hub supports low latency and configurable time retention. Unlike queues an\", \"d topics, Event Hubs keep event data after it's been read by a consumer. This feature enables other \", \"data analytic services, both internal and external, to replay the data for further analysis. Events \", \"stored in event hub are only deleted upon expiration of the retention period, which is one day by de\", \"fault, but configurable.\\n\\nEvent Hub supports common event publishing protocols including HTTPS and A\", \"MQP. It also supports Kafka 1.0. Existing Kafka applications can communicate with Event Hub using th\", \"e Kafka protocol providing an alternative to managing large Kafka clusters. Many open-source cloud-n\", \"ative systems embrace Kafka.\\n\\nEvent Hubs implements message streaming through a partitioned consumer\", \" model in which each consumer only reads a specific subset, or partition, of the message stream. Thi\", \"s pattern enables tremendous horizontal scale for event processing and provides other stream-focused\", \" features that are unavailable in queues and topics. A partition is an ordered sequence of events th\", \"at is held in an event hub. As newer events arrive, they're added to the end of this sequence. Figur\", \"e 4-19 shows partitioning in an Event Hub.\\n\\nFigure 4 -19. Event Hub partitioning\\n\\n<!-- image -->\\n\\nIn\", \"stead of reading from the same resource, each consumer group reads across a subset, or partition, of\", \" the message stream.\\n\\nEvent\\n\\nEvent Receivers\\n\\nFor cloud -native applications that must stream large \", \"numbers of events, Azure Event Hub can be a robust and affordable solution.\\n\\n## gRPC\\n\\nSo far in this\", \" book, we've focused on REST -based communication. We've seen that REST is a flexible architectural \", \"style that defines CRUD-based operations against entity resources. Clients interact with resources a\", \"cross HTTP with a request/response communication model. While REST is widely implemented, a newer co\", \"mmunication technology, gRPC, has gained tremendous momentum across the cloud -native community.\\n\\n##\", \" What is gRPC?\\n\\ngRPC is a modern, high-performance framework that evolves the age-old remote procedu\", \"re call (RPC) protocol. At the application level, gRPC streamlines messaging between clients and bac\", \"k-end services. Originating from Google, gRPC is open source and part of the Cloud Native Computing \", \"Foundation (CNCF) ecosystem of cloud-native offerings. CNCF considers gRPC an incubating project. In\", \"cubating means end users are using the technology in production applications, and the project has a \", \"healthy number of contributors.\\n\\nA typical gRPC client app will expose a local, in-process function \", \"that implements a business operation. Under the covers, that local function invokes another function\", \" on a remote machine. What appears to be a local call essentially becomes a transparent out-of-proce\", \"ss call to a remote service. The RPC plumbing abstracts the point-to-point networking communication,\", \" serialization, and execution between computers.\\n\\nIn cloud -native applications, developers often wo\", \"rk across programming languages, frameworks, and technologies. This interoperability complicates mes\", \"sage contracts and the plumbing required for cross-platform communication. gRPC provides a \\\"uniform \", \"horizontal layer\\\" that abstracts these concerns. Developers code in their native platform focused on\", \" business functionality, while gRPC handles communication plumbing.\\n\\ngRPC offers comprehensive suppo\", \"rt across most popular development stacks, including Java, JavaScript, C#, Go, Swift, and NodeJS.\\n\\n#\", \"# gRPC Benefits\\n\\ngRPC uses HTTP/2 for its transport protocol. While compatible with HTTP 1.1, HTTP/2\", \" features many advanced capabilities:\\n\\n- A binary framing protocol for data transport - unlike HTTP \", \"1.1, which is text based.\\n- Multiplexing support for sending multiple parallel requests over the sam\", \"e connection HTTP 1.1 limits processing to one request/response message at a time.\\n- Bidirectional f\", \"ull -duplex communication for sending both client requests and server responses simultaneously.\\n- Bu\", \"ilt -in streaming enabling requests and responses to asynchronously stream large data sets.\\n- Header\", \" compression that reduces network usage.\\n\\ngRPC is lightweight and highly performant. It can be up to\", \" 8x faster than JSON serialization with messages 60 -80% smaller. In Microsoft Windows Communication\", \" Foundation (WCF) parlance, gRPC performance exceeds the speed and efficiency of the highly optimize\", \"d NetTCP bindings. Unlike NetTCP, which favors the Microsoft stack, gRPC is cross-platform.\\n\\n## Prot\", \"ocol Buffers\\n\\ngRPC embraces an open-source technology called Protocol Buffers. They provide a highly\", \" efficient and platform-neutral serialization format for serializing structured messages that servic\", \"es send to each other. Using a cross-platform Interface Definition Language (IDL), developers define\", \" a service contract for each microservice. The contract, implemented as a text-based .proto file, de\", \"scribes the methods, inputs, and outputs for each service. The same contract file can be used for gR\", \"PC clients and services built on different development platforms.\\n\\nUsing the proto file, the Protobu\", \"f compiler, protoc, generates both client and service code for your target platform. The code includ\", \"es the following components:\\n\\n- Strongly typed objects, shared by the client and service, that repre\", \"sent the service operations and data elements for a message.\\n- A strongly typed base class with the \", \"required network plumbing that the remote gRPC service can inherit and extend.\\n- A client stub that \", \"contains the required plumbing to invoke the remote gRPC service.\\n\\nAt run time, each message is seri\", \"alized as a standard Protobuf representation and exchanged between the client and remote service. Un\", \"like JSON or XML, Protobuf messages are serialized as compiled binary bytes.\\n\\nThe book, gRPC for WCF\", \" Developers, available from the Microsoft Architecture site, provides in-depth coverage of gRPC and \", \"Protocol Buffers.\\n\\n## gRPC support in .NET\\n\\ngRPC is integrated into .NET Core 3.0 SDK and later. The\", \" following tools support it:\\n\\n- Visual Studio 2022 with the ASP.NET and web development workload ins\", \"talled\\n- Visual Studio Code\\n- The dotnet CLI\\n\\nThe SDK includes tooling for endpoint routing, built-i\", \"n IoC, and logging. The open-source Kestrel web server supports HTTP/2 connections. Figure 4-20 show\", \"s a Visual Studio 2022 template that scaffolds a skeleton project for a gRPC service. Note how .NET \", \"fully supports Windows, Linux, and macOS.\\n\\nSolution Explorer\\n\\nSearch Solution Explorer (Ctri+:)\\n\\na S\", \"olution 'GrpcServicel\\\" (1 of 1 project)\\n\\nCreate a new project\\n\\n@ Connected Services\\n\\n88 Dependencies\", \"\\n\\nRecent project templates\\n\\n5 Properties gic ASP.NET Core gRPC Service\\n\\n\\u2022 E Protos\\n\\n\\u2022 greet.proto\\n\\nF\", \"o ASP.NET Core Web API\\n\\n\\u2022 E Services\\n\\n\\u2022 C# GreeterService.cs\\n\\n\\u2022 appsettings.json\\n\\n\\u203a Azure Functions\\n\", \"\\n\\u2022 C# Program.cs\\n\\nFigure 4 -20. gRPC support in Visual Studio 2022\\n\\n<!-- image -->\\n\\nFigure 4-21 show\", \"s the skeleton gRPC service generated from the built-in scaffolding included in Visual Studio 2022.\\n\", \"\\nFigure 4 -21. gRPC project in Visual Studio 2022\\n\\n<!-- image -->\\n\\nIn the previous figure, note the \", \"proto description file and service code. As you'll see shortly, Visual Studio generates additional c\", \"onfiguration in both the Startup class and underlying project file.\\n\\n## gRPC usage\\n\\nFavor gRPC for t\", \"he following scenarios:\\n\\n- Synchronous backend microservice-to-microservice communication where an i\", \"mmediate response is required to continue processing.\\n- Polyglot environments that need to support m\", \"ixed programming platforms.\\n- Low latency and high throughput communication where performance is cri\", \"tical.\\n- Point -to -point real-time communication - gRPC can push messages in real time without poll\", \"ing and has excellent support for bi-directional streaming.\\n\\ngrpc\\n\\nAll languages\\n\\nP\\n\\nAll platforms\\n\\n\", \"All project types\\n\\nClear all\\n\\nX\\n\\nAPI Gateways / BFF\\n\\n\\\"Shopping\\\"\\n\\n- Network constrained environments \", \"\\u2013 binary gRPC messages are always smaller than an equivalent text-based JSON message.\\n\\nAt the time, \", \"of this writing, gRPC is primarily used with backend services. Modern browsers can't provide the lev\", \"el of HTTP/2 control required to support a front-end gRPC client. That said, there's support for gRP\", \"C-Web with .NET that enables gRPC communication from browser-based apps built with JavaScript or Bla\", \"zor WebAssembly technologies. gRPC-Web enables an ASP.NET Core gRPC app to support gRPC features in \", \"browser apps:\\n\\n- Strongly typed, code-generated clients\\n- Compact Protobuf messages\\n- Server streami\", \"ng\\n\\n## gRPC implementation\\n\\n\\\"Marketing\\\"\\n\\nmicroservices\\n\\nThe microservice reference architecture, eSh\", \"op on Containers, from Microsoft, shows how to implement gRPC services in .NET applications. Figure \", \"4-22 presents the back-end architecture.\\n\\nWeb-Marketing\\n\\nFigure 4 -22. Backend architecture for eSho\", \"p on Containers\\n\\n<!-- image -->\\n\\nIn the previous figure, note how eShop embraces the Backend for Fro\", \"ntends pattern (BFF) by exposing multiple API gateways. We discussed the BFF pattern earlier in this\", \" chapter. Pay close\\n\\nCloud\\n\\nHTTP/2\\n\\n--'GRPG\\n\\ngRPC\\n\\nServer\\n\\nOrdering\\n\\nMicroservice attention to the A\", \"ggregator microservice (in gray) that sits between the Web-Shopping API Gateway and backend Shopping\", \" microservices. The Aggregator receives a single request from a client, dispatches it to various mic\", \"roservices, aggregates the results, and sends them back to the requesting client. Such operations ty\", \"pically require synchronous communication as to produce an immediate response. In eShop, backend cal\", \"ls from the Aggregator are performed using gRPC as shown in Figure 4 -23.\\n\\nMicroservice\\n\\nFigure 4 -2\", \"3. gRPC in eShop on Containers\\n\\n<!-- image -->\\n\\ngRPC communication requires both client and server c\", \"omponents. In the previous figure, note how the Shopping Aggregator implements a gRPC client. The cl\", \"ient makes synchronous gRPC calls (in red) to backend microservices, each of which implement a gRPC \", \"server. Both the client and server take advantage of the built-in gRPC plumbing from the .NET SDK. C\", \"lient-side stubs provide the plumbing to invoke remote gRPC calls. Server-side components provide gR\", \"PC plumbing that custom service classes can inherit and consume.\\n\\nMicroservices that expose both a R\", \"ESTful API and gRPC communication require multiple endpoints to manage traffic. You would open an en\", \"dpoint that listens for HTTP traffic for the RESTful calls and another for gRPC calls. The gRPC endp\", \"oint must be configured for the HTTP/2 protocol that is required for gRPC communication.\\n\\nWhile we s\", \"trive to decouple microservices with asynchronous communication patterns, some operations require di\", \"rect calls. gRPC should be the primary choice for direct synchronous communication between microserv\", \"ices. Its high-performance communication protocol, based on HTTP/2 and protocol buffers, make it a p\", \"erfect choice.\\n\\nCloud\\n\\nSidecar Proxy\\n\\nHTTP\\n\\n## Looking ahead\\n\\nSidecar Proxy\\n\\nMicroservice\\n\\nSidecar P\", \"roxy\\n\\nMicroservice\\n\\nLooking ahead, gRPC will continue to gain traction for cloud-native systems. The\", \" performance benefits and ease of development are compelling. However, REST will likely be around fo\", \"r a long time. It excels for publicly exposed APIs and for backward compatibility reasons.\\n\\nSidecar \", \"Proxy\\n\\nSidecar Proxy\\n\\nSidecar Proxy\\n\\n## Service Mesh communication infrastructure\\n\\nThroughout this c\", \"hapter, we've explored the challenges of microservice communication. We said that development teams \", \"need to be sensitive to how back-end services communicate with each other. Ideally, the less inter-s\", \"ervice communication, the better. However, avoidance isn't always possible as back -end services oft\", \"en rely on one another to complete operations.\\n\\nWe explored different approaches for implementing sy\", \"nchronous HTTP communication and asynchronous messaging. In each of the cases, the developer is burd\", \"ened with implementing communication code. Communication code is complex and time intensive. Incorre\", \"ct decisions can lead to significant performance issues.\\n\\nA more modern approach to microservice com\", \"munication centers around a new and rapidly evolving technology entitled Service Mesh. A service mes\", \"h is a configurable infrastructure layer with built-in capabilities to handle service-to-service com\", \"munication, resiliency, and many cross-cutting concerns. It moves the responsibility for these conce\", \"rns out of the microservices and into service mesh layer. Communication is abstracted away from your\", \" microservices.\\n\\nA key component of a service mesh is a proxy. In a cloud-native application, an ins\", \"tance of a proxy is typically colocated with each microservice. While they execute in separate proce\", \"sses, the two are closely linked and share the same lifecycle. This pattern, known as the Sidecar pa\", \"ttern, and is shown in Figure 4-24.\\n\\nFigure 4 -24. Service mesh with a side car\\n\\n<!-- image -->\\n\\ngRP\", \"C\\n\\nNote in the previous figure how messages are intercepted by a proxy that runs alongside each micr\", \"oservice. Each proxy can be configured with traffic rules specific to the microservice. It understan\", \"ds messages and can route them across your services and the outside world.\\n\\nAlong with managing serv\", \"ice-to-service communication, the Service Mesh provides support for service discovery and load balan\", \"cing.\\n\\nOnce configured, a service mesh is highly functional. The mesh retrieves a corresponding pool\", \" of instances from a service discovery endpoint. It sends a request to a specific service instance, \", \"recording the latency and response type of the result. It chooses the instance most likely to return\", \" a fast response based on different factors, including the observed latency for recent requests.\\n\\nA \", \"service mesh manages traffic, communication, and networking concerns at the application level. It un\", \"derstands messages and requests. A service mesh typically integrates with a container orchestrator. \", \"Kubernetes supports an extensible architecture in which a service mesh can be added.\\n\\nIn chapter 6, \", \"we deep-dive into Service Mesh technologies including a discussion on its architecture and available\", \" open-source implementations.\\n\\n## Summary\\n\\nIn this chapter, we discussed cloud-native communication \", \"patterns. We started by examining how front -end clients communicate with back -end microservices. A\", \"long the way, we talked about API Gateway platforms and real-time communication. We then looked at h\", \"ow microservices communicate with other back -end services. We looked at both synchronous HTTP commu\", \"nication and asynchronous messaging across services. We covered gRPC, an upcoming technology in the \", \"cloudnative world. Finally, we introduced a new and rapidly evolving technology entitled Service Mes\", \"h that can streamline microservice communication.\\n\\nSpecial emphasis was on managed Azure services th\", \"at can help implement communication in cloudnative systems:\\n\\n- Azure Application Gateway\\n- Azure API\", \" Management\\n- Azure SignalR Service\\n- Azure Storage Queues\\n- Azure Service Bus\\n- Azure Event Grid\\n- \", \"Azure Event Hub\\n\\nWe next move to distributed data in cloud -native systems and the benefits and chal\", \"lenges that it presents.\\n\\n## References\\n\\n- .NET Microservices: Architecture for Containerized .NET a\", \"pplications\\n- Designing Interservice Communication for Microservices\\n- Azure SignalR Service, a full\", \"y managed service to add real-time functionality\\n\\n- Azure API Gateway Ingress Controller\\n- gRPC Docu\", \"mentation\\n- gRPC for WCF Developers\\n- Comparing gRPC Services with HTTP APIs\\n- Building gRPC Service\", \"s with .NET video\\n\\nMonolithic Application\\n\\nMy Web Application\\n\\nWeb Apps\\n\\nMobile Apps\\n\\nCloud-Native A\", \"pplication ty Web Application\\n\\nWeb Apps\\n\\nMobile Apps\\n\\n## Cloud -native data patterns\\n\\nService\\n\\nServi\", \"ce\\n\\nService\\n\\nAs we've seen throughout this book, a cloud-native approach changes the way you design,\", \" deploy, and manage applications. It also changes the way you manage and store data.\\n\\nFigure 5-1 con\", \"trasts the differences.\\n\\nData Store\\n\\nSingle, shared database\\n\\nData Store\\n\\nData Store\\n\\nFigure 5 -1. D\", \"ata management in cloud -native applications\\n\\n<!-- image -->\\n\\n<!-- image -->\\n\\nExperienced developers\", \" will easily recognize the architecture on the left-side of figure 5-1. In this monolithic applicati\", \"on, business service components collocate together in a shared services tier, sharing data from a si\", \"ngle relational database.\\n\\nIn many ways, a single database keeps data management simple. Querying da\", \"ta across multiple tables is straightforward. Changes to data update together or they all rollback. \", \"ACID transactions guarantee strong and immediate consistency.\\n\\nDesigning for cloud-native, we take a\", \" different approach. On the right-side of Figure 5-1, note how business functionality segregates int\", \"o small, independent microservices. Each microservice encapsulates a specific business capability an\", \"d its own data. The monolithic database decomposes\\n\\nMicroservice\\n\\nMobile app\\n\\nProduct Catalog\\n\\nMicro\", \"service into a distributed data model with many smaller databases, each aligning with a microservice\", \". When the smoke clears, we emerge with a design that exposes a database per microservice .\\n\\nJSON\\n\\nS\", \"PA web app\\n\\nAPI Gateway\\n\\nOrdering\\n\\n## Database -per -microservice, why?\\n\\n2\\n\\n3\\n\\nThis database per mic\", \"roservice provides many benefits, especially for systems that must evolve rapidly and support massiv\", \"e scale. With this model\\u2026\\n\\n- Domain data is encapsulated within the service\\n- Data schema can evolve\", \" without directly impacting other services\\n- Each data store can independently scale\\n- A data store \", \"failure in one service won't directly impact other services L\\n\\nSegregating data also enables each mi\", \"croservice to implement the data store type that is best optimized for its workload, storage needs, \", \"and read/write patterns. Choices include relational, document, key-value, and even graph-based data \", \"stores.\\n\\nFigure 5-2 presents the principle of polyglot persistence in a cloud-native system.\\n\\nFigure\", \" 5 -2. Polyglot data persistence\\n\\n<!-- image -->\\n\\nNote in the previous figure how each microservice \", \"supports a different type of data store.\\n\\n- The product catalog microservice consumes a relational d\", \"atabase to accommodate the rich relational structure of its underlying data.\\n- The shopping cart mic\", \"roservice consumes a distributed cache that supports its simple, keyvalue data store.\\n- The ordering\", \" microservice consumes both a NoSql document database for write operations along with a highly denor\", \"malized key/value store to accommodate high-volumes of read operations.\\n\\n4\\n\\n{\\n\\n}\\n\\nJavaScript/Angular\", \"js\\n\\nCloud\\n\\nSQL\\n\\n1\\n\\nBasket\\n\\nLineltem owned by\\n\\nProduct\\n\\nWhile relational databases remain relevant fo\", \"r microservices with complex data, NoSQL databases have gained considerable popularity. They provide\", \" massive scale and high availability. Their schemaless nature allows developers to move away from an\", \" architecture of typed data classes and ORMs that make change expensive and time-consuming. We cover\", \" NoSQL databases later in this chapter.\\n\\nPrice\\n\\nWhile encapsulating data into separate microservices\", \" can increase agility, performance, and scalability, it also presents many challenges. In the next s\", \"ection, we discuss these challenges along with patterns and practices to help overcome them.\\n\\n## Cro\", \"ss -service queries\\n\\nWhile microservices are independent and focus on specific functional capabiliti\", \"es, like inventory, shipping, or ordering, they frequently require integration with other microservi\", \"ces. Often the integration involves one microservice querying another for data. Figure 5-3 shows the\", \" scenario.\\n\\nFigure 5 -3. Querying across microservices\\n\\n<!-- image -->\\n\\nIn the preceding figure, we \", \"see a shopping basket microservice that adds an item to a user's shopping basket. While the data sto\", \"re for this microservice contains basket and line item data, it doesn't maintain product or pricing \", \"data. Instead, those data items are owned by the catalog and pricing microservices. This aspect pres\", \"ents a problem. How can the shopping basket microservice add a product to the user's shopping basket\", \" when it doesn't have product nor pricing data in its database?\\n\\nOne option discussed in Chapter 4 i\", \"s a direct HTTP call from the shopping basket to the catalog and pricing microservices. However, in \", \"chapter 4, we said synchronous HTTP calls couple microservices together, reducing their autonomy and\", \" diminishing their architectural benefits.\\n\\nWe could also implement a request-reply pattern with sep\", \"arate inbound and outbound queues for each service. However, this pattern is complicated and require\", \"s plumbing to correlate request and response messages. While it does decouple the backend microservi\", \"ce calls, the calling service must still synchronously wait for the call to complete. Network conges\", \"tion, transient faults, or an overloaded microservice and can result in long-running and even failed\", \" operations.\\n\\nBasket\\n\\nLineltem syncs\\n\\nProduct\\n\\nInstead, a widely accepted pattern for removing cross\", \"-service dependencies is the Materialized View Pattern, shown in Figure 5-4.\\n\\nSynes\\n\\n<!-- image -->\\n\", \"\\nProduct/Pricing\\n\\nShopping Basket Service\\n\\nFigure 5 -4. Materialized View Pattern\\n\\nWith this pattern\", \", you place a local data table (known as a read model) in the shopping basket service. This table co\", \"ntains a denormalized copy of the data needed from the product and pricing microservices. Copying th\", \"e data directly into the shopping basket microservice eliminates the need for expensive cross-servic\", \"e calls. With the data local to the service, you improve the service's response time and reliability\", \". Additionally, having its own copy of the data makes the shopping basket service more resilient. If\", \" the catalog service should become unavailable, it wouldn't directly impact the shopping basket serv\", \"ice. The shopping basket can continue operating with the data from its own store.\\n\\nThe catch with th\", \"is approach is that you now have duplicate data in your system. However, strategically duplicating d\", \"ata in cloud-native systems is an established practice and not considered an anti -pattern, or bad p\", \"ractice. Keep in mind that one and only one service can own a data set and have authority over it. Y\", \"ou'll need to synchronize the read models when the system of record is updated. Synchronization is t\", \"ypically implemented via asynchronous messaging with a publish/subscribe pattern, as shown in Figure\", \" 5.4.\\n\\n## Distributed transactions\\n\\nWhile querying data across microservices is difficult, implement\", \"ing a transaction across several microservices is even more complex. The inherent challenge of maint\", \"aining data consistency across independent data sources in different microservices can't be understa\", \"ted. The lack of distributed transactions in cloud -native applications means that you must manage d\", \"istributed transactions programmatically. You move from a world of immediate consistency to that of \", \"eventual consistency .\\n\\nFigure 5-5 shows the problem.\\n\\nOrder\\n\\nOrder\\n\\nService\\n\\nService\\n\\nCreate\\n\\nCreat\", \"e\\n\\nPending\\n\\nPending\\n\\nOrder\\n\\nOrder\\n\\nComplete\\n\\nOrder\\n\\nCancel\\n\\nOrder\\n\\nComplete\\n\\nOrder\\n\\nPayment\\n\\nPayment\", \"\\n\\nService\\n\\nInventory\\n\\nInventory\\n\\nService\\n\\nShipping\\n\\nShipping\\n\\nService\\n\\nNotification\\n\\nNotification\\n\\nS\", \"ervice\\n\\nService\\n\\nService\\n\\nService\\n\\nService\\n\\nFigure 5 -5. Implementing a transaction across microserv\", \"ices\\n\\n<!-- image -->\\n\\nIn the preceding figure, five independent microservices participate in a distr\", \"ibuted transaction that creates an order. Each microservice maintains its own data store and impleme\", \"nts a local transaction for its store. To create the order, the local transaction for each individua\", \"l microservice must succeed, or all must abort and roll back the operation. While built-in transacti\", \"onal support is available inside each of the microservices, there's no support for a distributed tra\", \"nsaction that would span across all five services to keep data consistent.\\n\\nInstead, you must constr\", \"uct this distributed transaction programmatically .\\n\\nA popular pattern for adding distributed transa\", \"ctional support is the Saga pattern. It's implemented by grouping local transactions together progra\", \"mmatically and sequentially invoking each one. If any of the local transactions fail, the Saga abort\", \"s the operation and invokes a set of compensating transactions. The compensating transactions undo t\", \"he changes made by the preceding local transactions and restore data consistency. Figure 5-6 shows a\", \" failed transaction with the Saga pattern.\\n\\nFigure 5 -6. Rolling back a transaction\\n\\n<!-- image -->\\n\", \"\\nUser\\n\\nInterface\\n\\nCommand\\n\\nCommand\\n\\nModel\\n\\nWrite Store\\n\\n(Tables)\\n\\nIn the previous figure, the Update\", \" Inventory operation has failed in the Inventory microservice. The Saga invokes a set of compensatin\", \"g transactions (in red) to adjust the inventory counts, cancel the payment and the order, and return\", \" the data for each microservice back to a consistent state.\\n\\nSaga patterns are typically choreograph\", \"ed as a series of related events, or orchestrated as a set of related commands. In Chapter 4, we dis\", \"cussed the service aggregator pattern that would be the foundation for an orchestrated saga implemen\", \"tation. We also discussed eventing along with Azure Service Bus and Azure Event Grid topics that wou\", \"ld be a foundation for a choreographed saga implementation.\\n\\n## High volume data\\n\\nLarge cloud-native\", \" applications often support high-volume data requirements. In these scenarios, traditional data stor\", \"age techniques can cause bottlenecks. For complex systems that deploy on a large scale, both Command\", \" and Query Responsibility Segregation (CQRS) and Event Sourcing may improve application performance.\", \"\\n\\n## CQRS\\n\\nCQRS, is an architectural pattern that can help maximize performance, scalability, and se\", \"curity. The pattern separates operations that read data from those operations that write data.\\n\\nFor \", \"normal scenarios, the same entity model and data repository object are used for both read and write \", \"operations.\\n\\nHowever, a high volume data scenario can benefit from separate models and data tables f\", \"or reads and writes. To improve performance, the read operation could query against a highly denorma\", \"lized representation of the data to avoid expensive repetitive table joins and table locks. The writ\", \"e operation, known as a command, would update against a fully normalized representation of the data \", \"that would guarantee consistency. You then need to implement a mechanism to keep both representation\", \"s in sync. Typically, whenever the write table is modified, it publishes an event that replicates th\", \"e modification to the read table.\\n\\nFigure 5-7 shows an implementation of the CQRS pattern.\\n\\nFigure 5\", \" -7. CQRS implementation\\n\\n<!-- image -->\\n\\nIn the previous figure, separate command and query models \", \"are implemented. Each data write operation is saved to the write store and then propagated to the re\", \"ad store. Pay close attention to how the data propagation process operates on the principle of event\", \"ual consistency. The read model eventually synchronizes with the write model, but there may be some \", \"lag in the process. We discuss eventual consistency in the next section.\\n\\nThis separation enables re\", \"ads and writes to scale independently. Read operations use a schema optimized for queries, while the\", \" writes use a schema optimized for updates. Read queries go against denormalized data, while complex\", \" business logic can be applied to the write model. As well, you might impose tighter security on wri\", \"te operations than those exposing reads.\\n\\nImplementing CQRS can improve application performance for \", \"cloud-native services. However, it does result in a more complex design. Apply this principle carefu\", \"lly and strategically to those sections of your cloud-native application that will benefit from it. \", \"For more on CQRS, see the Microsoft book .NET Microservices: Architecture for Containerized .NET App\", \"lications .\\n\\n## Event sourcing\\n\\nAnother approach to optimizing high volume data scenarios involves E\", \"vent Sourcing .\\n\\nA system typically stores the current state of a data entity. If a user changes the\", \"ir phone number, for example, the customer record is updated with the new number. We always know the\", \" current state of a data entity, but each update overwrites the previous state.\\n\\nIn most cases, this\", \" model works fine. In high volume systems, however, overhead from transactional locking and frequent\", \" update operations can impact database performance, responsiveness, and limit scalability.\\n\\nEvent So\", \"urcing takes a different approach to capturing data. Each operation that affects data is persisted t\", \"o an event store. Instead of updating the state of a data record, we append each change to a sequent\", \"ial list of past events - similar to an accountant's ledger. The Event Store becomes the system of r\", \"ecord for the data. It's used to propagate various materialized views within the bounded context of \", \"a microservice. Figure 5.8 shows the pattern.\\n\\nPresentation\\n\\nCart created\\n\\nItem 1 added\\n\\nItem 2 adde\", \"d\\n\\nItem 1 removed\\n\\nShipping information added\\n\\nPersisted events\\n\\nEvent store\\n\\nSome options for consu\", \"ming events\\n\\nFigure 5 -8. Event Sourcing\\n\\n<!-- image -->\\n\\nIn the previous figure, note how each entr\", \"y (in blue) for a user's shopping cart is appended to an underlying event store. In the adjoining ma\", \"terialized view, the system projects the current state by replaying all the events associated with e\", \"ach shopping cart. This view, or read model, is then exposed back to the UI. Events can also be inte\", \"grated with external systems and applications or queried to determine the current state of an entity\", \". With this approach, you maintain history. You know not only the current state of an entity, but al\", \"so how you reached this state.\\n\\nMechanically speaking, event sourcing simplifies the write model. Th\", \"ere are no updates or deletes. Appending each data entry as an immutable event minimizes contention,\", \" locking, and concurrency conflicts associated with relational databases. Building read models with \", \"the materialized view pattern enables you to decouple the view from the write model and choose the b\", \"est data store to optimize the needs of your application UI.\\n\\nFor this pattern, consider a data stor\", \"e that directly supports event sourcing. Azure Cosmos DB, MongoDB, Cassandra, CouchDB, and RavenDB a\", \"re good candidates.\\n\\nAs with all patterns and technologies, implement strategically and when needed.\", \" While event sourcing can provide increased performance and scalability, it comes at the expense of \", \"complexity and a learning curve.\\n\\nDocument\\n\\nStore value\\n\\nvalue value\\n\\n## Relational vs. NoSQL data v\", \"alue\\n\\nGraph\\n\\nRelational and NoSQL are two types of database systems commonly implemented in cloud-na\", \"tive apps. They're built differently, store data differently, and accessed differently. In this sect\", \"ion, we'll look at both. Later in this chapter, we'll look at an emerging database technology called\", \" NewSQL .\\n\\nRelational databases have been a prevalent technology for decades. They're mature, proven\", \", and widely implemented. Competing database products, tooling, and expertise abound. Relational dat\", \"abases provide a store of related data tables. These tables have a fixed schema, use SQL (Structured\", \" Query Language) to manage data, and support ACID guarantees.\\n\\nNo -SQL databases refer to high-perfo\", \"rmance, non-relational data stores. They excel in their ease-ofuse, scalability, resilience, and ava\", \"ilability characteristics. Instead of joining tables of normalized data, NoSQL stores unstructured o\", \"r semi -structured data, often in key-value pairs or JSON documents. NoSQL databases typically don't\", \" provide ACID guarantees beyond the scope of a single database partition. High volume services that \", \"require sub second response time favor NoSQL datastores.\\n\\nThe impact of NoSQL technologies for distr\", \"ibuted cloud-native systems can't be overstated. The proliferation of new data technologies in this \", \"space has disrupted solutions that once exclusively relied on relational databases.\\n\\nNoSQL databases\", \" include several different models for accessing and managing data, each suited to specific use cases\", \". Figure 5-9 presents four common models.\\n\\n<!-- image -->\\n\\n<!-- image -->\\n\\nFigure 5 -9: Data models \", \"for NoSQL databases\\n\\n| Model               | Characteristics                                        \", \"                                       |\\n|---------------------|------------------------------------\", \"-----------------------------------------------------------|\\n| Document Store      | Data and metada\", \"ta are stored hierarchically in  JSON - based documents inside the database.   |\\n| Key Value Store  \", \"   | The simplest of the NoSQL databases, data is  represented as a collection of key-value pairs. |\", \"\\n| Wide - Column Store | Related data is stored as a set of nested \\u0002 key/value pairs within a single\", \" column.           |\\n| Graph Store         | Data is stored in a graph structure as node,  edge, and\", \" data properties.                      |\\n\\n<!-- image -->\\n\\n<!-- image -->\\n\\n## The CAP theorem\\n\\nAs a w\", \"ay to understand the differences between these types of databases, consider the CAP theorem, a set o\", \"f principles applied to distributed systems that store state. Figure 5-10 shows the three properties\", \" of the CAP theorem.\\n\\nPartition\\n\\nFigure 5 -10. The CAP theorem\\n\\n<!-- image -->\\n\\nThe theorem states t\", \"hat distributed data systems will offer a trade-off between consistency, availability, and partition\", \" tolerance. And, that any database can only guarantee two of the three properties:\\n\\n- Consistency. E\", \"very node in the cluster responds with the most recent data, even if the system must block the reque\", \"st until all replicas update. If you query a \\\"consistent system\\\" for an item that is currently updat\", \"ing, you'll wait for that response until all replicas successfully update. However, you'll receive t\", \"he most current data.\\n- Availability. Every node returns an immediate response, even if that respons\", \"e isn't the most recent data. If you query an \\\"available system\\\" for an item that is updating, you'l\", \"l get the best possible answer the service can provide at that moment.\\n- Partition Tolerance. Guaran\", \"tees the system continues to operate even if a replicated data node fails or loses connectivity with\", \" other replicated data nodes.\\n\\nCAP theorem explains the tradeoffs associated with managing consisten\", \"cy and availability during a network partition; however tradeoffs with respect to consistency and pe\", \"rformance also exist with the absence of a network partition. CAP theorem is often further extended \", \"to PACELC to explain the tradeoffs more comprehensively.\\n\\nRelational databases typically provide con\", \"sistency and availability, but not partition tolerance. They're typically provisioned to a single se\", \"rver and scale vertically by adding more resources to the machine.\\n\\nMany relational database systems\", \" support built-in replication features where copies of the primary database can be made to other sec\", \"ondary server instances. Write operations are made to the primary instance and replicated to each of\", \" the secondaries. Upon a failure, the primary instance can fail over to a secondary to provide high \", \"availability. Secondaries can also be used to distribute read operations. While writes operations al\", \"ways go against the primary replica, read operations can be routed to any of the secondaries to redu\", \"ce system load.\\n\\nData can also be horizontally partitioned across multiple nodes, such as with shard\", \"ing. But, sharding dramatically increases operational overhead by spitting data across many pieces t\", \"hat cannot easily communicate. It can be costly and time consuming to manage. Relational features th\", \"at include table joins, transactions, and referential integrity require steep performance penalties \", \"in sharded deployments.\\n\\nReplication consistency and recovery point objectives can be tuned by confi\", \"guring whether replication occurs synchronously or asynchronously. If data replicas were to lose net\", \"work connectivity in a \\\"highly consistent\\\" or synchronous relational database cluster, you wouldn't \", \"be able to write to the database. The system would reject the write operation as it can't replicate \", \"that change to the other data replica. Every data replica has to update before the transaction can c\", \"omplete.\\n\\nNoSQL databases typically support high availability and partition tolerance. They scale ou\", \"t horizontally, often across commodity servers. This approach provides tremendous availability, both\", \" within and across geographical regions at a reduced cost. You partition and replicate data across t\", \"hese machines, or nodes, providing redundancy and fault tolerance. Consistency is typically tuned th\", \"rough consensus protocols or quorum mechanisms. They provide more control when navigating tradeoffs \", \"between tuning synchronous versus asynchronous replication in relational systems.\\n\\nIf data replicas \", \"were to lose connectivity in a \\\"highly available\\\" NoSQL database cluster, you could still complete a\", \" write operation to the database. The database cluster would allow the write operation and update ea\", \"ch data replica as it becomes available. NoSQL databases that support multiple writable replicas can\", \" further strengthen high availability by avoiding the need for failover when optimizing recovery tim\", \"e objective.\\n\\nModern NoSQL databases typically implement partitioning capabilities as a feature of t\", \"heir system design. Partition management is often built-in to the database, and routing is achieved \", \"through placement hints - often called partition keys. A flexible data models enables the NoSQL data\", \"bases to lower the burden of schema management and improve availability when deploying application u\", \"pdates that require data model changes.\\n\\nHigh availability and massive scalability are often more cr\", \"itical to the business than relational table joins and referential integrity. Developers can impleme\", \"nt techniques and patterns such as Sagas, CQRS, and asynchronous messaging to embrace eventual consi\", \"stency.\\n\\nNowadays, care must be taken when considering the CAP theorem constraints. A new type of da\", \"tabase, called NewSQL, has emerged which extends the relational database engine to support both hori\", \"zontal scalability and the scalable performance of NoSQL systems.\\n\\n## Considerations for relational \", \"vs. NoSQL systems\\n\\nBased upon specific data requirements, a cloud-native-based microservice can impl\", \"ement a relational, NoSQL datastore or both.\\n\\n| Consider a NoSQL datastore when:                    \", \"                                                                                                    \", \"                               | Consider a relational database when:                               \", \"              |\\n|-----------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"-|----------------------------------------------------------------------------------|\\n| You have hig\", \"h volume workloads that require  predictable latency at large scale (for example,  latency measured \", \"in milliseconds while  performing millions of transactions per second) | Your workload volume genera\", \"lly fits within  thousands of transactions per second |\\n| Your data is dynamic and frequently change\", \"s                                                                                                   \", \"                                         | Your data is highly structured and requires  referential \", \"integrity               |\\n| Relationships can be de-normalized data  models                         \", \"                                                                                                    \", \"           | Relationships are expressed through table joins  on normalized data models       |\\n| Da\", \"ta retrieval is simple and expressed without  table joins                                           \", \"                                                                                 | You work with com\", \"plex queries and reports                                        |\\n| Data is typically replicated acr\", \"oss geographies  and requires finer control over consistency,  availability, and performance        \", \"                                                   | Data is typically centralized, or can be replic\", \"ated  regions asynchronously      |\\n| Your application will be deployed to commodity  hardware, such\", \" as with public clouds                                                                              \", \"                     | Your application will be deployed to large, high\\u0002 end hardware               \", \"    |\\n\\nIn the next sections, we'll explore the options available in the Azure cloud for storing and \", \"managing your cloud-native data.\\n\\n## Database as a Service\\n\\nTo start, you could provision an Azure v\", \"irtual machine and install your database of choice for each service. While you'd have full control o\", \"ver the environment, you'd forgo many built-in features of the cloud platform. You'd also be respons\", \"ible for managing the virtual machine and database for each service. This approach could quickly bec\", \"ome time-consuming and expensive.\\n\\nInstead, cloud-native applications favor data services exposed as\", \" a Database as a Service (DBaaS). Fully managed by a cloud vendor, these services provide built-in s\", \"ecurity, scalability, and monitoring. Instead of owning the service, you simply consume it as a back\", \"ing service. The provider operates the resource at scale and bears the responsibility for performanc\", \"e and maintenance.\\n\\nThey can be configured across cloud availability zones and regions to achieve hi\", \"gh availability. They all support just-in-time capacity and a pay-as-you-go model. Azure features di\", \"fferent kinds of managed data service options, each with specific benefits.\\n\\nWe'll first look at rel\", \"ational DBaaS services available in Azure. You'll see that Microsoft's flagship SQL Server database \", \"is available along with several open-source options. Then, we'll talk about the NoSQL data services \", \"in Azure.\\n\\nSQL Database\\n\\nSQL\\n\\nMySQL\\n\\nMy\\n\\nMariaDB\\n\\nPostgreSQL\\n\\nBuilt-in high availability with a 99.9\", \"9% service level agreement\\n\\n\\u2022 Automatic upgrades, patching, and backups\\n\\n## Azure relational databas\", \"es\\n\\nFor cloud -native microservices that require relational data, Azure offers four managed relation\", \"al databases as a service (DBaaS) offerings, shown in Figure 5-11.\\n\\nFigure 5 -11. Managed relational\", \" databases available in Azure\\n\\n<!-- image -->\\n\\nIn the previous figure, note how each sits upon a com\", \"mon DBaaS infrastructure which features key capabilities at no additional cost.\\n\\nThese features are \", \"especially important to organizations who provision large numbers of databases, but have limited res\", \"ources to administer them. You can provision an Azure database in minutes by selecting the amount of\", \" processing cores, memory, and underlying storage. You can scale the database on -the -fly and dynam\", \"ically adjust resources with little to no downtime.\\n\\n## Azure SQL Database\\n\\nDevelopment teams with e\", \"xpertise in Microsoft SQL Server should consider Azure SQL Database. It's a fully managed relational\", \" database-as-a-service (DBaaS) based on the Microsoft SQL Server Database Engine. The service shares\", \" many features found in the on-premises version of SQL Server and runs the latest stable version of \", \"the SQL Server Database Engine.\\n\\nFor use with a cloud -native microservice, Azure SQL Database is av\", \"ailable with three deployment options:\\n\\n- A Single Database represents a fully managed SQL Database \", \"running on an Azure SQL Database server in the Azure cloud. The database is considered contained as \", \"it has no configuration dependencies on the underlying database server.\\n- A Managed Instance is a fu\", \"lly managed instance of the Microsoft SQL Server Database Engine that provides near-100% compatibili\", \"ty with an on-premises SQL Server. This option supports larger databases, up to 35 TB and is placed \", \"in an Azure Virtual Network for better isolation.\\n\\n- Azure SQL Database serverless is a compute tier\", \" for a single database that automatically scales based on workload demand. It bills only for the amo\", \"unt of compute used per second. The service is well suited for workloads with intermittent, unpredic\", \"table usage patterns, interspersed with periods of inactivity. The serverless compute tier also auto\", \"matically pauses databases during inactive periods so that only storage charges are billed. It autom\", \"atically resumes when activity returns.\\n\\nBeyond the traditional Microsoft SQL Server stack, Azure al\", \"so features managed versions of three popular open-source databases.\\n\\n## Open-source databases in Az\", \"ure\\n\\nOpen -source relational databases have become a popular choice for cloud-native applications. M\", \"any enterprises favor them over commercial database products, especially for cost savings. Many deve\", \"lopment teams enjoy their flexibility, community-backed development, and ecosystem of tools and exte\", \"nsions. Open-source databases can be deployed across multiple cloud providers, helping minimize the \", \"concern of \\\"vendor lock -in.\\\"\\n\\nDevelopers can easily self-host any open-source database on an Azure \", \"VM. While providing full control, this approach puts you on the hook for the management, monitoring,\", \" and maintenance of the database and VM.\\n\\nHowever, Microsoft continues its commitment to keeping Azu\", \"re an \\\"open platform\\\" by offering several popular open-source databases as fully managed DBaaS servi\", \"ces.\\n\\n## Azure Database for MySQL\\n\\nMySQL is an open-source relational database and a pillar for appl\", \"ications built on the LAMP software stack. Widely chosen for read heavy workloads, it's used by many\", \" large organizations, including Facebook, Twitter, and YouTube. The community edition is available f\", \"or free, while the enterprise edition requires a license purchase. Originally created in 1995, the p\", \"roduct was purchased by Sun Microsystems in 2008. Oracle acquired Sun and MySQL in 2010.\\n\\nAzure Data\", \"base for MySQL is a managed relational database service based on the open-source MySQL Server engine\", \". It uses the MySQL Community edition. The Azure MySQL server is the administrative point for the se\", \"rvice. It's the same MySQL server engine used for on-premises deployments. The engine can create a s\", \"ingle database per server or multiple databases per server that share resources. You can continue to\", \" manage data using the same open-source tools without having to learn new skills or manage virtual m\", \"achines.\\n\\n## Azure Database for MariaDB\\n\\nMariaDB Server is another popular open-source database serv\", \"er. It was created as a fork of MySQL when Oracle purchased Sun Microsystems, who owned MySQL. The i\", \"ntent was to ensure that MariaDB remained open-source. As MariaDB is a fork of MySQL, the data and t\", \"able definitions are compatible, and the client protocols, structures, and APIs, are close-knit.\\n\\nMa\", \"riaDB has a strong community and is used by many large enterprises. While Oracle continues to mainta\", \"in, enhance, and support MySQL, the MariaDB foundation manages MariaDB, allowing public contribution\", \"s to the product and documentation.\\n\\nAzure Database for MariaDB is a fully managed relational databa\", \"se as a service in the Azure cloud. The service is based on the MariaDB community edition server eng\", \"ine. It can handle mission-critical workloads with predictable performance and dynamic scalability.\\n\", \"\\n## Azure Database for PostgreSQL\\n\\nPostgreSQL is an open-source relational database with over 30 yea\", \"rs of active development. PostgreSQL has a strong reputation for reliability and data integrity. It'\", \"s feature rich, SQL compliant, and considered more performant than MySQL - especially for workloads \", \"with complex queries and heavy writes. Many large enterprises including Apple, Red Hat, and Fujitsu \", \"have built products using PostgreSQL.\\n\\nAzure Database for PostgreSQL is a fully managed relational d\", \"atabase service, based on the opensource Postgres database engine. The service supports many develop\", \"ment platforms, including C++, Java, Python, Node, C#, and PHP. You can migrate PostgreSQL databases\", \" to it using the commandline interface tool or Azure Data Migration Service.\\n\\nAzure Database for Pos\", \"tgreSQL is available with two deployment options:\\n\\n- The Single Server deployment option is a centra\", \"l administrative point for multiple databases to which you can deploy many databases. The pricing is\", \" structured per-server based upon cores and storage.\\n- The Hyperscale (Citus) option is powered by C\", \"itus Data technology. It enables high performance by horizontally scaling a single database across h\", \"undreds of nodes to deliver fast performance and scale. This option allows the engine to fit more da\", \"ta in memory, parallelize queries across hundreds of nodes, and index data faster.\\n\\n## NoSQL data in\", \" Azure\\n\\nCosmos DB is a fully managed, globally distributed NoSQL database service in the Azure cloud\", \". It has been adopted by many large companies across the world, including Coca-Cola, Skype, ExxonMob\", \"il, and Liberty Mutual.\\n\\nIf your services require fast response from anywhere in the world, high ava\", \"ilability, or elastic scalability, Cosmos DB is a great choice. Figure 5-12 shows Cosmos DB.\\n\\n(LEAF}\", \"\\n\\nSQL\\n\\nTurnkey global distribution\\n\\nMongoDB\\n\\nTable API\\n\\n\\u2022 OOO\\n\\nColumn-family\\n\\nGremlin\\n\\n\\u2022\\n\\nFigure 5 -\", \"12: Overview of Azure Cosmos DB\\n\\n<!-- image -->\\n\\nThe previous figure presents many of the built-in c\", \"loud-native capabilities available in Cosmos DB. In this section, we'll take a closer look at them.\\n\", \"\\n## Global support\\n\\nCloud -native applications often have a global audience and require global scale\", \".\\n\\nYou can distribute Cosmos databases across regions or around the world, placing data close to you\", \"r users, improving response time, and reducing latency. You can add or remove a database from a regi\", \"on without pausing or redeploying your services. In the background, Cosmos DB transparently replicat\", \"es the data to each of the configured regions.\\n\\nCosmos DB supports active/active clustering at the g\", \"lobal level, enabling you to configure any of your database regions to support both writes and reads\", \" .\\n\\nThe Multi -region write protocol is an important feature in Cosmos DB that enables the following\", \" functionality:\\n\\n- Unlimited elastic write and read scalability.\\n- 99.999% read and write availabili\", \"ty all around the world.\\n- Guaranteed reads and writes served in less than 10 milliseconds at the 99\", \"th percentile.\\n\\nWith the Cosmos DB Multi -Homing APIs, your microservice is automatically aware of t\", \"he nearest Azure region and sends requests to it. The nearest region is identified by Cosmos DB with\", \"out any configuration changes. Should a region become unavailable, the Multi-Homing feature will aut\", \"omatically route requests to the next nearest available region.\\n\\n## Multi -model support\\n\\nWhen repla\", \"tforming monolithic applications to a cloud-native architecture, development teams sometimes have to\", \" migrate open-source, NoSQL data stores. Cosmos DB can help you preserve your cassandra\\n\\nFuture AP/s\", \"\\n\\ninvestment in these NoSQL datastores with its multi -model data platform. The following table show\", \"s the supported NoSQL compatibility APIs .\\n\\n| Provider       | Description                          \", \"                                      |\\n|----------------|------------------------------------------\", \"----------------------------------|\\n| NoSQL API      | API for NoSQL stores data in document format \", \"                              |\\n| Mongo DB API   | Supports Mongo DB APIs and JSON documents        \", \"                          |\\n| Gremlin API    | Supports Gremlin API with graph-based nodes  and edge\", \" data representations |\\n| Cassandra API  | Supports Casandra API for wide-column data  representatio\", \"ns                |\\n| Table API      | Supports Azure Table Storage with premium  enhancements      \", \"              |\\n| PostgreSQL API | Managed service for running PostgreSQL at any  scale             \", \"          |\\n\\nDevelopment teams can migrate existing Mongo, Gremlin, or Cassandra databases into Cosm\", \"os DB with minimal changes to data or code. For new apps, development teams can choose among opensou\", \"rce options or the built-in SQL API model.\\n\\nInternally, Cosmos stores the data in a simple struct fo\", \"rmat made up of primitive data types. For each request, the database engine translates the primitive\", \" data into the model representation you've selected.\\n\\nIn the previous table, note the Table API opti\", \"on. This API is an evolution of Azure Table Storage. Both share the same underlying table model, but\", \" the Cosmos DB Table API adds premium enhancements not available in the Azure Storage API. The follo\", \"wing table contrasts the features.\\n\\n| Feature               | Azure Table Storage                   \", \"                         | Azure Cosmos DB                                                          \", \"      |\\n|-----------------------|----------------------------------------------------------------|--\", \"------------------------------------------------------------------------------|\\n| Latency           \", \"    | Fast                                                           | Single - digit millisecond la\", \"tency for reads and  writes anywhere in the world |\\n| Throughp ut           | Limit of 20,000 operat\", \"ions per table                           | Unlimited operations per table                           \", \"                      |\\n| Global  Distributio n | Single region with optional single  secondary read\", \" region      | Turnkey distributions to all regions with  automatic failover                  |\\n| In\", \"dexing              | Available for partition and row key  properties only           | Automatic ind\", \"exing of all properties                                           |\\n| Pricing               | Optimi\", \"zed for cold workloads (low  throughput : storage ratio) | Optimized for hot workloads (high  throug\", \"hput : storage ratio)                 |\\n\\nMicroservices that consume Azure Table storage can easily m\", \"igrate to the Cosmos DB Table API. No code changes are required.\\n\\nStrong\\n\\nBounded Staleness\\n\\nStronge\", \"r Consistency\\n\\nSession\\n\\nConsistent Prefix\\n\\nEventual\\n\\nWeaker Consistency\\n\\nHigher availability, lower \", \"latency, higher throughput\\n\\n## Tunable consistency\\n\\nEarlier in the Relational vs. NoSQL section, we \", \"discussed the subject of data consistency. Data consistency refers to the integrity of your data. Cl\", \"oud-native services with distributed data rely on replication and must make a fundamental tradeoff b\", \"etween read consistency, availability, and latency.\\n\\nMost distributed databases allow developers to \", \"choose between two consistency models: strong consistency and eventual consistency. Strong consisten\", \"cy is the gold standard of data programmability. It guarantees that a query will always return the m\", \"ost current data - even if the system must incur latency waiting for an update to replicate across a\", \"ll database copies. While a database configured for eventual consistency will return data immediatel\", \"y, even if that data isn't the most current copy. The latter option enables higher availability, gre\", \"ater scale, and increased performance.\\n\\nAzure Cosmos DB offers five well -defined consistency models\", \" shown in Figure 5-13.\\n\\nFigure 5 -13: Cosmos DB Consistency Levels\\n\\n<!-- image -->\\n\\nThese options en\", \"able you to make precise choices and granular tradeoffs for consistency, availability, and the perfo\", \"rmance for your data. The levels are presented in the following table.\\n\\n| Consistency Level   | Desc\", \"ription                                                                                             \", \"                       |\\n|---------------------|----------------------------------------------------\", \"----------------------------------------------------------------------------|\\n| Eventual            \", \"| No ordering guarantee for reads. Replicas will  eventually converge.                              \", \"                             |\\n| Constant Prefix     | Reads are still eventual, but data is returne\", \"d in  the ordering in which it is written.                                        |\\n| Session       \", \"      | Guarantees you can read any data written  during the current session. It is the default  con\", \"sistency level.                    |\\n| Bounded Staleness   | Reads trail writes by interval that you\", \" specify.                                                                               |\\n| Strong  \", \"            | Reads are guaranteed to return most recent  committed version of an item. A client nev\", \"er  sees an uncommitted or partial read. |\\n\\nIn the article Getting Behind the 9-Ball: Cosmos DB Cons\", \"istency Levels Explained, Microsoft Program Manager Jeremy Likness provides an excellent explanation\", \" of the five models.\\n\\n## Partitioning\\n\\nAzure Cosmos DB embraces automatic partitioning to scale a da\", \"tabase to meet the performance needs of your cloud-native services.\\n\\nYou manage data in Cosmos DB da\", \"ta by creating databases, containers, and items.\\n\\n\\\"city\\\": \\\"London\\\"\\n\\nContainer\\n\\nContainer\\n\\nContainers\", \" live in a Cosmos DB database and represent a schema-agnostic grouping of items. Items are the data \", \"that you add to the container. They're represented as documents, rows, nodes, or edges. All items ad\", \"ded to a container are automatically indexed. Logical\\n\\nPartitions\\n\\nTo partition the container, items\", \" are divided into distinct subsets called logical partitions. Logical partitions are populated based\", \" on the value of a partition key that is associated with each item in a container. Figure 5-14 shows\", \" two containers each with a logical partition based on a partition key value.\\n\\nPhysical\\n\\nFigure 5 -1\", \"4: Cosmos DB partitioning mechanics\\n\\n<!-- image -->\\n\\nNote in the previous figure how each item inclu\", \"des a partition key of either 'city' or 'airport'. The key determines the item's logical partition. \", \"Items with a city code are assigned to the container on the left, and items with an airport code, to\", \" the container on the right. Combining the partition key value with the ID value creates an item's i\", \"ndex, which uniquely identifies the item.\\n\\nInternally, Cosmos DB automatically manages the placement\", \" of logical partitions on physical partitions to satisfy the scalability and performance needs of th\", \"e container. As application throughput and storage requirements increase, Azure Cosmos DB redistribu\", \"tes logical partitions across a greater number of servers. Redistribution operations are managed by \", \"Cosmos DB and invoked without interruption or downtime.\\n\\n## NewSQL databases\\n\\nNewSQL is an emerging \", \"database technology that combines the distributed scalability of NoSQL with the ACID guarantees of a\", \" relational database. NewSQL databases are important for business systems that must process high-vol\", \"umes of data, across distributed environments, with full transactional support and ACID compliance. \", \"While a NoSQL database can provide massive scalability, it does not guarantee data consistency. Inte\", \"rmittent problems from inconsistent data can place a burden on the development team. Developers must\", \" construct safeguards into their microservice code to manage problems caused by inconsistent data.\\n\\n\", \"The Cloud Native Computing Foundation (CNCF) features several NewSQL database projects.\\n\\nDatabase\\n\\n|\", \" Project      | Characteristics                                                                     \", \"                                                                                                    \", \"                                                                                                    \", \"                                                                                     |\\n|------------\", \"--|-------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"----------------------------------------------------------------------------------------------------\", \"-------------------------------------------------------------------------|\\n| Cockroach DB | An ACID \", \"- compliant, relational database that  scales globally. Add a new node to a cluster and  CockroachDB\", \" takes care of balancing the data  across instances and geographies. It creates,  manages, and distr\", \"ibutes replicas to ensure  reliability. It\\u2019s open source and freely available.                      \", \"                                                             |\\n| TiDB         | An open - source dat\", \"abase that supports Hybrid  Transactional and Analytical Processing (HTAP)  workloads. It is MySQL-c\", \"ompatible and features  horizontal scalability, strong consistency, and  high availability. TiDB act\", \"s like a MySQL server.  You can continue to use existing MySQL client  libraries, without requiring \", \"extensive code  changes to your application.     |\\n| YugabyteDB   | An open source, high - performan\", \"ce, distributed  SQL database. It supports low query latency,  resilience against failures, and glob\", \"al data  distribution. YugabyteDB is PostgreSQL\\u0002 compatible and handles scale-out RDBMS and  interne\", \"t - scale OLTP workloads. The product also  supports NoSQL and is compatible with  Cassandra.       \", \"                                     |\\n| Vitess       | Vitess is a database solution for deploying,\", \"  scaling, and managing large clusters of MySQL  instances. It can run in a public or private cloud \", \" architecture. Vitess combines and extends many  important MySQL features and features both  vertica\", \"l and horizontal sharding support.  Originated by YouTube, Vitess has been serving  all YouTube data\", \"base traffic since 2011. |\\n\\nThe open-source projects in the previous figure are available from the C\", \"loud Native Computing Foundation. Three of the offerings are full database products, which include .\", \"NET support. The other, Vitess, is a database clustering system that horizontally scales large clust\", \"ers of MySQL instances.\\n\\nA key design goal for NewSQL databases is to work natively in Kubernetes, t\", \"aking advantage of the platform's resiliency and scalability.\\n\\nNewSQL databases are designed to thri\", \"ve in ephemeral cloud environments where underlying virtual machines can be restarted or rescheduled\", \" at a moment's notice. The databases are designed to survive node failures without data loss nor dow\", \"ntime. CockroachDB, for example, is able to survive a machine loss by maintaining three consistent r\", \"eplicas of any data across the nodes in a cluster.\\n\\nKubernetes uses a Services construct to allow a \", \"client to address a group of identical NewSQL databases processes from a single DNS entry. By decoup\", \"ling the database instances from the address\\n\\nof the service with which it's associated, we can scal\", \"e without disrupting existing application instances. Sending a request to any service at a given tim\", \"e will always yield the same result.\\n\\nIn this scenario, all database instances are equal. There are \", \"no primary or secondary relationships. Techniques like consensus replication found in CockroachDB al\", \"low any database node to handle any request. If the node that receives a load-balanced request has t\", \"he data it needs locally, it responds immediately. If not, the node becomes a gateway and forwards t\", \"he request to the appropriate nodes to get the correct answer. From the client's perspective, every \", \"database node is the same: They appear as a single logical database with the consistency guarantees \", \"of a single-machine system, despite having dozens or even hundreds of nodes that are working behind \", \"the scenes.\\n\\nFor a detailed look at the mechanics behind NewSQL databases, see the DASH: Four Proper\", \"ties of Kubernetes -Native Databases article.\\n\\n## Data migration to the cloud\\n\\nOne of the more time \", \"-consuming tasks is migrating data from one data platform to another. The Azure Data Migration Servi\", \"ce can help expedite such efforts. It can migrate data from several external database sources into A\", \"zure Data platforms with minimal downtime. Target platforms include the following services:\\n\\n- Azure\", \" SQL Database\\n- Azure Database for MySQL\\n- Azure Database for MariaDB\\n- Azure Database for PostgreSQ\", \"L\\n- Azure Cosmos DB\\n\\nThe service provides recommendations to guide you through the changes required \", \"to execute a migration, both small or large.\\n\\n## Caching in a cloud -native app\\n\\nThe benefits of cac\", \"hing are well understood. The technique works by temporarily copying frequently accessed data from a\", \" backend data store to fast storage that's located closer to the application. Caching is often imple\", \"mented where\\u2026\\n\\n- Data remains relatively static.\\n- Data access is slow, especially compared to the s\", \"peed of the cache.\\n- Data is subject to high levels of contention.\\n\\n## Why?\\n\\nAs discussed in the Mic\", \"rosoft caching guidance, caching can increase performance, scalability, and availability for individ\", \"ual microservices and the system as a whole. It reduces the latency and contention of handling large\", \" volumes of concurrent requests to a data store. As data volume and the number of users increase, th\", \"e greater the benefits of caching become.\\n\\nClient Web app\\n\\nCloud\\n\\n## Caching architecture\\n\\nCloud nat\", \"ive applications typically implement a distributed caching architecture. The cache is hosted as a cl\", \"oud -based backing service, separate from the microservices. Figure 5-15 shows the architecture.\\n\\nFi\", \"gure 5 -15: Caching in a cloud native app\\n\\n<!-- image -->\\n\\nIn the previous figure, note how the cach\", \"e is independent of and shared by the microservices. In this scenario, the cache is invoked by the A\", \"PI Gateway. As discussed in chapter 4, the gateway serves as a front end for all incoming requests. \", \"The distributed cache increases system responsiveness by returning cached data whenever possible. Ad\", \"ditionally, separating the cache from the services allows the cache to scale up or out independently\", \" to meet increased traffic demands.\\n\\nThe previous figure presents a common caching pattern known as \", \"the cache-aside pattern. For an incoming request, you first query the cache (step #1) for a response\", \". If found, the data is returned immediately. If the data doesn't exist in the cache (known as a cac\", \"he miss), it's retrieved from a local database in a downstream service (step #2). It's then written \", \"to the cache for future requests (step #3), and returned to the caller. Care must be taken to period\", \"ically evict cached data so that the system remains timely and consistent.\\n\\nAs a shared cache grows,\", \" it might prove beneficial to partition its data across multiple nodes. Doing so can help minimize c\", \"ontention and improve scalability. Many Caching services support the ability to\\n\\nCache\\n\\nAzure\\n\\nTable\", \"\\n\\nCaching is most effective when a client repeatedly reads data that is immutable or that changes in\", \"frequently. Examples include reference information such as product and pricing information, or share\", \"d static resources that are costly to construct. Web API Azure\\n\\nCosmos\\n\\nWhile microservices should b\", \"e stateless, a distributed cache can support concurrent access to session state data when absolutely\", \" required.\\n\\nAlso consider caching to avoid repetitive computations. If an operation transforms data \", \"or performs a complicated calculation, cache the result for subsequent requests. 5QL\\n\\ncontainer\\n\\nAzu\", \"re\\n\\nDatabase\\n\\nMicroservice 1\\n\\nWeb AP\\n\\ndynamically add and remove nodes and rebalance data across par\", \"titions. This approach typically involves clustering. Clustering exposes a collection of federated n\", \"odes as a seamless, single cache. Internally, however, the data is dispersed across the nodes follow\", \"ing a predefined distribution strategy that balances the load evenly.\\n\\n## Azure Cache for Redis\\n\\nAzu\", \"re Cache for Redis is a secure data caching and messaging broker service, fully managed by Microsoft\", \". Consumed as a Platform as a Service (PaaS) offering, it provides high throughput and lowlatency ac\", \"cess to data. The service is accessible to any application within or outside of Azure.\\n\\nThe Azure Ca\", \"che for Redis service manages access to open-source Redis servers hosted across Azure data centers. \", \"The service acts as a facade providing management, access control, and security. The service nativel\", \"y supports a rich set of data structures, including strings, hashes, lists, and sets. If your applic\", \"ation already uses Redis, it will work as-is with Azure Cache for Redis.\\n\\nAzure Cache for Redis is m\", \"ore than a simple cache server. It can support a number of scenarios to enhance a microservices arch\", \"itecture:\\n\\n- An in -memory data store\\n- A distributed non -relational database\\n- A message broker\\n- \", \"A configuration or discovery server\\n\\nFor advanced scenarios, a copy of the cached data can be persis\", \"ted to disk. If a catastrophic event disables both the primary and replica caches, the cache is reco\", \"nstructed from the most recent snapshot.\\n\\nAzure Redis Cache is available across a number of predefin\", \"ed configurations and pricing tiers. The Premium tier features many enterprise-level features such a\", \"s clustering, data persistence, georeplication, and virtual-network isolation.\\n\\n## Elasticsearch in \", \"a cloud -native app\\n\\nElasticsearch is a distributed search and analytics system that enables complex\", \" search capabilities across diverse types of data. It's open source and widely popular. Consider how\", \" the following companies integrate Elasticsearch into their application:\\n\\n- Wikipedia for full-text \", \"and incremental (search as you type) searching.\\n- GitHub to index and expose over 8 million code rep\", \"ositories.\\n- Docker for making its container library discoverable.\\n\\nElasticsearch is built on top of\", \" the Apache Lucene full-text search engine. Lucene provides highperformance document indexing and qu\", \"erying. It indexes data with an inverted indexing scheme \\u2013 instead of mapping pages to keywords, it \", \"maps keywords to pages just like a glossary at the end of a book. Lucene has powerful query syntax c\", \"apabilities and can query data by:\\n\\n- Term (a full word)\\n- Prefix (starts-with word)\\n- Wildcard (usi\", \"ng \\\"*\\\" or \\\"?\\\" filters)\\n- Phrase (a sequence of text in a document)\\n- Boolean value (complex searches\", \" combining queries)\\n\\nWhile Lucene provides low-level plumbing for searching, Elasticsearch provides \", \"the server that sits on top of Lucene. Elasticsearch adds higher-level functionality to simplify wor\", \"king Lucene, including a RESTful API to access Lucene's indexing and searching functionality. It als\", \"o provides a distributed infrastructure capable of massive scalability, fault tolerance, and high av\", \"ailability.\\n\\nFor larger cloud-native applications with complex search requirements, Elasticsearch is\", \" available as managed service in Azure. The Microsoft Azure Marketplace features preconfigured templ\", \"ates which developers can use to deploy an Elasticsearch cluster on Azure.\\n\\nFrom the Microsoft Azure\", \" Marketplace, developers can use preconfigured templates built to quickly deploy an Elasticsearch cl\", \"uster on Azure. Using the Azure-managed offering, you can deploy up to 50 data nodes, 20 coordinatin\", \"g nodes, and three dedicated master nodes.\\n\\n## Summary\\n\\nThis chapter presented a detailed look at da\", \"ta in cloud-native systems. We started by contrasting data storage in monolithic applications with d\", \"ata storage patterns in cloud-native systems. We looked at data patterns implemented in cloud-native\", \" systems, including cross-service queries, distributed transactions, and patterns to deal with high-\", \"volume systems. We contrasted SQL with NoSQL data. We looked at data storage options available in Az\", \"ure that include both Microsoft-centric and opensource options. Finally, we discussed caching and El\", \"asticsearch in a cloud-native application.\\n\\n## References\\n\\n- Command and Query Responsibility Segreg\", \"ation (CQRS) pattern\\n- Event Sourcing pattern\\n- Why isn't RDBMS Partition Tolerant in CAP Theorem an\", \"d why is it Available?\\n- Materialized View\\n- All you really need to know about open source databases\", \"\\n- Compensating Transaction pattern\\n- Saga Pattern\\n- Saga Patterns | How to implement business trans\", \"actions using microservices\\n- Compensating Transaction pattern\\n- Getting Behind the 9-Ball: Cosmos D\", \"B Consistency Levels Explained\\n- On RDBMS, NoSQL and NewSQL databases. Interview with John Ryan\\n\\n- \\u2022\", \"\\n- \\u2022\\n- \\u2022\\n- TiDB\\n- \\u2022\\n- Vitess\\n- \\u2022\\n- \\u2022\\n\\nSQL vs NoSQL vs NewSQL: The Full Comparison DASH: Four Propert\", \"ies of Kubernetes-Native Databases CockroachDB YugabyteDB Elasticsearch: The Definitive Guide Introd\", \"uction to Apache Lucene\\n\\nClient Mobile App\\n\\nClient SPA Web app\\n\\nBrowser\\n\\nJSON\\n\\nBack end\\n\\nCaching\\n\\nBa\", \"cking Service\\n\\nMicroservice\\n\\n.....\\n\\n## Cloud -native resiliency\\n\\nSQL\\n\\nMicroservice\\n\\nResiliency is th\", \"e ability of your system to react to failure and still remain functional. It's not about avoiding fa\", \"ilure, but accepting failure and constructing your cloud-native services to respond to it. You want \", \"to return to a fully functioning state quickly as possible.\\n\\nUnlike traditional monolithic applicati\", \"ons, where everything runs together in a single process, cloudnative systems embrace a distributed a\", \"rchitecture as shown in Figure 6-1:\\n\\nFigure 6 -1. Distributed cloud -native environment\\n\\n<!-- image \", \"-->\\n\\nIn the previous figure, each microservice and cloud-based backing service execute in a separate\", \" process, across server infrastructure, communicating via network-based calls.\\n\\nOperating in this en\", \"vironment, a service must be sensitive to many different challenges:\\n\\n- Unexpected network latency -\", \" the time for a service request to travel to the receiver and back.\\n- Transient faults -short -lived\", \" network connectivity errors.\\n- Blockage by a long-running synchronous operation.\\n- A host process t\", \"hat has crashed and is being restarted or moved.\\n- An overloaded microservice that can't respond for\", \" a short time.\\n- An in -flight orchestrator operation such as a rolling upgrade or moving a service \", \"from one node to another.\\n\\n{}\\n\\nDocument Database\\n\\nBacking Service\\n\\n- Hardware failures.\\n\\nCloud platf\", \"orms can detect and mitigate many of these infrastructure issues. It may restart, scale out, and eve\", \"n redistribute your service to a different node. However, to take full advantage of this built-in pr\", \"otection, you must design your services to react to it and thrive in this dynamic environment.\\n\\nIn t\", \"he following sections, we'll explore defensive techniques that your service and managed cloud resour\", \"ces can leverage to minimize downtime and disruption.\\n\\n## Application resiliency patterns\\n\\nThe first\", \" line of defense is application resiliency.\\n\\nWhile you could invest considerable time writing your o\", \"wn resiliency framework, such products already exist. Polly is a comprehensive .NET resilience and t\", \"ransient-fault-handling library that allows developers to express resiliency policies in a fluent an\", \"d thread-safe manner. Polly targets applications built with either .NET Framework or .NET 7. The fol\", \"lowing table describes the resiliency features, called policies, available in the Polly Library. The\", \"y can be applied individually or grouped together.\\n\\n| Policy          | Experience                  \", \"                                                                         |\\n|-----------------|------\", \"------------------------------------------------------------------------------------------------|\\n| \", \"Retry           | Configures retry operations on designated  operations.                            \", \"                   |\\n| Circuit Breaker | Blocks requested operations for a predefined  period when f\", \"aults exceed a configured  threshold      |\\n| Timeout         | Places limit on the duration for whi\", \"ch a caller  can wait for a response.                            |\\n| Bulkhead        | Constrains ac\", \"tions to fixed - size resource pool to  prevent failing calls from swamping a resource. |\\n| Cache   \", \"        | Stores responses automatically.                                                           \", \"           |\\n| Fallback        | Defines structured behavior upon a failure.                        \", \"                                  |\\n\\nNote how in the previous figure the resiliency policies apply t\", \"o request messages, whether coming from an external client or back -end service. The goal is to comp\", \"ensate the request for a service that might be momentarily unavailable. These short-lived interrupti\", \"ons typically manifest themselves with the HTTP status codes shown in the following table.\\n\\n|   HTTP\", \" Status Code | Cause                                                 |\\n|--------------------|-------\", \"------------------------------------------------|\\n|                404 | Not Found                  \", \"                           |\\n|                408 | Request timeout                                 \", \"      |\\n|                429 | Too many requests (you\\u2019ve most likely been throttled) |\\n|            \", \"    502 | Bad gateway                                           |\\n|                503 | Service una\", \"vailable                                   |\\n\\nClient Mobile App\\n\\nClient SPA Web app\\n\\nBrowser\\n\\nJSON\\n\\n\", \"Back end\\n\\nRetries = 4\\n\\nDuration = 2 sec\\n\\nResiliency Configuration\\n\\n|   HTTP Status Code | Cause     \", \"          |\\n|--------------------|---------------------|\\n|                504 | Gateway timeout 500 \", \"|\\n\\nQuestion: Would you retry an HTTP Status Code of 403 Forbidden? No. Here, the system is functioni\", \"ng properly, but informing the caller that they aren't authorized to perform the requested operation\", \". Care must be taken to retry only those operations caused by failures.\\n\\nAs recommended in Chapter 1\", \", Microsoft developers constructing cloud-native applications should target the .NET platform. Versi\", \"on 2.1 introduced the HTTPClientFactory library for creating HTTP Client instances for interacting w\", \"ith URL-based resources. Superseding the original HTTPClient class, the factory class supports many \", \"enhanced features, one of which is tight integration with the Polly resiliency library. With it, you\", \" can easily define resiliency policies in the application Startup class to handle partial failures a\", \"nd connectivity issues.\\n\\nNext, let\\u2019s expand on retry and circuit breaker patterns.\\n\\n## Retry pattern\", \"\\n\\nIn a distributed cloud -native environment, calls to services and cloud resources can fail because\", \" of transient (short-lived) failures, which typically correct themselves after a brief period of tim\", \"e. Implementing a retry strategy helps a cloud-native service mitigate these scenarios.\\n\\nThe Retry p\", \"attern enables a service to retry a failed request operation a (configurable) number of times with a\", \"n exponentially increasing wait time. Figure 6-2 shows a retry in action.\\n\\nFigure 6 -2. Retry patter\", \"n in action\\n\\n<!-- image -->\\n\\nIn the previous figure, a retry pattern has been implemented for a requ\", \"est operation. It's configured to allow up to four retries before failing with a backoff interval (w\", \"ait time) starting at two seconds, which exponentially doubles for each subsequent attempt.\\n\\n- The f\", \"irst invocation fails and returns an HTTP status code of 500. The application waits for two seconds \", \"and retries the call.\\n\\n- The second invocation also fails and returns an HTTP status code of 500. Th\", \"e application now doubles the backoff interval to four seconds and retries the call.\\n- Finally, the \", \"third call succeeds.\\n- In this scenario, the retry operation would have attempted up to four retries\", \" while doubling the backoff duration before failing the call.\\n- Had the 4th retry attempt failed, a \", \"fallback policy would be invoked to gracefully handle the problem.\\n\\nIt's important to increase the b\", \"ackoff period before retrying the call to allow the service time to selfcorrect. It's a best practic\", \"e to implement an exponentially increasing backoff (doubling the period on each retry) to allow adeq\", \"uate correction time.\\n\\n## Circuit breaker pattern\\n\\nWhile the retry pattern can help salvage a reques\", \"t entangled in a partial failure, there are situations where failures can be caused by unanticipated\", \" events that will require longer periods of time to resolve. These faults can range in severity from\", \" a partial loss of connectivity to the complete failure of a service. In these situations, it's poin\", \"tless for an application to continually retry an operation that is unlikely to succeed.\\n\\nTo make thi\", \"ngs worse, executing continual retry operations on a non-responsive service can move you into a self\", \"-imposed denial of service scenario where you flood your service with continual calls exhausting res\", \"ources such as memory, threads and database connections, causing failure in unrelated parts of the s\", \"ystem that use the same resources.\\n\\nIn these situations, it would be preferable for the operation to\", \" fail immediately and only attempt to invoke the service if it's likely to succeed.\\n\\nThe Circuit Bre\", \"aker pattern can prevent an application from repeatedly trying to execute an operation that's likely\", \" to fail. After a pre-defined number of failed calls, it blocks all traffic to the service. Periodic\", \"ally, it will allow a trial call to determine whether the fault has resolved. Figure 6-3 shows the C\", \"ircuit Breaker pattern in action.\\n\\nClient Mobile App\\n\\nClient SPA Web app\\n\\nBrowser\\n\\nJSON\\n\\nJSON\\n\\nHTML\\n\", \"\\nRetries = 4\\n\\nDuration = 2 sec\\n\\nExceptionsAllowed = 100\\n\\nCheckCircuit = 30 seconds\\n\\nResiliency Confi\", \"guration\\n\\nFigure 6 -3. Circuit breaker pattern in action\\n\\n<!-- image -->\\n\\nIn the previous figure, a \", \"Circuit Breaker pattern has been added to the original retry pattern. Note how after 100 failed requ\", \"ests, the circuit breakers opens and no longer allows calls to the service. The CheckCircuit value, \", \"set at 30 seconds, specifies how often the library allows one request to proceed to the service. If \", \"that call succeeds, the circuit closes and the service is once again available to traffic.\\n\\nKeep in \", \"mind that the intent of the Circuit Breaker pattern is different than that of the Retry pattern. The\", \" Retry pattern enables an application to retry an operation in the expectation that it will succeed.\", \" The Circuit Breaker pattern prevents an application from doing an operation that is likely to fail.\", \" Typically, an application will combine these two patterns by using the Retry pattern to invoke an o\", \"peration through a circuit breaker.\\n\\n## Testing for resiliency\\n\\nTesting for resiliency cannot always\", \" be done the same way that you test application functionality (by running unit tests, integration te\", \"sts, and so on). Instead, you must test how the end-to-end workload performs under failure condition\", \"s, which only occur intermittently. For example: inject failures by crashing processes, expired cert\", \"ificates, make dependent services unavailable etc. Frameworks like chaos -monkey can be used for suc\", \"h chaos testing.\\n\\nApplication resiliency is a must for handling problematic requested operations. Bu\", \"t, it's only half of the story. Next, we cover resiliency features available in the Azure cloud.\\n\\n##\", \" Azure platform resiliency\\n\\nBuilding a reliable application in the cloud is different from tradition\", \"al on-premises application development. While historically you purchased higher-end hardware to scal\", \"e up, in a cloud environment you scale out. Instead of trying to prevent failures, the goal is to mi\", \"nimize their effects and keep the system stable.\\n\\nBack end\\n\\nThat said, reliable cloud applications d\", \"isplay distinct characteristics:\\n\\n- They're resilient, recover gracefully from problems, and continu\", \"e to function.\\n- They're highly available (HA) and run as designed in a healthy state with no signif\", \"icant downtime.\\n\\nUnderstanding how these characteristics work together - and how they affect cost is\", \" essential to building a reliable cloud-native application. We'll next look at ways that you can bui\", \"ld resiliency and availability into your cloud-native applications leveraging features from the Azur\", \"e cloud.\\n\\n## Design with resiliency\\n\\nWe've said resiliency enables your application to react to fail\", \"ure and still remain functional. The whitepaper, Resilience in Azure whitepaper, provides guidance f\", \"or achieving resilience in the Azure platform. Here are some key recommendations:\\n\\n- Hardware failur\", \"e. Build redundancy into the application by deploying components across different fault domains. For\", \" example, ensure that Azure VMs are placed in different racks by using Availability Sets.\\n- Datacent\", \"er failure. Build redundancy into the application with fault isolation zones across datacenters. For\", \" example, ensure that Azure VMs are placed in different fault-isolated datacenters by using Azure Av\", \"ailability Zones.\\n- Regional failure. Replicate the data and components into another region so that \", \"applications can be quickly recovered. For example, use Azure Site Recovery to replicate Azure VMs t\", \"o another Azure region.\\n- Heavy load. Load balance across instances to handle spikes in usage. For e\", \"xample, put two or more Azure VMs behind a load balancer to distribute traffic to all VMs.\\n- Acciden\", \"tal data deletion or corruption. Back up data so it can be restored if there's any deletion or corru\", \"ption. For example, use Azure Backup to periodically back up your Azure VMs.\\n\\n## Design with redunda\", \"ncy\\n\\nFailures vary in scope of impact. A hardware failure, such as a failed disk, can affect a singl\", \"e node in a cluster. A failed network switch could affect an entire server rack. Less common failure\", \"s, such as loss of power, could disrupt a whole datacenter. Rarely, an entire region becomes unavail\", \"able.\\n\\nRedundancy is one way to provide application resilience. The exact level of redundancy needed\", \" depends upon your business requirements and will affect both the cost and complexity of your system\", \". For example, a multi-region deployment is more expensive and more complex to manage than a single-\", \"region deployment. You'll need operational procedures to manage failover and failback. The additiona\", \"l cost and complexity might be justified for some business scenarios, but not others.\\n\\nTo architect \", \"redundancy, you need to identify the critical paths in your application, and then determine if there\", \"'s redundancy at each point in the path? If a subsystem should fail, will the application fail over \", \"to something else? Finally, you need a clear understanding of those features built\\n\\nSQL\\n\\nWest US\\n\\nSQ\", \"L\\n\\nCanada\\n\\nCentral\\n\\nSQL\\n\\nEurope into the Azure cloud platform that you can leverage to meet your red\", \"undancy requirements. Here are recommendations for architecting redundancy:\\n\\nEast US\\n\\n- Deploy multi\", \"ple instances of services. If your application depends on a single instance of a service, it creates\", \" a single point of failure. Provisioning multiple instances improves both resiliency and scalability\", \". When hosting in Azure Kubernetes Service, you can declaratively configure redundant instances (rep\", \"lica sets) in the Kubernetes manifest file. The replica count value can be managed programmatically,\", \" in the portal, or through autoscaling features.\\n- Leveraging a load balancer. Load-balancing distri\", \"butes your application's requests to healthy service instances and automatically removes unhealthy i\", \"nstances from rotation. When deploying to Kubernetes, load balancing can be specified in the Kuberne\", \"tes manifest file in the Services section.\\n- Plan for multiregion deployment. If you deploy your app\", \"lication to a single region, and that region becomes unavailable, your application will also become \", \"unavailable. This may be unacceptable under the terms of your application's service level agreements\", \". Instead, consider deploying your application and its services across multiple regions. For example\", \", an Azure Kubernetes Service (AKS) cluster is deployed to a single region. To protect your system f\", \"rom a regional failure, you might deploy your application to multiple AKS clusters across different \", \"regions and use the Paired Regions feature to coordinate platform updates and prioritize recovery ef\", \"forts.\\n- Enable geo-replication . Geo -replication for services such as Azure SQL Database and Cosmo\", \"s DB will create secondary replicas of your data across multiple regions. While both services will a\", \"utomatically replicate data within the same region, geo-replication protects you against a regional \", \"outage by enabling you to fail over to a secondary region. Another best practice for geo -replicatio\", \"n centers around storing container images. To deploy a service in AKS, you need to store and pull th\", \"e image from a repository. Azure Container Registry integrates with AKS and can securely store conta\", \"iner images. To improve performance and availability, consider geo-replicating your images to a regi\", \"stry in each region where you have an AKS cluster. Each AKS cluster then pulls container images from\", \" the local container registry in its region as shown in Figure 6-4:\\n\\nFigure 6 -4 . Replicated resour\", \"ces across regions\\n\\n<!-- image -->\\n\\nWest \\u2022\\n\\nSQL\\n\\nNetwork\\n\\nInfrastructure\\n\\nAzure\\n\\nTraffic Manager\\n\\n- \", \"Implement a DNS traffic load balancer. Azure Traffic Manager provides high-availability for critical\", \" applications by load-balancing at the DNS level. It can route traffic to different regions based on\", \" geography, cluster response time, and even application endpoint health. For example, Azure Traffic \", \"Manager can direct customers to the closest AKS cluster and application instance. If you have multip\", \"le AKS clusters in different regions, use Traffic Manager to control how traffic flows to the applic\", \"ations that run in each cluster. Figure 6-5 shows this scenario. Load Balancer\\n\\nFigure 6 -5. AKS and\", \" Azure Traffic Manager\\n\\n<!-- image -->\\n\\n## Design for scalability\\n\\nThe cloud thrives on scaling. The\", \" ability to increase/decrease system resources to address increasing/decreasing system load is a key\", \" tenet of the Azure cloud. But, to effectively scale an application, you need an understanding of th\", \"e scaling features of each Azure service that you include in your application. Here are recommendati\", \"ons for effectively implementing scaling in your system.\\n\\n- Design for scaling. An application must \", \"be designed for scaling. To start, services should be stateless so that requests can be routed to an\", \"y instance. Having stateless services also means that adding or removing an instance doesn't adverse\", \"ly impact current users.\\n- Partition workloads. Decomposing domains into independent, self-contained\", \" microservices enable each service to scale independently of others. Typically, services will have d\", \"ifferent scalability needs and requirements. Partitioning enables you to scale only what needs to be\", \" scaled without the unnecessary cost of scaling an entire application.\\n- Favor scale -out. Cloud -ba\", \"sed applications favor scaling out resources as opposed to scaling up. Scaling out (also known as ho\", \"rizontal scaling) involves adding more service resources to an existing system to meet and share a d\", \"esired level of performance. Scaling up (also known\\n\\nScale Up (vertical scaling)\\n\\nIncrease capacity \", \"by adding\\n\\nRAM/CPU/Disk to a single resource\\n\\nas vertical scaling) involves replacing existing resou\", \"rces with more powerful hardware (more disk, memory, and processing cores). Scaling out can be invok\", \"ed automatically with the autoscaling features available in some Azure cloud resources. Scaling out \", \"across multiple resources also adds redundancy to the overall system. Finally scaling up a single re\", \"source is typically more expensive than scaling out across many smaller resources. Figure 6-6 shows \", \"the two approaches:\\n\\nFigure 6 -6. Scale up versus scale out\\n\\n<!-- image -->\\n\\n- Scale proportionally.\", \" When scaling a service, think in terms of resource sets. If you were to dramatically scale out a sp\", \"ecific service, what impact would that have on back-end data stores, caches and dependent services? \", \"Some resources such as Cosmos DB can scale out proportionally, while many others can't. You want to \", \"ensure that you don't scale out a resource to a point where it will exhaust other associated resourc\", \"es.\\n- Avoid affinity. A best practice is to ensure a node doesn't require local affinity, often refe\", \"rred to as a sticky session. A request should be able to route to any instance. If you need to persi\", \"st state, it should be saved to a distributed cache, such as Azure Redis cache .\\n- Take advantage of\", \" platform autoscaling features. Use built-in autoscaling features whenever possible, rather than cus\", \"tom or third-party mechanisms. Where possible, use scheduled scaling rules to ensure that resources \", \"are available without a startup delay, but add reactive autoscaling to the rules as appropriate, to \", \"cope with unexpected changes in demand. For more information, see Autoscaling guidance .\\n- Scale out\", \" aggressively. A final practice would be to scale out aggressively so that you can quickly meet imme\", \"diate spikes in traffic without losing business. And, then scale in (that is, remove unneeded instan\", \"ces) conservatively to keep the system stable. A simple way to implement this is to set the cool dow\", \"n period, which is the time to wait between scaling operations, to five minutes for adding resources\", \" and up to 15 minutes for removing instances.\\n\\n## Built -in retry in services\\n\\nWe encouraged the bes\", \"t practice of implementing programmatic retry operations in an earlier section. Keep in mind that ma\", \"ny Azure services and their corresponding client SDKs also include retry\\n\\nScale Out (horizontal scal\", \"ing)\\n\\nIncrease capacity by adding resources\\n\\nmechanisms. The following list summarizes retry feature\", \"s in the many of the Azure services that are discussed in this book:\\n\\n- Azure Cosmos DB. The Documen\", \"tClient class from the client API automatically retires failed attempts. The number of retries and m\", \"aximum wait time are configurable. Exceptions thrown by the client API are either requests that exce\", \"ed the retry policy or non-transient errors.\\n- Azure Redis Cache. The Redis StackExchange client use\", \"s a connection manager class that includes retries on failed attempts. The number of retries, specif\", \"ic retry policy and wait time are all configurable.\\n- Azure Service Bus. The Service Bus client expo\", \"ses a RetryPolicy class that can be configured with a back -off interval, retry count, and Terminati\", \"onTimeBuffer, which specifies the maximum time an operation can take. The default policy is nine max\", \"imum retry attempts with a 30second backoff period between attempts.\\n- Azure SQL Database. Retry sup\", \"port is provided when using the Entity Framework Core library.\\n- Azure Storage. The storage client l\", \"ibrary support retry operations. The strategies vary across Azure storage tables, blobs, and queues.\", \" As well, alternate retries switch between primary and secondary storage services locations when the\", \" geo-redundancy feature is enabled.\\n- Azure Event Hubs. The Event Hub client library features a Retr\", \"yPolicy property, which includes a configurable exponential backoff feature.\\n\\n## Resilient communica\", \"tions\\n\\nThroughout this book, we've embraced a microservice-based architectural approach. While such \", \"an architecture provides important benefits, it presents many challenges:\\n\\n- Out -of-process network\", \" communication. Each microservice communicates over a network protocol that introduces network conge\", \"stion, latency, and transient faults.\\n- Service discovery. How do microservices discover and communi\", \"cate with each other when running across a cluster of machines with their own IP addresses and ports\", \"?\\n- Resiliency. How do you manage short-lived failures and keep the system stable?\\n- Load balancing.\", \" How does inbound traffic get distributed across multiple instances of a microservice?\\n- Security. H\", \"ow are security concerns such as transport-level encryption and certificate management enforced?\\n- D\", \"istributed Monitoring. - How do you correlate and capture traceability and monitoring for a single r\", \"equest across multiple consuming microservices?\\n\\nYou can address these concerns with different libra\", \"ries and frameworks, but the implementation can be expensive, complex, and time-consuming. You also \", \"end up with infrastructure concerns coupled to business logic.\\n\\nCloud\\n\\nSidecar Proxy\\n\\n## Service mes\", \"h\\n\\nMicroservice\\n\\nSidecar Proxy\\n\\nMicroservice\\n\\nSidecar Proxy\\n\\nMicroservice\\n\\nA better approach is an e\", \"volving technology entitled Service Mesh. A service mesh is a configurable infrastructure layer with\", \" built-in capabilities to handle service communication and the other challenges mentioned above. It \", \"decouples these concerns by moving them into a service proxy. The proxy is deployed into a separate \", \"process (called a sidecar) to provide isolation from business code. However, the sidecar is linked t\", \"o the service - it's created with it and shares its lifecycle. Figure 6-7 shows this scenario.\\n\\nMicr\", \"oservice\\n\\nFigure 6 -7. Service mesh with a side car\\n\\n<!-- image -->\\n\\nIn the previous figure, note ho\", \"w the proxy intercepts and manages communication among the microservices and the cluster.\\n\\nA service\", \" mesh is logically split into two disparate components: A data plane and control plane. Figure 6 -8 \", \"shows these components and their responsibilities.\\n\\nMicroservice\\n\\nHTTP\\n\\ngRPC\\n\\nC#\\n\\nService 1\\n\\nSidecar\", \" Proxy\\n\\nManagement\\n\\nMonitoring\\n\\nProvisioning\\n\\nScaling\\n\\nFigure 6 -8. Service mesh control and data pl\", \"ane\\n\\n<!-- image -->\\n\\nOnce configured, a service mesh is highly functional. It can retrieve a corresp\", \"onding pool of instances from a service discovery endpoint. The mesh can then send a request to a sp\", \"ecific instance, recording the latency and response type of the result. A mesh can choose the instan\", \"ce most likely to return a fast response based on many factors, including its observed latency for r\", \"ecent requests.\\n\\nIf an instance is unresponsive or fails, the mesh will retry the request on another\", \" instance. If it returns errors, a mesh will evict the instance from the load -balancing pool and re\", \"state it after it heals. If a request times out, a mesh can fail and then retry the request. A mesh \", \"captures and emits metrics and distributed tracing to a centralized metrics system.\\n\\n## Istio and En\", \"voy\\n\\nWhile a few service mesh options currently exist, Istio is the most popular at the time of this\", \" writing. Istio is a joint venture from IBM, Google, and Lyft. It's an open-source offering that can\", \" be integrated into a new or existing distributed application. The technology provides a consistent \", \"and complete solution to secure, connect, and monitor microservices. Its features include:\\n\\n- Secure\", \" service -to -service communication in a cluster with strong identity-based authentication and autho\", \"rization.\\n- Automatic load balancing for HTTP, gRPC, WebSocket, and TCP traffic.\\n- Fine -grained con\", \"trol of traffic behavior with rich routing rules, retries, failovers, and fault injection.\\n- A plugg\", \"able policy layer and configuration API supporting access controls, rate limits, and quotas.\\n- Autom\", \"atic metrics, logs, and traces for all traffic within a cluster, including cluster ingress and egres\", \"s.\\n\\nA key component for an Istio implementation is a proxy service entitled the Envoy proxy. It runs\", \" alongside each service and provides a platform-agnostic foundation for the following features:\\n\\n- D\", \"ynamic service discovery.\\n- Load balancing.\\n\\nControl Plane\\n\\n- TLS termination.\\n- HTTP and gRPC proxi\", \"es.\\n- Circuit breaker resiliency.\\n- Health checks.\\n- Rolling updates with canary deployments.\\n\\nAs pr\", \"eviously discussed, Envoy is deployed as a sidecar to each microservice in the cluster.\\n\\n## Integrat\", \"ion with Azure Kubernetes Services\\n\\nThe Azure cloud embraces Istio and provides direct support for i\", \"t within Azure Kubernetes Services. The following links can help you get started:\\n\\n- Installing Isti\", \"o in AKS\\n- Using AKS and Istio\\n\\n## References\\n\\n- Polly\\n- Retry pattern\\n- Circuit Breaker pattern\\n- R\", \"esilience in Azure whitepaper\\n- network latency\\n- Redundancy\\n- geo -replication\\n- Azure Traffic Mana\", \"ger\\n- Autoscaling guidance\\n- Istio\\n- Envoy proxy\\n\\n## Monitoring and health\\n\\nMicroservices and cloud \", \"-native applications go hand in hand with good DevOps practices. DevOps is many things to many peopl\", \"e but perhaps one of the better definitions comes from cloud advocate and DevOps evangelist Donovan \", \"Brown:\\n\\n\\\"DevOps is the union of people, process, and products to enable continuous delivery of value\", \" to our end users.\\\"\\n\\nUnfortunately, with terse definitions, there's always room to say more things. \", \"One of the key components of DevOps is ensuring that the applications running in production are func\", \"tioning properly and efficiently. To gauge the health of the application in production, it's necessa\", \"ry to monitor the various logs and metrics being produced from the servers, hosts, and the applicati\", \"on proper. The number of different services running in support of a cloud-native application makes m\", \"onitoring the health of individual components and the application as a whole a critical challenge.\\n\\n\", \"## Observability patterns\\n\\nJust as patterns have been developed to aid in the layout of code in appl\", \"ications, there are patterns for operating applications in a reliable way. Three useful patterns in \", \"maintaining applications have emerged: logging , monitoring, and alerts .\\n\\n## When to use logging\\n\\nN\", \"o matter how careful we are, applications almost always behave in unexpected ways in production. Whe\", \"n users report problems with an application, it's useful to be able to see what was going on with th\", \"e app when the problem occurred. One of the most tried and true ways of capturing information about \", \"what an application is doing while it's running is to have the application write down what it's doin\", \"g. This process is known as logging. Anytime failures or problems occur in production, the goal shou\", \"ld be to reproduce the conditions under which the failures occurred, in a non-production environment\", \". Having good logging in place provides a roadmap for developers to follow in order to duplicate pro\", \"blems in an environment that can be tested and experimented with.\\n\\n## Challenges when logging with c\", \"loud-native applications\\n\\nIn traditional applications, log files are typically stored on the local m\", \"achine. In fact, on Unix-like operating systems, there's a folder structure defined to hold any logs\", \", typically under /var/log.\\n\\nMonolithic App (scaled out)\\n\\nNode 1\\n\\n- - 7\\n\\nASP.NET MVC app\\n\\nUl Endpoin\", \"ts\\n\\nBusiness Logic\\n\\nData Access Logic\\n\\nA\\n\\nLogfile\\n\\nMonolithic App\\n\\n## ASP.NET MVC app Node 2 ASP.NET\", \" MVC app Node 3 ASP.NET MVC app\\n\\nData Access Logic\\n\\nFigure 7 -1. Logging to a file in a monolithic a\", \"pp.\\n\\n<!-- image -->\\n\\nThe usefulness of logging to a flat file on a single machine is vastly reduced \", \"in a cloud environment. Applications producing logs may not have access to the local disk or the loc\", \"al disk may be highly transient as containers are shuffled around physical machines. Even simple sca\", \"ling up of monolithic applications across multiple nodes can make it challenging to locate the appro\", \"priate file-based log file.\\n\\nFigure 7 -2. Logging to files in a scaled monolithic app.\\n\\n<!-- image -\", \"->\\n\\nCloud -native applications developed using a microservices architecture also pose some challenge\", \"s for file -based loggers. User requests may now span multiple services that are run on different ma\", \"chines\\n\\nClient\\n\\nRequest\\n\\nLocal Log File per Service and may include serverless functions with no acc\", \"ess to a local file system at all. It would be very challenging to correlate the logs from a user or\", \" a session across these many services and machines.\\n\\n## container \\\\_ Local logfile ' container Local\", \" logfile,\\n\\nMicroservice 2\\n\\nFigure 7 -3. Logging to local files in a microservices app.\\n\\n<!-- image -\", \"->\\n\\nFinally, the number of users in some cloud-native applications is high. Imagine that each user g\", \"enerates a hundred lines of log messages when they log into an application. In isolation, that is ma\", \"nageable, but multiply that over 100,000 users and the volume of logs becomes large enough that spec\", \"ialized tools are needed to support effective use of the logs.\\n\\n## Logging in cloud-native applicati\", \"ons\\n\\nEvery programming language has tooling that permits writing logs, and typically the overhead fo\", \"r writing these logs is low. Many of the logging libraries provide logging different kinds of critic\", \"alities, which can be tuned at run time. For instance, the Serilog library is a popular structured l\", \"ogging library for .NET that provides the following logging levels:\\n\\n- Verbose\\n- Debug\\n- Information\", \"\\n- Warning\\n- Error\\n- Fatal\\n\\nThese different log levels provide granularity in logging. When the appl\", \"ication is functioning properly in production, it may be configured to only log important messages. \", \"When the application is\\n\\nBackend\\n\\n1\\n\\n| UpdatePrice command\\n\\nDatabase\\n\\n2\\n\\n3\\n\\nImplementing centralized\", \" logging misbehaving, then the log level can be increased so more verbose logs are gathered. This ba\", \"lances performance against ease of debugging. cache Service 2\\n\\nThe high performance of logging tools\", \" and the tunability of verbosity should encourage developers to log frequently. Many favor a pattern\", \" of logging the entry and exit of each method. This approach may sound like overkill, but it's infre\", \"quent that developers will wish for less logging. In fact, it's not uncommon to perform deployments \", \"for the sole purpose of adding logging around a problematic method. Err on the side of too much logg\", \"ing and not on too little. Some tools can be used to automatically provide this kind of logging. Ser\", \"vice N\\n\\nA\\n\\nBecause of the challenges associated with using file-based logs in cloud-native apps, cen\", \"tralized logs are preferred. Logs are collected by the applications and shipped to a central logging\", \" application which indexes and stores the logs. This class of system can ingest tens of gigabytes of\", \" logs every day.\\n\\nIt's also helpful to follow some standard practices when building logging that spa\", \"ns many services. For instance, generating a correlation ID at the start of a lengthy interaction, a\", \"nd then logging it in each message that is related to that interaction, makes it easier to search fo\", \"r all related messages. One need only find a single message and extract the correlation ID to find a\", \"ll the related messages. Another example is ensuring that the log format is the same for every servi\", \"ce, whatever the language or logging library it uses. This standardization makes reading logs much e\", \"asier. Figure 7-4 demonstrates how a microservices architecture can leverage centralized logging as \", \"part of its workflow.\\n\\nFigure 7 -4. Logs from various sources are ingested into a centralized log st\", \"ore.\\n\\n<!-- image -->\\n\\n## Challenges with detecting and responding to potential app health issues\\n\\nSo\", \"me applications aren't mission critical. Maybe they're only used internally, and when a problem occu\", \"rs, the user can contact the team responsible and the application can be restarted. However, custome\", \"rs often have higher expectations for the applications they consume. You should know when problems o\", \"ccur with your application before users do, or before users notify you. Otherwise, the first you kno\", \"w about a problem may be when you notice an angry deluge of social media posts deriding your applica\", \"tion or even your organization.\\n\\nSome scenarios you may need to consider include:\\n\\n- One service in \", \"your application keeps failing and restarting, resulting in intermittent slow responses.\\n- At some t\", \"imes of the day, your application's response time is slow.\\n- After a recent deployment, load on the \", \"database has tripled.\\n\\nImplemented properly, monitoring can let you know about conditions that will \", \"lead to problems, letting you address underlying conditions before they result in any significant us\", \"er impact.\\n\\n## Monitoring cloud-native apps\\n\\nSome centralized logging systems take on an additional \", \"role of collecting telemetry outside of pure logs. They can collect metrics, such as time to run a d\", \"atabase query, average response time from a web server, and even CPU load averages and memory pressu\", \"re as reported by the operating system. In conjunction with the logs, these systems can provide a ho\", \"listic view of the health of nodes in the system and the application as a whole.\\n\\nThe metric -gather\", \"ing capabilities of the monitoring tools can also be fed manually from within the application. Busin\", \"ess flows that are of particular interest such as new users signing up or orders being placed, may b\", \"e instrumented such that they increment a counter in the central monitoring system. This aspect unlo\", \"cks the monitoring tools to not only monitor the health of the application but the health of the bus\", \"iness.\\n\\nQueries can be constructed in the log aggregation tools to look for certain statistics or pa\", \"tterns, which can then be displayed in graphical form, on custom dashboards. Frequently, teams will \", \"invest in large, wall -mounted displays that rotate through the statistics related to an application\", \". This way, it's simple to see the problems as they occur.\\n\\nCloud -native monitoring tools provide r\", \"eal-time telemetry and insight into apps regardless of whether they're single-process monolithic app\", \"lications or distributed microservice architectures. They include tools that allow collection of dat\", \"a from the app as well as tools for querying and displaying information about the app's health.\\n\\n## \", \"Challenges with reacting to critical problems in cloud-native apps\\n\\nIf you need to react to problems\", \" with your application, you need some way to alert the right personnel. This is the third cloud-nati\", \"ve application observability pattern and depends on logging and monitoring. Your application needs t\", \"o have logging in place to allow problems to be diagnosed, and\\n\\nin some cases to feed into monitorin\", \"g tools. It needs monitoring to aggregate application metrics and health data in one place. Once thi\", \"s has been established, rules can be created that will trigger alerts when certain metrics fall outs\", \"ide of acceptable levels.\\n\\nGenerally, alerts are layered on top of monitoring such that certain cond\", \"itions trigger appropriate alerts to notify team members of urgent problems. Some scenarios that may\", \" require alerts include:\\n\\n- One of your application's services is not responding after 1 minute of d\", \"owntime.\\n- Your application is returning unsuccessful HTTP responses to more than 1% of requests.\\n- \", \"Your application's average response time for key endpoints exceeds 2000 ms.\\n\\n## Alerts in cloud -nat\", \"ive apps\\n\\nYou can craft queries against the monitoring tools to look for known failure conditions. F\", \"or instance, queries could search through the incoming logs for indications of HTTP status code 500,\", \" which indicates a problem on a web server. As soon as one of these is detected, then an e-mail or a\", \"n SMS could be sent to the owner of the originating service who can begin to investigate.\\n\\nTypically\", \", though, a single 500 error isn't enough to determine that a problem has occurred. It could mean th\", \"at a user mistyped their password or entered some malformed data. The alert queries can be crafted t\", \"o only fire when a larger than average number of 500 errors are detected.\\n\\nOne of the most damaging \", \"patterns in alerting is to fire too many alerts for humans to investigate. Service owners will rapid\", \"ly become desensitized to errors that they've previously investigated and found to be benign. Then, \", \"when true errors occur, they'll be lost in the noise of hundreds of false positives. The parable of \", \"the Boy Who Cried Wolf is frequently told to children to warn them of this very danger. It's importa\", \"nt to ensure that the alerts that do fire are indicative of a real problem.\\n\\n## Logging with Elastic\", \" Stack\\n\\nThere are many good centralized logging tools and they vary in cost from being free, open-so\", \"urce tools, to more expensive options. In many cases, the free tools are as good as or better than t\", \"he paid offerings. One such tool is a combination of three open-source components: Elasticsearch, Lo\", \"gstash, and Kibana.\\n\\nCollectively these tools are known as the Elastic Stack or ELK stack.\\n\\n## Elast\", \"ic Stack\\n\\nThe Elastic Stack is a powerful option for gathering information from a Kubernetes cluster\", \". Kubernetes supports sending logs to an Elasticsearch endpoint, and for the most part, all you need\", \" to get started is to set the environment variables as shown in Figure 7-5:\\n\\nKUBE\\\\_LOGGING\\\\_DESTINAT\", \"ION=elasticsearch KUBE\\\\_ENABLE\\\\_NODE\\\\_LOGGING=true\\n\\nFigure 7 -5. Configuration variables for Kuberne\", \"tes\\n\\nThis step will install Elasticsearch on the cluster and target sending all the cluster logs to \", \"it.\\n\\nB\\n\\n*\\n\\n88,833 hits\\n\\nSearch\\u2026.. (e.g. status:200 AND extension:PHP)\\n\\nAdd a filter +\\n\\neshops-*\\n\\nSel\", \"ected Fields\\n\\n?\\n\\n\\\\_source\\n\\nAvailable Fields\\n\\n\\u2022 @timestamp t @version\\n\\nt \\\\_id t \\\\_index\\n\\n\\\\_score t \\\\_\", \"type\\n\\nt e.Level t e.MessageTempl...\\n\\nNew Save Open\\n\\nMarch 19th 2019, 15:33:34.099 - March 19th 2019,\", \" 15:48:34.099 \\u2014\\n\\nAuto\\n\\nFigure 7 -6. An example of a Kibana dashboard showing the results of a query \", \"against logs that are ingested from Kubernetes\\n\\n<!-- image -->\\n\\n## What are the advantages of Elasti\", \"c Stack?\\n\\nElastic Stack provides centralized logging in a low-cost, scalable, cloud-friendly manner.\", \" Its user interface streamlines data analysis so you can spend your time gleaning insights from your\", \" data instead of fighting with a clunky interface. It supports a wide variety of inputs so as your d\", \"istributed application spans more and different kinds of services, you can expect to continue to be \", \"able to feed log and metric data into the system. The Elastic Stack also supports fast searches even\", \" across large data sets, making it possible even for large applications to log detailed data and sti\", \"ll be able to have visibility into it in a performant fashion.\\n\\n## Logstash\\n\\nThe first component is \", \"Logstash. This tool is used to gather log information from a large variety of different sources. For\", \" instance, Logstash can read logs from disk and also receive messages from logging libraries like Se\", \"rilog. Logstash can do some basic filtering and expansion on the logs as they arrive. For instance, \", \"if your logs contain IP addresses then Logstash may be configured to do a geographical lookup and ob\", \"tain a country/region or even city of origin for that message .\\n\\nSerilog is a logging library for .N\", \"ET languages, which allows for parameterized logging. Instead of generating a textual log message th\", \"at embeds fields, parameters are kept separate. This library allows for more intelligent filtering a\", \"nd searching. A sample Serilog configuration for writing to Logstash appears in Figure 7-7.\\n\\n```\\nvar\", \" log = new LoggerConfiguration() . WriteTo . Http(\\\"http://localhost:8080\\\") . CreateLogger();\\n```\\n\\nFi\", \"gure 7 -7. Serilog config for writing log information directly to logstash over HTTP\\n\\nLogstash would\", \" use a configuration like the one shown in Figure 7-8.\\n\\nShare\\n\\n\\u2022 Last 15 minutes\\n\\nUses lucene query \", \"syntax\\n\\n```\\ninput { http { #default host 0.0.0.0:8080 codec => json } } output { elasticsearch { hos\", \"ts => \\\"elasticsearch:9200\\\" index=>\\\"sales -%{+xxxx.ww}\\\" } }\\n```\\n\\nFigure 7 -8. A Logstash configuratio\", \"n for consuming logs from Serilog\\n\\nFor scenarios where extensive log manipulation isn't needed there\", \"'s an alternative to Logstash known as Beats. Beats is a family of tools that can gather a wide vari\", \"ety of data from logs to network data and uptime information. Many applications will use both Logsta\", \"sh and Beats.\\n\\nOnce the logs have been gathered by Logstash, it needs somewhere to put them. While L\", \"ogstash supports many different outputs, one of the more exciting ones is Elasticsearch.\\n\\n## Elastic\", \"search\\n\\nElasticsearch is a powerful search engine that can index logs as they arrive. It makes runni\", \"ng queries against the logs quick. Elasticsearch can handle huge quantities of logs and, in extreme \", \"cases, can be scaled out across many nodes.\\n\\nLog messages that have been crafted to contain paramete\", \"rs or that have had parameters split from them through Logstash processing, can be queried directly \", \"as Elasticsearch preserves this information.\\n\\nA query that searches for the top 10 pages visited by \", \"jill@example.com, appears in Figure 7-9.\\n\\n```\\n\\\"query\\\": { \\\"match\\\": { \\\"user\\\": \\\"jill@example.com\\\" } } ,\", \" \\\"aggregations\\\": { \\\"top_10_pages\\\": { \\\"terms\\\": { \\\"field\\\": \\\"page\\\" , \\\"size\\\": 10 } } }\\n```\\n\\nFigure 7 -9.\", \" An Elasticsearch query for finding top 10 pages visited by a user\\n\\n## Visualizing information with \", \"Kibana web dashboards\\n\\nThe final component of the stack is Kibana. This tool is used to provide inte\", \"ractive visualizations in a web dashboard. Dashboards may be crafted even by users who are non-techn\", \"ical. Most data that is resident in the Elasticsearch index, can be included in the Kibana dashboard\", \"s. Individual users may\\n\\nhave different dashboard desires and Kibana enables this customization thro\", \"ugh allowing userspecific dashboards.\\n\\n## Installing Elastic Stack on Azure\\n\\nThe Elastic stack can b\", \"e installed on Azure in many ways. As always, it's possible to provision virtual machines and instal\", \"l Elastic Stack on them directly. This option is preferred by some experienced users as it offers th\", \"e highest degree of customizability. Deploying on infrastructure as a service introduces significant\", \" management overhead forcing those who take that path to take ownership of all the tasks associated \", \"with infrastructure as a service such as securing the machines and keeping up-to-date with patches.\\n\", \"\\nAn option with less overhead is to make use of one of the many Docker containers on which the Elast\", \"ic Stack has already been configured. These containers can be dropped into an existing Kubernetes cl\", \"uster and run alongside application code. The sebp/elk container is a well-documented and tested Ela\", \"stic Stack container.\\n\\nAnother option is a recently announced ELK-as-a-service offering .\\n\\n## Refere\", \"nces\\n\\n- Install Elastic Stack on Azure\\n\\n## Monitoring in Azure Kubernetes Services\\n\\nThe built -in lo\", \"gging in Kubernetes is primitive. However, there are some great options for getting the logs out of \", \"Kubernetes and into a place where they can be properly analyzed. If you need to monitor your AKS clu\", \"sters, configuring Elastic Stack for Kubernetes is a great solution.\\n\\n## Azure Monitor for Container\", \"s\\n\\nAzure Monitor for Containers supports consuming logs from not just Kubernetes but also from other\", \" orchestration engines such as DC/OS, Docker Swarm, and Red Hat OpenShift.\\n\\nOther Clouds\\n\\nVM\\n\\nVM wit\", \"h agent\\n\\nFigure 7 -10. Consuming logs from various containers\\n\\n<!-- image -->\\n\\nPrometheus is a popul\", \"ar open source metric monitoring solution. It is part of the Cloud Native Compute Foundation. Typica\", \"lly, using Prometheus requires managing a Prometheus server with its own store. However, Azure Monit\", \"or for Containers provides direct integration with Prometheus metrics endpoints, so a separate serve\", \"r is not required.\\n\\nLog and metric information is gathered not just from the containers running in t\", \"he cluster but also from the cluster hosts themselves. It allows correlating log information from th\", \"e two making it much easier to track down an error.\\n\\nInstalling the log collectors differs on Window\", \"s and Linux clusters. But in both cases the log collection is implemented as a Kubernetes DaemonSet \", \", meaning that the log collector is run as a container on each of the nodes.\\n\\nNo matter which orches\", \"trator or operating system is running the Azure Monitor daemon, the log information is forwarded to \", \"the same Azure Monitor tools with which users are familiar. This approach ensures a parallel experie\", \"nce in environments that mix different log sources such as a hybrid Kubernetes/Azure Functions envir\", \"onment.\\n\\nLocall\\n\\nVM\\n\\nVM with agent\\n\\nAzure\\n\\nAzure\\n\\nContainers(contosoretail-it)\\n\\n\\u00a9 Refresh\\n\\n@ Solutio\", \"n Settings\\n\\nIP Logs\\n\\n2/26/19 13:08 - 2/27/19 13:08\\n\\nCONTAINER IMAGES INVENTORY\\n\\n60\\n\\n39\\n\\nTotal Images\", \" kubernetes-d... v1.10.1\\n\\noms ciprod112920\\\\_\\n\\noms ciprod101620\\\\_\\n\\nk8s-dns-kub...\\n\\n1,14.13\\n\\nkubernete\", \"s-d... v1.10.0\\n\\nkube-svc-red. v1.02\\n\\nbusybox latest\\n\\nhop-tunnel-fr... v1.92-14.04\\n\\nhyperkube-a.. v19\", \"9\\n\\nnginx\\n\\n1.13.12-alpine\\n\\nSee all.\\n\\nImage Type Count\\n\\nCOUNT\\n\\nCONTAINERS STATUS\\n\\n7\\n\\nTotal Container N\", \"odes\\n\\n300\\n\\nTotal Running Containers\\n\\nCONTAINER CPU PERFORMANCE\\n\\nCPU Usage Over Time\\n\\n40%\\n\\nFigure 7 -\", \"11. A sample dashboard showing logging and metric information from many running containers.\\n\\n<!-- im\", \"age -->\\n\\n## Log.Finalize()\\n\\nLogging is one of the most overlooked and yet most important parts of de\", \"ploying any application at scale. As the size and complexity of applications increase, then so does \", \"the difficulty of debugging them. Having top quality logs available makes debugging much easier and \", \"moves it from the realm of \\\"nearly impossible\\\" to \\\"a pleasant experience\\\".\\n\\n## Azure Monitor\\n\\nNo oth\", \"er cloud provider has as mature of a cloud application monitoring solution than that found in Azure.\", \" Azure Monitor is an umbrella name for a collection of tools designed to provide visibility into the\", \" state of your system. It helps you understand how your cloud-native services are performing and pro\", \"actively identifies issues affecting them. Figure 7-12 presents a high level of view of Azure Monito\", \"r.\\n\\nCONTAINER PROCESS\\n\\nContainer Process Counts\\n\\nCONTAINER MEMORY PERFORMANCE\\n\\nMemory Usage Over Tim\", \"e\\n\\nApplication\\n\\nOperating System\\n\\nAzure Resources\\n\\nAzure Subscription\\n\\nAzure Tenant\\n\\nCustom Sources\\n\", \"\\nAzure Monitor \\u2022\\n\\nInsights\\n\\nApplication\\n\\nContainer\\n\\nVM\\n\\nMonitoring\\n\\nSolutions\\n\\nFigure 7 -12. High -l\", \"evel view of Azure Monitor.\\n\\n<!-- image -->\\n\\n## Gathering logs and metrics\\n\\nThe first step in any mo\", \"nitoring solution is to gather as much data as possible. The more data gathered, the deeper the insi\", \"ghts. Instrumenting systems has traditionally been difficult. Simple Network Management Protocol (SN\", \"MP) was the gold standard protocol for collecting machine level information, but it required a great\", \" deal of knowledge and configuration. Fortunately, much of this hard work has been eliminated as the\", \" most common metrics are gathered automatically by Azure Monitor.\\n\\nApplication level metrics and eve\", \"nts aren't possible to instrument automatically because they're specific to the application being de\", \"ployed. In order to gather these metrics, there are SDKs and APIs available to directly report such \", \"information, such as when a customer signs up or completes an order. Exceptions can also be captured\", \" and reported back into Azure Monitor via Application Insights. The SDKs support most every language\", \" found in Cloud Native Applications including Go, Python, JavaScript, and the .NET languages.\\n\\nThe u\", \"ltimate goal of gathering information about the state of your application is to ensure that your end\", \" users have a good experience. What better way to tell if users are experiencing issues than doing o\", \"utside -in web tests? These tests can be as simple as pinging your website from locations around the\", \" world or as involved as having agents log into the site and simulate user actions.\\n\\n## Reporting da\", \"ta\\n\\nOnce the data is gathered, it can be manipulated, summarized, and plotted into charts, which all\", \"ow users to instantly see when there are problems. These charts can be gathered into dashboards or i\", \"nto Workbooks, a multi-page report designed to tell a story about some aspect of the system.\\n\\n&lt; G\", \"raph\\n\\n# Table 1\\n\\n\\u2022 Stats\\n\\nHAWAII: 10.58%\\n\\nKENTUCKY: 7.68%\\\\_\\n\\nGEORGIA: 15.36%\\n\\nCOLORADO: 7.25%\\n\\nALABA\", \"MA: 8.12%\\n\\n\\u2022 Done (0.819 s)\\n\\n123\\n\\n10 records\\n\\n-o ALABAMA\\n\\n-- COLORADO\\n\\n-- GEORGIA\\n\\n-- HAWAII\\n\\n-- KEN\", \"TUCKY\\n\\n-- MONTANA\\n\\nNo modern application would be complete without some artificial intelligence or m\", \"achine learning. To this end, data can be passed to the various machine learning tools in Azure to a\", \"llow you to extract trends and information that would otherwise be hidden.\\n\\nApplication Insights pro\", \"vides a powerful (SQL-like) query language called Kusto that can query records, summarize them, and \", \"even plot charts. For example, the following query will locate all records for the month of November\", \" 2007, group them by state, and plot the top 10 as a pie chart.\\n\\nFigure 7-13 shows the results of th\", \"is Application Insights Query.\\n\\n<!-- image -->\\n\\nFigure 7 -13. Application Insights query results.\\n\\n<\", \"!-- image -->\\n\\nThere is a playground for experimenting with Kusto queries. Reading sample queries ca\", \"n also be instructive.\\n\\n## Dashboards\\n\\nThere are several different dashboard technologies that may b\", \"e used to surface the information from Azure Monitor. Perhaps the simplest is to just run queries in\", \" Application Insights and plot the data into a chart .\\n\\nFabrikam v + New dashboard 7 Upload Download\", \" Edit \\u00a9 Unshare / Full screen D Clone \\u2022 Delete\\n\\nUTC Time: Past 24 hours\\n\\nFabrikam\\n\\nDaily Statistics\\n\", \"\\nEdit\\n\\nThis dashboard includes daily usage and performance statisties for the Fabrikam application\\n\\n\", \"Analytics\\n\\nNAME\\n\\nGET Home/Index\\n\\nGET /\\n\\nGET /FabrikamProd/Content/fonts/segoew.|\\n\\nGET /FabrikamProd/\", \"Content/fonts/segoew...\\n\\nGET ServiceTickets/Index\\n\\nGET /Content/fonts/segoewp-light-webfon... 5.86 K\", \"\\n\\nGET /Content/fonts/segoewp-webfont.eot\\n\\nServer response time\\n\\n13.33min\\n\\nFigure 7 -14. An example o\", \"f Application Insights charts embedded in the main Azure Dashboard.\\n\\n<!-- image -->\\n\\nThese charts ca\", \"n then be embedded in the Azure portal proper through use of the dashboard feature. For users with m\", \"ore exacting requirements, such as being able to drill down into several tiers of data, Azure Monito\", \"r data is available to Power BI. Power BI is an industry-leading, enterprise class, business intelli\", \"gence tool that can aggregate data from many different data sources.\\n\\nSum Server requests\\n\\n=\\n\\nPower \", \"Bl\\n\\nAzure Audit Logs Billing @ Share Dashboard\\n\\nAsk a question about the data on this dashboard\\n\\nEve\", \"nts by Resource Type\\n\\nOPERATIONAUINSIGHTS\\n\\nSQL\\n\\nINSIGHTS\\n\\nEvents by Caller\\n\\n65217SPCC3087D778\\\\_\\n\\nk@m\", \"icrosorte- o@microsoftc.\\n\\nEvents by Level level\\n\\nEvents Over Time\\n\\n200\\n\\nEvents by Status\\n\\nFigure 7 -\", \"15. An example Power BI dashboard.\\n\\n<!-- image -->\\n\\n## Alerts\\n\\nSometimes, having data dashboards is \", \"insufficient. If nobody is awake to watch the dashboards, then it can still be many hours before a p\", \"roblem is addressed, or even detected. To this end, Azure Monitor also provides a top notch alerting\", \" solution. Alerts can be triggered by a wide range of conditions including:\\n\\n- Metric values\\n- Log s\", \"earch queries\\n- Activity Log events\\n- Health of the underlying Azure platform\\n- Tests for web site a\", \"vailability\\n\\nWhen triggered, the alerts can perform a wide variety of tasks. On the simple side, the\", \" alerts may just send an e -mail notification to a mailing list or a text message to an individual. \", \"More involved alerts\\n\\nGet me started\\n\\nAzure Audit Logs Billing\\n\\nmight trigger a workflow in a tool s\", \"uch as PagerDuty, which is aware of who is on call for a particular application. Alerts can trigger \", \"actions in Microsoft Flow unlocking near limitless possibilities for workflows.\\n\\nAs common causes of\", \" alerts are identified, the alerts can be enhanced with details about the common causes of the alert\", \"s and the steps to take to resolve them. Highly mature cloud-native application deployments may opt \", \"to kick off self-healing tasks, which perform actions such as removing failing nodes from a scale se\", \"t or triggering an autoscaling activity. Eventually it may no longer be necessary to wake up on-call\", \" personnel at 2AM to resolve a live-site issue as the system will be able to adjust itself to compen\", \"sate or at least limp along until somebody arrives at work the next morning.\\n\\nAzure Monitor automati\", \"cally leverages machine learning to understand the normal operating parameters of deployed applicati\", \"ons. This approach enables it to detect services that are operating outside of their normal paramete\", \"rs. For instance, the typical weekday traffic on the site might be 10,000 requests per minute. And t\", \"hen, on a given week, suddenly the number of requests hits a highly unusual 20,000 requests per minu\", \"te. Smart Detection will notice this deviation from the norm and trigger an alert. At the same time,\", \" the trend analysis is smart enough to avoid firing false positives when the traffic load is expecte\", \"d.\\n\\n## References\\n\\n- Azure Monitor\\n\\n## Cloud -native identity\\n\\nMost software applications need to ha\", \"ve some knowledge of the user or process that is calling them. The user or process interacting with \", \"an application is known as a security principal, and the process of authenticating and authorizing t\", \"hese principals is known as identity management, or simply identity . Simple applications may includ\", \"e all of their identity management within the application, but this approach doesn't scale well with\", \" many applications and many kinds of security principals. Windows supports the use of Active Directo\", \"ry to provide centralized authentication and authorization.\\n\\nWhile this solution is effective within\", \" corporate networks, it isn't designed for use by users or applications that are outside of the AD d\", \"omain. With the growth of Internet-based applications and the rise of cloud -native apps, security m\", \"odels have evolved .\\n\\nIn today's cloud-native identity model, architecture is assumed to be distribu\", \"ted. Apps can be deployed anywhere and may communicate with other apps anywhere. Clients may communi\", \"cate with these apps from anywhere, and in fact, clients may consist of any combination of platforms\", \" and devices. Cloud -native identity solutions use open standards to achieve secure application acce\", \"ss from clients. These clients range from human users on PCs or phones, to other apps hosted anywher\", \"e online, to set-top boxes and IOT devices running any software platform anywhere in the world.\\n\\nMod\", \"ern cloud -native identity solutions typically use access tokens that are issued by a secure token s\", \"ervice/server (STS) to a security principal once their identity is determined. The access token, typ\", \"ically a JSON Web Token (JWT), includes claims about the security principal. These claims will minim\", \"ally include the user's identity but may also include other claims that can be used by applications \", \"to determine the level of access to grant the principal.\\n\\nTypically, the STS is only responsible for\", \" authenticating the principal. Determining their level of access to resources is left to other parts\", \" of the application.\\n\\n## References\\n\\n- Microsoft identity platform\\n\\n## Authentication and authorizat\", \"ion in cloud -native apps\\n\\nAuthentication is the process of determining the identity of a security p\", \"rincipal. Authorization is the act of granting an authenticated principal permission to perform an a\", \"ction or access a resource. Sometimes authentication is shortened to AuthN and authorization is shor\", \"tened to AuthZ. Cloud -\\n\\nnative applications need to rely on open HTTP-based protocols to authentica\", \"te security principals since both clients and applications could be running anywhere in the world on\", \" any platform or device. The only common factor is HTTP.\\n\\nMany organizations still rely on local aut\", \"hentication services like Active Directory Federation Services (ADFS). While this approach has tradi\", \"tionally served organizations well for on premises authentication needs, cloud-native applications b\", \"enefit from systems designed specifically for the cloud. A recent 2019 United Kingdom National Cyber\", \" Security Centre (NCSC) advisory states that \\\"organizations using Azure AD as their primary authenti\", \"cation source will actually lower their risk compared to ADFS.\\\" Some reasons outlined in this analys\", \"is include:\\n\\n- Access to full set of Microsoft credential protection technologies.\\n- Most organizati\", \"ons are already relying on Azure AD to some extent.\\n- Double hashing of NTLM hashes ensures compromi\", \"se won't allow credentials that work in local Active Directory.\\n\\n## References\\n\\n- Authentication bas\", \"ics\\n- Access tokens and claims\\n- It may be time to ditch your on premises authentication services\\n\\n#\", \"# Azure Active Directory\\n\\nMicrosoft Azure Active Directory (Azure AD) offers identity and access man\", \"agement as a service. Customers use it to configure and maintain who users are, what information to \", \"store about them, who can access that information, who can manage it, and what apps can access it. A\", \"AD can authenticate users for applications configured to use it, providing a single sign-on (SSO) ex\", \"perience. It can be used on its own or be integrated with Windows AD running on premises.\\n\\nAzure AD \", \"is built for the cloud. It's truly a cloud-native identity solution that uses a REST-based Graph API\", \" and OData syntax for queries, unlike Windows AD, which uses LDAP. On premises Active Directory can \", \"sync user attributes to the cloud using Identity Sync Services, allowing all authentication to take \", \"place in the cloud using Azure AD. Alternately, authentication can be configured via Connect to pass\", \" back to local Active Directory via ADFS to be completed by Windows AD on premises.\\n\\nAzure AD suppor\", \"ts company branded sign-in screens, multi-factory authentication, and cloud-based application proxie\", \"s that are used to provide SSO for applications hosted on premises. It offers different kinds of sec\", \"urity reporting and alert capabilities.\\n\\n## References\\n\\n- Microsoft identity platform\\n\\nBrowser\\n\\n## I\", \"dentityServer for cloud -native applications\\n\\nIdentityServer is an authentication server that implem\", \"ents OpenID Connect (OIDC) and OAuth 2.0 standards for ASP.NET Core. It's designed to provide a comm\", \"on way to authenticate requests to all of your applications, whether they're web, native, mobile, or\", \" API endpoints. IdentityServer can be used to implement Single Sign-On (SSO) for multiple applicatio\", \"ns and application types. It can be used to authenticate actual users via sign-in forms and similar \", \"user interfaces as well as service-based authentication that typically involves token issuance, veri\", \"fication, and renewal without any user interface. IdentityServer is designed to be a customizable so\", \"lution. Each instance is typically customized to suit an individual organization and/or set of appli\", \"cations' needs.\\n\\n## Common web app scenarios\\n\\nTypically, applications need to support some or all of\", \" the following scenarios:\\n\\n- Human users accessing web applications with a browser.\\n- Human users ac\", \"cessing back-end Web APIs from browser-based apps.\\n- Human users on mobile/native clients accessing \", \"back-end Web APIs.\\n- Other applications accessing back-end Web APIs (without an active user or user \", \"interface).\\n- Any application may need to interact with other Web APIs, using its own identity or de\", \"legating to the user's identity.\\n\\nFigure 8 -1. Application types and scenarios.\\n\\n<!-- image -->\\n\\nIn \", \"each of these scenarios, the exposed functionality needs to be secured against unauthorized use. At \", \"a minimum, this typically requires authenticating the user or principal making a request for a resou\", \"rce. This authentication may use one of several common protocols such as SAML2p, WS-Fed, or OpenID C\", \"onnect. Communicating with APIs typically uses the OAuth2 protocol and its support for security toke\", \"ns. Separating these critical cross-cutting security concerns and their implementation details from \", \"the applications themselves ensures consistency and improves security and maintainability.\\n\\nOutsourc\", \"ing these concerns to a dedicated product like IdentityServer helps the requirement for every applic\", \"ation to solve these problems itself.\\n\\nIdentityServer provides middleware that runs within an ASP.NE\", \"T Core application and adds support for OpenID Connect and OAuth2 (see supported specifications). Or\", \"ganizations would create their own ASP.NET Core app using IdentityServer middleware to act as the ST\", \"S for all of their token-based security protocols. The IdentityServer middleware exposes endpoints t\", \"o support standard functionality, including:\\n\\n- Authorize (authenticate the end user)\\n- Token (reque\", \"st a token programmatically)\\n- Discovery (metadata about the server)\\n- User Info (get user informati\", \"on with a valid access token)\\n- Device Authorization (used to start device flow authorization)\\n- Int\", \"rospection (token validation)\\n- Revocation (token revocation)\\n- End Session (trigger single sign-out\", \" across all apps)\\n\\n## Getting started\\n\\nIdentityServer4 is available under dual license:\\n\\n- RPL -lets\", \" you use the IdentityServer4 free if used in open-source work\\n- Paid -lets you use the IdentityServe\", \"r4 in a commercial scenario\\n\\nFor more information about pricing, see the official product's pricing \", \"page .\\n\\nYou can add it to your applications using its NuGet packages. The main package is IdentitySe\", \"rver4 , which has been downloaded over four million times. The base package doesn't include any user\", \" interface code and only supports in-memory configuration. To use it with a database, you'll also wa\", \"nt a data provider like IdentityServer4.EntityFramework, which uses Entity Framework Core to store c\", \"onfiguration and operational data for IdentityServer. For user interface, you can copy files from th\", \"e Quickstart UI repository into your ASP.NET Core MVC application to add support for sign in and sig\", \"n out using IdentityServer middleware.\\n\\n## Configuration\\n\\nIdentityServer supports different kinds of\", \" protocols and social authentication providers that can be configured as part of each custom install\", \"ation. This is typically done in the ASP.NET Core application's Program class (or in the Startup cla\", \"ss in the ConfigureServices method). The configuration involves specifying the supported protocols a\", \"nd the paths to the servers and endpoints that will be used. Figure 8-2 shows an example configurati\", \"on taken from the IdentityServer4 Quickstart UI project:\\n\\n```\\npublic class Startup { public void Con\", \"figureServices(IServiceCollection services) { services . AddMvc();\\n```\\n\\n```\\n// some details omitted \", \"services . AddIdentityServer(); services . AddAuthentication() . AddGoogle(\\\"Google\\\" , options => { o\", \"ptions . SignInScheme = IdentityServerConstants . ExternalCookieAuthenticationScheme; options . Clie\", \"ntId = \\\"<insert here>\\\"; options . ClientSecret = \\\"<insert here>\\\"; }) . AddOpenIdConnect(\\\"demoidsrv\\\" \", \", \\\"IdentityServer\\\" , options => { options . SignInScheme = IdentityServerConstants . ExternalCookieA\", \"uthenticationScheme; options . SignOutScheme = IdentityServerConstants . SignoutScheme; options . Au\", \"thority = \\\"https://demo.identityserver.io/\\\"; options . ClientId = \\\"implicit\\\"; options . ResponseType\", \" = \\\"id_token\\\"; options . SaveTokens = true; options . CallbackPath = new PathString(\\\"/signin-idsrv\\\")\", \"; options . SignedOutCallbackPath = new PathString(\\\"/signout-callback-idsrv\\\"); options . RemoteSignO\", \"utPath = new PathString(\\\"/signout-idsrv\\\"); options . TokenValidationParameters = new TokenValidation\", \"Parameters { NameClaimType = \\\"name\\\" , RoleClaimType = \\\"role\\\" }; }); } }\\n```\\n\\nFigure 8 -2. Configurin\", \"g IdentityServer.\\n\\n## JavaScript clients\\n\\nMany cloud-native applications use server-side APIs and ri\", \"ch client single page applications (SPAs) on the front end. IdentityServer ships a JavaScript client\", \" (oidc-client.js) via NPM that can be added to SPAs to enable them to use IdentityServer for sign in\", \", sign out, and token-based authentication of web APIs.\\n\\n## References\\n\\n- IdentityServer documentati\", \"on\\n- Application types\\n- JavaScript OIDC client\\n\\n## Cloud -native security\\n\\nNot a day goes by where \", \"the news doesn't contain some story about a company being hacked or somehow losing their customers' \", \"data. Even countries/regions aren't immune to the problems created by treating security as an aftert\", \"hought. For years, companies have treated the security of customer data and, in fact, their entire n\", \"etworks as something of a \\\"nice to have\\\". Windows servers were left unpatched, ancient versions of P\", \"HP kept running, and MongoDB databases left wide open to the world.\\n\\nHowever, there are starting to \", \"be real-world consequences for not maintaining a security mindset when building and deploying applic\", \"ations. Many companies learned the hard way what can happen when servers and desktops aren't patched\", \" during the 2017 outbreak of NotPetya. The cost of these attacks has easily reached into the billion\", \"s, with some estimates putting the losses from this single attack at 10 billion US dollars.\\n\\nEven go\", \"vernments aren't immune to hacking incidents. The city of Baltimore was held ransom by criminals mak\", \"ing it impossible for citizens to pay their bills or use city services.\\n\\nThere has also been an incr\", \"ease in legislation that mandates certain data protections for personal data. In Europe, GDPR has be\", \"en in effect for more than a year and, more recently, California passed their own version called CCD\", \"A, which comes into effect January 1, 2020. The fines under GDPR can be so punishing as to put compa\", \"nies out of business. Google has already been fined 50 million Euros for violations, but that's just\", \" a drop in the bucket compared with the potential fines.\\n\\nIn short, security is serious business.\\n\\n#\", \"# Azure security for cloud -native apps\\n\\nCloud -native applications can be both easier and more diff\", \"icult to secure than traditional applications. On the downside, you need to secure more smaller appl\", \"ications and dedicate more energy to build out the security infrastructure. The heterogeneous nature\", \" of programming languages and styles in most service deployments also means you need to pay more att\", \"ention to security bulletins from many different providers.\\n\\nOn the flip side, smaller services, eac\", \"h with their own data store, limit the scope of an attack. If an attacker compromises one system, it\", \"'s probably more difficult for the attacker to make the jump to another system than it is in a monol\", \"ithic application. Process boundaries are strong boundaries. Also, if a database backup gets exposed\", \", then the damage is more limited, as that database contains only a subset of data and is unlikely t\", \"o contain personal data.\\n\\n## Threat modeling\\n\\nNo matter if the advantages outweigh the disadvantages\", \" of cloud-native applications, the same holistic security mindset must be followed. Security and sec\", \"ure thinking must be part of every step of the development and operations story. When planning an ap\", \"plication ask questions like:\\n\\n- What would be the impact of this data being lost?\\n- How can we limi\", \"t the damage from bad data being injected into this service?\\n- Who should have access to this data?\\n\", \"- Are there auditing policies in place around the development and release process?\\n\\nAll these questi\", \"ons are part of a process called threat modeling. This process tries to answer the question of what \", \"threats there are to the system, how likely the threats are, and the potential damage from them.\\n\\nOn\", \"ce the list of threats has been established, you need to decide whether they're worth mitigating. So\", \"metimes a threat is so unlikely and expensive to plan for that it isn't worth spending energy on it.\", \" For instance, some state level actor could inject changes into the design of a process that is used\", \" by millions of devices. Now, instead of running a certain piece of code in Ring 3, that code is run\", \" in Ring 0. This process allows an exploit that can bypass the hypervisor and run the attack code on\", \" the bare metal machines, allowing attacks on all the virtual machines that are running on that hard\", \"ware.\\n\\nThe altered processors are difficult to detect without a microscope and advanced knowledge of\", \" the on silicon design of that processor. This scenario is unlikely to happen and expensive to mitig\", \"ate, so probably no threat model would recommend building exploit protection for it.\\n\\nMore likely th\", \"reats, such as broken access controls permitting Id incrementing attacks (replacing Id=2 with Id=3 i\", \"n the URL) or SQL injection, are more attractive to build protections against. The mitigations for t\", \"hese threats are quite reasonable to build and prevent embarrassing security holes that smear the co\", \"mpany's reputation.\\n\\n## Principle of least privilege\\n\\nOne of the founding ideas in computer security\", \" is the Principle of Least Privilege (POLP). It's actually a foundational idea in most any form of s\", \"ecurity be it digital or physical. In short, the principle is that any user or process should have t\", \"he smallest number of rights possible to execute its task.\\n\\nAs an example, think of the tellers at a\", \" bank: accessing the safe is an uncommon activity. So, the average teller can't open the safe themse\", \"lves. To gain access, they need to escalate their request through a bank manager, who performs addit\", \"ional security checks.\\n\\nIn a computer system, a fantastic example is the rights of a user connecting\", \" to a database. In many cases, there's a single user account used to both build the database structu\", \"re and run the application. Except in extreme cases, the account running the application doesn't nee\", \"d the ability to update schema information. There should be several accounts that provide different \", \"levels of privilege. The application should only use the permission level that grants read and write\", \"s access to the data in the tables. This kind of protection would eliminate attacks that aimed to dr\", \"op database tables or introduce malicious triggers.\\n\\nAlmost every part of building a cloud-native ap\", \"plication can benefit from remembering the principle of least privilege. You can find it at play whe\", \"n setting up firewalls, network security groups, roles, and scopes in Role-based access control (RBA\", \"C).\\n\\n## Penetration testing\\n\\nAs applications become more complicated the number of attack vectors in\", \"creases at an alarming rate. Threat modeling is flawed in that it tends to be executed by the same p\", \"eople building the system. In the same way that many developers have trouble envisioning user intera\", \"ctions and then build unusable user interfaces, most developers have difficulty seeing every attack \", \"vector. It's also possible that the developers building the system aren't well versed in attack meth\", \"odologies and miss something crucial.\\n\\nPenetration testing or \\\"pen testing\\\" involves bringing in ext\", \"ernal actors to attempt to attack the system. These attackers may be an external consulting company \", \"or other developers with good security knowledge from another part of the business. They're given ca\", \"rte blanche to attempt to subvert the system. Frequently, they'll find extensive security holes that\", \" need to be patched. Sometimes the attack vector will be something totally unexpected like exploitin\", \"g a phishing attack against the CEO.\\n\\nAzure itself is constantly undergoing attacks from a team of h\", \"ackers inside Microsoft. Over the years, they've been the first to find dozens of potentially catast\", \"rophic attack vectors, closing them before they can be exploited externally. The more tempting a tar\", \"get, the more likely that eternal actors will attempt to exploit it and there are a few targets in t\", \"he world more tempting than Azure.\\n\\n## Monitoring\\n\\nShould an attacker attempt to penetrate an applic\", \"ation, there should be some warning of it. Frequently, attacks can be spotted by examining the logs \", \"from services. Attacks leave telltale signs that can be spotted before they succeed. For instance, a\", \"n attacker attempting to guess a password will make many requests to a login system. Monitoring arou\", \"nd the login system can detect weird patterns that are out of line with the typical access pattern. \", \"This monitoring can be turned into an alert that can, in turn, alert an operations person to activat\", \"e some sort of countermeasure. A highly mature monitoring system might even take action based on the\", \"se deviations proactively adding rules to block requests or throttle responses.\\n\\n## Securing the bui\", \"ld\\n\\nOne place where security is often overlooked is around the build process. Not only should the bu\", \"ild run security checks, such as scanning for insecure code or checked-in credentials, but the build\", \" itself should be secure. If the build server is compromised, then it provides a fantastic vector fo\", \"r introducing arbitrary code into the product.\\n\\nImagine that an attacker is looking to steal the pas\", \"swords of people signing into a web application. They could introduce a build step that modifies the\", \" checked-out code to mirror any login request to another server. The next time code goes through the\", \" build, it's silently updated. The source code vulnerability scanning won't catch this vulnerability\", \" as it runs before the build. Equally, nobody will\\n\\ncatch it in a code review because the build step\", \"s live on the build server. The exploited code will go to production where it can harvest passwords.\", \" Probably there's no audit log of the build process changes, or at least nobody monitoring the audit\", \".\\n\\nThis scenario is a perfect example of a seemingly low-value target that can be used to break into\", \" the system. Once an attacker breaches the perimeter of the system, they can start working on findin\", \"g ways to elevate their permissions to the point that they can cause real harm anywhere they like.\\n\\n\", \"## Building secure code\\n\\n.NET Framework is already a quite secure framework. It avoids some of the p\", \"itfalls of unmanaged code, such as walking off the ends of arrays. Work is actively done to fix secu\", \"rity holes as they're discovered. There's even a bug bounty program that pays researchers to find is\", \"sues in the framework and report them instead of exploiting them.\\n\\nThere are many ways to make .NET \", \"code more secure. Following guidelines such as the Secure coding guidelines for .NET article is a re\", \"asonable step to take to ensure that the code is secure from the ground up. The OWASP top 10 is anot\", \"her invaluable guide to build secure code.\\n\\nThe build process is a good place to put scanning tools \", \"to detect problems in source code before they make it into production. Most every project has depend\", \"encies on some other packages. A tool that can scan for outdated packages will catch problems in a n\", \"ightly build. Even when building Docker images, it's useful to check and make sure that the base ima\", \"ge doesn't have known vulnerabilities. Another thing to check is that nobody has accidentally checke\", \"d in credentials.\\n\\n## Built -in security\\n\\nAzure is designed to balance usability and security for mo\", \"st users. Different users are going to have different security requirements, so they need to fine-tu\", \"ne their approach to cloud security. Microsoft publishes a great deal of security information in the\", \" Trust Center. This resource should be the first stop for those professionals interested in understa\", \"nding how the built-in attack mitigation technologies work.\\n\\nWithin the Azure portal, the Azure Advi\", \"sor is a system that is constantly scanning an environment and making recommendations. Some of these\", \" recommendations are designed to save users money, but others are designed to identify potentially i\", \"nsecure configurations, such as having a storage container open to the world and not protected by a \", \"Virtual Network.\\n\\n## Azure network infrastructure\\n\\nIn an on -premises deployment environment, a grea\", \"t deal of energy is dedicated to setting up networking. Setting up routers, switches, and the such i\", \"s complicated work. Networks allow certain resources to talk to other resources and prevent access i\", \"n some cases. A frequent network rule is to restrict access to the production environment from the d\", \"evelopment environment on the off chance that a half -developed piece of code runs awry and deletes \", \"a swath of data.\\n\\nOut of the box, most PaaS Azure resources have only the most basic and permissive \", \"networking setup. For instance, anybody on the Internet can access an app service. New SQL Server in\", \"stances typically\\n\\nInternet come restricted, so that external parties can't access them, but the IP \", \"address ranges used by Azure itself are permitted through. So, while the SQL server is protected fro\", \"m external threats, an attacker only needs to set up an Azure bridgehead from where they can launch \", \"attacks against all SQL instances on Azure.\\n\\nGateway\\n\\nFortunately, most Azure resources can be place\", \"d into an Azure Virtual Network that allows finegrained access control. Similar to the way that on-p\", \"remises networks establish private networks that are protected from the wider world, virtual network\", \"s are islands of private IP addresses that are located within the Azure network.\\n\\nFigure 9 -1. A vir\", \"tual network in Azure.\\n\\n<!-- image -->\\n\\nIn the same way that on-premises networks have a firewall go\", \"verning access to the network, you can establish a similar firewall at the boundary of the virtual n\", \"etwork. By default, all the resources on a virtual network can still talk to the Internet. It's only\", \" incoming connections that require some form of explicit firewall exception.\\n\\nWith the network estab\", \"lished, internal resources like storage accounts can be set up to only allow for access by resources\", \" that are also on the Virtual Network. This firewall provides an extra level of security, should the\", \" keys for that storage account be leaked, attackers wouldn't be able to connect to it to exploit the\", \" leaked keys. This scenario is another example of the principle of least privilege.\\n\\nThe nodes in an\", \" Azure Kubernetes cluster can participate in a virtual network just like other resources that are mo\", \"re native to Azure. This functionality is called Azure Container Networking Interface. In effect, it\", \" allocates a subnet within the virtual network on which virtual machines and container images are al\", \"located.\\n\\nContinuing down the path of illustrating the principle of least privilege, not every resou\", \"rce within a Virtual Network needs to talk to every other resource. For instance, in an application \", \"that provides a\\n\\nUser\\n\\nSecurity principal web API over a storage account and a SQL database, it's un\", \"likely that the database and the storage account need to talk to one another. Any data sharing betwe\", \"en them would go through the web application. So, a network security group (NSG) could be used to de\", \"ny traffic between the two services.\\n\\nA policy of denying communication between resources can be ann\", \"oying to implement, especially coming from a background of using Azure without traffic restrictions.\", \" On some other clouds, the concept of network security groups is much more prevalent. For instance, \", \"the default policy on AWS is that resources can't communicate among themselves until enabled by rule\", \"s in an NSG. While slower to develop this, a more restrictive environment provides a more secure def\", \"ault. Making use of proper DevOps practices, especially using Azure Resource Manager or Terraform to\", \" manage permissions can make controlling the rules easier.\\n\\nVirtual Networks can also be useful when\", \" setting up communication between on-premises and cloud resources. A virtual private network can be \", \"used to seamlessly attach the two networks together. This approach allows running a virtual network \", \"without any sort of gateway for scenarios where all the users are on-site. There are a number of tec\", \"hnologies that can be used to establish this network. The simplest is to use a site-to-site VPN that\", \" can be established between many routers and Azure. Traffic is encrypted and tunneled over the Inter\", \"net at the same cost per byte as any other traffic. For scenarios where more bandwidth or more secur\", \"ity is desirable, Azure offers a service called Express Route that uses a private circuit between an\", \" on-premises network and Azure. It's more costly and difficult to establish but also more secure.\\n\\n#\", \"# Role -based access control for restricting access to Azure resources\\n\\nRBAC is a system that provid\", \"es an identity to applications running in Azure. Applications can access resources using this identi\", \"ty instead of or in addition to using keys or passwords.\\n\\n## Security Principals\\n\\nThe first componen\", \"t in RBAC is a security principal. A security principal can be a user, group, service principal, or \", \"managed identity.\\n\\nFigure 9 -2. Different types of security principals.\\n\\n<!-- image -->\\n\\n- User -Any\", \" user who has an account in Azure Active Directory is a user.\\n- Group -A collection of users from Az\", \"ure Active Directory. As a member of a group, a user takes on the roles of that group in addition to\", \" their own.\\n- Service principal - A security identity under which services or applications run.\\n\\nOwn\", \"er\\n\\nContributor\\n\\nReader\\n\\nBackup Operator\\n\\n2 Role definition\\n\\nContributor\\n\\n- Managed identity - An Az\", \"ure Active Directory identity managed by Azure. Managed identities are typically used when developin\", \"g cloud applications that manage the credentials for authenticating to Azure services.\\n\\nThe security\", \" principal can be applied to most any resource. This aspect means that it's possible to assign a sec\", \"urity principal to a container running within Azure Kubernetes, allowing it to access secrets stored\", \" in Key Vault. An Azure Function could take on a permission allowing it to talk to an Active Directo\", \"ry instance to validate a JWT for a calling user. Once services are enabled with a service principal\", \", their permissions can be managed granularly using roles and scopes.\\n\\nReader Support Tickets\\n\\n## Ro\", \"les\\n\\nA security principal can take on many roles or, using a more sartorial analogy, wear many hats.\", \" Each role defines a series of permissions such as \\\"Read messages from Azure Service Bus endpoint\\\". \", \"The effective permission set of a security principal is the combination of all the permissions assig\", \"ned to all the roles that a security principal has. Azure has a large number of built-in roles and u\", \"sers can define their own roles.\\n\\nFigure 9 -3. RBAC role definitions.\\n\\n<!-- image -->\\n\\nBuilt into Az\", \"ure are also a number of high-level roles such as Owner, Contributor, Reader, and User Account Admin\", \"istrator. With the Owner role, a security principal can access all resources and assign permissions \", \"to others. A contributor has the same level of access to all resources but they can't assign permiss\", \"ions. A Reader can only view existing Azure resources and a User Account Administrator can manage ac\", \"cess to Azure resources.\\n\\nMore granular built-in roles such as DNS Zone Contributor have rights limi\", \"ted to a single service. Security principals can take on any number of roles.\\n\\n\\\"/\\\"\\n\\n+ Add\\n\\n== Edit c\", \"olumns Refresh\\n\\nCheck access\\n\\nI Removel\\n\\nRoles\\n\\nAdd a role assignment\\n\\nGrant access to resources at \", \"this scope by assigning a role to a user, group, service\\n\\nprincipal, or managed identity.\\n\\nRole assi\", \"gnments Deny assignments Classic administrators\\n\\nCheck access\\n\\nReview the level of access a user, gr\", \"oup, service principal, or managed identity has to this resource. Learn more I\\n\\nFind 0\\n\\n## Scopes\\n\\nA\", \"zure AD user, group, or service principal\\n\\nView role assignments\\n\\nView the users, groups, service pr\", \"incipals assignments granting them access at this\\n\\nRoles can be applied to a restricted set of resou\", \"rces within Azure. For instance, applying scope to the previous example of reading from a Service Bu\", \"s queue, you can narrow the permission to a single queue: \\\"Read messages from Azure Service Bus endp\", \"oint blah.servicebus.windows.net/queue1\\\"\\n\\nThe scope can be as narrow as a single resource or it can \", \"be applied to an entire resource group, subscription, or even management group. View the users, grou\", \"ps, service principals\\n\\nView\\n\\nLearn more Z\\n\\nWhen testing if a security principal has certain permiss\", \"ion, the combination of role and scope are taken into account. This combination provides a powerful \", \"authorization mechanism.\\n\\n## Deny\\n\\nPreviously, only \\\"allow\\\" rules were permitted for RBAC. This beha\", \"vior made some scopes complicated to build. For instance, allowing a security principal access to al\", \"l storage accounts except one required granting explicit permission to a potentially endless list of\", \" storage accounts. Every time a new storage account was created, it would have to be added to this l\", \"ist of accounts. This added management overhead that certainly wasn't desirable.\\n\\nDeny rules take pr\", \"ecedence over allow rules. Now representing the same \\\"allow all but one\\\" scope could be represented \", \"as two rules \\\"allow all\\\" and \\\"deny this one specific one\\\". Deny rules not only ease management but a\", \"llow for resources that are extra secure by denying access to everybody.\\n\\n## Checking access\\n\\nAs you\", \" can imagine, having a large number of roles and scopes can make figuring out the effective permissi\", \"on of a service principal quite difficult. Piling deny rules on top of that, only serves to increase\", \" the complexity. Fortunately, there's a permissions calculator that can show the effective permissio\", \"ns for any service principal. It's typically found under the IAM tab in the portal, as shown in Figu\", \"re 9-3.\\n\\nFigure 9 -4. Permission calculator for an app service.\\n\\n<!-- image -->\\n\\nand managed identit\", \"ies that have role iM\\n\\n## Securing secrets\\n\\nPasswords and certificates are a common attack vector fo\", \"r attackers. Password -cracking hardware can do a brute -force attack and try to guess billions of p\", \"asswords per second. So it's important that the passwords that are used to access resources are stro\", \"ng, with a large variety of characters. These passwords are exactly the kind of passwords that are n\", \"ear impossible to remember. Fortunately, the passwords in Azure don't actually need to be known by a\", \"ny human.\\n\\nMany security experts suggest that using a password manager to keep your own passwords is\", \" the best approach. While it centralizes your passwords in one location, it also allows using highly\", \" complex passwords and ensuring they're unique for each account. The same system exists within Azure\", \": a central store for secrets.\\n\\n## Azure Key Vault\\n\\nAzure Key Vault provides a centralized location \", \"to store passwords for things such as databases, API keys, and certificates. Once a secret is entere\", \"d into the Vault, it's never shown again and the commands to extract and view it are purposefully co\", \"mplicated. The information in the safe is protected using either software encryption or FIPS 140-2 L\", \"evel 2 validated Hardware Security Modules.\\n\\nAccess to the key vault is provided through RBACs, mean\", \"ing that not just any user can access the information in the vault. Say a web application wishes to \", \"access the database connection string stored in Azure Key Vault. To gain access, applications need t\", \"o run using a service principal. Under this assumed role, they can read the secrets from the safe. T\", \"here are a number of different security settings that can further limit the access that an applicati\", \"on has to the vault, so that it can't update secrets but only read them.\\n\\nAccess to the key vault ca\", \"n be monitored to ensure that only the expected applications are accessing the vault. The logs can b\", \"e integrated back into Azure Monitor, unlocking the ability to set up alerts when unexpected conditi\", \"ons are encountered.\\n\\n## Kubernetes\\n\\nWithin Kubernetes, there's a similar service for maintaining sm\", \"all pieces of secret information. Kubernetes Secrets can be set via the typical kubectl executable.\\n\", \"\\nCreating a secret is as simple as finding the base64 version of the values to be stored:\\n\\n```\\necho \", \"-n 'admin' | base64 YWRtaW4= echo -n '1f2d1e2e67df' | base64 MWYyZDFlMmU2N2Rm\\n```\\n\\nThen adding it to\", \" a secrets file named secret.yml for example that looks similar to the following example:\\n\\n```\\napiVe\", \"rsion: v1 kind: Secret metadata: name: mysecret\\n```\\n\\n| type:  Opaque   |\\n|-----------------|\\n\\nFinall\", \"y, this file can be loaded into Kubernetes by running the following command:\\n\\n| kubectl apply  -f ./\", \"secret.yaml   |\\n|-----------------------------------|\\n\\nThese secrets can then be mounted into volume\", \"s or exposed to container processes through environment variables. The Twelve -factor app approach t\", \"o building applications suggests using the lowest common denominator to transmit settings to an appl\", \"ication. Environment variables are the lowest common denominator, because they're supported no matte\", \"r the operating system or application.\\n\\nAn alternative to use the built -in Kubernetes secrets is to\", \" access the secrets in Azure Key Vault from within Kubernetes. The simplest way to do this is to ass\", \"ign an RBAC role to the container looking to load secrets. The application can then use the Azure Ke\", \"y Vault APIs to access the secrets. However, this approach requires modifications to the code and do\", \"esn't follow the pattern of using environment variables. Instead, it's possible to inject values int\", \"o a container. This approach is actually more secure than using the Kubernetes secrets directly, as \", \"they can be accessed by users on the cluster.\\n\\n## Encryption in transit and at rest\\n\\nKeeping data sa\", \"fe is important whether it's on disk or transiting between various different services. The most effe\", \"ctive way to keep data from leaking is to encrypt it into a format that can't be easily read by othe\", \"rs. Azure supports a wide range of encryption options.\\n\\n## In transit\\n\\nThere are several ways to enc\", \"rypt traffic on the network in Azure. The access to Azure services is typically done over connection\", \"s that use Transport Layer Security (TLS). For instance, all the connections to the Azure APIs requi\", \"re TLS connections. Equally, connections to endpoints in Azure storage can be restricted to work onl\", \"y over TLS encrypted connections.\\n\\nTLS is a complicated protocol and simply knowing that the connect\", \"ion is using TLS isn't sufficient to ensure security. For instance, TLS 1.0 is chronically insecure,\", \" and TLS 1.1 isn't much better. Even within the versions of TLS, there are various settings that can\", \" make the connections easier to decrypt. The best course of action is to check and see if the server\", \" connection is using up-to-date and well configured protocols.\\n\\nThis check can be done by an externa\", \"l service such as SSL labs' SSL Server Test. A test run against a typical Azure endpoint, in this ca\", \"se a service bus endpoint, yields a near perfect score of A.\\n\\nEven services like Azure SQL databases\", \" use TLS encryption to keep data hidden. The interesting part about encrypting the data in transit u\", \"sing TLS is that it isn't possible, even for Microsoft, to listen in on the connection between compu\", \"ters running TLS. This should provide comfort for companies concerned that their data may be at risk\", \" from Microsoft proper or even a state actor with more resources than the standard attacker.\\n\\nSSL Re\", \"port: todeletesoon.servicebus.windows.net (23.99.80.186)\\n\\nAssessed on: Sun, 09 Jun 2019 05:15:43 UTC\", \" | Hide | Clear cache\\n\\nSummary\\n\\n## Overall Rating\\n\\nCertificate\\n\\nFigure 9 -5. SSL labs report showing\", \" a score of A for a Service Bus endpoint.\\n\\n<!-- image -->\\n\\nWhile this level of encryption isn't goin\", \"g to be sufficient for all time, it should inspire confidence that Azure TLS connections are quite s\", \"ecure. Azure will continue to evolve its security standards as encryption improves. It's nice to kno\", \"w that there's somebody watching the security standards and updating Azure as they improve.\\n\\n## At r\", \"est\\n\\nIn any application, there are a number of places where data rests on the disk. The application \", \"code itself is loaded from some storage mechanism. Most applications also use some kind of a databas\", \"e such as SQL Server, Cosmos DB, or even the amazingly price-efficient Table Storage. These database\", \"s all use heavily encrypted storage to ensure that nobody other than the applications with proper pe\", \"rmissions can read your data. Even the system operators can't read data that has been encrypted. So \", \"customers can remain confident their secret information remains secret.\\n\\n## Storage\\n\\nThe underpinnin\", \"g of much of Azure is the Azure Storage engine. Virtual machine disks are mounted on top of Azure St\", \"orage. Azure Kubernetes Service runs on virtual machines that, themselves, are hosted on Azure Stora\", \"ge. Even serverless technologies, such as Azure Functions Apps and Azure Container Instances, run ou\", \"t of disk that is part of Azure Storage.\\n\\nIf Azure Storage is well encrypted, then it provides for a\", \" foundation for most everything else to also be encrypted. Azure Storage is encrypted with FIPS 140-\", \"2 compliant 256-bit AES. This is a wellregarded encryption technology having been the subject of ext\", \"ensive academic scrutiny over the last 20 or so years. At present, there's no known practical attack\", \" that would allow someone without knowledge of the key to read data encrypted by AES.\\n\\nBy default, t\", \"he keys used for encrypting Azure Storage are managed by Microsoft. There are extensive protections \", \"in place to ensure to prevent malicious access to these keys. However, users with particular encrypt\", \"ion requirements can also provide their own storage keys that are managed in Azure\\n\\nScan Another \\u00bb\\n\\n\", \"Key Vault. These keys can be revoked at any time, which would effectively render the contents of the\", \" Storage account using them inaccessible.\\n\\nVirtual machines use encrypted storage, but it's possible\", \" to provide another layer of encryption by using technologies like BitLocker on Windows or DM-Crypt \", \"on Linux. These technologies mean that even if the disk image was leaked off of storage, it would re\", \"main near impossible to read it.\\n\\n## Azure SQL\\n\\nDatabases hosted on Azure SQL use a technology calle\", \"d Transparent Data Encryption (TDE) to ensure data remains encrypted. It's enabled by default on all\", \" newly created SQL databases, but must be enabled manually for legacy databases. TDE executes real-t\", \"ime encryption and decryption of not just the database, but also the backups and transaction logs.\\n\\n\", \"The encryption parameters are stored in the master database and, on startup, are read into memory fo\", \"r the remaining operations. This means that the master database must remain unencrypted. The actual \", \"key is managed by Microsoft. However, users with exacting security requirements may provide their ow\", \"n key in Key Vault in much the same way as is done for Azure Storage. The Key Vault provides for suc\", \"h services as key rotation and revocation.\\n\\nThe \\\"Transparent\\\" part of TDS comes from the fact that t\", \"here aren't client changes needed to use an encrypted database. While this approach provides for goo\", \"d security, leaking the database password is enough for users to be able to decrypt the data. There'\", \"s another approach that encrypts individual columns or tables in a database. Always Encrypted ensure\", \"s that at no point the encrypted data appears in plain text inside the database.\\n\\nSetting up this ti\", \"er of encryption requires running through a wizard in SQL Server Management Studio to select the sor\", \"t of encryption and where in Key Vault to store the associated keys.\\n\\nAlways Encrypted\\n\\nColumn Selec\", \"tion\\n\\nIntroduction\\n\\nColumn Selection\\n\\nMaster Key Configuration\\n\\nValidation\\n\\nSummary\\n\\nResults\\n\\nFigure\", \" 9 -6. Selecting columns in a table to be encrypted using Always Encrypted.\\n\\n<!-- image -->\\n\\nClient \", \"applications that read information from these encrypted columns need to make special allowances to r\", \"ead encrypted data. Connection strings need to be updated with Column Encryption Setting=Enabled and\", \" client credentials must be retrieved from the Key Vault. The SQL Server client must then be primed \", \"with the column encryption keys. Once that is done, the remaining actions use the standard interface\", \"s to SQL Client. That is, tools like Dapper and Entity Framework, which are built on top of SQL Clie\", \"nt, will continue to work without changes. Always Encrypted may not yet be available for every SQL S\", \"erver driver on every language.\\n\\nThe combination of TDE and Always Encrypted, both of which can be u\", \"sed with client-specific keys, ensures that even the most exacting encryption requirements are suppo\", \"rted.\\n\\n## Cosmos DB\\n\\nCosmos DB is the newest database provided by Microsoft in Azure. It has been bu\", \"ilt from the ground up with security and cryptography in mind. AES-256bit encryption is standard for\", \" all Cosmos DB\\n\\nSecret Store\\n\\nStores Sk\\n\\nDeploy Sk databases and can't be disabled. Coupled with the\", \" TLS 1.2 requirement for communication, the entire storage solution is encrypted.\\n\\nSk[Encryption key\", \"k]\\n\\nFigure 9 -7. The flow of data encryption within Cosmos DB.\\n\\n<!-- image -->\\n\\nWhile Cosmos DB does\", \"n't provide for supplying customer encryption keys, there has been significant work done by the team\", \" to ensure it remains PCI-DSS compliant without that. Cosmos DB also doesn't support any sort of sin\", \"gle column encryption similar to Azure SQL's Always Encrypted yet.\\n\\n## Keeping secure\\n\\nAzure has all\", \" the tools necessary to release a highly secure product. However, a chain is only as strong as its w\", \"eakest link. If the applications deployed on top of Azure aren't developed with a proper security mi\", \"ndset and good security audits, then they become the weak link in the chain. There are many great st\", \"atic analysis tools, encryption libraries, and security practices that can be used to ensure that th\", \"e software installed on Azure is as secure as Azure itself. Examples include static analysis tools ,\", \" encryption libraries, and security practices .\\n\\n## DevOps\\n\\nThe favorite mantra of software consulta\", \"nts is to answer \\\"It depends\\\" to any question posed. It isn't because software consultants are fond \", \"of not taking a position. It's because there's no one true answer to any questions in software. Ther\", \"e's no absolute right and wrong, but rather a balance between opposites.\\n\\nTake, for instance, the tw\", \"o major schools of developing web applications: Single Page Applications (SPAs) versus server-side a\", \"pplications. On the one hand, the user experience tends to be better with SPAs and the amount of tra\", \"ffic to the web server can be minimized making it possible to host them on something as simple as st\", \"atic hosting. On the other hand, SPAs tend to be slower to develop and more difficult to test. Which\", \" one is the right choice? Well, it depends on your situation.\\n\\nCloud -native applications aren't imm\", \"une to that same dichotomy. They have clear advantages in terms of speed of development, stability, \", \"and scalability, but managing them can be quite a bit more difficult.\\n\\nYears ago, it wasn't uncommon\", \" for the process of moving an application from development to production to take a month, or even mo\", \"re. Companies released software on a 6-month or even every year cadence. One needs to look no furthe\", \"r than Microsoft Windows to get an idea for the cadence of releases that were acceptable before the \", \"ever-green days of Windows 10. Five years passed between Windows XP and Vista, a further three betwe\", \"en Vista and Windows 7.\\n\\nIt's now fairly well established that being able to release software rapidl\", \"y gives fast-moving companies a huge market advantage over their more sloth-like competitors. It's f\", \"or that reason that major updates to Windows 10 are now approximately every six months.\\n\\nThe pattern\", \"s and practices that enable faster, more reliable releases to deliver value to the business are coll\", \"ectively known as DevOps. They consist of a wide range of ideas spanning the entire software develop\", \"ment life cycle from specifying an application all the way up to delivering and operating that appli\", \"cation.\\n\\nDevOps emerged before microservices and it's likely that the movement towards smaller, more\", \" fit to purpose services wouldn't have been possible without DevOps to make releasing and operating \", \"not just one but many applications in production easier.\\n\\n\\u2022 microservices\\n\\nSearch term\\n\\nUnited State\", \"s\\n\\nAzure\\n\\nBoards\\n\\nInterest over time i\\n\\n100\\n\\n75\\n\\n50\\n\\n25\\n\\nMay 1, 2009\\n\\n: \\\"\\n\\nDevOps\\n\\nSearch term\\n\\nAll \", \"categories\\n\\n:\\n\\n+ Add comparison\\n\\nFigure 10 -1 -DevOps and microservices.\\n\\n<!-- image -->\\n\\nThrough go\", \"od DevOps practices, it's possible to realize the advantages of cloud-native applications without su\", \"ffocating under a mountain of work actually operating the applications.\\n\\nThere's no golden hammer wh\", \"en it comes to DevOps. Nobody can sell a complete and allencompassing solution for releasing and ope\", \"rating high-quality applications. This is because each application is wildly different from all othe\", \"rs. However, there are tools that can make DevOps a far less daunting proposition. One of these tool\", \"s is known as Azure DevOps.\\n\\n## Azure DevOps\\n\\nAzure DevOps has a long pedigree. It can trace its roo\", \"ts back to when Team Foundation Server first moved online and through the various name changes: Visu\", \"al Studio Online and Visual Studio Team Services. Through the years, however, it has become far more\", \" than its predecessors.\\n\\nAzure DevOps is divided into five major components:\\n\\nFigure 10 -2 -Azure De\", \"vOps.\\n\\n<!-- image -->\\n\\nAzure Repos -Source code management that supports the venerable Team Foundati\", \"on Version Control (TFVC) and the industry favorite Git. Pull requests provide a way to enable socia\", \"l coding by fostering discussion of changes as they're made.\\n\\nAverage\\n\\nAzure Boards -Provides an iss\", \"ue and work item tracking tool that strives to allow users to pick the workflows that work best for \", \"them. It comes with a number of pre-configured templates including ones to support SCRUM and Kanban \", \"styles of development.\\n\\nAzure Pipelines - A build and release management system that supports tight \", \"integration with Azure. Builds can be run on various platforms from Windows to Linux to macOS. Build\", \" agents may be provisioned in the cloud or on-premises.\\n\\nAzure Test Plans -No QA person will be left\", \" behind with the test management and exploratory testing support offered by the Test Plans feature.\\n\", \"\\nAzure Artifacts -An artifact feed that allows companies to create their own, internal, versions of \", \"NuGet, npm, and others. It serves a double purpose of acting as a cache of upstream packages if ther\", \"e's a failure of a centralized repository.\\n\\nThe top-level organizational unit in Azure DevOps is kno\", \"wn as a Project. Within each project the various components, such as Azure Artifacts, can be turned \", \"on and off. Each of these components provides different advantages for cloud-native applications. Th\", \"e three most useful are repositories, boards, and pipelines. If users want to manage their source co\", \"de in another repository stack, such as GitHub, but still take advantage of Azure Pipelines and othe\", \"r components, that's perfectly possible.\\n\\nFortunately, development teams have many options when sele\", \"cting a repository. One of them is GitHub.\\n\\n## GitHub Actions\\n\\nFounded in 2009, GitHub is a widely p\", \"opular web-based repository for hosting projects, documentation, and code. Many large tech companies\", \", such as Apple, Amazon, Google, and mainstream corporations use GitHub. GitHub uses the open-source\", \", distributed version control system named Git as its foundation. On top, it then adds its own set o\", \"f features, including defect tracking, feature and pull requests, tasks management, and wikis for ea\", \"ch code base.\\n\\nAs GitHub evolves, it too is adding DevOps features. For example, GitHub has its own \", \"continuous integration/continuous delivery (CI/CD) pipeline, called GitHub Actions. GitHub Actions i\", \"s a community-powered workflow automation tool. It lets DevOps teams integrate with their existing t\", \"ooling, mix and match new products, and hook into their software lifecycle, including existing CI/CD\", \" partners.\\\"\\n\\nGitHub has over 40 million users, making it the largest host of source code in the worl\", \"d. In October of 2018, Microsoft purchased GitHub. Microsoft has pledged that GitHub will remain an \", \"open platform that any developer can plug into and extend. It continues to operate as an independent\", \" company. GitHub offers plans for enterprise, team, professional, and free accounts.\\n\\n## Source cont\", \"rol\\n\\nOrganizing the code for a cloud-native application can be challenging. Instead of a single gian\", \"t application, the cloud-native applications tend to be made up of a web of smaller applications tha\", \"t talk with one another. As with all things in computing, the best arrangement of code remains an op\", \"en\\n\\nquestion. There are examples of successful applications using different kinds of layouts, but tw\", \"o variants seem to have the most popularity.\\n\\nBefore getting down into the actual source control its\", \"elf, it's probably worth deciding on how many projects are appropriate. Within a single project, the\", \"re's support for multiple repositories, and build pipelines. Boards are a little more complicated, b\", \"ut there too, the tasks can easily be assigned to multiple teams within a single project. It's possi\", \"ble to support hundreds, even thousands of developers, out of a single Azure DevOps project. Doing s\", \"o is likely the best approach as it provides a single place for all developer to work out of and red\", \"uces the confusion of finding that one application when developers are unsure in which project in wh\", \"ich it resides.\\n\\nSplitting up code for microservices within the Azure DevOps project can be slightly\", \" more challenging.\\n\\nFigure 10 -3 -One vs. many repositories.\\n\\n<!-- image -->\\n\\n## Repository per micr\", \"oservice\\n\\nAt first glance, this approach seems like the most logical approach to splitting up the so\", \"urce code for microservices. Each repository can contain the code needed to build the one microservi\", \"ce. The advantages to this approach are readily visible:\\n\\n1. Instructions for building and maintaini\", \"ng the application can be added to a README file at the root of each repository. When flipping throu\", \"gh the repositories, it's easy to find these instructions, reducing spin-up time for developers.\\n2. \", \"Every service is located in a logical place, easily found by knowing the name of the service.\\n3. Bui\", \"lds can easily be set up such that they're only triggered when a change is made to the owning reposi\", \"tory.\\n4. The number of changes coming into a repository is limited to the small number of developers\", \" working on the project.\\n\\n5. Security is easy to set up by restricting the repositories to which dev\", \"elopers have read and write permissions.\\n6. Repository level settings can be changed by the owning t\", \"eam with a minimum of discussion with others.\\n\\nOne of the key ideas behind microservices is that ser\", \"vices should be siloed and separated from each other. When using Domain Driven Design to decide on t\", \"he boundaries for services the services act as transactional boundaries. Database updates shouldn't \", \"span multiple services. This collection of related data is referred to as a bounded context. This id\", \"ea is reflected by the isolation of microservice data to a database separate and autonomous from the\", \" rest of the services. It makes a great deal of sense to carry this idea all the way through to the \", \"source code.\\n\\nHowever, this approach isn't without its issues. One of the more gnarly development pr\", \"oblems of our time is managing dependencies. Consider the number of files that make up the average n\", \"ode\\\\_modules directory. A fresh install of something like create-react-app is likely to bring with i\", \"t thousands of packages. The question of how to manage these dependencies is a difficult one.\\n\\nIf a \", \"dependency is updated, then downstream packages must also update this dependency. Unfortunately, tha\", \"t takes development work so, invariably, the node\\\\_modules directory ends up with multiple versions \", \"of a single package, each one a dependency of some other package that is versioned at a slightly dif\", \"ferent cadence. When deploying an application, which version of a dependency should be used? The ver\", \"sion that is currently in production? The version that is currently in Beta but is likely to be in p\", \"roduction by the time the consumer makes it to production? Difficult problems that aren't resolved b\", \"y just using microservices.\\n\\nThere are libraries that are depended upon by a wide variety of project\", \"s. By dividing the microservices up with one in each repository the internal dependencies can best b\", \"e resolved by using the internal repository, Azure Artifacts. Builds for libraries will push their l\", \"atest versions into Azure Artifacts for internal consumption. The downstream project must still be m\", \"anually updated to take a dependency on the newly updated packages.\\n\\nAnother disadvantage presents i\", \"tself when moving code between services. Although it would be nice to believe that the first divisio\", \"n of an application into microservices is 100% correct, the reality is that rarely we're so prescien\", \"t as to make no service division mistakes. Thus, functionality and the code that drives it will need\", \" to move from service to service: repository to repository. When leaping from one repository to anot\", \"her, the code loses its history. There are many cases, especially in the event of an audit, where ha\", \"ving full history on a piece of code is invaluable.\\n\\nThe final and most important disadvantage is co\", \"ordinating changes. In a true microservices application, there should be no deployment dependencies \", \"between services. It should be possible to deploy services A, B, and C in any order as they have loo\", \"se coupling. In reality, however, there are times when it's desirable to make a change that crosses \", \"multiple repositories at the same time. Some examples include updating a library to close a security\", \" hole or changing a communication protocol used by all services.\\n\\nTo do a cross -repository change r\", \"equires a commit to each repository be made in succession. Each change in each repository will need \", \"to be pull-requested and reviewed separately. This activity can be difficult to coordinate.\\n\\nAn alte\", \"rnative to using many repositories is to put all the source code together in a giant, all knowing, s\", \"ingle repository.\\n\\n## Single repository\\n\\nIn this approach, sometimes referred to as a monorepository\", \", all the source code for every service is put into the same repository. At first, this approach see\", \"ms like a terrible idea likely to make dealing with source code unwieldy. There are, however, some m\", \"arked advantages to working this way.\\n\\nThe first advantage is that it's easier to manage dependencie\", \"s between projects. Instead of relying on some external artifact feed, projects can directly import \", \"one another. This means that updates are instant, and conflicting versions are likely to be found at\", \" compile time on the developer's workstation. In effect, shifting some of the integration testing le\", \"ft.\\n\\nWhen moving code between projects, it's now easier to preserve the history as the files will be\", \" detected as having been moved rather than being rewritten.\\n\\nAnother advantage is that wide ranging \", \"changes that cross service boundaries can be made in a single commit. This activity reduces the over\", \"head of having potentially dozens of changes to review individually.\\n\\nThere are many tools that can \", \"perform static analysis of code to detect insecure programming practices or problematic use of APIs.\", \" In a multi-repository world, each repository will need to be iterated over to find the problems in \", \"them. The single repository allows running the analysis all in one place.\\n\\nThere are also many disad\", \"vantages to the single repository approach. One of the most worrying ones is that having a single re\", \"pository raises security concerns. If the contents of a repository are leaked in a repository per se\", \"rvice model, the amount of code lost is minimal. With a single repository, everything the company ow\", \"ns could be lost. There have been many examples in the past of this happening and derailing entire g\", \"ame development efforts. Having multiple repositories exposes less surface area, which is a desirabl\", \"e trait in most security practices.\\n\\nThe size of the single repository is likely to become unmanagea\", \"ble rapidly. This presents some interesting performance implications. It may become necessary to use\", \" specialized tools such as Virtual File System for Git, which was originally designed to improve the\", \" experience for developers on the Windows team.\\n\\nFrequently the argument for using a single reposito\", \"ry boils down to an argument that Facebook or Google use this method for source code arrangement. If\", \" the approach is good enough for these companies, then, surely, it's the correct approach for all co\", \"mpanies. The truth of the matter is that few companies operate on anything like the scale of Faceboo\", \"k or Google. The problems that occur at those scales are different from those most developers will f\", \"ace. What is good for the goose may not be good for the gander.\\n\\nIn the end, either solution can be \", \"used to host the source code for microservices. However, in most cases, the management, and engineer\", \"ing overhead of operating in a single repository isn't worth the meager advantages. Splitting code u\", \"p over multiple repositories encourages better separation of concerns and encourages autonomy among \", \"development teams.\\n\\nV\\n\\nservices email Service\\n\\nARM templates\\n\\n## Standard directory structure\\n\\nRegar\", \"dless of the single versus multiple repositories debate each service will have its own directory. On\", \"e of the best optimizations to allow developers to cross between projects quickly is to maintain a s\", \"tandard directory structure.\\n\\nsrc tests\\n\\nARM templates build scripts\\n\\nSrC\\n\\ntests\\n\\nFigure 10 -4 -Stan\", \"dard directory structure.\\n\\n<!-- image -->\\n\\nWhenever a new project is created, a template that puts i\", \"n place the correct structure should be used. This template can also include such useful items as a \", \"skeleton README file and an azurepipelines.yml. In any microservice architecture, a high degree of v\", \"ariance between projects makes bulk operations against the services more difficult.\\n\\nThere are many \", \"tools that can provide templating for an entire directory, containing several source code directorie\", \"s. Yeoman is popular in the JavaScript world and GitHub have recently released Repository Templates,\", \" which provide much of the same functionality.\\n\\n## Task management\\n\\nManaging tasks in any project ca\", \"n be difficult. Up front there are countless questions to be answered about the sort of workflows to\", \" set up to ensure optimal developer productivity.\\n\\nCloud -native applications tend to be smaller tha\", \"n traditional software products or at least they're divided into smaller services. Tracking of issue\", \"s or tasks related to these services remains as important as with any other software project. Nobody\", \" wants to lose track of some work item or explain to a customer that their issue wasn't properly log\", \"ged. Boards are configured at the project level but within each project, areas can be defined. These\", \" allow breaking down issues across several components. The advantage to keeping all the work for the\", \" entire application in one place is that it's easy to move work items from one team to another as th\", \"ey're understood better.\\n\\nWork Items\\n\\n1 NEW TASK *\\n\\nAdd \\\"remember me\\\" button to login screen\\n\\nSimon \", \"Timms\\n\\nState\\n\\n\\u2022 To Do\\n\\nReason\\n\\nDescription checkbox clicked.\\n\\nUser Name:\\n\\nPassword:\\n\\n\\u2022 0 comments\\n\\nA\", \"dd tag\\n\\nA Save\\n\\nAzure DevOps comes with a number of popular templates pre-configured. In the most ba\", \"sic configuration, all that is needed to know is what's in the backlog, what people are working on, \", \"and what's done. It's important to have this visibility into the process of building software, so th\", \"at work can be prioritized and completed tasks reported to the customer. Of course, few software pro\", \"jects stick to a process as simple as to do, doing, and done. It doesn't take long for people to sta\", \"rt adding steps like QA or Detailed Specification to the process. + Add link v\\n\\nOne of the more impo\", \"rtant parts of Agile methodologies is self-introspection at regular intervals. These reviews are mea\", \"nt to provide insight into what problems the team is facing and how they can be improved. Frequently\", \", this means changing the flow of issues and features through the development process. So, it's perf\", \"ectly healthy to expand the layouts of the boards with additional stages.\\n\\nThe stages in the boards \", \"aren't the only organizational tool. Depending on the configuration of the board, there's a hierarch\", \"y of work items. The most granular item that can appear on a board is a task. Out of the box a task \", \"contains fields for a title, description, a priority, an estimate of the amount of work remaining an\", \"d the ability to link to other work items or development items (branches, commits, pull requests, bu\", \"ilds, and so forth). Work items can be classified into different areas of the application and differ\", \"ent iterations (sprints) to make finding them easier.\\n\\nFigure 10 -5 -Task in Azure DevOps.\\n\\n<!-- ima\", \"ge -->\\n\\nThe description field supports the normal styles you'd expect (bold, italic underscore and s\", \"trike through) and the ability to insert images. This makes it a powerful tool for use when specifyi\", \"ng work or bugs.\\n\\nTasks can be rolled up into features, which define a larger unit of work. Features\", \", in turn, can be rolled up into epics. Classifying tasks in this hierarchy makes it much easier to \", \"understand how close a large feature is to rolling out.\\n\\n\\u2022 Back to Work Items\\n\\nO, AzureCamp2019 Team\", \" v\\n\\nAll processes &gt; Basic\\n\\nWork item types\\n\\nBacklog levels\\n\\nTaskboard Backlog Capacity\\n\\nNamel\\n\\n\\u00bf \", \"Collapse all\\n\\n\\u2022 Epic\\n\\n\\u2022 Unparented\\n\\n\\u00a1 Issue\\n\\nTask\\n\\n5f Test Case\\n\\n\\u2022 Test Plan\\n\\nCA Test Suite\\n\\nProject\", \"s\\n\\n+ New Work Item\\n\\nTo Do 8 h\\n\\n\\u2022 2 Add \\\"remember me\\\"\\n\\nbutton to login screen\\n\\n<!-- image -->\\n\\n8 h\\n\\nF\", \"igure 10 -6 -Work item in Azure DevOps.\\n\\nThere are different kinds of views into the issues in Azure\", \" Boards. Items that aren't yet scheduled appear in the backlog. From there, they can be assigned to \", \"a sprint. A sprint is a time box during which it's expected some quantity of work will be completed.\", \" This work can include tasks but also the resolution of tickets. Once there, the entire sprint can b\", \"e managed from the Sprint board section. This view shows how work is progressing and includes a burn\", \" down chart to give an ever-updating estimate of if the sprint will be successful.\\n\\nFigure 10 -7 -Bo\", \"ard in Azure DevOps.\\n\\n<!-- image -->\\n\\nBy now, it should be apparent that there's a great deal of pow\", \"er in the Boards in Azure DevOps. For developers, there are easy views of what is being worked on. F\", \"or project managers views into upcoming work as well as an overview of existing work. For managers, \", \"there are plenty of reports about resourcing and capacity. Unfortunately, there's nothing magical ab\", \"out cloud-native applications that eliminate the need to track work. But if you must track work, the\", \"re are a few places where the experience is better than in Azure DevOps.\\n\\n## CI/CD pipelines\\n\\nAlmost\", \" no change in the software development life cycle has been so revolutionary as the advent of continu\", \"ous integration (CI) and continuous delivery (CD). Building and running automated tests against the \", \"source code of a project as soon as a change is checked in catches mistakes early. Prior to the adve\", \"nt of continuous integration builds, it wouldn't be uncommon to pull code from the\\n\\nDescription\\n\\nDoi\", \"ng\\n\\nJune 8 - June 29.\\n\\n15 work days remaining\\n\\n\\u00a9 Help\\n\\nT Filter by work item type nam\\n\\nO Sprint 1 \\u00d7 \", \"8 Person A v = |\\n\\nDone\\n\\nEpics can be defined as a large piece of work that has one common objective.\", \" Use an Epic to track the progress of complex featur....\\n\\nrepository and find that it didn't pass te\", \"sts or couldn't even be built. This resulted in tracking down the source of the breakage.\\n\\nTradition\", \"ally shipping software to the production environment required extensive documentation and a list of \", \"steps. Each one of these steps needed to be manually completed in a very error prone process.\\n\\nFigur\", \"e 10 -8 -Checklist.\\n\\n<!-- image -->\\n\\nThe sister of continuous integration is continuous delivery in \", \"which the freshly built packages are deployed to an environment. The manual process can't scale to m\", \"atch the speed of development so automation becomes more important. Checklists are replaced by scrip\", \"ts that can execute the same tasks faster and more accurately than any human.\\n\\nThe environment to wh\", \"ich continuous delivery delivers might be a test environment or, as is being done by many major tech\", \"nology companies, it could be the production environment. The latter requires an investment in high-\", \"quality tests that can give confidence that a change isn't going to break production for users. In t\", \"he same way that continuous integration caught issues in the code early continuous delivery catches \", \"issues in the deployment process early.\\n\\nThe importance of automating the build and delivery process\", \" is accentuated by cloud-native applications. Deployments happen more frequently and to more environ\", \"ments so manually deploying borders on impossible.\\n\\n## Azure Builds\\n\\nAzure DevOps provides a set of \", \"tools to make continuous integration and deployment easier than ever. These tools are located under \", \"Azure Pipelines. The first of them is Azure Builds, which is a tool for running YAML-based build def\", \"initions at scale. Users can either bring their own build machines (great for if the build requires \", \"a meticulously set up environment) or use a machine from a constantly refreshed pool of Azure hosted\", \" virtual machines. These hosted build agents come pre-installed with a\\n\\nwide range of development to\", \"ols for not just .NET development but for everything from Java to Python to iPhone development.\\n\\nDev\", \"Ops includes a wide range of out of the box build definitions that can be customized for any build. \", \"The build definitions are defined in a file called azure -pipelines.yml and checked into the reposit\", \"ory so they can be versioned along with the source code. This makes it much easier to make changes t\", \"o the build pipeline in a branch as the changes can be checked into just that branch. An example azu\", \"repipelines.yml for building an ASP.NET web application on full framework is show in Figure 10-9.\\n\\n`\", \"``\\nname: $(rev:r) variables: version: 9.2.0.$(Build.BuildNumber) solution: Portals.sln artifactName:\", \" drop buildPlatform: any cpu buildConfiguration: release pool: name: Hosted VisualStudio demands: -m\", \"sbuild -visualstudio -vstest steps: -task: NuGetToolInstaller@0 displayName: 'Use NuGet 4.4.1' input\", \"s: versionSpec: 4.4.1 -task: NuGetCommand@2 displayName: 'NuGet restore' inputs: restoreSolution: '$\", \"(solution)' -task: VSBuild@1 displayName: 'Build solution' inputs: solution: '$(solution)' msbuildAr\", \"gs: ' -p:DeployOnBuild=true -p:WebPublishMethod=Package -p:PackageAsSingleFile=true -p:SkipInvalidCo\", \"nfigurations=true -p:PackageLocation=\\\"$(build.artifactstagingdirectory)\\\\\\\\ \\\"' platform: '$(buildPlatf\", \"orm)' configuration: '$(buildConfiguration)' -task: VSTest@2 displayName: 'Test Assemblies' inputs: \", \"testAssemblyVer2: | ** \\\\$(buildConfiguration)\\\\ ** \\\\*test*.dll !**\\\\obj\\\\ ** !**\\\\*testadapter.dll platf\", \"orm: '$(buildPlatform)' configuration: '$(buildConfiguration)' -task: CopyFiles@2 displayName: 'Copy\", \" UI Test Files to: $(build.artifactstagingdirectory)' inputs:\\n```\\n\\nR\\n\\nDevelop\\n\\n1 job, 1 task\\n\\nQA\\n\\n1 \", \"job, 1 task\\n\\nProduction\\n\\n1 job, 1 task\\n\\n```\\nSourceFolder: UITests TargetFolder: '$(build.artifactsta\", \"gingdirectory)/uitests' -task: PublishBuildArtifacts@1 displayName: 'Publish Artifact' inputs: Patht\", \"oPublish: '$(build.artifactstagingdirectory)' ArtifactName: '$(artifactName)' condition: succeededOr\", \"Failed()\\n```\\n\\nFigure 10 -9 -A sample azure -pipelines.yml\\n\\nThis build definition uses a number of bu\", \"ilt -in tasks that make creating builds as simple as building a Lego set (simpler than the giant Mil\", \"lennium Falcon). For instance, the NuGet task restores NuGet packages, while the VSBuild task calls \", \"the Visual Studio build tools to perform the actual compilation. There are hundreds of different tas\", \"ks available in Azure DevOps, with thousands more that are maintained by the community. It's likely \", \"that no matter what build tasks you're looking to run, somebody has built one already.\\n\\nBuilds can b\", \"e triggered manually, by a check-in, on a schedule, or by the completion of another build. In most c\", \"ases, building on every check-in is desirable. Builds can be filtered so that different builds run a\", \"gainst different parts of the repository or against different branches. This allows for scenarios li\", \"ke running fast builds with reduced testing on pull requests and running a full regression suite aga\", \"inst the trunk on a nightly basis.\\n\\nThe end result of a build is a collection of files known as buil\", \"d artifacts. These artifacts can be passed along to the next step in the build process or added to a\", \"n Azure Artifacts feed, so they can be consumed by other builds.\\n\\n## Azure DevOps releases\\n\\nBuilds t\", \"ake care of compiling the software into a shippable package, but the artifacts still need to be push\", \"ed out to a testing environment to complete continuous delivery. For this, Azure DevOps uses a separ\", \"ate tool called Releases. The Releases tool makes use of the same tasks' library that were available\", \" to the Build but introduce a concept of \\\"stages\\\". A stage is an isolated environment into which the\", \" package is installed. For instance, a product might make use of a development, a QA, and a producti\", \"on environment. Code is continuously delivered into the development environment where automated test\", \"s can be run against it. Once those tests pass the release moves onto the QA environment for manual \", \"testing. Finally, the code is pushed to production where it's visible to everybody.\\n\\nFigure 10 -10 -\", \"Release pipeline\\n\\n<!-- image -->\\n\\nEach stage in the build can be automatically triggered by the comp\", \"letion of the previous phase. In many cases, however, this isn't desirable. Moving code into product\", \"ion might require approval from somebody. The Releases tool supports this by allowing approvers at e\", \"ach step of the release pipeline. Rules can be set up such that a specific person or group of people\", \" must sign off on a release before it\\n\\nmakes into production. These gates allow for manual quality c\", \"hecks and also for compliance with any regulatory requirements related to control what goes into pro\", \"duction.\\n\\n## Everybody gets a build pipeline\\n\\nThere's no cost to configuring many build pipelines, s\", \"o it's advantageous to have at least one build pipeline per microservice. Ideally, microservices are\", \" independently deployable to any environment so having each one able to be released via its own pipe\", \"line without releasing a mass of unrelated code is perfect. Each pipeline can have its own set of ap\", \"provals allowing for variations in build process for each service.\\n\\n## Versioning releases\\n\\nOne draw\", \"back to using the Releases functionality is that it can't be defined in a checked-in azurepipelines.\", \"yml file. There are many reasons you might want to do that from having per-branch release definition\", \"s to including a release skeleton in your project template. Fortunately, work is ongoing to shift so\", \"me of the stages support into the Build component. This will be known as multi-stage build and the f\", \"irst version is available now!\\n\\n## Feature flags\\n\\nIn chapter 1, we affirmed that cloud native is muc\", \"h about speed and agility. Users expect rapid responsiveness, innovative features, and zero downtime\", \". Feature flags are a modern deployment technique that helps increase agility for cloud-native appli\", \"cations. They enable you to deploy new features into a production environment, but restrict their av\", \"ailability. With the flick of a switch, you can activate a new feature for specific users without re\", \"starting the app or deploying new code. They separate the release of new features from their code de\", \"ployment.\\n\\nFeature flags are built upon conditional logic that control visibility of functionality f\", \"or users at run time. In modern cloud -native systems, it's common to deploy new features into produ\", \"ction early, but test them with a limited audience. As confidence increases, the feature can be incr\", \"ementally rolled out to wider audiences.\\n\\nOther use cases for feature flags include:\\n\\n- Restrict pre\", \"mium functionality to specific customer groups willing to pay higher subscription fees.\\n- Stabilize \", \"a system by quickly deactivating a problem feature, avoiding the risks of a rollback or immediate ho\", \"tfix.\\n- Disable an optional feature with high resource consumption during peak usage periods.\\n- Cond\", \"uct experimental feature releases to small user segments to validate feasibility and popularity.\\n\\nFe\", \"ature flags also promote trunk-based development. It's a source-control branching model where develo\", \"pers collaborate on features in a single branch. The approach minimizes the risk and complexity of m\", \"erging large numbers of long-running feature branches. Features are unavailable until activated.\\n\\n##\", \" Implementing feature flags\\n\\nAt its core, a feature flag is a reference to a simple decision object.\", \" It returns a Boolean state of on or off. The flag typically wraps a block of code that encapsulates\", \" a feature capability. The state of the flag determines whether that code block executes for a given\", \" user. Figure 10-11 shows the implementation.\\n\\n```\\nif (featureFlag) { // Run this code block if the \", \"featureFlag value is true } else { // Run this code block if the featureFlag value is false }\\n```\\n\\nF\", \"igure 10 -11 -Simple feature flag implementation.\\n\\nNote how this approach separates the decision log\", \"ic from the feature code.\\n\\nIn chapter 1, we discussed the Twelve-Factor App. The guidance recommende\", \"d keeping configuration settings external from application executable code. When needed, settings ca\", \"n be read in from the external source. Feature flag configuration values should also be independent \", \"from their codebase. By externalizing flag configuration in a separate repository, you can change fl\", \"ag state without modifying and redeploying the application.\\n\\nAzure App Configuration provides a cent\", \"ralized repository for feature flags. With it, you define different kinds of feature flags and manip\", \"ulate their states quickly and confidently. You add the App Configuration client libraries to your a\", \"pplication to enable feature flag functionality. Various programming language frameworks are support\", \"ed.\\n\\nFeature flags can be easily implemented in an ASP.NET Core service. Installing the .NET Feature\", \" Management libraries and App Configuration provider enable you to declaratively add feature flags t\", \"o your code. They enable FeatureGate attributes so that you don't have to manually write if statemen\", \"ts across your codebase.\\n\\nOnce configured in your Startup class, you can add feature flag functional\", \"ity at the controller, action, or middleware level. Figure 10-12 presents controller and action impl\", \"ementation:\\n\\n```\\n[FeatureGate(MyFeatureFlags . FeatureA)] public class ProductController : Controlle\", \"r { ... } [FeatureGate(MyFeatureFlags . FeatureA)] public IActionResult UpdateProductStatus() { retu\", \"rn ObjectResult(ProductDto); }\\n```\\n\\nFigure 10 -12 -Feature flag implementation in a controller and a\", \"ction.\\n\\nIf a feature flag is disabled, the user will receive a 404 (Not Found) status code with no r\", \"esponse body. Feature flags can also be injected directly into C# classes. Figure 10-13 shows featur\", \"e flag injection:\\n\\n```\\npublic class ProductController : Controller { private readonly IFeatureManage\", \"r _featureManager; public ProductController(IFeatureManager featureManager) { _featureManager = feat\", \"ureManager; } }\\n```\\n\\nFigure 10 -13 -Feature flag injection into a class.\\n\\nThe Feature Management lib\", \"raries manage the feature flag lifecycle behind the scenes. For example, to minimize high numbers of\", \" calls to the configuration store, the libraries cache flag states for a specified duration. They ca\", \"n guarantee the immutability of flag states during a request call. They also offer a Point -in -time\", \" snapshot. You can reconstruct the history of any key-value and provide its past value at any moment\", \" within the previous seven days.\\n\\n## Infrastructure as code\\n\\nCloud -native systems embrace microserv\", \"ices, containers, and modern system design to achieve speed and agility. They provide automated buil\", \"d and release stages to ensure consistent and quality code. But, that's only part of the story. How \", \"do you provision the cloud environments upon which these systems run?\\n\\nModern cloud -native applicat\", \"ions embrace the widely accepted practice of Infrastructure as Code, or IaC. With IaC, you automate \", \"platform provisioning. You essentially apply software engineering practices such as testing and vers\", \"ioning to your DevOps practices. Your infrastructure and deployments are automated, consistent, and \", \"repeatable. Just as continuous delivery automated the traditional model of manual deployments, Infra\", \"structure as Code (IaC) is evolving how application environments are managed.\\n\\nTools like Azure Reso\", \"urce Manager (ARM), Terraform, and the Azure Command Line Interface (CLI) enable you to declarativel\", \"y script the cloud infrastructure you require.\\n\\n## Azure Resource Manager templates\\n\\nARM stands for \", \"Azure Resource Manager. It's an API provisioning engine that is built into Azure and exposed as an A\", \"PI service. ARM enables you to deploy, update, delete, and manage the resources contained in Azure r\", \"esource group in a single, coordinated operation. You provide the engine with a JSON -based template\", \" that specifies the resources you require and their configuration. ARM automatically orchestrates th\", \"e deployment in the correct order respecting dependencies. The engine ensures idempotency. If a desi\", \"red resource already exists with the same configuration, provisioning will be ignored.\\n\\nAzure Resour\", \"ce Manager templates are a JSON-based language for defining various resources in Azure. The basic sc\", \"hema looks something like Figure 10-14.\\n\\n```\\n{ \\\"$schema\\\": \\\"https://schema.management.azure.com/schem\", \"as/2015-01-\\n```\\n\\n```\\n01/deploymentTemplate.json#\\\" , \\\"contentVersion\\\": \\\"\\\" , \\\"apiProfile\\\": \\\"\\\" , \\\"param\", \"eters\\\": { }, \\\"variables\\\": { }, \\\"functions\\\": [ ] , \\\"resources\\\": [ ] , \\\"outputs\\\": { } }\\n```\\n\\nFigure 10\", \" -14 -The schema for a Resource Manager template\\n\\nWithin this template, one might define a storage c\", \"ontainer inside the resources section like so:\\n\\n```\\n\\\"resources\\\": [ { \\\"type\\\": \\\"Microsoft.Storage/stor\", \"ageAccounts\\\" , \\\"name\\\": \\\"[variables('storageAccountName')]\\\" , \\\"location\\\": \\\"[parameters('location')]\\\" \", \", \\\"apiVersion\\\": \\\"2018-07-01\\\" , \\\"sku\\\": { \\\"name\\\": \\\"[parameters('storageAccountType')]\\\" }, \\\"kind\\\": \\\"Sto\", \"rageV2\\\" , \\\"properties\\\": {} } ] ,\\n```\\n\\nFigure 10 -15 -An example of a storage account defined in a Re\", \"source Manager template\\n\\nAn ARM template can be parameterized with dynamic environment and configura\", \"tion information. Doing so enables it to be reused to define different environments, such as develop\", \"ment, QA, or production. Normally, the template creates all resources within a single Azure resource\", \" group. It's possible to define multiple resource groups in a single Resource Manager template, if n\", \"eeded. You can delete all resources in an environment by deleting the resource group itself. Cost an\", \"alysis can also be run at the resource group level, allowing for quick accounting of how much each e\", \"nvironment is costing.\\n\\nThere are many examples of ARM templates available in the Azure Quickstart T\", \"emplates project on GitHub. They can help accelerate creating a new template or modifying an existin\", \"g one.\\n\\nResource Manager templates can be run in many of ways. Perhaps the simplest way is to simply\", \" paste them into the Azure portal. For experimental deployments, this method can be quick. They can \", \"also be run as part of a build or release process in Azure DevOps. There are tasks that will leverag\", \"e connections into Azure to run the templates. Changes to Resource Manager templates are applied inc\", \"rementally, meaning that to add a new resource requires just adding it to the template. The tooling \", \"will reconcile differences between the current resources and those defined in the template. Resource\", \"s will then be created or altered so they match what is defined in the template.\\n\\n## Terraform\\n\\nClou\", \"d -native applications are often constructed to be cloud agnostic. Being so means the application is\", \"n't tightly coupled to a particular cloud vendor and can be deployed to any public cloud.\\n\\nTerraform\", \" is a commercial templating tool that can provision cloud-native applications across all the major c\", \"loud players: Azure, Google Cloud Platform, AWS, and AliCloud. Instead of using JSON as the template\", \" definition language, it uses the slightly more terse HCL (Hashicorp Configuration Language).\\n\\nAn ex\", \"ample Terraform file that does the same as the previous Resource Manager template (Figure 1015) is s\", \"hown in Figure 10-16:\\n\\n```\\nprovider \\\"azurerm\\\" { version = \\\"=1.28.0\\\" } resource \\\"azurerm_resource_gro\", \"up\\\" \\\"testrg\\\" { name = \\\"production\\\" location = \\\"West US\\\" } resource \\\"azurerm_storage_account\\\" \\\"testsa\", \"\\\" { name = \\\"${var.storageAccountName}\\\" resource_group_name = \\\"${azurerm_resource_group.testrg.name}\\\"\", \" location = \\\"${var.region}\\\" account_tier = \\\"${var.tier}\\\" account_replication_type = \\\"${var.replicati\", \"onType}\\\" }\\n```\\n\\nFigure 10 -16 -An example of a Resource Manager template\\n\\nTerraform also provides in\", \"tuitive error messages for problem templates. There's also a handy validate task that can be used in\", \" the build phase to catch template errors early.\\n\\nAs with Resource Manager templates, command-line t\", \"ools are available to deploy Terraform templates. There are also community-created tasks in Azure Pi\", \"pelines that can validate and apply Terraform templates.\\n\\nSometimes Terraform and ARM templates outp\", \"ut meaningful values, such as a connection string to a newly created database. This information can \", \"be captured in the build pipeline and used in subsequent tasks.\\n\\n## Azure CLI Scripts and Tasks\\n\\nFin\", \"ally, you can leverage Azure CLI to declaratively script your cloud infrastructure. Azure CLI script\", \"s can be created, found, and shared to provision and configure almost any Azure resource. The CLI is\", \" simple to use with a gentle learning curve. Scripts are executed within either PowerShell or Bash. \", \"They're also straightforward to debug, especially when compared with ARM templates.\\n\\nAzure CLI scrip\", \"ts work well when you need to tear down and redeploy your infrastructure. Updating an existing envir\", \"onment can be tricky. Many CLI commands aren't idempotent. That means they'll recreate the resource \", \"each time they're run, even if the resource already exists. It's always possible to add code that ch\", \"ecks for the existence of each resource before creating it. But, doing so, your script can become bl\", \"oated and difficult to manage.\\n\\nThese scripts can also be embedded in Azure DevOps pipelines as Azur\", \"e CLI tasks. Executing the pipeline invokes the script.\\n\\nFigure 10-17 shows a YAML snippet that list\", \"s the version of Azure CLI and the details of the subscription. Note how Azure CLI commands are incl\", \"uded in an inline script.\\n\\n```\\n-task: AzureCLI@2 displayName: Azure CLI inputs: azureSubscription: <\", \"Name of the Azure Resource Manager service connection> scriptType: ps scriptLocation: inlineScript i\", \"nlineScript: | az --version az account show\\n```\\n\\nFigure 10 -17 -Azure CLI script\\n\\nIn the article, Wh\", \"at is Infrastructure as Code, Author Sam Guckenheimer describes how, \\\"Teams who implement IaC can de\", \"liver stable environments rapidly and at scale. Teams avoid manual configuration of environments and\", \" enforce consistency by representing the desired state of their environments via code. Infrastructur\", \"e deployments with IaC are repeatable and prevent runtime issues caused by configuration drift or mi\", \"ssing dependencies. DevOps teams can work together with a unified set of practices and tools to deli\", \"ver applications and their supporting infrastructure rapidly, reliably, and at scale.\\\"\\n\\n## Cloud Nat\", \"ive Application Bundles\\n\\nA key property of cloud-native applications is that they leverage the capab\", \"ilities of the cloud to speed up development. This design often means that a full application uses d\", \"ifferent kinds of technologies. Applications may be shipped in Docker containers, some services may \", \"use Azure Functions, while other parts may run directly on virtual machines allocated on large metal\", \" servers with hardware GPU acceleration. No two cloud -native applications are the same, so it's bee\", \"n difficult to provide a single mechanism for shipping them.\\n\\nThe Docker containers may run on Kuber\", \"netes using a Helm Chart for deployment. The Azure Functions may be allocated using Terraform templa\", \"tes. Finally, the virtual machines may be allocated using Terraform but built out using Ansible. Thi\", \"s is a large variety of technologies and there has been no way to package them all together into a r\", \"easonable package. Until now.\\n\\nCloud Native Application Bundles (CNABs) are a joint effort by many c\", \"ommunity-minded companies such as Microsoft, Docker, and HashiCorp to develop a specification to pac\", \"kage distributed applications.\\n\\nThe effort was announced in December of 2018, so there's still a fai\", \"r bit of work to do to expose the effort to the greater community. However, there's already an open \", \"specification and a reference implementation known as Duffle. This tool, which was written in Go, is\", \" a joint effort between Docker and Microsoft.\\n\\nThe CNABs can contain different kinds of installation\", \" technologies. This aspect allows things like Helm Charts, Terraform templates, and Ansible Playbook\", \"s to coexist in the same package. Once built, the packages are self-contained and portable; they can\", \" be installed from a USB stick. The packages are cryptographically signed to ensure they originate f\", \"rom the party they claim.\\n\\nThe core of a CNAB is a file called bundle.json. This file defines the co\", \"ntents of the bundle, be they Terraform or images or anything else. Figure 11-9 defines a CNAB that \", \"invokes some Terraform. Notice, however, that it actually defines an invocation image that is used t\", \"o invoke the Terraform. When packaged up, the Docker file that is located in the cnab directory is b\", \"uilt into a Docker image, which will be included in the bundle. Having Terraform installed inside a \", \"Docker container in the bundle means that users don't need to have Terraform installed on their mach\", \"ine to run the bundling.\\n\\n```\\n{ \\\"name\\\": \\\"terraform\\\" , \\\"version\\\": \\\"0.1.0\\\" , \\\"schemaVersion\\\": \\\"v1.0.0 \", \"-WD\\\" , \\\"parameters\\\": { \\\"backend\\\": { \\\"type\\\": \\\"boolean\\\" , \\\"defaultValue\\\": false , \\\"destination\\\": { \\\"en\", \"v\\\": \\\"TF_VAR_backend\\\" } } }, \\\"invocationImages\\\": [ { \\\"imageType\\\": \\\"docker\\\" , \\\"image\\\": \\\"cnab/terraform\", \":latest\\\" } ] , \\\"credentials\\\": { \\\"tenant_id\\\": { \\\"env\\\": \\\"TF_VAR_tenant_id\\\" }, \\\"client_id\\\": { \\\"env\\\": \\\"T\", \"F_VAR_client_id\\\" }, \\\"client_secret\\\": { \\\"env\\\": \\\"TF_VAR_client_secret\\\" }, \\\"subscription_id\\\": { \\\"env\\\": \", \"\\\"TF_VAR_subscription_id\\\" }, \\\"ssh_authorized_key\\\": { \\\"env\\\": \\\"TF_VAR_ssh_authorized_key\\\" } }, \\\"actions\", \"\\\": { \\\"status\\\": { \\\"modifies\\\": true } } }\\n```\\n\\nFigure 10 -18 -An example Terraform file\\n\\nThe bundle.js\", \"on also defines a set of parameters that are passed down into the Terraform. Parameterization of the\", \" bundle allows for installation in various different environments.\\n\\nThe CNAB format is also flexible\", \", allowing it to be used against any cloud. It can even be used against on-premises solutions such a\", \"s OpenStack .\\n\\n## DevOps Decisions\\n\\nThere are so many great tools in the DevOps space these days and\", \" even more fantastic books and papers on how to succeed. A favorite book to get started on the DevOp\", \"s journey is The Phoenix Project, which follows the transformation of a fictional company from NoOps\", \" to DevOps. One thing is for certain: DevOps is no longer a \\\"nice to have\\\" when deploying complex, C\", \"loud Native Applications. It's a requirement and should be planned for and resourced at the start of\", \" any project.\\n\\n## References\\n\\n- Azure DevOps\\n- Azure Resource Manager\\n- Terraform\\n- Azure CLI\\n\\nMicro\", \" services\\n\\nModern\\n\\nDesign\\n\\nContainers\\n\\nBacking\\n\\nServices\\n\\n## Summary: Architecting cloud -native app\", \"s\\n\\nIn summary, here are important conclusions from this guide:\\n\\n- Cloud -native is about designing m\", \"odern applications that embrace rapid change, large scale, and resilience, in modern, dynamic enviro\", \"nments such as public, private, and hybrid clouds.\\n- The Cloud Native Computing Foundation (CNCF) is\", \" an influential open-source consortium of over 300 major corporations. It's responsible for driving \", \"the adoption of cloud-native computing across technology and cloud stacks.\\n- CNCF guidelines recomme\", \"nd that cloud-native applications embrace six important pillars as shown in Figure 11-1:\\n- These clo\", \"ud -native pillars include:\\n- \\u2013 The cloud and its underlying service model\\n- \\u2013 Modern design princip\", \"les\\n- \\u2013 Microservices\\n- \\u2013 Containerization and container orchestration\\n- \\u2013 Cloud -based backing serv\", \"ices, such as databases and message brokers\\n- \\u2013 Automation, including Infrastructure as Code and cod\", \"e deployment\\n\\nFigure 11-1. Cloud-native foundational pillars\\n\\n<!-- image -->\\n\\n<!-- image -->\\n\\n- Kube\", \"rnetes is the hosting environment of choice for most cloud-native applications. Smaller, simple serv\", \"ices are sometimes hosted in serverless platforms, such as Azure Functions. Among many key automatio\", \"n features, both environments provide automatic scaling to handle fluctuating workload volumes.\\n- Se\", \"rvice communication becomes a significant design decision when constructing a cloudnative applicatio\", \"n. Applications typically expose an API gateway to manage front-end client communication. Then backe\", \"nd microservices strive to communicate with each other implementing asynchronous communication patte\", \"rns, when possible.\\n- gRPC is a modern, high-performance framework that evolves the age-old remote p\", \"rocedure call (RPC) protocol. Cloud-native applications often embrace gRPC to streamline messaging b\", \"etween back -end services. gRPC uses HTTP/2 for its transport protocol. It can be up to 8x faster th\", \"an JSON serialization with message sizes 60-80% smaller. gRPC is open source and managed by the Clou\", \"d Native Computing Foundation (CNCF).\\n- Distributed data is a model often implemented by cloud-nativ\", \"e applications. Applications segregate business functionality into small, independent microservices.\", \" Each microservice encapsulates its own dependencies, data, and state. The classic shared database m\", \"odel evolves into one of many smaller databases, each aligning with a microservice. When the smoke c\", \"lears, we emerge with a design that exposes a database-per-microservice model.\\n- No -SQL databases r\", \"efer to high-performance, non-relational data stores. They excel in their ease-of -use, scalability,\", \" resilience, and availability characteristics. High volume services that require sub second response\", \" time favor NoSQL datastores. The proliferation of NoSQL technologies for distributed cloud-native s\", \"ystems can't be overstated.\\n- NewSQL is an emerging database technology that combines the distribute\", \"d scalability of NoSQL and the ACID guarantees of a relational database. NewSQL databases target bus\", \"iness systems that must process high-volumes of data, across distributed environments, with full tra\", \"nsactional/ACID compliance. The Cloud Native Computing Foundation (CNCF) features several NewSQL dat\", \"abase projects.\\n- Resiliency is the ability of your system to react to failure and still remain func\", \"tional. Cloudnative systems embrace distributed architecture where failure is inevitable. Applicatio\", \"ns must be constructed to respond elegantly to failure and quickly return to a fully functioning sta\", \"te.\\n- Service meshes are a configurable infrastructure layer with built-in capabilities to handle se\", \"rvice communication and other cross -cutting challenges. They decouple cross-cutting responsibilitie\", \"s from your business code. These responsibilities move into a service proxy. Referred to as the Side\", \"car pattern, the proxy is deployed into a separate process to provide isolation from your business c\", \"ode.\\n- Observability is a key design consideration for cloud-native applications. As services are di\", \"stributed across a cluster of nodes, centralized logging, monitoring, and alerts, become mandatory. \", \"Azure Monitor is a collection of cloud-based tools designed to provide visibility into the state of \", \"your system.\\n\\n- Infrastructure as Code is a widely accepted practice that automates platform provisi\", \"oning. Your infrastructure and deployments are automated, consistent, and repeatable. Tools like Azu\", \"re Resource Manager, Terraform, and the Azure CLI, enable you to declaratively script the cloud infr\", \"astructure you require.\\n- Code automation is a requirement for cloud-native applications. Modern CI/\", \"CD systems help fulfill this principle. They provide separate build and deployment steps that help e\", \"nsure consistent and quality code. The build stage transforms the code into a binary artifact. The r\", \"elease stage picks up the binary artifact, applies external environment configuration, and deploys i\", \"t to a specified environment. Azure DevOps and GitHub are full-featured DevOps environments.\"]"