|    | options.UseInMemoryDatabase("Identity");                                          |
|---:|:----------------------------------------------------------------------------------|
|  0 | options.UseInternalServiceProvider(provider);                                     |
|  1 | });                                                                               |
|  2 |                                                                                   |
|  3 | // Build the service provider.                                                    |
|  4 | var sp = services.BuildServiceProvider();                                         |
|  5 |                                                                                   |
|  6 | // Create a scope to obtain a reference to the database                           |
|  7 | // context (ApplicationDbContext).                                                |
|  8 | using (var scope = sp.CreateScope())                                              |
|  9 | {                                                                                 |
| 10 | var scopedServices = scope.ServiceProvider;                                       |
| 11 | var db = scopedServices.GetRequiredService<CatalogContext>();                     |
| 12 | var loggerFactory = scopedServices.GetRequiredService<ILoggerFactory>();          |
| 13 |                                                                                   |
| 14 | var logger = scopedServices                                                       |
| 15 | .GetRequiredService<ILogger<WebTestFixture>>();                                   |
| 16 |                                                                                   |
| 17 | // Ensure the database is created.                                                |
| 18 | db.Database.EnsureCreated();                                                      |
| 19 |                                                                                   |
| 20 | try                                                                               |
| 21 | {                                                                                 |
| 22 | // Seed the database with test data.                                              |
| 23 | CatalogContextSeed.SeedAsync(db, loggerFactory).Wait();                           |
| 24 |                                                                                   |
| 25 | // seed sample user data                                                          |
| 26 | var userManager =                                                                 |
| 27 | scopedServices.GetRequiredService<UserManager<ApplicationUser>>();                |
| 28 | var roleManager = scopedServices.GetRequiredService<RoleManager<IdentityRole>>(); |
| 29 | AppIdentityDbContextSeed.SeedAsync(userManager, roleManager).Wait();              |
| 30 | }                                                                                 |
| 31 | catch (Exception ex)                                                              |
| 32 | {                                                                                 |
| 33 | logger.LogError(ex, $"An error occurred seeding the " +                           |
| 34 | "database with test messages. Error: {ex.Message}");                              |
| 35 | }                                                                                 |
| 36 | }                                                                                 |
| 37 | });                                                                               |
| 38 | }                                                                                 |
| 39 | }                                                                                 |