|    | 0                                                                                 |
|---:|:----------------------------------------------------------------------------------|
|  0 | options.UseInMemoryDatabase("Identity");                                          |
|  1 | options.UseInternalServiceProvider(provider);                                     |
|  2 | });                                                                               |
|  3 |                                                                                   |
|  4 | // Build the service provider.                                                    |
|  5 | var sp = services.BuildServiceProvider();                                         |
|  6 |                                                                                   |
|  7 | // Create a scope to obtain a reference to the database                           |
|  8 | // context (ApplicationDbContext).                                                |
|  9 | using (var scope = sp.CreateScope())                                              |
| 10 | {                                                                                 |
| 11 | var scopedServices = scope.ServiceProvider;                                       |
| 12 | var db = scopedServices.GetRequiredService<CatalogContext>();                     |
| 13 | var loggerFactory = scopedServices.GetRequiredService<ILoggerFactory>();          |
| 14 |                                                                                   |
| 15 | var logger = scopedServices                                                       |
| 16 | .GetRequiredService<ILogger<WebTestFixture>>();                                   |
| 17 |                                                                                   |
| 18 | // Ensure the database is created.                                                |
| 19 | db.Database.EnsureCreated();                                                      |
| 20 |                                                                                   |
| 21 | try                                                                               |
| 22 | {                                                                                 |
| 23 | // Seed the database with test data.                                              |
| 24 | CatalogContextSeed.SeedAsync(db, loggerFactory).Wait();                           |
| 25 |                                                                                   |
| 26 | // seed sample user data                                                          |
| 27 | var userManager =                                                                 |
| 28 | scopedServices.GetRequiredService<UserManager<ApplicationUser>>();                |
| 29 | var roleManager = scopedServices.GetRequiredService<RoleManager<IdentityRole>>(); |
| 30 | AppIdentityDbContextSeed.SeedAsync(userManager, roleManager).Wait();              |
| 31 | }                                                                                 |
| 32 | catch (Exception ex)                                                              |
| 33 | {                                                                                 |
| 34 | logger.LogError(ex, $"An error occurred seeding the " +                           |
| 35 | "database with test messages. Error: {ex.Message}");                              |
| 36 | }                                                                                 |
| 37 | }                                                                                 |
| 38 | });                                                                               |
| 39 | }                                                                                 |
| 40 | }                                                                                 |