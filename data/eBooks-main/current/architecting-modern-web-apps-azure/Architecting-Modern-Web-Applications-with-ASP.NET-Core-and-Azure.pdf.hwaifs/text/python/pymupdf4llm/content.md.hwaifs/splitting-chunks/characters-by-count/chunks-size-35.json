"[\"**EDITION v8.0** - Updated to ASP.NET Core 8.0\\n\\n\\n[Refer changelog](https://aka.ms/aspnet-ebook-chang\", \"elog) for the book updates and community contributions.\\n\\n\\nPUBLISHED BY\\n\\n\\nMicrosoft Developer Divisio\", \"n, .NET, and Visual Studio product teams\\n\\n\\nA division of Microsoft Corporation\\n\\n\\nOne Microsoft Way\\n\\n\", \"\\nRedmond, Washington 98052-6399\\n\\n\\nCopyright \\u00a9 2023 by Microsoft Corporation\\n\\n\\nAll rights reserved. N\", \"o part of the contents of this book may be reproduced or transmitted in any\\nform or by any means wit\", \"hout the written permission of the publisher.\\n\\n\\nThis book is provided \\u201cas-is\\u201d and expresses the auth\", \"or\\u2019s views and opinions. The views, opinions, and\\ninformation expressed in this book, including URL \", \"and other Internet website references, may change\\nwithout notice.\\n\\n\\nSome examples depicted herein ar\", \"e provided for illustration only and are fictitious. No real association\\nor connection is intended o\", \"r should be inferred.\\n\\n\\n[Microsoft and the trademarks listed at https://www.microsoft.com](https://w\", \"ww.microsoft.com/) on the \\u201cTrademarks\\u201d webpage are\\ntrademarks of the Microsoft group of companies.\\n\\n\", \"\\nMac and macOS are trademarks of Apple Inc.\\n\\n\\nThe Docker whale logo is a registered trademark of Doc\", \"ker, Inc. Used by permission.\\n\\n\\nAll other marks and logos are property of their respective owners.\\n\\n\", \"\\nAuthor:\\n\\n\\n**Steve \\u201cardalis\\u201d Smith** [- Software Architect and Trainer - Ardalis.com](https://ardali\", \"s.com/)\\n\\n\\nEditors:\\n\\n\\n**Maira Wenzel**\\n### Action links\\n\\n\\n  - [This e-book is also available in a PDF\", \" format (English version only) Download](https://aka.ms/webappebook)\\n\\n\\n  - [Clone/Fork the reference\", \" application eShopOnWeb on GitHub](https://github.com/dotnet-architecture/eShopOnWeb)\\n### Introducti\", \"on\\n\\n\\n.NET 8 and ASP.NET Core offer several advantages over traditional .NET development. You should \", \"use\\n.NET 8 for your server applications if some or all of the following are important to your applic\", \"ation\\u2019s\\nsuccess:\\n\\n\\n  - Cross-platform support.\\n\\n\\n  - Use of microservices.\\n\\n\\n  - Use of Docker conta\", \"iners.\\n\\n\\n  - High performance and scalability requirements.\\n\\n\\n  - Side-by-side versioning of .NET ve\", \"rsions by application on the same server.\\n\\n\\nTraditional .NET 4.x apps can and do support many of the\", \"se requirements, but ASP.NET Core and .NET\\n8 have been optimized to offer improved support for the a\", \"bove scenarios.\\n\\n\\nMore and more organizations are choosing to host their web applications in the clo\", \"ud using services\\nlike Microsoft Azure. You should consider hosting your application in the cloud if\", \" the following are\\nimportant to your application or organization:\\n\\n\\n  - Reduced investment in data c\", \"enter costs (hardware, software, space, utilities, server\\nmanagement, etc.)\\n\\n\\n  - Flexible pricing (\", \"pay based on usage, not for idle capacity).\\n\\n\\n  - Extreme reliability.\\n\\n\\n  - Improved app mobility; \", \"easily change where and how your app is deployed.\\n\\n\\n  - Flexible capacity; scale up or down based on\", \" actual needs.\\n\\n\\nBuilding web applications with ASP.NET Core, hosted in Azure, offers many competiti\", \"ve advantages\\nover traditional alternatives. ASP.NET Core is optimized for modern web application de\", \"velopment\\npractices and cloud hosting scenarios. In this guide, you\\u2019ll learn how to architect your A\", \"SP.NET Core\\napplications to best take advantage of these capabilities.\\n### Version\\n\\n\\nThis guide has \", \"been revised to cover **.NET 8.0** version along with many additional updates related to\\nthe same \\u201cw\", \"ave\\u201d of technologies (that is, Azure and additional third-party technologies) coinciding in\\ntime wit\", \"h the .NET 8.0 release. That\\u2019s why the book version has also been updated to version **8.0** .\\n### P\", \"urpose\\n\\n\\nThis guide provides end-to-end guidance on building _monolithic_ web applications using ASP\", \".NET\\nCore and Azure. In this context, \\u201cmonolithic\\u201d refers to the fact that these applications are de\", \"ployed as\\na single unit, not as a collection of interacting services and applications. In some conte\", \"xts, the term\\n_monolith_ may be used as a pejorative, but in the vast majority of situations a singl\", \"e application is\\nmuch easier to build, deploy, and debug than an app composed of many different serv\", \"ices, while still\\nachieving the business requirements.\\n\\n\\nThis guide is complementary to \\u201c _[.NET Mic\", \"roservices. Architecture for Containerized .NET Applications](https://docs.microsoft.com/en-us/dotne\", \"t/architecture/microservices/)_ \\u201d,\\nwhich focuses more on Docker, microservices, and deployment of co\", \"ntainers to host enterprise\\napplications.\\n\\n\\n#### **.NET Microservices. Architecture for Containerize\", \"d .NET Applications**\\n\\n\\n  - **e-book**\\n[https://aka.ms/MicroservicesEbook](https://aka.ms/Microservi\", \"cesEbook)\\n\\n  - **Sample Application**\\n[https://aka.ms/microservicesarchitecture](https://aka.ms/micr\", \"oservicesarchitecture)\\n### Who should use this guide\\n\\n\\nThe audience for this guide is mainly develop\", \"ers, development leads, and architects who are\\ninterested in building modern web applications using \", \"Microsoft technologies and services in the\\ncloud.\\n\\n\\nA secondary audience is technical decision maker\", \"s who are already familiar ASP.NET or Azure and are\\nlooking for information on whether it makes sens\", \"e to upgrade to ASP.NET Core for new or existing\\nprojects.\\n### How you can use this guide\\n\\n\\nThis gui\", \"de has been condensed into a relatively small document that focuses on building web\\napplications wit\", \"h modern .NET technologies and Azure. As such, it can be read in its entirety to\\nprovide a foundatio\", \"n of understanding such applications and their technical considerations. The\\nguide, along with its s\", \"ample application, can also serve as a starting point or reference. Use the\\nassociated sample applic\", \"ation as a template for your own applications, or to see how you might\\norganize your application\\u2019s c\", \"omponent parts. Refer back to the guide\\u2019s principles and coverage of\\narchitecture and technology opt\", \"ions and decision considerations when you\\u2019re weighing these choices\\nfor your own application.\\n\\n\\nFeel\", \" free to forward this guide to your team to help ensure a common understanding of these\\nconsideratio\", \"ns and opportunities. Having everybody working from a common set of terminology and\\nunderlying princ\", \"iples helps ensure consistent application of architectural patterns and practices.\\n### References\\n\\n\\n\", \"  - **Choosing between .NET and .NET Framework for server apps**\\n[https://learn.microsoft.com/dotnet\", \"/standard/choosing-core-framework-server](https://docs.microsoft.com/en-us/dotnet/standard/choosing-\", \"core-framework-server)\\n\\n\\n## Contents\\n\\n**Characteristics of Modern Web Applications .................\", \"...................................................... 1**\\n\\n\\nReference application: eShopOnWeb .....\", \"....................................................................................................\", \"..................... 1\\n\\n\\nReference Application ....................................................\", \"................................................................................................... \", \"2\\n\\n\\nCloud-hosted and scalable ......................................................................\", \"............................................................................ 2\\n\\n\\nCross platform ....\", \"....................................................................................................\", \"................................................................... 2\\n\\n\\nModular and loosely coupled \", \"....................................................................................................\", \"......................................... 3\\n\\n\\nEasily tested with automated tests ...................\", \"....................................................................................................\", \"............ 3\\n\\n\\nTraditional and SPA behaviors supported ...........................................\", \".......................................................................... 3\\n\\n\\nSimple development an\", \"d deployment .......................................................................................\", \"..................................... 4\\n\\n\\nTraditional ASP.NET and Web Forms ........................\", \"....................................................................................................\", \"... 4\\n\\n\\nBlazor .....................................................................................\", \"....................................................................................................\", \"... 4\\n\\n\\nReferences \\u2013 Modern Web Applications .......................................................\", \"............................................................ 4\\n\\n\\n**Choose Between Traditional Web Ap\", \"ps and Single Page Apps (SPAs) ............................. 6**\\n\\n\\nBlazor ..........................\", \"....................................................................................................\", \".............................................................. 7\\n\\n\\nWhen to choose traditional web ap\", \"ps .................................................................................................\", \"........................... 7\\n\\n\\nWhen to choose SPAs ................................................\", \"....................................................................................................\", \"........ 8\\n\\n\\nReferences \\u2013 SPA Frameworks ...........................................................\", \"............................................................................ 8\\n\\n\\nWhen to choose Blaz\", \"or .................................................................................................\", \"........................................................ 9\\n\\n\\nDecision table ........................\", \"....................................................................................................\", \"................................................ 9\\n\\n\\nOther considerations ..........................\", \"....................................................................................................\", \"................................ 9\\n\\n\\n**Architectural principles ....................................\", \"..................................................................... 11**\\n\\n\\nCommon design principle\", \"s ..................................................................................................\", \"............................................. 11\\n\\n\\nSeparation of concerns ..........................\", \"....................................................................................................\", \".................... 11\\n\\n\\nEncapsulation ............................................................\", \"....................................................................................................\", \"..... 11\\n\\n\\nDependency inversion ....................................................................\", \"................................................................................ 12\\n\\n\\nExplicit depen\", \"dencies ............................................................................................\", \"......................................................... 14\\n\\n\\nSingle responsibility ...............\", \"....................................................................................................\", \"..................................... 14\\n\\n\\nDon\\u2019t repeat yourself (DRY) .............................\", \"....................................................................................................\", \"........ 15\\n\\n\\ni Contents\\n\\n\\nPersistence ignorance ...................................................\", \"................................................................................................. 15\", \"\\n\\n\\nBounded contexts ................................................................................\", \"............................................................................ 16\\n\\n\\nAdditional resourc\", \"es .................................................................................................\", \"........................................................... 16\\n\\n\\n**Common web application architectu\", \"res ............................................................................. 17**\\n\\n\\nWhat is a m\", \"onolithic application? .............................................................................\", \"..................................................... 17\\n\\n\\nAll-in-one applications .................\", \"....................................................................................................\", \".................................. 17\\n\\n\\nWhat are layers? ...........................................\", \"....................................................................................................\", \"..................... 18\\n\\n\\nTraditional \\u201cN-Layer\\u201d architecture applications .........................\", \"............................................................................... 19\\n\\n\\nClean architect\", \"ure ................................................................................................\", \"................................................................. 23\\n\\n\\nOrganizing code in Clean Arch\", \"itecture ...........................................................................................\", \"........................ 28\\n\\n\\nMonolithic applications and containers ...............................\", \"........................................................................................ 30\\n\\n\\nMonoli\", \"thic application deployed as a container ...........................................................\", \"...................................... 31\\n\\n\\nDocker support .........................................\", \"....................................................................................................\", \"......................... 33\\n\\n\\nTroubleshooting Docker problems .....................................\", \"...................................................................................... 34\\n\\n\\nOther we\", \"b application architectural styles .................................................................\", \"............................................ 34\\n\\n\\nReferences \\u2013 Common web architectures ............\", \".................................................................................................. 3\", \"4\\n\\n\\n**Common client-side web technologies ..........................................................\", \"..................... 36**\\n\\n\\nHTML ..................................................................\", \"....................................................................................................\", \".................... 36\\n\\n\\nCSS ......................................................................\", \"....................................................................................................\", \".................... 36\\n\\n\\nCSS preprocessors ........................................................\", \"................................................................................................... \", \"37\\n\\n\\nJavaScript ....................................................................................\", \"............................................................................................. 38\\n\\n\\nL\", \"egacy web apps with jQuery .........................................................................\", \"............................................................ 38\\n\\n\\njQuery vs a SPA Framework ........\", \"....................................................................................................\", \"............................. 38\\n\\n\\nAngular SPAs ....................................................\", \"....................................................................................................\", \".............. 39\\n\\n\\nReact ..........................................................................\", \"....................................................................................................\", \"........ 40\\n\\n\\nVue ..................................................................................\", \"....................................................................................................\", \"... 40\\n\\n\\nBlazor WebAssembly ........................................................................\", \".............................................................................. 41\\n\\n\\nChoosing a SPA F\", \"ramework ...........................................................................................\", \".............................................. 41\\n\\n\\nReferences \\u2013 Client Web Technologies ...........\", \"....................................................................................................\", \".... 42\\n\\n\\n**Develop ASP.NET Core MVC apps ..........................................................\", \"............................. 43**\\n\\n\\nMVC and Razor Pages ...........................................\", \"....................................................................................................\", \".......... 43\\n\\n\\nii Contents\\n\\n\\nWhy Razor Pages?......................................................\", \"....................................................................................................\", \".. 44\\n\\n\\nWhen to use MVC ............................................................................\", \"................................................................................ 44\\n\\n\\nMapping reques\", \"ts to responses ....................................................................................\", \"................................................. 44\\n\\n\\nKeeping controllers under control ...........\", \"....................................................................................................\", \"............. 46\\n\\n\\nReferences \\u2013 Mapping Requests to Responses ......................................\", \"............................................................. 48\\n\\n\\nWorking with dependencies .......\", \"....................................................................................................\", \".................................. 48\\n\\n\\nDeclare your dependencies ..................................\", \"....................................................................................................\", \".... 49\\n\\n\\nStructuring the application ..............................................................\", \"................................................................................. 50\\n\\n\\nFeature organ\", \"ization ............................................................................................\", \"........................................................... 51\\n\\n\\nAPIs and Blazor applications ......\", \"....................................................................................................\", \".............................. 53\\n\\n\\nCross-cutting concerns .........................................\", \"....................................................................................................\", \"..... 54\\n\\n\\nReferences \\u2013 Structuring applications ...................................................\", \".................................................................. 57\\n\\n\\nSecurity ...................\", \"....................................................................................................\", \".............................................................. 57\\n\\n\\nIdentity .......................\", \"....................................................................................................\", \"...................................................... 57\\n\\n\\nAuthentication .........................\", \"....................................................................................................\", \"...................................... 60\\n\\n\\nReferences \\u2013 Authentication ............................\", \"....................................................................................................\", \"........ 61\\n\\n\\nAuthorization ........................................................................\", \"............................................................................................. 61\\n\\n\\nR\", \"eferences \\u2013 Security ...............................................................................\", \"....................................................................... 64\\n\\n\\nClient communication ..\", \"....................................................................................................\", \"................................................... 64\\n\\n\\nReferences \\u2013 Client Communication .........\", \"....................................................................................................\", \"........... 65\\n\\n\\nDomain-driven design \\u2013 Should you apply it? .......................................\", \"................................................................... 65\\n\\n\\nWhen should you apply DDD .\", \"....................................................................................................\", \"................................. 66\\n\\n\\nWhen shouldn\\u2019t you apply DDD ................................\", \"................................................................................................ 66\\n\", \"\\n\\nReferences \\u2013 Domain-Driven Design ................................................................\", \"....................................................... 67\\n\\n\\nDeployment ............................\", \"....................................................................................................\", \"............................................. 67\\n\\n\\nReferences \\u2013 Deployment .........................\", \"....................................................................................................\", \"................ 68\\n\\n\\n**Working with Data in ASP.NET Core Apps .....................................\", \".................................... 69**\\n\\n\\nEntity Framework Core (for relational databases) .......\", \"............................................................................................. 69\\n\\n\\nT\", \"he DbContext .......................................................................................\", \"........................................................................... 69\\n\\n\\nConfiguring EF Core\", \" ...................................................................................................\", \"..................................................... 70\\n\\n\\nFetching and storing Data ...............\", \"....................................................................................................\", \"......................... 71\\n\\n\\nFetching related data ...............................................\", \"....................................................................................................\", \"... 72\\n\\n\\niii Contents\\n\\n\\nEncapsulating data .........................................................\", \"................................................................................................. 73\", \"\\n\\n\\nResilient connections ...........................................................................\", \"........................................................................... 74\\n\\n\\nReferences \\u2013 Entity\", \" Framework Core ....................................................................................\", \".................................... 76\\n\\n\\nEF Core or micro-ORM? ....................................\", \"....................................................................................................\", \"............. 76\\n\\n\\nSQL or NoSQL ....................................................................\", \"....................................................................................................\", \" 77\\n\\n\\nAzure Cosmos DB ..............................................................................\", \"................................................................................... 78\\n\\n\\nOther persi\", \"stence options .....................................................................................\", \"............................................................ 79\\n\\n\\nCaching ..........................\", \"....................................................................................................\", \"....................................................... 80\\n\\n\\nASP.NET Core response caching .........\", \"....................................................................................................\", \"................... 80\\n\\n\\nData caching ..............................................................\", \"....................................................................................................\", \".... 81\\n\\n\\nGetting data to Blazor WebAssembly apps ..................................................\", \".............................................................. 83\\n\\n\\n**Test ASP.NET Core MVC apps ...\", \"........................................................................................... 85**\\n\\n\\nK\", \"inds of automated tests ............................................................................\", \"....................................................................... 85\\n\\n\\nUnit tests ............\", \"....................................................................................................\", \".............................................................. 85\\n\\n\\nIntegration tests ..............\", \"....................................................................................................\", \".............................................. 85\\n\\n\\nFunctional tests ...............................\", \"....................................................................................................\", \".............................. 86\\n\\n\\nTesting Pyramid ................................................\", \"....................................................................................................\", \"............ 86\\n\\n\\nWhat to test .....................................................................\", \"................................................................................................... \", \"87\\n\\n\\nOrganizing test projects ......................................................................\", \"............................................................................... 88\\n\\n\\nTest naming ...\", \"....................................................................................................\", \"................................................................. 89\\n\\n\\nUnit testing ASP.NET Core app\", \"s ..................................................................................................\", \"................................... 91\\n\\n\\nIntegration testing ASP.NET Core apps .....................\", \".................................................................................................. 9\", \"2\\n\\n\\nFunctional testing ASP.NET Core apps ...........................................................\", \".............................................................. 92\\n\\n\\nReferences \\u2013 Test ASP.NET Core M\", \"VC apps ............................................................................................\", \".............. 95\\n\\n\\n**Development process for Azure ................................................\", \".......................................... 96**\\n\\n\\nVision ...........................................\", \"....................................................................................................\", \".......................................... 96\\n\\n\\nDevelopment environment for ASP.NET Core apps ......\", \"......................................................................................... 96\\n\\n\\nDevel\", \"opment tools choices: IDE or editor ................................................................\", \".............................................. 96\\n\\n\\nDevelopment workflow for Azure-hosted ASP.NET Co\", \"re apps .......................................................................... 97\\n\\n\\nInitial setu\", \"p ..................................................................................................\", \"....................................................................... 97\\n\\n\\nWorkflow for developing\", \" Azure-hosted ASP.NET Core applications .......................................................... 9\", \"8\\n\\n\\nReferences .....................................................................................\", \"........................................................................................ 100\\n\\n\\niv Co\", \"ntents\\n\\n\\n**Azure hosting recommendations for ASP.NET Core web apps .................................\", \"..... 101**\\n\\n\\nWeb applications .....................................................................\", \"........................................................................................... 101\\n\\n\\nAp\", \"p Service Web Apps .................................................................................\", \"............................................................... 101\\n\\n\\nApp Service Web Apps for Conta\", \"iners ..............................................................................................\", \".................... 103\\n\\n\\nAzure Kubernetes Service ................................................\", \"........................................................................................... 106\\n\\n\\nAz\", \"ure Virtual Machines ...............................................................................\", \"................................................................. 107\\n\\n\\nLogical processes ..........\", \"....................................................................................................\", \".................................................. 107\\n\\n\\nData ......................................\", \"....................................................................................................\", \"................................................ 107\\n\\n\\nArchitecture recommendations ................\", \"....................................................................................................\", \"................. 108\\n\\n\\nv Contents\\n\\n\\n**CHAPTER**\\n# 1\\n\\n## Characteristics of Modern Web Applications\\n\", \"\\n\\n\\u201c\\u2026 with proper design, the features come cheaply. This approach is arduous, but continues to\\nsucce\", \"ed.\\u201d\\n\\n_- Dennis Ritchie_\\n\\n\\nModern web applications have higher user expectations and greater demands\", \" than ever before.\\nToday\\u2019s web apps are expected to be available 24/7 from anywhere in the world, an\", \"d usable from\\nvirtually any device or screen size. Web applications must be secure, flexible, and sc\", \"alable to meet\\nspikes in demand. Increasingly, complex scenarios should be handled by rich user expe\", \"riences built on\\nthe client using JavaScript, and communicating efficiently through web APIs.\\n\\n\\nASP.\", \"NET Core is optimized for modern web applications and cloud-based hosting scenarios. Its\\nmodular des\", \"ign enables applications to depend on only those features they actually use, improving\\napplication s\", \"ecurity and performance while reducing hosting resource requirements.\\n\\n### Reference application: eS\", \"hopOnWeb\\n\\n\\nThis guidance includes a reference application, _eShopOnWeb_, that demonstrates some of t\", \"he\\nprinciples and recommendations. The application is a simple online store, which supports browsing\", \"\\nthrough a catalog of shirts, coffee mugs, and other marketing items. The reference application is\\nd\", \"eliberately simple in order to make it easy to understand.\\n\\n\\n1 CHAPTER 1 | Characteristics of Modern\", \" Web Applications\\n\\n\\n_Figure 2-1. eShopOnWeb_\\n\\n#### **Reference Application**\\n\\n\\n  - **eShopOnWeb**\\n[h\", \"ttps://github.com/dotnet/eShopOnWeb](https://github.com/dotnet/eShopOnWeb)\\n\\n### Cloud-hosted and sca\", \"lable\\n\\n\\nASP.NET Core is optimized for the cloud (public cloud, private cloud, any cloud) because it \", \"is lowmemory and high-throughput. The smaller footprint of ASP.NET Core applications means you can\\nh\", \"ost more of them on the same hardware, and you pay for fewer resources when using pay-as-yougo cloud\", \" hosting services. The higher-throughput means you can serve more customers from an\\napplication give\", \"n the same hardware, further reducing the need to invest in servers and hosting\\ninfrastructure.\\n\\n###\", \" Cross platform\\n\\n\\nASP.NET Core is cross-platform and can run on Linux, macOS, and Windows. This capa\", \"bility opens up\\nmany new options for both the development and deployment of apps built with ASP.NET \", \"Core.\\n\\n\\n2 CHAPTER 1 | Characteristics of Modern Web Applications\\n\\n\\nDocker containers - both Linux an\", \"d Windows - can host ASP.NET Core applications, allowing them to\\n[take advantage of the benefits of \", \"containers and microservices.](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/)\\n\", \"\\n### Modular and loosely coupled\\n\\n\\nNuGet packages are first-class citizens in .NET Core, and ASP.NET\", \" Core apps are composed of many\\nlibraries through NuGet. This granularity of functionality helps ens\", \"ure apps only depend on and\\ndeploy functionality they actually require, reducing their footprint and\", \" security vulnerability surface\\narea.\\n\\n\\n[ASP.NET Core also fully supports dependency injection, both\", \" internally and at the application level.](https://deviq.com/dependency-injection/)\\nInterfaces can h\", \"ave multiple implementations that can be swapped out as needed. Dependency\\ninjection allows apps to \", \"loosely couple to those interfaces, rather than specific implementations,\\nmaking them easier to exte\", \"nd, maintain, and test.\\n\\n### Easily tested with automated tests\\n\\n\\nASP.NET Core applications support \", \"unit testing, and their loose coupling and support for dependency\\ninjection makes it easy to swap in\", \"frastructure concerns with fake implementations for test purposes.\\nASP.NET Core also ships with a Te\", \"stServer that can be used to host apps in memory. Functional tests\\ncan then make requests to this in\", \"-memory server, exercising the full application stack (including\\nmiddleware, routing, model binding,\", \" filters, etc.) and receiving a response, all in a fraction of the time\\nit would take to host the ap\", \"p on a real server and make requests through the network layer. These\\ntests are especially easy to w\", \"rite, and valuable, for APIs, which are increasingly important in modern\\nweb applications.\\n\\n### Trad\", \"itional and SPA behaviors supported\\n\\n\\nTraditional web applications have involved little client-side \", \"behavior, but instead have relied on the\\nserver for all navigation, queries, and updates the app mig\", \"ht need to make. Each new operation made\\nby the user would be translated into a new web request, wit\", \"h the result being a full page reload in the\\nend user\\u2019s browser. Classic Model-View-Controller (MVC)\", \" frameworks typically follow this approach,\\nwith each new request corresponding to a different contr\", \"oller action, which in turn would work with a\\nmodel and return a view. Some individual operations on\", \" a given page might be enhanced with AJAX\\n(Asynchronous JavaScript and XML) functionality, but the o\", \"verall architecture of the app used many\\ndifferent MVC views and URL endpoints. In addition, ASP.NET\", \" Core MVC also supports Razor Pages, a\\nsimpler way to organize MVC-style pages.\\n\\n\\nSingle Page Applic\", \"ations (SPAs), by contrast, involve very few dynamically generated server-side page\\nloads (if any). \", \"Many SPAs are initialized within a static HTML file that loads the necessary JavaScript\\nlibraries to\", \" start and run the app. These apps make heavy usage of web APIs for their data needs and\\ncan provide\", \" much richer user experiences. Blazor WebAssembly provides a means of building SPAs\\nusing .NET code,\", \" which then runs in the client\\u2019s browser.\\n\\n\\n3 CHAPTER 1 | Characteristics of Modern Web Applications\", \"\\n\\n\\nMany web applications involve a combination of traditional web application behavior (typically fo\", \"r\\ncontent) and SPAs (for interactivity). ASP.NET Core supports both MVC (Views or Page based) and we\", \"b\\nAPIs in the same application, using the same set of tools and underlying framework libraries.\\n\\n###\", \" Simple development and deployment\\n\\n\\nASP.NET Core applications can be written using simple text edit\", \"ors and command-line interfaces, or\\nfull-featured development environments like Visual Studio. Monol\", \"ithic applications are typically\\ndeployed to a single endpoint. Deployments can easily be automated \", \"to occur as part of a continuous\\nintegration (CI) and continuous delivery (CD) pipeline. In addition\", \" to traditional CI/CD tools, Microsoft\\nAzure has integrated support for git repositories and can aut\", \"omatically deploy updates as they are\\nmade to a specified git branch or tag. Azure DevOps provides a\", \" full-featured CI/CD build and\\ndeployment pipeline, and GitHub Actions provide another option for pr\", \"ojects hosted there.\\n\\n### Traditional ASP.NET and Web Forms\\n\\n\\nIn addition to ASP.NET Core, tradition\", \"al ASP.NET 4.x continues to be a robust and reliable platform for\\nbuilding web applications. ASP.NET\", \" supports MVC and Web API development models, as well as Web\\nForms, which is well suited to rich pag\", \"e-based application development and features a rich third-party\\ncomponent ecosystem. Microsoft Azure\", \" has great longstanding support for ASP.NET 4.x applications,\\nand many developers are familiar with \", \"this platform.\\n\\n### Blazor\\n\\n\\nBlazor is included with ASP.NET Core 3.0 and later. It provides a new m\", \"echanism for building rich\\ninteractive web client applications using Razor, C#, and ASP.NET Core. It\", \" offers another solution to\\nconsider when developing modern web applications. There are two versions\", \" of Blazor to consider:\\nserver-side and client-side.\\n\\n\\nServer-side Blazor was released in 2019 with \", \"ASP.NET Core 3.0. As its name implies, it runs on the\\nserver, rendering changes to the client docume\", \"nt back to the browser over the network. Server-side\\nBlazor provides a rich client experience withou\", \"t requiring client-side JavaScript and without requiring\\nseparate page loads for each client page in\", \"teraction. Changes in the loaded page are requested from\\nand processed by the server and then sent b\", \"ack to the client using SignalR.\\n\\n\\nClient-side Blazor, released in 2020, eliminates the need to rend\", \"er changes on the server. Instead, it\\nleverages WebAssembly to run .NET code within the client. The \", \"client can still make API calls to the\\nserver if needed to request data, but all client-side behavio\", \"r runs in the client via WebAssembly, which\\nis already supported by all major browsers and is just a\", \" JavaScript library.\\n\\n#### **References \\u2013 Modern Web Applications**\\n\\n\\n  - **Introduction to ASP.NET \", \"Core**\\n[https://learn.microsoft.com/aspnet/core/](https://docs.microsoft.com/aspnet/core/)\\n\\n\\n4 CHAPT\", \"ER 1 | Characteristics of Modern Web Applications\\n\\n\\n  - **Testing in ASP.NET Core**\\n[https://learn.m\", \"icrosoft.com/aspnet/core/testing/](https://docs.microsoft.com/aspnet/core/testing/)\\n\\n  - **Blazor - \", \"Get Started**\\n[https://blazor.net/docs/get-started.html](https://blazor.net/docs/get-started.html)\\n\\n\", \"\\n5 CHAPTER 1 | Characteristics of Modern Web Applications\\n\\n\\n**CHAPTER**\\n# 2\\n\\n## Choose Between Tradi\", \"tional Web Apps and Single Page Apps (SPAs)\\n\\n\\n\\u201cAtwood\\u2019s Law: Any application that can be written in \", \"JavaScript, will eventually be written in\\nJavaScript.\\u201d\\n\\n_- Jeff Atwood_\\n\\n\\nThere are two general appr\", \"oaches to building web applications today: traditional web applications\\nthat perform most of the app\", \"lication logic on the server, and single-page applications (SPAs) that\\nperform most of the user inte\", \"rface logic in a web browser, communicating with the web server\\nprimarily using web APIs. A hybrid a\", \"pproach is also possible, the simplest being host one or more rich\\nSPA-like subapplications within a\", \" larger traditional web application.\\n\\n\\nUse traditional web applications when:\\n\\n\\n  - Your application\", \"\\u2019s client-side requirements are simple or even read-only.\\n\\n\\n  - Your application needs to function i\", \"n browsers without JavaScript support.\\n\\n\\n  - Your application is public-facing and benefits from sea\", \"rch engine discovery and referrals.\\n\\n\\nUse a SPA when:\\n\\n\\n  - Your application must expose a rich user\", \" interface with many features.\\n\\n\\n  - Your team is familiar with JavaScript, TypeScript, or Blazor We\", \"bAssembly development.\\n\\n\\n  - Your application must already expose an API for other (internal or publ\", \"ic) clients.\\n\\n\\nAdditionally, SPA frameworks require greater architectural and security expertise. Th\", \"ey experience\\ngreater churn due to frequent updates and new client frameworks than traditional web a\", \"pplications.\\nConfiguring automated build and deployment processes and utilizing deployment options l\", \"ike\\ncontainers may be more difficult with SPA applications than traditional web apps.\\n\\n\\nImprovements\", \" in user experience made possible by the SPA approach must be weighed against these\\nconsiderations.\\n\", \"\\n\\n6 CHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs)\\n\\n\\n### Blazor\\n\\nASP.NE\", \"T Core includes a model for building rich, interactive, and composable user interfaces called\\nBlazor\", \". Blazor server-side allows developers to build UI with C# and Razor on the server and for the UI\\nto\", \" be interactively connected to the browser in real-time using a persistent SignalR connection. Blazo\", \"r\\nWebAssembly introduces another option for Blazor apps, allowing them to run in the browser using\\nW\", \"ebAssembly. Because it\\u2019s real .NET code running on WebAssembly, you can reuse code and libraries\\nfro\", \"m server-side parts of your application.\\n\\n\\nBlazor provides a new, third option to consider when eval\", \"uating whether to build a purely serverrendered web application or a SPA. You can build rich, SPA-li\", \"ke client-side behaviors using Blazor,\\nwithout the need for significant JavaScript development. Blaz\", \"or applications can call APIs to request\\ndata or perform server-side operations. They can interopera\", \"te with JavaScript where necessary to take\\nadvantage of JavaScript libraries and frameworks.\\n\\n\\nConsi\", \"der building your web application with Blazor when:\\n\\n\\n  - Your application must expose a rich user i\", \"nterface\\n\\n\\n  - Your team is more comfortable with .NET development than JavaScript or TypeScript\\ndev\", \"elopment\\n\\n\\nIf you have an existing web forms application you\\u2019re considering migrating to .NET Core o\", \"r the latest\\n[.NET, you may wish to review the free e-book, Blazor for Web Forms Developers](https:/\", \"/docs.microsoft.com/en-us/dotnet/architecture/blazor-for-web-forms-developers/) to see whether it\\nma\", \"kes sense to consider migrating it to Blazor.\\n\\n\\n[For more information about Blazor, see Get started \", \"with Blazor.](https://blazor.net/docs/get-started.html)\\n\\n### When to choose traditional web apps\\n\\n\\nT\", \"he following section is a more detailed explanation of the previously stated reasons for picking\\ntra\", \"ditional web applications.\\n\\n\\n**Your application has simple, possibly read-only, client-side requirem\", \"ents**\\n\\n\\nMany web applications are primarily consumed in a read-only fashion by the vast majority of\", \" their\\nusers. Read-only (or read-mostly) applications tend to be much simpler than those application\", \"s that\\nmaintain and manipulate a great deal of state. For example, a search engine might consist of \", \"a single\\nentry point with a textbox and a second page for displaying search results. Anonymous users\", \" can\\neasily make requests, and there is little need for client-side logic. Likewise, a blog or conte\", \"nt\\nmanagement system\\u2019s public-facing application usually consists mainly of content with little clie\", \"ntside behavior. Such applications are easily built as traditional server-based web applications, wh\", \"ich\\nperform logic on the web server and render HTML to be displayed in the browser. The fact that ea\", \"ch\\nunique page of the site has its own URL that can be bookmarked and indexed by search engines (by\\n\", \"default, without having to add this functionality as a separate feature of the application) is also \", \"a clear\\nbenefit in such scenarios.\\n\\n\\n**Your application needs to function in browsers without JavaSc\", \"ript support**\\n\\n\\n7 CHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs)\\n\\n\\nWeb\", \" applications that need to function in browsers with limited or no JavaScript support should be\\nwrit\", \"ten using traditional web app workflows (or at least be able to fall back to such behavior). SPAs\\nre\", \"quire client-side JavaScript in order to function; if it\\u2019s not available, SPAs are not a good choice\", \".\\n\\n\\n**Your team is unfamiliar with JavaScript or TypeScript development techniques**\\n\\n\\nIf your team \", \"is unfamiliar with JavaScript or TypeScript, but is familiar with server-side web application\\ndevelo\", \"pment, then they will probably be able to deliver a traditional web app more quickly than a\\nSPA. Unl\", \"ess learning to program SPAs is a goal, or the user experience afforded by a SPA is required,\\ntradit\", \"ional web apps are a more productive choice for teams who are already familiar with building\\nthem.\\n\\n\", \"### When to choose SPAs\\n\\n\\nThe following section is a more detailed explanation of when to choose a S\", \"ingle Page Applications\\nstyle of development for your web app.\\n\\n\\n**Your application must expose a ri\", \"ch user interface with many features**\\n\\n\\nSPAs can support rich client-side functionality that doesn\\u2019\", \"t require reloading the page as users take\\nactions or navigate between areas of the app. SPAs can lo\", \"ad more quickly, fetching data in the\\nbackground, and individual user actions are more responsive si\", \"nce full page reloads are rare. SPAs can\\nsupport incremental updates, saving partially completed for\", \"ms or documents without the user having\\nto click a button to submit a form. SPAs can support rich cl\", \"ient-side behaviors, such as drag-and-drop,\\nmuch more readily than traditional applications. SPAs ca\", \"n be designed to run in a disconnected mode,\\nmaking updates to a client-side model that are eventual\", \"ly synchronized back to the server once a\\nconnection is re-established. Choose a SPA-style applicati\", \"on if your app\\u2019s requirements include rich\\nfunctionality that goes beyond what typical HTML forms of\", \"fer.\\n\\n\\nFrequently, SPAs need to implement features that are built into traditional web apps, such as\", \"\\ndisplaying a meaningful URL in the address bar reflecting the current operation (and allowing users\", \" to\\nbookmark or deep link to this URL to return to it). SPAs also should allow users to use the brow\", \"ser\\u2019s\\nback and forward buttons with results that won\\u2019t surprise them.\\n\\n\\n**Your team is familiar with\", \" JavaScript and/or TypeScript development**\\n\\n\\nWriting SPAs requires familiarity with JavaScript and/\", \"or TypeScript and client-side programming\\ntechniques and libraries. Your team should be competent in\", \" writing modern JavaScript using a SPA\\nframework like Angular.\\n\\n#### **References \\u2013 SPA Frameworks**\", \"\\n\\n\\n  - **Angular** [: https://angular.io](https://angular.io/)\\n\\n  - **React** [: https://reactjs.org\", \"/](https://reactjs.org/)\\n\\n  - **Vue.js** [: https://vuejs.org/](https://vuejs.org/)\\n\\n\\n**Your applica\", \"tion must already expose an API for other (internal or public) clients**\\n\\n\\n8 CHAPTER 2 | Choose Betw\", \"een Traditional Web Apps and Single Page Apps (SPAs)\\n\\n\\nIf you\\u2019re already supporting a web API for us\", \"e by other clients, it may require less effort to create a\\nSPA implementation that leverages these A\", \"PIs rather than reproducing the logic in server-side form.\\nSPAs make extensive use of web APIs to qu\", \"ery and update data as users interact with the application.\\n\\n### When to choose Blazor\\n\\n\\nThe followi\", \"ng section is a more detailed explanation of when to choose Blazor for your web app.\\n\\n\\n**Your applic\", \"ation must expose a rich user interface**\\n\\n\\nLike JavaScript-based SPAs, Blazor applications can supp\", \"ort rich client behavior without page reloads.\\nThese applications are more responsive to users, fetc\", \"hing only the data (or HTML) required to respond\\nto a given user interaction. Designed properly, ser\", \"ver-side Blazor apps can be configured to run as\\nclient-side Blazor apps with minimal changes once t\", \"his feature is supported.\\n\\n\\n**Your team is more comfortable with .NET development than JavaScript or\", \" TypeScript**\\n**development**\\n\\n\\nMany developers are more productive with .NET and Razor than with cl\", \"ient-side languages like\\nJavaScript or TypeScript. Since the server-side of the application is alrea\", \"dy being developed with .NET,\\nusing Blazor ensures every .NET developer on the team can understand a\", \"nd potentially build the\\nbehavior of the front end of the application.\\n\\n### Decision table\\n\\n\\nThe fol\", \"lowing decision table summarizes some of the basic factors to consider when choosing\\nbetween a tradi\", \"tional web application, a SPA, or a Blazor app.\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n|Factor|Traditional Web<br>App|Single\", \" Page<br>Application|Blazor<br>App|\\n|---|---|---|---|\\n|Required Team Familiarity with<br>JavaScript/\", \"TypeScript|**Minimal**|**Required**|**Minimal**|\\n|Support Browsers without Scripting|**Supported**|*\", \"*Not Supported**|**Supporte**<br>**d**|\\n|Minimal Client-Side Application Behavior|**Well-Suited**|**\", \"Overkill**|**Viable**|\\n|Rich, Complex User Interface<br>Requirements|**Limited**|**Well-Suited**|**W\", \"ell-**<br>**Suited**|\\n\\n### Other considerations\\n\\n\\n\\n\\n\\nTraditional Web Apps tend to be simpler and hav\", \"e better Search Engine Optimization (SEO) criteria\\nthan SPA apps. Search engine bots can easily cons\", \"ume content from traditional apps, while support\\nfor indexing SPAs may be lacking or limited. If you\", \"r app benefits from public discovery by search\\nengines, this is often an important consideration.\\n\\n\\n\", \"9 CHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs)\\n\\n\\nIn addition, unless \", \"you\\u2019ve built a management tool for your SPA\\u2019s content, it may require developers\\nto make changes. Tr\", \"aditional Web Apps are often easier for non-developers to make changes to, since\\nmuch of the content\", \" is simply HTML and may not require a build process to preview or even deploy. If\\nnon-developers in \", \"your organization are likely to need to maintain the content of the app, a\\ntraditional web app may b\", \"e a better choice.\\n\\n\\nSPAs shine when the app has complex interactive forms or other user interaction\", \" features. For\\ncomplex apps that require authentication to use, and thus aren\\u2019t accessible by public\", \" search engine\\nspiders, SPAs are a great option in many cases.\\n\\n\\n10 CHAPTER 2 | Choose Between Tradi\", \"tional Web Apps and Single Page Apps (SPAs)\\n\\n\\n**CHAPTER**\\n# 3\\n\\n## Architectural principles\\n\\n\\n\\u201cIf bui\", \"lders built buildings the way programmers wrote programs, then the first woodpecker that\\ncame along \", \"would destroy civilization.\\u201d\\n\\n_- Gerald Weinberg_\\n\\n\\nYou should architect and design software solutio\", \"ns with maintainability in mind. The principles\\noutlined in this section can help guide you toward a\", \"rchitectural decisions that will result in clean,\\nmaintainable applications. Generally, these princi\", \"ples will guide you toward building applications out\\nof discrete components that are not tightly cou\", \"pled to other parts of your application, but rather\\ncommunicate through explicit interfaces or messa\", \"ging systems.\\n\\n### Common design principles\\n\\n#### **Separation of concerns**\\n\\n\\nA guiding principle w\", \"hen developing is **Separation of Concerns** . This principle asserts that software\\nshould be separa\", \"ted based on the kinds of work it performs. For instance, consider an application that\\nincludes logi\", \"c for identifying noteworthy items to display to the user, and which formats such items in\\na particu\", \"lar way to make them more noticeable. The behavior responsible for choosing which items to\\nformat sh\", \"ould be kept separate from the behavior responsible for formatting the items, since these\\nbehaviors \", \"are separate concerns that are only coincidentally related to one another.\\n\\n\\nArchitecturally, applic\", \"ations can be logically built to follow this principle by separating core business\\nbehavior from inf\", \"rastructure and user-interface logic. Ideally, business rules and logic should reside in\\na separate \", \"project, which should not depend on other projects in the application. This separation\\nhelps ensure \", \"that the business model is easy to test and can evolve without being tightly coupled to\\nlow-level im\", \"plementation details (it also helps if infrastructure concerns depend on abstractions\\ndefined in the\", \" business layer). Separation of concerns is a key consideration behind the use of layers\\nin applicat\", \"ion architectures.\\n\\n#### **Encapsulation**\\n\\n\\nDifferent parts of an application should use **encapsul\", \"ation** to insulate them from other parts of the\\napplication. Application components and layers shou\", \"ld be able to adjust their internal implementation\\nwithout breaking their collaborators as long as e\", \"xternal contracts are not violated. Proper use of\\nencapsulation helps achieve loose coupling and mod\", \"ularity in application designs, since objects and\\npackages can be replaced with alternative implemen\", \"tations so long as the same interface is\\nmaintained.\\n\\n\\n11 CHAPTER 3 | Architectural principles\\n\\n\\nIn \", \"classes, encapsulation is achieved by limiting outside access to the class\\u2019s internal state. If an\\no\", \"utside actor wants to manipulate the state of the object, it should do so through a well-defined\\nfun\", \"ction (or property setter), rather than having direct access to the private state of the object.\\nLik\", \"ewise, application components and applications themselves should expose well-defined interfaces\\nfor \", \"their collaborators to use, rather than allowing their state to be modified directly. This approach\\n\", \"frees the application\\u2019s internal design to evolve over time without worrying that doing so will brea\", \"k\\ncollaborators, so long as the public contracts are maintained.\\n\\n\\nMutable global state is antitheti\", \"cal to encapsulation. A value fetched from mutable global state in one\\nfunction cannot be relied upo\", \"n to have the same value in another function (or even further in the\\nsame function). Understanding c\", \"oncerns with mutable global state is one of the reasons programming\\nlanguages like C# have support f\", \"or different scoping rules, which are used everywhere from\\nstatements to methods to classes. It\\u2019s wo\", \"rth noting that data-driven architectures which rely on a\\ncentral database for integration within an\", \"d between applications are, themselves, choosing to depend\\non the mutable global state represented b\", \"y the database. A key consideration in domain-driven\\ndesign and clean architecture is how to encapsu\", \"late access to data, and how to ensure application\\nstate is not made invalid by direct access to its\", \" persistence format.\\n\\n#### **Dependency inversion**\\n\\n\\nThe direction of dependency within the applica\", \"tion should be in the direction of abstraction, not\\nimplementation details. Most applications are wr\", \"itten such that compile-time dependency flows in the\\ndirection of runtime execution, producing a dir\", \"ect dependency graph. That is, if class A calls a method\\nof class B and class B calls a method of cl\", \"ass C, then at compile time class A will depend on class B,\\nand class B will depend on class C, as s\", \"hown in Figure 4-1.\\n\\n\\n12 CHAPTER 3 | Architectural principles\\n\\n\\n_Figure 4-1. Direct dependency graph\", \"._\\n\\n\\nApplying the dependency inversion principle allows A to call methods on an abstraction that B\\ni\", \"mplements, making it possible for A to call B at run time, but for B to depend on an interface\\ncontr\", \"olled by A at compile time (thus, _inverting_ the typical compile-time dependency). At run time, the\", \"\\nflow of program execution remains unchanged, but the introduction of interfaces means that differen\", \"t\\nimplementations of these interfaces can easily be plugged in.\\n\\n\\n13 CHAPTER 3 | Architectural princ\", \"iples\\n\\n\\n_Figure 4-2. Inverted dependency graph._\\n\\n\\n**Dependency inversion** is a key part of buildin\", \"g loosely coupled applications, since implementation\\ndetails can be written to depend on and impleme\", \"nt higher-level abstractions, rather than the other\\nway around. The resulting applications are more \", \"testable, modular, and maintainable as a result. The\\npractice of _dependency injection_ is made poss\", \"ible by following the dependency inversion principle.\\n\\n#### **Explicit dependencies**\\n\\n\\n**Methods an\", \"d classes should explicitly require any collaborating objects they need in order to**\\n**function cor\", \"rectly.** [It is called the Explicit Dependencies Principle. Class constructors provide an](https://\", \"deviq.com/principles/explicit-dependencies-principle)\\nopportunity for classes to identify the things\", \" they need in order to be in a valid state and to function\\nproperly. If you define classes that can \", \"be constructed and called, but that will only function properly\\nif certain global or infrastructure \", \"components are in place, these classes are being _dishonest_ with their\\nclients. The constructor con\", \"tract is telling the client that it only needs the things specified (possibly\\nnothing if the class i\", \"s just using a parameterless constructor), but then at runtime it turns out the\\nobject really did ne\", \"ed something else.\\n\\n\\nBy following the explicit dependencies principle, your classes and methods are \", \"being honest with their\\nclients about what they need in order to function. Following the principle m\", \"akes your code more selfdocumenting and your coding contracts more user-friendly, since users will c\", \"ome to trust that as long\\nas they provide what\\u2019s required in the form of method or constructor param\", \"eters, the objects they\\u2019re\\nworking with will behave correctly at run time.\\n\\n#### **Single responsibi\", \"lity**\\n\\n\\nThe single responsibility principle applies to object-oriented design, but can also be cons\", \"idered as an\\narchitectural principle similar to separation of concerns. It states that objects shoul\", \"d have only one\\nresponsibility and that they should have only one reason to change. Specifically, th\", \"e only situation in\\nwhich the object should change is if the manner in which it performs its one res\", \"ponsibility must be\\n\\n\\n14 CHAPTER 3 | Architectural principles\\n\\n\\nupdated. Following this principle he\", \"lps to produce more loosely coupled and modular systems, since\\nmany kinds of new behavior can be imp\", \"lemented as new classes, rather than by adding additional\\nresponsibility to existing classes. Adding\", \" new classes is always safer than changing existing classes,\\nsince no code yet depends on the new cl\", \"asses.\\n\\n\\nIn a monolithic application, we can apply the single responsibility principle at a high lev\", \"el to the layers\\nin the application. Presentation responsibility should remain in the UI project, wh\", \"ile data access\\nresponsibility should be kept within an infrastructure project. Business logic shoul\", \"d be kept in the\\napplication core project, where it can be easily tested and can evolve independentl\", \"y from other\\nresponsibilities.\\n\\n\\nWhen this principle is applied to application architecture and take\", \"n to its logical endpoint, you get\\nmicroservices. A given microservice should have a single responsi\", \"bility. If you need to extend the\\nbehavior of a system, it\\u2019s usually better to do it by adding addit\", \"ional microservices, rather than by\\nadding responsibility to an existing one.\\n\\n\\n[Learn more about mi\", \"croservices architecture](https://aka.ms/MicroservicesEbook)\\n\\n#### **Don\\u2019t repeat yourself (DRY)**\\n\\n\", \"\\nThe application should avoid specifying behavior related to a particular concept in multiple places\", \" as\\nthis practice is a frequent source of errors. At some point, a change in requirements will requi\", \"re\\nchanging this behavior. It\\u2019s likely that at least one instance of the behavior will fail to be up\", \"dated, and\\nthe system will behave inconsistently.\\n\\n\\nRather than duplicating logic, encapsulate it in\", \" a programming construct. Make this construct the\\nsingle authority over this behavior, and have any \", \"other part of the application that requires this\\nbehavior use the new construct.\\n\\n\\n\\n\\n#### **Persiste\", \"nce ignorance**\\n\\n**Persistence ignorance** (PI) refers to types that need to be persisted, but whose\", \" code is unaffected by\\nthe choice of persistence technology. Such types in .NET are sometimes referr\", \"ed to as Plain Old CLR\\nObjects (POCOs), because they do not need to inherit from a particular base c\", \"lass or implement a\\nparticular interface. Persistence ignorance is valuable because it allows the sa\", \"me business model to be\\npersisted in multiple ways, offering additional flexibility to the applicati\", \"on. Persistence choices might\\nchange over time, from one database technology to another, or addition\", \"al forms of persistence might\\nbe required in addition to whatever the application started with (for \", \"example, using a Redis cache or\\nAzure Cosmos DB in addition to a relational database).\\n\\n\\nSome exampl\", \"es of violations of this principle include:\\n\\n\\n15 CHAPTER 3 | Architectural principles\\n\\n\\n  - A requir\", \"ed base class.\\n\\n\\n  - A required interface implementation.\\n\\n\\n  - Classes responsible for saving thems\", \"elves (such as the Active Record pattern).\\n\\n\\n  - Required parameterless constructor.\\n\\n\\n  - Propertie\", \"s requiring virtual keyword.\\n\\n\\n  - Persistence-specific required attributes.\\n\\n\\nThe requirement that \", \"classes have any of the above features or behaviors adds coupling between the\\ntypes to be persisted \", \"and the choice of persistence technology, making it more difficult to adopt new\\ndata access strategi\", \"es in the future.\\n\\n#### **Bounded contexts**\\n\\n\\n**Bounded contexts** are a central pattern in Domain-\", \"Driven Design. They provide a way of tackling\\ncomplexity in large applications or organizations by b\", \"reaking it up into separate conceptual modules.\\nEach conceptual module then represents a context tha\", \"t is separated from other contexts (hence,\\nbounded), and can evolve independently. Each bounded cont\", \"ext should ideally be free to choose its\\nown names for concepts within it, and should have exclusive\", \" access to its own persistence store.\\n\\n\\nAt a minimum, individual web applications should strive to b\", \"e their own bounded context, with their\\nown persistence store for their business model, rather than \", \"sharing a database with other applications.\\nCommunication between bounded contexts occurs through pr\", \"ogrammatic interfaces, rather than\\nthrough a shared database, which allows for business logic and ev\", \"ents to take place in response to\\nchanges that take place. Bounded contexts map closely to microserv\", \"ices, which also are ideally\\nimplemented as their own individual bounded contexts.\\n\\n### Additional r\", \"esources\\n\\n\\n  - [Principles](https://deviq.com/principles/principles-overview)\\n\\n  - [Bounded Context]\", \"(https://martinfowler.com/bliki/BoundedContext.html)\\n\\n\\n16 CHAPTER 3 | Architectural principles\\n\\n\\n**C\", \"HAPTER**\\n# 4\\n\\n## Common web application architectures\\n\\n\\n\\u201cIf you think good architecture is expensive\", \", try bad architecture.\\u201d _- Brian Foote and Joseph Yoder_\\n\\n\\nMost traditional .NET applications are d\", \"eployed as single units corresponding to an executable or a\\nsingle web application running within a \", \"single IIS appdomain. This approach is the simplest\\ndeployment model and serves many internal and sm\", \"aller public applications very well. However, even\\ngiven this single unit of deployment, most non-tr\", \"ivial business applications benefit from some logical\\nseparation into several layers.\\n\\n### What is a\", \" monolithic application?\\n\\n\\nA monolithic application is one that is entirely self-contained, in terms\", \" of its behavior. It may interact\\nwith other services or data stores in the course of performing its\", \" operations, but the core of its\\nbehavior runs within its own process and the entire application is \", \"typically deployed as a single unit. If\\nsuch an application needs to scale horizontally, typically t\", \"he entire application is duplicated across\\nmultiple servers or virtual machines.\\n\\n### All-in-one app\", \"lications\\n\\n\\nThe smallest possible number of projects for an application architecture is one. In this\", \" architecture, the\\nentire logic of the application is contained in a single project, compiled to a s\", \"ingle assembly, and\\ndeployed as a single unit.\\n\\n\\nA new ASP.NET Core project, whether created in Visu\", \"al Studio or from the command line, starts out as\\na simple \\u201call-in-one\\u201d monolith. It contains all of\", \" the behavior of the application, including\\npresentation, business, and data access logic. Figure 5-\", \"1 shows the file structure of a single-project\\napp.\\n\\n\\n17 CHAPTER 4 | Common web application architec\", \"tures\\n\\n\\n_Figure 5-1. A single project ASP.NET Core app._\\n\\n\\nIn a single project scenario, separation \", \"of concerns is achieved through the use of folders. The default\\ntemplate includes separate folders f\", \"or MVC pattern responsibilities of Models, Views, and Controllers,\\nas well as additional folders for\", \" Data and Services. In this arrangement, presentation details should be\\nlimited as much as possible \", \"to the Views folder, and data access implementation details should be\\nlimited to classes kept in the\", \" Data folder. Business logic should reside in services and classes within\\nthe Models folder.\\n\\n\\nAltho\", \"ugh simple, the single-project monolithic solution has some disadvantages. As the project\\u2019s size\\nand\", \" complexity grows, the number of files and folders will continue to grow as well. User interface (UI\", \")\\nconcerns (models, views, controllers) reside in multiple folders, which aren\\u2019t grouped together\\nal\", \"phabetically. This issue only gets worse when additional UI-level constructs, such as Filters or\\nMod\", \"elBinders, are added in their own folders. Business logic is scattered between the Models and\\nServic\", \"es folders, and there\\u2019s no clear indication of which classes in which folders should depend on\\n[whic\", \"h others. This lack of organization at the project level frequently leads to spaghetti code.](https:\", \"//deviq.com/spaghetti-code/)\\n\\n\\nTo address these issues, applications often evolve into multi-project\", \" solutions, where each project is\\nconsidered to reside in a particular _layer_ of the application.\\n\\n\", \"### What are layers?\\n\\n\\nAs applications grow in complexity, one way to manage that complexity is to b\", \"reak up the application\\naccording to its responsibilities or concerns. This approach follows the sep\", \"aration of concerns\\nprinciple and can help keep a growing codebase organized so that developers can \", \"easily find where\\ncertain functionality is implemented. Layered architecture offers a number of adva\", \"ntages beyond just\\ncode organization, though.\\n\\n\\n18 CHAPTER 4 | Common web application architectures\\n\", \"\\n\\nBy organizing code into layers, common low-level functionality can be reused throughout the\\napplic\", \"ation. This reuse is beneficial because it means less code needs to be written and because it can\\n[a\", \"llow the application to standardize on a single implementation, following the don\\u2019t repeat yourself]\", \"(https://en.wikipedia.org/wiki/Don%27t_repeat_yourself)\\n[(DRY)](https://en.wikipedia.org/wiki/Don%27\", \"t_repeat_yourself) principle.\\n\\n\\nWith a layered architecture, applications can enforce restrictions o\", \"n which layers can communicate\\nwith other layers. This architecture helps to achieve encapsulation. \", \"When a layer is changed or\\nreplaced, only those layers that work with it should be impacted. By limi\", \"ting which layers depend on\\nwhich other layers, the impact of changes can be mitigated so that a sin\", \"gle change doesn\\u2019t impact the\\nentire application.\\n\\n\\nLayers (and encapsulation) make it much easier t\", \"o replace functionality within the application. For\\nexample, an application might initially use its \", \"own SQL Server database for persistence, but later could\\nchoose to use a cloud-based persistence str\", \"ategy, or one behind a web API. If the application has\\nproperly encapsulated its persistence impleme\", \"ntation within a logical layer, that SQL Server-specific\\nlayer could be replaced by a new one implem\", \"enting the same public interface.\\n\\n\\nIn addition to the potential of swapping out implementations in \", \"response to future changes in\\nrequirements, application layers can also make it easier to swap out i\", \"mplementations for testing\\npurposes. Instead of having to write tests that operate against the real \", \"data layer or UI layer of the\\napplication, these layers can be replaced at test time with fake imple\", \"mentations that provide known\\nresponses to requests. This approach typically makes tests much easier\", \" to write and much faster to\\nrun when compared to running tests against the application\\u2019s real infra\", \"structure.\\n\\n\\nLogical layering is a common technique for improving the organization of code in enterp\", \"rise software\\napplications, and there are several ways in which code can be organized into layers.\\n\\n\", \"\\n\\n\\n### Traditional \\u201cN-Layer\\u201d architecture applications\\n\\nThe most common organization of application \", \"logic into layers is shown in Figure 5-2.\\n\\n\\n19 CHAPTER 4 | Common web application architectures\\n\\n\\n_F\", \"igure 5-2. Typical application layers._\\n\\n\\nThese layers are frequently abbreviated as UI, BLL (Busine\", \"ss Logic Layer), and DAL (Data Access Layer).\\nUsing this architecture, users make requests through t\", \"he UI layer, which interacts only with the BLL.\\nThe BLL, in turn, can call the DAL for data access r\", \"equests. The UI layer shouldn\\u2019t make any requests to\\nthe DAL directly, nor should it interact with p\", \"ersistence directly through other means. Likewise, the BLL\\nshould only interact with persistence by \", \"going through the DAL. In this way, each layer has its own\\nwell-known responsibility.\\n\\n\\nOne disadvan\", \"tage of this traditional layering approach is that compile-time dependencies run from\\nthe top to the\", \" bottom. That is, the UI layer depends on the BLL, which depends on the DAL. This\\nmeans that the BLL\", \", which usually holds the most important logic in the application, is dependent on\\ndata access imple\", \"mentation details (and often on the existence of a database). Testing business logic\\nin such an arch\", \"itecture is often difficult, requiring a test database. The dependency inversion principle\\ncan be us\", \"ed to address this issue, as you\\u2019ll see in the next section.\\n\\n\\nFigure 5-3 shows an example solution,\", \" breaking the application into three projects by responsibility\\n(or layer).\\n\\n\\n20 CHAPTER 4 | Common \", \"web application architectures\\n\\n\\n_Figure 5-3. A simple monolithic application with three projects._\\n\\n\", \"\\nAlthough this application uses several projects for organizational purposes, it\\u2019s still deployed as\", \" a\\nsingle unit and its clients will interact with it as a single web app. This allows for very simpl\", \"e\\ndeployment process. Figure 5-4 shows how such an app might be hosted using Azure.\\n\\n\\n_Figure 5-4. S\", \"imple deployment of Azure Web App_\\n\\n\\nAs application needs grow, more complex and robust deployment s\", \"olutions may be required. Figure\\n5-5 shows an example of a more complex deployment plan that support\", \"s additional capabilities.\\n\\n\\n21 CHAPTER 4 | Common web application architectures\\n\\n\\n_Figure 5-5. Depl\", \"oying a web app to an Azure App Service_\\n\\n\\nInternally, this project\\u2019s organization into multiple pro\", \"jects based on responsibility improves the\\nmaintainability of the application.\\n\\n\\nThis unit can be sc\", \"aled up or out to take advantage of cloud-based on-demand scalability. Scaling up\\nmeans adding addit\", \"ional CPU, memory, disk space, or other resources to the server(s) hosting your\\napp. Scaling out mea\", \"ns adding additional instances of such servers, whether these are physical\\nservers, virtual machines\", \", or containers. When your app is hosted across multiple instances, a load\\nbalancer is used to assig\", \"n requests to individual app instances.\\n\\n\\nThe simplest approach to scaling a web application in Azur\", \"e is to configure scaling manually in the\\napplication\\u2019s App Service Plan. Figure 5-6 shows the appro\", \"priate Azure dashboard screen to configure\\nhow many instances are serving an app.\\n\\n\\n22 CHAPTER 4 | C\", \"ommon web application architectures\\n\\n\\n_Figure 5-6. App Service Plan scaling in Azure._\\n\\n### Clean ar\", \"chitecture\\n\\n\\nApplications that follow the Dependency Inversion Principle as well as the Domain-Drive\", \"n Design\\n(DDD) principles tend to arrive at a similar architecture. This architecture has gone by ma\", \"ny names\\nover the years. One of the first names was Hexagonal Architecture, followed by Ports-and-Ad\", \"apters.\\n[More recently, it\\u2019s been cited as the Onion Architecture](https://jeffreypalermo.com/blog/t\", \"he-onion-architecture-part-1/) [or Clean Architecture. The latter name, Clean](https://blog.cleancod\", \"er.com/uncle-bob/2012/08/13/the-clean-architecture.html)\\nArchitecture, is used as the name for this \", \"architecture in this e-book.\\n\\n\\nThe eShopOnWeb reference application uses the Clean Architecture appr\", \"oach in organizing its code\\ninto projects. You can find a solution template you can use as a startin\", \"g point for your own ASP.NET\\n[Core solutions in the ardalis/cleanarchitecture GitHub repository or b\", \"y installing the template from](https://github.com/ardalis/cleanarchitecture)\\n[NuGet.](https://www.n\", \"uget.org/packages/Ardalis.CleanArchitecture.Template/)\\n\\n\\nClean architecture puts the business logic \", \"and application model at the center of the application.\\nInstead of having business logic depend on d\", \"ata access or other infrastructure concerns, this\\ndependency is inverted: infrastructure and impleme\", \"ntation details depend on the Application Core.\\nThis functionality is achieved by defining abstracti\", \"ons, or interfaces, in the Application Core, which are\\nthen implemented by types defined in the Infr\", \"astructure layer. A common way of visualizing this\\narchitecture is to use a series of concentric cir\", \"cles, similar to an onion. Figure 5-7 shows an example of\\nthis style of architectural representation\", \".\\n\\n\\n23 CHAPTER 4 | Common web application architectures\\n\\n\\n_Figure 5-7. Clean Architecture; onion vie\", \"w_\\n\\n\\nIn this diagram, dependencies flow toward the innermost circle. The Application Core takes its \", \"name\\nfrom its position at the core of this diagram. And you can see on the diagram that the Applicat\", \"ion\\nCore has no dependencies on other application layers. The application\\u2019s entities and interfaces \", \"are at\\nthe very center. Just outside, but still in the Application Core, are domain services, which \", \"typically\\nimplement interfaces defined in the inner circle. Outside of the Application Core, both th\", \"e UI and the\\nInfrastructure layers depend on the Application Core, but not on one another (necessari\", \"ly).\\n\\n\\nFigure 5-8 shows a more traditional horizontal layer diagram that better reflects the depende\", \"ncy\\nbetween the UI and other layers.\\n\\n\\n24 CHAPTER 4 | Common web application architectures\\n\\n\\n_Figure\", \" 5-8. Clean Architecture; horizontal layer view_\\n\\n\\nNote that the solid arrows represent compile-time\", \" dependencies, while the dashed arrow represents a\\nruntime-only dependency. With the clean architect\", \"ure, the UI layer works with interfaces defined in\\nthe Application Core at compile time, and ideally\", \" shouldn\\u2019t know about the implementation types\\ndefined in the Infrastructure layer. At run time, how\", \"ever, these implementation types are required for\\nthe app to execute, so they need to be present and\", \" wired up to the Application Core interfaces via\\ndependency injection.\\n\\n\\nFigure 5-9 shows a more det\", \"ailed view of an ASP.NET Core application\\u2019s architecture when built\\nfollowing these recommendations.\", \"\\n\\n\\n25 CHAPTER 4 | Common web application architectures\\n\\n\\n_Figure 5-9. ASP.NET Core architecture diag\", \"ram following Clean Architecture._\\n\\n\\nBecause the Application Core doesn\\u2019t depend on Infrastructure, \", \"it\\u2019s very easy to write automated unit\\ntests for this layer. Figures 5-10 and 5-11 show how tests fi\", \"t into this architecture.\\n\\n\\n_Figure 5-10. Unit testing Application Core in isolation._\\n\\n\\n26 CHAPTER \", \"4 | Common web application architectures\\n\\n\\n_Figure 5-11. Integration testing Infrastructure implemen\", \"tations with external dependencies._\\n\\n\\nSince the UI layer doesn\\u2019t have any direct dependency on type\", \"s defined in the Infrastructure project,\\nit\\u2019s likewise very easy to swap out implementations, either\", \" to facilitate testing or in response to\\nchanging application requirements. ASP.NET Core\\u2019s built-in \", \"use of and support for dependency\\ninjection makes this architecture the most appropriate way to stru\", \"cture non-trivial monolithic\\napplications.\\n\\n\\nFor monolithic applications, the Application Core, Infr\", \"astructure, and UI projects are all run as a single\\napplication. The runtime application architectur\", \"e might look something like Figure 5-12.\\n\\n\\n27 CHAPTER 4 | Common web application architectures\\n\\n\\n_Fi\", \"gure 5-12. A sample ASP.NET Core app\\u2019s runtime architecture._\\n\\n#### **Organizing code in Clean Archi\", \"tecture**\\n\\n\\nIn a Clean Architecture solution, each project has clear responsibilities. As such, cert\", \"ain types belong\\nin each project and you\\u2019ll frequently find folders corresponding to these types in \", \"the appropriate\\nproject.\\n\\n\\n**Application Core**\\n\\n\\nThe Application Core holds the business model, whi\", \"ch includes entities, services, and interfaces. These\\ninterfaces include abstractions for operations\", \" that will be performed using Infrastructure, such as data\\naccess, file system access, network calls\", \", etc. Sometimes services or interfaces defined at this layer will\\nneed to work with non-entity type\", \"s that have no dependencies on UI or Infrastructure. These can be\\ndefined as simple Data Transfer Ob\", \"jects (DTOs).\\n\\n\\n**Application Core types**\\n\\n\\n  - Entities (business model classes that are persisted\", \")\\n\\n  - Aggregates (groups of entities)\\n\\n  - Interfaces\\n\\n  - Domain Services\\n\\n  - Specifications\\n\\n  -\", \" Custom Exceptions and Guard Clauses\\n\\n  - Domain Events and Handlers\\n\\n\\n28 CHAPTER 4 | Common web app\", \"lication architectures\\n\\n\\n**Infrastructure**\\n\\n\\nThe Infrastructure project typically includes data acc\", \"ess implementations. In a typical ASP.NET Core\\nweb application, these implementations include the En\", \"tity Framework (EF) DbContext, any EF Core\\nMigration objects that have been defined, and data access\", \" implementation classes. The most common\\n[way to abstract data access implementation code is through\", \" the use of the Repository design pattern.](https://deviq.com/repository-pattern/)\\n\\n\\nIn addition to \", \"data access implementations, the Infrastructure project should contain implementations\\nof services t\", \"hat must interact with infrastructure concerns. These services should implement interfaces\\ndefined i\", \"n the Application Core, and so Infrastructure should have a reference to the Application Core\\nprojec\", \"t.\\n\\n\\n**Infrastructure types**\\n\\n\\n  - EF Core types (DbContext, Migration)\\n\\n  - Data access implementa\", \"tion types (Repositories)\\n\\n  - Infrastructure-specific services (for example, FileLogger or SmtpNoti\", \"fier)\\n\\n\\n**UI Layer**\\n\\n\\nThe user interface layer in an ASP.NET Core MVC application is the entry poin\", \"t for the application. This\\nproject should reference the Application Core project, and its types sho\", \"uld interact with infrastructure\\nstrictly through interfaces defined in Application Core. No direct \", \"instantiation of or static calls to the\\nInfrastructure layer types should be allowed in the UI layer\", \".\\n\\n\\n**UI Layer types**\\n\\n\\n  - Controllers\\n\\n  - Custom Filters\\n\\n  - Custom Middleware\\n\\n  - Views\\n\\n  - \", \"ViewModels\\n\\n  - Startup\\n\\nThe Startup class or _Program.cs_ file is responsible for configuring the a\", \"pplication, and for wiring up\\nimplementation types to interfaces. The place where this logic is perf\", \"ormed is known as the app\\u2019s\\n_composition root_, and is what allows dependency injection to work prop\", \"erly at run time.\\n\\n\\n\\n\\n\\n29 CHAPTER 4 | Common web application architectures\\n\\n\\n### Monolithic applicat\", \"ions and containers\\n\\nYou can build a single and monolithic-deployment based Web Application or Servi\", \"ce and deploy it as\\na container. Within the application, it might not be monolithic but organized in\", \"to several libraries,\\ncomponents, or layers. Externally, it\\u2019s a single container with a single proce\", \"ss, single web application,\\nor single service.\\n\\n\\nTo manage this model, you deploy a single container\", \" to represent the application. To scale, just add\\nadditional copies with a load balancer in front. T\", \"he simplicity comes from managing a single\\ndeployment in a single container or VM.\\n\\n\\nYou can include\", \" multiple components/libraries or internal layers within each container, as illustrated in\\nFigure 5-\", \"13. But, following the container principle of _\\u201ca container does one thing, and does it in one\\nproce\", \"ss_\\u201d, the monolithic pattern might be a conflict.\\n\\n\\nThe downside of this approach comes if/when the \", \"application grows, requiring it to scale. If the entire\\napplication scales, it\\u2019s not really a proble\", \"m. However, in most cases, a few parts of the application are\\nthe choke points requiring scaling, wh\", \"ile other components are used less.\\n\\n\\nUsing the typical eCommerce example, what you likely need to s\", \"cale is the product information\\ncomponent. Many more customers browse products than purchase them. M\", \"ore customers use their\\nbasket than use the payment pipeline. Fewer customers add comments or view t\", \"heir purchase history.\\nAnd you likely only have a handful of employees, in a single region, that nee\", \"d to manage the content\\nand marketing campaigns. By scaling the monolithic design, all the code is d\", \"eployed multiple times.\\n\\n\\nIn addition to the \\u201cscale everything\\u201d problem, changes to a single compone\", \"nt require complete\\nretesting of the entire application, and a complete redeployment of all the inst\", \"ances.\\n\\n\\nThe monolithic approach is common, and many organizations are developing with this architec\", \"tural\\napproach. Many are having good enough results, while others are hitting limits. Many designed \", \"their\\napplications in this model, because the tools and infrastructure were too difficult to build s\", \"erviceoriented architectures (SOA), and they didn\\u2019t see the need until the app grew. If you find you\", \"\\u2019re hitting\\n\\n\\n30 CHAPTER 4 | Common web application architectures\\n\\n\\nthe limits of the monolithic app\", \"roach, breaking up the app to enable it to better leverage containers\\nand microservices may be the n\", \"ext logical step.\\n\\n\\nDeploying monolithic applications in Microsoft Azure can be achieved using dedic\", \"ated VMs for each\\n[instance. Using Azure Virtual Machine Scale Sets, you can easily scale the VMs. A\", \"zure App Services can](https://docs.microsoft.com/azure/virtual-machine-scale-sets/)\\nrun monolithic \", \"applications and easily scale instances without having to manage the VMs. Azure App\\nServices can run\", \" single instances of Docker containers as well, simplifying the deployment. Using\\nDocker, you can de\", \"ploy a single VM as a Docker host, and run multiple instances. Using the Azure\\nbalancer, as shown in\", \" the Figure 5-14, you can manage scaling.\\n\\n\\nThe deployment to the various hosts can be managed with \", \"traditional deployment techniques. The\\nDocker hosts can be managed with commands like **docker run**\", \" performed manually, or through\\nautomation such as Continuous Delivery (CD) pipelines.\\n\\n#### **Monol\", \"ithic application deployed as a container**\\n\\n\\nThere are benefits of using containers to manage monol\", \"ithic application deployments. Scaling the\\ninstances of containers is far faster and easier than dep\", \"loying additional VMs. Even when using virtual\\nmachine scale sets to scale VMs, they take time to cr\", \"eate. When deployed as app instances, the\\nconfiguration of the app is managed as part of the VM.\\n\\n\\nD\", \"eploying updates as Docker images is far faster and network efficient. Docker Images typically start\", \"\\nin seconds, speeding rollouts. Tearing down a Docker instance is as easy as issuing a docker stop\\nc\", \"ommand, typically completing in less than a second.\\n\\n\\n31 CHAPTER 4 | Common web application architec\", \"tures\\n\\n\\nAs containers are inherently immutable by design, you never need to worry about corrupted VM\", \"s,\\nwhereas update scripts might forget to account for some specific configuration or file left on th\", \"e disk.\\n\\n\\nYou can use Docker containers for a monolithic deployment of simpler web applications. Thi\", \"s\\napproach improves continuous integration and continuous deployment pipelines and helps achieve\\ndep\", \"loyment-to-production success. No more \\u201cIt works on my machine, why does it not work in\\nproduction?\\u201d\", \"\\n\\n\\nA microservices-based architecture has many benefits, but those benefits come at a cost of increa\", \"sed\\ncomplexity. In some cases, the costs outweigh the benefits, so a monolithic deployment applicati\", \"on\\nrunning in a single container or in just a few containers is a better option.\\n\\n\\nA monolithic appl\", \"ication might not be easily decomposable into well-separated microservices.\\nMicroservices should wor\", \"k independently of each other to provide a more resilient application. If you\\ncan\\u2019t deliver independ\", \"ent feature slices of the application, separating it only adds complexity.\\n\\n\\nAn application might no\", \"t yet need to scale features independently. Many applications, when they\\nneed to scale beyond a sing\", \"le instance, can do so through the relatively simple process of cloning that\\nentire instance. The ad\", \"ditional work to separate the application into discrete services provides a\\nminimal benefit when sca\", \"ling full instances of the application is simple and cost-effective.\\n\\n\\nEarly in the development of a\", \"n application, you might not have a clear idea where the natural\\nfunctional boundaries are. As you d\", \"evelop a minimum viable product, the natural separation might\\nnot yet have emerged. Some of these co\", \"nditions might be temporary. You might start by creating a\\nmonolithic application, and later separat\", \"e some features to be developed and deployed as\\nmicroservices. Other conditions might be essential t\", \"o the application\\u2019s problem space, meaning that\\nthe application might never be broken into multiple \", \"microservices.\\n\\n\\nSeparating an application into many discrete processes also introduces overhead. Th\", \"ere\\u2019s more\\ncomplexity in separating features into different processes. The communication protocols b\", \"ecome\\nmore complex. Instead of method calls, you must use asynchronous communications between\\nservic\", \"es. As you move to a microservices architecture, you need to add many of the building blocks\\nimpleme\", \"nted in the microservices version of the eShopOnContainers application: event bus handling,\\nmessage \", \"resiliency and retries, eventual consistency, and more.\\n\\n\\n[The much simpler eShopOnWeb reference app\", \"lication supports single-container monolithic container](https://github.com/dotnet-architecture/eSho\", \"pOnWeb)\\nusage. The application includes one web application that includes traditional MVC views, web\", \" APIs,\\nand Razor Pages. Optionally, you can run the application\\u2019s Blazor-based admin component, whic\", \"h\\nrequires a separate API project to run as well.\\n\\n\\nThe application can be launched from the solutio\", \"n root using the docker-compose build and dockercompose up commands. This command configures a conta\", \"iner for the web instance, using the\\nDockerfile found in the web project\\u2019s root, and runs the contai\", \"ner on a specified port. You can\\ndownload the source for this application from GitHub and run it loc\", \"ally. Even this monolithic\\napplication benefits from being deployed in a container environment.\\n\\n\\nFo\", \"r one, the containerized deployment means that every instance of the application runs in the same\\nen\", \"vironment. This approach includes the developer environment where early testing and\\ndevelopment take\", \" place. The development team can run the application in a containerized\\nenvironment that matches the\", \" production environment.\\n\\n\\n32 CHAPTER 4 | Common web application architectures\\n\\n\\nIn addition, contai\", \"nerized applications scale out at a lower cost. Using a container environment\\nenables greater resour\", \"ce sharing than traditional VM environments.\\n\\n\\nFinally, containerizing the application forces a sepa\", \"ration between the business logic and the storage\\nserver. As the application scales out, the multipl\", \"e containers will all rely on a single physical storage\\nmedium. This storage medium would typically \", \"be a high-availability server running a SQL Server\\ndatabase.\\n\\n### Docker support\\n\\n\\nThe eShopOnWeb pr\", \"oject runs on .NET. Therefore, it can run in either Linux-based or Windows-based\\ncontainers. Note th\", \"at for Docker deployment, you want to use the same host type for SQL Server.\\nLinux-based containers \", \"allow a smaller footprint and are preferred.\\n\\n\\nYou can use Visual Studio 2017 or later to add Docker\", \" support to an existing application by rightclicking on a project in **Solution Explorer** and choos\", \"ing **Add** - **Docker Support** . This step adds the\\nfiles required and modifies the project to use\", \" them. The current eShopOnWeb sample already has\\nthese files in place.\\n\\n\\nThe solution-level docker-c\", \"ompose.yml file contains information about what images to build and\\nwhat containers to launch. The f\", \"ile allows you to use the docker-compose command to launch\\nmultiple applications at the same time. I\", \"n this case, it is only launching the Web project. You can also\\nuse it to configure dependencies, su\", \"ch as a separate database container.\\n\\n\\nThe docker-compose.yml file references the Dockerfile in the \", \"Web project. The Dockerfile is used to\\nspecify which base container will be used and how the applica\", \"tion will be configured on it. The Web\\u2019\\nDockerfile:\\n\\n\\n33 CHAPTER 4 | Common web application architec\", \"tures\\n\\n\\n#### **Troubleshooting Docker problems**\\n\\nOnce you run the containerized application, it con\", \"tinues to run until you stop it. You can view which\\ncontainers are running with the docker ps comman\", \"d. You can stop a running container by using the\\ndocker stop command and specifying the container ID\", \".\\n\\n\\nNote that running Docker containers may be bound to ports you might otherwise try to use in your\", \"\\ndevelopment environment. If you try to run or debug an application using the same port as a running\", \"\\nDocker container, you\\u2019ll get an error stating that the server can\\u2019t bind to that port. Once again,\\n\", \"stopping the container should resolve the issue.\\n\\n\\nIf you want to add Docker support to your applica\", \"tion using Visual Studio, make sure Docker Desktop\\nis running when you do so. The wizard won\\u2019t run c\", \"orrectly if Docker Desktop isn\\u2019t running when you\\nstart the wizard. In addition, the wizard examines\", \" your current container choice to add the correct\\nDocker support. If you want to add, support for Wi\", \"ndows Containers, you need to run the wizard\\nwhile you have Docker Desktop running with Windows Cont\", \"ainers configured. If you want to add,\\nsupport for Linux containers, run the wizard while you have D\", \"ocker running with Linux containers\\nconfigured.\\n\\n#### **Other web application architectural styles**\", \"\\n\\n\\n  - [Web-Queue-Worker: The core components of this architecture are a web front end that](https:/\", \"/docs.microsoft.com/azure/architecture/guide/architecture-styles/web-queue-worker)\\nserves client req\", \"uests, and a worker that performs resource-intensive tasks, long-running\\nworkflows, or batch jobs. T\", \"he web front end communicates with the worker through a\\nmessage queue.\\n\\n  - [N-tier: An N-tier archi\", \"tecture divides an application into logical layers and physical tiers.](https://docs.microsoft.com/a\", \"zure/architecture/guide/architecture-styles/n-tier)\\n\\n  - [Microservice: A microservices architecture\", \" consists of a collection of small, autonomous](https://docs.microsoft.com/azure/architecture/guide/\", \"architecture-styles/microservices)\\nservices. Each service is self-contained and should implement a s\", \"ingle business capability\\nwithin a bounded context.\\n\\n#### **References \\u2013 Common web architectures**\\n\", \"\\n\\n  - **The Clean Architecture**\\n[https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-archite\", \"cture.html](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)\\n\\n  - **The\", \" Onion Architecture**\\n[https://jeffreypalermo.com/blog/the-onion-architecture-part-1/](https://jeffr\", \"eypalermo.com/blog/the-onion-architecture-part-1/)\\n\\n  - **The Repository Pattern**\\n[https://deviq.co\", \"m/repository-pattern/](https://deviq.com/repository-pattern/)\\n\\n  - **Clean Architecture Solution Tem\", \"plate**\\n[https://github.com/ardalis/cleanarchitecture](https://github.com/ardalis/cleanarchitecture)\", \"\\n\\n\\n34 CHAPTER 4 | Common web application architectures\\n\\n\\n  - **Architecting Microservices e-book**\\n[\", \"https://aka.ms/MicroservicesEbook](https://aka.ms/MicroservicesEbook)\\n\\n  - **DDD (Domain-Driven Desi\", \"gn)**\\n[https://learn.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-](https:/\", \"/docs.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/)\\n[patter\", \"ns/](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patter\", \"ns/)\\n\\n\\n35 CHAPTER 4 | Common web application architectures\\n\\n\\n**CHAPTER**\\n# 5\\n\\n## Common client-side \", \"web technologies\\n\\n\\n\\u201cWebsites should look good from the inside and out.\\u201d _- Paul Cookson_\\n\\n\\nASP.NET C\", \"ore applications are web applications and they typically rely on client-side web\\ntechnologies like H\", \"TML, CSS, and JavaScript. By separating the content of the page (the HTML) from\\nits layout and styli\", \"ng (the CSS), and its behavior (via JavaScript), complex web apps can leverage the\\nSeparation of Con\", \"cerns principle. Future changes to the structure, design, or behavior of the\\napplication can be made\", \" more easily when these concerns are not intertwined.\\n\\n\\nWhile HTML and CSS are relatively stable, Ja\", \"vaScript, by means of the application frameworks and\\nutilities developers work with to build web-bas\", \"ed applications, is evolving at breakneck speed. This\\nchapter looks at a few ways that JavaScript is\", \" used by web developers and provides a high-level\\noverview of the Angular and React client-side libr\", \"aries.\\n\\n\\n\\n\\n### HTML\\n\\nHTML is the standard markup language used to create web pages and web applicati\", \"ons. Its elements\\nform the building blocks of pages, representing formatted text, images, form input\", \"s, and other\\nstructures. When a browser makes a request to a URL, whether fetching a page or an appl\", \"ication, the\\nfirst thing that is returned is an HTML document. This HTML document may reference or i\", \"nclude\\nadditional information about its look and layout in the form of CSS, or behavior in the form \", \"of\\nJavaScript.\\n\\n### CSS\\n\\n\\nCSS (Cascading Style Sheets) is used to control the look and layout of HTM\", \"L elements. CSS styles can\\nbe applied directly to an HTML element, defined separately on the same pa\", \"ge, or defined in a\\nseparate file and referenced by the page. Styles cascade based on how they are u\", \"sed to select a given\\nHTML element. For instance, a style might apply to an entire document, but wou\", \"ld be overridden by a\\n\\n\\n36 CHAPTER 5 | Common client-side web technologies\\n\\n\\nstyle that applied to a\", \" particular element. Likewise, an element-specific style would be overridden by a\\nstyle that applied\", \" to a CSS class that was applied to the element, which in turn would be overridden\\nby a style target\", \"ing a specific instance of that element (via its ID). Figure 6-1\\n\\n\\n_Figure 6-1. CSS Specificity rule\", \"s, in order._\\n\\n\\nIt\\u2019s best to keep styles in their own separate stylesheet files, and to use selectio\", \"n-based cascading to\\nimplement consistent and reusable styles within the application. Placing style \", \"rules within HTML\\nshould be avoided, and applying styles to specific individual elements (rather tha\", \"n whole classes of\\nelements, or elements that have had a particular CSS class applied to them) shoul\", \"d be the exception,\\nnot the rule.\\n\\n#### **CSS preprocessors**\\n\\n\\nCSS stylesheets lack support for con\", \"ditional logic, variables, and other programming language\\nfeatures. Thus, large stylesheets often in\", \"clude quite a bit of repetition, as the same color, font, or other\\nsetting is applied to many differ\", \"ent variations of HTML elements and CSS classes. CSS preprocessors\\n[can help your stylesheets follow\", \" the DRY principle](https://deviq.com/don-t-repeat-yourself/) by adding support for variables and lo\", \"gic.\\n\\n\\nThe most popular CSS preprocessors are Sass and LESS. Both extend CSS and are backward\\ncompat\", \"ible with it, meaning that a plain CSS file is a valid Sass or LESS file. Sass is Ruby-based and\\nLES\", \"S is JavaScript based, and both typically run as part of your local development process. Both have\\nc\", \"ommand-line tools available, as well as built-in support in Visual Studio for running them using Gul\", \"p\\nor Grunt tasks.\\n\\n\\n37 CHAPTER 5 | Common client-side web technologies\\n\\n\\n### JavaScript\\n\\nJavaScript \", \"is a dynamic, interpreted programming language that has been standardized in the\\nECMAScript language\", \" specification. It is the programming language of the web. Like CSS, JavaScript\\ncan be defined as at\", \"tributes within HTML elements, as blocks of script within a page, or in separate\\nfiles. Just like CS\", \"S, it\\u2019s recommended to organize JavaScript into separate files, keeping it separated as\\nmuch as poss\", \"ible from the HTML found on individual web pages or application views.\\n\\n\\nWhen working with JavaScrip\", \"t in your web application, there are a few tasks that you\\u2019ll commonly\\nneed to perform:\\n\\n\\n  - Selecti\", \"ng an HTML element and retrieving and/or updating its value.\\n\\n\\n  - Querying a Web API for data.\\n\\n\\n  \", \"- Sending a command to a Web API (and responding to a callback with its result).\\n\\n\\n  - Performing va\", \"lidation.\\n\\n\\nYou can perform all of these tasks with JavaScript alone, but many libraries exist to ma\", \"ke these tasks\\neasier. One of the first and most successful of these libraries is jQuery, which cont\", \"inues to be a\\npopular choice for simplifying these tasks on web pages. For Single Page Applications \", \"(SPAs), jQuery\\ndoesn\\u2019t provide many of the desired features that Angular and React offer.\\n\\n#### **Le\", \"gacy web apps with jQuery**\\n\\n\\nAlthough ancient by JavaScript framework standards, jQuery continues t\", \"o be a commonly used library\\nfor working with HTML/CSS and building applications that make AJAX call\", \"s to web APIs. However,\\njQuery operates at the level of the browser document object model (DOM), and\", \" by default offers only\\nan imperative, rather than declarative, model.\\n\\n\\nFor example, imagine that i\", \"f a textbox\\u2019s value exceeds 10, an element on the page should be made\\nvisible. In jQuery, this funct\", \"ionality would typically be implemented by writing an event handler with\\ncode that would inspect the\", \" textbox\\u2019s value and set the visibility of the target element based on that\\nvalue. This process is a\", \"n imperative, code-based approach. Another framework might instead use\\ndatabinding to bind the visib\", \"ility of the element to the value of the textbox declaratively. This\\napproach would not require writ\", \"ing any code, but instead only requires decorating the elements\\ninvolved with data binding attribute\", \"s. As client-side behaviors grow more complex, data binding\\napproaches frequently result in simpler \", \"solutions with less code and conditional complexity.\\n\\n#### **jQuery vs a SPA Framework**\\n\\n|Factor|jQ\", \"uery|Angular|\\n|---|---|---|\\n|Abstracts the DOM|**Yes**|**Yes**|\\n|AJAX Support|**Yes**|**Yes**|\\n|Decl\", \"arative Data Binding|**No**|**Yes**|\\n|MVC-style Routing|**No**|**Yes**|\\n\\n\\n\\n38 CHAPTER 5 | Common cli\", \"ent-side web technologies\\n\\n\\n|Factor|jQuery|Angular|\\n|---|---|---|\\n|Templating|**No**|**Yes**|\\n|Deep-\", \"Link Routing|**No**|**Yes**|\\n\\n\\nMost of the features jQuery lacks intrinsically can be added with the\", \" addition of other libraries.\\nHowever, a SPA framework like Angular provides these features in a mor\", \"e integrated fashion, since it\\u2019s\\nbeen designed with all of them in mind from the start. Also, jQuery\", \" is an imperative library, meaning\\nthat you need to call jQuery functions in order to do anything wi\", \"th jQuery. Much of the work and\\nfunctionality that SPA frameworks provide can be done declaratively,\", \" requiring no actual code to be\\nwritten.\\n\\n\\nData binding is a great example of this functionality. In\", \" jQuery, it usually only takes one line of code to\\nget the value of a DOM element or to set an eleme\", \"nt\\u2019s value. However, you have to write this code\\nanytime you need to change the value of the element\", \", and sometimes this will occur in multiple\\nfunctions on a page. Another common example is element v\", \"isibility. In jQuery, there might be many\\ndifferent places where you\\u2019d write code to control whether\", \" certain elements were visible. In each of\\nthese cases, when using data binding, no code would need \", \"to be written. You\\u2019d simply bind the value\\nor visibility of the elements in question to a _viewmodel\", \"_ on the page, and changes to that viewmodel\\nwould automatically be reflected in the bound elements.\", \"\\n\\n#### **Angular SPAs**\\n\\n\\nAngular remains one of the world\\u2019s most popular JavaScript frameworks. Sin\", \"ce Angular 2, the team\\n[rebuilt the framework from the ground up (using TypeScript) and rebranded fr\", \"om the original](https://www.typescriptlang.org/)\\nAngularJS name to Angular. Now several years old, \", \"the redesigned Angular continues to be a robust\\nframework for building Single Page Applications.\\n\\n\\nA\", \"ngular applications are built from components. Components combine HTML templates with special\\nobject\", \"s and control a portion of the page. A simple component from Angular\\u2019s docs is shown here:\\n\\n\\nCompone\", \"nts are defined using the @Component decorator function, which takes in metadata about\\nthe component\", \". The selector property identifies the ID of the element on the page where this\\ncomponent will be di\", \"splayed. The template property is a simple HTML template that includes a\\nplaceholder that correspond\", \"s to the component\\u2019s name property, defined on the last line.\\n\\n\\nBy working with components and templ\", \"ates, instead of DOM elements, Angular apps can operate at a\\nhigher level of abstraction and with le\", \"ss overall code than apps written using just JavaScript (also\\ncalled \\u201cvanilla JS\\u201d) or with jQuery. A\", \"ngular also imposes some order on how you organize your clientside script files. By convention, Angu\", \"lar apps use a common folder structure, with module and\\n\\n\\n39 CHAPTER 5 | Common client-side web tech\", \"nologies\\n\\n\\ncomponent script files located in an app folder. Angular scripts concerned with building,\", \" deploying,\\nand testing the app are typically located in a higher-level folder.\\n\\n\\nYou can develop An\", \"gular apps by using a CLI. Getting started with Angular development locally\\n(assuming you already ha\", \"ve git and npm installed) consists of simply cloning a repo from GitHub and\\nrunning npm install and \", \"npm start. Beyond this, Angular ships its own CLI, which can create projects,\\nadd files, and assist \", \"with testing, bundling, and deployment tasks. This CLI friendliness makes Angular\\nespecially compati\", \"ble with ASP.NET Core, which also features great CLI support.\\n\\n\\nMicrosoft has developed a reference \", \"application, eShopOnContainers, which includes an Angular SPA\\nimplementation. This app includes Angu\", \"lar modules to manage the online store\\u2019s shopping basket,\\nload and display items from its catalog, a\", \"nd handling order creation. You can view and download the\\n[sample application from GitHub.](https://\", \"github.com/dotnet-architecture/eShopOnContainers/tree/main/src/Web/WebSPA)\\n\\n#### **React**\\n\\n\\nUnlike \", \"Angular, which offers a full Model-View-Controller pattern implementation, React is only\\nconcerned w\", \"ith views. It\\u2019s not a framework, just a library, so to build a SPA you\\u2019ll need to leverage\\nadditiona\", \"l libraries. There are a number of libraries that are designed to be used with React to\\nproduce rich\", \" single page applications.\\n\\n\\nOne of React\\u2019s most important features is its use of a virtual DOM. The\", \" virtual DOM provides React\\nwith several advantages, including performance (the virtual DOM can opti\", \"mize which parts of the\\nactual DOM need to be updated) and testability (no need to have a browser to\", \" test React and its\\ninteractions with its virtual DOM).\\n\\n\\nReact is also unusual in how it works with\", \" HTML. Rather than having a strict separation between code\\nand markup (with references to JavaScript\", \" appearing in HTML attributes perhaps), React adds HTML\\ndirectly within its JavaScript code as JSX. \", \"JSX is HTML-like syntax that can compile down to pure\\nJavaScript. For example:\\n\\n\\nIf you already know\", \" JavaScript, learning React should be easy. There isn\\u2019t nearly as much learning\\ncurve or special syn\", \"tax involved as with Angular or other popular libraries.\\n\\n\\nBecause React isn\\u2019t a full framework, you\", \"\\u2019ll typically want other libraries to handle things like routing,\\nweb API calls, and dependency mana\", \"gement. The nice thing is, you can pick the best library for each\\nof these, but the disadvantage is \", \"that you need to make all of these decisions and verify all of your\\nchosen libraries work well toget\", \"her when you\\u2019re done. If you want a good starting point, you can use\\na starter kit like React Slings\", \"hot, which prepackages a set of compatible libraries together with React.\\n\\n#### **Vue**\\n\\n\\nFrom its g\", \"etting started guide, \\u201cVue is a progressive framework for building user interfaces. Unlike\\nother mon\", \"olithic frameworks, Vue is designed from the ground up to be incrementally adoptable. The\\n\\n\\n40 CHAPT\", \"ER 5 | Common client-side web technologies\\n\\n\\ncore library is focused on the view layer only, and is \", \"easy to pick up and integrate with other libraries\\nor existing projects. On the other hand, Vue is p\", \"erfectly capable of powering sophisticated SinglePage Applications when used in combination with mod\", \"ern tooling and supporting libraries.\\u201d\\n\\n\\nGetting started with Vue simply requires including its scri\", \"pt within an HTML file:\\n\\n\\nThis is enough to render \\\"Hello Vue!\\\" on the page. Note, however, that Vue\", \" isn\\u2019t simply rendering the\\nmessage to the div once. It supports databinding and dynamic updates suc\", \"h that if the value of\\nmessage changes, the value in the <div> is immediately updated to reflect it.\", \"\\n\\n\\nOf course, this only scratches the surface of what Vue is capable of. It\\u2019s gained a great deal of\", \"\\n[popularity in the last several years and has a large community. There\\u2019s a huge and growing list of\", \"](https://github.com/vuejs/awesome-vue#redux)\\n[supporting components and libraries that work with Vu\", \"e to extend it as well. If you\\u2019re looking to add](https://github.com/vuejs/awesome-vue#redux)\\nclient\", \"-side behavior to your web application or considering building a full SPA, Vue is worth\\ninvestigatin\", \"g.\\n\\n#### **Blazor WebAssembly**\\n\\n\\nUnlike other JavaScript frameworks, Blazor WebAssembly is a single\", \"-page app (SPA) framework for\\nbuilding interactive client-side web apps with .NET. Blazor WebAssembl\", \"y uses open web standards\\nwithout plugins or recompiling code into other languages. Blazor WebAssemb\", \"ly works in all modern\\nweb browsers, including mobile browsers.\\n\\n\\nRunning .NET code inside web brows\", \"ers is made possible by WebAssembly (abbreviated wasm).\\nWebAssembly is a compact bytecode format opt\", \"imized for fast download and maximum execution\\nspeed. WebAssembly is an open web standard and is sup\", \"ported in web browsers without plugins.\\n\\n\\nWebAssembly code can access the full functionality of the \", \"browser via JavaScript, called JavaScript\\ninteroperability, often shortened to JavaScript interop or\", \" JS interop. .NET code executed via\\nWebAssembly in the browser runs in the browser\\u2019s JavaScript sand\", \"box with the protections that the\\nsandbox provides against malicious actions on the client machine.\\n\", \"\\n\\n[For more information, see Introduction to ASP.NET Core Blazor.](https://docs.microsoft.com/aspnet\", \"/core/blazor/)\\n\\n#### **Choosing a SPA Framework**\\n\\n\\nWhen considering which option will work best to \", \"support your SPA, keep in mind the following\\nconsiderations:\\n\\n\\n41 CHAPTER 5 | Common client-side web\", \" technologies\\n\\n\\n  - Is your team familiar with the framework and its dependencies (including TypeScr\", \"ipt in some\\ncases)?\\n\\n\\n  - How opinionated is the framework, and do you agree with its default way of\", \" doing things?\\n\\n\\n  - Does it (or a companion library) include all of the features your app requires?\", \"\\n\\n\\n  - Is it well documented?\\n\\n\\n  - How active is its community? Are new projects being built with i\", \"t?\\n\\n\\n  - How active is its core team? Are issues being resolved and new versions shipped regularly?\\n\", \"\\n\\nFrameworks continue to evolve with breakneck speed. Use the considerations listed above to help\\nmi\", \"tigate the risk of choosing a framework you\\u2019ll later regret being dependent upon. If you\\u2019re\\nparticul\", \"arly risk-averse, consider a framework that offers commercial support and/or is being\\ndeveloped by a\", \" large enterprise.\\n\\n#### **References \\u2013 Client Web Technologies**\\n\\n\\n  - **HTML and CSS**\\n[https://ww\", \"w.w3.org/standards/webdesign/htmlcss](https://www.w3.org/standards/webdesign/htmlcss)\\n\\n  - **Sass vs\", \". LESS**\\n[https://www.keycdn.com/blog/sass-vs-less/](https://www.keycdn.com/blog/sass-vs-less/)\\n\\n  -\", \" **Styling ASP.NET Core Apps with LESS, Sass, and Font Awesome**\\n[https://learn.microsoft.com/aspnet\", \"/core/client-side/less-sass-fa](https://docs.microsoft.com/aspnet/core/client-side/less-sass-fa)\\n\\n  \", \"- **Client-Side Development in ASP.NET Core**\\n[https://learn.microsoft.com/aspnet/core/client-side/]\", \"(https://docs.microsoft.com/aspnet/core/client-side/)\\n\\n  - **jQuery**\\n[https://jquery.com/](https://\", \"jquery.com/)\\n\\n  - **Angular**\\n[https://angular.io/](https://angular.io/)\\n\\n  - **React**\\n[https://rea\", \"ctjs.org/](https://reactjs.org/)\\n\\n  - **Vue**\\n[https://vuejs.org/](https://vuejs.org/)\\n\\n  - **Angula\", \"r vs React vs Vue: Which Framework to Choose in 2020**\\n[https://www.codeinwp.com/blog/angular-vs-vue\", \"-vs-react/](https://www.codeinwp.com/blog/angular-vs-vue-vs-react/)\\n\\n  - **The Top JavaScript Framew\", \"orks for Front-End Development in 2020**\\n[https://www.freecodecamp.org/news/complete-guide-for-front\", \"-end-developers-javascript-](https://www.freecodecamp.org/news/complete-guide-for-front-end-develope\", \"rs-javascript-frameworks-2019/)\\n[frameworks-2019/](https://www.freecodecamp.org/news/complete-guide-\", \"for-front-end-developers-javascript-frameworks-2019/)\\n\\n\\n42 CHAPTER 5 | Common client-side web techno\", \"logies\\n\\n\\n**CHAPTER**\\n# 6\\n\\n## Develop ASP.NET Core MVC apps\\n\\n\\n\\u201cIt\\u2019s not important to get it right the\", \" first time. It\\u2019s vitally important to get it right the last time.\\u201d _-_\\n_Andrew Hunt and David Thoma\", \"s_\\n\\n\\nASP.NET Core is a cross-platform, open-source framework for building modern cloud-optimized web\", \"\\napplications. ASP.NET Core apps are lightweight and modular, with built-in support for dependency\\ni\", \"njection, enabling greater testability and maintainability. Combined with MVC, which supports\\nbuildi\", \"ng modern web APIs in addition to view-based apps, ASP.NET Core is a powerful framework\\nwith which t\", \"o build enterprise web applications.\\n\\n### MVC and Razor Pages\\n\\n\\nASP.NET Core MVC offers many feature\", \"s that are useful for building web-based APIs and apps. The\\nterm MVC stands for \\u201cModel-View-Controll\", \"er\\u201d, a UI pattern that breaks up the responsibilities of\\nresponding to user requests into several pa\", \"rts. In addition to following this pattern, you can also\\nimplement features in your ASP.NET Core app\", \"s as Razor Pages.\\n\\n\\nRazor Pages are built into ASP.NET Core MVC, and use the same features for routi\", \"ng, model binding,\\nfilters, authorization, etc. However, instead of having separate folders and file\", \"s for Controllers, Models,\\nViews, etc. and using attribute-based routing, Razor Pages are placed in \", \"a single folder (\\u201c/Pages\\u201d),\\nroute based on their relative location in this folder, and handle reques\", \"ts with handlers instead of\\ncontroller actions. As a result, when working with Razor Pages, all of t\", \"he files and classes you need are\\ntypically colocated, not spread throughout the web project.\\n\\n\\n[Lea\", \"rn more about how MVC, Razor Pages, and related patterns are applied in the eShopOnWeb](https://gith\", \"ub.com/dotnet-architecture/eShopOnWeb/wiki/Patterns#mvc)\\n[sample application.](https://github.com/do\", \"tnet-architecture/eShopOnWeb/wiki/Patterns#mvc)\\n\\n\\nWhen you create a new ASP.NET Core App, you should\", \" have a plan in mind for the kind of app you\\nwant to build. When creating a new project, in your IDE\", \" or using the dotnet new CLI command, you\\nwill choose from several templates. The most common projec\", \"t templates are Empty, Web API, Web\\nApp, and Web App (Model-View-Controller). Although you can only \", \"make this decision when you first\\ncreate a project, it\\u2019s not an irrevocable decision. The Web API pr\", \"oject uses standard Model-ViewController controllers \\u2013 it just lacks Views by default. Likewise, the\", \" default Web App template uses\\nRazor Pages, and so also lacks a Views folder. You can add a Views fo\", \"lder to these projects later to\\nsupport view-based behavior. Web API and Model-View-Controller proje\", \"cts don\\u2019t include a Pages\\n\\n\\n43 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\nfolder by default, but yo\", \"u can add one later to support Razor Pages-based behavior. You can think of\\nthese three templates as\", \" supporting three different kinds of default user interaction: data (web API),\\npage-based, and view-\", \"based. However, you can mix and match any or all of these templates within a\\nsingle project if you w\", \"ish.\\n\\n#### **Why Razor Pages?**\\n\\n\\nRazor Pages is the default approach for new web applications in Vi\", \"sual Studio. Razor Pages offers a\\nsimpler way of building page-based application features, such as n\", \"on-SPA forms. Using controllers\\nand views, it was common for applications to have very large control\", \"lers that worked with many\\ndifferent dependencies and view models and returned many different views.\", \" This resulted in more\\ncomplexity and often resulted in controllers that didn\\u2019t follow the Single Re\", \"sponsibility Principle or\\nOpen/Closed Principles effectively. Razor Pages addresses this issue by en\", \"capsulating the server-side\\nlogic for a given logical \\u201cpage\\u201d in a web application with its Razor mar\", \"kup. A Razor Page that has no\\nserver-side logic can only consist of a Razor file (for instance, \\u201cInd\", \"ex.cshtml\\u201d). However, most nontrivial Razor Pages will have an associated page model class, which by\", \" convention is named the same\\nas the Razor file with a \\u201c.cs\\u201d extension (for example, \\u201cIndex.cshtml.c\", \"s\\u201d).\\n\\n\\nA Razor Page\\u2019s page model combines the responsibilities of an MVC controller and a viewmodel.\", \"\\nInstead of handling requests with controller action methods, page model handlers like \\u201cOnGet()\\u201d are\", \"\\nexecuted, rendering their associated page by default. Razor Pages simplifies the process of buildin\", \"g\\nindividual pages in an ASP.NET Core app, while still providing all the architectural features of A\", \"SP.NET\\nCore MVC. They\\u2019re a good default choice for new page-based functionality.\\n\\n#### **When to use\", \" MVC**\\n\\n\\nIf you\\u2019re building web APIs, the MVC pattern makes more sense than trying to use Razor Page\", \"s. If your\\nproject will only expose web API endpoints, you should ideally start from the Web API pro\", \"ject\\ntemplate. Otherwise, it\\u2019s easy to add controllers and associated API endpoints to any ASP.NET C\", \"ore\\napp. Use the view-based MVC approach if you\\u2019re migrating an existing application from ASP.NET MV\", \"C\\n5 or earlier to ASP.NET Core MVC and you want to do so with the least amount of effort. Once you\\u2019v\", \"e\\nmade the initial migration, you can evaluate whether it makes sense to adopt Razor Pages for new\\nf\", \"eatures or even as a wholesale migration. For more information about porting .NET 4.x apps to .NET\\n[\", \"8, see Porting Existing ASP.NET Apps to ASP.NET Core eBook.](https://docs.microsoft.com/dotnet/archi\", \"tecture/porting-existing-aspnet-apps/)\\n\\n\\nWhether you choose to build your web app using Razor Pages \", \"or MVC views, your app will have\\nsimilar performance and will include support for dependency injecti\", \"on, filters, model binding,\\nvalidation, and so on.\\n\\n### Mapping requests to responses\\n\\n\\nAt its heart\", \", ASP.NET Core apps map incoming requests to outgoing responses. At a low level, this\\nmapping is don\", \"e with middleware, and simple ASP.NET Core apps and microservices may be\\ncomprised solely of custom \", \"middleware. When using ASP.NET Core MVC, you can work at a\\nsomewhat higher level, thinking in terms \", \"of _routes_, _controllers_, and _actions_ . Each incoming request is\\ncompared with the application\\u2019s\", \" routing table, and if a matching route is found, the associated action\\n\\n\\n44 CHAPTER 6 | Develop ASP\", \".NET Core MVC apps\\n\\n\\nmethod (belonging to a controller) is called to handle the request. If no match\", \"ing route is found, an\\nerror handler (in this case, returning a NotFound result) is called.\\n\\n\\nASP.NE\", \"T Core MVC apps can use conventional routes, attribute routes, or both. Conventional routes\\nare defi\", \"ned in code, specifying routing _conventions_ using syntax like in the example below:\\n\\n\\nIn this exam\", \"ple, a route named \\u201cdefault\\u201d has been added to the routing table. It defines a route\\ntemplate with p\", \"laceholders for controller, action, and id. The controller and action placeholders have\\nthe default \", \"specified (Home and Index, respectively), and the id placeholder is optional (by virtue of a\\n\\u201c?\\u201d app\", \"lied to it). The convention defined here states that the first part of a request should correspond\\nt\", \"o the name of the controller, the second part to the action, and then if necessary a third part will\", \"\\nrepresent an ID parameter. Conventional routes are typically defined in one place for the applicati\", \"on,\\nsuch as in _Program.cs_ where the request middleware pipeline is configured.\\n\\n\\nAttribute routes \", \"are applied to controllers and actions directly, rather than specified globally. This\\napproach has t\", \"he advantage of making them much more discoverable when you\\u2019re looking at a\\nparticular method, but d\", \"oes mean that routing information is not kept in one place in the application.\\nWith attribute routes\", \", you can easily specify multiple routes for a given action, as well as combine\\nroutes between contr\", \"ollers and actions. For example:\\n\\n\\nRoutes can be specified on [HttpGet] and similar attributes, avoi\", \"ding the need to add separate [Route]\\nattributes. Attribute routes can also use tokens to reduce the\", \" need to repeat controller or action\\nnames, as shown below:\\n\\n\\nRazor Pages don\\u2019t use attribute routin\", \"g. You can specify additional route template information for a\\nRazor Page as part of its @page direc\", \"tive:\\n\\n```\\n@page \\\"{id:int}\\\"\\n\\n```\\n\\n45 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\nIn the previous exa\", \"mple, the page in question would match a route with an integer id parameter. For\\nexample, the _Produ\", \"cts.cshtml_ page located in the root of /Pages would respond to requests like this\\none:\\n\\n```\\n/Produc\", \"ts/123\\n\\n```\\n\\nOnce a given request has been matched to a route, but before the action method is calle\", \"d, ASP.NET\\n[Core MVC will perform model binding and model validation](https://docs.microsoft.com/asp\", \"net/core/mvc/models/model-binding) on the request. Model binding is\\nresponsible for converting incom\", \"ing HTTP data into the .NET types specified as parameters of the\\naction method to be called. For exa\", \"mple, if the action method expects an int id parameter, model\\nbinding will attempt to provide this p\", \"arameter from a value provided as part of the request. To do so,\\nmodel binding looks for values in a\", \" posted form, values in the route itself, and query string values.\\nAssuming an id value is found, it\", \" will be converted to an integer before being passed into the action\\nmethod.\\n\\n\\nAfter binding the mod\", \"el but before calling the action method, model validation occurs. Model\\nvalidation uses optional att\", \"ributes on the model type, and can help ensure that the provided model\\nobject conforms to certain da\", \"ta requirements. Certain values may be specified as required, or limited\\nto a certain length or nume\", \"ric range, etc. If validation attributes are specified but the model does not\\nconform to their requi\", \"rements, the property ModelState.IsValid will be false, and the set of failing\\nvalidation rules will\", \" be available to send to the client making the request.\\n\\n\\nIf you\\u2019re using model validation, you shou\", \"ld be sure to always check that the model is valid before\\nperforming any state-altering commands, to\", \" ensure your app is not corrupted by invalid data. You can\\n[use a filter](https://docs.microsoft.com\", \"/aspnet/core/mvc/controllers/filters) to avoid the need to add code for this validation in every act\", \"ion. ASP.NET Core MVC filters\\noffer a way of intercepting groups of requests, so that common policie\", \"s and cross-cutting concerns\\ncan be applied on a targeted basis. Filters can be applied to individua\", \"l actions, whole controllers, or\\nglobally for an application.\\n\\n\\nFor web APIs, ASP.NET Core MVC suppo\", \"rts _[content negotiation](https://docs.microsoft.com/aspnet/core/mvc/models/formatting)_, allowing \", \"requests to specify how\\nresponses should be formatted. Based on headers provided in the request, act\", \"ions returning data will\\nformat the response in XML, JSON, or another supported format. This feature\", \" enables the same API to\\nbe used by multiple clients with different data format requirements.\\n\\n\\nWeb \", \"API projects should consider using the [ApiController] attribute, which can be applied to\\nindividual\", \" controllers, to a base controller class, or to the entire assembly. This attribute adds\\nautomatic m\", \"odel validation checking and any action with an invalid model will return a BadRequest\\nwith the deta\", \"ils of the validation errors. The attribute also requires all actions have an attribute route,\\nrathe\", \"r than using a conventional route, and returns more detailed ProblemDetails information in\\nresponse \", \"to errors.\\n\\n#### **Keeping controllers under control**\\n\\n\\nFor page-based applications, Razor Pages do\", \" a great job of keeping controllers from getting too\\nlarge. Each individual page is given its own fi\", \"les and classes dedicated just to its handler(s). Prior to\\nthe introduction of Razor Pages, many vie\", \"w-centric applications would have large controller classes\\nresponsible for many different actions an\", \"d views. These classes would naturally grow to have many\\nresponsibilities and dependencies, making t\", \"hem harder to maintain. If you find your view-based\\n\\n\\n46 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\", \"\\ncontrollers are growing too large, consider refactoring them to use Razor Pages, or introducing a\\np\", \"attern like a mediator.\\n\\n\\nThe mediator design pattern is used to reduce coupling between classes whi\", \"le allowing\\ncommunication between them. In ASP.NET Core MVC applications, this pattern is frequently\", \" employed\\nto break up controllers into smaller pieces by using _handlers_ to do the work of action m\", \"ethods. The\\n[popular MediatR NuGet package is often used to accomplish this. Typically, controllers \", \"include many](https://www.nuget.org/packages/MediatR/)\\ndifferent action methods, each of which may r\", \"equire certain dependencies. The set of all\\ndependencies required by any action must be passed into \", \"the controller\\u2019s constructor. When using\\nMediatR, the only dependency a controller will typically ha\", \"ve is an instance of the mediator. Each\\naction then uses the mediator instance to send a message, wh\", \"ich is processed by a handler. The\\nhandler is specific to a single action and thus only needs the de\", \"pendencies required by that action. An\\nexample of a controller using MediatR is shown here:\\n\\n\\nIn the\", \" MyOrders action, the call to Send a GetMyOrders message is handled by this class:\\n\\n\\n47 CHAPTER 6 | \", \"Develop ASP.NET Core MVC apps\\n\\n\\nThe end result of this approach is for controllers to be much smalle\", \"r and focused primarily on routing\\nand model binding, while individual handlers are responsible for \", \"the specific tasks needed by a given\\n[endpoint. This approach can also be achieved without MediatR b\", \"y using the ApiEndpoints NuGet](https://www.nuget.org/packages/Ardalis.ApiEndpoints/)\\n[package, whic\", \"h attempts to bring to API controllers the same benefits Razor Pages brings to view-](https://www.nu\", \"get.org/packages/Ardalis.ApiEndpoints/)\\nbased controllers.\\n\\n#### **References \\u2013 Mapping Requests to \", \"Responses**\\n\\n\\n  - **Routing to Controller Actions**\\n[https://learn.microsoft.com/aspnet/core/mvc/con\", \"trollers/routing](https://docs.microsoft.com/aspnet/core/mvc/controllers/routing)\\n\\n  - **Model Bindi\", \"ng**\\n[https://learn.microsoft.com/aspnet/core/mvc/models/model-binding](https://docs.microsoft.com/a\", \"spnet/core/mvc/models/model-binding)\\n\\n  - **Model Validation**\\n[https://learn.microsoft.com/aspnet/c\", \"ore/mvc/models/validation](https://docs.microsoft.com/aspnet/core/mvc/models/validation)\\n\\n  - **Filt\", \"ers**\\n[https://learn.microsoft.com/aspnet/core/mvc/controllers/filters](https://docs.microsoft.com/a\", \"spnet/core/mvc/controllers/filters)\\n\\n  - **ApiController Attribute**\\n[https://learn.microsoft.com/as\", \"pnet/core/web-api/](https://docs.microsoft.com/aspnet/core/web-api/)\\n\\n### Working with dependencies\\n\", \"\\n\\n[ASP.NET Core has built-in support for and internally makes use of a technique known as dependency\", \"](https://docs.microsoft.com/aspnet/core/fundamentals/dependency-injection)\\n[injection. Dependency i\", \"njection is a technique that enables loose coupling between different parts of](https://docs.microso\", \"ft.com/aspnet/core/fundamentals/dependency-injection)\\nan application. Looser coupling is desirable b\", \"ecause it makes it easier to isolate parts of the\\napplication, allowing for testing or replacement. \", \"It also makes it less likely that a change in one part of\\nthe application will have an unexpected im\", \"pact somewhere else in the application. Dependency\\ninjection is based on the dependency inversion pr\", \"inciple, and is often key to achieving the\\nopen/closed principle. When evaluating how your applicati\", \"on works with its dependencies, beware of\\n[the static cling](https://deviq.com/static-cling/) [code \", \"smell, and remember the aphorism \\u201cnew is glue.\\u201d](https://ardalis.com/new-is-glue)\\n\\n\\nStatic cling occ\", \"urs when your classes make calls to static methods, or access static properties, which\\nhave side eff\", \"ects or dependencies on infrastructure. For example, if you have a method that calls a\\nstatic method\", \", which in turn writes to a database, your method is tightly coupled to the database.\\nAnything that \", \"breaks that database call will break your method. Testing such methods is notoriously\\ndifficult, sin\", \"ce such tests either require commercial mocking libraries to mock the static calls, or can\\nonly be t\", \"ested with a test database in place. Static calls that don\\u2019t have any dependence on\\ninfrastructure, \", \"especially those calls that are completely stateless, are fine to call and have no impact\\non couplin\", \"g or testability (beyond coupling code to the static call itself).\\n\\n\\n48 CHAPTER 6 | Develop ASP.NET \", \"Core MVC apps\\n\\n\\nMany developers understand the risks of static cling and global state, but will stil\", \"l tightly couple their\\ncode to specific implementations through direct instantiation. \\u201cNew is glue\\u201d \", \"is meant to be a reminder\\nof this coupling, and not a general condemnation of the use of the new key\", \"word. Just as with static\\nmethod calls, new instances of types that have no external dependencies ty\", \"pically do not tightly\\ncouple code to implementation details or make testing more difficult. But eac\", \"h time a class is\\ninstantiated, take just a brief moment to consider whether it makes sense to hard-\", \"code that specific\\ninstance in that particular location, or if it would be a better design to reques\", \"t that instance as a\\ndependency.\\n\\n#### **Declare your dependencies**\\n\\n\\nASP.NET Core is built around \", \"having methods and classes declare their dependencies, requesting\\nthem as arguments. ASP.NET applica\", \"tions are typically set up in _Program.cs_ or in a Startup class.\\n\\n\\n\\n\\n\\n**Configure services in** _**\", \"Program.cs**_\\n\\n\\nFor very simple apps, you can wire up dependencies directly in _Program.cs_ file usi\", \"ng a\\nWebApplicationBuilder. Once all needed services have been added, the builder is used to create \", \"the\\napp.\\n\\n\\n**Configure services in** _**Startup.cs**_\\n\\n\\nThe _Startup.cs_ is itself configured to sup\", \"port dependency injection at several points. If you\\u2019re using a\\nStartup class, you can give it a cons\", \"tructor and it can request dependencies through it, like so:\\n\\n\\nThe Startup class is interesting in t\", \"hat there are no explicit type requirements for it. It doesn\\u2019t inherit\\nfrom a special Startup base c\", \"lass, nor does it implement any particular interface. You can give it a\\nconstructor, or not, and you\", \" can specify as many parameters on the constructor as you want. When\\n\\n\\n49 CHAPTER 6 | Develop ASP.NE\", \"T Core MVC apps\\n\\n\\nthe web host you\\u2019ve configured for your application starts, it will call the Start\", \"up class (if you\\u2019ve told it\\nto use one), and will use dependency injection to populate any dependenc\", \"ies the Startup class\\nrequires. Of course, if you request parameters that aren\\u2019t configured in the s\", \"ervices container used by\\nASP.NET Core, you\\u2019ll get an exception, but as long as you stick to depende\", \"ncies the container knows\\nabout, you can request anything you want.\\n\\n\\nDependency injection is built \", \"into your ASP.NET Core apps right from the start, when you create the\\nStartup instance. It doesn\\u2019t s\", \"top there for the Startup class. You can also request dependencies in the\\nConfigure method:\\n\\n\\nThe Co\", \"nfigureServices method is the exception to this behavior; it must take just one parameter of\\ntype IS\", \"erviceCollection. It doesn\\u2019t really need to support dependency injection, since on the one hand\\nit i\", \"s responsible for adding objects to the services container, and on the other it has access to all\\ncu\", \"rrently configured services via the IServiceCollection parameter. Thus, you can work with\\ndependenci\", \"es defined in the ASP.NET Core services collection in every part of the Startup class, either\\nby req\", \"uesting the needed service as a parameter or by working with the IServiceCollection in\\nConfigureServ\", \"ices.\\n\\n\\n\\n\\n\\nThe Startup class is a model for how you should structure other parts of your ASP.NET Cor\", \"e\\napplication, from Controllers to Middleware to Filters to your own Services. In each case, you sho\", \"uld\\n[follow the Explicit Dependencies Principle, requesting your dependencies rather than directly c\", \"reating](https://deviq.com/explicit-dependencies-principle/)\\nthem, and leveraging dependency injecti\", \"on throughout your application. Be careful of where and how\\nyou directly instantiate implementations\", \", especially services and objects that work with infrastructure\\nor have side effects. Prefer working\", \" with abstractions defined in your application core and passed in as\\narguments to hardcoding referen\", \"ces to specific implementation types.\\n\\n### Structuring the application\\n\\n\\nMonolithic applications typ\", \"ically have a single entry point. In the case of an ASP.NET Core web\\napplication, the entry point wi\", \"ll be the ASP.NET Core web project. However, that doesn\\u2019t mean the\\nsolution should consist of just a\", \" single project. It\\u2019s useful to break up the application into different\\nlayers in order to follow se\", \"paration of concerns. Once broken up into layers, it\\u2019s helpful to go beyond\\nfolders to separate proj\", \"ects, which can help achieve better encapsulation. The best approach to\\nachieve these goals with an \", \"ASP.NET Core application is a variation of the Clean Architecture\\ndiscussed in chapter 5. Following \", \"this approach, the application\\u2019s solution will comprise separate\\nlibraries for the UI, Infrastructur\", \"e, and ApplicationCore.\\n\\n\\n50 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\nIn addition to these projec\", \"ts, separate test projects are included as well (Testing is discussed in\\nChapter 9).\\n\\n\\nThe applicati\", \"on\\u2019s object model and interfaces should be placed in the ApplicationCore project. This\\nproject will \", \"have as few dependencies as possible (and none on specific infrastructure concerns), and\\nthe other p\", \"rojects in the solution will reference it. Business entities that need to be persisted are\\ndefined i\", \"n the ApplicationCore project, as are services that do not directly depend on infrastructure.\\n\\n\\nImpl\", \"ementation details, such as how persistence is performed or how notifications might be sent to a\\nuse\", \"r, are kept in the Infrastructure project. This project will reference implementation-specific\\npacka\", \"ges such as Entity Framework Core, but should not expose details about these implementations\\noutside\", \" of the project. Infrastructure services and repositories should implement interfaces that are\\ndefin\", \"ed in the ApplicationCore project, and its persistence implementations are responsible for\\nretrievin\", \"g and storing entities defined in ApplicationCore.\\n\\n\\nThe ASP.NET Core UI project is responsible for \", \"any UI level concerns, but should not include business\\nlogic or infrastructure details. In fact, ide\", \"ally it shouldn\\u2019t even have a dependency on the Infrastructure\\nproject, which will help ensure no de\", \"pendency between the two projects is introduced accidentally.\\nThis can be achieved using a third-par\", \"ty DI container like Autofac, which allows you to define DI rules\\nin Module classes in each project.\", \"\\n\\n\\nAnother approach to decoupling the application from implementation details is to have the\\napplica\", \"tion call microservices, perhaps deployed in individual Docker containers. This provides even\\ngreate\", \"r separation of concerns and decoupling than leveraging DI between two projects, but has\\nadditional \", \"complexity.\\n\\n#### **Feature organization**\\n\\n\\nBy default, ASP.NET Core applications organize their fo\", \"lder structure to include Controllers and Views,\\nand frequently ViewModels. Client-side code to supp\", \"ort these server-side structures is typically stored\\nseparately in the wwwroot folder. However, larg\", \"e applications may encounter problems with this\\norganization, since working on any given feature oft\", \"en requires jumping between these folders. This\\ngets more and more difficult as the number of files \", \"and subfolders in each folder grows, resulting in a\\ngreat deal of scrolling through Solution Explore\", \"r. One solution to this problem is to organize\\napplication code by _feature_ instead of by file type\", \". This organizational style is typically referred to as\\n[feature folders or feature slices (see also\", \": Vertical Slices).](https://docs.microsoft.com/archive/msdn-magazine/2016/september/asp-net-core-fe\", \"ature-slices-for-asp-net-core-mvc)\\n\\n\\nASP.NET Core MVC supports Areas for this purpose. Using areas, \", \"you can create separate sets of\\nControllers and Views folders (as well as any associated models) in \", \"each Area folder. Figure 7-1 shows\\nan example folder structure, using Areas.\\n\\n\\n51 CHAPTER 6 | Develo\", \"p ASP.NET Core MVC apps\\n\\n\\n_Figure 7-1. Sample Area Organization_\\n\\n\\nWhen using Areas, you must use at\", \"tributes to decorate your controllers with the name of the area to\\nwhich they belong:\\n\\n\\nYou also nee\", \"d to add area support to your routes:\\n\\n\\nIn addition to the built-in support for Areas, you can also \", \"use your own folder structure, and\\nconventions in place of attributes and custom routes. This would \", \"allow you to have feature folders\\nthat didn\\u2019t include separate folders for Views, Controllers, etc.,\", \" keeping the hierarchy flatter and\\nmaking it easier to see all related files in a single place for e\", \"ach feature. For APIs, folders can be used\\nto replace controllers, and each folder can contain all o\", \"f the API Endpoints and their associated DTOs.\\n\\n\\n52 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\nASP.\", \"NET Core uses built-in convention types to control its behavior. You can modify or replace these\\ncon\", \"ventions. For example, you can create a convention that will automatically get the feature name\\nfor \", \"a given controller based on its namespace (which typically correlates to the folder in which the\\ncon\", \"troller is located):\\n\\n\\nYou then specify this convention as an option when you add support for MVC to\", \" your application in\\nConfigureServices (or in _Program.cs_ ):\\n\\n\\nASP.NET Core MVC also uses a convent\", \"ion to locate views. You can override it with a custom\\nconvention so that views will be located in y\", \"our feature folders (using the feature name provided by\\nthe FeatureConvention, above). You can learn\", \" more about this approach and download a working\\n[sample from the MSDN Magazine article, Feature Sli\", \"ces for ASP.NET Core MVC.](https://docs.microsoft.com/archive/msdn-magazine/2016/september/asp-net-c\", \"ore-feature-slices-for-asp-net-core-mvc)\\n\\n#### **APIs and Blazor applications**\\n\\n\\nIf your applicatio\", \"n includes a set of web APIs, which must be secured, these APIs should ideally be\\nconfigured as a se\", \"parate project from your View or Razor Pages application. Separating APIs,\\nespecially public APIs, f\", \"rom your server-side web application has a number of benefits. These\\napplications often will have un\", \"ique deployment and load characteristics. They\\u2019re also very likely to\\nadopt different mechanisms for\", \" security, with standard form-based applications leveraging cookiebased authentication and APIs most\", \" likely using token-based authentication.\\n\\n\\nAdditionally, Blazor applications, whether using Blazor \", \"Server or Blazor WebAssembly, should be built\\nas separate projects. The applications have different \", \"runtime characteristics as well as security models.\\nThey\\u2019re likely to share common types with the se\", \"rver-side web application (or API project), and these\\ntypes should be defined in a common shared pro\", \"ject.\\n\\n\\n53 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\nThe addition of a Blazor WebAssembly admin in\", \"terface to eShopOnWeb required adding several new\\nprojects. The Blazor WebAssembly project itself, B\", \"lazorAdmin. A new set of public API endpoints, used\\nby BlazorAdmin and configured to use token-based\", \" authentication, is defined in the PublicApi project.\\nAnd certain shared types used by both of these\", \" projects are kept in a new BlazorShared project.\\n\\n\\nOne might ask, why add a separate BlazorShared p\", \"roject when there is already a common\\nApplicationCore project that could be used to share any types \", \"required by both PublicApi and\\nBlazorAdmin? The answer is that this project includes all of the appl\", \"ication\\u2019s business logic and is thus\\nmuch larger than necessary and also much more likely to need to\", \" be kept secure on the server.\\nRemember that any library referenced by BlazorAdmin will be downloade\", \"d to users\\u2019 browsers when\\nthey load the Blazor application.\\n\\n\\n[Depending on whether one is using the\", \" Backends-For-Frontends (BFF) pattern, the APIs consumed by](https://docs.microsoft.com/azure/archit\", \"ecture/patterns/backends-for-frontends)\\nthe Blazor WebAssembly app may not share their types 100% wi\", \"th Blazor. In particular, a public API\\nthat\\u2019s meant to be consumed by many different clients may def\", \"ine its own request and result types,\\nrather than sharing them in a client-specific shared project. \", \"In the eShopOnWeb sample, the\\nassumption is being made that the PublicApi project is, in fact, hosti\", \"ng a public API, so not all of its\\nrequest and response types come from the BlazorShared project.\\n\\n#\", \"### **Cross-cutting concerns**\\n\\n\\nAs applications grow, it becomes increasingly important to factor o\", \"ut cross-cutting concerns to\\neliminate duplication and maintain consistency. Some examples of cross-\", \"cutting concerns in ASP.NET\\nCore applications are authentication, model validation rules, output cac\", \"hing, and error handling,\\n[though there are many others. ASP.NET Core MVC filters](https://docs.micr\", \"osoft.com/aspnet/core/mvc/controllers/filters) allow you to run code before or after certain\\nsteps i\", \"n the request processing pipeline. For instance, a filter can run before and after model binding,\\nbe\", \"fore and after an action, or before and after an action\\u2019s result. You can also use an authorization\\n\", \"filter to control access to the rest of the pipeline. Figures 7-2 shows how request execution flows\\n\", \"through filters, if configured.\\n\\n\\n54 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\n_Figure 7-2. Reques\", \"t execution through filters and request pipeline._\\n\\n\\nFilters are usually implemented as attributes, \", \"so you can apply them to controllers or actions (or even\\nglobally). When added in this fashion, filt\", \"ers specified at the action level override or build upon filters\\nspecified at the controller level, \", \"which themselves override global filters. For example, the [Route]\\nattribute can be used to build up\", \" routes between controllers and actions. Likewise, authorization can\\nbe configured at the controller\", \" level, and then overridden by individual actions, as the following\\nsample demonstrates:\\n\\n\\nThe first\", \" method, Login, uses the [AllowAnonymous] filter (attribute) to override the Authorize filter\\nset at\", \" the controller level. The ForgotPassword action (and any other action in the class that doesn\\u2019t\\nhav\", \"e an AllowAnonymous attribute) will require an authenticated request.\\n\\n\\nFilters can be used to elimi\", \"nate duplication in the form of common error handling policies for APIs.\\nFor example, a typical API \", \"policy is to return a NotFound response to requests referencing keys that\\ndo not exist, and a BadReq\", \"uest response if model validation fails. The following example\\ndemonstrates these two policies in ac\", \"tion:\\n\\n\\n55 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\nDon\\u2019t allow your action methods to become clu\", \"ttered with conditional code like this. Instead, pull the\\npolicies into filters that can be applied \", \"on an as-needed basis. In this example, the model validation\\ncheck, which should occur anytime a com\", \"mand is sent to the API, can be replaced by the following\\nattribute:\\n\\n\\nYou can add the ValidateModel\", \"Attribute to your project as a NuGet dependency by including the\\n[Ardalis.ValidateModel](https://www\", \".nuget.org/packages/Ardalis.ValidateModel) package. For APIs, you can use the ApiController attribut\", \"e to enforce this\\nbehavior without the need for a separate ValidateModel filter.\\n\\n\\nLikewise, a filte\", \"r can be used to check if a record exists and return a 404 before the action is executed,\\neliminatin\", \"g the need to perform these checks in the action. Once you\\u2019ve pulled out common\\nconventions and orga\", \"nized your solution to separate infrastructure code and business logic from your\\nUI, your MVC action\", \" methods should be extremely thin:\\n\\n\\nYou can read more about implementing filters and download a wor\", \"king sample from the MSDN\\n[Magazine article, Real-World ASP.NET Core MVC Filters.](https://docs.micr\", \"osoft.com/archive/msdn-magazine/2016/august/asp-net-core-real-world-asp-net-core-mvc-filters)\\n\\n\\nIf y\", \"ou find that you have a number of common responses from APIs based on common scenarios like\\nvalidati\", \"on errors (Bad Request), resource not found, and server errors, you might consider using a\\n_result_ \", \"abstraction. The result abstraction would be returned by services consumed by API endpoints,\\nand the\", \" controller action or endpoint would use a filter to translate these into IActionResults.\\n\\n\\n56 CHAPT\", \"ER 6 | Develop ASP.NET Core MVC apps\\n\\n\\n#### **References \\u2013 Structuring applications**\\n\\n\\n  - **Areas*\", \"*\\n[https://learn.microsoft.com/aspnet/core/mvc/controllers/areas](https://docs.microsoft.com/aspnet/\", \"core/mvc/controllers/areas)\\n\\n  - **MSDN Magazine \\u2013 Feature Slices for ASP.NET Core MVC**\\n[https://le\", \"arn.microsoft.com/archive/msdn-magazine/2016/september/asp-net-core-feature-](https://docs.microsoft\", \".com/archive/msdn-magazine/2016/september/asp-net-core-feature-slices-for-asp-net-core-mvc)\\n[slices-\", \"for-asp-net-core-mvc](https://docs.microsoft.com/archive/msdn-magazine/2016/september/asp-net-core-f\", \"eature-slices-for-asp-net-core-mvc)\\n\\n  - **Filters**\\n[https://learn.microsoft.com/aspnet/core/mvc/co\", \"ntrollers/filters](https://docs.microsoft.com/aspnet/core/mvc/controllers/filters)\\n\\n  - **MSDN Magaz\", \"ine \\u2013 Real World ASP.NET Core MVC Filters**\\n[https://learn.microsoft.com/archive/msdn-magazine/2016/\", \"august/asp-net-core-real-world-](https://docs.microsoft.com/archive/msdn-magazine/2016/august/asp-ne\", \"t-core-real-world-asp-net-core-mvc-filters)\\n[asp-net-core-mvc-filters](https://docs.microsoft.com/ar\", \"chive/msdn-magazine/2016/august/asp-net-core-real-world-asp-net-core-mvc-filters)\\n\\n  - **Result in e\", \"ShopOnWeb**\\n[https://github.com/dotnet-architecture/eShopOnWeb/wiki/Patterns#result](https://github.\", \"com/dotnet-architecture/eShopOnWeb/wiki/Patterns#result)\\n\\n### Security\\n\\n\\nSecuring web applications i\", \"s a large topic, with many considerations. At its most basic level, security\\ninvolves ensuring you k\", \"now who a given request is coming from, and then ensuring that the request\\nonly has access to resour\", \"ces it should. Authentication is the process of comparing credentials\\nprovided with a request to tho\", \"se in a trusted data store, to see if the request should be treated as\\ncoming from a known entity. A\", \"uthorization is the process of restricting access to certain resources\\nbased on user identity. A thi\", \"rd security concern is protecting requests from eavesdropping by third\\n[parties, for which you shoul\", \"d at least ensure that SSL is used by your application.](https://docs.microsoft.com/aspnet/core/secu\", \"rity/enforcing-ssl)\\n\\n#### **Identity**\\n\\n\\nASP.NET Core Identity is a membership system you can use to\", \" support login functionality for your\\napplication. It has support for local user accounts as well as\", \" external login provider support from\\nproviders like Microsoft Account, Twitter, Facebook, Google, a\", \"nd more. In addition to ASP.NET Core\\nIdentity, your application can use windows authentication, or a\", \" third-party identity provider like\\n[Identity Server.](https://github.com/IdentityServer/IdentitySer\", \"ver4)\\n\\n\\nASP.NET Core Identity is included in new project templates if the Individual User Accounts o\", \"ption is\\nselected. This template includes support for registration, login, external logins, forgotte\", \"n passwords,\\nand additional functionality.\\n\\n\\n57 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\n_Figure \", \"7-3. Select Individual User Accounts to have Identity preconfigured._\\n\\n\\nIdentity support is configur\", \"ed in _Program.cs_ or Startup, and includes configuring services as well as\\nmiddleware.\\n\\n\\n**Configur\", \"e Identity in** _**Program.cs**_\\n\\n\\nIn _Program.cs_, you configure services from the WebHostBuilder i\", \"nstance, and then once the app is\\ncreated, you configure its middleware. The key points to note are \", \"the call to AddDefaultIdentity for\\nrequired services and the UseAuthentication and UseAuthorization \", \"calls which add required\\nmiddleware.\\n\\n\\n58 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\n**Configuring \", \"Identity in app startup**\\n\\n\\nIt\\u2019s important that UseAuthentication and UseAuthorization appear before\", \" MapRazorPages. When\\nconfiguring Identity services, you\\u2019ll notice a call to AddDefaultTokenProviders\", \". This has nothing to do\\nwith tokens that may be used to secure web communications, but instead refe\", \"rs to providers that\\ncreate prompts that can be sent to users via SMS or email in order for them to \", \"confirm their identity.\\n\\n\\n59 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\n[You can learn more about c\", \"onfiguring two-factor authentication](https://docs.microsoft.com/aspnet/core/security/authentication\", \"/2fa) [and enabling external login providers](https://docs.microsoft.com/aspnet/core/security/authen\", \"tication/social/)\\nfrom the official ASP.NET Core docs.\\n\\n#### **Authentication**\\n\\n\\nAuthentication is \", \"the process of determining who is accessing the system. If you\\u2019re using ASP.NET\\nCore Identity and th\", \"e configuration methods shown in the previous section, it will automatically\\nconfigure some authenti\", \"cation defaults in the application. However, you can also configure these\\ndefaults manually, or over\", \"ride the ones set by AddIdentity. If you\\u2019re using Identity, it configures\\ncookie-based authenticatio\", \"n as the default _scheme_ .\\n\\n\\nIn web-based authentication, there are typically up to five actions th\", \"at may be performed in the\\ncourse of authenticating a client of a system. These are:\\n\\n\\n  - Authentic\", \"ate. Use the information provided by the client to create an identity for them to use\\nwithin the app\", \"lication.\\n\\n  - Challenge. This action is used to require the client to identify themselves.\\n\\n  - For\", \"bid. Inform the client they are forbidden from performing an action.\\n\\n  - Sign-in. Persist the exist\", \"ing client in some way.\\n\\n  - Sign-out. Remove the client from persistence.\\n\\nThere are a number of co\", \"mmon techniques for performing authentication in web applications. These\\nare referred to as schemes.\", \" A given scheme will define actions for some or all of the above options.\\nSome schemes only support \", \"a subset of actions, and may require a separate scheme to perform those\\nit does not support. For exa\", \"mple, the OpenId-Connect (OIDC) scheme doesn\\u2019t support Sign-in or\\nSign-out, but is commonly configur\", \"ed to use Cookie authentication for this persistence.\\n\\n\\nIn your ASP.NET Core application, you can co\", \"nfigure a DefaultAuthenticateScheme as well as optional\\nspecific schemes for each of the actions des\", \"cribed above. For example, DefaultChallengeScheme,\\n[DefaultForbidScheme, etc. Calling AddIdentity<TU\", \"ser,TRole> configures a number of aspects of the](https://github.com/dotnet/aspnetcore/blob/release/\", \"3.1/src/Identity/Core/src/IdentityServiceCollectionExtensions.cs#L38-L102)\\napplication and adds many\", \" required services. It also includes this call to configure the authentication\\nscheme:\\n\\n\\nThese schem\", \"es use cookies for persistence and redirection to login pages for authentication by\\ndefault. These s\", \"chemes are appropriate for web applications that interact with users via web browsers,\\nbut not recom\", \"mended for APIs. Instead, APIs will typically use another form of authentication, such as\\nJWT bearer\", \" tokens.\\n\\n\\nWeb APIs are consumed by code, such as HttpClient in .NET applications and equivalent typ\", \"es in other\\nframeworks. These clients expect a usable response from an API call, or a status code in\", \"dicating what,\\nif any, problem has occurred. These clients are not interacting through a browser and\", \" do not render or\\ninteract with any HTML that an API might return. Thus, it is not appropriate for A\", \"PI endpoints to\\nredirect their clients to login pages if they are not authenticated. Another scheme \", \"is more appropriate.\\n\\n\\n60 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\nTo configure authentication fo\", \"r APIs, you might set up authentication like the following, used by the\\nPublicApi project in the eSh\", \"opOnWeb reference application:\\n\\n\\nWhile it is possible to configure multiple different authentication\", \" schemes within a single project, it is\\nmuch simpler to configure a single default scheme. For this \", \"reason, among others, the eShopOnWeb\\nreference application separates its APIs into their own project\", \", PublicApi, separate from the main Web\\nproject that includes the application\\u2019s views and Razor Page\", \"s.\\n\\n\\n**Authentication in Blazor apps**\\n\\n\\nBlazor Server applications can leverage the same authentica\", \"tion features as any other ASP.NET Core\\napplication. Blazor WebAssembly applications cannot use the \", \"built-in Identity and Authentication\\nproviders, however, since they run in the browser. Blazor WebAs\", \"sembly applications can store user\\nauthentication status locally and can access claims to determine \", \"what actions users should be able to\\nperform. However, all authentication and authorization checks s\", \"hould be performed on the server\\nregardless of any logic implemented inside the Blazor WebAssembly a\", \"pp, since users can easily\\nbypass the app and interact with the APIs directly.\\n\\n#### **References \\u2013 \", \"Authentication**\\n\\n\\n  - **Authentication Actions and Defaults**\\n[https://stackoverflow.com/a/52493428\", \"](https://stackoverflow.com/a/52493428)\\n\\n  - **Authentication and Authorization for SPAs**\\n[https://\", \"learn.microsoft.com/aspnet/core/security/authentication/identity-api-authorization](https://docs.mic\", \"rosoft.com/aspnet/core/security/authentication/identity-api-authorization)\\n\\n  - **ASP.NET Core Blazo\", \"r Authentication and Authorization**\\n[https://learn.microsoft.com/aspnet/core/blazor/security/](http\", \"s://docs.microsoft.com/aspnet/core/blazor/security/)\\n\\n  - **Security: Authentication and Authorizati\", \"on in ASP.NET Web Forms and Blazor**\\n[https://learn.microsoft.com/dotnet/architecture/blazor-for-web\", \"-forms-developers/security-](https://docs.microsoft.com/en-us/dotnet/architecture/blazor-for-web-for\", \"ms-developers/security-authentication-authorization)\\n[authentication-authorization](https://docs.mic\", \"rosoft.com/en-us/dotnet/architecture/blazor-for-web-forms-developers/security-authentication-authori\", \"zation)\\n\\n#### **Authorization**\\n\\n\\nThe simplest form of authorization involves restricting access to \", \"anonymous users. This functionality\\ncan be achieved by applying the [Authorize] attribute to certain\", \" controllers or actions. If roles are\\n\\n\\n61 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\nbeing used, t\", \"he attribute can be further extended to restrict access to users who belong to certain\\nroles, as sho\", \"wn:\\n\\n\\nIn this case, users belonging to either the HRManager or Finance roles (or both) would have ac\", \"cess to\\nthe SalaryController. To require that a user belong to multiple roles (not just one of sever\", \"al), you can\\napply the attribute multiple times, specifying a required role each time.\\n\\n\\nSpecifying \", \"certain sets of roles as strings in many different controllers and actions can lead to\\nundesirable r\", \"epetition. At a minimum, define constants for these string literals and use the constants\\nanywhere y\", \"ou need to specify the string. You can also configure authorization policies, which\\nencapsulate auth\", \"orization rules, and then specify the policy instead of individual roles when applying\\nthe [Authoriz\", \"e] attribute:\\n\\n\\nUsing policies in this way, you can separate the kinds of actions being restricted f\", \"rom the specific roles\\nor rules that apply to it. Later, if you create a new role that needs to have\", \" access to certain resources,\\nyou can just update a policy, rather than updating every list of roles\", \" on every [Authorize] attribute.\\n\\n\\n**Claims**\\n\\n\\nClaims are name value pairs that represent propertie\", \"s of an authenticated user. For example, you\\nmight store users\\u2019 employee number as a claim. Claims c\", \"an then be used as part of authorization\\npolicies. You could create a policy called \\u201cEmployeeOnly\\u201d t\", \"hat requires the existence of a claim called\\n\\\"EmployeeNumber\\\", as shown in this example:\\n\\n\\nThis poli\", \"cy could then be used with the [Authorize] attribute to protect any controller and/or action,\\nas des\", \"cribed above.\\n\\n\\n**Securing web APIs**\\n\\n\\nMost web APIs should implement a token-based authentication \", \"system. Token authentication is\\nstateless and designed to be scalable. In a token-based authenticati\", \"on system, the client must first\\nauthenticate with the authentication provider. If successful, the c\", \"lient is issued a token, which is simply\\n\\n\\n62 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\na cryptogr\", \"aphically meaningful string of characters. The most common format for tokens is JSON Web\\nToken, or J\", \"WT (often pronounced \\u201cjot\\u201d). When the client then needs to issue a request to an API, it\\nadds this t\", \"oken as a header on the request. The server then validates the token found in the request\\nheader bef\", \"ore completing the request. Figure 7-4 demonstrates this process.\\n\\n\\n_Figure 7-4. Token-based authent\", \"ication for Web APIs._\\n\\n\\nYou can create your own authentication service, integrate with Azure AD and\", \" OAuth, or implement a\\n[service using an open-source tool like IdentityServer.](https://github.com/I\", \"dentityServer)\\n\\n\\nJWT tokens can embed claims about the user, which can be read on the client or serv\", \"er. You can use a\\n[tool like jwt.io](https://jwt.io/) to view the contents of a JWT token. Do not st\", \"ore sensitive data like passwords or keys\\nin JTW tokens, since their contents are easily read.\\n\\n\\nWhe\", \"n using JWT tokens with SPA or Blazor WebAssembly applications, you must store the token\\nsomewhere o\", \"n the client and then add it to every API call. This activity is typically done as a header, as\\nthe \", \"following code demonstrates:\\n\\n\\nAfter calling the above method, requests made with the _httpClient wi\", \"ll have the token embedded in\\nthe request\\u2019s headers, allowing the server-side API to authenticate an\", \"d authorize the request.\\n\\n\\n63 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\n**Custom Security**\\n\\n\\n\\n\\n\\n\\n\", \"\\nBe especially careful about \\u201crolling your own\\u201d implementation of cryptography, user membership, or\\n\", \"token generation system. There are many commercial and open-source alternatives available, which\\nwil\", \"l almost certainly have better security than a custom implementation.\\n\\n#### **References \\u2013 Security*\", \"*\\n\\n\\n  - **Security Docs Overview**\\n[https://learn.microsoft.com/aspnet/core/security/](https://docs.\", \"microsoft.com/aspnet/core/security/)\\n\\n  - **Enforcing SSL in an ASP.NET Core App**\\n[https://learn.mi\", \"crosoft.com/aspnet/core/security/enforcing-ssl](https://docs.microsoft.com/aspnet/core/security/enfo\", \"rcing-ssl)\\n\\n  - **Introduction to Identity**\\n[https://learn.microsoft.com/aspnet/core/security/authe\", \"ntication/identity](https://docs.microsoft.com/aspnet/core/security/authentication/identity)\\n\\n  - **\", \"Introduction to Authorization**\\n[https://learn.microsoft.com/aspnet/core/security/authorization/intr\", \"oduction](https://docs.microsoft.com/aspnet/core/security/authorization/introduction)\\n\\n  - **Authent\", \"ication and Authorization for API Apps in Azure App Service**\\n[https://learn.microsoft.com/azure/app\", \"-service-api/app-service-api-authentication](https://docs.microsoft.com/azure/app-service-api/app-se\", \"rvice-api-authentication)\\n\\n  - **Identity Server**\\n[https://github.com/IdentityServer](https://githu\", \"b.com/IdentityServer)\\n\\n### Client communication\\n\\n\\nIn addition to serving pages and responding to req\", \"uests for data via web APIs, ASP.NET Core apps can\\ncommunicate directly with connected clients. This\", \" outbound communication can use a variety of\\ntransport technologies, the most common being WebSocket\", \"s. ASP.NET Core SignalR is a library that\\nmakes it simple to add real-time server-to-client communic\", \"ation functionality to your applications.\\nSignalR supports a variety of transport technologies, incl\", \"uding WebSockets, and abstracts away many\\nof the implementation details from the developer.\\n\\n\\nReal-t\", \"ime client communication, whether using WebSockets directly or other techniques, are useful in\\na var\", \"iety of application scenarios. Some examples include:\\n\\n\\n  - Live chat room applications\\n\\n\\n  - Monito\", \"ring applications\\n\\n\\n  - Job progress updates\\n\\n\\n  - Notifications\\n\\n\\n  - Interactive forms application\", \"s\\n\\n\\nWhen building client communication into your applications, there are typically two components:\\n\\n\", \"\\n64 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\n  - Server-side connection manager (SignalR Hub, Web\", \"SocketManager WebSocketHandler)\\n\\n\\n  - Client-side library\\n\\n\\nClients aren\\u2019t limited to browsers \\u2013 mob\", \"ile apps, console apps, and other native apps can also\\ncommunicate using SignalR/WebSockets. The fol\", \"lowing simple program echoes all content sent to a\\nchat application to the console, as part of a Web\", \"SocketManager sample application:\\n\\n\\nConsider ways in which your applications communicate directly wi\", \"th client applications, and consider\\nwhether real-time communication would improve your app\\u2019s user e\", \"xperience.\\n\\n#### **References \\u2013 Client Communication**\\n\\n\\n  - **ASP.NET Core SignalR**\\n[https://githu\", \"b.com/dotnet/aspnetcore/tree/main/src/SignalR](https://github.com/dotnet/aspnetcore/tree/main/src/Si\", \"gnalR)\\n\\n  - **WebSocket Manager**\\n[https://github.com/radu-matei/websocket-manager](https://github.c\", \"om/radu-matei/websocket-manager)\\n\\n### Domain-driven design \\u2013 Should you apply it?\\n\\n\\nDomain-Driven De\", \"sign (DDD) is an agile approach to building software that emphasizes focusing on\\nthe _business domai\", \"n_ . It places a heavy emphasis on communication and interaction with business\\ndomain expert(s) who \", \"can relate to the developers how the real-world system works. For example, if\\nyou\\u2019re building a syst\", \"em that handles stock trades, your domain expert might be an experienced stock\\nbroker. DDD is design\", \"ed to address large, complex business problems, and is often not appropriate\\nfor smaller, simpler ap\", \"plications, as the investment in understanding and modeling the domain is not\\nworth it.\\n\\n\\n65 CHAPTER\", \" 6 | Develop ASP.NET Core MVC apps\\n\\n\\nWhen building software following a DDD approach, your team (inc\", \"luding non-technical stakeholders\\nand contributors) should develop a _ubiquitous language_ for the p\", \"roblem space. That is, the same\\nterminology should be used for the real-world concept being modeled,\", \" the software equivalent, and\\nany structures that might exist to persist the concept (for example, d\", \"atabase tables). Thus, the\\nconcepts described in the ubiquitous language should form the basis for y\", \"our _domain model_ .\\n\\n\\nYour domain model comprises objects that interact with one another to represe\", \"nt the behavior of the\\nsystem. These objects may fall into the following categories:\\n\\n\\n  - [Entities\", \", which represent objects with a thread of identity. Entities are typically stored in](https://deviq\", \".com/entity/)\\npersistence with a key by which they can later be retrieved.\\n\\n\\n  - [Aggregates, which \", \"represent groups of objects that should be persisted as a unit.](https://deviq.com/aggregate-pattern\", \"/)\\n\\n\\n  - [Value objects, which represent concepts that can be compared on the basis of the sum of](h\", \"ttps://deviq.com/value-object/)\\ntheir property values. For example, DateRange consisting of a start \", \"and end date.\\n\\n\\n  - [Domain events, which represent things happening within the system that are of i\", \"nterest to](https://martinfowler.com/eaaDev/DomainEvent.html)\\nother parts of the system.\\n\\n\\nA DDD dom\", \"ain model should encapsulate complex behavior within the model. Entities, in particular,\\nshould not \", \"merely be collections of properties. When the domain model lacks behavior and merely\\n[represents the\", \" state of the system, it is said to be an anemic model, which is undesirable in DDD.](https://deviq.\", \"com/anemic-model/)\\n\\n\\nIn addition to these model types, DDD typically employs a variety of patterns:\\n\", \"\\n\\n  - [Repository, for abstracting persistence details.](https://deviq.com/repository-pattern/)\\n\\n\\n  \", \"- [Factory, for encapsulating complex object creation.](https://en.wikipedia.org/wiki/Factory_method\", \"_pattern)\\n\\n\\n  - [Services, for encapsulating complex behavior and/or infrastructure implementation d\", \"etails.](http://gorodinski.com/blog/2012/04/14/services-in-domain-driven-design-ddd/)\\n\\n\\n  - [Command\", \", for decoupling issuing commands and executing the command itself.](https://en.wikipedia.org/wiki/C\", \"ommand_pattern)\\n\\n\\n  - [Specification, for encapsulating query details.](https://deviq.com/specificat\", \"ion-pattern/)\\n\\n\\nDDD also recommends the use of the Clean Architecture discussed previously, allowing\", \" for loose\\ncoupling, encapsulation, and code that can easily be verified using unit tests.\\n\\n#### **W\", \"hen should you apply DDD**\\n\\n\\nDDD is well suited to large applications with significant business (not\", \" just technical) complexity. The\\napplication should require the knowledge of domain experts. There s\", \"hould be significant behavior in\\nthe domain model itself, representing business rules and interactio\", \"ns beyond simply storing and\\nretrieving the current state of various records from data stores.\\n\\n####\", \" **When shouldn\\u2019t you apply DDD**\\n\\n\\nDDD involves investments in modeling, architecture, and communic\", \"ation that may not be warranted\\nfor smaller applications or applications that are essentially just C\", \"RUD (create/read/update/delete). If\\nyou choose to approach your application following DDD, but find \", \"that your domain has an anemic\\nmodel with no behavior, you may need to rethink your approach. Either\", \" your application may not\\n\\n\\n66 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\nneed DDD, or you may need\", \" assistance refactoring your application to encapsulate business logic in\\nthe domain model, rather t\", \"han in your database or user interface.\\n\\n\\nA hybrid approach would be to only use DDD for the transac\", \"tional or more complex areas of the\\napplication, but not for simpler CRUD or read-only portions of t\", \"he application. For instance, you don\\u2019t\\nneed the constraints of an Aggregate if you\\u2019re querying data\", \" to display a report or to visualize data\\nfor a dashboard. It\\u2019s perfectly acceptable to have a separ\", \"ate, simpler read model for such\\nrequirements.\\n\\n#### **References \\u2013 Domain-Driven Design**\\n\\n\\n  - **D\", \"DD in Plain English (StackOverflow Answer)**\\n[https://stackoverflow.com/questions/1222392/can-someon\", \"e-explain-domain-driven-design-](https://stackoverflow.com/questions/1222392/can-someone-explain-dom\", \"ain-driven-design-ddd-in-plain-english-please/1222488#1222488)\\n[ddd-in-plain-english-please/1222488#\", \"1222488](https://stackoverflow.com/questions/1222392/can-someone-explain-domain-driven-design-ddd-in\", \"-plain-english-please/1222488#1222488)\\n\\n### Deployment\\n\\n\\nThere are a few steps involved in the proce\", \"ss of deploying your ASP.NET Core application, regardless\\nof where it will be hosted. The first step\", \" is to publish the application, which can be done using the\\ndotnet publish CLI command. This step wi\", \"ll compile the application and place all of the files needed to\\nrun the application into a designate\", \"d folder. When you deploy from Visual Studio, this step is\\nperformed for you automatically. The publ\", \"ish folder contains .exe and .dll files for the application and\\nits dependencies. A self-contained a\", \"pplication will also include a version of the .NET runtime. ASP.NET\\nCore applications will also incl\", \"ude configuration files, static client assets, and MVC views.\\n\\n\\nASP.NET Core applications are consol\", \"e applications that must be started when the server boots and\\nrestarted if the application (or serve\", \"r) crashes. A process manager can be used to automate this\\nprocess. The most common process managers\", \" for ASP.NET Core are Nginx and Apache on Linux and\\nIIS or Windows Service on Windows.\\n\\n\\nIn addition\", \" to a process manager, ASP.NET Core applications may use a reverse proxy server. A\\nreverse proxy ser\", \"ver receives HTTP requests from the Internet and forwards them to Kestrel after\\nsome preliminary han\", \"dling. Reverse proxy servers provide a layer of security for the application.\\nKestrel also doesn\\u2019t s\", \"upport hosting multiple applications on the same port, so techniques like host\\nheaders cannot be use\", \"d with it to enable hosting multiple applications on the same port and IP\\naddress.\\n\\n\\n_Figure 7-5. AS\", \"P.NET hosted in Kestrel behind a reverse proxy server_\\n\\n\\nAnother scenario in which a reverse proxy c\", \"an be helpful is to secure multiple applications using\\nSSL/HTTPS. In this case, only the reverse pro\", \"xy would need to have SSL configured. Communication\\nbetween the reverse proxy server and Kestrel cou\", \"ld take place over HTTP, as shown in Figure 7-6.\\n\\n\\n67 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\n_F\", \"igure 7-6. ASP.NET hosted behind an HTTPS-secured reverse proxy server_\\n\\n\\nAn increasingly popular ap\", \"proach is to host your ASP.NET Core application in a Docker container,\\nwhich then can be hosted loca\", \"lly or deployed to Azure for cloud-based hosting. The Docker container\\ncould contain your applicatio\", \"n code, running on Kestrel, and would be deployed behind a reverse\\nproxy server, as shown above.\\n\\n\\nI\", \"f you\\u2019re hosting your application on Azure, you can use Microsoft Azure Application Gateway as a\\nded\", \"icated virtual appliance to provide several services. In addition to acting as a reverse proxy for\\ni\", \"ndividual applications, Application Gateway can also offer the following features:\\n\\n\\n  - HTTP load b\", \"alancing\\n\\n\\n  - SSL offload (SSL only to Internet)\\n\\n\\n  - End to End SSL\\n\\n\\n  - Multi-site routing (con\", \"solidate up to 20 sites on a single Application Gateway)\\n\\n\\n  - Web application firewall\\n\\n\\n  - Websoc\", \"ket support\\n\\n\\n  - Advanced diagnostics\\n\\n\\n_Learn more about Azure deployment options in Chapter 10._\\n\", \"\\n#### **References \\u2013 Deployment**\\n\\n\\n  - **Hosting and Deployment Overview**\\n[https://learn.microsoft\", \".com/aspnet/core/publishing/](https://docs.microsoft.com/aspnet/core/publishing/)\\n\\n  - **When to use\", \" Kestrel with a reverse proxy**\\n[https://learn.microsoft.com/aspnet/core/fundamentals/servers/kestre\", \"l#when-to-use-kestrel-](https://docs.microsoft.com/aspnet/core/fundamentals/servers/kestrel#when-to-\", \"use-kestrel-with-a-reverse-proxy)\\n[with-a-reverse-proxy](https://docs.microsoft.com/aspnet/core/fund\", \"amentals/servers/kestrel#when-to-use-kestrel-with-a-reverse-proxy)\\n\\n  - **Host ASP.NET Core apps in \", \"Docker**\\n[https://learn.microsoft.com/aspnet/core/publishing/docker](https://docs.microsoft.com/aspn\", \"et/core/publishing/docker)\\n\\n  - **Introducing Azure Application Gateway**\\n[https://learn.microsoft.c\", \"om/azure/application-gateway/application-gateway-introduction](https://docs.microsoft.com/azure/appl\", \"ication-gateway/application-gateway-introduction)\\n\\n\\n68 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\n*\", \"*CHAPTER**\\n# 7\\n\\n## Working with Data in ASP.NET Core Apps\\n\\n\\n\\u201cData is a precious thing and will last \", \"longer than the systems themselves.\\u201d\\n\\n\\nTim Berners-Lee\\n\\n\\nData access is an important part of almost \", \"any software application. ASP.NET Core supports various\\ndata access options, including Entity Framew\", \"ork Core (and Entity Framework 6 as well), and can work\\nwith any .NET data access framework. The cho\", \"ice of which data access framework to use depends on\\nthe application\\u2019s needs. Abstracting these choi\", \"ces from the ApplicationCore and UI projects, and\\nencapsulating implementation details in Infrastruc\", \"ture, helps to produce loosely coupled, testable\\nsoftware.\\n\\n### Entity Framework Core (for relationa\", \"l databases)\\n\\n\\nIf you\\u2019re writing a new ASP.NET Core application that needs to work with relational d\", \"ata, then Entity\\nFramework Core (EF Core) is the recommended way for your application to access its \", \"data. EF Core is\\nan object-relational mapper (O/RM) that enables .NET developers to persist objects \", \"to and from a\\ndata source. It eliminates the need for most of the data access code developers would \", \"typically need\\nto write. Like ASP.NET Core, EF Core has been rewritten from the ground up to support\", \" modular\\ncross-platform applications. You add it to your application as a NuGet package, configure i\", \"t during\\napp startup, and request it through dependency injection wherever you need it.\\n\\n\\nTo use EF \", \"Core with a SQL Server database, run the following dotnet CLI command:\\n\\n```\\ndotnet add package Micro\", \"soft.EntityFrameworkCore.SqlServer\\n\\n```\\n\\nTo add support for an InMemory data source, for testing:\\n\\n`\", \"``\\ndotnet add package Microsoft.EntityFrameworkCore.InMemory\\n\\n#### **The DbContext**\\n\\n```\\n\\n[To work \", \"with EF Core, you need a subclass of DbContext. This class holds properties representing](https://do\", \"cs.microsoft.com/dotnet/api/microsoft.entityframeworkcore.dbcontext)\\ncollections of the entities you\", \"r application will work with. The eShopOnWeb sample includes a\\nCatalogContext with collections for i\", \"tems, brands, and types:\\n\\n\\n69 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\nYour DbContext mu\", \"st have a constructor that accepts DbContextOptions and pass this argument to\\nthe base DbContext con\", \"structor. If you have only one DbContext in your application, you can pass an\\ninstance of DbContextO\", \"ptions, but if you have more than one you must use the generic\\nDbContextOptions<T> type, passing in \", \"your DbContext type as the generic parameter.\\n\\n#### **Configuring EF Core**\\n\\n\\nIn your ASP.NET Core a\", \"pplication, you\\u2019ll typically configure EF Core in _Program.cs_ with your\\napplication\\u2019s other depende\", \"ncies. EF Core uses a DbContextOptionsBuilder, which supports several\\nhelpful extension methods to s\", \"treamline its configuration. To configure CatalogContext to use a SQL\\nServer database with a connect\", \"ion string defined in Configuration, you would add the following code:\\n\\n\\nTo use the in-memory databa\", \"se:\\n\\n\\nOnce you have installed EF Core, created a DbContext child type, and added the type to the\\napp\", \"lication\\u2019s services, you are ready to use EF Core. You can request an instance of your DbContext\\ntyp\", \"e in any service that needs it and start working with your persisted entities using LINQ as if they\\n\", \"were simply in a collection. EF Core does the work of translating your LINQ expressions into SQL\\nque\", \"ries to store and retrieve your data.\\n\\n\\nYou can see the queries EF Core is executing by configuring \", \"a logger and ensuring its level is set to at\\nleast Information, as shown in Figure 8-1.\\n\\n\\n70 CHAPTER\", \" 7 | Working with Data in ASP.NET Core Apps\\n\\n\\n_Figure 8-1. Logging EF Core queries to the console_\\n\\n\", \"#### **Fetching and storing Data**\\n\\n\\nTo retrieve data from EF Core, you access the appropriate prope\", \"rty and use LINQ to filter the result.\\nYou can also use LINQ to perform projection, transforming the\", \" result from one type to another. The\\nfollowing example would retrieve CatalogBrands, ordered by nam\", \"e, filtered by their Enabled property,\\nand projected onto a SelectListItem type:\\n\\n\\nIt\\u2019s important in\", \" the above example to add the call to ToListAsync in order to execute the query\\nimmediately. Otherwi\", \"se, the statement will assign an IQueryable<SelectListItem> to brandItems,\\nwhich will not be execute\", \"d until it is enumerated. There are pros and cons to returning IQueryable\\nresults from methods. It a\", \"llows the query EF Core will construct to be further modified, but can also\\nresult in errors that on\", \"ly occur at run time, if operations are added to the query that EF Core cannot\\ntranslate. It\\u2019s gener\", \"ally safer to pass any filters into the method performing the data access, and return\\nback an in-mem\", \"ory collection (for example, List<T>) as the result.\\n\\n\\nEF Core tracks changes on entities it fetches\", \" from persistence. To save changes to a tracked entity, you\\njust call the SaveChangesAsync method on\", \" the DbContext, making sure it\\u2019s the same DbContext\\ninstance that was used to fetch the entity. Addi\", \"ng and removing entities is directly done on the\\nappropriate DbSet property, again with a call to Sa\", \"veChangesAsync to execute the database\\ncommands. The following example demonstrates adding, updating\", \", and removing entities from\\npersistence.\\n\\n\\n71 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\n\", \"EF Core supports both synchronous and async methods for fetching and saving. In web applications,\\nit\", \"\\u2019s recommended to use the async/await pattern with the async methods, so that web server threads\\nare\", \" not blocked while waiting for data access operations to complete.\\n\\n\\n[For more information, see Buff\", \"ering and Streaming.](https://docs.microsoft.com/ef/core/performance/efficient-querying#buffering-an\", \"d-streaming)\\n\\n#### **Fetching related data**\\n\\n\\nWhen EF Core retrieves entities, it populates all of \", \"the properties that are stored directly with that\\nentity in the database. Navigation properties, suc\", \"h as lists of related entities, are not populated and\\nmay have their value set to null. This process\", \" ensures EF Core is not fetching more data than is\\nneeded, which is especially important for web app\", \"lications, which must quickly process requests and\\nreturn responses in an efficient manner. To inclu\", \"de relationships with an entity using _eager loading_,\\nyou specify the property using the Include ex\", \"tension method on the query, as shown:\\n\\n\\nYou can include multiple relationships, and you can also in\", \"clude subrelationships using ThenInclude.\\nEF Core will execute a single query to retrieve the result\", \"ing set of entities. Alternately you can include\\nnavigation properties of navigation properties by p\", \"assing a \\u2018.\\u2019-separated string to the .Include()\\nextension method, like so:\\n\\n```\\n  .Include(\\\"Items.Pr\", \"oducts\\\")\\n\\n```\\n\\nIn addition to encapsulating filtering logic, a specification can specify the shape o\", \"f the data to be\\nreturned, including which properties to populate. The eShopOnWeb sample includes se\", \"veral\\nspecifications that demonstrate encapsulating eager loading information within the specificati\", \"on. You\\ncan see how the specification is used as part of a query here:\\n\\n\\n72 CHAPTER 7 | Working with\", \" Data in ASP.NET Core Apps\\n\\n\\nAnother option for loading related data is to use _explicit loading_ . \", \"Explicit loading allows you to load\\nadditional data into an entity that has already been retrieved. \", \"Since this approach involves a separate\\nrequest to the database, it\\u2019s not recommended for web applic\", \"ations, which should minimize the\\nnumber of database round trips made per request.\\n\\n\\n_Lazy loading_ \", \"is a feature that automatically loads related data as it is referenced by the application. EF\\nCore h\", \"as added support for lazy loading in version 2.1. Lazy loading is not enabled by default and\\nrequire\", \"s installing the Microsoft.EntityFrameworkCore.Proxies. As with explicit loading, lazy loading\\nshoul\", \"d typically be disabled for web applications, since its use will result in additional database\\nqueri\", \"es being made within each web request. Unfortunately, the overhead incurred by lazy loading\\noften go\", \"es unnoticed at development time, when the latency is small and often the data sets used for\\ntesting\", \" are small. However, in production, with more users, more data, and more latency, the\\nadditional dat\", \"abase requests can often result in poor performance for web applications that make\\nheavy use of lazy\", \" loading.\\n\\n\\n[Avoid Lazy Loading Entities in Web Applications](https://ardalis.com/avoid-lazy-loading\", \"-entities-in-asp-net-applications)\\n\\n\\nIt\\u2019s a good idea to test your application while examining the a\", \"ctual database queries it makes. Under\\ncertain circumstances, EF Core may make many more queries or \", \"a more expensive query than is\\n[optimal for the application. One such problem is known as a Cartesia\", \"n Explosion. The EF Core team](https://docs.microsoft.com/ef/core/querying/single-split-queries#cart\", \"esian-explosion)\\n[makes available the AsSplitQuery method as one of several ways to tune runtime beh\", \"avior.](https://docs.microsoft.com/ef/core/querying/single-split-queries#split-queries)\\n\\n#### **Enca\", \"psulating data**\\n\\n\\nEF Core supports several features that allow your model to properly encapsulate i\", \"ts state. A common\\nproblem in domain models is that they expose collection navigation properties as \", \"publicly accessible\\nlist types. This problem allows any collaborator to manipulate the contents of t\", \"hese collection types,\\nwhich may bypass important business rules related to the collection, possibly\", \" leaving the object in an\\ninvalid state. The solution to this problem is to expose read-only access \", \"to related collections, and\\nexplicitly provide methods defining ways in which clients can manipulate\", \" them, as in this example:\\n\\n\\n73 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\nThis entity typ\", \"e doesn\\u2019t expose a public List or ICollection property, but instead exposes an\\nIReadOnlyCollection t\", \"ype that wraps the underlying List type. When using this pattern, you can\\nindicate to Entity Framewo\", \"rk Core to use the backing field like so:\\n\\n\\nAnother way in which you can improve your domain model i\", \"s by using value objects for types that\\nlack identity and are only distinguished by their properties\", \". Using such types as properties of your\\nentities can help keep logic specific to the value object w\", \"here it belongs, and can avoid duplicate logic\\nbetween multiple entities that use the same concept. \", \"In Entity Framework Core, you can persist value\\nobjects in the same table as their owning entity by \", \"configuring the type as an owned entity, like so:\\n\\n\\nIn this example, the ShipToAddress property is o\", \"f type Address. Address is a value object with several\\nproperties such as Street and City. EF Core m\", \"aps the Order object to its table with one column per\\nAddress property, prefixing each column name w\", \"ith the name of the property. In this example, the\\nOrder table would include columns such as ShipToA\", \"ddress_Street and ShipToAddress_City. It\\u2019s also\\npossible to store owned types in separate tables, if\", \" desired.\\n\\n\\n[Learn more about owned entity support in EF Core.](https://docs.microsoft.com/ef/core/m\", \"odeling/owned-entities)\\n\\n#### **Resilient connections**\\n\\n\\nExternal resources like SQL databases may \", \"occasionally be unavailable. In cases of temporary\\nunavailability, applications can use retry logic \", \"to avoid raising an exception. This technique is\\ncommonly referred to as _connection resiliency_ [. \", \"You can implement your own retry with exponential](https://docs.microsoft.com/azure/architecture/pat\", \"terns/retry)\\n[backoff](https://docs.microsoft.com/azure/architecture/patterns/retry) technique by at\", \"tempting to retry with an exponentially increasing wait time, until a maximum\\nretry count has been r\", \"eached. This technique embraces the fact that cloud resources might\\nintermittently be unavailable fo\", \"r short periods of time, resulting in the failure of some requests.\\n\\n\\nFor Azure SQL DB, Entity Frame\", \"work Core already provides internal database connection resiliency\\nand retry logic. But you need to \", \"enable the Entity Framework execution strategy for each DbContext\\nconnection if you want to have res\", \"ilient EF Core connections.\\n\\n\\nFor instance, the following code at the EF Core connection level enabl\", \"es resilient SQL connections that\\nare retried if the connection fails.\\n\\n\\n74 CHAPTER 7 | Working with\", \" Data in ASP.NET Core Apps\\n\\n\\n**Execution strategies and explicit transactions using BeginTransaction\", \" and multiple**\\n**DbContexts**\\n\\n\\nWhen retries are enabled in EF Core connections, each operation you\", \" perform using EF Core becomes\\nits own retryable operation. Each query and each call to SaveChangesA\", \"sync will be retried as a unit if a\\ntransient failure occurs.\\n\\n\\nHowever, if your code initiates a tr\", \"ansaction using BeginTransaction, you are defining your own group\\nof operations that need to be trea\", \"ted as a unit; everything inside the transaction has to be rolled back\\nif a failure occurs. You will\", \" see an exception like the following if you attempt to execute that\\ntransaction when using an EF exe\", \"cution strategy (retry policy) and you include several\\nSaveChangesAsync from multiple DbContexts in \", \"it.\\n\\n\\nSystem.InvalidOperationException: The configured execution strategy\\nSqlServerRetryingExecution\", \"Strategy does not support user initiated transactions. Use the execution\\nstrategy returned by DbCont\", \"ext.Database.CreateExecutionStrategy() to execute all the operations in\\nthe transaction as a retryab\", \"le unit.\\n\\n\\nThe solution is to manually invoke the EF execution strategy with a delegate representing\", \" everything\\nthat needs to be executed. If a transient failure occurs, the execution strategy will in\", \"voke the delegate\\nagain. The following code shows how to implement this approach:\\n\\n\\nThe first DbCont\", \"ext is the _catalogContext and the second DbContext is within the\\n_integrationEventLogService object\", \". Finally, the Commit action would be performed multiple\\nDbContexts and using an EF Execution Strate\", \"gy.\\n\\n\\n75 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\n#### **References \\u2013 Entity Framework C\", \"ore**\\n\\n\\n  - **EF Core Docs** [https://learn.microsoft.com/ef/](https://docs.microsoft.com/ef/)\\n\\n  - \", \"**EF Core: Related Data** [https://learn.microsoft.com/ef/core/querying/related-data](https://docs.m\", \"icrosoft.com/ef/core/querying/related-data)\\n\\n  - **Avoid Lazy Loading Entities in ASPNET Application\", \"s** [https://ardalis.com/avoid-lazy-](https://ardalis.com/avoid-lazy-loading-entities-in-asp-net-app\", \"lications)\\n[loading-entities-in-asp-net-applications](https://ardalis.com/avoid-lazy-loading-entitie\", \"s-in-asp-net-applications)\\n\\n### EF Core or micro-ORM?\\n\\n\\nWhile EF Core is a great choice for managing\", \" persistence, and for the most part encapsulates\\ndatabase details from application developers, it is\", \"n\\u2019t the only choice. Another popular open-source\\n[alternative is Dapper, a so-called micro-ORM. A mi\", \"cro-ORM is a lightweight, less full-featured tool for](https://github.com/StackExchange/Dapper)\\nmapp\", \"ing objects to data structures. In the case of Dapper, its design goals focus on performance,\\nrather\", \" than fully encapsulating the underlying queries it uses to retrieve and update data. Because it\\ndoe\", \"sn\\u2019t abstract SQL from the developer, Dapper is \\u201ccloser to the metal\\u201d and lets developers write the\\n\", \"exact queries they want to use for a given data access operation.\\n\\n\\nEF Core has two significant feat\", \"ures it provides which separate it from Dapper but also add to its\\nperformance overhead. The first i\", \"s the translation from LINQ expressions into SQL. These translations\\nare cached, but even so there i\", \"s overhead in performing them the first time. The second is change\\ntracking on entities (so that eff\", \"icient update statements can be generated). This behavior can be\\n[turned off for specific queries by\", \" using the AsNoTracking](https://docs.microsoft.com/dotnet/api/system.data.entity.dbextensions.asnot\", \"racking) extension. EF Core also generates SQL\\nqueries that usually are very efficient and in any ca\", \"se perfectly acceptable from a performance\\nstandpoint, but if you need fine control over the precise\", \" query to be executed, you can pass in custom\\nSQL (or execute a stored procedure) using EF Core, too\", \". In this case, Dapper still outperforms EF Core,\\nbut only very slightly. Current performance benchm\", \"ark data for a variety of data access methods can\\n[be found on the Dapper site.](https://github.com/\", \"StackExchange/Dapper)\\n\\n\\nTo see how the syntax for Dapper varies from EF Core, consider these two ver\", \"sions of the same\\nmethod for retrieving a list of items:\\n\\n\\nIf you need to build more complex object \", \"graphs with Dapper, you need to write the associated\\nqueries yourself (as opposed to adding an Inclu\", \"de as you would in EF Core). This functionality is\\nsupported through various syntaxes, including a f\", \"eature called Multi Mapping that lets you map\\nindividual rows to multiple mapped objects. For exampl\", \"e, given a class Post with a property Owner of\\ntype User, the following SQL would return all of the \", \"necessary data:\\n\\n\\n76 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\nEach returned row includes\", \" both User and Post data. Since the User data should be attached to the\\nPost data via its Owner prop\", \"erty, the following function is used:\\n\\n```\\n(post, user) => { post.Owner = user; return post; }\\n\\n```\\n\", \"\\nThe full code listing to return a collection of posts with their Owner property populated with the\\n\", \"associated user data would be:\\n\\n\\nBecause it offers less encapsulation, Dapper requires developers kn\", \"ow more about how their data is\\nstored, how to query it efficiently, and write more code to fetch it\", \". When the model changes, instead\\nof simply creating a new migration (another EF Core feature), and/\", \"or updating mapping information\\nin one place in a DbContext, every query that is impacted must be up\", \"dated. These queries have no\\ncompile-time guarantees, so they may break at run time in response to c\", \"hanges to the model or\\ndatabase, making errors more difficult to detect quickly. In exchange for the\", \"se tradeoffs, Dapper\\noffers extremely fast performance.\\n\\n\\nFor most applications, and most parts of a\", \"lmost all applications, EF Core offers acceptable\\nperformance. Thus, its developer productivity bene\", \"fits are likely to outweigh its performance\\noverhead. For queries that can benefit from caching, the\", \" actual query may only be executed a tiny\\npercentage of the time, making relatively small query perf\", \"ormance differences moot.\\n\\n### SQL or NoSQL\\n\\n\\nTraditionally, relational databases like SQL Server ha\", \"ve dominated the marketplace for persistent data\\n[storage, but they are not the only solution availa\", \"ble. NoSQL databases like MongoDB offer a different](https://www.mongodb.com/what-is-mongodb)\\napproa\", \"ch to storing objects. Rather than mapping objects to tables and rows, another option is to\\nserializ\", \"e the entire object graph, and store the result. The benefits of this approach, at least initially,\\n\", \"are simplicity and performance. It\\u2019s simpler to store a single serialized object with a key than to\\n\", \"decompose the object into many tables with relationships and update rows that may have changed\\nsince\", \" the object was last retrieved from the database. Likewise, fetching and deserializing a single\\nobje\", \"ct from a key-based store is typically much faster and easier than complex joins or multiple\\ndatabas\", \"e queries required to fully compose the same object from a relational database. The lack of\\nlocks or\", \" transactions or a fixed schema also makes NoSQL databases amenable to scaling across many\\nmachines,\", \" supporting very large datasets.\\n\\n\\nOn the other hand, NoSQL databases (as they are typically called)\", \" have their drawbacks. Relational\\ndatabases use normalization to enforce consistency and avoid dupli\", \"cation of data. This approach\\nreduces the total size of the database and ensures that updates to sha\", \"red data are available\\nimmediately throughout the database. In a relational database, an Address tab\", \"le might reference a\\n\\n\\n77 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\nCountry table by ID, \", \"such that if the name of a country/region were changed, the address records\\nwould benefit from the u\", \"pdate without themselves having to be updated. However, in a NoSQL\\ndatabase, Address, and its associ\", \"ated Country might be serialized as part of many stored objects. An\\nupdate to a country/region name \", \"would require all such objects to be updated, rather than a single\\nrow. Relational databases can als\", \"o ensure relational integrity by enforcing rules like foreign keys.\\nNoSQL databases typically do not\", \" offer such constraints on their data.\\n\\n\\nAnother complexity NoSQL databases must deal with is versio\", \"ning. When an object\\u2019s properties\\nchange, it may not be able to be deserialized from past versions t\", \"hat were stored. Thus, all existing\\nobjects that have a serialized (previous) version of the object \", \"must be updated to conform to its new\\nschema. This approach is not conceptually different from a rel\", \"ational database, where schema\\nchanges sometimes require update scripts or mapping updates. However,\", \" the number of entries that\\nmust be modified is often much greater in the NoSQL approach, because th\", \"ere is more duplication of\\ndata.\\n\\n\\nIt\\u2019s possible in NoSQL databases to store multiple versions of ob\", \"jects, something fixed schema\\nrelational databases typically do not support. However, in this case, \", \"your application code will need to\\naccount for the existence of previous versions of objects, adding\", \" additional complexity.\\n\\n\\n[NoSQL databases typically do not enforce ACID, which means they have both\", \" performance and](https://en.wikipedia.org/wiki/ACID)\\nscalability benefits over relational databases\", \". They\\u2019re well suited to extremely large datasets and\\nobjects that are not well suited to storage in\", \" normalized table structures. There is no reason why a\\nsingle application cannot take advantage of b\", \"oth relational and NoSQL databases, using each where it\\nis best suited.\\n\\n### Azure Cosmos DB\\n\\n\\nAzure\", \" Cosmos DB is a fully managed NoSQL database service that offers cloud-based schema-free\\ndata storag\", \"e. Azure Cosmos DB is built for fast and predictable performance, high availability, elastic\\nscaling\", \", and global distribution. Despite being a NoSQL database, developers can use rich and familiar\\nSQL \", \"query capabilities on JSON data. All resources in Azure Cosmos DB are stored as JSON\\ndocuments. Reso\", \"urces are managed as _items_, which are documents containing metadata, and _feeds_,\\nwhich are collec\", \"tions of items. Figure 8-2 shows the relationship between different Azure Cosmos DB\\nresources.\\n\\n\\n78 \", \"CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\n_Figure 8-2. Azure Cosmos DB resource organizat\", \"ion._\\n\\n\\nThe Azure Cosmos DB query language is a simple yet powerful interface for querying JSON\\ndocu\", \"ments. The language supports a subset of ANSI SQL grammar and adds deep integration of\\nJavaScript ob\", \"ject, arrays, object construction, and function invocation.\\n\\n\\n**References \\u2013 Azure Cosmos DB**\\n\\n\\n  -\", \" [Azure Cosmos DB Introduction https://learn.microsoft.com/azure/cosmos-db/introduction](https://doc\", \"s.microsoft.com/azure/cosmos-db/introduction)\\n\\n### Other persistence options\\n\\n\\nIn addition to relati\", \"onal and NoSQL storage options, ASP.NET Core applications can use Azure\\nStorage to store various dat\", \"a formats and files in a cloud-based, scalable fashion. Azure Storage is\\nmassively scalable, so you \", \"can start out storing small amounts of data and scale up to storing\\nhundreds or terabytes if your ap\", \"plication requires it. Azure Storage supports four kinds of data:\\n\\n\\n  - Blob Storage for unstructure\", \"d text or binary storage, also referred to as object storage.\\n\\n\\n  - Table Storage for structured dat\", \"asets, accessible via row keys.\\n\\n\\n  - Queue Storage for reliable queue-based messaging.\\n\\n\\n79 CHAPTER\", \" 7 | Working with Data in ASP.NET Core Apps\\n\\n\\n  - File Storage for shared file access between Azure \", \"virtual machines and on-premises\\napplications.\\n\\n\\n**References \\u2013 Azure Storage**\\n\\n\\n  - [Azure Storage\", \" Introduction https://learn.microsoft.com/azure/storage/common/storage-](https://docs.microsoft.com/\", \"azure/storage/common/storage-introduction)\\n[introduction](https://docs.microsoft.com/azure/storage/c\", \"ommon/storage-introduction)\\n\\n### Caching\\n\\n\\nIn web applications, each web request should be completed\", \" in the shortest time possible. One way to\\nachieve this functionality is to limit the number of exte\", \"rnal calls the server must make to complete the\\nrequest. Caching involves storing a copy of data on \", \"the server (or another data store that is more\\neasily queried than the source of the data). Web appl\", \"ications, and especially non-SPA traditional web\\napplications, need to build the entire user interfa\", \"ce with every request. This approach frequently\\ninvolves making many of the same database queries re\", \"peatedly from one user request to the next. In\\nmost cases, this data changes rarely, so there is lit\", \"tle reason to constantly request it from the\\ndatabase. ASP.NET Core supports response caching, for c\", \"aching entire pages, and data caching, which\\nsupports more granular caching behavior.\\n\\n\\nWhen impleme\", \"nting caching, it\\u2019s important to keep in mind separation of concerns. Avoid\\nimplementing caching log\", \"ic in your data access logic, or in your user interface. Instead, encapsulate\\ncaching in its own cla\", \"sses, and use configuration to manage its behavior. This approach follows the\\nOpen/Closed and Single\", \" Responsibility principles, and will make it easier for you to manage how you\\nuse caching in your ap\", \"plication as it grows.\\n\\n#### **ASP.NET Core response caching**\\n\\n\\nASP.NET Core supports two levels of\", \" response caching. The first level does not cache anything on the\\nserver, but adds HTTP headers that\", \" instruct clients and proxy servers to cache responses. This\\nfunctionality is implemented by adding \", \"the ResponseCache attribute to individual controllers or\\nactions:\\n\\n\\nThe previous example will result\", \" in the following header being added to the response, instructing\\nclients to cache the result for up\", \" to 60 seconds.\\n\\n```\\nCache-Control: public,max-age=60\\n\\n```\\n\\nIn order to add server-side in-memory ca\", \"ching to the application, you must reference the\\nMicrosoft.AspNetCore.ResponseCaching NuGet package,\", \" and then add the Response Caching\\nmiddleware. This middleware is configured with services and middl\", \"eware during app startup:\\n\\n\\n80 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\nThe Response Cac\", \"hing Middleware will automatically cache responses based on a set of conditions,\\nwhich you can custo\", \"mize. By default, only 200 (OK) responses requested via GET or HEAD methods\\nare cached. In addition,\", \" requests must have a response with a Cache-Control: public header, and\\n[cannot include headers for \", \"Authorization or Set-Cookie. See a complete list of the caching conditions](https://docs.microsoft.c\", \"om/aspnet/core/performance/caching/middleware#conditions-for-caching)\\n[used by the response caching \", \"middleware.](https://docs.microsoft.com/aspnet/core/performance/caching/middleware#conditions-for-ca\", \"ching)\\n\\n#### **Data caching**\\n\\n\\nRather than (or in addition to) caching full web responses, you can \", \"cache the results of individual data\\n[queries. For this functionality, you can use in memory caching\", \" on the web server, or use a distributed](https://docs.microsoft.com/aspnet/core/performance/caching\", \"/distributed)\\n[cache. This section will demonstrate how to implement in memory caching.](https://doc\", \"s.microsoft.com/aspnet/core/performance/caching/distributed)\\n\\n\\nAdd support for memory (or distribute\", \"d) caching with the following code:\\n\\n\\nBe sure to add the Microsoft.Extensions.Caching.Memory NuGet p\", \"ackage as well.\\n\\n\\nOnce you\\u2019ve added the service, you request IMemoryCache via dependency injection w\", \"herever you\\nneed to access the cache. In this example, the CachedCatalogService is using the Proxy (\", \"or Decorator)\\ndesign pattern, by providing an alternative implementation of ICatalogService that con\", \"trols access to\\n(or adds behavior to) the underlying CatalogService implementation.\\n\\n\\n81 CHAPTER 7 |\", \" Working with Data in ASP.NET Core Apps\\n\\n\\nTo configure the application to use the cached version of \", \"the service, but still allow the service to get\\nthe instance of CatalogService it needs in its const\", \"ructor, you would add the following lines in\\n_Program.cs_ :\\n\\n\\nWith this code in place, the database \", \"calls to fetch the catalog data will only be made once per\\nminute, rather than on every request. Dep\", \"ending on the traffic to the site, this can have a significant\\nimpact on the number of queries made \", \"to the database, and the average page load time for the home\\npage that currently depends on all thre\", \"e of the queries exposed by this service.\\n\\n\\nAn issue that arises when caching is implemented is _sta\", \"le data_ - that is, data that has changed at the\\nsource but an out-of-date version remains in the ca\", \"che. A simple way to mitigate this issue is to use\\nsmall cache durations, since for a busy applicati\", \"on there is a limited additional benefit to extending\\nthe length data is cached. For example, consid\", \"er a page that makes a single database query, and is\\nrequested 10 times per second. If this page is \", \"cached for one minute, it will result in the number of\\ndatabase queries made per minute to drop from\", \" 600 to 1, a reduction of 99.8%. If instead the cache\\nduration was made one hour, the overall reduct\", \"ion would be 99.997%, but now the likelihood and\\npotential age of stale data are both increased dram\", \"atically.\\n\\n\\nAnother approach is to proactively remove cache entries when the data they contain is up\", \"dated. Any\\nindividual entry can be removed if its key is known:\\n\\n```\\n_cache.Remove(cacheKey);\\n\\n```\\n\\n\", \"If your application exposes functionality for updating entries that it caches, you can remove the\\nco\", \"rresponding cache entries in your code that performs the updates. Sometimes there may be many\\ndiffer\", \"ent entries that depend on a particular set of data. In that case, it can be useful to create\\ndepend\", \"encies between cache entries, by using a CancellationChangeToken. With a\\nCancellationChangeToken, yo\", \"u can expire multiple cache entries at once by canceling the token.\\n\\n\\n82 CHAPTER 7 | Working with Da\", \"ta in ASP.NET Core Apps\\n\\n\\nCaching can dramatically improve the performance of web pages that repeate\", \"dly request the same\\nvalues from the database. Be sure to measure data access and page performance b\", \"efore applying\\ncaching, and only apply caching where you see a need for improvement. Caching consume\", \"s web\\nserver memory resources and increases the complexity of the application, so it\\u2019s important you\", \" don\\u2019t\\nprematurely optimize using this technique.\\n\\n### Getting data to Blazor WebAssembly apps\\n\\n\\nIf \", \"you\\u2019re building apps that use Blazor Server, you can use Entity Framework and other direct data\\nacce\", \"ss technologies as they\\u2019ve been discussed thus far in this chapter. However, when building Blazor\\nWe\", \"bAssembly apps, like other SPA frameworks, you will need a different strategy for data access.\\nTypic\", \"ally, these applications access data and interact with the server through web API endpoints.\\n\\n\\nIf th\", \"e data or operations being performed are sensitive, be sure to review the section on security in\\nthe\", \" previous chapter and protect your APIs against unauthorized access.\\n\\n\\n[You\\u2019ll find an example of a \", \"Blazor WebAssembly app in the eShopOnWeb reference application, in the](https://github.com/dotnet-ar\", \"chitecture/eShopOnWeb)\\nBlazorAdmin project. This project is hosted within the eShopOnWeb Web project\", \", and allows users in\\nthe Administrators group to manage the items in the store. You can see a scree\", \"nshot of the\\napplication in Figure 8-3.\\n\\n\\n_Figure 8-3. eShopOnWeb Catalog Admin Screenshot._\\n\\n\\n83 CH\", \"APTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\nWhen fetching data from web APIs within a Blazor \", \"WebAssembly app, you just use an instance of\\nHttpClient as you would in any .NET application. The ba\", \"sic steps involved are to create the request to\\nsend (if necessary, usually for POST or PUT requests\", \"), await the request itself, verify the status code,\\nand deserialize the response. If you\\u2019re going t\", \"o make many requests to a given set of APIs, it\\u2019s a good\\nidea to encapsulate your APIs and configure\", \" the HttpClient base address centrally. This way, if you\\nneed to adjust any of these settings betwee\", \"n environments, you can make the changes in just one\\nplace. You should add support for this service \", \"in your Program.Main:\\n\\n\\nIf you need to access services securely, you should access a secure token an\", \"d configure the HttpClient\\nto pass this token as an Authentication header with every request:\\n\\n\\nThis\", \" activity can be done from any component that has the HttpClient injected into it, provided that\\nHtt\", \"pClient wasn\\u2019t added to the application\\u2019s services with a Transient lifetime. Every reference to\\nHtt\", \"pClient in the application references the same instance, so changes to it in one component flow\\nthro\", \"ugh the entire application. A good place to perform this authentication check (followed by\\nspecifyin\", \"g the token) is in a shared component like the main navigation for the site. Learn more about\\n[this \", \"approach in the BlazorAdmin project in the eShopOnWeb reference application.](https://github.com/dot\", \"net-architecture/eShopOnWeb)\\n\\n\\nOne benefit of Blazor WebAssembly over traditional JavaScript SPAs is\", \" that you don\\u2019t need to keep\\ncopies of your data transfer objects(DTOs) synchronized. Your Blazor We\", \"bAssembly project and your\\nweb API project can both share the same DTOs in a common shared project. \", \"This approach eliminates\\nsome of the friction involved in developing SPAs.\\n\\n\\nTo quickly get data fro\", \"m an API endpoint, you can use the built-in helper method, GetFromJsonAsync.\\nThere are similar metho\", \"ds for POST, PUT, etc. The following shows how to get a CatalogItem from an\\nAPI endpoint using a con\", \"figured HttpClient in a Blazor WebAssembly app:\\n\\n```\\nvar item = await _httpClient.GetFromJsonAsync<C\", \"atalogItem>($\\\"catalog-items/{id}\\\");\\n\\n```\\n\\nOnce you have the data you need, you\\u2019ll typically track ch\", \"anges locally. When you want to make\\nupdates to the backend data store, you\\u2019ll call additional web A\", \"PIs for this purpose.\\n\\n\\n**References \\u2013 Blazor Data**\\n\\n\\n  - [Call a web API from ASP.NET Core Blazor \", \"https://learn.microsoft.com/aspnet/core/blazor/call-](https://docs.microsoft.com/aspnet/core/blazor/\", \"call-web-api)\\nweb-api\\n\\n\\n84 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\n**CHAPTER**\\n# 8\\n\\n## \", \"Test ASP.NET Core MVC apps\\n\\n\\n_\\u201cIf you don\\u2019t like unit testing your product, most likely your custome\", \"rs won\\u2019t like to test it, either.\\u201d_ _Anonymous\\n\\nSoftware of any complexity can fail in unexpected wa\", \"ys in response to changes. Thus, testing after\\nmaking changes is required for all but the most trivi\", \"al (or least critical) applications. Manual testing is\\nthe slowest, least reliable, most expensive w\", \"ay to test software. Unfortunately, if applications aren\\u2019t\\ndesigned to be testable, it can be the on\", \"ly means of testing available. Applications written to follow\\nthe architectural principles laid out \", \"in chapter 4 should be largely unit testable. ASP.NET Core\\napplications support automated integratio\", \"n and functional testing.\\n\\n### Kinds of automated tests\\n\\n\\nThere are many kinds of automated tests fo\", \"r software applications. The simplest, lowest level test is\\nthe unit test. At a slightly higher leve\", \"l, there are integration tests and functional tests. Other kinds of\\ntests, such as UI tests, load te\", \"sts, stress tests, and smoke tests, are beyond the scope of this document.\\n\\n#### **Unit tests**\\n\\n\\nA \", \"unit test tests a single part of your application\\u2019s logic. One can further describe it by listing so\", \"me of\\nthe things that it isn\\u2019t. A unit test doesn\\u2019t test how your code works with dependencies or\\nin\", \"frastructure \\u2013 that\\u2019s what integration tests are for. A unit test doesn\\u2019t test the framework your co\", \"de\\nis written on \\u2013 you should assume it works or, if you find it doesn\\u2019t, file a bug and code a work\", \"around.\\nA unit test runs completely in memory and in process. It doesn\\u2019t communicate with the file s\", \"ystem, the\\nnetwork, or a database. Unit tests should only test your code.\\n\\n\\nUnit tests, by virtue of\", \" the fact that they test only a single unit of your code, with no external\\ndependencies, should exec\", \"ute extremely fast. Thus, you should be able to run test suites of hundreds\\nof unit tests in a few s\", \"econds. Run them frequently, ideally before every push to a shared source\\ncontrol repository, and ce\", \"rtainly with every automated build on your build server.\\n\\n#### **Integration tests**\\n\\n\\nAlthough it\\u2019s\", \" a good idea to encapsulate your code that interacts with infrastructure like databases\\nand file sys\", \"tems, you will still have some of that code, and you will probably want to test it.\\n\\n\\n85 CHAPTER 8 |\", \" Test ASP.NET Core MVC apps\\n\\n\\nAdditionally, you should verify that your code\\u2019s layers interact as yo\", \"u expect when your application\\u2019s\\ndependencies are fully resolved. This functionality is the responsi\", \"bility of integration tests. Integration\\ntests tend to be slower and more difficult to set up than u\", \"nit tests, because they often depend on\\nexternal dependencies and infrastructure. Thus, you should a\", \"void testing things that could be tested\\nwith unit tests in integration tests. If you can test a giv\", \"en scenario with a unit test, you should test it\\nwith a unit test. If you can\\u2019t, then consider using\", \" an integration test.\\n\\n\\nIntegration tests will often have more complex setup and teardown procedures\", \" than unit tests. For\\nexample, an integration test that goes against an actual database will need a \", \"way to return the\\ndatabase to a known state before each test run. As new tests are added and the pro\", \"duction database\\nschema evolves, these test scripts will tend to grow in size and complexity. In man\", \"y large systems, it is\\nimpractical to run full suites of integration tests on developer workstations\", \" before checking in\\nchanges to shared source control. In these cases, integration tests may be run o\", \"n a build server.\\n\\n#### **Functional tests**\\n\\n\\nIntegration tests are written from the perspective of\", \" the developer, to verify that some components of\\nthe system work correctly together. Functional tes\", \"ts are written from the perspective of the user, and\\nverify the correctness of the system based on i\", \"ts requirements. The following excerpt offers a useful\\nanalogy for how to think about functional tes\", \"ts, compared to unit tests:\\n\\n\\n\\u201cMany times the development of a system is likened to the building of \", \"a house. While this analogy\\nisn\\u2019t quite correct, we can extend it for the purposes of understanding \", \"the difference between unit\\nand functional tests. Unit testing is analogous to a building inspector \", \"visiting a house\\u2019s construction\\nsite. He is focused on the various internal systems of the house, th\", \"e foundation, framing, electrical,\\nplumbing, and so on. He ensures (tests) that the parts of the hou\", \"se will work correctly and safely, that\\nis, meet the building code. Functional tests in this scenari\", \"o are analogous to the homeowner visiting\\nthis same construction site. He assumes that the internal \", \"systems will behave appropriately, that the\\nbuilding inspector is performing his task. The homeowner\", \" is focused on what it will be like to live in\\nthis house. He is concerned with how the house looks,\", \" are the various rooms a comfortable size, does\\nthe house fit the family\\u2019s needs, are the windows in\", \" a good spot to catch the morning sun. The\\nhomeowner is performing functional tests on the house. He\", \" has the user\\u2019s perspective. The building\\ninspector is performing unit tests on the house. He has th\", \"e builder\\u2019s perspective.\\u201d\\n\\n\\n[Source: Unit Testing versus Functional Tests](https://www.softwaretesti\", \"ngtricks.com/2007/01/unit-testing-versus-functional-tests.html)\\n\\n\\nI\\u2019m fond of saying \\u201cAs developers,\", \" we fail in two ways: we build the thing wrong, or we build the\\nwrong thing.\\u201d Unit tests ensure you \", \"are building the thing right; functional tests ensure you are\\nbuilding the right thing.\\n\\n\\nSince func\", \"tional tests operate at the system level, they may require some degree of UI automation.\\nLike integr\", \"ation tests, they usually work with some kind of test infrastructure as well. This activity\\nmakes th\", \"em slower and more brittle than unit and integration tests. You should have only as many\\nfunctional \", \"tests as you need to be confident the system is behaving as users expect.\\n\\n#### **Testing Pyramid**\\n\", \"\\n\\nMartin Fowler wrote about the testing pyramid, an example of which is shown in Figure 9-1.\\n\\n\\n86 CH\", \"APTER 8 | Test ASP.NET Core MVC apps\\n\\n\\n_Figure 9-1. Testing Pyramid_\\n\\n\\nThe different layers of the p\", \"yramid, and their relative sizes, represent different kinds of tests and how\\nmany you should write f\", \"or your application. As you can see, the recommendation is to have a large\\nbase of unit tests, suppo\", \"rted by a smaller layer of integration tests, with an even smaller layer of\\nfunctional tests. Each l\", \"ayer should ideally only have tests in it that cannot be performed adequately at\\na lower layer. Keep\", \" the testing pyramid in mind when you are trying to decide which kind of test you\\nneed for a particu\", \"lar scenario.\\n\\n#### **What to test**\\n\\n\\nA common problem for developers who are inexperienced with wr\", \"iting automated tests is coming up\\nwith what to test. A good starting point is to test conditional l\", \"ogic. Anywhere you have a method with\\nbehavior that changes based on a conditional statement (if-els\", \"e, switch, and so on), you should be\\nable to come up with at least a couple of tests that confirm th\", \"e correct behavior for certain conditions.\\nIf your code has error conditions, it\\u2019s good to write at \", \"least one test for the \\u201chappy path\\u201d through the\\ncode (with no errors), and at least one test for the\", \" \\u201csad path\\u201d (with errors or atypical results) to\\nconfirm your application behaves as expected in the\", \" face of errors. Finally, try to focus on testing\\nthings that can fail, rather than focusing on metr\", \"ics like code coverage. More code coverage is better\\nthan less, generally. However, writing a few mo\", \"re tests of a complex and business-critical method is\\nusually a better use of time than writing test\", \"s for auto-properties just to improve test code coverage\\nmetrics.\\n\\n\\n87 CHAPTER 8 | Test ASP.NET Core\", \" MVC apps\\n\\n\\n### Organizing test projects\\n\\nTest projects can be organized however works best for you.\", \" It\\u2019s a good idea to separate tests by type\\n(unit test, integration test) and by what they are testi\", \"ng (by project, by namespace). Whether this\\nseparation consists of folders within a single test proj\", \"ect, or multiple test projects, is a design decision.\\nOne project is simplest, but for large project\", \"s with many tests, or in order to more easily run different\\nsets of tests, you might want to have se\", \"veral different test projects. Many teams organize test projects\\nbased on the project they are testi\", \"ng, which for applications with more than a few projects can result\\nin a large number of test projec\", \"ts, especially if you still break these down according to what kind of\\ntests are in each project. A \", \"compromise approach is to have one project per kind of test, per\\napplication, with folders inside th\", \"e test projects to indicate the project (and class) being tested.\\n\\n\\nA common approach is to organize\", \" the application projects under a \\u2018src\\u2019 folder, and the application\\u2019s\\ntest projects under a parallel\", \" \\u2018tests\\u2019 folder. You can create matching solution folders in Visual Studio, if\\nyou find this organiz\", \"ation useful.\\n\\n\\n_Figure 9-2. Test organization in your solution_\\n\\n\\nYou can use whichever test framew\", \"ork you prefer. The xUnit framework works well and is what all of\\nthe ASP.NET Core and EF Core tests\", \" are written in. You can add an xUnit test project in Visual Studio\\nusing the template shown in Figu\", \"re 9-3, or from the CLI using dotnet new xunit.\\n\\n\\n88 CHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\n_Figur\", \"e 9-3. Add an xUnit Test Project in Visual Studio_\\n\\n#### **Test naming**\\n\\n\\nName your tests in a cons\", \"istent fashion, with names that indicate what each test does. One approach\\nI\\u2019ve had great success wi\", \"th is to name test classes according to the class and method they are testing.\\nThis approach results\", \" in many small test classes, but it makes it extremely clear what each test is\\nresponsible for. With\", \" the test class name set up, to identify the class and method to be tested, the test\\nmethod name can\", \" be used to specify the behavior being tested. This name should include the\\nexpected behavior and an\", \"y inputs or assumptions that should yield this behavior. Some example test\\nnames:\\n\\n\\n  - CatalogContr\", \"ollerGetImage.CallsImageServiceWithId\\n\\n\\n  - CatalogControllerGetImage.LogsWarningGivenImageMissingEx\", \"ception\\n\\n\\n  - CatalogControllerGetImage.ReturnsFileResultWithBytesGivenSuccess\\n\\n\\n  - CatalogControll\", \"erGetImage.ReturnsNotFoundResultGivenImageMissingException\\n\\n\\nA variation of this approach ends each \", \"test class name with \\u201cShould\\u201d and modifies the tense slightly:\\n\\n\\n  - CatalogControllerGetImage **Sho\", \"uld** . **Call** ImageServiceWithId\\n\\n\\n  - CatalogControllerGetImage **Should** . **Log** WarningGive\", \"nImageMissingException\\n\\n\\n89 CHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\nSome teams find the second nami\", \"ng approach clearer, though slightly more verbose. In any case, try\\nto use a naming convention that \", \"provides insight into test behavior, so that when one or more tests\\nfail, it\\u2019s obvious from their na\", \"mes what cases have failed. Avoid naming your tests vaguely, such as\\nControllerTests.Test1, as these\", \" names offer no value when you see them in test results.\\n\\n\\nIf you follow a naming convention like th\", \"e one above that produces many small test classes, it\\u2019s a\\ngood idea to further organize your tests u\", \"sing folders and namespaces. Figure 9-4 shows one\\napproach to organizing tests by folder within seve\", \"ral test projects.\\n\\n\\n_Figure 9-4. Organizing test classes by folder based on class being tested._\\n\\n\\n\", \"If a particular application class has many methods being tested (and thus many test classes), it may\", \"\\nmake sense to place these classes in a folder corresponding to the application class. This organiza\", \"tion\\nis no different than how you might organize files into folders elsewhere. If you have more than\", \" three\\n\\n\\n90 CHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\nor four related files in a folder containing ma\", \"ny other files, it\\u2019s often helpful to move them into their\\nown subfolder.\\n\\n### Unit testing ASP.NET \", \"Core apps\\n\\n\\nIn a well-designed ASP.NET Core application, most of the complexity and business logic w\", \"ill be\\nencapsulated in business entities and a variety of services. The ASP.NET Core MVC app itself,\", \" with its\\ncontrollers, filters, viewmodels, and views, should require few unit tests. Much of the fu\", \"nctionality of a\\ngiven action lies outside the action method itself. Testing whether routing or glob\", \"al error handling\\nwork correctly cannot be done effectively with a unit test. Likewise, any filters,\", \" including model\\nvalidation and authentication and authorization filters, cannot be unit tested with\", \" a test targeting a\\ncontroller\\u2019s action method. Without these sources of behavior, most action metho\", \"ds should be\\ntrivially small, delegating the bulk of their work to services that can be tested indep\", \"endent of the\\ncontroller that uses them.\\n\\n\\nSometimes you\\u2019ll need to refactor your code in order to u\", \"nit test it. Frequently this activity involves\\nidentifying abstractions and using dependency injecti\", \"on to access the abstraction in the code you\\u2019d\\nlike to test, rather than coding directly against inf\", \"rastructure. For example, consider this easy action\\nmethod for displaying images:\\n\\n\\nUnit testing thi\", \"s method is made difficult by its direct dependency on System.IO.File, which it uses to\\nread from th\", \"e file system. You can test this behavior to ensure it works as expected, but doing so with\\nreal fil\", \"es is an integration test. It\\u2019s worth noting you can\\u2019t unit test this method\\u2019s route\\u2014you\\u2019ll see how\\n\", \"to do this testing with a functional test shortly.\\n\\n\\nIf you can\\u2019t unit test the file system behavior\", \" directly, and you can\\u2019t test the route, what is there to\\ntest? Well, after refactoring to make unit\", \" testing possible, you may discover some test cases and\\nmissing behavior, such as error handling. Wh\", \"at does the method do when a file isn\\u2019t found? What\\nshould it do? In this example, the refactored me\", \"thod looks like this:\\n\\n\\n91 CHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\n_logger and _imageService are bo\", \"th injected as dependencies. Now you can test that the same ID that\\nis passed to the action method i\", \"s passed to _imageService, and that the resulting bytes are returned\\nas part of the FileResult. You \", \"can also test that error logging is happening as expected, and that a\\nNotFound result is returned if\", \" the image is missing, assuming this behavior is important application\\nbehavior (that is, not just t\", \"emporary code the developer added to diagnose an issue). The actual file\\nlogic has moved into a sepa\", \"rate implementation service, and has been augmented to return an\\napplication-specific exception for \", \"the case of a missing file. You can test this implementation\\nindependently, using an integration tes\", \"t.\\n\\n\\nIn most cases, you\\u2019ll want to use global exception handlers in your controllers, so the amount \", \"of logic\\nin them should be minimal and probably not worth unit testing. Do most of your testing of c\", \"ontroller\\nactions using functional tests and the TestServer class described below.\\n\\n### Integration \", \"testing ASP.NET Core apps\\n\\n\\nMost of the integration tests in your ASP.NET Core apps should be testin\", \"g services and other\\n[implementation types defined in your Infrastructure project. For example, you \", \"could test that EF Core](https://docs.microsoft.com/ef/core/miscellaneous/testing/)\\n[was successfull\", \"y updating and retrieving the data that you expect](https://docs.microsoft.com/ef/core/miscellaneous\", \"/testing/) from your data access classes\\nresiding in the Infrastructure project. The best way to tes\", \"t that your ASP.NET Core MVC project is\\nbehaving correctly is with functional tests that run against\", \" your app running in a test host.\\n\\n### Functional testing ASP.NET Core apps\\n\\n\\nFor ASP.NET Core appli\", \"cations, the TestServer class makes functional tests fairly easy to write. You\\nconfigure a TestServe\", \"r using a WebHostBuilder (or HostBuilder) directly (as you normally do for your\\napplication), or wit\", \"h the WebApplicationFactory type (available since version 2.1). Try to match your\\ntest host to your \", \"production host as closely as possible, so your tests exercise behavior similar to what\\nthe app will\", \" do in production. The WebApplicationFactory class is helpful for configuring the\\nTestServer\\u2019s Conte\", \"ntRoot, which is used by ASP.NET Core to locate static resource like Views.\\n\\n\\nYou can create simple \", \"functional tests by creating a test class that implements\\nIClassFixture<WebApplicationFactory<TEntry\", \"Point>>, where TEntryPoint is your web application\\u2019s\\nStartup class. With this interface in place, yo\", \"ur test fixture can create a client using the factory\\u2019s\\nCreateClient method:\\n\\n\\n92 CHAPTER 8 | Test A\", \"SP.NET Core MVC apps\\n\\n\\nFrequently, you\\u2019ll want to perform some additional configuration of your site\", \" before each test runs,\\nsuch as configuring the application to use an in-memory data store and then \", \"seeding the application\\nwith test data. To achieve this functionality, create your own subclass of\\nW\", \"ebApplicationFactory<TEntryPoint> and override its ConfigureWebHost method. The example\\nbelow is fro\", \"m the eShopOnWeb FunctionalTests project and is used as part of the tests on the main\\nweb applicatio\", \"n.\\n\\n\\n93 CHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\nTests can make use of this custom WebApplicationFac\", \"tory by using it to create a client and then\\nmaking requests to the application using this client in\", \"stance. The application will have data seeded\\nthat can be used as part of the test\\u2019s assertions. The\", \" following test verifies that the home page of the\\neShopOnWeb application loads correctly and includ\", \"es a product listing that was added to the\\napplication as part of the seed data.\\n\\n\\n94 CHAPTER 8 | Te\", \"st ASP.NET Core MVC apps\\n\\n\\nThis functional test exercises the full ASP.NET Core MVC / Razor Pages ap\", \"plication stack, including all\\nmiddleware, filters, and binders that may be in place. It verifies th\", \"at a given route (\\u201c/\\u201d) returns the\\nexpected success status code and HTML output. It does so without \", \"setting up a real web server, and\\navoids much of the brittleness that using a real web server for te\", \"sting can experience (for example,\\nproblems with firewall settings). Functional tests that run again\", \"st TestServer are usually slower than\\nintegration and unit tests, but are much faster than tests tha\", \"t would run over the network to a test\\nweb server. Use functional tests to ensure your application\\u2019s\", \" front-end stack is working as expected.\\nThese tests are especially useful when you find duplication\", \" in your controllers or pages and you\\naddress the duplication by adding filters. Ideally, this refac\", \"toring won\\u2019t change the behavior of the\\napplication, and a suite of functional tests will verify thi\", \"s is the case.\\n\\n#### **References \\u2013 Test ASP.NET Core MVC apps**\\n\\n\\n  - **Testing in ASP.NET Core**\\n[\", \"https://learn.microsoft.com/aspnet/core/testing/](https://docs.microsoft.com/aspnet/core/testing/)\\n\\n\", \"  - **Unit Test Naming Convention**\\n[https://ardalis.com/unit-test-naming-convention](https://ardali\", \"s.com/unit-test-naming-convention)\\n\\n  - **Testing EF Core**\\n[https://learn.microsoft.com/ef/core/mis\", \"cellaneous/testing/](https://docs.microsoft.com/ef/core/miscellaneous/testing/)\\n\\n  - **Integration t\", \"ests in ASP.NET Core**\\n[https://learn.microsoft.com/aspnet/core/test/integration-tests](https://docs\", \".microsoft.com/aspnet/core/test/integration-tests)\\n\\n\\n95 CHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\n**C\", \"HAPTER**\\n# 9\\n\\n## Development process for Azure\\n\\n\\n_\\u201cWith the cloud, individuals and small businesses \", \"can snap their fingers and instantly set up enterprise-_\\n_class services.\\u201d_\\n\\n_- Roy Stephan_\\n\\n### Vi\", \"sion\\n\\n\\n_Develop well-designed ASP .NET Core applications the way you like, using Visual Studio or th\", \"e dotnet_\\n_CLI and Visual Studio Code or your editor of choice._\\n\\n### Development environment for AS\", \"P.NET Core apps\\n\\n#### **Development tools choices: IDE or editor**\\n\\n\\nWhether you prefer a full and p\", \"owerful IDE or a lightweight and agile editor, Microsoft has you\\ncovered when developing ASP.NET Cor\", \"e applications.\\n\\n\\n**Visual Studio 2022.** Visual Studio 2022 is the best-in-class IDE for developing\", \" applications for\\nASP.NET Core. It offers a host of features that increase developer productivity. Y\", \"ou can use it to\\ndevelop the application, then analyze its performance and other characteristics. Th\", \"e integrated\\ndebugger lets you pause code execution and step back and forth through code on the fly \", \"as it\\u2019s\\nrunning. Its support for hot reloads allows you to continue working with your app where you \", \"left off,\\neven after making code changes, without having to restart the app. The built-in test runne\", \"r lets you\\norganize your tests and their results and can even perform live unit testing while you\\u2019re\", \" coding. Using\\nLive Share, you can collaborate in real-time with other developers, sharing your code\", \" session\\nseamlessly over the network. And when you\\u2019re ready, Visual Studio includes everything you n\", \"eed to\\npublish your application to Azure or wherever you might host it.\\n\\n\\n[Download Visual Studio 20\", \"22](https://aka.ms/vsdownload?utm_source=mscom&utm_campaign=msdocs)\\n\\n\\n**Visual Studio Code and dotne\", \"t CLI** (Cross-Platform Tools for Mac, Linux, and Windows). If you prefer\\na lightweight and cross-pl\", \"atform editor supporting any development language, you can use Microsoft\\nVisual Studio Code and the \", \"dotnet CLI. These products provide a simple yet robust experience that\\n\\n\\n96 CHAPTER 9 | Development \", \"process for Azure\\n\\n\\nstreamlines the developer workflow. Additionally, Visual Studio Code supports ex\", \"tensions for C# and\\nweb development, providing intellisense and shortcut-tasks within the editor.\\n\\n\\n\", \"[Download the .NET SDK](https://dotnet.microsoft.com/download)\\n\\n\\n[Download Visual Studio Code](https\", \"://code.visualstudio.com/download)\\n\\n### Development workflow for Azure-hosted ASP.NET Core apps\\n\\n\\nTh\", \"e application development lifecycle starts from each developer\\u2019s machine, coding the app using\\ntheir\", \" preferred language and testing it locally. Developers may choose their preferred source control\\nsys\", \"tem and can configure Continuous Integration (CI) and/or Continuous Delivery/Deployment (CD)\\nusing a\", \" build server or based on built-in Azure features.\\n\\n\\nTo get started with developing an ASP.NET Core \", \"application using CI/CD, you can use Azure DevOps\\nServices or your organization\\u2019s own Team Foundatio\", \"n Server (TFS). GitHub Actions provide another\\noption for easily building and deploying apps to Azur\", \"e, for apps whose code is hosted on GitHub.\\n\\n#### **Initial setup**\\n\\n\\nTo create a release pipeline f\", \"or your app, you need to have your application code in source control.\\nSet up a local repository and\", \" connect it to a remote repository in a team project. Follow these\\ninstructions:\\n\\n\\n  - [Share your c\", \"ode with Git and Visual Studio or](https://docs.microsoft.com/azure/devops/git/share-your-code-in-gi\", \"t-vs)\\n\\n\\n  - [Share your code with TFVC and Visual Studio](https://docs.microsoft.com/azure/devops/tf\", \"vc/share-your-code-in-tfvc-vs)\\n\\n\\nCreate an Azure App Service where you\\u2019ll deploy your application. C\", \"reate a Web App by going to the\\nApp Services blade on the Azure portal. Click +Add, select the Web A\", \"pp template, click Create, and\\nprovide a name and other details. The web app will be accessible from\", \" {name}.azurewebsites.net.\\n\\n\\n97 CHAPTER 9 | Development process for Azure\\n\\n\\n_Figure 10-1. Creating a\", \" new Azure App Service Web App in the Azure Portal._\\n\\n\\nYour CI build process will perform an automat\", \"ed build whenever new code is committed to the\\nproject\\u2019s source control repository. This process giv\", \"es you immediate feedback that the code builds\\n(and, ideally, passes automated tests) and can potent\", \"ially be deployed. This CI build will produce a\\nweb deploy package artifact and publish it for consu\", \"mption by your CD process.\\n\\n\\n[Define your CI build process](https://docs.microsoft.com/azure/devops/\", \"pipelines/ecosystems/dotnet-core)\\n\\n\\nBe sure to enable continuous integration so the system will queu\", \"e a build whenever someone on your\\nteam commits new code. Test the build and verify that it is produ\", \"cing a web deploy package as one of\\nits artifacts.\\n\\n\\nWhen a build succeeds, your CD process will dep\", \"loy the results of your CI build to your Azure web\\napp. To configure this step, you create and confi\", \"gure a _Release_, which will deploy to your Azure App\\nService.\\n\\n\\n[Deploy an Azure web app](https://d\", \"ocs.microsoft.com/azure/devops/pipelines/targets/webapp)\\n\\n\\nOnce your CI/CD pipeline is configured, y\", \"ou can easily make updates to your web app and commit\\nthem to source control to have them deployed.\\n\", \"\\n#### **Workflow for developing Azure-hosted ASP.NET Core applications**\\n\\n\\nOnce you have configured \", \"your Azure account and your CI/CD process, developing Azure-hosted\\nASP.NET Core applications is simp\", \"le. The following are the basic steps you usually take when building\\nan ASP.NET Core app, hosted in \", \"Azure App Service as a Web App, as illustrated in Figure 10-2.\\n\\n\\n98 CHAPTER 9 | Development process \", \"for Azure\\n\\n\\n_Figure 10-2. Step-by-step workflow for building ASP.NET Core apps and hosting them in A\", \"zure_\\n\\n\\n**Step 1. Local dev environment inner loop**\\n\\n\\nDeveloping your ASP.NET Core application for \", \"deployment to Azure is no different from developing\\nyour application otherwise. Use the local develo\", \"pment environment you\\u2019re comfortable with, whether\\nthat\\u2019s Visual Studio 2019 or the dotnet CLI and V\", \"isual Studio Code or your preferred editor. You can\\nwrite code, run and debug your changes, run auto\", \"mated tests, and make local commits to source\\ncontrol until you\\u2019re ready to push your changes to you\", \"r shared source control repository.\\n\\n\\n**Step 2. Application code repository**\\n\\n\\nWhenever you\\u2019re read\", \"y to share your code with your team, you should push your changes from your\\nlocal source repository \", \"to your team\\u2019s shared source repository. If you\\u2019ve been working in a custom\\n[branch, this step usual\", \"ly involves merging your code into a shared branch (perhaps by means of a pull](https://docs.microso\", \"ft.com/azure/devops/git/pull-requests)\\n[request).](https://docs.microsoft.com/azure/devops/git/pull-\", \"requests)\\n\\n\\n**Step 3. Build Server: Continuous integration. build, test, package**\\n\\n\\nA new build is \", \"triggered on the build server whenever a new commit is made to the shared\\napplication code repositor\", \"y. As part of the CI process, this build should fully compile the application\\nand run automated test\", \"s to confirm everything is working as expected. The end result of the CI\\nprocess should be a package\", \"d version of the web app, ready for deployment.\\n\\n\\n**Step 4. Build Server: Continuous delivery**\\n\\n\\nOn\", \"ce a build has succeeded, the CD process will pick up the build artifacts produced. This process wil\", \"l\\ninclude a web deploy package. The build server will deploy this package to Azure App Service,\\n\\n\\n99\", \" CHAPTER 9 | Development process for Azure\\n\\n\\nreplacing any existing service with the newly created o\", \"ne. Typically this step targets a staging\\nenvironment, but some applications deploy directly to prod\", \"uction through a CD process.\\n\\n\\n**Step 5. Azure App Service Web App**\\n\\n\\nOnce deployed, the ASP.NET Co\", \"re application runs within the context of an Azure App Service Web\\nApp. This Web App can be monitore\", \"d and further configured using the Azure Portal.\\n\\n\\n**Step 6. Production monitoring and diagnostics**\", \"\\n\\n\\nWhile the Web App is running, you can monitor the health of the application and collect diagnosti\", \"cs\\nand user behavior data. Application Insights is included in Visual Studio, and offers automatic\\ni\", \"nstrumentation for ASP.NET apps. It can provide you with information on usage, exceptions, requests,\", \"\\nperformance, and logs.\\n\\n### References\\n\\n\\n**Build and Deploy Your ASP.NET Core App to Azure**\\n[https\", \"://learn.microsoft.com/azure/devops/build-release/apps/aspnet/build-aspnet-core](https://docs.micros\", \"oft.com/azure/devops/build-release/apps/aspnet/build-aspnet-core)\\n\\n\\n100 CHAPTER 9 | Development proc\", \"ess for Azure\\n\\n\\n**CHAPTER**\\n# 10\\n\\n## Azure hosting recommendations for ASP.NET Core web apps\\n\\n\\n\\u201cLine\", \"-of-business leaders everywhere are bypassing IT departments to get applications from the cloud\\n(als\", \"o known as SaaS) and paying for them like they would a magazine subscription. And when the\\nservice i\", \"s no longer required, they can cancel the subscription with no equipment left unused in the\\ncorner.\\u201d\", \"\\n\\n_- Daryl Plummer, Gartner analyst_\\n\\n\\nWhatever your application\\u2019s needs and architecture, Microsoft\", \" Azure can support it. Your hosting\\nneeds can be as simple as a static website or a sophisticated ap\", \"plication made up of dozens of\\nservices. For ASP.NET Core monolithic web applications and supporting\", \" services, there are several\\nwell-known configurations that are recommended. The recommendations on \", \"this article are grouped\\nbased on the kind of resource to be hosted, whether full applications, indi\", \"vidual processes, or data.\\n\\n### Web applications\\n\\n\\nWeb applications can be hosted with:\\n\\n\\n  - App Se\", \"rvice Web Apps\\n\\n\\n  - Containers (several options)\\n\\n\\n  - Virtual Machines (VMs)\\n\\n\\nOf these, App Servi\", \"ce Web Apps is the recommended approach for most scenarios, including simple\\ncontainer-based apps. F\", \"or microservice architectures, consider a container-based approach. If you\\nneed more control over th\", \"e machines running your application, consider Azure Virtual Machines.\\n\\n#### **App Service Web Apps**\", \"\\n\\n\\nApp Service Web Apps offers a fully managed platform optimized for hosting web applications. It\\u2019s\", \" a\\nplatform as a service (PaaS) offering that lets you focus on your business logic, while Azure tak\", \"es care\\nof the infrastructure needed to run and scale the app. Some key features of App Service Web \", \"Apps:\\n\\n\\n101 CHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps\\n\\n\\n  - DevOps optimi\", \"zation (continuous integration and delivery, multiple environments, A/B\\ntesting, scripting support).\", \"\\n\\n\\n  - Global scale and high availability.\\n\\n\\n  - Connections to SaaS platforms and your on-premises \", \"data.\\n\\n\\n  - Security and compliance.\\n\\n\\n  - Visual Studio integration.\\n\\n\\nAzure App Service is the bes\", \"t choice for most web apps. Deployment and management are integrated\\ninto the platform, sites can sc\", \"ale quickly to handle high traffic loads, and the built-in load balancing\\nand traffic manager provid\", \"e high availability. You can move existing sites to Azure App Service easily\\nwith an online migratio\", \"n tool. You can use an open-source app from the Web Application Gallery, or\\ncreate a new site using \", \"the framework and tools of your choice. The WebJobs feature makes it easy to\\nadd background job proc\", \"essing to your App Service web app. If you have an existing ASP.NET\\napplication hosted on-premises u\", \"sing a local database, there\\u2019s a clear path to migrate. You can use\\nApp Service Web App with an Azur\", \"e SQL Database (or secure access to your on-premises database\\nserver, if preferred).\\n\\n\\nIn most cases\", \", moving from a locally hosted ASP.NET app to an App Service Web App is a\\nstraightforward process. L\", \"ittle or no modification should be required of the app itself, and it can\\nquickly start to take adva\", \"ntage of the many features that Azure App Service Web Apps offer.\\n\\n\\n102 CHAPTER 10 | Azure hosting r\", \"ecommendations for ASP.NET Core web apps\\n\\n\\nIn addition to apps that are not optimized for the cloud,\", \" Azure App Service Web Apps are an excellent\\nsolution for many simple monolithic (non-distributed) a\", \"pplications, such as many ASP.NET Core apps.\\nIn this approach, the architecture is basic and simple \", \"to understand and manage:\\n\\n\\nA small number of resources in a single resource group is typically suff\", \"icient to manage such an app.\\nApps that are typically deployed as a single unit, rather than those a\", \"pps that are made up of many\\n[separate processes, are good candidates for this basic architectural a\", \"pproach. Though architecturally](https://docs.microsoft.com/azure/architecture/reference-architectur\", \"es/app-service-web-app/basic-web-app)\\nsimple, this approach still allows the hosted app to scale bot\", \"h up (more resources per node) and out\\n(more hosted nodes) to meet any increase in demand. With auto\", \"scale, the app can be configured to\\nautomatically adjust the number of nodes hosting the app based o\", \"n demand and average load across\\nnodes.\\n\\n#### **App Service Web Apps for Containers**\\n\\n\\n[In addition\", \" to support for hosting web apps directly, App Service Web Apps for Containers](https://azure.micros\", \"oft.com/services/app-service/containers/) can be\\nused to run containerized applications on Windows a\", \"nd Linux. Using this service, you can easily\\ndeploy and run containerized applications that can scal\", \"e with your business. The apps have all of the\\nfeatures of App Service Web Apps listed above. In add\", \"ition, Web Apps for Containers supports\\nstreamlined CI/CD with Docker Hub, Azure Container Registry,\", \" and GitHub. You can use Azure DevOps\\nto define build and deployment pipelines that publish changes \", \"to a registry. These changes can then\\nbe tested in a staging environment and automatically deployed \", \"to production using deployment slots,\\nallowing zero-downtime upgrades. Rolling back to previous vers\", \"ions can be done just as easily.\\n\\n\\nThere are a few scenarios where Web Apps for Containers makes the\", \" most sense. If you have existing\\napps that you can containerize, whether in Windows or Linux contai\", \"ners, you can host these easily\\nusing this toolset. Just publish your container and then configure W\", \"eb Apps for Containers to pull the\\nlatest version of that image from your registry of choice. This i\", \"s a \\u201clift and shift\\u201d approach to migrating\\nfrom classic app hosting models to a cloud-optimized mode\", \"l.\\n\\n\\n103 CHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps\\n\\n\\nThis approach also w\", \"orks well if your development team is able to move to a container-based\\ndevelopment process. The \\u201cin\", \"ner loop\\u201d of developing apps with containers includes building the app\\nwith containers. Changes made\", \" to the code as well as to container configuration are pushed to source\\ncontrol, and an automated bu\", \"ild is responsible for publishing new container images to a registry like\\nDocker Hub or Azure Contai\", \"ner Registry. These images are then used as the basis for additional\\ndevelopment, as well as for dep\", \"loyments to production, as shown in the following diagram:\\n\\n\\n104 CHAPTER 10 | Azure hosting recommen\", \"dations for ASP.NET Core web apps\\n\\n\\nDeveloping with containers offers many advantages, especially wh\", \"en containers are used in\\nproduction. The same container configuration is used to host the app in ea\", \"ch environment in which it\\nruns, from the local development machine to build and test systems to pro\", \"duction. This approach\\ngreatly reduces the likelihood of defects resulting from differences in machi\", \"ne configuration or\\nsoftware versions. Developers can also use whatever tools they\\u2019re most productiv\", \"e with, including the\\noperating system, since containers can run on any OS. In some cases, distribut\", \"ed applications\\ninvolving many containers may be very resource-intensive to run on a single developm\", \"ent machine. In\\nthis scenario, it may make sense to upgrade to using Kubernetes and Azure Dev Spaces\", \", covered in\\nthe next section.\\n\\n\\nAs portions of larger applications are broken up into their own sma\", \"ller, independent _microservices_,\\nadditional design patterns can be used to improve app behavior. I\", \"nstead of working directly with\\nindividual services, an _API gateway_ can simplify access and decoup\", \"le the client from its back end.\\nHaving separate service back ends for different front ends also all\", \"ows services to evolve in concert\\nwith their consumers. Common services can be accessed via a separa\", \"te _sidecar_ container, which might\\ninclude common client connectivity libraries using the _ambassad\", \"or_ pattern.\\n\\n\\n105 CHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps\\n\\n\\n[Learn mor\", \"e about design patterns to consider when building microservice-based systems.](https://docs.microsof\", \"t.com/azure/architecture/microservices/design/patterns)\\n\\n#### **Azure Kubernetes Service**\\n\\n\\nAzure K\", \"ubernetes Service (AKS) manages your hosted Kubernetes environment, making it quick and\\neasy to depl\", \"oy and manage containerized applications without container orchestration expertise. It\\nalso eliminat\", \"es the burden of ongoing operations and maintenance by provisioning, upgrading, and\\nscaling resource\", \"s on-demand, without taking your applications offline.\\n\\n\\nAKS reduces the complexity and operational \", \"overhead of managing a Kubernetes cluster by\\noffloading much of that responsibility to Azure. As a h\", \"osted Kubernetes service, Azure handles critical\\ntasks like health monitoring and maintenance for yo\", \"u. Also, you pay only for the agent nodes within\\nyour clusters, not for the masters. As a managed Ku\", \"bernetes service, AKS provides:\\n\\n\\n  - Automated Kubernetes version upgrades and patching.\\n\\n  - Easy \", \"cluster scaling.\\n\\n  - Self-healing hosted control plane (masters).\\n\\n  - Cost savings - pay only for \", \"running agent pool nodes.\\n\\nWith Azure handling the management of the nodes in your AKS cluster, you \", \"no longer need to\\nperform many tasks manually, like cluster upgrades. Because Azure handles these cr\", \"itical maintenance\\ntasks for you, AKS doesn\\u2019t provide direct access (such as with SSH) to the cluste\", \"r.\\n\\n\\nTeams who are leveraging AKS can also take advantage of Azure Dev Spaces. Azure Dev Spaces help\", \"s\\nteams to focus on the development and rapid iteration of their microservice application by allowin\", \"g\\nteams to work directly with their entire microservices architecture or application running in AKS.\", \" Azure\\nDev Spaces also provides a way to independently update portions of your microservices archite\", \"cture\\nin isolation without affecting the rest of the AKS cluster or other developers.\\n\\n\\n106 CHAPTER \", \"10 | Azure hosting recommendations for ASP.NET Core web apps\\n\\n\\nAzure Dev Spaces:\\n\\n\\n  - Minimize loca\", \"l machine setup time and resource requirements\\n\\n  - Allow teams to iterate more rapidly\\n\\n  - Reduce \", \"the number of integration environments required by a team\\n\\n  - Remove the need to mock certain servi\", \"ces in a distributed system when developing/testing\\n\\n\\n[Learn more about Azure Dev Spaces](https://do\", \"cs.microsoft.com/azure/dev-spaces/about)\\n\\n#### **Azure Virtual Machines**\\n\\n\\nIf you have an existing \", \"application that would require substantial modifications to run in App Service,\\nyou could choose Vir\", \"tual Machines in order to simplify migrating to the cloud. However, correctly\\nconfiguring, securing,\", \" and maintaining VMs requires much more time and IT expertise compared to\\nAzure App Service. If you\\u2019\", \"re considering Azure Virtual Machines, make sure you take into account the\\nongoing maintenance effor\", \"t required to patch, update, and manage your VM environment. Azure\\nVirtual Machines is infrastructur\", \"e as a service (IaaS), while App Service is PaaS. You should also\\nconsider whether deploying your ap\", \"p as a Windows Container to Web App for Containers might be a\\nviable option for your scenario.\\n\\n### \", \"Logical processes\\n\\n\\nIndividual logical processes that can be decoupled from the rest of the applicat\", \"ion may be deployed\\nindependently to Azure Functions in a \\u201cserverless\\u201d manner. Azure Functions lets \", \"you just write the\\ncode you need for a given problem, without worrying about the application or infr\", \"astructure to run it.\\nYou can choose from a variety of programming languages, including C#, F#, Node\", \".js, Python, and\\nPHP, allowing you to pick the most productive language for the task at hand. Like m\", \"ost cloud-based\\nsolutions, you pay only for the amount of time your use, and you can trust Azure Fun\", \"ctions to scale up\\nas needed.\\n\\n### Data\\n\\n\\nAzure offers a wide variety of data storage options, so th\", \"at your application can use the appropriate\\ndata provider for the data in question.\\n\\n\\n107 CHAPTER 10\", \" | Azure hosting recommendations for ASP.NET Core web apps\\n\\n\\nFor transactional, relational data, Azu\", \"re SQL Databases are the best option. For high performance\\nread-mostly data, a Redis cache backed by\", \" an Azure SQL Database is a good solution.\\n\\n\\nUnstructured JSON data can be stored in a variety of wa\", \"ys, from SQL Database columns to Blobs or\\nTables in Azure Storage, to Azure Cosmos DB. Of these, Azu\", \"re Cosmos DB offers the best querying\\nfunctionality, and is the recommended option for large numbers\", \" of JSON-based documents that must\\nsupport querying.\\n\\n\\nTransient command- or event-based data used t\", \"o orchestrate application behavior can use Azure\\nService Bus or Azure Storage Queues. Azure Service \", \"Bus offers more flexibility and is the\\nrecommended service for non-trivial messaging within and betw\", \"een applications.\\n\\n### Architecture recommendations\\n\\n\\nYour application\\u2019s requirements should dictate\", \" its architecture. There are many different Azure\\nservices available. Choosing the right one is an i\", \"mportant decision. Microsoft offers a gallery of\\nreference architectures to help identify typical ar\", \"chitectures optimized for common scenarios. You\\nmay find a reference architecture that maps closely \", \"to your application\\u2019s requirements, or at least\\noffers a starting point.\\n\\n\\nFigure 11-1 shows an exam\", \"ple reference architecture. This diagram describes a recommended\\narchitecture approach for a Sitecor\", \"e content management system website optimized for marketing.\\n\\n\\n_Figure 11-1. Sitecore marketing webs\", \"ite reference architecture._\\n\\n\\n**References \\u2013 Azure hosting recommendations**\\n\\n\\n  - Azure Solution A\", \"rchitectures\\n[https://azure.microsoft.com/solutions/architecture/](https://azure.microsoft.com/solut\", \"ions/architecture/)\\n\\n\\n108 CHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps\\n\\n\\n  -\", \" Azure Basic Web Application Architecture\\n[https://learn.microsoft.com/azure/architecture/reference-\", \"architectures/app-service-web-](https://docs.microsoft.com/azure/architecture/reference-architecture\", \"s/app-service-web-app/basic-web-app)\\n[app/basic-web-app](https://docs.microsoft.com/azure/architectu\", \"re/reference-architectures/app-service-web-app/basic-web-app)\\n\\n\\n  - Design Patterns for Microservice\", \"s\\n[https://learn.microsoft.com/azure/architecture/microservices/design/patterns](https://docs.micros\", \"oft.com/azure/architecture/microservices/design/patterns)\\n\\n\\n  - Azure Developer Guide\\n[https://azure\", \".microsoft.com/campaigns/developer-guide/](https://azure.microsoft.com/campaigns/developer-guide/)\\n\\n\", \"\\n  - Web Apps overview\\n[https://learn.microsoft.com/azure/app-service/app-service-web-overview](http\", \"s://docs.microsoft.com/azure/app-service/app-service-web-overview)\\n\\n\\n  - Web App for Containers\\n[htt\", \"ps://azure.microsoft.com/services/app-service/containers/](https://azure.microsoft.com/services/app-\", \"service/containers/)\\n\\n\\n  - Introduction to Azure Kubernetes Service (AKS)\\n[https://learn.microsoft.c\", \"om/azure/aks/intro-kubernetes](https://docs.microsoft.com/azure/aks/intro-kubernetes)\\n\\n\\n109 CHAPTER \", \"10 | Azure hosting recommendations for ASP.NET Core web apps\\n\\n\\n\"]"