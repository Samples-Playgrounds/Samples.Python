"[\"\\n\\n\\fEDITION v8.0 - Updated to ASP.NET Core 8.0\\n\\nRefer changelog for the book updates and community co\", \"ntributions.\\n\\nPUBLISHED BY\\n\\nMicrosoft Developer Division, .NET, and Visual Studio product teams\\n\\nA d\", \"ivision of Microsoft Corporation\\n\\nOne Microsoft Way\\n\\nRedmond, Washington 98052-6399\\n\\nCopyright \\u00a9 202\", \"3 by Microsoft Corporation\\n\\nAll rights reserved. No part of the contents of this book may be reprodu\", \"ced or transmitted in any\\nform or by any means without the written permission of the publisher.\\n\\nThi\", \"s book is provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The views, opinions, and\\ni\", \"nformation expressed in this book, including URL and other Internet website references, may change\\nw\", \"ithout notice.\\n\\nSome examples depicted herein are provided for illustration only and are fictitious.\", \" No real association\\nor connection is intended or should be inferred.\\n\\nMicrosoft and the trademarks \", \"listed at https://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are\\ntrademarks of the Microsoft grou\", \"p of companies.\\n\\nMac and macOS are trademarks of Apple Inc.\\n\\nThe Docker whale logo is a registered t\", \"rademark of Docker, Inc. Used by permission.\\n\\nAll other marks and logos are property of their respec\", \"tive owners.\\n\\nAuthor:\\n\\nSteve \\u201cardalis\\u201d Smith - Software Architect and Trainer - Ardalis.com\\n\\nEditors\", \":\\n\\nMaira Wenzel\\n\\nAction links\\n\\n\\u2022\\n\\n\\u2022\\n\\nThis e-book is also available in a PDF format (English version \", \"only) Download\\n\\nClone/Fork the reference application eShopOnWeb on GitHub\\n\\nIntroduction\\n\\n.NET 8 and \", \"ASP.NET Core offer several advantages over traditional .NET development. You should use\\n.NET 8 for y\", \"our server applications if some or all of the following are important to your application\\u2019s\\nsuccess:\", \"\\n\\n\\u2022\\n\\nCross-platform support.\\n\\n\\f\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nUse of microservices.\\n\\nUse of Docker containers.\\n\\nHigh pe\", \"rformance and scalability requirements.\\n\\nSide-by-side versioning of .NET versions by application on \", \"the same server.\\n\\nTraditional .NET 4.x apps can and do support many of these requirements, but ASP.N\", \"ET Core and .NET\\n8 have been optimized to offer improved support for the above scenarios.\\n\\nMore and \", \"more organizations are choosing to host their web applications in the cloud using services\\nlike Micr\", \"osoft Azure. You should consider hosting your application in the cloud if the following are\\nimportan\", \"t to your application or organization:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nReduced investment in data center costs (hard\", \"ware, software, space, utilities, server\\nmanagement, etc.)\\n\\nFlexible pricing (pay based on usage, no\", \"t for idle capacity).\\n\\nExtreme reliability.\\n\\nImproved app mobility; easily change where and how your\", \" app is deployed.\\n\\nFlexible capacity; scale up or down based on actual needs.\\n\\nBuilding web applicat\", \"ions with ASP.NET Core, hosted in Azure, offers many competitive advantages\\nover traditional alterna\", \"tives. ASP.NET Core is optimized for modern web application development\\npractices and cloud hosting \", \"scenarios. In this guide, you\\u2019ll learn how to architect your ASP.NET Core\\napplications to best take \", \"advantage of these capabilities.\\n\\nVersion\\n\\nThis guide has been revised to cover .NET 8.0 version alo\", \"ng with many additional updates related to\\nthe same \\u201cwave\\u201d of technologies (that is, Azure and addit\", \"ional third-party technologies) coinciding in\\ntime with the .NET 8.0 release. That\\u2019s why the book ve\", \"rsion has also been updated to version 8.0.\\n\\nPurpose\\n\\nThis guide provides end-to-end guidance on bui\", \"lding monolithic web applications using ASP.NET\\nCore and Azure. In this context, \\u201cmonolithic\\u201d refers\", \" to the fact that these applications are deployed as\\na single unit, not as a collection of interacti\", \"ng services and applications. In some contexts, the term\\nmonolith may be used as a pejorative, but i\", \"n the vast majority of situations a single application is\\nmuch easier to build, deploy, and debug th\", \"an an app composed of many different services, while still\\nachieving the business requirements.\\n\\nThi\", \"s guide is complementary to \\u201c.NET Microservices. Architecture for Containerized .NET Applications\\u201d,\\n\", \"which focuses more on Docker, microservices, and deployment of containers to host enterprise\\napplica\", \"tions.\\n\\n\\f.NET Microservices. Architecture for Containerized .NET Applications\\n\\n\\u2022\\n\\n\\u2022\\n\\ne-book\\nhttps://\", \"aka.ms/MicroservicesEbook\\n\\nSample Application\\nhttps://aka.ms/microservicesarchitecture\\n\\nWho should u\", \"se this guide\\n\\nThe audience for this guide is mainly developers, development leads, and architects w\", \"ho are\\ninterested in building modern web applications using Microsoft technologies and services in t\", \"he\\ncloud.\\n\\nA secondary audience is technical decision makers who are already familiar ASP.NET or Azu\", \"re and are\\nlooking for information on whether it makes sense to upgrade to ASP.NET Core for new or e\", \"xisting\\nprojects.\\n\\nHow you can use this guide\\n\\nThis guide has been condensed into a relatively small\", \" document that focuses on building web\\napplications with modern .NET technologies and Azure. As such\", \", it can be read in its entirety to\\nprovide a foundation of understanding such applications and thei\", \"r technical considerations. The\\nguide, along with its sample application, can also serve as a starti\", \"ng point or reference. Use the\\nassociated sample application as a template for your own applications\", \", or to see how you might\\norganize your application\\u2019s component parts. Refer back to the guide\\u2019s pri\", \"nciples and coverage of\\narchitecture and technology options and decision considerations when you\\u2019re \", \"weighing these choices\\nfor your own application.\\n\\nFeel free to forward this guide to your team to he\", \"lp ensure a common understanding of these\\nconsiderations and opportunities. Having everybody working\", \" from a common set of terminology and\\nunderlying principles helps ensure consistent application of a\", \"rchitectural patterns and practices.\\n\\nReferences\\n\\n\\u2022\\n\\nChoosing between .NET and .NET Framework for se\", \"rver apps\\nhttps://learn.microsoft.com/dotnet/standard/choosing-core-framework-server\\n\\n\\fContents\\n\\nCha\", \"racteristics of Modern Web Applications ............................................................\", \"........... 1\\n\\nReference application: eShopOnWeb ...................................................\", \"........................................................................... 1\\n\\nReference Application\", \" ...................................................................................................\", \".................................................... 2\\n\\nCloud-hosted and scalable ..................\", \"....................................................................................................\", \"............................ 2\\n\\nCross platform .....................................................\", \"....................................................................................................\", \".................. 2\\n\\nModular and loosely coupled ..................................................\", \"........................................................................................... 3\\n\\nEasil\", \"y tested with automated tests ......................................................................\", \"............................................................. 3\\n\\nTraditional and SPA behaviors suppo\", \"rted ...............................................................................................\", \"...................... 3\\n\\nSimple development and deployment ........................................\", \".................................................................................... 4\\n\\nTraditional \", \"ASP.NET and Web Forms ..............................................................................\", \"................................................. 4\\n\\nBlazor ........................................\", \"....................................................................................................\", \"................................................ 4\\n\\nReferences \\u2013 Modern Web Applications ...........\", \"....................................................................................................\", \".... 4\\n\\nChoose Between Traditional Web Apps and Single Page Apps (SPAs) ............................\", \". 6\\n\\nBlazor ........................................................................................\", \"....................................................................................................\", \" 7\\n\\nWhen to choose traditional web apps ............................................................\", \"................................................................ 7\\n\\nWhen to choose SPAs ............\", \"....................................................................................................\", \"............................................ 8\\n\\nReferences \\u2013 SPA Frameworks ........................\", \"....................................................................................................\", \"........... 8\\n\\nWhen to choose Blazor ...............................................................\", \".......................................................................................... 9\\n\\nDecisi\", \"on table ...........................................................................................\", \"................................................................................. 9\\n\\nOther considera\", \"tions ..............................................................................................\", \"................................................................ 9\\n\\nArchitectural principles .......\", \".................................................................................................. 1\", \"1\\n\\nCommon design principles ........................................................................\", \"....................................................................... 11\\n\\nSeparation of concerns .\", \"....................................................................................................\", \"............................................. 11\\n\\nEncapsulation ....................................\", \"....................................................................................................\", \"............................. 11\\n\\nDependency inversion .............................................\", \"....................................................................................................\", \"... 12\\n\\nExplicit dependencies ......................................................................\", \"............................................................................... 14\\n\\nSingle responsib\", \"ility ..............................................................................................\", \".......................................................... 14\\n\\nDon\\u2019t repeat yourself (DRY) .........\", \"....................................................................................................\", \"............................ 15\\n\\ni\\n\\nContents\\n\\n\\fPersistence ignorance ...............................\", \"....................................................................................................\", \"................. 15\\n\\nBounded contexts .............................................................\", \"............................................................................................... 16\\n\\n\", \"Additional resources ...............................................................................\", \"............................................................................. 16\\n\\nCommon web applica\", \"tion architectures ............................................................................. 17\\n\", \"\\nWhat is a monolithic application? .................................................................\", \"................................................................. 17\\n\\nAll-in-one applications ......\", \"....................................................................................................\", \"............................................. 17\\n\\nWhat are layers? .................................\", \"....................................................................................................\", \"............................... 18\\n\\nTraditional \\u201cN-Layer\\u201d architecture applications ................\", \"........................................................................................ 19\\n\\nClean a\", \"rchitecture ........................................................................................\", \"......................................................................... 23\\n\\nOrganizing code in Cle\", \"an Architecture ....................................................................................\", \"............................... 28\\n\\nMonolithic applications and containers .........................\", \".............................................................................................. 30\\n\\nM\", \"onolithic application deployed as a container ......................................................\", \"........................................... 31\\n\\nDocker support .....................................\", \"....................................................................................................\", \"............................. 33\\n\\nTroubleshooting Docker problems ..................................\", \"......................................................................................... 34\\n\\nOther \", \"web application architectural styles ...............................................................\", \".............................................. 34\\n\\nReferences \\u2013 Common web architectures ...........\", \"................................................................................................... \", \"34\\n\\nCommon client-side web technologies ............................................................\", \"................... 36\\n\\nHTML .......................................................................\", \"....................................................................................................\", \"............... 36\\n\\nCSS ............................................................................\", \"....................................................................................................\", \".............. 36\\n\\nCSS preprocessors ...............................................................\", \"............................................................................................ 37\\n\\nJav\", \"aScript ............................................................................................\", \"..................................................................................... 38\\n\\nLegacy web\", \" apps with jQuery ..................................................................................\", \"................................................... 38\\n\\njQuery vs a SPA Framework ..................\", \"....................................................................................................\", \"................... 38\\n\\nAngular SPAs ...............................................................\", \"....................................................................................................\", \"... 39\\n\\nReact ......................................................................................\", \"................................................................................................ 40\\n\", \"\\nVue ...............................................................................................\", \".......................................................................................... 40\\n\\nBlazo\", \"r WebAssembly ......................................................................................\", \"................................................................ 41\\n\\nChoosing a SPA Framework ......\", \"....................................................................................................\", \"............................... 41\\n\\nReferences \\u2013 Client Web Technologies ...........................\", \"........................................................................................ 42\\n\\nDevelop\", \" ASP.NET Core MVC apps .............................................................................\", \".......... 43\\n\\nMVC and Razor Pages .................................................................\", \"........................................................................................ 43\\n\\nii\\n\\nCon\", \"tents\\n\\n\\fWhy Razor Pages?............................................................................\", \"................................................................................ 44\\n\\nWhen to use MVC\", \" ...................................................................................................\", \"......................................................... 44\\n\\nMapping requests to responses ........\", \"....................................................................................................\", \"......................... 44\\n\\nKeeping controllers under control ....................................\", \"........................................................................................ 46\\n\\nReferen\", \"ces \\u2013 Mapping Requests to Responses ................................................................\", \"................................... 48\\n\\nWorking with dependencies ..................................\", \"....................................................................................................\", \"....... 48\\n\\nDeclare your dependencies ..............................................................\", \"............................................................................ 49\\n\\nStructuring the app\", \"lication ...........................................................................................\", \".................................................... 50\\n\\nFeature organization ......................\", \"....................................................................................................\", \"............................. 51\\n\\nAPIs and Blazor applications .....................................\", \"................................................................................................... \", \"53\\n\\nCross-cutting concerns .........................................................................\", \"......................................................................... 54\\n\\nReferences \\u2013 Structuri\", \"ng applications ....................................................................................\", \"................................. 57\\n\\nSecurity .....................................................\", \"....................................................................................................\", \"............................ 57\\n\\nIdentity ..........................................................\", \"....................................................................................................\", \"................... 57\\n\\nAuthentication .............................................................\", \"....................................................................................................\", \".. 60\\n\\nReferences \\u2013 Authentication .................................................................\", \"....................................................................... 61\\n\\nAuthorization ..........\", \"....................................................................................................\", \"....................................................... 61\\n\\nReferences \\u2013 Security ..................\", \"....................................................................................................\", \"................................ 64\\n\\nClient communication ..........................................\", \"....................................................................................................\", \"........... 64\\n\\nReferences \\u2013 Client Communication ..................................................\", \"...................................................................... 65\\n\\nDomain-driven design \\u2013 Sh\", \"ould you apply it? .................................................................................\", \"......................... 65\\n\\nWhen should you apply DDD ............................................\", \".......................................................................................... 66\\n\\nWhen \", \"shouldn\\u2019t you apply DDD ............................................................................\", \".................................................... 66\\n\\nReferences \\u2013 Domain-Driven Design .........\", \"....................................................................................................\", \".......... 67\\n\\nDeployment ..........................................................................\", \"................................................................................................... \", \"67\\n\\nReferences \\u2013 Deployment ........................................................................\", \"..................................................................... 68\\n\\nWorking with Data in ASP.N\", \"ET Core Apps ......................................................................... 69\\n\\nEntity Fr\", \"amework Core (for relational databases) ............................................................\", \"........................................ 69\\n\\nThe DbContext .........................................\", \"....................................................................................................\", \"..................... 69\\n\\nConfiguring EF Core ......................................................\", \".................................................................................................. 7\", \"0\\n\\nFetching and storing Data .......................................................................\", \"..................................................................... 71\\n\\nFetching related data ....\", \"....................................................................................................\", \".............................................. 72\\n\\niii\\n\\nContents\\n\\n\\fEncapsulating data ..............\", \"....................................................................................................\", \"........................................ 73\\n\\nResilient connections .................................\", \"....................................................................................................\", \"................. 74\\n\\nReferences \\u2013 Entity Framework Core ...........................................\", \"............................................................................. 76\\n\\nEF Core or micro-O\", \"RM? ................................................................................................\", \"..................................................... 76\\n\\nSQL or NoSQL .............................\", \"....................................................................................................\", \"....................................... 77\\n\\nAzure Cosmos DB ........................................\", \"....................................................................................................\", \"..................... 78\\n\\nOther persistence options ................................................\", \"................................................................................................. 79\", \"\\n\\nCaching ..........................................................................................\", \"........................................................................................... 80\\n\\nASP.\", \"NET Core response caching ..........................................................................\", \"...................................................... 80\\n\\nData caching ............................\", \"....................................................................................................\", \"...................................... 81\\n\\nGetting data to Blazor WebAssembly apps .................\", \"............................................................................................... 83\\n\\n\", \"Test ASP.NET Core MVC apps .........................................................................\", \"..................... 85\\n\\nKinds of automated tests .................................................\", \".................................................................................................. 8\", \"5\\n\\nUnit tests ......................................................................................\", \"........................................................................................ 85\\n\\nIntegra\", \"tion tests .........................................................................................\", \"....................................................................... 85\\n\\nFunctional tests .......\", \"....................................................................................................\", \"...................................................... 86\\n\\nTesting Pyramid .........................\", \"....................................................................................................\", \"................................... 86\\n\\nWhat to test ...............................................\", \"....................................................................................................\", \"..................... 87\\n\\nOrganizing test projects .................................................\", \"....................................................................................................\", \" 88\\n\\nTest naming ...................................................................................\", \"..................................................................................... 89\\n\\nUnit testi\", \"ng ASP.NET Core apps ...............................................................................\", \"...................................................... 91\\n\\nIntegration testing ASP.NET Core apps ...\", \"....................................................................................................\", \"................ 92\\n\\nFunctional testing ASP.NET Core apps ..........................................\", \"............................................................................... 92\\n\\nReferences \\u2013 Tes\", \"t ASP.NET Core MVC apps ............................................................................\", \".............................. 95\\n\\nDevelopment process for Azure ...................................\", \"....................................................... 96\\n\\nVision .................................\", \"....................................................................................................\", \".................................................... 96\\n\\nDevelopment environment for ASP.NET Core ap\", \"ps ............................................................................................... 9\", \"6\\n\\nDevelopment tools choices: IDE or editor ........................................................\", \"...................................................... 96\\n\\nDevelopment workflow for Azure-hosted ASP\", \".NET Core apps .......................................................................... 97\\n\\nInitia\", \"l setup ............................................................................................\", \"............................................................................. 97\\n\\nWorkflow for devel\", \"oping Azure-hosted ASP.NET Core applications .......................................................\", \"... 98\\n\\nReferences .................................................................................\", \"............................................................................................ 100\\n\\niv\", \"\\n\\nContents\\n\\n\\fAzure hosting recommendations for ASP.NET Core web apps ...............................\", \"....... 101\\n\\nWeb applications ......................................................................\", \".......................................................................................... 101\\n\\nApp \", \"Service Web Apps ...................................................................................\", \"............................................................. 101\\n\\nApp Service Web Apps for Containe\", \"rs .................................................................................................\", \"................. 103\\n\\nAzure Kubernetes Service ....................................................\", \"....................................................................................... 106\\n\\nAzure V\", \"irtual Machines ....................................................................................\", \"............................................................ 107\\n\\nLogical processes ................\", \"....................................................................................................\", \"............................................ 107\\n\\nData .............................................\", \"....................................................................................................\", \"......................................... 107\\n\\nArchitecture recommendations ........................\", \"....................................................................................................\", \"......... 108\\n\\nv\\n\\nContents\\n\\n\\fCHAPTER  1\\n\\nCharacteristics of Modern\\nWeb Applications\\n\\n\\u201c\\u2026 with proper \", \"design, the features come cheaply. This approach is arduous, but continues to\\nsucceed.\\u201d\\n- Dennis Rit\", \"chie\\n\\nModern web applications have higher user expectations and greater demands than ever before.\\nTo\", \"day\\u2019s web apps are expected to be available 24/7 from anywhere in the world, and usable from\\nvirtual\", \"ly any device or screen size. Web applications must be secure, flexible, and scalable to meet\\nspikes\", \" in demand. Increasingly, complex scenarios should be handled by rich user experiences built on\\nthe \", \"client using JavaScript, and communicating efficiently through web APIs.\\n\\nASP.NET Core is optimized \", \"for modern web applications and cloud-based hosting scenarios. Its\\nmodular design enables applicatio\", \"ns to depend on only those features they actually use, improving\\napplication security and performanc\", \"e while reducing hosting resource requirements.\\n\\nReference application: eShopOnWeb\\n\\nThis guidance in\", \"cludes a reference application, eShopOnWeb, that demonstrates some of the\\nprinciples and recommendat\", \"ions. The application is a simple online store, which supports browsing\\nthrough a catalog of shirts,\", \" coffee mugs, and other marketing items. The reference application is\\ndeliberately simple in order t\", \"o make it easy to understand.\\n\\n1\\n\\nCHAPTER 1 | Characteristics of Modern Web Applications\\n\\n\\fFigure 2-\", \"1. eShopOnWeb\\n\\nReference Application\\n\\n\\u2022\\n\\neShopOnWeb\\nhttps://github.com/dotnet/eShopOnWeb\\n\\nCloud-host\", \"ed and scalable\\n\\nASP.NET Core is optimized for the cloud (public cloud, private cloud, any cloud) be\", \"cause it is low-\\nmemory and high-throughput. The smaller footprint of ASP.NET Core applications mean\", \"s you can\\nhost more of them on the same hardware, and you pay for fewer resources when using pay-as-\", \"you-\\ngo cloud hosting services. The higher-throughput means you can serve more customers from an\\napp\", \"lication given the same hardware, further reducing the need to invest in servers and hosting\\ninfrast\", \"ructure.\\n\\nCross platform\\n\\nASP.NET Core is cross-platform and can run on Linux, macOS, and Windows. T\", \"his capability opens up\\nmany new options for both the development and deployment of apps built with \", \"ASP.NET Core.\\n\\n2\\n\\nCHAPTER 1 | Characteristics of Modern Web Applications\\n\\n\\fDocker containers - both \", \"Linux and Windows - can host ASP.NET Core applications, allowing them to\\ntake advantage of the benef\", \"its of containers and microservices.\\n\\nModular and loosely coupled\\n\\nNuGet packages are first-class ci\", \"tizens in .NET Core, and ASP.NET Core apps are composed of many\\nlibraries through NuGet. This granul\", \"arity of functionality helps ensure apps only depend on and\\ndeploy functionality they actually requi\", \"re, reducing their footprint and security vulnerability surface\\narea.\\n\\nASP.NET Core also fully suppo\", \"rts dependency injection, both internally and at the application level.\\nInterfaces can have multiple\", \" implementations that can be swapped out as needed. Dependency\\ninjection allows apps to loosely coup\", \"le to those interfaces, rather than specific implementations,\\nmaking them easier to extend, maintain\", \", and test.\\n\\nEasily tested with automated tests\\n\\nASP.NET Core applications support unit testing, and\", \" their loose coupling and support for dependency\\ninjection makes it easy to swap infrastructure conc\", \"erns with fake implementations for test purposes.\\nASP.NET Core also ships with a TestServer that can\", \" be used to host apps in memory. Functional tests\\ncan then make requests to this in-memory server, e\", \"xercising the full application stack (including\\nmiddleware, routing, model binding, filters, etc.) a\", \"nd receiving a response, all in a fraction of the time\\nit would take to host the app on a real serve\", \"r and make requests through the network layer. These\\ntests are especially easy to write, and valuabl\", \"e, for APIs, which are increasingly important in modern\\nweb applications.\\n\\nTraditional and SPA behav\", \"iors supported\\n\\nTraditional web applications have involved little client-side behavior, but instead \", \"have relied on the\\nserver for all navigation, queries, and updates the app might need to make. Each \", \"new operation made\\nby the user would be translated into a new web request, with the result being a f\", \"ull page reload in the\\nend user\\u2019s browser. Classic Model-View-Controller (MVC) frameworks typically \", \"follow this approach,\\nwith each new request corresponding to a different controller action, which in\", \" turn would work with a\\nmodel and return a view. Some individual operations on a given page might be\", \" enhanced with AJAX\\n(Asynchronous JavaScript and XML) functionality, but the overall architecture of\", \" the app used many\\ndifferent MVC views and URL endpoints. In addition, ASP.NET Core MVC also support\", \"s Razor Pages, a\\nsimpler way to organize MVC-style pages.\\n\\nSingle Page Applications (SPAs), by contr\", \"ast, involve very few dynamically generated server-side page\\nloads (if any). Many SPAs are initializ\", \"ed within a static HTML file that loads the necessary JavaScript\\nlibraries to start and run the app.\", \" These apps make heavy usage of web APIs for their data needs and\\ncan provide much richer user exper\", \"iences. Blazor WebAssembly provides a means of building SPAs\\nusing .NET code, which then runs in the\", \" client\\u2019s browser.\\n\\n3\\n\\nCHAPTER 1 | Characteristics of Modern Web Applications\\n\\n\\fMany web application\", \"s involve a combination of traditional web application behavior (typically for\\ncontent) and SPAs (fo\", \"r interactivity). ASP.NET Core supports both MVC (Views or Page based) and web\\nAPIs in the same appl\", \"ication, using the same set of tools and underlying framework libraries.\\n\\nSimple development and dep\", \"loyment\\n\\nASP.NET Core applications can be written using simple text editors and command-line interfa\", \"ces, or\\nfull-featured development environments like Visual Studio. Monolithic applications are typic\", \"ally\\ndeployed to a single endpoint. Deployments can easily be automated to occur as part of a contin\", \"uous\\nintegration (CI) and continuous delivery (CD) pipeline. In addition to traditional CI/CD tools,\", \" Microsoft\\nAzure has integrated support for git repositories and can automatically deploy updates as\", \" they are\\nmade to a specified git branch or tag. Azure DevOps provides a full-featured CI/CD build a\", \"nd\\ndeployment pipeline, and GitHub Actions provide another option for projects hosted there.\\n\\nTradit\", \"ional ASP.NET and Web Forms\\n\\nIn addition to ASP.NET Core, traditional ASP.NET 4.x continues to be a \", \"robust and reliable platform for\\nbuilding web applications. ASP.NET supports MVC and Web API develop\", \"ment models, as well as Web\\nForms, which is well suited to rich page-based application development a\", \"nd features a rich third-party\\ncomponent ecosystem. Microsoft Azure has great longstanding support f\", \"or ASP.NET 4.x applications,\\nand many developers are familiar with this platform.\\n\\nBlazor\\n\\nBlazor is\", \" included with ASP.NET Core 3.0 and later. It provides a new mechanism for building rich\\ninteractive\", \" web client applications using Razor, C#, and ASP.NET Core. It offers another solution to\\nconsider w\", \"hen developing modern web applications. There are two versions of Blazor to consider:\\nserver-side an\", \"d client-side.\\n\\nServer-side Blazor was released in 2019 with ASP.NET Core 3.0. As its name implies, \", \"it runs on the\\nserver, rendering changes to the client document back to the browser over the network\", \". Server-side\\nBlazor provides a rich client experience without requiring client-side JavaScript and \", \"without requiring\\nseparate page loads for each client page interaction. Changes in the loaded page a\", \"re requested from\\nand processed by the server and then sent back to the client using SignalR.\\n\\nClien\", \"t-side Blazor, released in 2020, eliminates the need to render changes on the server. Instead, it\\nle\", \"verages WebAssembly to run .NET code within the client. The client can still make API calls to the\\ns\", \"erver if needed to request data, but all client-side behavior runs in the client via WebAssembly, wh\", \"ich\\nis already supported by all major browsers and is just a JavaScript library.\\n\\nReferences \\u2013 Moder\", \"n Web Applications\\n\\n\\u2022\\n\\nIntroduction to ASP.NET Core\\nhttps://learn.microsoft.com/aspnet/core/\\n\\n4\\n\\nCHA\", \"PTER 1 | Characteristics of Modern Web Applications\\n\\n\\f\\u2022\\n\\n\\u2022\\n\\nTesting in ASP.NET Core\\nhttps://learn.mi\", \"crosoft.com/aspnet/core/testing/\\n\\nBlazor - Get Started\\nhttps://blazor.net/docs/get-started.html\\n\\n5\\n\\n\", \"CHAPTER 1 | Characteristics of Modern Web Applications\\n\\n\\fCHAPTER  2\\n\\nChoose Between\\nTraditional Web \", \"Apps and\\nSingle Page Apps (SPAs)\\n\\n\\u201cAtwood\\u2019s Law: Any application that can be written in JavaScript, \", \"will eventually be written in\\nJavaScript.\\u201d\\n- Jeff Atwood\\n\\nThere are two general approaches to buildi\", \"ng web applications today: traditional web applications\\nthat perform most of the application logic o\", \"n the server, and single-page applications (SPAs) that\\nperform most of the user interface logic in a\", \" web browser, communicating with the web server\\nprimarily using web APIs. A hybrid approach is also \", \"possible, the simplest being host one or more rich\\nSPA-like subapplications within a larger traditio\", \"nal web application.\\n\\nUse traditional web applications when:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nYour application\\u2019s client-sid\", \"e requirements are simple or even read-only.\\n\\nYour application needs to function in browsers without\", \" JavaScript support.\\n\\nYour application is public-facing and benefits from search engine discovery an\", \"d referrals.\\n\\nUse a SPA when:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nYour application must expose a rich user interface with many\", \" features.\\n\\nYour team is familiar with JavaScript, TypeScript, or Blazor WebAssembly development.\\n\\nY\", \"our application must already expose an API for other (internal or public) clients.\\n\\nAdditionally, SP\", \"A frameworks require greater architectural and security expertise. They experience\\ngreater churn due\", \" to frequent updates and new client frameworks than traditional web applications.\\nConfiguring automa\", \"ted build and deployment processes and utilizing deployment options like\\ncontainers may be more diff\", \"icult with SPA applications than traditional web apps.\\n\\nImprovements in user experience made possibl\", \"e by the SPA approach must be weighed against these\\nconsiderations.\\n\\n6\\n\\nCHAPTER 2 | Choose Between T\", \"raditional Web Apps and Single Page Apps (SPAs)\\n\\n\\fBlazor\\n\\nASP.NET Core includes a model for building\", \" rich, interactive, and composable user interfaces called\\nBlazor. Blazor server-side allows develope\", \"rs to build UI with C# and Razor on the server and for the UI\\nto be interactively connected to the b\", \"rowser in real-time using a persistent SignalR connection. Blazor\\nWebAssembly introduces another opt\", \"ion for Blazor apps, allowing them to run in the browser using\\nWebAssembly. Because it\\u2019s real .NET c\", \"ode running on WebAssembly, you can reuse code and libraries\\nfrom server-side parts of your applicat\", \"ion.\\n\\nBlazor provides a new, third option to consider when evaluating whether to build a purely serv\", \"er-\\nrendered web application or a SPA. You can build rich, SPA-like client-side behaviors using Blaz\", \"or,\\nwithout the need for significant JavaScript development. Blazor applications can call APIs to re\", \"quest\\ndata or perform server-side operations. They can interoperate with JavaScript where necessary \", \"to take\\nadvantage of JavaScript libraries and frameworks.\\n\\nConsider building your web application wi\", \"th Blazor when:\\n\\n\\u2022\\n\\n\\u2022\\n\\nYour application must expose a rich user interface\\n\\nYour team is more comfort\", \"able with .NET development than JavaScript or TypeScript\\ndevelopment\\n\\nIf you have an existing web fo\", \"rms application you\\u2019re considering migrating to .NET Core or the latest\\n.NET, you may wish to review\", \" the free e-book, Blazor for Web Forms Developers to see whether it\\nmakes sense to consider migratin\", \"g it to Blazor.\\n\\nFor more information about Blazor, see Get started with Blazor.\\n\\nWhen to choose tra\", \"ditional web apps\\n\\nThe following section is a more detailed explanation of the previously stated rea\", \"sons for picking\\ntraditional web applications.\\n\\nYour application has simple, possibly read-only, cli\", \"ent-side requirements\\n\\nMany web applications are primarily consumed in a read-only fashion by the va\", \"st majority of their\\nusers. Read-only (or read-mostly) applications tend to be much simpler than tho\", \"se applications that\\nmaintain and manipulate a great deal of state. For example, a search engine mig\", \"ht consist of a single\\nentry point with a textbox and a second page for displaying search results. A\", \"nonymous users can\\neasily make requests, and there is little need for client-side logic. Likewise, a\", \" blog or content\\nmanagement system\\u2019s public-facing application usually consists mainly of content wi\", \"th little client-\\nside behavior. Such applications are easily built as traditional server-based web \", \"applications, which\\nperform logic on the web server and render HTML to be displayed in the browser. \", \"The fact that each\\nunique page of the site has its own URL that can be bookmarked and indexed by sea\", \"rch engines (by\\ndefault, without having to add this functionality as a separate feature of the appli\", \"cation) is also a clear\\nbenefit in such scenarios.\\n\\nYour application needs to function in browsers w\", \"ithout JavaScript support\\n\\n7\\n\\nCHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (\", \"SPAs)\\n\\n\\fWeb applications that need to function in browsers with limited or no JavaScript support sho\", \"uld be\\nwritten using traditional web app workflows (or at least be able to fall back to such behavio\", \"r). SPAs\\nrequire client-side JavaScript in order to function; if it\\u2019s not available, SPAs are not a \", \"good choice.\\n\\nYour team is unfamiliar with JavaScript or TypeScript development techniques\\n\\nIf your \", \"team is unfamiliar with JavaScript or TypeScript, but is familiar with server-side web application\\nd\", \"evelopment, then they will probably be able to deliver a traditional web app more quickly than a\\nSPA\", \". Unless learning to program SPAs is a goal, or the user experience afforded by a SPA is required,\\nt\", \"raditional web apps are a more productive choice for teams who are already familiar with building\\nth\", \"em.\\n\\nWhen to choose SPAs\\n\\nThe following section is a more detailed explanation of when to choose a S\", \"ingle Page Applications\\nstyle of development for your web app.\\n\\nYour application must expose a rich \", \"user interface with many features\\n\\nSPAs can support rich client-side functionality that doesn\\u2019t requ\", \"ire reloading the page as users take\\nactions or navigate between areas of the app. SPAs can load mor\", \"e quickly, fetching data in the\\nbackground, and individual user actions are more responsive since fu\", \"ll page reloads are rare. SPAs can\\nsupport incremental updates, saving partially completed forms or \", \"documents without the user having\\nto click a button to submit a form. SPAs can support rich client-s\", \"ide behaviors, such as drag-and-drop,\\nmuch more readily than traditional applications. SPAs can be d\", \"esigned to run in a disconnected mode,\\nmaking updates to a client-side model that are eventually syn\", \"chronized back to the server once a\\nconnection is re-established. Choose a SPA-style application if \", \"your app\\u2019s requirements include rich\\nfunctionality that goes beyond what typical HTML forms offer.\\n\\n\", \"Frequently, SPAs need to implement features that are built into traditional web apps, such as\\ndispla\", \"ying a meaningful URL in the address bar reflecting the current operation (and allowing users to\\nboo\", \"kmark or deep link to this URL to return to it). SPAs also should allow users to use the browser\\u2019s\\nb\", \"ack and forward buttons with results that won\\u2019t surprise them.\\n\\nYour team is familiar with JavaScrip\", \"t and/or TypeScript development\\n\\nWriting SPAs requires familiarity with JavaScript and/or TypeScript\", \" and client-side programming\\ntechniques and libraries. Your team should be competent in writing mode\", \"rn JavaScript using a SPA\\nframework like Angular.\\n\\nReferences \\u2013 SPA Frameworks\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nAngular: ht\", \"tps://angular.io\\n\\nReact: https://reactjs.org/\\n\\nVue.js: https://vuejs.org/\\n\\nYour application must alr\", \"eady expose an API for other (internal or public) clients\\n\\n8\\n\\nCHAPTER 2 | Choose Between Traditional\", \" Web Apps and Single Page Apps (SPAs)\\n\\n\\fIf you\\u2019re already supporting a web API for use by other clie\", \"nts, it may require less effort to create a\\nSPA implementation that leverages these APIs rather than\", \" reproducing the logic in server-side form.\\nSPAs make extensive use of web APIs to query and update \", \"data as users interact with the application.\\n\\nWhen to choose Blazor\\n\\nThe following section is a more\", \" detailed explanation of when to choose Blazor for your web app.\\n\\nYour application must expose a ric\", \"h user interface\\n\\nLike JavaScript-based SPAs, Blazor applications can support rich client behavior w\", \"ithout page reloads.\\nThese applications are more responsive to users, fetching only the data (or HTM\", \"L) required to respond\\nto a given user interaction. Designed properly, server-side Blazor apps can b\", \"e configured to run as\\nclient-side Blazor apps with minimal changes once this feature is supported.\\n\", \"\\nYour team is more comfortable with .NET development than JavaScript or TypeScript\\ndevelopment\\n\\nMany\", \" developers are more productive with .NET and Razor than with client-side languages like\\nJavaScript \", \"or TypeScript. Since the server-side of the application is already being developed with .NET,\\nusing \", \"Blazor ensures every .NET developer on the team can understand and potentially build the\\nbehavior of\", \" the front end of the application.\\n\\nDecision table\\n\\nThe following decision table summarizes some of \", \"the basic factors to consider when choosing\\nbetween a traditional web application, a SPA, or a Blazo\", \"r app.\\n\\nFactor\\n\\nRequired Team Familiarity with\\nJavaScript/TypeScript\\n\\nTraditional Web\\nApp\\n\\nSingle Pa\", \"ge\\nApplication\\n\\nBlazor\\nApp\\n\\nMinimal\\n\\nRequired\\n\\nMinimal\\n\\nSupport Browsers without Scripting\\n\\nSupporte\", \"d\\n\\nNot Supported\\n\\nMinimal Client-Side Application Behavior  Well-Suited\\n\\nOverkill\\n\\nRich, Complex Use\", \"r Interface\\nRequirements\\n\\nLimited\\n\\nWell-Suited\\n\\nSupporte\\nd\\n\\nViable\\n\\nWell-\\nSuited\\n\\nOther consideratio\", \"ns\\n\\nTraditional Web Apps tend to be simpler and have better Search Engine Optimization (SEO) criteri\", \"a\\nthan SPA apps. Search engine bots can easily consume content from traditional apps, while support\\n\", \"for indexing SPAs may be lacking or limited. If your app benefits from public discovery by search\\nen\", \"gines, this is often an important consideration.\\n\\n9\\n\\nCHAPTER 2 | Choose Between Traditional Web Apps\", \" and Single Page Apps (SPAs)\\n\\n\\fIn addition, unless you\\u2019ve built a management tool for your SPA\\u2019s con\", \"tent, it may require developers\\nto make changes. Traditional Web Apps are often easier for non-devel\", \"opers to make changes to, since\\nmuch of the content is simply HTML and may not require a build proce\", \"ss to preview or even deploy. If\\nnon-developers in your organization are likely to need to maintain \", \"the content of the app, a\\ntraditional web app may be a better choice.\\n\\nSPAs shine when the app has c\", \"omplex interactive forms or other user interaction features. For\\ncomplex apps that require authentic\", \"ation to use, and thus aren\\u2019t accessible by public search engine\\nspiders, SPAs are a great option in\", \" many cases.\\n\\n10\\n\\nCHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs)\\n\\n\\fCHAP\", \"TER  3\\n\\nArchitectural principles\\n\\n\\u201cIf builders built buildings the way programmers wrote programs, t\", \"hen the first woodpecker that\\ncame along would destroy civilization.\\u201d\\n- Gerald Weinberg\\n\\nYou should \", \"architect and design software solutions with maintainability in mind. The principles\\noutlined in thi\", \"s section can help guide you toward architectural decisions that will result in clean,\\nmaintainable \", \"applications. Generally, these principles will guide you toward building applications out\\nof discret\", \"e components that are not tightly coupled to other parts of your application, but rather\\ncommunicate\", \" through explicit interfaces or messaging systems.\\n\\nCommon design principles\\n\\nSeparation of concerns\", \"\\n\\nA guiding principle when developing is Separation of Concerns. This principle asserts that softwar\", \"e\\nshould be separated based on the kinds of work it performs. For instance, consider an application \", \"that\\nincludes logic for identifying noteworthy items to display to the user, and which formats such \", \"items in\\na particular way to make them more noticeable. The behavior responsible for choosing which \", \"items to\\nformat should be kept separate from the behavior responsible for formatting the items, sinc\", \"e these\\nbehaviors are separate concerns that are only coincidentally related to one another.\\n\\nArchit\", \"ecturally, applications can be logically built to follow this principle by separating core business\\n\", \"behavior from infrastructure and user-interface logic. Ideally, business rules and logic should resi\", \"de in\\na separate project, which should not depend on other projects in the application. This separat\", \"ion\\nhelps ensure that the business model is easy to test and can evolve without being tightly couple\", \"d to\\nlow-level implementation details (it also helps if infrastructure concerns depend on abstractio\", \"ns\\ndefined in the business layer). Separation of concerns is a key consideration behind the use of l\", \"ayers\\nin application architectures.\\n\\nEncapsulation\\n\\nDifferent parts of an application should use enc\", \"apsulation to insulate them from other parts of the\\napplication. Application components and layers s\", \"hould be able to adjust their internal implementation\\nwithout breaking their collaborators as long a\", \"s external contracts are not violated. Proper use of\\nencapsulation helps achieve loose coupling and \", \"modularity in application designs, since objects and\\npackages can be replaced with alternative imple\", \"mentations so long as the same interface is\\nmaintained.\\n\\n11\\n\\nCHAPTER 3 | Architectural principles\\n\\n\\f\", \"In classes, encapsulation is achieved by limiting outside access to the class\\u2019s internal state. If a\", \"n\\noutside actor wants to manipulate the state of the object, it should do so through a well-defined\\n\", \"function (or property setter), rather than having direct access to the private state of the object.\\n\", \"Likewise, application components and applications themselves should expose well-defined interfaces\\nf\", \"or their collaborators to use, rather than allowing their state to be modified directly. This approa\", \"ch\\nfrees the application\\u2019s internal design to evolve over time without worrying that doing so will b\", \"reak\\ncollaborators, so long as the public contracts are maintained.\\n\\nMutable global state is antithe\", \"tical to encapsulation. A value fetched from mutable global state in one\\nfunction cannot be relied u\", \"pon to have the same value in another function (or even further in the\\nsame function). Understanding\", \" concerns with mutable global state is one of the reasons programming\\nlanguages like C# have support\", \" for different scoping rules, which are used everywhere from\\nstatements to methods to classes. It\\u2019s \", \"worth noting that data-driven architectures which rely on a\\ncentral database for integration within \", \"and between applications are, themselves, choosing to depend\\non the mutable global state represented\", \" by the database. A key consideration in domain-driven\\ndesign and clean architecture is how to encap\", \"sulate access to data, and how to ensure application\\nstate is not made invalid by direct access to i\", \"ts persistence format.\\n\\nDependency inversion\\n\\nThe direction of dependency within the application sho\", \"uld be in the direction of abstraction, not\\nimplementation details. Most applications are written su\", \"ch that compile-time dependency flows in the\\ndirection of runtime execution, producing a direct depe\", \"ndency graph. That is, if class A calls a method\\nof class B and class B calls a method of class C, t\", \"hen at compile time class A will depend on class B,\\nand class B will depend on class C, as shown in \", \"Figure 4-1.\\n\\n12\\n\\nCHAPTER 3 | Architectural principles\\n\\n\\fFigure 4-1. Direct dependency graph.\\n\\nApplyi\", \"ng the dependency inversion principle allows A to call methods on an abstraction that B\\nimplements, \", \"making it possible for A to call B at run time, but for B to depend on an interface\\ncontrolled by A \", \"at compile time (thus, inverting the typical compile-time dependency). At run time, the\\nflow of prog\", \"ram execution remains unchanged, but the introduction of interfaces means that different\\nimplementat\", \"ions of these interfaces can easily be plugged in.\\n\\n13\\n\\nCHAPTER 3 | Architectural principles\\n\\n\\fFigur\", \"e 4-2. Inverted dependency graph.\\n\\nDependency inversion is a key part of building loosely coupled ap\", \"plications, since implementation\\ndetails can be written to depend on and implement higher-level abst\", \"ractions, rather than the other\\nway around. The resulting applications are more testable, modular, a\", \"nd maintainable as a result. The\\npractice of dependency injection is made possible by following the \", \"dependency inversion principle.\\n\\nExplicit dependencies\\n\\nMethods and classes should explicitly requir\", \"e any collaborating objects they need in order to\\nfunction correctly. It is called the Explicit Depe\", \"ndencies Principle. Class constructors provide an\\nopportunity for classes to identify the things the\", \"y need in order to be in a valid state and to function\\nproperly. If you define classes that can be c\", \"onstructed and called, but that will only function properly\\nif certain global or infrastructure comp\", \"onents are in place, these classes are being dishonest with their\\nclients. The constructor contract \", \"is telling the client that it only needs the things specified (possibly\\nnothing if the class is just\", \" using a parameterless constructor), but then at runtime it turns out the\\nobject really did need som\", \"ething else.\\n\\nBy following the explicit dependencies principle, your classes and methods are being h\", \"onest with their\\nclients about what they need in order to function. Following the principle makes yo\", \"ur code more self-\\ndocumenting and your coding contracts more user-friendly, since users will come t\", \"o trust that as long\\nas they provide what\\u2019s required in the form of method or constructor parameters\", \", the objects they\\u2019re\\nworking with will behave correctly at run time.\\n\\nSingle responsibility\\n\\nThe si\", \"ngle responsibility principle applies to object-oriented design, but can also be considered as an\\nar\", \"chitectural principle similar to separation of concerns. It states that objects should have only one\", \"\\nresponsibility and that they should have only one reason to change. Specifically, the only situatio\", \"n in\\nwhich the object should change is if the manner in which it performs its one responsibility mus\", \"t be\\n\\n14\\n\\nCHAPTER 3 | Architectural principles\\n\\n\\fupdated. Following this principle helps to produce \", \"more loosely coupled and modular systems, since\\nmany kinds of new behavior can be implemented as new\", \" classes, rather than by adding additional\\nresponsibility to existing classes. Adding new classes is\", \" always safer than changing existing classes,\\nsince no code yet depends on the new classes.\\n\\nIn a mo\", \"nolithic application, we can apply the single responsibility principle at a high level to the layers\", \"\\nin the application. Presentation responsibility should remain in the UI project, while data access\\n\", \"responsibility should be kept within an infrastructure project. Business logic should be kept in the\", \"\\napplication core project, where it can be easily tested and can evolve independently from other\\nres\", \"ponsibilities.\\n\\nWhen this principle is applied to application architecture and taken to its logical \", \"endpoint, you get\\nmicroservices. A given microservice should have a single responsibility. If you ne\", \"ed to extend the\\nbehavior of a system, it\\u2019s usually better to do it by adding additional microservic\", \"es, rather than by\\nadding responsibility to an existing one.\\n\\nLearn more about microservices archite\", \"cture\\n\\nDon\\u2019t repeat yourself (DRY)\\n\\nThe application should avoid specifying behavior related to a pa\", \"rticular concept in multiple places as\\nthis practice is a frequent source of errors. At some point, \", \"a change in requirements will require\\nchanging this behavior. It\\u2019s likely that at least one instance\", \" of the behavior will fail to be updated, and\\nthe system will behave inconsistently.\\n\\nRather than du\", \"plicating logic, encapsulate it in a programming construct. Make this construct the\\nsingle authority\", \" over this behavior, and have any other part of the application that requires this\\nbehavior use the \", \"new construct.\\n\\nNote\\n\\nAvoid binding together behavior that is only coincidentally repetitive. For ex\", \"ample, just because two\\ndifferent constants both have the same value, that doesn\\u2019t mean you should h\", \"ave only one constant, if\\nconceptually they\\u2019re referring to different things. Duplication is always \", \"preferable to coupling to the\\nwrong abstraction.\\n\\nPersistence ignorance\\n\\nPersistence ignorance (PI) \", \"refers to types that need to be persisted, but whose code is unaffected by\\nthe choice of persistence\", \" technology. Such types in .NET are sometimes referred to as Plain Old CLR\\nObjects (POCOs), because \", \"they do not need to inherit from a particular base class or implement a\\nparticular interface. Persis\", \"tence ignorance is valuable because it allows the same business model to be\\npersisted in multiple wa\", \"ys, offering additional flexibility to the application. Persistence choices might\\nchange over time, \", \"from one database technology to another, or additional forms of persistence might\\nbe required in add\", \"ition to whatever the application started with (for example, using a Redis cache or\\nAzure Cosmos DB \", \"in addition to a relational database).\\n\\nSome examples of violations of this principle include:\\n\\n15\\n\\n\", \"CHAPTER 3 | Architectural principles\\n\\n\\f\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nA required base class.\\n\\nA required interfac\", \"e implementation.\\n\\nClasses responsible for saving themselves (such as the Active Record pattern).\\n\\nR\", \"equired parameterless constructor.\\n\\nProperties requiring virtual keyword.\\n\\nPersistence-specific requ\", \"ired attributes.\\n\\nThe requirement that classes have any of the above features or behaviors adds coup\", \"ling between the\\ntypes to be persisted and the choice of persistence technology, making it more diff\", \"icult to adopt new\\ndata access strategies in the future.\\n\\nBounded contexts\\n\\nBounded contexts are a c\", \"entral pattern in Domain-Driven Design. They provide a way of tackling\\ncomplexity in large applicati\", \"ons or organizations by breaking it up into separate conceptual modules.\\nEach conceptual module then\", \" represents a context that is separated from other contexts (hence,\\nbounded), and can evolve indepen\", \"dently. Each bounded context should ideally be free to choose its\\nown names for concepts within it, \", \"and should have exclusive access to its own persistence store.\\n\\nAt a minimum, individual web applica\", \"tions should strive to be their own bounded context, with their\\nown persistence store for their busi\", \"ness model, rather than sharing a database with other applications.\\nCommunication between bounded co\", \"ntexts occurs through programmatic interfaces, rather than\\nthrough a shared database, which allows f\", \"or business logic and events to take place in response to\\nchanges that take place. Bounded contexts \", \"map closely to microservices, which also are ideally\\nimplemented as their own individual bounded con\", \"texts.\\n\\nAdditional resources\\n\\n\\u2022\\n\\n\\u2022\\n\\nPrinciples\\n\\nBounded Context\\n\\n16\\n\\nCHAPTER 3 | Architectural princ\", \"iples\\n\\n\\fCHAPTER  4\\n\\nCommon web application\\narchitectures\\n\\n\\u201cIf you think good architecture is expensi\", \"ve, try bad architecture.\\u201d - Brian Foote and Joseph Yoder\\n\\nMost traditional .NET applications are de\", \"ployed as single units corresponding to an executable or a\\nsingle web application running within a s\", \"ingle IIS appdomain. This approach is the simplest\\ndeployment model and serves many internal and sma\", \"ller public applications very well. However, even\\ngiven this single unit of deployment, most non-tri\", \"vial business applications benefit from some logical\\nseparation into several layers.\\n\\nWhat is a mono\", \"lithic application?\\n\\nA monolithic application is one that is entirely self-contained, in terms of it\", \"s behavior. It may interact\\nwith other services or data stores in the course of performing its opera\", \"tions, but the core of its\\nbehavior runs within its own process and the entire application is typica\", \"lly deployed as a single unit. If\\nsuch an application needs to scale horizontally, typically the ent\", \"ire application is duplicated across\\nmultiple servers or virtual machines.\\n\\nAll-in-one applications\\n\", \"\\nThe smallest possible number of projects for an application architecture is one. In this architectu\", \"re, the\\nentire logic of the application is contained in a single project, compiled to a single assem\", \"bly, and\\ndeployed as a single unit.\\n\\nA new ASP.NET Core project, whether created in Visual Studio or\", \" from the command line, starts out as\\na simple \\u201call-in-one\\u201d monolith. It contains all of the behavio\", \"r of the application, including\\npresentation, business, and data access logic. Figure 5-1 shows the \", \"file structure of a single-project\\napp.\\n\\n17\\n\\nCHAPTER 4 | Common web application architectures\\n\\n\\fFigu\", \"re 5-1. A single project ASP.NET Core app.\\n\\nIn a single project scenario, separation of concerns is \", \"achieved through the use of folders. The default\\ntemplate includes separate folders for MVC pattern \", \"responsibilities of Models, Views, and Controllers,\\nas well as additional folders for Data and Servi\", \"ces. In this arrangement, presentation details should be\\nlimited as much as possible to the Views fo\", \"lder, and data access implementation details should be\\nlimited to classes kept in the Data folder. B\", \"usiness logic should reside in services and classes within\\nthe Models folder.\\n\\nAlthough simple, the \", \"single-project monolithic solution has some disadvantages. As the project\\u2019s size\\nand complexity grow\", \"s, the number of files and folders will continue to grow as well. User interface (UI)\\nconcerns (mode\", \"ls, views, controllers) reside in multiple folders, which aren\\u2019t grouped together\\nalphabetically. Th\", \"is issue only gets worse when additional UI-level constructs, such as Filters or\\nModelBinders, are a\", \"dded in their own folders. Business logic is scattered between the Models and\\nServices folders, and \", \"there\\u2019s no clear indication of which classes in which folders should depend on\\nwhich others. This la\", \"ck of organization at the project level frequently leads to spaghetti code.\\n\\nTo address these issues\", \", applications often evolve into multi-project solutions, where each project is\\nconsidered to reside\", \" in a particular layer of the application.\\n\\nWhat are layers?\\n\\nAs applications grow in complexity, on\", \"e way to manage that complexity is to break up the application\\naccording to its responsibilities or \", \"concerns. This approach follows the separation of concerns\\nprinciple and can help keep a growing cod\", \"ebase organized so that developers can easily find where\\ncertain functionality is implemented. Layer\", \"ed architecture offers a number of advantages beyond just\\ncode organization, though.\\n\\n18\\n\\nCHAPTER 4 \", \"| Common web application architectures\\n\\n\\fBy organizing code into layers, common low-level functional\", \"ity can be reused throughout the\\napplication. This reuse is beneficial because it means less code ne\", \"eds to be written and because it can\\nallow the application to standardize on a single implementation\", \", following the don\\u2019t repeat yourself\\n(DRY) principle.\\n\\nWith a layered architecture, applications ca\", \"n enforce restrictions on which layers can communicate\\nwith other layers. This architecture helps to\", \" achieve encapsulation. When a layer is changed or\\nreplaced, only those layers that work with it sho\", \"uld be impacted. By limiting which layers depend on\\nwhich other layers, the impact of changes can be\", \" mitigated so that a single change doesn\\u2019t impact the\\nentire application.\\n\\nLayers (and encapsulation\", \") make it much easier to replace functionality within the application. For\\nexample, an application m\", \"ight initially use its own SQL Server database for persistence, but later could\\nchoose to use a clou\", \"d-based persistence strategy, or one behind a web API. If the application has\\nproperly encapsulated \", \"its persistence implementation within a logical layer, that SQL Server-specific\\nlayer could be repla\", \"ced by a new one implementing the same public interface.\\n\\nIn addition to the potential of swapping o\", \"ut implementations in response to future changes in\\nrequirements, application layers can also make i\", \"t easier to swap out implementations for testing\\npurposes. Instead of having to write tests that ope\", \"rate against the real data layer or UI layer of the\\napplication, these layers can be replaced at tes\", \"t time with fake implementations that provide known\\nresponses to requests. This approach typically m\", \"akes tests much easier to write and much faster to\\nrun when compared to running tests against the ap\", \"plication\\u2019s real infrastructure.\\n\\nLogical layering is a common technique for improving the organizat\", \"ion of code in enterprise software\\napplications, and there are several ways in which code can be org\", \"anized into layers.\\n\\nNote\\n\\nLayers represent logical separation within the application. In the event \", \"that application logic is\\nphysically distributed to separate servers or processes, these separate ph\", \"ysical deployment targets are\\nreferred to as tiers. It\\u2019s possible, and quite common, to have an N-La\", \"yer application that is deployed\\nto a single tier.\\n\\nTraditional \\u201cN-Layer\\u201d architecture applications\\n\", \"\\nThe most common organization of application logic into layers is shown in Figure 5-2.\\n\\n19\\n\\nCHAPTER \", \"4 | Common web application architectures\\n\\n\\fFigure 5-2. Typical application layers.\\n\\nThese layers are\", \" frequently abbreviated as UI, BLL (Business Logic Layer), and DAL (Data Access Layer).\\nUsing this a\", \"rchitecture, users make requests through the UI layer, which interacts only with the BLL.\\nThe BLL, i\", \"n turn, can call the DAL for data access requests. The UI layer shouldn\\u2019t make any requests to\\nthe D\", \"AL directly, nor should it interact with persistence directly through other means. Likewise, the BLL\", \"\\nshould only interact with persistence by going through the DAL. In this way, each layer has its own\", \"\\nwell-known responsibility.\\n\\nOne disadvantage of this traditional layering approach is that compile-\", \"time dependencies run from\\nthe top to the bottom. That is, the UI layer depends on the BLL, which de\", \"pends on the DAL. This\\nmeans that the BLL, which usually holds the most important logic in the appli\", \"cation, is dependent on\\ndata access implementation details (and often on the existence of a database\", \"). Testing business logic\\nin such an architecture is often difficult, requiring a test database. The\", \" dependency inversion principle\\ncan be used to address this issue, as you\\u2019ll see in the next section\", \".\\n\\nFigure 5-3 shows an example solution, breaking the application into three projects by responsibil\", \"ity\\n(or layer).\\n\\n20\\n\\nCHAPTER 4 | Common web application architectures\\n\\n\\fFigure 5-3. A simple monolit\", \"hic application with three projects.\\n\\nAlthough this application uses several projects for organizati\", \"onal purposes, it\\u2019s still deployed as a\\nsingle unit and its clients will interact with it as a singl\", \"e web app. This allows for very simple\\ndeployment process. Figure 5-4 shows how such an app might be\", \" hosted using Azure.\\n\\nFigure 5-4. Simple deployment of Azure Web App\\n\\nAs application needs grow, mor\", \"e complex and robust deployment solutions may be required. Figure\\n5-5 shows an example of a more com\", \"plex deployment plan that supports additional capabilities.\\n\\n21\\n\\nCHAPTER 4 | Common web application \", \"architectures\\n\\n\\fFigure 5-5. Deploying a web app to an Azure App Service\\n\\nInternally, this project\\u2019s \", \"organization into multiple projects based on responsibility improves the\\nmaintainability of the appl\", \"ication.\\n\\nThis unit can be scaled up or out to take advantage of cloud-based on-demand scalability. \", \"Scaling up\\nmeans adding additional CPU, memory, disk space, or other resources to the server(s) host\", \"ing your\\napp. Scaling out means adding additional instances of such servers, whether these are physi\", \"cal\\nservers, virtual machines, or containers. When your app is hosted across multiple instances, a l\", \"oad\\nbalancer is used to assign requests to individual app instances.\\n\\nThe simplest approach to scali\", \"ng a web application in Azure is to configure scaling manually in the\\napplication\\u2019s App Service Plan\", \". Figure 5-6 shows the appropriate Azure dashboard screen to configure\\nhow many instances are servin\", \"g an app.\\n\\n22\\n\\nCHAPTER 4 | Common web application architectures\\n\\n\\fFigure 5-6. App Service Plan scali\", \"ng in Azure.\\n\\nClean architecture\\n\\nApplications that follow the Dependency Inversion Principle as wel\", \"l as the Domain-Driven Design\\n(DDD) principles tend to arrive at a similar architecture. This archit\", \"ecture has gone by many names\\nover the years. One of the first names was Hexagonal Architecture, fol\", \"lowed by Ports-and-Adapters.\\nMore recently, it\\u2019s been cited as the Onion Architecture or Clean Archi\", \"tecture. The latter name, Clean\\nArchitecture, is used as the name for this architecture in this e-bo\", \"ok.\\n\\nThe eShopOnWeb reference application uses the Clean Architecture approach in organizing its cod\", \"e\\ninto projects. You can find a solution template you can use as a starting point for your own ASP.N\", \"ET\\nCore solutions in the ardalis/cleanarchitecture GitHub repository or by installing the template f\", \"rom\\nNuGet.\\n\\nClean architecture puts the business logic and application model at the center of the ap\", \"plication.\\nInstead of having business logic depend on data access or other infrastructure concerns, \", \"this\\ndependency is inverted: infrastructure and implementation details depend on the Application Cor\", \"e.\\nThis functionality is achieved by defining abstractions, or interfaces, in the Application Core, \", \"which are\\nthen implemented by types defined in the Infrastructure layer. A common way of visualizing\", \" this\\narchitecture is to use a series of concentric circles, similar to an onion. Figure 5-7 shows a\", \"n example of\\nthis style of architectural representation.\\n\\n23\\n\\nCHAPTER 4 | Common web application arc\", \"hitectures\\n\\n\\fFigure 5-7. Clean Architecture; onion view\\n\\nIn this diagram, dependencies flow toward t\", \"he innermost circle. The Application Core takes its name\\nfrom its position at the core of this diagr\", \"am. And you can see on the diagram that the Application\\nCore has no dependencies on other applicatio\", \"n layers. The application\\u2019s entities and interfaces are at\\nthe very center. Just outside, but still \", \"in the Application Core, are domain services, which typically\\nimplement interfaces defined in the in\", \"ner circle. Outside of the Application Core, both the UI and the\\nInfrastructure layers depend on the\", \" Application Core, but not on one another (necessarily).\\n\\nFigure 5-8 shows a more traditional horizo\", \"ntal layer diagram that better reflects the dependency\\nbetween the UI and other layers.\\n\\n24\\n\\nCHAPTER\", \" 4 | Common web application architectures\\n\\n\\fFigure 5-8. Clean Architecture; horizontal layer view\\n\\nN\", \"ote that the solid arrows represent compile-time dependencies, while the dashed arrow represents a\\nr\", \"untime-only dependency. With the clean architecture, the UI layer works with interfaces defined in\\nt\", \"he Application Core at compile time, and ideally shouldn\\u2019t know about the implementation types\\ndefin\", \"ed in the Infrastructure layer. At run time, however, these implementation types are required for\\nth\", \"e app to execute, so they need to be present and wired up to the Application Core interfaces via\\ndep\", \"endency injection.\\n\\nFigure 5-9 shows a more detailed view of an ASP.NET Core application\\u2019s architect\", \"ure when built\\nfollowing these recommendations.\\n\\n25\\n\\nCHAPTER 4 | Common web application architecture\", \"s\\n\\n\\fFigure 5-9. ASP.NET Core architecture diagram following Clean Architecture.\\n\\nBecause the Applica\", \"tion Core doesn\\u2019t depend on Infrastructure, it\\u2019s very easy to write automated unit\\ntests for this la\", \"yer. Figures 5-10 and 5-11 show how tests fit into this architecture.\\n\\nFigure 5-10. Unit testing App\", \"lication Core in isolation.\\n\\n26\\n\\nCHAPTER 4 | Common web application architectures\\n\\n\\fFigure 5-11. Int\", \"egration testing Infrastructure implementations with external dependencies.\\n\\nSince the UI layer does\", \"n\\u2019t have any direct dependency on types defined in the Infrastructure project,\\nit\\u2019s likewise very ea\", \"sy to swap out implementations, either to facilitate testing or in response to\\nchanging application \", \"requirements. ASP.NET Core\\u2019s built-in use of and support for dependency\\ninjection makes this archite\", \"cture the most appropriate way to structure non-trivial monolithic\\napplications.\\n\\nFor monolithic app\", \"lications, the Application Core, Infrastructure, and UI projects are all run as a single\\napplication\", \". The runtime application architecture might look something like Figure 5-12.\\n\\n27\\n\\nCHAPTER 4 | Commo\", \"n web application architectures\\n\\n\\fFigure 5-12. A sample ASP.NET Core app\\u2019s runtime architecture.\\n\\nOr\", \"ganizing code in Clean Architecture\\n\\nIn a Clean Architecture solution, each project has clear respon\", \"sibilities. As such, certain types belong\\nin each project and you\\u2019ll frequently find folders corresp\", \"onding to these types in the appropriate\\nproject.\\n\\nApplication Core\\n\\nThe Application Core holds the \", \"business model, which includes entities, services, and interfaces. These\\ninterfaces include abstract\", \"ions for operations that will be performed using Infrastructure, such as data\\naccess, file system ac\", \"cess, network calls, etc. Sometimes services or interfaces defined at this layer will\\nneed to work w\", \"ith non-entity types that have no dependencies on UI or Infrastructure. These can be\\ndefined as simp\", \"le Data Transfer Objects (DTOs).\\n\\nApplication Core types\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nEntities (business mo\", \"del classes that are persisted)\\n\\nAggregates (groups of entities)\\n\\nInterfaces\\n\\nDomain Services\\n\\nSpeci\", \"fications\\n\\nCustom Exceptions and Guard Clauses\\n\\nDomain Events and Handlers\\n\\n28\\n\\nCHAPTER 4 | Common w\", \"eb application architectures\\n\\n\\fInfrastructure\\n\\nThe Infrastructure project typically includes data ac\", \"cess implementations. In a typical ASP.NET Core\\nweb application, these implementations include the E\", \"ntity Framework (EF) DbContext, any EF Core\\nMigration objects that have been defined, and data acces\", \"s implementation classes. The most common\\nway to abstract data access implementation code is through\", \" the use of the Repository design pattern.\\n\\nIn addition to data access implementations, the Infrastr\", \"ucture project should contain implementations\\nof services that must interact with infrastructure con\", \"cerns. These services should implement interfaces\\ndefined in the Application Core, and so Infrastruc\", \"ture should have a reference to the Application Core\\nproject.\\n\\nInfrastructure types\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nEF Cor\", \"e types (DbContext, Migration)\\n\\nData access implementation types (Repositories)\\n\\nInfrastructure-spec\", \"ific services (for example, FileLogger or SmtpNotifier)\\n\\nUI Layer\\n\\nThe user interface layer in an AS\", \"P.NET Core MVC application is the entry point for the application. This\\nproject should reference the\", \" Application Core project, and its types should interact with infrastructure\\nstrictly through interf\", \"aces defined in Application Core. No direct instantiation of or static calls to the\\nInfrastructure l\", \"ayer types should be allowed in the UI layer.\\n\\nUI Layer types\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nControllers\\n\\nCustom\", \" Filters\\n\\nCustom Middleware\\n\\nViews\\n\\nViewModels\\n\\nStartup\\n\\nThe Startup class or Program.cs file is res\", \"ponsible for configuring the application, and for wiring up\\nimplementation types to interfaces. The \", \"place where this logic is performed is known as the app\\u2019s\\ncomposition root, and is what allows depen\", \"dency injection to work properly at run time.\\n\\nNote\\n\\nIn order to wire up dependency injection during\", \" app startup, the UI layer project may need to\\nreference the Infrastructure project. This dependency\", \" can be eliminated, most easily by using a\\ncustom DI container that has built-in support for loading\", \" types from assemblies. For the purposes of\\nthis sample, the simplest approach is to allow the UI pr\", \"oject to reference the Infrastructure project\\n(but developers should limit actual references to type\", \"s in the Infrastructure project to the app\\u2019s\\ncomposition root).\\n\\n29\\n\\nCHAPTER 4 | Common web applicat\", \"ion architectures\\n\\n\\fMonolithic applications and containers\\n\\nYou can build a single and monolithic-de\", \"ployment based Web Application or Service and deploy it as\\na container. Within the application, it m\", \"ight not be monolithic but organized into several libraries,\\ncomponents, or layers. Externally, it\\u2019s\", \" a single container with a single process, single web application,\\nor single service.\\n\\nTo manage thi\", \"s model, you deploy a single container to represent the application. To scale, just add\\nadditional c\", \"opies with a load balancer in front. The simplicity comes from managing a single\\ndeployment in a sin\", \"gle container or VM.\\n\\nYou can include multiple components/libraries or internal layers within each c\", \"ontainer, as illustrated in\\nFigure 5-13. But, following the container principle of _\\u201ca container doe\", \"s one thing, and does it in one\\nprocess_\\u201d, the monolithic pattern might be a conflict.\\n\\nThe downside\", \" of this approach comes if/when the application grows, requiring it to scale. If the entire\\napplicat\", \"ion scales, it\\u2019s not really a problem. However, in most cases, a few parts of the application are\\nth\", \"e choke points requiring scaling, while other components are used less.\\n\\nUsing the typical eCommerce\", \" example, what you likely need to scale is the product information\\ncomponent. Many more customers br\", \"owse products than purchase them. More customers use their\\nbasket than use the payment pipeline. Few\", \"er customers add comments or view their purchase history.\\nAnd you likely only have a handful of empl\", \"oyees, in a single region, that need to manage the content\\nand marketing campaigns. By scaling the m\", \"onolithic design, all the code is deployed multiple times.\\n\\nIn addition to the \\u201cscale everything\\u201d pr\", \"oblem, changes to a single component require complete\\nretesting of the entire application, and a com\", \"plete redeployment of all the instances.\\n\\nThe monolithic approach is common, and many organizations \", \"are developing with this architectural\\napproach. Many are having good enough results, while others a\", \"re hitting limits. Many designed their\\napplications in this model, because the tools and infrastruct\", \"ure were too difficult to build service-\\noriented architectures (SOA), and they didn\\u2019t see the need \", \"until the app grew. If you find you\\u2019re hitting\\n\\n30\\n\\nCHAPTER 4 | Common web application architectures\", \"\\n\\n\\fthe limits of the monolithic approach, breaking up the app to enable it to better leverage contai\", \"ners\\nand microservices may be the next logical step.\\n\\nDeploying monolithic applications in Microsoft\", \" Azure can be achieved using dedicated VMs for each\\ninstance. Using Azure Virtual Machine Scale Sets\", \", you can easily scale the VMs. Azure App Services can\\nrun monolithic applications and easily scale \", \"instances without having to manage the VMs. Azure App\\nServices can run single instances of Docker co\", \"ntainers as well, simplifying the deployment. Using\\nDocker, you can deploy a single VM as a Docker h\", \"ost, and run multiple instances. Using the Azure\\nbalancer, as shown in the Figure 5-14, you can mana\", \"ge scaling.\\n\\nThe deployment to the various hosts can be managed with traditional deployment techniqu\", \"es. The\\nDocker hosts can be managed with commands like docker run performed manually, or through\\naut\", \"omation such as Continuous Delivery (CD) pipelines.\\n\\nMonolithic application deployed as a container\\n\", \"\\nThere are benefits of using containers to manage monolithic application deployments. Scaling the\\nin\", \"stances of containers is far faster and easier than deploying additional VMs. Even when using virtua\", \"l\\nmachine scale sets to scale VMs, they take time to create. When deployed as app instances, the\\ncon\", \"figuration of the app is managed as part of the VM.\\n\\nDeploying updates as Docker images is far faste\", \"r and network efficient. Docker Images typically start\\nin seconds, speeding rollouts. Tearing down a\", \" Docker instance is as easy as issuing a docker stop\\ncommand, typically completing in less than a se\", \"cond.\\n\\n31\\n\\nCHAPTER 4 | Common web application architectures\\n\\n\\fAs containers are inherently immutable\", \" by design, you never need to worry about corrupted VMs,\\nwhereas update scripts might forget to acco\", \"unt for some specific configuration or file left on the disk.\\n\\nYou can use Docker containers for a m\", \"onolithic deployment of simpler web applications. This\\napproach improves continuous integration and \", \"continuous deployment pipelines and helps achieve\\ndeployment-to-production success. No more \\u201cIt work\", \"s on my machine, why does it not work in\\nproduction?\\u201d\\n\\nA microservices-based architecture has many b\", \"enefits, but those benefits come at a cost of increased\\ncomplexity. In some cases, the costs outweig\", \"h the benefits, so a monolithic deployment application\\nrunning in a single container or in just a fe\", \"w containers is a better option.\\n\\nA monolithic application might not be easily decomposable into wel\", \"l-separated microservices.\\nMicroservices should work independently of each other to provide a more r\", \"esilient application. If you\\ncan\\u2019t deliver independent feature slices of the application, separating\", \" it only adds complexity.\\n\\nAn application might not yet need to scale features independently. Many a\", \"pplications, when they\\nneed to scale beyond a single instance, can do so through the relatively simp\", \"le process of cloning that\\nentire instance. The additional work to separate the application into dis\", \"crete services provides a\\nminimal benefit when scaling full instances of the application is simple a\", \"nd cost-effective.\\n\\nEarly in the development of an application, you might not have a clear idea wher\", \"e the natural\\nfunctional boundaries are. As you develop a minimum viable product, the natural separa\", \"tion might\\nnot yet have emerged. Some of these conditions might be temporary. You might start by cre\", \"ating a\\nmonolithic application, and later separate some features to be developed and deployed as\\nmic\", \"roservices. Other conditions might be essential to the application\\u2019s problem space, meaning that\\nthe\", \" application might never be broken into multiple microservices.\\n\\nSeparating an application into many\", \" discrete processes also introduces overhead. There\\u2019s more\\ncomplexity in separating features into di\", \"fferent processes. The communication protocols become\\nmore complex. Instead of method calls, you mus\", \"t use asynchronous communications between\\nservices. As you move to a microservices architecture, you\", \" need to add many of the building blocks\\nimplemented in the microservices version of the eShopOnCont\", \"ainers application: event bus handling,\\nmessage resiliency and retries, eventual consistency, and mo\", \"re.\\n\\nThe much simpler eShopOnWeb reference application supports single-container monolithic containe\", \"r\\nusage. The application includes one web application that includes traditional MVC views, web APIs,\", \"\\nand Razor Pages. Optionally, you can run the application\\u2019s Blazor-based admin component, which\\nrequ\", \"ires a separate API project to run as well.\\n\\nThe application can be launched from the solution root \", \"using the docker-compose build and docker-\\ncompose up commands. This command configures a container \", \"for the web instance, using the\\nDockerfile found in the web project\\u2019s root, and runs the container o\", \"n a specified port. You can\\ndownload the source for this application from GitHub and run it locally.\", \" Even this monolithic\\napplication benefits from being deployed in a container environment.\\n\\nFor one,\", \" the containerized deployment means that every instance of the application runs in the same\\nenvironm\", \"ent. This approach includes the developer environment where early testing and\\ndevelopment take place\", \". The development team can run the application in a containerized\\nenvironment that matches the produ\", \"ction environment.\\n\\n32\\n\\nCHAPTER 4 | Common web application architectures\\n\\n\\fIn addition, containerize\", \"d applications scale out at a lower cost. Using a container environment\\nenables greater resource sha\", \"ring than traditional VM environments.\\n\\nFinally, containerizing the application forces a separation \", \"between the business logic and the storage\\nserver. As the application scales out, the multiple conta\", \"iners will all rely on a single physical storage\\nmedium. This storage medium would typically be a hi\", \"gh-availability server running a SQL Server\\ndatabase.\\n\\nDocker support\\n\\nThe eShopOnWeb project runs o\", \"n .NET. Therefore, it can run in either Linux-based or Windows-based\\ncontainers. Note that for Docke\", \"r deployment, you want to use the same host type for SQL Server.\\nLinux-based containers allow a smal\", \"ler footprint and are preferred.\\n\\nYou can use Visual Studio 2017 or later to add Docker support to a\", \"n existing application by right-\\nclicking on a project in Solution Explorer and choosing Add > Docke\", \"r Support. This step adds the\\nfiles required and modifies the project to use them. The current eShop\", \"OnWeb sample already has\\nthese files in place.\\n\\nThe solution-level docker-compose.yml file contains \", \"information about what images to build and\\nwhat containers to launch. The file allows you to use the\", \" docker-compose command to launch\\nmultiple applications at the same time. In this case, it is only l\", \"aunching the Web project. You can also\\nuse it to configure dependencies, such as a separate database\", \" container.\\n\\nversion: '3'\\n\\nservices:\\n  eshopwebmvc:\\n    image: eshopwebmvc\\n    build:\\n      context:\", \" .\\n      dockerfile: src/Web/Dockerfile\\n    environment:\\n      - ASPNETCORE_ENVIRONMENT=Development\\n\", \"    ports:\\n      - \\\"5106:5106\\\"\\n\\nnetworks:\\n  default:\\n    external:\\n      name: nat\\n\\nThe docker-compo\", \"se.yml file references the Dockerfile in the Web project. The Dockerfile is used to\\nspecify which ba\", \"se container will be used and how the application will be configured on it. The Web\\u2019\\nDockerfile:\\n\\nFR\", \"OM mcr.microsoft.com/dotnet/sdk:8.0 AS build\\nWORKDIR /app\\n\\nCOPY *.sln .\\nCOPY . .\\nWORKDIR /app/src/We\", \"b\\nRUN dotnet restore\\n\\n33\\n\\nCHAPTER 4 | Common web application architectures\\n\\n\\fRUN dotnet publish -c R\", \"elease -o out\\n\\nFROM mcr.microsoft.com/dotnet/aspnet:8.0 AS runtime\\nWORKDIR /app\\nCOPY --from=build /a\", \"pp/src/Web/out ./\\n\\nENTRYPOINT [\\\"dotnet\\\", \\\"Web.dll\\\"]\\n\\nTroubleshooting Docker problems\\n\\nOnce you run t\", \"he containerized application, it continues to run until you stop it. You can view which\\ncontainers a\", \"re running with the docker ps command. You can stop a running container by using the\\ndocker stop com\", \"mand and specifying the container ID.\\n\\nNote that running Docker containers may be bound to ports you\", \" might otherwise try to use in your\\ndevelopment environment. If you try to run or debug an applicati\", \"on using the same port as a running\\nDocker container, you\\u2019ll get an error stating that the server ca\", \"n\\u2019t bind to that port. Once again,\\nstopping the container should resolve the issue.\\n\\nIf you want to \", \"add Docker support to your application using Visual Studio, make sure Docker Desktop\\nis running when\", \" you do so. The wizard won\\u2019t run correctly if Docker Desktop isn\\u2019t running when you\\nstart the wizard\", \". In addition, the wizard examines your current container choice to add the correct\\nDocker support. \", \"If you want to add, support for Windows Containers, you need to run the wizard\\nwhile you have Docker\", \" Desktop running with Windows Containers configured. If you want to add,\\nsupport for Linux container\", \"s, run the wizard while you have Docker running with Linux containers\\nconfigured.\\n\\nOther web applica\", \"tion architectural styles\\n\\n\\u2022  Web-Queue-Worker: The core components of this architecture are a web f\", \"ront end that\\n\\nserves client requests, and a worker that performs resource-intensive tasks, long-run\", \"ning\\nworkflows, or batch jobs. The web front end communicates with the worker through a\\nmessage queu\", \"e.\\n\\n\\u2022\\n\\nN-tier: An N-tier architecture divides an application into logical layers and physical tiers.\", \"\\n\\n\\u2022  Microservice: A microservices architecture consists of a collection of small, autonomous\\n\\nservi\", \"ces. Each service is self-contained and should implement a single business capability\\nwithin a bound\", \"ed context.\\n\\nReferences \\u2013 Common web architectures\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n34\\n\\nThe Clean Architecture\\nhttps://b\", \"log.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html\\n\\nThe Onion Architecture\\nhttps://\", \"jeffreypalermo.com/blog/the-onion-architecture-part-1/\\n\\nThe Repository Pattern\\nhttps://deviq.com/rep\", \"ository-pattern/\\n\\nClean Architecture Solution Template\\nhttps://github.com/ardalis/cleanarchitecture\\n\", \"\\nCHAPTER 4 | Common web application architectures\\n\\n\\f\\u2022\\n\\n\\u2022\\n\\nArchitecting Microservices e-book\\nhttps://\", \"aka.ms/MicroservicesEbook\\n\\nDDD (Domain-Driven Design)\\nhttps://learn.microsoft.com/dotnet/architectur\", \"e/microservices/microservice-ddd-cqrs-\\npatterns/\\n\\n35\\n\\nCHAPTER 4 | Common web application architectur\", \"es\\n\\n\\fCHAPTER  5\\n\\nCommon client-side web\\ntechnologies\\n\\n\\u201cWebsites should look good from the inside and\", \" out.\\u201d - Paul Cookson\\n\\nASP.NET Core applications are web applications and they typically rely on cli\", \"ent-side web\\ntechnologies like HTML, CSS, and JavaScript. By separating the content of the page (the\", \" HTML) from\\nits layout and styling (the CSS), and its behavior (via JavaScript), complex web apps ca\", \"n leverage the\\nSeparation of Concerns principle. Future changes to the structure, design, or behavio\", \"r of the\\napplication can be made more easily when these concerns are not intertwined.\\n\\nWhile HTML an\", \"d CSS are relatively stable, JavaScript, by means of the application frameworks and\\nutilities develo\", \"pers work with to build web-based applications, is evolving at breakneck speed. This\\nchapter looks a\", \"t a few ways that JavaScript is used by web developers and provides a high-level\\noverview of the Ang\", \"ular and React client-side libraries.\\n\\nNote\\n\\nBlazor provides an alternative to JavaScript frameworks\", \" for building rich, interactive client user\\ninterfaces.\\n\\nHTML\\n\\nHTML is the standard markup language \", \"used to create web pages and web applications. Its elements\\nform the building blocks of pages, repre\", \"senting formatted text, images, form inputs, and other\\nstructures. When a browser makes a request to\", \" a URL, whether fetching a page or an application, the\\nfirst thing that is returned is an HTML docum\", \"ent. This HTML document may reference or include\\nadditional information about its look and layout in\", \" the form of CSS, or behavior in the form of\\nJavaScript.\\n\\nCSS\\n\\nCSS (Cascading Style Sheets) is used \", \"to control the look and layout of HTML elements. CSS styles can\\nbe applied directly to an HTML eleme\", \"nt, defined separately on the same page, or defined in a\\nseparate file and referenced by the page. S\", \"tyles cascade based on how they are used to select a given\\nHTML element. For instance, a style might\", \" apply to an entire document, but would be overridden by a\\n\\n36\\n\\nCHAPTER 5 | Common client-side web t\", \"echnologies\\n\\n\\fstyle that applied to a particular element. Likewise, an element-specific style would \", \"be overridden by a\\nstyle that applied to a CSS class that was applied to the element, which in turn \", \"would be overridden\\nby a style targeting a specific instance of that element (via its ID). Figure 6-\", \"1\\n\\nFigure 6-1. CSS Specificity rules, in order.\\n\\nIt\\u2019s best to keep styles in their own separate styl\", \"esheet files, and to use selection-based cascading to\\nimplement consistent and reusable styles withi\", \"n the application. Placing style rules within HTML\\nshould be avoided, and applying styles to specifi\", \"c individual elements (rather than whole classes of\\nelements, or elements that have had a particular\", \" CSS class applied to them) should be the exception,\\nnot the rule.\\n\\nCSS preprocessors\\n\\nCSS styleshee\", \"ts lack support for conditional logic, variables, and other programming language\\nfeatures. Thus, lar\", \"ge stylesheets often include quite a bit of repetition, as the same color, font, or other\\nsetting is\", \" applied to many different variations of HTML elements and CSS classes. CSS preprocessors\\ncan help y\", \"our stylesheets follow the DRY principle by adding support for variables and logic.\\n\\nThe most popula\", \"r CSS preprocessors are Sass and LESS. Both extend CSS and are backward\\ncompatible with it, meaning \", \"that a plain CSS file is a valid Sass or LESS file. Sass is Ruby-based and\\nLESS is JavaScript based,\", \" and both typically run as part of your local development process. Both have\\ncommand-line tools avai\", \"lable, as well as built-in support in Visual Studio for running them using Gulp\\nor Grunt tasks.\\n\\n37\\n\", \"\\nCHAPTER 5 | Common client-side web technologies\\n\\n\\fJavaScript\\n\\nJavaScript is a dynamic, interpreted \", \"programming language that has been standardized in the\\nECMAScript language specification. It is the \", \"programming language of the web. Like CSS, JavaScript\\ncan be defined as attributes within HTML eleme\", \"nts, as blocks of script within a page, or in separate\\nfiles. Just like CSS, it\\u2019s recommended to org\", \"anize JavaScript into separate files, keeping it separated as\\nmuch as possible from the HTML found o\", \"n individual web pages or application views.\\n\\nWhen working with JavaScript in your web application, \", \"there are a few tasks that you\\u2019ll commonly\\nneed to perform:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nSelecting an HTML element a\", \"nd retrieving and/or updating its value.\\n\\nQuerying a Web API for data.\\n\\nSending a command to a Web A\", \"PI (and responding to a callback with its result).\\n\\nPerforming validation.\\n\\nYou can perform all of t\", \"hese tasks with JavaScript alone, but many libraries exist to make these tasks\\neasier. One of the fi\", \"rst and most successful of these libraries is jQuery, which continues to be a\\npopular choice for sim\", \"plifying these tasks on web pages. For Single Page Applications (SPAs), jQuery\\ndoesn\\u2019t provide many \", \"of the desired features that Angular and React offer.\\n\\nLegacy web apps with jQuery\\n\\nAlthough ancient\", \" by JavaScript framework standards, jQuery continues to be a commonly used library\\nfor working with \", \"HTML/CSS and building applications that make AJAX calls to web APIs. However,\\njQuery operates at the\", \" level of the browser document object model (DOM), and by default offers only\\nan imperative, rather \", \"than declarative, model.\\n\\nFor example, imagine that if a textbox\\u2019s value exceeds 10, an element on t\", \"he page should be made\\nvisible. In jQuery, this functionality would typically be implemented by writ\", \"ing an event handler with\\ncode that would inspect the textbox\\u2019s value and set the visibility of the \", \"target element based on that\\nvalue. This process is an imperative, code-based approach. Another fram\", \"ework might instead use\\ndatabinding to bind the visibility of the element to the value of the textbo\", \"x declaratively. This\\napproach would not require writing any code, but instead only requires decorat\", \"ing the elements\\ninvolved with data binding attributes. As client-side behaviors grow more complex, \", \"data binding\\napproaches frequently result in simpler solutions with less code and conditional comple\", \"xity.\\n\\njQuery vs a SPA Framework\\n\\nFactor\\n\\njQuery  Angular\\n\\nAbstracts the DOM\\n\\nAJAX Support\\n\\nYes\\n\\nYes\", \"\\n\\nDeclarative Data Binding  No\\n\\nMVC-style Routing\\n\\nNo\\n\\nYes\\n\\nYes\\n\\nYes\\n\\nYes\\n\\n38\\n\\nCHAPTER 5 | Common cl\", \"ient-side web technologies\\n\\n\\fFactor\\n\\njQuery  Angular\\n\\nTemplating\\n\\nDeep-Link Routing\\n\\nNo\\n\\nNo\\n\\nYes\\n\\nYe\", \"s\\n\\nMost of the features jQuery lacks intrinsically can be added with the addition of other libraries\", \".\\nHowever, a SPA framework like Angular provides these features in a more integrated fashion, since \", \"it\\u2019s\\nbeen designed with all of them in mind from the start. Also, jQuery is an imperative library, m\", \"eaning\\nthat you need to call jQuery functions in order to do anything with jQuery. Much of the work \", \"and\\nfunctionality that SPA frameworks provide can be done declaratively, requiring no actual code to\", \" be\\nwritten.\\n\\nData binding is a great example of this functionality. In jQuery, it usually only take\", \"s one line of code to\\nget the value of a DOM element or to set an element\\u2019s value. However, you have\", \" to write this code\\nanytime you need to change the value of the element, and sometimes this will occ\", \"ur in multiple\\nfunctions on a page. Another common example is element visibility. In jQuery, there m\", \"ight be many\\ndifferent places where you\\u2019d write code to control whether certain elements were visibl\", \"e. In each of\\nthese cases, when using data binding, no code would need to be written. You\\u2019d simply b\", \"ind the value\\nor visibility of the elements in question to a viewmodel on the page, and changes to t\", \"hat viewmodel\\nwould automatically be reflected in the bound elements.\\n\\nAngular SPAs\\n\\nAngular remains\", \" one of the world\\u2019s most popular JavaScript frameworks. Since Angular 2, the team\\nrebuilt the framew\", \"ork from the ground up (using TypeScript) and rebranded from the original\\nAngularJS name to Angular.\", \" Now several years old, the redesigned Angular continues to be a robust\\nframework for building Singl\", \"e Page Applications.\\n\\nAngular applications are built from components. Components combine HTML templa\", \"tes with special\\nobjects and control a portion of the page. A simple component from Angular\\u2019s docs i\", \"s shown here:\\n\\nimport { Component } from '@angular/core';\\n\\n@Component({\\n    selector: 'my-app',\\n    \", \"template: `<h1>Hello {{name}}</h1>`\\n})\\n\\nexport class AppComponent { name = 'Angular'; }\\n\\nComponents \", \"are defined using the @Component decorator function, which takes in metadata about\\nthe component. Th\", \"e selector property identifies the ID of the element on the page where this\\ncomponent will be displa\", \"yed. The template property is a simple HTML template that includes a\\nplaceholder that corresponds to\", \" the component\\u2019s name property, defined on the last line.\\n\\nBy working with components and templates,\", \" instead of DOM elements, Angular apps can operate at a\\nhigher level of abstraction and with less ov\", \"erall code than apps written using just JavaScript (also\\ncalled \\u201cvanilla JS\\u201d) or with jQuery. Angula\", \"r also imposes some order on how you organize your client-\\nside script files. By convention, Angular\", \" apps use a common folder structure, with module and\\n\\n39\\n\\nCHAPTER 5 | Common client-side web technol\", \"ogies\\n\\n\\fcomponent script files located in an app folder. Angular scripts concerned with building, de\", \"ploying,\\nand testing the app are typically located in a higher-level folder.\\n\\nYou can develop Angula\", \"r apps by using a CLI. Getting started with Angular development locally\\n(assuming you already have g\", \"it and npm installed) consists of simply cloning a repo from GitHub and\\nrunning npm install and npm \", \"start. Beyond this, Angular ships its own CLI, which can create projects,\\nadd files, and assist with\", \" testing, bundling, and deployment tasks. This CLI friendliness makes Angular\\nespecially compatible \", \"with ASP.NET Core, which also features great CLI support.\\n\\nMicrosoft has developed a reference appli\", \"cation, eShopOnContainers, which includes an Angular SPA\\nimplementation. This app includes Angular m\", \"odules to manage the online store\\u2019s shopping basket,\\nload and display items from its catalog, and ha\", \"ndling order creation. You can view and download the\\nsample application from GitHub.\\n\\nReact\\n\\nUnlike \", \"Angular, which offers a full Model-View-Controller pattern implementation, React is only\\nconcerned w\", \"ith views. It\\u2019s not a framework, just a library, so to build a SPA you\\u2019ll need to leverage\\nadditiona\", \"l libraries. There are a number of libraries that are designed to be used with React to\\nproduce rich\", \" single page applications.\\n\\nOne of React\\u2019s most important features is its use of a virtual DOM. The \", \"virtual DOM provides React\\nwith several advantages, including performance (the virtual DOM can optim\", \"ize which parts of the\\nactual DOM need to be updated) and testability (no need to have a browser to \", \"test React and its\\ninteractions with its virtual DOM).\\n\\nReact is also unusual in how it works with H\", \"TML. Rather than having a strict separation between code\\nand markup (with references to JavaScript a\", \"ppearing in HTML attributes perhaps), React adds HTML\\ndirectly within its JavaScript code as JSX. JS\", \"X is HTML-like syntax that can compile down to pure\\nJavaScript. For example:\\n\\n<ul>\\n{ authors.map(aut\", \"hor =>\\n    <li key={author.id}>{author.name}</li>\\n)}\\n</ul>\\n\\nIf you already know JavaScript, learning\", \" React should be easy. There isn\\u2019t nearly as much learning\\ncurve or special syntax involved as with \", \"Angular or other popular libraries.\\n\\nBecause React isn\\u2019t a full framework, you\\u2019ll typically want oth\", \"er libraries to handle things like routing,\\nweb API calls, and dependency management. The nice thing\", \" is, you can pick the best library for each\\nof these, but the disadvantage is that you need to make \", \"all of these decisions and verify all of your\\nchosen libraries work well together when you\\u2019re done. \", \"If you want a good starting point, you can use\\na starter kit like React Slingshot, which prepackages\", \" a set of compatible libraries together with React.\\n\\nVue\\n\\nFrom its getting started guide, \\u201cVue is a \", \"progressive framework for building user interfaces. Unlike\\nother monolithic frameworks, Vue is desig\", \"ned from the ground up to be incrementally adoptable. The\\n\\n40\\n\\nCHAPTER 5 | Common client-side web te\", \"chnologies\\n\\n\\fcore library is focused on the view layer only, and is easy to pick up and integrate wi\", \"th other libraries\\nor existing projects. On the other hand, Vue is perfectly capable of powering sop\", \"histicated Single-\\nPage Applications when used in combination with modern tooling and supporting lib\", \"raries.\\u201d\\n\\nGetting started with Vue simply requires including its script within an HTML file:\\n\\n<!-- d\", \"evelopment version, includes helpful console warnings -->\\n<script src=\\\"https://cdn.jsdelivr.net/npm/\", \"vue/dist/vue.js\\\"></script>\\nWith the framework added, you\\u2019re then able to declaratively render data t\", \"o the DOM using\\nVue\\u2019s straightforward templating syntax:\\n<div id=\\\"app\\\">\\n  {{ message }}\\n</div>\\nand t\", \"hen adding the following script:\\nvar app = new Vue({\\n  el: '#app',\\n  data: {\\n    message: 'Hello Vue\", \"!'\\n  }\\n})\\n\\nThis is enough to render \\\"Hello Vue!\\\" on the page. Note, however, that Vue isn\\u2019t simply r\", \"endering the\\nmessage to the div once. It supports databinding and dynamic updates such that if the v\", \"alue of\\nmessage changes, the value in the <div> is immediately updated to reflect it.\\n\\nOf course, th\", \"is only scratches the surface of what Vue is capable of. It\\u2019s gained a great deal of\\npopularity in t\", \"he last several years and has a large community. There\\u2019s a huge and growing list of\\nsupporting compo\", \"nents and libraries that work with Vue to extend it as well. If you\\u2019re looking to add\\nclient-side be\", \"havior to your web application or considering building a full SPA, Vue is worth\\ninvestigating.\\n\\nBlaz\", \"or WebAssembly\\n\\nUnlike other JavaScript frameworks, Blazor WebAssembly is a single-page app (SPA) fr\", \"amework for\\nbuilding interactive client-side web apps with .NET. Blazor WebAssembly uses open web st\", \"andards\\nwithout plugins or recompiling code into other languages. Blazor WebAssembly works in all mo\", \"dern\\nweb browsers, including mobile browsers.\\n\\nRunning .NET code inside web browsers is made possibl\", \"e by WebAssembly (abbreviated wasm).\\nWebAssembly is a compact bytecode format optimized for fast dow\", \"nload and maximum execution\\nspeed. WebAssembly is an open web standard and is supported in web brows\", \"ers without plugins.\\n\\nWebAssembly code can access the full functionality of the browser via JavaScri\", \"pt, called JavaScript\\ninteroperability, often shortened to JavaScript interop or JS interop. .NET co\", \"de executed via\\nWebAssembly in the browser runs in the browser\\u2019s JavaScript sandbox with the protect\", \"ions that the\\nsandbox provides against malicious actions on the client machine.\\n\\nFor more informatio\", \"n, see Introduction to ASP.NET Core Blazor.\\n\\nChoosing a SPA Framework\\n\\nWhen considering which option\", \" will work best to support your SPA, keep in mind the following\\nconsiderations:\\n\\n41\\n\\nCHAPTER 5 | Com\", \"mon client-side web technologies\\n\\n\\f\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nIs your team familiar with the framework and it\", \"s dependencies (including TypeScript in some\\ncases)?\\n\\nHow opinionated is the framework, and do you a\", \"gree with its default way of doing things?\\n\\nDoes it (or a companion library) include all of the feat\", \"ures your app requires?\\n\\nIs it well documented?\\n\\nHow active is its community? Are new projects being\", \" built with it?\\n\\nHow active is its core team? Are issues being resolved and new versions shipped reg\", \"ularly?\\n\\nFrameworks continue to evolve with breakneck speed. Use the considerations listed above to \", \"help\\nmitigate the risk of choosing a framework you\\u2019ll later regret being dependent upon. If you\\u2019re\\np\", \"articularly risk-averse, consider a framework that offers commercial support and/or is being\\ndevelop\", \"ed by a large enterprise.\\n\\nReferences \\u2013 Client Web Technologies\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nHTML \", \"and CSS\\nhttps://www.w3.org/standards/webdesign/htmlcss\\n\\nSass vs. LESS\\nhttps://www.keycdn.com/blog/sa\", \"ss-vs-less/\\n\\nStyling ASP.NET Core Apps with LESS, Sass, and Font Awesome\\nhttps://learn.microsoft.com\", \"/aspnet/core/client-side/less-sass-fa\\n\\nClient-Side Development in ASP.NET Core\\nhttps://learn.microso\", \"ft.com/aspnet/core/client-side/\\n\\njQuery\\nhttps://jquery.com/\\n\\nAngular\\nhttps://angular.io/\\n\\nReact\\nhttp\", \"s://reactjs.org/\\n\\nVue\\nhttps://vuejs.org/\\n\\nAngular vs React vs Vue: Which Framework to Choose in 2020\", \"\\nhttps://www.codeinwp.com/blog/angular-vs-vue-vs-react/\\n\\nThe Top JavaScript Frameworks for Front-End\", \" Development in 2020\\nhttps://www.freecodecamp.org/news/complete-guide-for-front-end-developers-javas\", \"cript-\\nframeworks-2019/\\n\\n42\\n\\nCHAPTER 5 | Common client-side web technologies\\n\\n\\fCHAPTER  6\\n\\nDevelop A\", \"SP.NET Core\\nMVC apps\\n\\n\\u201cIt\\u2019s not important to get it right the first time. It\\u2019s vitally important to \", \"get it right the last time.\\u201d -\\nAndrew Hunt and David Thomas\\n\\nASP.NET Core is a cross-platform, open-\", \"source framework for building modern cloud-optimized web\\napplications. ASP.NET Core apps are lightwe\", \"ight and modular, with built-in support for dependency\\ninjection, enabling greater testability and m\", \"aintainability. Combined with MVC, which supports\\nbuilding modern web APIs in addition to view-based\", \" apps, ASP.NET Core is a powerful framework\\nwith which to build enterprise web applications.\\n\\nMVC an\", \"d Razor Pages\\n\\nASP.NET Core MVC offers many features that are useful for building web-based APIs and\", \" apps. The\\nterm MVC stands for \\u201cModel-View-Controller\\u201d, a UI pattern that breaks up the responsibili\", \"ties of\\nresponding to user requests into several parts. In addition to following this pattern, you c\", \"an also\\nimplement features in your ASP.NET Core apps as Razor Pages.\\n\\nRazor Pages are built into ASP\", \".NET Core MVC, and use the same features for routing, model binding,\\nfilters, authorization, etc. Ho\", \"wever, instead of having separate folders and files for Controllers, Models,\\nViews, etc. and using a\", \"ttribute-based routing, Razor Pages are placed in a single folder (\\u201c/Pages\\u201d),\\nroute based on their r\", \"elative location in this folder, and handle requests with handlers instead of\\ncontroller actions. As\", \" a result, when working with Razor Pages, all of the files and classes you need are\\ntypically coloca\", \"ted, not spread throughout the web project.\\n\\nLearn more about how MVC, Razor Pages, and related patt\", \"erns are applied in the eShopOnWeb\\nsample application.\\n\\nWhen you create a new ASP.NET Core App, you \", \"should have a plan in mind for the kind of app you\\nwant to build. When creating a new project, in yo\", \"ur IDE or using the dotnet new CLI command, you\\nwill choose from several templates. The most common \", \"project templates are Empty, Web API, Web\\nApp, and Web App (Model-View-Controller). Although you can\", \" only make this decision when you first\\ncreate a project, it\\u2019s not an irrevocable decision. The Web \", \"API project uses standard Model-View-\\nController controllers \\u2013 it just lacks Views by default. Likew\", \"ise, the default Web App template uses\\nRazor Pages, and so also lacks a Views folder. You can add a \", \"Views folder to these projects later to\\nsupport view-based behavior. Web API and Model-View-Controll\", \"er projects don\\u2019t include a Pages\\n\\n43\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\ffolder by default\", \", but you can add one later to support Razor Pages-based behavior. You can think of\\nthese three temp\", \"lates as supporting three different kinds of default user interaction: data (web API),\\npage-based, a\", \"nd view-based. However, you can mix and match any or all of these templates within a\\nsingle project \", \"if you wish.\\n\\nWhy Razor Pages?\\n\\nRazor Pages is the default approach for new web applications in Visu\", \"al Studio. Razor Pages offers a\\nsimpler way of building page-based application features, such as non\", \"-SPA forms. Using controllers\\nand views, it was common for applications to have very large controlle\", \"rs that worked with many\\ndifferent dependencies and view models and returned many different views. T\", \"his resulted in more\\ncomplexity and often resulted in controllers that didn\\u2019t follow the Single Resp\", \"onsibility Principle or\\nOpen/Closed Principles effectively. Razor Pages addresses this issue by enca\", \"psulating the server-side\\nlogic for a given logical \\u201cpage\\u201d in a web application with its Razor marku\", \"p. A Razor Page that has no\\nserver-side logic can only consist of a Razor file (for instance, \\u201cIndex\", \".cshtml\\u201d). However, most non-\\ntrivial Razor Pages will have an associated page model class, which by\", \" convention is named the same\\nas the Razor file with a \\u201c.cs\\u201d extension (for example, \\u201cIndex.cshtml.c\", \"s\\u201d).\\n\\nA Razor Page\\u2019s page model combines the responsibilities of an MVC controller and a viewmodel.\\n\", \"Instead of handling requests with controller action methods, page model handlers like \\u201cOnGet()\\u201d are\\n\", \"executed, rendering their associated page by default. Razor Pages simplifies the process of building\", \"\\nindividual pages in an ASP.NET Core app, while still providing all the architectural features of AS\", \"P.NET\\nCore MVC. They\\u2019re a good default choice for new page-based functionality.\\n\\nWhen to use MVC\\n\\nIf\", \" you\\u2019re building web APIs, the MVC pattern makes more sense than trying to use Razor Pages. If your\\n\", \"project will only expose web API endpoints, you should ideally start from the Web API project\\ntempla\", \"te. Otherwise, it\\u2019s easy to add controllers and associated API endpoints to any ASP.NET Core\\napp. Us\", \"e the view-based MVC approach if you\\u2019re migrating an existing application from ASP.NET MVC\\n5 or earl\", \"ier to ASP.NET Core MVC and you want to do so with the least amount of effort. Once you\\u2019ve\\nmade the \", \"initial migration, you can evaluate whether it makes sense to adopt Razor Pages for new\\nfeatures or \", \"even as a wholesale migration. For more information about porting .NET 4.x apps to .NET\\n8, see Porti\", \"ng Existing ASP.NET Apps to ASP.NET Core eBook.\\n\\nWhether you choose to build your web app using Razo\", \"r Pages or MVC views, your app will have\\nsimilar performance and will include support for dependency\", \" injection, filters, model binding,\\nvalidation, and so on.\\n\\nMapping requests to responses\\n\\nAt its he\", \"art, ASP.NET Core apps map incoming requests to outgoing responses. At a low level, this\\nmapping is \", \"done with middleware, and simple ASP.NET Core apps and microservices may be\\ncomprised solely of cust\", \"om middleware. When using ASP.NET Core MVC, you can work at a\\nsomewhat higher level, thinking in ter\", \"ms of routes, controllers, and actions. Each incoming request is\\ncompared with the application\\u2019s rou\", \"ting table, and if a matching route is found, the associated action\\n\\n44\\n\\nCHAPTER 6 | Develop ASP.NET\", \" Core MVC apps\\n\\n\\fmethod (belonging to a controller) is called to handle the request. If no matching \", \"route is found, an\\nerror handler (in this case, returning a NotFound result) is called.\\n\\nASP.NET Cor\", \"e MVC apps can use conventional routes, attribute routes, or both. Conventional routes\\nare defined i\", \"n code, specifying routing conventions using syntax like in the example below:\\n\\napp.UseEndpoints(end\", \"points =>\\n{\\n    endpoints.MapControllerRoute(name: \\\"default\\\", pattern:\\n\\\"{controller=Home}/{action=In\", \"dex}/{id?}\\\");\\n});\\n\\nIn this example, a route named \\u201cdefault\\u201d has been added to the routing table. It \", \"defines a route\\ntemplate with placeholders for controller, action, and id. The controller and action\", \" placeholders have\\nthe default specified (Home and Index, respectively), and the id placeholder is o\", \"ptional (by virtue of a\\n\\u201c?\\u201d applied to it). The convention defined here states that the first part o\", \"f a request should correspond\\nto the name of the controller, the second part to the action, and then\", \" if necessary a third part will\\nrepresent an ID parameter. Conventional routes are typically defined\", \" in one place for the application,\\nsuch as in Program.cs where the request middleware pipeline is co\", \"nfigured.\\n\\nAttribute routes are applied to controllers and actions directly, rather than specified g\", \"lobally. This\\napproach has the advantage of making them much more discoverable when you\\u2019re looking a\", \"t a\\nparticular method, but does mean that routing information is not kept in one place in the applic\", \"ation.\\nWith attribute routes, you can easily specify multiple routes for a given action, as well as \", \"combine\\nroutes between controllers and actions. For example:\\n\\n[Route(\\\"Home\\\")]\\npublic class HomeContr\", \"oller : Controller\\n{\\n    [Route(\\\"\\\")] // Combines to define the route template \\\"Home\\\"\\n    [Route(\\\"Ind\", \"ex\\\")] // Combines to define route template \\\"Home/Index\\\"\\n    [Route(\\\"/\\\")] // Does not combine, define\", \"s the route template \\\"\\\"\\n    public IActionResult Index() {}\\n}\\n\\nRoutes can be specified on [HttpGet] \", \"and similar attributes, avoiding the need to add separate [Route]\\nattributes. Attribute routes can a\", \"lso use tokens to reduce the need to repeat controller or action\\nnames, as shown below:\\n\\n[Route(\\\"[co\", \"ntroller]\\\")]\\npublic class ProductsController : Controller\\n{\\n    [Route(\\\"\\\")] // Matches 'Products'\\n  \", \"  [Route(\\\"Index\\\")] // Matches 'Products/Index'\\n    public IActionResult Index() {}\\n}\\n\\nRazor Pages do\", \"n\\u2019t use attribute routing. You can specify additional route template information for a\\nRazor Page as\", \" part of its @page directive:\\n\\n@page \\\"{id:int}\\\"\\n\\n45\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fIn \", \"the previous example, the page in question would match a route with an integer id parameter. For\\nexa\", \"mple, the Products.cshtml page located in the root of /Pages would respond to requests like this\\none\", \":\\n\\n/Products/123\\n\\nOnce a given request has been matched to a route, but before the action method is \", \"called, ASP.NET\\nCore MVC will perform model binding and model validation on the request. Model bindi\", \"ng is\\nresponsible for converting incoming HTTP data into the .NET types specified as parameters of t\", \"he\\naction method to be called. For example, if the action method expects an int id parameter, model\\n\", \"binding will attempt to provide this parameter from a value provided as part of the request. To do s\", \"o,\\nmodel binding looks for values in a posted form, values in the route itself, and query string val\", \"ues.\\nAssuming an id value is found, it will be converted to an integer before being passed into the \", \"action\\nmethod.\\n\\nAfter binding the model but before calling the action method, model validation occur\", \"s. Model\\nvalidation uses optional attributes on the model type, and can help ensure that the provide\", \"d model\\nobject conforms to certain data requirements. Certain values may be specified as required, o\", \"r limited\\nto a certain length or numeric range, etc. If validation attributes are specified but the \", \"model does not\\nconform to their requirements, the property ModelState.IsValid will be false, and the\", \" set of failing\\nvalidation rules will be available to send to the client making the request.\\n\\nIf you\", \"\\u2019re using model validation, you should be sure to always check that the model is valid before\\nperfor\", \"ming any state-altering commands, to ensure your app is not corrupted by invalid data. You can\\nuse a\", \" filter to avoid the need to add code for this validation in every action. ASP.NET Core MVC filters\\n\", \"offer a way of intercepting groups of requests, so that common policies and cross-cutting concerns\\nc\", \"an be applied on a targeted basis. Filters can be applied to individual actions, whole controllers, \", \"or\\nglobally for an application.\\n\\nFor web APIs, ASP.NET Core MVC supports content negotiation, allowi\", \"ng requests to specify how\\nresponses should be formatted. Based on headers provided in the request, \", \"actions returning data will\\nformat the response in XML, JSON, or another supported format. This feat\", \"ure enables the same API to\\nbe used by multiple clients with different data format requirements.\\n\\nWe\", \"b API projects should consider using the [ApiController] attribute, which can be applied to\\nindividu\", \"al controllers, to a base controller class, or to the entire assembly. This attribute adds\\nautomatic\", \" model validation checking and any action with an invalid model will return a BadRequest\\nwith the de\", \"tails of the validation errors. The attribute also requires all actions have an attribute route,\\nrat\", \"her than using a conventional route, and returns more detailed ProblemDetails information in\\nrespons\", \"e to errors.\\n\\nKeeping controllers under control\\n\\nFor page-based applications, Razor Pages do a great\", \" job of keeping controllers from getting too\\nlarge. Each individual page is given its own files and \", \"classes dedicated just to its handler(s). Prior to\\nthe introduction of Razor Pages, many view-centri\", \"c applications would have large controller classes\\nresponsible for many different actions and views.\", \" These classes would naturally grow to have many\\nresponsibilities and dependencies, making them hard\", \"er to maintain. If you find your view-based\\n\\n46\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fcontrol\", \"lers are growing too large, consider refactoring them to use Razor Pages, or introducing a\\npattern l\", \"ike a mediator.\\n\\nThe mediator design pattern is used to reduce coupling between classes while allowi\", \"ng\\ncommunication between them. In ASP.NET Core MVC applications, this pattern is frequently employed\", \"\\nto break up controllers into smaller pieces by using handlers to do the work of action methods. The\", \"\\npopular MediatR NuGet package is often used to accomplish this. Typically, controllers include many\", \"\\ndifferent action methods, each of which may require certain dependencies. The set of all\\ndependenci\", \"es required by any action must be passed into the controller\\u2019s constructor. When using\\nMediatR, the \", \"only dependency a controller will typically have is an instance of the mediator. Each\\naction then us\", \"es the mediator instance to send a message, which is processed by a handler. The\\nhandler is specific\", \" to a single action and thus only needs the dependencies required by that action. An\\nexample of a co\", \"ntroller using MediatR is shown here:\\n\\npublic class OrderController : Controller\\n{\\n    private reado\", \"nly IMediator _mediator;\\n\\n    public OrderController(IMediator mediator)\\n    {\\n        _mediator = m\", \"ediator;\\n    }\\n\\n    [HttpGet]\\n    public async Task<IActionResult> MyOrders()\\n    {\\n        var view\", \"Model = await _mediator.Send(new GetMyOrders(User.Identity.Name));\\n        return View(viewModel);\\n \", \"   }\\n    // other actions implemented similarly\\n}\\n\\nIn the MyOrders action, the call to Send a GetMyO\", \"rders message is handled by this class:\\n\\npublic class GetMyOrdersHandler : IRequestHandler<GetMyOrde\", \"rs, IEnumerable<OrderViewModel>>\\n{\\n    private readonly IOrderRepository _orderRepository;\\n    publi\", \"c GetMyOrdersHandler(IOrderRepository orderRepository)\\n    {\\n        _orderRepository = orderReposit\", \"ory;\\n    }\\n\\n  public async Task<IEnumerable<OrderViewModel>> Handle(GetMyOrders request,\\nCancellatio\", \"nToken cancellationToken)\\n    {\\n        var specification = new CustomerOrdersWithItemsSpecification\", \"(request.UserName);\\n        var orders = await _orderRepository.ListAsync(specification);\\n        re\", \"turn orders.Select(o => new OrderViewModel\\n            {\\n                OrderDate = o.OrderDate,\\n  \", \"              OrderItems = o.OrderItems?.Select(oi => new OrderItemViewModel()\\n                  {\\n \", \"                   PictureUrl = oi.ItemOrdered.PictureUri,\\n                    ProductId = oi.ItemOr\", \"dered.CatalogItemId,\\n                    ProductName = oi.ItemOrdered.ProductName,\\n                 \", \"   UnitPrice = oi.UnitPrice,\\n                    Units = oi.Units\\n\\n47\\n\\nCHAPTER 6 | Develop ASP.NET C\", \"ore MVC apps\\n\\n\\f                  }).ToList(),\\n                OrderNumber = o.Id,\\n                Sh\", \"ippingAddress = o.ShipToAddress,\\n                Total = o.Total()\\n        });\\n    }\\n}\\n\\nThe end resu\", \"lt of this approach is for controllers to be much smaller and focused primarily on routing\\nand model\", \" binding, while individual handlers are responsible for the specific tasks needed by a given\\nendpoin\", \"t. This approach can also be achieved without MediatR by using the ApiEndpoints NuGet\\npackage, which\", \" attempts to bring to API controllers the same benefits Razor Pages brings to view-\\nbased controller\", \"s.\\n\\nReferences \\u2013 Mapping Requests to Responses\\n\\n\\u2022\\n\\nRouting to Controller Actions\\nhttps://learn.micro\", \"soft.com/aspnet/core/mvc/controllers/routing\\n\\n\\u2022  Model Binding\\n\\nhttps://learn.microsoft.com/aspnet/c\", \"ore/mvc/models/model-binding\\n\\n\\u2022  Model Validation\\n\\n\\u2022\\n\\n\\u2022\\n\\nhttps://learn.microsoft.com/aspnet/core/mvc\", \"/models/validation\\n\\nFilters\\nhttps://learn.microsoft.com/aspnet/core/mvc/controllers/filters\\n\\nApiCont\", \"roller Attribute\\nhttps://learn.microsoft.com/aspnet/core/web-api/\\n\\nWorking with dependencies\\n\\nASP.NE\", \"T Core has built-in support for and internally makes use of a technique known as dependency\\ninjectio\", \"n. Dependency injection is a technique that enables loose coupling between different parts of\\nan app\", \"lication. Looser coupling is desirable because it makes it easier to isolate parts of the\\napplicatio\", \"n, allowing for testing or replacement. It also makes it less likely that a change in one part of\\nth\", \"e application will have an unexpected impact somewhere else in the application. Dependency\\ninjection\", \" is based on the dependency inversion principle, and is often key to achieving the\\nopen/closed princ\", \"iple. When evaluating how your application works with its dependencies, beware of\\nthe static cling c\", \"ode smell, and remember the aphorism \\u201cnew is glue.\\u201d\\n\\nStatic cling occurs when your classes make call\", \"s to static methods, or access static properties, which\\nhave side effects or dependencies on infrast\", \"ructure. For example, if you have a method that calls a\\nstatic method, which in turn writes to a dat\", \"abase, your method is tightly coupled to the database.\\nAnything that breaks that database call will \", \"break your method. Testing such methods is notoriously\\ndifficult, since such tests either require co\", \"mmercial mocking libraries to mock the static calls, or can\\nonly be tested with a test database in p\", \"lace. Static calls that don\\u2019t have any dependence on\\ninfrastructure, especially those calls that are\", \" completely stateless, are fine to call and have no impact\\non coupling or testability (beyond coupli\", \"ng code to the static call itself).\\n\\n48\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fMany developers\", \" understand the risks of static cling and global state, but will still tightly couple their\\ncode to \", \"specific implementations through direct instantiation. \\u201cNew is glue\\u201d is meant to be a reminder\\nof th\", \"is coupling, and not a general condemnation of the use of the new keyword. Just as with static\\nmetho\", \"d calls, new instances of types that have no external dependencies typically do not tightly\\ncouple c\", \"ode to implementation details or make testing more difficult. But each time a class is\\ninstantiated,\", \" take just a brief moment to consider whether it makes sense to hard-code that specific\\ninstance in \", \"that particular location, or if it would be a better design to request that instance as a\\ndependency\", \".\\n\\nDeclare your dependencies\\n\\nASP.NET Core is built around having methods and classes declare their \", \"dependencies, requesting\\nthem as arguments. ASP.NET applications are typically set up in Program.cs \", \"or in a Startup class.\\n\\nNote\\n\\nConfiguring apps completely in Program.cs is the default approach for \", \".NET 6 (and later) and Visual\\nStudio 2022 apps. Project templates have been updated to help you get \", \"started with this new\\napproach. ASP.NET Core projects can still use a Startup class, if desired.\\n\\nCo\", \"nfigure services in Program.cs\\n\\nFor very simple apps, you can wire up dependencies directly in Progr\", \"am.cs file using a\\nWebApplicationBuilder. Once all needed services have been added, the builder is u\", \"sed to create the\\napp.\\n\\nvar builder = WebApplication.CreateBuilder(args);\\n\\n// Add services to the co\", \"ntainer.\\nbuilder.Services.AddRazorPages();\\n\\nvar app = builder.Build();\\n\\nConfigure services in Startu\", \"p.cs\\n\\nThe Startup.cs is itself configured to support dependency injection at several points. If you\\u2019\", \"re using a\\nStartup class, you can give it a constructor and it can request dependencies through it, \", \"like so:\\n\\npublic class Startup\\n{\\n    public Startup(IHostingEnvironment env)\\n    {\\n        var build\", \"er = new ConfigurationBuilder()\\n            .SetBasePath(env.ContentRootPath)\\n            .AddJsonFi\", \"le(\\\"appsettings.json\\\", optional: false, reloadOnChange: true)\\n            .AddJsonFile($\\\"appsettings\", \".{env.EnvironmentName}.json\\\", optional: true);\\n    }\\n}\\n\\nThe Startup class is interesting in that the\", \"re are no explicit type requirements for it. It doesn\\u2019t inherit\\nfrom a special Startup base class, n\", \"or does it implement any particular interface. You can give it a\\nconstructor, or not, and you can sp\", \"ecify as many parameters on the constructor as you want. When\\n\\n49\\n\\nCHAPTER 6 | Develop ASP.NET Core \", \"MVC apps\\n\\n\\fthe web host you\\u2019ve configured for your application starts, it will call the Startup clas\", \"s (if you\\u2019ve told it\\nto use one), and will use dependency injection to populate any dependencies the\", \" Startup class\\nrequires. Of course, if you request parameters that aren\\u2019t configured in the services\", \" container used by\\nASP.NET Core, you\\u2019ll get an exception, but as long as you stick to dependencies t\", \"he container knows\\nabout, you can request anything you want.\\n\\nDependency injection is built into you\", \"r ASP.NET Core apps right from the start, when you create the\\nStartup instance. It doesn\\u2019t stop ther\", \"e for the Startup class. You can also request dependencies in the\\nConfigure method:\\n\\npublic void Con\", \"figure(IApplicationBuilder app,\\n    IHostingEnvironment env,\\n    ILoggerFactory loggerFactory)\\n{\\n\\n}\\n\", \"\\nThe ConfigureServices method is the exception to this behavior; it must take just one parameter of\\n\", \"type IServiceCollection. It doesn\\u2019t really need to support dependency injection, since on the one ha\", \"nd\\nit is responsible for adding objects to the services container, and on the other it has access to\", \" all\\ncurrently configured services via the IServiceCollection parameter. Thus, you can work with\\ndep\", \"endencies defined in the ASP.NET Core services collection in every part of the Startup class, either\", \"\\nby requesting the needed service as a parameter or by working with the IServiceCollection in\\nConfig\", \"ureServices.\\n\\nNote\\n\\nIf you need to ensure certain services are available to your Startup class, you \", \"can configure them using\\nan IWebHostBuilder and its ConfigureServices method inside the CreateDefaul\", \"tBuilder call.\\n\\nThe Startup class is a model for how you should structure other parts of your ASP.NE\", \"T Core\\napplication, from Controllers to Middleware to Filters to your own Services. In each case, yo\", \"u should\\nfollow the Explicit Dependencies Principle, requesting your dependencies rather than direct\", \"ly creating\\nthem, and leveraging dependency injection throughout your application. Be careful of whe\", \"re and how\\nyou directly instantiate implementations, especially services and objects that work with \", \"infrastructure\\nor have side effects. Prefer working with abstractions defined in your application co\", \"re and passed in as\\narguments to hardcoding references to specific implementation types.\\n\\nStructurin\", \"g the application\\n\\nMonolithic applications typically have a single entry point. In the case of an AS\", \"P.NET Core web\\napplication, the entry point will be the ASP.NET Core web project. However, that does\", \"n\\u2019t mean the\\nsolution should consist of just a single project. It\\u2019s useful to break up the applicati\", \"on into different\\nlayers in order to follow separation of concerns. Once broken up into layers, it\\u2019s\", \" helpful to go beyond\\nfolders to separate projects, which can help achieve better encapsulation. The\", \" best approach to\\nachieve these goals with an ASP.NET Core application is a variation of the Clean A\", \"rchitecture\\ndiscussed in chapter 5. Following this approach, the application\\u2019s solution will compris\", \"e separate\\nlibraries for the UI, Infrastructure, and ApplicationCore.\\n\\n50\\n\\nCHAPTER 6 | Develop ASP.N\", \"ET Core MVC apps\\n\\n\\fIn addition to these projects, separate test projects are included as well (Testi\", \"ng is discussed in\\nChapter 9).\\n\\nThe application\\u2019s object model and interfaces should be placed in th\", \"e ApplicationCore project. This\\nproject will have as few dependencies as possible (and none on speci\", \"fic infrastructure concerns), and\\nthe other projects in the solution will reference it. Business ent\", \"ities that need to be persisted are\\ndefined in the ApplicationCore project, as are services that do \", \"not directly depend on infrastructure.\\n\\nImplementation details, such as how persistence is performed\", \" or how notifications might be sent to a\\nuser, are kept in the Infrastructure project. This project \", \"will reference implementation-specific\\npackages such as Entity Framework Core, but should not expose\", \" details about these implementations\\noutside of the project. Infrastructure services and repositorie\", \"s should implement interfaces that are\\ndefined in the ApplicationCore project, and its persistence i\", \"mplementations are responsible for\\nretrieving and storing entities defined in ApplicationCore.\\n\\nThe \", \"ASP.NET Core UI project is responsible for any UI level concerns, but should not include business\\nlo\", \"gic or infrastructure details. In fact, ideally it shouldn\\u2019t even have a dependency on the Infrastru\", \"cture\\nproject, which will help ensure no dependency between the two projects is introduced accidenta\", \"lly.\\nThis can be achieved using a third-party DI container like Autofac, which allows you to define \", \"DI rules\\nin Module classes in each project.\\n\\nAnother approach to decoupling the application from imp\", \"lementation details is to have the\\napplication call microservices, perhaps deployed in individual Do\", \"cker containers. This provides even\\ngreater separation of concerns and decoupling than leveraging DI\", \" between two projects, but has\\nadditional complexity.\\n\\nFeature organization\\n\\nBy default, ASP.NET Cor\", \"e applications organize their folder structure to include Controllers and Views,\\nand frequently View\", \"Models. Client-side code to support these server-side structures is typically stored\\nseparately in t\", \"he wwwroot folder. However, large applications may encounter problems with this\\norganization, since \", \"working on any given feature often requires jumping between these folders. This\\ngets more and more d\", \"ifficult as the number of files and subfolders in each folder grows, resulting in a\\ngreat deal of sc\", \"rolling through Solution Explorer. One solution to this problem is to organize\\napplication code by f\", \"eature instead of by file type. This organizational style is typically referred to as\\nfeature folder\", \"s or feature slices (see also: Vertical Slices).\\n\\nASP.NET Core MVC supports Areas for this purpose. \", \"Using areas, you can create separate sets of\\nControllers and Views folders (as well as any associate\", \"d models) in each Area folder. Figure 7-1 shows\\nan example folder structure, using Areas.\\n\\n51\\n\\nCHAPT\", \"ER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fFigure 7-1. Sample Area Organization\\n\\nWhen using Areas, you m\", \"ust use attributes to decorate your controllers with the name of the area to\\nwhich they belong:\\n\\n[Ar\", \"ea(\\\"Catalog\\\")]\\npublic class HomeController\\n{}\\n\\nYou also need to add area support to your routes:\\n\\nap\", \"p.UseEndpoints(endpoints =>\\n{\\n    endpoints.MapControllerRoute(name: \\\"areaRoute\\\", pattern:\\n\\\"{area:ex\", \"ists}/{controller=Home}/{action=Index}/{id?}\\\");\\n    endpoints.MapControllerRoute(name: \\\"default\\\", pa\", \"ttern:\\n\\\"{controller=Home}/{action=Index}/{id?}\\\");\\n});\\n\\nIn addition to the built-in support for Areas\", \", you can also use your own folder structure, and\\nconventions in place of attributes and custom rout\", \"es. This would allow you to have feature folders\\nthat didn\\u2019t include separate folders for Views, Con\", \"trollers, etc., keeping the hierarchy flatter and\\nmaking it easier to see all related files in a sin\", \"gle place for each feature. For APIs, folders can be used\\nto replace controllers, and each folder ca\", \"n contain all of the API Endpoints and their associated DTOs.\\n\\n52\\n\\nCHAPTER 6 | Develop ASP.NET Core \", \"MVC apps\\n\\n\\fASP.NET Core uses built-in convention types to control its behavior. You can modify or re\", \"place these\\nconventions. For example, you can create a convention that will automatically get the fe\", \"ature name\\nfor a given controller based on its namespace (which typically correlates to the folder i\", \"n which the\\ncontroller is located):\\n\\npublic class FeatureConvention : IControllerModelConvention\\n{\\n \", \"   public void Apply(ControllerModel controller)\\n    {\\n        controller.Properties.Add(\\\"feature\\\",\\n\", \"        GetFeatureName(controller.ControllerType));\\n    }\\n\\n    private string GetFeatureName(TypeInf\", \"o controllerType)\\n    {\\n        string[] tokens = controllerType.FullName.Split('.');\\n        if (!t\", \"okens.Any(t => t == \\\"Features\\\")) return \\\"\\\";\\n        string featureName = tokens\\n            .SkipWhi\", \"le(t => !t.Equals(\\\"features\\\",\\nStringComparison.CurrentCultureIgnoreCase))\\n            .Skip(1)\\n     \", \"       .Take(1)\\n            .FirstOrDefault();\\n        return featureName;\\n    }\\n}\\n\\nYou then specify\", \" this convention as an option when you add support for MVC to your application in\\nConfigureServices \", \"(or in Program.cs):\\n\\n// ConfigureServices\\nservices.AddMvc(o => o.Conventions.Add(new FeatureConventi\", \"on()));\\n\\n// Program.cs\\nbuilder.Services.AddMvc(o => o.Conventions.Add(new FeatureConvention()));\\n\\nAS\", \"P.NET Core MVC also uses a convention to locate views. You can override it with a custom\\nconvention \", \"so that views will be located in your feature folders (using the feature name provided by\\nthe Featur\", \"eConvention, above). You can learn more about this approach and download a working\\nsample from the M\", \"SDN Magazine article, Feature Slices for ASP.NET Core MVC.\\n\\nAPIs and Blazor applications\\n\\nIf your ap\", \"plication includes a set of web APIs, which must be secured, these APIs should ideally be\\nconfigured\", \" as a separate project from your View or Razor Pages application. Separating APIs,\\nespecially public\", \" APIs, from your server-side web application has a number of benefits. These\\napplications often will\", \" have unique deployment and load characteristics. They\\u2019re also very likely to\\nadopt different mechan\", \"isms for security, with standard form-based applications leveraging cookie-\\nbased authentication and\", \" APIs most likely using token-based authentication.\\n\\nAdditionally, Blazor applications, whether usin\", \"g Blazor Server or Blazor WebAssembly, should be built\\nas separate projects. The applications have d\", \"ifferent runtime characteristics as well as security models.\\nThey\\u2019re likely to share common types wi\", \"th the server-side web application (or API project), and these\\ntypes should be defined in a common s\", \"hared project.\\n\\n53\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fThe addition of a Blazor WebAssembly\", \" admin interface to eShopOnWeb required adding several new\\nprojects. The Blazor WebAssembly project \", \"itself, BlazorAdmin. A new set of public API endpoints, used\\nby BlazorAdmin and configured to use to\", \"ken-based authentication, is defined in the PublicApi project.\\nAnd certain shared types used by both\", \" of these projects are kept in a new BlazorShared project.\\n\\nOne might ask, why add a separate Blazor\", \"Shared project when there is already a common\\nApplicationCore project that could be used to share an\", \"y types required by both PublicApi and\\nBlazorAdmin? The answer is that this project includes all of \", \"the application\\u2019s business logic and is thus\\nmuch larger than necessary and also much more likely to\", \" need to be kept secure on the server.\\nRemember that any library referenced by BlazorAdmin will be d\", \"ownloaded to users\\u2019 browsers when\\nthey load the Blazor application.\\n\\nDepending on whether one is usi\", \"ng the Backends-For-Frontends (BFF) pattern, the APIs consumed by\\nthe Blazor WebAssembly app may not\", \" share their types 100% with Blazor. In particular, a public API\\nthat\\u2019s meant to be consumed by many\", \" different clients may define its own request and result types,\\nrather than sharing them in a client\", \"-specific shared project. In the eShopOnWeb sample, the\\nassumption is being made that the PublicApi \", \"project is, in fact, hosting a public API, so not all of its\\nrequest and response types come from th\", \"e BlazorShared project.\\n\\nCross-cutting concerns\\n\\nAs applications grow, it becomes increasingly impor\", \"tant to factor out cross-cutting concerns to\\neliminate duplication and maintain consistency. Some ex\", \"amples of cross-cutting concerns in ASP.NET\\nCore applications are authentication, model validation r\", \"ules, output caching, and error handling,\\nthough there are many others. ASP.NET Core MVC filters all\", \"ow you to run code before or after certain\\nsteps in the request processing pipeline. For instance, a\", \" filter can run before and after model binding,\\nbefore and after an action, or before and after an a\", \"ction\\u2019s result. You can also use an authorization\\nfilter to control access to the rest of the pipeli\", \"ne. Figures 7-2 shows how request execution flows\\nthrough filters, if configured.\\n\\n54\\n\\nCHAPTER 6 | D\", \"evelop ASP.NET Core MVC apps\\n\\n\\fFigure 7-2. Request execution through filters and request pipeline.\\n\\n\", \"Filters are usually implemented as attributes, so you can apply them to controllers or actions (or e\", \"ven\\nglobally). When added in this fashion, filters specified at the action level override or build u\", \"pon filters\\nspecified at the controller level, which themselves override global filters. For example\", \", the [Route]\\nattribute can be used to build up routes between controllers and actions. Likewise, au\", \"thorization can\\nbe configured at the controller level, and then overridden by individual actions, as\", \" the following\\nsample demonstrates:\\n\\n[Authorize]\\npublic class AccountController : Controller\\n{\\n    [\", \"AllowAnonymous] // overrides the Authorize attribute\\n    public async Task<IActionResult> Login() {}\", \"\\n    public async Task<IActionResult> ForgotPassword() {}\\n}\\n\\nThe first method, Login, uses the [Allo\", \"wAnonymous] filter (attribute) to override the Authorize filter\\nset at the controller level. The For\", \"gotPassword action (and any other action in the class that doesn\\u2019t\\nhave an AllowAnonymous attribute)\", \" will require an authenticated request.\\n\\nFilters can be used to eliminate duplication in the form of\", \" common error handling policies for APIs.\\nFor example, a typical API policy is to return a NotFound \", \"response to requests referencing keys that\\ndo not exist, and a BadRequest response if model validati\", \"on fails. The following example\\ndemonstrates these two policies in action:\\n\\n[HttpPut(\\\"{id}\\\")]\\npublic\", \" async Task<IActionResult> Put(int id, [FromBody]Author author)\\n{\\n\\n55\\n\\nCHAPTER 6 | Develop ASP.NET C\", \"ore MVC apps\\n\\n\\f    if ((await _authorRepository.ListAsync()).All(a => a.Id != id))\\n    {\\n        ret\", \"urn NotFound(id);\\n    }\\n    if (!ModelState.IsValid)\\n    {\\n        return BadRequest(ModelState);\\n  \", \"  }\\n    author.Id = id;\\n    await _authorRepository.UpdateAsync(author);\\n    return Ok();\\n}\\n\\nDon\\u2019t a\", \"llow your action methods to become cluttered with conditional code like this. Instead, pull the\\npoli\", \"cies into filters that can be applied on an as-needed basis. In this example, the model validation\\nc\", \"heck, which should occur anytime a command is sent to the API, can be replaced by the following\\nattr\", \"ibute:\\n\\npublic class ValidateModelAttribute : ActionFilterAttribute\\n{\\n    public override void OnAct\", \"ionExecuting(ActionExecutingContext context)\\n    {\\n        if (!context.ModelState.IsValid)\\n        \", \"{\\n            context.Result = new BadRequestObjectResult(context.ModelState);\\n        }\\n    }\\n}\\n\\nYo\", \"u can add the ValidateModelAttribute to your project as a NuGet dependency by including the\\nArdalis.\", \"ValidateModel package. For APIs, you can use the ApiController attribute to enforce this\\nbehavior wi\", \"thout the need for a separate ValidateModel filter.\\n\\nLikewise, a filter can be used to check if a re\", \"cord exists and return a 404 before the action is executed,\\neliminating the need to perform these ch\", \"ecks in the action. Once you\\u2019ve pulled out common\\nconventions and organized your solution to separat\", \"e infrastructure code and business logic from your\\nUI, your MVC action methods should be extremely t\", \"hin:\\n\\n[HttpPut(\\\"{id}\\\")]\\n[ValidateAuthorExists]\\npublic async Task<IActionResult> Put(int id, [FromBod\", \"y]Author author)\\n{\\n    await _authorRepository.UpdateAsync(author);\\n    return Ok();\\n}\\n\\nYou can read\", \" more about implementing filters and download a working sample from the MSDN\\nMagazine article, Real-\", \"World ASP.NET Core MVC Filters.\\n\\nIf you find that you have a number of common responses from APIs ba\", \"sed on common scenarios like\\nvalidation errors (Bad Request), resource not found, and server errors,\", \" you might consider using a\\nresult abstraction. The result abstraction would be returned by services\", \" consumed by API endpoints,\\nand the controller action or endpoint would use a filter to translate th\", \"ese into IActionResults.\\n\\n56\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fReferences \\u2013 Structuring a\", \"pplications\\n\\n\\u2022\\n\\nAreas\\nhttps://learn.microsoft.com/aspnet/core/mvc/controllers/areas\\n\\n\\u2022  MSDN Magazin\", \"e \\u2013 Feature Slices for ASP.NET Core MVC\\n\\nhttps://learn.microsoft.com/archive/msdn-magazine/2016/sept\", \"ember/asp-net-core-feature-\\nslices-for-asp-net-core-mvc\\n\\n\\u2022\\n\\nFilters\\nhttps://learn.microsoft.com/aspn\", \"et/core/mvc/controllers/filters\\n\\n\\u2022  MSDN Magazine \\u2013 Real World ASP.NET Core MVC Filters\\n\\nhttps://lea\", \"rn.microsoft.com/archive/msdn-magazine/2016/august/asp-net-core-real-world-\\nasp-net-core-mvc-filters\", \"\\n\\n\\u2022\\n\\nResult in eShopOnWeb\\nhttps://github.com/dotnet-architecture/eShopOnWeb/wiki/Patterns#result\\n\\nSe\", \"curity\\n\\nSecuring web applications is a large topic, with many considerations. At its most basic leve\", \"l, security\\ninvolves ensuring you know who a given request is coming from, and then ensuring that th\", \"e request\\nonly has access to resources it should. Authentication is the process of comparing credent\", \"ials\\nprovided with a request to those in a trusted data store, to see if the request should be treat\", \"ed as\\ncoming from a known entity. Authorization is the process of restricting access to certain reso\", \"urces\\nbased on user identity. A third security concern is protecting requests from eavesdropping by \", \"third\\nparties, for which you should at least ensure that SSL is used by your application.\\n\\nIdentity\\n\", \"\\nASP.NET Core Identity is a membership system you can use to support login functionality for your\\nap\", \"plication. It has support for local user accounts as well as external login provider support from\\npr\", \"oviders like Microsoft Account, Twitter, Facebook, Google, and more. In addition to ASP.NET Core\\nIde\", \"ntity, your application can use windows authentication, or a third-party identity provider like\\nIden\", \"tity Server.\\n\\nASP.NET Core Identity is included in new project templates if the Individual User Acco\", \"unts option is\\nselected. This template includes support for registration, login, external logins, fo\", \"rgotten passwords,\\nand additional functionality.\\n\\n57\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fFi\", \"gure 7-3. Select Individual User Accounts to have Identity preconfigured.\\n\\nIdentity support is confi\", \"gured in Program.cs or Startup, and includes configuring services as well as\\nmiddleware.\\n\\nConfigure \", \"Identity in Program.cs\\n\\nIn Program.cs, you configure services from the WebHostBuilder instance, and \", \"then once the app is\\ncreated, you configure its middleware. The key points to note are the call to A\", \"ddDefaultIdentity for\\nrequired services and the UseAuthentication and UseAuthorization calls which a\", \"dd required\\nmiddleware.\\n\\nvar builder = WebApplication.CreateBuilder(args);\\n\\n// Add services to the c\", \"ontainer.\\nvar connectionString = builder.Configuration.GetConnectionString(\\\"DefaultConnection\\\");\\nbui\", \"lder.Services.AddDbContext<ApplicationDbContext>(options =>\\n    options.UseSqlServer(connectionStrin\", \"g));\\nbuilder.Services.AddDatabaseDeveloperPageExceptionFilter();\\n\\nbuilder.Services.AddDefaultIdentit\", \"y<IdentityUser>(options =>\\noptions.SignIn.RequireConfirmedAccount = true)\\n    .AddEntityFrameworkSto\", \"res<ApplicationDbContext>();\\nbuilder.Services.AddRazorPages();\\n\\nvar app = builder.Build();\\n\\n// Confi\", \"gure the HTTP request pipeline.\\nif (app.Environment.IsDevelopment())\\n\\n58\\n\\nCHAPTER 6 | Develop ASP.NE\", \"T Core MVC apps\\n\\n\\f{\\n    app.UseMigrationsEndPoint();\\n}\\nelse\\n{\\n  app.UseExceptionHandler(\\\"/Error\\\");\\n \", \" // The default HSTS value is 30 days. You may want to change this for production\\nscenarios, see htt\", \"ps://aka.ms/aspnetcore-hsts.\\n  app.UseHsts();\\n}\\n\\napp.UseHttpsRedirection();\\napp.UseStaticFiles();\\n\\na\", \"pp.UseRouting();\\n\\napp.UseAuthentication();\\napp.UseAuthorization();\\n\\napp.MapRazorPages();\\n\\napp.Run();\", \"\\n\\nConfiguring Identity in app startup\\n\\n// Add framework services.\\nbuilder.Services.AddDbContext<Appl\", \"icationDbContext>(options =>\\n    options.UseSqlServer(Configuration.GetConnectionString(\\\"DefaultConn\", \"ection\\\")));\\nbuilder.Services.AddIdentity<ApplicationUser, IdentityRole>()\\n    .AddEntityFrameworkSto\", \"res<ApplicationDbContext>()\\n    .AddDefaultTokenProviders();\\nbuilder.Services.AddMvc();\\n\\nvar app = b\", \"uilder.Build();\\n\\nif (app.Environment.IsDevelopment())\\n{\\n    app.UseMigrationsEndPoint();\\n}\\nelse\\n{\\n  \", \"  app.UseExceptionHandler(\\\"/Error\\\");\\n    app.UseHsts();\\n}\\n\\napp.UseHttpsRedirection();\\napp.UseStaticF\", \"iles();\\n\\napp.UseRouting();\\n\\napp.UseAuthentication();\\napp.UseAuthorization();\\n\\napp.MapRazorPages();\\n\\n\", \"It\\u2019s important that UseAuthentication and UseAuthorization appear before MapRazorPages. When\\nconfigu\", \"ring Identity services, you\\u2019ll notice a call to AddDefaultTokenProviders. This has nothing to do\\nwit\", \"h tokens that may be used to secure web communications, but instead refers to providers that\\ncreate \", \"prompts that can be sent to users via SMS or email in order for them to confirm their identity.\\n\\n59\\n\", \"\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fYou can learn more about configuring two-factor authent\", \"ication and enabling external login providers\\nfrom the official ASP.NET Core docs.\\n\\nAuthentication\\n\\n\", \"Authentication is the process of determining who is accessing the system. If you\\u2019re using ASP.NET\\nCo\", \"re Identity and the configuration methods shown in the previous section, it will automatically\\nconfi\", \"gure some authentication defaults in the application. However, you can also configure these\\ndefaults\", \" manually, or override the ones set by AddIdentity. If you\\u2019re using Identity, it configures\\ncookie-b\", \"ased authentication as the default scheme.\\n\\nIn web-based authentication, there are typically up to f\", \"ive actions that may be performed in the\\ncourse of authenticating a client of a system. These are:\\n\\n\", \"\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nAuthenticate. Use the information provided by the client to create an identity for th\", \"em to use\\nwithin the application.\\n\\nChallenge. This action is used to require the client to identify \", \"themselves.\\n\\nForbid. Inform the client they are forbidden from performing an action.\\n\\nSign-in. Persi\", \"st the existing client in some way.\\n\\nSign-out. Remove the client from persistence.\\n\\nThere are a numb\", \"er of common techniques for performing authentication in web applications. These\\nare referred to as \", \"schemes. A given scheme will define actions for some or all of the above options.\\nSome schemes only \", \"support a subset of actions, and may require a separate scheme to perform those\\nit does not support.\", \" For example, the OpenId-Connect (OIDC) scheme doesn\\u2019t support Sign-in or\\nSign-out, but is commonly \", \"configured to use Cookie authentication for this persistence.\\n\\nIn your ASP.NET Core application, you\", \" can configure a DefaultAuthenticateScheme as well as optional\\nspecific schemes for each of the acti\", \"ons described above. For example, DefaultChallengeScheme,\\nDefaultForbidScheme, etc. Calling AddIdent\", \"ity<TUser,TRole> configures a number of aspects of the\\napplication and adds many required services. \", \"It also includes this call to configure the authentication\\nscheme:\\n\\nbuilder.Services.AddAuthenticati\", \"on(options =>\\n{\\n    options.DefaultAuthenticateScheme = IdentityConstants.ApplicationScheme;\\n    opt\", \"ions.DefaultChallengeScheme = IdentityConstants.ApplicationScheme;\\n    options.DefaultSignInScheme =\", \" IdentityConstants.ExternalScheme;\\n});\\n\\nThese schemes use cookies for persistence and redirection to\", \" login pages for authentication by\\ndefault. These schemes are appropriate for web applications that \", \"interact with users via web browsers,\\nbut not recommended for APIs. Instead, APIs will typically use\", \" another form of authentication, such as\\nJWT bearer tokens.\\n\\nWeb APIs are consumed by code, such as \", \"HttpClient in .NET applications and equivalent types in other\\nframeworks. These clients expect a usa\", \"ble response from an API call, or a status code indicating what,\\nif any, problem has occurred. These\", \" clients are not interacting through a browser and do not render or\\ninteract with any HTML that an A\", \"PI might return. Thus, it is not appropriate for API endpoints to\\nredirect their clients to login pa\", \"ges if they are not authenticated. Another scheme is more appropriate.\\n\\n60\\n\\nCHAPTER 6 | Develop ASP.\", \"NET Core MVC apps\\n\\n\\fTo configure authentication for APIs, you might set up authentication like the f\", \"ollowing, used by the\\nPublicApi project in the eShopOnWeb reference application:\\n\\nbuilder.Services\\n \", \"   .AddAuthentication(config =>\\n    {\\n      config.DefaultScheme = JwtBearerDefaults.AuthenticationS\", \"cheme;\\n    })\\n    .AddJwtBearer(config =>\\n    {\\n        config.RequireHttpsMetadata = false;\\n       \", \" config.SaveToken = true;\\n        config.TokenValidationParameters = new TokenValidationParameters\\n \", \"       {\\n            ValidateIssuerSigningKey = true,\\n            IssuerSigningKey = new SymmetricSe\", \"curityKey(key),\\n            ValidateIssuer = false,\\n            ValidateAudience = false\\n        };\\n\", \"    });\\n\\nWhile it is possible to configure multiple different authentication schemes within a single\", \" project, it is\\nmuch simpler to configure a single default scheme. For this reason, among others, th\", \"e eShopOnWeb\\nreference application separates its APIs into their own project, PublicApi, separate fr\", \"om the main Web\\nproject that includes the application\\u2019s views and Razor Pages.\\n\\nAuthentication in Bl\", \"azor apps\\n\\nBlazor Server applications can leverage the same authentication features as any other ASP\", \".NET Core\\napplication. Blazor WebAssembly applications cannot use the built-in Identity and Authenti\", \"cation\\nproviders, however, since they run in the browser. Blazor WebAssembly applications can store \", \"user\\nauthentication status locally and can access claims to determine what actions users should be a\", \"ble to\\nperform. However, all authentication and authorization checks should be performed on the serv\", \"er\\nregardless of any logic implemented inside the Blazor WebAssembly app, since users can easily\\nbyp\", \"ass the app and interact with the APIs directly.\\n\\nReferences \\u2013 Authentication\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nAuthentic\", \"ation Actions and Defaults\\nhttps://stackoverflow.com/a/52493428\\n\\nAuthentication and Authorization fo\", \"r SPAs\\nhttps://learn.microsoft.com/aspnet/core/security/authentication/identity-api-authorization\\n\\nA\", \"SP.NET Core Blazor Authentication and Authorization\\nhttps://learn.microsoft.com/aspnet/core/blazor/s\", \"ecurity/\\n\\nSecurity: Authentication and Authorization in ASP.NET Web Forms and Blazor\\nhttps://learn.m\", \"icrosoft.com/dotnet/architecture/blazor-for-web-forms-developers/security-\\nauthentication-authorizat\", \"ion\\n\\nAuthorization\\n\\nThe simplest form of authorization involves restricting access to anonymous user\", \"s. This functionality\\ncan be achieved by applying the [Authorize] attribute to certain controllers o\", \"r actions. If roles are\\n\\n61\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fbeing used, the attribute c\", \"an be further extended to restrict access to users who belong to certain\\nroles, as shown:\\n\\n[Authoriz\", \"e(Roles = \\\"HRManager,Finance\\\")]\\npublic class SalaryController : Controller\\n{\\n\\n}\\n\\nIn this case, users\", \" belonging to either the HRManager or Finance roles (or both) would have access to\\nthe SalaryControl\", \"ler. To require that a user belong to multiple roles (not just one of several), you can\\napply the at\", \"tribute multiple times, specifying a required role each time.\\n\\nSpecifying certain sets of roles as s\", \"trings in many different controllers and actions can lead to\\nundesirable repetition. At a minimum, d\", \"efine constants for these string literals and use the constants\\nanywhere you need to specify the str\", \"ing. You can also configure authorization policies, which\\nencapsulate authorization rules, and then \", \"specify the policy instead of individual roles when applying\\nthe [Authorize] attribute:\\n\\n[Authorize(\", \"Policy = \\\"CanViewPrivateReport\\\")]\\npublic IActionResult ExecutiveSalaryReport()\\n{\\n    return View();\\n\", \"}\\n\\nUsing policies in this way, you can separate the kinds of actions being restricted from the speci\", \"fic roles\\nor rules that apply to it. Later, if you create a new role that needs to have access to ce\", \"rtain resources,\\nyou can just update a policy, rather than updating every list of roles on every [Au\", \"thorize] attribute.\\n\\nClaims\\n\\nClaims are name value pairs that represent properties of an authenticat\", \"ed user. For example, you\\nmight store users\\u2019 employee number as a claim. Claims can then be used as \", \"part of authorization\\npolicies. You could create a policy called \\u201cEmployeeOnly\\u201d that requires the ex\", \"istence of a claim called\\n\\\"EmployeeNumber\\\", as shown in this example:\\n\\npublic void ConfigureServices\", \"(IServiceCollection services)\\n{\\n    services.AddMvc();\\n    services.AddAuthorization(options =>\\n    \", \"{\\n        options.AddPolicy(\\\"EmployeeOnly\\\", policy => policy.RequireClaim(\\\"EmployeeNumber\\\"));\\n    })\", \";\\n}\\n\\nThis policy could then be used with the [Authorize] attribute to protect any controller and/or \", \"action,\\nas described above.\\n\\nSecuring web APIs\\n\\nMost web APIs should implement a token-based authent\", \"ication system. Token authentication is\\nstateless and designed to be scalable. In a token-based auth\", \"entication system, the client must first\\nauthenticate with the authentication provider. If successfu\", \"l, the client is issued a token, which is simply\\n\\n62\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fa \", \"cryptographically meaningful string of characters. The most common format for tokens is JSON Web\\nTok\", \"en, or JWT (often pronounced \\u201cjot\\u201d). When the client then needs to issue a request to an API, it\\nadd\", \"s this token as a header on the request. The server then validates the token found in the request\\nhe\", \"ader before completing the request. Figure 7-4 demonstrates this process.\\n\\nFigure 7-4. Token-based a\", \"uthentication for Web APIs.\\n\\nYou can create your own authentication service, integrate with Azure AD\", \" and OAuth, or implement a\\nservice using an open-source tool like IdentityServer.\\n\\nJWT tokens can em\", \"bed claims about the user, which can be read on the client or server. You can use a\\ntool like jwt.io\", \" to view the contents of a JWT token. Do not store sensitive data like passwords or keys\\nin JTW toke\", \"ns, since their contents are easily read.\\n\\nWhen using JWT tokens with SPA or Blazor WebAssembly appl\", \"ications, you must store the token\\nsomewhere on the client and then add it to every API call. This a\", \"ctivity is typically done as a header, as\\nthe following code demonstrates:\\n\\n// AuthService.cs in Bla\", \"zorAdmin project of eShopOnWeb\\nprivate async Task SetAuthorizationHeader()\\n{\\n      var token = await\", \" GetToken();\\n      _httpClient.DefaultRequestHeaders.Authorization = new\\nAuthenticationHeaderValue(\\\"\", \"Bearer\\\", token);\\n}\\n\\nAfter calling the above method, requests made with the _httpClient will have the\", \" token embedded in\\nthe request\\u2019s headers, allowing the server-side API to authenticate and authorize\", \" the request.\\n\\n63\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fCustom Security\\n\\nCaution\\n\\nAs a genera\", \"l rule, avoid implementing your own custom security implementations.\\n\\nBe especially careful about \\u201cr\", \"olling your own\\u201d implementation of cryptography, user membership, or\\ntoken generation system. There \", \"are many commercial and open-source alternatives available, which\\nwill almost certainly have better \", \"security than a custom implementation.\\n\\nReferences \\u2013 Security\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nSecurity Docs Overv\", \"iew\\nhttps://learn.microsoft.com/aspnet/core/security/\\n\\nEnforcing SSL in an ASP.NET Core App\\nhttps://\", \"learn.microsoft.com/aspnet/core/security/enforcing-ssl\\n\\nIntroduction to Identity\\nhttps://learn.micro\", \"soft.com/aspnet/core/security/authentication/identity\\n\\nIntroduction to Authorization\\nhttps://learn.m\", \"icrosoft.com/aspnet/core/security/authorization/introduction\\n\\nAuthentication and Authorization for A\", \"PI Apps in Azure App Service\\nhttps://learn.microsoft.com/azure/app-service-api/app-service-api-authe\", \"ntication\\n\\nIdentity Server\\nhttps://github.com/IdentityServer\\n\\nClient communication\\n\\nIn addition to s\", \"erving pages and responding to requests for data via web APIs, ASP.NET Core apps can\\ncommunicate dir\", \"ectly with connected clients. This outbound communication can use a variety of\\ntransport technologie\", \"s, the most common being WebSockets. ASP.NET Core SignalR is a library that\\nmakes it simple to add r\", \"eal-time server-to-client communication functionality to your applications.\\nSignalR supports a varie\", \"ty of transport technologies, including WebSockets, and abstracts away many\\nof the implementation de\", \"tails from the developer.\\n\\nReal-time client communication, whether using WebSockets directly or othe\", \"r techniques, are useful in\\na variety of application scenarios. Some examples include:\\n\\n\\u2022\\n\\nLive chat\", \" room applications\\n\\n\\u2022  Monitoring applications\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nJob progress updates\\n\\nNotifications\\n\\nIntera\", \"ctive forms applications\\n\\nWhen building client communication into your applications, there are typic\", \"ally two components:\\n\\n64\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\f\\u2022\\n\\n\\u2022\\n\\nServer-side connection m\", \"anager (SignalR Hub, WebSocketManager WebSocketHandler)\\n\\nClient-side library\\n\\nClients aren\\u2019t limited\", \" to browsers \\u2013 mobile apps, console apps, and other native apps can also\\ncommunicate using SignalR/W\", \"ebSockets. The following simple program echoes all content sent to a\\nchat application to the console\", \", as part of a WebSocketManager sample application:\\n\\npublic class Program\\n{\\n    private static Conne\", \"ction _connection;\\n    public static void Main(string[] args)\\n    {\\n        StartConnectionAsync();\\n\", \"        _connection.On(\\\"receiveMessage\\\", (arguments) =>\\n        {\\n            Console.WriteLine($\\\"{a\", \"rguments[0]} said: {arguments[1]}\\\");\\n        });\\n        Console.ReadLine();\\n        StopConnectionA\", \"sync();\\n    }\\n\\n    public static async Task StartConnectionAsync()\\n    {\\n        _connection = new C\", \"onnection();\\n        await _connection.StartConnectionAsync(\\\"ws://localhost:65110/chat\\\");\\n    }\\n\\n   \", \" public static async Task StopConnectionAsync()\\n    {\\n        await _connection.StopConnectionAsync(\", \");\\n    }\\n}\\n\\nConsider ways in which your applications communicate directly with client applications, \", \"and consider\\nwhether real-time communication would improve your app\\u2019s user experience.\\n\\nReferences \\u2013\", \" Client Communication\\n\\n\\u2022\\n\\nASP.NET Core SignalR\\nhttps://github.com/dotnet/aspnetcore/tree/main/src/Si\", \"gnalR\\n\\n\\u2022  WebSocket Manager\\n\\nhttps://github.com/radu-matei/websocket-manager\\n\\nDomain-driven design \\u2013\", \" Should you apply it?\\n\\nDomain-Driven Design (DDD) is an agile approach to building software that emp\", \"hasizes focusing on\\nthe business domain. It places a heavy emphasis on communication and interaction\", \" with business\\ndomain expert(s) who can relate to the developers how the real-world system works. Fo\", \"r example, if\\nyou\\u2019re building a system that handles stock trades, your domain expert might be an exp\", \"erienced stock\\nbroker. DDD is designed to address large, complex business problems, and is often not\", \" appropriate\\nfor smaller, simpler applications, as the investment in understanding and modeling the \", \"domain is not\\nworth it.\\n\\n65\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fWhen building software foll\", \"owing a DDD approach, your team (including non-technical stakeholders\\nand contributors) should devel\", \"op a ubiquitous language for the problem space. That is, the same\\nterminology should be used for the\", \" real-world concept being modeled, the software equivalent, and\\nany structures that might exist to p\", \"ersist the concept (for example, database tables). Thus, the\\nconcepts described in the ubiquitous la\", \"nguage should form the basis for your domain model.\\n\\nYour domain model comprises objects that intera\", \"ct with one another to represent the behavior of the\\nsystem. These objects may fall into the followi\", \"ng categories:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nEntities, which represent objects with a thread of identity. Entities ar\", \"e typically stored in\\npersistence with a key by which they can later be retrieved.\\n\\nAggregates, whic\", \"h represent groups of objects that should be persisted as a unit.\\n\\nValue objects, which represent co\", \"ncepts that can be compared on the basis of the sum of\\ntheir property values. For example, DateRange\", \" consisting of a start and end date.\\n\\nDomain events, which represent things happening within the sys\", \"tem that are of interest to\\nother parts of the system.\\n\\nA DDD domain model should encapsulate comple\", \"x behavior within the model. Entities, in particular,\\nshould not merely be collections of properties\", \". When the domain model lacks behavior and merely\\nrepresents the state of the system, it is said to \", \"be an anemic model, which is undesirable in DDD.\\n\\nIn addition to these model types, DDD typically em\", \"ploys a variety of patterns:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nRepository, for abstracting persistence details.\\n\\nFacto\", \"ry, for encapsulating complex object creation.\\n\\nServices, for encapsulating complex behavior and/or \", \"infrastructure implementation details.\\n\\nCommand, for decoupling issuing commands and executing the c\", \"ommand itself.\\n\\nSpecification, for encapsulating query details.\\n\\nDDD also recommends the use of the \", \"Clean Architecture discussed previously, allowing for loose\\ncoupling, encapsulation, and code that c\", \"an easily be verified using unit tests.\\n\\nWhen should you apply DDD\\n\\nDDD is well suited to large appl\", \"ications with significant business (not just technical) complexity. The\\napplication should require t\", \"he knowledge of domain experts. There should be significant behavior in\\nthe domain model itself, rep\", \"resenting business rules and interactions beyond simply storing and\\nretrieving the current state of \", \"various records from data stores.\\n\\nWhen shouldn\\u2019t you apply DDD\\n\\nDDD involves investments in modelin\", \"g, architecture, and communication that may not be warranted\\nfor smaller applications or application\", \"s that are essentially just CRUD (create/read/update/delete). If\\nyou choose to approach your applica\", \"tion following DDD, but find that your domain has an anemic\\nmodel with no behavior, you may need to \", \"rethink your approach. Either your application may not\\n\\n66\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC app\", \"s\\n\\n\\fneed DDD, or you may need assistance refactoring your application to encapsulate business logic \", \"in\\nthe domain model, rather than in your database or user interface.\\n\\nA hybrid approach would be to \", \"only use DDD for the transactional or more complex areas of the\\napplication, but not for simpler CRU\", \"D or read-only portions of the application. For instance, you don\\u2019t\\nneed the constraints of an Aggre\", \"gate if you\\u2019re querying data to display a report or to visualize data\\nfor a dashboard. It\\u2019s perfectl\", \"y acceptable to have a separate, simpler read model for such\\nrequirements.\\n\\nReferences \\u2013 Domain-Driv\", \"en Design\\n\\n\\u2022\\n\\nDDD in Plain English (StackOverflow Answer)\\nhttps://stackoverflow.com/questions/122239\", \"2/can-someone-explain-domain-driven-design-\\nddd-in-plain-english-please/1222488#1222488\\n\\nDeployment\\n\", \"\\nThere are a few steps involved in the process of deploying your ASP.NET Core application, regardles\", \"s\\nof where it will be hosted. The first step is to publish the application, which can be done using \", \"the\\ndotnet publish CLI command. This step will compile the application and place all of the files ne\", \"eded to\\nrun the application into a designated folder. When you deploy from Visual Studio, this step \", \"is\\nperformed for you automatically. The publish folder contains .exe and .dll files for the applicat\", \"ion and\\nits dependencies. A self-contained application will also include a version of the .NET runti\", \"me. ASP.NET\\nCore applications will also include configuration files, static client assets, and MVC v\", \"iews.\\n\\nASP.NET Core applications are console applications that must be started when the server boots\", \" and\\nrestarted if the application (or server) crashes. A process manager can be used to automate thi\", \"s\\nprocess. The most common process managers for ASP.NET Core are Nginx and Apache on Linux and\\nIIS o\", \"r Windows Service on Windows.\\n\\nIn addition to a process manager, ASP.NET Core applications may use a\", \" reverse proxy server. A\\nreverse proxy server receives HTTP requests from the Internet and forwards \", \"them to Kestrel after\\nsome preliminary handling. Reverse proxy servers provide a layer of security f\", \"or the application.\\nKestrel also doesn\\u2019t support hosting multiple applications on the same port, so \", \"techniques like host\\nheaders cannot be used with it to enable hosting multiple applications on the s\", \"ame port and IP\\naddress.\\n\\nFigure 7-5. ASP.NET hosted in Kestrel behind a reverse proxy server\\n\\nAnoth\", \"er scenario in which a reverse proxy can be helpful is to secure multiple applications using\\nSSL/HTT\", \"PS. In this case, only the reverse proxy would need to have SSL configured. Communication\\nbetween th\", \"e reverse proxy server and Kestrel could take place over HTTP, as shown in Figure 7-6.\\n\\n67\\n\\nCHAPTER \", \"6 | Develop ASP.NET Core MVC apps\\n\\n\\fFigure 7-6. ASP.NET hosted behind an HTTPS-secured reverse proxy\", \" server\\n\\nAn increasingly popular approach is to host your ASP.NET Core application in a Docker conta\", \"iner,\\nwhich then can be hosted locally or deployed to Azure for cloud-based hosting. The Docker cont\", \"ainer\\ncould contain your application code, running on Kestrel, and would be deployed behind a revers\", \"e\\nproxy server, as shown above.\\n\\nIf you\\u2019re hosting your application on Azure, you can use Microsoft \", \"Azure Application Gateway as a\\ndedicated virtual appliance to provide several services. In addition \", \"to acting as a reverse proxy for\\nindividual applications, Application Gateway can also offer the fol\", \"lowing features:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nHTTP load balancing\\n\\nSSL offload (SSL only to Internet)\\n\\nEnd to End SSL\\n\\n\", \"\\u2022  Multi-site routing (consolidate up to 20 sites on a single Application Gateway)\\n\\n\\u2022  Web applicati\", \"on firewall\\n\\n\\u2022  Websocket support\\n\\n\\u2022\\n\\nAdvanced diagnostics\\n\\nLearn more about Azure deployment option\", \"s in Chapter 10.\\n\\nReferences \\u2013 Deployment\\n\\n\\u2022\\n\\nHosting and Deployment Overview\\nhttps://learn.microsof\", \"t.com/aspnet/core/publishing/\\n\\n\\u2022  When to use Kestrel with a reverse proxy\\n\\nhttps://learn.microsoft.\", \"com/aspnet/core/fundamentals/servers/kestrel#when-to-use-kestrel-\\nwith-a-reverse-proxy\\n\\n\\u2022\\n\\n\\u2022\\n\\nHost A\", \"SP.NET Core apps in Docker\\nhttps://learn.microsoft.com/aspnet/core/publishing/docker\\n\\nIntroducing Az\", \"ure Application Gateway\\nhttps://learn.microsoft.com/azure/application-gateway/application-gateway-in\", \"troduction\\n\\n68\\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\\n\\n\\fCHAPTER  7\\n\\nWorking with Data in\\nASP.NET\", \" Core Apps\\n\\n\\u201cData is a precious thing and will last longer than the systems themselves.\\u201d\\n\\nTim Berner\", \"s-Lee\\n\\nData access is an important part of almost any software application. ASP.NET Core supports va\", \"rious\\ndata access options, including Entity Framework Core (and Entity Framework 6 as well), and can\", \" work\\nwith any .NET data access framework. The choice of which data access framework to use depends \", \"on\\nthe application\\u2019s needs. Abstracting these choices from the ApplicationCore and UI projects, and\\n\", \"encapsulating implementation details in Infrastructure, helps to produce loosely coupled, testable\\ns\", \"oftware.\\n\\nEntity Framework Core (for relational databases)\\n\\nIf you\\u2019re writing a new ASP.NET Core app\", \"lication that needs to work with relational data, then Entity\\nFramework Core (EF Core) is the recomm\", \"ended way for your application to access its data. EF Core is\\nan object-relational mapper (O/RM) tha\", \"t enables .NET developers to persist objects to and from a\\ndata source. It eliminates the need for m\", \"ost of the data access code developers would typically need\\nto write. Like ASP.NET Core, EF Core has\", \" been rewritten from the ground up to support modular\\ncross-platform applications. You add it to you\", \"r application as a NuGet package, configure it during\\napp startup, and request it through dependency\", \" injection wherever you need it.\\n\\nTo use EF Core with a SQL Server database, run the following dotne\", \"t CLI command:\\n\\ndotnet add package Microsoft.EntityFrameworkCore.SqlServer\\n\\nTo add support for an In\", \"Memory data source, for testing:\\n\\ndotnet add package Microsoft.EntityFrameworkCore.InMemory\\n\\nThe DbC\", \"ontext\\n\\nTo work with EF Core, you need a subclass of DbContext. This class holds properties represen\", \"ting\\ncollections of the entities your application will work with. The eShopOnWeb sample includes a\\nC\", \"atalogContext with collections for items, brands, and types:\\n\\n69\\n\\nCHAPTER 7 | Working with Data in A\", \"SP.NET Core Apps\\n\\n\\fpublic class CatalogContext : DbContext\\n{\\n  public CatalogContext(DbContextOption\", \"s<CatalogContext> options) : base(options)\\n  {\\n\\n  }\\n\\n  public DbSet<CatalogItem> CatalogItems { get;\", \" set; }\\n  public DbSet<CatalogBrand> CatalogBrands { get; set; }\\n  public DbSet<CatalogType> Catalog\", \"Types { get; set; }\\n}\\n\\nYour DbContext must have a constructor that accepts DbContextOptions and pass\", \" this argument to\\nthe base DbContext constructor. If you have only one DbContext in your application\", \", you can pass an\\ninstance of DbContextOptions, but if you have more than one you must use the gener\", \"ic\\nDbContextOptions<T> type, passing in your DbContext type as the generic parameter.\\n\\nConfiguring E\", \"F Core\\n\\nIn your ASP.NET Core application, you\\u2019ll typically configure EF Core in Program.cs with your\", \"\\napplication\\u2019s other dependencies. EF Core uses a DbContextOptionsBuilder, which supports several\\nhe\", \"lpful extension methods to streamline its configuration. To configure CatalogContext to use a SQL\\nSe\", \"rver database with a connection string defined in Configuration, you would add the following code:\\n\\n\", \"builder.Services.AddDbContext<CatalogContext>(\\n    options => options.UseSqlServer(\\n        builder.\", \"Configuration.GetConnectionString(\\\"DefaultConnection\\\")));\\n\\nTo use the in-memory database:\\n\\nbuilder.S\", \"ervices.AddDbContext<CatalogContext>(options =>\\n    options.UseInMemoryDatabase());\\n\\nOnce you have i\", \"nstalled EF Core, created a DbContext child type, and added the type to the\\napplication\\u2019s services, \", \"you are ready to use EF Core. You can request an instance of your DbContext\\ntype in any service that\", \" needs it and start working with your persisted entities using LINQ as if they\\nwere simply in a coll\", \"ection. EF Core does the work of translating your LINQ expressions into SQL\\nqueries to store and ret\", \"rieve your data.\\n\\nYou can see the queries EF Core is executing by configuring a logger and ensuring \", \"its level is set to at\\nleast Information, as shown in Figure 8-1.\\n\\n70\\n\\nCHAPTER 7 | Working with Data\", \" in ASP.NET Core Apps\\n\\n\\fFigure 8-1. Logging EF Core queries to the console\\n\\nFetching and storing Dat\", \"a\\n\\nTo retrieve data from EF Core, you access the appropriate property and use LINQ to filter the res\", \"ult.\\nYou can also use LINQ to perform projection, transforming the result from one type to another. \", \"The\\nfollowing example would retrieve CatalogBrands, ordered by name, filtered by their Enabled prope\", \"rty,\\nand projected onto a SelectListItem type:\\n\\nvar brandItems = await _context.CatalogBrands\\n    .W\", \"here(b => b.Enabled)\\n    .OrderBy(b => b.Name)\\n    .Select(b => new SelectListItem {\\n        Value =\", \" b.Id, Text = b.Name })\\n    .ToListAsync();\\n\\nIt\\u2019s important in the above example to add the call to \", \"ToListAsync in order to execute the query\\nimmediately. Otherwise, the statement will assign an IQuer\", \"yable<SelectListItem> to brandItems,\\nwhich will not be executed until it is enumerated. There are pr\", \"os and cons to returning IQueryable\\nresults from methods. It allows the query EF Core will construct\", \" to be further modified, but can also\\nresult in errors that only occur at run time, if operations ar\", \"e added to the query that EF Core cannot\\ntranslate. It\\u2019s generally safer to pass any filters into th\", \"e method performing the data access, and return\\nback an in-memory collection (for example, List<T>) \", \"as the result.\\n\\nEF Core tracks changes on entities it fetches from persistence. To save changes to a\", \" tracked entity, you\\njust call the SaveChangesAsync method on the DbContext, making sure it\\u2019s the sa\", \"me DbContext\\ninstance that was used to fetch the entity. Adding and removing entities is directly do\", \"ne on the\\nappropriate DbSet property, again with a call to SaveChangesAsync to execute the database\\n\", \"commands. The following example demonstrates adding, updating, and removing entities from\\npersistenc\", \"e.\\n\\n71\\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\f// create\\nvar newBrand = new CatalogBra\", \"nd() { Brand = \\\"Acme\\\" };\\n_context.Add(newBrand);\\nawait _context.SaveChangesAsync();\\n\\n// read and upd\", \"ate\\nvar existingBrand = _context.CatalogBrands.Find(1);\\nexistingBrand.Brand = \\\"Updated Brand\\\";\\nawait\", \" _context.SaveChangesAsync();\\n\\n// read and delete (alternate Find syntax)\\nvar brandToDelete = _conte\", \"xt.Find<CatalogBrand>(2);\\n_context.CatalogBrands.Remove(brandToDelete);\\nawait _context.SaveChangesAs\", \"ync();\\n\\nEF Core supports both synchronous and async methods for fetching and saving. In web applicat\", \"ions,\\nit\\u2019s recommended to use the async/await pattern with the async methods, so that web server thr\", \"eads\\nare not blocked while waiting for data access operations to complete.\\n\\nFor more information, se\", \"e Buffering and Streaming.\\n\\nFetching related data\\n\\nWhen EF Core retrieves entities, it populates all\", \" of the properties that are stored directly with that\\nentity in the database. Navigation properties,\", \" such as lists of related entities, are not populated and\\nmay have their value set to null. This pro\", \"cess ensures EF Core is not fetching more data than is\\nneeded, which is especially important for web\", \" applications, which must quickly process requests and\\nreturn responses in an efficient manner. To i\", \"nclude relationships with an entity using eager loading,\\nyou specify the property using the Include \", \"extension method on the query, as shown:\\n\\n// .Include requires using Microsoft.EntityFrameworkCore\\nv\", \"ar brandsWithItems = await _context.CatalogBrands\\n    .Include(b => b.Items)\\n    .ToListAsync();\\n\\nYo\", \"u can include multiple relationships, and you can also include subrelationships using ThenInclude.\\nE\", \"F Core will execute a single query to retrieve the resulting set of entities. Alternately you can in\", \"clude\\nnavigation properties of navigation properties by passing a \\u2018.\\u2019-separated string to the .Inclu\", \"de()\\nextension method, like so:\\n\\n    .Include(\\\"Items.Products\\\")\\n\\nIn addition to encapsulating filter\", \"ing logic, a specification can specify the shape of the data to be\\nreturned, including which propert\", \"ies to populate. The eShopOnWeb sample includes several\\nspecifications that demonstrate encapsulatin\", \"g eager loading information within the specification. You\\ncan see how the specification is used as p\", \"art of a query here:\\n\\n// Includes all expression-based includes\\nquery = specification.Includes.Aggre\", \"gate(query,\\n            (current, include) => current.Include(include));\\n\\n// Include any string-base\", \"d include statements\\nquery = specification.IncludeStrings.Aggregate(query,\\n            (current, inc\", \"lude) => current.Include(include));\\n\\n72\\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\fAnothe\", \"r option for loading related data is to use explicit loading. Explicit loading allows you to load\\nad\", \"ditional data into an entity that has already been retrieved. Since this approach involves a separat\", \"e\\nrequest to the database, it\\u2019s not recommended for web applications, which should minimize the\\nnumb\", \"er of database round trips made per request.\\n\\nLazy loading is a feature that automatically loads rel\", \"ated data as it is referenced by the application. EF\\nCore has added support for lazy loading in vers\", \"ion 2.1. Lazy loading is not enabled by default and\\nrequires installing the Microsoft.EntityFramewor\", \"kCore.Proxies. As with explicit loading, lazy loading\\nshould typically be disabled for web applicati\", \"ons, since its use will result in additional database\\nqueries being made within each web request. Un\", \"fortunately, the overhead incurred by lazy loading\\noften goes unnoticed at development time, when th\", \"e latency is small and often the data sets used for\\ntesting are small. However, in production, with \", \"more users, more data, and more latency, the\\nadditional database requests can often result in poor p\", \"erformance for web applications that make\\nheavy use of lazy loading.\\n\\nAvoid Lazy Loading Entities in\", \" Web Applications\\n\\nIt\\u2019s a good idea to test your application while examining the actual database que\", \"ries it makes. Under\\ncertain circumstances, EF Core may make many more queries or a more expensive q\", \"uery than is\\noptimal for the application. One such problem is known as a Cartesian Explosion. The EF\", \" Core team\\nmakes available the AsSplitQuery method as one of several ways to tune runtime behavior.\\n\", \"\\nEncapsulating data\\n\\nEF Core supports several features that allow your model to properly encapsulate\", \" its state. A common\\nproblem in domain models is that they expose collection navigation properties a\", \"s publicly accessible\\nlist types. This problem allows any collaborator to manipulate the contents of\", \" these collection types,\\nwhich may bypass important business rules related to the collection, possib\", \"ly leaving the object in an\\ninvalid state. The solution to this problem is to expose read-only acces\", \"s to related collections, and\\nexplicitly provide methods defining ways in which clients can manipula\", \"te them, as in this example:\\n\\npublic class Basket : BaseEntity\\n{\\n  public string BuyerId { get; set;\", \" }\\n  private readonly List<BasketItem> _items = new List<BasketItem>();\\n  public IReadOnlyCollection\", \"<BasketItem> Items => _items.AsReadOnly();\\n\\n  public void AddItem(int catalogItemId, decimal unitPri\", \"ce, int quantity = 1)\\n  {\\n    var existingItem = Items.FirstOrDefault(i => i.CatalogItemId == catalo\", \"gItemId);\\n    if (existingItem == null)\\n    {\\n      _items.Add(new BasketItem()\\n      {\\n        Cata\", \"logItemId = catalogItemId,\\n        Quantity = quantity,\\n        UnitPrice = unitPrice\\n      });\\n    \", \"}\\n    else existingItem.Quantity += quantity;\\n  }\\n}\\n\\n73\\n\\nCHAPTER 7 | Working with Data in ASP.NET Co\", \"re Apps\\n\\n\\fThis entity type doesn\\u2019t expose a public List or ICollection property, but instead exposes\", \" an\\nIReadOnlyCollection type that wraps the underlying List type. When using this pattern, you can\\ni\", \"ndicate to Entity Framework Core to use the backing field like so:\\n\\nprivate void ConfigureBasket(Ent\", \"ityTypeBuilder<Basket> builder)\\n{\\n  var navigation = builder.Metadata.FindNavigation(nameof(Basket.I\", \"tems));\\n\\n  navigation.SetPropertyAccessMode(PropertyAccessMode.Field);\\n}\\n\\nAnother way in which you c\", \"an improve your domain model is by using value objects for types that\\nlack identity and are only dis\", \"tinguished by their properties. Using such types as properties of your\\nentities can help keep logic \", \"specific to the value object where it belongs, and can avoid duplicate logic\\nbetween multiple entiti\", \"es that use the same concept. In Entity Framework Core, you can persist value\\nobjects in the same ta\", \"ble as their owning entity by configuring the type as an owned entity, like so:\\n\\nprivate void Config\", \"ureOrder(EntityTypeBuilder<Order> builder)\\n{\\n  builder.OwnsOne(o => o.ShipToAddress);\\n}\\n\\nIn this exa\", \"mple, the ShipToAddress property is of type Address. Address is a value object with several\\nproperti\", \"es such as Street and City. EF Core maps the Order object to its table with one column per\\nAddress p\", \"roperty, prefixing each column name with the name of the property. In this example, the\\nOrder table \", \"would include columns such as ShipToAddress_Street and ShipToAddress_City. It\\u2019s also\\npossible to sto\", \"re owned types in separate tables, if desired.\\n\\nLearn more about owned entity support in EF Core.\\n\\nR\", \"esilient connections\\n\\nExternal resources like SQL databases may occasionally be unavailable. In case\", \"s of temporary\\nunavailability, applications can use retry logic to avoid raising an exception. This \", \"technique is\\ncommonly referred to as connection resiliency. You can implement your own retry with ex\", \"ponential\\nbackoff technique by attempting to retry with an exponentially increasing wait time, until\", \" a maximum\\nretry count has been reached. This technique embraces the fact that cloud resources might\", \"\\nintermittently be unavailable for short periods of time, resulting in the failure of some requests.\", \"\\n\\nFor Azure SQL DB, Entity Framework Core already provides internal database connection resiliency\\na\", \"nd retry logic. But you need to enable the Entity Framework execution strategy for each DbContext\\nco\", \"nnection if you want to have resilient EF Core connections.\\n\\nFor instance, the following code at the\", \" EF Core connection level enables resilient SQL connections that\\nare retried if the connection fails\", \".\\n\\nbuilder.Services.AddDbContext<OrderingContext>(options =>\\n{\\n    options.UseSqlServer(builder.Conf\", \"iguration[\\\"ConnectionString\\\"],\\n        sqlServerOptionsAction: sqlOptions =>\\n        {\\n            s\", \"qlOptions.EnableRetryOnFailure(\\n            maxRetryCount: 5,\\n\\n74\\n\\nCHAPTER 7 | Working with Data in \", \"ASP.NET Core Apps\\n\\n\\f            maxRetryDelay: TimeSpan.FromSeconds(30),\\n            errorNumbersToA\", \"dd: null);\\n        }\\n    );\\n});\\n\\nExecution strategies and explicit transactions using BeginTransacti\", \"on and multiple\\nDbContexts\\n\\nWhen retries are enabled in EF Core connections, each operation you perf\", \"orm using EF Core becomes\\nits own retryable operation. Each query and each call to SaveChangesAsync \", \"will be retried as a unit if a\\ntransient failure occurs.\\n\\nHowever, if your code initiates a transact\", \"ion using BeginTransaction, you are defining your own group\\nof operations that need to be treated as\", \" a unit; everything inside the transaction has to be rolled back\\nif a failure occurs. You will see a\", \"n exception like the following if you attempt to execute that\\ntransaction when using an EF execution\", \" strategy (retry policy) and you include several\\nSaveChangesAsync from multiple DbContexts in it.\\n\\nS\", \"ystem.InvalidOperationException: The configured execution strategy\\nSqlServerRetryingExecutionStrateg\", \"y does not support user initiated transactions. Use the execution\\nstrategy returned by DbContext.Dat\", \"abase.CreateExecutionStrategy() to execute all the operations in\\nthe transaction as a retryable unit\", \".\\n\\nThe solution is to manually invoke the EF execution strategy with a delegate representing everyth\", \"ing\\nthat needs to be executed. If a transient failure occurs, the execution strategy will invoke the\", \" delegate\\nagain. The following code shows how to implement this approach:\\n\\n// Use of an EF Core resi\", \"liency strategy when using multiple DbContexts\\n// within an explicit transaction\\n// See:\\n// https://\", \"learn.microsoft.com/ef/core/miscellaneous/connection-resiliency\\nvar strategy = _catalogContext.Datab\", \"ase.CreateExecutionStrategy();\\nawait strategy.ExecuteAsync(async () =>\\n{\\n  // Achieving atomicity be\", \"tween original Catalog database operation and the\\n  // IntegrationEventLog thanks to a local transac\", \"tion\\n  using (var transaction = _catalogContext.Database.BeginTransaction())\\n  {\\n    _catalogContext\", \".CatalogItems.Update(catalogItem);\\n    await _catalogContext.SaveChangesAsync();\\n\\n    // Save to Eve\", \"ntLog only if product price changed\\n    if (raiseProductPriceChangedEvent)\\n    {\\n      await _integr\", \"ationEventLogService.SaveEventAsync(priceChangedEvent);\\n      transaction.Commit();\\n    }\\n  }\\n});\\n\\nT\", \"he first DbContext is the _catalogContext and the second DbContext is within the\\n_integrationEventLo\", \"gService object. Finally, the Commit action would be performed multiple\\nDbContexts and using an EF E\", \"xecution Strategy.\\n\\n75\\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\fReferences \\u2013 Entity Fra\", \"mework Core\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nEF Core Docs https://learn.microsoft.com/ef/\\n\\nEF Core: Related Data https://le\", \"arn.microsoft.com/ef/core/querying/related-data\\n\\nAvoid Lazy Loading Entities in ASPNET Applications \", \"https://ardalis.com/avoid-lazy-\\nloading-entities-in-asp-net-applications\\n\\nEF Core or micro-ORM?\\n\\nWhi\", \"le EF Core is a great choice for managing persistence, and for the most part encapsulates\\ndatabase d\", \"etails from application developers, it isn\\u2019t the only choice. Another popular open-source\\nalternativ\", \"e is Dapper, a so-called micro-ORM. A micro-ORM is a lightweight, less full-featured tool for\\nmappin\", \"g objects to data structures. In the case of Dapper, its design goals focus on performance,\\nrather t\", \"han fully encapsulating the underlying queries it uses to retrieve and update data. Because it\\ndoesn\", \"\\u2019t abstract SQL from the developer, Dapper is \\u201ccloser to the metal\\u201d and lets developers write the\\nex\", \"act queries they want to use for a given data access operation.\\n\\nEF Core has two significant feature\", \"s it provides which separate it from Dapper but also add to its\\nperformance overhead. The first is t\", \"he translation from LINQ expressions into SQL. These translations\\nare cached, but even so there is o\", \"verhead in performing them the first time. The second is change\\ntracking on entities (so that effici\", \"ent update statements can be generated). This behavior can be\\nturned off for specific queries by usi\", \"ng the AsNoTracking extension. EF Core also generates SQL\\nqueries that usually are very efficient an\", \"d in any case perfectly acceptable from a performance\\nstandpoint, but if you need fine control over \", \"the precise query to be executed, you can pass in custom\\nSQL (or execute a stored procedure) using E\", \"F Core, too. In this case, Dapper still outperforms EF Core,\\nbut only very slightly. Current perform\", \"ance benchmark data for a variety of data access methods can\\nbe found on the Dapper site.\\n\\nTo see ho\", \"w the syntax for Dapper varies from EF Core, consider these two versions of the same\\nmethod for retr\", \"ieving a list of items:\\n\\n// EF Core\\nprivate readonly CatalogContext _context;\\npublic async Task<IEnu\", \"merable<CatalogType>> GetCatalogTypes()\\n{\\n  return await _context.CatalogTypes.ToListAsync();\\n}\\n\\n// \", \"Dapper\\nprivate readonly SqlConnection _conn;\\npublic async Task<IEnumerable<CatalogType>> GetCatalogT\", \"ypesWithDapper()\\n{\\n  return await _conn.QueryAsync<CatalogType>(\\\"SELECT * FROM CatalogType\\\");\\n}\\n\\nIf \", \"you need to build more complex object graphs with Dapper, you need to write the associated\\nqueries y\", \"ourself (as opposed to adding an Include as you would in EF Core). This functionality is\\nsupported t\", \"hrough various syntaxes, including a feature called Multi Mapping that lets you map\\nindividual rows \", \"to multiple mapped objects. For example, given a class Post with a property Owner of\\ntype User, the \", \"following SQL would return all of the necessary data:\\n\\n76\\n\\nCHAPTER 7 | Working with Data in ASP.NET \", \"Core Apps\\n\\n\\fselect * from #Posts p\\nleft join #Users u on u.Id = p.OwnerId\\nOrder by p.Id\\n\\nEach return\", \"ed row includes both User and Post data. Since the User data should be attached to the\\nPost data via\", \" its Owner property, the following function is used:\\n\\n(post, user) => { post.Owner = user; return po\", \"st; }\\n\\nThe full code listing to return a collection of posts with their Owner property populated wit\", \"h the\\nassociated user data would be:\\n\\nvar sql = @\\\"select * from #Posts p\\nleft join #Users u on u.Id \", \"= p.OwnerId\\nOrder by p.Id\\\";\\nvar data = connection.Query<Post, User, Post>(sql,\\n(post, user) => { pos\", \"t.Owner = user; return post;});\\n\\nBecause it offers less encapsulation, Dapper requires developers kn\", \"ow more about how their data is\\nstored, how to query it efficiently, and write more code to fetch it\", \". When the model changes, instead\\nof simply creating a new migration (another EF Core feature), and/\", \"or updating mapping information\\nin one place in a DbContext, every query that is impacted must be up\", \"dated. These queries have no\\ncompile-time guarantees, so they may break at run time in response to c\", \"hanges to the model or\\ndatabase, making errors more difficult to detect quickly. In exchange for the\", \"se tradeoffs, Dapper\\noffers extremely fast performance.\\n\\nFor most applications, and most parts of al\", \"most all applications, EF Core offers acceptable\\nperformance. Thus, its developer productivity benef\", \"its are likely to outweigh its performance\\noverhead. For queries that can benefit from caching, the \", \"actual query may only be executed a tiny\\npercentage of the time, making relatively small query perfo\", \"rmance differences moot.\\n\\nSQL or NoSQL\\n\\nTraditionally, relational databases like SQL Server have dom\", \"inated the marketplace for persistent data\\nstorage, but they are not the only solution available. No\", \"SQL databases like MongoDB offer a different\\napproach to storing objects. Rather than mapping object\", \"s to tables and rows, another option is to\\nserialize the entire object graph, and store the result. \", \"The benefits of this approach, at least initially,\\nare simplicity and performance. It\\u2019s simpler to s\", \"tore a single serialized object with a key than to\\ndecompose the object into many tables with relati\", \"onships and update rows that may have changed\\nsince the object was last retrieved from the database.\", \" Likewise, fetching and deserializing a single\\nobject from a key-based store is typically much faste\", \"r and easier than complex joins or multiple\\ndatabase queries required to fully compose the same obje\", \"ct from a relational database. The lack of\\nlocks or transactions or a fixed schema also makes NoSQL \", \"databases amenable to scaling across many\\nmachines, supporting very large datasets.\\n\\nOn the other ha\", \"nd, NoSQL databases (as they are typically called) have their drawbacks. Relational\\ndatabases use no\", \"rmalization to enforce consistency and avoid duplication of data. This approach\\nreduces the total si\", \"ze of the database and ensures that updates to shared data are available\\nimmediately throughout the \", \"database. In a relational database, an Address table might reference a\\n\\n77\\n\\nCHAPTER 7 | Working with\", \" Data in ASP.NET Core Apps\\n\\n\\fCountry table by ID, such that if the name of a country/region were cha\", \"nged, the address records\\nwould benefit from the update without themselves having to be updated. How\", \"ever, in a NoSQL\\ndatabase, Address, and its associated Country might be serialized as part of many s\", \"tored objects. An\\nupdate to a country/region name would require all such objects to be updated, rath\", \"er than a single\\nrow. Relational databases can also ensure relational integrity by enforcing rules l\", \"ike foreign keys.\\nNoSQL databases typically do not offer such constraints on their data.\\n\\nAnother co\", \"mplexity NoSQL databases must deal with is versioning. When an object\\u2019s properties\\nchange, it may no\", \"t be able to be deserialized from past versions that were stored. Thus, all existing\\nobjects that ha\", \"ve a serialized (previous) version of the object must be updated to conform to its new\\nschema. This \", \"approach is not conceptually different from a relational database, where schema\\nchanges sometimes re\", \"quire update scripts or mapping updates. However, the number of entries that\\nmust be modified is oft\", \"en much greater in the NoSQL approach, because there is more duplication of\\ndata.\\n\\nIt\\u2019s possible in \", \"NoSQL databases to store multiple versions of objects, something fixed schema\\nrelational databases t\", \"ypically do not support. However, in this case, your application code will need to\\naccount for the e\", \"xistence of previous versions of objects, adding additional complexity.\\n\\nNoSQL databases typically d\", \"o not enforce ACID, which means they have both performance and\\nscalability benefits over relational \", \"databases. They\\u2019re well suited to extremely large datasets and\\nobjects that are not well suited to s\", \"torage in normalized table structures. There is no reason why a\\nsingle application cannot take advan\", \"tage of both relational and NoSQL databases, using each where it\\nis best suited.\\n\\nAzure Cosmos DB\\n\\nA\", \"zure Cosmos DB is a fully managed NoSQL database service that offers cloud-based schema-free\\ndata st\", \"orage. Azure Cosmos DB is built for fast and predictable performance, high availability, elastic\\nsca\", \"ling, and global distribution. Despite being a NoSQL database, developers can use rich and familiar\\n\", \"SQL query capabilities on JSON data. All resources in Azure Cosmos DB are stored as JSON\\ndocuments. \", \"Resources are managed as items, which are documents containing metadata, and feeds,\\nwhich are collec\", \"tions of items. Figure 8-2 shows the relationship between different Azure Cosmos DB\\nresources.\\n\\n78\\n\\n\", \"CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\fFigure 8-2. Azure Cosmos DB resource organizati\", \"on.\\n\\nThe Azure Cosmos DB query language is a simple yet powerful interface for querying JSON\\ndocumen\", \"ts. The language supports a subset of ANSI SQL grammar and adds deep integration of\\nJavaScript objec\", \"t, arrays, object construction, and function invocation.\\n\\nReferences \\u2013 Azure Cosmos DB\\n\\n\\u2022\\n\\nAzure Cos\", \"mos DB Introduction https://learn.microsoft.com/azure/cosmos-db/introduction\\n\\nOther persistence opti\", \"ons\\n\\nIn addition to relational and NoSQL storage options, ASP.NET Core applications can use Azure\\nSt\", \"orage to store various data formats and files in a cloud-based, scalable fashion. Azure Storage is\\nm\", \"assively scalable, so you can start out storing small amounts of data and scale up to storing\\nhundre\", \"ds or terabytes if your application requires it. Azure Storage supports four kinds of data:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\", \"\\n\\n79\\n\\nBlob Storage for unstructured text or binary storage, also referred to as object storage.\\n\\nTab\", \"le Storage for structured datasets, accessible via row keys.\\n\\nQueue Storage for reliable queue-based\", \" messaging.\\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\f\\u2022\\n\\nFile Storage for shared file ac\", \"cess between Azure virtual machines and on-premises\\napplications.\\n\\nReferences \\u2013 Azure Storage\\n\\n\\u2022\\n\\nAz\", \"ure Storage Introduction https://learn.microsoft.com/azure/storage/common/storage-\\nintroduction\\n\\nCac\", \"hing\\n\\nIn web applications, each web request should be completed in the shortest time possible. One w\", \"ay to\\nachieve this functionality is to limit the number of external calls the server must make to co\", \"mplete the\\nrequest. Caching involves storing a copy of data on the server (or another data store tha\", \"t is more\\neasily queried than the source of the data). Web applications, and especially non-SPA trad\", \"itional web\\napplications, need to build the entire user interface with every request. This approach \", \"frequently\\ninvolves making many of the same database queries repeatedly from one user request to the\", \" next. In\\nmost cases, this data changes rarely, so there is little reason to constantly request it f\", \"rom the\\ndatabase. ASP.NET Core supports response caching, for caching entire pages, and data caching\", \", which\\nsupports more granular caching behavior.\\n\\nWhen implementing caching, it\\u2019s important to keep \", \"in mind separation of concerns. Avoid\\nimplementing caching logic in your data access logic, or in yo\", \"ur user interface. Instead, encapsulate\\ncaching in its own classes, and use configuration to manage \", \"its behavior. This approach follows the\\nOpen/Closed and Single Responsibility principles, and will m\", \"ake it easier for you to manage how you\\nuse caching in your application as it grows.\\n\\nASP.NET Core r\", \"esponse caching\\n\\nASP.NET Core supports two levels of response caching. The first level does not cach\", \"e anything on the\\nserver, but adds HTTP headers that instruct clients and proxy servers to cache res\", \"ponses. This\\nfunctionality is implemented by adding the ResponseCache attribute to individual contro\", \"llers or\\nactions:\\n\\n[ResponseCache(Duration = 60)]\\npublic IActionResult Contact()\\n{\\n  ViewData[\\\"Messa\", \"ge\\\"] = \\\"Your contact page.\\\";\\n  return View();\\n}\\n\\nThe previous example will result in the following h\", \"eader being added to the response, instructing\\nclients to cache the result for up to 60 seconds.\\n\\nCa\", \"che-Control: public,max-age=60\\n\\nIn order to add server-side in-memory caching to the application, yo\", \"u must reference the\\nMicrosoft.AspNetCore.ResponseCaching NuGet package, and then add the Response C\", \"aching\\nmiddleware. This middleware is configured with services and middleware during app startup:\\n\\n8\", \"0\\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\fbuilder.Services.AddResponseCaching();\\n\\n// o\", \"ther code omitted, including building the app\\n\\napp.UseResponseCaching();\\n\\nThe Response Caching Middl\", \"eware will automatically cache responses based on a set of conditions,\\nwhich you can customize. By d\", \"efault, only 200 (OK) responses requested via GET or HEAD methods\\nare cached. In addition, requests \", \"must have a response with a Cache-Control: public header, and\\ncannot include headers for Authorizati\", \"on or Set-Cookie. See a complete list of the caching conditions\\nused by the response caching middlew\", \"are.\\n\\nData caching\\n\\nRather than (or in addition to) caching full web responses, you can cache the re\", \"sults of individual data\\nqueries. For this functionality, you can use in memory caching on the web s\", \"erver, or use a distributed\\ncache. This section will demonstrate how to implement in memory caching.\", \"\\n\\nAdd support for memory (or distributed) caching with the following code:\\n\\nbuilder.Services.AddMemo\", \"ryCache();\\nbuilder.Services.AddMvc();\\n\\nBe sure to add the Microsoft.Extensions.Caching.Memory NuGet \", \"package as well.\\n\\nOnce you\\u2019ve added the service, you request IMemoryCache via dependency injection w\", \"herever you\\nneed to access the cache. In this example, the CachedCatalogService is using the Proxy (\", \"or Decorator)\\ndesign pattern, by providing an alternative implementation of ICatalogService that con\", \"trols access to\\n(or adds behavior to) the underlying CatalogService implementation.\\n\\npublic class Ca\", \"chedCatalogService : ICatalogService\\n{\\n  private readonly IMemoryCache _cache;\\n  private readonly Ca\", \"talogService _catalogService;\\n  private static readonly string _brandsKey = \\\"brands\\\";\\n  private stat\", \"ic readonly string _typesKey = \\\"types\\\";\\n  private static readonly TimeSpan _defaultCacheDuration = T\", \"imeSpan.FromSeconds(30);\\n\\n  public CachedCatalogService(\\n      IMemoryCache cache,\\n      CatalogServ\", \"ice catalogService)\\n  {\\n    _cache = cache;\\n    _catalogService = catalogService;\\n  }\\n\\n  public asyn\", \"c Task<IEnumerable<SelectListItem>> GetBrands()\\n  {\\n    return await _cache.GetOrCreateAsync(_brands\", \"Key, async entry =>\\n    {\\n      entry.SlidingExpiration = _defaultCacheDuration;\\n      return await \", \"_catalogService.GetBrands();\\n    });\\n  }\\n\\n  public async Task<Catalog> GetCatalogItems(int pageIndex\", \", int itemsPage, int? brandID,\\n\\n81\\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\fint? typeId\", \")\\n  {\\n    string cacheKey = $\\\"items-{pageIndex}-{itemsPage}-{brandID}-{typeId}\\\";\\n    return await _c\", \"ache.GetOrCreateAsync(cacheKey, async entry =>\\n      {\\n        entry.SlidingExpiration = _defaultCac\", \"heDuration;\\n        return await _catalogService.GetCatalogItems(pageIndex, itemsPage, brandID,\\ntype\", \"Id);\\n      });\\n  }\\n\\n  public async Task<IEnumerable<SelectListItem>> GetTypes()\\n  {\\n    return await\", \" _cache.GetOrCreateAsync(_typesKey, async entry =>\\n    {\\n      entry.SlidingExpiration = _defaultCac\", \"heDuration;\\n      return await _catalogService.GetTypes();\\n    });\\n  }\\n}\\n\\nTo configure the applicati\", \"on to use the cached version of the service, but still allow the service to get\\nthe instance of Cata\", \"logService it needs in its constructor, you would add the following lines in\\nProgram.cs:\\n\\nbuilder.Se\", \"rvices.AddMemoryCache();\\nbuilder.Services.AddScoped<ICatalogService, CachedCatalogService>();\\nbuilde\", \"r.Services.AddScoped<CatalogService>();\\n\\nWith this code in place, the database calls to fetch the ca\", \"talog data will only be made once per\\nminute, rather than on every request. Depending on the traffic\", \" to the site, this can have a significant\\nimpact on the number of queries made to the database, and \", \"the average page load time for the home\\npage that currently depends on all three of the queries expo\", \"sed by this service.\\n\\nAn issue that arises when caching is implemented is stale data \\u2013 that is, data\", \" that has changed at the\\nsource but an out-of-date version remains in the cache. A simple way to mit\", \"igate this issue is to use\\nsmall cache durations, since for a busy application there is a limited ad\", \"ditional benefit to extending\\nthe length data is cached. For example, consider a page that makes a s\", \"ingle database query, and is\\nrequested 10 times per second. If this page is cached for one minute, i\", \"t will result in the number of\\ndatabase queries made per minute to drop from 600 to 1, a reduction o\", \"f 99.8%. If instead the cache\\nduration was made one hour, the overall reduction would be 99.997%, bu\", \"t now the likelihood and\\npotential age of stale data are both increased dramatically.\\n\\nAnother appro\", \"ach is to proactively remove cache entries when the data they contain is updated. Any\\nindividual ent\", \"ry can be removed if its key is known:\\n\\n_cache.Remove(cacheKey);\\n\\nIf your application exposes functi\", \"onality for updating entries that it caches, you can remove the\\ncorresponding cache entries in your \", \"code that performs the updates. Sometimes there may be many\\ndifferent entries that depend on a parti\", \"cular set of data. In that case, it can be useful to create\\ndependencies between cache entries, by u\", \"sing a CancellationChangeToken. With a\\nCancellationChangeToken, you can expire multiple cache entrie\", \"s at once by canceling the token.\\n\\n82\\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\f// confi\", \"gure CancellationToken and add entry to cache\\nvar cts = new CancellationTokenSource();\\n_cache.Set(\\\"c\", \"ts\\\", cts);\\n_cache.Set(cacheKey, itemToCache, new CancellationChangeToken(cts.Token));\\n\\n// elsewhere,\", \" expire the cache by cancelling the token\\\\\\n_cache.Get<CancellationTokenSource>(\\\"cts\\\").Cancel();\\n\\nCac\", \"hing can dramatically improve the performance of web pages that repeatedly request the same\\nvalues f\", \"rom the database. Be sure to measure data access and page performance before applying\\ncaching, and o\", \"nly apply caching where you see a need for improvement. Caching consumes web\\nserver memory resources\", \" and increases the complexity of the application, so it\\u2019s important you don\\u2019t\\nprematurely optimize u\", \"sing this technique.\\n\\nGetting data to Blazor WebAssembly apps\\n\\nIf you\\u2019re building apps that use Blaz\", \"or Server, you can use Entity Framework and other direct data\\naccess technologies as they\\u2019ve been di\", \"scussed thus far in this chapter. However, when building Blazor\\nWebAssembly apps, like other SPA fra\", \"meworks, you will need a different strategy for data access.\\nTypically, these applications access da\", \"ta and interact with the server through web API endpoints.\\n\\nIf the data or operations being performe\", \"d are sensitive, be sure to review the section on security in\\nthe previous chapter and protect your \", \"APIs against unauthorized access.\\n\\nYou\\u2019ll find an example of a Blazor WebAssembly app in the eShopOn\", \"Web reference application, in the\\nBlazorAdmin project. This project is hosted within the eShopOnWeb \", \"Web project, and allows users in\\nthe Administrators group to manage the items in the store. You can \", \"see a screenshot of the\\napplication in Figure 8-3.\\n\\nFigure 8-3. eShopOnWeb Catalog Admin Screenshot.\", \"\\n\\n83\\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\fWhen fetching data from web APIs within a\", \" Blazor WebAssembly app, you just use an instance of\\nHttpClient as you would in any .NET application\", \". The basic steps involved are to create the request to\\nsend (if necessary, usually for POST or PUT \", \"requests), await the request itself, verify the status code,\\nand deserialize the response. If you\\u2019re\", \" going to make many requests to a given set of APIs, it\\u2019s a good\\nidea to encapsulate your APIs and c\", \"onfigure the HttpClient base address centrally. This way, if you\\nneed to adjust any of these setting\", \"s between environments, you can make the changes in just one\\nplace. You should add support for this \", \"service in your Program.Main:\\n\\nbuilder.Services.AddScoped(sp => new HttpClient\\n  {\\n    BaseAddress =\", \" new Uri(builder.HostEnvironment.BaseAddress)\\n  });\\n\\nIf you need to access services securely, you sh\", \"ould access a secure token and configure the HttpClient\\nto pass this token as an Authentication head\", \"er with every request:\\n\\n_httpClient.DefaultRequestHeaders.Authorization =\\n  new AuthenticationHeader\", \"Value(\\\"Bearer\\\", token);\\n\\nThis activity can be done from any component that has the HttpClient inject\", \"ed into it, provided that\\nHttpClient wasn\\u2019t added to the application\\u2019s services with a Transient lif\", \"etime. Every reference to\\nHttpClient in the application references the same instance, so changes to \", \"it in one component flow\\nthrough the entire application. A good place to perform this authentication\", \" check (followed by\\nspecifying the token) is in a shared component like the main navigation for the \", \"site. Learn more about\\nthis approach in the BlazorAdmin project in the eShopOnWeb reference applicat\", \"ion.\\n\\nOne benefit of Blazor WebAssembly over traditional JavaScript SPAs is that you don\\u2019t need to k\", \"eep\\ncopies of your data transfer objects(DTOs) synchronized. Your Blazor WebAssembly project and you\", \"r\\nweb API project can both share the same DTOs in a common shared project. This approach eliminates\\n\", \"some of the friction involved in developing SPAs.\\n\\nTo quickly get data from an API endpoint, you can\", \" use the built-in helper method, GetFromJsonAsync.\\nThere are similar methods for POST, PUT, etc. The\", \" following shows how to get a CatalogItem from an\\nAPI endpoint using a configured HttpClient in a Bl\", \"azor WebAssembly app:\\n\\nvar item = await _httpClient.GetFromJsonAsync<CatalogItem>($\\\"catalog-items/{i\", \"d}\\\");\\n\\nOnce you have the data you need, you\\u2019ll typically track changes locally. When you want to mak\", \"e\\nupdates to the backend data store, you\\u2019ll call additional web APIs for this purpose.\\n\\nReferences \\u2013\", \" Blazor Data\\n\\n\\u2022\\n\\nCall a web API from ASP.NET Core Blazor https://learn.microsoft.com/aspnet/core/bla\", \"zor/call-\\nweb-api\\n\\n84\\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps\\n\\n\\fCHAPTER  8\\n\\nTest ASP.NET\", \" Core MVC\\napps\\n\\n\\u201cIf you don\\u2019t like unit testing your product, most likely your customers won\\u2019t like \", \"to test it, either.\\u201d _-\\nAnonymous-\\n\\nSoftware of any complexity can fail in unexpected ways in respon\", \"se to changes. Thus, testing after\\nmaking changes is required for all but the most trivial (or least\", \" critical) applications. Manual testing is\\nthe slowest, least reliable, most expensive way to test s\", \"oftware. Unfortunately, if applications aren\\u2019t\\ndesigned to be testable, it can be the only means of \", \"testing available. Applications written to follow\\nthe architectural principles laid out in chapter 4\", \" should be largely unit testable. ASP.NET Core\\napplications support automated integration and functi\", \"onal testing.\\n\\nKinds of automated tests\\n\\nThere are many kinds of automated tests for software applic\", \"ations. The simplest, lowest level test is\\nthe unit test. At a slightly higher level, there are inte\", \"gration tests and functional tests. Other kinds of\\ntests, such as UI tests, load tests, stress tests\", \", and smoke tests, are beyond the scope of this document.\\n\\nUnit tests\\n\\nA unit test tests a single pa\", \"rt of your application\\u2019s logic. One can further describe it by listing some of\\nthe things that it is\", \"n\\u2019t. A unit test doesn\\u2019t test how your code works with dependencies or\\ninfrastructure \\u2013 that\\u2019s what \", \"integration tests are for. A unit test doesn\\u2019t test the framework your code\\nis written on \\u2013 you shou\", \"ld assume it works or, if you find it doesn\\u2019t, file a bug and code a workaround.\\nA unit test runs co\", \"mpletely in memory and in process. It doesn\\u2019t communicate with the file system, the\\nnetwork, or a da\", \"tabase. Unit tests should only test your code.\\n\\nUnit tests, by virtue of the fact that they test onl\", \"y a single unit of your code, with no external\\ndependencies, should execute extremely fast. Thus, yo\", \"u should be able to run test suites of hundreds\\nof unit tests in a few seconds. Run them frequently,\", \" ideally before every push to a shared source\\ncontrol repository, and certainly with every automated\", \" build on your build server.\\n\\nIntegration tests\\n\\nAlthough it\\u2019s a good idea to encapsulate your code \", \"that interacts with infrastructure like databases\\nand file systems, you will still have some of that\", \" code, and you will probably want to test it.\\n\\n85\\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\fAddition\", \"ally, you should verify that your code\\u2019s layers interact as you expect when your application\\u2019s\\ndepen\", \"dencies are fully resolved. This functionality is the responsibility of integration tests. Integrati\", \"on\\ntests tend to be slower and more difficult to set up than unit tests, because they often depend o\", \"n\\nexternal dependencies and infrastructure. Thus, you should avoid testing things that could be test\", \"ed\\nwith unit tests in integration tests. If you can test a given scenario with a unit test, you shou\", \"ld test it\\nwith a unit test. If you can\\u2019t, then consider using an integration test.\\n\\nIntegration tes\", \"ts will often have more complex setup and teardown procedures than unit tests. For\\nexample, an integ\", \"ration test that goes against an actual database will need a way to return the\\ndatabase to a known s\", \"tate before each test run. As new tests are added and the production database\\nschema evolves, these \", \"test scripts will tend to grow in size and complexity. In many large systems, it is\\nimpractical to r\", \"un full suites of integration tests on developer workstations before checking in\\nchanges to shared s\", \"ource control. In these cases, integration tests may be run on a build server.\\n\\nFunctional tests\\n\\nIn\", \"tegration tests are written from the perspective of the developer, to verify that some components of\", \"\\nthe system work correctly together. Functional tests are written from the perspective of the user, \", \"and\\nverify the correctness of the system based on its requirements. The following excerpt offers a u\", \"seful\\nanalogy for how to think about functional tests, compared to unit tests:\\n\\n\\u201cMany times the deve\", \"lopment of a system is likened to the building of a house. While this analogy\\nisn\\u2019t quite correct, w\", \"e can extend it for the purposes of understanding the difference between unit\\nand functional tests. \", \"Unit testing is analogous to a building inspector visiting a house\\u2019s construction\\nsite. He is focuse\", \"d on the various internal systems of the house, the foundation, framing, electrical,\\nplumbing, and s\", \"o on. He ensures (tests) that the parts of the house will work correctly and safely, that\\nis, meet t\", \"he building code. Functional tests in this scenario are analogous to the homeowner visiting\\nthis sam\", \"e construction site. He assumes that the internal systems will behave appropriately, that the\\nbuildi\", \"ng inspector is performing his task. The homeowner is focused on what it will be like to live in\\nthi\", \"s house. He is concerned with how the house looks, are the various rooms a comfortable size, does\\nth\", \"e house fit the family\\u2019s needs, are the windows in a good spot to catch the morning sun. The\\nhomeown\", \"er is performing functional tests on the house. He has the user\\u2019s perspective. The building\\ninspecto\", \"r is performing unit tests on the house. He has the builder\\u2019s perspective.\\u201d\\n\\nSource: Unit Testing ve\", \"rsus Functional Tests\\n\\nI\\u2019m fond of saying \\u201cAs developers, we fail in two ways: we build the thing wr\", \"ong, or we build the\\nwrong thing.\\u201d Unit tests ensure you are building the thing right; functional te\", \"sts ensure you are\\nbuilding the right thing.\\n\\nSince functional tests operate at the system level, th\", \"ey may require some degree of UI automation.\\nLike integration tests, they usually work with some kin\", \"d of test infrastructure as well. This activity\\nmakes them slower and more brittle than unit and int\", \"egration tests. You should have only as many\\nfunctional tests as you need to be confident the system\", \" is behaving as users expect.\\n\\nTesting Pyramid\\n\\nMartin Fowler wrote about the testing pyramid, an ex\", \"ample of which is shown in Figure 9-1.\\n\\n86\\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\fFigure 9-1. Tes\", \"ting Pyramid\\n\\nThe different layers of the pyramid, and their relative sizes, represent different kin\", \"ds of tests and how\\nmany you should write for your application. As you can see, the recommendation i\", \"s to have a large\\nbase of unit tests, supported by a smaller layer of integration tests, with an eve\", \"n smaller layer of\\nfunctional tests. Each layer should ideally only have tests in it that cannot be \", \"performed adequately at\\na lower layer. Keep the testing pyramid in mind when you are trying to decid\", \"e which kind of test you\\nneed for a particular scenario.\\n\\nWhat to test\\n\\nA common problem for develop\", \"ers who are inexperienced with writing automated tests is coming up\\nwith what to test. A good starti\", \"ng point is to test conditional logic. Anywhere you have a method with\\nbehavior that changes based o\", \"n a conditional statement (if-else, switch, and so on), you should be\\nable to come up with at least \", \"a couple of tests that confirm the correct behavior for certain conditions.\\nIf your code has error c\", \"onditions, it\\u2019s good to write at least one test for the \\u201chappy path\\u201d through the\\ncode (with no error\", \"s), and at least one test for the \\u201csad path\\u201d (with errors or atypical results) to\\nconfirm your appli\", \"cation behaves as expected in the face of errors. Finally, try to focus on testing\\nthings that can f\", \"ail, rather than focusing on metrics like code coverage. More code coverage is better\\nthan less, gen\", \"erally. However, writing a few more tests of a complex and business-critical method is\\nusually a bet\", \"ter use of time than writing tests for auto-properties just to improve test code coverage\\nmetrics.\\n\\n\", \"87\\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\fOrganizing test projects\\n\\nTest projects can be organize\", \"d however works best for you. It\\u2019s a good idea to separate tests by type\\n(unit test, integration tes\", \"t) and by what they are testing (by project, by namespace). Whether this\\nseparation consists of fold\", \"ers within a single test project, or multiple test projects, is a design decision.\\nOne project is si\", \"mplest, but for large projects with many tests, or in order to more easily run different\\nsets of tes\", \"ts, you might want to have several different test projects. Many teams organize test projects\\nbased \", \"on the project they are testing, which for applications with more than a few projects can result\\nin \", \"a large number of test projects, especially if you still break these down according to what kind of\\n\", \"tests are in each project. A compromise approach is to have one project per kind of test, per\\napplic\", \"ation, with folders inside the test projects to indicate the project (and class) being tested.\\n\\nA co\", \"mmon approach is to organize the application projects under a \\u2018src\\u2019 folder, and the application\\u2019s\\nte\", \"st projects under a parallel \\u2018tests\\u2019 folder. You can create matching solution folders in Visual Stud\", \"io, if\\nyou find this organization useful.\\n\\nFigure 9-2. Test organization in your solution\\n\\nYou can u\", \"se whichever test framework you prefer. The xUnit framework works well and is what all of\\nthe ASP.NE\", \"T Core and EF Core tests are written in. You can add an xUnit test project in Visual Studio\\nusing th\", \"e template shown in Figure 9-3, or from the CLI using dotnet new xunit.\\n\\n88\\n\\nCHAPTER 8 | Test ASP.NE\", \"T Core MVC apps\\n\\n\\fFigure 9-3. Add an xUnit Test Project in Visual Studio\\n\\nTest naming\\n\\nName your tes\", \"ts in a consistent fashion, with names that indicate what each test does. One approach\\nI\\u2019ve had grea\", \"t success with is to name test classes according to the class and method they are testing.\\nThis appr\", \"oach results in many small test classes, but it makes it extremely clear what each test is\\nresponsib\", \"le for. With the test class name set up, to identify the class and method to be tested, the test\\nmet\", \"hod name can be used to specify the behavior being tested. This name should include the\\nexpected beh\", \"avior and any inputs or assumptions that should yield this behavior. Some example test\\nnames:\\n\\n\\u2022\\n\\n\\u2022\\n\", \"\\n\\u2022\\n\\n\\u2022\\n\\nCatalogControllerGetImage.CallsImageServiceWithId\\n\\nCatalogControllerGetImage.LogsWarningGiven\", \"ImageMissingException\\n\\nCatalogControllerGetImage.ReturnsFileResultWithBytesGivenSuccess\\n\\nCatalogCont\", \"rollerGetImage.ReturnsNotFoundResultGivenImageMissingException\\n\\nA variation of this approach ends ea\", \"ch test class name with \\u201cShould\\u201d and modifies the tense slightly:\\n\\n\\u2022\\n\\n\\u2022\\n\\n89\\n\\nCatalogControllerGetIma\", \"geShould.CallImageServiceWithId\\n\\nCatalogControllerGetImageShould.LogWarningGivenImageMissingExceptio\", \"n\\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\fSome teams find the second naming approach clearer, thou\", \"gh slightly more verbose. In any case, try\\nto use a naming convention that provides insight into tes\", \"t behavior, so that when one or more tests\\nfail, it\\u2019s obvious from their names what cases have faile\", \"d. Avoid naming your tests vaguely, such as\\nControllerTests.Test1, as these names offer no value whe\", \"n you see them in test results.\\n\\nIf you follow a naming convention like the one above that produces \", \"many small test classes, it\\u2019s a\\ngood idea to further organize your tests using folders and namespace\", \"s. Figure 9-4 shows one\\napproach to organizing tests by folder within several test projects.\\n\\nFigure\", \" 9-4. Organizing test classes by folder based on class being tested.\\n\\nIf a particular application cl\", \"ass has many methods being tested (and thus many test classes), it may\\nmake sense to place these cla\", \"sses in a folder corresponding to the application class. This organization\\nis no different than how \", \"you might organize files into folders elsewhere. If you have more than three\\n\\n90\\n\\nCHAPTER 8 | Test A\", \"SP.NET Core MVC apps\\n\\n\\for four related files in a folder containing many other files, it\\u2019s often hel\", \"pful to move them into their\\nown subfolder.\\n\\nUnit testing ASP.NET Core apps\\n\\nIn a well-designed ASP.\", \"NET Core application, most of the complexity and business logic will be\\nencapsulated in business ent\", \"ities and a variety of services. The ASP.NET Core MVC app itself, with its\\ncontrollers, filters, vie\", \"wmodels, and views, should require few unit tests. Much of the functionality of a\\ngiven action lies \", \"outside the action method itself. Testing whether routing or global error handling\\nwork correctly ca\", \"nnot be done effectively with a unit test. Likewise, any filters, including model\\nvalidation and aut\", \"hentication and authorization filters, cannot be unit tested with a test targeting a\\ncontroller\\u2019s ac\", \"tion method. Without these sources of behavior, most action methods should be\\ntrivially small, deleg\", \"ating the bulk of their work to services that can be tested independent of the\\ncontroller that uses \", \"them.\\n\\nSometimes you\\u2019ll need to refactor your code in order to unit test it. Frequently this activit\", \"y involves\\nidentifying abstractions and using dependency injection to access the abstraction in the \", \"code you\\u2019d\\nlike to test, rather than coding directly against infrastructure. For example, consider t\", \"his easy action\\nmethod for displaying images:\\n\\n[HttpGet(\\\"[controller]/pic/{id}\\\")]\\npublic IActionResu\", \"lt GetImage(int id)\\n{\\n  var contentRoot = _env.ContentRootPath + \\\"//Pics\\\";\\n  var path = Path.Combine\", \"(contentRoot, id + \\\".png\\\");\\n  Byte[] b = System.IO.File.ReadAllBytes(path);\\n  return File(b, \\\"image/\", \"png\\\");\\n}\\n\\nUnit testing this method is made difficult by its direct dependency on System.IO.File, whi\", \"ch it uses to\\nread from the file system. You can test this behavior to ensure it works as expected, \", \"but doing so with\\nreal files is an integration test. It\\u2019s worth noting you can\\u2019t unit test this meth\", \"od\\u2019s route\\u2014you\\u2019ll see how\\nto do this testing with a functional test shortly.\\n\\nIf you can\\u2019t unit test\", \" the file system behavior directly, and you can\\u2019t test the route, what is there to\\ntest? Well, after\", \" refactoring to make unit testing possible, you may discover some test cases and\\nmissing behavior, s\", \"uch as error handling. What does the method do when a file isn\\u2019t found? What\\nshould it do? In this e\", \"xample, the refactored method looks like this:\\n\\n[HttpGet(\\\"[controller]/pic/{id}\\\")]\\npublic IActionRes\", \"ult GetImage(int id)\\n{\\n  byte[] imageBytes;\\n  try\\n  {\\n    imageBytes = _imageService.GetImageBytesBy\", \"Id(id);\\n  }\\n  catch (CatalogImageMissingException ex)\\n  {\\n    _logger.LogWarning($\\\"No image found fo\", \"r id: {id}\\\");\\n    return NotFound();\\n  }\\n\\n91\\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\f  return File\", \"(imageBytes, \\\"image/png\\\");\\n}\\n\\n_logger and _imageService are both injected as dependencies. Now you c\", \"an test that the same ID that\\nis passed to the action method is passed to _imageService, and that th\", \"e resulting bytes are returned\\nas part of the FileResult. You can also test that error logging is ha\", \"ppening as expected, and that a\\nNotFound result is returned if the image is missing, assuming this b\", \"ehavior is important application\\nbehavior (that is, not just temporary code the developer added to d\", \"iagnose an issue). The actual file\\nlogic has moved into a separate implementation service, and has b\", \"een augmented to return an\\napplication-specific exception for the case of a missing file. You can te\", \"st this implementation\\nindependently, using an integration test.\\n\\nIn most cases, you\\u2019ll want to use \", \"global exception handlers in your controllers, so the amount of logic\\nin them should be minimal and \", \"probably not worth unit testing. Do most of your testing of controller\\nactions using functional test\", \"s and the TestServer class described below.\\n\\nIntegration testing ASP.NET Core apps\\n\\nMost of the inte\", \"gration tests in your ASP.NET Core apps should be testing services and other\\nimplementation types de\", \"fined in your Infrastructure project. For example, you could test that EF Core\\nwas successfully upda\", \"ting and retrieving the data that you expect from your data access classes\\nresiding in the Infrastru\", \"cture project. The best way to test that your ASP.NET Core MVC project is\\nbehaving correctly is with\", \" functional tests that run against your app running in a test host.\\n\\nFunctional testing ASP.NET Core\", \" apps\\n\\nFor ASP.NET Core applications, the TestServer class makes functional tests fairly easy to wri\", \"te. You\\nconfigure a TestServer using a WebHostBuilder (or HostBuilder) directly (as you normally do \", \"for your\\napplication), or with the WebApplicationFactory type (available since version 2.1). Try to \", \"match your\\ntest host to your production host as closely as possible, so your tests exercise behavior\", \" similar to what\\nthe app will do in production. The WebApplicationFactory class is helpful for confi\", \"guring the\\nTestServer\\u2019s ContentRoot, which is used by ASP.NET Core to locate static resource like Vi\", \"ews.\\n\\nYou can create simple functional tests by creating a test class that implements\\nIClassFixture<\", \"WebApplicationFactory<TEntryPoint>>, where TEntryPoint is your web application\\u2019s\\nStartup class. With\", \" this interface in place, your test fixture can create a client using the factory\\u2019s\\nCreateClient met\", \"hod:\\n\\npublic class BasicWebTests : IClassFixture<WebApplicationFactory<Program>>\\n{\\n  protected reado\", \"nly HttpClient _client;\\n\\n  public BasicWebTests(WebApplicationFactory<Program> factory)\\n  {\\n    _cli\", \"ent = factory.CreateClient();\\n  }\\n\\n92\\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\f  // write tests tha\", \"t use _client\\n}\\n\\nTip\\n\\nIf you\\u2019re using minimal API configuration in your Program.cs file, by default \", \"the class will be declared\\ninternal and won\\u2019t be accessible from the test project. You can choose an\", \"y other instance class in your\\nweb project instead, or add this to your Program.cs file:\\n\\n]{custom-s\", \"tyle=Code}`csharp // Make the implicit Program class public so test projects can access it\\npublic pa\", \"rtial class Program { } [`\\n\\nFrequently, you\\u2019ll want to perform some additional configuration of your\", \" site before each test runs,\\nsuch as configuring the application to use an in-memory data store and \", \"then seeding the application\\nwith test data. To achieve this functionality, create your own subclass\", \" of\\nWebApplicationFactory<TEntryPoint> and override its ConfigureWebHost method. The example\\nbelow i\", \"s from the eShopOnWeb FunctionalTests project and is used as part of the tests on the main\\nweb appli\", \"cation.\\n\\nusing Microsoft.AspNetCore.Hosting;\\nusing Microsoft.AspNetCore.Identity;\\nusing Microsoft.As\", \"pNetCore.Mvc.Testing;\\nusing Microsoft.EntityFrameworkCore;\\nusing Microsoft.eShopWeb.Infrastructure.D\", \"ata;\\nusing Microsoft.eShopWeb.Infrastructure.Identity;\\nusing Microsoft.eShopWeb.Web;\\nusing Microsoft\", \".Extensions.DependencyInjection;\\nusing Microsoft.Extensions.Logging;\\nusing System;\\n\\nnamespace Micros\", \"oft.eShopWeb.FunctionalTests.Web;\\npublic class WebTestFixture : WebApplicationFactory<Startup>\\n{\\n  p\", \"rotected override void ConfigureWebHost(IWebHostBuilder builder)\\n  {\\n    builder.UseEnvironment(\\\"Tes\", \"ting\\\");\\n\\n    builder.ConfigureServices(services =>\\n    {\\n      services.AddEntityFrameworkInMemoryDa\", \"tabase();\\n\\n      // Create a new service provider.\\n      var provider = services\\n            .AddEnt\", \"ityFrameworkInMemoryDatabase()\\n            .BuildServiceProvider();\\n\\n      // Add a database context\", \" (ApplicationDbContext) using an in-memory\\n      // database for testing.\\n      services.AddDbContex\", \"t<CatalogContext>(options =>\\n      {\\n        options.UseInMemoryDatabase(\\\"InMemoryDbForTesting\\\");\\n  \", \"      options.UseInternalServiceProvider(provider);\\n      });\\n\\n      services.AddDbContext<AppIdenti\", \"tyDbContext>(options =>\\n      {\\n\\n93\\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\f        options.UseInM\", \"emoryDatabase(\\\"Identity\\\");\\n        options.UseInternalServiceProvider(provider);\\n      });\\n\\n      //\", \" Build the service provider.\\n      var sp = services.BuildServiceProvider();\\n\\n      // Create a scop\", \"e to obtain a reference to the database\\n      // context (ApplicationDbContext).\\n      using (var sc\", \"ope = sp.CreateScope())\\n      {\\n        var scopedServices = scope.ServiceProvider;\\n        var db =\", \" scopedServices.GetRequiredService<CatalogContext>();\\n        var loggerFactory = scopedServices.Get\", \"RequiredService<ILoggerFactory>();\\n\\n        var logger = scopedServices\\n            .GetRequiredServ\", \"ice<ILogger<WebTestFixture>>();\\n\\n        // Ensure the database is created.\\n        db.Database.Ensu\", \"reCreated();\\n\\n        try\\n        {\\n          // Seed the database with test data.\\n          Catalog\", \"ContextSeed.SeedAsync(db, loggerFactory).Wait();\\n\\n          // seed sample user data\\n          var u\", \"serManager =\\nscopedServices.GetRequiredService<UserManager<ApplicationUser>>();\\n          var roleMa\", \"nager = scopedServices.GetRequiredService<RoleManager<IdentityRole>>();\\n          AppIdentityDbConte\", \"xtSeed.SeedAsync(userManager, roleManager).Wait();\\n        }\\n        catch (Exception ex)\\n        {\\n\", \"          logger.LogError(ex, $\\\"An error occurred seeding the \\\" +\\n                    \\\"database with\", \" test messages. Error: {ex.Message}\\\");\\n        }\\n      }\\n    });\\n  }\\n}\\n\\nTests can make use of this c\", \"ustom WebApplicationFactory by using it to create a client and then\\nmaking requests to the applicati\", \"on using this client instance. The application will have data seeded\\nthat can be used as part of the\", \" test\\u2019s assertions. The following test verifies that the home page of the\\neShopOnWeb application loa\", \"ds correctly and includes a product listing that was added to the\\napplication as part of the seed da\", \"ta.\\n\\nusing Microsoft.eShopWeb.FunctionalTests.Web;\\nusing System.Net.Http;\\nusing System.Threading.Tas\", \"ks;\\nusing Xunit;\\n\\nnamespace Microsoft.eShopWeb.FunctionalTests.WebRazorPages;\\n[Collection(\\\"Sequentia\", \"l\\\")]\\npublic class HomePageOnGet : IClassFixture<WebTestFixture>\\n{\\n  public HomePageOnGet(WebTestFixt\", \"ure factory)\\n  {\\n\\n94\\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\f    Client = factory.CreateClient();\\n\", \"  }\\n\\n  public HttpClient Client { get; }\\n\\n  [Fact]\\n  public async Task ReturnsHomePageWithProductLis\", \"ting()\\n  {\\n    // Arrange & Act\\n    var response = await Client.GetAsync(\\\"/\\\");\\n    response.EnsureSu\", \"ccessStatusCode();\\n    var stringResponse = await response.Content.ReadAsStringAsync();\\n\\n    // Asse\", \"rt\\n    Assert.Contains(\\\".NET Bot Black Sweatshirt\\\", stringResponse);\\n  }\\n}\\n\\nThis functional test exe\", \"rcises the full ASP.NET Core MVC / Razor Pages application stack, including all\\nmiddleware, filters,\", \" and binders that may be in place. It verifies that a given route (\\u201c/\\u201d) returns the\\nexpected success\", \" status code and HTML output. It does so without setting up a real web server, and\\navoids much of th\", \"e brittleness that using a real web server for testing can experience (for example,\\nproblems with fi\", \"rewall settings). Functional tests that run against TestServer are usually slower than\\nintegration a\", \"nd unit tests, but are much faster than tests that would run over the network to a test\\nweb server. \", \"Use functional tests to ensure your application\\u2019s front-end stack is working as expected.\\nThese test\", \"s are especially useful when you find duplication in your controllers or pages and you\\naddress the d\", \"uplication by adding filters. Ideally, this refactoring won\\u2019t change the behavior of the\\napplication\", \", and a suite of functional tests will verify this is the case.\\n\\nReferences \\u2013 Test ASP.NET Core MVC \", \"apps\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nTesting in ASP.NET Core\\nhttps://learn.microsoft.com/aspnet/core/testing/\\n\\nUnit Tes\", \"t Naming Convention\\nhttps://ardalis.com/unit-test-naming-convention\\n\\nTesting EF Core\\nhttps://learn.m\", \"icrosoft.com/ef/core/miscellaneous/testing/\\n\\nIntegration tests in ASP.NET Core\\nhttps://learn.microso\", \"ft.com/aspnet/core/test/integration-tests\\n\\n95\\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\\n\\n\\fCHAPTER  9\\n\\n\", \"Development process for\\nAzure\\n\\n\\u201cWith the cloud, individuals and small businesses can snap their fing\", \"ers and instantly set up enterprise-\\nclass services.\\u201d\\n- Roy Stephan\\n\\nVision\\n\\nDevelop well-designed A\", \"SP .NET Core applications the way you like, using Visual Studio or the dotnet\\nCLI and Visual Studio \", \"Code or your editor of choice.\\n\\nDevelopment environment for ASP.NET Core apps\\n\\nDevelopment tools cho\", \"ices: IDE or editor\\n\\nWhether you prefer a full and powerful IDE or a lightweight and agile editor, M\", \"icrosoft has you\\ncovered when developing ASP.NET Core applications.\\n\\nVisual Studio 2022. Visual Stud\", \"io 2022 is the best-in-class IDE for developing applications for\\nASP.NET Core. It offers a host of f\", \"eatures that increase developer productivity. You can use it to\\ndevelop the application, then analyz\", \"e its performance and other characteristics. The integrated\\ndebugger lets you pause code execution a\", \"nd step back and forth through code on the fly as it\\u2019s\\nrunning. Its support for hot reloads allows y\", \"ou to continue working with your app where you left off,\\neven after making code changes, without hav\", \"ing to restart the app. The built-in test runner lets you\\norganize your tests and their results and \", \"can even perform live unit testing while you\\u2019re coding. Using\\nLive Share, you can collaborate in rea\", \"l-time with other developers, sharing your code session\\nseamlessly over the network. And when you\\u2019re\", \" ready, Visual Studio includes everything you need to\\npublish your application to Azure or wherever \", \"you might host it.\\n\\nDownload Visual Studio 2022\\n\\nVisual Studio Code and dotnet CLI (Cross-Platform T\", \"ools for Mac, Linux, and Windows). If you prefer\\na lightweight and cross-platform editor supporting \", \"any development language, you can use Microsoft\\nVisual Studio Code and the dotnet CLI. These product\", \"s provide a simple yet robust experience that\\n\\n96\\n\\nCHAPTER 9 | Development process for Azure\\n\\n\\fstrea\", \"mlines the developer workflow. Additionally, Visual Studio Code supports extensions for C# and\\nweb d\", \"evelopment, providing intellisense and shortcut-tasks within the editor.\\n\\nDownload the .NET SDK\\n\\nDow\", \"nload Visual Studio Code\\n\\nDevelopment workflow for Azure-hosted ASP.NET\\nCore apps\\n\\nThe application d\", \"evelopment lifecycle starts from each developer\\u2019s machine, coding the app using\\ntheir preferred lang\", \"uage and testing it locally. Developers may choose their preferred source control\\nsystem and can con\", \"figure Continuous Integration (CI) and/or Continuous Delivery/Deployment (CD)\\nusing a build server o\", \"r based on built-in Azure features.\\n\\nTo get started with developing an ASP.NET Core application usin\", \"g CI/CD, you can use Azure DevOps\\nServices or your organization\\u2019s own Team Foundation Server (TFS). \", \"GitHub Actions provide another\\noption for easily building and deploying apps to Azure, for apps whos\", \"e code is hosted on GitHub.\\n\\nInitial setup\\n\\nTo create a release pipeline for your app, you need to h\", \"ave your application code in source control.\\nSet up a local repository and connect it to a remote re\", \"pository in a team project. Follow these\\ninstructions:\\n\\n\\u2022\\n\\n\\u2022\\n\\nShare your code with Git and Visual St\", \"udio or\\n\\nShare your code with TFVC and Visual Studio\\n\\nCreate an Azure App Service where you\\u2019ll deplo\", \"y your application. Create a Web App by going to the\\nApp Services blade on the Azure portal. Click +\", \"Add, select the Web App template, click Create, and\\nprovide a name and other details. The web app wi\", \"ll be accessible from {name}.azurewebsites.net.\\n\\n97\\n\\nCHAPTER 9 | Development process for Azure\\n\\n\\fFig\", \"ure 10-1. Creating a new Azure App Service Web App in the Azure Portal.\\n\\nYour CI build process will \", \"perform an automated build whenever new code is committed to the\\nproject\\u2019s source control repository\", \". This process gives you immediate feedback that the code builds\\n(and, ideally, passes automated tes\", \"ts) and can potentially be deployed. This CI build will produce a\\nweb deploy package artifact and pu\", \"blish it for consumption by your CD process.\\n\\nDefine your CI build process\\n\\nBe sure to enable contin\", \"uous integration so the system will queue a build whenever someone on your\\nteam commits new code. Te\", \"st the build and verify that it is producing a web deploy package as one of\\nits artifacts.\\n\\nWhen a b\", \"uild succeeds, your CD process will deploy the results of your CI build to your Azure web\\napp. To co\", \"nfigure this step, you create and configure a Release, which will deploy to your Azure App\\nService.\\n\", \"\\nDeploy an Azure web app\\n\\nOnce your CI/CD pipeline is configured, you can easily make updates to you\", \"r web app and commit\\nthem to source control to have them deployed.\\n\\nWorkflow for developing Azure-ho\", \"sted ASP.NET Core applications\\n\\nOnce you have configured your Azure account and your CI/CD process, \", \"developing Azure-hosted\\nASP.NET Core applications is simple. The following are the basic steps you u\", \"sually take when building\\nan ASP.NET Core app, hosted in Azure App Service as a Web App, as illustra\", \"ted in Figure 10-2.\\n\\n98\\n\\nCHAPTER 9 | Development process for Azure\\n\\n\\fFigure 10-2. Step-by-step workf\", \"low for building ASP.NET Core apps and hosting them in Azure\\n\\nStep 1. Local dev environment inner lo\", \"op\\n\\nDeveloping your ASP.NET Core application for deployment to Azure is no different from developing\", \"\\nyour application otherwise. Use the local development environment you\\u2019re comfortable with, whether\\n\", \"that\\u2019s Visual Studio 2019 or the dotnet CLI and Visual Studio Code or your preferred editor. You can\", \"\\nwrite code, run and debug your changes, run automated tests, and make local commits to source\\ncontr\", \"ol until you\\u2019re ready to push your changes to your shared source control repository.\\n\\nStep 2. Applic\", \"ation code repository\\n\\nWhenever you\\u2019re ready to share your code with your team, you should push your\", \" changes from your\\nlocal source repository to your team\\u2019s shared source repository. If you\\u2019ve been w\", \"orking in a custom\\nbranch, this step usually involves merging your code into a shared branch (perhap\", \"s by means of a pull\\nrequest).\\n\\nStep 3. Build Server: Continuous integration. build, test, package\\n\\n\", \"A new build is triggered on the build server whenever a new commit is made to the shared\\napplication\", \" code repository. As part of the CI process, this build should fully compile the application\\nand run\", \" automated tests to confirm everything is working as expected. The end result of the CI\\nprocess shou\", \"ld be a packaged version of the web app, ready for deployment.\\n\\nStep 4. Build Server: Continuous del\", \"ivery\\n\\nOnce a build has succeeded, the CD process will pick up the build artifacts produced. This pr\", \"ocess will\\ninclude a web deploy package. The build server will deploy this package to Azure App Serv\", \"ice,\\n\\n99\\n\\nCHAPTER 9 | Development process for Azure\\n\\n\\freplacing any existing service with the newly \", \"created one. Typically this step targets a staging\\nenvironment, but some applications deploy directl\", \"y to production through a CD process.\\n\\nStep 5. Azure App Service Web App\\n\\nOnce deployed, the ASP.NET\", \" Core application runs within the context of an Azure App Service Web\\nApp. This Web App can be monit\", \"ored and further configured using the Azure Portal.\\n\\nStep 6. Production monitoring and diagnostics\\n\\n\", \"While the Web App is running, you can monitor the health of the application and collect diagnostics\\n\", \"and user behavior data. Application Insights is included in Visual Studio, and offers automatic\\ninst\", \"rumentation for ASP.NET apps. It can provide you with information on usage, exceptions, requests,\\npe\", \"rformance, and logs.\\n\\nReferences\\n\\nBuild and Deploy Your ASP.NET Core App to Azure\\nhttps://learn.micr\", \"osoft.com/azure/devops/build-release/apps/aspnet/build-aspnet-core\\n\\n100\\n\\nCHAPTER 9 | Development pro\", \"cess for Azure\\n\\n\\fCHAPTER  10\\n\\nAzure hosting\\nrecommendations for\\nASP.NET Core web apps\\n\\n\\u201cLine-of-busi\", \"ness leaders everywhere are bypassing IT departments to get applications from the cloud\\n(also known \", \"as SaaS) and paying for them like they would a magazine subscription. And when the\\nservice is no lon\", \"ger required, they can cancel the subscription with no equipment left unused in the\\ncorner.\\u201d\\n- Daryl\", \" Plummer, Gartner analyst\\n\\nWhatever your application\\u2019s needs and architecture, Microsoft Azure can s\", \"upport it. Your hosting\\nneeds can be as simple as a static website or a sophisticated application ma\", \"de up of dozens of\\nservices. For ASP.NET Core monolithic web applications and supporting services, t\", \"here are several\\nwell-known configurations that are recommended. The recommendations on this article\", \" are grouped\\nbased on the kind of resource to be hosted, whether full applications, individual proce\", \"sses, or data.\\n\\nWeb applications\\n\\nWeb applications can be hosted with:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nApp Service Web App\", \"s\\n\\nContainers (several options)\\n\\nVirtual Machines (VMs)\\n\\nOf these, App Service Web Apps is the recom\", \"mended approach for most scenarios, including simple\\ncontainer-based apps. For microservice architec\", \"tures, consider a container-based approach. If you\\nneed more control over the machines running your \", \"application, consider Azure Virtual Machines.\\n\\nApp Service Web Apps\\n\\nApp Service Web Apps offers a f\", \"ully managed platform optimized for hosting web applications. It\\u2019s a\\nplatform as a service (PaaS) of\", \"fering that lets you focus on your business logic, while Azure takes care\\nof the infrastructure need\", \"ed to run and scale the app. Some key features of App Service Web Apps:\\n\\n101\\n\\nCHAPTER 10 | Azure hos\", \"ting recommendations for ASP.NET Core web apps\\n\\n\\f\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nDevOps optimization (continuous inte\", \"gration and delivery, multiple environments, A/B\\ntesting, scripting support).\\n\\nGlobal scale and high\", \" availability.\\n\\nConnections to SaaS platforms and your on-premises data.\\n\\nSecurity and compliance.\\n\\n\", \"Visual Studio integration.\\n\\nAzure App Service is the best choice for most web apps. Deployment and m\", \"anagement are integrated\\ninto the platform, sites can scale quickly to handle high traffic loads, an\", \"d the built-in load balancing\\nand traffic manager provide high availability. You can move existing s\", \"ites to Azure App Service easily\\nwith an online migration tool. You can use an open-source app from \", \"the Web Application Gallery, or\\ncreate a new site using the framework and tools of your choice. The \", \"WebJobs feature makes it easy to\\nadd background job processing to your App Service web app. If you h\", \"ave an existing ASP.NET\\napplication hosted on-premises using a local database, there\\u2019s a clear path \", \"to migrate. You can use\\nApp Service Web App with an Azure SQL Database (or secure access to your on-\", \"premises database\\nserver, if preferred).\\n\\nIn most cases, moving from a locally hosted ASP.NET app to\", \" an App Service Web App is a\\nstraightforward process. Little or no modification should be required o\", \"f the app itself, and it can\\nquickly start to take advantage of the many features that Azure App Ser\", \"vice Web Apps offer.\\n\\n102\\n\\nCHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps\\n\\n\\fIn\", \" addition to apps that are not optimized for the cloud, Azure App Service Web Apps are an excellent\\n\", \"solution for many simple monolithic (non-distributed) applications, such as many ASP.NET Core apps.\\n\", \"In this approach, the architecture is basic and simple to understand and manage:\\n\\nA small number of \", \"resources in a single resource group is typically sufficient to manage such an app.\\nApps that are ty\", \"pically deployed as a single unit, rather than those apps that are made up of many\\nseparate processe\", \"s, are good candidates for this basic architectural approach. Though architecturally\\nsimple, this ap\", \"proach still allows the hosted app to scale both up (more resources per node) and out\\n(more hosted n\", \"odes) to meet any increase in demand. With autoscale, the app can be configured to\\nautomatically adj\", \"ust the number of nodes hosting the app based on demand and average load across\\nnodes.\\n\\nApp Service \", \"Web Apps for Containers\\n\\nIn addition to support for hosting web apps directly, App Service Web Apps \", \"for Containers can be\\nused to run containerized applications on Windows and Linux. Using this servic\", \"e, you can easily\\ndeploy and run containerized applications that can scale with your business. The a\", \"pps have all of the\\nfeatures of App Service Web Apps listed above. In addition, Web Apps for Contain\", \"ers supports\\nstreamlined CI/CD with Docker Hub, Azure Container Registry, and GitHub. You can use Az\", \"ure DevOps\\nto define build and deployment pipelines that publish changes to a registry. These change\", \"s can then\\nbe tested in a staging environment and automatically deployed to production using deploym\", \"ent slots,\\nallowing zero-downtime upgrades. Rolling back to previous versions can be done just as ea\", \"sily.\\n\\nThere are a few scenarios where Web Apps for Containers makes the most sense. If you have exi\", \"sting\\napps that you can containerize, whether in Windows or Linux containers, you can host these eas\", \"ily\\nusing this toolset. Just publish your container and then configure Web Apps for Containers to pu\", \"ll the\\nlatest version of that image from your registry of choice. This is a \\u201clift and shift\\u201d approac\", \"h to migrating\\nfrom classic app hosting models to a cloud-optimized model.\\n\\n103\\n\\nCHAPTER 10 | Azure \", \"hosting recommendations for ASP.NET Core web apps\\n\\n\\fThis approach also works well if your developmen\", \"t team is able to move to a container-based\\ndevelopment process. The \\u201cinner loop\\u201d of developing apps\", \" with containers includes building the app\\nwith containers. Changes made to the code as well as to c\", \"ontainer configuration are pushed to source\\ncontrol, and an automated build is responsible for publi\", \"shing new container images to a registry like\\nDocker Hub or Azure Container Registry. These images a\", \"re then used as the basis for additional\\ndevelopment, as well as for deployments to production, as s\", \"hown in the following diagram:\\n\\n104\\n\\nCHAPTER 10 | Azure hosting recommendations for ASP.NET Core web\", \" apps\\n\\n\\fDeveloping with containers offers many advantages, especially when containers are used in\\npr\", \"oduction. The same container configuration is used to host the app in each environment in which it\\nr\", \"uns, from the local development machine to build and test systems to production. This approach\\ngreat\", \"ly reduces the likelihood of defects resulting from differences in machine configuration or\\nsoftware\", \" versions. Developers can also use whatever tools they\\u2019re most productive with, including the\\noperat\", \"ing system, since containers can run on any OS. In some cases, distributed applications\\ninvolving ma\", \"ny containers may be very resource-intensive to run on a single development machine. In\\nthis scenari\", \"o, it may make sense to upgrade to using Kubernetes and Azure Dev Spaces, covered in\\nthe next sectio\", \"n.\\n\\nAs portions of larger applications are broken up into their own smaller, independent microservic\", \"es,\\nadditional design patterns can be used to improve app behavior. Instead of working directly with\", \"\\nindividual services, an API gateway can simplify access and decouple the client from its back end.\\n\", \"Having separate service back ends for different front ends also allows services to evolve in concert\", \"\\nwith their consumers. Common services can be accessed via a separate sidecar container, which might\", \"\\ninclude common client connectivity libraries using the ambassador pattern.\\n\\n105\\n\\nCHAPTER 10 | Azure\", \" hosting recommendations for ASP.NET Core web apps\\n\\n\\fLearn more about design patterns to consider wh\", \"en building microservice-based systems.\\n\\nAzure Kubernetes Service\\n\\nAzure Kubernetes Service (AKS) ma\", \"nages your hosted Kubernetes environment, making it quick and\\neasy to deploy and manage containerize\", \"d applications without container orchestration expertise. It\\nalso eliminates the burden of ongoing o\", \"perations and maintenance by provisioning, upgrading, and\\nscaling resources on-demand, without takin\", \"g your applications offline.\\n\\nAKS reduces the complexity and operational overhead of managing a Kube\", \"rnetes cluster by\\noffloading much of that responsibility to Azure. As a hosted Kubernetes service, A\", \"zure handles critical\\ntasks like health monitoring and maintenance for you. Also, you pay only for t\", \"he agent nodes within\\nyour clusters, not for the masters. As a managed Kubernetes service, AKS provi\", \"des:\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nAutomated Kubernetes version upgrades and patching.\\n\\nEasy cluster scaling.\\n\\nSelf-h\", \"ealing hosted control plane (masters).\\n\\nCost savings - pay only for running agent pool nodes.\\n\\nWith \", \"Azure handling the management of the nodes in your AKS cluster, you no longer need to\\nperform many t\", \"asks manually, like cluster upgrades. Because Azure handles these critical maintenance\\ntasks for you\", \", AKS doesn\\u2019t provide direct access (such as with SSH) to the cluster.\\n\\nTeams who are leveraging AKS\", \" can also take advantage of Azure Dev Spaces. Azure Dev Spaces helps\\nteams to focus on the developme\", \"nt and rapid iteration of their microservice application by allowing\\nteams to work directly with the\", \"ir entire microservices architecture or application running in AKS. Azure\\nDev Spaces also provides a\", \" way to independently update portions of your microservices architecture\\nin isolation without affect\", \"ing the rest of the AKS cluster or other developers.\\n\\n106\\n\\nCHAPTER 10 | Azure hosting recommendation\", \"s for ASP.NET Core web apps\\n\\n\\fAzure Dev Spaces:\\n\\n\\u2022  Minimize local machine setup time and resource r\", \"equirements\\n\\n\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nAllow teams to iterate more rapidly\\n\\nReduce the number of integration environm\", \"ents required by a team\\n\\nRemove the need to mock certain services in a distributed system when devel\", \"oping/testing\\n\\nLearn more about Azure Dev Spaces\\n\\nAzure Virtual Machines\\n\\nIf you have an existing ap\", \"plication that would require substantial modifications to run in App Service,\\nyou could choose Virtu\", \"al Machines in order to simplify migrating to the cloud. However, correctly\\nconfiguring, securing, a\", \"nd maintaining VMs requires much more time and IT expertise compared to\\nAzure App Service. If you\\u2019re\", \" considering Azure Virtual Machines, make sure you take into account the\\nongoing maintenance effort \", \"required to patch, update, and manage your VM environment. Azure\\nVirtual Machines is infrastructure \", \"as a service (IaaS), while App Service is PaaS. You should also\\nconsider whether deploying your app \", \"as a Windows Container to Web App for Containers might be a\\nviable option for your scenario.\\n\\nLogica\", \"l processes\\n\\nIndividual logical processes that can be decoupled from the rest of the application may\", \" be deployed\\nindependently to Azure Functions in a \\u201cserverless\\u201d manner. Azure Functions lets you jus\", \"t write the\\ncode you need for a given problem, without worrying about the application or infrastruct\", \"ure to run it.\\nYou can choose from a variety of programming languages, including C#, F#, Node.js, Py\", \"thon, and\\nPHP, allowing you to pick the most productive language for the task at hand. Like most clo\", \"ud-based\\nsolutions, you pay only for the amount of time your use, and you can trust Azure Functions \", \"to scale up\\nas needed.\\n\\nData\\n\\nAzure offers a wide variety of data storage options, so that your appl\", \"ication can use the appropriate\\ndata provider for the data in question.\\n\\n107\\n\\nCHAPTER 10 | Azure hos\", \"ting recommendations for ASP.NET Core web apps\\n\\n\\fFor transactional, relational data, Azure SQL Datab\", \"ases are the best option. For high performance\\nread-mostly data, a Redis cache backed by an Azure SQ\", \"L Database is a good solution.\\n\\nUnstructured JSON data can be stored in a variety of ways, from SQL \", \"Database columns to Blobs or\\nTables in Azure Storage, to Azure Cosmos DB. Of these, Azure Cosmos DB \", \"offers the best querying\\nfunctionality, and is the recommended option for large numbers of JSON-base\", \"d documents that must\\nsupport querying.\\n\\nTransient command- or event-based data used to orchestrate \", \"application behavior can use Azure\\nService Bus or Azure Storage Queues. Azure Service Bus offers mor\", \"e flexibility and is the\\nrecommended service for non-trivial messaging within and between applicatio\", \"ns.\\n\\nArchitecture recommendations\\n\\nYour application\\u2019s requirements should dictate its architecture. \", \"There are many different Azure\\nservices available. Choosing the right one is an important decision. \", \"Microsoft offers a gallery of\\nreference architectures to help identify typical architectures optimiz\", \"ed for common scenarios. You\\nmay find a reference architecture that maps closely to your application\", \"\\u2019s requirements, or at least\\noffers a starting point.\\n\\nFigure 11-1 shows an example reference archit\", \"ecture. This diagram describes a recommended\\narchitecture approach for a Sitecore content management\", \" system website optimized for marketing.\\n\\nFigure 11-1. Sitecore marketing website reference architec\", \"ture.\\n\\nReferences \\u2013 Azure hosting recommendations\\n\\n\\u2022\\n\\nAzure Solution Architectures\\nhttps://azure.mic\", \"rosoft.com/solutions/architecture/\\n\\n108\\n\\nCHAPTER 10 | Azure hosting recommendations for ASP.NET Core\", \" web apps\\n\\n\\f\\u2022\\n\\n\\u2022\\n\\n\\u2022\\n\\nAzure Basic Web Application Architecture\\nhttps://learn.microsoft.com/azure/arch\", \"itecture/reference-architectures/app-service-web-\\napp/basic-web-app\\n\\nDesign Patterns for Microservic\", \"es\\nhttps://learn.microsoft.com/azure/architecture/microservices/design/patterns\\n\\nAzure Developer Gui\", \"de\\nhttps://azure.microsoft.com/campaigns/developer-guide/\\n\\n\\u2022  Web Apps overview\\n\\nhttps://learn.micro\", \"soft.com/azure/app-service/app-service-web-overview\\n\\n\\u2022  Web App for Containers\\n\\nhttps://azure.micros\", \"oft.com/services/app-service/containers/\\n\\n\\u2022\\n\\nIntroduction to Azure Kubernetes Service (AKS)\\nhttps://\", \"learn.microsoft.com/azure/aks/intro-kubernetes\\n\\n109\\n\\nCHAPTER 10 | Azure hosting recommendations for \", \"ASP.NET Core web apps\\n\\n\"]"