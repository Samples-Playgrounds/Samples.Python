"[\"EDITION v8.0 - Updated to ASP.NET Core 8.0\\nRefer changelog for the book updates and community contri\", \"butions.\\nPUBLISHED BY\\nMicrosoft Developer Division, .NET, and Visual Studio product teams\\nA division\", \" of Microsoft Corporation\\nOne Microsoft Way\\nRedmond, Washington 98052-6399\\nCopyright \\u00a9 2023 by Micro\", \"soft Corporation\\nAll rights reserved. No part of the contents of this book may be reproduced or tran\", \"smitted in any\\nform or by any means without the written permission of the publisher.\\nThis book is pr\", \"ovided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The views, opinions, and\\ninformation e\", \"xpressed in this book, including URL and other Internet website references, may change\\nwithout notic\", \"e.\\nSome examples depicted herein are provided for illustration only and are fictitious. No real asso\", \"ciation\\nor connection is intended or should be inferred.\\nMicrosoft and the trademarks listed at http\", \"s://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are\\ntrademarks of the Microsoft group of companies\", \".\\nMac and macOS are trademarks of Apple Inc.\\nThe Docker whale logo is a registered trademark of Dock\", \"er, Inc. Used by permission.\\nAll other marks and logos are property of their respective owners.\\nAuth\", \"or:\\nSteve \\u201cardalis\\u201d Smith - Software Architect and Trainer - Ardalis.com\\nEditors:\\nMaira Wenzel\\nActio\", \"n links\\n\\u2022 This e-book is also available in a PDF format (English version only) Download\\n\\u2022 Clone/Fork\", \" the reference application eShopOnWeb on GitHub\\nIntroduction\\n.NET 8 and ASP.NET Core offer several a\", \"dvantages over traditional .NET development. You should use\\n.NET 8 for your server applications if s\", \"ome or all of the following are important to your application\\u2019s\\nsuccess:\\n\\u2022 Cross-platform support.\\u2022 \", \"Use of microservices.\\n\\u2022 Use of Docker containers.\\n\\u2022 High performance and scalability requirements.\\n\\u2022\", \" Side-by-side versioning of .NET versions by application on the same server.\\nTraditional .NET 4.x ap\", \"ps can and do support many of these requirements, but ASP.NET Core and .NET\\n8 have been optimized to\", \" offer improved support for the above scenarios.\\nMore and more organizations are choosing to host th\", \"eir web applications in the cloud using services\\nlike Microsoft Azure. You should consider hosting y\", \"our application in the cloud if the following are\\nimportant to your application or organization:\\n\\u2022 R\", \"educed investment in data center costs (hardware, software, space, utilities, server\\nmanagement, etc\", \".)\\n\\u2022 Flexible pricing (pay based on usage, not for idle capacity).\\n\\u2022 Extreme reliability.\\n\\u2022 Improved\", \" app mobility; easily change where and how your app is deployed.\\n\\u2022 Flexible capacity; scale up or do\", \"wn based on actual needs.\\nBuilding web applications with ASP.NET Core, hosted in Azure, offers many \", \"competitive advantages\\nover traditional alternatives. ASP.NET Core is optimized for modern web appli\", \"cation development\\npractices and cloud hosting scenarios. In this guide, you\\u2019ll learn how to archite\", \"ct your ASP.NET Core\\napplications to best take advantage of these capabilities.\\nVersion\\nThis guide h\", \"as been revised to cover .NET 8.0 version along with many additional updates related to\\nthe same \\u201cwa\", \"ve\\u201d of technologies (that is, Azure and additional third-party technologies) coinciding in\\ntime with\", \" the .NET 8.0 release. That\\u2019s why the book version has also been updated to version 8.0.\\nPurpose\\nThi\", \"s guide provides end-to-end guidance on building monolithic web applications using ASP.NET\\nCore and \", \"Azure. In this context, \\u201cmonolithic\\u201d refers to the fact that these applications are deployed as\\na si\", \"ngle unit, not as a collection of interacting services and applications. In some contexts, the term\\n\", \"monolith may be used as a pejorative, but in the vast majority of situations a single application is\", \"\\nmuch easier to build, deploy, and debug than an app composed of many different services, while stil\", \"l\\nachieving the business requirements.\\nThis guide is complementary to \\u201c.NET Microservices. Architect\", \"ure for Containerized .NET Applications\\u201d,\\nwhich focuses more on Docker, microservices, and deploymen\", \"t of containers to host enterprise\\napplications..NET Microservices. Architecture for Containerized .\", \"NET Applications\\n\\u2022 e-book\\nhttps://aka.ms/MicroservicesEbook\\n\\u2022 Sample Application\\nhttps://aka.ms/micr\", \"oservicesarchitecture\\nWho should use this guide\\nThe audience for this guide is mainly developers, de\", \"velopment leads, and architects who are\\ninterested in building modern web applications using Microso\", \"ft technologies and services in the\\ncloud.\\nA secondary audience is technical decision makers who are\", \" already familiar ASP.NET or Azure and are\\nlooking for information on whether it makes sense to upgr\", \"ade to ASP.NET Core for new or existing\\nprojects.\\nHow you can use this guide\\nThis guide has been con\", \"densed into a relatively small document that focuses on building web\\napplications with modern .NET t\", \"echnologies and Azure. As such, it can be read in its entirety to\\nprovide a foundation of understand\", \"ing such applications and their technical considerations. The\\nguide, along with its sample applicati\", \"on, can also serve as a starting point or reference. Use the\\nassociated sample application as a temp\", \"late for your own applications, or to see how you might\\norganize your application\\u2019s component parts.\", \" Refer back to the guide\\u2019s principles and coverage of\\narchitecture and technology options and decisi\", \"on considerations when you\\u2019re weighing these choices\\nfor your own application.\\nFeel free to forward \", \"this guide to your team to help ensure a common understanding of these\\nconsiderations and opportunit\", \"ies. Having everybody working from a common set of terminology and\\nunderlying principles helps ensur\", \"e consistent application of architectural patterns and practices.\\nReferences\\n\\u2022 Choosing between .NET\", \" and .NET Framework for server apps\\nhttps://learn.microsoft.com/dotnet/standard/choosing-core-framew\", \"ork-serverContents\\nCharacteristics of Modern Web Applications ......................................\", \"................................. 1\\nReference application: eShopOnWeb ..............................\", \"................................................................................................ 1\\nR\", \"eference Application ...............................................................................\", \"........................................................................ 2\\nCloud-hosted and scalable\", \" ...................................................................................................\", \"............................................... 2\\nCross platform ...................................\", \"....................................................................................................\", \".................................... 2\\nModular and loosely coupled .................................\", \"....................................................................................................\", \"........ 3\\nEasily tested with automated tests ......................................................\", \"............................................................................. 3\\nTraditional and SPA \", \"behaviors supported ................................................................................\", \"..................................... 3\\nSimple development and deployment ..........................\", \".................................................................................................. 4\", \"\\nTraditional ASP.NET and Web Forms .................................................................\", \".............................................................. 4\\nBlazor ............................\", \"....................................................................................................\", \"............................................................ 4\\nReferences \\u2013 Modern Web Applications \", \"....................................................................................................\", \"............... 4\\nChoose Between Traditional Web Apps and Single Page Apps (SPAs) ..................\", \"........... 6\\nBlazor ...............................................................................\", \"....................................................................................................\", \"......... 7\\nWhen to choose traditional web apps ....................................................\", \"........................................................................ 7\\nWhen to choose SPAs .....\", \"....................................................................................................\", \"................................................... 8\\nReferences \\u2013 SPA Frameworks ..................\", \"....................................................................................................\", \"................. 8\\nWhen to choose Blazor ..........................................................\", \"............................................................................................... 9\\nDe\", \"cision table .......................................................................................\", \"..................................................................................... 9\\nOther consid\", \"erations ...........................................................................................\", \"................................................................... 9\\nArchitectural principles .....\", \"....................................................................................................\", \" 11\\nCommon design principles .......................................................................\", \"........................................................................ 11\\nSeparation of concerns .\", \"....................................................................................................\", \"............................................. 11\\nEncapsulation .....................................\", \"....................................................................................................\", \"............................ 11\\nDependency inversion ...............................................\", \"....................................................................................................\", \". 12\\nExplicit dependencies .........................................................................\", \"............................................................................ 14\\nSingle responsibilit\", \"y ..................................................................................................\", \"...................................................... 14\\nDon\\u2019t repeat yourself (DRY) ..............\", \"....................................................................................................\", \"....................... 15\\ni ContentsPersistence ignorance .........................................\", \"....................................................................................................\", \"....... 15\\nBounded contexts ........................................................................\", \".................................................................................... 16\\nAdditional r\", \"esources ...........................................................................................\", \"................................................................. 16\\nCommon web application architec\", \"tures ............................................................................. 17\\nWhat is a mon\", \"olithic application? ...............................................................................\", \"................................................... 17\\nAll-in-one applications .....................\", \"....................................................................................................\", \".............................. 17\\nWhat are layers? .................................................\", \"....................................................................................................\", \"............... 18\\nTraditional \\u201cN-Layer\\u201d architecture applications .................................\", \"....................................................................... 19\\nClean architecture ......\", \"....................................................................................................\", \"....................................................... 23\\nOrganizing code in Clean Architecture ...\", \"....................................................................................................\", \"............ 28\\nMonolithic applications and containers .............................................\", \".......................................................................... 30\\nMonolithic application\", \" deployed as a container ...........................................................................\", \"...................... 31\\nDocker support ...........................................................\", \"....................................................................................................\", \"....... 33\\nTroubleshooting Docker problems .........................................................\", \".................................................................. 34\\nOther web application architec\", \"tural styles .......................................................................................\", \"...................... 34\\nReferences \\u2013 Common web architectures ....................................\", \".......................................................................... 34\\nCommon client-side web\", \" technologies ............................................................................... 36\\nHTM\", \"L ..................................................................................................\", \"........................................................................................ 36\\nCSS ....\", \"....................................................................................................\", \"...................................................................................... 36\\nCSS prepro\", \"cessors ............................................................................................\", \"............................................................... 37\\nJavaScript ......................\", \"....................................................................................................\", \"....................................................... 38\\nLegacy web apps with jQuery .............\", \"....................................................................................................\", \".................... 38\\njQuery vs a SPA Framework ..................................................\", \"....................................................................................... 38\\nAngular S\", \"PAs ................................................................................................\", \"...................................................................... 39\\nReact ....................\", \"....................................................................................................\", \".............................................................. 40\\nVue ..............................\", \"....................................................................................................\", \"....................................................... 40\\nBlazor WebAssembly ......................\", \"....................................................................................................\", \"............................ 41\\nChoosing a SPA Framework ...........................................\", \".............................................................................................. 41\\nRe\", \"ferences \\u2013 Client Web Technologies .................................................................\", \".................................................. 42\\nDevelop ASP.NET Core MVC apps ................\", \"....................................................................... 43\\nMVC and Razor Pages .....\", \"....................................................................................................\", \"................................................ 43\\nii ContentsWhy Razor Pages?.....................\", \"....................................................................................................\", \"................................... 44\\nWhen to use MVC .............................................\", \"....................................................................................................\", \"........... 44\\nMapping requests to responses .......................................................\", \".............................................................................. 44\\nKeeping controller\", \"s under control ....................................................................................\", \"........................................ 46\\nReferences \\u2013 Mapping Requests to Responses .............\", \"...................................................................................... 48\\nWorking wi\", \"th dependencies ....................................................................................\", \"......................................................... 48\\nDeclare your dependencies .............\", \"....................................................................................................\", \"......................... 49\\nStructuring the application ...........................................\", \"....................................................................................................\", \" 50\\nFeature organization ...........................................................................\", \"............................................................................ 51\\nAPIs and Blazor appl\", \"ications ...........................................................................................\", \"............................................. 53\\nCross-cutting concerns ............................\", \"....................................................................................................\", \".................. 54\\nReferences \\u2013 Structuring applications ........................................\", \"............................................................................. 57\\nSecurity ..........\", \"....................................................................................................\", \"....................................................................... 57\\nIdentity ................\", \"....................................................................................................\", \"............................................................. 57\\nAuthentication ....................\", \"....................................................................................................\", \"........................................... 60\\nReferences \\u2013 Authentication .........................\", \"....................................................................................................\", \"........... 61\\nAuthorization .......................................................................\", \".............................................................................................. 61\\nRe\", \"ferences \\u2013 Security ................................................................................\", \"...................................................................... 64\\nClient communication .....\", \"....................................................................................................\", \"................................................ 64\\nReferences \\u2013 Client Communication ..............\", \"....................................................................................................\", \"...... 65\\nDomain-driven design \\u2013 Should you apply it? ..............................................\", \"............................................................ 65\\nWhen should you apply DDD ..........\", \"....................................................................................................\", \"........................ 66\\nWhen shouldn\\u2019t you apply DDD ...........................................\", \"..................................................................................... 66\\nReferences \", \"\\u2013 Domain-Driven Design .............................................................................\", \".......................................... 67\\nDeployment ...........................................\", \"....................................................................................................\", \".............................. 67\\nReferences \\u2013 Deployment ..........................................\", \"................................................................................................... \", \"68\\nWorking with Data in ASP.NET Core Apps ..........................................................\", \"............... 69\\nEntity Framework Core (for relational databases) ................................\", \".................................................................... 69\\nThe DbContext ..............\", \"....................................................................................................\", \"................................................ 69\\nConfiguring EF Core ............................\", \"....................................................................................................\", \"........................ 70\\nFetching and storing Data ..............................................\", \".............................................................................................. 71\\nFe\", \"tching related data ................................................................................\", \"...................................................................... 72\\niii ContentsEncapsulating \", \"data ...............................................................................................\", \"........................................................... 73\\nResilient connections ...............\", \"....................................................................................................\", \"................................... 74\\nReferences \\u2013 Entity Framework Core ..........................\", \".............................................................................................. 76\\nEF\", \" Core or micro-ORM? ................................................................................\", \"..................................................................... 76\\nSQL or NoSQL ..............\", \"....................................................................................................\", \"...................................................... 77\\nAzure Cosmos DB ..........................\", \"....................................................................................................\", \"................................... 78\\nOther persistence options ...................................\", \"....................................................................................................\", \".......... 79\\nCaching ..............................................................................\", \"....................................................................................................\", \"... 80\\nASP.NET Core response caching ...............................................................\", \"................................................................. 80\\nData caching ..................\", \"....................................................................................................\", \"................................................ 81\\nGetting data to Blazor WebAssembly apps ........\", \"....................................................................................................\", \".... 83\\nTest ASP.NET Core MVC apps .................................................................\", \"............................. 85\\nKinds of automated tests ..........................................\", \"....................................................................................................\", \"..... 85\\nUnit tests ................................................................................\", \".............................................................................................. 85\\nIn\", \"tegration tests ....................................................................................\", \"............................................................................ 85\\nFunctional tests ...\", \"....................................................................................................\", \".......................................................... 86\\nTesting Pyramid ......................\", \"....................................................................................................\", \"...................................... 86\\nWhat to test .............................................\", \"....................................................................................................\", \"....................... 87\\nOrganizing test projects ................................................\", \"....................................................................................................\", \". 88\\nTest naming ...................................................................................\", \"..................................................................................... 89\\nUnit testin\", \"g ASP.NET Core apps ................................................................................\", \"..................................................... 91\\nIntegration testing ASP.NET Core apps .....\", \"....................................................................................................\", \".............. 92\\nFunctional testing ASP.NET Core apps .............................................\", \"............................................................................ 92\\nReferences \\u2013 Test AS\", \"P.NET Core MVC apps ................................................................................\", \".......................... 95\\nDevelopment process for Azure ........................................\", \".................................................. 96\\nVision .......................................\", \"....................................................................................................\", \".............................................. 96\\nDevelopment environment for ASP.NET Core apps ....\", \"........................................................................................... 96\\nDevel\", \"opment tools choices: IDE or editor ................................................................\", \".............................................. 96\\nDevelopment workflow for Azure-hosted ASP.NET Core\", \" apps .......................................................................... 97\\nInitial setup ..\", \"....................................................................................................\", \"................................................................... 97\\nWorkflow for developing Azure\", \"-hosted ASP.NET Core applications .......................................................... 98\\nRefe\", \"rences .............................................................................................\", \"................................................................................ 100\\niv ContentsAzur\", \"e hosting recommendations for ASP.NET Core web apps ...................................... 101\\nWeb a\", \"pplications ........................................................................................\", \"........................................................................ 101\\nApp Service Web Apps ..\", \"....................................................................................................\", \".......................................... 101\\nApp Service Web Apps for Containers .................\", \"................................................................................................. 10\", \"3\\nAzure Kubernetes Service .........................................................................\", \".................................................................. 106\\nAzure Virtual Machines ......\", \"....................................................................................................\", \"...................................... 107\\nLogical processes .......................................\", \"....................................................................................................\", \"..................... 107\\nData .....................................................................\", \"....................................................................................................\", \"................. 107\\nArchitecture recommendations .................................................\", \".................................................................................... 108\\nv Contents1\", \"\\nCHAPTER\\nCharacteristics of Modern\\nWeb Applications\\n\\u201c\\u2026 with proper design, the features come cheaply\", \". This approach is arduous, but continues to\\nsucceed.\\u201d\\n- Dennis Ritchie\\nModern web applications have\", \" higher user expectations and greater demands than ever before.\\nToday\\u2019s web apps are expected to be \", \"available 24/7 from anywhere in the world, and usable from\\nvirtually any device or screen size. Web \", \"applications must be secure, flexible, and scalable to meet\\nspikes in demand. Increasingly, complex \", \"scenarios should be handled by rich user experiences built on\\nthe client using JavaScript, and commu\", \"nicating efficiently through web APIs.\\nASP.NET Core is optimized for modern web applications and clo\", \"ud-based hosting scenarios. Its\\nmodular design enables applications to depend on only those features\", \" they actually use, improving\\napplication security and performance while reducing hosting resource r\", \"equirements.\\nReference application: eShopOnWeb\\nThis guidance includes a reference application, eShop\", \"OnWeb, that demonstrates some of the\\nprinciples and recommendations. The application is a simple onl\", \"ine store, which supports browsing\\nthrough a catalog of shirts, coffee mugs, and other marketing ite\", \"ms. The reference application is\\ndeliberately simple in order to make it easy to understand.\\n1 CHAPT\", \"ER 1 | Characteristics of Modern Web ApplicationsFigure 2-1. eShopOnWeb\\nReference Application\\n\\u2022 eSho\", \"pOnWeb\\nhttps://github.com/dotnet/eShopOnWeb\\nCloud-hosted and scalable\\nASP.NET Core is optimized for \", \"the cloud (public cloud, private cloud, any cloud) because it is low-\\nmemory and high-throughput. Th\", \"e smaller footprint of ASP.NET Core applications means you can\\nhost more of them on the same hardwar\", \"e, and you pay for fewer resources when using pay-as-you-\\ngo cloud hosting services. The higher-thro\", \"ughput means you can serve more customers from an\\napplication given the same hardware, further reduc\", \"ing the need to invest in servers and hosting\\ninfrastructure.\\nCross platform\\nASP.NET Core is cross-p\", \"latform and can run on Linux, macOS, and Windows. This capability opens up\\nmany new options for both\", \" the development and deployment of apps built with ASP.NET Core.\\n2 CHAPTER 1 | Characteristics of Mo\", \"dern Web ApplicationsDocker containers - both Linux and Windows - can host ASP.NET Core applications\", \", allowing them to\\ntake advantage of the benefits of containers and microservices.\\nModular and loose\", \"ly coupled\\nNuGet packages are first-class citizens in .NET Core, and ASP.NET Core apps are composed \", \"of many\\nlibraries through NuGet. This granularity of functionality helps ensure apps only depend on \", \"and\\ndeploy functionality they actually require, reducing their footprint and security vulnerability \", \"surface\\narea.\\nASP.NET Core also fully supports dependency injection, both internally and at the appl\", \"ication level.\\nInterfaces can have multiple implementations that can be swapped out as needed. Depen\", \"dency\\ninjection allows apps to loosely couple to those interfaces, rather than specific implementati\", \"ons,\\nmaking them easier to extend, maintain, and test.\\nEasily tested with automated tests\\nASP.NET Co\", \"re applications support unit testing, and their loose coupling and support for dependency\\ninjection \", \"makes it easy to swap infrastructure concerns with fake implementations for test purposes.\\nASP.NET C\", \"ore also ships with a TestServer that can be used to host apps in memory. Functional tests\\ncan then \", \"make requests to this in-memory server, exercising the full application stack (including\\nmiddleware,\", \" routing, model binding, filters, etc.) and receiving a response, all in a fraction of the time\\nit w\", \"ould take to host the app on a real server and make requests through the network layer. These\\ntests \", \"are especially easy to write, and valuable, for APIs, which are increasingly important in modern\\nweb\", \" applications.\\nTraditional and SPA behaviors supported\\nTraditional web applications have involved li\", \"ttle client-side behavior, but instead have relied on the\\nserver for all navigation, queries, and up\", \"dates the app might need to make. Each new operation made\\nby the user would be translated into a new\", \" web request, with the result being a full page reload in the\\nend user\\u2019s browser. Classic Model-View\", \"-Controller (MVC) frameworks typically follow this approach,\\nwith each new request corresponding to \", \"a different controller action, which in turn would work with a\\nmodel and return a view. Some individ\", \"ual operations on a given page might be enhanced with AJAX\\n(Asynchronous JavaScript and XML) functio\", \"nality, but the overall architecture of the app used many\\ndifferent MVC views and URL endpoints. In \", \"addition, ASP.NET Core MVC also supports Razor Pages, a\\nsimpler way to organize MVC-style pages.\\nSin\", \"gle Page Applications (SPAs), by contrast, involve very few dynamically generated server-side page\\nl\", \"oads (if any). Many SPAs are initialized within a static HTML file that loads the necessary JavaScri\", \"pt\\nlibraries to start and run the app. These apps make heavy usage of web APIs for their data needs \", \"and\\ncan provide much richer user experiences. Blazor WebAssembly provides a means of building SPAs\\nu\", \"sing .NET code, which then runs in the client\\u2019s browser.\\n3 CHAPTER 1 | Characteristics of Modern Web\", \" ApplicationsMany web applications involve a combination of traditional web application behavior (ty\", \"pically for\\ncontent) and SPAs (for interactivity). ASP.NET Core supports both MVC (Views or Page bas\", \"ed) and web\\nAPIs in the same application, using the same set of tools and underlying framework libra\", \"ries.\\nSimple development and deployment\\nASP.NET Core applications can be written using simple text e\", \"ditors and command-line interfaces, or\\nfull-featured development environments like Visual Studio. Mo\", \"nolithic applications are typically\\ndeployed to a single endpoint. Deployments can easily be automat\", \"ed to occur as part of a continuous\\nintegration (CI) and continuous delivery (CD) pipeline. In addit\", \"ion to traditional CI/CD tools, Microsoft\\nAzure has integrated support for git repositories and can \", \"automatically deploy updates as they are\\nmade to a specified git branch or tag. Azure DevOps provide\", \"s a full-featured CI/CD build and\\ndeployment pipeline, and GitHub Actions provide another option for\", \" projects hosted there.\\nTraditional ASP.NET and Web Forms\\nIn addition to ASP.NET Core, traditional A\", \"SP.NET 4.x continues to be a robust and reliable platform for\\nbuilding web applications. ASP.NET sup\", \"ports MVC and Web API development models, as well as Web\\nForms, which is well suited to rich page-ba\", \"sed application development and features a rich third-party\\ncomponent ecosystem. Microsoft Azure has\", \" great longstanding support for ASP.NET 4.x applications,\\nand many developers are familiar with this\", \" platform.\\nBlazor\\nBlazor is included with ASP.NET Core 3.0 and later. It provides a new mechanism fo\", \"r building rich\\ninteractive web client applications using Razor, C#, and ASP.NET Core. It offers ano\", \"ther solution to\\nconsider when developing modern web applications. There are two versions of Blazor \", \"to consider:\\nserver-side and client-side.\\nServer-side Blazor was released in 2019 with ASP.NET Core \", \"3.0. As its name implies, it runs on the\\nserver, rendering changes to the client document back to th\", \"e browser over the network. Server-side\\nBlazor provides a rich client experience without requiring c\", \"lient-side JavaScript and without requiring\\nseparate page loads for each client page interaction. Ch\", \"anges in the loaded page are requested from\\nand processed by the server and then sent back to the cl\", \"ient using SignalR.\\nClient-side Blazor, released in 2020, eliminates the need to render changes on t\", \"he server. Instead, it\\nleverages WebAssembly to run .NET code within the client. The client can stil\", \"l make API calls to the\\nserver if needed to request data, but all client-side behavior runs in the c\", \"lient via WebAssembly, which\\nis already supported by all major browsers and is just a JavaScript lib\", \"rary.\\nReferences \\u2013 Modern Web Applications\\n\\u2022 Introduction to ASP.NET Core\\nhttps://learn.microsoft.co\", \"m/aspnet/core/\\n4 CHAPTER 1 | Characteristics of Modern Web Applications\\u2022 Testing in ASP.NET Core\\nhtt\", \"ps://learn.microsoft.com/aspnet/core/testing/\\n\\u2022 Blazor - Get Started\\nhttps://blazor.net/docs/get-sta\", \"rted.html\\n5 CHAPTER 1 | Characteristics of Modern Web Applications2\\nCHAPTER\\nChoose Between\\nTradition\", \"al Web Apps and\\nSingle Page Apps (SPAs)\\n\\u201cAtwood\\u2019s Law: Any application that can be written in JavaSc\", \"ript, will eventually be written in\\nJavaScript.\\u201d\\n- Jeff Atwood\\nThere are two general approaches to b\", \"uilding web applications today: traditional web applications\\nthat perform most of the application lo\", \"gic on the server, and single-page applications (SPAs) that\\nperform most of the user interface logic\", \" in a web browser, communicating with the web server\\nprimarily using web APIs. A hybrid approach is \", \"also possible, the simplest being host one or more rich\\nSPA-like subapplications within a larger tra\", \"ditional web application.\\nUse traditional web applications when:\\n\\u2022 Your application\\u2019s client-side re\", \"quirements are simple or even read-only.\\n\\u2022 Your application needs to function in browsers without Ja\", \"vaScript support.\\n\\u2022 Your application is public-facing and benefits from search engine discovery and \", \"referrals.\\nUse a SPA when:\\n\\u2022 Your application must expose a rich user interface with many features.\\n\", \"\\u2022 Your team is familiar with JavaScript, TypeScript, or Blazor WebAssembly development.\\n\\u2022 Your appli\", \"cation must already expose an API for other (internal or public) clients.\\nAdditionally, SPA framewor\", \"ks require greater architectural and security expertise. They experience\\ngreater churn due to freque\", \"nt updates and new client frameworks than traditional web applications.\\nConfiguring automated build \", \"and deployment processes and utilizing deployment options like\\ncontainers may be more difficult with\", \" SPA applications than traditional web apps.\\nImprovements in user experience made possible by the SP\", \"A approach must be weighed against these\\nconsiderations.\\n6 CHAPTER 2 | Choose Between Traditional We\", \"b Apps and Single Page Apps (SPAs)Blazor\\nASP.NET Core includes a model for building rich, interactiv\", \"e, and composable user interfaces called\\nBlazor. Blazor server-side allows developers to build UI wi\", \"th C# and Razor on the server and for the UI\\nto be interactively connected to the browser in real-ti\", \"me using a persistent SignalR connection. Blazor\\nWebAssembly introduces another option for Blazor ap\", \"ps, allowing them to run in the browser using\\nWebAssembly. Because it\\u2019s real .NET code running on We\", \"bAssembly, you can reuse code and libraries\\nfrom server-side parts of your application.\\nBlazor provi\", \"des a new, third option to consider when evaluating whether to build a purely server-\\nrendered web a\", \"pplication or a SPA. You can build rich, SPA-like client-side behaviors using Blazor,\\nwithout the ne\", \"ed for significant JavaScript development. Blazor applications can call APIs to request\\ndata or perf\", \"orm server-side operations. They can interoperate with JavaScript where necessary to take\\nadvantage \", \"of JavaScript libraries and frameworks.\\nConsider building your web application with Blazor when:\\n\\u2022 Y\", \"our application must expose a rich user interface\\n\\u2022 Your team is more comfortable with .NET developm\", \"ent than JavaScript or TypeScript\\ndevelopment\\nIf you have an existing web forms application you\\u2019re c\", \"onsidering migrating to .NET Core or the latest\\n.NET, you may wish to review the free e-book, Blazor\", \" for Web Forms Developers to see whether it\\nmakes sense to consider migrating it to Blazor.\\nFor more\", \" information about Blazor, see Get started with Blazor.\\nWhen to choose traditional web apps\\nThe foll\", \"owing section is a more detailed explanation of the previously stated reasons for picking\\ntraditiona\", \"l web applications.\\nYour application has simple, possibly read-only, client-side requirements\\nMany w\", \"eb applications are primarily consumed in a read-only fashion by the vast majority of their\\nusers. R\", \"ead-only (or read-mostly) applications tend to be much simpler than those applications that\\nmaintain\", \" and manipulate a great deal of state. For example, a search engine might consist of a single\\nentry \", \"point with a textbox and a second page for displaying search results. Anonymous users can\\neasily mak\", \"e requests, and there is little need for client-side logic. Likewise, a blog or content\\nmanagement s\", \"ystem\\u2019s public-facing application usually consists mainly of content with little client-\\nside behavi\", \"or. Such applications are easily built as traditional server-based web applications, which\\nperform l\", \"ogic on the web server and render HTML to be displayed in the browser. The fact that each\\nunique pag\", \"e of the site has its own URL that can be bookmarked and indexed by search engines (by\\ndefault, with\", \"out having to add this functionality as a separate feature of the application) is also a clear\\nbenef\", \"it in such scenarios.\\nYour application needs to function in browsers without JavaScript support\\n7 CH\", \"APTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs)Web applications that need \", \"to function in browsers with limited or no JavaScript support should be\\nwritten using traditional we\", \"b app workflows (or at least be able to fall back to such behavior). SPAs\\nrequire client-side JavaSc\", \"ript in order to function; if it\\u2019s not available, SPAs are not a good choice.\\nYour team is unfamilia\", \"r with JavaScript or TypeScript development techniques\\nIf your team is unfamiliar with JavaScript or\", \" TypeScript, but is familiar with server-side web application\\ndevelopment, then they will probably b\", \"e able to deliver a traditional web app more quickly than a\\nSPA. Unless learning to program SPAs is \", \"a goal, or the user experience afforded by a SPA is required,\\ntraditional web apps are a more produc\", \"tive choice for teams who are already familiar with building\\nthem.\\nWhen to choose SPAs\\nThe following\", \" section is a more detailed explanation of when to choose a Single Page Applications\\nstyle of develo\", \"pment for your web app.\\nYour application must expose a rich user interface with many features\\nSPAs c\", \"an support rich client-side functionality that doesn\\u2019t require reloading the page as users take\\nacti\", \"ons or navigate between areas of the app. SPAs can load more quickly, fetching data in the\\nbackgroun\", \"d, and individual user actions are more responsive since full page reloads are rare. SPAs can\\nsuppor\", \"t incremental updates, saving partially completed forms or documents without the user having\\nto clic\", \"k a button to submit a form. SPAs can support rich client-side behaviors, such as drag-and-drop,\\nmuc\", \"h more readily than traditional applications. SPAs can be designed to run in a disconnected mode,\\nma\", \"king updates to a client-side model that are eventually synchronized back to the server once a\\nconne\", \"ction is re-established. Choose a SPA-style application if your app\\u2019s requirements include rich\\nfunc\", \"tionality that goes beyond what typical HTML forms offer.\\nFrequently, SPAs need to implement feature\", \"s that are built into traditional web apps, such as\\ndisplaying a meaningful URL in the address bar r\", \"eflecting the current operation (and allowing users to\\nbookmark or deep link to this URL to return t\", \"o it). SPAs also should allow users to use the browser\\u2019s\\nback and forward buttons with results that \", \"won\\u2019t surprise them.\\nYour team is familiar with JavaScript and/or TypeScript development\\nWriting SPA\", \"s requires familiarity with JavaScript and/or TypeScript and client-side programming\\ntechniques and \", \"libraries. Your team should be competent in writing modern JavaScript using a SPA\\nframework like Ang\", \"ular.\\nReferences \\u2013 SPA Frameworks\\n\\u2022 Angular: https://angular.io\\n\\u2022 React: https://reactjs.org/\\n\\u2022 Vue.\", \"js: https://vuejs.org/\\nYour application must already expose an API for other (internal or public) cl\", \"ients\\n8 CHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs)If you\\u2019re already\", \" supporting a web API for use by other clients, it may require less effort to create a\\nSPA implement\", \"ation that leverages these APIs rather than reproducing the logic in server-side form.\\nSPAs make ext\", \"ensive use of web APIs to query and update data as users interact with the application.\\nWhen to choo\", \"se Blazor\\nThe following section is a more detailed explanation of when to choose Blazor for your web\", \" app.\\nYour application must expose a rich user interface\\nLike JavaScript-based SPAs, Blazor applicat\", \"ions can support rich client behavior without page reloads.\\nThese applications are more responsive t\", \"o users, fetching only the data (or HTML) required to respond\\nto a given user interaction. Designed \", \"properly, server-side Blazor apps can be configured to run as\\nclient-side Blazor apps with minimal c\", \"hanges once this feature is supported.\\nYour team is more comfortable with .NET development than Java\", \"Script or TypeScript\\ndevelopment\\nMany developers are more productive with .NET and Razor than with c\", \"lient-side languages like\\nJavaScript or TypeScript. Since the server-side of the application is alre\", \"ady being developed with .NET,\\nusing Blazor ensures every .NET developer on the team can understand \", \"and potentially build the\\nbehavior of the front end of the application.\\nDecision table\\nThe following\", \" decision table summarizes some of the basic factors to consider when choosing\\nbetween a traditional\", \" web application, a SPA, or a Blazor app.\\nTraditional Web Single Page Blazor\\nFactor\\nApp Application \", \"App\\nRequired Team Familiarity with Minimal Required Minimal\\nJavaScript/TypeScript\\nSupport Browsers w\", \"ithout Scripting Supported Not Supported Supporte\\nd\\nMinimal Client-Side Application Behavior Well-Su\", \"ited Overkill Viable\\nRich, Complex User Interface Limited Well-Suited Well-\\nRequirements Suited\\nOthe\", \"r considerations\\nTraditional Web Apps tend to be simpler and have better Search Engine Optimization \", \"(SEO) criteria\\nthan SPA apps. Search engine bots can easily consume content from traditional apps, w\", \"hile support\\nfor indexing SPAs may be lacking or limited. If your app benefits from public discovery\", \" by search\\nengines, this is often an important consideration.\\n9 CHAPTER 2 | Choose Between Tradition\", \"al Web Apps and Single Page Apps (SPAs)In addition, unless you\\u2019ve built a management tool for your S\", \"PA\\u2019s content, it may require developers\\nto make changes. Traditional Web Apps are often easier for n\", \"on-developers to make changes to, since\\nmuch of the content is simply HTML and may not require a bui\", \"ld process to preview or even deploy. If\\nnon-developers in your organization are likely to need to m\", \"aintain the content of the app, a\\ntraditional web app may be a better choice.\\nSPAs shine when the ap\", \"p has complex interactive forms or other user interaction features. For\\ncomplex apps that require au\", \"thentication to use, and thus aren\\u2019t accessible by public search engine\\nspiders, SPAs are a great op\", \"tion in many cases.\\n10 CHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs)3\\n\", \"CHAPTER\\nArchitectural principles\\n\\u201cIf builders built buildings the way programmers wrote programs, th\", \"en the first woodpecker that\\ncame along would destroy civilization.\\u201d\\n- Gerald Weinberg\\nYou should ar\", \"chitect and design software solutions with maintainability in mind. The principles\\noutlined in this \", \"section can help guide you toward architectural decisions that will result in clean,\\nmaintainable ap\", \"plications. Generally, these principles will guide you toward building applications out\\nof discrete \", \"components that are not tightly coupled to other parts of your application, but rather\\ncommunicate t\", \"hrough explicit interfaces or messaging systems.\\nCommon design principles\\nSeparation of concerns\\nA g\", \"uiding principle when developing is Separation of Concerns. This principle asserts that software\\nsho\", \"uld be separated based on the kinds of work it performs. For instance, consider an application that\\n\", \"includes logic for identifying noteworthy items to display to the user, and which formats such items\", \" in\\na particular way to make them more noticeable. The behavior responsible for choosing which items\", \" to\\nformat should be kept separate from the behavior responsible for formatting the items, since the\", \"se\\nbehaviors are separate concerns that are only coincidentally related to one another.\\nArchitectura\", \"lly, applications can be logically built to follow this principle by separating core business\\nbehavi\", \"or from infrastructure and user-interface logic. Ideally, business rules and logic should reside in\\n\", \"a separate project, which should not depend on other projects in the application. This separation\\nhe\", \"lps ensure that the business model is easy to test and can evolve without being tightly coupled to\\nl\", \"ow-level implementation details (it also helps if infrastructure concerns depend on abstractions\\ndef\", \"ined in the business layer). Separation of concerns is a key consideration behind the use of layers\\n\", \"in application architectures.\\nEncapsulation\\nDifferent parts of an application should use encapsulati\", \"on to insulate them from other parts of the\\napplication. Application components and layers should be\", \" able to adjust their internal implementation\\nwithout breaking their collaborators as long as extern\", \"al contracts are not violated. Proper use of\\nencapsulation helps achieve loose coupling and modulari\", \"ty in application designs, since objects and\\npackages can be replaced with alternative implementatio\", \"ns so long as the same interface is\\nmaintained.\\n11 CHAPTER 3 | Architectural principlesIn classes, e\", \"ncapsulation is achieved by limiting outside access to the class\\u2019s internal state. If an\\noutside act\", \"or wants to manipulate the state of the object, it should do so through a well-defined\\nfunction (or \", \"property setter), rather than having direct access to the private state of the object.\\nLikewise, app\", \"lication components and applications themselves should expose well-defined interfaces\\nfor their coll\", \"aborators to use, rather than allowing their state to be modified directly. This approach\\nfrees the \", \"application\\u2019s internal design to evolve over time without worrying that doing so will break\\ncollabor\", \"ators, so long as the public contracts are maintained.\\nMutable global state is antithetical to encap\", \"sulation. A value fetched from mutable global state in one\\nfunction cannot be relied upon to have th\", \"e same value in another function (or even further in the\\nsame function). Understanding concerns with\", \" mutable global state is one of the reasons programming\\nlanguages like C# have support for different\", \" scoping rules, which are used everywhere from\\nstatements to methods to classes. It\\u2019s worth noting t\", \"hat data-driven architectures which rely on a\\ncentral database for integration within and between ap\", \"plications are, themselves, choosing to depend\\non the mutable global state represented by the databa\", \"se. A key consideration in domain-driven\\ndesign and clean architecture is how to encapsulate access \", \"to data, and how to ensure application\\nstate is not made invalid by direct access to its persistence\", \" format.\\nDependency inversion\\nThe direction of dependency within the application should be in the di\", \"rection of abstraction, not\\nimplementation details. Most applications are written such that compile-\", \"time dependency flows in the\\ndirection of runtime execution, producing a direct dependency graph. Th\", \"at is, if class A calls a method\\nof class B and class B calls a method of class C, then at compile t\", \"ime class A will depend on class B,\\nand class B will depend on class C, as shown in Figure 4-1.\\n12 C\", \"HAPTER 3 | Architectural principlesFigure 4-1. Direct dependency graph.\\nApplying the dependency inve\", \"rsion principle allows A to call methods on an abstraction that B\\nimplements, making it possible for\", \" A to call B at run time, but for B to depend on an interface\\ncontrolled by A at compile time (thus,\", \" inverting the typical compile-time dependency). At run time, the\\nflow of program execution remains \", \"unchanged, but the introduction of interfaces means that different\\nimplementations of these interfac\", \"es can easily be plugged in.\\n13 CHAPTER 3 | Architectural principlesFigure 4-2. Inverted dependency \", \"graph.\\nDependency inversion is a key part of building loosely coupled applications, since implementa\", \"tion\\ndetails can be written to depend on and implement higher-level abstractions, rather than the ot\", \"her\\nway around. The resulting applications are more testable, modular, and maintainable as a result.\", \" The\\npractice of dependency injection is made possible by following the dependency inversion princip\", \"le.\\nExplicit dependencies\\nMethods and classes should explicitly require any collaborating objects th\", \"ey need in order to\\nfunction correctly. It is called the Explicit Dependencies Principle. Class cons\", \"tructors provide an\\nopportunity for classes to identify the things they need in order to be in a val\", \"id state and to function\\nproperly. If you define classes that can be constructed and called, but tha\", \"t will only function properly\\nif certain global or infrastructure components are in place, these cla\", \"sses are being dishonest with their\\nclients. The constructor contract is telling the client that it \", \"only needs the things specified (possibly\\nnothing if the class is just using a parameterless constru\", \"ctor), but then at runtime it turns out the\\nobject really did need something else.\\nBy following the \", \"explicit dependencies principle, your classes and methods are being honest with their\\nclients about \", \"what they need in order to function. Following the principle makes your code more self-\\ndocumenting \", \"and your coding contracts more user-friendly, since users will come to trust that as long\\nas they pr\", \"ovide what\\u2019s required in the form of method or constructor parameters, the objects they\\u2019re\\nworking w\", \"ith will behave correctly at run time.\\nSingle responsibility\\nThe single responsibility principle app\", \"lies to object-oriented design, but can also be considered as an\\narchitectural principle similar to \", \"separation of concerns. It states that objects should have only one\\nresponsibility and that they sho\", \"uld have only one reason to change. Specifically, the only situation in\\nwhich the object should chan\", \"ge is if the manner in which it performs its one responsibility must be\\n14 CHAPTER 3 | Architectural\", \" principlesupdated. Following this principle helps to produce more loosely coupled and modular syste\", \"ms, since\\nmany kinds of new behavior can be implemented as new classes, rather than by adding additi\", \"onal\\nresponsibility to existing classes. Adding new classes is always safer than changing existing c\", \"lasses,\\nsince no code yet depends on the new classes.\\nIn a monolithic application, we can apply the \", \"single responsibility principle at a high level to the layers\\nin the application. Presentation respo\", \"nsibility should remain in the UI project, while data access\\nresponsibility should be kept within an\", \" infrastructure project. Business logic should be kept in the\\napplication core project, where it can\", \" be easily tested and can evolve independently from other\\nresponsibilities.\\nWhen this principle is a\", \"pplied to application architecture and taken to its logical endpoint, you get\\nmicroservices. A given\", \" microservice should have a single responsibility. If you need to extend the\\nbehavior of a system, i\", \"t\\u2019s usually better to do it by adding additional microservices, rather than by\\nadding responsibility\", \" to an existing one.\\nLearn more about microservices architecture\\nDon\\u2019t repeat yourself (DRY)\\nThe app\", \"lication should avoid specifying behavior related to a particular concept in multiple places as\\nthis\", \" practice is a frequent source of errors. At some point, a change in requirements will require\\nchang\", \"ing this behavior. It\\u2019s likely that at least one instance of the behavior will fail to be updated, a\", \"nd\\nthe system will behave inconsistently.\\nRather than duplicating logic, encapsulate it in a program\", \"ming construct. Make this construct the\\nsingle authority over this behavior, and have any other part\", \" of the application that requires this\\nbehavior use the new construct.\\nNote\\nAvoid binding together b\", \"ehavior that is only coincidentally repetitive. For example, just because two\\ndifferent constants bo\", \"th have the same value, that doesn\\u2019t mean you should have only one constant, if\\nconceptually they\\u2019re\", \" referring to different things. Duplication is always preferable to coupling to the\\nwrong abstractio\", \"n.\\nPersistence ignorance\\nPersistence ignorance (PI) refers to types that need to be persisted, but w\", \"hose code is unaffected by\\nthe choice of persistence technology. Such types in .NET are sometimes re\", \"ferred to as Plain Old CLR\\nObjects (POCOs), because they do not need to inherit from a particular ba\", \"se class or implement a\\nparticular interface. Persistence ignorance is valuable because it allows th\", \"e same business model to be\\npersisted in multiple ways, offering additional flexibility to the appli\", \"cation. Persistence choices might\\nchange over time, from one database technology to another, or addi\", \"tional forms of persistence might\\nbe required in addition to whatever the application started with (\", \"for example, using a Redis cache or\\nAzure Cosmos DB in addition to a relational database).\\nSome exam\", \"ples of violations of this principle include:\\n15 CHAPTER 3 | Architectural principles\\u2022 A required ba\", \"se class.\\n\\u2022 A required interface implementation.\\n\\u2022 Classes responsible for saving themselves (such a\", \"s the Active Record pattern).\\n\\u2022 Required parameterless constructor.\\n\\u2022 Properties requiring virtual k\", \"eyword.\\n\\u2022 Persistence-specific required attributes.\\nThe requirement that classes have any of the abo\", \"ve features or behaviors adds coupling between the\\ntypes to be persisted and the choice of persisten\", \"ce technology, making it more difficult to adopt new\\ndata access strategies in the future.\\nBounded c\", \"ontexts\\nBounded contexts are a central pattern in Domain-Driven Design. They provide a way of tackli\", \"ng\\ncomplexity in large applications or organizations by breaking it up into separate conceptual modu\", \"les.\\nEach conceptual module then represents a context that is separated from other contexts (hence,\\n\", \"bounded), and can evolve independently. Each bounded context should ideally be free to choose its\\now\", \"n names for concepts within it, and should have exclusive access to its own persistence store.\\nAt a \", \"minimum, individual web applications should strive to be their own bounded context, with their\\nown p\", \"ersistence store for their business model, rather than sharing a database with other applications.\\nC\", \"ommunication between bounded contexts occurs through programmatic interfaces, rather than\\nthrough a \", \"shared database, which allows for business logic and events to take place in response to\\nchanges tha\", \"t take place. Bounded contexts map closely to microservices, which also are ideally\\nimplemented as t\", \"heir own individual bounded contexts.\\nAdditional resources\\n\\u2022 Principles\\n\\u2022 Bounded Context\\n16 CHAPTER\", \" 3 | Architectural principles4\\nCHAPTER\\nCommon web application\\narchitectures\\n\\u201cIf you think good archi\", \"tecture is expensive, try bad architecture.\\u201d - Brian Foote and Joseph Yoder\\nMost traditional .NET ap\", \"plications are deployed as single units corresponding to an executable or a\\nsingle web application r\", \"unning within a single IIS appdomain. This approach is the simplest\\ndeployment model and serves many\", \" internal and smaller public applications very well. However, even\\ngiven this single unit of deploym\", \"ent, most non-trivial business applications benefit from some logical\\nseparation into several layers\", \".\\nWhat is a monolithic application?\\nA monolithic application is one that is entirely self-contained,\", \" in terms of its behavior. It may interact\\nwith other services or data stores in the course of perfo\", \"rming its operations, but the core of its\\nbehavior runs within its own process and the entire applic\", \"ation is typically deployed as a single unit. If\\nsuch an application needs to scale horizontally, ty\", \"pically the entire application is duplicated across\\nmultiple servers or virtual machines.\\nAll-in-one\", \" applications\\nThe smallest possible number of projects for an application architecture is one. In th\", \"is architecture, the\\nentire logic of the application is contained in a single project, compiled to a\", \" single assembly, and\\ndeployed as a single unit.\\nA new ASP.NET Core project, whether created in Visu\", \"al Studio or from the command line, starts out as\\na simple \\u201call-in-one\\u201d monolith. It contains all of\", \" the behavior of the application, including\\npresentation, business, and data access logic. Figure 5-\", \"1 shows the file structure of a single-project\\napp.\\n17 CHAPTER 4 | Common web application architectu\", \"resFigure 5-1. A single project ASP.NET Core app.\\nIn a single project scenario, separation of concer\", \"ns is achieved through the use of folders. The default\\ntemplate includes separate folders for MVC pa\", \"ttern responsibilities of Models, Views, and Controllers,\\nas well as additional folders for Data and\", \" Services. In this arrangement, presentation details should be\\nlimited as much as possible to the Vi\", \"ews folder, and data access implementation details should be\\nlimited to classes kept in the Data fol\", \"der. Business logic should reside in services and classes within\\nthe Models folder.\\nAlthough simple,\", \" the single-project monolithic solution has some disadvantages. As the project\\u2019s size\\nand complexity\", \" grows, the number of files and folders will continue to grow as well. User interface (UI)\\nconcerns \", \"(models, views, controllers) reside in multiple folders, which aren\\u2019t grouped together\\nalphabeticall\", \"y. This issue only gets worse when additional UI-level constructs, such as Filters or\\nModelBinders, \", \"are added in their own folders. Business logic is scattered between the Models and\\nServices folders,\", \" and there\\u2019s no clear indication of which classes in which folders should depend on\\nwhich others. Th\", \"is lack of organization at the project level frequently leads to spaghetti code.\\nTo address these is\", \"sues, applications often evolve into multi-project solutions, where each project is\\nconsidered to re\", \"side in a particular layer of the application.\\nWhat are layers?\\nAs applications grow in complexity, \", \"one way to manage that complexity is to break up the application\\naccording to its responsibilities o\", \"r concerns. This approach follows the separation of concerns\\nprinciple and can help keep a growing c\", \"odebase organized so that developers can easily find where\\ncertain functionality is implemented. Lay\", \"ered architecture offers a number of advantages beyond just\\ncode organization, though.\\n18 CHAPTER 4 \", \"| Common web application architecturesBy organizing code into layers, common low-level functionality\", \" can be reused throughout the\\napplication. This reuse is beneficial because it means less code needs\", \" to be written and because it can\\nallow the application to standardize on a single implementation, f\", \"ollowing the don\\u2019t repeat yourself\\n(DRY) principle.\\nWith a layered architecture, applications can en\", \"force restrictions on which layers can communicate\\nwith other layers. This architecture helps to ach\", \"ieve encapsulation. When a layer is changed or\\nreplaced, only those layers that work with it should \", \"be impacted. By limiting which layers depend on\\nwhich other layers, the impact of changes can be mit\", \"igated so that a single change doesn\\u2019t impact the\\nentire application.\\nLayers (and encapsulation) mak\", \"e it much easier to replace functionality within the application. For\\nexample, an application might \", \"initially use its own SQL Server database for persistence, but later could\\nchoose to use a cloud-bas\", \"ed persistence strategy, or one behind a web API. If the application has\\nproperly encapsulated its p\", \"ersistence implementation within a logical layer, that SQL Server-specific\\nlayer could be replaced b\", \"y a new one implementing the same public interface.\\nIn addition to the potential of swapping out imp\", \"lementations in response to future changes in\\nrequirements, application layers can also make it easi\", \"er to swap out implementations for testing\\npurposes. Instead of having to write tests that operate a\", \"gainst the real data layer or UI layer of the\\napplication, these layers can be replaced at test time\", \" with fake implementations that provide known\\nresponses to requests. This approach typically makes t\", \"ests much easier to write and much faster to\\nrun when compared to running tests against the applicat\", \"ion\\u2019s real infrastructure.\\nLogical layering is a common technique for improving the organization of \", \"code in enterprise software\\napplications, and there are several ways in which code can be organized \", \"into layers.\\nNote\\nLayers represent logical separation within the application. In the event that appl\", \"ication logic is\\nphysically distributed to separate servers or processes, these separate physical de\", \"ployment targets are\\nreferred to as tiers. It\\u2019s possible, and quite common, to have an N-Layer appli\", \"cation that is deployed\\nto a single tier.\\nTraditional \\u201cN-Layer\\u201d architecture applications\\nThe most c\", \"ommon organization of application logic into layers is shown in Figure 5-2.\\n19 CHAPTER 4 | Common we\", \"b application architecturesFigure 5-2. Typical application layers.\\nThese layers are frequently abbre\", \"viated as UI, BLL (Business Logic Layer), and DAL (Data Access Layer).\\nUsing this architecture, user\", \"s make requests through the UI layer, which interacts only with the BLL.\\nThe BLL, in turn, can call \", \"the DAL for data access requests. The UI layer shouldn\\u2019t make any requests to\\nthe DAL directly, nor \", \"should it interact with persistence directly through other means. Likewise, the BLL\\nshould only inte\", \"ract with persistence by going through the DAL. In this way, each layer has its own\\nwell-known respo\", \"nsibility.\\nOne disadvantage of this traditional layering approach is that compile-time dependencies \", \"run from\\nthe top to the bottom. That is, the UI layer depends on the BLL, which depends on the DAL. \", \"This\\nmeans that the BLL, which usually holds the most important logic in the application, is depende\", \"nt on\\ndata access implementation details (and often on the existence of a database). Testing busines\", \"s logic\\nin such an architecture is often difficult, requiring a test database. The dependency invers\", \"ion principle\\ncan be used to address this issue, as you\\u2019ll see in the next section.\\nFigure 5-3 shows\", \" an example solution, breaking the application into three projects by responsibility\\n(or layer).\\n20 \", \"CHAPTER 4 | Common web application architecturesFigure 5-3. A simple monolithic application with thr\", \"ee projects.\\nAlthough this application uses several projects for organizational purposes, it\\u2019s still\", \" deployed as a\\nsingle unit and its clients will interact with it as a single web app. This allows fo\", \"r very simple\\ndeployment process. Figure 5-4 shows how such an app might be hosted using Azure.\\nFigu\", \"re 5-4. Simple deployment of Azure Web App\\nAs application needs grow, more complex and robust deploy\", \"ment solutions may be required. Figure\\n5-5 shows an example of a more complex deployment plan that s\", \"upports additional capabilities.\\n21 CHAPTER 4 | Common web application architecturesFigure 5-5. Depl\", \"oying a web app to an Azure App Service\\nInternally, this project\\u2019s organization into multiple projec\", \"ts based on responsibility improves the\\nmaintainability of the application.\\nThis unit can be scaled \", \"up or out to take advantage of cloud-based on-demand scalability. Scaling up\\nmeans adding additional\", \" CPU, memory, disk space, or other resources to the server(s) hosting your\\napp. Scaling out means ad\", \"ding additional instances of such servers, whether these are physical\\nservers, virtual machines, or \", \"containers. When your app is hosted across multiple instances, a load\\nbalancer is used to assign req\", \"uests to individual app instances.\\nThe simplest approach to scaling a web application in Azure is to\", \" configure scaling manually in the\\napplication\\u2019s App Service Plan. Figure 5-6 shows the appropriate \", \"Azure dashboard screen to configure\\nhow many instances are serving an app.\\n22 CHAPTER 4 | Common web\", \" application architecturesFigure 5-6. App Service Plan scaling in Azure.\\nClean architecture\\nApplicat\", \"ions that follow the Dependency Inversion Principle as well as the Domain-Driven Design\\n(DDD) princi\", \"ples tend to arrive at a similar architecture. This architecture has gone by many names\\nover the yea\", \"rs. One of the first names was Hexagonal Architecture, followed by Ports-and-Adapters.\\nMore recently\", \", it\\u2019s been cited as the Onion Architecture or Clean Architecture. The latter name, Clean\\nArchitectu\", \"re, is used as the name for this architecture in this e-book.\\nThe eShopOnWeb reference application u\", \"ses the Clean Architecture approach in organizing its code\\ninto projects. You can find a solution te\", \"mplate you can use as a starting point for your own ASP.NET\\nCore solutions in the ardalis/cleanarchi\", \"tecture GitHub repository or by installing the template from\\nNuGet.\\nClean architecture puts the busi\", \"ness logic and application model at the center of the application.\\nInstead of having business logic \", \"depend on data access or other infrastructure concerns, this\\ndependency is inverted: infrastructure \", \"and implementation details depend on the Application Core.\\nThis functionality is achieved by definin\", \"g abstractions, or interfaces, in the Application Core, which are\\nthen implemented by types defined \", \"in the Infrastructure layer. A common way of visualizing this\\narchitecture is to use a series of con\", \"centric circles, similar to an onion. Figure 5-7 shows an example of\\nthis style of architectural rep\", \"resentation.\\n23 CHAPTER 4 | Common web application architecturesFigure 5-7. Clean Architecture; onio\", \"n view\\nIn this diagram, dependencies flow toward the innermost circle. The Application Core takes it\", \"s name\\nfrom its position at the core of this diagram. And you can see on the diagram that the Applic\", \"ation\\nCore has no dependencies on other application layers. The application\\u2019s entities and interface\", \"s are at\\nthe very center. Just outside, but still in the Application Core, are domain services, whic\", \"h typically\\nimplement interfaces defined in the inner circle. Outside of the Application Core, both \", \"the UI and the\\nInfrastructure layers depend on the Application Core, but not on one another (necessa\", \"rily).\\nFigure 5-8 shows a more traditional horizontal layer diagram that better reflects the depende\", \"ncy\\nbetween the UI and other layers.\\n24 CHAPTER 4 | Common web application architecturesFigure 5-8. \", \"Clean Architecture; horizontal layer view\\nNote that the solid arrows represent compile-time dependen\", \"cies, while the dashed arrow represents a\\nruntime-only dependency. With the clean architecture, the \", \"UI layer works with interfaces defined in\\nthe Application Core at compile time, and ideally shouldn\\u2019\", \"t know about the implementation types\\ndefined in the Infrastructure layer. At run time, however, the\", \"se implementation types are required for\\nthe app to execute, so they need to be present and wired up\", \" to the Application Core interfaces via\\ndependency injection.\\nFigure 5-9 shows a more detailed view \", \"of an ASP.NET Core application\\u2019s architecture when built\\nfollowing these recommendations.\\n25 CHAPTER\", \" 4 | Common web application architecturesFigure 5-9. ASP.NET Core architecture diagram following Cle\", \"an Architecture.\\nBecause the Application Core doesn\\u2019t depend on Infrastructure, it\\u2019s very easy to wr\", \"ite automated unit\\ntests for this layer. Figures 5-10 and 5-11 show how tests fit into this architec\", \"ture.\\nFigure 5-10. Unit testing Application Core in isolation.\\n26 CHAPTER 4 | Common web application\", \" architecturesFigure 5-11. Integration testing Infrastructure implementations with external dependen\", \"cies.\\nSince the UI layer doesn\\u2019t have any direct dependency on types defined in the Infrastructure p\", \"roject,\\nit\\u2019s likewise very easy to swap out implementations, either to facilitate testing or in resp\", \"onse to\\nchanging application requirements. ASP.NET Core\\u2019s built-in use of and support for dependency\", \"\\ninjection makes this architecture the most appropriate way to structure non-trivial monolithic\\nappl\", \"ications.\\nFor monolithic applications, the Application Core, Infrastructure, and UI projects are all\", \" run as a single\\napplication. The runtime application architecture might look something like Figure \", \"5-12.\\n27 CHAPTER 4 | Common web application architecturesFigure 5-12. A sample ASP.NET Core app\\u2019s ru\", \"ntime architecture.\\nOrganizing code in Clean Architecture\\nIn a Clean Architecture solution, each pro\", \"ject has clear responsibilities. As such, certain types belong\\nin each project and you\\u2019ll frequently\", \" find folders corresponding to these types in the appropriate\\nproject.\\nApplication Core\\nThe Applicat\", \"ion Core holds the business model, which includes entities, services, and interfaces. These\\ninterfac\", \"es include abstractions for operations that will be performed using Infrastructure, such as data\\nacc\", \"ess, file system access, network calls, etc. Sometimes services or interfaces defined at this layer \", \"will\\nneed to work with non-entity types that have no dependencies on UI or Infrastructure. These can\", \" be\\ndefined as simple Data Transfer Objects (DTOs).\\nApplication Core types\\n\\u2022 Entities (business mode\", \"l classes that are persisted)\\n\\u2022 Aggregates (groups of entities)\\n\\u2022 Interfaces\\n\\u2022 Domain Services\\n\\u2022 Spe\", \"cifications\\n\\u2022 Custom Exceptions and Guard Clauses\\n\\u2022 Domain Events and Handlers\\n28 CHAPTER 4 | Common\", \" web application architecturesInfrastructure\\nThe Infrastructure project typically includes data acce\", \"ss implementations. In a typical ASP.NET Core\\nweb application, these implementations include the Ent\", \"ity Framework (EF) DbContext, any EF Core\\nMigration objects that have been defined, and data access \", \"implementation classes. The most common\\nway to abstract data access implementation code is through t\", \"he use of the Repository design pattern.\\nIn addition to data access implementations, the Infrastruct\", \"ure project should contain implementations\\nof services that must interact with infrastructure concer\", \"ns. These services should implement interfaces\\ndefined in the Application Core, and so Infrastructur\", \"e should have a reference to the Application Core\\nproject.\\nInfrastructure types\\n\\u2022 EF Core types (DbC\", \"ontext, Migration)\\n\\u2022 Data access implementation types (Repositories)\\n\\u2022 Infrastructure-specific servi\", \"ces (for example, FileLogger or SmtpNotifier)\\nUI Layer\\nThe user interface layer in an ASP.NET Core M\", \"VC application is the entry point for the application. This\\nproject should reference the Application\", \" Core project, and its types should interact with infrastructure\\nstrictly through interfaces defined\", \" in Application Core. No direct instantiation of or static calls to the\\nInfrastructure layer types s\", \"hould be allowed in the UI layer.\\nUI Layer types\\n\\u2022 Controllers\\n\\u2022 Custom Filters\\n\\u2022 Custom Middleware\\n\", \"\\u2022 Views\\n\\u2022 ViewModels\\n\\u2022 Startup\\nThe Startup class or Program.cs file is responsible for configuring t\", \"he application, and for wiring up\\nimplementation types to interfaces. The place where this logic is \", \"performed is known as the app\\u2019s\\ncomposition root, and is what allows dependency injection to work pr\", \"operly at run time.\\nNote\\nIn order to wire up dependency injection during app startup, the UI layer p\", \"roject may need to\\nreference the Infrastructure project. This dependency can be eliminated, most eas\", \"ily by using a\\ncustom DI container that has built-in support for loading types from assemblies. For \", \"the purposes of\\nthis sample, the simplest approach is to allow the UI project to reference the Infra\", \"structure project\\n(but developers should limit actual references to types in the Infrastructure proj\", \"ect to the app\\u2019s\\ncomposition root).\\n29 CHAPTER 4 | Common web application architecturesMonolithic ap\", \"plications and containers\\nYou can build a single and monolithic-deployment based Web Application or \", \"Service and deploy it as\\na container. Within the application, it might not be monolithic but organiz\", \"ed into several libraries,\\ncomponents, or layers. Externally, it\\u2019s a single container with a single \", \"process, single web application,\\nor single service.\\nTo manage this model, you deploy a single contai\", \"ner to represent the application. To scale, just add\\nadditional copies with a load balancer in front\", \". The simplicity comes from managing a single\\ndeployment in a single container or VM.\\nYou can includ\", \"e multiple components/libraries or internal layers within each container, as illustrated in\\nFigure 5\", \"-13. But, following the container principle of _\\u201ca container does one thing, and does it in one\\nproc\", \"ess_\\u201d, the monolithic pattern might be a conflict.\\nThe downside of this approach comes if/when the a\", \"pplication grows, requiring it to scale. If the entire\\napplication scales, it\\u2019s not really a problem\", \". However, in most cases, a few parts of the application are\\nthe choke points requiring scaling, whi\", \"le other components are used less.\\nUsing the typical eCommerce example, what you likely need to scal\", \"e is the product information\\ncomponent. Many more customers browse products than purchase them. More\", \" customers use their\\nbasket than use the payment pipeline. Fewer customers add comments or view thei\", \"r purchase history.\\nAnd you likely only have a handful of employees, in a single region, that need t\", \"o manage the content\\nand marketing campaigns. By scaling the monolithic design, all the code is depl\", \"oyed multiple times.\\nIn addition to the \\u201cscale everything\\u201d problem, changes to a single component re\", \"quire complete\\nretesting of the entire application, and a complete redeployment of all the instances\", \".\\nThe monolithic approach is common, and many organizations are developing with this architectural\\na\", \"pproach. Many are having good enough results, while others are hitting limits. Many designed their\\na\", \"pplications in this model, because the tools and infrastructure were too difficult to build service-\", \"\\noriented architectures (SOA), and they didn\\u2019t see the need until the app grew. If you find you\\u2019re h\", \"itting\\n30 CHAPTER 4 | Common web application architecturesthe limits of the monolithic approach, bre\", \"aking up the app to enable it to better leverage containers\\nand microservices may be the next logica\", \"l step.\\nDeploying monolithic applications in Microsoft Azure can be achieved using dedicated VMs for\", \" each\\ninstance. Using Azure Virtual Machine Scale Sets, you can easily scale the VMs. Azure App Serv\", \"ices can\\nrun monolithic applications and easily scale instances without having to manage the VMs. Az\", \"ure App\\nServices can run single instances of Docker containers as well, simplifying the deployment. \", \"Using\\nDocker, you can deploy a single VM as a Docker host, and run multiple instances. Using the Azu\", \"re\\nbalancer, as shown in the Figure 5-14, you can manage scaling.\\nThe deployment to the various host\", \"s can be managed with traditional deployment techniques. The\\nDocker hosts can be managed with comman\", \"ds like docker run performed manually, or through\\nautomation such as Continuous Delivery (CD) pipeli\", \"nes.\\nMonolithic application deployed as a container\\nThere are benefits of using containers to manage\", \" monolithic application deployments. Scaling the\\ninstances of containers is far faster and easier th\", \"an deploying additional VMs. Even when using virtual\\nmachine scale sets to scale VMs, they take time\", \" to create. When deployed as app instances, the\\nconfiguration of the app is managed as part of the V\", \"M.\\nDeploying updates as Docker images is far faster and network efficient. Docker Images typically s\", \"tart\\nin seconds, speeding rollouts. Tearing down a Docker instance is as easy as issuing a docker st\", \"op\\ncommand, typically completing in less than a second.\\n31 CHAPTER 4 | Common web application archit\", \"ecturesAs containers are inherently immutable by design, you never need to worry about corrupted VMs\", \",\\nwhereas update scripts might forget to account for some specific configuration or file left on the\", \" disk.\\nYou can use Docker containers for a monolithic deployment of simpler web applications. This\\na\", \"pproach improves continuous integration and continuous deployment pipelines and helps achieve\\ndeploy\", \"ment-to-production success. No more \\u201cIt works on my machine, why does it not work in\\nproduction?\\u201d\\nA \", \"microservices-based architecture has many benefits, but those benefits come at a cost of increased\\nc\", \"omplexity. In some cases, the costs outweigh the benefits, so a monolithic deployment application\\nru\", \"nning in a single container or in just a few containers is a better option.\\nA monolithic application\", \" might not be easily decomposable into well-separated microservices.\\nMicroservices should work indep\", \"endently of each other to provide a more resilient application. If you\\ncan\\u2019t deliver independent fea\", \"ture slices of the application, separating it only adds complexity.\\nAn application might not yet nee\", \"d to scale features independently. Many applications, when they\\nneed to scale beyond a single instan\", \"ce, can do so through the relatively simple process of cloning that\\nentire instance. The additional \", \"work to separate the application into discrete services provides a\\nminimal benefit when scaling full\", \" instances of the application is simple and cost-effective.\\nEarly in the development of an applicati\", \"on, you might not have a clear idea where the natural\\nfunctional boundaries are. As you develop a mi\", \"nimum viable product, the natural separation might\\nnot yet have emerged. Some of these conditions mi\", \"ght be temporary. You might start by creating a\\nmonolithic application, and later separate some feat\", \"ures to be developed and deployed as\\nmicroservices. Other conditions might be essential to the appli\", \"cation\\u2019s problem space, meaning that\\nthe application might never be broken into multiple microservic\", \"es.\\nSeparating an application into many discrete processes also introduces overhead. There\\u2019s more\\nco\", \"mplexity in separating features into different processes. The communication protocols become\\nmore co\", \"mplex. Instead of method calls, you must use asynchronous communications between\\nservices. As you mo\", \"ve to a microservices architecture, you need to add many of the building blocks\\nimplemented in the m\", \"icroservices version of the eShopOnContainers application: event bus handling,\\nmessage resiliency an\", \"d retries, eventual consistency, and more.\\nThe much simpler eShopOnWeb reference application support\", \"s single-container monolithic container\\nusage. The application includes one web application that inc\", \"ludes traditional MVC views, web APIs,\\nand Razor Pages. Optionally, you can run the application\\u2019s Bl\", \"azor-based admin component, which\\nrequires a separate API project to run as well.\\nThe application ca\", \"n be launched from the solution root using the docker-compose build and docker-\\ncompose up commands.\", \" This command configures a container for the web instance, using the\\nDockerfile found in the web pro\", \"ject\\u2019s root, and runs the container on a specified port. You can\\ndownload the source for this applic\", \"ation from GitHub and run it locally. Even this monolithic\\napplication benefits from being deployed \", \"in a container environment.\\nFor one, the containerized deployment means that every instance of the a\", \"pplication runs in the same\\nenvironment. This approach includes the developer environment where earl\", \"y testing and\\ndevelopment take place. The development team can run the application in a containerize\", \"d\\nenvironment that matches the production environment.\\n32 CHAPTER 4 | Common web application archite\", \"cturesIn addition, containerized applications scale out at a lower cost. Using a container environme\", \"nt\\nenables greater resource sharing than traditional VM environments.\\nFinally, containerizing the ap\", \"plication forces a separation between the business logic and the storage\\nserver. As the application \", \"scales out, the multiple containers will all rely on a single physical storage\\nmedium. This storage \", \"medium would typically be a high-availability server running a SQL Server\\ndatabase.\\nDocker support\\nT\", \"he eShopOnWeb project runs on .NET. Therefore, it can run in either Linux-based or Windows-based\\ncon\", \"tainers. Note that for Docker deployment, you want to use the same host type for SQL Server.\\nLinux-b\", \"ased containers allow a smaller footprint and are preferred.\\nYou can use Visual Studio 2017 or later\", \" to add Docker support to an existing application by right-\\nclicking on a project in Solution Explor\", \"er and choosing Add > Docker Support. This step adds the\\nfiles required and modifies the project to \", \"use them. The current eShopOnWeb sample already has\\nthese files in place.\\nThe solution-level docker-\", \"compose.yml file contains information about what images to build and\\nwhat containers to launch. The \", \"file allows you to use the docker-compose command to launch\\nmultiple applications at the same time. \", \"In this case, it is only launching the Web project. You can also\\nuse it to configure dependencies, s\", \"uch as a separate database container.\\nversion: '3'\\nservices:\\neshopwebmvc:\\nimage: eshopwebmvc\\nbuild:\\n\", \"context: .\\ndockerfile: src/Web/Dockerfile\\nenvironment:\\n- ASPNETCORE_ENVIRONMENT=Development\\nports:\\n-\", \" \\\"5106:5106\\\"\\nnetworks:\\ndefault:\\nexternal:\\nname: nat\\nThe docker-compose.yml file references the Docke\", \"rfile in the Web project. The Dockerfile is used to\\nspecify which base container will be used and ho\", \"w the application will be configured on it. The Web\\u2019\\nDockerfile:\\nFROM mcr.microsoft.com/dotnet/sdk:8\", \".0 AS build\\nWORKDIR /app\\nCOPY *.sln .\\nCOPY . .\\nWORKDIR /app/src/Web\\nRUN dotnet restore\\n33 CHAPTER 4 \", \"| Common web application architecturesRUN dotnet publish -c Release -o out\\nFROM mcr.microsoft.com/do\", \"tnet/aspnet:8.0 AS runtime\\nWORKDIR /app\\nCOPY --from=build /app/src/Web/out ./\\nENTRYPOINT [\\\"dotnet\\\", \", \"\\\"Web.dll\\\"]\\nTroubleshooting Docker problems\\nOnce you run the containerized application, it continues \", \"to run until you stop it. You can view which\\ncontainers are running with the docker ps command. You \", \"can stop a running container by using the\\ndocker stop command and specifying the container ID.\\nNote \", \"that running Docker containers may be bound to ports you might otherwise try to use in your\\ndevelopm\", \"ent environment. If you try to run or debug an application using the same port as a running\\nDocker c\", \"ontainer, you\\u2019ll get an error stating that the server can\\u2019t bind to that port. Once again,\\nstopping \", \"the container should resolve the issue.\\nIf you want to add Docker support to your application using \", \"Visual Studio, make sure Docker Desktop\\nis running when you do so. The wizard won\\u2019t run correctly if\", \" Docker Desktop isn\\u2019t running when you\\nstart the wizard. In addition, the wizard examines your curre\", \"nt container choice to add the correct\\nDocker support. If you want to add, support for Windows Conta\", \"iners, you need to run the wizard\\nwhile you have Docker Desktop running with Windows Containers conf\", \"igured. If you want to add,\\nsupport for Linux containers, run the wizard while you have Docker runni\", \"ng with Linux containers\\nconfigured.\\nOther web application architectural styles\\n\\u2022 Web-Queue-Worker: \", \"The core components of this architecture are a web front end that\\nserves client requests, and a work\", \"er that performs resource-intensive tasks, long-running\\nworkflows, or batch jobs. The web front end \", \"communicates with the worker through a\\nmessage queue.\\n\\u2022 N-tier: An N-tier architecture divides an ap\", \"plication into logical layers and physical tiers.\\n\\u2022 Microservice: A microservices architecture consi\", \"sts of a collection of small, autonomous\\nservices. Each service is self-contained and should impleme\", \"nt a single business capability\\nwithin a bounded context.\\nReferences \\u2013 Common web architectures\\n\\u2022 Th\", \"e Clean Architecture\\nhttps://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html\\n\\u2022 \", \"The Onion Architecture\\nhttps://jeffreypalermo.com/blog/the-onion-architecture-part-1/\\n\\u2022 The Reposito\", \"ry Pattern\\nhttps://deviq.com/repository-pattern/\\n\\u2022 Clean Architecture Solution Template\\nhttps://gith\", \"ub.com/ardalis/cleanarchitecture\\n34 CHAPTER 4 | Common web application architectures\\u2022 Architecting M\", \"icroservices e-book\\nhttps://aka.ms/MicroservicesEbook\\n\\u2022 DDD (Domain-Driven Design)\\nhttps://learn.mic\", \"rosoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-\\npatterns/\\n35 CHAPTER 4 | Common \", \"web application architectures5\\nCHAPTER\\nCommon client-side web\\ntechnologies\\n\\u201cWebsites should look goo\", \"d from the inside and out.\\u201d - Paul Cookson\\nASP.NET Core applications are web applications and they t\", \"ypically rely on client-side web\\ntechnologies like HTML, CSS, and JavaScript. By separating the cont\", \"ent of the page (the HTML) from\\nits layout and styling (the CSS), and its behavior (via JavaScript),\", \" complex web apps can leverage the\\nSeparation of Concerns principle. Future changes to the structure\", \", design, or behavior of the\\napplication can be made more easily when these concerns are not intertw\", \"ined.\\nWhile HTML and CSS are relatively stable, JavaScript, by means of the application frameworks a\", \"nd\\nutilities developers work with to build web-based applications, is evolving at breakneck speed. T\", \"his\\nchapter looks at a few ways that JavaScript is used by web developers and provides a high-level\\n\", \"overview of the Angular and React client-side libraries.\\nNote\\nBlazor provides an alternative to Java\", \"Script frameworks for building rich, interactive client user\\ninterfaces.\\nHTML\\nHTML is the standard m\", \"arkup language used to create web pages and web applications. Its elements\\nform the building blocks \", \"of pages, representing formatted text, images, form inputs, and other\\nstructures. When a browser mak\", \"es a request to a URL, whether fetching a page or an application, the\\nfirst thing that is returned i\", \"s an HTML document. This HTML document may reference or include\\nadditional information about its loo\", \"k and layout in the form of CSS, or behavior in the form of\\nJavaScript.\\nCSS\\nCSS (Cascading Style She\", \"ets) is used to control the look and layout of HTML elements. CSS styles can\\nbe applied directly to \", \"an HTML element, defined separately on the same page, or defined in a\\nseparate file and referenced b\", \"y the page. Styles cascade based on how they are used to select a given\\nHTML element. For instance, \", \"a style might apply to an entire document, but would be overridden by a\\n36 CHAPTER 5 | Common client\", \"-side web technologiesstyle that applied to a particular element. Likewise, an element-specific styl\", \"e would be overridden by a\\nstyle that applied to a CSS class that was applied to the element, which \", \"in turn would be overridden\\nby a style targeting a specific instance of that element (via its ID). F\", \"igure 6-1\\nFigure 6-1. CSS Specificity rules, in order.\\nIt\\u2019s best to keep styles in their own separat\", \"e stylesheet files, and to use selection-based cascading to\\nimplement consistent and reusable styles\", \" within the application. Placing style rules within HTML\\nshould be avoided, and applying styles to s\", \"pecific individual elements (rather than whole classes of\\nelements, or elements that have had a part\", \"icular CSS class applied to them) should be the exception,\\nnot the rule.\\nCSS preprocessors\\nCSS style\", \"sheets lack support for conditional logic, variables, and other programming language\\nfeatures. Thus,\", \" large stylesheets often include quite a bit of repetition, as the same color, font, or other\\nsettin\", \"g is applied to many different variations of HTML elements and CSS classes. CSS preprocessors\\ncan he\", \"lp your stylesheets follow the DRY principle by adding support for variables and logic.\\nThe most pop\", \"ular CSS preprocessors are Sass and LESS. Both extend CSS and are backward\\ncompatible with it, meani\", \"ng that a plain CSS file is a valid Sass or LESS file. Sass is Ruby-based and\\nLESS is JavaScript bas\", \"ed, and both typically run as part of your local development process. Both have\\ncommand-line tools a\", \"vailable, as well as built-in support in Visual Studio for running them using Gulp\\nor Grunt tasks.\\n3\", \"7 CHAPTER 5 | Common client-side web technologiesJavaScript\\nJavaScript is a dynamic, interpreted pro\", \"gramming language that has been standardized in the\\nECMAScript language specification. It is the pro\", \"gramming language of the web. Like CSS, JavaScript\\ncan be defined as attributes within HTML elements\", \", as blocks of script within a page, or in separate\\nfiles. Just like CSS, it\\u2019s recommended to organi\", \"ze JavaScript into separate files, keeping it separated as\\nmuch as possible from the HTML found on i\", \"ndividual web pages or application views.\\nWhen working with JavaScript in your web application, ther\", \"e are a few tasks that you\\u2019ll commonly\\nneed to perform:\\n\\u2022 Selecting an HTML element and retrieving a\", \"nd/or updating its value.\\n\\u2022 Querying a Web API for data.\\n\\u2022 Sending a command to a Web API (and respo\", \"nding to a callback with its result).\\n\\u2022 Performing validation.\\nYou can perform all of these tasks wi\", \"th JavaScript alone, but many libraries exist to make these tasks\\neasier. One of the first and most \", \"successful of these libraries is jQuery, which continues to be a\\npopular choice for simplifying thes\", \"e tasks on web pages. For Single Page Applications (SPAs), jQuery\\ndoesn\\u2019t provide many of the desire\", \"d features that Angular and React offer.\\nLegacy web apps with jQuery\\nAlthough ancient by JavaScript \", \"framework standards, jQuery continues to be a commonly used library\\nfor working with HTML/CSS and bu\", \"ilding applications that make AJAX calls to web APIs. However,\\njQuery operates at the level of the b\", \"rowser document object model (DOM), and by default offers only\\nan imperative, rather than declarativ\", \"e, model.\\nFor example, imagine that if a textbox\\u2019s value exceeds 10, an element on the page should b\", \"e made\\nvisible. In jQuery, this functionality would typically be implemented by writing an event han\", \"dler with\\ncode that would inspect the textbox\\u2019s value and set the visibility of the target element b\", \"ased on that\\nvalue. This process is an imperative, code-based approach. Another framework might inst\", \"ead use\\ndatabinding to bind the visibility of the element to the value of the textbox declaratively.\", \" This\\napproach would not require writing any code, but instead only requires decorating the elements\", \"\\ninvolved with data binding attributes. As client-side behaviors grow more complex, data binding\\napp\", \"roaches frequently result in simpler solutions with less code and conditional complexity.\\njQuery vs \", \"a SPA Framework\\nFactor jQuery Angular\\nAbstracts the DOM Yes Yes\\nAJAX Support Yes Yes\\nDeclarative Dat\", \"a Binding No Yes\\nMVC-style Routing No Yes\\n38 CHAPTER 5 | Common client-side web technologiesFactor j\", \"Query Angular\\nTemplating No Yes\\nDeep-Link Routing No Yes\\nMost of the features jQuery lacks intrinsic\", \"ally can be added with the addition of other libraries.\\nHowever, a SPA framework like Angular provid\", \"es these features in a more integrated fashion, since it\\u2019s\\nbeen designed with all of them in mind fr\", \"om the start. Also, jQuery is an imperative library, meaning\\nthat you need to call jQuery functions \", \"in order to do anything with jQuery. Much of the work and\\nfunctionality that SPA frameworks provide \", \"can be done declaratively, requiring no actual code to be\\nwritten.\\nData binding is a great example o\", \"f this functionality. In jQuery, it usually only takes one line of code to\\nget the value of a DOM el\", \"ement or to set an element\\u2019s value. However, you have to write this code\\nanytime you need to change \", \"the value of the element, and sometimes this will occur in multiple\\nfunctions on a page. Another com\", \"mon example is element visibility. In jQuery, there might be many\\ndifferent places where you\\u2019d write\", \" code to control whether certain elements were visible. In each of\\nthese cases, when using data bind\", \"ing, no code would need to be written. You\\u2019d simply bind the value\\nor visibility of the elements in \", \"question to a viewmodel on the page, and changes to that viewmodel\\nwould automatically be reflected \", \"in the bound elements.\\nAngular SPAs\\nAngular remains one of the world\\u2019s most popular JavaScript frame\", \"works. Since Angular 2, the team\\nrebuilt the framework from the ground up (using TypeScript) and reb\", \"randed from the original\\nAngularJS name to Angular. Now several years old, the redesigned Angular co\", \"ntinues to be a robust\\nframework for building Single Page Applications.\\nAngular applications are bui\", \"lt from components. Components combine HTML templates with special\\nobjects and control a portion of \", \"the page. A simple component from Angular\\u2019s docs is shown here:\\nimport { Component } from '@angular/\", \"core';\\n@Component({\\nselector: 'my-app',\\ntemplate: `<h1>Hello {{name}}</h1>`\\n})\\nexport class AppCompo\", \"nent { name = 'Angular'; }\\nComponents are defined using the @Component decorator function, which tak\", \"es in metadata about\\nthe component. The selector property identifies the ID of the element on the pa\", \"ge where this\\ncomponent will be displayed. The template property is a simple HTML template that incl\", \"udes a\\nplaceholder that corresponds to the component\\u2019s name property, defined on the last line.\\nBy w\", \"orking with components and templates, instead of DOM elements, Angular apps can operate at a\\nhigher \", \"level of abstraction and with less overall code than apps written using just JavaScript (also\\ncalled\", \" \\u201cvanilla JS\\u201d) or with jQuery. Angular also imposes some order on how you organize your client-\\nside\", \" script files. By convention, Angular apps use a common folder structure, with module and\\n39 CHAPTER\", \" 5 | Common client-side web technologiescomponent script files located in an app folder. Angular scr\", \"ipts concerned with building, deploying,\\nand testing the app are typically located in a higher-level\", \" folder.\\nYou can develop Angular apps by using a CLI. Getting started with Angular development local\", \"ly\\n(assuming you already have git and npm installed) consists of simply cloning a repo from GitHub a\", \"nd\\nrunning npm install and npm start. Beyond this, Angular ships its own CLI, which can create proje\", \"cts,\\nadd files, and assist with testing, bundling, and deployment tasks. This CLI friendliness makes\", \" Angular\\nespecially compatible with ASP.NET Core, which also features great CLI support.\\nMicrosoft h\", \"as developed a reference application, eShopOnContainers, which includes an Angular SPA\\nimplementatio\", \"n. This app includes Angular modules to manage the online store\\u2019s shopping basket,\\nload and display \", \"items from its catalog, and handling order creation. You can view and download the\\nsample applicatio\", \"n from GitHub.\\nReact\\nUnlike Angular, which offers a full Model-View-Controller pattern implementatio\", \"n, React is only\\nconcerned with views. It\\u2019s not a framework, just a library, so to build a SPA you\\u2019l\", \"l need to leverage\\nadditional libraries. There are a number of libraries that are designed to be use\", \"d with React to\\nproduce rich single page applications.\\nOne of React\\u2019s most important features is its\", \" use of a virtual DOM. The virtual DOM provides React\\nwith several advantages, including performance\", \" (the virtual DOM can optimize which parts of the\\nactual DOM need to be updated) and testability (no\", \" need to have a browser to test React and its\\ninteractions with its virtual DOM).\\nReact is also unus\", \"ual in how it works with HTML. Rather than having a strict separation between code\\nand markup (with \", \"references to JavaScript appearing in HTML attributes perhaps), React adds HTML\\ndirectly within its \", \"JavaScript code as JSX. JSX is HTML-like syntax that can compile down to pure\\nJavaScript. For exampl\", \"e:\\n<ul>\\n{ authors.map(author =>\\n<li key={author.id}>{author.name}</li>\\n)}\\n</ul>\\nIf you already know \", \"JavaScript, learning React should be easy. There isn\\u2019t nearly as much learning\\ncurve or special synt\", \"ax involved as with Angular or other popular libraries.\\nBecause React isn\\u2019t a full framework, you\\u2019ll\", \" typically want other libraries to handle things like routing,\\nweb API calls, and dependency managem\", \"ent. The nice thing is, you can pick the best library for each\\nof these, but the disadvantage is tha\", \"t you need to make all of these decisions and verify all of your\\nchosen libraries work well together\", \" when you\\u2019re done. If you want a good starting point, you can use\\na starter kit like React Slingshot\", \", which prepackages a set of compatible libraries together with React.\\nVue\\nFrom its getting started \", \"guide, \\u201cVue is a progressive framework for building user interfaces. Unlike\\nother monolithic framewo\", \"rks, Vue is designed from the ground up to be incrementally adoptable. The\\n40 CHAPTER 5 | Common cli\", \"ent-side web technologiescore library is focused on the view layer only, and is easy to pick up and \", \"integrate with other libraries\\nor existing projects. On the other hand, Vue is perfectly capable of \", \"powering sophisticated Single-\\nPage Applications when used in combination with modern tooling and su\", \"pporting libraries.\\u201d\\nGetting started with Vue simply requires including its script within an HTML fi\", \"le:\\n<!-- development version, includes helpful console warnings -->\\n<script src=\\\"https://cdn.jsdeliv\", \"r.net/npm/vue/dist/vue.js\\\"></script>\\nWith the framework added, you\\u2019re then able to declaratively ren\", \"der data to the DOM using\\nVue\\u2019s straightforward templating syntax:\\n<div id=\\\"app\\\">\\n{{ message }}\\n</di\", \"v>\\nand then adding the following script:\\nvar app = new Vue({\\nel: '#app',\\ndata: {\\nmessage: 'Hello Vue\", \"!'\\n}\\n})\\nThis is enough to render \\\"Hello Vue!\\\" on the page. Note, however, that Vue isn\\u2019t simply rend\", \"ering the\\nmessage to the div once. It supports databinding and dynamic updates such that if the valu\", \"e of\\nmessage changes, the value in the <div> is immediately updated to reflect it.\\nOf course, this o\", \"nly scratches the surface of what Vue is capable of. It\\u2019s gained a great deal of\\npopularity in the l\", \"ast several years and has a large community. There\\u2019s a huge and growing list of\\nsupporting component\", \"s and libraries that work with Vue to extend it as well. If you\\u2019re looking to add\\nclient-side behavi\", \"or to your web application or considering building a full SPA, Vue is worth\\ninvestigating.\\nBlazor We\", \"bAssembly\\nUnlike other JavaScript frameworks, Blazor WebAssembly is a single-page app (SPA) framewor\", \"k for\\nbuilding interactive client-side web apps with .NET. Blazor WebAssembly uses open web standard\", \"s\\nwithout plugins or recompiling code into other languages. Blazor WebAssembly works in all modern\\nw\", \"eb browsers, including mobile browsers.\\nRunning .NET code inside web browsers is made possible by We\", \"bAssembly (abbreviated wasm).\\nWebAssembly is a compact bytecode format optimized for fast download a\", \"nd maximum execution\\nspeed. WebAssembly is an open web standard and is supported in web browsers wit\", \"hout plugins.\\nWebAssembly code can access the full functionality of the browser via JavaScript, call\", \"ed JavaScript\\ninteroperability, often shortened to JavaScript interop or JS interop. .NET code execu\", \"ted via\\nWebAssembly in the browser runs in the browser\\u2019s JavaScript sandbox with the protections tha\", \"t the\\nsandbox provides against malicious actions on the client machine.\\nFor more information, see In\", \"troduction to ASP.NET Core Blazor.\\nChoosing a SPA Framework\\nWhen considering which option will work \", \"best to support your SPA, keep in mind the following\\nconsiderations:\\n41 CHAPTER 5 | Common client-si\", \"de web technologies\\u2022 Is your team familiar with the framework and its dependencies (including TypeSc\", \"ript in some\\ncases)?\\n\\u2022 How opinionated is the framework, and do you agree with its default way of do\", \"ing things?\\n\\u2022 Does it (or a companion library) include all of the features your app requires?\\n\\u2022 Is i\", \"t well documented?\\n\\u2022 How active is its community? Are new projects being built with it?\\n\\u2022 How active\", \" is its core team? Are issues being resolved and new versions shipped regularly?\\nFrameworks continue\", \" to evolve with breakneck speed. Use the considerations listed above to help\\nmitigate the risk of ch\", \"oosing a framework you\\u2019ll later regret being dependent upon. If you\\u2019re\\nparticularly risk-averse, con\", \"sider a framework that offers commercial support and/or is being\\ndeveloped by a large enterprise.\\nRe\", \"ferences \\u2013 Client Web Technologies\\n\\u2022 HTML and CSS\\nhttps://www.w3.org/standards/webdesign/htmlcss\\n\\u2022 S\", \"ass vs. LESS\\nhttps://www.keycdn.com/blog/sass-vs-less/\\n\\u2022 Styling ASP.NET Core Apps with LESS, Sass, \", \"and Font Awesome\\nhttps://learn.microsoft.com/aspnet/core/client-side/less-sass-fa\\n\\u2022 Client-Side Deve\", \"lopment in ASP.NET Core\\nhttps://learn.microsoft.com/aspnet/core/client-side/\\n\\u2022 jQuery\\nhttps://jquery\", \".com/\\n\\u2022 Angular\\nhttps://angular.io/\\n\\u2022 React\\nhttps://reactjs.org/\\n\\u2022 Vue\\nhttps://vuejs.org/\\n\\u2022 Angular \", \"vs React vs Vue: Which Framework to Choose in 2020\\nhttps://www.codeinwp.com/blog/angular-vs-vue-vs-r\", \"eact/\\n\\u2022 The Top JavaScript Frameworks for Front-End Development in 2020\\nhttps://www.freecodecamp.org\", \"/news/complete-guide-for-front-end-developers-javascript-\\nframeworks-2019/\\n42 CHAPTER 5 | Common cli\", \"ent-side web technologies6\\nCHAPTER\\nDevelop ASP.NET Core\\nMVC apps\\n\\u201cIt\\u2019s not important to get it right\", \" the first time. It\\u2019s vitally important to get it right the last time.\\u201d -\\nAndrew Hunt and David Thom\", \"as\\nASP.NET Core is a cross-platform, open-source framework for building modern cloud-optimized web\\na\", \"pplications. ASP.NET Core apps are lightweight and modular, with built-in support for dependency\\ninj\", \"ection, enabling greater testability and maintainability. Combined with MVC, which supports\\nbuilding\", \" modern web APIs in addition to view-based apps, ASP.NET Core is a powerful framework\\nwith which to \", \"build enterprise web applications.\\nMVC and Razor Pages\\nASP.NET Core MVC offers many features that ar\", \"e useful for building web-based APIs and apps. The\\nterm MVC stands for \\u201cModel-View-Controller\\u201d, a UI\", \" pattern that breaks up the responsibilities of\\nresponding to user requests into several parts. In a\", \"ddition to following this pattern, you can also\\nimplement features in your ASP.NET Core apps as Razo\", \"r Pages.\\nRazor Pages are built into ASP.NET Core MVC, and use the same features for routing, model b\", \"inding,\\nfilters, authorization, etc. However, instead of having separate folders and files for Contr\", \"ollers, Models,\\nViews, etc. and using attribute-based routing, Razor Pages are placed in a single fo\", \"lder (\\u201c/Pages\\u201d),\\nroute based on their relative location in this folder, and handle requests with han\", \"dlers instead of\\ncontroller actions. As a result, when working with Razor Pages, all of the files an\", \"d classes you need are\\ntypically colocated, not spread throughout the web project.\\nLearn more about \", \"how MVC, Razor Pages, and related patterns are applied in the eShopOnWeb\\nsample application.\\nWhen yo\", \"u create a new ASP.NET Core App, you should have a plan in mind for the kind of app you\\nwant to buil\", \"d. When creating a new project, in your IDE or using the dotnet new CLI command, you\\nwill choose fro\", \"m several templates. The most common project templates are Empty, Web API, Web\\nApp, and Web App (Mod\", \"el-View-Controller). Although you can only make this decision when you first\\ncreate a project, it\\u2019s \", \"not an irrevocable decision. The Web API project uses standard Model-View-\\nController controllers \\u2013 \", \"it just lacks Views by default. Likewise, the default Web App template uses\\nRazor Pages, and so also\", \" lacks a Views folder. You can add a Views folder to these projects later to\\nsupport view-based beha\", \"vior. Web API and Model-View-Controller projects don\\u2019t include a Pages\\n43 CHAPTER 6 | Develop ASP.NE\", \"T Core MVC appsfolder by default, but you can add one later to support Razor Pages-based behavior. Y\", \"ou can think of\\nthese three templates as supporting three different kinds of default user interactio\", \"n: data (web API),\\npage-based, and view-based. However, you can mix and match any or all of these te\", \"mplates within a\\nsingle project if you wish.\\nWhy Razor Pages?\\nRazor Pages is the default approach fo\", \"r new web applications in Visual Studio. Razor Pages offers a\\nsimpler way of building page-based app\", \"lication features, such as non-SPA forms. Using controllers\\nand views, it was common for application\", \"s to have very large controllers that worked with many\\ndifferent dependencies and view models and re\", \"turned many different views. This resulted in more\\ncomplexity and often resulted in controllers that\", \" didn\\u2019t follow the Single Responsibility Principle or\\nOpen/Closed Principles effectively. Razor Page\", \"s addresses this issue by encapsulating the server-side\\nlogic for a given logical \\u201cpage\\u201d in a web ap\", \"plication with its Razor markup. A Razor Page that has no\\nserver-side logic can only consist of a Ra\", \"zor file (for instance, \\u201cIndex.cshtml\\u201d). However, most non-\\ntrivial Razor Pages will have an associa\", \"ted page model class, which by convention is named the same\\nas the Razor file with a \\u201c.cs\\u201d extension\", \" (for example, \\u201cIndex.cshtml.cs\\u201d).\\nA Razor Page\\u2019s page model combines the responsibilities of an MVC\", \" controller and a viewmodel.\\nInstead of handling requests with controller action methods, page model\", \" handlers like \\u201cOnGet()\\u201d are\\nexecuted, rendering their associated page by default. Razor Pages simpl\", \"ifies the process of building\\nindividual pages in an ASP.NET Core app, while still providing all the\", \" architectural features of ASP.NET\\nCore MVC. They\\u2019re a good default choice for new page-based functi\", \"onality.\\nWhen to use MVC\\nIf you\\u2019re building web APIs, the MVC pattern makes more sense than trying t\", \"o use Razor Pages. If your\\nproject will only expose web API endpoints, you should ideally start from\", \" the Web API project\\ntemplate. Otherwise, it\\u2019s easy to add controllers and associated API endpoints \", \"to any ASP.NET Core\\napp. Use the view-based MVC approach if you\\u2019re migrating an existing application\", \" from ASP.NET MVC\\n5 or earlier to ASP.NET Core MVC and you want to do so with the least amount of ef\", \"fort. Once you\\u2019ve\\nmade the initial migration, you can evaluate whether it makes sense to adopt Razor\", \" Pages for new\\nfeatures or even as a wholesale migration. For more information about porting .NET 4.\", \"x apps to .NET\\n8, see Porting Existing ASP.NET Apps to ASP.NET Core eBook.\\nWhether you choose to bui\", \"ld your web app using Razor Pages or MVC views, your app will have\\nsimilar performance and will incl\", \"ude support for dependency injection, filters, model binding,\\nvalidation, and so on.\\nMapping request\", \"s to responses\\nAt its heart, ASP.NET Core apps map incoming requests to outgoing responses. At a low\", \" level, this\\nmapping is done with middleware, and simple ASP.NET Core apps and microservices may be\\n\", \"comprised solely of custom middleware. When using ASP.NET Core MVC, you can work at a\\nsomewhat highe\", \"r level, thinking in terms of routes, controllers, and actions. Each incoming request is\\ncompared wi\", \"th the application\\u2019s routing table, and if a matching route is found, the associated action\\n44 CHAPT\", \"ER 6 | Develop ASP.NET Core MVC appsmethod (belonging to a controller) is called to handle the reque\", \"st. If no matching route is found, an\\nerror handler (in this case, returning a NotFound result) is c\", \"alled.\\nASP.NET Core MVC apps can use conventional routes, attribute routes, or both. Conventional ro\", \"utes\\nare defined in code, specifying routing conventions using syntax like in the example below:\\napp\", \".UseEndpoints(endpoints =>\\n{\\nendpoints.MapControllerRoute(name: \\\"default\\\", pattern:\\n\\\"{controller=Hom\", \"e}/{action=Index}/{id?}\\\");\\n});\\nIn this example, a route named \\u201cdefault\\u201d has been added to the routin\", \"g table. It defines a route\\ntemplate with placeholders for controller, action, and id. The controlle\", \"r and action placeholders have\\nthe default specified (Home and Index, respectively), and the id plac\", \"eholder is optional (by virtue of a\\n\\u201c?\\u201d applied to it). The convention defined here states that the \", \"first part of a request should correspond\\nto the name of the controller, the second part to the acti\", \"on, and then if necessary a third part will\\nrepresent an ID parameter. Conventional routes are typic\", \"ally defined in one place for the application,\\nsuch as in Program.cs where the request middleware pi\", \"peline is configured.\\nAttribute routes are applied to controllers and actions directly, rather than \", \"specified globally. This\\napproach has the advantage of making them much more discoverable when you\\u2019r\", \"e looking at a\\nparticular method, but does mean that routing information is not kept in one place in\", \" the application.\\nWith attribute routes, you can easily specify multiple routes for a given action, \", \"as well as combine\\nroutes between controllers and actions. For example:\\n[Route(\\\"Home\\\")]\\npublic class\", \" HomeController : Controller\\n{\\n[Route(\\\"\\\")] // Combines to define the route template \\\"Home\\\"\\n[Route(\\\"I\", \"ndex\\\")] // Combines to define route template \\\"Home/Index\\\"\\n[Route(\\\"/\\\")] // Does not combine, defines \", \"the route template \\\"\\\"\\npublic IActionResult Index() {}\\n}\\nRoutes can be specified on [HttpGet] and sim\", \"ilar attributes, avoiding the need to add separate [Route]\\nattributes. Attribute routes can also use\", \" tokens to reduce the need to repeat controller or action\\nnames, as shown below:\\n[Route(\\\"[controller\", \"]\\\")]\\npublic class ProductsController : Controller\\n{\\n[Route(\\\"\\\")] // Matches 'Products'\\n[Route(\\\"Index\\\"\", \")] // Matches 'Products/Index'\\npublic IActionResult Index() {}\\n}\\nRazor Pages don\\u2019t use attribute rou\", \"ting. You can specify additional route template information for a\\nRazor Page as part of its @page di\", \"rective:\\n@page \\\"{id:int}\\\"\\n45 CHAPTER 6 | Develop ASP.NET Core MVC appsIn the previous example, the p\", \"age in question would match a route with an integer id parameter. For\\nexample, the Products.cshtml p\", \"age located in the root of /Pages would respond to requests like this\\none:\\n/Products/123\\nOnce a give\", \"n request has been matched to a route, but before the action method is called, ASP.NET\\nCore MVC will\", \" perform model binding and model validation on the request. Model binding is\\nresponsible for convert\", \"ing incoming HTTP data into the .NET types specified as parameters of the\\naction method to be called\", \". For example, if the action method expects an int id parameter, model\\nbinding will attempt to provi\", \"de this parameter from a value provided as part of the request. To do so,\\nmodel binding looks for va\", \"lues in a posted form, values in the route itself, and query string values.\\nAssuming an id value is \", \"found, it will be converted to an integer before being passed into the action\\nmethod.\\nAfter binding \", \"the model but before calling the action method, model validation occurs. Model\\nvalidation uses optio\", \"nal attributes on the model type, and can help ensure that the provided model\\nobject conforms to cer\", \"tain data requirements. Certain values may be specified as required, or limited\\nto a certain length \", \"or numeric range, etc. If validation attributes are specified but the model does not\\nconform to thei\", \"r requirements, the property ModelState.IsValid will be false, and the set of failing\\nvalidation rul\", \"es will be available to send to the client making the request.\\nIf you\\u2019re using model validation, you\", \" should be sure to always check that the model is valid before\\nperforming any state-altering command\", \"s, to ensure your app is not corrupted by invalid data. You can\\nuse a filter to avoid the need to ad\", \"d code for this validation in every action. ASP.NET Core MVC filters\\noffer a way of intercepting gro\", \"ups of requests, so that common policies and cross-cutting concerns\\ncan be applied on a targeted bas\", \"is. Filters can be applied to individual actions, whole controllers, or\\nglobally for an application.\", \"\\nFor web APIs, ASP.NET Core MVC supports content negotiation, allowing requests to specify how\\nrespo\", \"nses should be formatted. Based on headers provided in the request, actions returning data will\\nform\", \"at the response in XML, JSON, or another supported format. This feature enables the same API to\\nbe u\", \"sed by multiple clients with different data format requirements.\\nWeb API projects should consider us\", \"ing the [ApiController] attribute, which can be applied to\\nindividual controllers, to a base control\", \"ler class, or to the entire assembly. This attribute adds\\nautomatic model validation checking and an\", \"y action with an invalid model will return a BadRequest\\nwith the details of the validation errors. T\", \"he attribute also requires all actions have an attribute route,\\nrather than using a conventional rou\", \"te, and returns more detailed ProblemDetails information in\\nresponse to errors.\\nKeeping controllers \", \"under control\\nFor page-based applications, Razor Pages do a great job of keeping controllers from ge\", \"tting too\\nlarge. Each individual page is given its own files and classes dedicated just to its handl\", \"er(s). Prior to\\nthe introduction of Razor Pages, many view-centric applications would have large con\", \"troller classes\\nresponsible for many different actions and views. These classes would naturally grow\", \" to have many\\nresponsibilities and dependencies, making them harder to maintain. If you find your vi\", \"ew-based\\n46 CHAPTER 6 | Develop ASP.NET Core MVC appscontrollers are growing too large, consider ref\", \"actoring them to use Razor Pages, or introducing a\\npattern like a mediator.\\nThe mediator design patt\", \"ern is used to reduce coupling between classes while allowing\\ncommunication between them. In ASP.NET\", \" Core MVC applications, this pattern is frequently employed\\nto break up controllers into smaller pie\", \"ces by using handlers to do the work of action methods. The\\npopular MediatR NuGet package is often u\", \"sed to accomplish this. Typically, controllers include many\\ndifferent action methods, each of which \", \"may require certain dependencies. The set of all\\ndependencies required by any action must be passed \", \"into the controller\\u2019s constructor. When using\\nMediatR, the only dependency a controller will typical\", \"ly have is an instance of the mediator. Each\\naction then uses the mediator instance to send a messag\", \"e, which is processed by a handler. The\\nhandler is specific to a single action and thus only needs t\", \"he dependencies required by that action. An\\nexample of a controller using MediatR is shown here:\\npub\", \"lic class OrderController : Controller\\n{\\nprivate readonly IMediator _mediator;\\npublic OrderControlle\", \"r(IMediator mediator)\\n{\\n_mediator = mediator;\\n}\\n[HttpGet]\\npublic async Task<IActionResult> MyOrders(\", \")\\n{\\nvar viewModel = await _mediator.Send(new GetMyOrders(User.Identity.Name));\\nreturn View(viewModel\", \");\\n}\\n// other actions implemented similarly\\n}\\nIn the MyOrders action, the call to Send a GetMyOrders\", \" message is handled by this class:\\npublic class GetMyOrdersHandler : IRequestHandler<GetMyOrders, IE\", \"numerable<OrderViewModel>>\\n{\\nprivate readonly IOrderRepository _orderRepository;\\npublic GetMyOrdersH\", \"andler(IOrderRepository orderRepository)\\n{\\n_orderRepository = orderRepository;\\n}\\npublic async Task<I\", \"Enumerable<OrderViewModel>> Handle(GetMyOrders request,\\nCancellationToken cancellationToken)\\n{\\nvar s\", \"pecification = new CustomerOrdersWithItemsSpecification(request.UserName);\\nvar orders = await _order\", \"Repository.ListAsync(specification);\\nreturn orders.Select(o => new OrderViewModel\\n{\\nOrderDate = o.Or\", \"derDate,\\nOrderItems = o.OrderItems?.Select(oi => new OrderItemViewModel()\\n{\\nPictureUrl = oi.ItemOrde\", \"red.PictureUri,\\nProductId = oi.ItemOrdered.CatalogItemId,\\nProductName = oi.ItemOrdered.ProductName,\\n\", \"UnitPrice = oi.UnitPrice,\\nUnits = oi.Units\\n47 CHAPTER 6 | Develop ASP.NET Core MVC apps}).ToList(),\\n\", \"OrderNumber = o.Id,\\nShippingAddress = o.ShipToAddress,\\nTotal = o.Total()\\n});\\n}\\n}\\nThe end result of t\", \"his approach is for controllers to be much smaller and focused primarily on routing\\nand model bindin\", \"g, while individual handlers are responsible for the specific tasks needed by a given\\nendpoint. This\", \" approach can also be achieved without MediatR by using the ApiEndpoints NuGet\\npackage, which attemp\", \"ts to bring to API controllers the same benefits Razor Pages brings to view-\\nbased controllers.\\nRefe\", \"rences \\u2013 Mapping Requests to Responses\\n\\u2022 Routing to Controller Actions\\nhttps://learn.microsoft.com/a\", \"spnet/core/mvc/controllers/routing\\n\\u2022 Model Binding\\nhttps://learn.microsoft.com/aspnet/core/mvc/model\", \"s/model-binding\\n\\u2022 Model Validation\\nhttps://learn.microsoft.com/aspnet/core/mvc/models/validation\\n\\u2022 F\", \"ilters\\nhttps://learn.microsoft.com/aspnet/core/mvc/controllers/filters\\n\\u2022 ApiController Attribute\\nhtt\", \"ps://learn.microsoft.com/aspnet/core/web-api/\\nWorking with dependencies\\nASP.NET Core has built-in su\", \"pport for and internally makes use of a technique known as dependency\\ninjection. Dependency injectio\", \"n is a technique that enables loose coupling between different parts of\\nan application. Looser coupl\", \"ing is desirable because it makes it easier to isolate parts of the\\napplication, allowing for testin\", \"g or replacement. It also makes it less likely that a change in one part of\\nthe application will hav\", \"e an unexpected impact somewhere else in the application. Dependency\\ninjection is based on the depen\", \"dency inversion principle, and is often key to achieving the\\nopen/closed principle. When evaluating \", \"how your application works with its dependencies, beware of\\nthe static cling code smell, and remembe\", \"r the aphorism \\u201cnew is glue.\\u201d\\nStatic cling occurs when your classes make calls to static methods, or\", \" access static properties, which\\nhave side effects or dependencies on infrastructure. For example, i\", \"f you have a method that calls a\\nstatic method, which in turn writes to a database, your method is t\", \"ightly coupled to the database.\\nAnything that breaks that database call will break your method. Test\", \"ing such methods is notoriously\\ndifficult, since such tests either require commercial mocking librar\", \"ies to mock the static calls, or can\\nonly be tested with a test database in place. Static calls that\", \" don\\u2019t have any dependence on\\ninfrastructure, especially those calls that are completely stateless, \", \"are fine to call and have no impact\\non coupling or testability (beyond coupling code to the static c\", \"all itself).\\n48 CHAPTER 6 | Develop ASP.NET Core MVC appsMany developers understand the risks of sta\", \"tic cling and global state, but will still tightly couple their\\ncode to specific implementations thr\", \"ough direct instantiation. \\u201cNew is glue\\u201d is meant to be a reminder\\nof this coupling, and not a gener\", \"al condemnation of the use of the new keyword. Just as with static\\nmethod calls, new instances of ty\", \"pes that have no external dependencies typically do not tightly\\ncouple code to implementation detail\", \"s or make testing more difficult. But each time a class is\\ninstantiated, take just a brief moment to\", \" consider whether it makes sense to hard-code that specific\\ninstance in that particular location, or\", \" if it would be a better design to request that instance as a\\ndependency.\\nDeclare your dependencies\\n\", \"ASP.NET Core is built around having methods and classes declare their dependencies, requesting\\nthem \", \"as arguments. ASP.NET applications are typically set up in Program.cs or in a Startup class.\\nNote\\nCo\", \"nfiguring apps completely in Program.cs is the default approach for .NET 6 (and later) and Visual\\nSt\", \"udio 2022 apps. Project templates have been updated to help you get started with this new\\napproach. \", \"ASP.NET Core projects can still use a Startup class, if desired.\\nConfigure services in Program.cs\\nFo\", \"r very simple apps, you can wire up dependencies directly in Program.cs file using a\\nWebApplicationB\", \"uilder. Once all needed services have been added, the builder is used to create the\\napp.\\nvar builder\", \" = WebApplication.CreateBuilder(args);\\n// Add services to the container.\\nbuilder.Services.AddRazorPa\", \"ges();\\nvar app = builder.Build();\\nConfigure services in Startup.cs\\nThe Startup.cs is itself configur\", \"ed to support dependency injection at several points. If you\\u2019re using a\\nStartup class, you can give \", \"it a constructor and it can request dependencies through it, like so:\\npublic class Startup\\n{\\npublic \", \"Startup(IHostingEnvironment env)\\n{\\nvar builder = new ConfigurationBuilder()\\n.SetBasePath(env.Content\", \"RootPath)\\n.AddJsonFile(\\\"appsettings.json\\\", optional: false, reloadOnChange: true)\\n.AddJsonFile($\\\"app\", \"settings.{env.EnvironmentName}.json\\\", optional: true);\\n}\\n}\\nThe Startup class is interesting in that \", \"there are no explicit type requirements for it. It doesn\\u2019t inherit\\nfrom a special Startup base class\", \", nor does it implement any particular interface. You can give it a\\nconstructor, or not, and you can\", \" specify as many parameters on the constructor as you want. When\\n49 CHAPTER 6 | Develop ASP.NET Core\", \" MVC appsthe web host you\\u2019ve configured for your application starts, it will call the Startup class \", \"(if you\\u2019ve told it\\nto use one), and will use dependency injection to populate any dependencies the S\", \"tartup class\\nrequires. Of course, if you request parameters that aren\\u2019t configured in the services c\", \"ontainer used by\\nASP.NET Core, you\\u2019ll get an exception, but as long as you stick to dependencies the\", \" container knows\\nabout, you can request anything you want.\\nDependency injection is built into your A\", \"SP.NET Core apps right from the start, when you create the\\nStartup instance. It doesn\\u2019t stop there f\", \"or the Startup class. You can also request dependencies in the\\nConfigure method:\\npublic void Configu\", \"re(IApplicationBuilder app,\\nIHostingEnvironment env,\\nILoggerFactory loggerFactory)\\n{\\n}\\nThe Configure\", \"Services method is the exception to this behavior; it must take just one parameter of\\ntype IServiceC\", \"ollection. It doesn\\u2019t really need to support dependency injection, since on the one hand\\nit is respo\", \"nsible for adding objects to the services container, and on the other it has access to all\\ncurrently\", \" configured services via the IServiceCollection parameter. Thus, you can work with\\ndependencies defi\", \"ned in the ASP.NET Core services collection in every part of the Startup class, either\\nby requesting\", \" the needed service as a parameter or by working with the IServiceCollection in\\nConfigureServices.\\nN\", \"ote\\nIf you need to ensure certain services are available to your Startup class, you can configure th\", \"em using\\nan IWebHostBuilder and its ConfigureServices method inside the CreateDefaultBuilder call.\\nT\", \"he Startup class is a model for how you should structure other parts of your ASP.NET Core\\napplicatio\", \"n, from Controllers to Middleware to Filters to your own Services. In each case, you should\\nfollow t\", \"he Explicit Dependencies Principle, requesting your dependencies rather than directly creating\\nthem,\", \" and leveraging dependency injection throughout your application. Be careful of where and how\\nyou di\", \"rectly instantiate implementations, especially services and objects that work with infrastructure\\nor\", \" have side effects. Prefer working with abstractions defined in your application core and passed in \", \"as\\narguments to hardcoding references to specific implementation types.\\nStructuring the application\\n\", \"Monolithic applications typically have a single entry point. In the case of an ASP.NET Core web\\nappl\", \"ication, the entry point will be the ASP.NET Core web project. However, that doesn\\u2019t mean the\\nsoluti\", \"on should consist of just a single project. It\\u2019s useful to break up the application into different\\nl\", \"ayers in order to follow separation of concerns. Once broken up into layers, it\\u2019s helpful to go beyo\", \"nd\\nfolders to separate projects, which can help achieve better encapsulation. The best approach to\\na\", \"chieve these goals with an ASP.NET Core application is a variation of the Clean Architecture\\ndiscuss\", \"ed in chapter 5. Following this approach, the application\\u2019s solution will comprise separate\\nlibrarie\", \"s for the UI, Infrastructure, and ApplicationCore.\\n50 CHAPTER 6 | Develop ASP.NET Core MVC appsIn ad\", \"dition to these projects, separate test projects are included as well (Testing is discussed in\\nChapt\", \"er 9).\\nThe application\\u2019s object model and interfaces should be placed in the ApplicationCore project\", \". This\\nproject will have as few dependencies as possible (and none on specific infrastructure concer\", \"ns), and\\nthe other projects in the solution will reference it. Business entities that need to be per\", \"sisted are\\ndefined in the ApplicationCore project, as are services that do not directly depend on in\", \"frastructure.\\nImplementation details, such as how persistence is performed or how notifications migh\", \"t be sent to a\\nuser, are kept in the Infrastructure project. This project will reference implementat\", \"ion-specific\\npackages such as Entity Framework Core, but should not expose details about these imple\", \"mentations\\noutside of the project. Infrastructure services and repositories should implement interfa\", \"ces that are\\ndefined in the ApplicationCore project, and its persistence implementations are respons\", \"ible for\\nretrieving and storing entities defined in ApplicationCore.\\nThe ASP.NET Core UI project is \", \"responsible for any UI level concerns, but should not include business\\nlogic or infrastructure detai\", \"ls. In fact, ideally it shouldn\\u2019t even have a dependency on the Infrastructure\\nproject, which will h\", \"elp ensure no dependency between the two projects is introduced accidentally.\\nThis can be achieved u\", \"sing a third-party DI container like Autofac, which allows you to define DI rules\\nin Module classes \", \"in each project.\\nAnother approach to decoupling the application from implementation details is to ha\", \"ve the\\napplication call microservices, perhaps deployed in individual Docker containers. This provid\", \"es even\\ngreater separation of concerns and decoupling than leveraging DI between two projects, but h\", \"as\\nadditional complexity.\\nFeature organization\\nBy default, ASP.NET Core applications organize their \", \"folder structure to include Controllers and Views,\\nand frequently ViewModels. Client-side code to su\", \"pport these server-side structures is typically stored\\nseparately in the wwwroot folder. However, la\", \"rge applications may encounter problems with this\\norganization, since working on any given feature o\", \"ften requires jumping between these folders. This\\ngets more and more difficult as the number of file\", \"s and subfolders in each folder grows, resulting in a\\ngreat deal of scrolling through Solution Explo\", \"rer. One solution to this problem is to organize\\napplication code by feature instead of by file type\", \". This organizational style is typically referred to as\\nfeature folders or feature slices (see also:\", \" Vertical Slices).\\nASP.NET Core MVC supports Areas for this purpose. Using areas, you can create sep\", \"arate sets of\\nControllers and Views folders (as well as any associated models) in each Area folder. \", \"Figure 7-1 shows\\nan example folder structure, using Areas.\\n51 CHAPTER 6 | Develop ASP.NET Core MVC a\", \"ppsFigure 7-1. Sample Area Organization\\nWhen using Areas, you must use attributes to decorate your c\", \"ontrollers with the name of the area to\\nwhich they belong:\\n[Area(\\\"Catalog\\\")]\\npublic class HomeContro\", \"ller\\n{}\\nYou also need to add area support to your routes:\\napp.UseEndpoints(endpoints =>\\n{\\nendpoints.\", \"MapControllerRoute(name: \\\"areaRoute\\\", pattern:\\n\\\"{area:exists}/{controller=Home}/{action=Index}/{id?}\", \"\\\");\\nendpoints.MapControllerRoute(name: \\\"default\\\", pattern:\\n\\\"{controller=Home}/{action=Index}/{id?}\\\")\", \";\\n});\\nIn addition to the built-in support for Areas, you can also use your own folder structure, and\", \"\\nconventions in place of attributes and custom routes. This would allow you to have feature folders\\n\", \"that didn\\u2019t include separate folders for Views, Controllers, etc., keeping the hierarchy flatter and\", \"\\nmaking it easier to see all related files in a single place for each feature. For APIs, folders can\", \" be used\\nto replace controllers, and each folder can contain all of the API Endpoints and their asso\", \"ciated DTOs.\\n52 CHAPTER 6 | Develop ASP.NET Core MVC appsASP.NET Core uses built-in convention types\", \" to control its behavior. You can modify or replace these\\nconventions. For example, you can create a\", \" convention that will automatically get the feature name\\nfor a given controller based on its namespa\", \"ce (which typically correlates to the folder in which the\\ncontroller is located):\\npublic class Featu\", \"reConvention : IControllerModelConvention\\n{\\npublic void Apply(ControllerModel controller)\\n{\\ncontroll\", \"er.Properties.Add(\\\"feature\\\",\\nGetFeatureName(controller.ControllerType));\\n}\\nprivate string GetFeature\", \"Name(TypeInfo controllerType)\\n{\\nstring[] tokens = controllerType.FullName.Split('.');\\nif (!tokens.An\", \"y(t => t == \\\"Features\\\")) return \\\"\\\";\\nstring featureName = tokens\\n.SkipWhile(t => !t.Equals(\\\"features\\\"\", \",\\nStringComparison.CurrentCultureIgnoreCase))\\n.Skip(1)\\n.Take(1)\\n.FirstOrDefault();\\nreturn featureNam\", \"e;\\n}\\n}\\nYou then specify this convention as an option when you add support for MVC to your applicatio\", \"n in\\nConfigureServices (or in Program.cs):\\n// ConfigureServices\\nservices.AddMvc(o => o.Conventions.A\", \"dd(new FeatureConvention()));\\n// Program.cs\\nbuilder.Services.AddMvc(o => o.Conventions.Add(new Featu\", \"reConvention()));\\nASP.NET Core MVC also uses a convention to locate views. You can override it with \", \"a custom\\nconvention so that views will be located in your feature folders (using the feature name pr\", \"ovided by\\nthe FeatureConvention, above). You can learn more about this approach and download a worki\", \"ng\\nsample from the MSDN Magazine article, Feature Slices for ASP.NET Core MVC.\\nAPIs and Blazor appli\", \"cations\\nIf your application includes a set of web APIs, which must be secured, these APIs should ide\", \"ally be\\nconfigured as a separate project from your View or Razor Pages application. Separating APIs,\", \"\\nespecially public APIs, from your server-side web application has a number of benefits. These\\nappli\", \"cations often will have unique deployment and load characteristics. They\\u2019re also very likely to\\nadop\", \"t different mechanisms for security, with standard form-based applications leveraging cookie-\\nbased \", \"authentication and APIs most likely using token-based authentication.\\nAdditionally, Blazor applicati\", \"ons, whether using Blazor Server or Blazor WebAssembly, should be built\\nas separate projects. The ap\", \"plications have different runtime characteristics as well as security models.\\nThey\\u2019re likely to shar\", \"e common types with the server-side web application (or API project), and these\\ntypes should be defi\", \"ned in a common shared project.\\n53 CHAPTER 6 | Develop ASP.NET Core MVC appsThe addition of a Blazor\", \" WebAssembly admin interface to eShopOnWeb required adding several new\\nprojects. The Blazor WebAssem\", \"bly project itself, BlazorAdmin. A new set of public API endpoints, used\\nby BlazorAdmin and configur\", \"ed to use token-based authentication, is defined in the PublicApi project.\\nAnd certain shared types \", \"used by both of these projects are kept in a new BlazorShared project.\\nOne might ask, why add a sepa\", \"rate BlazorShared project when there is already a common\\nApplicationCore project that could be used \", \"to share any types required by both PublicApi and\\nBlazorAdmin? The answer is that this project inclu\", \"des all of the application\\u2019s business logic and is thus\\nmuch larger than necessary and also much mor\", \"e likely to need to be kept secure on the server.\\nRemember that any library referenced by BlazorAdmi\", \"n will be downloaded to users\\u2019 browsers when\\nthey load the Blazor application.\\nDepending on whether \", \"one is using the Backends-For-Frontends (BFF) pattern, the APIs consumed by\\nthe Blazor WebAssembly a\", \"pp may not share their types 100% with Blazor. In particular, a public API\\nthat\\u2019s meant to be consum\", \"ed by many different clients may define its own request and result types,\\nrather than sharing them i\", \"n a client-specific shared project. In the eShopOnWeb sample, the\\nassumption is being made that the \", \"PublicApi project is, in fact, hosting a public API, so not all of its\\nrequest and response types co\", \"me from the BlazorShared project.\\nCross-cutting concerns\\nAs applications grow, it becomes increasing\", \"ly important to factor out cross-cutting concerns to\\neliminate duplication and maintain consistency.\", \" Some examples of cross-cutting concerns in ASP.NET\\nCore applications are authentication, model vali\", \"dation rules, output caching, and error handling,\\nthough there are many others. ASP.NET Core MVC fil\", \"ters allow you to run code before or after certain\\nsteps in the request processing pipeline. For ins\", \"tance, a filter can run before and after model binding,\\nbefore and after an action, or before and af\", \"ter an action\\u2019s result. You can also use an authorization\\nfilter to control access to the rest of th\", \"e pipeline. Figures 7-2 shows how request execution flows\\nthrough filters, if configured.\\n54 CHAPTER\", \" 6 | Develop ASP.NET Core MVC appsFigure 7-2. Request execution through filters and request pipeline\", \".\\nFilters are usually implemented as attributes, so you can apply them to controllers or actions (or\", \" even\\nglobally). When added in this fashion, filters specified at the action level override or build\", \" upon filters\\nspecified at the controller level, which themselves override global filters. For examp\", \"le, the [Route]\\nattribute can be used to build up routes between controllers and actions. Likewise, \", \"authorization can\\nbe configured at the controller level, and then overridden by individual actions, \", \"as the following\\nsample demonstrates:\\n[Authorize]\\npublic class AccountController : Controller\\n{\\n[All\", \"owAnonymous] // overrides the Authorize attribute\\npublic async Task<IActionResult> Login() {}\\npublic\", \" async Task<IActionResult> ForgotPassword() {}\\n}\\nThe first method, Login, uses the [AllowAnonymous] \", \"filter (attribute) to override the Authorize filter\\nset at the controller level. The ForgotPassword \", \"action (and any other action in the class that doesn\\u2019t\\nhave an AllowAnonymous attribute) will requir\", \"e an authenticated request.\\nFilters can be used to eliminate duplication in the form of common error\", \" handling policies for APIs.\\nFor example, a typical API policy is to return a NotFound response to r\", \"equests referencing keys that\\ndo not exist, and a BadRequest response if model validation fails. The\", \" following example\\ndemonstrates these two policies in action:\\n[HttpPut(\\\"{id}\\\")]\\npublic async Task<IA\", \"ctionResult> Put(int id, [FromBody]Author author)\\n{\\n55 CHAPTER 6 | Develop ASP.NET Core MVC appsif (\", \"(await _authorRepository.ListAsync()).All(a => a.Id != id))\\n{\\nreturn NotFound(id);\\n}\\nif (!ModelState\", \".IsValid)\\n{\\nreturn BadRequest(ModelState);\\n}\\nauthor.Id = id;\\nawait _authorRepository.UpdateAsync(aut\", \"hor);\\nreturn Ok();\\n}\\nDon\\u2019t allow your action methods to become cluttered with conditional code like \", \"this. Instead, pull the\\npolicies into filters that can be applied on an as-needed basis. In this exa\", \"mple, the model validation\\ncheck, which should occur anytime a command is sent to the API, can be re\", \"placed by the following\\nattribute:\\npublic class ValidateModelAttribute : ActionFilterAttribute\\n{\\npub\", \"lic override void OnActionExecuting(ActionExecutingContext context)\\n{\\nif (!context.ModelState.IsVali\", \"d)\\n{\\ncontext.Result = new BadRequestObjectResult(context.ModelState);\\n}\\n}\\n}\\nYou can add the Validate\", \"ModelAttribute to your project as a NuGet dependency by including the\\nArdalis.ValidateModel package.\", \" For APIs, you can use the ApiController attribute to enforce this\\nbehavior without the need for a s\", \"eparate ValidateModel filter.\\nLikewise, a filter can be used to check if a record exists and return \", \"a 404 before the action is executed,\\neliminating the need to perform these checks in the action. Onc\", \"e you\\u2019ve pulled out common\\nconventions and organized your solution to separate infrastructure code a\", \"nd business logic from your\\nUI, your MVC action methods should be extremely thin:\\n[HttpPut(\\\"{id}\\\")]\\n\", \"[ValidateAuthorExists]\\npublic async Task<IActionResult> Put(int id, [FromBody]Author author)\\n{\\nawait\", \" _authorRepository.UpdateAsync(author);\\nreturn Ok();\\n}\\nYou can read more about implementing filters \", \"and download a working sample from the MSDN\\nMagazine article, Real-World ASP.NET Core MVC Filters.\\nI\", \"f you find that you have a number of common responses from APIs based on common scenarios like\\nvalid\", \"ation errors (Bad Request), resource not found, and server errors, you might consider using a\\nresult\", \" abstraction. The result abstraction would be returned by services consumed by API endpoints,\\nand th\", \"e controller action or endpoint would use a filter to translate these into IActionResults.\\n56 CHAPTE\", \"R 6 | Develop ASP.NET Core MVC appsReferences \\u2013 Structuring applications\\n\\u2022 Areas\\nhttps://learn.micro\", \"soft.com/aspnet/core/mvc/controllers/areas\\n\\u2022 MSDN Magazine \\u2013 Feature Slices for ASP.NET Core MVC\\nhtt\", \"ps://learn.microsoft.com/archive/msdn-magazine/2016/september/asp-net-core-feature-\\nslices-for-asp-n\", \"et-core-mvc\\n\\u2022 Filters\\nhttps://learn.microsoft.com/aspnet/core/mvc/controllers/filters\\n\\u2022 MSDN Magazin\", \"e \\u2013 Real World ASP.NET Core MVC Filters\\nhttps://learn.microsoft.com/archive/msdn-magazine/2016/augus\", \"t/asp-net-core-real-world-\\nasp-net-core-mvc-filters\\n\\u2022 Result in eShopOnWeb\\nhttps://github.com/dotnet\", \"-architecture/eShopOnWeb/wiki/Patterns#result\\nSecurity\\nSecuring web applications is a large topic, w\", \"ith many considerations. At its most basic level, security\\ninvolves ensuring you know who a given re\", \"quest is coming from, and then ensuring that the request\\nonly has access to resources it should. Aut\", \"hentication is the process of comparing credentials\\nprovided with a request to those in a trusted da\", \"ta store, to see if the request should be treated as\\ncoming from a known entity. Authorization is th\", \"e process of restricting access to certain resources\\nbased on user identity. A third security concer\", \"n is protecting requests from eavesdropping by third\\nparties, for which you should at least ensure t\", \"hat SSL is used by your application.\\nIdentity\\nASP.NET Core Identity is a membership system you can u\", \"se to support login functionality for your\\napplication. It has support for local user accounts as we\", \"ll as external login provider support from\\nproviders like Microsoft Account, Twitter, Facebook, Goog\", \"le, and more. In addition to ASP.NET Core\\nIdentity, your application can use windows authentication,\", \" or a third-party identity provider like\\nIdentity Server.\\nASP.NET Core Identity is included in new p\", \"roject templates if the Individual User Accounts option is\\nselected. This template includes support \", \"for registration, login, external logins, forgotten passwords,\\nand additional functionality.\\n57 CHAP\", \"TER 6 | Develop ASP.NET Core MVC appsFigure 7-3. Select Individual User Accounts to have Identity pr\", \"econfigured.\\nIdentity support is configured in Program.cs or Startup, and includes configuring servi\", \"ces as well as\\nmiddleware.\\nConfigure Identity in Program.cs\\nIn Program.cs, you configure services fr\", \"om the WebHostBuilder instance, and then once the app is\\ncreated, you configure its middleware. The \", \"key points to note are the call to AddDefaultIdentity for\\nrequired services and the UseAuthenticatio\", \"n and UseAuthorization calls which add required\\nmiddleware.\\nvar builder = WebApplication.CreateBuild\", \"er(args);\\n// Add services to the container.\\nvar connectionString = builder.Configuration.GetConnecti\", \"onString(\\\"DefaultConnection\\\");\\nbuilder.Services.AddDbContext<ApplicationDbContext>(options =>\\noption\", \"s.UseSqlServer(connectionString));\\nbuilder.Services.AddDatabaseDeveloperPageExceptionFilter();\\nbuild\", \"er.Services.AddDefaultIdentity<IdentityUser>(options =>\\noptions.SignIn.RequireConfirmedAccount = tru\", \"e)\\n.AddEntityFrameworkStores<ApplicationDbContext>();\\nbuilder.Services.AddRazorPages();\\nvar app = bu\", \"ilder.Build();\\n// Configure the HTTP request pipeline.\\nif (app.Environment.IsDevelopment())\\n58 CHAPT\", \"ER 6 | Develop ASP.NET Core MVC apps{\\napp.UseMigrationsEndPoint();\\n}\\nelse\\n{\\napp.UseExceptionHandler(\", \"\\\"/Error\\\");\\n// The default HSTS value is 30 days. You may want to change this for production\\nscenario\", \"s, see https://aka.ms/aspnetcore-hsts.\\napp.UseHsts();\\n}\\napp.UseHttpsRedirection();\\napp.UseStaticFile\", \"s();\\napp.UseRouting();\\napp.UseAuthentication();\\napp.UseAuthorization();\\napp.MapRazorPages();\\napp.Run\", \"();\\nConfiguring Identity in app startup\\n// Add framework services.\\nbuilder.Services.AddDbContext<App\", \"licationDbContext>(options =>\\noptions.UseSqlServer(Configuration.GetConnectionString(\\\"DefaultConnect\", \"ion\\\")));\\nbuilder.Services.AddIdentity<ApplicationUser, IdentityRole>()\\n.AddEntityFrameworkStores<App\", \"licationDbContext>()\\n.AddDefaultTokenProviders();\\nbuilder.Services.AddMvc();\\nvar app = builder.Build\", \"();\\nif (app.Environment.IsDevelopment())\\n{\\napp.UseMigrationsEndPoint();\\n}\\nelse\\n{\\napp.UseExceptionHan\", \"dler(\\\"/Error\\\");\\napp.UseHsts();\\n}\\napp.UseHttpsRedirection();\\napp.UseStaticFiles();\\napp.UseRouting();\\n\", \"app.UseAuthentication();\\napp.UseAuthorization();\\napp.MapRazorPages();\\nIt\\u2019s important that UseAuthent\", \"ication and UseAuthorization appear before MapRazorPages. When\\nconfiguring Identity services, you\\u2019ll\", \" notice a call to AddDefaultTokenProviders. This has nothing to do\\nwith tokens that may be used to s\", \"ecure web communications, but instead refers to providers that\\ncreate prompts that can be sent to us\", \"ers via SMS or email in order for them to confirm their identity.\\n59 CHAPTER 6 | Develop ASP.NET Cor\", \"e MVC appsYou can learn more about configuring two-factor authentication and enabling external login\", \" providers\\nfrom the official ASP.NET Core docs.\\nAuthentication\\nAuthentication is the process of dete\", \"rmining who is accessing the system. If you\\u2019re using ASP.NET\\nCore Identity and the configuration met\", \"hods shown in the previous section, it will automatically\\nconfigure some authentication defaults in \", \"the application. However, you can also configure these\\ndefaults manually, or override the ones set b\", \"y AddIdentity. If you\\u2019re using Identity, it configures\\ncookie-based authentication as the default sc\", \"heme.\\nIn web-based authentication, there are typically up to five actions that may be performed in t\", \"he\\ncourse of authenticating a client of a system. These are:\\n\\u2022 Authenticate. Use the information pro\", \"vided by the client to create an identity for them to use\\nwithin the application.\\n\\u2022 Challenge. This \", \"action is used to require the client to identify themselves.\\n\\u2022 Forbid. Inform the client they are fo\", \"rbidden from performing an action.\\n\\u2022 Sign-in. Persist the existing client in some way.\\n\\u2022 Sign-out. R\", \"emove the client from persistence.\\nThere are a number of common techniques for performing authentica\", \"tion in web applications. These\\nare referred to as schemes. A given scheme will define actions for s\", \"ome or all of the above options.\\nSome schemes only support a subset of actions, and may require a se\", \"parate scheme to perform those\\nit does not support. For example, the OpenId-Connect (OIDC) scheme do\", \"esn\\u2019t support Sign-in or\\nSign-out, but is commonly configured to use Cookie authentication for this \", \"persistence.\\nIn your ASP.NET Core application, you can configure a DefaultAuthenticateScheme as well\", \" as optional\\nspecific schemes for each of the actions described above. For example, DefaultChallenge\", \"Scheme,\\nDefaultForbidScheme, etc. Calling AddIdentity<TUser,TRole> configures a number of aspects of\", \" the\\napplication and adds many required services. It also includes this call to configure the authen\", \"tication\\nscheme:\\nbuilder.Services.AddAuthentication(options =>\\n{\\noptions.DefaultAuthenticateScheme =\", \" IdentityConstants.ApplicationScheme;\\noptions.DefaultChallengeScheme = IdentityConstants.Application\", \"Scheme;\\noptions.DefaultSignInScheme = IdentityConstants.ExternalScheme;\\n});\\nThese schemes use cookie\", \"s for persistence and redirection to login pages for authentication by\\ndefault. These schemes are ap\", \"propriate for web applications that interact with users via web browsers,\\nbut not recommended for AP\", \"Is. Instead, APIs will typically use another form of authentication, such as\\nJWT bearer tokens.\\nWeb \", \"APIs are consumed by code, such as HttpClient in .NET applications and equivalent types in other\\nfra\", \"meworks. These clients expect a usable response from an API call, or a status code indicating what,\\n\", \"if any, problem has occurred. These clients are not interacting through a browser and do not render \", \"or\\ninteract with any HTML that an API might return. Thus, it is not appropriate for API endpoints to\", \"\\nredirect their clients to login pages if they are not authenticated. Another scheme is more appropr\", \"iate.\\n60 CHAPTER 6 | Develop ASP.NET Core MVC appsTo configure authentication for APIs, you might se\", \"t up authentication like the following, used by the\\nPublicApi project in the eShopOnWeb reference ap\", \"plication:\\nbuilder.Services\\n.AddAuthentication(config =>\\n{\\nconfig.DefaultScheme = JwtBearerDefaults.\", \"AuthenticationScheme;\\n})\\n.AddJwtBearer(config =>\\n{\\nconfig.RequireHttpsMetadata = false;\\nconfig.SaveT\", \"oken = true;\\nconfig.TokenValidationParameters = new TokenValidationParameters\\n{\\nValidateIssuerSignin\", \"gKey = true,\\nIssuerSigningKey = new SymmetricSecurityKey(key),\\nValidateIssuer = false,\\nValidateAudie\", \"nce = false\\n};\\n});\\nWhile it is possible to configure multiple different authentication schemes withi\", \"n a single project, it is\\nmuch simpler to configure a single default scheme. For this reason, among \", \"others, the eShopOnWeb\\nreference application separates its APIs into their own project, PublicApi, s\", \"eparate from the main Web\\nproject that includes the application\\u2019s views and Razor Pages.\\nAuthenticat\", \"ion in Blazor apps\\nBlazor Server applications can leverage the same authentication features as any o\", \"ther ASP.NET Core\\napplication. Blazor WebAssembly applications cannot use the built-in Identity and \", \"Authentication\\nproviders, however, since they run in the browser. Blazor WebAssembly applications ca\", \"n store user\\nauthentication status locally and can access claims to determine what actions users sho\", \"uld be able to\\nperform. However, all authentication and authorization checks should be performed on \", \"the server\\nregardless of any logic implemented inside the Blazor WebAssembly app, since users can ea\", \"sily\\nbypass the app and interact with the APIs directly.\\nReferences \\u2013 Authentication\\n\\u2022 Authenticatio\", \"n Actions and Defaults\\nhttps://stackoverflow.com/a/52493428\\n\\u2022 Authentication and Authorization for S\", \"PAs\\nhttps://learn.microsoft.com/aspnet/core/security/authentication/identity-api-authorization\\n\\u2022 ASP\", \".NET Core Blazor Authentication and Authorization\\nhttps://learn.microsoft.com/aspnet/core/blazor/sec\", \"urity/\\n\\u2022 Security: Authentication and Authorization in ASP.NET Web Forms and Blazor\\nhttps://learn.mi\", \"crosoft.com/dotnet/architecture/blazor-for-web-forms-developers/security-\\nauthentication-authorizati\", \"on\\nAuthorization\\nThe simplest form of authorization involves restricting access to anonymous users. \", \"This functionality\\ncan be achieved by applying the [Authorize] attribute to certain controllers or a\", \"ctions. If roles are\\n61 CHAPTER 6 | Develop ASP.NET Core MVC appsbeing used, the attribute can be fu\", \"rther extended to restrict access to users who belong to certain\\nroles, as shown:\\n[Authorize(Roles =\", \" \\\"HRManager,Finance\\\")]\\npublic class SalaryController : Controller\\n{\\n}\\nIn this case, users belonging \", \"to either the HRManager or Finance roles (or both) would have access to\\nthe SalaryController. To req\", \"uire that a user belong to multiple roles (not just one of several), you can\\napply the attribute mul\", \"tiple times, specifying a required role each time.\\nSpecifying certain sets of roles as strings in ma\", \"ny different controllers and actions can lead to\\nundesirable repetition. At a minimum, define consta\", \"nts for these string literals and use the constants\\nanywhere you need to specify the string. You can\", \" also configure authorization policies, which\\nencapsulate authorization rules, and then specify the \", \"policy instead of individual roles when applying\\nthe [Authorize] attribute:\\n[Authorize(Policy = \\\"Can\", \"ViewPrivateReport\\\")]\\npublic IActionResult ExecutiveSalaryReport()\\n{\\nreturn View();\\n}\\nUsing policies \", \"in this way, you can separate the kinds of actions being restricted from the specific roles\\nor rules\", \" that apply to it. Later, if you create a new role that needs to have access to certain resources,\\ny\", \"ou can just update a policy, rather than updating every list of roles on every [Authorize] attribute\", \".\\nClaims\\nClaims are name value pairs that represent properties of an authenticated user. For example\", \", you\\nmight store users\\u2019 employee number as a claim. Claims can then be used as part of authorizatio\", \"n\\npolicies. You could create a policy called \\u201cEmployeeOnly\\u201d that requires the existence of a claim c\", \"alled\\n\\\"EmployeeNumber\\\", as shown in this example:\\npublic void ConfigureServices(IServiceCollection s\", \"ervices)\\n{\\nservices.AddMvc();\\nservices.AddAuthorization(options =>\\n{\\noptions.AddPolicy(\\\"EmployeeOnly\", \"\\\", policy => policy.RequireClaim(\\\"EmployeeNumber\\\"));\\n});\\n}\\nThis policy could then be used with the [\", \"Authorize] attribute to protect any controller and/or action,\\nas described above.\\nSecuring web APIs\\n\", \"Most web APIs should implement a token-based authentication system. Token authentication is\\nstateles\", \"s and designed to be scalable. In a token-based authentication system, the client must first\\nauthent\", \"icate with the authentication provider. If successful, the client is issued a token, which is simply\", \"\\n62 CHAPTER 6 | Develop ASP.NET Core MVC appsa cryptographically meaningful string of characters. Th\", \"e most common format for tokens is JSON Web\\nToken, or JWT (often pronounced \\u201cjot\\u201d). When the client \", \"then needs to issue a request to an API, it\\nadds this token as a header on the request. The server t\", \"hen validates the token found in the request\\nheader before completing the request. Figure 7-4 demons\", \"trates this process.\\nFigure 7-4. Token-based authentication for Web APIs.\\nYou can create your own au\", \"thentication service, integrate with Azure AD and OAuth, or implement a\\nservice using an open-source\", \" tool like IdentityServer.\\nJWT tokens can embed claims about the user, which can be read on the clie\", \"nt or server. You can use a\\ntool like jwt.io to view the contents of a JWT token. Do not store sensi\", \"tive data like passwords or keys\\nin JTW tokens, since their contents are easily read.\\nWhen using JWT\", \" tokens with SPA or Blazor WebAssembly applications, you must store the token\\nsomewhere on the clien\", \"t and then add it to every API call. This activity is typically done as a header, as\\nthe following c\", \"ode demonstrates:\\n// AuthService.cs in BlazorAdmin project of eShopOnWeb\\nprivate async Task SetAutho\", \"rizationHeader()\\n{\\nvar token = await GetToken();\\n_httpClient.DefaultRequestHeaders.Authorization = n\", \"ew\\nAuthenticationHeaderValue(\\\"Bearer\\\", token);\\n}\\nAfter calling the above method, requests made with \", \"the _httpClient will have the token embedded in\\nthe request\\u2019s headers, allowing the server-side API \", \"to authenticate and authorize the request.\\n63 CHAPTER 6 | Develop ASP.NET Core MVC appsCustom Securi\", \"ty\\nCaution\\nAs a general rule, avoid implementing your own custom security implementations.\\nBe especi\", \"ally careful about \\u201crolling your own\\u201d implementation of cryptography, user membership, or\\ntoken gene\", \"ration system. There are many commercial and open-source alternatives available, which\\nwill almost c\", \"ertainly have better security than a custom implementation.\\nReferences \\u2013 Security\\n\\u2022 Security Docs Ov\", \"erview\\nhttps://learn.microsoft.com/aspnet/core/security/\\n\\u2022 Enforcing SSL in an ASP.NET Core App\\nhttp\", \"s://learn.microsoft.com/aspnet/core/security/enforcing-ssl\\n\\u2022 Introduction to Identity\\nhttps://learn.\", \"microsoft.com/aspnet/core/security/authentication/identity\\n\\u2022 Introduction to Authorization\\nhttps://l\", \"earn.microsoft.com/aspnet/core/security/authorization/introduction\\n\\u2022 Authentication and Authorizatio\", \"n for API Apps in Azure App Service\\nhttps://learn.microsoft.com/azure/app-service-api/app-service-ap\", \"i-authentication\\n\\u2022 Identity Server\\nhttps://github.com/IdentityServer\\nClient communication\\nIn additio\", \"n to serving pages and responding to requests for data via web APIs, ASP.NET Core apps can\\ncommunica\", \"te directly with connected clients. This outbound communication can use a variety of\\ntransport techn\", \"ologies, the most common being WebSockets. ASP.NET Core SignalR is a library that\\nmakes it simple to\", \" add real-time server-to-client communication functionality to your applications.\\nSignalR supports a\", \" variety of transport technologies, including WebSockets, and abstracts away many\\nof the implementat\", \"ion details from the developer.\\nReal-time client communication, whether using WebSockets directly or\", \" other techniques, are useful in\\na variety of application scenarios. Some examples include:\\n\\u2022 Live c\", \"hat room applications\\n\\u2022 Monitoring applications\\n\\u2022 Job progress updates\\n\\u2022 Notifications\\n\\u2022 Interactive\", \" forms applications\\nWhen building client communication into your applications, there are typically t\", \"wo components:\\n64 CHAPTER 6 | Develop ASP.NET Core MVC apps\\u2022 Server-side connection manager (SignalR\", \" Hub, WebSocketManager WebSocketHandler)\\n\\u2022 Client-side library\\nClients aren\\u2019t limited to browsers \\u2013 \", \"mobile apps, console apps, and other native apps can also\\ncommunicate using SignalR/WebSockets. The \", \"following simple program echoes all content sent to a\\nchat application to the console, as part of a \", \"WebSocketManager sample application:\\npublic class Program\\n{\\nprivate static Connection _connection;\\np\", \"ublic static void Main(string[] args)\\n{\\nStartConnectionAsync();\\n_connection.On(\\\"receiveMessage\\\", (ar\", \"guments) =>\\n{\\nConsole.WriteLine($\\\"{arguments[0]} said: {arguments[1]}\\\");\\n});\\nConsole.ReadLine();\\nSto\", \"pConnectionAsync();\\n}\\npublic static async Task StartConnectionAsync()\\n{\\n_connection = new Connection\", \"();\\nawait _connection.StartConnectionAsync(\\\"ws://localhost:65110/chat\\\");\\n}\\npublic static async Task \", \"StopConnectionAsync()\\n{\\nawait _connection.StopConnectionAsync();\\n}\\n}\\nConsider ways in which your app\", \"lications communicate directly with client applications, and consider\\nwhether real-time communicatio\", \"n would improve your app\\u2019s user experience.\\nReferences \\u2013 Client Communication\\n\\u2022 ASP.NET Core SignalR\", \"\\nhttps://github.com/dotnet/aspnetcore/tree/main/src/SignalR\\n\\u2022 WebSocket Manager\\nhttps://github.com/r\", \"adu-matei/websocket-manager\\nDomain-driven design \\u2013 Should you apply it?\\nDomain-Driven Design (DDD) i\", \"s an agile approach to building software that emphasizes focusing on\\nthe business domain. It places \", \"a heavy emphasis on communication and interaction with business\\ndomain expert(s) who can relate to t\", \"he developers how the real-world system works. For example, if\\nyou\\u2019re building a system that handles\", \" stock trades, your domain expert might be an experienced stock\\nbroker. DDD is designed to address l\", \"arge, complex business problems, and is often not appropriate\\nfor smaller, simpler applications, as \", \"the investment in understanding and modeling the domain is not\\nworth it.\\n65 CHAPTER 6 | Develop ASP.\", \"NET Core MVC appsWhen building software following a DDD approach, your team (including non-technical\", \" stakeholders\\nand contributors) should develop a ubiquitous language for the problem space. That is,\", \" the same\\nterminology should be used for the real-world concept being modeled, the software equivale\", \"nt, and\\nany structures that might exist to persist the concept (for example, database tables). Thus,\", \" the\\nconcepts described in the ubiquitous language should form the basis for your domain model.\\nYour\", \" domain model comprises objects that interact with one another to represent the behavior of the\\nsyst\", \"em. These objects may fall into the following categories:\\n\\u2022 Entities, which represent objects with a\", \" thread of identity. Entities are typically stored in\\npersistence with a key by which they can later\", \" be retrieved.\\n\\u2022 Aggregates, which represent groups of objects that should be persisted as a unit.\\n\\u2022\", \" Value objects, which represent concepts that can be compared on the basis of the sum of\\ntheir prope\", \"rty values. For example, DateRange consisting of a start and end date.\\n\\u2022 Domain events, which repres\", \"ent things happening within the system that are of interest to\\nother parts of the system.\\nA DDD doma\", \"in model should encapsulate complex behavior within the model. Entities, in particular,\\nshould not m\", \"erely be collections of properties. When the domain model lacks behavior and merely\\nrepresents the s\", \"tate of the system, it is said to be an anemic model, which is undesirable in DDD.\\nIn addition to th\", \"ese model types, DDD typically employs a variety of patterns:\\n\\u2022 Repository, for abstracting persiste\", \"nce details.\\n\\u2022 Factory, for encapsulating complex object creation.\\n\\u2022 Services, for encapsulating com\", \"plex behavior and/or infrastructure implementation details.\\n\\u2022 Command, for decoupling issuing comman\", \"ds and executing the command itself.\\n\\u2022 Specification, for encapsulating query details.\\nDDD also reco\", \"mmends the use of the Clean Architecture discussed previously, allowing for loose\\ncoupling, encapsul\", \"ation, and code that can easily be verified using unit tests.\\nWhen should you apply DDD\\nDDD is well \", \"suited to large applications with significant business (not just technical) complexity. The\\napplicat\", \"ion should require the knowledge of domain experts. There should be significant behavior in\\nthe doma\", \"in model itself, representing business rules and interactions beyond simply storing and\\nretrieving t\", \"he current state of various records from data stores.\\nWhen shouldn\\u2019t you apply DDD\\nDDD involves inve\", \"stments in modeling, architecture, and communication that may not be warranted\\nfor smaller applicati\", \"ons or applications that are essentially just CRUD (create/read/update/delete). If\\nyou choose to app\", \"roach your application following DDD, but find that your domain has an anemic\\nmodel with no behavior\", \", you may need to rethink your approach. Either your application may not\\n66 CHAPTER 6 | Develop ASP.\", \"NET Core MVC appsneed DDD, or you may need assistance refactoring your application to encapsulate bu\", \"siness logic in\\nthe domain model, rather than in your database or user interface.\\nA hybrid approach \", \"would be to only use DDD for the transactional or more complex areas of the\\napplication, but not for\", \" simpler CRUD or read-only portions of the application. For instance, you don\\u2019t\\nneed the constraints\", \" of an Aggregate if you\\u2019re querying data to display a report or to visualize data\\nfor a dashboard. I\", \"t\\u2019s perfectly acceptable to have a separate, simpler read model for such\\nrequirements.\\nReferences \\u2013 \", \"Domain-Driven Design\\n\\u2022 DDD in Plain English (StackOverflow Answer)\\nhttps://stackoverflow.com/questio\", \"ns/1222392/can-someone-explain-domain-driven-design-\\nddd-in-plain-english-please/1222488#1222488\\nDep\", \"loyment\\nThere are a few steps involved in the process of deploying your ASP.NET Core application, re\", \"gardless\\nof where it will be hosted. The first step is to publish the application, which can be done\", \" using the\\ndotnet publish CLI command. This step will compile the application and place all of the f\", \"iles needed to\\nrun the application into a designated folder. When you deploy from Visual Studio, thi\", \"s step is\\nperformed for you automatically. The publish folder contains .exe and .dll files for the a\", \"pplication and\\nits dependencies. A self-contained application will also include a version of the .NE\", \"T runtime. ASP.NET\\nCore applications will also include configuration files, static client assets, an\", \"d MVC views.\\nASP.NET Core applications are console applications that must be started when the server\", \" boots and\\nrestarted if the application (or server) crashes. A process manager can be used to automa\", \"te this\\nprocess. The most common process managers for ASP.NET Core are Nginx and Apache on Linux and\", \"\\nIIS or Windows Service on Windows.\\nIn addition to a process manager, ASP.NET Core applications may \", \"use a reverse proxy server. A\\nreverse proxy server receives HTTP requests from the Internet and forw\", \"ards them to Kestrel after\\nsome preliminary handling. Reverse proxy servers provide a layer of secur\", \"ity for the application.\\nKestrel also doesn\\u2019t support hosting multiple applications on the same port\", \", so techniques like host\\nheaders cannot be used with it to enable hosting multiple applications on \", \"the same port and IP\\naddress.\\nFigure 7-5. ASP.NET hosted in Kestrel behind a reverse proxy server\\nAn\", \"other scenario in which a reverse proxy can be helpful is to secure multiple applications using\\nSSL/\", \"HTTPS. In this case, only the reverse proxy would need to have SSL configured. Communication\\nbetween\", \" the reverse proxy server and Kestrel could take place over HTTP, as shown in Figure 7-6.\\n67 CHAPTER\", \" 6 | Develop ASP.NET Core MVC appsFigure 7-6. ASP.NET hosted behind an HTTPS-secured reverse proxy s\", \"erver\\nAn increasingly popular approach is to host your ASP.NET Core application in a Docker containe\", \"r,\\nwhich then can be hosted locally or deployed to Azure for cloud-based hosting. The Docker contain\", \"er\\ncould contain your application code, running on Kestrel, and would be deployed behind a reverse\\np\", \"roxy server, as shown above.\\nIf you\\u2019re hosting your application on Azure, you can use Microsoft Azur\", \"e Application Gateway as a\\ndedicated virtual appliance to provide several services. In addition to a\", \"cting as a reverse proxy for\\nindividual applications, Application Gateway can also offer the followi\", \"ng features:\\n\\u2022 HTTP load balancing\\n\\u2022 SSL offload (SSL only to Internet)\\n\\u2022 End to End SSL\\n\\u2022 Multi-sit\", \"e routing (consolidate up to 20 sites on a single Application Gateway)\\n\\u2022 Web application firewall\\n\\u2022 \", \"Websocket support\\n\\u2022 Advanced diagnostics\\nLearn more about Azure deployment options in Chapter 10.\\nRe\", \"ferences \\u2013 Deployment\\n\\u2022 Hosting and Deployment Overview\\nhttps://learn.microsoft.com/aspnet/core/publ\", \"ishing/\\n\\u2022 When to use Kestrel with a reverse proxy\\nhttps://learn.microsoft.com/aspnet/core/fundament\", \"als/servers/kestrel#when-to-use-kestrel-\\nwith-a-reverse-proxy\\n\\u2022 Host ASP.NET Core apps in Docker\\nhtt\", \"ps://learn.microsoft.com/aspnet/core/publishing/docker\\n\\u2022 Introducing Azure Application Gateway\\nhttps\", \"://learn.microsoft.com/azure/application-gateway/application-gateway-introduction\\n68 CHAPTER 6 | Dev\", \"elop ASP.NET Core MVC apps7\\nCHAPTER\\nWorking with Data in\\nASP.NET Core Apps\\n\\u201cData is a precious thing\", \" and will last longer than the systems themselves.\\u201d\\nTim Berners-Lee\\nData access is an important part\", \" of almost any software application. ASP.NET Core supports various\\ndata access options, including En\", \"tity Framework Core (and Entity Framework 6 as well), and can work\\nwith any .NET data access framewo\", \"rk. The choice of which data access framework to use depends on\\nthe application\\u2019s needs. Abstracting\", \" these choices from the ApplicationCore and UI projects, and\\nencapsulating implementation details in\", \" Infrastructure, helps to produce loosely coupled, testable\\nsoftware.\\nEntity Framework Core (for rel\", \"ational databases)\\nIf you\\u2019re writing a new ASP.NET Core application that needs to work with relation\", \"al data, then Entity\\nFramework Core (EF Core) is the recommended way for your application to access \", \"its data. EF Core is\\nan object-relational mapper (O/RM) that enables .NET developers to persist obje\", \"cts to and from a\\ndata source. It eliminates the need for most of the data access code developers wo\", \"uld typically need\\nto write. Like ASP.NET Core, EF Core has been rewritten from the ground up to sup\", \"port modular\\ncross-platform applications. You add it to your application as a NuGet package, configu\", \"re it during\\napp startup, and request it through dependency injection wherever you need it.\\nTo use E\", \"F Core with a SQL Server database, run the following dotnet CLI command:\\ndotnet add package Microsof\", \"t.EntityFrameworkCore.SqlServer\\nTo add support for an InMemory data source, for testing:\\ndotnet add \", \"package Microsoft.EntityFrameworkCore.InMemory\\nThe DbContext\\nTo work with EF Core, you need a subcla\", \"ss of DbContext. This class holds properties representing\\ncollections of the entities your applicati\", \"on will work with. The eShopOnWeb sample includes a\\nCatalogContext with collections for items, brand\", \"s, and types:\\n69 CHAPTER 7 | Working with Data in ASP.NET Core Appspublic class CatalogContext : DbC\", \"ontext\\n{\\npublic CatalogContext(DbContextOptions<CatalogContext> options) : base(options)\\n{\\n}\\npublic \", \"DbSet<CatalogItem> CatalogItems { get; set; }\\npublic DbSet<CatalogBrand> CatalogBrands { get; set; }\", \"\\npublic DbSet<CatalogType> CatalogTypes { get; set; }\\n}\\nYour DbContext must have a constructor that \", \"accepts DbContextOptions and pass this argument to\\nthe base DbContext constructor. If you have only \", \"one DbContext in your application, you can pass an\\ninstance of DbContextOptions, but if you have mor\", \"e than one you must use the generic\\nDbContextOptions<T> type, passing in your DbContext type as the \", \"generic parameter.\\nConfiguring EF Core\\nIn your ASP.NET Core application, you\\u2019ll typically configure \", \"EF Core in Program.cs with your\\napplication\\u2019s other dependencies. EF Core uses a DbContextOptionsBui\", \"lder, which supports several\\nhelpful extension methods to streamline its configuration. To configure\", \" CatalogContext to use a SQL\\nServer database with a connection string defined in Configuration, you \", \"would add the following code:\\nbuilder.Services.AddDbContext<CatalogContext>(\\noptions => options.UseS\", \"qlServer(\\nbuilder.Configuration.GetConnectionString(\\\"DefaultConnection\\\")));\\nTo use the in-memory dat\", \"abase:\\nbuilder.Services.AddDbContext<CatalogContext>(options =>\\noptions.UseInMemoryDatabase());\\nOnce\", \" you have installed EF Core, created a DbContext child type, and added the type to the\\napplication\\u2019s\", \" services, you are ready to use EF Core. You can request an instance of your DbContext\\ntype in any s\", \"ervice that needs it and start working with your persisted entities using LINQ as if they\\nwere simpl\", \"y in a collection. EF Core does the work of translating your LINQ expressions into SQL\\nqueries to st\", \"ore and retrieve your data.\\nYou can see the queries EF Core is executing by configuring a logger and\", \" ensuring its level is set to at\\nleast Information, as shown in Figure 8-1.\\n70 CHAPTER 7 | Working w\", \"ith Data in ASP.NET Core AppsFigure 8-1. Logging EF Core queries to the console\\nFetching and storing\", \" Data\\nTo retrieve data from EF Core, you access the appropriate property and use LINQ to filter the \", \"result.\\nYou can also use LINQ to perform projection, transforming the result from one type to anothe\", \"r. The\\nfollowing example would retrieve CatalogBrands, ordered by name, filtered by their Enabled pr\", \"operty,\\nand projected onto a SelectListItem type:\\nvar brandItems = await _context.CatalogBrands\\n.Whe\", \"re(b => b.Enabled)\\n.OrderBy(b => b.Name)\\n.Select(b => new SelectListItem {\\nValue = b.Id, Text = b.Na\", \"me })\\n.ToListAsync();\\nIt\\u2019s important in the above example to add the call to ToListAsync in order to\", \" execute the query\\nimmediately. Otherwise, the statement will assign an IQueryable<SelectListItem> t\", \"o brandItems,\\nwhich will not be executed until it is enumerated. There are pros and cons to returnin\", \"g IQueryable\\nresults from methods. It allows the query EF Core will construct to be further modified\", \", but can also\\nresult in errors that only occur at run time, if operations are added to the query th\", \"at EF Core cannot\\ntranslate. It\\u2019s generally safer to pass any filters into the method performing the\", \" data access, and return\\nback an in-memory collection (for example, List<T>) as the result.\\nEF Core \", \"tracks changes on entities it fetches from persistence. To save changes to a tracked entity, you\\njus\", \"t call the SaveChangesAsync method on the DbContext, making sure it\\u2019s the same DbContext\\ninstance th\", \"at was used to fetch the entity. Adding and removing entities is directly done on the\\nappropriate Db\", \"Set property, again with a call to SaveChangesAsync to execute the database\\ncommands. The following \", \"example demonstrates adding, updating, and removing entities from\\npersistence.\\n71 CHAPTER 7 | Workin\", \"g with Data in ASP.NET Core Apps// create\\nvar newBrand = new CatalogBrand() { Brand = \\\"Acme\\\" };\\n_con\", \"text.Add(newBrand);\\nawait _context.SaveChangesAsync();\\n// read and update\\nvar existingBrand = _conte\", \"xt.CatalogBrands.Find(1);\\nexistingBrand.Brand = \\\"Updated Brand\\\";\\nawait _context.SaveChangesAsync();\\n\", \"// read and delete (alternate Find syntax)\\nvar brandToDelete = _context.Find<CatalogBrand>(2);\\n_cont\", \"ext.CatalogBrands.Remove(brandToDelete);\\nawait _context.SaveChangesAsync();\\nEF Core supports both sy\", \"nchronous and async methods for fetching and saving. In web applications,\\nit\\u2019s recommended to use th\", \"e async/await pattern with the async methods, so that web server threads\\nare not blocked while waiti\", \"ng for data access operations to complete.\\nFor more information, see Buffering and Streaming.\\nFetchi\", \"ng related data\\nWhen EF Core retrieves entities, it populates all of the properties that are stored \", \"directly with that\\nentity in the database. Navigation properties, such as lists of related entities,\", \" are not populated and\\nmay have their value set to null. This process ensures EF Core is not fetchin\", \"g more data than is\\nneeded, which is especially important for web applications, which must quickly p\", \"rocess requests and\\nreturn responses in an efficient manner. To include relationships with an entity\", \" using eager loading,\\nyou specify the property using the Include extension method on the query, as s\", \"hown:\\n// .Include requires using Microsoft.EntityFrameworkCore\\nvar brandsWithItems = await _context.\", \"CatalogBrands\\n.Include(b => b.Items)\\n.ToListAsync();\\nYou can include multiple relationships, and you\", \" can also include subrelationships using ThenInclude.\\nEF Core will execute a single query to retriev\", \"e the resulting set of entities. Alternately you can include\\nnavigation properties of navigation pro\", \"perties by passing a \\u2018.\\u2019-separated string to the .Include()\\nextension method, like so:\\n.Include(\\\"Ite\", \"ms.Products\\\")\\nIn addition to encapsulating filtering logic, a specification can specify the shape of\", \" the data to be\\nreturned, including which properties to populate. The eShopOnWeb sample includes sev\", \"eral\\nspecifications that demonstrate encapsulating eager loading information within the specificatio\", \"n. You\\ncan see how the specification is used as part of a query here:\\n// Includes all expression-bas\", \"ed includes\\nquery = specification.Includes.Aggregate(query,\\n(current, include) => current.Include(in\", \"clude));\\n// Include any string-based include statements\\nquery = specification.IncludeStrings.Aggrega\", \"te(query,\\n(current, include) => current.Include(include));\\n72 CHAPTER 7 | Working with Data in ASP.N\", \"ET Core AppsAnother option for loading related data is to use explicit loading. Explicit loading all\", \"ows you to load\\nadditional data into an entity that has already been retrieved. Since this approach \", \"involves a separate\\nrequest to the database, it\\u2019s not recommended for web applications, which should\", \" minimize the\\nnumber of database round trips made per request.\\nLazy loading is a feature that automa\", \"tically loads related data as it is referenced by the application. EF\\nCore has added support for laz\", \"y loading in version 2.1. Lazy loading is not enabled by default and\\nrequires installing the Microso\", \"ft.EntityFrameworkCore.Proxies. As with explicit loading, lazy loading\\nshould typically be disabled \", \"for web applications, since its use will result in additional database\\nqueries being made within eac\", \"h web request. Unfortunately, the overhead incurred by lazy loading\\noften goes unnoticed at developm\", \"ent time, when the latency is small and often the data sets used for\\ntesting are small. However, in \", \"production, with more users, more data, and more latency, the\\nadditional database requests can often\", \" result in poor performance for web applications that make\\nheavy use of lazy loading.\\nAvoid Lazy Loa\", \"ding Entities in Web Applications\\nIt\\u2019s a good idea to test your application while examining the actu\", \"al database queries it makes. Under\\ncertain circumstances, EF Core may make many more queries or a m\", \"ore expensive query than is\\noptimal for the application. One such problem is known as a Cartesian Ex\", \"plosion. The EF Core team\\nmakes available the AsSplitQuery method as one of several ways to tune run\", \"time behavior.\\nEncapsulating data\\nEF Core supports several features that allow your model to properl\", \"y encapsulate its state. A common\\nproblem in domain models is that they expose collection navigation\", \" properties as publicly accessible\\nlist types. This problem allows any collaborator to manipulate th\", \"e contents of these collection types,\\nwhich may bypass important business rules related to the colle\", \"ction, possibly leaving the object in an\\ninvalid state. The solution to this problem is to expose re\", \"ad-only access to related collections, and\\nexplicitly provide methods defining ways in which clients\", \" can manipulate them, as in this example:\\npublic class Basket : BaseEntity\\n{\\npublic string BuyerId {\", \" get; set; }\\nprivate readonly List<BasketItem> _items = new List<BasketItem>();\\npublic IReadOnlyColl\", \"ection<BasketItem> Items => _items.AsReadOnly();\\npublic void AddItem(int catalogItemId, decimal unit\", \"Price, int quantity = 1)\\n{\\nvar existingItem = Items.FirstOrDefault(i => i.CatalogItemId == catalogIt\", \"emId);\\nif (existingItem == null)\\n{\\n_items.Add(new BasketItem()\\n{\\nCatalogItemId = catalogItemId,\\nQuan\", \"tity = quantity,\\nUnitPrice = unitPrice\\n});\\n}\\nelse existingItem.Quantity += quantity;\\n}\\n}\\n73 CHAPTER \", \"7 | Working with Data in ASP.NET Core AppsThis entity type doesn\\u2019t expose a public List or ICollecti\", \"on property, but instead exposes an\\nIReadOnlyCollection type that wraps the underlying List type. Wh\", \"en using this pattern, you can\\nindicate to Entity Framework Core to use the backing field like so:\\np\", \"rivate void ConfigureBasket(EntityTypeBuilder<Basket> builder)\\n{\\nvar navigation = builder.Metadata.F\", \"indNavigation(nameof(Basket.Items));\\nnavigation.SetPropertyAccessMode(PropertyAccessMode.Field);\\n}\\nA\", \"nother way in which you can improve your domain model is by using value objects for types that\\nlack \", \"identity and are only distinguished by their properties. Using such types as properties of your\\nenti\", \"ties can help keep logic specific to the value object where it belongs, and can avoid duplicate logi\", \"c\\nbetween multiple entities that use the same concept. In Entity Framework Core, you can persist val\", \"ue\\nobjects in the same table as their owning entity by configuring the type as an owned entity, like\", \" so:\\nprivate void ConfigureOrder(EntityTypeBuilder<Order> builder)\\n{\\nbuilder.OwnsOne(o => o.ShipToAd\", \"dress);\\n}\\nIn this example, the ShipToAddress property is of type Address. Address is a value object \", \"with several\\nproperties such as Street and City. EF Core maps the Order object to its table with one\", \" column per\\nAddress property, prefixing each column name with the name of the property. In this exam\", \"ple, the\\nOrder table would include columns such as ShipToAddress_Street and ShipToAddress_City. It\\u2019s\", \" also\\npossible to store owned types in separate tables, if desired.\\nLearn more about owned entity su\", \"pport in EF Core.\\nResilient connections\\nExternal resources like SQL databases may occasionally be un\", \"available. In cases of temporary\\nunavailability, applications can use retry logic to avoid raising a\", \"n exception. This technique is\\ncommonly referred to as connection resiliency. You can implement your\", \" own retry with exponential\\nbackoff technique by attempting to retry with an exponentially increasin\", \"g wait time, until a maximum\\nretry count has been reached. This technique embraces the fact that clo\", \"ud resources might\\nintermittently be unavailable for short periods of time, resulting in the failure\", \" of some requests.\\nFor Azure SQL DB, Entity Framework Core already provides internal database connec\", \"tion resiliency\\nand retry logic. But you need to enable the Entity Framework execution strategy for \", \"each DbContext\\nconnection if you want to have resilient EF Core connections.\\nFor instance, the follo\", \"wing code at the EF Core connection level enables resilient SQL connections that\\nare retried if the \", \"connection fails.\\nbuilder.Services.AddDbContext<OrderingContext>(options =>\\n{\\noptions.UseSqlServer(b\", \"uilder.Configuration[\\\"ConnectionString\\\"],\\nsqlServerOptionsAction: sqlOptions =>\\n{\\nsqlOptions.EnableR\", \"etryOnFailure(\\nmaxRetryCount: 5,\\n74 CHAPTER 7 | Working with Data in ASP.NET Core AppsmaxRetryDelay:\", \" TimeSpan.FromSeconds(30),\\nerrorNumbersToAdd: null);\\n}\\n);\\n});\\nExecution strategies and explicit tran\", \"sactions using BeginTransaction and multiple\\nDbContexts\\nWhen retries are enabled in EF Core connecti\", \"ons, each operation you perform using EF Core becomes\\nits own retryable operation. Each query and ea\", \"ch call to SaveChangesAsync will be retried as a unit if a\\ntransient failure occurs.\\nHowever, if you\", \"r code initiates a transaction using BeginTransaction, you are defining your own group\\nof operations\", \" that need to be treated as a unit; everything inside the transaction has to be rolled back\\nif a fai\", \"lure occurs. You will see an exception like the following if you attempt to execute that\\ntransaction\", \" when using an EF execution strategy (retry policy) and you include several\\nSaveChangesAsync from mu\", \"ltiple DbContexts in it.\\nSystem.InvalidOperationException: The configured execution strategy\\nSqlServ\", \"erRetryingExecutionStrategy does not support user initiated transactions. Use the execution\\nstrategy\", \" returned by DbContext.Database.CreateExecutionStrategy() to execute all the operations in\\nthe trans\", \"action as a retryable unit.\\nThe solution is to manually invoke the EF execution strategy with a dele\", \"gate representing everything\\nthat needs to be executed. If a transient failure occurs, the execution\", \" strategy will invoke the delegate\\nagain. The following code shows how to implement this approach:\\n/\", \"/ Use of an EF Core resiliency strategy when using multiple DbContexts\\n// within an explicit transac\", \"tion\\n// See:\\n// https://learn.microsoft.com/ef/core/miscellaneous/connection-resiliency\\nvar strategy\", \" = _catalogContext.Database.CreateExecutionStrategy();\\nawait strategy.ExecuteAsync(async () =>\\n{\\n// \", \"Achieving atomicity between original Catalog database operation and the\\n// IntegrationEventLog thank\", \"s to a local transaction\\nusing (var transaction = _catalogContext.Database.BeginTransaction())\\n{\\n_ca\", \"talogContext.CatalogItems.Update(catalogItem);\\nawait _catalogContext.SaveChangesAsync();\\n// Save to \", \"EventLog only if product price changed\\nif (raiseProductPriceChangedEvent)\\n{\\nawait _integrationEventL\", \"ogService.SaveEventAsync(priceChangedEvent);\\ntransaction.Commit();\\n}\\n}\\n});\\nThe first DbContext is th\", \"e _catalogContext and the second DbContext is within the\\n_integrationEventLogService object. Finally\", \", the Commit action would be performed multiple\\nDbContexts and using an EF Execution Strategy.\\n75 CH\", \"APTER 7 | Working with Data in ASP.NET Core AppsReferences \\u2013 Entity Framework Core\\n\\u2022 EF Core Docs ht\", \"tps://learn.microsoft.com/ef/\\n\\u2022 EF Core: Related Data https://learn.microsoft.com/ef/core/querying/r\", \"elated-data\\n\\u2022 Avoid Lazy Loading Entities in ASPNET Applications https://ardalis.com/avoid-lazy-\\nloa\", \"ding-entities-in-asp-net-applications\\nEF Core or micro-ORM?\\nWhile EF Core is a great choice for mana\", \"ging persistence, and for the most part encapsulates\\ndatabase details from application developers, i\", \"t isn\\u2019t the only choice. Another popular open-source\\nalternative is Dapper, a so-called micro-ORM. A\", \" micro-ORM is a lightweight, less full-featured tool for\\nmapping objects to data structures. In the \", \"case of Dapper, its design goals focus on performance,\\nrather than fully encapsulating the underlyin\", \"g queries it uses to retrieve and update data. Because it\\ndoesn\\u2019t abstract SQL from the developer, D\", \"apper is \\u201ccloser to the metal\\u201d and lets developers write the\\nexact queries they want to use for a gi\", \"ven data access operation.\\nEF Core has two significant features it provides which separate it from D\", \"apper but also add to its\\nperformance overhead. The first is the translation from LINQ expressions i\", \"nto SQL. These translations\\nare cached, but even so there is overhead in performing them the first t\", \"ime. The second is change\\ntracking on entities (so that efficient update statements can be generated\", \"). This behavior can be\\nturned off for specific queries by using the AsNoTracking extension. EF Core\", \" also generates SQL\\nqueries that usually are very efficient and in any case perfectly acceptable fro\", \"m a performance\\nstandpoint, but if you need fine control over the precise query to be executed, you \", \"can pass in custom\\nSQL (or execute a stored procedure) using EF Core, too. In this case, Dapper stil\", \"l outperforms EF Core,\\nbut only very slightly. Current performance benchmark data for a variety of d\", \"ata access methods can\\nbe found on the Dapper site.\\nTo see how the syntax for Dapper varies from EF \", \"Core, consider these two versions of the same\\nmethod for retrieving a list of items:\\n// EF Core\\npriv\", \"ate readonly CatalogContext _context;\\npublic async Task<IEnumerable<CatalogType>> GetCatalogTypes()\\n\", \"{\\nreturn await _context.CatalogTypes.ToListAsync();\\n}\\n// Dapper\\nprivate readonly SqlConnection _conn\", \";\\npublic async Task<IEnumerable<CatalogType>> GetCatalogTypesWithDapper()\\n{\\nreturn await _conn.Query\", \"Async<CatalogType>(\\\"SELECT * FROM CatalogType\\\");\\n}\\nIf you need to build more complex object graphs w\", \"ith Dapper, you need to write the associated\\nqueries yourself (as opposed to adding an Include as yo\", \"u would in EF Core). This functionality is\\nsupported through various syntaxes, including a feature c\", \"alled Multi Mapping that lets you map\\nindividual rows to multiple mapped objects. For example, given\", \" a class Post with a property Owner of\\ntype User, the following SQL would return all of the necessar\", \"y data:\\n76 CHAPTER 7 | Working with Data in ASP.NET Core Appsselect * from #Posts p\\nleft join #Users\", \" u on u.Id = p.OwnerId\\nOrder by p.Id\\nEach returned row includes both User and Post data. Since the U\", \"ser data should be attached to the\\nPost data via its Owner property, the following function is used:\", \"\\n(post, user) => { post.Owner = user; return post; }\\nThe full code listing to return a collection of\", \" posts with their Owner property populated with the\\nassociated user data would be:\\nvar sql = @\\\"selec\", \"t * from #Posts p\\nleft join #Users u on u.Id = p.OwnerId\\nOrder by p.Id\\\";\\nvar data = connection.Query\", \"<Post, User, Post>(sql,\\n(post, user) => { post.Owner = user; return post;});\\nBecause it offers less \", \"encapsulation, Dapper requires developers know more about how their data is\\nstored, how to query it \", \"efficiently, and write more code to fetch it. When the model changes, instead\\nof simply creating a n\", \"ew migration (another EF Core feature), and/or updating mapping information\\nin one place in a DbCont\", \"ext, every query that is impacted must be updated. These queries have no\\ncompile-time guarantees, so\", \" they may break at run time in response to changes to the model or\\ndatabase, making errors more diff\", \"icult to detect quickly. In exchange for these tradeoffs, Dapper\\noffers extremely fast performance.\\n\", \"For most applications, and most parts of almost all applications, EF Core offers acceptable\\nperforma\", \"nce. Thus, its developer productivity benefits are likely to outweigh its performance\\noverhead. For \", \"queries that can benefit from caching, the actual query may only be executed a tiny\\npercentage of th\", \"e time, making relatively small query performance differences moot.\\nSQL or NoSQL\\nTraditionally, rela\", \"tional databases like SQL Server have dominated the marketplace for persistent data\\nstorage, but the\", \"y are not the only solution available. NoSQL databases like MongoDB offer a different\\napproach to st\", \"oring objects. Rather than mapping objects to tables and rows, another option is to\\nserialize the en\", \"tire object graph, and store the result. The benefits of this approach, at least initially,\\nare simp\", \"licity and performance. It\\u2019s simpler to store a single serialized object with a key than to\\ndecompos\", \"e the object into many tables with relationships and update rows that may have changed\\nsince the obj\", \"ect was last retrieved from the database. Likewise, fetching and deserializing a single\\nobject from \", \"a key-based store is typically much faster and easier than complex joins or multiple\\ndatabase querie\", \"s required to fully compose the same object from a relational database. The lack of\\nlocks or transac\", \"tions or a fixed schema also makes NoSQL databases amenable to scaling across many\\nmachines, support\", \"ing very large datasets.\\nOn the other hand, NoSQL databases (as they are typically called) have thei\", \"r drawbacks. Relational\\ndatabases use normalization to enforce consistency and avoid duplication of \", \"data. This approach\\nreduces the total size of the database and ensures that updates to shared data a\", \"re available\\nimmediately throughout the database. In a relational database, an Address table might r\", \"eference a\\n77 CHAPTER 7 | Working with Data in ASP.NET Core AppsCountry table by ID, such that if th\", \"e name of a country/region were changed, the address records\\nwould benefit from the update without t\", \"hemselves having to be updated. However, in a NoSQL\\ndatabase, Address, and its associated Country mi\", \"ght be serialized as part of many stored objects. An\\nupdate to a country/region name would require a\", \"ll such objects to be updated, rather than a single\\nrow. Relational databases can also ensure relati\", \"onal integrity by enforcing rules like foreign keys.\\nNoSQL databases typically do not offer such con\", \"straints on their data.\\nAnother complexity NoSQL databases must deal with is versioning. When an obj\", \"ect\\u2019s properties\\nchange, it may not be able to be deserialized from past versions that were stored. \", \"Thus, all existing\\nobjects that have a serialized (previous) version of the object must be updated t\", \"o conform to its new\\nschema. This approach is not conceptually different from a relational database,\", \" where schema\\nchanges sometimes require update scripts or mapping updates. However, the number of en\", \"tries that\\nmust be modified is often much greater in the NoSQL approach, because there is more dupli\", \"cation of\\ndata.\\nIt\\u2019s possible in NoSQL databases to store multiple versions of objects, something fi\", \"xed schema\\nrelational databases typically do not support. However, in this case, your application co\", \"de will need to\\naccount for the existence of previous versions of objects, adding additional complex\", \"ity.\\nNoSQL databases typically do not enforce ACID, which means they have both performance and\\nscala\", \"bility benefits over relational databases. They\\u2019re well suited to extremely large datasets and\\nobjec\", \"ts that are not well suited to storage in normalized table structures. There is no reason why a\\nsing\", \"le application cannot take advantage of both relational and NoSQL databases, using each where it\\nis \", \"best suited.\\nAzure Cosmos DB\\nAzure Cosmos DB is a fully managed NoSQL database service that offers c\", \"loud-based schema-free\\ndata storage. Azure Cosmos DB is built for fast and predictable performance, \", \"high availability, elastic\\nscaling, and global distribution. Despite being a NoSQL database, develop\", \"ers can use rich and familiar\\nSQL query capabilities on JSON data. All resources in Azure Cosmos DB \", \"are stored as JSON\\ndocuments. Resources are managed as items, which are documents containing metadat\", \"a, and feeds,\\nwhich are collections of items. Figure 8-2 shows the relationship between different Az\", \"ure Cosmos DB\\nresources.\\n78 CHAPTER 7 | Working with Data in ASP.NET Core AppsFigure 8-2. Azure Cosm\", \"os DB resource organization.\\nThe Azure Cosmos DB query language is a simple yet powerful interface f\", \"or querying JSON\\ndocuments. The language supports a subset of ANSI SQL grammar and adds deep integra\", \"tion of\\nJavaScript object, arrays, object construction, and function invocation.\\nReferences \\u2013 Azure \", \"Cosmos DB\\n\\u2022 Azure Cosmos DB Introduction https://learn.microsoft.com/azure/cosmos-db/introduction\\nOt\", \"her persistence options\\nIn addition to relational and NoSQL storage options, ASP.NET Core applicatio\", \"ns can use Azure\\nStorage to store various data formats and files in a cloud-based, scalable fashion.\", \" Azure Storage is\\nmassively scalable, so you can start out storing small amounts of data and scale u\", \"p to storing\\nhundreds or terabytes if your application requires it. Azure Storage supports four kind\", \"s of data:\\n\\u2022 Blob Storage for unstructured text or binary storage, also referred to as object storag\", \"e.\\n\\u2022 Table Storage for structured datasets, accessible via row keys.\\n\\u2022 Queue Storage for reliable qu\", \"eue-based messaging.\\n79 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\u2022 File Storage for shared \", \"file access between Azure virtual machines and on-premises\\napplications.\\nReferences \\u2013 Azure Storage\\n\", \"\\u2022 Azure Storage Introduction https://learn.microsoft.com/azure/storage/common/storage-\\nintroduction\\n\", \"Caching\\nIn web applications, each web request should be completed in the shortest time possible. One\", \" way to\\nachieve this functionality is to limit the number of external calls the server must make to \", \"complete the\\nrequest. Caching involves storing a copy of data on the server (or another data store t\", \"hat is more\\neasily queried than the source of the data). Web applications, and especially non-SPA tr\", \"aditional web\\napplications, need to build the entire user interface with every request. This approac\", \"h frequently\\ninvolves making many of the same database queries repeatedly from one user request to t\", \"he next. In\\nmost cases, this data changes rarely, so there is little reason to constantly request it\", \" from the\\ndatabase. ASP.NET Core supports response caching, for caching entire pages, and data cachi\", \"ng, which\\nsupports more granular caching behavior.\\nWhen implementing caching, it\\u2019s important to keep\", \" in mind separation of concerns. Avoid\\nimplementing caching logic in your data access logic, or in y\", \"our user interface. Instead, encapsulate\\ncaching in its own classes, and use configuration to manage\", \" its behavior. This approach follows the\\nOpen/Closed and Single Responsibility principles, and will \", \"make it easier for you to manage how you\\nuse caching in your application as it grows.\\nASP.NET Core r\", \"esponse caching\\nASP.NET Core supports two levels of response caching. The first level does not cache\", \" anything on the\\nserver, but adds HTTP headers that instruct clients and proxy servers to cache resp\", \"onses. This\\nfunctionality is implemented by adding the ResponseCache attribute to individual control\", \"lers or\\nactions:\\n[ResponseCache(Duration = 60)]\\npublic IActionResult Contact()\\n{\\nViewData[\\\"Message\\\"]\", \" = \\\"Your contact page.\\\";\\nreturn View();\\n}\\nThe previous example will result in the following header b\", \"eing added to the response, instructing\\nclients to cache the result for up to 60 seconds.\\nCache-Cont\", \"rol: public,max-age=60\\nIn order to add server-side in-memory caching to the application, you must re\", \"ference the\\nMicrosoft.AspNetCore.ResponseCaching NuGet package, and then add the Response Caching\\nmi\", \"ddleware. This middleware is configured with services and middleware during app startup:\\n80 CHAPTER \", \"7 | Working with Data in ASP.NET Core Appsbuilder.Services.AddResponseCaching();\\n// other code omitt\", \"ed, including building the app\\napp.UseResponseCaching();\\nThe Response Caching Middleware will automa\", \"tically cache responses based on a set of conditions,\\nwhich you can customize. By default, only 200 \", \"(OK) responses requested via GET or HEAD methods\\nare cached. In addition, requests must have a respo\", \"nse with a Cache-Control: public header, and\\ncannot include headers for Authorization or Set-Cookie.\", \" See a complete list of the caching conditions\\nused by the response caching middleware.\\nData caching\", \"\\nRather than (or in addition to) caching full web responses, you can cache the results of individual\", \" data\\nqueries. For this functionality, you can use in memory caching on the web server, or use a dis\", \"tributed\\ncache. This section will demonstrate how to implement in memory caching.\\nAdd support for me\", \"mory (or distributed) caching with the following code:\\nbuilder.Services.AddMemoryCache();\\nbuilder.Se\", \"rvices.AddMvc();\\nBe sure to add the Microsoft.Extensions.Caching.Memory NuGet package as well.\\nOnce \", \"you\\u2019ve added the service, you request IMemoryCache via dependency injection wherever you\\nneed to acc\", \"ess the cache. In this example, the CachedCatalogService is using the Proxy (or Decorator)\\ndesign pa\", \"ttern, by providing an alternative implementation of ICatalogService that controls access to\\n(or add\", \"s behavior to) the underlying CatalogService implementation.\\npublic class CachedCatalogService : ICa\", \"talogService\\n{\\nprivate readonly IMemoryCache _cache;\\nprivate readonly CatalogService _catalogService\", \";\\nprivate static readonly string _brandsKey = \\\"brands\\\";\\nprivate static readonly string _typesKey = \\\"\", \"types\\\";\\nprivate static readonly TimeSpan _defaultCacheDuration = TimeSpan.FromSeconds(30);\\npublic Ca\", \"chedCatalogService(\\nIMemoryCache cache,\\nCatalogService catalogService)\\n{\\n_cache = cache;\\n_catalogSer\", \"vice = catalogService;\\n}\\npublic async Task<IEnumerable<SelectListItem>> GetBrands()\\n{\\nreturn await _\", \"cache.GetOrCreateAsync(_brandsKey, async entry =>\\n{\\nentry.SlidingExpiration = _defaultCacheDuration;\", \"\\nreturn await _catalogService.GetBrands();\\n});\\n}\\npublic async Task<Catalog> GetCatalogItems(int page\", \"Index, int itemsPage, int? brandID,\\n81 CHAPTER 7 | Working with Data in ASP.NET Core Appsint? typeId\", \")\\n{\\nstring cacheKey = $\\\"items-{pageIndex}-{itemsPage}-{brandID}-{typeId}\\\";\\nreturn await _cache.GetOr\", \"CreateAsync(cacheKey, async entry =>\\n{\\nentry.SlidingExpiration = _defaultCacheDuration;\\nreturn await\", \" _catalogService.GetCatalogItems(pageIndex, itemsPage, brandID,\\ntypeId);\\n});\\n}\\npublic async Task<IEn\", \"umerable<SelectListItem>> GetTypes()\\n{\\nreturn await _cache.GetOrCreateAsync(_typesKey, async entry =\", \">\\n{\\nentry.SlidingExpiration = _defaultCacheDuration;\\nreturn await _catalogService.GetTypes();\\n});\\n}\\n\", \"}\\nTo configure the application to use the cached version of the service, but still allow the service\", \" to get\\nthe instance of CatalogService it needs in its constructor, you would add the following line\", \"s in\\nProgram.cs:\\nbuilder.Services.AddMemoryCache();\\nbuilder.Services.AddScoped<ICatalogService, Cach\", \"edCatalogService>();\\nbuilder.Services.AddScoped<CatalogService>();\\nWith this code in place, the data\", \"base calls to fetch the catalog data will only be made once per\\nminute, rather than on every request\", \". Depending on the traffic to the site, this can have a significant\\nimpact on the number of queries \", \"made to the database, and the average page load time for the home\\npage that currently depends on all\", \" three of the queries exposed by this service.\\nAn issue that arises when caching is implemented is s\", \"tale data \\u2013 that is, data that has changed at the\\nsource but an out-of-date version remains in the c\", \"ache. A simple way to mitigate this issue is to use\\nsmall cache durations, since for a busy applicat\", \"ion there is a limited additional benefit to extending\\nthe length data is cached. For example, consi\", \"der a page that makes a single database query, and is\\nrequested 10 times per second. If this page is\", \" cached for one minute, it will result in the number of\\ndatabase queries made per minute to drop fro\", \"m 600 to 1, a reduction of 99.8%. If instead the cache\\nduration was made one hour, the overall reduc\", \"tion would be 99.997%, but now the likelihood and\\npotential age of stale data are both increased dra\", \"matically.\\nAnother approach is to proactively remove cache entries when the data they contain is upd\", \"ated. Any\\nindividual entry can be removed if its key is known:\\n_cache.Remove(cacheKey);\\nIf your appl\", \"ication exposes functionality for updating entries that it caches, you can remove the\\ncorresponding \", \"cache entries in your code that performs the updates. Sometimes there may be many\\ndifferent entries \", \"that depend on a particular set of data. In that case, it can be useful to create\\ndependencies betwe\", \"en cache entries, by using a CancellationChangeToken. With a\\nCancellationChangeToken, you can expire\", \" multiple cache entries at once by canceling the token.\\n82 CHAPTER 7 | Working with Data in ASP.NET \", \"Core Apps// configure CancellationToken and add entry to cache\\nvar cts = new CancellationTokenSource\", \"();\\n_cache.Set(\\\"cts\\\", cts);\\n_cache.Set(cacheKey, itemToCache, new CancellationChangeToken(cts.Token)\", \");\\n// elsewhere, expire the cache by cancelling the token\\\\\\n_cache.Get<CancellationTokenSource>(\\\"cts\\\"\", \").Cancel();\\nCaching can dramatically improve the performance of web pages that repeatedly request th\", \"e same\\nvalues from the database. Be sure to measure data access and page performance before applying\", \"\\ncaching, and only apply caching where you see a need for improvement. Caching consumes web\\nserver m\", \"emory resources and increases the complexity of the application, so it\\u2019s important you don\\u2019t\\nprematu\", \"rely optimize using this technique.\\nGetting data to Blazor WebAssembly apps\\nIf you\\u2019re building apps \", \"that use Blazor Server, you can use Entity Framework and other direct data\\naccess technologies as th\", \"ey\\u2019ve been discussed thus far in this chapter. However, when building Blazor\\nWebAssembly apps, like \", \"other SPA frameworks, you will need a different strategy for data access.\\nTypically, these applicati\", \"ons access data and interact with the server through web API endpoints.\\nIf the data or operations be\", \"ing performed are sensitive, be sure to review the section on security in\\nthe previous chapter and p\", \"rotect your APIs against unauthorized access.\\nYou\\u2019ll find an example of a Blazor WebAssembly app in \", \"the eShopOnWeb reference application, in the\\nBlazorAdmin project. This project is hosted within the \", \"eShopOnWeb Web project, and allows users in\\nthe Administrators group to manage the items in the stor\", \"e. You can see a screenshot of the\\napplication in Figure 8-3.\\nFigure 8-3. eShopOnWeb Catalog Admin S\", \"creenshot.\\n83 CHAPTER 7 | Working with Data in ASP.NET Core AppsWhen fetching data from web APIs wit\", \"hin a Blazor WebAssembly app, you just use an instance of\\nHttpClient as you would in any .NET applic\", \"ation. The basic steps involved are to create the request to\\nsend (if necessary, usually for POST or\", \" PUT requests), await the request itself, verify the status code,\\nand deserialize the response. If y\", \"ou\\u2019re going to make many requests to a given set of APIs, it\\u2019s a good\\nidea to encapsulate your APIs \", \"and configure the HttpClient base address centrally. This way, if you\\nneed to adjust any of these se\", \"ttings between environments, you can make the changes in just one\\nplace. You should add support for \", \"this service in your Program.Main:\\nbuilder.Services.AddScoped(sp => new HttpClient\\n{\\nBaseAddress = n\", \"ew Uri(builder.HostEnvironment.BaseAddress)\\n});\\nIf you need to access services securely, you should \", \"access a secure token and configure the HttpClient\\nto pass this token as an Authentication header wi\", \"th every request:\\n_httpClient.DefaultRequestHeaders.Authorization =\\nnew AuthenticationHeaderValue(\\\"B\", \"earer\\\", token);\\nThis activity can be done from any component that has the HttpClient injected into i\", \"t, provided that\\nHttpClient wasn\\u2019t added to the application\\u2019s services with a Transient lifetime. Ev\", \"ery reference to\\nHttpClient in the application references the same instance, so changes to it in one\", \" component flow\\nthrough the entire application. A good place to perform this authentication check (f\", \"ollowed by\\nspecifying the token) is in a shared component like the main navigation for the site. Lea\", \"rn more about\\nthis approach in the BlazorAdmin project in the eShopOnWeb reference application.\\nOne \", \"benefit of Blazor WebAssembly over traditional JavaScript SPAs is that you don\\u2019t need to keep\\ncopies\", \" of your data transfer objects(DTOs) synchronized. Your Blazor WebAssembly project and your\\nweb API \", \"project can both share the same DTOs in a common shared project. This approach eliminates\\nsome of th\", \"e friction involved in developing SPAs.\\nTo quickly get data from an API endpoint, you can use the bu\", \"ilt-in helper method, GetFromJsonAsync.\\nThere are similar methods for POST, PUT, etc. The following \", \"shows how to get a CatalogItem from an\\nAPI endpoint using a configured HttpClient in a Blazor WebAss\", \"embly app:\\nvar item = await _httpClient.GetFromJsonAsync<CatalogItem>($\\\"catalog-items/{id}\\\");\\nOnce y\", \"ou have the data you need, you\\u2019ll typically track changes locally. When you want to make\\nupdates to \", \"the backend data store, you\\u2019ll call additional web APIs for this purpose.\\nReferences \\u2013 Blazor Data\\n\\u2022\", \" Call a web API from ASP.NET Core Blazor https://learn.microsoft.com/aspnet/core/blazor/call-\\nweb-ap\", \"i\\n84 CHAPTER 7 | Working with Data in ASP.NET Core Apps8\\nCHAPTER\\nTest ASP.NET Core MVC\\napps\\n\\u201cIf you \", \"don\\u2019t like unit testing your product, most likely your customers won\\u2019t like to test it, either.\\u201d _-\\n\", \"Anonymous-\\nSoftware of any complexity can fail in unexpected ways in response to changes. Thus, test\", \"ing after\\nmaking changes is required for all but the most trivial (or least critical) applications. \", \"Manual testing is\\nthe slowest, least reliable, most expensive way to test software. Unfortunately, i\", \"f applications aren\\u2019t\\ndesigned to be testable, it can be the only means of testing available. Applic\", \"ations written to follow\\nthe architectural principles laid out in chapter 4 should be largely unit t\", \"estable. ASP.NET Core\\napplications support automated integration and functional testing.\\nKinds of au\", \"tomated tests\\nThere are many kinds of automated tests for software applications. The simplest, lowes\", \"t level test is\\nthe unit test. At a slightly higher level, there are integration tests and functiona\", \"l tests. Other kinds of\\ntests, such as UI tests, load tests, stress tests, and smoke tests, are beyo\", \"nd the scope of this document.\\nUnit tests\\nA unit test tests a single part of your application\\u2019s logi\", \"c. One can further describe it by listing some of\\nthe things that it isn\\u2019t. A unit test doesn\\u2019t test\", \" how your code works with dependencies or\\ninfrastructure \\u2013 that\\u2019s what integration tests are for. A \", \"unit test doesn\\u2019t test the framework your code\\nis written on \\u2013 you should assume it works or, if you\", \" find it doesn\\u2019t, file a bug and code a workaround.\\nA unit test runs completely in memory and in pro\", \"cess. It doesn\\u2019t communicate with the file system, the\\nnetwork, or a database. Unit tests should onl\", \"y test your code.\\nUnit tests, by virtue of the fact that they test only a single unit of your code, \", \"with no external\\ndependencies, should execute extremely fast. Thus, you should be able to run test s\", \"uites of hundreds\\nof unit tests in a few seconds. Run them frequently, ideally before every push to \", \"a shared source\\ncontrol repository, and certainly with every automated build on your build server.\\nI\", \"ntegration tests\\nAlthough it\\u2019s a good idea to encapsulate your code that interacts with infrastructu\", \"re like databases\\nand file systems, you will still have some of that code, and you will probably wan\", \"t to test it.\\n85 CHAPTER 8 | Test ASP.NET Core MVC appsAdditionally, you should verify that your cod\", \"e\\u2019s layers interact as you expect when your application\\u2019s\\ndependencies are fully resolved. This func\", \"tionality is the responsibility of integration tests. Integration\\ntests tend to be slower and more d\", \"ifficult to set up than unit tests, because they often depend on\\nexternal dependencies and infrastru\", \"cture. Thus, you should avoid testing things that could be tested\\nwith unit tests in integration tes\", \"ts. If you can test a given scenario with a unit test, you should test it\\nwith a unit test. If you c\", \"an\\u2019t, then consider using an integration test.\\nIntegration tests will often have more complex setup \", \"and teardown procedures than unit tests. For\\nexample, an integration test that goes against an actua\", \"l database will need a way to return the\\ndatabase to a known state before each test run. As new test\", \"s are added and the production database\\nschema evolves, these test scripts will tend to grow in size\", \" and complexity. In many large systems, it is\\nimpractical to run full suites of integration tests on\", \" developer workstations before checking in\\nchanges to shared source control. In these cases, integra\", \"tion tests may be run on a build server.\\nFunctional tests\\nIntegration tests are written from the per\", \"spective of the developer, to verify that some components of\\nthe system work correctly together. Fun\", \"ctional tests are written from the perspective of the user, and\\nverify the correctness of the system\", \" based on its requirements. The following excerpt offers a useful\\nanalogy for how to think about fun\", \"ctional tests, compared to unit tests:\\n\\u201cMany times the development of a system is likened to the bui\", \"lding of a house. While this analogy\\nisn\\u2019t quite correct, we can extend it for the purposes of under\", \"standing the difference between unit\\nand functional tests. Unit testing is analogous to a building i\", \"nspector visiting a house\\u2019s construction\\nsite. He is focused on the various internal systems of the \", \"house, the foundation, framing, electrical,\\nplumbing, and so on. He ensures (tests) that the parts o\", \"f the house will work correctly and safely, that\\nis, meet the building code. Functional tests in thi\", \"s scenario are analogous to the homeowner visiting\\nthis same construction site. He assumes that the \", \"internal systems will behave appropriately, that the\\nbuilding inspector is performing his task. The \", \"homeowner is focused on what it will be like to live in\\nthis house. He is concerned with how the hou\", \"se looks, are the various rooms a comfortable size, does\\nthe house fit the family\\u2019s needs, are the w\", \"indows in a good spot to catch the morning sun. The\\nhomeowner is performing functional tests on the \", \"house. He has the user\\u2019s perspective. The building\\ninspector is performing unit tests on the house. \", \"He has the builder\\u2019s perspective.\\u201d\\nSource: Unit Testing versus Functional Tests\\nI\\u2019m fond of saying \\u201c\", \"As developers, we fail in two ways: we build the thing wrong, or we build the\\nwrong thing.\\u201d Unit tes\", \"ts ensure you are building the thing right; functional tests ensure you are\\nbuilding the right thing\", \".\\nSince functional tests operate at the system level, they may require some degree of UI automation.\", \"\\nLike integration tests, they usually work with some kind of test infrastructure as well. This activ\", \"ity\\nmakes them slower and more brittle than unit and integration tests. You should have only as many\", \"\\nfunctional tests as you need to be confident the system is behaving as users expect.\\nTesting Pyrami\", \"d\\nMartin Fowler wrote about the testing pyramid, an example of which is shown in Figure 9-1.\\n86 CHAP\", \"TER 8 | Test ASP.NET Core MVC appsFigure 9-1. Testing Pyramid\\nThe different layers of the pyramid, a\", \"nd their relative sizes, represent different kinds of tests and how\\nmany you should write for your a\", \"pplication. As you can see, the recommendation is to have a large\\nbase of unit tests, supported by a\", \" smaller layer of integration tests, with an even smaller layer of\\nfunctional tests. Each layer shou\", \"ld ideally only have tests in it that cannot be performed adequately at\\na lower layer. Keep the test\", \"ing pyramid in mind when you are trying to decide which kind of test you\\nneed for a particular scena\", \"rio.\\nWhat to test\\nA common problem for developers who are inexperienced with writing automated tests\", \" is coming up\\nwith what to test. A good starting point is to test conditional logic. Anywhere you ha\", \"ve a method with\\nbehavior that changes based on a conditional statement (if-else, switch, and so on)\", \", you should be\\nable to come up with at least a couple of tests that confirm the correct behavior fo\", \"r certain conditions.\\nIf your code has error conditions, it\\u2019s good to write at least one test for th\", \"e \\u201chappy path\\u201d through the\\ncode (with no errors), and at least one test for the \\u201csad path\\u201d (with err\", \"ors or atypical results) to\\nconfirm your application behaves as expected in the face of errors. Fina\", \"lly, try to focus on testing\\nthings that can fail, rather than focusing on metrics like code coverag\", \"e. More code coverage is better\\nthan less, generally. However, writing a few more tests of a complex\", \" and business-critical method is\\nusually a better use of time than writing tests for auto-properties\", \" just to improve test code coverage\\nmetrics.\\n87 CHAPTER 8 | Test ASP.NET Core MVC appsOrganizing tes\", \"t projects\\nTest projects can be organized however works best for you. It\\u2019s a good idea to separate t\", \"ests by type\\n(unit test, integration test) and by what they are testing (by project, by namespace). \", \"Whether this\\nseparation consists of folders within a single test project, or multiple test projects,\", \" is a design decision.\\nOne project is simplest, but for large projects with many tests, or in order \", \"to more easily run different\\nsets of tests, you might want to have several different test projects. \", \"Many teams organize test projects\\nbased on the project they are testing, which for applications with\", \" more than a few projects can result\\nin a large number of test projects, especially if you still bre\", \"ak these down according to what kind of\\ntests are in each project. A compromise approach is to have \", \"one project per kind of test, per\\napplication, with folders inside the test projects to indicate the\", \" project (and class) being tested.\\nA common approach is to organize the application projects under a\", \" \\u2018src\\u2019 folder, and the application\\u2019s\\ntest projects under a parallel \\u2018tests\\u2019 folder. You can create m\", \"atching solution folders in Visual Studio, if\\nyou find this organization useful.\\nFigure 9-2. Test or\", \"ganization in your solution\\nYou can use whichever test framework you prefer. The xUnit framework wor\", \"ks well and is what all of\\nthe ASP.NET Core and EF Core tests are written in. You can add an xUnit t\", \"est project in Visual Studio\\nusing the template shown in Figure 9-3, or from the CLI using dotnet ne\", \"w xunit.\\n88 CHAPTER 8 | Test ASP.NET Core MVC appsFigure 9-3. Add an xUnit Test Project in Visual St\", \"udio\\nTest naming\\nName your tests in a consistent fashion, with names that indicate what each test do\", \"es. One approach\\nI\\u2019ve had great success with is to name test classes according to the class and meth\", \"od they are testing.\\nThis approach results in many small test classes, but it makes it extremely cle\", \"ar what each test is\\nresponsible for. With the test class name set up, to identify the class and met\", \"hod to be tested, the test\\nmethod name can be used to specify the behavior being tested. This name s\", \"hould include the\\nexpected behavior and any inputs or assumptions that should yield this behavior. S\", \"ome example test\\nnames:\\n\\u2022 CatalogControllerGetImage.CallsImageServiceWithId\\n\\u2022 CatalogControllerGetIm\", \"age.LogsWarningGivenImageMissingException\\n\\u2022 CatalogControllerGetImage.ReturnsFileResultWithBytesGive\", \"nSuccess\\n\\u2022 CatalogControllerGetImage.ReturnsNotFoundResultGivenImageMissingException\\nA variation of \", \"this approach ends each test class name with \\u201cShould\\u201d and modifies the tense slightly:\\n\\u2022 CatalogCont\", \"rollerGetImageShould.CallImageServiceWithId\\n\\u2022 CatalogControllerGetImageShould.LogWarningGivenImageMi\", \"ssingException\\n89 CHAPTER 8 | Test ASP.NET Core MVC appsSome teams find the second naming approach c\", \"learer, though slightly more verbose. In any case, try\\nto use a naming convention that provides insi\", \"ght into test behavior, so that when one or more tests\\nfail, it\\u2019s obvious from their names what case\", \"s have failed. Avoid naming your tests vaguely, such as\\nControllerTests.Test1, as these names offer \", \"no value when you see them in test results.\\nIf you follow a naming convention like the one above tha\", \"t produces many small test classes, it\\u2019s a\\ngood idea to further organize your tests using folders an\", \"d namespaces. Figure 9-4 shows one\\napproach to organizing tests by folder within several test projec\", \"ts.\\nFigure 9-4. Organizing test classes by folder based on class being tested.\\nIf a particular appli\", \"cation class has many methods being tested (and thus many test classes), it may\\nmake sense to place \", \"these classes in a folder corresponding to the application class. This organization\\nis no different \", \"than how you might organize files into folders elsewhere. If you have more than three\\n90 CHAPTER 8 |\", \" Test ASP.NET Core MVC appsor four related files in a folder containing many other files, it\\u2019s often\", \" helpful to move them into their\\nown subfolder.\\nUnit testing ASP.NET Core apps\\nIn a well-designed AS\", \"P.NET Core application, most of the complexity and business logic will be\\nencapsulated in business e\", \"ntities and a variety of services. The ASP.NET Core MVC app itself, with its\\ncontrollers, filters, v\", \"iewmodels, and views, should require few unit tests. Much of the functionality of a\\ngiven action lie\", \"s outside the action method itself. Testing whether routing or global error handling\\nwork correctly \", \"cannot be done effectively with a unit test. Likewise, any filters, including model\\nvalidation and a\", \"uthentication and authorization filters, cannot be unit tested with a test targeting a\\ncontroller\\u2019s \", \"action method. Without these sources of behavior, most action methods should be\\ntrivially small, del\", \"egating the bulk of their work to services that can be tested independent of the\\ncontroller that use\", \"s them.\\nSometimes you\\u2019ll need to refactor your code in order to unit test it. Frequently this activi\", \"ty involves\\nidentifying abstractions and using dependency injection to access the abstraction in the\", \" code you\\u2019d\\nlike to test, rather than coding directly against infrastructure. For example, consider \", \"this easy action\\nmethod for displaying images:\\n[HttpGet(\\\"[controller]/pic/{id}\\\")]\\npublic IActionResu\", \"lt GetImage(int id)\\n{\\nvar contentRoot = _env.ContentRootPath + \\\"//Pics\\\";\\nvar path = Path.Combine(con\", \"tentRoot, id + \\\".png\\\");\\nByte[] b = System.IO.File.ReadAllBytes(path);\\nreturn File(b, \\\"image/png\\\");\\n}\", \"\\nUnit testing this method is made difficult by its direct dependency on System.IO.File, which it use\", \"s to\\nread from the file system. You can test this behavior to ensure it works as expected, but doing\", \" so with\\nreal files is an integration test. It\\u2019s worth noting you can\\u2019t unit test this method\\u2019s rout\", \"e\\u2014you\\u2019ll see how\\nto do this testing with a functional test shortly.\\nIf you can\\u2019t unit test the file \", \"system behavior directly, and you can\\u2019t test the route, what is there to\\ntest? Well, after refactori\", \"ng to make unit testing possible, you may discover some test cases and\\nmissing behavior, such as err\", \"or handling. What does the method do when a file isn\\u2019t found? What\\nshould it do? In this example, th\", \"e refactored method looks like this:\\n[HttpGet(\\\"[controller]/pic/{id}\\\")]\\npublic IActionResult GetImag\", \"e(int id)\\n{\\nbyte[] imageBytes;\\ntry\\n{\\nimageBytes = _imageService.GetImageBytesById(id);\\n}\\ncatch (Cata\", \"logImageMissingException ex)\\n{\\n_logger.LogWarning($\\\"No image found for id: {id}\\\");\\nreturn NotFound()\", \";\\n}\\n91 CHAPTER 8 | Test ASP.NET Core MVC appsreturn File(imageBytes, \\\"image/png\\\");\\n}\\n_logger and _im\", \"ageService are both injected as dependencies. Now you can test that the same ID that\\nis passed to th\", \"e action method is passed to _imageService, and that the resulting bytes are returned\\nas part of the\", \" FileResult. You can also test that error logging is happening as expected, and that a\\nNotFound resu\", \"lt is returned if the image is missing, assuming this behavior is important application\\nbehavior (th\", \"at is, not just temporary code the developer added to diagnose an issue). The actual file\\nlogic has \", \"moved into a separate implementation service, and has been augmented to return an\\napplication-specif\", \"ic exception for the case of a missing file. You can test this implementation\\nindependently, using a\", \"n integration test.\\nIn most cases, you\\u2019ll want to use global exception handlers in your controllers,\", \" so the amount of logic\\nin them should be minimal and probably not worth unit testing. Do most of yo\", \"ur testing of controller\\nactions using functional tests and the TestServer class described below.\\nIn\", \"tegration testing ASP.NET Core apps\\nMost of the integration tests in your ASP.NET Core apps should b\", \"e testing services and other\\nimplementation types defined in your Infrastructure project. For exampl\", \"e, you could test that EF Core\\nwas successfully updating and retrieving the data that you expect fro\", \"m your data access classes\\nresiding in the Infrastructure project. The best way to test that your AS\", \"P.NET Core MVC project is\\nbehaving correctly is with functional tests that run against your app runn\", \"ing in a test host.\\nFunctional testing ASP.NET Core apps\\nFor ASP.NET Core applications, the TestServ\", \"er class makes functional tests fairly easy to write. You\\nconfigure a TestServer using a WebHostBuil\", \"der (or HostBuilder) directly (as you normally do for your\\napplication), or with the WebApplicationF\", \"actory type (available since version 2.1). Try to match your\\ntest host to your production host as cl\", \"osely as possible, so your tests exercise behavior similar to what\\nthe app will do in production. Th\", \"e WebApplicationFactory class is helpful for configuring the\\nTestServer\\u2019s ContentRoot, which is used\", \" by ASP.NET Core to locate static resource like Views.\\nYou can create simple functional tests by cre\", \"ating a test class that implements\\nIClassFixture<WebApplicationFactory<TEntryPoint>>, where TEntryPo\", \"int is your web application\\u2019s\\nStartup class. With this interface in place, your test fixture can cre\", \"ate a client using the factory\\u2019s\\nCreateClient method:\\npublic class BasicWebTests : IClassFixture<Web\", \"ApplicationFactory<Program>>\\n{\\nprotected readonly HttpClient _client;\\npublic BasicWebTests(WebApplic\", \"ationFactory<Program> factory)\\n{\\n_client = factory.CreateClient();\\n}\\n92 CHAPTER 8 | Test ASP.NET Cor\", \"e MVC apps// write tests that use _client\\n}\\nTip\\nIf you\\u2019re using minimal API configuration in your Pr\", \"ogram.cs file, by default the class will be declared\\ninternal and won\\u2019t be accessible from the test \", \"project. You can choose any other instance class in your\\nweb project instead, or add this to your Pr\", \"ogram.cs file:\\n]{custom-style=Code}`csharp // Make the implicit Program class public so test project\", \"s can access it\\npublic partial class Program { } [`\\nFrequently, you\\u2019ll want to perform some addition\", \"al configuration of your site before each test runs,\\nsuch as configuring the application to use an i\", \"n-memory data store and then seeding the application\\nwith test data. To achieve this functionality, \", \"create your own subclass of\\nWebApplicationFactory<TEntryPoint> and override its ConfigureWebHost met\", \"hod. The example\\nbelow is from the eShopOnWeb FunctionalTests project and is used as part of the tes\", \"ts on the main\\nweb application.\\nusing Microsoft.AspNetCore.Hosting;\\nusing Microsoft.AspNetCore.Ident\", \"ity;\\nusing Microsoft.AspNetCore.Mvc.Testing;\\nusing Microsoft.EntityFrameworkCore;\\nusing Microsoft.eS\", \"hopWeb.Infrastructure.Data;\\nusing Microsoft.eShopWeb.Infrastructure.Identity;\\nusing Microsoft.eShopW\", \"eb.Web;\\nusing Microsoft.Extensions.DependencyInjection;\\nusing Microsoft.Extensions.Logging;\\nusing Sy\", \"stem;\\nnamespace Microsoft.eShopWeb.FunctionalTests.Web;\\npublic class WebTestFixture : WebApplication\", \"Factory<Startup>\\n{\\nprotected override void ConfigureWebHost(IWebHostBuilder builder)\\n{\\nbuilder.UseEn\", \"vironment(\\\"Testing\\\");\\nbuilder.ConfigureServices(services =>\\n{\\nservices.AddEntityFrameworkInMemoryDat\", \"abase();\\n// Create a new service provider.\\nvar provider = services\\n.AddEntityFrameworkInMemoryDataba\", \"se()\\n.BuildServiceProvider();\\n// Add a database context (ApplicationDbContext) using an in-memory\\n//\", \" database for testing.\\nservices.AddDbContext<CatalogContext>(options =>\\n{\\noptions.UseInMemoryDatabas\", \"e(\\\"InMemoryDbForTesting\\\");\\noptions.UseInternalServiceProvider(provider);\\n});\\nservices.AddDbContext<A\", \"ppIdentityDbContext>(options =>\\n{\\n93 CHAPTER 8 | Test ASP.NET Core MVC appsoptions.UseInMemoryDataba\", \"se(\\\"Identity\\\");\\noptions.UseInternalServiceProvider(provider);\\n});\\n// Build the service provider.\\nvar\", \" sp = services.BuildServiceProvider();\\n// Create a scope to obtain a reference to the database\\n// co\", \"ntext (ApplicationDbContext).\\nusing (var scope = sp.CreateScope())\\n{\\nvar scopedServices = scope.Serv\", \"iceProvider;\\nvar db = scopedServices.GetRequiredService<CatalogContext>();\\nvar loggerFactory = scope\", \"dServices.GetRequiredService<ILoggerFactory>();\\nvar logger = scopedServices\\n.GetRequiredService<ILog\", \"ger<WebTestFixture>>();\\n// Ensure the database is created.\\ndb.Database.EnsureCreated();\\ntry\\n{\\n// See\", \"d the database with test data.\\nCatalogContextSeed.SeedAsync(db, loggerFactory).Wait();\\n// seed sampl\", \"e user data\\nvar userManager =\\nscopedServices.GetRequiredService<UserManager<ApplicationUser>>();\\nvar\", \" roleManager = scopedServices.GetRequiredService<RoleManager<IdentityRole>>();\\nAppIdentityDbContextS\", \"eed.SeedAsync(userManager, roleManager).Wait();\\n}\\ncatch (Exception ex)\\n{\\nlogger.LogError(ex, $\\\"An er\", \"ror occurred seeding the \\\" +\\n\\\"database with test messages. Error: {ex.Message}\\\");\\n}\\n}\\n});\\n}\\n}\\nTests \", \"can make use of this custom WebApplicationFactory by using it to create a client and then\\nmaking req\", \"uests to the application using this client instance. The application will have data seeded\\nthat can \", \"be used as part of the test\\u2019s assertions. The following test verifies that the home page of the\\neSho\", \"pOnWeb application loads correctly and includes a product listing that was added to the\\napplication \", \"as part of the seed data.\\nusing Microsoft.eShopWeb.FunctionalTests.Web;\\nusing System.Net.Http;\\nusing\", \" System.Threading.Tasks;\\nusing Xunit;\\nnamespace Microsoft.eShopWeb.FunctionalTests.WebRazorPages;\\n[C\", \"ollection(\\\"Sequential\\\")]\\npublic class HomePageOnGet : IClassFixture<WebTestFixture>\\n{\\npublic HomePag\", \"eOnGet(WebTestFixture factory)\\n{\\n94 CHAPTER 8 | Test ASP.NET Core MVC appsClient = factory.CreateCli\", \"ent();\\n}\\npublic HttpClient Client { get; }\\n[Fact]\\npublic async Task ReturnsHomePageWithProductListin\", \"g()\\n{\\n// Arrange & Act\\nvar response = await Client.GetAsync(\\\"/\\\");\\nresponse.EnsureSuccessStatusCode()\", \";\\nvar stringResponse = await response.Content.ReadAsStringAsync();\\n// Assert\\nAssert.Contains(\\\".NET B\", \"ot Black Sweatshirt\\\", stringResponse);\\n}\\n}\\nThis functional test exercises the full ASP.NET Core MVC \", \"/ Razor Pages application stack, including all\\nmiddleware, filters, and binders that may be in place\", \". It verifies that a given route (\\u201c/\\u201d) returns the\\nexpected success status code and HTML output. It \", \"does so without setting up a real web server, and\\navoids much of the brittleness that using a real w\", \"eb server for testing can experience (for example,\\nproblems with firewall settings). Functional test\", \"s that run against TestServer are usually slower than\\nintegration and unit tests, but are much faste\", \"r than tests that would run over the network to a test\\nweb server. Use functional tests to ensure yo\", \"ur application\\u2019s front-end stack is working as expected.\\nThese tests are especially useful when you \", \"find duplication in your controllers or pages and you\\naddress the duplication by adding filters. Ide\", \"ally, this refactoring won\\u2019t change the behavior of the\\napplication, and a suite of functional tests\", \" will verify this is the case.\\nReferences \\u2013 Test ASP.NET Core MVC apps\\n\\u2022 Testing in ASP.NET Core\\nhtt\", \"ps://learn.microsoft.com/aspnet/core/testing/\\n\\u2022 Unit Test Naming Convention\\nhttps://ardalis.com/unit\", \"-test-naming-convention\\n\\u2022 Testing EF Core\\nhttps://learn.microsoft.com/ef/core/miscellaneous/testing/\", \"\\n\\u2022 Integration tests in ASP.NET Core\\nhttps://learn.microsoft.com/aspnet/core/test/integration-tests\\n\", \"95 CHAPTER 8 | Test ASP.NET Core MVC apps9\\nCHAPTER\\nDevelopment process for\\nAzure\\n\\u201cWith the cloud, in\", \"dividuals and small businesses can snap their fingers and instantly set up enterprise-\\nclass service\", \"s.\\u201d\\n- Roy Stephan\\nVision\\nDevelop well-designed ASP .NET Core applications the way you like, using Vi\", \"sual Studio or the dotnet\\nCLI and Visual Studio Code or your editor of choice.\\nDevelopment environme\", \"nt for ASP.NET Core apps\\nDevelopment tools choices: IDE or editor\\nWhether you prefer a full and powe\", \"rful IDE or a lightweight and agile editor, Microsoft has you\\ncovered when developing ASP.NET Core a\", \"pplications.\\nVisual Studio 2022. Visual Studio 2022 is the best-in-class IDE for developing applicat\", \"ions for\\nASP.NET Core. It offers a host of features that increase developer productivity. You can us\", \"e it to\\ndevelop the application, then analyze its performance and other characteristics. The integra\", \"ted\\ndebugger lets you pause code execution and step back and forth through code on the fly as it\\u2019s\\nr\", \"unning. Its support for hot reloads allows you to continue working with your app where you left off,\", \"\\neven after making code changes, without having to restart the app. The built-in test runner lets yo\", \"u\\norganize your tests and their results and can even perform live unit testing while you\\u2019re coding. \", \"Using\\nLive Share, you can collaborate in real-time with other developers, sharing your code session\\n\", \"seamlessly over the network. And when you\\u2019re ready, Visual Studio includes everything you need to\\npu\", \"blish your application to Azure or wherever you might host it.\\nDownload Visual Studio 2022\\nVisual St\", \"udio Code and dotnet CLI (Cross-Platform Tools for Mac, Linux, and Windows). If you prefer\\na lightwe\", \"ight and cross-platform editor supporting any development language, you can use Microsoft\\nVisual Stu\", \"dio Code and the dotnet CLI. These products provide a simple yet robust experience that\\n96 CHAPTER 9\", \" | Development process for Azurestreamlines the developer workflow. Additionally, Visual Studio Code\", \" supports extensions for C# and\\nweb development, providing intellisense and shortcut-tasks within th\", \"e editor.\\nDownload the .NET SDK\\nDownload Visual Studio Code\\nDevelopment workflow for Azure-hosted AS\", \"P.NET\\nCore apps\\nThe application development lifecycle starts from each developer\\u2019s machine, coding t\", \"he app using\\ntheir preferred language and testing it locally. Developers may choose their preferred \", \"source control\\nsystem and can configure Continuous Integration (CI) and/or Continuous Delivery/Deplo\", \"yment (CD)\\nusing a build server or based on built-in Azure features.\\nTo get started with developing \", \"an ASP.NET Core application using CI/CD, you can use Azure DevOps\\nServices or your organization\\u2019s ow\", \"n Team Foundation Server (TFS). GitHub Actions provide another\\noption for easily building and deploy\", \"ing apps to Azure, for apps whose code is hosted on GitHub.\\nInitial setup\\nTo create a release pipeli\", \"ne for your app, you need to have your application code in source control.\\nSet up a local repository\", \" and connect it to a remote repository in a team project. Follow these\\ninstructions:\\n\\u2022 Share your co\", \"de with Git and Visual Studio or\\n\\u2022 Share your code with TFVC and Visual Studio\\nCreate an Azure App S\", \"ervice where you\\u2019ll deploy your application. Create a Web App by going to the\\nApp Services blade on \", \"the Azure portal. Click +Add, select the Web App template, click Create, and\\nprovide a name and othe\", \"r details. The web app will be accessible from {name}.azurewebsites.net.\\n97 CHAPTER 9 | Development \", \"process for AzureFigure 10-1. Creating a new Azure App Service Web App in the Azure Portal.\\nYour CI \", \"build process will perform an automated build whenever new code is committed to the\\nproject\\u2019s source\", \" control repository. This process gives you immediate feedback that the code builds\\n(and, ideally, p\", \"asses automated tests) and can potentially be deployed. This CI build will produce a\\nweb deploy pack\", \"age artifact and publish it for consumption by your CD process.\\nDefine your CI build process\\nBe sure\", \" to enable continuous integration so the system will queue a build whenever someone on your\\nteam com\", \"mits new code. Test the build and verify that it is producing a web deploy package as one of\\nits art\", \"ifacts.\\nWhen a build succeeds, your CD process will deploy the results of your CI build to your Azur\", \"e web\\napp. To configure this step, you create and configure a Release, which will deploy to your Azu\", \"re App\\nService.\\nDeploy an Azure web app\\nOnce your CI/CD pipeline is configured, you can easily make \", \"updates to your web app and commit\\nthem to source control to have them deployed.\\nWorkflow for develo\", \"ping Azure-hosted ASP.NET Core applications\\nOnce you have configured your Azure account and your CI/\", \"CD process, developing Azure-hosted\\nASP.NET Core applications is simple. The following are the basic\", \" steps you usually take when building\\nan ASP.NET Core app, hosted in Azure App Service as a Web App,\", \" as illustrated in Figure 10-2.\\n98 CHAPTER 9 | Development process for AzureFigure 10-2. Step-by-ste\", \"p workflow for building ASP.NET Core apps and hosting them in Azure\\nStep 1. Local dev environment in\", \"ner loop\\nDeveloping your ASP.NET Core application for deployment to Azure is no different from devel\", \"oping\\nyour application otherwise. Use the local development environment you\\u2019re comfortable with, whe\", \"ther\\nthat\\u2019s Visual Studio 2019 or the dotnet CLI and Visual Studio Code or your preferred editor. Yo\", \"u can\\nwrite code, run and debug your changes, run automated tests, and make local commits to source\\n\", \"control until you\\u2019re ready to push your changes to your shared source control repository.\\nStep 2. Ap\", \"plication code repository\\nWhenever you\\u2019re ready to share your code with your team, you should push y\", \"our changes from your\\nlocal source repository to your team\\u2019s shared source repository. If you\\u2019ve bee\", \"n working in a custom\\nbranch, this step usually involves merging your code into a shared branch (per\", \"haps by means of a pull\\nrequest).\\nStep 3. Build Server: Continuous integration. build, test, package\", \"\\nA new build is triggered on the build server whenever a new commit is made to the shared\\napplicatio\", \"n code repository. As part of the CI process, this build should fully compile the application\\nand ru\", \"n automated tests to confirm everything is working as expected. The end result of the CI\\nprocess sho\", \"uld be a packaged version of the web app, ready for deployment.\\nStep 4. Build Server: Continuous del\", \"ivery\\nOnce a build has succeeded, the CD process will pick up the build artifacts produced. This pro\", \"cess will\\ninclude a web deploy package. The build server will deploy this package to Azure App Servi\", \"ce,\\n99 CHAPTER 9 | Development process for Azurereplacing any existing service with the newly create\", \"d one. Typically this step targets a staging\\nenvironment, but some applications deploy directly to p\", \"roduction through a CD process.\\nStep 5. Azure App Service Web App\\nOnce deployed, the ASP.NET Core ap\", \"plication runs within the context of an Azure App Service Web\\nApp. This Web App can be monitored and\", \" further configured using the Azure Portal.\\nStep 6. Production monitoring and diagnostics\\nWhile the \", \"Web App is running, you can monitor the health of the application and collect diagnostics\\nand user b\", \"ehavior data. Application Insights is included in Visual Studio, and offers automatic\\ninstrumentatio\", \"n for ASP.NET apps. It can provide you with information on usage, exceptions, requests,\\nperformance,\", \" and logs.\\nReferences\\nBuild and Deploy Your ASP.NET Core App to Azure\\nhttps://learn.microsoft.com/az\", \"ure/devops/build-release/apps/aspnet/build-aspnet-core\\n100 CHAPTER 9 | Development process for Azure\", \"10\\nCHAPTER\\nAzure hosting\\nrecommendations for\\nASP.NET Core web apps\\n\\u201cLine-of-business leaders everywh\", \"ere are bypassing IT departments to get applications from the cloud\\n(also known as SaaS) and paying \", \"for them like they would a magazine subscription. And when the\\nservice is no longer required, they c\", \"an cancel the subscription with no equipment left unused in the\\ncorner.\\u201d\\n- Daryl Plummer, Gartner an\", \"alyst\\nWhatever your application\\u2019s needs and architecture, Microsoft Azure can support it. Your hosti\", \"ng\\nneeds can be as simple as a static website or a sophisticated application made up of dozens of\\nse\", \"rvices. For ASP.NET Core monolithic web applications and supporting services, there are several\\nwell\", \"-known configurations that are recommended. The recommendations on this article are grouped\\nbased on\", \" the kind of resource to be hosted, whether full applications, individual processes, or data.\\nWeb ap\", \"plications\\nWeb applications can be hosted with:\\n\\u2022 App Service Web Apps\\n\\u2022 Containers (several options\", \")\\n\\u2022 Virtual Machines (VMs)\\nOf these, App Service Web Apps is the recommended approach for most scena\", \"rios, including simple\\ncontainer-based apps. For microservice architectures, consider a container-ba\", \"sed approach. If you\\nneed more control over the machines running your application, consider Azure Vi\", \"rtual Machines.\\nApp Service Web Apps\\nApp Service Web Apps offers a fully managed platform optimized \", \"for hosting web applications. It\\u2019s a\\nplatform as a service (PaaS) offering that lets you focus on yo\", \"ur business logic, while Azure takes care\\nof the infrastructure needed to run and scale the app. Som\", \"e key features of App Service Web Apps:\\n101 CHAPTER 10 | Azure hosting recommendations for ASP.NET C\", \"ore web apps\\u2022 DevOps optimization (continuous integration and delivery, multiple environments, A/B\\nt\", \"esting, scripting support).\\n\\u2022 Global scale and high availability.\\n\\u2022 Connections to SaaS platforms an\", \"d your on-premises data.\\n\\u2022 Security and compliance.\\n\\u2022 Visual Studio integration.\\nAzure App Service i\", \"s the best choice for most web apps. Deployment and management are integrated\\ninto the platform, sit\", \"es can scale quickly to handle high traffic loads, and the built-in load balancing\\nand traffic manag\", \"er provide high availability. You can move existing sites to Azure App Service easily\\nwith an online\", \" migration tool. You can use an open-source app from the Web Application Gallery, or\\ncreate a new si\", \"te using the framework and tools of your choice. The WebJobs feature makes it easy to\\nadd background\", \" job processing to your App Service web app. If you have an existing ASP.NET\\napplication hosted on-p\", \"remises using a local database, there\\u2019s a clear path to migrate. You can use\\nApp Service Web App wit\", \"h an Azure SQL Database (or secure access to your on-premises database\\nserver, if preferred).\\nIn mos\", \"t cases, moving from a locally hosted ASP.NET app to an App Service Web App is a\\nstraightforward pro\", \"cess. Little or no modification should be required of the app itself, and it can\\nquickly start to ta\", \"ke advantage of the many features that Azure App Service Web Apps offer.\\n102 CHAPTER 10 | Azure host\", \"ing recommendations for ASP.NET Core web appsIn addition to apps that are not optimized for the clou\", \"d, Azure App Service Web Apps are an excellent\\nsolution for many simple monolithic (non-distributed)\", \" applications, such as many ASP.NET Core apps.\\nIn this approach, the architecture is basic and simpl\", \"e to understand and manage:\\nA small number of resources in a single resource group is typically suff\", \"icient to manage such an app.\\nApps that are typically deployed as a single unit, rather than those a\", \"pps that are made up of many\\nseparate processes, are good candidates for this basic architectural ap\", \"proach. Though architecturally\\nsimple, this approach still allows the hosted app to scale both up (m\", \"ore resources per node) and out\\n(more hosted nodes) to meet any increase in demand. With autoscale, \", \"the app can be configured to\\nautomatically adjust the number of nodes hosting the app based on deman\", \"d and average load across\\nnodes.\\nApp Service Web Apps for Containers\\nIn addition to support for host\", \"ing web apps directly, App Service Web Apps for Containers can be\\nused to run containerized applicat\", \"ions on Windows and Linux. Using this service, you can easily\\ndeploy and run containerized applicati\", \"ons that can scale with your business. The apps have all of the\\nfeatures of App Service Web Apps lis\", \"ted above. In addition, Web Apps for Containers supports\\nstreamlined CI/CD with Docker Hub, Azure Co\", \"ntainer Registry, and GitHub. You can use Azure DevOps\\nto define build and deployment pipelines that\", \" publish changes to a registry. These changes can then\\nbe tested in a staging environment and automa\", \"tically deployed to production using deployment slots,\\nallowing zero-downtime upgrades. Rolling back\", \" to previous versions can be done just as easily.\\nThere are a few scenarios where Web Apps for Conta\", \"iners makes the most sense. If you have existing\\napps that you can containerize, whether in Windows \", \"or Linux containers, you can host these easily\\nusing this toolset. Just publish your container and t\", \"hen configure Web Apps for Containers to pull the\\nlatest version of that image from your registry of\", \" choice. This is a \\u201clift and shift\\u201d approach to migrating\\nfrom classic app hosting models to a cloud\", \"-optimized model.\\n103 CHAPTER 10 | Azure hosting recommendations for ASP.NET Core web appsThis appro\", \"ach also works well if your development team is able to move to a container-based\\ndevelopment proces\", \"s. The \\u201cinner loop\\u201d of developing apps with containers includes building the app\\nwith containers. Ch\", \"anges made to the code as well as to container configuration are pushed to source\\ncontrol, and an au\", \"tomated build is responsible for publishing new container images to a registry like\\nDocker Hub or Az\", \"ure Container Registry. These images are then used as the basis for additional\\ndevelopment, as well \", \"as for deployments to production, as shown in the following diagram:\\n104 CHAPTER 10 | Azure hosting \", \"recommendations for ASP.NET Core web appsDeveloping with containers offers many advantages, especial\", \"ly when containers are used in\\nproduction. The same container configuration is used to host the app \", \"in each environment in which it\\nruns, from the local development machine to build and test systems t\", \"o production. This approach\\ngreatly reduces the likelihood of defects resulting from differences in \", \"machine configuration or\\nsoftware versions. Developers can also use whatever tools they\\u2019re most prod\", \"uctive with, including the\\noperating system, since containers can run on any OS. In some cases, dist\", \"ributed applications\\ninvolving many containers may be very resource-intensive to run on a single dev\", \"elopment machine. In\\nthis scenario, it may make sense to upgrade to using Kubernetes and Azure Dev S\", \"paces, covered in\\nthe next section.\\nAs portions of larger applications are broken up into their own \", \"smaller, independent microservices,\\nadditional design patterns can be used to improve app behavior. \", \"Instead of working directly with\\nindividual services, an API gateway can simplify access and decoupl\", \"e the client from its back end.\\nHaving separate service back ends for different front ends also allo\", \"ws services to evolve in concert\\nwith their consumers. Common services can be accessed via a separat\", \"e sidecar container, which might\\ninclude common client connectivity libraries using the ambassador p\", \"attern.\\n105 CHAPTER 10 | Azure hosting recommendations for ASP.NET Core web appsLearn more about des\", \"ign patterns to consider when building microservice-based systems.\\nAzure Kubernetes Service\\nAzure Ku\", \"bernetes Service (AKS) manages your hosted Kubernetes environment, making it quick and\\neasy to deplo\", \"y and manage containerized applications without container orchestration expertise. It\\nalso eliminate\", \"s the burden of ongoing operations and maintenance by provisioning, upgrading, and\\nscaling resources\", \" on-demand, without taking your applications offline.\\nAKS reduces the complexity and operational ove\", \"rhead of managing a Kubernetes cluster by\\noffloading much of that responsibility to Azure. As a host\", \"ed Kubernetes service, Azure handles critical\\ntasks like health monitoring and maintenance for you. \", \"Also, you pay only for the agent nodes within\\nyour clusters, not for the masters. As a managed Kuber\", \"netes service, AKS provides:\\n\\u2022 Automated Kubernetes version upgrades and patching.\\n\\u2022 Easy cluster sc\", \"aling.\\n\\u2022 Self-healing hosted control plane (masters).\\n\\u2022 Cost savings - pay only for running agent po\", \"ol nodes.\\nWith Azure handling the management of the nodes in your AKS cluster, you no longer need to\", \"\\nperform many tasks manually, like cluster upgrades. Because Azure handles these critical maintenanc\", \"e\\ntasks for you, AKS doesn\\u2019t provide direct access (such as with SSH) to the cluster.\\nTeams who are \", \"leveraging AKS can also take advantage of Azure Dev Spaces. Azure Dev Spaces helps\\nteams to focus on\", \" the development and rapid iteration of their microservice application by allowing\\nteams to work dir\", \"ectly with their entire microservices architecture or application running in AKS. Azure\\nDev Spaces a\", \"lso provides a way to independently update portions of your microservices architecture\\nin isolation \", \"without affecting the rest of the AKS cluster or other developers.\\n106 CHAPTER 10 | Azure hosting re\", \"commendations for ASP.NET Core web appsAzure Dev Spaces:\\n\\u2022 Minimize local machine setup time and res\", \"ource requirements\\n\\u2022 Allow teams to iterate more rapidly\\n\\u2022 Reduce the number of integration environm\", \"ents required by a team\\n\\u2022 Remove the need to mock certain services in a distributed system when deve\", \"loping/testing\\nLearn more about Azure Dev Spaces\\nAzure Virtual Machines\\nIf you have an existing appl\", \"ication that would require substantial modifications to run in App Service,\\nyou could choose Virtual\", \" Machines in order to simplify migrating to the cloud. However, correctly\\nconfiguring, securing, and\", \" maintaining VMs requires much more time and IT expertise compared to\\nAzure App Service. If you\\u2019re c\", \"onsidering Azure Virtual Machines, make sure you take into account the\\nongoing maintenance effort re\", \"quired to patch, update, and manage your VM environment. Azure\\nVirtual Machines is infrastructure as\", \" a service (IaaS), while App Service is PaaS. You should also\\nconsider whether deploying your app as\", \" a Windows Container to Web App for Containers might be a\\nviable option for your scenario.\\nLogical p\", \"rocesses\\nIndividual logical processes that can be decoupled from the rest of the application may be \", \"deployed\\nindependently to Azure Functions in a \\u201cserverless\\u201d manner. Azure Functions lets you just wr\", \"ite the\\ncode you need for a given problem, without worrying about the application or infrastructure \", \"to run it.\\nYou can choose from a variety of programming languages, including C#, F#, Node.js, Python\", \", and\\nPHP, allowing you to pick the most productive language for the task at hand. Like most cloud-b\", \"ased\\nsolutions, you pay only for the amount of time your use, and you can trust Azure Functions to s\", \"cale up\\nas needed.\\nData\\nAzure offers a wide variety of data storage options, so that your applicatio\", \"n can use the appropriate\\ndata provider for the data in question.\\n107 CHAPTER 10 | Azure hosting rec\", \"ommendations for ASP.NET Core web appsFor transactional, relational data, Azure SQL Databases are th\", \"e best option. For high performance\\nread-mostly data, a Redis cache backed by an Azure SQL Database \", \"is a good solution.\\nUnstructured JSON data can be stored in a variety of ways, from SQL Database col\", \"umns to Blobs or\\nTables in Azure Storage, to Azure Cosmos DB. Of these, Azure Cosmos DB offers the b\", \"est querying\\nfunctionality, and is the recommended option for large numbers of JSON-based documents \", \"that must\\nsupport querying.\\nTransient command- or event-based data used to orchestrate application b\", \"ehavior can use Azure\\nService Bus or Azure Storage Queues. Azure Service Bus offers more flexibility\", \" and is the\\nrecommended service for non-trivial messaging within and between applications.\\nArchitect\", \"ure recommendations\\nYour application\\u2019s requirements should dictate its architecture. There are many \", \"different Azure\\nservices available. Choosing the right one is an important decision. Microsoft offer\", \"s a gallery of\\nreference architectures to help identify typical architectures optimized for common s\", \"cenarios. You\\nmay find a reference architecture that maps closely to your application\\u2019s requirements\", \", or at least\\noffers a starting point.\\nFigure 11-1 shows an example reference architecture. This dia\", \"gram describes a recommended\\narchitecture approach for a Sitecore content management system website \", \"optimized for marketing.\\nFigure 11-1. Sitecore marketing website reference architecture.\\nReferences \", \"\\u2013 Azure hosting recommendations\\n\\u2022 Azure Solution Architectures\\nhttps://azure.microsoft.com/solutions\", \"/architecture/\\n108 CHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps\\u2022 Azure Basic\", \" Web Application Architecture\\nhttps://learn.microsoft.com/azure/architecture/reference-architectures\", \"/app-service-web-\\napp/basic-web-app\\n\\u2022 Design Patterns for Microservices\\nhttps://learn.microsoft.com/\", \"azure/architecture/microservices/design/patterns\\n\\u2022 Azure Developer Guide\\nhttps://azure.microsoft.com\", \"/campaigns/developer-guide/\\n\\u2022 Web Apps overview\\nhttps://learn.microsoft.com/azure/app-service/app-se\", \"rvice-web-overview\\n\\u2022 Web App for Containers\\nhttps://azure.microsoft.com/services/app-service/contain\", \"ers/\\n\\u2022 Introduction to Azure Kubernetes Service (AKS)\\nhttps://learn.microsoft.com/azure/aks/intro-ku\", \"bernetes\\n109 CHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps\"]"