"[\" \\n \\n \\n\\fEDITION v8.0 - Updated to ASP.NET Core 8.0 \\n\\nRefer changelog for the book updates and communi\", \"ty contributions. \\n\\nPUBLISHED BY \\n\\nMicrosoft Developer Division, .NET, and Visual Studio product tea\", \"ms \\n\\nA division of Microsoft Corporation \\n\\nOne Microsoft Way \\n\\nRedmond, Washington 98052-6399 \\n\\nCopy\", \"right \\u00a9 2023 by Microsoft Corporation \\n\\nAll rights reserved. No part of the contents of this book ma\", \"y be reproduced or transmitted in any \\nform or by any means without the written permission of the pu\", \"blisher. \\n\\nThis book is provided \\u201cas-is\\u201d and expresses the author\\u2019s views and opinions. The views, o\", \"pinions, and \\ninformation expressed in this book, including URL and other Internet website reference\", \"s, may change \\nwithout notice. \\n\\nSome examples depicted herein are provided for illustration only an\", \"d are fictitious. No real association \\nor connection is intended or should be inferred. \\n\\nMicrosoft \", \"and the trademarks listed at https://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are \\ntrademarks o\", \"f the Microsoft group of companies. \\n\\nMac and macOS are trademarks of Apple Inc. \\n\\nThe Docker whale \", \"logo is a registered trademark of Docker, Inc. Used by permission. \\n\\nAll other marks and logos are p\", \"roperty of their respective owners. \\n\\nAuthor: \\n\\nSteve \\u201cardalis\\u201d Smith - Software Architect and Train\", \"er - Ardalis.com \\n\\nEditors: \\n\\nMaira Wenzel \\n\\nAction links \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nThis e-book is also available in\", \" a PDF format (English version only) Download \\n\\nClone/Fork the reference application eShopOnWeb on G\", \"itHub \\n\\nIntroduction \\n\\n.NET 8 and ASP.NET Core offer several advantages over traditional .NET develo\", \"pment. You should use \\n.NET 8 for your server applications if some or all of the following are impor\", \"tant to your application\\u2019s \\nsuccess: \\n\\n\\u2022 \\n\\nCross-platform support. \\n\\n\\f\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nUse of microse\", \"rvices. \\n\\nUse of Docker containers. \\n\\nHigh performance and scalability requirements. \\n\\nSide-by-side \", \"versioning of .NET versions by application on the same server. \\n\\nTraditional .NET 4.x apps can and d\", \"o support many of these requirements, but ASP.NET Core and .NET \\n8 have been optimized to offer impr\", \"oved support for the above scenarios. \\n\\nMore and more organizations are choosing to host their web a\", \"pplications in the cloud using services \\nlike Microsoft Azure. You should consider hosting your appl\", \"ication in the cloud if the following are \\nimportant to your application or organization: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\", \"\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nReduced investment in data center costs (hardware, software, space, utilities, server \\nm\", \"anagement, etc.) \\n\\nFlexible pricing (pay based on usage, not for idle capacity). \\n\\nExtreme reliabili\", \"ty. \\n\\nImproved app mobility; easily change where and how your app is deployed. \\n\\nFlexible capacity; \", \"scale up or down based on actual needs. \\n\\nBuilding web applications with ASP.NET Core, hosted in Azu\", \"re, offers many competitive advantages \\nover traditional alternatives. ASP.NET Core is optimized for\", \" modern web application development \\npractices and cloud hosting scenarios. In this guide, you\\u2019ll le\", \"arn how to architect your ASP.NET Core \\napplications to best take advantage of these capabilities. \\n\", \"\\nVersion \\n\\nThis guide has been revised to cover .NET 8.0 version along with many additional updates \", \"related to \\nthe same \\u201cwave\\u201d of technologies (that is, Azure and additional third-party technologies)\", \" coinciding in \\ntime with the .NET 8.0 release. That\\u2019s why the book version has also been updated to\", \" version 8.0. \\n\\nPurpose \\n\\nThis guide provides end-to-end guidance on building monolithic web applica\", \"tions using ASP.NET \\nCore and Azure. In this context, \\u201cmonolithic\\u201d refers to the fact that these app\", \"lications are deployed as \\na single unit, not as a collection of interacting services and applicatio\", \"ns. In some contexts, the term \\nmonolith may be used as a pejorative, but in the vast majority of si\", \"tuations a single application is \\nmuch easier to build, deploy, and debug than an app composed of ma\", \"ny different services, while still \\nachieving the business requirements. \\n\\nThis guide is complementa\", \"ry to \\u201c.NET Microservices. Architecture for Containerized .NET Applications\\u201d, \\nwhich focuses more on\", \" Docker, microservices, and deployment of containers to host enterprise \\napplications. \\n\\n\\f.NET Micro\", \"services. Architecture for Containerized .NET Applications \\n\\n\\u2022 \\n\\n\\u2022 \\n\\ne-book \\nhttps://aka.ms/Microser\", \"vicesEbook \\n\\nSample Application \\nhttps://aka.ms/microservicesarchitecture \\n\\nWho should use this guid\", \"e \\n\\nThe audience for this guide is mainly developers, development leads, and architects who are \\nint\", \"erested in building modern web applications using Microsoft technologies and services in the \\ncloud.\", \" \\n\\nA secondary audience is technical decision makers who are already familiar ASP.NET or Azure and a\", \"re \\nlooking for information on whether it makes sense to upgrade to ASP.NET Core for new or existing\", \" \\nprojects. \\n\\nHow you can use this guide \\n\\nThis guide has been condensed into a relatively small doc\", \"ument that focuses on building web \\napplications with modern .NET technologies and Azure. As such, i\", \"t can be read in its entirety to \\nprovide a foundation of understanding such applications and their \", \"technical considerations. The \\nguide, along with its sample application, can also serve as a startin\", \"g point or reference. Use the \\nassociated sample application as a template for your own applications\", \", or to see how you might \\norganize your application\\u2019s component parts. Refer back to the guide\\u2019s pr\", \"inciples and coverage of \\narchitecture and technology options and decision considerations when you\\u2019r\", \"e weighing these choices \\nfor your own application. \\n\\nFeel free to forward this guide to your team t\", \"o help ensure a common understanding of these \\nconsiderations and opportunities. Having everybody wo\", \"rking from a common set of terminology and \\nunderlying principles helps ensure consistent applicatio\", \"n of architectural patterns and practices. \\n\\nReferences \\n\\n\\u2022 \\n\\nChoosing between .NET and .NET Framewo\", \"rk for server apps \\nhttps://learn.microsoft.com/dotnet/standard/choosing-core-framework-server \\n\\n\\fCo\", \"ntents \\n\\nCharacteristics of Modern Web Applications ................................................\", \"....................... 1 \\n\\nReference application: eShopOnWeb ......................................\", \"........................................................................................ 1 \\n\\nReferen\", \"ce Application .....................................................................................\", \".................................................................. 2 \\n\\nCloud-hosted and scalable ...\", \"....................................................................................................\", \"........................................... 2 \\n\\nCross platform .....................................\", \"....................................................................................................\", \".................................. 2 \\n\\nModular and loosely coupled .................................\", \"....................................................................................................\", \"........ 3 \\n\\nEasily tested with automated tests ....................................................\", \"............................................................................... 3 \\n\\nTraditional and \", \"SPA behaviors supported ............................................................................\", \"......................................... 3 \\n\\nSimple development and deployment ....................\", \"....................................................................................................\", \".... 4 \\n\\nTraditional ASP.NET and Web Forms .........................................................\", \"...................................................................... 4 \\n\\nBlazor ..................\", \"....................................................................................................\", \"...................................................................... 4 \\n\\nReferences \\u2013 Modern Web A\", \"pplications ........................................................................................\", \"........................... 4 \\n\\nChoose Between Traditional Web Apps and Single Page Apps (SPAs) ....\", \"......................... 6 \\n\\nBlazor ...............................................................\", \"....................................................................................................\", \"......................... 7 \\n\\nWhen to choose traditional web apps ..................................\", \".......................................................................................... 7 \\n\\nWhen \", \"to choose SPAs .....................................................................................\", \"....................................................................... 8 \\n\\nReferences \\u2013 SPA Framewo\", \"rks ................................................................................................\", \"....................................... 8 \\n\\nWhen to choose Blazor ..................................\", \"....................................................................................................\", \"................... 9 \\n\\nDecision table .............................................................\", \"....................................................................................................\", \"........... 9 \\n\\nOther considerations ...............................................................\", \"............................................................................................... 9 \\n\\n\", \"Architectural principles ...........................................................................\", \".............................. 11 \\n\\nCommon design principles .......................................\", \"....................................................................................................\", \".... 11 \\n\\nSeparation of concerns ...................................................................\", \"............................................................................... 11 \\n\\nEncapsulation .\", \"....................................................................................................\", \"................................................................ 11 \\n\\nDependency inversion .........\", \"....................................................................................................\", \"....................................... 12 \\n\\nExplicit dependencies .................................\", \"....................................................................................................\", \"................ 14 \\n\\nSingle responsibility ........................................................\", \"................................................................................................ 14 \", \"\\n\\nDon\\u2019t repeat yourself (DRY) ......................................................................\", \"................................................................... 15 \\n\\ni \\n\\nContents \\n\\n \\n \\n\\fPersist\", \"ence ignorance .....................................................................................\", \"............................................................... 15 \\n\\nBounded contexts ..............\", \"....................................................................................................\", \".......................................... 16 \\n\\nAdditional resources ...............................\", \"....................................................................................................\", \"......................... 16 \\n\\nCommon web application architectures ................................\", \"............................................. 17 \\n\\nWhat is a monolithic application? ...............\", \"....................................................................................................\", \"............... 17 \\n\\nAll-in-one applications .......................................................\", \"................................................................................................ 17 \", \"\\n\\nWhat are layers? .................................................................................\", \"................................................................................... 18 \\n\\nTraditional\", \" \\u201cN-Layer\\u201d architecture applications ...............................................................\", \"......................................... 19 \\n\\nClean architecture ..................................\", \"....................................................................................................\", \"........................... 23 \\n\\nOrganizing code in Clean Architecture .............................\", \"...................................................................................... 28 \\n\\nMonolith\", \"ic applications and containers .....................................................................\", \".................................................. 30 \\n\\nMonolithic application deployed as a contain\", \"er .................................................................................................\", \" 31 \\n\\nDocker support ...............................................................................\", \"....................................................................................... 33 \\n\\nTrouble\", \"shooting Docker problems ...........................................................................\", \"................................................ 34 \\n\\nOther web application architectural styles ...\", \"....................................................................................................\", \"...... 34 \\n\\nReferences \\u2013 Common web architectures ..................................................\", \"............................................................ 34 \\n\\nCommon client-side web technologie\", \"s ............................................................................... 36 \\n\\nHTML ........\", \"....................................................................................................\", \".............................................................................. 36 \\n\\nCSS ............\", \"....................................................................................................\", \".............................................................................. 36 \\n\\nCSS preprocessor\", \"s ..................................................................................................\", \"......................................................... 37 \\n\\nJavaScript ..........................\", \"....................................................................................................\", \"................................................... 38 \\n\\nLegacy web apps with jQuery ...............\", \"....................................................................................................\", \".................. 38 \\n\\njQuery vs a SPA Framework ..................................................\", \"....................................................................................... 38 \\n\\nAngular\", \" SPAs ..............................................................................................\", \"........................................................................ 39 \\n\\nReact ................\", \"....................................................................................................\", \".................................................................. 40 \\n\\nVue ........................\", \"....................................................................................................\", \"............................................................. 40 \\n\\nBlazor WebAssembly ..............\", \"....................................................................................................\", \".................................... 41 \\n\\nChoosing a SPA Framework .................................\", \"....................................................................................................\", \".... 41 \\n\\nReferences \\u2013 Client Web Technologies .....................................................\", \".............................................................. 42 \\n\\nDevelop ASP.NET Core MVC apps ..\", \"..................................................................................... 43 \\n\\nMVC and R\", \"azor Pages .........................................................................................\", \"................................................................ 43 \\n\\nii \\n\\nContents \\n\\n \\n\\fWhy Razor P\", \"ages?...............................................................................................\", \"............................................................. 44 \\n\\nWhen to use MVC .................\", \"....................................................................................................\", \"....................................... 44 \\n\\nMapping requests to responses .........................\", \"....................................................................................................\", \"........ 44 \\n\\nKeeping controllers under control ....................................................\", \"........................................................................ 46 \\n\\nReferences \\u2013 Mapping R\", \"equests to Responses ...............................................................................\", \".................... 48 \\n\\nWorking with dependencies ................................................\", \"............................................................................................. 48 \\n\\nD\", \"eclare your dependencies ...........................................................................\", \"............................................................... 49 \\n\\nStructuring the application ...\", \"....................................................................................................\", \"........................................ 50 \\n\\nFeature organization .................................\", \"....................................................................................................\", \".................. 51 \\n\\nAPIs and Blazor applications ...............................................\", \"......................................................................................... 53 \\n\\nCross\", \"-cutting concerns ..................................................................................\", \"................................................................ 54 \\n\\nReferences \\u2013 Structuring appli\", \"cations ............................................................................................\", \"......................... 57 \\n\\nSecurity ............................................................\", \"....................................................................................................\", \"..................... 57 \\n\\nIdentity ................................................................\", \"....................................................................................................\", \"............. 57 \\n\\nAuthentication ..................................................................\", \"................................................................................................. 60\", \" \\n\\nReferences \\u2013 Authentication .....................................................................\", \"................................................................... 61 \\n\\nAuthorization .............\", \"....................................................................................................\", \".................................................... 61 \\n\\nReferences \\u2013 Security ....................\", \"....................................................................................................\", \".............................. 64 \\n\\nClient communication ...........................................\", \"....................................................................................................\", \".......... 64 \\n\\nReferences \\u2013 Client Communication ..................................................\", \"...................................................................... 65 \\n\\nDomain-driven design \\u2013 S\", \"hould you apply it? ................................................................................\", \".......................... 65 \\n\\nWhen should you apply DDD ..........................................\", \"............................................................................................ 66 \\n\\nWh\", \"en shouldn\\u2019t you apply DDD .........................................................................\", \"....................................................... 66 \\n\\nReferences \\u2013 Domain-Driven Design .....\", \"....................................................................................................\", \".............. 67 \\n\\nDeployment .....................................................................\", \"....................................................................................................\", \".... 67 \\n\\nReferences \\u2013 Deployment ..................................................................\", \"........................................................................... 68 \\n\\nWorking with Data i\", \"n ASP.NET Core Apps ......................................................................... 69 \\n\\nE\", \"ntity Framework Core (for relational databases) ....................................................\", \"................................................ 69 \\n\\nThe DbContext ................................\", \"....................................................................................................\", \".............................. 69 \\n\\nConfiguring EF Core ............................................\", \"....................................................................................................\", \"........ 70 \\n\\nFetching and storing Data ............................................................\", \"................................................................................ 71 \\n\\nFetching relat\", \"ed data ............................................................................................\", \".......................................................... 72 \\n\\niii \\n\\nContents \\n\\n \\n\\fEncapsulating da\", \"ta .................................................................................................\", \"......................................................... 73 \\n\\nResilient connections ...............\", \"....................................................................................................\", \"................................... 74 \\n\\nReferences \\u2013 Entity Framework Core ........................\", \"................................................................................................ 76 \", \"\\n\\nEF Core or micro-ORM? ............................................................................\", \"......................................................................... 76 \\n\\nSQL or NoSQL ........\", \"....................................................................................................\", \"............................................................ 77 \\n\\nAzure Cosmos DB ..................\", \"....................................................................................................\", \"........................................... 78 \\n\\nOther persistence options .........................\", \"....................................................................................................\", \".................... 79 \\n\\nCaching ..................................................................\", \"....................................................................................................\", \"............... 80 \\n\\nASP.NET Core response caching .................................................\", \"............................................................................... 80 \\n\\nData caching ..\", \"....................................................................................................\", \"................................................................ 81 \\n\\nGetting data to Blazor WebAsse\", \"mbly apps ..........................................................................................\", \"...................... 83 \\n\\nTest ASP.NET Core MVC apps .............................................\", \"................................................. 85 \\n\\nKinds of automated tests ....................\", \"....................................................................................................\", \"........................... 85 \\n\\nUnit tests ........................................................\", \"....................................................................................................\", \".................. 85 \\n\\nIntegration tests ..........................................................\", \"....................................................................................................\", \".. 85 \\n\\nFunctional tests ...........................................................................\", \"...................................................................................... 86 \\n\\nTesting \", \"Pyramid ............................................................................................\", \".................................................................... 86 \\n\\nWhat to test .............\", \"....................................................................................................\", \"....................................................... 87 \\n\\nOrganizing test projects ..............\", \"....................................................................................................\", \"................................... 88 \\n\\nTest naming ...............................................\", \"....................................................................................................\", \"..................... 89 \\n\\nUnit testing ASP.NET Core apps ..........................................\", \"........................................................................................... 91 \\n\\nInt\", \"egration testing ASP.NET Core apps .................................................................\", \"...................................................... 92 \\n\\nFunctional testing ASP.NET Core apps ...\", \"....................................................................................................\", \".................. 92 \\n\\nReferences \\u2013 Test ASP.NET Core MVC apps ....................................\", \"...................................................................... 95 \\n\\nDevelopment process for \", \"Azure .......................................................................................... 96 \", \"\\n\\nVision ...........................................................................................\", \".............................................................................................. 96 \\n\\n\", \"Development environment for ASP.NET Core apps ......................................................\", \"......................................... 96 \\n\\nDevelopment tools choices: IDE or editor ............\", \".................................................................................................. 9\", \"6 \\n\\nDevelopment workflow for Azure-hosted ASP.NET Core apps ........................................\", \".................................. 97 \\n\\nInitial setup ..............................................\", \"....................................................................................................\", \"....................... 97 \\n\\nWorkflow for developing Azure-hosted ASP.NET Core applications ........\", \".................................................. 98 \\n\\nReferences .................................\", \"....................................................................................................\", \"........................................ 100 \\n\\niv \\n\\nContents \\n\\n \\n\\fAzure hosting recommendations for \", \"ASP.NET Core web apps ...................................... 101 \\n\\nWeb applications ................\", \"....................................................................................................\", \"............................................ 101 \\n\\nApp Service Web Apps ............................\", \"....................................................................................................\", \"................ 101 \\n\\nApp Service Web Apps for Containers .........................................\", \"......................................................................... 103 \\n\\nAzure Kubernetes Ser\", \"vice ...............................................................................................\", \"............................................ 106 \\n\\nAzure Virtual Machines ..........................\", \"....................................................................................................\", \".................. 107 \\n\\nLogical processes .........................................................\", \"....................................................................................................\", \"... 107 \\n\\nData .....................................................................................\", \"....................................................................................................\", \". 107 \\n\\nArchitecture recommendations ...............................................................\", \"...................................................................... 108 \\n\\nv \\n\\nContents \\n\\n \\n\\fCHAPT\", \"ER  1 \\n\\nCharacteristics of Modern \\nWeb Applications \\n\\n\\u201c\\u2026 with proper design, the features come cheap\", \"ly. This approach is arduous, but continues to \\nsucceed.\\u201d \\n- Dennis Ritchie \\n\\nModern web application\", \"s have higher user expectations and greater demands than ever before. \\nToday\\u2019s web apps are expected\", \" to be available 24/7 from anywhere in the world, and usable from \\nvirtually any device or screen si\", \"ze. Web applications must be secure, flexible, and scalable to meet \\nspikes in demand. Increasingly,\", \" complex scenarios should be handled by rich user experiences built on \\nthe client using JavaScript,\", \" and communicating efficiently through web APIs. \\n\\nASP.NET Core is optimized for modern web applicat\", \"ions and cloud-based hosting scenarios. Its \\nmodular design enables applications to depend on only t\", \"hose features they actually use, improving \\napplication security and performance while reducing host\", \"ing resource requirements. \\n\\nReference application: eShopOnWeb \\n\\nThis guidance includes a reference \", \"application, eShopOnWeb, that demonstrates some of the \\nprinciples and recommendations. The applicat\", \"ion is a simple online store, which supports browsing \\nthrough a catalog of shirts, coffee mugs, and\", \" other marketing items. The reference application is \\ndeliberately simple in order to make it easy t\", \"o understand. \\n\\n1 \\n\\nCHAPTER 1 | Characteristics of Modern Web Applications \\n\\n \\n \\n\\fFigure 2-1. eShopO\", \"nWeb \\n\\nReference Application \\n\\n\\u2022 \\n\\neShopOnWeb \\nhttps://github.com/dotnet/eShopOnWeb \\n\\nCloud-hosted a\", \"nd scalable \\n\\nASP.NET Core is optimized for the cloud (public cloud, private cloud, any cloud) becau\", \"se it is low-\\nmemory and high-throughput. The smaller footprint of ASP.NET Core applications means y\", \"ou can \\nhost more of them on the same hardware, and you pay for fewer resources when using pay-as-yo\", \"u-\\ngo cloud hosting services. The higher-throughput means you can serve more customers from an \\nappl\", \"ication given the same hardware, further reducing the need to invest in servers and hosting \\ninfrast\", \"ructure. \\n\\nCross platform \\n\\nASP.NET Core is cross-platform and can run on Linux, macOS, and Windows.\", \" This capability opens up \\nmany new options for both the development and deployment of apps built wi\", \"th ASP.NET Core. \\n\\n2 \\n\\nCHAPTER 1 | Characteristics of Modern Web Applications \\n\\n \\n \\n \\n\\fDocker contai\", \"ners - both Linux and Windows - can host ASP.NET Core applications, allowing them to \\ntake advantage\", \" of the benefits of containers and microservices. \\n\\nModular and loosely coupled \\n\\nNuGet packages are\", \" first-class citizens in .NET Core, and ASP.NET Core apps are composed of many \\nlibraries through Nu\", \"Get. This granularity of functionality helps ensure apps only depend on and \\ndeploy functionality th\", \"ey actually require, reducing their footprint and security vulnerability surface \\narea. \\n\\nASP.NET Co\", \"re also fully supports dependency injection, both internally and at the application level. \\nInterfac\", \"es can have multiple implementations that can be swapped out as needed. Dependency \\ninjection allows\", \" apps to loosely couple to those interfaces, rather than specific implementations, \\nmaking them easi\", \"er to extend, maintain, and test. \\n\\nEasily tested with automated tests \\n\\nASP.NET Core applications s\", \"upport unit testing, and their loose coupling and support for dependency \\ninjection makes it easy to\", \" swap infrastructure concerns with fake implementations for test purposes. \\nASP.NET Core also ships \", \"with a TestServer that can be used to host apps in memory. Functional tests \\ncan then make requests \", \"to this in-memory server, exercising the full application stack (including \\nmiddleware, routing, mod\", \"el binding, filters, etc.) and receiving a response, all in a fraction of the time \\nit would take to\", \" host the app on a real server and make requests through the network layer. These \\ntests are especia\", \"lly easy to write, and valuable, for APIs, which are increasingly important in modern \\nweb applicati\", \"ons. \\n\\nTraditional and SPA behaviors supported \\n\\nTraditional web applications have involved little c\", \"lient-side behavior, but instead have relied on the \\nserver for all navigation, queries, and updates\", \" the app might need to make. Each new operation made \\nby the user would be translated into a new web\", \" request, with the result being a full page reload in the \\nend user\\u2019s browser. Classic Model-View-Co\", \"ntroller (MVC) frameworks typically follow this approach, \\nwith each new request corresponding to a \", \"different controller action, which in turn would work with a \\nmodel and return a view. Some individu\", \"al operations on a given page might be enhanced with AJAX \\n(Asynchronous JavaScript and XML) functio\", \"nality, but the overall architecture of the app used many \\ndifferent MVC views and URL endpoints. In\", \" addition, ASP.NET Core MVC also supports Razor Pages, a \\nsimpler way to organize MVC-style pages. \\n\", \"\\nSingle Page Applications (SPAs), by contrast, involve very few dynamically generated server-side pa\", \"ge \\nloads (if any). Many SPAs are initialized within a static HTML file that loads the necessary Jav\", \"aScript \\nlibraries to start and run the app. These apps make heavy usage of web APIs for their data \", \"needs and \\ncan provide much richer user experiences. Blazor WebAssembly provides a means of building\", \" SPAs \\nusing .NET code, which then runs in the client\\u2019s browser. \\n\\n3 \\n\\nCHAPTER 1 | Characteristics o\", \"f Modern Web Applications \\n\\n \\n \\n\\fMany web applications involve a combination of traditional web appl\", \"ication behavior (typically for \\ncontent) and SPAs (for interactivity). ASP.NET Core supports both M\", \"VC (Views or Page based) and web \\nAPIs in the same application, using the same set of tools and unde\", \"rlying framework libraries. \\n\\nSimple development and deployment \\n\\nASP.NET Core applications can be w\", \"ritten using simple text editors and command-line interfaces, or \\nfull-featured development environm\", \"ents like Visual Studio. Monolithic applications are typically \\ndeployed to a single endpoint. Deplo\", \"yments can easily be automated to occur as part of a continuous \\nintegration (CI) and continuous del\", \"ivery (CD) pipeline. In addition to traditional CI/CD tools, Microsoft \\nAzure has integrated support\", \" for git repositories and can automatically deploy updates as they are \\nmade to a specified git bran\", \"ch or tag. Azure DevOps provides a full-featured CI/CD build and \\ndeployment pipeline, and GitHub Ac\", \"tions provide another option for projects hosted there. \\n\\nTraditional ASP.NET and Web Forms \\n\\nIn add\", \"ition to ASP.NET Core, traditional ASP.NET 4.x continues to be a robust and reliable platform for \\nb\", \"uilding web applications. ASP.NET supports MVC and Web API development models, as well as Web \\nForms\", \", which is well suited to rich page-based application development and features a rich third-party \\nc\", \"omponent ecosystem. Microsoft Azure has great longstanding support for ASP.NET 4.x applications, \\nan\", \"d many developers are familiar with this platform. \\n\\nBlazor \\n\\nBlazor is included with ASP.NET Core 3\", \".0 and later. It provides a new mechanism for building rich \\ninteractive web client applications usi\", \"ng Razor, C#, and ASP.NET Core. It offers another solution to \\nconsider when developing modern web a\", \"pplications. There are two versions of Blazor to consider: \\nserver-side and client-side. \\n\\nServer-si\", \"de Blazor was released in 2019 with ASP.NET Core 3.0. As its name implies, it runs on the \\nserver, r\", \"endering changes to the client document back to the browser over the network. Server-side \\nBlazor pr\", \"ovides a rich client experience without requiring client-side JavaScript and without requiring \\nsepa\", \"rate page loads for each client page interaction. Changes in the loaded page are requested from \\nand\", \" processed by the server and then sent back to the client using SignalR. \\n\\nClient-side Blazor, relea\", \"sed in 2020, eliminates the need to render changes on the server. Instead, it \\nleverages WebAssembly\", \" to run .NET code within the client. The client can still make API calls to the \\nserver if needed to\", \" request data, but all client-side behavior runs in the client via WebAssembly, which \\nis already su\", \"pported by all major browsers and is just a JavaScript library. \\n\\nReferences \\u2013 Modern Web Applicatio\", \"ns \\n\\n\\u2022 \\n\\nIntroduction to ASP.NET Core \\nhttps://learn.microsoft.com/aspnet/core/ \\n\\n4 \\n\\nCHAPTER 1 | Ch\", \"aracteristics of Modern Web Applications \\n\\n \\n \\n\\f\\u2022 \\n\\n\\u2022 \\n\\nTesting in ASP.NET Core \\nhttps://learn.micro\", \"soft.com/aspnet/core/testing/ \\n\\nBlazor - Get Started \\nhttps://blazor.net/docs/get-started.html \\n\\n5 \\n\", \"\\nCHAPTER 1 | Characteristics of Modern Web Applications \\n\\n \\n \\n\\fCHAPTER  2 \\n\\nChoose Between \\nTraditio\", \"nal Web Apps and \\nSingle Page Apps (SPAs) \\n\\n\\u201cAtwood\\u2019s Law: Any application that can be written in Ja\", \"vaScript, will eventually be written in \\nJavaScript.\\u201d \\n- Jeff Atwood \\n\\nThere are two general approac\", \"hes to building web applications today: traditional web applications \\nthat perform most of the appli\", \"cation logic on the server, and single-page applications (SPAs) that \\nperform most of the user inter\", \"face logic in a web browser, communicating with the web server \\nprimarily using web APIs. A hybrid a\", \"pproach is also possible, the simplest being host one or more rich \\nSPA-like subapplications within \", \"a larger traditional web application. \\n\\nUse traditional web applications when: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nYour ap\", \"plication\\u2019s client-side requirements are simple or even read-only. \\n\\nYour application needs to funct\", \"ion in browsers without JavaScript support. \\n\\nYour application is public-facing and benefits from se\", \"arch engine discovery and referrals. \\n\\nUse a SPA when: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nYour application must expose a \", \"rich user interface with many features. \\n\\nYour team is familiar with JavaScript, TypeScript, or Blaz\", \"or WebAssembly development. \\n\\nYour application must already expose an API for other (internal or pub\", \"lic) clients. \\n\\nAdditionally, SPA frameworks require greater architectural and security expertise. T\", \"hey experience \\ngreater churn due to frequent updates and new client frameworks than traditional web\", \" applications. \\nConfiguring automated build and deployment processes and utilizing deployment option\", \"s like \\ncontainers may be more difficult with SPA applications than traditional web apps. \\n\\nImprovem\", \"ents in user experience made possible by the SPA approach must be weighed against these \\nconsiderati\", \"ons. \\n\\n6 \\n\\nCHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs) \\n\\n \\n \\n\\fBlazor\", \" \\n\\nASP.NET Core includes a model for building rich, interactive, and composable user interfaces call\", \"ed \\nBlazor. Blazor server-side allows developers to build UI with C# and Razor on the server and for\", \" the UI \\nto be interactively connected to the browser in real-time using a persistent SignalR connec\", \"tion. Blazor \\nWebAssembly introduces another option for Blazor apps, allowing them to run in the bro\", \"wser using \\nWebAssembly. Because it\\u2019s real .NET code running on WebAssembly, you can reuse code and \", \"libraries \\nfrom server-side parts of your application. \\n\\nBlazor provides a new, third option to cons\", \"ider when evaluating whether to build a purely server-\\nrendered web application or a SPA. You can bu\", \"ild rich, SPA-like client-side behaviors using Blazor, \\nwithout the need for significant JavaScript \", \"development. Blazor applications can call APIs to request \\ndata or perform server-side operations. T\", \"hey can interoperate with JavaScript where necessary to take \\nadvantage of JavaScript libraries and \", \"frameworks. \\n\\nConsider building your web application with Blazor when: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nYour application mu\", \"st expose a rich user interface \\n\\nYour team is more comfortable with .NET development than JavaScrip\", \"t or TypeScript \\ndevelopment \\n\\nIf you have an existing web forms application you\\u2019re considering migr\", \"ating to .NET Core or the latest \\n.NET, you may wish to review the free e-book, Blazor for Web Forms\", \" Developers to see whether it \\nmakes sense to consider migrating it to Blazor. \\n\\nFor more informatio\", \"n about Blazor, see Get started with Blazor. \\n\\nWhen to choose traditional web apps \\n\\nThe following s\", \"ection is a more detailed explanation of the previously stated reasons for picking \\ntraditional web \", \"applications. \\n\\nYour application has simple, possibly read-only, client-side requirements \\n\\nMany web\", \" applications are primarily consumed in a read-only fashion by the vast majority of their \\nusers. Re\", \"ad-only (or read-mostly) applications tend to be much simpler than those applications that \\nmaintain\", \" and manipulate a great deal of state. For example, a search engine might consist of a single \\nentry\", \" point with a textbox and a second page for displaying search results. Anonymous users can \\neasily m\", \"ake requests, and there is little need for client-side logic. Likewise, a blog or content \\nmanagemen\", \"t system\\u2019s public-facing application usually consists mainly of content with little client-\\nside beh\", \"avior. Such applications are easily built as traditional server-based web applications, which \\nperfo\", \"rm logic on the web server and render HTML to be displayed in the browser. The fact that each \\nuniqu\", \"e page of the site has its own URL that can be bookmarked and indexed by search engines (by \\ndefault\", \", without having to add this functionality as a separate feature of the application) is also a clear\", \" \\nbenefit in such scenarios. \\n\\nYour application needs to function in browsers without JavaScript sup\", \"port \\n\\n7 \\n\\nCHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs) \\n\\n \\n \\n\\fWeb ap\", \"plications that need to function in browsers with limited or no JavaScript support should be \\nwritte\", \"n using traditional web app workflows (or at least be able to fall back to such behavior). SPAs \\nreq\", \"uire client-side JavaScript in order to function; if it\\u2019s not available, SPAs are not a good choice.\", \" \\n\\nYour team is unfamiliar with JavaScript or TypeScript development techniques \\n\\nIf your team is un\", \"familiar with JavaScript or TypeScript, but is familiar with server-side web application \\ndevelopmen\", \"t, then they will probably be able to deliver a traditional web app more quickly than a \\nSPA. Unless\", \" learning to program SPAs is a goal, or the user experience afforded by a SPA is required, \\ntraditio\", \"nal web apps are a more productive choice for teams who are already familiar with building \\nthem. \\n\\n\", \"When to choose SPAs \\n\\nThe following section is a more detailed explanation of when to choose a Singl\", \"e Page Applications \\nstyle of development for your web app. \\n\\nYour application must expose a rich us\", \"er interface with many features \\n\\nSPAs can support rich client-side functionality that doesn\\u2019t requi\", \"re reloading the page as users take \\nactions or navigate between areas of the app. SPAs can load mor\", \"e quickly, fetching data in the \\nbackground, and individual user actions are more responsive since f\", \"ull page reloads are rare. SPAs can \\nsupport incremental updates, saving partially completed forms o\", \"r documents without the user having \\nto click a button to submit a form. SPAs can support rich clien\", \"t-side behaviors, such as drag-and-drop, \\nmuch more readily than traditional applications. SPAs can \", \"be designed to run in a disconnected mode, \\nmaking updates to a client-side model that are eventuall\", \"y synchronized back to the server once a \\nconnection is re-established. Choose a SPA-style applicati\", \"on if your app\\u2019s requirements include rich \\nfunctionality that goes beyond what typical HTML forms o\", \"ffer. \\n\\nFrequently, SPAs need to implement features that are built into traditional web apps, such a\", \"s \\ndisplaying a meaningful URL in the address bar reflecting the current operation (and allowing use\", \"rs to \\nbookmark or deep link to this URL to return to it). SPAs also should allow users to use the b\", \"rowser\\u2019s \\nback and forward buttons with results that won\\u2019t surprise them. \\n\\nYour team is familiar wi\", \"th JavaScript and/or TypeScript development \\n\\nWriting SPAs requires familiarity with JavaScript and/\", \"or TypeScript and client-side programming \\ntechniques and libraries. Your team should be competent i\", \"n writing modern JavaScript using a SPA \\nframework like Angular. \\n\\nReferences \\u2013 SPA Frameworks \\n\\n\\u2022 \\n\", \"\\n\\u2022 \\n\\n\\u2022 \\n\\nAngular: https://angular.io \\n\\nReact: https://reactjs.org/ \\n\\nVue.js: https://vuejs.org/ \\n\\nYo\", \"ur application must already expose an API for other (internal or public) clients \\n\\n8 \\n\\nCHAPTER 2 | C\", \"hoose Between Traditional Web Apps and Single Page Apps (SPAs) \\n\\n \\n \\n\\fIf you\\u2019re already supporting a\", \" web API for use by other clients, it may require less effort to create a \\nSPA implementation that l\", \"everages these APIs rather than reproducing the logic in server-side form. \\nSPAs make extensive use \", \"of web APIs to query and update data as users interact with the application. \\n\\nWhen to choose Blazor\", \" \\n\\nThe following section is a more detailed explanation of when to choose Blazor for your web app. \\n\", \"\\nYour application must expose a rich user interface \\n\\nLike JavaScript-based SPAs, Blazor application\", \"s can support rich client behavior without page reloads. \\nThese applications are more responsive to \", \"users, fetching only the data (or HTML) required to respond \\nto a given user interaction. Designed p\", \"roperly, server-side Blazor apps can be configured to run as \\nclient-side Blazor apps with minimal c\", \"hanges once this feature is supported. \\n\\nYour team is more comfortable with .NET development than Ja\", \"vaScript or TypeScript \\ndevelopment \\n\\nMany developers are more productive with .NET and Razor than w\", \"ith client-side languages like \\nJavaScript or TypeScript. Since the server-side of the application i\", \"s already being developed with .NET, \\nusing Blazor ensures every .NET developer on the team can unde\", \"rstand and potentially build the \\nbehavior of the front end of the application. \\n\\nDecision table \\n\\nT\", \"he following decision table summarizes some of the basic factors to consider when choosing \\nbetween \", \"a traditional web application, a SPA, or a Blazor app. \\n\\nFactor \\n\\nRequired Team Familiarity with \\nJa\", \"vaScript/TypeScript \\n\\nTraditional Web \\nApp \\n\\nSingle Page \\nApplication \\n\\nBlazor \\nApp \\n\\nMinimal \\n\\nRequ\", \"ired \\n\\nMinimal \\n\\nSupport Browsers without Scripting \\n\\nSupported \\n\\nNot Supported \\n\\nMinimal Client-Sid\", \"e Application Behavior  Well-Suited \\n\\nOverkill \\n\\nRich, Complex User Interface \\nRequirements \\n\\nLimite\", \"d \\n\\nWell-Suited \\n\\nSupporte\\nd \\n\\nViable \\n\\nWell-\\nSuited \\n\\nOther considerations \\n\\nTraditional Web Apps t\", \"end to be simpler and have better Search Engine Optimization (SEO) criteria \\nthan SPA apps. Search e\", \"ngine bots can easily consume content from traditional apps, while support \\nfor indexing SPAs may be\", \" lacking or limited. If your app benefits from public discovery by search \\nengines, this is often an\", \" important consideration. \\n\\n9 \\n\\nCHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps\", \" (SPAs) \\n\\n \\n \\n\\fIn addition, unless you\\u2019ve built a management tool for your SPA\\u2019s content, it may req\", \"uire developers \\nto make changes. Traditional Web Apps are often easier for non-developers to make c\", \"hanges to, since \\nmuch of the content is simply HTML and may not require a build process to preview \", \"or even deploy. If \\nnon-developers in your organization are likely to need to maintain the content o\", \"f the app, a \\ntraditional web app may be a better choice. \\n\\nSPAs shine when the app has complex inte\", \"ractive forms or other user interaction features. For \\ncomplex apps that require authentication to u\", \"se, and thus aren\\u2019t accessible by public search engine \\nspiders, SPAs are a great option in many cas\", \"es. \\n\\n10 \\n\\nCHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs) \\n\\n \\n \\n\\fCHAPTE\", \"R  3 \\n\\nArchitectural principles \\n\\n\\u201cIf builders built buildings the way programmers wrote programs, t\", \"hen the first woodpecker that \\ncame along would destroy civilization.\\u201d \\n- Gerald Weinberg \\n\\nYou shou\", \"ld architect and design software solutions with maintainability in mind. The principles \\noutlined in\", \" this section can help guide you toward architectural decisions that will result in clean, \\nmaintain\", \"able applications. Generally, these principles will guide you toward building applications out \\nof d\", \"iscrete components that are not tightly coupled to other parts of your application, but rather \\ncomm\", \"unicate through explicit interfaces or messaging systems. \\n\\nCommon design principles \\n\\nSeparation of\", \" concerns \\n\\nA guiding principle when developing is Separation of Concerns. This principle asserts th\", \"at software \\nshould be separated based on the kinds of work it performs. For instance, consider an a\", \"pplication that \\nincludes logic for identifying noteworthy items to display to the user, and which f\", \"ormats such items in \\na particular way to make them more noticeable. The behavior responsible for ch\", \"oosing which items to \\nformat should be kept separate from the behavior responsible for formatting t\", \"he items, since these \\nbehaviors are separate concerns that are only coincidentally related to one a\", \"nother. \\n\\nArchitecturally, applications can be logically built to follow this principle by separatin\", \"g core business \\nbehavior from infrastructure and user-interface logic. Ideally, business rules and \", \"logic should reside in \\na separate project, which should not depend on other projects in the applica\", \"tion. This separation \\nhelps ensure that the business model is easy to test and can evolve without b\", \"eing tightly coupled to \\nlow-level implementation details (it also helps if infrastructure concerns \", \"depend on abstractions \\ndefined in the business layer). Separation of concerns is a key consideratio\", \"n behind the use of layers \\nin application architectures. \\n\\nEncapsulation \\n\\nDifferent parts of an ap\", \"plication should use encapsulation to insulate them from other parts of the \\napplication. Applicatio\", \"n components and layers should be able to adjust their internal implementation \\nwithout breaking the\", \"ir collaborators as long as external contracts are not violated. Proper use of \\nencapsulation helps \", \"achieve loose coupling and modularity in application designs, since objects and \\npackages can be rep\", \"laced with alternative implementations so long as the same interface is \\nmaintained. \\n\\n11 \\n\\nCHAPTER \", \"3 | Architectural principles \\n\\n \\n \\n\\fIn classes, encapsulation is achieved by limiting outside access\", \" to the class\\u2019s internal state. If an \\noutside actor wants to manipulate the state of the object, it\", \" should do so through a well-defined \\nfunction (or property setter), rather than having direct acces\", \"s to the private state of the object. \\nLikewise, application components and applications themselves \", \"should expose well-defined interfaces \\nfor their collaborators to use, rather than allowing their st\", \"ate to be modified directly. This approach \\nfrees the application\\u2019s internal design to evolve over t\", \"ime without worrying that doing so will break \\ncollaborators, so long as the public contracts are ma\", \"intained. \\n\\nMutable global state is antithetical to encapsulation. A value fetched from mutable glob\", \"al state in one \\nfunction cannot be relied upon to have the same value in another function (or even \", \"further in the \\nsame function). Understanding concerns with mutable global state is one of the reaso\", \"ns programming \\nlanguages like C# have support for different scoping rules, which are used everywher\", \"e from \\nstatements to methods to classes. It\\u2019s worth noting that data-driven architectures which rel\", \"y on a \\ncentral database for integration within and between applications are, themselves, choosing t\", \"o depend \\non the mutable global state represented by the database. A key consideration in domain-dri\", \"ven \\ndesign and clean architecture is how to encapsulate access to data, and how to ensure applicati\", \"on \\nstate is not made invalid by direct access to its persistence format. \\n\\nDependency inversion \\n\\nT\", \"he direction of dependency within the application should be in the direction of abstraction, not \\nim\", \"plementation details. Most applications are written such that compile-time dependency flows in the \\n\", \"direction of runtime execution, producing a direct dependency graph. That is, if class A calls a met\", \"hod \\nof class B and class B calls a method of class C, then at compile time class A will depend on c\", \"lass B, \\nand class B will depend on class C, as shown in Figure 4-1. \\n\\n12 \\n\\nCHAPTER 3 | Architectura\", \"l principles \\n\\n \\n \\n\\fFigure 4-1. Direct dependency graph. \\n\\nApplying the dependency inversion princip\", \"le allows A to call methods on an abstraction that B \\nimplements, making it possible for A to call B\", \" at run time, but for B to depend on an interface \\ncontrolled by A at compile time (thus, inverting \", \"the typical compile-time dependency). At run time, the \\nflow of program execution remains unchanged,\", \" but the introduction of interfaces means that different \\nimplementations of these interfaces can ea\", \"sily be plugged in. \\n\\n13 \\n\\nCHAPTER 3 | Architectural principles \\n\\n \\n \\n \\n\\fFigure 4-2. Inverted depend\", \"ency graph. \\n\\nDependency inversion is a key part of building loosely coupled applications, since imp\", \"lementation \\ndetails can be written to depend on and implement higher-level abstractions, rather tha\", \"n the other \\nway around. The resulting applications are more testable, modular, and maintainable as \", \"a result. The \\npractice of dependency injection is made possible by following the dependency inversi\", \"on principle. \\n\\nExplicit dependencies \\n\\nMethods and classes should explicitly require any collaborat\", \"ing objects they need in order to \\nfunction correctly. It is called the Explicit Dependencies Princi\", \"ple. Class constructors provide an \\nopportunity for classes to identify the things they need in orde\", \"r to be in a valid state and to function \\nproperly. If you define classes that can be constructed an\", \"d called, but that will only function properly \\nif certain global or infrastructure components are i\", \"n place, these classes are being dishonest with their \\nclients. The constructor contract is telling \", \"the client that it only needs the things specified (possibly \\nnothing if the class is just using a p\", \"arameterless constructor), but then at runtime it turns out the \\nobject really did need something el\", \"se. \\n\\nBy following the explicit dependencies principle, your classes and methods are being honest wi\", \"th their \\nclients about what they need in order to function. Following the principle makes your code\", \" more self-\\ndocumenting and your coding contracts more user-friendly, since users will come to trust\", \" that as long \\nas they provide what\\u2019s required in the form of method or constructor parameters, the \", \"objects they\\u2019re \\nworking with will behave correctly at run time. \\n\\nSingle responsibility \\n\\nThe singl\", \"e responsibility principle applies to object-oriented design, but can also be considered as an \\narch\", \"itectural principle similar to separation of concerns. It states that objects should have only one \\n\", \"responsibility and that they should have only one reason to change. Specifically, the only situation\", \" in \\nwhich the object should change is if the manner in which it performs its one responsibility mus\", \"t be \\n\\n14 \\n\\nCHAPTER 3 | Architectural principles \\n\\n \\n \\n \\n\\fupdated. Following this principle helps to\", \" produce more loosely coupled and modular systems, since \\nmany kinds of new behavior can be implemen\", \"ted as new classes, rather than by adding additional \\nresponsibility to existing classes. Adding new\", \" classes is always safer than changing existing classes, \\nsince no code yet depends on the new class\", \"es. \\n\\nIn a monolithic application, we can apply the single responsibility principle at a high level \", \"to the layers \\nin the application. Presentation responsibility should remain in the UI project, whil\", \"e data access \\nresponsibility should be kept within an infrastructure project. Business logic should\", \" be kept in the \\napplication core project, where it can be easily tested and can evolve independentl\", \"y from other \\nresponsibilities. \\n\\nWhen this principle is applied to application architecture and tak\", \"en to its logical endpoint, you get \\nmicroservices. A given microservice should have a single respon\", \"sibility. If you need to extend the \\nbehavior of a system, it\\u2019s usually better to do it by adding ad\", \"ditional microservices, rather than by \\nadding responsibility to an existing one. \\n\\nLearn more about\", \" microservices architecture \\n\\nDon\\u2019t repeat yourself (DRY) \\n\\nThe application should avoid specifying \", \"behavior related to a particular concept in multiple places as \\nthis practice is a frequent source o\", \"f errors. At some point, a change in requirements will require \\nchanging this behavior. It\\u2019s likely \", \"that at least one instance of the behavior will fail to be updated, and \\nthe system will behave inco\", \"nsistently. \\n\\nRather than duplicating logic, encapsulate it in a programming construct. Make this co\", \"nstruct the \\nsingle authority over this behavior, and have any other part of the application that re\", \"quires this \\nbehavior use the new construct. \\n\\nNote \\n\\nAvoid binding together behavior that is only c\", \"oincidentally repetitive. For example, just because two \\ndifferent constants both have the same valu\", \"e, that doesn\\u2019t mean you should have only one constant, if \\nconceptually they\\u2019re referring to differ\", \"ent things. Duplication is always preferable to coupling to the \\nwrong abstraction. \\n\\nPersistence ig\", \"norance \\n\\nPersistence ignorance (PI) refers to types that need to be persisted, but whose code is un\", \"affected by \\nthe choice of persistence technology. Such types in .NET are sometimes referred to as P\", \"lain Old CLR \\nObjects (POCOs), because they do not need to inherit from a particular base class or i\", \"mplement a \\nparticular interface. Persistence ignorance is valuable because it allows the same busin\", \"ess model to be \\npersisted in multiple ways, offering additional flexibility to the application. Per\", \"sistence choices might \\nchange over time, from one database technology to another, or additional for\", \"ms of persistence might \\nbe required in addition to whatever the application started with (for examp\", \"le, using a Redis cache or \\nAzure Cosmos DB in addition to a relational database). \\n\\nSome examples o\", \"f violations of this principle include: \\n\\n15 \\n\\nCHAPTER 3 | Architectural principles \\n\\n \\n \\n\\f\\u2022 \\n\\n\\u2022 \\n\\n\\u2022\", \" \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nA required base class. \\n\\nA required interface implementation. \\n\\nClasses responsible f\", \"or saving themselves (such as the Active Record pattern). \\n\\nRequired parameterless constructor. \\n\\nPr\", \"operties requiring virtual keyword. \\n\\nPersistence-specific required attributes. \\n\\nThe requirement th\", \"at classes have any of the above features or behaviors adds coupling between the \\ntypes to be persis\", \"ted and the choice of persistence technology, making it more difficult to adopt new \\ndata access str\", \"ategies in the future. \\n\\nBounded contexts \\n\\nBounded contexts are a central pattern in Domain-Driven \", \"Design. They provide a way of tackling \\ncomplexity in large applications or organizations by breakin\", \"g it up into separate conceptual modules. \\nEach conceptual module then represents a context that is \", \"separated from other contexts (hence, \\nbounded), and can evolve independently. Each bounded context \", \"should ideally be free to choose its \\nown names for concepts within it, and should have exclusive ac\", \"cess to its own persistence store. \\n\\nAt a minimum, individual web applications should strive to be t\", \"heir own bounded context, with their \\nown persistence store for their business model, rather than sh\", \"aring a database with other applications. \\nCommunication between bounded contexts occurs through pro\", \"grammatic interfaces, rather than \\nthrough a shared database, which allows for business logic and ev\", \"ents to take place in response to \\nchanges that take place. Bounded contexts map closely to microser\", \"vices, which also are ideally \\nimplemented as their own individual bounded contexts. \\n\\nAdditional re\", \"sources \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nPrinciples \\n\\nBounded Context \\n\\n16 \\n\\nCHAPTER 3 | Architectural principles \\n\\n \\n \\n\\fCH\", \"APTER  4 \\n\\nCommon web application \\narchitectures \\n\\n\\u201cIf you think good architecture is expensive, try\", \" bad architecture.\\u201d - Brian Foote and Joseph Yoder \\n\\nMost traditional .NET applications are deployed\", \" as single units corresponding to an executable or a \\nsingle web application running within a single\", \" IIS appdomain. This approach is the simplest \\ndeployment model and serves many internal and smaller\", \" public applications very well. However, even \\ngiven this single unit of deployment, most non-trivia\", \"l business applications benefit from some logical \\nseparation into several layers. \\n\\nWhat is a monol\", \"ithic application? \\n\\nA monolithic application is one that is entirely self-contained, in terms of it\", \"s behavior. It may interact \\nwith other services or data stores in the course of performing its oper\", \"ations, but the core of its \\nbehavior runs within its own process and the entire application is typi\", \"cally deployed as a single unit. If \\nsuch an application needs to scale horizontally, typically the \", \"entire application is duplicated across \\nmultiple servers or virtual machines. \\n\\nAll-in-one applicat\", \"ions \\n\\nThe smallest possible number of projects for an application architecture is one. In this arch\", \"itecture, the \\nentire logic of the application is contained in a single project, compiled to a singl\", \"e assembly, and \\ndeployed as a single unit. \\n\\nA new ASP.NET Core project, whether created in Visual \", \"Studio or from the command line, starts out as \\na simple \\u201call-in-one\\u201d monolith. It contains all of t\", \"he behavior of the application, including \\npresentation, business, and data access logic. Figure 5-1\", \" shows the file structure of a single-project \\napp. \\n\\n17 \\n\\nCHAPTER 4 | Common web application archit\", \"ectures \\n\\n \\n \\n\\fFigure 5-1. A single project ASP.NET Core app. \\n\\nIn a single project scenario, separa\", \"tion of concerns is achieved through the use of folders. The default \\ntemplate includes separate fol\", \"ders for MVC pattern responsibilities of Models, Views, and Controllers, \\nas well as additional fold\", \"ers for Data and Services. In this arrangement, presentation details should be \\nlimited as much as p\", \"ossible to the Views folder, and data access implementation details should be \\nlimited to classes ke\", \"pt in the Data folder. Business logic should reside in services and classes within \\nthe Models folde\", \"r. \\n\\nAlthough simple, the single-project monolithic solution has some disadvantages. As the project\\u2019\", \"s size \\nand complexity grows, the number of files and folders will continue to grow as well. User in\", \"terface (UI) \\nconcerns (models, views, controllers) reside in multiple folders, which aren\\u2019t grouped\", \" together \\nalphabetically. This issue only gets worse when additional UI-level constructs, such as F\", \"ilters or \\nModelBinders, are added in their own folders. Business logic is scattered between the Mod\", \"els and \\nServices folders, and there\\u2019s no clear indication of which classes in which folders should \", \"depend on \\nwhich others. This lack of organization at the project level frequently leads to spaghett\", \"i code. \\n\\nTo address these issues, applications often evolve into multi-project solutions, where eac\", \"h project is \\nconsidered to reside in a particular layer of the application. \\n\\nWhat are layers? \\n\\nAs\", \" applications grow in complexity, one way to manage that complexity is to break up the application \\n\", \"according to its responsibilities or concerns. This approach follows the separation of concerns \\npri\", \"nciple and can help keep a growing codebase organized so that developers can easily find where \\ncert\", \"ain functionality is implemented. Layered architecture offers a number of advantages beyond just \\nco\", \"de organization, though. \\n\\n18 \\n\\nCHAPTER 4 | Common web application architectures \\n\\n \\n \\n \\n\\fBy organiz\", \"ing code into layers, common low-level functionality can be reused throughout the \\napplication. This\", \" reuse is beneficial because it means less code needs to be written and because it can \\nallow the ap\", \"plication to standardize on a single implementation, following the don\\u2019t repeat yourself \\n(DRY) prin\", \"ciple. \\n\\nWith a layered architecture, applications can enforce restrictions on which layers can comm\", \"unicate \\nwith other layers. This architecture helps to achieve encapsulation. When a layer is change\", \"d or \\nreplaced, only those layers that work with it should be impacted. By limiting which layers dep\", \"end on \\nwhich other layers, the impact of changes can be mitigated so that a single change doesn\\u2019t i\", \"mpact the \\nentire application. \\n\\nLayers (and encapsulation) make it much easier to replace functiona\", \"lity within the application. For \\nexample, an application might initially use its own SQL Server dat\", \"abase for persistence, but later could \\nchoose to use a cloud-based persistence strategy, or one beh\", \"ind a web API. If the application has \\nproperly encapsulated its persistence implementation within a\", \" logical layer, that SQL Server-specific \\nlayer could be replaced by a new one implementing the same\", \" public interface. \\n\\nIn addition to the potential of swapping out implementations in response to fut\", \"ure changes in \\nrequirements, application layers can also make it easier to swap out implementations\", \" for testing \\npurposes. Instead of having to write tests that operate against the real data layer or\", \" UI layer of the \\napplication, these layers can be replaced at test time with fake implementations t\", \"hat provide known \\nresponses to requests. This approach typically makes tests much easier to write a\", \"nd much faster to \\nrun when compared to running tests against the application\\u2019s real infrastructure.\", \" \\n\\nLogical layering is a common technique for improving the organization of code in enterprise softw\", \"are \\napplications, and there are several ways in which code can be organized into layers. \\n\\nNote \\n\\nL\", \"ayers represent logical separation within the application. In the event that application logic is \\np\", \"hysically distributed to separate servers or processes, these separate physical deployment targets a\", \"re \\nreferred to as tiers. It\\u2019s possible, and quite common, to have an N-Layer application that is de\", \"ployed \\nto a single tier. \\n\\nTraditional \\u201cN-Layer\\u201d architecture applications \\n\\nThe most common organi\", \"zation of application logic into layers is shown in Figure 5-2. \\n\\n19 \\n\\nCHAPTER 4 | Common web applic\", \"ation architectures \\n\\n \\n \\n\\fFigure 5-2. Typical application layers. \\n\\nThese layers are frequently abb\", \"reviated as UI, BLL (Business Logic Layer), and DAL (Data Access Layer). \\nUsing this architecture, u\", \"sers make requests through the UI layer, which interacts only with the BLL. \\nThe BLL, in turn, can c\", \"all the DAL for data access requests. The UI layer shouldn\\u2019t make any requests to \\nthe DAL directly,\", \" nor should it interact with persistence directly through other means. Likewise, the BLL \\nshould onl\", \"y interact with persistence by going through the DAL. In this way, each layer has its own \\nwell-know\", \"n responsibility. \\n\\nOne disadvantage of this traditional layering approach is that compile-time depe\", \"ndencies run from \\nthe top to the bottom. That is, the UI layer depends on the BLL, which depends on\", \" the DAL. This \\nmeans that the BLL, which usually holds the most important logic in the application,\", \" is dependent on \\ndata access implementation details (and often on the existence of a database). Tes\", \"ting business logic \\nin such an architecture is often difficult, requiring a test database. The depe\", \"ndency inversion principle \\ncan be used to address this issue, as you\\u2019ll see in the next section. \\n\\n\", \"Figure 5-3 shows an example solution, breaking the application into three projects by responsibility\", \" \\n(or layer). \\n\\n20 \\n\\nCHAPTER 4 | Common web application architectures \\n\\n \\n \\n \\n\\fFigure 5-3. A simple \", \"monolithic application with three projects. \\n\\nAlthough this application uses several projects for or\", \"ganizational purposes, it\\u2019s still deployed as a \\nsingle unit and its clients will interact with it a\", \"s a single web app. This allows for very simple \\ndeployment process. Figure 5-4 shows how such an ap\", \"p might be hosted using Azure. \\n\\nFigure 5-4. Simple deployment of Azure Web App \\n\\nAs application nee\", \"ds grow, more complex and robust deployment solutions may be required. Figure \\n5-5 shows an example \", \"of a more complex deployment plan that supports additional capabilities. \\n\\n21 \\n\\nCHAPTER 4 | Common w\", \"eb application architectures \\n\\n \\n \\n \\n \\n\\fFigure 5-5. Deploying a web app to an Azure App Service \\n\\nIn\", \"ternally, this project\\u2019s organization into multiple projects based on responsibility improves the \\nm\", \"aintainability of the application. \\n\\nThis unit can be scaled up or out to take advantage of cloud-ba\", \"sed on-demand scalability. Scaling up \\nmeans adding additional CPU, memory, disk space, or other res\", \"ources to the server(s) hosting your \\napp. Scaling out means adding additional instances of such ser\", \"vers, whether these are physical \\nservers, virtual machines, or containers. When your app is hosted \", \"across multiple instances, a load \\nbalancer is used to assign requests to individual app instances. \", \"\\n\\nThe simplest approach to scaling a web application in Azure is to configure scaling manually in th\", \"e \\napplication\\u2019s App Service Plan. Figure 5-6 shows the appropriate Azure dashboard screen to config\", \"ure \\nhow many instances are serving an app. \\n\\n22 \\n\\nCHAPTER 4 | Common web application architectures \", \"\\n\\n \\n \\n \\n\\fFigure 5-6. App Service Plan scaling in Azure. \\n\\nClean architecture \\n\\nApplications that fol\", \"low the Dependency Inversion Principle as well as the Domain-Driven Design \\n(DDD) principles tend to\", \" arrive at a similar architecture. This architecture has gone by many names \\nover the years. One of \", \"the first names was Hexagonal Architecture, followed by Ports-and-Adapters. \\nMore recently, it\\u2019s bee\", \"n cited as the Onion Architecture or Clean Architecture. The latter name, Clean \\nArchitecture, is us\", \"ed as the name for this architecture in this e-book. \\n\\nThe eShopOnWeb reference application uses the\", \" Clean Architecture approach in organizing its code \\ninto projects. You can find a solution template\", \" you can use as a starting point for your own ASP.NET \\nCore solutions in the ardalis/cleanarchitectu\", \"re GitHub repository or by installing the template from \\nNuGet. \\n\\nClean architecture puts the busine\", \"ss logic and application model at the center of the application. \\nInstead of having business logic d\", \"epend on data access or other infrastructure concerns, this \\ndependency is inverted: infrastructure \", \"and implementation details depend on the Application Core. \\nThis functionality is achieved by defini\", \"ng abstractions, or interfaces, in the Application Core, which are \\nthen implemented by types define\", \"d in the Infrastructure layer. A common way of visualizing this \\narchitecture is to use a series of \", \"concentric circles, similar to an onion. Figure 5-7 shows an example of \\nthis style of architectural\", \" representation. \\n\\n23 \\n\\nCHAPTER 4 | Common web application architectures \\n\\n \\n \\n \\n\\fFigure 5-7. Clean \", \"Architecture; onion view \\n\\nIn this diagram, dependencies flow toward the innermost circle. The Appli\", \"cation Core takes its name \\nfrom its position at the core of this diagram. And you can see on the di\", \"agram that the Application \\nCore has no dependencies on other application layers. The application\\u2019s \", \"entities and interfaces are at \\nthe very center. Just outside, but still in the Application Core, ar\", \"e domain services, which typically \\nimplement interfaces defined in the inner circle. Outside of the\", \" Application Core, both the UI and the \\nInfrastructure layers depend on the Application Core, but no\", \"t on one another (necessarily). \\n\\nFigure 5-8 shows a more traditional horizontal layer diagram that \", \"better reflects the dependency \\nbetween the UI and other layers. \\n\\n24 \\n\\nCHAPTER 4 | Common web appli\", \"cation architectures \\n\\n \\n \\n \\n\\fFigure 5-8. Clean Architecture; horizontal layer view \\n\\nNote that the \", \"solid arrows represent compile-time dependencies, while the dashed arrow represents a \\nruntime-only \", \"dependency. With the clean architecture, the UI layer works with interfaces defined in \\nthe Applicat\", \"ion Core at compile time, and ideally shouldn\\u2019t know about the implementation types \\ndefined in the \", \"Infrastructure layer. At run time, however, these implementation types are required for \\nthe app to \", \"execute, so they need to be present and wired up to the Application Core interfaces via \\ndependency \", \"injection. \\n\\nFigure 5-9 shows a more detailed view of an ASP.NET Core application\\u2019s architecture whe\", \"n built \\nfollowing these recommendations. \\n\\n25 \\n\\nCHAPTER 4 | Common web application architectures \\n\\n\", \" \\n \\n \\n\\fFigure 5-9. ASP.NET Core architecture diagram following Clean Architecture. \\n\\nBecause the App\", \"lication Core doesn\\u2019t depend on Infrastructure, it\\u2019s very easy to write automated unit \\ntests for th\", \"is layer. Figures 5-10 and 5-11 show how tests fit into this architecture. \\n\\nFigure 5-10. Unit testi\", \"ng Application Core in isolation. \\n\\n26 \\n\\nCHAPTER 4 | Common web application architectures \\n\\n \\n \\n \\n \\n\", \"\\fFigure 5-11. Integration testing Infrastructure implementations with external dependencies. \\n\\nSince\", \" the UI layer doesn\\u2019t have any direct dependency on types defined in the Infrastructure project, \\nit\", \"\\u2019s likewise very easy to swap out implementations, either to facilitate testing or in response to \\nc\", \"hanging application requirements. ASP.NET Core\\u2019s built-in use of and support for dependency \\ninjecti\", \"on makes this architecture the most appropriate way to structure non-trivial monolithic \\napplication\", \"s. \\n\\nFor monolithic applications, the Application Core, Infrastructure, and UI projects are all run \", \"as a single \\napplication. The runtime application architecture might look something like Figure 5-12\", \". \\n\\n27 \\n\\nCHAPTER 4 | Common web application architectures \\n\\n \\n \\n \\n\\fFigure 5-12. A sample ASP.NET Cor\", \"e app\\u2019s runtime architecture. \\n\\nOrganizing code in Clean Architecture \\n\\nIn a Clean Architecture solu\", \"tion, each project has clear responsibilities. As such, certain types belong \\nin each project and yo\", \"u\\u2019ll frequently find folders corresponding to these types in the appropriate \\nproject. \\n\\nApplication\", \" Core \\n\\nThe Application Core holds the business model, which includes entities, services, and interf\", \"aces. These \\ninterfaces include abstractions for operations that will be performed using Infrastruct\", \"ure, such as data \\naccess, file system access, network calls, etc. Sometimes services or interfaces \", \"defined at this layer will \\nneed to work with non-entity types that have no dependencies on UI or In\", \"frastructure. These can be \\ndefined as simple Data Transfer Objects (DTOs). \\n\\nApplication Core types\", \" \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nEntities (business model classes that are persisted) \\n\\nAggregates (gr\", \"oups of entities) \\n\\nInterfaces \\n\\nDomain Services \\n\\nSpecifications \\n\\nCustom Exceptions and Guard Clau\", \"ses \\n\\nDomain Events and Handlers \\n\\n28 \\n\\nCHAPTER 4 | Common web application architectures \\n\\n \\n \\n \\n\\fIn\", \"frastructure \\n\\nThe Infrastructure project typically includes data access implementations. In a typic\", \"al ASP.NET Core \\nweb application, these implementations include the Entity Framework (EF) DbContext,\", \" any EF Core \\nMigration objects that have been defined, and data access implementation classes. The \", \"most common \\nway to abstract data access implementation code is through the use of the Repository de\", \"sign pattern. \\n\\nIn addition to data access implementations, the Infrastructure project should contai\", \"n implementations \\nof services that must interact with infrastructure concerns. These services shoul\", \"d implement interfaces \\ndefined in the Application Core, and so Infrastructure should have a referen\", \"ce to the Application Core \\nproject. \\n\\nInfrastructure types \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nEF Core types (DbContext, \", \"Migration) \\n\\nData access implementation types (Repositories) \\n\\nInfrastructure-specific services (for\", \" example, FileLogger or SmtpNotifier) \\n\\nUI Layer \\n\\nThe user interface layer in an ASP.NET Core MVC a\", \"pplication is the entry point for the application. This \\nproject should reference the Application Co\", \"re project, and its types should interact with infrastructure \\nstrictly through interfaces defined i\", \"n Application Core. No direct instantiation of or static calls to the \\nInfrastructure layer types sh\", \"ould be allowed in the UI layer. \\n\\nUI Layer types \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nControllers \\n\\nCustom Fil\", \"ters \\n\\nCustom Middleware \\n\\nViews \\n\\nViewModels \\n\\nStartup \\n\\nThe Startup class or Program.cs file is re\", \"sponsible for configuring the application, and for wiring up \\nimplementation types to interfaces. Th\", \"e place where this logic is performed is known as the app\\u2019s \\ncomposition root, and is what allows de\", \"pendency injection to work properly at run time. \\n\\nNote \\n\\nIn order to wire up dependency injection d\", \"uring app startup, the UI layer project may need to \\nreference the Infrastructure project. This depe\", \"ndency can be eliminated, most easily by using a \\ncustom DI container that has built-in support for \", \"loading types from assemblies. For the purposes of \\nthis sample, the simplest approach is to allow t\", \"he UI project to reference the Infrastructure project \\n(but developers should limit actual reference\", \"s to types in the Infrastructure project to the app\\u2019s \\ncomposition root). \\n\\n29 \\n\\nCHAPTER 4 | Common \", \"web application architectures \\n\\n \\n \\n\\fMonolithic applications and containers \\n\\nYou can build a single\", \" and monolithic-deployment based Web Application or Service and deploy it as \\na container. Within th\", \"e application, it might not be monolithic but organized into several libraries, \\ncomponents, or laye\", \"rs. Externally, it\\u2019s a single container with a single process, single web application, \\nor single se\", \"rvice. \\n\\nTo manage this model, you deploy a single container to represent the application. To scale,\", \" just add \\nadditional copies with a load balancer in front. The simplicity comes from managing a sin\", \"gle \\ndeployment in a single container or VM. \\n\\nYou can include multiple components/libraries or inte\", \"rnal layers within each container, as illustrated in \\nFigure 5-13. But, following the container prin\", \"ciple of _\\u201ca container does one thing, and does it in one \\nprocess_\\u201d, the monolithic pattern might b\", \"e a conflict. \\n\\nThe downside of this approach comes if/when the application grows, requiring it to s\", \"cale. If the entire \\napplication scales, it\\u2019s not really a problem. However, in most cases, a few pa\", \"rts of the application are \\nthe choke points requiring scaling, while other components are used less\", \". \\n\\nUsing the typical eCommerce example, what you likely need to scale is the product information \\nc\", \"omponent. Many more customers browse products than purchase them. More customers use their \\nbasket t\", \"han use the payment pipeline. Fewer customers add comments or view their purchase history. \\nAnd you \", \"likely only have a handful of employees, in a single region, that need to manage the content \\nand ma\", \"rketing campaigns. By scaling the monolithic design, all the code is deployed multiple times. \\n\\nIn a\", \"ddition to the \\u201cscale everything\\u201d problem, changes to a single component require complete \\nretesting\", \" of the entire application, and a complete redeployment of all the instances. \\n\\nThe monolithic appro\", \"ach is common, and many organizations are developing with this architectural \\napproach. Many are hav\", \"ing good enough results, while others are hitting limits. Many designed their \\napplications in this \", \"model, because the tools and infrastructure were too difficult to build service-\\noriented architectu\", \"res (SOA), and they didn\\u2019t see the need until the app grew. If you find you\\u2019re hitting \\n\\n30 \\n\\nCHAPTE\", \"R 4 | Common web application architectures \\n\\n \\n \\n \\n\\fthe limits of the monolithic approach, breaking \", \"up the app to enable it to better leverage containers \\nand microservices may be the next logical ste\", \"p. \\n\\nDeploying monolithic applications in Microsoft Azure can be achieved using dedicated VMs for ea\", \"ch \\ninstance. Using Azure Virtual Machine Scale Sets, you can easily scale the VMs. Azure App Servic\", \"es can \\nrun monolithic applications and easily scale instances without having to manage the VMs. Azu\", \"re App \\nServices can run single instances of Docker containers as well, simplifying the deployment. \", \"Using \\nDocker, you can deploy a single VM as a Docker host, and run multiple instances. Using the Az\", \"ure \\nbalancer, as shown in the Figure 5-14, you can manage scaling. \\n\\nThe deployment to the various \", \"hosts can be managed with traditional deployment techniques. The \\nDocker hosts can be managed with c\", \"ommands like docker run performed manually, or through \\nautomation such as Continuous Delivery (CD) \", \"pipelines. \\n\\nMonolithic application deployed as a container \\n\\nThere are benefits of using containers\", \" to manage monolithic application deployments. Scaling the \\ninstances of containers is far faster an\", \"d easier than deploying additional VMs. Even when using virtual \\nmachine scale sets to scale VMs, th\", \"ey take time to create. When deployed as app instances, the \\nconfiguration of the app is managed as \", \"part of the VM. \\n\\nDeploying updates as Docker images is far faster and network efficient. Docker Ima\", \"ges typically start \\nin seconds, speeding rollouts. Tearing down a Docker instance is as easy as iss\", \"uing a docker stop \\ncommand, typically completing in less than a second. \\n\\n31 \\n\\nCHAPTER 4 | Common w\", \"eb application architectures \\n\\n \\n \\n \\n\\fAs containers are inherently immutable by design, you never ne\", \"ed to worry about corrupted VMs, \\nwhereas update scripts might forget to account for some specific c\", \"onfiguration or file left on the disk. \\n\\nYou can use Docker containers for a monolithic deployment o\", \"f simpler web applications. This \\napproach improves continuous integration and continuous deployment\", \" pipelines and helps achieve \\ndeployment-to-production success. No more \\u201cIt works on my machine, why\", \" does it not work in \\nproduction?\\u201d \\n\\nA microservices-based architecture has many benefits, but those\", \" benefits come at a cost of increased \\ncomplexity. In some cases, the costs outweigh the benefits, s\", \"o a monolithic deployment application \\nrunning in a single container or in just a few containers is \", \"a better option. \\n\\nA monolithic application might not be easily decomposable into well-separated mic\", \"roservices. \\nMicroservices should work independently of each other to provide a more resilient appli\", \"cation. If you \\ncan\\u2019t deliver independent feature slices of the application, separating it only adds\", \" complexity. \\n\\nAn application might not yet need to scale features independently. Many applications,\", \" when they \\nneed to scale beyond a single instance, can do so through the relatively simple process \", \"of cloning that \\nentire instance. The additional work to separate the application into discrete serv\", \"ices provides a \\nminimal benefit when scaling full instances of the application is simple and cost-e\", \"ffective. \\n\\nEarly in the development of an application, you might not have a clear idea where the na\", \"tural \\nfunctional boundaries are. As you develop a minimum viable product, the natural separation mi\", \"ght \\nnot yet have emerged. Some of these conditions might be temporary. You might start by creating \", \"a \\nmonolithic application, and later separate some features to be developed and deployed as \\nmicrose\", \"rvices. Other conditions might be essential to the application\\u2019s problem space, meaning that \\nthe ap\", \"plication might never be broken into multiple microservices. \\n\\nSeparating an application into many d\", \"iscrete processes also introduces overhead. There\\u2019s more \\ncomplexity in separating features into dif\", \"ferent processes. The communication protocols become \\nmore complex. Instead of method calls, you mus\", \"t use asynchronous communications between \\nservices. As you move to a microservices architecture, yo\", \"u need to add many of the building blocks \\nimplemented in the microservices version of the eShopOnCo\", \"ntainers application: event bus handling, \\nmessage resiliency and retries, eventual consistency, and\", \" more. \\n\\nThe much simpler eShopOnWeb reference application supports single-container monolithic cont\", \"ainer \\nusage. The application includes one web application that includes traditional MVC views, web \", \"APIs, \\nand Razor Pages. Optionally, you can run the application\\u2019s Blazor-based admin component, whic\", \"h \\nrequires a separate API project to run as well. \\n\\nThe application can be launched from the soluti\", \"on root using the docker-compose build and docker-\\ncompose up commands. This command configures a co\", \"ntainer for the web instance, using the \\nDockerfile found in the web project\\u2019s root, and runs the co\", \"ntainer on a specified port. You can \\ndownload the source for this application from GitHub and run i\", \"t locally. Even this monolithic \\napplication benefits from being deployed in a container environment\", \". \\n\\nFor one, the containerized deployment means that every instance of the application runs in the s\", \"ame \\nenvironment. This approach includes the developer environment where early testing and \\ndevelopm\", \"ent take place. The development team can run the application in a containerized \\nenvironment that ma\", \"tches the production environment. \\n\\n32 \\n\\nCHAPTER 4 | Common web application architectures \\n\\n \\n \\n\\fIn \", \"addition, containerized applications scale out at a lower cost. Using a container environment \\nenabl\", \"es greater resource sharing than traditional VM environments. \\n\\nFinally, containerizing the applicat\", \"ion forces a separation between the business logic and the storage \\nserver. As the application scale\", \"s out, the multiple containers will all rely on a single physical storage \\nmedium. This storage medi\", \"um would typically be a high-availability server running a SQL Server \\ndatabase. \\n\\nDocker support \\n\\n\", \"The eShopOnWeb project runs on .NET. Therefore, it can run in either Linux-based or Windows-based \\nc\", \"ontainers. Note that for Docker deployment, you want to use the same host type for SQL Server. \\nLinu\", \"x-based containers allow a smaller footprint and are preferred. \\n\\nYou can use Visual Studio 2017 or \", \"later to add Docker support to an existing application by right-\\nclicking on a project in Solution E\", \"xplorer and choosing Add > Docker Support. This step adds the \\nfiles required and modifies the proje\", \"ct to use them. The current eShopOnWeb sample already has \\nthese files in place. \\n\\nThe solution-leve\", \"l docker-compose.yml file contains information about what images to build and \\nwhat containers to la\", \"unch. The file allows you to use the docker-compose command to launch \\nmultiple applications at the \", \"same time. In this case, it is only launching the Web project. You can also \\nuse it to configure dep\", \"endencies, such as a separate database container. \\n\\nversion: '3' \\n\\nservices: \\n  eshopwebmvc: \\n    im\", \"age: eshopwebmvc \\n    build: \\n      context: . \\n      dockerfile: src/Web/Dockerfile \\n    environmen\", \"t: \\n      - ASPNETCORE_ENVIRONMENT=Development \\n    ports: \\n      - \\\"5106:5106\\\" \\n\\nnetworks: \\n  defau\", \"lt: \\n    external: \\n      name: nat \\n\\nThe docker-compose.yml file references the Dockerfile in the W\", \"eb project. The Dockerfile is used to \\nspecify which base container will be used and how the applica\", \"tion will be configured on it. The Web\\u2019 \\nDockerfile: \\n\\nFROM mcr.microsoft.com/dotnet/sdk:8.0 AS buil\", \"d \\nWORKDIR /app \\n\\nCOPY *.sln . \\nCOPY . . \\nWORKDIR /app/src/Web \\nRUN dotnet restore \\n\\n33 \\n\\nCHAPTER 4 \", \"| Common web application architectures \\n\\n \\n \\n \\n \\n \\n\\fRUN dotnet publish -c Release -o out \\n\\nFROM mcr.\", \"microsoft.com/dotnet/aspnet:8.0 AS runtime \\nWORKDIR /app \\nCOPY --from=build /app/src/Web/out ./ \\n\\nEN\", \"TRYPOINT [\\\"dotnet\\\", \\\"Web.dll\\\"] \\n\\nTroubleshooting Docker problems \\n\\nOnce you run the containerized ap\", \"plication, it continues to run until you stop it. You can view which \\ncontainers are running with th\", \"e docker ps command. You can stop a running container by using the \\ndocker stop command and specifyi\", \"ng the container ID. \\n\\nNote that running Docker containers may be bound to ports you might otherwise\", \" try to use in your \\ndevelopment environment. If you try to run or debug an application using the sa\", \"me port as a running \\nDocker container, you\\u2019ll get an error stating that the server can\\u2019t bind to th\", \"at port. Once again, \\nstopping the container should resolve the issue. \\n\\nIf you want to add Docker s\", \"upport to your application using Visual Studio, make sure Docker Desktop \\nis running when you do so.\", \" The wizard won\\u2019t run correctly if Docker Desktop isn\\u2019t running when you \\nstart the wizard. In addit\", \"ion, the wizard examines your current container choice to add the correct \\nDocker support. If you wa\", \"nt to add, support for Windows Containers, you need to run the wizard \\nwhile you have Docker Desktop\", \" running with Windows Containers configured. If you want to add, \\nsupport for Linux containers, run \", \"the wizard while you have Docker running with Linux containers \\nconfigured. \\n\\nOther web application \", \"architectural styles \\n\\n\\u2022  Web-Queue-Worker: The core components of this architecture are a web front\", \" end that \\n\\nserves client requests, and a worker that performs resource-intensive tasks, long-runnin\", \"g \\nworkflows, or batch jobs. The web front end communicates with the worker through a \\nmessage queue\", \". \\n\\n\\u2022 \\n\\nN-tier: An N-tier architecture divides an application into logical layers and physical tiers\", \". \\n\\n\\u2022  Microservice: A microservices architecture consists of a collection of small, autonomous \\n\\nse\", \"rvices. Each service is self-contained and should implement a single business capability \\nwithin a b\", \"ounded context. \\n\\nReferences \\u2013 Common web architectures \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n34 \\n\\nThe Clean Architectur\", \"e \\nhttps://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html \\n\\nThe Onion Architec\", \"ture \\nhttps://jeffreypalermo.com/blog/the-onion-architecture-part-1/ \\n\\nThe Repository Pattern \\nhttps\", \"://deviq.com/repository-pattern/ \\n\\nClean Architecture Solution Template \\nhttps://github.com/ardalis/\", \"cleanarchitecture \\n\\nCHAPTER 4 | Common web application architectures \\n\\n \\n \\n \\n \\n \\n\\f\\u2022 \\n\\n\\u2022 \\n\\nArchitecti\", \"ng Microservices e-book \\nhttps://aka.ms/MicroservicesEbook \\n\\nDDD (Domain-Driven Design) \\nhttps://lea\", \"rn.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-\\npatterns/ \\n\\n35 \\n\\nCHAPTER 4\", \" | Common web application architectures \\n\\n \\n \\n\\fCHAPTER  5 \\n\\nCommon client-side web \\ntechnologies \\n\\n\\u201c\", \"Websites should look good from the inside and out.\\u201d - Paul Cookson \\n\\nASP.NET Core applications are w\", \"eb applications and they typically rely on client-side web \\ntechnologies like HTML, CSS, and JavaScr\", \"ipt. By separating the content of the page (the HTML) from \\nits layout and styling (the CSS), and it\", \"s behavior (via JavaScript), complex web apps can leverage the \\nSeparation of Concerns principle. Fu\", \"ture changes to the structure, design, or behavior of the \\napplication can be made more easily when \", \"these concerns are not intertwined. \\n\\nWhile HTML and CSS are relatively stable, JavaScript, by means\", \" of the application frameworks and \\nutilities developers work with to build web-based applications, \", \"is evolving at breakneck speed. This \\nchapter looks at a few ways that JavaScript is used by web dev\", \"elopers and provides a high-level \\noverview of the Angular and React client-side libraries. \\n\\nNote \\n\", \"\\nBlazor provides an alternative to JavaScript frameworks for building rich, interactive client user \", \"\\ninterfaces. \\n\\nHTML \\n\\nHTML is the standard markup language used to create web pages and web applicat\", \"ions. Its elements \\nform the building blocks of pages, representing formatted text, images, form inp\", \"uts, and other \\nstructures. When a browser makes a request to a URL, whether fetching a page or an a\", \"pplication, the \\nfirst thing that is returned is an HTML document. This HTML document may reference \", \"or include \\nadditional information about its look and layout in the form of CSS, or behavior in the \", \"form of \\nJavaScript. \\n\\nCSS \\n\\nCSS (Cascading Style Sheets) is used to control the look and layout of \", \"HTML elements. CSS styles can \\nbe applied directly to an HTML element, defined separately on the sam\", \"e page, or defined in a \\nseparate file and referenced by the page. Styles cascade based on how they \", \"are used to select a given \\nHTML element. For instance, a style might apply to an entire document, b\", \"ut would be overridden by a \\n\\n36 \\n\\nCHAPTER 5 | Common client-side web technologies \\n\\n \\n \\n\\fstyle that\", \" applied to a particular element. Likewise, an element-specific style would be overridden by a \\nstyl\", \"e that applied to a CSS class that was applied to the element, which in turn would be overridden \\nby\", \" a style targeting a specific instance of that element (via its ID). Figure 6-1 \\n\\nFigure 6-1. CSS Sp\", \"ecificity rules, in order. \\n\\nIt\\u2019s best to keep styles in their own separate stylesheet files, and to\", \" use selection-based cascading to \\nimplement consistent and reusable styles within the application. \", \"Placing style rules within HTML \\nshould be avoided, and applying styles to specific individual eleme\", \"nts (rather than whole classes of \\nelements, or elements that have had a particular CSS class applie\", \"d to them) should be the exception, \\nnot the rule. \\n\\nCSS preprocessors \\n\\nCSS stylesheets lack suppor\", \"t for conditional logic, variables, and other programming language \\nfeatures. Thus, large stylesheet\", \"s often include quite a bit of repetition, as the same color, font, or other \\nsetting is applied to \", \"many different variations of HTML elements and CSS classes. CSS preprocessors \\ncan help your stylesh\", \"eets follow the DRY principle by adding support for variables and logic. \\n\\nThe most popular CSS prep\", \"rocessors are Sass and LESS. Both extend CSS and are backward \\ncompatible with it, meaning that a pl\", \"ain CSS file is a valid Sass or LESS file. Sass is Ruby-based and \\nLESS is JavaScript based, and bot\", \"h typically run as part of your local development process. Both have \\ncommand-line tools available, \", \"as well as built-in support in Visual Studio for running them using Gulp \\nor Grunt tasks. \\n\\n37 \\n\\nCHA\", \"PTER 5 | Common client-side web technologies \\n\\n \\n \\n \\n\\fJavaScript \\n\\nJavaScript is a dynamic, interpre\", \"ted programming language that has been standardized in the \\nECMAScript language specification. It is\", \" the programming language of the web. Like CSS, JavaScript \\ncan be defined as attributes within HTML\", \" elements, as blocks of script within a page, or in separate \\nfiles. Just like CSS, it\\u2019s recommended\", \" to organize JavaScript into separate files, keeping it separated as \\nmuch as possible from the HTML\", \" found on individual web pages or application views. \\n\\nWhen working with JavaScript in your web appl\", \"ication, there are a few tasks that you\\u2019ll commonly \\nneed to perform: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nSelecting an\", \" HTML element and retrieving and/or updating its value. \\n\\nQuerying a Web API for data. \\n\\nSending a c\", \"ommand to a Web API (and responding to a callback with its result). \\n\\nPerforming validation. \\n\\nYou c\", \"an perform all of these tasks with JavaScript alone, but many libraries exist to make these tasks \\ne\", \"asier. One of the first and most successful of these libraries is jQuery, which continues to be a \\np\", \"opular choice for simplifying these tasks on web pages. For Single Page Applications (SPAs), jQuery \", \"\\ndoesn\\u2019t provide many of the desired features that Angular and React offer. \\n\\nLegacy web apps with j\", \"Query \\n\\nAlthough ancient by JavaScript framework standards, jQuery continues to be a commonly used l\", \"ibrary \\nfor working with HTML/CSS and building applications that make AJAX calls to web APIs. Howeve\", \"r, \\njQuery operates at the level of the browser document object model (DOM), and by default offers o\", \"nly \\nan imperative, rather than declarative, model. \\n\\nFor example, imagine that if a textbox\\u2019s value\", \" exceeds 10, an element on the page should be made \\nvisible. In jQuery, this functionality would typ\", \"ically be implemented by writing an event handler with \\ncode that would inspect the textbox\\u2019s value \", \"and set the visibility of the target element based on that \\nvalue. This process is an imperative, co\", \"de-based approach. Another framework might instead use \\ndatabinding to bind the visibility of the el\", \"ement to the value of the textbox declaratively. This \\napproach would not require writing any code, \", \"but instead only requires decorating the elements \\ninvolved with data binding attributes. As client-\", \"side behaviors grow more complex, data binding \\napproaches frequently result in simpler solutions wi\", \"th less code and conditional complexity. \\n\\njQuery vs a SPA Framework \\n\\nFactor \\n\\njQuery  Angular \\n\\nAb\", \"stracts the DOM \\n\\nAJAX Support \\n\\nYes \\n\\nYes \\n\\nDeclarative Data Binding  No \\n\\nMVC-style Routing \\n\\nNo \\n\", \"\\nYes \\n\\nYes \\n\\nYes \\n\\nYes \\n\\n38 \\n\\nCHAPTER 5 | Common client-side web technologies \\n\\n \\n \\n\\fFactor \\n\\njQuery\", \"  Angular \\n\\nTemplating \\n\\nDeep-Link Routing \\n\\nNo \\n\\nNo \\n\\nYes \\n\\nYes \\n\\nMost of the features jQuery lacks\", \" intrinsically can be added with the addition of other libraries. \\nHowever, a SPA framework like Ang\", \"ular provides these features in a more integrated fashion, since it\\u2019s \\nbeen designed with all of the\", \"m in mind from the start. Also, jQuery is an imperative library, meaning \\nthat you need to call jQue\", \"ry functions in order to do anything with jQuery. Much of the work and \\nfunctionality that SPA frame\", \"works provide can be done declaratively, requiring no actual code to be \\nwritten. \\n\\nData binding is \", \"a great example of this functionality. In jQuery, it usually only takes one line of code to \\nget the\", \" value of a DOM element or to set an element\\u2019s value. However, you have to write this code \\nanytime \", \"you need to change the value of the element, and sometimes this will occur in multiple \\nfunctions on\", \" a page. Another common example is element visibility. In jQuery, there might be many \\ndifferent pla\", \"ces where you\\u2019d write code to control whether certain elements were visible. In each of \\nthese cases\", \", when using data binding, no code would need to be written. You\\u2019d simply bind the value \\nor visibil\", \"ity of the elements in question to a viewmodel on the page, and changes to that viewmodel \\nwould aut\", \"omatically be reflected in the bound elements. \\n\\nAngular SPAs \\n\\nAngular remains one of the world\\u2019s m\", \"ost popular JavaScript frameworks. Since Angular 2, the team \\nrebuilt the framework from the ground \", \"up (using TypeScript) and rebranded from the original \\nAngularJS name to Angular. Now several years \", \"old, the redesigned Angular continues to be a robust \\nframework for building Single Page Application\", \"s. \\n\\nAngular applications are built from components. Components combine HTML templates with special \", \"\\nobjects and control a portion of the page. A simple component from Angular\\u2019s docs is shown here: \\n\\n\", \"import { Component } from '@angular/core'; \\n\\n@Component({ \\n    selector: 'my-app', \\n    template: `<\", \"h1>Hello {{name}}</h1>` \\n}) \\n\\nexport class AppComponent { name = 'Angular'; } \\n\\nComponents are defin\", \"ed using the @Component decorator function, which takes in metadata about \\nthe component. The select\", \"or property identifies the ID of the element on the page where this \\ncomponent will be displayed. Th\", \"e template property is a simple HTML template that includes a \\nplaceholder that corresponds to the c\", \"omponent\\u2019s name property, defined on the last line. \\n\\nBy working with components and templates, inst\", \"ead of DOM elements, Angular apps can operate at a \\nhigher level of abstraction and with less overal\", \"l code than apps written using just JavaScript (also \\ncalled \\u201cvanilla JS\\u201d) or with jQuery. Angular a\", \"lso imposes some order on how you organize your client-\\nside script files. By convention, Angular ap\", \"ps use a common folder structure, with module and \\n\\n39 \\n\\nCHAPTER 5 | Common client-side web technolo\", \"gies \\n\\n \\n \\n \\n \\n\\fcomponent script files located in an app folder. Angular scripts concerned with buil\", \"ding, deploying, \\nand testing the app are typically located in a higher-level folder. \\n\\nYou can deve\", \"lop Angular apps by using a CLI. Getting started with Angular development locally \\n(assuming you alr\", \"eady have git and npm installed) consists of simply cloning a repo from GitHub and \\nrunning npm inst\", \"all and npm start. Beyond this, Angular ships its own CLI, which can create projects, \\nadd files, an\", \"d assist with testing, bundling, and deployment tasks. This CLI friendliness makes Angular \\nespecial\", \"ly compatible with ASP.NET Core, which also features great CLI support. \\n\\nMicrosoft has developed a \", \"reference application, eShopOnContainers, which includes an Angular SPA \\nimplementation. This app in\", \"cludes Angular modules to manage the online store\\u2019s shopping basket, \\nload and display items from it\", \"s catalog, and handling order creation. You can view and download the \\nsample application from GitHu\", \"b. \\n\\nReact \\n\\nUnlike Angular, which offers a full Model-View-Controller pattern implementation, React\", \" is only \\nconcerned with views. It\\u2019s not a framework, just a library, so to build a SPA you\\u2019ll need \", \"to leverage \\nadditional libraries. There are a number of libraries that are designed to be used with\", \" React to \\nproduce rich single page applications. \\n\\nOne of React\\u2019s most important features is its us\", \"e of a virtual DOM. The virtual DOM provides React \\nwith several advantages, including performance (\", \"the virtual DOM can optimize which parts of the \\nactual DOM need to be updated) and testability (no \", \"need to have a browser to test React and its \\ninteractions with its virtual DOM). \\n\\nReact is also un\", \"usual in how it works with HTML. Rather than having a strict separation between code \\nand markup (wi\", \"th references to JavaScript appearing in HTML attributes perhaps), React adds HTML \\ndirectly within \", \"its JavaScript code as JSX. JSX is HTML-like syntax that can compile down to pure \\nJavaScript. For e\", \"xample: \\n\\n<ul> \\n{ authors.map(author => \\n    <li key={author.id}>{author.name}</li> \\n)} \\n</ul> \\n\\nIf \", \"you already know JavaScript, learning React should be easy. There isn\\u2019t nearly as much learning \\ncur\", \"ve or special syntax involved as with Angular or other popular libraries. \\n\\nBecause React isn\\u2019t a fu\", \"ll framework, you\\u2019ll typically want other libraries to handle things like routing, \\nweb API calls, a\", \"nd dependency management. The nice thing is, you can pick the best library for each \\nof these, but t\", \"he disadvantage is that you need to make all of these decisions and verify all of your \\nchosen libra\", \"ries work well together when you\\u2019re done. If you want a good starting point, you can use \\na starter \", \"kit like React Slingshot, which prepackages a set of compatible libraries together with React. \\n\\nVue\", \" \\n\\nFrom its getting started guide, \\u201cVue is a progressive framework for building user interfaces. Unl\", \"ike \\nother monolithic frameworks, Vue is designed from the ground up to be incrementally adoptable. \", \"The \\n\\n40 \\n\\nCHAPTER 5 | Common client-side web technologies \\n\\n \\n \\n\\fcore library is focused on the vie\", \"w layer only, and is easy to pick up and integrate with other libraries \\nor existing projects. On th\", \"e other hand, Vue is perfectly capable of powering sophisticated Single-\\nPage Applications when used\", \" in combination with modern tooling and supporting libraries.\\u201d \\n\\nGetting started with Vue simply req\", \"uires including its script within an HTML file: \\n\\n<!-- development version, includes helpful console\", \" warnings --> \\n<script src=\\\"https://cdn.jsdelivr.net/npm/vue/dist/vue.js\\\"></script> \\nWith the framew\", \"ork added, you\\u2019re then able to declaratively render data to the DOM using \\nVue\\u2019s straightforward tem\", \"plating syntax: \\n<div id=\\\"app\\\"> \\n  {{ message }} \\n</div> \\nand then adding the following script: \\nvar\", \" app = new Vue({ \\n  el: '#app', \\n  data: { \\n    message: 'Hello Vue!' \\n  } \\n}) \\n\\nThis is enough to r\", \"ender \\\"Hello Vue!\\\" on the page. Note, however, that Vue isn\\u2019t simply rendering the \\nmessage to the d\", \"iv once. It supports databinding and dynamic updates such that if the value of \\nmessage changes, the\", \" value in the <div> is immediately updated to reflect it. \\n\\nOf course, this only scratches the surfa\", \"ce of what Vue is capable of. It\\u2019s gained a great deal of \\npopularity in the last several years and \", \"has a large community. There\\u2019s a huge and growing list of \\nsupporting components and libraries that \", \"work with Vue to extend it as well. If you\\u2019re looking to add \\nclient-side behavior to your web appli\", \"cation or considering building a full SPA, Vue is worth \\ninvestigating. \\n\\nBlazor WebAssembly \\n\\nUnlik\", \"e other JavaScript frameworks, Blazor WebAssembly is a single-page app (SPA) framework for \\nbuilding\", \" interactive client-side web apps with .NET. Blazor WebAssembly uses open web standards \\nwithout plu\", \"gins or recompiling code into other languages. Blazor WebAssembly works in all modern \\nweb browsers,\", \" including mobile browsers. \\n\\nRunning .NET code inside web browsers is made possible by WebAssembly \", \"(abbreviated wasm). \\nWebAssembly is a compact bytecode format optimized for fast download and maximu\", \"m execution \\nspeed. WebAssembly is an open web standard and is supported in web browsers without plu\", \"gins. \\n\\nWebAssembly code can access the full functionality of the browser via JavaScript, called Jav\", \"aScript \\ninteroperability, often shortened to JavaScript interop or JS interop. .NET code executed v\", \"ia \\nWebAssembly in the browser runs in the browser\\u2019s JavaScript sandbox with the protections that th\", \"e \\nsandbox provides against malicious actions on the client machine. \\n\\nFor more information, see Int\", \"roduction to ASP.NET Core Blazor. \\n\\nChoosing a SPA Framework \\n\\nWhen considering which option will wo\", \"rk best to support your SPA, keep in mind the following \\nconsiderations: \\n\\n41 \\n\\nCHAPTER 5 | Common c\", \"lient-side web technologies \\n\\n \\n \\n\\f\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nIs your team familiar with the framework \", \"and its dependencies (including TypeScript in some \\ncases)? \\n\\nHow opinionated is the framework, and \", \"do you agree with its default way of doing things? \\n\\nDoes it (or a companion library) include all of\", \" the features your app requires? \\n\\nIs it well documented? \\n\\nHow active is its community? Are new pro\", \"jects being built with it? \\n\\nHow active is its core team? Are issues being resolved and new versions\", \" shipped regularly? \\n\\nFrameworks continue to evolve with breakneck speed. Use the considerations lis\", \"ted above to help \\nmitigate the risk of choosing a framework you\\u2019ll later regret being dependent upo\", \"n. If you\\u2019re \\nparticularly risk-averse, consider a framework that offers commercial support and/or i\", \"s being \\ndeveloped by a large enterprise. \\n\\nReferences \\u2013 Client Web Technologies \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022\", \" \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nHTML and CSS \\nhttps://www.w3.org/standards/webdesign/htmlcss \\n\\nSass vs. LESS \", \"\\nhttps://www.keycdn.com/blog/sass-vs-less/ \\n\\nStyling ASP.NET Core Apps with LESS, Sass, and Font Awe\", \"some \\nhttps://learn.microsoft.com/aspnet/core/client-side/less-sass-fa \\n\\nClient-Side Development in \", \"ASP.NET Core \\nhttps://learn.microsoft.com/aspnet/core/client-side/ \\n\\njQuery \\nhttps://jquery.com/ \\n\\nA\", \"ngular \\nhttps://angular.io/ \\n\\nReact \\nhttps://reactjs.org/ \\n\\nVue \\nhttps://vuejs.org/ \\n\\nAngular vs Rea\", \"ct vs Vue: Which Framework to Choose in 2020 \\nhttps://www.codeinwp.com/blog/angular-vs-vue-vs-react/\", \" \\n\\nThe Top JavaScript Frameworks for Front-End Development in 2020 \\nhttps://www.freecodecamp.org/new\", \"s/complete-guide-for-front-end-developers-javascript-\\nframeworks-2019/ \\n\\n42 \\n\\nCHAPTER 5 | Common cli\", \"ent-side web technologies \\n\\n \\n \\n\\fCHAPTER  6 \\n\\nDevelop ASP.NET Core \\nMVC apps \\n\\n\\u201cIt\\u2019s not important t\", \"o get it right the first time. It\\u2019s vitally important to get it right the last time.\\u201d - \\nAndrew Hunt\", \" and David Thomas \\n\\nASP.NET Core is a cross-platform, open-source framework for building modern clou\", \"d-optimized web \\napplications. ASP.NET Core apps are lightweight and modular, with built-in support \", \"for dependency \\ninjection, enabling greater testability and maintainability. Combined with MVC, whic\", \"h supports \\nbuilding modern web APIs in addition to view-based apps, ASP.NET Core is a powerful fram\", \"ework \\nwith which to build enterprise web applications. \\n\\nMVC and Razor Pages \\n\\nASP.NET Core MVC off\", \"ers many features that are useful for building web-based APIs and apps. The \\nterm MVC stands for \\u201cMo\", \"del-View-Controller\\u201d, a UI pattern that breaks up the responsibilities of \\nresponding to user reques\", \"ts into several parts. In addition to following this pattern, you can also \\nimplement features in yo\", \"ur ASP.NET Core apps as Razor Pages. \\n\\nRazor Pages are built into ASP.NET Core MVC, and use the same\", \" features for routing, model binding, \\nfilters, authorization, etc. However, instead of having separ\", \"ate folders and files for Controllers, Models, \\nViews, etc. and using attribute-based routing, Razor\", \" Pages are placed in a single folder (\\u201c/Pages\\u201d), \\nroute based on their relative location in this fol\", \"der, and handle requests with handlers instead of \\ncontroller actions. As a result, when working wit\", \"h Razor Pages, all of the files and classes you need are \\ntypically colocated, not spread throughout\", \" the web project. \\n\\nLearn more about how MVC, Razor Pages, and related patterns are applied in the e\", \"ShopOnWeb \\nsample application. \\n\\nWhen you create a new ASP.NET Core App, you should have a plan in m\", \"ind for the kind of app you \\nwant to build. When creating a new project, in your IDE or using the do\", \"tnet new CLI command, you \\nwill choose from several templates. The most common project templates are\", \" Empty, Web API, Web \\nApp, and Web App (Model-View-Controller). Although you can only make this deci\", \"sion when you first \\ncreate a project, it\\u2019s not an irrevocable decision. The Web API project uses st\", \"andard Model-View-\\nController controllers \\u2013 it just lacks Views by default. Likewise, the default We\", \"b App template uses \\nRazor Pages, and so also lacks a Views folder. You can add a Views folder to th\", \"ese projects later to \\nsupport view-based behavior. Web API and Model-View-Controller projects don\\u2019t\", \" include a Pages \\n\\n43 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n\\ffolder by default, but you \", \"can add one later to support Razor Pages-based behavior. You can think of \\nthese three templates as \", \"supporting three different kinds of default user interaction: data (web API), \\npage-based, and view-\", \"based. However, you can mix and match any or all of these templates within a \\nsingle project if you \", \"wish. \\n\\nWhy Razor Pages? \\n\\nRazor Pages is the default approach for new web applications in Visual St\", \"udio. Razor Pages offers a \\nsimpler way of building page-based application features, such as non-SPA\", \" forms. Using controllers \\nand views, it was common for applications to have very large controllers \", \"that worked with many \\ndifferent dependencies and view models and returned many different views. Thi\", \"s resulted in more \\ncomplexity and often resulted in controllers that didn\\u2019t follow the Single Respo\", \"nsibility Principle or \\nOpen/Closed Principles effectively. Razor Pages addresses this issue by enca\", \"psulating the server-side \\nlogic for a given logical \\u201cpage\\u201d in a web application with its Razor mark\", \"up. A Razor Page that has no \\nserver-side logic can only consist of a Razor file (for instance, \\u201cInd\", \"ex.cshtml\\u201d). However, most non-\\ntrivial Razor Pages will have an associated page model class, which \", \"by convention is named the same \\nas the Razor file with a \\u201c.cs\\u201d extension (for example, \\u201cIndex.cshtm\", \"l.cs\\u201d). \\n\\nA Razor Page\\u2019s page model combines the responsibilities of an MVC controller and a viewmod\", \"el. \\nInstead of handling requests with controller action methods, page model handlers like \\u201cOnGet()\\u201d\", \" are \\nexecuted, rendering their associated page by default. Razor Pages simplifies the process of bu\", \"ilding \\nindividual pages in an ASP.NET Core app, while still providing all the architectural feature\", \"s of ASP.NET \\nCore MVC. They\\u2019re a good default choice for new page-based functionality. \\n\\nWhen to us\", \"e MVC \\n\\nIf you\\u2019re building web APIs, the MVC pattern makes more sense than trying to use Razor Pages\", \". If your \\nproject will only expose web API endpoints, you should ideally start from the Web API pro\", \"ject \\ntemplate. Otherwise, it\\u2019s easy to add controllers and associated API endpoints to any ASP.NET \", \"Core \\napp. Use the view-based MVC approach if you\\u2019re migrating an existing application from ASP.NET \", \"MVC \\n5 or earlier to ASP.NET Core MVC and you want to do so with the least amount of effort. Once yo\", \"u\\u2019ve \\nmade the initial migration, you can evaluate whether it makes sense to adopt Razor Pages for n\", \"ew \\nfeatures or even as a wholesale migration. For more information about porting .NET 4.x apps to .\", \"NET \\n8, see Porting Existing ASP.NET Apps to ASP.NET Core eBook. \\n\\nWhether you choose to build your \", \"web app using Razor Pages or MVC views, your app will have \\nsimilar performance and will include sup\", \"port for dependency injection, filters, model binding, \\nvalidation, and so on. \\n\\nMapping requests to\", \" responses \\n\\nAt its heart, ASP.NET Core apps map incoming requests to outgoing responses. At a low l\", \"evel, this \\nmapping is done with middleware, and simple ASP.NET Core apps and microservices may be \\n\", \"comprised solely of custom middleware. When using ASP.NET Core MVC, you can work at a \\nsomewhat high\", \"er level, thinking in terms of routes, controllers, and actions. Each incoming request is \\ncompared \", \"with the application\\u2019s routing table, and if a matching route is found, the associated action \\n\\n44 \\n\", \"\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n\\fmethod (belonging to a controller) is called to ha\", \"ndle the request. If no matching route is found, an \\nerror handler (in this case, returning a NotFou\", \"nd result) is called. \\n\\nASP.NET Core MVC apps can use conventional routes, attribute routes, or both\", \". Conventional routes \\nare defined in code, specifying routing conventions using syntax like in the \", \"example below: \\n\\napp.UseEndpoints(endpoints => \\n{ \\n    endpoints.MapControllerRoute(name: \\\"default\\\",\", \" pattern: \\n\\\"{controller=Home}/{action=Index}/{id?}\\\"); \\n}); \\n\\nIn this example, a route named \\u201cdefault\", \"\\u201d has been added to the routing table. It defines a route \\ntemplate with placeholders for controller\", \", action, and id. The controller and action placeholders have \\nthe default specified (Home and Index\", \", respectively), and the id placeholder is optional (by virtue of a \\n\\u201c?\\u201d applied to it). The convent\", \"ion defined here states that the first part of a request should correspond \\nto the name of the contr\", \"oller, the second part to the action, and then if necessary a third part will \\nrepresent an ID param\", \"eter. Conventional routes are typically defined in one place for the application, \\nsuch as in Progra\", \"m.cs where the request middleware pipeline is configured. \\n\\nAttribute routes are applied to controll\", \"ers and actions directly, rather than specified globally. This \\napproach has the advantage of making\", \" them much more discoverable when you\\u2019re looking at a \\nparticular method, but does mean that routing\", \" information is not kept in one place in the application. \\nWith attribute routes, you can easily spe\", \"cify multiple routes for a given action, as well as combine \\nroutes between controllers and actions.\", \" For example: \\n\\n[Route(\\\"Home\\\")] \\npublic class HomeController : Controller \\n{ \\n    [Route(\\\"\\\")] // Com\", \"bines to define the route template \\\"Home\\\" \\n    [Route(\\\"Index\\\")] // Combines to define route template\", \" \\\"Home/Index\\\" \\n    [Route(\\\"/\\\")] // Does not combine, defines the route template \\\"\\\" \\n    public IActi\", \"onResult Index() {} \\n} \\n\\nRoutes can be specified on [HttpGet] and similar attributes, avoiding the n\", \"eed to add separate [Route] \\nattributes. Attribute routes can also use tokens to reduce the need to \", \"repeat controller or action \\nnames, as shown below: \\n\\n[Route(\\\"[controller]\\\")] \\npublic class Products\", \"Controller : Controller \\n{ \\n    [Route(\\\"\\\")] // Matches 'Products' \\n    [Route(\\\"Index\\\")] // Matches '\", \"Products/Index' \\n    public IActionResult Index() {} \\n} \\n\\nRazor Pages don\\u2019t use attribute routing. Y\", \"ou can specify additional route template information for a \\nRazor Page as part of its @page directiv\", \"e: \\n\\n@page \\\"{id:int}\\\" \\n\\n45 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n\\fIn the previous exampl\", \"e, the page in question would match a route with an integer id parameter. For \\nexample, the Products\", \".cshtml page located in the root of /Pages would respond to requests like this \\none: \\n\\n/Products/123\", \" \\n\\nOnce a given request has been matched to a route, but before the action method is called, ASP.NET\", \" \\nCore MVC will perform model binding and model validation on the request. Model binding is \\nrespons\", \"ible for converting incoming HTTP data into the .NET types specified as parameters of the \\naction me\", \"thod to be called. For example, if the action method expects an int id parameter, model \\nbinding wil\", \"l attempt to provide this parameter from a value provided as part of the request. To do so, \\nmodel b\", \"inding looks for values in a posted form, values in the route itself, and query string values. \\nAssu\", \"ming an id value is found, it will be converted to an integer before being passed into the action \\nm\", \"ethod. \\n\\nAfter binding the model but before calling the action method, model validation occurs. Mode\", \"l \\nvalidation uses optional attributes on the model type, and can help ensure that the provided mode\", \"l \\nobject conforms to certain data requirements. Certain values may be specified as required, or lim\", \"ited \\nto a certain length or numeric range, etc. If validation attributes are specified but the mode\", \"l does not \\nconform to their requirements, the property ModelState.IsValid will be false, and the se\", \"t of failing \\nvalidation rules will be available to send to the client making the request. \\n\\nIf you\\u2019\", \"re using model validation, you should be sure to always check that the model is valid before \\nperfor\", \"ming any state-altering commands, to ensure your app is not corrupted by invalid data. You can \\nuse \", \"a filter to avoid the need to add code for this validation in every action. ASP.NET Core MVC filters\", \" \\noffer a way of intercepting groups of requests, so that common policies and cross-cutting concerns\", \" \\ncan be applied on a targeted basis. Filters can be applied to individual actions, whole controller\", \"s, or \\nglobally for an application. \\n\\nFor web APIs, ASP.NET Core MVC supports content negotiation, a\", \"llowing requests to specify how \\nresponses should be formatted. Based on headers provided in the req\", \"uest, actions returning data will \\nformat the response in XML, JSON, or another supported format. Th\", \"is feature enables the same API to \\nbe used by multiple clients with different data format requireme\", \"nts. \\n\\nWeb API projects should consider using the [ApiController] attribute, which can be applied to\", \" \\nindividual controllers, to a base controller class, or to the entire assembly. This attribute adds\", \" \\nautomatic model validation checking and any action with an invalid model will return a BadRequest \", \"\\nwith the details of the validation errors. The attribute also requires all actions have an attribut\", \"e route, \\nrather than using a conventional route, and returns more detailed ProblemDetails informati\", \"on in \\nresponse to errors. \\n\\nKeeping controllers under control \\n\\nFor page-based applications, Razor \", \"Pages do a great job of keeping controllers from getting too \\nlarge. Each individual page is given i\", \"ts own files and classes dedicated just to its handler(s). Prior to \\nthe introduction of Razor Pages\", \", many view-centric applications would have large controller classes \\nresponsible for many different\", \" actions and views. These classes would naturally grow to have many \\nresponsibilities and dependenci\", \"es, making them harder to maintain. If you find your view-based \\n\\n46 \\n\\nCHAPTER 6 | Develop ASP.NET C\", \"ore MVC apps \\n\\n \\n \\n\\fcontrollers are growing too large, consider refactoring them to use Razor Pages,\", \" or introducing a \\npattern like a mediator. \\n\\nThe mediator design pattern is used to reduce coupling\", \" between classes while allowing \\ncommunication between them. In ASP.NET Core MVC applications, this \", \"pattern is frequently employed \\nto break up controllers into smaller pieces by using handlers to do \", \"the work of action methods. The \\npopular MediatR NuGet package is often used to accomplish this. Typ\", \"ically, controllers include many \\ndifferent action methods, each of which may require certain depend\", \"encies. The set of all \\ndependencies required by any action must be passed into the controller\\u2019s con\", \"structor. When using \\nMediatR, the only dependency a controller will typically have is an instance o\", \"f the mediator. Each \\naction then uses the mediator instance to send a message, which is processed b\", \"y a handler. The \\nhandler is specific to a single action and thus only needs the dependencies requir\", \"ed by that action. An \\nexample of a controller using MediatR is shown here: \\n\\npublic class OrderCont\", \"roller : Controller \\n{ \\n    private readonly IMediator _mediator; \\n\\n    public OrderController(IMedi\", \"ator mediator) \\n    { \\n        _mediator = mediator; \\n    } \\n\\n    [HttpGet] \\n    public async Task<I\", \"ActionResult> MyOrders() \\n    { \\n        var viewModel = await _mediator.Send(new GetMyOrders(User.I\", \"dentity.Name)); \\n        return View(viewModel); \\n    } \\n    // other actions implemented similarly \", \"\\n} \\n\\nIn the MyOrders action, the call to Send a GetMyOrders message is handled by this class: \\n\\npubl\", \"ic class GetMyOrdersHandler : IRequestHandler<GetMyOrders, IEnumerable<OrderViewModel>> \\n{ \\n    priv\", \"ate readonly IOrderRepository _orderRepository; \\n    public GetMyOrdersHandler(IOrderRepository orde\", \"rRepository) \\n    { \\n        _orderRepository = orderRepository; \\n    } \\n\\n  public async Task<IEnume\", \"rable<OrderViewModel>> Handle(GetMyOrders request, \\nCancellationToken cancellationToken) \\n    { \\n   \", \"     var specification = new CustomerOrdersWithItemsSpecification(request.UserName); \\n        var or\", \"ders = await _orderRepository.ListAsync(specification); \\n        return orders.Select(o => new Order\", \"ViewModel \\n            { \\n                OrderDate = o.OrderDate, \\n                OrderItems = o.O\", \"rderItems?.Select(oi => new OrderItemViewModel() \\n                  { \\n                    PictureUr\", \"l = oi.ItemOrdered.PictureUri, \\n                    ProductId = oi.ItemOrdered.CatalogItemId, \\n     \", \"               ProductName = oi.ItemOrdered.ProductName, \\n                    UnitPrice = oi.UnitPri\", \"ce, \\n                    Units = oi.Units \\n\\n47 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n \\n \", \"\\n \\n\\f                  }).ToList(), \\n                OrderNumber = o.Id, \\n                ShippingAdd\", \"ress = o.ShipToAddress, \\n                Total = o.Total() \\n        }); \\n    } \\n} \\n\\nThe end result o\", \"f this approach is for controllers to be much smaller and focused primarily on routing \\nand model bi\", \"nding, while individual handlers are responsible for the specific tasks needed by a given \\nendpoint.\", \" This approach can also be achieved without MediatR by using the ApiEndpoints NuGet \\npackage, which \", \"attempts to bring to API controllers the same benefits Razor Pages brings to view-\\nbased controllers\", \". \\n\\nReferences \\u2013 Mapping Requests to Responses \\n\\n\\u2022 \\n\\nRouting to Controller Actions \\nhttps://learn.mi\", \"crosoft.com/aspnet/core/mvc/controllers/routing \\n\\n\\u2022  Model Binding \\n\\nhttps://learn.microsoft.com/asp\", \"net/core/mvc/models/model-binding \\n\\n\\u2022  Model Validation \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nhttps://learn.microsoft.com/aspnet\", \"/core/mvc/models/validation \\n\\nFilters \\nhttps://learn.microsoft.com/aspnet/core/mvc/controllers/filte\", \"rs \\n\\nApiController Attribute \\nhttps://learn.microsoft.com/aspnet/core/web-api/ \\n\\nWorking with depend\", \"encies \\n\\nASP.NET Core has built-in support for and internally makes use of a technique known as depe\", \"ndency \\ninjection. Dependency injection is a technique that enables loose coupling between different\", \" parts of \\nan application. Looser coupling is desirable because it makes it easier to isolate parts \", \"of the \\napplication, allowing for testing or replacement. It also makes it less likely that a change\", \" in one part of \\nthe application will have an unexpected impact somewhere else in the application. D\", \"ependency \\ninjection is based on the dependency inversion principle, and is often key to achieving t\", \"he \\nopen/closed principle. When evaluating how your application works with its dependencies, beware \", \"of \\nthe static cling code smell, and remember the aphorism \\u201cnew is glue.\\u201d \\n\\nStatic cling occurs when\", \" your classes make calls to static methods, or access static properties, which \\nhave side effects or\", \" dependencies on infrastructure. For example, if you have a method that calls a \\nstatic method, whic\", \"h in turn writes to a database, your method is tightly coupled to the database. \\nAnything that break\", \"s that database call will break your method. Testing such methods is notoriously \\ndifficult, since s\", \"uch tests either require commercial mocking libraries to mock the static calls, or can \\nonly be test\", \"ed with a test database in place. Static calls that don\\u2019t have any dependence on \\ninfrastructure, es\", \"pecially those calls that are completely stateless, are fine to call and have no impact \\non coupling\", \" or testability (beyond coupling code to the static call itself). \\n\\n48 \\n\\nCHAPTER 6 | Develop ASP.NET\", \" Core MVC apps \\n\\n \\n \\n\\fMany developers understand the risks of static cling and global state, but wil\", \"l still tightly couple their \\ncode to specific implementations through direct instantiation. \\u201cNew is\", \" glue\\u201d is meant to be a reminder \\nof this coupling, and not a general condemnation of the use of the\", \" new keyword. Just as with static \\nmethod calls, new instances of types that have no external depend\", \"encies typically do not tightly \\ncouple code to implementation details or make testing more difficul\", \"t. But each time a class is \\ninstantiated, take just a brief moment to consider whether it makes sen\", \"se to hard-code that specific \\ninstance in that particular location, or if it would be a better desi\", \"gn to request that instance as a \\ndependency. \\n\\nDeclare your dependencies \\n\\nASP.NET Core is built ar\", \"ound having methods and classes declare their dependencies, requesting \\nthem as arguments. ASP.NET a\", \"pplications are typically set up in Program.cs or in a Startup class. \\n\\nNote \\n\\nConfiguring apps comp\", \"letely in Program.cs is the default approach for .NET 6 (and later) and Visual \\nStudio 2022 apps. Pr\", \"oject templates have been updated to help you get started with this new \\napproach. ASP.NET Core proj\", \"ects can still use a Startup class, if desired. \\n\\nConfigure services in Program.cs \\n\\nFor very simple\", \" apps, you can wire up dependencies directly in Program.cs file using a \\nWebApplicationBuilder. Once\", \" all needed services have been added, the builder is used to create the \\napp. \\n\\nvar builder = WebApp\", \"lication.CreateBuilder(args); \\n\\n// Add services to the container. \\nbuilder.Services.AddRazorPages();\", \" \\n\\nvar app = builder.Build(); \\n\\nConfigure services in Startup.cs \\n\\nThe Startup.cs is itself configur\", \"ed to support dependency injection at several points. If you\\u2019re using a \\nStartup class, you can give\", \" it a constructor and it can request dependencies through it, like so: \\n\\npublic class Startup \\n{ \\n  \", \"  public Startup(IHostingEnvironment env) \\n    { \\n        var builder = new ConfigurationBuilder() \\n\", \"            .SetBasePath(env.ContentRootPath) \\n            .AddJsonFile(\\\"appsettings.json\\\", optional\", \": false, reloadOnChange: true) \\n            .AddJsonFile($\\\"appsettings.{env.EnvironmentName}.json\\\", \", \"optional: true); \\n    } \\n} \\n\\nThe Startup class is interesting in that there are no explicit type req\", \"uirements for it. It doesn\\u2019t inherit \\nfrom a special Startup base class, nor does it implement any p\", \"articular interface. You can give it a \\nconstructor, or not, and you can specify as many parameters \", \"on the constructor as you want. When \\n\\n49 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n \\n \\n\\fthe\", \" web host you\\u2019ve configured for your application starts, it will call the Startup class (if you\\u2019ve t\", \"old it \\nto use one), and will use dependency injection to populate any dependencies the Startup clas\", \"s \\nrequires. Of course, if you request parameters that aren\\u2019t configured in the services container u\", \"sed by \\nASP.NET Core, you\\u2019ll get an exception, but as long as you stick to dependencies the containe\", \"r knows \\nabout, you can request anything you want. \\n\\nDependency injection is built into your ASP.NET\", \" Core apps right from the start, when you create the \\nStartup instance. It doesn\\u2019t stop there for th\", \"e Startup class. You can also request dependencies in the \\nConfigure method: \\n\\npublic void Configure\", \"(IApplicationBuilder app, \\n    IHostingEnvironment env, \\n    ILoggerFactory loggerFactory) \\n{ \\n\\n} \\n\\n\", \"The ConfigureServices method is the exception to this behavior; it must take just one parameter of \\n\", \"type IServiceCollection. It doesn\\u2019t really need to support dependency injection, since on the one ha\", \"nd \\nit is responsible for adding objects to the services container, and on the other it has access t\", \"o all \\ncurrently configured services via the IServiceCollection parameter. Thus, you can work with \\n\", \"dependencies defined in the ASP.NET Core services collection in every part of the Startup class, eit\", \"her \\nby requesting the needed service as a parameter or by working with the IServiceCollection in \\nC\", \"onfigureServices. \\n\\nNote \\n\\nIf you need to ensure certain services are available to your Startup clas\", \"s, you can configure them using \\nan IWebHostBuilder and its ConfigureServices method inside the Crea\", \"teDefaultBuilder call. \\n\\nThe Startup class is a model for how you should structure other parts of yo\", \"ur ASP.NET Core \\napplication, from Controllers to Middleware to Filters to your own Services. In eac\", \"h case, you should \\nfollow the Explicit Dependencies Principle, requesting your dependencies rather \", \"than directly creating \\nthem, and leveraging dependency injection throughout your application. Be ca\", \"reful of where and how \\nyou directly instantiate implementations, especially services and objects th\", \"at work with infrastructure \\nor have side effects. Prefer working with abstractions defined in your \", \"application core and passed in as \\narguments to hardcoding references to specific implementation typ\", \"es. \\n\\nStructuring the application \\n\\nMonolithic applications typically have a single entry point. In \", \"the case of an ASP.NET Core web \\napplication, the entry point will be the ASP.NET Core web project. \", \"However, that doesn\\u2019t mean the \\nsolution should consist of just a single project. It\\u2019s useful to bre\", \"ak up the application into different \\nlayers in order to follow separation of concerns. Once broken \", \"up into layers, it\\u2019s helpful to go beyond \\nfolders to separate projects, which can help achieve bett\", \"er encapsulation. The best approach to \\nachieve these goals with an ASP.NET Core application is a va\", \"riation of the Clean Architecture \\ndiscussed in chapter 5. Following this approach, the application\\u2019\", \"s solution will comprise separate \\nlibraries for the UI, Infrastructure, and ApplicationCore. \\n\\n50 \\n\", \"\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n \\n\\fIn addition to these projects, separate test pro\", \"jects are included as well (Testing is discussed in \\nChapter 9). \\n\\nThe application\\u2019s object model an\", \"d interfaces should be placed in the ApplicationCore project. This \\nproject will have as few depende\", \"ncies as possible (and none on specific infrastructure concerns), and \\nthe other projects in the sol\", \"ution will reference it. Business entities that need to be persisted are \\ndefined in the Application\", \"Core project, as are services that do not directly depend on infrastructure. \\n\\nImplementation detail\", \"s, such as how persistence is performed or how notifications might be sent to a \\nuser, are kept in t\", \"he Infrastructure project. This project will reference implementation-specific \\npackages such as Ent\", \"ity Framework Core, but should not expose details about these implementations \\noutside of the projec\", \"t. Infrastructure services and repositories should implement interfaces that are \\ndefined in the App\", \"licationCore project, and its persistence implementations are responsible for \\nretrieving and storin\", \"g entities defined in ApplicationCore. \\n\\nThe ASP.NET Core UI project is responsible for any UI level\", \" concerns, but should not include business \\nlogic or infrastructure details. In fact, ideally it sho\", \"uldn\\u2019t even have a dependency on the Infrastructure \\nproject, which will help ensure no dependency b\", \"etween the two projects is introduced accidentally. \\nThis can be achieved using a third-party DI con\", \"tainer like Autofac, which allows you to define DI rules \\nin Module classes in each project. \\n\\nAnoth\", \"er approach to decoupling the application from implementation details is to have the \\napplication ca\", \"ll microservices, perhaps deployed in individual Docker containers. This provides even \\ngreater sepa\", \"ration of concerns and decoupling than leveraging DI between two projects, but has \\nadditional compl\", \"exity. \\n\\nFeature organization \\n\\nBy default, ASP.NET Core applications organize their folder structur\", \"e to include Controllers and Views, \\nand frequently ViewModels. Client-side code to support these se\", \"rver-side structures is typically stored \\nseparately in the wwwroot folder. However, large applicati\", \"ons may encounter problems with this \\norganization, since working on any given feature often require\", \"s jumping between these folders. This \\ngets more and more difficult as the number of files and subfo\", \"lders in each folder grows, resulting in a \\ngreat deal of scrolling through Solution Explorer. One s\", \"olution to this problem is to organize \\napplication code by feature instead of by file type. This or\", \"ganizational style is typically referred to as \\nfeature folders or feature slices (see also: Vertica\", \"l Slices). \\n\\nASP.NET Core MVC supports Areas for this purpose. Using areas, you can create separate \", \"sets of \\nControllers and Views folders (as well as any associated models) in each Area folder. Figur\", \"e 7-1 shows \\nan example folder structure, using Areas. \\n\\n51 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC a\", \"pps \\n\\n \\n \\n\\fFigure 7-1. Sample Area Organization \\n\\nWhen using Areas, you must use attributes to decor\", \"ate your controllers with the name of the area to \\nwhich they belong: \\n\\n[Area(\\\"Catalog\\\")] \\npublic cl\", \"ass HomeController \\n{} \\n\\nYou also need to add area support to your routes: \\n\\napp.UseEndpoints(endpoi\", \"nts => \\n{ \\n    endpoints.MapControllerRoute(name: \\\"areaRoute\\\", pattern: \\n\\\"{area:exists}/{controller=\", \"Home}/{action=Index}/{id?}\\\"); \\n    endpoints.MapControllerRoute(name: \\\"default\\\", pattern: \\n\\\"{control\", \"ler=Home}/{action=Index}/{id?}\\\"); \\n}); \\n\\nIn addition to the built-in support for Areas, you can also\", \" use your own folder structure, and \\nconventions in place of attributes and custom routes. This woul\", \"d allow you to have feature folders \\nthat didn\\u2019t include separate folders for Views, Controllers, et\", \"c., keeping the hierarchy flatter and \\nmaking it easier to see all related files in a single place f\", \"or each feature. For APIs, folders can be used \\nto replace controllers, and each folder can contain \", \"all of the API Endpoints and their associated DTOs. \\n\\n52 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps\", \" \\n\\n \\n \\n \\n\\fASP.NET Core uses built-in convention types to control its behavior. You can modify or rep\", \"lace these \\nconventions. For example, you can create a convention that will automatically get the fe\", \"ature name \\nfor a given controller based on its namespace (which typically correlates to the folder \", \"in which the \\ncontroller is located): \\n\\npublic class FeatureConvention : IControllerModelConvention \", \"\\n{ \\n    public void Apply(ControllerModel controller) \\n    { \\n        controller.Properties.Add(\\\"fea\", \"ture\\\", \\n        GetFeatureName(controller.ControllerType)); \\n    } \\n\\n    private string GetFeatureNa\", \"me(TypeInfo controllerType) \\n    { \\n        string[] tokens = controllerType.FullName.Split('.'); \\n \", \"       if (!tokens.Any(t => t == \\\"Features\\\")) return \\\"\\\"; \\n        string featureName = tokens \\n     \", \"       .SkipWhile(t => !t.Equals(\\\"features\\\", \\nStringComparison.CurrentCultureIgnoreCase)) \\n         \", \"   .Skip(1) \\n            .Take(1) \\n            .FirstOrDefault(); \\n        return featureName; \\n    \", \"} \\n} \\n\\nYou then specify this convention as an option when you add support for MVC to your applicatio\", \"n in \\nConfigureServices (or in Program.cs): \\n\\n// ConfigureServices \\nservices.AddMvc(o => o.Conventio\", \"ns.Add(new FeatureConvention())); \\n\\n// Program.cs \\nbuilder.Services.AddMvc(o => o.Conventions.Add(ne\", \"w FeatureConvention())); \\n\\nASP.NET Core MVC also uses a convention to locate views. You can override\", \" it with a custom \\nconvention so that views will be located in your feature folders (using the featu\", \"re name provided by \\nthe FeatureConvention, above). You can learn more about this approach and downl\", \"oad a working \\nsample from the MSDN Magazine article, Feature Slices for ASP.NET Core MVC. \\n\\nAPIs an\", \"d Blazor applications \\n\\nIf your application includes a set of web APIs, which must be secured, these\", \" APIs should ideally be \\nconfigured as a separate project from your View or Razor Pages application.\", \" Separating APIs, \\nespecially public APIs, from your server-side web application has a number of ben\", \"efits. These \\napplications often will have unique deployment and load characteristics. They\\u2019re also \", \"very likely to \\nadopt different mechanisms for security, with standard form-based applications lever\", \"aging cookie-\\nbased authentication and APIs most likely using token-based authentication. \\n\\nAddition\", \"ally, Blazor applications, whether using Blazor Server or Blazor WebAssembly, should be built \\nas se\", \"parate projects. The applications have different runtime characteristics as well as security models.\", \" \\nThey\\u2019re likely to share common types with the server-side web application (or API project), and th\", \"ese \\ntypes should be defined in a common shared project. \\n\\n53 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC\", \" apps \\n\\n \\n \\n \\n \\n\\fThe addition of a Blazor WebAssembly admin interface to eShopOnWeb required adding \", \"several new \\nprojects. The Blazor WebAssembly project itself, BlazorAdmin. A new set of public API e\", \"ndpoints, used \\nby BlazorAdmin and configured to use token-based authentication, is defined in the P\", \"ublicApi project. \\nAnd certain shared types used by both of these projects are kept in a new BlazorS\", \"hared project. \\n\\nOne might ask, why add a separate BlazorShared project when there is already a comm\", \"on \\nApplicationCore project that could be used to share any types required by both PublicApi and \\nBl\", \"azorAdmin? The answer is that this project includes all of the application\\u2019s business logic and is t\", \"hus \\nmuch larger than necessary and also much more likely to need to be kept secure on the server. \\n\", \"Remember that any library referenced by BlazorAdmin will be downloaded to users\\u2019 browsers when \\nthey\", \" load the Blazor application. \\n\\nDepending on whether one is using the Backends-For-Frontends (BFF) p\", \"attern, the APIs consumed by \\nthe Blazor WebAssembly app may not share their types 100% with Blazor.\", \" In particular, a public API \\nthat\\u2019s meant to be consumed by many different clients may define its o\", \"wn request and result types, \\nrather than sharing them in a client-specific shared project. In the e\", \"ShopOnWeb sample, the \\nassumption is being made that the PublicApi project is, in fact, hosting a pu\", \"blic API, so not all of its \\nrequest and response types come from the BlazorShared project. \\n\\nCross-\", \"cutting concerns \\n\\nAs applications grow, it becomes increasingly important to factor out cross-cutti\", \"ng concerns to \\neliminate duplication and maintain consistency. Some examples of cross-cutting conce\", \"rns in ASP.NET \\nCore applications are authentication, model validation rules, output caching, and er\", \"ror handling, \\nthough there are many others. ASP.NET Core MVC filters allow you to run code before o\", \"r after certain \\nsteps in the request processing pipeline. For instance, a filter can run before and\", \" after model binding, \\nbefore and after an action, or before and after an action\\u2019s result. You can a\", \"lso use an authorization \\nfilter to control access to the rest of the pipeline. Figures 7-2 shows ho\", \"w request execution flows \\nthrough filters, if configured. \\n\\n54 \\n\\nCHAPTER 6 | Develop ASP.NET Core M\", \"VC apps \\n\\n \\n \\n\\fFigure 7-2. Request execution through filters and request pipeline. \\n\\nFilters are usu\", \"ally implemented as attributes, so you can apply them to controllers or actions (or even \\nglobally).\", \" When added in this fashion, filters specified at the action level override or build upon filters \\ns\", \"pecified at the controller level, which themselves override global filters. For example, the [Route]\", \" \\nattribute can be used to build up routes between controllers and actions. Likewise, authorization \", \"can \\nbe configured at the controller level, and then overridden by individual actions, as the follow\", \"ing \\nsample demonstrates: \\n\\n[Authorize] \\npublic class AccountController : Controller \\n{ \\n    [AllowA\", \"nonymous] // overrides the Authorize attribute \\n    public async Task<IActionResult> Login() {} \\n   \", \" public async Task<IActionResult> ForgotPassword() {} \\n} \\n\\nThe first method, Login, uses the [AllowA\", \"nonymous] filter (attribute) to override the Authorize filter \\nset at the controller level. The Forg\", \"otPassword action (and any other action in the class that doesn\\u2019t \\nhave an AllowAnonymous attribute)\", \" will require an authenticated request. \\n\\nFilters can be used to eliminate duplication in the form o\", \"f common error handling policies for APIs. \\nFor example, a typical API policy is to return a NotFoun\", \"d response to requests referencing keys that \\ndo not exist, and a BadRequest response if model valid\", \"ation fails. The following example \\ndemonstrates these two policies in action: \\n\\n[HttpPut(\\\"{id}\\\")] \\n\", \"public async Task<IActionResult> Put(int id, [FromBody]Author author) \\n{ \\n\\n55 \\n\\nCHAPTER 6 | Develop \", \"ASP.NET Core MVC apps \\n\\n \\n \\n \\n\\f    if ((await _authorRepository.ListAsync()).All(a => a.Id != id)) \\n\", \"    { \\n        return NotFound(id); \\n    } \\n    if (!ModelState.IsValid) \\n    { \\n        return BadR\", \"equest(ModelState); \\n    } \\n    author.Id = id; \\n    await _authorRepository.UpdateAsync(author); \\n \", \"   return Ok(); \\n} \\n\\nDon\\u2019t allow your action methods to become cluttered with conditional code like \", \"this. Instead, pull the \\npolicies into filters that can be applied on an as-needed basis. In this ex\", \"ample, the model validation \\ncheck, which should occur anytime a command is sent to the API, can be \", \"replaced by the following \\nattribute: \\n\\npublic class ValidateModelAttribute : ActionFilterAttribute \", \"\\n{ \\n    public override void OnActionExecuting(ActionExecutingContext context) \\n    { \\n        if (!\", \"context.ModelState.IsValid) \\n        { \\n            context.Result = new BadRequestObjectResult(cont\", \"ext.ModelState); \\n        } \\n    } \\n} \\n\\nYou can add the ValidateModelAttribute to your project as a \", \"NuGet dependency by including the \\nArdalis.ValidateModel package. For APIs, you can use the ApiContr\", \"oller attribute to enforce this \\nbehavior without the need for a separate ValidateModel filter. \\n\\nLi\", \"kewise, a filter can be used to check if a record exists and return a 404 before the action is execu\", \"ted, \\neliminating the need to perform these checks in the action. Once you\\u2019ve pulled out common \\ncon\", \"ventions and organized your solution to separate infrastructure code and business logic from your \\nU\", \"I, your MVC action methods should be extremely thin: \\n\\n[HttpPut(\\\"{id}\\\")] \\n[ValidateAuthorExists] \\npu\", \"blic async Task<IActionResult> Put(int id, [FromBody]Author author) \\n{ \\n    await _authorRepository.\", \"UpdateAsync(author); \\n    return Ok(); \\n} \\n\\nYou can read more about implementing filters and downloa\", \"d a working sample from the MSDN \\nMagazine article, Real-World ASP.NET Core MVC Filters. \\n\\nIf you fi\", \"nd that you have a number of common responses from APIs based on common scenarios like \\nvalidation e\", \"rrors (Bad Request), resource not found, and server errors, you might consider using a \\nresult abstr\", \"action. The result abstraction would be returned by services consumed by API endpoints, \\nand the con\", \"troller action or endpoint would use a filter to translate these into IActionResults. \\n\\n56 \\n\\nCHAPTER\", \" 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n\\fReferences \\u2013 Structuring applications \\n\\n\\u2022 \\n\\nAreas \\nhttps:/\", \"/learn.microsoft.com/aspnet/core/mvc/controllers/areas \\n\\n\\u2022  MSDN Magazine \\u2013 Feature Slices for ASP.N\", \"ET Core MVC \\n\\nhttps://learn.microsoft.com/archive/msdn-magazine/2016/september/asp-net-core-feature-\", \"\\nslices-for-asp-net-core-mvc \\n\\n\\u2022 \\n\\nFilters \\nhttps://learn.microsoft.com/aspnet/core/mvc/controllers/\", \"filters \\n\\n\\u2022  MSDN Magazine \\u2013 Real World ASP.NET Core MVC Filters \\n\\nhttps://learn.microsoft.com/archi\", \"ve/msdn-magazine/2016/august/asp-net-core-real-world-\\nasp-net-core-mvc-filters \\n\\n\\u2022 \\n\\nResult in eShop\", \"OnWeb \\nhttps://github.com/dotnet-architecture/eShopOnWeb/wiki/Patterns#result \\n\\nSecurity \\n\\nSecuring \", \"web applications is a large topic, with many considerations. At its most basic level, security \\ninvo\", \"lves ensuring you know who a given request is coming from, and then ensuring that the request \\nonly \", \"has access to resources it should. Authentication is the process of comparing credentials \\nprovided \", \"with a request to those in a trusted data store, to see if the request should be treated as \\ncoming \", \"from a known entity. Authorization is the process of restricting access to certain resources \\nbased \", \"on user identity. A third security concern is protecting requests from eavesdropping by third \\nparti\", \"es, for which you should at least ensure that SSL is used by your application. \\n\\nIdentity \\n\\nASP.NET \", \"Core Identity is a membership system you can use to support login functionality for your \\napplicatio\", \"n. It has support for local user accounts as well as external login provider support from \\nproviders\", \" like Microsoft Account, Twitter, Facebook, Google, and more. In addition to ASP.NET Core \\nIdentity,\", \" your application can use windows authentication, or a third-party identity provider like \\nIdentity \", \"Server. \\n\\nASP.NET Core Identity is included in new project templates if the Individual User Accounts\", \" option is \\nselected. This template includes support for registration, login, external logins, forgo\", \"tten passwords, \\nand additional functionality. \\n\\n57 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n\", \" \\n\\fFigure 7-3. Select Individual User Accounts to have Identity preconfigured. \\n\\nIdentity support is\", \" configured in Program.cs or Startup, and includes configuring services as well as \\nmiddleware. \\n\\nCo\", \"nfigure Identity in Program.cs \\n\\nIn Program.cs, you configure services from the WebHostBuilder insta\", \"nce, and then once the app is \\ncreated, you configure its middleware. The key points to note are the\", \" call to AddDefaultIdentity for \\nrequired services and the UseAuthentication and UseAuthorization ca\", \"lls which add required \\nmiddleware. \\n\\nvar builder = WebApplication.CreateBuilder(args); \\n\\n// Add ser\", \"vices to the container. \\nvar connectionString = builder.Configuration.GetConnectionString(\\\"DefaultCo\", \"nnection\\\"); \\nbuilder.Services.AddDbContext<ApplicationDbContext>(options => \\n    options.UseSqlServe\", \"r(connectionString)); \\nbuilder.Services.AddDatabaseDeveloperPageExceptionFilter(); \\n\\nbuilder.Service\", \"s.AddDefaultIdentity<IdentityUser>(options => \\noptions.SignIn.RequireConfirmedAccount = true) \\n    .\", \"AddEntityFrameworkStores<ApplicationDbContext>(); \\nbuilder.Services.AddRazorPages(); \\n\\nvar app = bui\", \"lder.Build(); \\n\\n// Configure the HTTP request pipeline. \\nif (app.Environment.IsDevelopment()) \\n\\n58 \\n\", \"\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n \\n \\n \\n \\n \\n\\f{ \\n    app.UseMigrationsEndPoint(); \\n} \\n\", \"else \\n{ \\n  app.UseExceptionHandler(\\\"/Error\\\"); \\n  // The default HSTS value is 30 days. You may want \", \"to change this for production \\nscenarios, see https://aka.ms/aspnetcore-hsts. \\n  app.UseHsts(); \\n} \\n\", \"\\napp.UseHttpsRedirection(); \\napp.UseStaticFiles(); \\n\\napp.UseRouting(); \\n\\napp.UseAuthentication(); \\na\", \"pp.UseAuthorization(); \\n\\napp.MapRazorPages(); \\n\\napp.Run(); \\n\\nConfiguring Identity in app startup \\n\\n/\", \"/ Add framework services. \\nbuilder.Services.AddDbContext<ApplicationDbContext>(options => \\n    optio\", \"ns.UseSqlServer(Configuration.GetConnectionString(\\\"DefaultConnection\\\"))); \\nbuilder.Services.AddIdent\", \"ity<ApplicationUser, IdentityRole>() \\n    .AddEntityFrameworkStores<ApplicationDbContext>() \\n    .Ad\", \"dDefaultTokenProviders(); \\nbuilder.Services.AddMvc(); \\n\\nvar app = builder.Build(); \\n\\nif (app.Environ\", \"ment.IsDevelopment()) \\n{ \\n    app.UseMigrationsEndPoint(); \\n} \\nelse \\n{ \\n    app.UseExceptionHandler(\", \"\\\"/Error\\\"); \\n    app.UseHsts(); \\n} \\n\\napp.UseHttpsRedirection(); \\napp.UseStaticFiles(); \\n\\napp.UseRouti\", \"ng(); \\n\\napp.UseAuthentication(); \\napp.UseAuthorization(); \\n\\napp.MapRazorPages(); \\n\\nIt\\u2019s important th\", \"at UseAuthentication and UseAuthorization appear before MapRazorPages. When \\nconfiguring Identity se\", \"rvices, you\\u2019ll notice a call to AddDefaultTokenProviders. This has nothing to do \\nwith tokens that m\", \"ay be used to secure web communications, but instead refers to providers that \\ncreate prompts that c\", \"an be sent to users via SMS or email in order for them to confirm their identity. \\n\\n59 \\n\\nCHAPTER 6 |\", \" Develop ASP.NET Core MVC apps \\n\\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n\\fYou can learn more about configuring two\", \"-factor authentication and enabling external login providers \\nfrom the official ASP.NET Core docs. \\n\", \"\\nAuthentication \\n\\nAuthentication is the process of determining who is accessing the system. If you\\u2019r\", \"e using ASP.NET \\nCore Identity and the configuration methods shown in the previous section, it will \", \"automatically \\nconfigure some authentication defaults in the application. However, you can also conf\", \"igure these \\ndefaults manually, or override the ones set by AddIdentity. If you\\u2019re using Identity, i\", \"t configures \\ncookie-based authentication as the default scheme. \\n\\nIn web-based authentication, ther\", \"e are typically up to five actions that may be performed in the \\ncourse of authenticating a client o\", \"f a system. These are: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nAuthenticate. Use the information provided by the clien\", \"t to create an identity for them to use \\nwithin the application. \\n\\nChallenge. This action is used to\", \" require the client to identify themselves. \\n\\nForbid. Inform the client they are forbidden from perf\", \"orming an action. \\n\\nSign-in. Persist the existing client in some way. \\n\\nSign-out. Remove the client \", \"from persistence. \\n\\nThere are a number of common techniques for performing authentication in web app\", \"lications. These \\nare referred to as schemes. A given scheme will define actions for some or all of \", \"the above options. \\nSome schemes only support a subset of actions, and may require a separate scheme\", \" to perform those \\nit does not support. For example, the OpenId-Connect (OIDC) scheme doesn\\u2019t suppor\", \"t Sign-in or \\nSign-out, but is commonly configured to use Cookie authentication for this persistence\", \". \\n\\nIn your ASP.NET Core application, you can configure a DefaultAuthenticateScheme as well as optio\", \"nal \\nspecific schemes for each of the actions described above. For example, DefaultChallengeScheme, \", \"\\nDefaultForbidScheme, etc. Calling AddIdentity<TUser,TRole> configures a number of aspects of the \\na\", \"pplication and adds many required services. It also includes this call to configure the authenticati\", \"on \\nscheme: \\n\\nbuilder.Services.AddAuthentication(options => \\n{ \\n    options.DefaultAuthenticateSchem\", \"e = IdentityConstants.ApplicationScheme; \\n    options.DefaultChallengeScheme = IdentityConstants.App\", \"licationScheme; \\n    options.DefaultSignInScheme = IdentityConstants.ExternalScheme; \\n}); \\n\\nThese sc\", \"hemes use cookies for persistence and redirection to login pages for authentication by \\ndefault. The\", \"se schemes are appropriate for web applications that interact with users via web browsers, \\nbut not \", \"recommended for APIs. Instead, APIs will typically use another form of authentication, such as \\nJWT \", \"bearer tokens. \\n\\nWeb APIs are consumed by code, such as HttpClient in .NET applications and equivale\", \"nt types in other \\nframeworks. These clients expect a usable response from an API call, or a status \", \"code indicating what, \\nif any, problem has occurred. These clients are not interacting through a bro\", \"wser and do not render or \\ninteract with any HTML that an API might return. Thus, it is not appropri\", \"ate for API endpoints to \\nredirect their clients to login pages if they are not authenticated. Anoth\", \"er scheme is more appropriate. \\n\\n60 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n\\fTo configure \", \"authentication for APIs, you might set up authentication like the following, used by the \\nPublicApi \", \"project in the eShopOnWeb reference application: \\n\\nbuilder.Services \\n    .AddAuthentication(config =\", \"> \\n    { \\n      config.DefaultScheme = JwtBearerDefaults.AuthenticationScheme; \\n    }) \\n    .AddJwtB\", \"earer(config => \\n    { \\n        config.RequireHttpsMetadata = false; \\n        config.SaveToken = tru\", \"e; \\n        config.TokenValidationParameters = new TokenValidationParameters \\n        { \\n           \", \" ValidateIssuerSigningKey = true, \\n            IssuerSigningKey = new SymmetricSecurityKey(key), \\n  \", \"          ValidateIssuer = false, \\n            ValidateAudience = false \\n        }; \\n    }); \\n\\nWhile\", \" it is possible to configure multiple different authentication schemes within a single project, it i\", \"s \\nmuch simpler to configure a single default scheme. For this reason, among others, the eShopOnWeb \", \"\\nreference application separates its APIs into their own project, PublicApi, separate from the main \", \"Web \\nproject that includes the application\\u2019s views and Razor Pages. \\n\\nAuthentication in Blazor apps \", \"\\n\\nBlazor Server applications can leverage the same authentication features as any other ASP.NET Core\", \" \\napplication. Blazor WebAssembly applications cannot use the built-in Identity and Authentication \\n\", \"providers, however, since they run in the browser. Blazor WebAssembly applications can store user \\na\", \"uthentication status locally and can access claims to determine what actions users should be able to\", \" \\nperform. However, all authentication and authorization checks should be performed on the server \\nr\", \"egardless of any logic implemented inside the Blazor WebAssembly app, since users can easily \\nbypass\", \" the app and interact with the APIs directly. \\n\\nReferences \\u2013 Authentication \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nAuthen\", \"tication Actions and Defaults \\nhttps://stackoverflow.com/a/52493428 \\n\\nAuthentication and Authorizati\", \"on for SPAs \\nhttps://learn.microsoft.com/aspnet/core/security/authentication/identity-api-authorizat\", \"ion \\n\\nASP.NET Core Blazor Authentication and Authorization \\nhttps://learn.microsoft.com/aspnet/core/\", \"blazor/security/ \\n\\nSecurity: Authentication and Authorization in ASP.NET Web Forms and Blazor \\nhttps\", \"://learn.microsoft.com/dotnet/architecture/blazor-for-web-forms-developers/security-\\nauthentication-\", \"authorization \\n\\nAuthorization \\n\\nThe simplest form of authorization involves restricting access to an\", \"onymous users. This functionality \\ncan be achieved by applying the [Authorize] attribute to certain \", \"controllers or actions. If roles are \\n\\n61 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n\\fbeing u\", \"sed, the attribute can be further extended to restrict access to users who belong to certain \\nroles,\", \" as shown: \\n\\n[Authorize(Roles = \\\"HRManager,Finance\\\")] \\npublic class SalaryController : Controller \\n{\", \" \\n\\n} \\n\\nIn this case, users belonging to either the HRManager or Finance roles (or both) would have a\", \"ccess to \\nthe SalaryController. To require that a user belong to multiple roles (not just one of sev\", \"eral), you can \\napply the attribute multiple times, specifying a required role each time. \\n\\nSpecifyi\", \"ng certain sets of roles as strings in many different controllers and actions can lead to \\nundesirab\", \"le repetition. At a minimum, define constants for these string literals and use the constants \\nanywh\", \"ere you need to specify the string. You can also configure authorization policies, which \\nencapsulat\", \"e authorization rules, and then specify the policy instead of individual roles when applying \\nthe [A\", \"uthorize] attribute: \\n\\n[Authorize(Policy = \\\"CanViewPrivateReport\\\")] \\npublic IActionResult ExecutiveS\", \"alaryReport() \\n{ \\n    return View(); \\n} \\n\\nUsing policies in this way, you can separate the kinds of \", \"actions being restricted from the specific roles \\nor rules that apply to it. Later, if you create a \", \"new role that needs to have access to certain resources, \\nyou can just update a policy, rather than \", \"updating every list of roles on every [Authorize] attribute. \\n\\nClaims \\n\\nClaims are name value pairs \", \"that represent properties of an authenticated user. For example, you \\nmight store users\\u2019 employee nu\", \"mber as a claim. Claims can then be used as part of authorization \\npolicies. You could create a poli\", \"cy called \\u201cEmployeeOnly\\u201d that requires the existence of a claim called \\n\\\"EmployeeNumber\\\", as shown i\", \"n this example: \\n\\npublic void ConfigureServices(IServiceCollection services) \\n{ \\n    services.AddMvc\", \"(); \\n    services.AddAuthorization(options => \\n    { \\n        options.AddPolicy(\\\"EmployeeOnly\\\", poli\", \"cy => policy.RequireClaim(\\\"EmployeeNumber\\\")); \\n    }); \\n} \\n\\nThis policy could then be used with the \", \"[Authorize] attribute to protect any controller and/or action, \\nas described above. \\n\\nSecuring web A\", \"PIs \\n\\nMost web APIs should implement a token-based authentication system. Token authentication is \\ns\", \"tateless and designed to be scalable. In a token-based authentication system, the client must first \", \"\\nauthenticate with the authentication provider. If successful, the client is issued a token, which i\", \"s simply \\n\\n62 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n \\n\\fa cryptographically meaningful st\", \"ring of characters. The most common format for tokens is JSON Web \\nToken, or JWT (often pronounced \\u201c\", \"jot\\u201d). When the client then needs to issue a request to an API, it \\nadds this token as a header on t\", \"he request. The server then validates the token found in the request \\nheader before completing the r\", \"equest. Figure 7-4 demonstrates this process. \\n\\nFigure 7-4. Token-based authentication for Web APIs.\", \" \\n\\nYou can create your own authentication service, integrate with Azure AD and OAuth, or implement a\", \" \\nservice using an open-source tool like IdentityServer. \\n\\nJWT tokens can embed claims about the use\", \"r, which can be read on the client or server. You can use a \\ntool like jwt.io to view the contents o\", \"f a JWT token. Do not store sensitive data like passwords or keys \\nin JTW tokens, since their conten\", \"ts are easily read. \\n\\nWhen using JWT tokens with SPA or Blazor WebAssembly applications, you must st\", \"ore the token \\nsomewhere on the client and then add it to every API call. This activity is typically\", \" done as a header, as \\nthe following code demonstrates: \\n\\n// AuthService.cs in BlazorAdmin project o\", \"f eShopOnWeb \\nprivate async Task SetAuthorizationHeader() \\n{ \\n      var token = await GetToken(); \\n \", \"     _httpClient.DefaultRequestHeaders.Authorization = new \\nAuthenticationHeaderValue(\\\"Bearer\\\", toke\", \"n); \\n} \\n\\nAfter calling the above method, requests made with the _httpClient will have the token embe\", \"dded in \\nthe request\\u2019s headers, allowing the server-side API to authenticate and authorize the reque\", \"st. \\n\\n63 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n \\n\\fCustom Security \\n\\nCaution \\n\\nAs a gener\", \"al rule, avoid implementing your own custom security implementations. \\n\\nBe especially careful about \", \"\\u201crolling your own\\u201d implementation of cryptography, user membership, or \\ntoken generation system. The\", \"re are many commercial and open-source alternatives available, which \\nwill almost certainly have bet\", \"ter security than a custom implementation. \\n\\nReferences \\u2013 Security \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nSecurit\", \"y Docs Overview \\nhttps://learn.microsoft.com/aspnet/core/security/ \\n\\nEnforcing SSL in an ASP.NET Cor\", \"e App \\nhttps://learn.microsoft.com/aspnet/core/security/enforcing-ssl \\n\\nIntroduction to Identity \\nht\", \"tps://learn.microsoft.com/aspnet/core/security/authentication/identity \\n\\nIntroduction to Authorizati\", \"on \\nhttps://learn.microsoft.com/aspnet/core/security/authorization/introduction \\n\\nAuthentication and\", \" Authorization for API Apps in Azure App Service \\nhttps://learn.microsoft.com/azure/app-service-api/\", \"app-service-api-authentication \\n\\nIdentity Server \\nhttps://github.com/IdentityServer \\n\\nClient communi\", \"cation \\n\\nIn addition to serving pages and responding to requests for data via web APIs, ASP.NET Core\", \" apps can \\ncommunicate directly with connected clients. This outbound communication can use a variet\", \"y of \\ntransport technologies, the most common being WebSockets. ASP.NET Core SignalR is a library th\", \"at \\nmakes it simple to add real-time server-to-client communication functionality to your applicatio\", \"ns. \\nSignalR supports a variety of transport technologies, including WebSockets, and abstracts away \", \"many \\nof the implementation details from the developer. \\n\\nReal-time client communication, whether us\", \"ing WebSockets directly or other techniques, are useful in \\na variety of application scenarios. Some\", \" examples include: \\n\\n\\u2022 \\n\\nLive chat room applications \\n\\n\\u2022  Monitoring applications \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nJob \", \"progress updates \\n\\nNotifications \\n\\nInteractive forms applications \\n\\nWhen building client communicati\", \"on into your applications, there are typically two components: \\n\\n64 \\n\\nCHAPTER 6 | Develop ASP.NET Co\", \"re MVC apps \\n\\n \\n \\n\\f\\u2022 \\n\\n\\u2022 \\n\\nServer-side connection manager (SignalR Hub, WebSocketManager WebSocketHa\", \"ndler) \\n\\nClient-side library \\n\\nClients aren\\u2019t limited to browsers \\u2013 mobile apps, console apps, and o\", \"ther native apps can also \\ncommunicate using SignalR/WebSockets. The following simple program echoes\", \" all content sent to a \\nchat application to the console, as part of a WebSocketManager sample applic\", \"ation: \\n\\npublic class Program \\n{ \\n    private static Connection _connection; \\n    public static void\", \" Main(string[] args) \\n    { \\n        StartConnectionAsync(); \\n        _connection.On(\\\"receiveMessage\", \"\\\", (arguments) => \\n        { \\n            Console.WriteLine($\\\"{arguments[0]} said: {arguments[1]}\\\");\", \" \\n        }); \\n        Console.ReadLine(); \\n        StopConnectionAsync(); \\n    } \\n\\n    public stati\", \"c async Task StartConnectionAsync() \\n    { \\n        _connection = new Connection(); \\n        await _\", \"connection.StartConnectionAsync(\\\"ws://localhost:65110/chat\\\"); \\n    } \\n\\n    public static async Task \", \"StopConnectionAsync() \\n    { \\n        await _connection.StopConnectionAsync(); \\n    } \\n} \\n\\nConsider \", \"ways in which your applications communicate directly with client applications, and consider \\nwhether\", \" real-time communication would improve your app\\u2019s user experience. \\n\\nReferences \\u2013 Client Communicati\", \"on \\n\\n\\u2022 \\n\\nASP.NET Core SignalR \\nhttps://github.com/dotnet/aspnetcore/tree/main/src/SignalR \\n\\n\\u2022  WebSo\", \"cket Manager \\n\\nhttps://github.com/radu-matei/websocket-manager \\n\\nDomain-driven design \\u2013 Should you a\", \"pply it? \\n\\nDomain-Driven Design (DDD) is an agile approach to building software that emphasizes focu\", \"sing on \\nthe business domain. It places a heavy emphasis on communication and interaction with busin\", \"ess \\ndomain expert(s) who can relate to the developers how the real-world system works. For example,\", \" if \\nyou\\u2019re building a system that handles stock trades, your domain expert might be an experienced \", \"stock \\nbroker. DDD is designed to address large, complex business problems, and is often not appropr\", \"iate \\nfor smaller, simpler applications, as the investment in understanding and modeling the domain \", \"is not \\nworth it. \\n\\n65 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n \\n \\n\\fWhen building software\", \" following a DDD approach, your team (including non-technical stakeholders \\nand contributors) should\", \" develop a ubiquitous language for the problem space. That is, the same \\nterminology should be used \", \"for the real-world concept being modeled, the software equivalent, and \\nany structures that might ex\", \"ist to persist the concept (for example, database tables). Thus, the \\nconcepts described in the ubiq\", \"uitous language should form the basis for your domain model. \\n\\nYour domain model comprises objects t\", \"hat interact with one another to represent the behavior of the \\nsystem. These objects may fall into \", \"the following categories: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nEntities, which represent objects with a thread of ident\", \"ity. Entities are typically stored in \\npersistence with a key by which they can later be retrieved. \", \"\\n\\nAggregates, which represent groups of objects that should be persisted as a unit. \\n\\nValue objects,\", \" which represent concepts that can be compared on the basis of the sum of \\ntheir property values. Fo\", \"r example, DateRange consisting of a start and end date. \\n\\nDomain events, which represent things hap\", \"pening within the system that are of interest to \\nother parts of the system. \\n\\nA DDD domain model sh\", \"ould encapsulate complex behavior within the model. Entities, in particular, \\nshould not merely be c\", \"ollections of properties. When the domain model lacks behavior and merely \\nrepresents the state of t\", \"he system, it is said to be an anemic model, which is undesirable in DDD. \\n\\nIn addition to these mod\", \"el types, DDD typically employs a variety of patterns: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nRepository, for abstrac\", \"ting persistence details. \\n\\nFactory, for encapsulating complex object creation. \\n\\nServices, for enca\", \"psulating complex behavior and/or infrastructure implementation details. \\n\\nCommand, for decoupling i\", \"ssuing commands and executing the command itself. \\n\\nSpecification, for encapsulating query details. \", \"\\n\\nDDD also recommends the use of the Clean Architecture discussed previously, allowing for loose \\nco\", \"upling, encapsulation, and code that can easily be verified using unit tests. \\n\\nWhen should you appl\", \"y DDD \\n\\nDDD is well suited to large applications with significant business (not just technical) comp\", \"lexity. The \\napplication should require the knowledge of domain experts. There should be significant\", \" behavior in \\nthe domain model itself, representing business rules and interactions beyond simply st\", \"oring and \\nretrieving the current state of various records from data stores. \\n\\nWhen shouldn\\u2019t you ap\", \"ply DDD \\n\\nDDD involves investments in modeling, architecture, and communication that may not be warr\", \"anted \\nfor smaller applications or applications that are essentially just CRUD (create/read/update/d\", \"elete). If \\nyou choose to approach your application following DDD, but find that your domain has an \", \"anemic \\nmodel with no behavior, you may need to rethink your approach. Either your application may n\", \"ot \\n\\n66 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n\\fneed DDD, or you may need assistance refa\", \"ctoring your application to encapsulate business logic in \\nthe domain model, rather than in your dat\", \"abase or user interface. \\n\\nA hybrid approach would be to only use DDD for the transactional or more \", \"complex areas of the \\napplication, but not for simpler CRUD or read-only portions of the application\", \". For instance, you don\\u2019t \\nneed the constraints of an Aggregate if you\\u2019re querying data to display a\", \" report or to visualize data \\nfor a dashboard. It\\u2019s perfectly acceptable to have a separate, simpler\", \" read model for such \\nrequirements. \\n\\nReferences \\u2013 Domain-Driven Design \\n\\n\\u2022 \\n\\nDDD in Plain English (\", \"StackOverflow Answer) \\nhttps://stackoverflow.com/questions/1222392/can-someone-explain-domain-driven\", \"-design-\\nddd-in-plain-english-please/1222488#1222488 \\n\\nDeployment \\n\\nThere are a few steps involved i\", \"n the process of deploying your ASP.NET Core application, regardless \\nof where it will be hosted. Th\", \"e first step is to publish the application, which can be done using the \\ndotnet publish CLI command.\", \" This step will compile the application and place all of the files needed to \\nrun the application in\", \"to a designated folder. When you deploy from Visual Studio, this step is \\nperformed for you automati\", \"cally. The publish folder contains .exe and .dll files for the application and \\nits dependencies. A \", \"self-contained application will also include a version of the .NET runtime. ASP.NET \\nCore applicatio\", \"ns will also include configuration files, static client assets, and MVC views. \\n\\nASP.NET Core applic\", \"ations are console applications that must be started when the server boots and \\nrestarted if the app\", \"lication (or server) crashes. A process manager can be used to automate this \\nprocess. The most comm\", \"on process managers for ASP.NET Core are Nginx and Apache on Linux and \\nIIS or Windows Service on Wi\", \"ndows. \\n\\nIn addition to a process manager, ASP.NET Core applications may use a reverse proxy server.\", \" A \\nreverse proxy server receives HTTP requests from the Internet and forwards them to Kestrel after\", \" \\nsome preliminary handling. Reverse proxy servers provide a layer of security for the application. \", \"\\nKestrel also doesn\\u2019t support hosting multiple applications on the same port, so techniques like hos\", \"t \\nheaders cannot be used with it to enable hosting multiple applications on the same port and IP \\na\", \"ddress. \\n\\nFigure 7-5. ASP.NET hosted in Kestrel behind a reverse proxy server \\n\\nAnother scenario in \", \"which a reverse proxy can be helpful is to secure multiple applications using \\nSSL/HTTPS. In this ca\", \"se, only the reverse proxy would need to have SSL configured. Communication \\nbetween the reverse pro\", \"xy server and Kestrel could take place over HTTP, as shown in Figure 7-6. \\n\\n67 \\n\\nCHAPTER 6 | Develop\", \" ASP.NET Core MVC apps \\n\\n \\n \\n \\n\\fFigure 7-6. ASP.NET hosted behind an HTTPS-secured reverse proxy ser\", \"ver \\n\\nAn increasingly popular approach is to host your ASP.NET Core application in a Docker containe\", \"r, \\nwhich then can be hosted locally or deployed to Azure for cloud-based hosting. The Docker contai\", \"ner \\ncould contain your application code, running on Kestrel, and would be deployed behind a reverse\", \" \\nproxy server, as shown above. \\n\\nIf you\\u2019re hosting your application on Azure, you can use Microsoft\", \" Azure Application Gateway as a \\ndedicated virtual appliance to provide several services. In additio\", \"n to acting as a reverse proxy for \\nindividual applications, Application Gateway can also offer the \", \"following features: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nHTTP load balancing \\n\\nSSL offload (SSL only to Internet) \\n\\nEnd to \", \"End SSL \\n\\n\\u2022  Multi-site routing (consolidate up to 20 sites on a single Application Gateway) \\n\\n\\u2022  We\", \"b application firewall \\n\\n\\u2022  Websocket support \\n\\n\\u2022 \\n\\nAdvanced diagnostics \\n\\nLearn more about Azure de\", \"ployment options in Chapter 10. \\n\\nReferences \\u2013 Deployment \\n\\n\\u2022 \\n\\nHosting and Deployment Overview \\nhtt\", \"ps://learn.microsoft.com/aspnet/core/publishing/ \\n\\n\\u2022  When to use Kestrel with a reverse proxy \\n\\nhtt\", \"ps://learn.microsoft.com/aspnet/core/fundamentals/servers/kestrel#when-to-use-kestrel-\\nwith-a-revers\", \"e-proxy \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nHost ASP.NET Core apps in Docker \\nhttps://learn.microsoft.com/aspnet/core/publishi\", \"ng/docker \\n\\nIntroducing Azure Application Gateway \\nhttps://learn.microsoft.com/azure/application-gat\", \"eway/application-gateway-introduction \\n\\n68 \\n\\nCHAPTER 6 | Develop ASP.NET Core MVC apps \\n\\n \\n \\n \\n\\fCHAP\", \"TER  7 \\n\\nWorking with Data in \\nASP.NET Core Apps \\n\\n\\u201cData is a precious thing and will last longer th\", \"an the systems themselves.\\u201d \\n\\nTim Berners-Lee \\n\\nData access is an important part of almost any softw\", \"are application. ASP.NET Core supports various \\ndata access options, including Entity Framework Core\", \" (and Entity Framework 6 as well), and can work \\nwith any .NET data access framework. The choice of \", \"which data access framework to use depends on \\nthe application\\u2019s needs. Abstracting these choices fr\", \"om the ApplicationCore and UI projects, and \\nencapsulating implementation details in Infrastructure,\", \" helps to produce loosely coupled, testable \\nsoftware. \\n\\nEntity Framework Core (for relational datab\", \"ases) \\n\\nIf you\\u2019re writing a new ASP.NET Core application that needs to work with relational data, th\", \"en Entity \\nFramework Core (EF Core) is the recommended way for your application to access its data. \", \"EF Core is \\nan object-relational mapper (O/RM) that enables .NET developers to persist objects to an\", \"d from a \\ndata source. It eliminates the need for most of the data access code developers would typi\", \"cally need \\nto write. Like ASP.NET Core, EF Core has been rewritten from the ground up to support mo\", \"dular \\ncross-platform applications. You add it to your application as a NuGet package, configure it \", \"during \\napp startup, and request it through dependency injection wherever you need it. \\n\\nTo use EF C\", \"ore with a SQL Server database, run the following dotnet CLI command: \\n\\ndotnet add package Microsoft\", \".EntityFrameworkCore.SqlServer \\n\\nTo add support for an InMemory data source, for testing: \\n\\ndotnet a\", \"dd package Microsoft.EntityFrameworkCore.InMemory \\n\\nThe DbContext \\n\\nTo work with EF Core, you need a\", \" subclass of DbContext. This class holds properties representing \\ncollections of the entities your a\", \"pplication will work with. The eShopOnWeb sample includes a \\nCatalogContext with collections for ite\", \"ms, brands, and types: \\n\\n69 \\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps \\n\\n \\n \\n\\fpublic class\", \" CatalogContext : DbContext \\n{ \\n  public CatalogContext(DbContextOptions<CatalogContext> options) : \", \"base(options) \\n  { \\n\\n  } \\n\\n  public DbSet<CatalogItem> CatalogItems { get; set; } \\n  public DbSet<Ca\", \"talogBrand> CatalogBrands { get; set; } \\n  public DbSet<CatalogType> CatalogTypes { get; set; } \\n} \\n\", \"\\nYour DbContext must have a constructor that accepts DbContextOptions and pass this argument to \\nthe\", \" base DbContext constructor. If you have only one DbContext in your application, you can pass an \\nin\", \"stance of DbContextOptions, but if you have more than one you must use the generic \\nDbContextOptions\", \"<T> type, passing in your DbContext type as the generic parameter. \\n\\nConfiguring EF Core \\n\\nIn your A\", \"SP.NET Core application, you\\u2019ll typically configure EF Core in Program.cs with your \\napplication\\u2019s o\", \"ther dependencies. EF Core uses a DbContextOptionsBuilder, which supports several \\nhelpful extension\", \" methods to streamline its configuration. To configure CatalogContext to use a SQL \\nServer database \", \"with a connection string defined in Configuration, you would add the following code: \\n\\nbuilder.Servi\", \"ces.AddDbContext<CatalogContext>( \\n    options => options.UseSqlServer( \\n        builder.Configurati\", \"on.GetConnectionString(\\\"DefaultConnection\\\"))); \\n\\nTo use the in-memory database: \\n\\nbuilder.Services.A\", \"ddDbContext<CatalogContext>(options => \\n    options.UseInMemoryDatabase()); \\n\\nOnce you have installe\", \"d EF Core, created a DbContext child type, and added the type to the \\napplication\\u2019s services, you ar\", \"e ready to use EF Core. You can request an instance of your DbContext \\ntype in any service that need\", \"s it and start working with your persisted entities using LINQ as if they \\nwere simply in a collecti\", \"on. EF Core does the work of translating your LINQ expressions into SQL \\nqueries to store and retrie\", \"ve your data. \\n\\nYou can see the queries EF Core is executing by configuring a logger and ensuring it\", \"s level is set to at \\nleast Information, as shown in Figure 8-1. \\n\\n70 \\n\\nCHAPTER 7 | Working with Dat\", \"a in ASP.NET Core Apps \\n\\n \\n \\n \\n \\n\\fFigure 8-1. Logging EF Core queries to the console \\n\\nFetching and \", \"storing Data \\n\\nTo retrieve data from EF Core, you access the appropriate property and use LINQ to fi\", \"lter the result. \\nYou can also use LINQ to perform projection, transforming the result from one type\", \" to another. The \\nfollowing example would retrieve CatalogBrands, ordered by name, filtered by their\", \" Enabled property, \\nand projected onto a SelectListItem type: \\n\\nvar brandItems = await _context.Cata\", \"logBrands \\n    .Where(b => b.Enabled) \\n    .OrderBy(b => b.Name) \\n    .Select(b => new SelectListIte\", \"m { \\n        Value = b.Id, Text = b.Name }) \\n    .ToListAsync(); \\n\\nIt\\u2019s important in the above examp\", \"le to add the call to ToListAsync in order to execute the query \\nimmediately. Otherwise, the stateme\", \"nt will assign an IQueryable<SelectListItem> to brandItems, \\nwhich will not be executed until it is \", \"enumerated. There are pros and cons to returning IQueryable \\nresults from methods. It allows the que\", \"ry EF Core will construct to be further modified, but can also \\nresult in errors that only occur at \", \"run time, if operations are added to the query that EF Core cannot \\ntranslate. It\\u2019s generally safer \", \"to pass any filters into the method performing the data access, and return \\nback an in-memory collec\", \"tion (for example, List<T>) as the result. \\n\\nEF Core tracks changes on entities it fetches from pers\", \"istence. To save changes to a tracked entity, you \\njust call the SaveChangesAsync method on the DbCo\", \"ntext, making sure it\\u2019s the same DbContext \\ninstance that was used to fetch the entity. Adding and r\", \"emoving entities is directly done on the \\nappropriate DbSet property, again with a call to SaveChang\", \"esAsync to execute the database \\ncommands. The following example demonstrates adding, updating, and \", \"removing entities from \\npersistence. \\n\\n71 \\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps \\n\\n \\n \", \"\\n \\n\\f// create \\nvar newBrand = new CatalogBrand() { Brand = \\\"Acme\\\" }; \\n_context.Add(newBrand); \\nawait\", \" _context.SaveChangesAsync(); \\n\\n// read and update \\nvar existingBrand = _context.CatalogBrands.Find(\", \"1); \\nexistingBrand.Brand = \\\"Updated Brand\\\"; \\nawait _context.SaveChangesAsync(); \\n\\n// read and delete\", \" (alternate Find syntax) \\nvar brandToDelete = _context.Find<CatalogBrand>(2); \\n_context.CatalogBrand\", \"s.Remove(brandToDelete); \\nawait _context.SaveChangesAsync(); \\n\\nEF Core supports both synchronous and\", \" async methods for fetching and saving. In web applications, \\nit\\u2019s recommended to use the async/awai\", \"t pattern with the async methods, so that web server threads \\nare not blocked while waiting for data\", \" access operations to complete. \\n\\nFor more information, see Buffering and Streaming. \\n\\nFetching rela\", \"ted data \\n\\nWhen EF Core retrieves entities, it populates all of the properties that are stored direc\", \"tly with that \\nentity in the database. Navigation properties, such as lists of related entities, are\", \" not populated and \\nmay have their value set to null. This process ensures EF Core is not fetching m\", \"ore data than is \\nneeded, which is especially important for web applications, which must quickly pro\", \"cess requests and \\nreturn responses in an efficient manner. To include relationships with an entity \", \"using eager loading, \\nyou specify the property using the Include extension method on the query, as s\", \"hown: \\n\\n// .Include requires using Microsoft.EntityFrameworkCore \\nvar brandsWithItems = await _conte\", \"xt.CatalogBrands \\n    .Include(b => b.Items) \\n    .ToListAsync(); \\n\\nYou can include multiple relatio\", \"nships, and you can also include subrelationships using ThenInclude. \\nEF Core will execute a single \", \"query to retrieve the resulting set of entities. Alternately you can include \\nnavigation properties \", \"of navigation properties by passing a \\u2018.\\u2019-separated string to the .Include() \\nextension method, like\", \" so: \\n\\n    .Include(\\\"Items.Products\\\") \\n\\nIn addition to encapsulating filtering logic, a specificatio\", \"n can specify the shape of the data to be \\nreturned, including which properties to populate. The eSh\", \"opOnWeb sample includes several \\nspecifications that demonstrate encapsulating eager loading informa\", \"tion within the specification. You \\ncan see how the specification is used as part of a query here: \\n\", \"\\n// Includes all expression-based includes \\nquery = specification.Includes.Aggregate(query, \\n       \", \"     (current, include) => current.Include(include)); \\n\\n// Include any string-based include statemen\", \"ts \\nquery = specification.IncludeStrings.Aggregate(query, \\n            (current, include) => current\", \".Include(include)); \\n\\n72 \\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps \\n\\n \\n \\n \\n \\n \\n\\fAnother o\", \"ption for loading related data is to use explicit loading. Explicit loading allows you to load \\naddi\", \"tional data into an entity that has already been retrieved. Since this approach involves a separate \", \"\\nrequest to the database, it\\u2019s not recommended for web applications, which should minimize the \\nnumb\", \"er of database round trips made per request. \\n\\nLazy loading is a feature that automatically loads re\", \"lated data as it is referenced by the application. EF \\nCore has added support for lazy loading in ve\", \"rsion 2.1. Lazy loading is not enabled by default and \\nrequires installing the Microsoft.EntityFrame\", \"workCore.Proxies. As with explicit loading, lazy loading \\nshould typically be disabled for web appli\", \"cations, since its use will result in additional database \\nqueries being made within each web reques\", \"t. Unfortunately, the overhead incurred by lazy loading \\noften goes unnoticed at development time, w\", \"hen the latency is small and often the data sets used for \\ntesting are small. However, in production\", \", with more users, more data, and more latency, the \\nadditional database requests can often result i\", \"n poor performance for web applications that make \\nheavy use of lazy loading. \\n\\nAvoid Lazy Loading E\", \"ntities in Web Applications \\n\\nIt\\u2019s a good idea to test your application while examining the actual d\", \"atabase queries it makes. Under \\ncertain circumstances, EF Core may make many more queries or a more\", \" expensive query than is \\noptimal for the application. One such problem is known as a Cartesian Expl\", \"osion. The EF Core team \\nmakes available the AsSplitQuery method as one of several ways to tune runt\", \"ime behavior. \\n\\nEncapsulating data \\n\\nEF Core supports several features that allow your model to prop\", \"erly encapsulate its state. A common \\nproblem in domain models is that they expose collection naviga\", \"tion properties as publicly accessible \\nlist types. This problem allows any collaborator to manipula\", \"te the contents of these collection types, \\nwhich may bypass important business rules related to the\", \" collection, possibly leaving the object in an \\ninvalid state. The solution to this problem is to ex\", \"pose read-only access to related collections, and \\nexplicitly provide methods defining ways in which\", \" clients can manipulate them, as in this example: \\n\\npublic class Basket : BaseEntity \\n{ \\n  public st\", \"ring BuyerId { get; set; } \\n  private readonly List<BasketItem> _items = new List<BasketItem>(); \\n  \", \"public IReadOnlyCollection<BasketItem> Items => _items.AsReadOnly(); \\n\\n  public void AddItem(int cat\", \"alogItemId, decimal unitPrice, int quantity = 1) \\n  { \\n    var existingItem = Items.FirstOrDefault(i\", \" => i.CatalogItemId == catalogItemId); \\n    if (existingItem == null) \\n    { \\n      _items.Add(new B\", \"asketItem() \\n      { \\n        CatalogItemId = catalogItemId, \\n        Quantity = quantity, \\n        \", \"UnitPrice = unitPrice \\n      }); \\n    }  \\n    else existingItem.Quantity += quantity; \\n  } \\n} \\n\\n73 \\n\", \"\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps \\n\\n \\n \\n \\n\\fThis entity type doesn\\u2019t expose a publi\", \"c List or ICollection property, but instead exposes an \\nIReadOnlyCollection type that wraps the unde\", \"rlying List type. When using this pattern, you can \\nindicate to Entity Framework Core to use the bac\", \"king field like so: \\n\\nprivate void ConfigureBasket(EntityTypeBuilder<Basket> builder) \\n{ \\n  var navi\", \"gation = builder.Metadata.FindNavigation(nameof(Basket.Items)); \\n\\n  navigation.SetPropertyAccessMode\", \"(PropertyAccessMode.Field); \\n} \\n\\nAnother way in which you can improve your domain model is by using \", \"value objects for types that \\nlack identity and are only distinguished by their properties. Using su\", \"ch types as properties of your \\nentities can help keep logic specific to the value object where it b\", \"elongs, and can avoid duplicate logic \\nbetween multiple entities that use the same concept. In Entit\", \"y Framework Core, you can persist value \\nobjects in the same table as their owning entity by configu\", \"ring the type as an owned entity, like so: \\n\\nprivate void ConfigureOrder(EntityTypeBuilder<Order> bu\", \"ilder) \\n{ \\n  builder.OwnsOne(o => o.ShipToAddress); \\n} \\n\\nIn this example, the ShipToAddress property\", \" is of type Address. Address is a value object with several \\nproperties such as Street and City. EF \", \"Core maps the Order object to its table with one column per \\nAddress property, prefixing each column\", \" name with the name of the property. In this example, the \\nOrder table would include columns such as\", \" ShipToAddress_Street and ShipToAddress_City. It\\u2019s also \\npossible to store owned types in separate t\", \"ables, if desired. \\n\\nLearn more about owned entity support in EF Core. \\n\\nResilient connections \\n\\nExt\", \"ernal resources like SQL databases may occasionally be unavailable. In cases of temporary \\nunavailab\", \"ility, applications can use retry logic to avoid raising an exception. This technique is \\ncommonly r\", \"eferred to as connection resiliency. You can implement your own retry with exponential \\nbackoff tech\", \"nique by attempting to retry with an exponentially increasing wait time, until a maximum \\nretry coun\", \"t has been reached. This technique embraces the fact that cloud resources might \\nintermittently be u\", \"navailable for short periods of time, resulting in the failure of some requests. \\n\\nFor Azure SQL DB,\", \" Entity Framework Core already provides internal database connection resiliency \\nand retry logic. Bu\", \"t you need to enable the Entity Framework execution strategy for each DbContext \\nconnection if you w\", \"ant to have resilient EF Core connections. \\n\\nFor instance, the following code at the EF Core connect\", \"ion level enables resilient SQL connections that \\nare retried if the connection fails. \\n\\nbuilder.Ser\", \"vices.AddDbContext<OrderingContext>(options => \\n{ \\n    options.UseSqlServer(builder.Configuration[\\\"C\", \"onnectionString\\\"], \\n        sqlServerOptionsAction: sqlOptions => \\n        { \\n            sqlOptions\", \".EnableRetryOnFailure( \\n            maxRetryCount: 5, \\n\\n74 \\n\\nCHAPTER 7 | Working with Data in ASP.NE\", \"T Core Apps \\n\\n \\n \\n \\n\\f            maxRetryDelay: TimeSpan.FromSeconds(30), \\n            errorNumbersT\", \"oAdd: null); \\n        } \\n    ); \\n}); \\n\\nExecution strategies and explicit transactions using BeginTra\", \"nsaction and multiple \\nDbContexts \\n\\nWhen retries are enabled in EF Core connections, each operation \", \"you perform using EF Core becomes \\nits own retryable operation. Each query and each call to SaveChan\", \"gesAsync will be retried as a unit if a \\ntransient failure occurs. \\n\\nHowever, if your code initiates\", \" a transaction using BeginTransaction, you are defining your own group \\nof operations that need to b\", \"e treated as a unit; everything inside the transaction has to be rolled back \\nif a failure occurs. Y\", \"ou will see an exception like the following if you attempt to execute that \\ntransaction when using a\", \"n EF execution strategy (retry policy) and you include several \\nSaveChangesAsync from multiple DbCon\", \"texts in it. \\n\\nSystem.InvalidOperationException: The configured execution strategy \\nSqlServerRetryin\", \"gExecutionStrategy does not support user initiated transactions. Use the execution \\nstrategy returne\", \"d by DbContext.Database.CreateExecutionStrategy() to execute all the operations in \\nthe transaction \", \"as a retryable unit. \\n\\nThe solution is to manually invoke the EF execution strategy with a delegate \", \"representing everything \\nthat needs to be executed. If a transient failure occurs, the execution str\", \"ategy will invoke the delegate \\nagain. The following code shows how to implement this approach: \\n\\n//\", \" Use of an EF Core resiliency strategy when using multiple DbContexts \\n// within an explicit transac\", \"tion \\n// See: \\n// https://learn.microsoft.com/ef/core/miscellaneous/connection-resiliency \\nvar strat\", \"egy = _catalogContext.Database.CreateExecutionStrategy(); \\nawait strategy.ExecuteAsync(async () => \\n\", \"{ \\n  // Achieving atomicity between original Catalog database operation and the \\n  // IntegrationEve\", \"ntLog thanks to a local transaction \\n  using (var transaction = _catalogContext.Database.BeginTransa\", \"ction()) \\n  { \\n    _catalogContext.CatalogItems.Update(catalogItem); \\n    await _catalogContext.Save\", \"ChangesAsync(); \\n\\n    // Save to EventLog only if product price changed \\n    if (raiseProductPriceCh\", \"angedEvent) \\n    { \\n      await _integrationEventLogService.SaveEventAsync(priceChangedEvent); \\n    \", \"  transaction.Commit(); \\n    } \\n  } \\n}); \\n\\nThe first DbContext is the _catalogContext and the second\", \" DbContext is within the \\n_integrationEventLogService object. Finally, the Commit action would be pe\", \"rformed multiple \\nDbContexts and using an EF Execution Strategy. \\n\\n75 \\n\\nCHAPTER 7 | Working with Dat\", \"a in ASP.NET Core Apps \\n\\n \\n \\n \\n\\fReferences \\u2013 Entity Framework Core \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nEF Core Docs https:\", \"//learn.microsoft.com/ef/ \\n\\nEF Core: Related Data https://learn.microsoft.com/ef/core/querying/relat\", \"ed-data \\n\\nAvoid Lazy Loading Entities in ASPNET Applications https://ardalis.com/avoid-lazy-\\nloading\", \"-entities-in-asp-net-applications \\n\\nEF Core or micro-ORM? \\n\\nWhile EF Core is a great choice for mana\", \"ging persistence, and for the most part encapsulates \\ndatabase details from application developers, \", \"it isn\\u2019t the only choice. Another popular open-source \\nalternative is Dapper, a so-called micro-ORM.\", \" A micro-ORM is a lightweight, less full-featured tool for \\nmapping objects to data structures. In t\", \"he case of Dapper, its design goals focus on performance, \\nrather than fully encapsulating the under\", \"lying queries it uses to retrieve and update data. Because it \\ndoesn\\u2019t abstract SQL from the develop\", \"er, Dapper is \\u201ccloser to the metal\\u201d and lets developers write the \\nexact queries they want to use fo\", \"r a given data access operation. \\n\\nEF Core has two significant features it provides which separate i\", \"t from Dapper but also add to its \\nperformance overhead. The first is the translation from LINQ expr\", \"essions into SQL. These translations \\nare cached, but even so there is overhead in performing them t\", \"he first time. The second is change \\ntracking on entities (so that efficient update statements can b\", \"e generated). This behavior can be \\nturned off for specific queries by using the AsNoTracking extens\", \"ion. EF Core also generates SQL \\nqueries that usually are very efficient and in any case perfectly a\", \"cceptable from a performance \\nstandpoint, but if you need fine control over the precise query to be \", \"executed, you can pass in custom \\nSQL (or execute a stored procedure) using EF Core, too. In this ca\", \"se, Dapper still outperforms EF Core, \\nbut only very slightly. Current performance benchmark data fo\", \"r a variety of data access methods can \\nbe found on the Dapper site. \\n\\nTo see how the syntax for Dap\", \"per varies from EF Core, consider these two versions of the same \\nmethod for retrieving a list of it\", \"ems: \\n\\n// EF Core \\nprivate readonly CatalogContext _context; \\npublic async Task<IEnumerable<CatalogT\", \"ype>> GetCatalogTypes() \\n{ \\n  return await _context.CatalogTypes.ToListAsync(); \\n} \\n\\n// Dapper \\npriv\", \"ate readonly SqlConnection _conn; \\npublic async Task<IEnumerable<CatalogType>> GetCatalogTypesWithDa\", \"pper() \\n{ \\n  return await _conn.QueryAsync<CatalogType>(\\\"SELECT * FROM CatalogType\\\"); \\n} \\n\\nIf you ne\", \"ed to build more complex object graphs with Dapper, you need to write the associated \\nqueries yourse\", \"lf (as opposed to adding an Include as you would in EF Core). This functionality is \\nsupported throu\", \"gh various syntaxes, including a feature called Multi Mapping that lets you map \\nindividual rows to \", \"multiple mapped objects. For example, given a class Post with a property Owner of \\ntype User, the fo\", \"llowing SQL would return all of the necessary data: \\n\\n76 \\n\\nCHAPTER 7 | Working with Data in ASP.NET \", \"Core Apps \\n\\n \\n \\n \\n\\fselect * from #Posts p \\nleft join #Users u on u.Id = p.OwnerId \\nOrder by p.Id \\n\\nE\", \"ach returned row includes both User and Post data. Since the User data should be attached to the \\nPo\", \"st data via its Owner property, the following function is used: \\n\\n(post, user) => { post.Owner = use\", \"r; return post; } \\n\\nThe full code listing to return a collection of posts with their Owner property \", \"populated with the \\nassociated user data would be: \\n\\nvar sql = @\\\"select * from #Posts p \\nleft join #\", \"Users u on u.Id = p.OwnerId \\nOrder by p.Id\\\"; \\nvar data = connection.Query<Post, User, Post>(sql, \\n(p\", \"ost, user) => { post.Owner = user; return post;}); \\n\\nBecause it offers less encapsulation, Dapper re\", \"quires developers know more about how their data is \\nstored, how to query it efficiently, and write \", \"more code to fetch it. When the model changes, instead \\nof simply creating a new migration (another \", \"EF Core feature), and/or updating mapping information \\nin one place in a DbContext, every query that\", \" is impacted must be updated. These queries have no \\ncompile-time guarantees, so they may break at r\", \"un time in response to changes to the model or \\ndatabase, making errors more difficult to detect qui\", \"ckly. In exchange for these tradeoffs, Dapper \\noffers extremely fast performance. \\n\\nFor most applica\", \"tions, and most parts of almost all applications, EF Core offers acceptable \\nperformance. Thus, its \", \"developer productivity benefits are likely to outweigh its performance \\noverhead. For queries that c\", \"an benefit from caching, the actual query may only be executed a tiny \\npercentage of the time, makin\", \"g relatively small query performance differences moot. \\n\\nSQL or NoSQL \\n\\nTraditionally, relational da\", \"tabases like SQL Server have dominated the marketplace for persistent data \\nstorage, but they are no\", \"t the only solution available. NoSQL databases like MongoDB offer a different \\napproach to storing o\", \"bjects. Rather than mapping objects to tables and rows, another option is to \\nserialize the entire o\", \"bject graph, and store the result. The benefits of this approach, at least initially, \\nare simplicit\", \"y and performance. It\\u2019s simpler to store a single serialized object with a key than to \\ndecompose th\", \"e object into many tables with relationships and update rows that may have changed \\nsince the object\", \" was last retrieved from the database. Likewise, fetching and deserializing a single \\nobject from a \", \"key-based store is typically much faster and easier than complex joins or multiple \\ndatabase queries\", \" required to fully compose the same object from a relational database. The lack of \\nlocks or transac\", \"tions or a fixed schema also makes NoSQL databases amenable to scaling across many \\nmachines, suppor\", \"ting very large datasets. \\n\\nOn the other hand, NoSQL databases (as they are typically called) have t\", \"heir drawbacks. Relational \\ndatabases use normalization to enforce consistency and avoid duplication\", \" of data. This approach \\nreduces the total size of the database and ensures that updates to shared d\", \"ata are available \\nimmediately throughout the database. In a relational database, an Address table m\", \"ight reference a \\n\\n77 \\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps \\n\\n \\n \\n\\fCountry table by I\", \"D, such that if the name of a country/region were changed, the address records \\nwould benefit from t\", \"he update without themselves having to be updated. However, in a NoSQL \\ndatabase, Address, and its a\", \"ssociated Country might be serialized as part of many stored objects. An \\nupdate to a country/region\", \" name would require all such objects to be updated, rather than a single \\nrow. Relational databases \", \"can also ensure relational integrity by enforcing rules like foreign keys. \\nNoSQL databases typicall\", \"y do not offer such constraints on their data. \\n\\nAnother complexity NoSQL databases must deal with i\", \"s versioning. When an object\\u2019s properties \\nchange, it may not be able to be deserialized from past v\", \"ersions that were stored. Thus, all existing \\nobjects that have a serialized (previous) version of t\", \"he object must be updated to conform to its new \\nschema. This approach is not conceptually different\", \" from a relational database, where schema \\nchanges sometimes require update scripts or mapping updat\", \"es. However, the number of entries that \\nmust be modified is often much greater in the NoSQL approac\", \"h, because there is more duplication of \\ndata. \\n\\nIt\\u2019s possible in NoSQL databases to store multiple \", \"versions of objects, something fixed schema \\nrelational databases typically do not support. However,\", \" in this case, your application code will need to \\naccount for the existence of previous versions of\", \" objects, adding additional complexity. \\n\\nNoSQL databases typically do not enforce ACID, which means\", \" they have both performance and \\nscalability benefits over relational databases. They\\u2019re well suited\", \" to extremely large datasets and \\nobjects that are not well suited to storage in normalized table st\", \"ructures. There is no reason why a \\nsingle application cannot take advantage of both relational and \", \"NoSQL databases, using each where it \\nis best suited. \\n\\nAzure Cosmos DB \\n\\nAzure Cosmos DB is a fully\", \" managed NoSQL database service that offers cloud-based schema-free \\ndata storage. Azure Cosmos DB i\", \"s built for fast and predictable performance, high availability, elastic \\nscaling, and global distri\", \"bution. Despite being a NoSQL database, developers can use rich and familiar \\nSQL query capabilities\", \" on JSON data. All resources in Azure Cosmos DB are stored as JSON \\ndocuments. Resources are managed\", \" as items, which are documents containing metadata, and feeds, \\nwhich are collections of items. Figu\", \"re 8-2 shows the relationship between different Azure Cosmos DB \\nresources. \\n\\n78 \\n\\nCHAPTER 7 | Worki\", \"ng with Data in ASP.NET Core Apps \\n\\n \\n \\n\\fFigure 8-2. Azure Cosmos DB resource organization. \\n\\nThe Az\", \"ure Cosmos DB query language is a simple yet powerful interface for querying JSON \\ndocuments. The la\", \"nguage supports a subset of ANSI SQL grammar and adds deep integration of \\nJavaScript object, arrays\", \", object construction, and function invocation. \\n\\nReferences \\u2013 Azure Cosmos DB \\n\\n\\u2022 \\n\\nAzure Cosmos DB\", \" Introduction https://learn.microsoft.com/azure/cosmos-db/introduction \\n\\nOther persistence options \\n\", \"\\nIn addition to relational and NoSQL storage options, ASP.NET Core applications can use Azure \\nStora\", \"ge to store various data formats and files in a cloud-based, scalable fashion. Azure Storage is \\nmas\", \"sively scalable, so you can start out storing small amounts of data and scale up to storing \\nhundred\", \"s or terabytes if your application requires it. Azure Storage supports four kinds of data: \\n\\n\\u2022 \\n\\n\\u2022 \\n\", \"\\n\\u2022 \\n\\n79 \\n\\nBlob Storage for unstructured text or binary storage, also referred to as object storage. \", \"\\n\\nTable Storage for structured datasets, accessible via row keys. \\n\\nQueue Storage for reliable queue\", \"-based messaging. \\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps \\n\\n \\n \\n \\n\\f\\u2022 \\n\\nFile Storage for\", \" shared file access between Azure virtual machines and on-premises \\napplications. \\n\\nReferences \\u2013 Azu\", \"re Storage \\n\\n\\u2022 \\n\\nAzure Storage Introduction https://learn.microsoft.com/azure/storage/common/storage\", \"-\\nintroduction \\n\\nCaching \\n\\nIn web applications, each web request should be completed in the shortest\", \" time possible. One way to \\nachieve this functionality is to limit the number of external calls the \", \"server must make to complete the \\nrequest. Caching involves storing a copy of data on the server (or\", \" another data store that is more \\neasily queried than the source of the data). Web applications, and\", \" especially non-SPA traditional web \\napplications, need to build the entire user interface with ever\", \"y request. This approach frequently \\ninvolves making many of the same database queries repeatedly fr\", \"om one user request to the next. In \\nmost cases, this data changes rarely, so there is little reason\", \" to constantly request it from the \\ndatabase. ASP.NET Core supports response caching, for caching en\", \"tire pages, and data caching, which \\nsupports more granular caching behavior. \\n\\nWhen implementing ca\", \"ching, it\\u2019s important to keep in mind separation of concerns. Avoid \\nimplementing caching logic in y\", \"our data access logic, or in your user interface. Instead, encapsulate \\ncaching in its own classes, \", \"and use configuration to manage its behavior. This approach follows the \\nOpen/Closed and Single Resp\", \"onsibility principles, and will make it easier for you to manage how you \\nuse caching in your applic\", \"ation as it grows. \\n\\nASP.NET Core response caching \\n\\nASP.NET Core supports two levels of response ca\", \"ching. The first level does not cache anything on the \\nserver, but adds HTTP headers that instruct c\", \"lients and proxy servers to cache responses. This \\nfunctionality is implemented by adding the Respon\", \"seCache attribute to individual controllers or \\nactions: \\n\\n[ResponseCache(Duration = 60)] \\npublic IA\", \"ctionResult Contact() \\n{ \\n  ViewData[\\\"Message\\\"] = \\\"Your contact page.\\\"; \\n  return View(); \\n} \\n\\nThe p\", \"revious example will result in the following header being added to the response, instructing \\nclient\", \"s to cache the result for up to 60 seconds. \\n\\nCache-Control: public,max-age=60 \\n\\nIn order to add ser\", \"ver-side in-memory caching to the application, you must reference the \\nMicrosoft.AspNetCore.Response\", \"Caching NuGet package, and then add the Response Caching \\nmiddleware. This middleware is configured \", \"with services and middleware during app startup: \\n\\n80 \\n\\nCHAPTER 7 | Working with Data in ASP.NET Cor\", \"e Apps \\n\\n \\n \\n\\fbuilder.Services.AddResponseCaching(); \\n\\n// other code omitted, including building the\", \" app \\n\\napp.UseResponseCaching(); \\n\\nThe Response Caching Middleware will automatically cache response\", \"s based on a set of conditions, \\nwhich you can customize. By default, only 200 (OK) responses reques\", \"ted via GET or HEAD methods \\nare cached. In addition, requests must have a response with a Cache-Con\", \"trol: public header, and \\ncannot include headers for Authorization or Set-Cookie. See a complete lis\", \"t of the caching conditions \\nused by the response caching middleware. \\n\\nData caching \\n\\nRather than (\", \"or in addition to) caching full web responses, you can cache the results of individual data \\nqueries\", \". For this functionality, you can use in memory caching on the web server, or use a distributed \\ncac\", \"he. This section will demonstrate how to implement in memory caching. \\n\\nAdd support for memory (or d\", \"istributed) caching with the following code: \\n\\nbuilder.Services.AddMemoryCache(); \\nbuilder.Services.\", \"AddMvc(); \\n\\nBe sure to add the Microsoft.Extensions.Caching.Memory NuGet package as well. \\n\\nOnce you\", \"\\u2019ve added the service, you request IMemoryCache via dependency injection wherever you \\nneed to acces\", \"s the cache. In this example, the CachedCatalogService is using the Proxy (or Decorator) \\ndesign pat\", \"tern, by providing an alternative implementation of ICatalogService that controls access to \\n(or add\", \"s behavior to) the underlying CatalogService implementation. \\n\\npublic class CachedCatalogService : I\", \"CatalogService \\n{ \\n  private readonly IMemoryCache _cache; \\n  private readonly CatalogService _catal\", \"ogService; \\n  private static readonly string _brandsKey = \\\"brands\\\"; \\n  private static readonly strin\", \"g _typesKey = \\\"types\\\"; \\n  private static readonly TimeSpan _defaultCacheDuration = TimeSpan.FromSeco\", \"nds(30); \\n\\n  public CachedCatalogService( \\n      IMemoryCache cache, \\n      CatalogService catalogSe\", \"rvice) \\n  { \\n    _cache = cache; \\n    _catalogService = catalogService; \\n  } \\n\\n  public async Task<I\", \"Enumerable<SelectListItem>> GetBrands() \\n  { \\n    return await _cache.GetOrCreateAsync(_brandsKey, a\", \"sync entry => \\n    { \\n      entry.SlidingExpiration = _defaultCacheDuration; \\n      return await _ca\", \"talogService.GetBrands(); \\n    }); \\n  } \\n\\n  public async Task<Catalog> GetCatalogItems(int pageIndex\", \", int itemsPage, int? brandID, \\n\\n81 \\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps \\n\\n \\n \\n \\n \\n \", \"\\n \\n \\n\\fint? typeId) \\n  { \\n    string cacheKey = $\\\"items-{pageIndex}-{itemsPage}-{brandID}-{typeId}\\\"; \", \"\\n    return await _cache.GetOrCreateAsync(cacheKey, async entry => \\n      { \\n        entry.SlidingEx\", \"piration = _defaultCacheDuration; \\n        return await _catalogService.GetCatalogItems(pageIndex, i\", \"temsPage, brandID, \\ntypeId); \\n      }); \\n  } \\n\\n  public async Task<IEnumerable<SelectListItem>> GetT\", \"ypes() \\n  { \\n    return await _cache.GetOrCreateAsync(_typesKey, async entry => \\n    { \\n      entry.\", \"SlidingExpiration = _defaultCacheDuration; \\n      return await _catalogService.GetTypes(); \\n    }); \", \"\\n  } \\n} \\n\\nTo configure the application to use the cached version of the service, but still allow the\", \" service to get \\nthe instance of CatalogService it needs in its constructor, you would add the follo\", \"wing lines in \\nProgram.cs: \\n\\nbuilder.Services.AddMemoryCache(); \\nbuilder.Services.AddScoped<ICatalog\", \"Service, CachedCatalogService>(); \\nbuilder.Services.AddScoped<CatalogService>(); \\n\\nWith this code in\", \" place, the database calls to fetch the catalog data will only be made once per \\nminute, rather than\", \" on every request. Depending on the traffic to the site, this can have a significant \\nimpact on the \", \"number of queries made to the database, and the average page load time for the home \\npage that curre\", \"ntly depends on all three of the queries exposed by this service. \\n\\nAn issue that arises when cachin\", \"g is implemented is stale data \\u2013 that is, data that has changed at the \\nsource but an out-of-date ve\", \"rsion remains in the cache. A simple way to mitigate this issue is to use \\nsmall cache durations, si\", \"nce for a busy application there is a limited additional benefit to extending \\nthe length data is ca\", \"ched. For example, consider a page that makes a single database query, and is \\nrequested 10 times pe\", \"r second. If this page is cached for one minute, it will result in the number of \\ndatabase queries m\", \"ade per minute to drop from 600 to 1, a reduction of 99.8%. If instead the cache \\nduration was made \", \"one hour, the overall reduction would be 99.997%, but now the likelihood and \\npotential age of stale\", \" data are both increased dramatically. \\n\\nAnother approach is to proactively remove cache entries whe\", \"n the data they contain is updated. Any \\nindividual entry can be removed if its key is known: \\n\\n_cac\", \"he.Remove(cacheKey); \\n\\nIf your application exposes functionality for updating entries that it caches\", \", you can remove the \\ncorresponding cache entries in your code that performs the updates. Sometimes \", \"there may be many \\ndifferent entries that depend on a particular set of data. In that case, it can b\", \"e useful to create \\ndependencies between cache entries, by using a CancellationChangeToken. With a \\n\", \"CancellationChangeToken, you can expire multiple cache entries at once by canceling the token. \\n\\n82 \", \"\\n\\nCHAPTER 7 | Working with Data in ASP.NET Core Apps \\n\\n \\n \\n \\n\\f// configure CancellationToken and add\", \" entry to cache \\nvar cts = new CancellationTokenSource(); \\n_cache.Set(\\\"cts\\\", cts); \\n_cache.Set(cache\", \"Key, itemToCache, new CancellationChangeToken(cts.Token)); \\n\\n// elsewhere, expire the cache by cance\", \"lling the token\\\\ \\n_cache.Get<CancellationTokenSource>(\\\"cts\\\").Cancel(); \\n\\nCaching can dramatically im\", \"prove the performance of web pages that repeatedly request the same \\nvalues from the database. Be su\", \"re to measure data access and page performance before applying \\ncaching, and only apply caching wher\", \"e you see a need for improvement. Caching consumes web \\nserver memory resources and increases the co\", \"mplexity of the application, so it\\u2019s important you don\\u2019t \\nprematurely optimize using this technique.\", \" \\n\\nGetting data to Blazor WebAssembly apps \\n\\nIf you\\u2019re building apps that use Blazor Server, you can\", \" use Entity Framework and other direct data \\naccess technologies as they\\u2019ve been discussed thus far \", \"in this chapter. However, when building Blazor \\nWebAssembly apps, like other SPA frameworks, you wil\", \"l need a different strategy for data access. \\nTypically, these applications access data and interact\", \" with the server through web API endpoints. \\n\\nIf the data or operations being performed are sensitiv\", \"e, be sure to review the section on security in \\nthe previous chapter and protect your APIs against \", \"unauthorized access. \\n\\nYou\\u2019ll find an example of a Blazor WebAssembly app in the eShopOnWeb referenc\", \"e application, in the \\nBlazorAdmin project. This project is hosted within the eShopOnWeb Web project\", \", and allows users in \\nthe Administrators group to manage the items in the store. You can see a scre\", \"enshot of the \\napplication in Figure 8-3. \\n\\nFigure 8-3. eShopOnWeb Catalog Admin Screenshot. \\n\\n83 \\n\\n\", \"CHAPTER 7 | Working with Data in ASP.NET Core Apps \\n\\n \\n \\n \\n \\n\\fWhen fetching data from web APIs withi\", \"n a Blazor WebAssembly app, you just use an instance of \\nHttpClient as you would in any .NET applica\", \"tion. The basic steps involved are to create the request to \\nsend (if necessary, usually for POST or\", \" PUT requests), await the request itself, verify the status code, \\nand deserialize the response. If \", \"you\\u2019re going to make many requests to a given set of APIs, it\\u2019s a good \\nidea to encapsulate your API\", \"s and configure the HttpClient base address centrally. This way, if you \\nneed to adjust any of these\", \" settings between environments, you can make the changes in just one \\nplace. You should add support \", \"for this service in your Program.Main: \\n\\nbuilder.Services.AddScoped(sp => new HttpClient \\n  { \\n    B\", \"aseAddress = new Uri(builder.HostEnvironment.BaseAddress) \\n  }); \\n\\nIf you need to access services se\", \"curely, you should access a secure token and configure the HttpClient \\nto pass this token as an Auth\", \"entication header with every request: \\n\\n_httpClient.DefaultRequestHeaders.Authorization = \\n  new Aut\", \"henticationHeaderValue(\\\"Bearer\\\", token); \\n\\nThis activity can be done from any component that has the\", \" HttpClient injected into it, provided that \\nHttpClient wasn\\u2019t added to the application\\u2019s services w\", \"ith a Transient lifetime. Every reference to \\nHttpClient in the application references the same inst\", \"ance, so changes to it in one component flow \\nthrough the entire application. A good place to perfor\", \"m this authentication check (followed by \\nspecifying the token) is in a shared component like the ma\", \"in navigation for the site. Learn more about \\nthis approach in the BlazorAdmin project in the eShopO\", \"nWeb reference application. \\n\\nOne benefit of Blazor WebAssembly over traditional JavaScript SPAs is \", \"that you don\\u2019t need to keep \\ncopies of your data transfer objects(DTOs) synchronized. Your Blazor We\", \"bAssembly project and your \\nweb API project can both share the same DTOs in a common shared project.\", \" This approach eliminates \\nsome of the friction involved in developing SPAs. \\n\\nTo quickly get data f\", \"rom an API endpoint, you can use the built-in helper method, GetFromJsonAsync. \\nThere are similar me\", \"thods for POST, PUT, etc. The following shows how to get a CatalogItem from an \\nAPI endpoint using a\", \" configured HttpClient in a Blazor WebAssembly app: \\n\\nvar item = await _httpClient.GetFromJsonAsync<\", \"CatalogItem>($\\\"catalog-items/{id}\\\"); \\n\\nOnce you have the data you need, you\\u2019ll typically track chang\", \"es locally. When you want to make \\nupdates to the backend data store, you\\u2019ll call additional web API\", \"s for this purpose. \\n\\nReferences \\u2013 Blazor Data \\n\\n\\u2022 \\n\\nCall a web API from ASP.NET Core Blazor https:/\", \"/learn.microsoft.com/aspnet/core/blazor/call-\\nweb-api \\n\\n84 \\n\\nCHAPTER 7 | Working with Data in ASP.NE\", \"T Core Apps \\n\\n \\n \\n\\fCHAPTER  8 \\n\\nTest ASP.NET Core MVC \\napps \\n\\n\\u201cIf you don\\u2019t like unit testing your p\", \"roduct, most likely your customers won\\u2019t like to test it, either.\\u201d _- \\nAnonymous- \\n\\nSoftware of any \", \"complexity can fail in unexpected ways in response to changes. Thus, testing after \\nmaking changes i\", \"s required for all but the most trivial (or least critical) applications. Manual testing is \\nthe slo\", \"west, least reliable, most expensive way to test software. Unfortunately, if applications aren\\u2019t \\nde\", \"signed to be testable, it can be the only means of testing available. Applications written to follow\", \" \\nthe architectural principles laid out in chapter 4 should be largely unit testable. ASP.NET Core \\n\", \"applications support automated integration and functional testing. \\n\\nKinds of automated tests \\n\\nTher\", \"e are many kinds of automated tests for software applications. The simplest, lowest level test is \\nt\", \"he unit test. At a slightly higher level, there are integration tests and functional tests. Other ki\", \"nds of \\ntests, such as UI tests, load tests, stress tests, and smoke tests, are beyond the scope of \", \"this document. \\n\\nUnit tests \\n\\nA unit test tests a single part of your application\\u2019s logic. One can f\", \"urther describe it by listing some of \\nthe things that it isn\\u2019t. A unit test doesn\\u2019t test how your c\", \"ode works with dependencies or \\ninfrastructure \\u2013 that\\u2019s what integration tests are for. A unit test \", \"doesn\\u2019t test the framework your code \\nis written on \\u2013 you should assume it works or, if you find it \", \"doesn\\u2019t, file a bug and code a workaround. \\nA unit test runs completely in memory and in process. It\", \" doesn\\u2019t communicate with the file system, the \\nnetwork, or a database. Unit tests should only test \", \"your code. \\n\\nUnit tests, by virtue of the fact that they test only a single unit of your code, with \", \"no external \\ndependencies, should execute extremely fast. Thus, you should be able to run test suite\", \"s of hundreds \\nof unit tests in a few seconds. Run them frequently, ideally before every push to a s\", \"hared source \\ncontrol repository, and certainly with every automated build on your build server. \\n\\nI\", \"ntegration tests \\n\\nAlthough it\\u2019s a good idea to encapsulate your code that interacts with infrastruc\", \"ture like databases \\nand file systems, you will still have some of that code, and you will probably \", \"want to test it. \\n\\n85 \\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps \\n\\n \\n \\n\\fAdditionally, you should verif\", \"y that your code\\u2019s layers interact as you expect when your application\\u2019s \\ndependencies are fully res\", \"olved. This functionality is the responsibility of integration tests. Integration \\ntests tend to be \", \"slower and more difficult to set up than unit tests, because they often depend on \\nexternal dependen\", \"cies and infrastructure. Thus, you should avoid testing things that could be tested \\nwith unit tests\", \" in integration tests. If you can test a given scenario with a unit test, you should test it \\nwith a\", \" unit test. If you can\\u2019t, then consider using an integration test. \\n\\nIntegration tests will often ha\", \"ve more complex setup and teardown procedures than unit tests. For \\nexample, an integration test tha\", \"t goes against an actual database will need a way to return the \\ndatabase to a known state before ea\", \"ch test run. As new tests are added and the production database \\nschema evolves, these test scripts \", \"will tend to grow in size and complexity. In many large systems, it is \\nimpractical to run full suit\", \"es of integration tests on developer workstations before checking in \\nchanges to shared source contr\", \"ol. In these cases, integration tests may be run on a build server. \\n\\nFunctional tests \\n\\nIntegration\", \" tests are written from the perspective of the developer, to verify that some components of \\nthe sys\", \"tem work correctly together. Functional tests are written from the perspective of the user, and \\nver\", \"ify the correctness of the system based on its requirements. The following excerpt offers a useful \\n\", \"analogy for how to think about functional tests, compared to unit tests: \\n\\n\\u201cMany times the developme\", \"nt of a system is likened to the building of a house. While this analogy \\nisn\\u2019t quite correct, we ca\", \"n extend it for the purposes of understanding the difference between unit \\nand functional tests. Uni\", \"t testing is analogous to a building inspector visiting a house\\u2019s construction \\nsite. He is focused \", \"on the various internal systems of the house, the foundation, framing, electrical, \\nplumbing, and so\", \" on. He ensures (tests) that the parts of the house will work correctly and safely, that \\nis, meet t\", \"he building code. Functional tests in this scenario are analogous to the homeowner visiting \\nthis sa\", \"me construction site. He assumes that the internal systems will behave appropriately, that the \\nbuil\", \"ding inspector is performing his task. The homeowner is focused on what it will be like to live in \\n\", \"this house. He is concerned with how the house looks, are the various rooms a comfortable size, does\", \" \\nthe house fit the family\\u2019s needs, are the windows in a good spot to catch the morning sun. The \\nho\", \"meowner is performing functional tests on the house. He has the user\\u2019s perspective. The building \\nin\", \"spector is performing unit tests on the house. He has the builder\\u2019s perspective.\\u201d \\n\\nSource: Unit Tes\", \"ting versus Functional Tests \\n\\nI\\u2019m fond of saying \\u201cAs developers, we fail in two ways: we build the \", \"thing wrong, or we build the \\nwrong thing.\\u201d Unit tests ensure you are building the thing right; func\", \"tional tests ensure you are \\nbuilding the right thing. \\n\\nSince functional tests operate at the syste\", \"m level, they may require some degree of UI automation. \\nLike integration tests, they usually work w\", \"ith some kind of test infrastructure as well. This activity \\nmakes them slower and more brittle than\", \" unit and integration tests. You should have only as many \\nfunctional tests as you need to be confid\", \"ent the system is behaving as users expect. \\n\\nTesting Pyramid \\n\\nMartin Fowler wrote about the testin\", \"g pyramid, an example of which is shown in Figure 9-1. \\n\\n86 \\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\", \" \\n\\n \\n \\n\\fFigure 9-1. Testing Pyramid \\n\\nThe different layers of the pyramid, and their relative sizes,\", \" represent different kinds of tests and how \\nmany you should write for your application. As you can \", \"see, the recommendation is to have a large \\nbase of unit tests, supported by a smaller layer of inte\", \"gration tests, with an even smaller layer of \\nfunctional tests. Each layer should ideally only have \", \"tests in it that cannot be performed adequately at \\na lower layer. Keep the testing pyramid in mind \", \"when you are trying to decide which kind of test you \\nneed for a particular scenario. \\n\\nWhat to test\", \" \\n\\nA common problem for developers who are inexperienced with writing automated tests is coming up \\n\", \"with what to test. A good starting point is to test conditional logic. Anywhere you have a method wi\", \"th \\nbehavior that changes based on a conditional statement (if-else, switch, and so on), you should \", \"be \\nable to come up with at least a couple of tests that confirm the correct behavior for certain co\", \"nditions. \\nIf your code has error conditions, it\\u2019s good to write at least one test for the \\u201chappy pa\", \"th\\u201d through the \\ncode (with no errors), and at least one test for the \\u201csad path\\u201d (with errors or aty\", \"pical results) to \\nconfirm your application behaves as expected in the face of errors. Finally, try \", \"to focus on testing \\nthings that can fail, rather than focusing on metrics like code coverage. More \", \"code coverage is better \\nthan less, generally. However, writing a few more tests of a complex and bu\", \"siness-critical method is \\nusually a better use of time than writing tests for auto-properties just \", \"to improve test code coverage \\nmetrics. \\n\\n87 \\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps \\n\\n \\n \\n \\n\\fOrgan\", \"izing test projects \\n\\nTest projects can be organized however works best for you. It\\u2019s a good idea to\", \" separate tests by type \\n(unit test, integration test) and by what they are testing (by project, by \", \"namespace). Whether this \\nseparation consists of folders within a single test project, or multiple t\", \"est projects, is a design decision. \\nOne project is simplest, but for large projects with many tests\", \", or in order to more easily run different \\nsets of tests, you might want to have several different \", \"test projects. Many teams organize test projects \\nbased on the project they are testing, which for a\", \"pplications with more than a few projects can result \\nin a large number of test projects, especially\", \" if you still break these down according to what kind of \\ntests are in each project. A compromise ap\", \"proach is to have one project per kind of test, per \\napplication, with folders inside the test proje\", \"cts to indicate the project (and class) being tested. \\n\\nA common approach is to organize the applica\", \"tion projects under a \\u2018src\\u2019 folder, and the application\\u2019s \\ntest projects under a parallel \\u2018tests\\u2019 fo\", \"lder. You can create matching solution folders in Visual Studio, if \\nyou find this organization usef\", \"ul. \\n\\nFigure 9-2. Test organization in your solution \\n\\nYou can use whichever test framework you pref\", \"er. The xUnit framework works well and is what all of \\nthe ASP.NET Core and EF Core tests are writte\", \"n in. You can add an xUnit test project in Visual Studio \\nusing the template shown in Figure 9-3, or\", \" from the CLI using dotnet new xunit. \\n\\n88 \\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps \\n\\n \\n \\n \\n\\fFigure \", \"9-3. Add an xUnit Test Project in Visual Studio \\n\\nTest naming \\n\\nName your tests in a consistent fash\", \"ion, with names that indicate what each test does. One approach \\nI\\u2019ve had great success with is to n\", \"ame test classes according to the class and method they are testing. \\nThis approach results in many \", \"small test classes, but it makes it extremely clear what each test is \\nresponsible for. With the tes\", \"t class name set up, to identify the class and method to be tested, the test \\nmethod name can be use\", \"d to specify the behavior being tested. This name should include the \\nexpected behavior and any inpu\", \"ts or assumptions that should yield this behavior. Some example test \\nnames: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nCatal\", \"ogControllerGetImage.CallsImageServiceWithId \\n\\nCatalogControllerGetImage.LogsWarningGivenImageMissin\", \"gException \\n\\nCatalogControllerGetImage.ReturnsFileResultWithBytesGivenSuccess \\n\\nCatalogControllerGet\", \"Image.ReturnsNotFoundResultGivenImageMissingException \\n\\nA variation of this approach ends each test \", \"class name with \\u201cShould\\u201d and modifies the tense slightly: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n89 \\n\\nCatalogControllerGetImageSh\", \"ould.CallImageServiceWithId \\n\\nCatalogControllerGetImageShould.LogWarningGivenImageMissingException \\n\", \"\\nCHAPTER 8 | Test ASP.NET Core MVC apps \\n\\n \\n \\n \\n\\fSome teams find the second naming approach clearer,\", \" though slightly more verbose. In any case, try \\nto use a naming convention that provides insight in\", \"to test behavior, so that when one or more tests \\nfail, it\\u2019s obvious from their names what cases hav\", \"e failed. Avoid naming your tests vaguely, such as \\nControllerTests.Test1, as these names offer no v\", \"alue when you see them in test results. \\n\\nIf you follow a naming convention like the one above that \", \"produces many small test classes, it\\u2019s a \\ngood idea to further organize your tests using folders and\", \" namespaces. Figure 9-4 shows one \\napproach to organizing tests by folder within several test projec\", \"ts. \\n\\nFigure 9-4. Organizing test classes by folder based on class being tested. \\n\\nIf a particular a\", \"pplication class has many methods being tested (and thus many test classes), it may \\nmake sense to p\", \"lace these classes in a folder corresponding to the application class. This organization \\nis no diff\", \"erent than how you might organize files into folders elsewhere. If you have more than three \\n\\n90 \\n\\nC\", \"HAPTER 8 | Test ASP.NET Core MVC apps \\n\\n \\n \\n \\n\\for four related files in a folder containing many oth\", \"er files, it\\u2019s often helpful to move them into their \\nown subfolder. \\n\\nUnit testing ASP.NET Core app\", \"s \\n\\nIn a well-designed ASP.NET Core application, most of the complexity and business logic will be \\n\", \"encapsulated in business entities and a variety of services. The ASP.NET Core MVC app itself, with i\", \"ts \\ncontrollers, filters, viewmodels, and views, should require few unit tests. Much of the function\", \"ality of a \\ngiven action lies outside the action method itself. Testing whether routing or global er\", \"ror handling \\nwork correctly cannot be done effectively with a unit test. Likewise, any filters, inc\", \"luding model \\nvalidation and authentication and authorization filters, cannot be unit tested with a \", \"test targeting a \\ncontroller\\u2019s action method. Without these sources of behavior, most action methods\", \" should be \\ntrivially small, delegating the bulk of their work to services that can be tested indepe\", \"ndent of the \\ncontroller that uses them. \\n\\nSometimes you\\u2019ll need to refactor your code in order to u\", \"nit test it. Frequently this activity involves \\nidentifying abstractions and using dependency inject\", \"ion to access the abstraction in the code you\\u2019d \\nlike to test, rather than coding directly against i\", \"nfrastructure. For example, consider this easy action \\nmethod for displaying images: \\n\\n[HttpGet(\\\"[co\", \"ntroller]/pic/{id}\\\")] \\npublic IActionResult GetImage(int id) \\n{ \\n  var contentRoot = _env.ContentRoo\", \"tPath + \\\"//Pics\\\"; \\n  var path = Path.Combine(contentRoot, id + \\\".png\\\"); \\n  Byte[] b = System.IO.File\", \".ReadAllBytes(path); \\n  return File(b, \\\"image/png\\\"); \\n} \\n\\nUnit testing this method is made difficult\", \" by its direct dependency on System.IO.File, which it uses to \\nread from the file system. You can te\", \"st this behavior to ensure it works as expected, but doing so with \\nreal files is an integration tes\", \"t. It\\u2019s worth noting you can\\u2019t unit test this method\\u2019s route\\u2014you\\u2019ll see how \\nto do this testing with\", \" a functional test shortly. \\n\\nIf you can\\u2019t unit test the file system behavior directly, and you can\\u2019\", \"t test the route, what is there to \\ntest? Well, after refactoring to make unit testing possible, you\", \" may discover some test cases and \\nmissing behavior, such as error handling. What does the method do\", \" when a file isn\\u2019t found? What \\nshould it do? In this example, the refactored method looks like this\", \": \\n\\n[HttpGet(\\\"[controller]/pic/{id}\\\")] \\npublic IActionResult GetImage(int id) \\n{ \\n  byte[] imageByte\", \"s; \\n  try \\n  { \\n    imageBytes = _imageService.GetImageBytesById(id); \\n  } \\n  catch (CatalogImageMis\", \"singException ex) \\n  { \\n    _logger.LogWarning($\\\"No image found for id: {id}\\\"); \\n    return NotFound\", \"(); \\n  } \\n\\n91 \\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps \\n\\n \\n \\n\\f  return File(imageBytes, \\\"image/png\\\")\", \"; \\n} \\n\\n_logger and _imageService are both injected as dependencies. Now you can test that the same I\", \"D that \\nis passed to the action method is passed to _imageService, and that the resulting bytes are \", \"returned \\nas part of the FileResult. You can also test that error logging is happening as expected, \", \"and that a \\nNotFound result is returned if the image is missing, assuming this behavior is important\", \" application \\nbehavior (that is, not just temporary code the developer added to diagnose an issue). \", \"The actual file \\nlogic has moved into a separate implementation service, and has been augmented to r\", \"eturn an \\napplication-specific exception for the case of a missing file. You can test this implement\", \"ation \\nindependently, using an integration test. \\n\\nIn most cases, you\\u2019ll want to use global exceptio\", \"n handlers in your controllers, so the amount of logic \\nin them should be minimal and probably not w\", \"orth unit testing. Do most of your testing of controller \\nactions using functional tests and the Tes\", \"tServer class described below. \\n\\nIntegration testing ASP.NET Core apps \\n\\nMost of the integration tes\", \"ts in your ASP.NET Core apps should be testing services and other \\nimplementation types defined in y\", \"our Infrastructure project. For example, you could test that EF Core \\nwas successfully updating and \", \"retrieving the data that you expect from your data access classes \\nresiding in the Infrastructure pr\", \"oject. The best way to test that your ASP.NET Core MVC project is \\nbehaving correctly is with functi\", \"onal tests that run against your app running in a test host. \\n\\nFunctional testing ASP.NET Core apps \", \"\\n\\nFor ASP.NET Core applications, the TestServer class makes functional tests fairly easy to write. Y\", \"ou \\nconfigure a TestServer using a WebHostBuilder (or HostBuilder) directly (as you normally do for \", \"your \\napplication), or with the WebApplicationFactory type (available since version 2.1). Try to mat\", \"ch your \\ntest host to your production host as closely as possible, so your tests exercise behavior s\", \"imilar to what \\nthe app will do in production. The WebApplicationFactory class is helpful for config\", \"uring the \\nTestServer\\u2019s ContentRoot, which is used by ASP.NET Core to locate static resource like Vi\", \"ews. \\n\\nYou can create simple functional tests by creating a test class that implements \\nIClassFixtur\", \"e<WebApplicationFactory<TEntryPoint>>, where TEntryPoint is your web application\\u2019s \\nStartup class. W\", \"ith this interface in place, your test fixture can create a client using the factory\\u2019s \\nCreateClient\", \" method: \\n\\npublic class BasicWebTests : IClassFixture<WebApplicationFactory<Program>> \\n{ \\n  protecte\", \"d readonly HttpClient _client; \\n\\n  public BasicWebTests(WebApplicationFactory<Program> factory) \\n  {\", \" \\n    _client = factory.CreateClient(); \\n  } \\n\\n92 \\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps \\n\\n \\n \\n \\n \", \"\\n\\f  // write tests that use _client \\n} \\n\\nTip \\n\\nIf you\\u2019re using minimal API configuration in your Pro\", \"gram.cs file, by default the class will be declared \\ninternal and won\\u2019t be accessible from the test \", \"project. You can choose any other instance class in your \\nweb project instead, or add this to your P\", \"rogram.cs file: \\n\\n]{custom-style=Code}`csharp // Make the implicit Program class public so test proj\", \"ects can access it \\npublic partial class Program { } [` \\n\\nFrequently, you\\u2019ll want to perform some ad\", \"ditional configuration of your site before each test runs, \\nsuch as configuring the application to u\", \"se an in-memory data store and then seeding the application \\nwith test data. To achieve this functio\", \"nality, create your own subclass of \\nWebApplicationFactory<TEntryPoint> and override its ConfigureWe\", \"bHost method. The example \\nbelow is from the eShopOnWeb FunctionalTests project and is used as part \", \"of the tests on the main \\nweb application. \\n\\nusing Microsoft.AspNetCore.Hosting; \\nusing Microsoft.As\", \"pNetCore.Identity; \\nusing Microsoft.AspNetCore.Mvc.Testing; \\nusing Microsoft.EntityFrameworkCore; \\nu\", \"sing Microsoft.eShopWeb.Infrastructure.Data; \\nusing Microsoft.eShopWeb.Infrastructure.Identity; \\nusi\", \"ng Microsoft.eShopWeb.Web; \\nusing Microsoft.Extensions.DependencyInjection; \\nusing Microsoft.Extensi\", \"ons.Logging; \\nusing System; \\n\\nnamespace Microsoft.eShopWeb.FunctionalTests.Web; \\npublic class WebTes\", \"tFixture : WebApplicationFactory<Startup> \\n{ \\n  protected override void ConfigureWebHost(IWebHostBui\", \"lder builder) \\n  { \\n    builder.UseEnvironment(\\\"Testing\\\"); \\n\\n    builder.ConfigureServices(services \", \"=> \\n    { \\n      services.AddEntityFrameworkInMemoryDatabase(); \\n\\n      // Create a new service prov\", \"ider. \\n      var provider = services \\n            .AddEntityFrameworkInMemoryDatabase() \\n           \", \" .BuildServiceProvider(); \\n\\n      // Add a database context (ApplicationDbContext) using an in-memor\", \"y \\n      // database for testing. \\n      services.AddDbContext<CatalogContext>(options => \\n      { \\n\", \"        options.UseInMemoryDatabase(\\\"InMemoryDbForTesting\\\"); \\n        options.UseInternalServiceProv\", \"ider(provider); \\n      }); \\n\\n      services.AddDbContext<AppIdentityDbContext>(options => \\n      { \\n\", \"\\n93 \\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps \\n\\n \\n \\n \\n \\n \\n \\n \\n \\n \\n\\f        options.UseInMemoryDatabas\", \"e(\\\"Identity\\\"); \\n        options.UseInternalServiceProvider(provider); \\n      }); \\n\\n      // Build th\", \"e service provider. \\n      var sp = services.BuildServiceProvider(); \\n\\n      // Create a scope to ob\", \"tain a reference to the database \\n      // context (ApplicationDbContext). \\n      using (var scope =\", \" sp.CreateScope()) \\n      { \\n        var scopedServices = scope.ServiceProvider; \\n        var db = s\", \"copedServices.GetRequiredService<CatalogContext>(); \\n        var loggerFactory = scopedServices.GetR\", \"equiredService<ILoggerFactory>(); \\n\\n        var logger = scopedServices \\n            .GetRequiredSer\", \"vice<ILogger<WebTestFixture>>(); \\n\\n        // Ensure the database is created. \\n        db.Database.E\", \"nsureCreated(); \\n\\n        try \\n        { \\n          // Seed the database with test data. \\n          \", \"CatalogContextSeed.SeedAsync(db, loggerFactory).Wait(); \\n\\n          // seed sample user data \\n      \", \"    var userManager = \\nscopedServices.GetRequiredService<UserManager<ApplicationUser>>(); \\n         \", \" var roleManager = scopedServices.GetRequiredService<RoleManager<IdentityRole>>(); \\n          AppIde\", \"ntityDbContextSeed.SeedAsync(userManager, roleManager).Wait(); \\n        } \\n        catch (Exception \", \"ex) \\n        { \\n          logger.LogError(ex, $\\\"An error occurred seeding the \\\" + \\n                 \", \"   \\\"database with test messages. Error: {ex.Message}\\\"); \\n        } \\n      } \\n    }); \\n  } \\n} \\n\\nTests\", \" can make use of this custom WebApplicationFactory by using it to create a client and then \\nmaking r\", \"equests to the application using this client instance. The application will have data seeded \\nthat c\", \"an be used as part of the test\\u2019s assertions. The following test verifies that the home page of the \\n\", \"eShopOnWeb application loads correctly and includes a product listing that was added to the \\napplica\", \"tion as part of the seed data. \\n\\nusing Microsoft.eShopWeb.FunctionalTests.Web; \\nusing System.Net.Htt\", \"p; \\nusing System.Threading.Tasks; \\nusing Xunit; \\n\\nnamespace Microsoft.eShopWeb.FunctionalTests.WebRa\", \"zorPages; \\n[Collection(\\\"Sequential\\\")] \\npublic class HomePageOnGet : IClassFixture<WebTestFixture> \\n{\", \" \\n  public HomePageOnGet(WebTestFixture factory) \\n  { \\n\\n94 \\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps \", \"\\n\\n \\n \\n \\n \\n \\n \\n \\n \\n \\n\\f    Client = factory.CreateClient(); \\n  } \\n\\n  public HttpClient Client { get; }\", \" \\n\\n  [Fact] \\n  public async Task ReturnsHomePageWithProductListing() \\n  { \\n    // Arrange & Act \\n   \", \" var response = await Client.GetAsync(\\\"/\\\"); \\n    response.EnsureSuccessStatusCode(); \\n    var string\", \"Response = await response.Content.ReadAsStringAsync(); \\n\\n    // Assert \\n    Assert.Contains(\\\".NET Bo\", \"t Black Sweatshirt\\\", stringResponse); \\n  } \\n} \\n\\nThis functional test exercises the full ASP.NET Core\", \" MVC / Razor Pages application stack, including all \\nmiddleware, filters, and binders that may be in\", \" place. It verifies that a given route (\\u201c/\\u201d) returns the \\nexpected success status code and HTML outp\", \"ut. It does so without setting up a real web server, and \\navoids much of the brittleness that using \", \"a real web server for testing can experience (for example, \\nproblems with firewall settings). Functi\", \"onal tests that run against TestServer are usually slower than \\nintegration and unit tests, but are \", \"much faster than tests that would run over the network to a test \\nweb server. Use functional tests t\", \"o ensure your application\\u2019s front-end stack is working as expected. \\nThese tests are especially usef\", \"ul when you find duplication in your controllers or pages and you \\naddress the duplication by adding\", \" filters. Ideally, this refactoring won\\u2019t change the behavior of the \\napplication, and a suite of fu\", \"nctional tests will verify this is the case. \\n\\nReferences \\u2013 Test ASP.NET Core MVC apps \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\", \"\\n\\u2022 \\n\\nTesting in ASP.NET Core \\nhttps://learn.microsoft.com/aspnet/core/testing/ \\n\\nUnit Test Naming Co\", \"nvention \\nhttps://ardalis.com/unit-test-naming-convention \\n\\nTesting EF Core \\nhttps://learn.microsoft\", \".com/ef/core/miscellaneous/testing/ \\n\\nIntegration tests in ASP.NET Core \\nhttps://learn.microsoft.com\", \"/aspnet/core/test/integration-tests \\n\\n95 \\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps \\n\\n \\n \\n \\n \\n \\n\\fCHAPT\", \"ER  9 \\n\\nDevelopment process for \\nAzure \\n\\n\\u201cWith the cloud, individuals and small businesses can snap \", \"their fingers and instantly set up enterprise-\\nclass services.\\u201d \\n- Roy Stephan \\n\\nVision \\n\\nDevelop we\", \"ll-designed ASP .NET Core applications the way you like, using Visual Studio or the dotnet \\nCLI and \", \"Visual Studio Code or your editor of choice. \\n\\nDevelopment environment for ASP.NET Core apps \\n\\nDevel\", \"opment tools choices: IDE or editor \\n\\nWhether you prefer a full and powerful IDE or a lightweight an\", \"d agile editor, Microsoft has you \\ncovered when developing ASP.NET Core applications. \\n\\nVisual Studi\", \"o 2022. Visual Studio 2022 is the best-in-class IDE for developing applications for \\nASP.NET Core. I\", \"t offers a host of features that increase developer productivity. You can use it to \\ndevelop the app\", \"lication, then analyze its performance and other characteristics. The integrated \\ndebugger lets you \", \"pause code execution and step back and forth through code on the fly as it\\u2019s \\nrunning. Its support f\", \"or hot reloads allows you to continue working with your app where you left off, \\neven after making c\", \"ode changes, without having to restart the app. The built-in test runner lets you \\norganize your tes\", \"ts and their results and can even perform live unit testing while you\\u2019re coding. Using \\nLive Share, \", \"you can collaborate in real-time with other developers, sharing your code session \\nseamlessly over t\", \"he network. And when you\\u2019re ready, Visual Studio includes everything you need to \\npublish your appli\", \"cation to Azure or wherever you might host it. \\n\\nDownload Visual Studio 2022 \\n\\nVisual Studio Code an\", \"d dotnet CLI (Cross-Platform Tools for Mac, Linux, and Windows). If you prefer \\na lightweight and cr\", \"oss-platform editor supporting any development language, you can use Microsoft \\nVisual Studio Code a\", \"nd the dotnet CLI. These products provide a simple yet robust experience that \\n\\n96 \\n\\nCHAPTER 9 | Dev\", \"elopment process for Azure \\n\\n \\n \\n\\fstreamlines the developer workflow. Additionally, Visual Studio Co\", \"de supports extensions for C# and \\nweb development, providing intellisense and shortcut-tasks within\", \" the editor. \\n\\nDownload the .NET SDK \\n\\nDownload Visual Studio Code \\n\\nDevelopment workflow for Azure-\", \"hosted ASP.NET \\nCore apps \\n\\nThe application development lifecycle starts from each developer\\u2019s machi\", \"ne, coding the app using \\ntheir preferred language and testing it locally. Developers may choose the\", \"ir preferred source control \\nsystem and can configure Continuous Integration (CI) and/or Continuous \", \"Delivery/Deployment (CD) \\nusing a build server or based on built-in Azure features. \\n\\nTo get started\", \" with developing an ASP.NET Core application using CI/CD, you can use Azure DevOps \\nServices or your\", \" organization\\u2019s own Team Foundation Server (TFS). GitHub Actions provide another \\noption for easily \", \"building and deploying apps to Azure, for apps whose code is hosted on GitHub. \\n\\nInitial setup \\n\\nTo \", \"create a release pipeline for your app, you need to have your application code in source control. \\nS\", \"et up a local repository and connect it to a remote repository in a team project. Follow these \\ninst\", \"ructions: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nShare your code with Git and Visual Studio or \\n\\nShare your code with TFVC and Vi\", \"sual Studio \\n\\nCreate an Azure App Service where you\\u2019ll deploy your application. Create a Web App by \", \"going to the \\nApp Services blade on the Azure portal. Click +Add, select the Web App template, click\", \" Create, and \\nprovide a name and other details. The web app will be accessible from {name}.azurewebs\", \"ites.net. \\n\\n97 \\n\\nCHAPTER 9 | Development process for Azure \\n\\n \\n \\n\\fFigure 10-1. Creating a new Azure \", \"App Service Web App in the Azure Portal. \\n\\nYour CI build process will perform an automated build whe\", \"never new code is committed to the \\nproject\\u2019s source control repository. This process gives you imme\", \"diate feedback that the code builds \\n(and, ideally, passes automated tests) and can potentially be d\", \"eployed. This CI build will produce a \\nweb deploy package artifact and publish it for consumption by\", \" your CD process. \\n\\nDefine your CI build process \\n\\nBe sure to enable continuous integration so the s\", \"ystem will queue a build whenever someone on your \\nteam commits new code. Test the build and verify \", \"that it is producing a web deploy package as one of \\nits artifacts. \\n\\nWhen a build succeeds, your CD\", \" process will deploy the results of your CI build to your Azure web \\napp. To configure this step, yo\", \"u create and configure a Release, which will deploy to your Azure App \\nService. \\n\\nDeploy an Azure we\", \"b app \\n\\nOnce your CI/CD pipeline is configured, you can easily make updates to your web app and comm\", \"it \\nthem to source control to have them deployed. \\n\\nWorkflow for developing Azure-hosted ASP.NET Cor\", \"e applications \\n\\nOnce you have configured your Azure account and your CI/CD process, developing Azur\", \"e-hosted \\nASP.NET Core applications is simple. The following are the basic steps you usually take wh\", \"en building \\nan ASP.NET Core app, hosted in Azure App Service as a Web App, as illustrated in Figure\", \" 10-2. \\n\\n98 \\n\\nCHAPTER 9 | Development process for Azure \\n\\n \\n \\n \\n\\fFigure 10-2. Step-by-step workflow \", \"for building ASP.NET Core apps and hosting them in Azure \\n\\nStep 1. Local dev environment inner loop \", \"\\n\\nDeveloping your ASP.NET Core application for deployment to Azure is no different from developing \\n\", \"your application otherwise. Use the local development environment you\\u2019re comfortable with, whether \\n\", \"that\\u2019s Visual Studio 2019 or the dotnet CLI and Visual Studio Code or your preferred editor. You can\", \" \\nwrite code, run and debug your changes, run automated tests, and make local commits to source \\ncon\", \"trol until you\\u2019re ready to push your changes to your shared source control repository. \\n\\nStep 2. App\", \"lication code repository \\n\\nWhenever you\\u2019re ready to share your code with your team, you should push \", \"your changes from your \\nlocal source repository to your team\\u2019s shared source repository. If you\\u2019ve b\", \"een working in a custom \\nbranch, this step usually involves merging your code into a shared branch (\", \"perhaps by means of a pull \\nrequest). \\n\\nStep 3. Build Server: Continuous integration. build, test, p\", \"ackage \\n\\nA new build is triggered on the build server whenever a new commit is made to the shared \\na\", \"pplication code repository. As part of the CI process, this build should fully compile the applicati\", \"on \\nand run automated tests to confirm everything is working as expected. The end result of the CI \\n\", \"process should be a packaged version of the web app, ready for deployment. \\n\\nStep 4. Build Server: C\", \"ontinuous delivery \\n\\nOnce a build has succeeded, the CD process will pick up the build artifacts pro\", \"duced. This process will \\ninclude a web deploy package. The build server will deploy this package to\", \" Azure App Service, \\n\\n99 \\n\\nCHAPTER 9 | Development process for Azure \\n\\n \\n \\n \\n\\freplacing any existing\", \" service with the newly created one. Typically this step targets a staging \\nenvironment, but some ap\", \"plications deploy directly to production through a CD process. \\n\\nStep 5. Azure App Service Web App \\n\", \"\\nOnce deployed, the ASP.NET Core application runs within the context of an Azure App Service Web \\nAp\", \"p. This Web App can be monitored and further configured using the Azure Portal. \\n\\nStep 6. Production\", \" monitoring and diagnostics \\n\\nWhile the Web App is running, you can monitor the health of the applic\", \"ation and collect diagnostics \\nand user behavior data. Application Insights is included in Visual St\", \"udio, and offers automatic \\ninstrumentation for ASP.NET apps. It can provide you with information on\", \" usage, exceptions, requests, \\nperformance, and logs. \\n\\nReferences \\n\\nBuild and Deploy Your ASP.NET C\", \"ore App to Azure \\nhttps://learn.microsoft.com/azure/devops/build-release/apps/aspnet/build-aspnet-co\", \"re \\n\\n100 \\n\\nCHAPTER 9 | Development process for Azure \\n\\n \\n \\n\\fCHAPTER  10 \\n\\nAzure hosting \\nrecommendat\", \"ions for \\nASP.NET Core web apps \\n\\n\\u201cLine-of-business leaders everywhere are bypassing IT departments \", \"to get applications from the cloud \\n(also known as SaaS) and paying for them like they would a magaz\", \"ine subscription. And when the \\nservice is no longer required, they can cancel the subscription with\", \" no equipment left unused in the \\ncorner.\\u201d \\n- Daryl Plummer, Gartner analyst \\n\\nWhatever your applica\", \"tion\\u2019s needs and architecture, Microsoft Azure can support it. Your hosting \\nneeds can be as simple \", \"as a static website or a sophisticated application made up of dozens of \\nservices. For ASP.NET Core \", \"monolithic web applications and supporting services, there are several \\nwell-known configurations th\", \"at are recommended. The recommendations on this article are grouped \\nbased on the kind of resource t\", \"o be hosted, whether full applications, individual processes, or data. \\n\\nWeb applications \\n\\nWeb appl\", \"ications can be hosted with: \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nApp Service Web Apps \\n\\nContainers (several options) \\n\\nVir\", \"tual Machines (VMs) \\n\\nOf these, App Service Web Apps is the recommended approach for most scenarios,\", \" including simple \\ncontainer-based apps. For microservice architectures, consider a container-based \", \"approach. If you \\nneed more control over the machines running your application, consider Azure Virtu\", \"al Machines. \\n\\nApp Service Web Apps \\n\\nApp Service Web Apps offers a fully managed platform optimized\", \" for hosting web applications. It\\u2019s a \\nplatform as a service (PaaS) offering that lets you focus on \", \"your business logic, while Azure takes care \\nof the infrastructure needed to run and scale the app. \", \"Some key features of App Service Web Apps: \\n\\n101 \\n\\nCHAPTER 10 | Azure hosting recommendations for AS\", \"P.NET Core web apps \\n\\n \\n \\n\\f\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nDevOps optimization (continuous integration and deliv\", \"ery, multiple environments, A/B \\ntesting, scripting support). \\n\\nGlobal scale and high availability. \", \"\\n\\nConnections to SaaS platforms and your on-premises data. \\n\\nSecurity and compliance. \\n\\nVisual Studi\", \"o integration. \\n\\nAzure App Service is the best choice for most web apps. Deployment and management a\", \"re integrated \\ninto the platform, sites can scale quickly to handle high traffic loads, and the buil\", \"t-in load balancing \\nand traffic manager provide high availability. You can move existing sites to A\", \"zure App Service easily \\nwith an online migration tool. You can use an open-source app from the Web \", \"Application Gallery, or \\ncreate a new site using the framework and tools of your choice. The WebJobs\", \" feature makes it easy to \\nadd background job processing to your App Service web app. If you have an\", \" existing ASP.NET \\napplication hosted on-premises using a local database, there\\u2019s a clear path to mi\", \"grate. You can use \\nApp Service Web App with an Azure SQL Database (or secure access to your on-prem\", \"ises database \\nserver, if preferred). \\n\\nIn most cases, moving from a locally hosted ASP.NET app to a\", \"n App Service Web App is a \\nstraightforward process. Little or no modification should be required of\", \" the app itself, and it can \\nquickly start to take advantage of the many features that Azure App Ser\", \"vice Web Apps offer. \\n\\n102 \\n\\nCHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps \\n\\n\", \" \\n \\n \\n\\fIn addition to apps that are not optimized for the cloud, Azure App Service Web Apps are an e\", \"xcellent \\nsolution for many simple monolithic (non-distributed) applications, such as many ASP.NET C\", \"ore apps. \\nIn this approach, the architecture is basic and simple to understand and manage: \\n\\nA smal\", \"l number of resources in a single resource group is typically sufficient to manage such an app. \\nApp\", \"s that are typically deployed as a single unit, rather than those apps that are made up of many \\nsep\", \"arate processes, are good candidates for this basic architectural approach. Though architecturally \\n\", \"simple, this approach still allows the hosted app to scale both up (more resources per node) and out\", \" \\n(more hosted nodes) to meet any increase in demand. With autoscale, the app can be configured to \\n\", \"automatically adjust the number of nodes hosting the app based on demand and average load across \\nno\", \"des. \\n\\nApp Service Web Apps for Containers \\n\\nIn addition to support for hosting web apps directly, A\", \"pp Service Web Apps for Containers can be \\nused to run containerized applications on Windows and Lin\", \"ux. Using this service, you can easily \\ndeploy and run containerized applications that can scale wit\", \"h your business. The apps have all of the \\nfeatures of App Service Web Apps listed above. In additio\", \"n, Web Apps for Containers supports \\nstreamlined CI/CD with Docker Hub, Azure Container Registry, an\", \"d GitHub. You can use Azure DevOps \\nto define build and deployment pipelines that publish changes to\", \" a registry. These changes can then \\nbe tested in a staging environment and automatically deployed t\", \"o production using deployment slots, \\nallowing zero-downtime upgrades. Rolling back to previous vers\", \"ions can be done just as easily. \\n\\nThere are a few scenarios where Web Apps for Containers makes the\", \" most sense. If you have existing \\napps that you can containerize, whether in Windows or Linux conta\", \"iners, you can host these easily \\nusing this toolset. Just publish your container and then configure\", \" Web Apps for Containers to pull the \\nlatest version of that image from your registry of choice. Thi\", \"s is a \\u201clift and shift\\u201d approach to migrating \\nfrom classic app hosting models to a cloud-optimized \", \"model. \\n\\n103 \\n\\nCHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps \\n\\n \\n \\n \\n\\fThis ap\", \"proach also works well if your development team is able to move to a container-based \\ndevelopment pr\", \"ocess. The \\u201cinner loop\\u201d of developing apps with containers includes building the app \\nwith container\", \"s. Changes made to the code as well as to container configuration are pushed to source \\ncontrol, and\", \" an automated build is responsible for publishing new container images to a registry like \\nDocker Hu\", \"b or Azure Container Registry. These images are then used as the basis for additional \\ndevelopment, \", \"as well as for deployments to production, as shown in the following diagram: \\n\\n104 \\n\\nCHAPTER 10 | Az\", \"ure hosting recommendations for ASP.NET Core web apps \\n\\n \\n \\n \\n\\fDeveloping with containers offers man\", \"y advantages, especially when containers are used in \\nproduction. The same container configuration i\", \"s used to host the app in each environment in which it \\nruns, from the local development machine to \", \"build and test systems to production. This approach \\ngreatly reduces the likelihood of defects resul\", \"ting from differences in machine configuration or \\nsoftware versions. Developers can also use whatev\", \"er tools they\\u2019re most productive with, including the \\noperating system, since containers can run on \", \"any OS. In some cases, distributed applications \\ninvolving many containers may be very resource-inte\", \"nsive to run on a single development machine. In \\nthis scenario, it may make sense to upgrade to usi\", \"ng Kubernetes and Azure Dev Spaces, covered in \\nthe next section. \\n\\nAs portions of larger applicatio\", \"ns are broken up into their own smaller, independent microservices, \\nadditional design patterns can \", \"be used to improve app behavior. Instead of working directly with \\nindividual services, an API gatew\", \"ay can simplify access and decouple the client from its back end. \\nHaving separate service back ends\", \" for different front ends also allows services to evolve in concert \\nwith their consumers. Common se\", \"rvices can be accessed via a separate sidecar container, which might \\ninclude common client connecti\", \"vity libraries using the ambassador pattern. \\n\\n105 \\n\\nCHAPTER 10 | Azure hosting recommendations for \", \"ASP.NET Core web apps \\n\\n \\n \\n \\n\\fLearn more about design patterns to consider when building microservi\", \"ce-based systems. \\n\\nAzure Kubernetes Service \\n\\nAzure Kubernetes Service (AKS) manages your hosted Ku\", \"bernetes environment, making it quick and \\neasy to deploy and manage containerized applications with\", \"out container orchestration expertise. It \\nalso eliminates the burden of ongoing operations and main\", \"tenance by provisioning, upgrading, and \\nscaling resources on-demand, without taking your applicatio\", \"ns offline. \\n\\nAKS reduces the complexity and operational overhead of managing a Kubernetes cluster b\", \"y \\noffloading much of that responsibility to Azure. As a hosted Kubernetes service, Azure handles cr\", \"itical \\ntasks like health monitoring and maintenance for you. Also, you pay only for the agent nodes\", \" within \\nyour clusters, not for the masters. As a managed Kubernetes service, AKS provides: \\n\\n\\u2022 \\n\\n\\u2022 \", \"\\n\\n\\u2022 \\n\\n\\u2022 \\n\\nAutomated Kubernetes version upgrades and patching. \\n\\nEasy cluster scaling. \\n\\nSelf-healing\", \" hosted control plane (masters). \\n\\nCost savings - pay only for running agent pool nodes. \\n\\nWith Azur\", \"e handling the management of the nodes in your AKS cluster, you no longer need to \\nperform many task\", \"s manually, like cluster upgrades. Because Azure handles these critical maintenance \\ntasks for you, \", \"AKS doesn\\u2019t provide direct access (such as with SSH) to the cluster. \\n\\nTeams who are leveraging AKS \", \"can also take advantage of Azure Dev Spaces. Azure Dev Spaces helps \\nteams to focus on the developme\", \"nt and rapid iteration of their microservice application by allowing \\nteams to work directly with th\", \"eir entire microservices architecture or application running in AKS. Azure \\nDev Spaces also provides\", \" a way to independently update portions of your microservices architecture \\nin isolation without aff\", \"ecting the rest of the AKS cluster or other developers. \\n\\n106 \\n\\nCHAPTER 10 | Azure hosting recommend\", \"ations for ASP.NET Core web apps \\n\\n \\n \\n \\n\\fAzure Dev Spaces: \\n\\n\\u2022  Minimize local machine setup time a\", \"nd resource requirements \\n\\n\\u2022 \\n\\n\\u2022 \\n\\n\\u2022 \\n\\nAllow teams to iterate more rapidly \\n\\nReduce the number of in\", \"tegration environments required by a team \\n\\nRemove the need to mock certain services in a distribute\", \"d system when developing/testing \\n\\nLearn more about Azure Dev Spaces \\n\\nAzure Virtual Machines \\n\\nIf y\", \"ou have an existing application that would require substantial modifications to run in App Service, \", \"\\nyou could choose Virtual Machines in order to simplify migrating to the cloud. However, correctly \\n\", \"configuring, securing, and maintaining VMs requires much more time and IT expertise compared to \\nAzu\", \"re App Service. If you\\u2019re considering Azure Virtual Machines, make sure you take into account the \\no\", \"ngoing maintenance effort required to patch, update, and manage your VM environment. Azure \\nVirtual \", \"Machines is infrastructure as a service (IaaS), while App Service is PaaS. You should also \\nconsider\", \" whether deploying your app as a Windows Container to Web App for Containers might be a \\nviable opti\", \"on for your scenario. \\n\\nLogical processes \\n\\nIndividual logical processes that can be decoupled from \", \"the rest of the application may be deployed \\nindependently to Azure Functions in a \\u201cserverless\\u201d mann\", \"er. Azure Functions lets you just write the \\ncode you need for a given problem, without worrying abo\", \"ut the application or infrastructure to run it. \\nYou can choose from a variety of programming langua\", \"ges, including C#, F#, Node.js, Python, and \\nPHP, allowing you to pick the most productive language \", \"for the task at hand. Like most cloud-based \\nsolutions, you pay only for the amount of time your use\", \", and you can trust Azure Functions to scale up \\nas needed. \\n\\nData \\n\\nAzure offers a wide variety of \", \"data storage options, so that your application can use the appropriate \\ndata provider for the data i\", \"n question. \\n\\n107 \\n\\nCHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps \\n\\n \\n \\n \\n\\fFo\", \"r transactional, relational data, Azure SQL Databases are the best option. For high performance \\nrea\", \"d-mostly data, a Redis cache backed by an Azure SQL Database is a good solution. \\n\\nUnstructured JSON\", \" data can be stored in a variety of ways, from SQL Database columns to Blobs or \\nTables in Azure Sto\", \"rage, to Azure Cosmos DB. Of these, Azure Cosmos DB offers the best querying \\nfunctionality, and is \", \"the recommended option for large numbers of JSON-based documents that must \\nsupport querying. \\n\\nTran\", \"sient command- or event-based data used to orchestrate application behavior can use Azure \\nService B\", \"us or Azure Storage Queues. Azure Service Bus offers more flexibility and is the \\nrecommended servic\", \"e for non-trivial messaging within and between applications. \\n\\nArchitecture recommendations \\n\\nYour a\", \"pplication\\u2019s requirements should dictate its architecture. There are many different Azure \\nservices \", \"available. Choosing the right one is an important decision. Microsoft offers a gallery of \\nreference\", \" architectures to help identify typical architectures optimized for common scenarios. You \\nmay find \", \"a reference architecture that maps closely to your application\\u2019s requirements, or at least \\noffers a\", \" starting point. \\n\\nFigure 11-1 shows an example reference architecture. This diagram describes a rec\", \"ommended \\narchitecture approach for a Sitecore content management system website optimized for marke\", \"ting. \\n\\nFigure 11-1. Sitecore marketing website reference architecture. \\n\\nReferences \\u2013 Azure hosting\", \" recommendations \\n\\n\\u2022 \\n\\nAzure Solution Architectures \\nhttps://azure.microsoft.com/solutions/architect\", \"ure/ \\n\\n108 \\n\\nCHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps \\n\\n \\n \\n \\n\\f\\u2022 \\n\\n\\u2022 \\n\\n\\u2022\", \" \\n\\nAzure Basic Web Application Architecture \\nhttps://learn.microsoft.com/azure/architecture/referenc\", \"e-architectures/app-service-web-\\napp/basic-web-app \\n\\nDesign Patterns for Microservices \\nhttps://lear\", \"n.microsoft.com/azure/architecture/microservices/design/patterns \\n\\nAzure Developer Guide \\nhttps://az\", \"ure.microsoft.com/campaigns/developer-guide/ \\n\\n\\u2022  Web Apps overview \\n\\nhttps://learn.microsoft.com/az\", \"ure/app-service/app-service-web-overview \\n\\n\\u2022  Web App for Containers \\n\\nhttps://azure.microsoft.com/s\", \"ervices/app-service/containers/ \\n\\n\\u2022 \\n\\nIntroduction to Azure Kubernetes Service (AKS) \\nhttps://learn.\", \"microsoft.com/azure/aks/intro-kubernetes \\n\\n109 \\n\\nCHAPTER 10 | Azure hosting recommendations for ASP.\", \"NET Core web apps \\n\\n \\n \\n\\f\"]"