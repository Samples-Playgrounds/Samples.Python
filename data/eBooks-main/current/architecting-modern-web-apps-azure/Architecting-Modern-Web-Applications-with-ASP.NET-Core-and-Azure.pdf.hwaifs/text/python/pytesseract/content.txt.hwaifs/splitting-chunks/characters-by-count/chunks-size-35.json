"[\"~& Microsoft\\n\\nArchitecting Modern\\nWeb Applications with\\nASP.NET Core and\\n\\nMicrosoft Azure\\n\\nra\\n\\nSteve\", \" \\u201cardalis\\u201d Smith\\nEDITION v8.0 - Updated to ASP.NET Core 8.0\\n\\nRefer changelog for the book updates an\", \"d community contributions.\\nPUBLISHED BY\\n\\nMicrosoft Developer Division, .NET, and Visual Studio produ\", \"ct teams\\nA division of Microsoft Corporation\\n\\nOne Microsoft Way\\n\\nRedmond, Washington 98052-6399\\n\\nCop\", \"yright \\u00a9 2023 by Microsoft Corporation\\n\\nAll rights reserved. No part of the contents of this book ma\", \"y be reproduced or transmitted in any\\nform or by any means without the written permission of the pub\", \"lisher.\\n\\nThis book is provided \\u201cas-is\\u201d and expresses the author's views and opinions. The views, opi\", \"nions, and\\ninformation expressed in this book, including URL and other Internet website references, \", \"may change\\nwithout notice.\\n\\nSome examples depicted herein are provided for illustration only and are\", \" fictitious. No real association\\nor connection is intended or should be inferred.\\n\\nMicrosoft and the\", \" trademarks listed at https://www.microsoft.com on the \\u201cTrademarks\\u201d webpage are\\ntrademarks of the Mi\", \"crosoft group of companies.\\n\\nMac and macOS are trademarks of Apple Inc.\\n\\nThe Docker whale logo is a \", \"registered trademark of Docker, Inc. Used by permission.\\nAll other marks and logos are property of t\", \"heir respective owners.\\n\\nAuthor:\\n\\nSteve \\u201cardalis\\u201d Smith - Software Architect and Trainer - Ardalis.c\", \"om\\n\\nEditors:\\n\\nMaira Wenzel\\n\\nAction links\\n\\n. This e-book is also available in a PDF format (English v\", \"ersion only) Download\\n\\n. Clone/Fork the reference application eShopOnWeb on GitHub\\n\\nIntroduction\\n\\n.N\", \"ET 8 and ASP.NET Core offer several advantages over traditional .NET development. You should use\\n.NE\", \"T 8 for your server applications if some or all of the following are important to your application's\", \"\\nSUCCESS:\\n\\n\\u00b0 Cross-platform support.\\n. Use of microservices.\\n\\n. Use of Docker containers.\\n\\n. High pe\", \"rformance and scalability requirements.\\n\\n. Side-by-side versioning of .NET versions by application o\", \"n the same server.\\n\\nTraditional .NET 4.x apps can and do support many of these requirements, but ASP\", \".NET Core and .NET\\n8 have been optimized to offer improved support for the above scenarios.\\n\\nMore an\", \"d more organizations are choosing to host their web applications in the cloud using services\\nlike Mi\", \"crosoft Azure. You should consider hosting your application in the cloud if the following are\\nimport\", \"ant to your application or organization:\\n\\n. Reduced investment in data center costs (hardware, softw\", \"are, space, utilities, server\\nmanagement, etc.)\\n\\n. Flexible pricing (pay based on usage, not for idl\", \"e capacity).\\n\\n: Extreme reliability.\\n\\n. Improved app mobility; easily change where and how your app \", \"Is deployed.\\n. Flexible capacity; scale up or down based on actual needs.\\n\\nBuilding web applications\", \" with ASP.NET Core, hosted in Azure, offers many competitive advantages\\nover traditional alternative\", \"s. ASP.NET Core is optimized for modern web application development\\npractices and cloud hosting scen\", \"arios. In this guide, you'll learn how to architect your ASP.NET Core\\napplications to best take adva\", \"ntage of these capabilities.\\n\\nVersion\\n\\nThis guide has been revised to cover .NET 8.0 version along w\", \"ith many additional updates related to\\nthe same \\u201cwave\\u201d of technologies (that is, Azure and additiona\", \"l third-party technologies) coinciding in\\ntime with the .NET 8.0 release. That's why the book versio\", \"n has also been updated to version 8.0.\\n\\nPurpose\\n\\nThis guide provides end-to-end guidance on buildin\", \"g monolithic web applications using ASP.NET\\nCore and Azure. In this context, \\u201cmonolithic\\u201d refers to \", \"the fact that these applications are deployed as\\na single unit, not as a collection of interacting s\", \"ervices and applications. In some contexts, the term\\nmonolith may be used as a pejorative, but in th\", \"e vast majority of situations a single application is\\nmuch easier to build, deploy, and debug than a\", \"n app composed of many different services, while still\\nachieving the business requirements.\\n\\nThis gu\", \"ide is complementary to \\u201c.NET Microservices. Architecture for Containerized .NET Applications\\\",\\nwhic\", \"h focuses more on Docker, microservices, and deployment of containers to host enterprise\\napplication\", \"s.\\n.NET Microservices. Architecture for Containerized .NET Applications\\n\\n\\u00b0 e-book\\nhttps://aka.ms/Mic\", \"roservicesEbook\\n\\n. Sample Application\\nhttps://aka.ms/microservicesarchitecture\\n\\nWho should use this \", \"guide\\n\\nThe audience for this guide is mainly developers, development leads, and architects who are\\ni\", \"nterested in building modern web applications using Microsoft technologies and services in the\\ncloud\", \".\\n\\nA secondary audience is technical decision makers who are already familiar ASP.NET or Azure and a\", \"re\\nlooking for information on whether it makes sense to upgrade to ASP.NET Core for new or existing\\n\", \"projects.\\n\\nHow you can use this guide\\n\\nThis guide has been condensed into a relatively small documen\", \"t that focuses on building web\\napplications with modern .NET technologies and Azure. As such, it can\", \" be read in its entirety to\\nprovide a foundation of understanding such applications and their techni\", \"cal considerations. The\\nguide, along with its sample application, can also serve as a Starting point\", \" or reference. Use the\\nassociated sample application as a template for your own applications, or to \", \"see how you might\\norganize your application\\u2019s component parts. Refer back to the guide\\u2019s principles \", \"and coverage of\\narchitecture and technology options and decision considerations when you're weighing\", \" these choices\\nfor your own application.\\n\\nFeel free to forward this guide to your team to help ensur\", \"e a common understanding of these\\nconsiderations and opportunities. Having everybody working from a \", \"common set of terminology and\\nunderlying principles helps ensure consistent application of architect\", \"ural patterns and practices.\\n\\nReferences\\n\\n. Choosing between .NET and .NET Framework for server apps\", \"\\n\\nhttps://learn.microsoft.com/dotnet/standard/choosing-core-framework-server\\nContents\\n\\nCharacteristi\", \"cs of Modern Web Applications. ...................sssssssssssssssssssscccccsssssssssssssssssssssssee\", \"es 1\\nReference application: CSHOPONWED.......cceccessesesessessesscsesssssessssssessssessessecussess\", \"ecussussessecussessecucsussessececsesseeueseseeseensseess 1\\nReference Application .u..cccccessesssss\", \"ssssssssesesssssecscsesssssesessessecussessssscsussessecussesssesssussessecussessecucsussessesussess\", \"ecusseeseenesesseeseensaens 2\\nCloud-hosted and scalable oo. cececessesssssesesseseesessessesessessec\", \"sesessessesesseenesscsecsesscsessessesucsessecucsessesueseeaeeaeeeeaeeaeeeeeeeaeeeeeenees 2\\nCrOSS Pl\", \"atfOrM.....ceccecccsessessesssssssesscsesssssesussessecsssesssssecessessesussussessecussessecussusse\", \"ssesucsessecussussesucsussessecussessecucsueseeseaesseeseeessesseeneaessess 2\\nModular and loosely CO\", \"UPLE .......eescesesssssssssssssssssescsesscsesscsessesecsesessesesussessssessssessesesuescscsesssae\", \"ssesecsesessesessesesseseeseaeeseaseseess 3\\nEasily tested with automated tests uc cecsssssssssssssss\", \"ssssssssesssssssssssessssessssessssessssessssessesessssessssesscsessssesseseeseseeseseeneseeseens 3\\n\", \"Traditional and SPA behaviors SUPPOSted ou... ecessesessessssesessesessesessesessesessesessesessesss\", \"esssesessesessesessesessesessesesseseeseaseneess 3\\nSimple developMent and GeplOyMent 0... cecessssss\", \"sesessessssessssessssessssesessesessesessesessessssesessesssesesseseesesesseeesseseesesesseeesseeess\", \" 4\\nTraditional ASP.NET and Web Forms .....eeeesssssssssssssessesessesscsessesscsscsessesucsssecsesue\", \"sessesucsecsesuesucsessecuesesseeucsessecneeeaeeneeneasens 4\\nBlAZOP oo seeseesessessessesessessesscs\", \"essecsesscsecsesscsscsccucsucsecsesucsscsesuesscsscsecucsscsesuesucsecsesuesucsesuesscsesuesuesusses\", \"sesucsessesuesecseanesucsessecuesesaeeneaneaeeneeneasens 4\\nReferences \\u2014 Modern Web Applications ....\", \".c.cccccesssssesssssssessessssessesssesssssssesssesecessessesussessessesessessecessesseenssesseeseen\", \"eseas 4\\nChoose Between Traditional Web Apps and Single Page Apps (SPAs) ...................sssssssee\", \" 6\\nBlAZOP oo seeseesessessessesessessesscsessecsesscsecsesscsscsccucsucsecsesucsscsesuesscsscsecucss\", \"csesuesucsecsesuesucsesuesscsesuesuesussessesucsessesuesecseanesucsessecuesesaeeneaneaeeneeneasens 7\", \"\\nWhen) to choose traditional WED apps ........ccesesessessssesesssssssesesscssssesessesessesessesuss\", \"esessesessesssesussesessesessesessesesseseesesesseaeeneess 7\\nWhen to ChOOSE SPAS... esessesssssesess\", \"essessesessessesscsessecsesucsessesucsecsesscsscsessessesscsecucsucsecsesucsecsecucsucsesuesucsessec\", \"uesesseeneasaeenecueaeeneeneasens 8\\nReferences \\u2014 SPA Framewolks .......ccesssssssessssssssssssssssse\", \"ssesssssssscsscsssssssucssssussucsucsucsussucsucsussussucsesseeseeaeeseeaeeaeeaeeaseaeeseeaeenee 8\\nW\", \"hen to CHOOSE BlaZOF ou... eeseesessssessssseseseesessesscsessecscsscsessesucsscsesucsucsessessesscs\", \"ecucsucsecsesucsecsecucsucsesuesucsessesuesessecneauesecneeueaeeneenensens 9\\nD@CISION table... eeces\", \"essesessessessesesessecnesscsessecucssssessesscsecsesuesscsessesucsecsecuesucsesuesscsecsesuesucsesu\", \"esucsecnesuesscsessecuesessecucsesaeeneaneaeeneeneasens 9\\nOther CONSIA|rAatTIONS oe eeseeessesessess\", \"essessesesessessesecsccucscsecnesscsecsecuesecsessesscsesnesueaecsecuesscsecsecucsessecucsessecsesue\", \"aeeseeucaeeaeeneeeeseeneeeaee 9\\nArchitectural principles. ..............cccccccccccccccscccccsscccss\", \"ssssssssssssssssssssssssssssssssssssssssssssssssssscssescesecs 11\\nCOMMON CESIGN PFINCIPI!NS ......ee\", \"eeesessesesesessesessesessesessesessessssesussesussesussessssesussesussesussesussesussesussessesesus\", \"sesessesessesesseeesseeesseeess 11\\nSEParation Of CONCEINS ...c.eccecsssessessessesessessecscsessssse\", \"secsessecscsessessesussessecscsussessesussessecucsussessesussessecuesucseeseaussesseenssesseeseensas\", \"ess 11\\nENCapSuUlatiOn.....c.ccccesscssssessssessssessssessssessssessssessssesessesessssessesessesess\", \"ssessssessesessssessssessssessssessssesessecessessesecesseseeseceesecesseeesaeenees 11\\nDEPENCeNCY IN\", \"VELSION .......c.cccessesessesessesessesessessssesessesessesessesessesessssssssussesessesessssessese\", \"ssesesussecsesecessecsesecessesueseceeseeesseensseenees 12\\nExplicit CEDENCEN CIES uu... eeecessesess\", \"esessesessesessesessesessesessesssesessssessssssssssesussesssssessesussssessssucsssecessesuesesesses\", \"ueseceeseeesseensseenees 14\\nSINGlE FESPONSIDITtY oe seeesscsessesessessesesessesessesessesssesussesu\", \"ssessssesussessssesussessssesussesussessssesussesesseaussecessecusseeesseessseeneseesees 14\\nDon't re\", \"peat yourself (DRY) wc ccccessessessesessessscscsessessesssessesussessessecussessesussussessscussess\", \"ssussussessecussesseesesesseeseeneseeseeneeesaess 15\\n\\ni Contents\\nPErsiStENCe IGMOLANCE ....eesecsess\", \"essssesessesessesessesessesessesessesssesssesessessssssessesessesessssessesessesessssessesecesseenss\", \"esessesuesecuesecesseeneseenees 15\\n\\nBOUNCE CONTEXTS ...... ee eseesessessesseseseesesscsscsessecscss\", \"csecsesscsessecucsecsesnesucsecsecuesecsessesucsessecuesucsesnecuesessecucsessecnesseaeeaeeueneeaeen\", \"eeneaees 16\\nACditional reSOULCES .......eesessessesseseseeseesesscsesessecucsessecuessesessesucsscse\", \"ssesuesecsesucscsesuecucsecsecucsussecuesucaessesuesecsesseeusaeeaeeeseeaeeneenenees 16\\nCommon web a\", \"pplication architectures ..............ccccccccsccccccscccssscccssssssssssssssssssssssssssssssssssee\", \"es 17\\nWhat IS & MONOLITHIC APPLICATION? oo... ecessesessecessesessecccsecscsessesessesecussecussecss\", \"secsssecussesussecsssecessesessecussecessecesseeneseeneseenees 17\\nAIl-IN-ONE APPII CATIONS oo. esese\", \"ssesssseseesescsececsecsesecsesecsesecucsecsssesuesessesesussecsssecussecsssecussesussessssecusseses\", \"secussecessecesseceeseeesseenees 17\\nWhat are layers? ....ccessesessssssssssssesesssssssesessesssesus\", \"sesussesussssussesussesussesussesussesussesussesussessssecussesussecussecessesessecuesesessecusseeee\", \"seeesseenees 18\\nTraditional \\u201cN-Layer\\u201d architecture applications ......eccessssessessssessssscesssses\", \"sssessecssssessecessecessesssecessecssesesseeesseensseenees 19\\nClean Architecture... eeeccesecsesses\", \"sssseseesessesesessecsesssecsssucsessesnesscsessesucsucaessesucsessecucsucsesnssucscsesuesucaesnecus\", \"aessesueseeaeeseeueaeeneeneeneass 23\\nOrganiZing COde IN Clean Architecture on... ceceecessssesssssss\", \"esessesssssssssesessessssssessesessesessesesseseesesesseseesesesseseeseseeneseeseess 28\\nMonolithic a\", \"pplications ANd CONTAINELS.........ccessesessessssesessesessessssessssesessesessesessessssesessesess\", \"esessesessesessesessesessesesseseeseseeseens 30\\nMonolithic application deployed aS a CONTAINED uc. .\", \"eeesecsesssssssesessesssesessesessesesscsesecsecessecseseseesesesseceeseeesseeneseenees 31\\nDOCKEr SU\", \"PPOSE... eecesessesessesessesessesssesussesussesucsessssesussessssesussesussesussesussesussesussesss\", \"sesussessssesessesussesussesucsesessesessesessesesseseeseaeeneens 33\\nTroubleshooting Docker Problems\", \" uu... cccessessssessssessssessssessssessssessssessssesessesessessssesessesessesessesessesesseeessee\", \"esseeesseeeeseeess 34\\nOther web application architectural Styles... cessssssessssssessessssssesseses\", \"ssssssssessesessessssesessesessesesssseessseesesesseseeseess 34\\nReferences \\u2014 COMMON WED architeCtUre\", \"s ......cccccsessessessessessecsecsessesessesesseseseseseeseeseeseeseeseeseeaeesseaeeseeseeseeseesee\", \"nee 34\\nCommon client-side web technologies. ..............cccccccccscccccsccccsccccssssscsssssssssss\", \"ssssssssssssssssssses 36\\nHTML... eseesessesssssessssessessessessessecsessessessessecsccuscucsussucsu\", \"csucsucsussussucsucsussucsucsucsucsucsessessecsecuecuccuccuceuccuccussucsucsucsussusseeseeseeaeeaeea\", \"eeneeneensens 36\\nCSS veccsssssessessessessessessessessecsecsecsecuccuccuccuccucsucsucsussussussucsuc\", \"sucsucsucsucsucsucsessessssecsecseeueauscucsucsucsussucsucsussucsucsucsucsucseesecseeaeeseeseeseesee\", \"aeeaeense 36\\nCSS PreProcCeSSOIs .....eecesessssssessssssssssesesesesssssssesesesesesessesesesesessss\", \"sesesesesessssuesesesesessssscsesesesesesseseseseseeeeseaeseseseeeeneenesesenees 37\\nJAVASCHIPE ...ee\", \"eceecccessesessessssesessesscsesucsesucsecussesussecussesussecsssesussessesesussesussesussesussesuss\", \"esnssecussecessecussesussesessecessecussecussesessecesseeneseeeeseenees 38\\nLegacy WED apps WITH JQUE\", \"TY ...ceecccsesssssssessssessssesessssessesessssessesessssessesessssessessssssessssesussesessecussee\", \"sesesessesusseeeeseeesseensseenees 38\\nJQUETY VS a SPA FraMeWokk o....ececcesesssssssssssesscsecscses\", \"sesesscsesscsesuesesussessesecussessesecussecussecussesussesusseceesecussesesseeessecesseeneseenees \", \"38\\nANUlar SPAS.....c.ccsccsessessssesessesessessssesssesssesussesussesussessssesussesussessssesusses\", \"ussesussesussesussesussesusseasssesussesussesussesuesesesseaesseeesseaesseeess 39\\nREACT... eeseseses\", \"sssesesscsesesscsescsesessscsesessesesessesesesuescaesucscsesucucsecussesesecsaseaesuesesesucucsesec\", \"ucsesecsenececucseaesucsesesecseaecesucaecesucaeeeseeaeeeenenees 40\\nVUC eeeeesessesesssesessesesesec\", \"sesesucscaesscscsesscucscsecusseaesucscsesucscsecucsesesessesesesucuesesecuesesecsesenecuesesesusues\", \"esucsesecucecsececsesesesueseaesusucaeeesecaeeeeeenes 40\\nBlazor WeDASSEMDIY ......ceesecsessessssese\", \"ssesessesessesessesessesessesessesessesessessssesssesussesucsessuesucsssesussecussecessesuesesessesu\", \"esecuesecesseeesseeneas 41\\nCHOOSING a SPA FraMe@wolk.......cccsesssssssssessssessssesssscsessssesscs\", \"essesessesessssessesessesessesessesessesessesessesessesessesessesesseseeseseeneaseseess 41\\nReference\", \"s \\u2014 Client Web Technologies ........cccsesssssessssessesssessessesessessecscsesssesesussesssesssesse\", \"ssecessesseesesesseeseeeseesseneessees 42\\nDevelop ASP.NET Core MVC app ...................ssccscssss\", \"ssssssssssssssssssssssssscssssssscsssccsscccssccccesccoes 43\\nMVC And RaZOr PaGeS.......scessssessese\", \"ssessssessssessssessssesessesessesessesessesessessssesussesussessssesussesussesessesussesessesussese\", \"ssesessesessesesseseeseseeseens 43\\n\\nii Contents\\nWhy Razor Page? ......cecesssssssssssssessessssessss\", \"scssssesscsussessesucsucsessesussecsesuesussessesuesecsecucsecsessesuesessesucsucsessesussessecueaes\", \"aeeneeeeaeeneanenees 44\\n\\nWheN tO USC MVC... eccesessesessessesscsessessccnesessecucsscsesnesscsesses\", \"scsscsecuesucsessecuesucsecucsussessecuesessesuesucseesecuesessecueaesaeeneaeeaeeneenenees 44\\nMappin\", \"g requests tO FESPONSES ......ccecesscsessessssessssessssesessesessesessesssesssesssessssesussesssse\", \"sessessssesssesessesessesessesessesesseseeseseeneens 44\\nKeeping controllers UNder CONTIOL on. eescss\", \"essesessssessesssscsssscssssssesscsessessssessssesessesessssesessecessessesesessesssseeesseeesseenss\", \"eenees 46\\nReferences \\u2014 Mapping Requests to RESPONSES ........ecsessssessessesesssssesscsessessecusse\", \"sssescsessessecussessecscsessesseeseseeseeneeeeses 48\\nWorking With CEPENCEN CIES... eececessesesssss\", \"ssssessecssecsssesscsessssessssesussecuesesussesussecsssecessecussesessecsssecessesussecuesecesseces\", \"seeneseeneseenees 48\\nDeclare YOUr CEPENCENCIES.........cecesscsessessssessssesessesessessssesesseses\", \"sesessssessesessesessesessesessesessssecnssecussessesecessesusseceeseeesseeneseenees 49\\nSTrUCTUFING \", \"The APPLICATION oo... cesesessesessesessesessecssessssessssecsesecussessssesussessssecsssecsssesusse\", \"cussesussesussecusseensseeesseeesaeensseensseeess 50\\nFE AtUre OFGANIZATION .......cecesscsessesssses\", \"essesessesessesesesessessssesssesssesusscsussescsesussesscsesessesucsesecssscsesecussesuesecessesues\", \"ecesseeesseensaeenees 51\\nAPIs And BlaZOr Aplications... ccecsesessessssessssessssesessessssesessesss\", \"secsssessssesssecussessssesssesesesssesessesessesessesesseeesseeesseseeseeess 53\\nCrOSS-CUTLING CONCE\", \"IIS ....eeecesesssssssessesessesessesessesessesessesssssssescsesucsesucsesessesussesucsesussesesescs\", \"essesesessesessesessesesseaeeseaeeneaeeseass 54\\nReferences \\u2014 Structuring ADPliCatiON ou. ccecsessese\", \"ssssessessssessessecssessesscsesssesecessesssesssessessesessesseescsesseeseeteseeseeneeeesee 5/\\nSQCU\", \"LILY wo.ceesessesscsesscsescsesscsesscsesscsesscsessssesussecussesussecussesussesussesussecussecusse\", \"cussesussecussesussesussecussesussecussesussesussesusseansseseeseesseensaeensseeess 57\\nIAONtITY oe e\", \"ecccessesessesessessssesssesssesussessssesussesussesussesussesussesussesucsssusscsusssaussesusscsucs\", \"ssussesessssessssesussecessessesecessesuesecessecesseeneseenees 5/\\nAUTNeNtiCatlOn .....eeeececeesess\", \"eesessesesseesesscsecsessessesessecucsecsesnesscsessessesecsesuesucsessessesecsecsesucsessesuesessec\", \"ucseeseenecucsessecueseeaeeneeeeaeeseenenees 60\\nReferences \\u2014 AUTH NtiCation nn... eeccecsessessessse\", \"ssssessesssssecsessessesssssscusssssussussussussucssssusseseeseseeseesseseeaeeaseaeeaeeaeeaeeseeneen\", \"ee 61\\nAUtNOFiZatiOn ......eeceecessesesssssesseseesecsecucsecsecsesuesessecucscsessesscsecsesucsucse\", \"csesucsesnessesscsesucsucsessesucsessesuesucsessesuesessesueaeeneeneseeaeeseanenees 61\\nREFErENCES \\u2014 \", \"SO CULILY.....cecccessessessssessescsessessesessessecussssessesussessecussussessecussessecussussesse\", \"cussssseesesussessecussusseesesussesseeneseeseeneaesaess 64\\nCIENT COMMUNICATION 2... eeeesesessesses\", \"eesessessesessecsessesecsesucsscsessesuesscsecucsucsessessesscsecuesucsesnesuesscsecuesucaesseeueaee\", \"necueseaessecueaeeneeneaneass 64\\nReferences \\u2014 CleENt COMMUNICATION ......ceccessessessessessessecsee\", \"sessecsessecsessecscssesscsucsucsuesuesuescseseeseeseeseeaeeateaeeaeeateaeeseeseenee 65\\nDomain-drive\", \"n design \\u2014 SHOUIA YOU Apply it? ne ccesesessesessesessessssessssesessessssesessesessesessesessesesse\", \"sessesessesessesesseseeseens 65\\nWhen Should you apply DDD.ww.. ec cesssssssessssesessesessessssesess\", \"esssesssessssesussesussesussessssesessesussesssesssesnsaesessesesseeesseeess 66\\nWhen shouldn't you a\", \"pply DDD .....eecccessessssessssesessessssesessesssesssessssesussesussesusseaussesussesussesessecuss\", \"esesseeesseeesseeesseeess 66\\nReferences \\u2014 DoMain-Driven DESIGN ....c..ccessessssessessesessessessses\", \"sessecsssesseescsesseesecussesssesssussessecussesseescsessesseeeseeseeneeesees 67\\nD@PlOYMEN LE... cc\", \"ecessesessessssesessesessesssessssesussesussessssesussesussesussesussessssessssessssesussesussessese\", \"sussessesesessesussesussesussesessesessesessesessesesseaeeneens 67\\nReferences \\u2014 DeEplOyMe nt.......c\", \"ccececsesssssssessessssessecscsessessessssessesscsssessecussessesussussessecussesseencsussessececses\", \"seesesesseeseeneseeseeneeeesess 68\\nWorking with Data in ASP.NET Core Apps. ...................cccccc\", \"ccsssssssssssssssssssssssssssssssssscsssccesecs 69\\nEntity Framework Core (for relational databases).\", \".. ccccecsesssssesssssssesssessecsssesssssesessesseesssessessesussessesncsesseeseeesseess 69\\nThe DD \", \"CONTEXE oo. eeeceesessessessesesessecscsscsecsccsescsecuesscsesuesscsessecuesscsecuesucsessessesecse\", \"cuesucsesnesuesessecuescsessecueseesesusaesseeneeeeaeeneenenees 69\\nCONFIGUIING EF COre wu. eeccccess\", \"essesscsessessesssessecucsessessecussessecussussessecusssssesussussessecussessscussusseesesussessecu\", \"ssesseeucsussesseeussesseeneaneaes 70\\nFetching ANd Storing Data ....cccceccccessessssessssessssesess\", \"ssessessssssessssssssssssssessesesssssssssessssessssssessecessessesesessesesseeesseeesseesseenees 71\", \"\\nFetching related data...ccccccsssssssessssessssesssscsssscsesssssssssssssssssssssssssssesessssessss\", \"essssessssessssssessecessecessesesseceesecesseesseeesseenees 72\\n\\nill Contents\\nEncapSulating Gata... \", \"cccecccsssessssessssessssessssessssssessessssssesssssssssessssessssessesessesessssessssessssessssess\", \"ssecessessesecesseenssesesseeesseeesseenees 73\\n\\nReSII@Nt CONNECTIONS... eceesessessessssessessesesse\", \"ssesucsecsecsesucsessecucsucsesuesucsecsecuesecsessesscscsecuesusaesnecuesessecussssecueseaeeseenent\", \"eaeeneeneaees 74\\nReferences \\u2014 Entity Framework Core ....cccccssssssssssssesssssssesssessessecessesss\", \"sscsessessesussesssesssessessecessesseescsesseeseeeseeseeneeeesee 76\\nEF COre OF MICFO-ORM? ou... ese\", \"esessessesssseesessessesessesscsecsecnesucscnccuesscsessesucsscsesucsessecuesucsecsesuesecsesucsscse\", \"ssecueaecaeenesesaeeneeueaeeneenensens 76\\nSQL OF NOSQL w.eeeeecesesssesessesesessesesesesesesscseses\", \"scscsesecsesesessesesesseuesesucscsesecscsesscuesesesuesesesseseaecececsesucecsescseseaesueseaecessc\", \"aeeeseeneneenenees T/\\nAZULE COSMOS DB .....eeeesessessssssesecssesececscsesucscsesucscsesscsesescses\", \"esesusseaesucseaesecucsecucuesesscuesesecussesesusseaesussesecuseenesececseaeeeeseaeeeeseaeens 18\\nOt\", \"TNEr PE|LrsiStENCE OPTIONS oo... eccesscssssessssecsssessssessssessssessssesessecessesssesessesssess\", \"sessssesessesssesussesussessesesessesessesessesesseeesseeeeseeess 79\\nCACHING ....eecesscsessesessese\", \"ssesessesessesussesussesussesussesussesussesussessssessssesussessssesussesussesussesussessesessssesu\", \"esesussesussesesseseesesussesusseseeseaesseensseeesseeess 80\\nASP.NET Core reSPONsSe CACHING uu... ec\", \"scsesssssssessssesessesessesessesssessssessssessssessssesussesussesussessssesussesussesssesssesessee\", \"esseeesseeesseeess 80\\nData CACHING ....eccesscsessessssessssesessesessesessesessesessesssesussesusse\", \"sussesussessscsssssussesssescsssssesucsssesussesussecessessesessssesusseceesecesseensseenees 81\\nGett\", \"ing data to Blazor WebASSEMDIY app... eccessssessessssesessesessesessesessessssesessessssesessesesse\", \"sessesessesessesessesesseeesseeesseeess 83\\nTest ASP.NET Core MVC apps ...............cccccsssssscccc\", \"ccssssssccccccssssscccccccssssscccccecssssscccccessssssccsseeess 85\\nKINGS Of AUTOMATE COSTS... eecce\", \"ceessesssssessesessssesscsscsussessesessessecsecsecsecsecsessecsecsecuscuceuceuscucsuscucsucsucsussu\", \"csesseeaeeseeneeaeeneeseenens 85\\nUNIt tOSES ee eeeccecesessesseseesessesesessessesecsessesscsessecuc\", \"sscsessesucsessecucsucsesuesucsessecussecsessesucsecsecucsucsesnecucsessesucsessesnesueaeeseeneneeae\", \"eneeneaee 85\\nINTEGFATION COSTS... .eececessessssessssessssesessessssessssesessesessesssssessssessese\", \"ssssssssssssesessssessssssssessesessssessssecussessesecessesusseceeseeesseeneseenees 85\\nFUNCTIONAL t\", \"eSts oo. eeceeessesessessessestesecsesscsscsessecscsessecuesucsessesucsucsesuesucsecsecuesucsessesuc\", \"sessecucsucsesnecucsessecuceessesuesueaeeseeueneeaeeneeneaees 86\\nT@STING PYM uo... ececessesessesess\", \"esessesessesessessssesussesssessssesussesussessssesussesussesussessssecussecussesussessssesussesuese\", \"eusseaessesessesesaeeesseseeseeess 86\\nWhaat to test... ecececcessessssssssssssesessessesncsessessese\", \"sessesusscsesuesucsessesusscsesuesucsessessesecsesucsessesnesussessesucseseesesucsessesueaeeaeeneeee\", \"aeeseeneness 87\\nOFrGaANIZING TESt PFOJECtS we ecececessesessesessesessessssessssesessessssssessessse\", \"sessesssessssessssessssesessesussesssesussesesesssesessessssesessesesseeesseeess 88\\nTOSE NAMING... e\", \"ccsessesessesessesessesessecsssesussesussesussesussesussesussesussesuesesussesussessssessssessssesus\", \"sesussesussessssesusseausseeussesussesessesesseansaeaesseeess 89\\nUnit testing ASP.NET Core App ou...\", \" ccecssssessssessssessssessssesessesessesessesssesessesessesessesssesessesussesessesessesessesessese\", \"ssesesseseeseaeeneess 91\\nIntegration testing ASP.NET Core apps .......cccessesesssssssessssessssesss\", \"ssssssesessesessesessesessesessesessesessesessesessesessesessesesseseeseseeseens 92\\nFunctional testi\", \"ng ASP.NET Core AappS.......esesessessssessssessssessssessssessssesessesessesessessssesessesessesess\", \"esessesessesessesessesesseseeseseeneens 92\\nReferences \\u2014 Test ASP.NET Core MVC apps.....ccccesessssss\", \"ssssessesessessesscsesssssesnssessesscsessessecussesseescssseeseeneseeseeneensaes 95\\nDevelopment pro\", \"cess for AZUIE ...............ccsssssssssssscscsscssssssscccccccccccsssssssssssssssssscsssssscssscss\", \"csess 96\\nVISION weceessessessesessessesscsscsesscsucnscscsucsucsessecucsscsecuesscsscsesucsussesuesu\", \"csessesucsucsesuesucsecsesucsucsesuesucaessecucsucsecuesucsessesuesucseeneeusaeeaeeeaeeaeeneaneaees \", \"96\\nDevelopment environment for ASP.NET Core App ......cccccssesssssesssssssesessessecscsessessesusse\", \"sseesesessesseeussesseencsesseeseensseess 96\\nDevelopment tools Choices: IDE OF CCItOP ne eeesessesss\", \"sessesessssssscsessesessesessesessesesseseseesecessecsesecesseesesecnsseeesseeneaeenees 96\\nDevelopme\", \"nt workflow for Azure-hosted ASP.NET Core App ......cccccessesssessessessssessecscsessessessssesseen\", \"csessseseeessess 97\\nINitiAl SCTUP we esccesesessesessesessessssesessesessesessessssesessesssssusssse\", \"ssssssssesssssssesessesussssessssucuesesussesussecessecussessssesuesecesseeesseensseenees 97\\nWorkflo\", \"w for developing Azure-hosted ASP.NET Core applications .......ccccesesescsessesesessesseetesseseese\", \"eeesee 98\\nREFEFENCES o.n.ceesecsessessessesseesessecsessecsecsecsecsecsccucsuscuceussucsussucsucsuss\", \"ucsucsucsscsucsecsecsessecseesecuecuesuccuccucsucsucsucsucsucsucseesesaeeaeeaeeaeeaeeneeaeenss 100\\n\\n\", \"iV Contents\\nAzure hosting recommendations for ASP.NET Core web apps..................ccccccccccsssss\", \"seees 101\\nWeb Applications ou... ccccsccesssssssessssessssessssessssessssesssessssesussesussessssesu\", \"ssesussesussesssessssesussesussesussesessesucsesessesessesessesesseaesseseeseess 101\\nApp Service We \", \"App .....ceesscsssssssssessssessssesessesessesessesessesessssssesessesessssssssessesucsesussssessese\", \"sussessssesuesecessesussesessecesaeeneaeenees 101\\nApp Service Web Apps for COntaine\\u2019r ......ccccesss\", \"sssssssessessssessssscsesssssecscsesssesssussessessssussessecusseesecussesseeseessesseeneeesaess 103\", \"\\nAZUre KUDe|rnetes SEPVICE .....eecessessssessessesseseesessesucsessecsesscsessecuesucsessecucsscsec\", \"nesucsecsesucsecsesnecuesessecucseesecueseseeseeeeaeeneeneeneaees 106\\nAZUre Virtlal MaChiNe 2... eec\", \"essesssssssessesseseeseesecuesessessesussessecuesucsecsecucscsecuesucsessesucsucsesuecuesecsecucsees\", \"esnesueseeseseeeeeneeneenenees 107\\nLOGICAl PFOCESSES uu... eeecessssesssssssessssessssecsesessssesue\", \"secsssessssessssessssecussesussucussssesucussssssessssessssessesucseseesesessssesseseesesesssaesnese\", \"eseseeeeans 107\\nData .o.ceeeecececsessssessesessesessesessesecucsessesessesecuesecsesessesesnesesues\", \"ecuesesuenssuescsensesesecuescsesecuenecsescsesesneassesesseseenenessesesseneenesessesesneaeeneaeene\", \"ess 107\\nArchitecture reCcOMMENCATtIONS.........eececessesssssesesseseseesessessesessesucsesessesuese\", \"ssecucsucsessesucsessesucsscsesnecucaessecucseeaeenseueaeeneeneneens 108\\n\\nContents\\nCHAPTER |\\n\\nCharac\", \"teristics of Modern\\nWeb Applications\\n\\n\\\"... with proper design, the features come cheaply. This appro\", \"ach is arduous, but continues to\\nsucceed.\\u201d\\n- Dennis Ritchie\\n\\nModern web applications have higher use\", \"r expectations and greater demands than ever before.\\nToday's web apps are expected to be available 2\", \"4/7 from anywhere in the world, and usable from\\nvirtually any device or screen size. Web application\", \"s must be secure, flexible, and scalable to meet\\nspikes in demand. Increasingly, complex scenarios s\", \"hould be handled by rich user experiences built on\\nthe client using JavaScript, and communicating ef\", \"ficiently through web APIs.\\n\\nASP.NET Core is optimized for modern web applications and cloud-based h\", \"osting scenarios. Its\\nmodular design enables applications to depend on only those features they actu\", \"ally use, improving\\napplication security and performance while reducing hosting resource requirement\", \"s.\\n\\nReference application: eshooOnWeb\\n\\nThis guidance includes a reference application, eShopOnWeb, t\", \"hat demonstrates some of the\\nprinciples and recommendations. The application is a simple online stor\", \"e, which supports browsing\\nthrough a catalog of shirts, coffee mugs, and other marketing items. The \", \"reference application is\\ndeliberately simple in order to make it easy to understand.\\n\\n1 CHAPTER 1 | \", \"Characteristics of Modern Web Applications\\nCatalog - Microsoftesh X = + - oO x\\n\\n\\u20ac > O | localhost:51\", \"06 + | = Zo\\nje eSHOP Login a\\nnwe\\n\\nON SALE\\n\\nTHIS WEEKEND\\n\\nShowing 10 of 12 products - Page 1 - 2 Next\", \"\\n\\n[ ADD TO CART ] [ADD TO CART } [ADD TO CART ]\\n\\n-NET BOT BLACK SWEATSHIRT -NET BLACK & WHITE MUG PR\", \"ISM WHITE T-SHIRT\\n\\n$19.50 $ 8.50 $ 12.00\\n\\nFigure 2-1. eShopOnWeb\\n\\nReference Application\\n\\n. eShopOnWe\", \"b\\nhttps://github.com/dotnet/eShopOnWeb\\n\\nCloud-hosted and scalable\\n\\nASP.NET Core is optimized for the\", \" cloud (public cloud, private cloud, any cloud) because it is low-\\nmemory and high-throughput. The s\", \"maller footprint of ASP.NET Core applications means you can\\nhost more of them on the same hardware, \", \"and you pay for fewer resources when using pay-as-you-\\ngo cloud hosting services. The higher-through\", \"put means you can serve more customers from an\\napplication given the same hardware, further reducing\", \" the need to invest in servers and hosting\\ninfrastructure.\\n\\nCross platform\\n\\nASP.NET Core is cross-pl\", \"atform and can run on Linux, macOS, and Windows. This capability opens up\\nmany new options for both \", \"the development and deployment of apps built with ASP.NET Core.\\n\\n2 CHAPTER 1 | Characteristics of Mo\", \"dern Web Applications\\nDocker containers - both Linux and Windows - can host ASP.NET Core application\", \"s, allowing them to\\ntake advantage of the benefits of containers and microservices.\\n\\nModular and loo\", \"sely coupled\\n\\nNuGet packages are first-class citizens in .NET Core, and ASP.NET Core apps are compos\", \"ed of many\\nlibraries through NuGet. This granularity of functionality helps ensure apps only depend \", \"on and\\ndeploy functionality they actually require, reducing their footprint and security vulnerabili\", \"ty surface\\narea.\\n\\nASP.NET Core also fully supports dependency injection, both internally and at the \", \"application level.\\nInterfaces can have multiple implementations that can be swapped out as needed. D\", \"ependency\\ninjection allows apps to loosely couple to those interfaces, rather than specific implemen\", \"tations,\\nmaking them easier to extend, maintain, and test.\\n\\nEasily tested with automated tests\\n\\nASP.\", \"NET Core applications support unit testing, and their loose coupling and support for dependency\\ninje\", \"ction makes it easy to swap infrastructure concerns with fake implementations for test purposes.\\nASP\", \".NET Core also ships with a TestServer that can be used to host apps in memory. Functional tests\\ncan\", \" then make requests to this in-memory server, exercising the full application stack (including\\nmiddl\", \"eware, routing, model binding, filters, etc.) and receiving a response, all in a fraction of the tim\", \"e\\nit would take to host the app on a real server and make requests through the network layer. These\\n\", \"tests are especially easy to write, and valuable, for APIs, which are increasingly important in mode\", \"rn\\nweb applications.\\n\\nTraditional and SPA behaviors supported\\n\\nTraditional web applications have inv\", \"olved little client-side behavior, but instead have relied on the\\nserver for all navigation, queries\", \", and updates the app might need to make. Each new operation made\\nby the user would be translated in\", \"to a new web request, with the result being a full page reload in the\\nend user's browser. Classic Mo\", \"del-View-Controller (MVC) frameworks typically follow this approach,\\nwith each new request correspon\", \"ding to a different controller action, which in turn would work with a\\nmodel and return a view. Some\", \" individual operations on a given page might be enhanced with AJAX\\n(Asynchronous JavaScript and XML)\", \" functionality, but the overall architecture of the app used many\\ndifferent MVC views and URL endpoi\", \"nts. In addition, ASP.NET Core MVC also supports Razor Pages, a\\nsimpler way to organize MVC-style pa\", \"ges.\\n\\nSingle Page Applications (SPAs), by contrast, involve very few dynamically generated server-si\", \"de page\\nloads (if any). Many SPAs are initialized within a static HTML file that loads the necessary\", \" JavaScript\\nlibraries to start and run the app. These apps make heavy usage of web APIs for their da\", \"ta needs and\\ncan provide much richer user experiences. Blazor WebAssembly provides a means of buildi\", \"ng SPAs\\nusing .NET code, which then runs in the client's browser.\\n\\n3 CHAPTER 1 | Characteristics of \", \"Modern Web Applications\\nMany web applications involve a combination of traditional web application b\", \"ehavior (typically for\\ncontent) and SPAs (for interactivity). ASP.NET Core supports both MVC (Views \", \"or Page based) and web\\nAPIs in the same application, using the same set of tools and underlying fram\", \"ework libraries.\\n\\nSimple develooment and deployment\\n\\nASP.NET Core applications can be written using \", \"simple text editors and command-line interfaces, or\\nfull-featured development environments like Visu\", \"al Studio. Monolithic applications are typically\\ndeployed to a single endpoint. Deployments can easi\", \"ly be automated to occur as part of a continuous\\nintegration (Cl) and continuous delivery (CD) pipel\", \"ine. In addition to traditional Cl/CD tools, Microsoft\\nAzure has integrated support for git reposito\", \"ries and can automatically deploy updates as they are\\nmade to a specified git branch or tag. Azure D\", \"evOps provides a full-featured CI/CD build and\\ndeployment pipeline, and GitHub Actions provide anoth\", \"er option for projects hosted there.\\n\\nTraditional ASP.NET and Web Forms\\n\\nIn addition to ASP.NET Core\", \", traditional ASP.NET 4.x continues to be a robust and reliable platform for\\nbuilding web applicatio\", \"ns. ASP.NET supports MVC and Web API development models, as well as Web\\nForms, which is well suited \", \"to rich page-based application development and features a rich third-party\\ncomponent ecosystem. Micr\", \"osoft Azure has great longstanding support for ASP.NET 4.x applications,\\nand many developers are fam\", \"iliar with this platform.\\n\\nBlazor\\n\\nBlazor is included with ASP.NET Core 3.0 and later. It provides a\", \" new mechanism for building rich\\ninteractive web client applications using Razor, C#, and ASP.NET Co\", \"re. It offers another solution to\\nconsider when developing modern web applications. There are two ve\", \"rsions of Blazor to consider:\\nserver-side and client-side.\\n\\nServer-side Blazor was released in 2019 \", \"with ASP.NET Core 3.0. As its name implies, it runs on the\\nserver, rendering changes to the client d\", \"ocument back to the browser over the network. Server-side\\nBlazor provides a rich client experience w\", \"ithout requiring client-side JavaScript and without requiring\\nseparate page loads for each client pa\", \"ge interaction. Changes in the loaded page are requested from\\nand processed by the server and then s\", \"ent back to the client using SignalR.\\n\\nClient-side Blazor, released in 2020, eliminates the need to \", \"render changes on the server. Instead, it\\nleverages WebAssembly to run .NET code within the client. \", \"The client can still make API calls to the\\nserver if needed to request data, but all client-side beh\", \"avior runs in the client via WebAssembly, which\\nis already supported by all major browsers and is ju\", \"st a JavaScript library.\\n\\nReferences \\u2014 Modern Web Applications\\n\\n\\u00b0 Introduction to ASP.NET Core\\nhttps\", \"://learn.microsoft.com/aspnet/core/\\n\\n4 CHAPTER 1 | Characteristics of Modern Web Applications\\nTestin\", \"g in ASP.NET Core\\nhttps://learn.microsoft.com/aspnet/core/testing/\\nBlazor - Get Started\\nhttps://blaz\", \"or.net/docs/get-started.html\\n\\nCHAPTER 1 | Characteristics of Modern Web Applications\\nCHAPTER 2\\n\\nCnoo\", \"se Between\\nTraditional Web Apps and\\nSingle Page Apps (SPAs)\\n\\n\\u201cAtwood's Law: Any application that can\", \" be written in JavaScript, will eventually be written in\\nJavaScript.\\u201d\\n- Jeff Atwood\\n\\nThere are two g\", \"eneral approaches to building web applications today: traditional web applications\\nthat perform most\", \" of the application logic on the server, and single-page applications (SPAs) that\\nperform most of th\", \"e user interface logic in a web browser, communicating with the web server\\nprimarily using web APIs.\", \" A hybrid approach is also possible, the simplest being host one or more rich\\nSPA-like subapplicatio\", \"ns within a larger traditional web application.\\n\\nUse traditional web applications when:\\n\\n. Your appl\", \"ication's client-side requirements are simple or even read-only.\\n\\n. Your application needs to functi\", \"on in browsers without JavaScript support.\\n\\n. Your application is public-facing and benefits from se\", \"arch engine discovery and referrals.\\nUse a SPA when:\\n\\n. Your application must expose a rich user int\", \"erface with many features.\\n\\n. Your team is familiar with JavaScript, TypeScript, or Blazor WebAssemb\", \"ly development.\\n\\n. Your application must already expose an API for other (internal or public) client\", \"s.\\n\\nAdditionally, SPA frameworks require greater architectural and security expertise. They experien\", \"ce\\ngreater churn due to frequent updates and new client frameworks than traditional web applications\", \".\\nConfiguring automated build and deployment processes and utilizing deployment options like\\ncontain\", \"ers may be more difficult with SPA applications than traditional web apps.\\n\\nImprovements in user exp\", \"erience made possible by the SPA approach must be weighed against these\\nconsiderations.\\n\\n6 CHAPTER 2\", \" | Choose Between Traditional Web Apps and Single Page Apps (SPAs)\\nBlazor\\n\\nASP.NET Core includes a m\", \"odel for building rich, interactive, and composable user interfaces called\\nBlazor. Blazor server-sid\", \"e allows developers to build Ul with C# and Razor on the server and for the UI\\nto be interactively c\", \"onnected to the browser in real-time using a persistent SignalR connection. Blazor\\nWebAssembly intro\", \"duces another option for Blazor apps, allowing them to run in the browser using\\nWebAssembly. Because\", \" it\\u2019s real .NET code running on WebAssembly, you can reuse code and libraries\\nfrom server-side parts\", \" of your application.\\n\\nBlazor provides a new, third option to consider when evaluating whether to bu\", \"ild a purely server-\\nrendered web application or a SPA. You can build rich, SPA-like client-side beh\", \"aviors using Blazor,\\nwithout the need for significant JavaScript development. Blazor applications ca\", \"n call APIs to request\\ndata or perform server-side operations. They can interoperate with JavaScript\", \" where necessary to take\\nadvantage of JavaScript libraries and frameworks.\\n\\nConsider building your w\", \"eb application with Blazor when:\\n\\n. Your application must expose a rich user interface\\n\\n. Your team \", \"is more comfortable with .NET development than JavaScript or TypeScript\\ndevelopment\\n\\nIf you have an \", \"existing web forms application you're considering migrating to .NET Core or the latest\\n.NET, you may\", \" wish to review the free e-book, Blazor for Web Forms Developers to see whether it\\nmakes sense to co\", \"nsider migrating it to Blazor.\\n\\nFor more information about Blazor, see Get started with Blazor.\\n\\nWhe\", \"n to choose traditional web apps\\n\\nThe following section is a more detailed explanation of the previo\", \"usly stated reasons for picking\\ntraditional web applications.\\n\\nYour application has simple, possibly\", \" read-only, client-side requirements\\n\\nMany web applications are primarily consumed in a read-only fa\", \"shion by the vast majority of their\\nusers. Read-only (or read-mostly) applications tend to be much s\", \"impler than those applications that\\nmaintain and manipulate a great deal of state. For example, a se\", \"arch engine might consist of a single\\nentry point with a textbox and a second page for displaying se\", \"arch results. Anonymous users can\\neasily make requests, and there is little need for client-side log\", \"ic. Likewise, a blog or content\\nmanagement system's public-facing application usually consists mainl\", \"y of content with little client-\\nside behavior. Such applications are easily built as traditional se\", \"rver-based web applications, which\\nperform logic on the web server and render HTML to be displayed i\", \"n the browser. The fact that each\\nunique page of the site has its own URL that can be bookmarked and\", \" indexed by search engines (by\\ndefault, without having to add this functionality as a separate featu\", \"re of the application) is also a clear\\nbenefit in such scenarios.\\n\\nYour application needs to functio\", \"n in browsers without JavaScript support\\n\\n7 CHAPTER 2 | Choose Between Traditional Web Apps and Sing\", \"le Page Apps (SPAs)\\nWeb applications that need to function in browsers with limited or no JavaScript\", \" support should be\\nwritten using traditional web app workflows (or at least be able to fall back to \", \"such behavior). SPAs\\nrequire client-side JavaScript in order to function; if it's not available, SPA\", \"s are not a good choice.\\n\\nYour team is unfamiliar with JavaScript or TypeScript development techniqu\", \"es\\n\\nIf your team is unfamiliar with JavaScript or TypeScript, but is familiar with server-side web a\", \"pplication\\ndevelopment, then they will probably be able to deliver a traditional web app more quickl\", \"y than a\\nSPA. Unless learning to program SPAs is a goal, or the user experience afforded by a SPA is\", \" required,\\ntraditional web apps are a more productive choice for teams who are already familiar with\", \" building\\nthem.\\n\\nWhen to choose SPAs\\n\\nThe following section is a more detailed explanation of when t\", \"o choose a Single Page Applications\\nstyle of development for your web app.\\n\\nYour application must ex\", \"pose a rich user interface with many features\\n\\nSPAs can support rich client-side functionality that \", \"doesn\\u2019t require reloading the page as users take\\nactions or navigate between areas of the app. SPAs \", \"can load more quickly, fetching data in the\\nbackground, and individual user actions are more respons\", \"ive since full page reloads are rare. SPAs can\\nsupport incremental updates, saving partially complet\", \"ed forms or documents without the user having\\nto click a button to submit a form. SPAs can support r\", \"ich client-side behaviors, such as drag-and-drop,\\nmuch more readily than traditional applications. S\", \"PAs can be designed to run in a disconnected mode,\\nmaking updates to a client-side model that are ev\", \"entually synchronized back to the server once a\\nconnection is re-established. Choose a SPA-style app\", \"lication if your app\\u2019s requirements include rich\\nfunctionality that goes beyond what typical HTML fo\", \"rms offer.\\n\\nFrequently, SPAs need to implement features that are built into traditional web apps, su\", \"ch as\\ndisplaying a meaningful URL in the address bar reflecting the current operation (and allowing \", \"users to\\nbookmark or deep link to this URL to return to it). SPAs also should allow users to use the\", \" browser's\\nback and forward buttons with results that won't surprise them.\\n\\nYour team is familiar wi\", \"th JavaScript and/or TypeScript development\\n\\nWriting SPAs requires familiarity with JavaScript and/o\", \"r TypeScript and client-side programming\\ntechniques and libraries. Your team should be competent in \", \"writing modern JavaScript using a SPA\\nframework like Angular.\\n\\nReferences \\u2014 SPA Frameworks\\n\\n. Angula\", \"r: https://angular.io\\n. React: https://reactjs.org/\\n. Vue.js: https://vuejs.org/\\n\\nYour application m\", \"ust already expose an API for other (internal or public) clients\\n\\n8 CHAPTER 2 | Choose Between Tradi\", \"tional Web Apps and Single Page Apps (SPAs)\\nIf you're already supporting a web API for use by other \", \"clients, it may require less effort to create a\\nSPA implementation that leverages these APIs rather \", \"than reproducing the logic in server-side form.\\nSPAs make extensive use of web APIs to query and upd\", \"ate data as users interact with the application.\\n\\nWhen to choose Blazor\\n\\nThe following section is a \", \"more detailed explanation of when to choose Blazor for your web app.\\n\\nYour application must expose a\", \" rich user interface\\n\\nLike JavaScript-based SPAs, Blazor applications can support rich client behavi\", \"or without page reloads.\\nThese applications are more responsive to users, fetching only the data (or\", \" HTML) required to respond\\nto a given user interaction. Designed properly, server-side Blazor apps c\", \"an be configured to run as\\nclient-side Blazor apps with minimal changes once this feature is support\", \"ed.\\n\\nYour team is more comfortable with .NET development than JavaScript or TypeScript\\ndevelopment\\n\\n\", \"Many developers are more productive with .NET and Razor than with client-side languages like\\nJavaScr\", \"ipt or TypeScript. Since the server-side of the application is already being developed with .NET,\\nus\", \"ing Blazor ensures every .NET developer on the team can understand and potentially build the\\nbehavio\", \"r of the front end of the application.\\n\\nDecision table\\n\\nThe following decision table summarizes some\", \" of the basic factors to consider when choosing\\nbetween a traditional web application, a SPA, or a B\", \"lazor app.\\n\\nTraditional Web Single Page Blazor\\nFactor gs\\nApplication\\nRequired Team Familiarity with \", \"Required\\nJavaScript/TypeScript\\nSupport Browsers without Scripting Supported Not Supported Supporte\\n\\n\", \"Minimal Client-Side Application Behavior Overkill | Viable\\nRich, Complex User Interface Limited Well\", \"-Suited Well-\\nRequirements Suited\\n\\nOther considerations\\n\\nTraditional Web Apps tend to be simpler and\", \" have better Search Engine Optimization (SEO) criteria\\nthan SPA apps. Search engine bots can easily \", \"consume content from traditional apps, while support\\nfor indexing SPAs may be lacking or limited. If\", \" your app benefits from public discovery by search\\nengines, this is often an important consideration\", \".\\n\\n9 CHAPTER 2 | Choose Between Traditional Web Apps and Single Page Apps (SPAs)\\nIn addition, unless\", \" you've built a management tool for your SPA's content, it may require developers\\nto make changes. T\", \"raditional Web Apps are often easier for non-developers to make changes to, since\\nmuch of the conten\", \"t is simply HTML and may not require a build process to preview or even deploy. If\\nnon-developers in\", \" your organization are likely to need to maintain the content of the app, a\\ntraditional web app may \", \"be a better choice.\\n\\nSPAs shine when the app has complex interactive forms or other user interaction\", \" features. For\\ncomplex apps that require authentication to use, and thus aren't accessible by public\", \" search engine\\nspiders, SPAs are a great option in many cases.\\n\\n10 CHAPTER 2 | Choose Between Tradit\", \"ional Web Apps and Single Page Apps (SPAs)\\nCHAPTER\\n\\nArchitectural principles\\n\\n\\u201cIf builders built bui\", \"ldings the way programmers wrote programs, then the first woodpecker that\\ncame along would destroy c\", \"ivilization.\\u201d\\n- Gerald Weinberg\\n\\nYou should architect and design software solutions with maintainabi\", \"lity in mind. The principles\\noutlined in this section can help guide you toward architectural decisi\", \"ons that will result in clean,\\nmaintainable applications. Generally, these principles will guide you\", \" toward building applications out\\nof discrete components that are not tightly coupled to other parts\", \" of your application, but rather\\ncommunicate through explicit interfaces or messaging systems.\\n\\nComm\", \"on design principles\\n\\nSeparation of concerns\\n\\nA guiding principle when developing is Separation of C\", \"oncerns. This principle asserts that software\\nshould be separated based on the kinds of work it perf\", \"orms. For instance, consider an application that\\nincludes logic for identifying noteworthy items to \", \"display to the user, and which formats such items in\\na particular way to make them more noticeable. \", \"The behavior responsible for choosing which items to\\nformat should be kept separate from the behavio\", \"r responsible for formatting the items, since these\\nbehaviors are separate concerns that are only co\", \"incidentally related to one another.\\n\\nArchitecturally, applications can be logically built to follow\", \" this principle by separating core business\\nbehavior from infrastructure and user-interface logic. I\", \"deally, business rules and logic should reside in\\na separate project, which should not depend on oth\", \"er projects in the application. This separation\\nhelps ensure that the business model is easy to test\", \" and can evolve without being tightly coupled to\\nlow-level implementation details (it also helps if \", \"infrastructure concerns depend on abstractions\\ndefined in the business layer). Separation of concern\", \"s is a key consideration behind the use of layers\\nin application architectures.\\n\\nEncapsulation\\n\\nDiff\", \"erent parts of an application should use encapsulation to insulate them from other parts of the\\nappl\", \"ication. Application components and layers should be able to adjust their internal implementation\\nwi\", \"thout breaking their collaborators as long as external contracts are not violated. Proper use of\\nenc\", \"apsulation helps achieve loose coupling and modularity in application designs, since objects and\\npac\", \"kages can be replaced with alternative implementations so long as the same interface is\\nmaintained.\\n\", \"\\n11 CHAPTER 3 | Architectural principles\\nIn classes, encapsulation is achieved by limiting outside a\", \"ccess to the class\\u2019s internal state. If an\\noutside actor wants to manipulate the state of the object\", \", it should do so through a well-defined\\nfunction (or property setter), rather than having direct ac\", \"cess to the private state of the object.\\nLikewise, application components and applications themselve\", \"s should expose well-defined interfaces\\nfor their collaborators to use, rather than allowing their s\", \"tate to be modified directly. This approach\\nfrees the application's internal design to evolve over t\", \"ime without worrying that doing so will break\\ncollaborators, so long as the public contracts are mai\", \"ntained.\\n\\nMutable global state is antithetical to encapsulation. A value fetched from mutable global\", \" state in one\\nfunction cannot be relied upon to have the same value in another function (or even fur\", \"ther in the\\nsame function). Understanding concerns with mutable global state is one of the reasons p\", \"rogramming\\nlanguages like C# have support for different scoping rules, which are used everywhere fro\", \"m\\nstatements to methods to classes. It\\u2019s worth noting that data-driven architectures which rely on a\", \"\\ncentral database for integration within and between applications are, themselves, choosing to depen\", \"d\\non the mutable global state represented by the database. A key consideration in domain-driven\\ndesi\", \"gn and clean architecture is how to encapsulate access to data, and how to ensure application\\nstate \", \"is not made invalid by direct access to its persistence format.\\n\\nDependency inversion\\n\\nThe direction\", \" of dependency within the application should be in the direction of abstraction, not\\nimplementation \", \"details. Most applications are written such that compile-time dependency flows in the\\ndirection of r\", \"untime execution, producing a direct dependency graph. That is, if class A calls a method\\nof class B\", \" and class B calls a method of class C, then at compile time class A will depend on class B,\\nand cla\", \"ss B will depend on class C, as shown in Figure 4-1.\\n\\n12 CHAPTER 3 | Architectural principles\\nDirect\", \" Dependency Graph\\n\\nCompile Time\\n\\nClass A\\n\\nReferences\\n\\nClass B\\n\\nReferences\\n\\nClass C\\n\\na_i eee\\n\\u2014 ee\\n\\n\\u2014 \", \"ee \\u2014 ee\\n\\nFigure 4-1. Direct dependency graph.\\n\\nApplying the dependency inversion principle allows A \", \"to call methods on an abstraction that B\\nimplements, making it possible for A to call B at run time,\", \" but for B to depend on an interface\\ncontrolled by A at compile time (thus, inverting the typical co\", \"mpile-time dependency). At run time, the\\nflow of program execution remains unchanged, but the introd\", \"uction of interfaces means that different\\nimplementations of these interfaces can easily be plugged \", \"in.\\n\\n13 CHAPTER 3 | Architectural principles\\nInverted Dependency Graph\\n\\nCompile Time Run Time\\n\\nClass\", \" A\\n\\nReferences\\n\\nControl Flow\\nClass B\\nReferences\\nReferences\\n\\nControl Flow\\n\\nClass C\\n\\nFigure 4-2. Inver\", \"ted dependency graph.\\n\\nDependency inversion is a key part of building loosely coupled applications, \", \"since implementation\\ndetails can be written to depend on and implement higher-level abstractions, ra\", \"ther than the other\\nway around. The resulting applications are more testable, modular, and maintaina\", \"ble as a result. The\\npractice of dependency injection is made possible by following the dependency i\", \"nversion principle.\\n\\nExplicit dependencies\\n\\nMethods and classes should explicitly require any collab\", \"orating objects they need in order to\\nfunction correctly. It is called the Explicit Dependencies Pri\", \"nciple. Class constructors provide an\\nopportunity for classes to identify the things they need in or\", \"der to be in a valid state and to function\\nproperly. If you define classes that can be constructed a\", \"nd called, but that will only function properly\\nif certain global or infrastructure components are i\", \"n place, these classes are being dishonest with their\\nclients. The constructor contract is telling t\", \"he client that it only needs the things specified (possibly\\nnothing if the class is just using a par\", \"ameterless constructor), but then at runtime it turns out the\\nobject really did need something else.\", \"\\n\\nBy following the explicit dependencies principle, your classes and methods are being honest with t\", \"heir\\nclients about what they need in order to function. Following the principle makes your code more\", \" self-\\ndocumenting and your coding contracts more user-friendly, since users will come to trust that\", \" as long\\nas they provide what's required in the form of method or constructor parameters, the object\", \"s they\\u2019re\\nworking with will behave correctly at run time.\\n\\nSingle responsibility\\n\\nThe single respons\", \"ibility principle applies to object-oriented design, but can also be considered as an\\narchitectural \", \"principle similar to separation of concerns. It states that objects should have only one\\nresponsibil\", \"ity and that they should have only one reason to change. Specifically, the only situation in\\nwhich t\", \"he object should change is if the manner in which it performs its one responsibility must be\\n\\n14 CHA\", \"PTER 3 | Architectural principles\\nupdated. Following this principle helps to produce more loosely co\", \"upled and modular systems, since\\nmany kinds of new behavior can be implemented as new classes, rathe\", \"r than by adding additional\\nresponsibility to existing classes. Adding new classes is always safer t\", \"han changing existing classes,\\nsince no code yet depends on the new classes.\\n\\nIn a monolithic applic\", \"ation, we can apply the single responsibility principle at a high level to the layers\\nin the applica\", \"tion. Presentation responsibility should remain in the UI project, while data access\\nresponsibility \", \"should be kept within an infrastructure project. Business logic should be kept in the\\napplication co\", \"re project, where it can be easily tested and can evolve independently from other\\nresponsibilities.\\n\", \"\\nWhen this principle is applied to application architecture and taken to its logical endpoint, you g\", \"et\\nmicroservices. A given microservice should have a single responsibility. If you need to extend th\", \"e\\nbehavior of a system, it\\u2019s usually better to do it by adding additional microservices, rather than\", \" by\\nadding responsibility to an existing one.\\n\\nLearn more about microservices architecture\\n\\nDon't re\", \"peat yourself (DRY)\\n\\nThe application should avoid specifying behavior related to a particular concep\", \"t in multiple places as\\nthis practice is a frequent source of errors. At some point, a change in req\", \"uirements will require\\nchanging this behavior. It's likely that at least one instance of the behavio\", \"r will fail to be updated, and\\nthe system will behave inconsistently.\\n\\nRather than duplicating logic\", \", encapsulate it in a programming construct. Make this construct the\\nsingle authority over this beha\", \"vior, and have any other part of the application that requires this\\nbehavior use the new construct.\\n\", \"\\nNote\\n\\nAvoid binding together behavior that is only coincidentally repetitive. For example, just bec\", \"ause two\\n\\ndifferent constants both have the same value, that doesn\\u2019t mean you should have only one c\", \"onstant, If\\nconceptually they're referring to different things. Duplication is always preferable to \", \"coupling to the\\nwrong abstraction.\\n\\nPersistence ignorance\\n\\nPersistence ignorance (Pl) refers to type\", \"s that need to be persisted, but whose code is unaffected by\\nthe choice of persistence technology. S\", \"uch types in .NET are sometimes referred to as Plain Old CLR\\nObjects (POCOs), because they do not ne\", \"ed to inherit from a particular base class or implement a\\nparticular interface. Persistence ignoranc\", \"e Is valuable because it allows the same business model to be\\npersisted in multiple ways, offering a\", \"dditional flexibility to the application. Persistence choices might\\nchange over time, from one datab\", \"ase technology to another, or additional forms of persistence might\\nbe required in addition to whate\", \"ver the application started with (for example, using a Redis cache or\\nAzure Cosmos DB in addition to\", \" a relational database).\\n\\nSome examples of violations of this principle include:\\n\\n15 CHAPTER 3 | Arc\", \"hitectural principles\\n. A required base class.\\n. A required interface implementation.\\n\\n. Classes res\", \"ponsible for saving themselves (such as the Active Record pattern).\\n\\n. Required parameterless constr\", \"uctor.\\n. Properties requiring virtual keyword.\\n. Persistence-specific required attributes.\\n\\nThe requ\", \"irement that classes have any of the above features or behaviors adds coupling between the\\ntypes to \", \"be persisted and the choice of persistence technology, making it more difficult to adopt new\\ndata ac\", \"cess strategies in the future.\\n\\nBounded contexts\\n\\nBounded contexts are a central pattern in Domain-D\", \"riven Design. They provide a way of tackling\\ncomplexity in large applications or organizations by br\", \"eaking it up into separate conceptual modules.\\nEach conceptual module then represents a context that\", \" is separated from other contexts (hence,\\nbounded), and can evolve independently. Each bounded conte\", \"xt should ideally be free to choose its\\nown names for concepts within it, and should have exclusive \", \"access to its own persistence store.\\n\\nAt a minimum, individual web applications should strive to be \", \"their own bounded context, with their\\nown persistence store for their business model, rather than sh\", \"aring a database with other applications.\\nCommunication between bounded contexts occurs through prog\", \"rammatic interfaces, rather than\\nthrough a shared database, which allows for business logic and even\", \"ts to take place in response to\\nchanges that take place. Bounded contexts map closely to microservic\", \"es, which also are ideally\\nimplemented as their own individual bounded contexts.\\n\\nAdditional resourc\", \"es\\n\\n\\u00b0 Principles\\n\\u00b0 Bounded Context\\n\\n16 CHAPTER 3 | Architectural principles\\nCHAPTER\\n\\nCommon web appl\", \"ication\\narchitectures\\n\\n\\u201cIf you think good architecture is expensive, try bad architecture.\\u201d - Brian \", \"Foote and Joseph Yoder\\n\\nMost traditional .NET applications are deployed as single units correspondin\", \"g to an executable or a\\nsingle web application running within a single IIS appdomain. This approach \", \"is the simplest\\ndeployment model and serves many internal and smaller public applications very well.\", \" However, even\\ngiven this single unit of deployment, most non-trivial business applications benefit \", \"from some logical\\nseparation into several layers.\\n\\nWhat is a monolithic application?\\n\\nA monolithic a\", \"pplication is one that is entirely self-contained, in terms of its behavior. It may interact\\nwith ot\", \"her services or data stores in the course of performing its operations, but the core of its\\nbehavior\", \" runs within its own process and the entire application is typically deployed as a single unit. If\\ns\", \"uch an application needs to scale horizontally, typically the entire application is duplicated acros\", \"s\\nmultiple servers or virtual machines.\\n\\nAll-in-one applications\\n\\nThe smallest possible number of pr\", \"ojects for an application architecture is one. In this architecture, the\\nentire logic of the applica\", \"tion is contained in a single project, compiled to a single assembly, and\\ndeployed as a single unit.\", \"\\n\\nA new ASP.NET Core project, whether created in Visual Studio or from the command line, starts out \", \"as\\na simple \\u201call-in-one\\u201d monolith. It contains all of the behavior of the application, including\\npre\", \"sentation, business, and data access logic. Figure 5-1 shows the file structure of a single-project\\n\", \"\\napp.\\n\\n17 CHAPTER 4 | Common web application architectures\\nVS Solution Structure\\n\\nSolution Explorer\\n\", \"\\n@&- \\u00a9o- Sah s\\\\\\u2014\\n\\nion Explorer (Ctri+;) -P-\\n{9 Solution 'MonolithSample' (1 project)\\n4 [{=3) Monolit\", \"hSample\\nG Connected Services\\n\\nb \\u00a9 Dependencies\\n\\nb & Properties\\n\\nb & wwwroot\\n\\nb \\u00a9 Controllers\\n4\\n\\n= Da\", \"ta | Data Access Logic\\n\\n> Ml Migrations < | - EF Migrations\\n\\n2 LEE U ASSIS BS - EF DbContext and mod\", \"el design\\nte Models SRAAAAARAAAAAAARARAAY\\n\\nb @ AccountViewModels\\nDb Ml ManageViewModels\\nb>  c* Appli\", \"cationUser.cs\\n\\n\\u2014\\u2014\\u2014 UI Models\\n\\n4 & Services\\nbc |EmailSender.cs\\nDb c\\u00ae [SmsSender.cs\\n\\n< Application Ser\", \"vices (interfaces and implementations)\\n\\n> C* MessageServices.cs\\n4 %&! Views\\n\\u00a9 Account\\n@ Home\\nm\\u2122@ Man\", \"age\\n\\u00a9 Shared\\n[2) _Viewlmports.cshtm!\\n[?) _ViewStart.cshtml\\n2) app.config\\n&T appsettings.json\\n&T bowe\", \"r.json . .\\n\\u00a7T bundleconfig.json ~ Application Entry Point and Configuration\\nb Program.cs\\nb>  C* Star\", \"tup.cs\\n\\n<\\u2014_____ Presentation Logic\\n\\nvvvyv\\n\\nvv\\n\\nFigure 5-1. A single project ASP.NET Core app.\\n\\nIn a \", \"single project scenario, separation of concerns Is achieved through the use of folders. The default\\n\", \"template includes separate folders for MVC pattern responsibilities of Models, Views, and Controller\", \"s,\\nas well as additional folders for Data and Services. In this arrangement, presentation details sh\", \"ould be\\nlimited as much as possible to the Views folder, and data access implementation details shou\", \"ld be\\nlimited to classes kept in the Data folder. Business logic should reside in services and class\", \"es within\\nthe Models folder.\\n\\nAlthough simple, the single-project monolithic solution has some disad\", \"vantages. As the project's size\\nand complexity grows, the number of files and folders will continue \", \"to grow as well. User interface (Ul)\\nconcerns (models, views, controllers) reside in multiple folder\", \"s, which aren't grouped together\\nalphabetically. This issue only gets worse when additional Ul-level\", \" constructs, such as Filters or\\nModelBinders, are added in their own folders. Business logic is scat\", \"tered between the Models and\\nServices folders, and there\\u2019s no clear indication of which classes in w\", \"hich folders should depend on\\nwhich others. This lack of organization at the project level frequentl\", \"y leads to spaghetti code.\\n\\nTo address these issues, applications often evolve into multi-project so\", \"lutions, where each project is\\nconsidered to reside in a particular layer of the application.\\n\\nWhat \", \"are layers?\\n\\nAs applications grow in complexity, one way to manage that complexity is to break up th\", \"e application\\naccording to its responsibilities or concerns. This approach follows the separation of\", \" concerns\\nprinciple and can help keep a growing codebase organized so that developers can easily fin\", \"d where\\ncertain functionality is implemented. Layered architecture offers a number of advantages bey\", \"ond just\\ncode organization, though.\\n\\n18 CHAPTER 4 | Common web application architectures\\nBy organizi\", \"ng code into layers, common low-level functionality can be reused throughout the\\napplication. This r\", \"euse is beneficial because it means less code needs to be written and because it can\\nallow the appli\", \"cation to standardize on a single implementation, following the don\\u2019t repeat yourself\\n(DRY) principl\", \"e.\\n\\nWith a layered architecture, applications can enforce restrictions on which layers can communica\", \"te\\nwith other layers. This architecture helps to achieve encapsulation. When a layer is changed or\\nr\", \"eplaced, only those layers that work with it should be impacted. By limiting which layers depend on\\n\", \"which other layers, the impact of changes can be mitigated so that a single change doesn\\u2019t impact th\", \"e\\nentire application.\\n\\nLayers (and encapsulation) make it much easier to replace functionality withi\", \"n the application. For\\nexample, an application might initially use its own SQL Server database for p\", \"ersistence, but later could\\nchoose to use a cloud-based persistence strategy, or one behind a web AP\", \"I. If the application has\\nproperly encapsulated its persistence implementation within a logical laye\", \"r, that SQL Server-specific\\nlayer could be replaced by a new one implementing the same public interf\", \"ace.\\n\\nIn addition to the potential of swapping out implementations in response to future changes in\\n\", \"requirements, application layers can also make it easier to swap out implementations for testing\\npur\", \"poses. Instead of having to write tests that operate against the real data layer or UI layer of the\\n\", \"application, these layers can be replaced at test time with fake implementations that provide known\\n\", \"responses to requests. This approach typically makes tests much easier to write and much faster to\\nr\", \"un when compared to running tests against the application's real infrastructure.\\n\\nLogical layering i\", \"s a common technique for improving the organization of code in enterprise software\\napplications, and\", \" there are several ways in which code can be organized into layers.\\n\\nNote\\n\\nLayers represent logical \", \"separation within the application. In the event that application logic is\\n\\nphysically distributed to\", \" separate servers or processes, these separate physical deployment targets are\\nreferred to as tiers.\", \" It's possible, and quite common, to have an N-Layer application that is deployed\\nto a single tier.\\n\", \"\\nTraditional \\u201cN-Layer\\u201d architecture applications\\n\\nThe most common organization of application logic \", \"into layers is shown in Figure 5-2.\\n\\n19 CHAPTER 4 | Common web application architectures\\nApplication\", \" Layers\\n\\nUser Interface\\n\\nBusiness Logic\\n\\nData Access\\n\\nFigure 5-2. Typical application layers.\\n\\nThese\", \" layers are frequently abbreviated as UI, BLL (Business Logic Layer), and DAL (Data Access Layer).\\nU\", \"sing this architecture, users make requests through the UI layer, which interacts only with the BLL.\", \"\\nThe BLL, in turn, can call the DAL for data access requests. The UI layer shouldn't make any reques\", \"ts to\\nthe DAL directly, nor should it interact with persistence directly through other means. Likewi\", \"se, the BLL\\nshould only interact with persistence by going through the DAL. In this way, each layer \", \"has its own\\nwell-known responsibility.\\n\\nOne disadvantage of this traditional layering approach is th\", \"at compile-time dependencies run from\\nthe top to the bottom. That is, the UI layer depends on the BL\", \"L, which depends on the DAL. This\\nmeans that the BLL, which usually holds the most important logic i\", \"n the application, is dependent on\\ndata access implementation details (and often on the existence of\", \" a database). Testing business logic\\nin such an architecture is often difficult, requiring a test da\", \"tabase. The dependency inversion principle\\ncan be used to address this issue, as you'll see in the n\", \"ext section.\\n\\nFigure 5-3 shows an example solution, breaking the application into three projects by \", \"responsibility\\n(or layer).\\n\\n20 CHAPTER 4 | Common web application architectures\\nVS Solution Structur\", \"e\\n\\nSolution Explorer\\n\\nGM&- o-s@ s|-|\\n\\nSearch Solution Explorer (Ctri+;) p-\\nA) Solution 'eShopOnWeb' \", \"(3 projects)\\n4 &!| src\\n> v[Gi] ApplicationCore \\u00ab Business/Application Model\\n4 +c] Infrastructure\\nb =\", \" Dependencies | Data Access Logic (Infrastructure)\\n> \\u00a9 Migrations + - EF Migrations\\nb +C* CatalogCon\", \"text.cs | .\\n- EF n nd m | i\\nb +C* CatalogContextSeed.cs EF DbContext and model design\\n\\n4 /B) Web\\nG& \", \"Connected Services\\nb> = Dependencies\\n> af Properties\\n> a} wwwroot\\n> am Controllers\\n> alll Pics\\nD all\", \"l Services\\n> alll ViewModels , - Presentation Logic\\n> alll Views\\n> aT appsettings,json\\n> a\\u00a77 bower,j\", \"son\\na7 bundleconfig.json\\nb ac* CatalogSettings.cs\\nb aC Program.cs\\n>b a* Startup.cs\\n\\ni tests < Automa\", \"ted Tests\\n\\nFigure 5-3. A simple monolithic application with three projects.\\n\\nAlthough this applicati\", \"on uses several projects for organizational purposes, it's still deployed as a\\nsingle unit and its c\", \"lients will interact with it as a single web app. This allows for very simple\\ndeployment process. Fi\", \"gure 5-4 shows how such an app might be hosted using Azure.\\n\\nCreate and Deploy Web app in\\n\\nAzure App\", \" Service\\n\\nDeploy project\\n9d to web app\\nCreate project\\nand web app\\n\\nFigure 5-4. Simple deployment of \", \"Azure Web App\\n\\nAs application needs grow, more complex and robust deployment solutions may be requir\", \"ed. Figure\\n5-5 shows an example of a more complex deployment plan that supports additional capabilit\", \"ies.\\n\\n21 CHAPTER 4 | Common web application architectures\\nAvure Active\\n\\nDirectory\\n\\n4\\n\\u2018 guthenticate\\n\", \"\\n#\\nf\\na\\n\\nIP address\\n\\nSource control\\n\\nFigure 5-5. Deploying a web app to an Azure App Service\\n\\nApp Ser\", \"vice Plan\\n\\nCSS)\\n\\nInstances\\n\\ndatabase database\\n\\nApp Service app\\nlast-known good\\n\\nproduction\\n\\nstaging\\n\", \"\\nDeployment slots\\n\\nAzure SOL Database\\n\\na\\n\\nlogical server\\n\\nBB,\\n\\nStorage account\\nBlob container\\napp lo\", \"gs web server\\n\\nlogs\\n\\nResource\\ngroup\\n\\nInternally, this project\\u2019s organization into multiple projects \", \"based on responsibility improves the\\n\\nmaintainability of the application.\\n\\nThis unit can be scaled u\", \"p or out to take advantage of cloud-based on-demand scalability. Scaling up\\nmeans adding additional \", \"CPU, memory, disk space, or other resources to the server(s) hosting your\\n\\napp. Scaling out means ad\", \"ding additional instances of such servers, whether these are physical\\n\\nservers, virtual machines, or\", \" containers. When your app is hosted across multiple instances, a load\\nbalancer is used to assign re\", \"quests to individual app instances.\\n\\nThe simplest approach to scaling a web application in Azure is \", \"to configure scaling manually in the\\n\\napplication's App Service Plan. Figure 5-6 shows the appropria\", \"te Azure dashboard screen to configure\\n\\nhow many instances are serving an app.\\n\\n22\\n\\nCHAPTER 4 | Comm\", \"on web application architectures\\nServicePlan Scale setting\\n\\nrvicePlan\\n\\nA x\\nEssentials \\u201c Vr QL\\ndemoas\", \"e1 \\u201c1g Premium: 1 Small\\ntestasel - Central US 4\\nReady\\n\\nPurple Demo Subscription\\n\\nedcc99a4-b7f9-4bSe-\", \"a9a1-3034c51db496\\n\\nUsage\\n\\nFile System Storage Quotas Scale : \\u00e9\\nSERVICEPLAN SERVICEPLAN SERVICEPLAN |\", \" INSTANCES PRD. IST\\nMemory Percentage 33% Autoscale On 1 1\\n0.01% CPU Percentage 1% Instances 1 * Sca\", \"le by\\nan instance count that | enter manually v\\nDescription\\nManual setup means that the number of in\", \"stances you choose won't change, even if there are\\nchanges in load.\\nEstimated spend Worker Pool Inst\", \"ances\\nSERVICEPLAN \\u2018| u\\nmitigate\\nView your spending in P| co {4 cS >\\n\\nyour App Service\\n\\nEnvironment s\", \"ettings\\n\\nWP1\\n\\nFigure 5-6. App Service Plan scaling in Azure.\\n\\nClean architecture\\n\\nApplications that \", \"follow the Dependency Inversion Principle as well as the Domain-Driven Design\\n(DDD) principles tend \", \"to arrive at a similar architecture. This architecture has gone by many names\\nover the years. One of\", \" the first names was Hexagonal Architecture, followed by Ports-and-Adapters.\\nMore recently, it's bee\", \"n cited as the Onion Architecture or Clean Architecture. The latter name, Clean\\nArchitecture, is use\", \"d as the name for this architecture in this e-book.\\n\\nThe eShopOnWeb reference application uses the C\", \"lean Architecture approach in organizing its code\\ninto projects. You can find a solution template yo\", \"u can use as a starting point for your own ASP.NET\\n\\nCore solutions in the ardalis/cleanarchitecture \", \"GitHub repository or by installing the template from\\nNuGet.\\n\\nClean architecture puts the business lo\", \"gic and application model at the center of the application.\\nInstead of having business logic depend \", \"on data access or other infrastructure concerns, this\\ndependency is inverted: infrastructure and imp\", \"lementation details depend on the Application Core.\\nThis functionality is achieved by defining abstr\", \"actions, or interfaces, in the Application Core, which are\\nthen implemented by types defined in the \", \"Infrastructure layer. A common way of visualizing this\\narchitecture is to use a series of concentric\", \" circles, similar to an onion. Figure 5-7 shows an example of\\nthis style of architectural representa\", \"tion.\\n\\n23 CHAPTER 4 | Common web application architectures\\nClean Architecture Layers (Onion view)\\n\\nU\", \"ser Interface\\n\\nControllers View Models\\n\\nDomain Services\\n\\nInterfaces\\nEntities\\n\\nApplication Core Exter\", \"nal Dependencies\\n\\nInfrastructure seu la,\\nRepositories Impl. Services\\n\\nFigure 5-7. Clean Architecture\", \"; onion view\\n\\nIn this diagram, dependencies flow toward the innermost circle. The Application Core t\", \"akes its name\\nfrom its position at the core of this diagram. And you can see on the diagram that the\", \" Application\\nCore has no dependencies on other application layers. The application's entities and in\", \"terfaces are at\\nthe very center. Just outside, but still in the Application Core, are domain service\", \"s, which typically\\nimplement interfaces defined in the inner circle. Outside of the Application Core\", \", both the UI and the\\nInfrastructure layers depend on the Application Core, but not on one another (\", \"necessarily).\\n\\nFigure 5-8 shows a more traditional horizontal layer diagram that better reflects the\", \" dependency\\nbetween the UI and other layers.\\n\\n24 CHAPTER 4 | Common web application architectures\\nOp\", \"tional Compile-Time Dependency\\nCompile-Time Dependency\\n\\nClean Architecture Layers \\u2014\\n\\nUser Interface\\n\", \"\\nInfrastructure\\n\\nApplication Core\\n\\nFigure 5-8. Clean Architecture; horizontal layer view\\n\\nNote that \", \"the solid arrows represent compile-time dependencies, while the dashed arrow represents a\\nruntime-on\", \"ly dependency. With the clean architecture, the UI layer works with interfaces defined in\\nthe Applic\", \"ation Core at compile time, and ideally shouldn't know about the implementation types\\ndefined in the\", \" Infrastructure layer. At run time, however, these implementation types are required for\\nthe app to \", \"execute, so they need to be present and wired up to the Application Core interfaces via\\ndependency i\", \"njection.\\n\\nFigure 5-9 shows a more detailed view of an ASP.NET Core application's architecture when \", \"built\\nfollowing these recommendations.\\n\\n25 CHAPTER 4 | Common web application architectures\\nCompile \", \"Time Dependency\\n\\nASPNET Core Architecture + tment\\n\\nASP.NET Core Web App Infrastructure Project\\n\\nInMe\", \"mory\\n\\nData Cache\\n\\nModel\\nValidation Filter\\nOther Filters ' DbContex\\n\\nAzure Service Other Web API\\n\\nCli\", \"ents\\n\\nRedis Cache\\n\\nData Sources Third Party Services\\n\\nmee ee ee a ee ee ee ee ee ee ee ee eee eee ee\", \"e eens\\n\\nGitHub AP! SendGrid API Twilio API\\n\\nSasmeananmaneasanceansewasasnmocacaneant lanwwa carne a \", \"wes e sme saa anes neaweaacaenzce\\n\\nFigure 5-9. ASP.NET Core architecture diagram following Clean Arc\", \"hitecture.\\n\\nBecause the Application Core doesn't depend on Infrastructure, it\\u2019s very easy to write a\", \"utomated unit\\ntests for this layer. Figures 5-10 and 5-11 show how tests fit into this architecture.\", \"\\n\\nDomain Services\\n\\nInterfaces\\n\\nEntities\\n\\nApplication Core\\n\\nFigure 5-10. Unit testing Application Cor\", \"e in isolation.\\n\\n26 CHAPTER 4 | Common web application architectures\\nExternal Dependencies\\n\\ninfrastr\", \"ucture\\n\\nIntegration\\nTests\\n\\nFigure 5-71. Integration testing Infrastructure implementations with exte\", \"rnal dependencies.\\n\\nSince the UI layer doesn't have any direct dependency on types defined in the In\", \"frastructure project,\\nit\\u2019s likewise very easy to swap out implementations, either to facilitate test\", \"ing or in response to\\nchanging application requirements. ASP.NET Core\\u2019s built-in use of and support \", \"for dependency\\ninjection makes this architecture the most appropriate way to structure non-trivial m\", \"onolithic\\napplications.\\n\\nFor monolithic applications, the Application Core, Infrastructure, and UI p\", \"rojects are all run as a single\\napplication. The runtime application architecture might look somethi\", \"ng like Figure 5-12.\\n\\n27 CHAPTER 4 | Common web application architectures\\nASPNET Core Architecture\\n\\n\", \"ASP.NET Core Web App\\n(Kestrel/Weblistener Host)\\n\\n[lela ieteetateiattata tate edalataiedatel tel adal\", \"atalatelatetatelialetalatateteiabetaialatelataletaiaied-\\u201dtakeiel |\\n\\nModel\\nValidation Filter\\nResponse\", \" InMemory\\nCaching Filter Data Cache\\n\\nData Sources\\n\\nwww ww ww ww www ww ww ew ee ee eee eee,\\n\\n{ }\\n\\nCl\", \"ient\\n\\nIS Reverse\\n\\n1 i\\n1 i\\nrT i\\n1 i\\n1 i\\nrT i\\n1 i\\nProxy Redis sectie Cache SQL Document\\n' Cache Servic\", \"e [nies [aa Database ____Database_______\\n'\\n'\\n'\\n'\\n\\nAzure S\\n\\nure Service\\n\\n< oe > &\\nRell\\n\\n! ASPNET Core\", \" | Other Web API Jy Email Service SMS Service\\nIdentity Clients (SendGrid, etc) (Twilio, etc) ;\\n\\nAzur\", \"e\\nService Bus\\n\\nA\\nrn\\nIdentity Providers! Third Party Services y\\n| EF Core OAuth Azure Active ' GitHub\", \" API SendGrid API Twilio API\\nProvider Provider(s) Directory us\\n\\nFigure 5-12. A sample ASP.NET Core a\", \"pp's runtime architecture.\\n\\nOrganizing code in Clean Architecture\\n\\nIn a Clean Architecture solution,\", \" each project has clear responsibilities. As such, certain types belong\\nin each project and you'll f\", \"requently find folders corresponding to these types in the appropriate\\nproject.\\n\\nApplication Core\\n\\nT\", \"he Application Core holds the business model, which includes entities, services, and interfaces. The\", \"se\\ninterfaces include abstractions for operations that will be performed using Infrastructure, such \", \"as data\\naccess, file system access, network calls, etc. Sometimes services or interfaces defined at \", \"this layer will\\nneed to work with non-entity types that have no dependencies on UI or Infrastructure\", \". These can be\\ndefined as simple Data Transfer Objects (DTOs).\\n\\nApplication Core types\\n\\n. Entities (\", \"business model classes that are persisted)\\n. Aggregates (groups of entities)\\n\\n. Interfaces\\n\\n. Domain\", \" Services\\n\\n. Specifications\\n\\n. Custom Exceptions and Guard Clauses\\n\\n\\u00b0 Domain Events and Handlers\\n\\n28\", \" CHAPTER 4 | Common web application architectures\\nInfrastructure\\n\\nThe Infrastructure project typical\", \"ly includes data access implementations. In a typical ASP.NET Core\\nweb application, these implementa\", \"tions include the Entity Framework (EF) DoContext, any EF Core\\nMigration objects that have been defi\", \"ned, and data access implementation classes. The most common\\nway to abstract data access implementat\", \"ion code is through the use of the Repository design pattern.\\n\\nIn addition to data access implementa\", \"tions, the Infrastructure project should contain implementations\\nof services that must interact with\", \" infrastructure concerns. These services should implement interfaces\\ndefined in the Application Core\", \", and so Infrastructure should have a reference to the Application Core\\nproject.\\n\\nInfrastructure typ\", \"es\\n\\n. EF Core types (DbContext, Migration)\\n\\n. Data access implementation types (Repositories)\\n. Infr\", \"astructure-specific services (for example, FileLogger or SmtpNotifier)\\nUl Layer\\n\\nThe user interface \", \"layer in an ASP.NET Core MVC application is the entry point for the application. This\\nproject should\", \" reference the Application Core project, and its types should interact with infrastructure\\nstrictly \", \"through interfaces defined in Application Core. No direct instantiation of or static calls to the\\nIn\", \"frastructure layer types should be allowed in the UI layer.\\n\\nUl Layer types\\n\\n. Controllers\\n\\u00b0 Custom \", \"Filters\\n. Custom Middleware\\n\\u00b0 Views\\n. ViewModels\\n\\u00b0 Startup\\nThe Startup class or Program.cs file is r\", \"esponsible for configuring the application, and for wiring up\\n\\nimplementation types to interfaces. T\", \"he place where this logic is performed is known as the app\\u2019s\\ncomposition root, and is what allows de\", \"pendency injection to work properly at run time.\\n\\nNote\\n\\nIn order to wire up dependency injection dur\", \"ing app startup, the UI layer project may need to\\nreference the Infrastructure project. This depende\", \"ncy can be eliminated, most easily by using a\\n\\ncustom DI container that has built-in support for loa\", \"ding types from assemblies. For the purposes of\\nthis sample, the simplest approach is to allow the U\", \"I project to reference the Infrastructure project\\n(but developers should limit actual references to \", \"types in the Infrastructure project to the app\\u2019s\\ncomposition root).\\n\\n29 CHAPTER 4 | Common web appli\", \"cation architectures\\nMonolithic applications and containers\\n\\nYou can build a single and monolithic-d\", \"eployment based Web Application or Service and deploy it as\\na container. Within the application, it \", \"might not be monolithic but organized into several libraries,\\ncomponents, or layers. Externally, it\\u2019\", \"s a single container with a single process, single web application,\\nor single service.\\n\\nTo manage th\", \"is model, you deploy a single container to represent the application. To scale, just add\\nadditional \", \"copies with a load balancer in front. The simplicity comes from managing a single\\ndeployment in a si\", \"ngle container or VM.\\n\\nMonolithic Containerized application\\n\\nApp 1 = 1 Container A monolithic applic\", \"ation has\\n\\nmost of its functionality within\\na single process/container that\\nis componentized with in\", \"ternal\\n\\nC layers or libraries.\\nHost 1 Si\\n(Server/VM)\\nHost 2 Scales out by cloning\\n(Server/VM) Ls] th\", \"e app/container on\\nmultiple servers/VMs\\nHost 3\\n(Server/VM) [J\\n\\nNeed to deploy Coarse-grained\\nthe ful\", \"l density of\\n\\napplication applications\\n\\nYou can include multiple components/libraries or internal la\", \"yers within each container, as illustrated in\\nFigure 5-13. But, following the container principle of\", \" _\\u201ca container does one thing, and does it in one\\nprocess_\\\", the monolithic pattern might be a confl\", \"ict.\\n\\nThe downside of this approach comes if/when the application grows, requiring it to scale. If t\", \"he entire\\napplication scales, it's not really a problem. However, in most cases, a few parts of the \", \"application are\\nthe choke points requiring scaling, while other components are used less.\\n\\nUsing the\", \" typical eCommerce example, what you likely need to scale is the product information\\ncomponent. Many\", \" more customers browse products than purchase them. More customers use their\\nbasket than use the pay\", \"ment pipeline. Fewer customers add comments or view their purchase history.\\nAnd you likely only have\", \" a handful of employees, in a single region, that need to manage the content\\nand marketing campaigns\", \". By scaling the monolithic design, all the code is deployed multiple times.\\n\\nIn addition to the \\u201csc\", \"ale everything\\u201d problem, changes to a single component require complete\\nretesting of the entire appl\", \"ication, and a complete redeployment of all the instances.\\n\\nThe monolithic approach is common, and m\", \"any organizations are developing with this architectural\\napproach. Many are having good enough resul\", \"ts, while others are hitting limits. Many designed their\\napplications in this model, because the too\", \"ls and infrastructure were too difficult to build service-\\noriented architectures (SOA), and they di\", \"dn\\u2019t see the need until the app grew. If you find you're hitting\\n\\n30 CHAPTER 4 | Common web applicat\", \"ion architectures\\nthe limits of the monolithic approach, breaking up the app to enable it to better \", \"leverage containers\\nand microservices may be the next logical step.\\n\\nArchitecture in Docker infrastr\", \"ucture\\nfor monolithic applications\\n\\nCa Microsoft\\n=> Azure\\nHost 1 (VM)\\nf\\\\ or =\\nBrowser or Host 2 (VM)\", \"\\n, f\\\\ om\\nClient app Oo ay\\n\\nHost 3 (VM)\\nf\\\\ or fH\\n\\nDeploying monolithic applications in Microsoft Azur\", \"e can be achieved using dedicated VMs for each\\ninstance. Using Azure Virtual Machine Scale Sets, you\", \" can easily scale the VMs. Azure App Services can\\nrun monolithic applications and easily scale insta\", \"nces without having to manage the VMs. Azure App\\nServices can run single instances of Docker contain\", \"ers as well, simplifying the deployment. Using\\nDocker, you can deploy a single VM as a Docker host, \", \"and run multiple instances. Using the Azure\\nbalancer, as shown in the Figure 5-14, you can manage sc\", \"aling.\\n\\nThe deployment to the various hosts can be managed with traditional deployment techniques. T\", \"he\\nDocker hosts can be managed with commands like docker run performed manually, or through\\nautomati\", \"on such as Continuous Delivery (CD) pipelines.\\n\\nMonolithic application deployed as a container\\n\\nTher\", \"e are benefits of using containers to manage monolithic application deployments. Scaling the\\ninstanc\", \"es of containers is far faster and easier than deploying additional VMs. Even when using virtual\\nmac\", \"hine scale sets to scale VMs, they take time to create. When deployed as app instances, the\\nconfigur\", \"ation of the app is managed as part of the VM.\\n\\nDeploying updates as Docker images is far faster and\", \" network efficient. Docker Images typically start\\nin seconds, speeding rollouts. Tearing down a Dock\", \"er instance is as easy as issuing a docker stop\\ncommand, typically completing in less than a second.\", \"\\n\\n31 CHAPTER 4 | Common web application architectures\\nAs containers are inherently immutable by desi\", \"gn, you never need to worry about corrupted VMs,\\nwhereas update scripts might forget to account for \", \"some specific configuration or file left on the disk.\\n\\nYou can use Docker containers for a monolithi\", \"c deployment of simpler web applications. This\\napproach improves continuous integration and continuo\", \"us deployment pipelines and helps achieve\\ndeployment-to-production success. No more \\u201cIt works on my \", \"machine, why does it not work in\\nproduction?\\\"\\n\\nA microservices-based architecture has many benefits,\", \" but those benefits come at a cost of increased\\ncomplexity. In some cases, the costs outweigh the be\", \"nefits, so a monolithic deployment application\\nrunning in a single container or in just a few contai\", \"ners is a better option.\\n\\nA monolithic application might not be easily decomposable into well-separa\", \"ted microservices.\\nMicroservices should work independently of each other to provide a more resilient\", \" application. If you\\ncan't deliver independent feature slices of the application, separating it only\", \" adds complexity.\\n\\nAn application might not yet need to scale features independently. Many applicati\", \"ons, when they\\nneed to scale beyond a single instance, can do so through the relatively simple proce\", \"ss of cloning that\\nentire instance. The additional work to separate the application into discrete se\", \"rvices provides a\\nminimal benefit when scaling full instances of the application is simple and cost-\", \"effective.\\n\\nEarly in the development of an application, you might not have a clear idea where the na\", \"tural\\nfunctional boundaries are. As you develop a minimum viable product, the natural separation mig\", \"ht\\nnot yet have emerged. Some of these conditions might be temporary. You might start by creating a\\n\", \"monolithic application, and later separate some features to be developed and deployed as\\nmicroservic\", \"es. Other conditions might be essential to the application's problem space, meaning that\\nthe applica\", \"tion might never be broken into multiple microservices.\\n\\nSeparating an application into many discret\", \"e processes also introduces overhead. There\\u2019s more\\ncomplexity in separating features into different \", \"processes. The communication protocols become\\nmore complex. Instead of method calls, you must use as\", \"ynchronous communications between\\nservices. As you move to a microservices architecture, you need to\", \" add many of the building blocks\\nimplemented in the microservices version of the eSshopOnContainers \", \"application: event bus handling,\\nmessage resiliency and retries, eventual consistency, and more.\\n\\nTh\", \"e much simpler eSshopOnWeb reference application supports single-container monolithic container\\nusag\", \"e. The application includes one web application that includes traditional MVC views, web APIs,\\nand R\", \"azor Pages. Optionally, you can run the application's Blazor-based admin component, which\\nrequires a\", \" separate API project to run as well.\\n\\nThe application can be launched from the solution root using \", \"the docker-compose build and docker-\\ncompose up commands. This command configures a container for th\", \"e web instance, using the\\nDockerfile found in the web project's root, and runs the container on a sp\", \"ecified port. You can\\ndownload the source for this application from GitHub and run it locally. Even \", \"this monolithic\\napplication benefits from being deployed in a container environment.\\n\\nFor one, the c\", \"ontainerized deployment means that every instance of the application runs in the same\\nenvironment. T\", \"his approach includes the developer environment where early testing and\\ndevelopment take place. The \", \"development team can run the application in a containerized\\nenvironment that matches the production \", \"environment.\\n\\n32 CHAPTER 4 | Common web application architectures\\nIn addition, containerized applica\", \"tions scale out at a lower cost. Using a container environment\\nenables greater resource sharing than\", \" traditional VM environments.\\n\\nFinally, containerizing the application forces a separation between t\", \"he business logic and the storage\\nserver. As the application scales out, the multiple containers wil\", \"l all rely on a single physical storage\\nmedium. This storage medium would typically be a high-availa\", \"bility server running a SQL Server\\ndatabase.\\n\\nDocker support\\n\\nThe eShopOnWeb project runs on .NET. T\", \"herefore, it can run in either Linux-based or Windows-based\\ncontainers. Note that for Docker deploym\", \"ent, you want to use the same host type for SQL Server.\\nLinux-based containers allow a smaller footp\", \"rint and are preferred.\\n\\nYou can use Visual Studio 2017 or later to add Docker support to an existin\", \"g application by right-\\nclicking on a project in Solution Explorer and choosing Add > Docker Support\", \". This step adds the\\nfiles required and modifies the project to use them. The current eshopOnWeb sam\", \"ple already has\\nthese files in place.\\n\\nThe solution-level docker-compose.yml file contains informati\", \"on about what images to build and\\nwhat containers to launch. The file allows you to use the docker-c\", \"ompose command to launch\\nmultiple applications at the same time. In this case, it is only launching \", \"the Web project. You can also\\nuse it to configure dependencies, such as a separate database containe\", \"r.\\n\\nversion: \\u2018'3'\\n\\nservices:\\neshopwebmvc:\\nimage: eshopwebmvc\\nbuild:\\ncontext:\\ndockerfile: src/Web/Doc\", \"kerfile\\n\\nenvironment:\\n\\n- ASPNETCORE_ENVIRONMENT=Development\\nports:\\n\\n- \\\"5106:5106\\\"\\n\\nnetworks:\\ndefault\", \":\\nexternal:\\nname: nat\\n\\nThe docker-compose.yml file references the Dockerfile in the Web project. The\", \" Dockerfile is used to\\nspecify which base container will be used and how the application will be con\", \"figured on it. The Web\\u2019\\nDockerfile:\\n\\nFROM mcr.microsoft.com/dotnet/sdk:8.@ AS build\\nWORKDIR /app\\n\\nCO\", \"PY *.sln .\\n\\nCOPY .\\n\\nWORKDIR /app/src/Web\\nRUN dotnet restore\\n\\n33 CHAPTER 4 | Common web application a\", \"rchitectures\\nRUN dotnet publish -c Release -o out\\n\\nFROM mcr.microsoft.com/dotnet/aspnet:8.@ AS runti\", \"me\\nWORKDIR /app\\nCOPY --from=build /app/src/Web/out ./\\n\\nENTRYPOINT [\\\"dotnet\\\", \\\"Web.dll\\\"]\\n\\nTroubleshoo\", \"ting Docker problems\\n\\nOnce you run the containerized application, it continues to run until you stop\", \" it. You can view which\\ncontainers are running with the docker ps command. You can stop a running co\", \"ntainer by using the\\ndocker stop command and specifying the container ID.\\n\\nNote that running Docker \", \"containers may be bound to ports you might otherwise try to use in your\\ndevelopment environment. If \", \"you try to run or debug an application using the same port as a running\\nDocker container, you'll get\", \" an error stating that the server can't bind to that port. Once again,\\nstopping the container should\", \" resolve the issue.\\n\\nIf you want to add Docker support to your application using Visual Studio, make\", \" sure Docker Desktop\\nis running when you do so. The wizard won't run correctly if Docker Desktop isn\", \"'t running when you\\nstart the wizard. In addition, the wizard examines your current container choice\", \" to add the correct\\nDocker support. If you want to add, support for Windows Containers, you need to \", \"run the wizard\\nwhile you have Docker Desktop running with Windows Containers configured. If you want\", \" to add,\\nsupport for Linux containers, run the wizard while you have Docker running with Linux conta\", \"iners\\nconfigured.\\n\\nOther web application architectural styles\\n\\n. Web-Queue-Worker: The core componen\", \"ts of this architecture are a web front end that\\nserves client requests, and a worker that performs \", \"resource-intensive tasks, long-running\\nworkflows, or batch jobs. The web front end communicates with\", \" the worker through a\\nmessage queue.\\n\\n. N-tier: An N-tier architecture divides an application into l\", \"ogical layers and physical tiers.\\n\\n. Microservice: A microservices architecture consists of a collec\", \"tion of small, autonomous\\nservices. Each service is self-contained and should implement a single bus\", \"iness capability\\nwithin a bounded context.\\n\\nReferences \\u2014 Common web architectures\\n\\n\\u00b0 The Clean Archi\", \"tecture\\nhttps://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html\\n\\n\\u00b0 The Onion Ar\", \"chitecture\\nhttps://jeffreypalermo.com/blog/the-onion-architecture-part-1/\\n\\n. The Repository Pattern\\n\", \"https://devig.com/repository-pattern/\\n\\n. Clean Architecture Solution Template\\n\\nhttps://github.com/ar\", \"dalis/cleanarchitecture\\n\\n34 CHAPTER 4 | Common web application architectures\\n35\\n\\nArchitecting Micros\", \"ervices e-book\\nhttps://aka.ms/MicroservicesEbook\\n\\nDDD (Domain-Driven Design)\\nhttos://learn.microsoft\", \".com/dotnet/architecture/microservices/microservice-ddd-cars-\\n\\npatterns/\\n\\nCHAPTER 4 | Common web app\", \"lication architectures\\nCHAPTER 5\\n\\nCommon client-side web\\ntecnnologies\\n\\n\\u201cWebsites should look good fr\", \"om the inside and out.\\u201d - Paul Cookson\\n\\nASP.NET Core applications are web applications and they typi\", \"cally rely on client-side web\\ntechnologies like HTML, CSS, and JavaScript. By separating the content\", \" of the page (the HTML) from\\nits layout and styling (the CSS), and its behavior (via JavaScript), co\", \"mplex web apps can leverage the\\nSeparation of Concerns principle. Future changes to the structure, d\", \"esign, or behavior of the\\napplication can be made more easily when these concerns are not intertwine\", \"d.\\n\\nWhile HTML and CSS are relatively stable, JavaScript, by means of the application frameworks and\", \"\\nutilities developers work with to build web-based applications, is evolving at breakneck speed. Thi\", \"s\\nchapter looks at a few ways that JavaScript is used by web developers and provides a high-level\\nov\", \"erview of the Angular and React client-side libraries.\\n\\nNote\\n\\nBlazor provides an alternative to Java\", \"Script frameworks for building rich, interactive client user\\ninterfaces.\\n\\nHTML\\n\\nHTML is the standard\", \" markup language used to create web pages and web applications. Its elements\\nform the building block\", \"s of pages, representing formatted text, images, form inputs, and other\\nstructures. When a browser m\", \"akes a request to a URL, whether fetching a page or an application, the\\nfirst thing that is returned\", \" is an HTML document. This HTML document may reference or include\\nadditional information about its l\", \"ook and layout in the form of CSS, or behavior in the form of\\nJavaScript.\\n\\nCSS\\n\\nCSS (Cascading Style\", \" Sheets) is used to control the look and layout of HTML elements. CSS styles can\\nbe applied directly\", \" to an HTML element, defined separately on the same page, or defined ina\\nseparate file and reference\", \"d by the page. Styles cascade based on how they are used to select a given\\nHTML element. For instanc\", \"e, a style might apply to an entire document, but would be overridden by a\\n\\n36 CHAPTER 5 | Common cl\", \"ient-side web technologies\\nstyle that applied to a particular element. Likewise, an element-specific\", \" style would be overridden by a\\nstyle that applied to a CSS class that was applied to the element, w\", \"hich in turn would be overridden\\nby a style targeting a specific instance of that element (via its I\", \"D). Figure 6-1\\n\\nCSS Specificity\\n\\n\\u00a2 Least specific; applies most broadly\\n\\n\\u00a2 Applies to all elements t\", \"he CSS class as been applied to\\n\\u00a2 Elements can have multiple classes applied to them\\n\\n\\u00a2 References a\", \" unique HTML element via its ID\\n\\n\\u00a2 Most specific\\nStyle \\u00ab Added to HTML element directly\\n\\nAttribute\\n\\n\", \"* Attribute and pseudo-class selectors also apply at this level\\n\\nFigure 6-1. CSS Specificity rules, \", \"in order.\\n\\nIt's best to keep styles in their own separate stylesheet files, and to use selection-bas\", \"ed cascading to\\nimplement consistent and reusable styles within the application. Placing style rules\", \" within HTML\\nshould be avoided, and applying styles to specific individual elements (rather than who\", \"le classes of\\nelements, or elements that have had a particular CSS class applied to them) should be \", \"the exception,\\nnot the rule.\\n\\nCSS preprocessors\\n\\nCSS stylesheets lack support for conditional logic,\", \" variables, and other programming language\\nfeatures. Thus, large stylesheets often include quite a b\", \"it of repetition, as the same color, font, or other\\nsetting is applied to many different variations \", \"of HTML elements and CSS classes. CSS preprocessors\\ncan help your stylesheets follow the DRY princip\", \"le by adding support for variables and logic.\\n\\nThe most popular CSS preprocessors are Sass and LESS.\", \" Both extend CSS and are backward\\ncompatible with it, meaning that a plain CSS file is a valid Sass \", \"or LESS file. Sass is Ruby-based and\\nLESS is JavaScript based, and both typically run as part of you\", \"r local development process. Both have\\ncommand-line tools available, as well as built-in support in \", \"Visual Studio for running them using Gulp\\nor Grunt tasks.\\n\\n37 CHAPTER 5 | Common client-side web tec\", \"hnologies\\nJavaScript\\n\\nJavaScript is a dynamic, interpreted programming language that has been standa\", \"rdized in the\\nECMAScript language specification. It is the programming language of the web. Like CSS\", \", JavaScript\\ncan be defined as attributes within HTML elements, as blocks of script within a page, o\", \"r in separate\\nfiles. Just like CSS, it's recommended to organize JavaScript into separate files, kee\", \"ping it separated as\\nmuch as possible from the HTML found on individual web pages or application vie\", \"ws.\\n\\nWhen working with JavaScript in your web application, there are a few tasks that you'll commonl\", \"y\\nneed to perform:\\n\\n. Selecting an HTML element and retrieving and/or updating its value.\\n\\n. Queryin\", \"g a Web API for data.\\n\\n. Sending a command to a Web API (and responding to a callback with its resul\", \"t).\\n. Performing validation.\\n\\nYou can perform all of these tasks with JavaScript alone, but many lib\", \"raries exist to make these tasks\\neasier. One of the first and most successful of these libraries is \", \"JQuery, which continues to be a\\npopular choice for simplifying these tasks on web pages. For Single \", \"Page Applications (SPAs), jQuery\\ndoesn't provide many of the desired features that Angular and React\", \" offer.\\n\\nLegacy web apps with jQuery\\n\\nAlthough ancient by JavaScript framework standards, jQuery con\", \"tinues to be a commonly used library\\nfor working with HTML/CSS and building applications that make A\", \"JAX calls to web APIs. However,\\njQuery operates at the level of the browser document object model (D\", \"OM), and by default offers only\\nan imperative, rather than declarative, model.\\n\\nFor example, imagine\", \" that if a textbox's value exceeds 10, an element on the page should be made\\nvisible. In jQuery, thi\", \"s functionality would typically be implemented by writing an event handler with\\ncode that would insp\", \"ect the textbox\\u2019s value and set the visibility of the target element based on that\\nvalue. This proce\", \"ss is an imperative, code-based approach. Another framework might instead use\\ndatabinding to bind th\", \"e visibility of the element to the value of the textbox declaratively. This\\napproach would not requi\", \"re writing any code, but instead only requires decorating the elements\\ninvolved with data binding at\", \"tributes. As client-side behaviors grow more complex, data binding\\napproaches frequently result in s\", \"impler solutions with less code and conditional complexity.\\n\\nJQuery vs a SPA Framework\\n\\nFactor\\nAbstr\", \"acts the DOM\\nAJAX Support\\n\\nDeclarative Data Binding\\n\\nMVC-style Routing\\n\\n38 CHAPTER 5 | Common client\", \"-side web technologies\\nFactor\\n\\nTemplating\\n\\nDeep-Link Routing\\n\\nMost of the features jQuery lacks intr\", \"insically can be added with the addition of other libraries.\\nHowever, a SPA framework like Angular p\", \"rovides these features in a more integrated fashion, since it's\\nbeen designed with all of them in mi\", \"nd from the start. Also, jQuery is an imperative library, meaning\\nthat you need to call jQuery funct\", \"ions in order to do anything with jQuery. Much of the work and\\nfunctionality that SPA frameworks pro\", \"vide can be done declaratively, requiring no actual code to be\\nwritten.\\n\\nData binding is a great exa\", \"mple of this functionality. In jQuery, it usually only takes one line of code to\\nget the value of a \", \"DOM element or to set an element's value. However, you have to write this code\\nanytime you need to c\", \"hange the value of the element, and sometimes this will occur in multiple\\nfunctions on a page. Anoth\", \"er common example is element visibility. In jQuery, there might be many\\ndifferent places where you'd\", \" write code to control whether certain elements were visible. In each of\\nthese cases, when using dat\", \"a binding, no code would need to be written. You'd simply bind the value\\nor visibility of the elemen\", \"ts in question to a viewmodel on the page, and changes to that viewmodel\\nwould automatically be refl\", \"ected in the bound elements.\\n\\nAngular SPAs\\n\\nAngular remains one of the world\\u2019s most popular JavaScri\", \"pt frameworks. Since Angular 2, the team\\nrebuilt the framework from the ground up (using TypeScript)\", \" and rebranded from the original\\nAngularJS name to Angular. Now several years old, the redesigned An\", \"gular continues to be a robust\\nframework for building Single Page Applications.\\n\\nAngular application\", \"s are built from components. Components combine HTML templates with special\\nobjects and control a po\", \"rtion of the page. A simple component from Angular\\u2019s docs is shown here:\\n\\nimport { Component } from \", \"\\u2018@angular/core' ;\\n\\n@Component ({\\nselector: \\u2018my-app',\\ntemplate: ~<h1i>Hello {{name}}</h1>-\\n\\n})\\n\\nexpor\", \"t class AppComponent { name = 'Angular'; }\\n\\nComponents are defined using the @Component decorator fu\", \"nction, which takes in metadata about\\nthe component. The selector property identifies the ID of the \", \"element on the page where this\\ncomponent will be displayed. The template property is a simple HTML t\", \"emplate that includes a\\nplaceholder that corresponds to the component's name property, defined on th\", \"e last line.\\n\\nBy working with components and templates, instead of DOM elements, Angular apps can op\", \"erate at a\\nhigher level of abstraction and with less overall code than apps written using just JavaS\", \"cript (also\\ncalled \\u201cvanilla JS\\\") or with jQuery. Angular also imposes some order on how you organize\", \" your client-\\nside script files. By convention, Angular apps use a common folder structure, with mod\", \"ule and\\n\\n39 CHAPTER 5 | Common client-side web technologies\\ncomponent script files located in an app\", \" folder. Angular scripts concerned with building, deploying,\\nand testing the app are typically locat\", \"ed in a higher-level folder.\\n\\nYou can develop Angular apps by using a CLI. Getting started with Angu\", \"lar development locally\\n(assuming you already have git and npm installed) consists of simply cloning\", \" a repo from GitHub and\\nrunning npm install and npm start. Beyond this, Angular ships its own CLI, w\", \"hich can create projects,\\nadd files, and assist with testing, bundling, and deployment tasks. This C\", \"LI friendliness makes Angular\\nespecially compatible with ASP.NET Core, which also features great CLI\", \" support.\\n\\nMicrosoft has developed a reference application, eShopOnContainers, which includes an Ang\", \"ular SPA\\nimplementation. This app includes Angular modules to manage the online store\\u2019s shopping bas\", \"ket,\\nload and display items from its catalog, and handling order creation. You can view and download\", \" the\\nsample application from GitHub.\\n\\nReact\\n\\nUnlike Angular, which offers a full Model-View-Controll\", \"er pattern implementation, React is only\\nconcerned with views. It's not a framework, just a library,\", \" so to build a SPA you'll need to leverage\\nadditional libraries. There are a number of libraries tha\", \"t are designed to be used with React to\\nproduce rich single page applications.\\n\\nOne of React's most \", \"important features is its use of a virtual DOM. The virtual DOM provides React\\nwith several advantag\", \"es, including performance (the virtual DOM can optimize which parts of the\\nactual DOM need to be upd\", \"ated) and testability (no need to have a browser to test React and its\\ninteractions with its virtual\", \" DOM).\\n\\nReact is also unusual in how it works with HTML. Rather than having a strict separation betw\", \"een code\\nand markup (with references to JavaScript appearing in HTML attributes perhaps), React adds\", \" HTML\\ndirectly within its JavaScript code as JSX. JSX is HTML-like syntax that can compile down to p\", \"ure\\nJavaScript. For example:\\n\\n<ul>\\n{ authors.map(author =>\\n\\n<li key={author.id}>{author.name}</1li>\\n\", \"\\nIf you already know JavaScript, learning React should be easy. There isn\\u2019t nearly as much learning\\n\", \"curve or special syntax involved as with Angular or other popular libraries.\\n\\nBecause React isn\\u2019t a \", \"full framework, you'll typically want other libraries to handle things like routing,\\nweb API calls, \", \"and dependency management. The nice thing is, you can pick the best library for each\\nof these, but t\", \"he disadvantage is that you need to make all of these decisions and verify all of your\\n\\nchosen libra\", \"ries work well together when you're done. If you want a good starting point, you can use\\na starter k\", \"it like React Slingshot, which prepackages a set of compatible libraries together with React.\\n\\nVue\\n\\n\", \"From its getting started guide, \\u201cVue is a progressive framework for building user interfaces. Unlike\", \"\\nother monolithic frameworks, Vue is designed from the ground up to be incrementally adoptable. The\\n\", \"\\n40 CHAPTER 5 | Common client-side web technologies\\ncore library is focused on the view layer only, \", \"and is easy to pick up and integrate with other libraries\\nor existing projects. On the other hand, V\", \"ue is perfectly capable of powering sophisticated Single-\\nPage Applications when used in combination\", \" with modern tooling and supporting libraries.\\u201d\\n\\nGetting started with Vue simply requires including \", \"its script within an HTML file:\\n\\n<!-- development version, includes helpful console warnings -->\\n<sc\", \"ript src=\\\"https://cdn.jsdelivr.net/npm/vue/dist/vue.js\\\"></script>\\nWith the framework added, you\\u2019re t\", \"hen able to declaratively render data to the DOM using\\nVue\\u2019s straightforward templating syntax:\\n<div\", \" id=\\\"app\\\">\\n{{ message }}\\n</div>\\n\\nand then adding the following script:\\nvar app = new Vue({\\nel: \\u2018#app\", \"',\\ndata: {\\nmessage: \\u2018Hello Vue!'\\n\\n}\\n})\\n\\nThis is enough to render \\\"Hello Vue!\\\" on the page. Note, how\", \"ever, that Vue isn\\u2019t simply rendering the\\nmessage to the div once. It supports databinding and dynam\", \"ic updates such that if the value of\\nmessage changes, the value in the <div> is immediately updated \", \"to reflect it.\\n\\nOf course, this only scratches the surface of what Vue is capable of. It\\u2019s gained a \", \"great deal of\\npopularity in the last several years and has a large community. There\\u2019s a huge and gro\", \"wing list of\\nsupporting components and libraries that work with Vue to extend it as well. If you're \", \"looking to add\\nclient-side behavior to your web application or considering building a full SPA, Vue \", \"is worth\\ninvestigating.\\n\\nBlazor WebAssembly\\n\\nUnlike other JavaScript frameworks, Blazor WebAssembly \", \"is a single-page app (SPA) framework for\\nbuilding interactive client-side web apps with .NET. Blazor\", \" WebAssembly uses open web standards\\nwithout plugins or recompiling code into other languages. Blazo\", \"r WebAssembly works in all modern\\nweb browsers, including mobile browsers.\\n\\nRunning .NET code inside\", \" web browsers is made possible by WebAssembly (abbreviated wasm).\\nWebAssembly is a compact bytecode \", \"format optimized for fast download and maximum execution\\nspeed. WebAssembly is an open web standard \", \"and is supported in web browsers without plugins.\\n\\nWebAssembly code can access the full functionalit\", \"y of the browser via JavaScript, called JavaScript\\ninteroperability, often shortened to JavaScript i\", \"nterop or JS interop. .NET code executed via\\nWebAssembly in the browser runs in the browser's JavaSc\", \"ript sandbox with the protections that the\\nsandbox provides against malicious actions on the client \", \"machine.\\n\\nFor more information, see Introduction to ASP.NET Core Blazor.\\n\\nChoosing a SPA Framework\\n\\n\", \"When considering which option will work best to support your SPA, keep in mind the following\\nconside\", \"rations:\\n\\nA1 CHAPTER 5 | Common client-side web technologies\\nIs your team familiar with the framewor\", \"k and its dependencies (including TypeScript in some\\ncases)?\\n\\nHow opinionated is the framework, and \", \"do you agree with its default way of doing things?\\nDoes it (or a companion library) include all of t\", \"he features your app requires?\\n\\nIs it well documented?\\n\\nHow active is its community? Are new project\", \"s being built with it?\\n\\nHow active is its core team? Are issues being resolved and new versions ship\", \"ped regularly?\\n\\nFrameworks continue to evolve with breakneck speed. Use the considerations listed ab\", \"ove to help\\n\\nmitigate the risk of choosing a framework you'll later regret being dependent upon. If \", \"you're\\n\\nparticularly risk-averse, consider a framework that offers commercial support and/or is bein\", \"g\\ndeveloped by a large enterprise.\\n\\nReferences \\u2014 Client Web Technologies\\n\\n42\\n\\nHTML and CSS\\n\\nhttps://\", \"www.w3.org/standards/webdesign/htmlcss\\n\\nSass vs. LESS\\n\\nhttps://www.keycdn.com/blog/sass-vs-less/\\n\\nSt\", \"yling ASP.NET Core Apps with LESS, Sass, and Font Awesome\\nhttps://learn.microsoft.com/aspnet/core/cl\", \"ient-side/less-sass-fa\\nClient-Side Development in ASP.NET Core\\nhttps://learn.microsoft.com/aspnet/co\", \"re/client-side/\\n\\njQuery\\n\\nhttps://iquery.com/\\n\\nAngular\\n\\nhttps://angular.io/\\n\\nReact\\n\\nhttps://reactjs.o\", \"rg/\\n\\nVue\\n\\nhttps://vuejs.org/\\n\\nAngular vs React vs Vue: Which Framework to Choose in 2020\\nhttps://www\", \".codeinwp.com/blog/angular-vs-vue-vs-react/\\n\\nThe Top JavaScript Frameworks for Front-End Development\", \" in 2020\\n\\nfra meworks- 2019/\\n\\nCHAPTER 5 | Common client-side web technologies\\nCHAPTER\\n\\nDevelop ASP.N\", \"ET Core\\nMVC apps\\n\\n\\u201cIt's not important to get it right the first time. It\\u2019s vitally important to get \", \"it right the last time.\\u201d -\\nAndrew Hunt and David Thomas\\n\\nASP.NET Core is a cross-platform, open-sour\", \"ce framework for building modern cloud-optimized web\\napplications. ASP.NET Core apps are lightweight\", \" and modular, with built-in support for dependency\\ninjection, enabling greater testability and maint\", \"ainability. Combined with MVC, which supports\\nbuilding modern web APIs in addition to view-based app\", \"s, ASP.NET Core is a powerful framework\\nwith which to build enterprise web applications.\\n\\nMVC and Ra\", \"zor Pages\\n\\nASP.NET Core MVC offers many features that are useful for building web-based APIs and app\", \"s. The\\nterm MVC stands for \\u201cModel-View-Controller\\u201d, a Ul pattern that breaks up the responsibilities\", \" of\\nresponding to user requests into several parts. In addition to following this pattern, you can a\", \"lso\\nimplement features in your ASP.NET Core apps as Razor Pages.\\n\\nRazor Pages are built into ASP.NET\", \" Core MVC, and use the same features for routing, model binding,\\nfilters, authorization, etc. Howeve\", \"r, instead of having separate folders and files for Controllers, Models,\\nViews, etc. and using attri\", \"bute-based routing, Razor Pages are placed in a single folder (\\\"/Pages\\u2019),\\nroute based on their relat\", \"ive location in this folder, and handle requests with handlers instead of\\ncontroller actions. As a r\", \"esult, when working with Razor Pages, all of the files and classes you need are\\ntypically colocated,\", \" not spread throughout the web project.\\n\\nLearn more about how MVC, Razor Pages, and related patterns\", \" are applied in the eshopOnWeb\\nsample application.\\n\\nWhen you create a new ASP.NET Core App, you shou\", \"ld have a plan in mind for the kind of app you\\nwant to build. When creating a new project, in your I\", \"DE or using the dotnet new CLI command, you\\nwill choose from several templates. The most common proj\", \"ect templates are Empty, Web API, Web\\nApp, and Web App (Model-View-Controller). Although you can onl\", \"y make this decision when you first\\ncreate a project, it\\u2019s not an irrevocable decision. The Web API \", \"project uses standard Model-View-\\nController controllers \\u2014 it just lacks Views by default. Likewise,\", \" the default Web App template uses\\nRazor Pages, and so also lacks a Views folder. You can add a View\", \"s folder to these projects later to\\nsupport view-based behavior. Web API and Model-View-Controller p\", \"rojects don't include a Pages\\n\\n43 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nfolder by default, but y\", \"ou can add one later to support Razor Pages-based behavior. You can think of\\nthese three templates a\", \"s supporting three different kinds of default user interaction: data (web API),\\npage-based, and view\", \"-based. However, you can mix and match any or all of these templates within a\\nsingle project if you \", \"wish.\\n\\nWhy Razor Pages?\\n\\nRazor Pages Is the default approach for new web applications in Visual Stud\", \"io. Razor Pages offers a\\nsimpler way of building page-based application features, such as non-SPA fo\", \"rms. Using controllers\\nand views, it was common for applications to have very large controllers that\", \" worked with many\\ndifferent dependencies and view models and returned many different views. This res\", \"ulted in more\\ncomplexity and often resulted in controllers that didn\\u2019t follow the Single Responsibil\", \"ity Principle or\\nOpen/Closed Principles effectively. Razor Pages addresses this issue by encapsulati\", \"ng the server-side\\nlogic for a given logical \\u201cpage\\u201d in a web application with its Razor markup. A Ra\", \"zor Page that has no\\nserver-side logic can only consist of a Razor file (for instance, \\u201cIndex.cshtml\", \"\\u201d). However, most non-\\ntrivial Razor Pages will have an associated page model class, which by conven\", \"tion is named the same\\nas the Razor file with a \\u201c.cs\\u201d extension (for example, \\u201cIndex.cshtml.cs\\u201d).\\n\\nA\", \" Razor Page's page model combines the responsibilities of an MVC controller and a viewmodel.\\nInstead\", \" of handling requests with controller action methods, page model handlers like \\u201cOnGet()\\u201d are\\nexecute\", \"d, rendering their associated page by default. Razor Pages simplifies the process of building\\nindivi\", \"dual pages in an ASP.NET Core app, while still providing all the architectural features of ASP.NET\\nC\", \"ore MVC. They're a good default choice for new page-based functionality.\\n\\nWhen to use MVC\\n\\nIf you're\", \" building web APIs, the MVC pattern makes more sense than trying to use Razor Pages. If your\\nproject\", \" will only expose web API endpoints, you should ideally start from the Web API project\\ntemplate. Oth\", \"erwise, it's easy to add controllers and associated API endpoints to any ASP.NET Core\\napp. Use the v\", \"iew-based MVC approach if you're migrating an existing application from ASP.NET MVC\\n5 or earlier to \", \"ASP.NET Core MVC and you want to do so with the least amount of effort. Once you've\\nmade the initial\", \" migration, you can evaluate whether it makes sense to adopt Razor Pages for new\\nfeatures or even as\", \" a wholesale migration. For more information about porting .NET 4.x apps to .NET\\n\\n8, see Porting Exi\", \"sting ASP.NET Apps to ASP.NET Core eBook.\\n\\nWhether you choose to build your web app using Razor Page\", \"s or MVC views, your app will have\\nsimilar performance and will include support for dependency injec\", \"tion, filters, model binding,\\nvalidation, and so on.\\n\\nMapping requests to responses\\n\\nAt its heart, A\", \"SP.NET Core apps map incoming requests to outgoing responses. At a low level, this\\nmapping is done w\", \"ith middleware, and simple ASP.NET Core apps and microservices may be\\ncomprised solely of custom mid\", \"dleware. When using ASP.NET Core MVC, you can work at a\\nsomewhat higher level, thinking in terms of \", \"routes, controllers, and actions. Each incoming request is\\ncompared with the application's routing t\", \"able, and if a matching route is found, the associated action\\n\\n44 CHAPTER 6 | Develop ASP.NET Core M\", \"VC apps\\nmethod (belonging to a controller) is called to handle the request. If no matching route is \", \"found, an\\nerror handler (in this case, returning a NotFound result) is called.\\n\\nASP.NET Core MVC app\", \"s can use conventional routes, attribute routes, or both. Conventional routes\\nare defined in code, s\", \"pecifying routing conventions using syntax like in the example below:\\n\\napp.UseEndpoints(endpoints =>\", \"\\n\\nendpoints .MapControllerRoute(name: \\\"default\\\", pattern:\\n\\\"{controller=Home}/{action=Index}/{id?}\\\");\", \"\\n})3\\n\\nIn this example, a route named \\u201cdefault\\u201d has been added to the routing table. It defines a rou\", \"te\\ntemplate with placeholders for controller, action, and id. The controller and action placeholders\", \" have\\nthe default specified (Home and Index, respectively), and the id placeholder is optional (by v\", \"irtue of a\\n\\\"2\\\" applied to it). The convention defined here states that the first part of a request s\", \"hould correspond\\nto the name of the controller, the second part to the action, and then if necessary\", \" a third part will\\nrepresent an ID parameter. Conventional routes are typically defined in one place\", \" for the application,\\nsuch as in Program.cs where the request middleware pipeline is configured.\\n\\nAt\", \"tribute routes are applied to controllers and actions directly, rather than specified globally. This\", \"\\napproach has the advantage of making them much more discoverable when you're looking at a\\nparticula\", \"r method, but does mean that routing information is not kept in one place in the application.\\nWith a\", \"ttribute routes, you can easily specify multiple routes for a given action, as well as combine\\nroute\", \"s between controllers and actions. For example:\\n\\n[Route( \\\"Home\\\" ) |\\npublic class HomeController : Co\", \"ntroller\\n\\n[Route(\\\"\\\")] // Combines to define the route template \\\"Home\\\"\\n\\n[Route(\\\"Index\\\")] // Combines \", \"to define route template \\\"Home/Index\\\"\\n[Route(\\\"/\\\")] // Does not combine, defines the route template \\\"\", \"\\\"\\npublic IActionResult Index() {}\\n\\nRoutes can be specified on [HttpGet] and similar attributes, avoi\", \"ding the need to add separate [Route]\\nattributes. Attribute routes can also use tokens to reduce the\", \" need to repeat controller or action\\nnames, as shown below:\\n\\n[Route(\\\"[ controller ]\\\") ]\\n\\npublic clas\", \"s ProductsController : Controller\\n\\n{\\n[Route(\\\"\\\")] // Matches \\u2018Products'\\n[Route(\\\"Index\\\")] // Matches '\", \"Products/Index'\\npublic IActionResult Index() {}\\n\\nRazor Pages don\\u2019t use attribute routing. You can sp\", \"ecify additional route template information for a\\nRazor Page as part of its @page directive:\\n\\n@page \", \"\\\"{id:int}\\\"\\n\\n45 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nIn the previous example, the page in questi\", \"on would match a route with an integer id parameter. For\\nexample, the Products.cshtml page located i\", \"n the root of /Pages would respond to requests like this\\none:\\n\\n/Products/123\\n\\nOnce a given request h\", \"as been matched to a route, but before the action method is called, ASP.NET\\nCore MVC will perform mo\", \"del binding and model validation on the request. Model binding is\\nresponsible for converting incomin\", \"g HTTP data into the .NET types specified as parameters of the\\naction method to be called. For examp\", \"le, if the action method expects an int id parameter, model\\nbinding will attempt to provide this par\", \"ameter from a value provided as part of the request. To do so,\\nmodel binding looks for values in a p\", \"osted form, values in the route itself, and query string values.\\nAssuming an id value is found, it w\", \"ill be converted to an integer before being passed into the action\\nmethod.\\n\\nAfter binding the model \", \"but before calling the action method, model validation occurs. Model\\nvalidation uses optional attrib\", \"utes on the model type, and can help ensure that the provided model\\nobject conforms to certain data \", \"requirements. Certain values may be specified as required, or limited\\nto a certain length or numeric\", \" range, etc. If validation attributes are specified but the model does not\\nconform to their requirem\", \"ents, the property ModelState.IsValid will be false, and the set of failing\\nvalidation rules will be\", \" available to send to the client making the request.\\n\\nIf you're using model validation, you should b\", \"e sure to always check that the model is valid before\\nperforming any state-altering commands, to ens\", \"ure your app is not corrupted by invalid data. You can\\nuse a filter to avoid the need to add code fo\", \"r this validation in every action. ASP.NET Core MVC filters\\noffer a way of intercepting groups of re\", \"quests, so that common policies and cross-cutting concerns\\ncan be applied on a targeted basis. Filte\", \"rs can be applied to individual actions, whole controllers, or\\nglobally for an application.\\n\\nFor web\", \" APIs, ASP.NET Core MVC supports content negotiation, allowing requests to specify how\\nresponses sho\", \"uld be formatted. Based on headers provided in the request, actions returning data will\\nformat the r\", \"esponse in XML, JSON, or another supported format. This feature enables the same API to\\nbe used by m\", \"ultiple clients with different data format requirements.\\n\\nWeb API projects should consider using the\", \" [ApiController] attribute, which can be applied to\\nindividual controllers, to a base controller cla\", \"ss, or to the entire assembly. This attribute adds\\nautomatic model validation checking and any actio\", \"n with an invalid model will return a BadRequest\\nwith the details of the validation errors. The attr\", \"ibute also requires all actions have an attribute route,\\nrather than using a conventional route, and\", \" returns more detailed ProblemDetails information in\\nresponse to errors.\\n\\nKeeping controllers under \", \"control\\n\\nFor page-based applications, Razor Pages do a great job of keeping controllers from getting\", \" too\\nlarge. Each individual page is given its own files and classes dedicated just to its handler(s)\", \". Prior to\\nthe introduction of Razor Pages, many view-centric applications would have large controll\", \"er classes\\nresponsible for many different actions and views. These classes would naturally grow to h\", \"ave many\\nresponsibilities and dependencies, making them harder to maintain. If you find your view-ba\", \"sed\\n\\n46 CHAPTER 6 | Develop ASP.NET Core MVC apps\\ncontrollers are growing too large, consider refact\", \"oring them to use Razor Pages, or introducing a\\npattern like a mediator.\\n\\nThe mediator design patter\", \"n is used to reduce coupling between classes while allowing\\ncommunication between them. In ASP.NET C\", \"ore MVC applications, this pattern is frequently employed\\nto break up controllers into smaller piece\", \"s by using handlers to do the work of action methods. The\\npopular MediatR NuGet package is often use\", \"d to accomplish this. Typically, controllers include many\\ndifferent action methods, each of which ma\", \"y require certain dependencies. The set of all\\ndependencies required by any action must be passed in\", \"to the controller's constructor. When using\\nMediatR, the only dependency a controller will typically\", \" have is an instance of the mediator. Each\\naction then uses the mediator instance to send a message,\", \" which is processed by a handler. The\\nhandler is specific to a single action and thus only needs the\", \" dependencies required by that action. An\\nexample of a controller using MediatR is shown here:\\n\\npubl\", \"ic class OrderController : Controller\\n\\n{\\n\\nprivate readonly IMediator _mediator;\\n\\npublic OrderControl\", \"ler(IMediator mediator)\\n\\nt\\n}\\n\\n[HttpGet |\\npublic async Task<IActionResult> MyOrders()\\n{\\n\\n_mediator = \", \"mediator;\\n\\nvar viewModel = await _mediator.Send(new GetMyOrders(User.Identity.Name) ) ;\\nreturn View(\", \"viewModel1) ;\\n\\n}\\n\\n// other actions implemented similarly\\n\\nIn the MyOrders action, the call to Send a\", \" GetMyOrders message is handled by this class:\\n\\npublic class GetMyOrdersHandler : IRequestHandler<Ge\", \"tMyOrders, IEnumerable<OrderViewModel >>\\n{\\n\\nprivate readonly IOrderRepository _orderRepository ;\\npub\", \"lic GetMyOrdersHandler(IOrderRepository orderRepository )\\n\\nt\\n}\\n\\n_orderRepository = orderRepository ;\", \"\\n\\npublic async Task<IEnumerable<OrderViewModel>> Handle(GetMyOrders request,\\nCancellationToken cance\", \"llationToken)\\n{\\nvar specification = new CustomerOrdersWithItemsSpecification(request.UserName) ;\\nvar\", \" orders = await _orderRepository.ListAsync(specification) ;\\nreturn orders.Select(o => new OrderViewM\", \"odel\\n{\\nOrderDate = o.OrderDate,\\nOrderItems = o.OrderItems?.Select(oi => new OrderItemViewModel ( )\\n{\", \"\\nPictureUrl = oi.ItemOrdered.PictureUri,\\nProductId = oi.ItemOrdered.CatalogItemId,\\nProductName = oi.\", \"ItemOrdered.ProductName,\\nUnitPrice = 01.UnitPrice,\\nUnits = 01i.Units\\n\\n47 CHAPTER 6 | Develop ASP.NET\", \" Core MVC apps\\n}).ToList(),\\nOrderNumber = o.Id,\\nShippingAddress = o.ShipToAddress,\\nTotal = o.Total()\", \"\\n\\nThe end result of this approach is for controllers to be much smaller and focused primarily on rou\", \"ting\\nand model binding, while individual handlers are responsible for the specific tasks needed by a\", \" given\\nendpoint. This approach can also be achieved without MediatR by using the ApiEndpoints NuGet\\n\", \"package, which attempts to bring to API controllers the same benefits Razor Pages brings to view-\\nba\", \"sed controllers.\\n\\nReferences \\u2014 Mapping Requests to Responses\\n\\n. Routing to Controller Actions\\nhttps:\", \"//learn.microsoft.com/aspnet/core/mvc/controllers/routing\\n\\n. Model Binding\\nhttps://learn.microsoft.c\", \"om/aspnet/core/mvc/models/model-binding\\n\\n\\u00b0 Model Validation\\nhttps://learn.microsoft.com/aspnet/core/\", \"mvc/models/validation\\n\\n\\u00b0 Filters\\nhttps://learn.microsoft.com/aspnet/core/mvc/controllers/filters\\n\\n. \", \"ApiController Attribute\\nhttps://learn.microsoft.com/aspnet/core/web-api/\\n\\nWorking with dependencies\\n\", \"\\nASP.NET Core has built-in support for and internally makes use of a technique known as dependency\\ni\", \"njection. Dependency injection is a technique that enables loose coupling between different parts of\", \"\\nan application. Looser coupling is desirable because it makes it easier to isolate parts of the\\napp\", \"lication, allowing for testing or replacement. It also makes it less likely that a change in one par\", \"t of\\nthe application will have an unexpected impact somewhere else in the application. Dependency\\nin\", \"jection is based on the dependency inversion principle, and is often key to achieving the\\nopen/close\", \"d principle. When evaluating how your application works with its dependencies, beware of\\nthe static \", \"cling code smell, and remember the aphorism \\u201cnew is glue.\\u201d\\n\\nStatic cling occurs when your classes ma\", \"ke calls to static methods, or access static properties, which\\nhave side effects or dependencies on \", \"infrastructure. For example, if you have a method that calls a\\nstatic method, which in turn writes t\", \"o a database, your method is tightly coupled to the database.\\nAnything that breaks that database cal\", \"l will break your method. Testing such methods is notoriously\\ndifficult, since such tests either req\", \"uire commercial mocking libraries to mock the static calls, or can\\nonly be tested with a test databa\", \"se in place. Static calls that don't have any dependence on\\ninfrastructure, especially those calls t\", \"hat are completely stateless, are fine to call and have no impact\\non coupling or testability (beyond\", \" coupling code to the static call itself).\\n\\n48 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nMany develo\", \"pers understand the risks of static cling and global state, but will still tightly couple their\\ncode\", \" to specific implementations through direct instantiation. \\u201cNew is glue\\u201d is meant to be a reminder\\no\", \"f this coupling, and not a general condemnation of the use of the new keyword. Just as with static\\nm\", \"ethod calls, new instances of types that have no external dependencies typically do not tightly\\ncoup\", \"le code to implementation details or make testing more difficult. But each time a class is\\ninstantia\", \"ted, take just a brief moment to consider whether it makes sense to hard-code that specific\\ninstance\", \" in that particular location, or if it would be a better design to request that instance as a\\ndepend\", \"ency.\\n\\nDeclare your dependencies\\n\\nASP.NET Core is built around having methods and classes declare th\", \"eir dependencies, requesting\\nthem as arguments. ASP.NET applications are typically set up in Program\", \".cs or in a Startup class.\\n\\nNote\\n\\nConfiguring apps completely in Program.cs is the default approach \", \"for .NET 6 (and later) and Visual\\n\\nStudio 2022 apps. Project templates have been updated to help you\", \" get started with this new\\napproach. ASP.NET Core projects can still use a Startup class, if desired\", \".\\n\\nConfigure services in Program.cs\\n\\nFor very simple apps, you can wire up dependencies directly in \", \"Program.cs file using a\\nWebApplicationBuilder. Once all needed services have been added, the builder\", \" is used to create the\\n\\napp.\\nvar builder = WebApplication.CreateBuilder(args) ;\\n\\n// Add services to \", \"the container.\\nbuilder.Services.AddRazorPages() ;\\n\\nvar app = builder.Build();\\n\\nConfigure services in\", \" Startup.cs\\n\\nThe Startup.cs is itself configured to support dependency injection at several points. \", \"If you're using a\\nStartup class, you can give it a constructor and it can request dependencies throu\", \"gh it, like so:\\n\\npublic class Startup\\n\\npublic Startup(IHostingEnvironment env)\\n\\n{\\n\\nvar builder = new\", \" ConfigurationBuilder()\\n.SetBasePath(env.ContentRootPath)\\n.AddJsonFile(\\\"appsettings.json\\\", optional:\", \" false, reloadOnChange: true)\\n.AddjJsonFile($\\\"appsettings.{env.EnvironmentName}.json\\\", optional: tru\", \"e) ;\\n\\nThe Startup class is interesting in that there are no explicit type requirements for it. It do\", \"esn\\u2019t inherit\\nfrom a special Startup base class, nor does it implement any particular interface. You\", \" can give it a\\nconstructor, or not, and you can specify as many parameters on the constructor as you\", \" want. When\\n\\n49 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nthe web host you've configured for your ap\", \"plication starts, it will call the Startup class (if you've told it\\nto use one), and will use depend\", \"ency injection to populate any dependencies the Startup class\\nrequires. Of course, if you request pa\", \"rameters that aren't configured in the services container used by\\nASP.NET Core, you'll get an except\", \"ion, but as long as you stick to dependencies the container knows\\nabout, you can request anything yo\", \"u want.\\n\\nDependency injection is built into your ASP.NET Core apps right from the start, when you cr\", \"eate the\\nStartup instance. It doesn\\u2019t stop there for the Startup class. You can also request depende\", \"ncies in the\\nConfigure method:\\n\\npublic void Configure(IApplicationBuilder app,\\nIHostingEnvironment e\", \"nv,\\nILoggerFactory loggerFactory)\\n\\nThe ConfigureServices method Is the exception to this behavior; i\", \"t must take just one parameter of\\ntype |IServiceCollection. It doesn't really need to support depend\", \"ency injection, since on the one hand\\nit is responsible for adding objects to the services container\", \", and on the other it has access to all\\ncurrently configured services via the IServiceCollection par\", \"ameter. Thus, you can work with\\ndependencies defined in the ASP.NET Core services collection in ever\", \"y part of the Startup class, either\\nby requesting the needed service as a parameter or by working wi\", \"th the IServiceCollection in\\nConfigureServices.\\n\\nNote\\n\\nIf you need to ensure certain services are av\", \"ailable to your Startup class, you can configure them using\\nan |WebHostBuilder and its ConfigureServ\", \"ices method inside the CreateDefaultBuilder call.\\n\\nThe Startup class is a model for how you should s\", \"tructure other parts of your ASP.NET Core\\napplication, from Controllers to Middleware to Filters to \", \"your own Services. In each case, you should\\nfollow the Explicit Dependencies Principle, requesting y\", \"our dependencies rather than directly creating\\nthem, and leveraging dependency injection throughout \", \"your application. Be careful of where and how\\nyou directly instantiate implementations, especially s\", \"ervices and objects that work with infrastructure\\nor have side effects. Prefer working with abstract\", \"ions defined in your application core and passed in as\\narguments to hardcoding references to specifi\", \"c implementation types.\\n\\nStructuring the application\\n\\nMonolithic applications typically have a singl\", \"e entry point. In the case of an ASP.NET Core web\\napplication, the entry point will be the ASP.NET C\", \"ore web project. However, that doesn't mean the\\nsolution should consist of just a single project. It\", \"'s useful to break up the application into different\\nlayers in order to follow separation of concern\", \"s. Once broken up into layers, it's helpful to go beyond\\nfolders to separate projects, which can hel\", \"p achieve better encapsulation. The best approach to\\nachieve these goals with an ASP.NET Core applic\", \"ation is a variation of the Clean Architecture\\ndiscussed in chapter 5. Following this approach, the \", \"application\\u2019s solution will comprise separate\\nlibraries for the UI, Infrastructure, and ApplicationC\", \"ore.\\n\\n50 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nIn addition to these projects, separate test proj\", \"ects are included as well (Testing is discussed in\\nChapter 9).\\n\\nThe application's object model and i\", \"nterfaces should be placed in the ApplicationCore project. This\\nproject will have as few dependencie\", \"s as possible (and none on specific infrastructure concerns), and\\nthe other projects in the solution\", \" will reference it. Business entities that need to be persisted are\\ndefined in the ApplicationCore p\", \"roject, as are services that do not directly depend on infrastructure.\\n\\nImplementation details, such\", \" as how persistence is performed or how notifications might be sent to a\\nuser, are kept in the Infra\", \"structure project. This project will reference implementation-specific\\npackages such as Entity Frame\", \"work Core, but should not expose details about these implementations\\noutside of the project. Infrast\", \"ructure services and repositories should implement interfaces that are\\ndefined in the ApplicationCor\", \"e project, and its persistence implementations are responsible for\\nretrieving and storing entities d\", \"efined in ApplicationCore.\\n\\nThe ASP.NET Core UI project is responsible for any UI level concerns, bu\", \"t should not include business\\nlogic or infrastructure details. In fact, ideally it shouldn't even ha\", \"ve a dependency on the Infrastructure\\nproject, which will help ensure no dependency between the two \", \"projects is introduced accidentally.\\nThis can be achieved using a third-party DI container like Auto\", \"fac, which allows you to define DI rules\\nin Module classes in each project.\\n\\nAnother approach to dec\", \"oupling the application from implementation details is to have the\\napplication call microservices, p\", \"erhaps deployed in individual Docker containers. This provides even\\ngreater separation of concerns a\", \"nd decoupling than leveraging DI between two projects, but has\\nadditional complexity.\\n\\nFeature organ\", \"ization\\n\\nBy default, ASP.NET Core applications organize their folder structure to include Controller\", \"s and Views,\\nand frequently ViewModels. Client-side code to support these server-side structures is \", \"typically stored\\nseparately in the wwwroot folder. However, large applications may encounter problem\", \"s with this\\norganization, since working on any given feature often requires jumping between these fo\", \"lders. This\\ngets more and more difficult as the number of files and subfolders in each folder grows,\", \" resulting in a\\ngreat deal of scrolling through Solution Explorer. One solution to this problem is t\", \"o organize\\napplication code by feature instead of by file type. This organizational style is typical\", \"ly referred to as\\nfeature folders or feature slices (see also: Vertical Slices).\\n\\nASP.NET Core MVC s\", \"upports Areas for this purpose. Using areas, you can create separate sets of\\nControllers and Views f\", \"olders (as well as any associated models) in each Area folder. Figure 7-1 shows\\nan example folder st\", \"ructure, using Areas.\\n\\n51 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nb AG) wwwroot\\n4 4(27 Areas\\n[ Bas\", \"ket\\n[5 Blog\\n4 (=) Catalog\\n[1 Controllers\\nFE) ViewModels\\n4 (=) Views\\n4] Home\\n&(-) Search\\n[] Games\\nb A\", \"E) Identity\\n4&1 Configuration\\n4) Controllers\\n6) Extensions\\n4) Features\\n& EF] HealthChecks\\n4] Interfa\", \"ces\\n(7) Pages\\n4] Services\\n4&E] ViewModels\\n69 Views\\n> ACD Account\\n\\nLO OO OE OY Ow OY\\n\\nFigure 7-1. Sam\", \"ple Area Organization\\n\\nWhen using Areas, you must use attributes to decorate your controllers with t\", \"he name of the area to\\nwhich they belong:\\n\\n[Area( \\\"Catalog\\\" ) ]\\n\\npublic class HomeController\\n\\nth\\n\\nYo\", \"u also need to add area support to your routes:\\napp.UseEndpoints(endpoints =>\\n\\nendpoints .MapControl\", \"lerRoute(name: \\\"\\u201careaRoute\\\", pattern:\\n\\n\\\"farea:exists}/{controller=Home}/{action=Index}/{id?}\\\");\\nendp\", \"oints .MapControllerRoute(name: \\\"default\\\", pattern:\\n\\n\\\"{controller=Home}/{action=Index}/{id?}\\\");\\n\\n})3\", \"\\n\\nIn addition to the built-in support for Areas, you can also use your own folder structure, and\\ncon\", \"ventions in place of attributes and custom routes. This would allow you to have feature folders\\nthat\", \" didn\\u2019t include separate folders for Views, Controllers, etc., keeping the hierarchy flatter and\\nmak\", \"ing it easier to see all related files in a single place for each feature. For APls, folders can be \", \"used\\nto replace controllers, and each folder can contain all of the API Endpoints and their associat\", \"ed DTOs.\\n\\n52 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nASP.NET Core uses built-in convention types t\", \"o control its behavior. You can modify or replace these\\nconventions. For example, you can create a c\", \"onvention that will automatically get the feature name\\nfor a given controller based on its namespace\", \" (which typically correlates to the folder in which the\\ncontroller is located):\\n\\npublic class Featur\", \"eConvention : IControllerModelConvention\\n\\n{\\npublic void Apply(ControllerModel controller)\\n\\n{\\n\\ncontro\", \"ller .Properties.Add(\\\"feature\\\",\\nGetFeatureName(controller.ControllerType) ) ;\\n\\n}\\n\\nprivate string Get\", \"FeatureName(TypeInfo controllerType)\\n{\\nstring[ | tokens = controllerType.FullName.Split('.');\\nif (!t\", \"okens.Any(t => t == \\\"Features\\\")) return \\\"\\\";\\nstring featureName = tokens\\n~SkipWhile(t => !t.Equals( \\\"\", \"features\\\",\\nStringComparison.CurrentCultureIgnoreCase) )\\n.Skip(1)\\n. Take(1)\\n.FirstOrDefault();\\nreturn\", \" featureName;\\n\\nYou then specify this convention as an option when you add support for MVC to your ap\", \"plication in\\nConfigureServices (or in Program.cs):\\n\\n// ConfigureServices\\nservices.AddMvc(o => o.Conv\", \"entions.Add(new FeatureConvention()));\\n\\n// Program.cs\\nbuilder.Services.AddMvc(o => o.Conventions.Add\", \"(new FeatureConvention()));\\n\\nASP.NET Core MVC also uses a convention to locate views. You can overri\", \"de it with a custom\\nconvention so that views will be located in your feature folders (using the feat\", \"ure name provided by\\nthe FeatureConvention, above). You can learn more about this approach and downl\", \"oad a working\\nsample from the MSDN Magazine article, Feature Slices for ASP.NET Core MVC.\\n\\nAPIs and \", \"Blazor applications\\n\\nIf your application includes a set of web APIs, which must be secured, these AP\", \"Is should ideally be\\nconfigured as a separate project from your View or Razor Pages application. Sep\", \"arating APIs,\\nespecially public APls, from your server-side web application has a number of benefits\", \". These\\napplications often will have unique deployment and load characteristics. They're also very l\", \"ikely to\\nadopt different mechanisms for security, with standard form-based applications leveraging c\", \"ookie-\\nbased authentication and APls most likely using token-based authentication.\\n\\nAdditionally, Bl\", \"azor applications, whether using Blazor Server or Blazor WebAssembly, should be built\\nas separate pr\", \"ojects. The applications have different runtime characteristics as well as security models.\\nThey're \", \"likely to share common types with the server-side web application (or API project), and these\\ntypes \", \"should be defined in a common shared project.\\n\\n53 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nThe addi\", \"tion of a Blazor WebAssembly admin interface to eshopOnWeb required adding several new\\nprojects. The\", \" Blazor WebAssembly project itself, BlazorAdmin. A new set of public API endpoints, used\\nby BlazorAd\", \"min and configured to use token-based authentication, is defined in the PublicApi project.\\nAnd certa\", \"in shared types used by both of these projects are kept in a new BlazorShared project.\\n\\nOne might as\", \"k, why add a separate BlazorShared project when there is already a common\\nApplicationCore project th\", \"at could be used to share any types required by both PublicApi and\\nBlazorAdmin? The answer is that t\", \"his project includes all of the application's business logic and is thus\\nmuch larger than necessary \", \"and also much more likely to need to be kept secure on the server.\\nRemember that any library referen\", \"ced by BlazorAdmin will be downloaded to users\\u2019 browsers when\\nthey load the Blazor application.\\n\\nDep\", \"ending on whether one is using the Backends-For-Frontends (BFF) pattern, the APIs consumed by\\nthe Bl\", \"azor WebAssembly app may not share their types 100% with Blazor. In particular, a public API\\n\\nthat's\", \" meant to be consumed by many different clients may define its own request and result types,\\nrather \", \"than sharing them in a client-specific shared project. In the eshopOnWeb sample, the\\nassumption is b\", \"eing made that the PublicApi project is, in fact, hosting a public API, so not all of its\\nrequest an\", \"d response types come from the BlazorShared project.\\n\\nCross-cutting concerns\\n\\nAs applications grow, \", \"it becomes increasingly important to factor out cross-cutting concerns to\\neliminate duplication and \", \"maintain consistency. Some examples of cross-cutting concerns in ASP.NET\\nCore applications are authe\", \"ntication, model validation rules, output caching, and error handling,\\nthough there are many others.\", \" ASP.NET Core MVC filters allow you to run code before or after certain\\nsteps in the request process\", \"ing pipeline. For instance, a filter can run before and after model binding,\\n\\nbefore and after an ac\", \"tion, or before and after an action\\u2019s result. You can also use an authorization\\nfilter to control ac\", \"cess to the rest of the pipeline. Figures 7-2 shows how request execution flows\\nthrough filters, if \", \"configured.\\n\\n54 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nAction filter (before)\\n\\nAction filter (aft\", \"er)\\n\\nFigure 7-2. Request execution through filters and request pipeline.\\n\\nFilters are usually implem\", \"ented as attributes, so you can apply them to controllers or actions (or even\\nglobally). When added \", \"in this fashion, filters specified at the action level override or build upon filters\\nspecified at t\", \"he controller level, which themselves override global filters. For example, the [Route]\\nattribute ca\", \"n be used to build up routes between controllers and actions. Likewise, authorization can\\nbe configu\", \"red at the controller level, and then overridden by individual actions, as the following\\nsample demo\", \"nstrates:\\n\\n| Authorize |\\n\\npublic class AccountController : Controller\\n\\n{\\n[AllowAnonymous]| // overri\", \"des the Authorize attribute\\npublic async Task<IActionResult> Login() {}\\npublic async Task<IActionRes\", \"ult> ForgotPassword() {}\\n\\nThe first method, Login, uses the [AllowAnonymous] filter (attribute) to o\", \"verride the Authorize filter\\nset at the controller level. The ForgotPassword action (and any other a\", \"ction in the class that doesn't\\nhave an AllowAnonymous attribute) will require an authenticated requ\", \"est.\\n\\nFilters can be used to eliminate duplication in the form of common error handling policies for\", \" APIs.\\nFor example, a typical API policy is to return a NotFound response to requests referencing ke\", \"ys that\\ndo not exist, and a BadRequest response if model validation fails. The following example\\ndem\", \"onstrates these two policies in action:\\n\\n[HttpPut(\\\"{id}\\\") ]\\npublic async Task<IActionResult> Put(int\", \" id, [FromBody]Author author)\\n{\\n\\n55 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nif ((await _authorRepo\", \"sitory.ListAsync()).All(a => a.Id != id))\\n{\\n\\nreturn NotFound(id) ;\\n\\n}\\nif (!ModelState. IsValid)\\n\\n{\\nr\", \"eturn BadRequest(ModelState) ;\\n\\n}\\n\\nauthor.Id = id;\\n\\nawait _authorRepository.UpdateAsync(author) ;\\nre\", \"turn Ok();\\n\\nDon't allow your action methods to become cluttered with conditional code like this. Ins\", \"tead, pull the\\npolicies into filters that can be applied on an as-needed basis. In this example, the\", \" model validation\\ncheck, which should occur anytime a command is sent to the API, can be replaced by\", \" the following\\nattribute:\\n\\npublic class ValidateModelAttribute : ActionFilterAttribute\\n{\\n\\npublic ove\", \"rride void OnActionExecuting(ActionExecutingContext context)\\n\\n{\\nif (!context.ModelState.IsValid)\\n\\n{\\n\", \"context.Result = new BadRequestObjectResult(context.ModelState) ;\\n\\nYou can add the ValidateModelAttr\", \"ibute to your project as a NuGet dependency by including the\\nArdalis.ValidateModel package. For APIs\", \", you can use the ApiController attribute to enforce this\\nbehavior without the need for a separate V\", \"alidateModel filter.\\n\\nLikewise, a filter can be used to check if a record exists and return a 404 be\", \"fore the action is executed,\\neliminating the need to perform these checks in the action. Once you've\", \" pulled out common\\nconventions and organized your solution to separate infrastructure code and busin\", \"ess logic from your\\nUl, your MVC action methods should be extremely thin:\\n\\n[HttpPut(\\\"{id}\\\") ]\\n\\n| Val\", \"idateAuthorExists |\\npublic async Task<IActionResult> Put(int id, [FromBody]Author author)\\n\\n{\\n\\nawait \", \"_authorRepository.UpdateAsync(author) ;\\nreturn Ok();\\n\\nYou can read more about implementing filters a\", \"nd download a working sample from the MSDN\\nMagazine article, Real-World ASP.NET Core MVC Filters.\\n\\nI\", \"f you find that you have a number of common responses from APIs based on common scenarios like\\nvalid\", \"ation errors (Bad Request), resource not found, and server errors, you might consider using a\\nresult\", \" abstraction. The result abstraction would be returned by services consumed by API endpoints,\\nand th\", \"e controller action or endpoint would use a filter to translate these into [ActionResults.\\n\\n56 CHAPT\", \"ER 6 | Develop ASP.NET Core MVC apps\\nReferences \\u2014 Structuring applications\\n\\n\\u00b0 Areas\\nhttps://learn.mi\", \"crosoft.com/aspnet/core/mvc/controllers/areas\\n\\n. MSDN Magazine - Feature Slices for ASP.NET Core MVC\", \"\\nhttps://learn.microsoft.com/archive/msdn-magazine/2016/september/asp-net-core-feature-\\nslices-for-a\", \"sp-net-core-mvc\\n\\n\\u00b0 Filters\\nhttps://learn.microsoft.com/aspnet/core/mvc/controllers/filters\\n\\n. MSDN M\", \"agazine \\u2014 Real World ASP.NET Core MVC Filters\\nhttos://learn.microsoft.com/archive/msdn-magazine/2016\", \"/august/asp-net-core-real-world-\\nasp-net-core-mvc-filters\\n\\n. Result in eShopOnWeb\\nhttps://github.com\", \"/dotnet-architecture/eShopOnWeb/wiki/Patterns#result\\n\\nSecurity\\n\\nSecuring web applications is a large\", \" topic, with many considerations. At its most basic level, security\\ninvolves ensuring you know who a\", \" given request is coming from, and then ensuring that the request\\nonly has access to resources it sh\", \"ould. Authentication is the process of comparing credentials\\nprovided with a request to those in a t\", \"rusted data store, to see if the request should be treated as\\ncoming from a known entity. Authorizat\", \"ion is the process of restricting access to certain resources\\nbased on user identity. A third securi\", \"ty concern is protecting requests from eavesdropping by third\\n\\nparties, for which you should at leas\", \"t ensure that SSL is used by your application.\\n\\nIdentity\\n\\nASP.NET Core Identity is a membership syst\", \"em you can use to support login functionality for your\\napplication. It has support for local user ac\", \"counts as well as external login provider support from\\nproviders like Microsoft Account, Twitter, Fa\", \"cebook, Google, and more. In addition to ASP.NET Core\\nIdentity, your application can use windows aut\", \"hentication, or a third-party identity provider like\\nIdentity Server.\\n\\nASP.NET Core Identity is incl\", \"uded in new project templates if the Individual User Accounts option is\\nselected. This template incl\", \"udes support for registration, login, external logins, forgotten passwords,\\nand additional functiona\", \"lity.\\n\\n5/7 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nAdditional information\\n\\nASP.NET Core Web App c#\", \" Linux = macOS Windows Cloud  Sernice Web\\n\\nFramework @\\n-NET 7.0 (Standard Term Support)\\n\\nAuthenticat\", \"ion type @\\n\\nNone\\n\\nIndividual Accounts\\nMicrosoft identity platform\\nWindows\\n\\n[] Do not use top-level s\", \"tatements @\\n\\nFigure 7-3. Select Individual User Accounts to have Identity preconfigured.\\n\\nIdentity s\", \"upport is configured in Program.cs or Startup, and includes configuring services as well as\\nmiddlewa\", \"re.\\n\\nConfigure Identity in Program.cs\\n\\nIn Program.cs, you configure services from the WebHostBuilder\", \" instance, and then once the app is\\ncreated, you configure its middleware. The key points to note ar\", \"e the call to AddDefaultldentity for\\nrequired services and the UseAuthentication and UseAuthorizatio\", \"n calls which add required\\nmiddleware.\\n\\nvar builder = WebApplication.CreateBuilder(args) ;\\n\\n// Add s\", \"ervices to the container.\\n\\nvar connectionString = builder.Configuration.GetConnectionString(\\\"Default\", \"Connection\\\" ) ;\\n\\nbuilder.Services.AddDbContext<ApplicationDbContext>(options =>\\noptions.UseSqlServer\", \"(connectionString) ) ;\\n\\nbuilder.Services.AddDatabaseDeveloperPageExceptionFilter() ;\\n\\nbuilder.Servic\", \"es.AddDefaultIidentity<IdentityUser>(options =>\\n\\noptions.Signin.RequireConfirmedAccount = true)\\n.Add\", \"EntityFrameworkStores<ApplicationDbContext>() ;\\n\\nbuilder.Services.AddRazorPages() ;\\n\\nvar app = build\", \"er.Build();\\n\\n// Configure the HTTP request pipeline.\\nif (app.Environment.IsDevelopment( ) )\\n\\n58 CHAP\", \"TER 6 | Develop ASP.NET Core MVC apps\\napp.UseMigrationsEndPoint() ;\\n\\nelse\\n\\n{\\n\\napp.UseExceptionHandle\", \"r(\\\"/Error\\u201d ) ;\\n\\n// The default HSTS value is 30 days. You may want to change this for production\\nsce\", \"narios, see https://aka.ms/aspnetcore-hsts.\\n\\napp.UseHsts();\\n\\n}\\n\\napp.UseHttpsRedirection( ) ;\\napp.Use\", \"StaticFiles();\\n\\napp.UseRouting() ;\\n\\napp.UseAuthentication() ;\\napp.UseAuthorization() ;\\n\\napp.MapRazor\", \"Pages() ;\\n\\napp.Run();\\n\\nConfiguring Identity in app startup\\n\\n// Add framework services.\\nbuilder.Servi\", \"ces.AddDbContext<ApplicationDbContext>(options =>\\noptions.UseSqlServer (Configuration.GetConnectionS\", \"tring(\\\"DefaultConnection\\\" ) ));\\nbuilder.Services.AddIidentity<ApplicationUser, IdentityRole>()\\n.AddE\", \"ntityFrameworkStores<ApplicationDbContext>()\\n.AddDefaultTokenProviders() ;\\nbuilder.Services.AddMvc()\", \";\\n\\nvar app = builder.Build();\\nif (app.Environment.IsDevelopment( ) )\\napp.UseMigrationsEndPoint() ;\\n\\n\", \"}\\n\\nelse\\n\\n{\\n\\napp.UseExceptionHandler(\\\"/Error\\\" ) ;\\napp.UseHsts();\\n\\nUseHttpsRedirection() ;\\nUseStaticFi\", \"les();\\n\\n.UseRouting() ;\\n\\nUseAuthentication() ;\\nUseAuthorization() ;\\n\\n.MapRazorPages() ;\\n\\nIt's import\", \"ant that UseAuthentication and UseAuthorization appear before MapRazorPages. When\\nconfiguring Identi\", \"ty services, you'll notice a call to AddDefaultTokenProviders. This has nothing to do\\nwith tokens th\", \"at may be used to secure web communications, but instead refers to providers that\\ncreate prompts tha\", \"t can be sent to users via SMS or email in order for them to confirm their identity.\\n\\n59 CHAPTER 6 |\", \" Develop ASP.NET Core MVC apps\\nYou can learn more about configuring two-factor authentication and en\", \"abling external login providers\\nfrom the official ASP.NET Core docs.\\n\\nAuthentication\\n\\nAuthentication\", \" is the process of determining who is accessing the system. If you're using ASP.NET\\nCore Identity an\", \"d the configuration methods shown in the previous section, it will automatically\\nconfigure some auth\", \"entication defaults in the application. However, you can also configure these\\ndefaults manually, or \", \"override the ones set by Addidentity. If you're using Identity, it configures\\ncookie-based authentic\", \"ation as the default scheme.\\n\\nIn web-based authentication, there are typically up to five actions th\", \"at may be performed in the\\ncourse of authenticating a client of a system. These are:\\n\\n. Authenticate\", \". Use the information provided by the client to create an identity for them to use\\nwithin the applic\", \"ation.\\n\\n. Challenge. This action is used to require the client to identify themselves.\\n. Forbid. Inf\", \"orm the client they are forbidden from performing an action.\\n. Sign-in. Persist the existing client \", \"in some way.\\n\\n. Sign-out. Remove the client from persistence.\\n\\nThere are a number of common techniqu\", \"es for performing authentication in web applications. These\\nare referred to as schemes. A given sche\", \"me will define actions for some or all of the above options.\\nSome schemes only support a subset of a\", \"ctions, and may require a separate scheme to perform those\\nit does not support. For example, the Ope\", \"nld-Connect (OIDC) scheme doesn't support Sign-in or\\nSign-out, but is commonly configured to use Coo\", \"kie authentication for this persistence.\\n\\nIn your ASP.NET Core application, you can configure a Defa\", \"ultAuthenticateScheme as well as optional\\nspecific schemes for each of the actions described above. \", \"For example, DefaultChallengeScheme,\\nDefaultForbidScheme, etc. Calling Addidentity<TUser, TRole> con\", \"figures a number of aspects of the\\napplication and adds many required services. It also includes thi\", \"s call to configure the authentication\\nscheme:\\n\\nbuilder.Services.AddAuthentication(options =>\\n\\n{\\n\\nop\", \"tions.DefaultAuthenticateScheme = IdentityConstants.ApplicationScheme ;\\n\\noptions.DefaultChallengeSch\", \"eme = IdentityConstants.ApplicationScheme;\\noptions.DefaultSigniInScheme = IdentityConstants.External\", \"Scheme;\\n\\n})3\\n\\nThese schemes use cookies for persistence and redirection to login pages for authentic\", \"ation by\\ndefault. These schemes are appropriate for web applications that interact with users via we\", \"b browsers,\\nbut not recommended for APIs. Instead, APIs will typically use another form of authentic\", \"ation, such as\\nJWT bearer tokens.\\n\\nWeb APIs are consumed by code, such as HttpClient in .NET applica\", \"tions and equivalent types in other\\nframeworks. These clients expect a usable response from an API c\", \"all, or a status code indicating what,\\nif any, problem has occurred. These clients are not interacti\", \"ng through a browser and do not render or\\ninteract with any HTML that an API might return. Thus, it \", \"is not appropriate for API endpoints to\\nredirect their clients to login pages if they are not authen\", \"ticated. Another scheme is more appropriate.\\n\\n60 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nTo config\", \"ure authentication for APIs, you might set up authentication like the following, used by the\\nPublicA\", \"pi project in the eshopOnWeb reference application:\\n\\nbuilder.Services\\n.AddAuthentication(config =>\\n{\", \"\\nconfig.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;\\n\\n})\\n.AddjJwtBearer(config =>\\n\\n{\\n\\ncon\", \"fig.RequireHttpsMetadata = false;\\nconfig.SaveToken = true;\\n\\nconfig.TokenValidationParameters = new T\", \"okenValidationParameters\\n{\\nValidateIssuerSigningKey = true,\\nIssuerSigningKey = new SymmetricSecurity\", \"Key(key) ,\\nValidateIssuer = false,\\nValidateAudience = false\\n\\nWhile it is possible to configure multi\", \"ple different authentication schemes within a single project, it is\\nmuch simpler to configure a sing\", \"le default scheme. For this reason, among others, the eshopOnWeb\\n\\nreference application separates it\", \"s APIs into their own project, PublicApi, separate from the main Web\\nproject that includes the appli\", \"cation's views and Razor Pages.\\n\\nAuthentication in Blazor apps\\n\\nBlazor Server applications can lever\", \"age the same authentication features as any other ASP.NET Core\\napplication. Blazor WebAssembly appli\", \"cations cannot use the built-in Identity and Authentication\\nproviders, however, since they run in th\", \"e browser. Blazor WebAssembly applications can store user\\nauthentication status locally and can acce\", \"ss claims to determine what actions users should be able to\\nperform. However, all authentication and\", \" authorization checks should be performed on the server\\nregardless of any logic implemented inside t\", \"he Blazor WebAssembly app, since users can easily\\nbypass the app and interact with the APIs directly\", \".\\n\\nReferences \\u2014 Authentication\\n\\n\\u00b0 Authentication Actions and Defaults\\nhttps://stackoverflow.com/a/52\", \"493428\\n\\n. Authentication and Authorization for SPAs\\nhttps://learn.microsoft.com/aspnet/core/security\", \"/authentication/identity-api-authorization\\n\\n\\u00b0 ASP.NET Core Blazor Authentication and Authorization\\nh\", \"ttps://learn.microsoft.com/aspnet/core/blazor/security/\\n\\n. Security: Authentication and Authorizatio\", \"n in ASP.NET Web Forms and Blazor\\n\\nhttps://learn.microsoft.com/dotnet/architecture/blazor-for-web-fo\", \"rms-developers/security-\\nauthentication-authorization\\n\\nAuthorization\\n\\nThe simplest form of authoriza\", \"tion involves restricting access to anonymous users. This functionality\\ncan be achieved by applying \", \"the [Authorize] attribute to certain controllers or actions. If roles are\\n\\n61 CHAPTER 6 | Develop AS\", \"P.NET Core MVC apps\\nbeing used, the attribute can be further extended to restrict access to users wh\", \"o belong to certain\\nroles, as shown:\\n\\n[Authorize(Roles = \\\"HRManager, Finance\\\" ) |\\npublic class Salar\", \"yController : Controller\\n\\nt\\n}\\n\\nIn this case, users belonging to either the HRManager or Finance role\", \"s (or both) would have access to\\nthe SalaryController. To require that a user belong to multiple rol\", \"es (not just one of several), you can\\napply the attribute multiple times, specifying a required role\", \" each time.\\n\\nSpecifying certain sets of roles as strings in many different controllers and actions c\", \"an lead to\\nundesirable repetition. At a minimum, define constants for these string literals and use \", \"the constants\\nanywhere you need to specify the string. You can also configure authorization policies\", \", which\\nencapsulate authorization rules, and then specify the policy instead of individual roles whe\", \"n applying\\nthe [Authorize] attribute:\\n\\n[Authorize(Policy = \\\"CanViewPrivateReport\\u201d ) |\\npublic IAction\", \"Result ExecutiveSalaryReport( )\\n\\nt\\n}\\n\\nreturn View();\\n\\nUsing policies in this way, you can separate t\", \"he kinds of actions being restricted from the specific roles\\nor rules that apply to it. Later, if yo\", \"u create a new role that needs to have access to certain resources,\\nyou can just update a policy, ra\", \"ther than updating every list of roles on every [Authorize] attribute.\\n\\nClaims\\n\\nClaims are name valu\", \"e pairs that represent properties of an authenticated user. For example, you\\nmight store users\\u2019 empl\", \"oyee number as a claim. Claims can then be used as part of authorization\\npolicies. You could create \", \"a policy called \\u201cEmployeeOnly\\u201d that requires the existence of a claim called\\n\\\"EmployeeNumber\\\", as sh\", \"own in this example:\\n\\npublic void ConfigureServices(IServiceCollection services)\\n\\n{\\nservices.AddMvc(\", \");\\nservices.AddAuthorization(options =>\\n{\\noptions.AddPolicy(\\\"EmployeeOnly\\\", policy => policy.Require\", \"Claim(\\\"EmployeeNumber'\\\" ) ) ;\\n})3\\n}\\n\\nThis policy could then be used with the [Authorize] attribute t\", \"o protect any controller and/or action,\\nas described above.\\n\\nSecuring web APIs\\n\\nMost web APIs should\", \" implement a token-based authentication system. Token authentication is\\nstateless and designed to be\", \" scalable. In a token-based authentication system, the client must first\\nauthenticate with the authe\", \"ntication provider. If successful, the client is issued a token, which is simply\\n\\n62 CHAPTER 6 | Dev\", \"elop ASP.NET Core MVC apps\\na cryptographically meaningful string of characters. The most common form\", \"at for tokens is JSON Web\\nToken, or JWT (often pronounced \\u201cjot\\u201d). When the client then needs to issu\", \"e a request to an API, it\\nadds this token as a header on the request. The server then validates the \", \"token found in the request\\nheader before completing the request. Figure 7-4 demonstrates this proces\", \"s.\\n\\nToken-Based Authentication\\n\\n\\u00a9 Password Password\\n\\nUser\\n\\nWeb Client\\n\\nSPA Application\\n\\nRequest\\n\\nRes\", \"ource\\n\\nFigure 7-4. Token-based authentication for Web APIs.\\n\\nYou can create your own authentication \", \"service, integrate with Azure AD and OAuth, or implement a\\nservice using an open-source tool like Id\", \"entityServer.\\n\\nJWT tokens can embed claims about the user, which can be read on the client or server\", \". You can use a\\ntool like jwt.io to view the contents of a JWT token. Do not store sensitive data li\", \"ke passwords or keys\\nin JTW tokens, since their contents are easily read.\\n\\nWhen using JWT tokens wit\", \"h SPA or Blazor WebAssembly applications, you must store the token\\nsomewhere on the client and then \", \"add it to every API call. This activity is typically done as a header, as\\nthe following code demonst\", \"rates:\\n\\n// AuthService.cs in BlazorAdmin project of eShopOnWeb\\nprivate async Task SetAuthorizationHe\", \"ader( )\\n\\n{\\n\\nvar token = await GetToken();\\n_httpClient.DefaultRequestHeaders.Authorization = new\\nAuth\", \"enticationHeaderValue(\\\"Bearer\\\", token) ;\\n\\n}\\n\\nAfter calling the above method, requests made with the \", \"_httpClient will have the token embedded in\\nthe request\\u2019's headers, allowing the server-side API to \", \"authenticate and authorize the request.\\n\\n63 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nCustom Securit\", \"y\\n\\nCaution\\n\\nAs a general rule, avoid implementing your own custom security implementations.\\n\\nBe espe\", \"cially careful about \\u201crolling your own\\u201d implementation of cryptography, user membership, or\\ntoken ge\", \"neration system. There are many commercial and open-source alternatives available, which\\nwill almost\", \" certainly have better security than a custom implementation.\\n\\nReferences \\u2014 Security\\n\\n. Security Doc\", \"s Overview\\nhttps://learn.microsoft.com/aspnet/core/security/\\n\\n. Enforcing SSL in an ASP.NET Core App\", \"\\nhttps://learn.microsoft.com/aspnet/core/security/enforcing-ssl\\n\\n. Introduction to Identity\\nhttps://\", \"learn.microsoft.com/aspnet/core/security/authentication/identity\\n\\u00b0 Introduction to Authorization\\n\\nht\", \"tps://learn.microsoft.com/aspnet/core/security/authorization/introduction\\n\\n. Authentication and Auth\", \"orization for API Apps in Azure App Service\\nhttos://learn.microsoft.com/azure/app-service-api/app-se\", \"rvice-api-authentication\\n\\n. Identity Server\\n\\nhttps://github.com/IdentityServer\\n\\nClient communication\", \"\\n\\nIn addition to serving pages and responding to requests for data via web APIs, ASP.NET Core apps c\", \"an\\ncommunicate directly with connected clients. This outbound communication can use a variety of\\ntra\", \"nsport technologies, the most common being WebSockets. ASP.NET Core SignalR is a library that\\nmakes \", \"it simple to add real-time server-to-client communication functionality to your applications.\\nSignal\", \"R supports a variety of transport technologies, including WebSockets, and abstracts away many\\nof the\", \" implementation details from the developer.\\n\\nReal-time client communication, whether using WebSocket\", \"s directly or other techniques, are useful in\\na variety of application scenarios. Some examples incl\", \"ude:\\n\\n. Live chat room applications\\n\\n. Monitoring applications\\n\\n. Job progress updates\\n\\n. Notificati\", \"ons\\n\\n. Interactive forms applications\\n\\nWhen building client communication into your applications, th\", \"ere are typically two components:\\n\\n64 CHAPTER 6 | Develop ASP.NET Core MVC apps\\n. Server-side connec\", \"tion manager (SignalR Hub, WebSocketManager WebSocketHandler)\\n. Client-side library\\n\\nClients aren't \", \"limited to browsers \\u2014 mobile apps, console apps, and other native apps can also\\ncommunicate using Si\", \"gnalR/WebSockets. The following simple program echoes all content sent to a\\nchat application to the \", \"console, as part of a WebSocketManager sample application:\\n\\npublic class Program\\n{\\nprivate static Co\", \"nnection _connection;\\npublic static void Main(string[] args)\\n{\\nStartConnectionAsync() ;\\n_connection.\", \"On(\\\"receiveMessage\\\", (arguments) =>\\n\\n{\\nConsole.WriteLine($\\\"{arguments[@]} said: {arguments[1]}\\\");\\n})\", \"3\\n\\nConsole.ReadLine() ;\\nStopConnectionAsync() ;\\n\\n}\\n\\npublic static async Task StartConnectionAsync()\\n\", \"\\n{\\n\\n_connection = new Connection() ;\\nawait _connection.StartConnectionAsync(\\\"ws://localhost:65110/ch\", \"at\\\") ;\\n\\n}\\n\\npublic static async Task StopConnectionAsync()\\n\\nt\\n}\\n\\nawait _connection.StopConnectionAsyn\", \"c() ;\\n\\nConsider ways in which your applications communicate directly with client applications, and c\", \"onsider\\nwhether real-time communication would improve your app\\u2019s user experience.\\n\\nReferences \\u2014 Clie\", \"nt Communication\\n\\n. ASP.NET Core SignalR\\nhttps://github.com/dotnet/aspnetcore/tree/main/src/SignalR\\n\", \"\\n. WebSocket Manager\\nhttps://github.com/radu-matei/websocket-manager\\n\\nDomain-driven design \\u2014 Should \", \"you apply it?\\n\\nDomain-Driven Design (DDD) is an agile approach to building software that emphasizes \", \"focusing on\\nthe business domain. It places a heavy emphasis on communication and interaction with bu\", \"siness\\ndomain expert(s) who can relate to the developers how the real-world system works. For exampl\", \"e, if\\nyou're building a system that handles stock trades, your domain expert might be an experienced\", \" stock\\nbroker. DDD is designed to address large, complex business problems, and is often not appropr\", \"iate\\nfor smaller, simpler applications, as the investment in understanding and modeling the domain i\", \"s not\\nworth it.\\n\\n65 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nWhen building software following a DDD\", \" approach, your team (including non-technical stakeholders\\nand contributors) should develop a ubiqui\", \"tous language for the problem space. That is, the same\\nterminology should be used for the real-world\", \" concept being modeled, the software equivalent, and\\nany structures that might exist to persist the \", \"concept (for example, database tables). Thus, the\\nconcepts described in the ubiquitous language shou\", \"ld form the basis for your domain model.\\n\\nYour domain model comprises objects that interact with one\", \" another to represent the behavior of the\\nsystem. These objects may fall into the following categori\", \"es:\\n\\n. Entities, which represent objects with a thread of identity. Entities are typically stored in\", \"\\npersistence with a key by which they can later be retrieved.\\n\\n. Aggregates, which represent groups \", \"of objects that should be persisted as a unit.\\n\\n. Value objects, which represent concepts that can b\", \"e compared on the basis of the sum of\\ntheir property values. For example, DateRange consisting of a \", \"start and end date.\\n\\n. Domain events, which represent things happening within the system that are of\", \" interest to\\nother parts of the system.\\n\\nA DDD domain model should encapsulate complex behavior with\", \"in the model. Entities, in particular,\\nshould not merely be collections of properties. When the doma\", \"in model lacks behavior and merely\\nrepresents the state of the system, it is said to be an anemic mo\", \"del, which is undesirable in DDD.\\n\\nIn addition to these model types, DDD typically employs a variety\", \" of patterns:\\n. Repository, for abstracting persistence details.\\n. Factory, for encapsulating comple\", \"x object creation.\\n. Services, for encapsulating complex behavior and/or infrastructure implementati\", \"on details.\\n. Command, for decoupling issuing commands and executing the command itself.\\n. Specifica\", \"tion, for encapsulating query details.\\n\\nDDD also recommends the use of the Clean Architecture discus\", \"sed previously, allowing for loose\\ncoupling, encapsulation, and code that can easily be verified usi\", \"ng unit tests.\\n\\nWhen should you apply DDD\\n\\nDDD is well suited to large applications with significant\", \" business (not just technical) complexity. The\\napplication should require the knowledge of domain ex\", \"perts. There should be significant behavior in\\nthe domain model itself, representing business rules \", \"and interactions beyond simply storing and\\nretrieving the current state of various records from data\", \" stores.\\n\\nWhen shouldn't you apply DDD\\n\\nDDD involves investments in modeling, architecture, and comm\", \"unication that may not be warranted\\nfor smaller applications or applications that are essentially ju\", \"st CRUD (create/read/update/delete). If\\nyou choose to approach your application following DDD, but f\", \"ind that your domain has an anemic\\nmodel with no behavior, you may need to rethink your approach. Ei\", \"ther your application may not\\n\\n66 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nneed DDD, or you may nee\", \"d assistance refactoring your application to encapsulate business logic in\\nthe domain model, rather \", \"than in your database or user interface.\\n\\nA hybrid approach would be to only use DDD for the transac\", \"tional or more complex areas of the\\napplication, but not for simpler CRUD or read-only portions of t\", \"he application. For instance, you don't\\nneed the constraints of an Aggregate if you're querying data\", \" to display a report or to visualize data\\nfor a dashboard. It\\u2019s perfectly acceptable to have a separ\", \"ate, simpler read model for such\\nrequirements.\\n\\nReferences \\u2014 Domain-Driven Design\\n. DDD in Plain Eng\", \"lish (StackOverflow Answer)\\n\\nddd- in-plain- english-please/1222488# 1222488\\n\\nDeployment\\n\\nThere are a\", \" few steps involved in the process of deploying your ASP.NET Core application, regardless\\nof where i\", \"t will be hosted. The first step is to publish the application, which can be done using the\\ndotnet p\", \"ublish CLI command. This step will compile the application and place all of the files needed to\\nrun \", \"the application into a designated folder. When you deploy from Visual Studio, this step is\\nperformed\", \" for you automatically. The publish folder contains .exe and .dll files for the application and\\nits \", \"dependencies. A self-contained application will also include a version of the .NET runtime. ASP.NET\\n\", \"Core applications will also include configuration files, static client assets, and MVC views.\\n\\nASP.N\", \"ET Core applications are console applications that must be started when the server boots and\\nrestart\", \"ed if the application (or server) crashes. A process manager can be used to automate this\\nprocess. T\", \"he most common process managers for ASP.NET Core are Nginx and Apache on Linux and\\nIIS or Windows Se\", \"rvice on Windows.\\n\\nIn addition to a process manager, ASP.NET Core applications may use a reverse pro\", \"xy server. A\\nreverse proxy server receives HTTP requests from the Internet and forwards them to Kest\", \"rel after\\nsome preliminary handling. Reverse proxy servers provide a layer of security for the appli\", \"cation.\\nKestrel also doesn\\u2019t support hosting multiple applications on the same port, so techniques l\", \"ike host\\nheaders cannot be used with it to enable hosting multiple applications on the same port and\", \" IP\\naddress.\\n\\nReverse proxy server: ASP.NET Core application\\n\\nInternet\\nf=. HTTP IIS, Nginx, Apache H\", \"TTP\\n\\nl\\n\\nHttpContext\\n\\n[)\\n\\nFigure 7-5. ASP.NET hosted in Kestrel behind a reverse proxy server\\n\\nAnothe\", \"r scenario in which a reverse proxy can be helpful is to secure multiple applications using\\nSSL/HTTP\", \"S. In this case, only the reverse proxy would need to have SSL configured. Communication\\nbetween the\", \" reverse proxy server and Kestrel could take place over HTTP, as shown in Figure 7-6.\\n\\n67 CHAPTER 6 \", \"| Develop ASP.NET Core MVC apps\\nReverse proxy server: ASP.NET Core application\\nInternet\\n\\nf \\u2122, HTTPS \", \"IIS, Nginx, Apache HTTP\\n\\nHttpContext\\n\\n(0)\\n\\nFigure 7-6. ASP.NET hosted behind an HTTPS-secured revers\", \"e proxy server\\n\\nAn increasingly popular approach is to host your ASP.NET Core application in a Docke\", \"r container,\\nwhich then can be hosted locally or deployed to Azure for cloud-based hosting. The Dock\", \"er container\\ncould contain your application code, running on Kestrel, and would be deployed behind a\", \" reverse\\nproxy server, as shown above.\\n\\nIf you're hosting your application on Azure, you can use Mic\", \"rosoft Azure Application Gateway as a\\ndedicated virtual appliance to provide several services. In ad\", \"dition to acting as a reverse proxy for\\nindividual applications, Application Gateway can also offer \", \"the following features:\\n\\n. HTTP load balancing\\n\\n\\u00b0 SSL offload (SSL only to Internet)\\n\\n. End to End S\", \"SL\\n\\n. Multi-site routing (consolidate up to 20 sites on a single Application Gateway)\\n. Web applicat\", \"ion firewall\\n\\n. Websocket support\\n\\n. Advanced diagnostics\\n\\nLearn more about Azure deployment options\", \" tn Chapter 10.\\n\\nReferences \\u2014 Deployment\\n\\n. Hosting and Deployment Overview\\nhttps://learn.microsoft.\", \"com/aspnet/core/publishing/\\n\\n. When to use Kestrel with a reverse proxy\\nhttps://learn.microsoft.com/\", \"aspnet/core/fundamentals/servers/kestrel#when-to-use-kestrel-\\nwith-a-reverse-proxy\\n\\n\\u00b0 Host ASP.NET C\", \"ore apps in Docker\\nhttps://learn.microsoft.com/aspnet/core/publishing/docker\\n\\n. Introducing Azure Ap\", \"plication Gateway\\nhttos://learn.microsoft.com/azure/application-gateway/application-gateway-introduc\", \"tion\\n\\n68 CHAPTER 6 | Develop ASP.NET Core MVC apps\\nCHAPTER\\n\\nWorking with Data in\\nASP.NET Core Apps\\n\\n\", \"\\u201cData Is a precious thing and will last longer than the systems themselves.\\u201d\\n\\nTim Berners-Lee\\n\\nData \", \"access is an important part of almost any software application. ASP.NET Core supports various\\ndata a\", \"ccess options, including Entity Framework Core (and Entity Framework 6 as well), and can work\\nwith a\", \"ny .NET data access framework. The choice of which data access framework to use depends on\\nthe appli\", \"cation's needs. Abstracting these choices from the ApplicationCore and UI projects, and\\nencapsulatin\", \"g implementation details in Infrastructure, helps to produce loosely coupled, testable\\nsoftware.\\n\\nEn\", \"tity Framework Core (for relational databases)\\n\\nIf you're writing a new ASP.NET Core application tha\", \"t needs to work with relational data, then Entity\\nFramework Core (EF Core) is the recommended way fo\", \"r your application to access its data. EF Core is\\nan object-relational mapper (O/RM) that enables .N\", \"ET developers to persist objects to and from a\\ndata source. It eliminates the need for most of the d\", \"ata access code developers would typically need\\nto write. Like ASP.NET Core, EF Core has been rewrit\", \"ten from the ground up to support modular\\ncross-platform applications. You add it to your applicatio\", \"n as a NuGet package, configure it during\\napp startup, and request it through dependency injection w\", \"herever you need it.\\n\\nTo use EF Core with a SQL Server database, run the following dotnet CLI comman\", \"d:\\n\\ndotnet add package Microsoft. EntityFrameworkCore.SqlServer\\n\\nTo add support for an INMemory data\", \" source, for testing:\\n\\ndotnet add package Microsoft. EntityFrameworkCore. InMemory\\nThe DbContext\\n\\nTo\", \" work with EF Core, you need a subclass of DoContext. This class holds properties representing\\ncolle\", \"ctions of the entities your application will work with. The eshopOnWeb sample includes a\\nCatalogCont\", \"ext with collections for items, brands, and types:\\n\\n69 CHAPTER 7 | Working with Data in ASP.NET Core\", \" Apps\\npublic class CatalogContext : DbContext\\n\\n{\\npublic CatalogContext(DbContextOptions<CatalogConte\", \"xt> options) : base(options)\\n\\n{\\n\\n}\\n\\npublic DbSet<CatalogItem> CatalogItems { get; set; }\\npublic DbSe\", \"t<CatalogBrand> CatalogBrands { get; set; }\\npublic DbSet<CatalogType> CatalogTypes { get; set; }\\n\\nYo\", \"ur DbContext must have a constructor that accepts DoContextOptions and pass this argument to\\nthe bas\", \"e DbContext constructor. If you have only one DbContext in your application, you can pass an\\ninstanc\", \"e of DoContextOptions, but if you have more than one you must use the generic\\nDbContextOptions<T> ty\", \"pe, passing in your DoContext type as the generic parameter.\\n\\nConfiguring EF Core\\n\\nIn your ASP.NET C\", \"ore application, you'll typically configure EF Core in Program.cs with your\\napplication\\u2019s other depe\", \"ndencies. EF Core uses a DoContextOptionsBuilder, which supports several\\nhelpful extension methods t\", \"o streamline its configuration. To configure CatalogContext to use a SQL\\nServer database with a conn\", \"ection string defined in Configuration, you would add the following code:\\n\\nbuilder.Services.AddDbCon\", \"text<CatalogContext > (\\noptions => options.UseSqlServer(\\nbuilder .Configuration.GetConnectionString(\", \"\\\"DefaultConnection\\\") ) ) ;\\n\\nTo use the in-memory database:\\n\\nOnce you have installed EF Core, created\", \" a DoContext child type, and added the type to the\\napplication's services, you are ready to use EF C\", \"ore. You can request an instance of your DoContext\\ntype in any service that needs it and start worki\", \"ng with your persisted entities using LINQ as if they\\nwere simply in a collection. EF Core does the \", \"work of translating your LINQ expressions into SQL\\nqueries to store and retrieve your data.\\n\\nYou can\", \" see the queries EF Core is executing by configuring a logger and ensuring its level is set to at\\nle\", \"ast Information, as shown in Figure 8-1.\\n\\n70 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n& C:\", \"\\\\Program Files\\\\dotnet\\\\dotnet.exe \\u2014 O x\\n\\nFigure 8-7. Logging EF Core queries to the console\\n\\nFetching\", \" and storing Data\\n\\nTo retrieve data from EF Core, you access the appropriate property and use LINQ t\", \"o filter the result.\\nYou can also use LINQ to perform projection, transforming the result from one t\", \"ype to another. The\\nfollowing example would retrieve CatalogBrands, ordered by name, filtered by the\", \"ir Enabled property,\\nand projected onto a SelectListltem type:\\n\\nvar brandItems = await _context.Cata\", \"logBrands\\n-Where(b => b.Enabled)\\n-OrderBy(b => b.Name)\\n\\n.Select(b => new SelectListItem {\\nValue = b.\", \"Id, Text = b.Name })\\n. TOListAsync();\\n\\nIt's important in the above example to add the call to ToList\", \"Async in order to execute the query\\nimmediately. Otherwise, the statement will assign an I|Queryable\", \"<SelectListltem> to branditems,\\nwhich will not be executed until it is enumerated. There are pros an\", \"d cons to returning |Queryable\\nresults from methods. It allows the query EF Core will construct to b\", \"e further modified, but can also\\nresult in errors that only occur at run time, if operations are add\", \"ed to the query that EF Core cannot\\ntranslate. It\\u2019s generally safer to pass any filters into the met\", \"hod performing the data access, and return\\nback an in-memory collection (for example, List<T>) as th\", \"e result.\\n\\nEF Core tracks changes on entities it fetches from persistence. To save changes to a trac\", \"ked entity, you\\njust call the SaveChangesAsync method on the DbContext, making sure it\\u2019s the same Db\", \"Context\\ninstance that was used to fetch the entity. Adding and removing entities is directly done on\", \" the\\nappropriate DbSet property, again with a call to SaveChangesAsync to execute the database\\ncomma\", \"nds. The following example demonstrates adding, updating, and removing entities from\\npersistence.\\n\\n7\", \"1 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\n// create\\n\\nvar newBrand = new CatalogBrand() { \", \"Brand = \\\"Acme\\\" };\\n_context.Add(newBrand) ;\\n\\nawait _context.SaveChangesAsync();\\n\\n// read and update\\nv\", \"ar existingBrand = _context.CatalogBrands.Find(1);\\n\\nexistingBrand.Brand = \\\"Updated Brand\\\";\\nawait _co\", \"ntext.SaveChangesAsync();\\n\\n// read and delete (alternate Find syntax)\\n\\nvar brandToDelete = _context.\", \"Find<CatalogBrand> (2) ;\\n_context.CatalogBrands.Remove(brandToDelete) ;\\n\\nawait _context.SaveChangesA\", \"sync();\\n\\nEF Core supports both synchronous and async methods for fetching and saving. In web applica\", \"tions,\\nit's recommended to use the async/await pattern with the async methods, so that web server th\", \"reads\\nare not blocked while waiting for data access operations to complete.\\n\\nFor more information, s\", \"ee Buffering and Streaming.\\n\\nFetching related data\\n\\nWhen EF Core retrieves entities, it populates al\", \"l of the properties that are stored directly with that\\nentity in the database. Navigation properties\", \", such as lists of related entities, are not populated and\\nmay have their value set to null. This pr\", \"ocess ensures EF Core is not fetching more data than is\\nneeded, which is especially important for we\", \"b applications, which must quickly process requests and\\nreturn responses in an efficient manner. To \", \"include relationships with an entity using eager loading,\\nyou specify the property using the Include\", \" extension method on the query, as shown:\\n\\n// .Include requires using Microsoft.EntityFrameworkCore\\n\", \"var brandsWithItems = await _context.CatalogBrands\\n\\n-Include(b => b.Items)\\n. TOListAsync();\\n\\nYou can\", \" include multiple relationships, and you can also include subrelationships using ThenInclude.\\nEF Cor\", \"e will execute a single query to retrieve the resulting set of entities. Alternately you can include\", \"\\nnavigation properties of navigation properties by passing a \\u2019.'-separated string to the .Include()\\n\", \"extension method, like so:\\n\\n.Include(\\\"Items.Products\\\" )\\n\\nIn addition to encapsulating filtering logi\", \"c, a specification can specify the shape of the data to be\\nreturned, including which properties to p\", \"opulate. The eshopOnWeb sample includes several\\nspecifications that demonstrate encapsulating eager \", \"loading information within the specification. You\\ncan see how the specification is used as part of a\", \" query here:\\n\\n// Includes all expression-based includes\\nquery = specification. Includes .Aggregate(q\", \"uery,\\n(current, include) => current. Include(include) ) ;\\n\\n// Include any string-based include state\", \"ments\\nquery = specification. IncludeStrings .Aggregate(query,\\n(current, include) => current. Include\", \"(include) ) ;\\n\\n72 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\nAnother option for loading rela\", \"ted data Is to use explicit loading. Explicit loading allows you to load\\nadditional data into an ent\", \"ity that has already been retrieved. Since this approach involves a separate\\nrequest to the database\", \", it\\u2019s not recommended for web applications, which should minimize the\\nnumber of database round trip\", \"s made per request.\\n\\nLazy loading is a feature that automatically loads related data as it is refere\", \"nced by the application. EF\\nCore has added support for lazy loading in version 2.1. Lazy loading is \", \"not enabled by default and\\nrequires installing the Microsoft.EntityFrameworkCore.Proxies. As with ex\", \"plicit loading, lazy loading\\nshould typically be disabled for web applications, since its use will r\", \"esult in additional database\\nqueries being made within each web request. Unfortunately, the overhead\", \" incurred by lazy loading\\noften goes unnoticed at development time, when the latency is small and of\", \"ten the data sets used for\\ntesting are small. However, in production, with more users, more data, an\", \"d more latency, the\\nadditional database requests can often result in poor performance for web applic\", \"ations that make\\nheavy use of lazy loading.\\n\\nAvoid Lazy Loading Entities in Web Applications\\n\\nIt's a\", \" good idea to test your application while examining the actual database queries it makes. Under\\ncert\", \"ain circumstances, EF Core may make many more queries or a more expensive query than is\\noptimal for \", \"the application. One such problem is known as a Cartesian Explosion. The EF Core team\\nmakes availabl\", \"e the AsSplitQuery method as one of several ways to tune runtime behavior.\\n\\nEncapsulating data\\n\\nEF C\", \"ore supports several features that allow your model to properly encapsulate its state. A common\\nprob\", \"lem in domain models is that they expose collection navigation properties as publicly accessible\\nlis\", \"t types. This problem allows any collaborator to manipulate the contents of these collection types,\\n\", \"which may bypass important business rules related to the collection, possibly leaving the object in \", \"an\\ninvalid state. The solution to this problem is to expose read-only access to related collections,\", \" and\\nexplicitly provide methods defining ways in which clients can manipulate them, as in this examp\", \"le:\\n\\npublic class Basket : BaseEntity\\n{\\n\\npublic string BuyerId { get; set; }\\nprivate readonly List<B\", \"asketItem> _items = new List<BasketItem>() ;\\npublic IReadOnlyCollection<BasketItem> Items => _items.\", \"AsReadOnly();\\n\\npublic void AddItem(int catalogItemId, decimal unitPrice, int quantity = 1)\\n\\n{\\nvar ex\", \"istingItem = Items.FirstOrDefault(i => i.CatalogItemId == catalogItemId) ;\\nif (existingItem == null)\", \"\\n\\n_items.Add(new BasketItem()\\n{\\nCatalogItemId = catalogItemId,\\nQuantity = quantity,\\nUnitPrice = unit\", \"Price\\n})5\\n}\\n\\nelse existingItem.Quantity += quantity;\\n\\n73 CHAPTER 7 | Working with Data in ASP.NET Co\", \"re Apps\\nThis entity type doesn't expose a public List or ICollection property, but instead exposes a\", \"n\\nIReadOnlyCollection type that wraps the underlying List type. When using this pattern, you can\\nind\", \"icate to Entity Framework Core to use the backing field like so:\\n\\nprivate void ConfigureBasket(Entit\", \"yTypeBuilder<Basket> builder)\\n{\\n\\nvar navigation = builder .Metadata.FindNavigation(nameof(Basket.Ite\", \"ms) ) ;\\n\\nnavigation.SetPropertyAccessMode(PropertyAccessMode. Field) ;\\n\\n}\\n\\nAnother way in which you \", \"can improve your domain model is by using value objects for types that\\nlack identity and are only di\", \"stinguished by their properties. Using such types as properties of your\\nentities can help keep logic\", \" specific to the value object where it belongs, and can avoid duplicate logic\\nbetween multiple entit\", \"ies that use the same concept. In Entity Framework Core, you can persist value\\nobjects in the same t\", \"able as their owning entity by configuring the type as an owned entity, like so:\\n\\nprivate void Confi\", \"gureOrder(EntityTypeBuilder<Order> builder)\\n\\nbuilder.OwnsOne(o => o.ShipToAddress) ;\\n\\n}\\n\\nIn this exa\", \"mple, the ShipToAddress property is of type Address. Address is a value object with several\\nproperti\", \"es such as Street and City. EF Core maps the Order object to its table with one column per\\nAddress p\", \"roperty, prefixing each column name with the name of the property. In this example, the\\nOrder table \", \"would include columns such as ShipToAddress_ Street and ShipToAddress_City. It\\u2019s also\\npossible to st\", \"ore owned types in separate tables, if desired.\\n\\nLearn more about owned entity support in EF Core.\\n\\n\", \"Resilient connections\\n\\nExternal resources like SQL databases may occasionally be unavailable. In cas\", \"es of temporary\\nunavailability, applications can use retry logic to avoid raising an exception. This\", \" technique is\\ncommonly referred to as connection resiliency. You can implement your own retry with e\", \"xponential\\nbackoff technique by attempting to retry with an exponentially increasing wait time, unti\", \"l a maximum\\nretry count has been reached. This technique embraces the fact that cloud resources migh\", \"t\\nintermittently be unavailable for short periods of time, resulting in the failure of some requests\", \".\\n\\nFor Azure SQL DB, Entity Framework Core already provides internal database connection resiliency\\n\", \"and retry logic. But you need to enable the Entity Framework execution strategy for each DoContext\\nc\", \"onnection if you want to have resilient EF Core connections.\\n\\nFor instance, the following code at th\", \"e EF Core connection level enables resilient SQL connections that\\nare retried if the connection fail\", \"s.\\n\\nbuilder.Services.AddDbContext<OrderingContext>(options =>\\n\\n{\\n\\noptions.UseSqlServer (builder .Con\", \"figuration| \\\"ConnectionString\\\" J,\\nsqlServerOptionsAction: sqlOptions =>\\n\\n{\\nsqlOptions.EnableRetryOnF\", \"ailure(\\n\\nmaxRetryCount: 5,\\n\\n74 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\nmaxRetryDelay: Tim\", \"eSpan.FromSeconds(30),\\nerrorNumbersToAdd: null) ;\\n\\nExecution strategies and explicit transactions us\", \"ing BeginTransaction and multiple\\nDbContexts\\n\\nWhen retries are enabled in EF Core connections, each \", \"operation you perform using EF Core becomes\\nits own retryable operation. Each query and each call to\", \" SaveChangesAsync will be retried as a unit if a\\ntransient failure occurs.\\n\\nHowever, if your code in\", \"itiates a transaction using BeginTransaction, you are defining your own group\\nof operations that nee\", \"d to be treated as a unit; everything inside the transaction has to be rolled back\\nif a failure occu\", \"rs. You will see an exception like the following if you attempt to execute that\\ntransaction when usi\", \"ng an EF execution strategy (retry policy) and you include several\\nSaveChangesAsync from multiple Db\", \"Contexts in it.\\n\\nSystem.InvalidOperationException: The configured execution strategy\\nSqlServerRetryi\", \"ngExecutionStrategy does not support user initiated transactions. Use the execution\\nstrategy returne\", \"d by DbContext.Database.CreateExecutionStrategy() to execute all the operations in\\nthe transaction a\", \"s a retryable unit.\\n\\nThe solution is to manually invoke the EF execution strategy with a delegate re\", \"presenting everything\\nthat needs to be executed. If a transient failure occurs, the execution strate\", \"gy will invoke the delegate\\nagain. The following code shows how to implement this approach:\\n\\n// Use \", \"of an EF Core resiliency strategy when using multiple DbContexts\\n// within an explicit transaction\\n/\", \"/ See:\\n// https://learn.microsoft.com/ef/core/miscellaneous/connection-resiliency\\nvar strategy = _ca\", \"talogContext.Database.CreateExecutionStrategy() ;\\nawait strategy.ExecuteAsync(async () =>\\n{\\n// Achie\", \"ving atomicity between original Catalog database operation and the\\n// IntegrationEventLog thanks to \", \"a local transaction\\nuSing (var transaction = _catalogContext.Database.BeginTransaction() )\\n{\\n_catalo\", \"gContext.CatalogItems.Update(catalogItem) ;\\nawait _catalogContext.SaveChangesAsync() ;\\n\\n// Save to E\", \"ventLog only if product price changed\\nif (raiseProductPriceChangedEvent )\\n\\n{\\n\\nawait _integrationEven\", \"tLogService.SaveEventAsync(priceChangedEvent ) ;\\ntransaction. Commit () ;\\n\\n}\\n}\\n})3\\nThe first DoConte\", \"xt is the _catalogContext and the second DbContext is within the\\n_integrationEventLogService object.\", \" Finally, the Commit action would be performed multiple\\nDbContexts and using an EF Execution Strateg\", \"y.\\n\\n15 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\nReferences \\u2014 Entity Framework Core\\n\\n\\u00b0 EF C\", \"ore Docs hitps://learn.microsoft.com/ef/\\n\\n\\u00b0 EF Core: Related Data hittps://learn.microsoft.com/ef/co\", \"re/querying/related-data\\n. Avoid Lazy Loading Entities in ASPNET Applications https://ardalis.com/av\", \"oid-lazy-\\nloading-entities-in-asp-net-applications\\n\\nEF Core or micro-ORM?\\n\\nWhile EF Core is a great \", \"choice for managing persistence, and for the most part encapsulates\\ndatabase details from applicatio\", \"n developers, it isn't the only choice. Another popular open-source\\nalternative is Dapper, a so-call\", \"ed micro-ORM. A micro-ORM is a lightweight, less full-featured tool for\\nmapping objects to data stru\", \"ctures. In the case of Dapper, its design goals focus on performance,\\nrather than fully encapsulatin\", \"g the underlying queries it uses to retrieve and update data. Because it\\ndoesn\\u2019t abstract SQL from t\", \"he developer, Dapper is \\u201ccloser to the metal\\u201d and lets developers write the\\nexact queries they want \", \"to use for a given data access operation.\\n\\nEF Core has two significant features it provides which se\", \"parate it from Dapper but also add to its\\nperformance overhead. The first is the translation from LI\", \"NQ expressions into SQL. These translations\\nare cached, but even so there is overhead in performing \", \"them the first time. The second is change\\ntracking on entities (so that efficient update statements \", \"can be generated). This behavior can be\\nturned off for specific queries by using the AsNoTracking ex\", \"tension. EF Core also generates SQL\\nqueries that usually are very efficient and in any case perfectl\", \"y acceptable from a performance\\nstandpoint, but if you need fine control over the precise query to b\", \"e executed, you can pass in custom\\nSQL (or execute a stored procedure) using EF Core, too. In this c\", \"ase, Dapper still outperforms EF Core,\\nbut only very slightly. Current performance benchmark data fo\", \"r a variety of data access methods can\\n\\nbe found on the Dapper site.\\n\\nTo see how the syntax for Dapp\", \"er varies from EF Core, consider these two versions of the same\\nmethod for retrieving a list of item\", \"s:\\n\\n// EF Core\\n\\nprivate readonly CatalogContext _context;\\n\\npublic async Task<IEnumerable<CatalogType\", \">> GetCatalogTypes()\\n{\\n\\nreturn await _context.CatalogTypes.ToListAsync();\\n\\n}\\n\\n// Dapper\\nprivate read\", \"only SqlConnection _conn;\\npublic async Task<IEnumerable<CatalogType>> GetCatalogTypesWithDapper ( )\\n\", \"{\\nreturn await _conn.QueryAsync<CatalogType>(\\\"SELECT * FROM CatalogType\\\") ;\\n\\n}\\n\\nIf you need to build\", \" more complex object graphs with Dapper, you need to write the associated\\nqueries yourself (as oppos\", \"ed to adding an Include as you would in EF Core). This functionality is\\nsupported through various sy\", \"ntaxes, including a feature called Multi Mapping that lets you map\\nindividual rows to multiple mappe\", \"d objects. For example, given a class Post with a property Owner of\\ntype User, the following SQL wou\", \"ld return all of the necessary data:\\n\\n76 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\nselect *\", \" from #Posts p\\n\\nleft join #Users u on u.Id = p.OwnerId\\nOrder by p.Id\\n\\nEach returned row includes bot\", \"h User and Post data. Since the User data should be attached to the\\nPost data via its Owner property\", \", the following function is used:\\n\\n(post, user) => { post.Owner = user; return post; }\\n\\nThe full cod\", \"e listing to return a collection of posts with their Owner property populated with the\\nassociated us\", \"er data would be:\\n\\nvar sgl = @\\\"select * from #Posts p\\nleft join #Users u on u.Id = p.OwneriId\\n\\nOrder\", \" by p.Id\\\";\\nvar data = connection.Query<Post, User, Post>(sql,\\n(post, user) => { post.Owner = user; r\", \"eturn post;});\\n\\nBecause it offers less encapsulation, Dapper requires developers know more about how\", \" their data is\\nstored, how to query it efficiently, and write more code to fetch it. When the model \", \"changes, instead\\nof simply creating a new migration (another EF Core feature), and/or updating mappi\", \"ng information\\nin one place in a DoContext, every query that is impacted must be updated. These quer\", \"ies have no\\ncompile-time guarantees, so they may break at run time in response to changes to the mod\", \"el or\\ndatabase, making errors more difficult to detect quickly. In exchange for these tradeoffs, Dap\", \"per\\noffers extremely fast performance.\\n\\nFor most applications, and most parts of almost all applicat\", \"ions, EF Core offers acceptable\\nperformance. Thus, its developer productivity benefits are likely to\", \" outweigh its performance\\noverhead. For queries that can benefit from caching, the actual query may \", \"only be executed a tiny\\npercentage of the time, making relatively small query performance difference\", \"s moot.\\n\\nSQL or NoSQL\\n\\nTraditionally, relational databases like SQL Server have dominated the market\", \"place for persistent data\\nstorage, but they are not the only solution available. NoSQL databases lik\", \"e MongoDB offer a different\\napproach to storing objects. Rather than mapping objects to tables and r\", \"ows, another option is to\\nserialize the entire object graph, and store the result. The benefits of t\", \"his approach, at least initially,\\nare simplicity and performance. It's simpler to store a single ser\", \"ialized object with a key than to\\ndecompose the object into many tables with relationships and updat\", \"e rows that may have changed\\nsince the object was last retrieved from the database. Likewise, fetchi\", \"ng and deserializing a single\\nobject from a key-based store is typically much faster and easier than\", \" complex joins or multiple\\ndatabase queries required to fully compose the same object from a relatio\", \"nal database. The lack of\\nlocks or transactions or a fixed schema also makes NoSQL databases amenabl\", \"e to scaling across many\\nmachines, supporting very large datasets.\\n\\nOn the other hand, NoSQL databas\", \"es (as they are typically called) have their drawbacks. Relational\\ndatabases use normalization to en\", \"force consistency and avoid duplication of data. This approach\\nreduces the total size of the databas\", \"e and ensures that updates to shared data are available\\nimmediately throughout the database. In a re\", \"lational database, an Address table might reference a\\n\\n77 CHAPTER 7 | Working with Data in ASP.NET C\", \"ore Apps\\nCountry table by ID, such that if the name of a country/region were changed, the address re\", \"cords\\nwould benefit from the update without themselves having to be updated. However, in a NoSQL\\ndat\", \"abase, Address, and its associated Country might be serialized as part of many stored objects. An\\nup\", \"date to a country/region name would require all such objects to be updated, rather than a single\\nrow\", \". Relational databases can also ensure relational integrity by enforcing rules like foreign keys.\\nNo\", \"SQL databases typically do not offer such constraints on their data.\\n\\nAnother complexity NoSQL datab\", \"ases must deal with is versioning. When an object's properties\\nchange, it may not be able to be dese\", \"rialized from past versions that were stored. Thus, all existing\\nobjects that have a serialized (pre\", \"vious) version of the object must be updated to conform to its new\\nschema. This approach is not conc\", \"eptually different from a relational database, where schema\\nchanges sometimes require update scripts\", \" or mapping updates. However, the number of entries that\\nmust be modified is often much greater in t\", \"he NoSQL approach, because there is more duplication of\\ndata.\\n\\nIt's possible in NoSQL databases to s\", \"tore multiple versions of objects, something fixed schema\\nrelational databases typically do not supp\", \"ort. However, in this case, your application code will need to\\naccount for the existence of previous\", \" versions of objects, adding additional complexity.\\n\\nNoSQL databases typically do not enforce ACID, \", \"which means they have both performance and\\nscalability benefits over relational databases. They're w\", \"ell suited to extremely large datasets and\\nobjects that are not well suited to storage in normalized\", \" table structures. There is no reason why a\\nsingle application cannot take advantage of both relatio\", \"nal and NoSQL databases, using each where it\\nis best suited.\\n\\nAzure Cosmos DB\\n\\nAzure Cosmos DB is a \", \"fully managed NoSQL database service that offers cloud-based schema-free\\ndata storage. Azure Cosmos \", \"DB is built for fast and predictable performance, high availability, elastic\\nscaling, and global dis\", \"tribution. Despite being a NoSQL database, developers can use rich and familiar\\nSQL query capabiliti\", \"es on JSON data. All resources in Azure Cosmos DB are stored as JSON\\ndocuments. Resources are manage\", \"d as items, which are documents containing metadata, and feeds,\\nwhich are collections of items. Figu\", \"re 8-2 shows the relationship between different Azure Cosmos DB\\nresources.\\n\\n78 CHAPTER 7 | Working w\", \"ith Data in ASP.NET Core Apps\\n14 la} Q\\n\\nAzure Cosmos DB Database Collections Documents Attachments\\nA\", \"ccount fdbs/{id} foalls/fid} /docs/{id} /attachments/{ic}\\n\\nUsers\\n\\nStored Procedures\\n\\nfusers/{icl} \\u2018s\", \"procs/{id}\\n\\nC.\\n\\nPermissions Triggers\\n\\u2018permissions/{id} /triqgers/fid}\\n\\n-\\n\\nUser Defined Functions\\n/fu\", \"nctionsid}\\n\\nFigure 8-2. Azure Cosmos DB resource organization.\\n\\nThe Azure Cosmos DB query language I\", \"s a simple yet powerful interface for querying JSON\\ndocuments. The language supports a subset of ANS\", \"I SQL grammar and adds deep integration of\\nJavaScript object, arrays, object construction, and funct\", \"ion invocation.\\n\\nReferences \\u2014 Azure Cosmos DB\\n\\n\\u00b0 Azure Cosmos DB Introduction https://learn.microsof\", \"t.com/azure/cosmos-db/introduction\\n\\nOther persistence options\\n\\nIn addition to relational and NoSQL s\", \"torage options, ASP.NET Core applications can use Azure\\nStorage to store various data formats and fi\", \"les in a cloud-based, scalable fashion. Azure Storage is\\nmassively scalable, so you can start out st\", \"oring small amounts of data and scale up to storing\\nhundreds or terabytes if your application requir\", \"es it. Azure Storage supports four kinds of data:\\n\\n. Blob Storage for unstructured text or binary st\", \"orage, also referred to as object storage.\\n. Table Storage for structured datasets, accessible via r\", \"ow keys.\\n\\n. Queue Storage for reliable queue-based messaging.\\n\\n79 CHAPTER 7 | Working with Data in A\", \"SP.NET Core Apps\\n. File Storage for shared file access between Azure virtual machines and on-premise\", \"s\\napplications.\\n\\nReferences \\u2014 Azure Storage\\n\\n. Azure Storage Introduction https://learn.microsoft.co\", \"m/azure/storage/common/storage-\\n\\nintroduction\\n\\nCaching\\n\\nIn web applications, each web request should\", \" be completed in the shortest time possible. One way to\\nachieve this functionality is to limit the n\", \"umber of external calls the server must make to complete the\\nrequest. Caching involves storing a cop\", \"y of data on the server (or another data store that is more\\neasily queried than the source of the da\", \"ta). Web applications, and especially non-SPA traditional web\\napplications, need to build the entire\", \" user interface with every request. This approach frequently\\ninvolves making many of the same databa\", \"se queries repeatedly from one user request to the next. In\\nmost cases, this data changes rarely, so\", \" there is little reason to constantly request it from the\\ndatabase. ASP.NET Core supports response c\", \"aching, for caching entire pages, and data caching, which\\nsupports more granular caching behavior.\\n\\n\", \"When implementing caching, it\\u2019s important to keep in mind separation of concerns. Avoid\\nimplementing\", \" caching logic in your data access logic, or in your user interface. Instead, encapsulate\\ncaching in\", \" its own classes, and use configuration to manage its behavior. This approach follows the\\nOpen/Close\", \"d and Single Responsibility principles, and will make it easier for you to manage how you\\nuse cachin\", \"g in your application as it grows.\\n\\nASP.NET Core response caching\\n\\nASP.NET Core supports two levels \", \"of response caching. The first level does not cache anything on the\\nserver, but adds HTTP headers th\", \"at instruct clients and proxy servers to cache responses. This\\nfunctionality is implemented by addin\", \"g the ResponseCache attribute to individual controllers or\\nactions:\\n\\n[ResponseCache(Duration = 60) |\", \"\\npublic IActionResult Contact()\\n\\n{\\n\\nViewData[\\\"Message\\\"]| = \\\"Your contact page.\\\";\\nreturn View();\\n\\n}\\n\\n\", \"The previous example will result in the following header being added to the response, instructing\\ncl\", \"ients to cache the result for up to 60 seconds.\\n\\nCache-Control: public,max-age=60\\n\\nIn order to add s\", \"erver-side in-memory caching to the application, you must reference the\\nMicrosoft.AsoNetCore.Respons\", \"eCaching NuGet package, and then add the Response Caching\\nmiddleware. This middleware is configured \", \"with services and middleware during app startup:\\n\\n80 CHAPTER 7 | Working with Data in ASP.NET Core A\", \"pps\\nbuilder.Services.AddResponseCaching() ;\\n\\n// other code omitted, including building the app\\n\\napp.\", \"UseResponseCaching() ;\\n\\nThe Response Caching Middleware will automatically cache responses based on \", \"a set of conditions,\\nwhich you can customize. By default, only 200 (OK) responses requested via GET \", \"or HEAD methods\\nare cached. In addition, requests must have a response with a Cache-Control: public \", \"header, and\\ncannot include headers for Authorization or Set-Cookie. See a complete list of the cachi\", \"ng conditions\\n\\nused by the response caching middleware.\\n\\nData caching\\n\\nRather than (or in addition t\", \"o) caching full web responses, you can cache the results of individual data\\nqueries. For this functi\", \"onality, you can use in memory caching on the web server, or use a distributed\\ncache. This section w\", \"ill demonstrate how to implement in memory caching.\\n\\nAdd support for memory (or distributed) caching\", \" with the following code:\\n\\nbuilder.Services.AddMemoryCache() ;\\nbuilder .Services.AddMvc();\\nBe sure t\", \"o add the Microsoft.Extensions.Caching.Memory NuGet package as well.\\n\\nOnce you've added the service,\", \" you request |[MemoryCache via dependency injection wherever you\\nneed to access the cache. In this e\", \"xample, the CachedCatalogService is using the Proxy (or Decorator)\\ndesign pattern, by providing an a\", \"lternative implementation of ICatalogService that controls access to\\n(or adds behavior to) the under\", \"lying CatalogService implementation.\\n\\npublic class CachedCatalogService : ICatalogService\\n{\\nprivate \", \"readonly IMemoryCache _cache;\\nprivate readonly CatalogService _catalogService;\\nprivate static readon\", \"ly string _brandsKey = \\\"brands\\\";\\nprivate static readonly string _typesKey = \\\"types\\\";\\nprivate static \", \"readonly TimeSpan _defaultCacheDuration = TimeSpan.FromSeconds(3@);\\n\\npublic CachedCatalogService(\\nIM\", \"emoryCache cache,\\nCatalogService catalogService)\\n{\\n_cache = cache;\\n_catalogService = catalogService;\", \"\\n\\n}\\n\\npublic async Task<IEnumerable<SelectListItem>> GetBrands()\\n\\n{\\n\\nreturn await _cache.GetOrCreateA\", \"sync(_brandsKey, async entry =>\\n\\n{\\nentry.SlidingExpiration = _defaultCacheDuration;\\nreturn await _ca\", \"talogService.GetBrands() ;\\n\\n})3\\n}\\n\\npublic async Task<Catalog> GetCatalogItems(int pageIndex, int ite\", \"msPage, int? brandID,\\n\\n81 CHAPTER 7 | Working with Data in ASP.NET Core Apps\\nint? typelId)\\n\\nstring c\", \"acheKey = $\\\"items-{pageIndex}-{itemsPage}-{brandID}-{typeId}\\\";\\nreturn await _cache.GetOrCreateAsync(\", \"cacheKey, async entry =>\\n{\\nentry.SlidingExpiration = _defaultCacheDuration;\\nreturn await _catalogSer\", \"vice.GetCatalogitems(pageIndex, itemsPage, brandID,\\ntypeld) ;\\n})3\\n}\\n\\npublic async Task<IEnumerable<S\", \"electListItem>> GetTypes()\\n{\\nreturn await _cache.GetOrCreateAsync(_typesKey, async entry =>\\n{\\nentry.\", \"SlidingExpiration = _defaultCacheDuration;\\nreturn await _catalogService.GetTypes();\\n})3\\n}\\n\\nTo config\", \"ure the application to use the cached version of the service, but still allow the service to get\\nthe\", \" instance of CatalogService it needs in its constructor, you would add the following lines in\\nProgra\", \"m.cs:\\n\\nbuilder.Services.AddMemoryCache() ;\\n\\nbuilder.Services.AddScoped<ICatalogService, CachedCatalo\", \"gService>();\\nbuilder.Services.AddScoped<CatalogService>() ;\\n\\nWith this code in place, the database c\", \"alls to fetch the catalog data will only be made once per\\nminute, rather than on every request. Depe\", \"nding on the traffic to the site, this can have a significant\\nimpact on the number of queries made t\", \"o the database, and the average page load time for the home\\npage that currently depends on all three\", \" of the queries exposed by this service.\\n\\nAn issue that arises when caching is implemented is stale \", \"data \\u2014 that is, data that has changed at the\\nsource but an out-of-date version remains in the cache.\", \" A simple way to mitigate this issue is to use\\nsmall cache durations, since for a busy application t\", \"here is a limited additional benefit to extending\\nthe length data is cached. For example, consider a\", \" page that makes a single database query, and is\\nrequested 10 times per second. If this page is cach\", \"ed for one minute, it will result in the number of\\ndatabase queries made per minute to drop from 600\", \" to 1, a reduction of 99.8%. If instead the cache\\nduration was made one hour, the overall reduction \", \"would be 99.997%, but now the likelihood and\\npotential age of stale data are both increased dramatic\", \"ally.\\n\\nAnother approach is to proactively remove cache entries when the data they contain is updated\", \". Any\\nindividual entry can be removed if its key is known:\\n\\n_cache.Remove(cacheKey) ;\\n\\nIf your appli\", \"cation exposes functionality for updating entries that it caches, you can remove the\\ncorresponding c\", \"ache entries in your code that performs the updates. Sometimes there may be many\\ndifferent entries t\", \"hat depend on a particular set of data. In that case, it can be useful to create\\ndependencies betwee\", \"n cache entries, by using a CancellationChangeToken. With a\\nCancellationChangeToken, you can expire \", \"multiple cache entries at once by canceling the token.\\n\\n82 CHAPTER 7 | Working with Data in ASP.NET \", \"Core Apps\\n// configure CancellationToken and add entry to cache\\nvar cts = new CancellationTokenSourc\", \"e() ;\\n_cache.Set(\\\"cts\\\", cts);\\n\\n_cache.Set(cacheKey, itemToCache, new CancellationChangeToken(cts. To\", \"ken) ) ;\\n\\n// elsewhere, expire the cache by cancelling the token\\\\\\n_cache.Get<CancellationTokenSource\", \">(\\\"cts\\\").Cancel();\\n\\nCaching can dramatically improve the performance of web pages that repeatedly re\", \"quest the same\\nvalues from the database. Be sure to measure data access and page performance before \", \"applying\\ncaching, and only apply caching where you see a need for improvement. Caching consumes web\\n\", \"server memory resources and increases the complexity of the application, so it\\u2019s important you don't\", \"\\nprematurely optimize using this technique.\\n\\nGetting data to Blazor WebAssembly apps\\n\\nIf you're buil\", \"ding apps that use Blazor Server, you can use Entity Framework and other direct data\\naccess technolo\", \"gies as they've been discussed thus far in this chapter. However, when building Blazor\\nWebAssembly a\", \"pps, like other SPA frameworks, you will need a different strategy for data access.\\nTypically, these\", \" applications access data and interact with the server through web API endpoints.\\n\\nIf the data or op\", \"erations being performed are sensitive, be sure to review the section on security in\\nthe previous ch\", \"apter and protect your APIs against unauthorized access.\\n\\nYou'll find an example of a Blazor WebAsse\", \"mbly app in the eShopOnWeb reference application, in the\\nBlazorAdmin project. This project is hosted\", \" within the eshopOnWeb Web project, and allows users in\\nthe Administrators group to manage the items\", \" in the store. You can see a screenshot of the\\napplication in Figure 8-3.\\n\\n\\u20ac Cc @ localhost:44315/Ad\", \"n FS Guest\\n\\neShopOnWeb Admin About eShopOnWeb\\n\\nManage Product Catalog\\n\\nItem Type Brand Id Name Descr\", \"iption Price Actions\\n\\n| Sheet Other 5 Roslyn Red Sheet Rosiyn Red Sheet 8.5\\na {\\nPT T-Shirt NET 4 .NE\", \"T Foundation Sweatshirt .NET Foundation Sweatshirt 12\\n> T-Shirt Other 3 Prism White T-Shirt Prism Wh\", \"ite T-Shirt 12\\n\\n& i\\n\\nI t\\n\\n5\\nMug NET 2. .NET Black & White Mug .NET Black & White Mug 8.50 EN\\n\\nap\\n\\nFi\", \"gure 8-3. eShopOnWeb Catalog Admin Screenshot.\\n\\n83 CHAPTER 7 | Working with Data in ASP.NET Core App\", \"s\\nWhen fetching data from web APIs within a Blazor WebAssembly app, you just use an instance of\\nHttp\", \"Client as you would in any .NET application. The basic steps involved are to create the request to\\ns\", \"end (if necessary, usually for POST or PUT requests), await the request itself, verify the status co\", \"de,\\nand deserialize the response. If you're going to make many requests to a given set of APIs, it\\u2019s\", \" a good\\nidea to encapsulate your APIs and configure the HttpClient base address centrally. This way,\", \" if you\\nneed to adjust any of these settings between environments, you can make the changes in just \", \"one\\nplace. You should add support for this service in your Program.Main:\\n\\nbuilder.Services.AddScoped\", \"(sp => new HttpClient\\n\\nBaseAddress = new Uri(builder.HostEnvironment.BaseAddress )\\n\\n})5\\n\\nIf you need\", \" to access services securely, you should access a secure token and configure the HttpClient\\nto pass \", \"this token as an Authentication header with every request:\\n\\n_httpClient.DefaultRequestHeaders.Author\", \"ization =\\n\\nnew AuthenticationHeaderValue(\\\"Bearer\\\", token) ;\\n\\nThis activity can be done from any comp\", \"onent that has the HttpClient injected into it, provided that\\nHttpClient wasn\\u2019t added to the applica\", \"tion\\u2019s services with a Transient lifetime. Every reference to\\nHttpClient in the application referenc\", \"es the same instance, so changes to it in one component flow\\nthrough the entire application. A good \", \"place to perform this authentication check (followed by\\nspecifying the token) is in a shared compone\", \"nt like the main navigation for the site. Learn more about\\nthis approach in the BlazorAdmin project \", \"in the eshopOnWeb reference application.\\n\\nOne benefit of Blazor WebAssembly over traditional JavaScr\", \"ipt SPAs is that you don\\u2019t need to keep\\ncopies of your data transfer objects(DTOs) synchronized. You\", \"r Blazor WebAssembly project and your\\nweb API project can both share the same DTOs in a common share\", \"d project. This approach eliminates\\nsome of the friction involved in developing SPAs.\\n\\nTo quickly ge\", \"t data from an API endpoint, you can use the built-in helper method, GetFromJsonAsync.\\nThere are sim\", \"ilar methods for POST, PUT, etc. The following shows how to get a Catalogltem from an\\nAPI endpoint u\", \"sing a configured HttpClient in a Blazor WebAssembly app:\\n\\nOnce you have the data you need, you'll t\", \"ypically track changes locally. When you want to make\\nupdates to the backend data store, you'll call\", \" additional web APIs for this purpose.\\n\\nReferences \\u2014 Blazor Data\\n\\n\\u00b0 Call a web API from ASP.NET Core\", \" Blazor https://learn.microsoft.com/aspnet/core/blazor/call-\\nweb-api\\n\\n84 CHAPTER 7 | Working with Da\", \"ta in ASP.NET Core Apps\\nCHAPTER\\n\\nTest ASP.NET Core MVC\\napps\\n\\n\\u201cIf you don't like unit testing your pr\", \"oduct, most likely your customers won't like to test it, either.\\u201d _-\\nAnonymous-\\n\\nSoftware of any com\", \"plexity can fail in unexpected ways in response to changes. Thus, testing after\\nmaking changes is re\", \"quired for all but the most trivial (or least critical) applications. Manual testing is\\nthe slowest,\", \" least reliable, most expensive way to test software. Unfortunately, if applications aren't\\ndesigned\", \" to be testable, it can be the only means of testing available. Applications written to follow\\nthe a\", \"rchitectural principles laid out in chapter 4 should be largely unit testable. ASP.NET Core\\napplicat\", \"ions support automated integration and functional testing.\\n\\nKinds of automated tests\\n\\nThere are many\", \" kinds of automated tests for software applications. The simplest, lowest level test is\\nthe unit tes\", \"t. At a slightly higher level, there are integration tests and functional tests. Other kinds of\\ntest\", \"s, such as Ul tests, load tests, stress tests, and smoke tests, are beyond the scope of this documen\", \"t.\\n\\nUnit tests\\n\\nA unit test tests a single part of your application's logic. One can further describ\", \"e it by listing some of\\nthe things that it isn\\u2019t. A unit test doesn\\u2019t test how your code works with \", \"dependencies or\\ninfrastructure \\u2014 that\\u2019s what integration tests are for. A unit test doesn\\u2019t test the\", \" framework your code\\nis written on \\u2014 you should assume it works or, if you find it doesn't, file a b\", \"ug and code a workaround.\\nA unit test runs completely in memory and in process. It doesn\\u2019t communica\", \"te with the file system, the\\nnetwork, or a database. Unit tests should only test your code.\\n\\nUnit te\", \"sts, by virtue of the fact that they test only a single unit of your code, with no external\\ndependen\", \"cies, should execute extremely fast. Thus, you should be able to run test suites of hundreds\\nof unit\", \" tests in a few seconds. Run them frequently, ideally before every push to a shared source\\ncontrol r\", \"epository, and certainly with every automated build on your build server.\\n\\nIntegration tests\\n\\nAlthou\", \"gh it's a good idea to encapsulate your code that interacts with infrastructure like databases\\nand f\", \"ile systems, you will still have some of that code, and you will probably want to test it.\\n\\n85 CHAPT\", \"ER 8 | Test ASP.NET Core MVC apps\\nAdditionally, you should verify that your code\\u2019s layers interact a\", \"s you expect when your application\\u2019s\\ndependencies are fully resolved. This functionality is the resp\", \"onsibility of integration tests. Integration\\ntests tend to be slower and more difficult to set up th\", \"an unit tests, because they often depend on\\nexternal dependencies and infrastructure. Thus, you shou\", \"ld avoid testing things that could be tested\\nwith unit tests in integration tests. If you can test a\", \" given scenario with a unit test, you should test it\\nwith a unit test. If you can't, then consider u\", \"sing an integration test.\\n\\nIntegration tests will often have more complex setup and teardown procedu\", \"res than unit tests. For\\nexample, an integration test that goes against an actual database will need\", \" a way to return the\\ndatabase to a known state before each test run. As new tests are added and the \", \"production database\\nschema evolves, these test scripts will tend to grow in size and complexity. In \", \"many large systems, It is\\nimpractical to run full suites of integration tests on developer workstati\", \"ons before checking in\\nchanges to shared source control. In these cases, integration tests may be ru\", \"n on a build server.\\n\\nFunctional tests\\n\\nIntegration tests are written from the perspective of the de\", \"veloper, to verify that some components of\\nthe system work correctly together. Functional tests are \", \"written from the perspective of the user, and\\nverify the correctness of the system based on its requ\", \"irements. The following excerpt offers a useful\\nanalogy for how to think about functional tests, com\", \"pared to unit tests:\\n\\n\\u201cMany times the development of a system is likened to the building of a house.\", \" While this analogy\\nisn't quite correct, we can extend it for the purposes of understanding the diff\", \"erence between unit\\nand functional tests. Unit testing is analogous to a building inspector visiting\", \" a house's construction\\nsite. He is focused on the various internal systems of the house, the founda\", \"tion, framing, electrical,\\nplumbing, and so on. He ensures (tests) that the parts of the house will \", \"work correctly and safely, that\\nis, meet the building code. Functional tests in this scenario are an\", \"alogous to the homeowner visiting\\nthis same construction site. He assumes that the internal systems \", \"will behave appropriately, that the\\nbuilding inspector is performing his task. The homeowner is focu\", \"sed on what it will be like to live in\\nthis house. He is concerned with how the house looks, are the\", \" various rooms a comfortable size, does\\nthe house fit the family\\u2019s needs, are the windows in a good \", \"spot to catch the morning sun. The\\nhomeowner is performing functional tests on the house. He has the\", \" user's perspective. The building\\ninspector is performing unit tests on the house. He has the builde\", \"r's perspective.\\u201d\\n\\nSource: Unit Testing versus Functional Tests\\n\\nI'm fond of saying \\u201cAs developers, \", \"we fail in two ways: we build the thing wrong, or we build the\\nwrong thing.\\u201d Unit tests ensure you a\", \"re building the thing right; functional tests ensure you are\\nbuilding the right thing.\\n\\nSince functi\", \"onal tests operate at the system level, they may require some degree of UI automation.\\nLike integrat\", \"ion tests, they usually work with some kind of test infrastructure as well. This activity\\nmakes them\", \" slower and more brittle than unit and integration tests. You should have only as many\\nfunctional te\", \"sts as you need to be confident the system is behaving as users expect.\\n\\nTesting Pyramid\\nMartin Fowl\", \"er wrote about the testing pyramid, an example of which is shown in Figure 9-1.\\n\\n86 CHAPTER 8 | Test\", \" ASP.NET Core MVC apps\\nFunctional\\nTests\\n\\nIntegration\\n\\nTests\\n\\nUnit\\nTests\\n\\nFigure 9-1. Testing Pyramid\", \"\\n\\nThe different layers of the pyramid, and their relative sizes, represent different kinds of tests \", \"and how\\nmany you should write for your application. As you can see, the recommendation is to have a \", \"large\\nbase of unit tests, supported by a smaller layer of integration tests, with an even smaller la\", \"yer of\\nfunctional tests. Each layer should ideally only have tests in it that cannot be performed ad\", \"equately at\\na lower layer. Keep the testing pyramid in mind when you are trying to decide which kind\", \" of test you\\nneed for a particular scenario.\\n\\nWhat to test\\n\\nA common problem for developers who are \", \"inexperienced with writing automated tests is coming up\\nwith what to test. A good starting point is \", \"to test conditional logic. Anywhere you have a method with\\nbehavior that changes based on a conditio\", \"nal statement (if-else, switch, and so on), you should be\\nable to come up with at least a couple of \", \"tests that confirm the correct behavior for certain conditions.\\nIf your code has error conditions, i\", \"t's good to write at least one test for the \\u201chappy path\\u201d through the\\ncode (with no errors), and at l\", \"east one test for the \\u201csad path\\u201d (with errors or atypical results) to\\nconfirm your application behav\", \"es as expected in the face of errors. Finally, try to focus on testing\\nthings that can fail, rather \", \"than focusing on metrics like code coverage. More code coverage is better\\nthan less, generally. Howe\", \"ver, writing a few more tests of a complex and business-critical method is\\nusually a better use of t\", \"ime than writing tests for auto-properties just to improve test code coverage\\nmetrics.\\n\\n87 CHAPTER 8\", \" | Test ASP.NET Core MVC apps\\nOrganizing test projects\\n\\nTest projects can be organized however works\", \" best for you. It's a good idea to separate tests by type\\n(unit test, integration test) and by what \", \"they are testing (by project, by namespace). Whether this\\nseparation consists of folders within a si\", \"ngle test project, or multiple test projects, is a design decision.\\nOne project is simplest, but for\", \" large projects with many tests, or in order to more easily run different\\nsets of tests, you might w\", \"ant to have several different test projects. Many teams organize test projects\\nbased on the project \", \"they are testing, which for applications with more than a few projects can result\\nin a large number \", \"of test projects, especially if you still break these down according to what kind of\\ntests are in ea\", \"ch project. A compromise approach is to have one project per kind of test, per\\napplication, with fol\", \"ders inside the test projects to indicate the project (and class) being tested.\\n\\nA common approach i\", \"s to organize the application projects under a \\u2018src\\u2019 folder, and the application's\\ntest projects und\", \"er a parallel \\u2018tests\\u2019 folder. You can create matching solution folders in Visual Studio, If\\nyou find\", \" this organization useful.\\n\\nSolution Explorer\\n\\na o- Alig] [s|- ALR\\n\\nSearch Solution Explorer (Ctrl+:\", \") PP -\\n\\nSteg Solution 'eShopOnWeb' (10 of 10 projects)\\n> [1 Solution Items\\nF src\\n> A[c4] Application\", \"Core\\n[ fed BlazorAdmin\\nb Alcs] BlazorShared\\nb Alcs] Infrastructure\\n[> bel PublicApi\\nb> \\u201ced Web\\n4 |) \", \"tests\\nb AT] FunctionalTests\\n> AT] Integration Tests\\n> a] UnitTests\\n\\nFigure 9-2. Test organization in\", \" your solution\\n\\nYou can use whichever test framework you prefer. The xUnit framework works well and \", \"is what all of\\nthe ASP.NET Core and EF Core tests are written in. You can add an xUnit test project \", \"in Visual Studio\\nusing the template shown in Figure 9-3, or from the CLI using dotnet new xunit.\\n\\n88\", \" CHAPTER 8 | Test ASP.NET Core MVC apps\\nAdd a new project\\n\\nRecent project templates\\n\\n] ASP.NET Core \", \"Web App\\n\\n\\u00a2\\n\\note) |\\n| |\\n\\nBlazor Server App\\n\\n@\\n@ Blazor WebAssembly App\\n\\nel\\n\\n} xUnit Test Project\\n\\n\\u00ab A\", \"SP.NET Web Application (.NET\\nFramework)\\n\\noe |\\n\\nASP.NET Clean Architecture Solution\\n(Steve Smith @ard\", \"alis, Erik Dahl)\\n\\n#8\\u00a7\\u00ab- Class Library\\n\\nc#\\n\\nc+\\n\\nc+\\n\\nc+\\n\\nc+\\n\\nc#\\n\\nc+\\n\\nxuni x\\npend Clear all\\n\\nAll langua\", \"ges - All platforms . All project types \\u2019\\n\\nFigure 9-3. Add an xUnit Test Project in Visual Studio\\n\\nT\", \"est naming\\n\\nxUnit Test Project\\nA project that contains x Unit.net tests that can run on .NET Core on\", \" Windows, Linux\\n\\nand MacOS.\\n\\nC# Linux macOS Windows Test\\n\\nxUnit Test Project\\n\\nA project that contain\", \"s xUnit.net tests that can run on .NET Core on Windows, Linux\\nand MacOS,\\n\\nVisual Basic Linux macOS W\", \"indows Test\\n\\nxUnit Test Project\\n\\nA project that contains xUnit.net tests that can run on .NET Core o\", \"n Windows, Linux\\nand MacOS,\\n\\nF# Linux macOS Windows Test\\n\\nNUnit Test Project\\n\\nA project that contain\", \"s NUnit tests that can run on .NET Core on Windows, Linux and\\nMacOS,\\n\\nc# Linux macOS Windows Desktop\", \" Test Web\\n\\nNUnit Test Project\\n\\nName your tests in a consistent fashion, with names that indicate wha\", \"t each test does. One approach\\nI've had great success with is to name test classes according to the \", \"class and method they are testing.\\nThis approach results in many small test classes, but it makes It\", \" extremely clear what each test is\\nresponsible for. With the test class name set up, to identify the\", \" class and method to be tested, the test\\nmethod name can be used to specify the behavior being teste\", \"d. This name should include the\\nexpected behavior and any inputs or assumptions that should yield th\", \"is behavior. Some example test\\n\\nNames:\\n\\n. CatalogControllerGetImage.CallslmageServiceWithld\\n\\n. Catal\", \"ogControllerGetImage.LogsWarningGiven|mageMissingException\\n\\n. CatalogControllerGetImage.ReturnsFileR\", \"esultWithBytesGivenSuccess\\n\\n. CatalogControllerGetImage.ReturnsNotFoundResultGivenlmageMissingExcept\", \"ion\\n\\nA variation of this approach ends each test class name with \\u201cShould\\u201d and modifies the tense sli\", \"ghtly:\\n\\n. CatalogControllerGetImageShould.CalllmageServiceWithld\\n\\n. CatalogControllerGetImageShould.\", \"LogWarningGivenlmageMissingException\\n\\n89\\n\\nCHAPTER 8 | Test ASP.NET Core MVC apps\\nSome teams find the\", \" second naming approach clearer, though slightly more verbose. In any case, try\\nto use a naming conv\", \"ention that provides insight into test behavior, so that when one or more tests\\nfail, it's obvious f\", \"rom their names what cases have failed. Avoid naming your tests vaguely, such as\\nControllerTests.Tes\", \"t1, as these names offer no value when you see them in test results.\\n\\nIf you follow a naming convent\", \"ion like the one above that produces many small test classes, it\\u2019s a\\ngood idea to further organize y\", \"our tests using folders and namespaces. Figure 9-4 shows one\\napproach to organizing tests by folder \", \"within several test projects.\\n\\n4 ([-7 tests\\n4471 FunctionalTests\\n>b a! Dependencies\\n> BED PublicApi\\n\", \"44-7 Web\\n4 4[=7 Controllers\\nbP AC# AccountControllerSignin.cs\\nb AC# CatalogControllerlndex.cs\\nPb AC#\", \" OrderControllerlndex.cs\\n> Af Pages\\nb ACH WebTestFixture.cs\\n441 Integration Tests\\n>b a! Dependencies\", \"\\n4 4/7 Repositories\\n> &() BasketRepository Tests\\n4 4[=7 OrderRepository Tests\\nb AC# GetByld.cs\\nbP AC\", \"# GetByldWithltemsAsyne.cs\\n4vT] UnitTests\\n>b a! Dependencies\\n4 4|=7 ApplicationCore\\n4 4[=7 Entities\\n\", \"4 4(-7 BasketTests\\nPb AC# BasketAddltem.cs\\nb AC# BasketRemoveEmptyltems.cs\\nb AC# Basket lotalltems.c\", \"s\\n>b AL CatalogltemTests\\n> Af OrderTests\\n> Af) Extensions\\n> AL) Services\\n> AL Specifications\\n> &( Bu\", \"ilders\\n\\nFigure 9-4. Organizing test classes by folder based on class being tested.\\n\\nIf a particular \", \"application class has many methods being tested (and thus many test classes), it may\\nmake sense to p\", \"lace these classes in a folder corresponding to the application class. This organization\\nis no diffe\", \"rent than how you might organize files into folders elsewhere. If you have more than three\\n\\n90 CHAPT\", \"ER 8 | Test ASP.NET Core MVC apps\\nor four related files in a folder containing many other files, it\\u2019\", \"s often helpful to move them into their\\nown subfolder.\\n\\nUnit testing ASP.NET Core apps\\n\\nIn a well-de\", \"signed ASP.NET Core application, most of the complexity and business logic will be\\nencapsulated in b\", \"usiness entities and a variety of services. The ASP.NET Core MVC app itself, with its\\ncontrollers, f\", \"ilters, viewmodels, and views, should require few unit tests. Much of the functionality of a\\ngiven a\", \"ction lies outside the action method itself. Testing whether routing or global error handling\\nwork c\", \"orrectly cannot be done effectively with a unit test. Likewise, any filters, including model\\nvalidat\", \"ion and authentication and authorization filters, cannot be unit tested with a test targeting a\\ncont\", \"roller's action method. Without these sources of behavior, most action methods should be\\ntrivially s\", \"mall, delegating the bulk of their work to services that can be tested independent of the\\ncontroller\", \" that uses them.\\n\\nSometimes you'll need to refactor your code in order to unit test it. Frequently t\", \"his activity involves\\nidentifying abstractions and using dependency injection to access the abstract\", \"ion in the code you'd\\nlike to test, rather than coding directly against infrastructure. For example,\", \" consider this easy action\\nmethod for displaying images:\\n\\n[HttpGet(\\\"[controller]/pic/{id}\\\") ]\\npublic\", \" IActionResult GetImage(int id)\\n{\\n\\nvar contentRoot = _env.ContentRootPath + \\\"//Pics\\\";\\n\\nvar path = Pa\", \"th.Combine(contentRoot, id + \\\".png\\\");\\nByte[ |] b = System.1I0.File.ReadAl11Bytes(path) ;\\nreturn File\", \"(b, \\\"\\u201cimage/png\\\") ;\\n\\nUnit testing this method is made difficult by its direct dependency on System.!\", \"O.File, which it uses to\\nread from the file system. You can test this behavior to ensure it works as\", \" expected, but doing so with\\nreal files is an integration test. It's worth noting you can\\u2019t unit tes\", \"t this method's route\\u2014you'll see how\\nto do this testing with a functional test shortly.\\n\\nIf you can\\u2019\", \"t unit test the file system behavior directly, and you can\\u2019t test the route, what is there to\\ntest? \", \"Well, after refactoring to make unit testing possible, you may discover some test cases and\\nmissing \", \"behavior, such as error handling. What does the method do when a file isn't found? What\\nshould it do\", \"? In this example, the refactored method looks like this:\\n\\n[HttpGet(\\\"[controller]/pic/{id}\\\") ]\\npubli\", \"c IActionResult GetImage(int id)\\n{\\n\\nbyte[ |] imageBytes;\\n\\ntry\\n\\n{\\n\\nimageBytes = _imageService.GetImag\", \"eBytesById(id) ;\\n}\\n\\ncatch (CatalogImageMissingException ex)\\n\\nt\\n_logger.LogWarning($\\\"No image found f\", \"or id: {id}\\\");\\nreturn NotFound();\\n\\n}\\n\\n91 CHAPTER 8 | Test ASP.NET Core MVC apps\\nreturn File(imageByt\", \"es, \\\"\\u201cimage/png\\\") ;\\n}\\n_logger and _imageService are both injected as dependencies. Now you can test \", \"that the same ID that\\nis passed to the action method is passed to _imageService, and that the result\", \"ing bytes are returned\\nas part of the FileResult. You can also test that error logging is happening \", \"as expected, and that a\\nNotFound result is returned if the image is missing, assuming this behavior \", \"is important application\\nbehavior (that is, not just temporary code the developer added to diagnose \", \"an issue). The actual file\\nlogic has moved into a separate implementation service, and has been augm\", \"ented to return an\\napplication-specific exception for the case of a missing file. You can test this \", \"implementation\\nindependently, using an integration test.\\n\\nIn most cases, you'll want to use global e\", \"xception handlers in your controllers, so the amount of logic\\nin them should be minimal and probably\", \" not worth unit testing. Do most of your testing of controller\\nactions using functional tests and th\", \"e TestServer class described below.\\n\\nIntegration testing ASP.NET Core apps\\n\\nMost of the integration \", \"tests in your ASP.NET Core apps should be testing services and other\\nimplementation types defined in\", \" your Infrastructure project. For example, you could test that EF Core\\nwas successfully updating and\", \" retrieving the data that you expect from your data access classes\\nresiding in the Infrastructure pr\", \"oject. The best way to test that your ASP.NET Core MVC project is\\nbehaving correctly is with functio\", \"nal tests that run against your app running in a test host.\\n\\nFunctional testing ASP.NET Core apps\\n\\nF\", \"or ASP.NET Core applications, the TestServer class makes functional tests fairly easy to write. You\\n\", \"configure a TestServer using a WebHostBuilder (or HostBuilder) directly (as you normally do for your\", \"\\napplication), or with the WebApplicationFactory type (available since version 2.1). Try to match yo\", \"ur\\ntest host to your production host as closely as possible, so your tests exercise behavior similar\", \" to what\\nthe app will do in production. The WebApplicationFactory class is helpful for configuring t\", \"he\\nTestServer's ContentRoot, which is used by ASP.NET Core to locate static resource like Views.\\n\\nYo\", \"u can create simple functional tests by creating a test class that implements\\nIClassFixture<WebAppli\", \"cationFactory<TEntryPoint> >, where TEntryPoint is your web application's\\nStartup class. With this i\", \"nterface in place, your test fixture can create a client using the factory's\\nCreateClient method:\\n\\np\", \"ublic class BasicWebTests : IClassFixture<WebApplicationFactory<Program>>\\n\\n{\\nprotected readonly Http\", \"Client client;\\n\\npublic BasicWebTests(WebApplicationFactory<Program> factory)\\n\\n{\\n_client = factory.Cr\", \"eateClient() ;\\nb\\n\\n92 CHAPTER 8 | Test ASP.NET Core MVC apps\\n// write tests that use client\\n\\n}\\n\\nTip\\n\\n\", \"If you're using minimal API configuration in your Program.cs file, by default the class will be decl\", \"ared\\ninternal and won't be accessible from the test project. You can choose any other instance class\", \" in your\\nweb project instead, or add this to your Program.cs file:\\n\\n]{custom-style=Code} csharp // M\", \"ake the implicit Program class public so test projects can access it\\npublic partial class Program {}\", \" [\\n\\nFrequently, you'll want to perform some additional configuration of your site before each test r\", \"uns,\\nsuch as configuring the application to use an in-memory data store and then seeding the applica\", \"tion\\nwith test data. To achieve this functionality, create your own subclass of\\nWebApplicationFactor\", \"y<TEntryPoint> and override its ConfigureWebHost method. The example\\nbelow is from the eshopOnWeb Fu\", \"nctionalTests project and is used as part of the tests on the main\\nweb application.\\n\\nusing Microsoft\", \".AspNetCore.Hosting;\\n\\nusing Microsoft.AspNetCore. Identity;\\n\\nusing Microsoft.AspNetCore.Mvc.Testing;\", \"\\n\\nusing Microsoft.EntityFrameworkCore;\\n\\nusing Microsoft.eShopWeb. Infrastructure. Data;\\nusing Micros\", \"oft.eShopWeb. Infrastructure. Identity;\\nusing Microsoft.eShopWeb.Web;\\n\\nusing Microsoft.Extensions.De\", \"pendencyInjection;\\nusing Microsoft.Extensions.Logging;\\n\\nusing System;\\n\\nnamespace Microsoft.eShopWeb.\", \"FunctionalTests.Web;\\npublic class WebTestFixture : WebApplicationFactory<Startup>\\n{\\n\\nprotected overr\", \"ide void ConfigureWebHost(IWebHostBuilder builder)\\n\\n{\\n\\nbuilder.UseEnvironment(\\\"Testing\\u201d\\\" ) ;\\n\\nbuilde\", \"r.ConfigureServices(services =>\\n\\n{\\n\\nservices. AddEntityFrameworkInMemoryDatabase() ;\\n\\n// Create a ne\", \"w service provider.\\n\\nvar provider = services\\n.AddEntityFrameworkInMemoryDatabase( )\\n.BuildServicePro\", \"vider() ;\\n\\n// Add a database context (ApplicationDbContext) using an in-memory\\n// database for testi\", \"ng.\\nservices. AddDbContext<CatalogContext>(options =>\\n\\n{\\n\\noptions .UseInMemoryDatabase(\\\"InMemoryDbFo\", \"rTesting\\\" ) ;\\noptions .UseInternalServiceProvider (provider) ;\\n\\n})5\\n\\nservices .AddDbContext<AppIdent\", \"ityDbContext>(options =>\\n{\\n\\n93 CHAPTER 8 | Test ASP.NET Core MVC apps\\noptions .UseInMemoryDatabase(\\\"\", \"Identity\\\") ;\\noptions .UseInternalServiceProvider (provider) ;\\n\\n})5\\n\\n// Build the service provider.\\nv\", \"ar sp = services.BuildServiceProvider() ;\\n\\n// Create a scope to obtain a reference to the database\\n/\", \"/ context (ApplicationDbContext) .\\nuSing (var scope = sp.CreateScope() )\\n{\\nvar scopedServices = scop\", \"e.ServiceProvider;\\nvar db = scopedServices.GetRequiredService<CatalogContext>() ;\\nvar loggerFactory \", \"= scopedServices.GetRequiredService<ILoggerFactory>() ;\\n\\nvar logger = scopedServices\\n.GetRequiredSer\", \"vice<ILogger<WebTestFixture>>() ;\\n\\n// Ensure the database is created.\\ndb.Database.EnsureCreated() ;\\n\", \"\\ntry\\n\\n{\\n// Seed the database with test data.\\nCatalogContextSeed.SeedAsync(db, loggerFactory) .Wait()\", \";\\n\\n// seed sample user data\\nvar userManager =\\nscopedServices.GetRequiredService<UserManager<Applicat\", \"ionUser>>() ;\\nvar roleManager = scopedServices.GetRequiredService<RoleManager<IdentityRole>>() ;\\nApp\", \"IdentityDbContextSeed.SeedAsync(userManager, roleManager) .Wait() ;\\n}\\n\\ncatch (Exception ex)\\n\\n{\\n\\nlogg\", \"er.LogError(ex, $\\\"An error occurred seeding the \\\" +\\n\\u201cdatabase with test messages. Error: {ex.Message\", \"}\\\") ;\\n\\n}\\n}\\n})3\\n}\\n}\\n\\nTests can make use of this custom WebApplicationFactory by using it to create a \", \"client and then\\nmaking requests to the application using this client instance. The application will \", \"have data seeded\\nthat can be used as part of the test's assertions. The following test verifies that\", \" the home page of the\\neShopOnWeb application loads correctly and includes a product listing that was\", \" added to the\\napplication as part of the seed data.\\n\\nusing Microsoft.eShopWeb.FunctionalTests.wWeb;\\n\", \"using System.Net.Http;\\n\\nusing System. Threading.Tasks;\\n\\nusing Xunit;\\n\\nnamespace Microsoft.eShopWeb.F\", \"unctionalTests.WebRazorPages ;\\n[Collection( \\\"Sequential\\\" ) |\\npublic class HomePageOnGet : IClassFixt\", \"ure<WebTestFixture>\\n\\n{\\npublic HomePageOnGet (WebTestFixture factory)\\n\\n{\\n\\n94 CHAPTER 8 | Test ASP.NET\", \" Core MVC apps\\nClient = factory.CreateClient();\\n}\\n\\npublic HttpClient Client { get; }\\n\\n[Fact |\\npublic\", \" async Task ReturnsHomePageWithProductListing( )\\n\\n{\\n// Arrange & Act\\nvar response = await Client.Get\", \"Async(\\\"/\\\");\\nresponse. EnsureSuccessStatusCode() ;\\nvar stringResponse = await response.Content.ReadAs\", \"StringAsync();\\n\\n// Assert\\nAssert.Contains(\\\".NET Bot Black Sweatshirt\\\", stringResponse) ;\\n\\nThis funct\", \"ional test exercises the full ASP.NET Core MVC / Razor Pages application stack, including all\\nmiddle\", \"ware, filters, and binders that may be in place. It verifies that a given route (\\\"/\\\") returns the\\nex\", \"pected success status code and HTML output. It does so without setting up a real web server, and\\navo\", \"ids much of the brittleness that using a real web server for testing can experience (for example,\\npr\", \"oblems with firewall settings). Functional tests that run against TestServer are usually slower than\", \"\\nintegration and unit tests, but are much faster than tests that would run over the network to a tes\", \"t\\nweb server. Use functional tests to ensure your application's front-end stack is working as expect\", \"ed.\\nThese tests are especially useful when you find duplication in your controllers or pages and you\", \"\\naddress the duplication by adding filters. Ideally, this refactoring won't change the behavior of t\", \"he\\napplication, and a suite of functional tests will verify this is the case.\\n\\nReferences \\u2014 Test ASP\", \".NET Core MVC apps\\n\\n. Testing in ASP.NET Core\\nhttps://learn.microsoft.com/aspnet/core/testing/\\n\\n. Un\", \"it Test Naming Convention\\nhttps://ardalis.com/unit-test-naming-convention\\n\\n\\u00b0 Testing EF Core\\nhttps:/\", \"/learn.microsoft.com/ef/core/miscellaneous/testing/\\n\\n. Integration tests in ASP.NET Core\\nhttps://lea\", \"rn.microsoft.com/aspnet/core/test/integration-tests\\n\\n95 CHAPTER 8 | Test ASP.NET Core MVC apps\\nCHAPT\", \"ER O\\n\\nDevelopment process for\\nAzure\\n\\n\\u201cWith the cloud, individuals and small businesses can snap thei\", \"r fingers and instantly set up enterprise-\\nclass services.\\u201d\\n- Roy Stephan\\n\\nVision\\nDevelop well-desig\", \"ned ASP .NET Core applications the way you like, using Visual Studio or the dotnet\\nCLI and Visual St\", \"udio Code or your editor of choice.\\n\\nDevelopment environment for ASP.NET Core apps\\n\\nDevelopment tool\", \"s choices: IDE or editor\\n\\nWhether you prefer a full and powerful IDE or a lightweight and agile edit\", \"or, Microsoft has you\\ncovered when developing ASP.NET Core applications.\\n\\nVisual Studio 2022. Visual\", \" Studio 2022 is the best-in-class IDE for developing applications for\\nASP.NET Core. It offers a host\", \" of features that increase developer productivity. You can use It to\\ndevelop the application, then a\", \"nalyze its performance and other characteristics. The integrated\\ndebugger lets you pause code execut\", \"ion and step back and forth through code on the fly as it's\\nrunning. Its support for hot reloads all\", \"ows you to continue working with your app where you left off,\\neven after making code changes, withou\", \"t having to restart the app. The built-in test runner lets you\\norganize your tests and their results\", \" and can even perform live unit testing while you're coding. Using\\nLive Share, you can collaborate i\", \"n real-time with other developers, sharing your code session\\nseamlessly over the network. And when y\", \"ou're ready, Visual Studio includes everything you need to\\npublish your application to Azure or wher\", \"ever you might host it.\\n\\nDownload Visual Studio 2022\\n\\nVisual Studio Code and dotnet CLI (Cross-Platf\", \"orm Tools for Mac, Linux, and Windows). If you prefer\\na lightweight and cross-platform editor suppor\", \"ting any development language, you can use Microsoft\\nVisual Studio Code and the dotnet CLI. These pr\", \"oducts provide a simple yet robust experience that\\n\\n96 CHAPTER 9 | Development process for Azure\\nstr\", \"eamlines the developer workflow. Additionally, Visual Studio Code supports extensions for C# and\\nweb\", \" development, providing intellisense and shortcut-tasks within the editor.\\n\\nDownload the .NET SDK\\n\\nD\", \"ownload Visual Studio Code\\n\\nDevelopment workflow for Azure-hosted ASP.NET\\nCore apps\\n\\nThe application\", \" development lifecycle starts from each developer's machine, coding the app using\\ntheir preferred la\", \"nguage and testing it locally. Developers may choose their preferred source control\\nsystem and can c\", \"onfigure Continuous Integration (Cl) and/or Continuous Delivery/Deployment (CD)\\nusing a build server\", \" or based on built-in Azure features.\\n\\nTo get started with developing an ASP.NET Core application us\", \"ing CI/CD, you can use Azure DevOps\\nServices or your organization\\u2019s own Team Foundation Server (TFS)\", \". GitHub Actions provide another\\noption for easily building and deploying apps to Azure, for apps wh\", \"ose code is hosted on GitHub.\\n\\nInitial setup\\n\\nTo create a release pipeline for your app, you need to\", \" have your application code in source control.\\nSet up a local repository and connect it to a remote \", \"repository in a team project. Follow these\\ninstructions:\\n\\n\\u00b0 Share your code with Git and Visual Stud\", \"io or\\n\\n\\u00b0 Share your code with TFVC and Visual Studio\\n\\nCreate an Azure App Service where you'll deplo\", \"y your application. Create a Web App by going to the\\nApp Services blade on the Azure portal. Click +\", \"Add, select the Web App template, click Create, and\\nprovide a name and other details. The web app wi\", \"ll be accessible from {name}.azurewebsites.net.\\n\\n97 CHAPTER 9 | Development process for Azure\\nNew > \", \"Web + Mobile\\n\\nex Web + Mobile\\n\\n\\u00bb Search the marketplace\\n\\nin\\nMARKETPLACE See all FEATURED APPS\\na\\nComp\", \"ute \\u00bb\\nNetworking \\u00bb = \\u2014\\nUy or your we\\nStorage \\u00bb\\na Databases \\u00bb : 7 - 6 A : Dy dow a\\nry Data + Analytic\", \"s \\u00bb Logic App\\na Al + Cognitive Services \\u00bb { 4} _. oe . eee q\\n\\na\\n\\na\\n\\nFigure 10-7. Creating a new Azur\", \"e App Service Web App in the Azure Portal.\\n\\nYour Cl build process will perform an automated build wh\", \"enever new code is committed to the\\nproject's source control repository. This process gives you imme\", \"diate feedback that the code builds\\n(and, ideally, passes automated tests) and can potentially be de\", \"ployed. This Cl build will produce a\\nweb deploy package artifact and publish it for consumption by y\", \"our CD process.\\n\\nDefine your Cl build process\\n\\nBe sure to enable continuous integration so the syste\", \"m will queue a build whenever someone on your\\nteam commits new code. Test the build and verify that \", \"it is producing a web deploy package as one of\\nits artifacts.\\n\\nWhen a build succeeds, your CD proces\", \"s will deploy the results of your Cl build to your Azure web\\napp. To configure this step, you create\", \" and configure a Release, which will deploy to your Azure App\\nService.\\n\\nDeploy an Azure web app\\n\\nOnc\", \"e your CI/CD pipeline is configured, you can easily make updates to your web app and commit\\nthem to \", \"source control to have them deployed.\\n\\nWorkflow for developing Azure-hosted ASP.NET Core application\", \"s\\n\\nOnce you have configured your Azure account and your CI/CD process, developing Azure-hosted\\nASP.N\", \"ET Core applications is simple. The following are the basic steps you usually take when building\\nan \", \"ASP.NET Core app, hosted in Azure App Service as a Web App, as illustrated in Figure 10-2.\\n\\n98 CHAPT\", \"ER 9 | Development process for Azure\\nend-to-end development / deployment workflow\\n\\n- 3. 4. 5.\\nApplic\", \"ation Build, Cl, Run, Manage\\nCode Repo Integrate, Test\\n\\nCD, Deploy App Service\\nWeb App\\n\\n(SCC)\\n\\nes cb\", \" a sce\\n\\n6\\n\\nMonitor and Diagnose\\n\\nCode\\nTest\\nRun\\nDebug\\n\\nCommit VS Application Insig Outer -Loop\\n\\nDev E\", \"nvironment\\n\\nFigure 10-2. Step-by-step workflow for building ASP.NET Core apps and hosting them in Az\", \"ure\\n\\nStep 1. Local dev environment inner loop\\n\\nDeveloping your ASP.NET Core application for deployme\", \"nt to Azure is no different from developing\\nyour application otherwise. Use the local development en\", \"vironment you're comfortable with, whether\\nthat's Visual Studio 2019 or the dotnet CLI and Visual St\", \"udio Code or your preferred editor. You can\\nwrite code, run and debug your changes, run automated te\", \"sts, and make local commits to source\\ncontrol until you're ready to push your changes to your shared\", \" source control repository.\\n\\nStep 2. Application code repository\\n\\nWhenever you're ready to share you\", \"r code with your team, you should push your changes from your\\nlocal source repository to your team\\u2019s\", \" shared source repository. If you've been working in a custom\\nbranch, this step usually involves mer\", \"ging your code into a shared branch (perhaps by means of a pull\\n\\nrequest).\\n\\nStep 3. Build Server: Co\", \"ntinuous integration. build, test, package\\n\\nA new build is triggered on the build server whenever a \", \"new commit is made to the shared\\napplication code repository. As part of the Cl process, this build \", \"should fully compile the application\\nand run automated tests to confirm everything is working as exp\", \"ected. The end result of the Cl\\nprocess should be a packaged version of the web app, ready for deplo\", \"yment.\\n\\nStep 4. Build Server: Continuous delivery\\n\\nOnce a build has succeeded, the CD process will p\", \"ick up the build artifacts produced. This process will\\ninclude a web deploy package. The build serve\", \"r will deploy this package to Azure App Service,\\n\\n99 CHAPTER 9 | Development process for Azure\\nrepla\", \"cing any existing service with the newly created one. Typically this step targets a staging\\nenvironm\", \"ent, but some applications deploy directly to production through a CD process.\\n\\nStep 5. Azure App Se\", \"rvice Web App\\nOnce deployed, the ASP.NET Core application runs within the context of an Azure App Se\", \"rvice Web\\nApp. This Web App can be monitored and further configured using the Azure Portal.\\n\\nStep 6.\", \" Production monitoring and diagnostics\\n\\nWhile the Web App is running, you can monitor the health of \", \"the application and collect diagnostics\\nand user behavior data. Application Insights is included in \", \"Visual Studio, and offers automatic\\ninstrumentation for ASP.NET apps. It can provide you with inform\", \"ation on usage, exceptions, requests,\\nperformance, and logs.\\n\\nReferences\\n\\nBuild and Deploy Your ASP.\", \"NET Core App to Azure\\nhttps://learn.microsoft.com/azure/devops/build-release/apps/aspnet/build-aspne\", \"t-core\\n\\n100 CHAPTER 9 | Development process for Azure\\nCHAPTER |\\n\\nAzure hosting\\nrecommendations for\\n\\n\", \"ASP.NET Core web apps\\n\\n\\u201cLine-of-business leaders everywhere are bypassing IT departments to get appl\", \"ications from the cloud\\n(also known as SaaS) and paying for them like they would a magazine subscrip\", \"tion. And when the\\nservice is no longer required, they can cancel the subscription with no equipment\", \" left unused in the\\ncorner.\\u201d\\n\\n- Daryl Plummer, Gartner analyst\\n\\nWhatever your application\\u2019s needs an\", \"d architecture, Microsoft Azure can support it. Your hosting\\nneeds can be as simple as a static webs\", \"ite or a sophisticated application made up of dozens of\\nservices. For ASP.NET Core monolithic web ap\", \"plications and supporting services, there are several\\nwell-known configurations that are recommended\", \". The recommendations on this article are grouped\\nbased on the kind of resource to be hosted, whethe\", \"r full applications, individual processes, or data.\\n\\nWeb applications\\nWeb applications can be hosted\", \" with:\\n. App Service Web Apps\\n\\u00b0 Containers (several options)\\n\\u00b0 Virtual Machines (VMs)\\n\\nOf these, App\", \" Service Web Apps is the recommended approach for most scenarios, including simple\\ncontainer-based a\", \"pps. For microservice architectures, consider a container-based approach. If you\\nneed more control o\", \"ver the machines running your application, consider Azure Virtual Machines.\\n\\nApp Service Web Apps\\n\\nA\", \"pp Service Web Apps offers a fully managed platform optimized for hosting web applications. It\\u2019s a\\np\", \"latform as a service (PaaS) offering that lets you focus on your business logic, while Azure takes c\", \"are\\nof the infrastructure needed to run and scale the app. Some key features of App Service Web Apps\", \":\\n\\n101 CHAPTER 10 | Azure hosting recommendations for ASP.NET Core web apps\\n. DevOps optimization (c\", \"ontinuous integration and delivery, multiple environments, A/B\\ntesting, scripting support).\\n\\n. Globa\", \"l scale and high availability.\\n\\n. Connections to SaaS platforms and your on-premises data.\\n. Securit\", \"y and compliance.\\n\\n. Visual Studio integration.\\n\\nAzure App Service is the best choice for most web a\", \"pps. Deployment and management are integrated\\ninto the platform, sites can scale quickly to handle h\", \"igh traffic loads, and the built-in load balancing\\nand traffic manager provide high availability. Yo\", \"u can move existing sites to Azure App Service easily\\nwith an online migration tool. You can use an \", \"open-source app from the Web Application Gallery, or\\ncreate a new site using the framework and tools\", \" of your choice. The WebJobs feature makes it easy to\\nadd background job processing to your App Serv\", \"ice web app. If you have an existing ASP.NET\\napplication hosted on-premises using a local database, \", \"there\\u2019s a clear path to migrate. You can use\\nApp Service Web App with an Azure SQL Database (or secu\", \"re access to your on-premises database\\nserver, if preferred).\\n\\nap Existing TAN Cloud AN Cloud-Optimi\", \"zed\\n\\n.NET applications (on-prem.) Infrastructure-Ready Existing .NET apps\\n\\nMonolithic or N-Tier Mono\", \"lithic or N-Tier Monolithic or N-Tier\\n\\nASP.NET VMs (laaS Azure) Azure App Service\\nMVC\\n\\\\ie|eoeoos SQL\", \" Server VM Azure Container Instance\\n\\nAzure Web Apps\\nFor Containers\\n\\nWeb API Reber RDBMS VMs\\nSignalR\\n\", \"\\nYour current Teas Windows Containers\\nWeb Pages Monitoring Tools On VMs\\n\\nYour current Deployment Azu\", \"re SQL DB\\nMonitoring (App Insights)\\nRelational Database sare 3\\n\\n(SQL, Oracle, MySQL, etc.) Cl/CD (Az\", \"ure DevOps)\\n\\nMicrosoft Microsoft\\n\\n.NET\\n\\n.NET\\n\\n|\\naz\\n\\nas\\n||\\n\\nIn most cases, moving from a locally host\", \"ed ASP.NET app to an App Service Web App is a\\nstraightforward process. Little or no modification sho\", \"uld be required of the app itself, and it can\\nquickly start to take advantage of the many features t\", \"hat Azure App Service Web Apps offer.\\n\\n102 CHAPTER 10 | Azure hosting recommendations for ASP.NET Co\", \"re web apps\\nIn addition to apps that are not optimized for the cloud, Azure App Service Web Apps are\", \" an excellent\\nsolution for many simple monolithic (non-distributed) applications, such as many ASP.N\", \"ET Core apps.\\nIn this approach, the architecture is basic and simple to understand and manage:\\n\\nAzur\", \"e Active App Service plan Azure SQL Database\\nDirectory eS.\\n\\nLogical server\\n\\noe.\\n\\nCena T > RS) Databa\", \"se Database\\n\\nStorage blob\\n\\n7 ! App Service\\n| ! web app\\nY |\\n\\u201ca> 1\\n3\\nA 01\\nAzure DNS\\n\\nA small number of\", \" resources in a single resource group is typically sufficient to manage such an app.\\nApps that are t\", \"ypically deployed as a single unit, rather than those apps that are made up of many\\nseparate process\", \"es, are good candidates for this basic architectural approach. Though architecturally\\nsimple, this a\", \"pproach still allows the hosted app to scale both up (more resources per node) and out\\n(more hosted \", \"nodes) to meet any increase in demand. With autoscale, the app can be configured to\\nautomatically ad\", \"just the number of nodes hosting the app based on demand and average load across\\nnodes.\\n\\nApp Service\", \" Web Apps for Containers\\n\\nIn addition to support for hosting web apps directly, App Service Web Apps\", \" for Containers can be\\nused to run containerized applications on Windows and Linux. Using this servi\", \"ce, you can easily\\ndeploy and run containerized applications that can scale with your business. The \", \"apps have all of the\\nfeatures of App Service Web Apps listed above. In addition, Web Apps for Contai\", \"ners supports\\nstreamlined Cl/CD with Docker Hub, Azure Container Registry, and GitHub. You can use A\", \"zure DevOps\\nto define build and deployment pipelines that publish changes to a registry. These chang\", \"es can then\\nbe tested in a staging environment and automatically deployed to production using deploy\", \"ment slots,\\nallowing zero-downtime upgrades. Rolling back to previous versions can be done just as e\", \"asily.\\n\\nThere are a few scenarios where Web Apps for Containers makes the most sense. If you have ex\", \"isting\\napps that you can containerize, whether in Windows or Linux containers, you can host these ea\", \"sily\\nusing this toolset. Just publish your container and then configure Web Apps for Containers to p\", \"ull the\\nlatest version of that image from your registry of choice. This is a \\u201clift and shift\\u201d approa\", \"ch to migrating\\nfrom classic app hosting models to a cloud-optimized model.\\n\\n103 CHAPTER 10 | Azure \", \"hosting recommendations for ASP.NET Core web apps\\nap Existing\\n\\n.NET applications (on-prem.)\\n\\nMonolit\", \"hic or N-Tier\\n\\nASP.NET\\nMVC\\n\\nVVOUPFOTITIS\\n\\nWeb API\\nSignalR\\n\\nWeb Pages\\n\\nWCF\\n\\nRelational Database\\n(SQL,\", \" Oracle, MySQL, etc.)\\n\\nMicrosoft\\n\\nCloud\\n\\nInfrastructure-Ready\\n\\nMonolithic or N-Tier\\nVMs (laaS Azure)\", \"\\nSQL Server VM\\n\\nBaber RDBMS VMs\\n\\nYour current Peas\\nMonitoring Tools\\n\\nYour current Deployment\\nTools (\", \"Puppet, Chef, etc.)\\n\\nMicrosoft\\n\\nAN Cloud-Optimized\\n\\nExisting .NET apps\\n\\nMonolithic or N-Tier\\nAzure A\", \"pp Service\\n\\nAzure Container Instance\\n\\nAzure Web Apps\\nFor Containers\\n\\nWindows Containers\\nOn VMs\\n\\nAzur\", \"e SQL DB\\n\\nMonitoring (App Insights)\\n\\nCl/CD (Azure DevOps)\\n\\nMicrosoft\\n\\nThis approach also works well \", \"if your development team is able to move to a container-based\\ndevelopment process. The \\u201cinner loop\\u201d \", \"of developing apps with containers includes building the app\\nwith containers. Changes made to the co\", \"de as well as to container configuration are pushed to source\\ncontrol, and an automated build is res\", \"ponsible for publishing new container images to a registry like\\nDocker Hub or Azure Container Regist\", \"ry. These images are then used as the basis for additional\\ndevelopment, as well as for deployments t\", \"o production, as shown in the following diagram:\\n\\n104\\n\\nCHAPTER 10 | Azure hosting recommendations fo\", \"r ASP.NET Core web apps\\nEnd to End Docker DevOps Lifecycle Workflow\\n\\n5 ashy, Azure\\n. ie \\u00a7=Web Apps f\", \"or\\nRun, manage (eients\\n\\n2. 3. 4.\\nApplication Build, Cl,\\ncode repo integrate, test\\n\\nCD, deploy\\n\\nica\\n\\n\", \"Microsoft\\n2 Azure\\n\\n(SCC)\\n\\nAzure DevOps Azure DevOps\\n\\u00a5 4\\n\\n| docker push |\\n\\nCode = \\u00ab\\n=\\n\\nDocker OTR  Do\", \"cxerHus\\nregistry\\n\\nCi\\n\\nMonitor and diagnose\\n\\nil +O\\n\\nOuter loop\\n\\nVS Application Insights\\n\\nDev environm\", \"ent\\n\\nDeveloping with containers offers many advantages, especially when containers are used in\\nprodu\", \"ction. The same container configuration is used to host the app in each environment in which it\\nruns\", \", from the local development machine to build and test systems to production. This approach\\ngreatly \", \"reduces the likelihood of defects resulting from differences in machine configuration or\\nsoftware ve\", \"rsions. Developers can also use whatever tools they're most productive with, including the\\noperating\", \" system, since containers can run on any OS. In some cases, distributed applications\\ninvolving many \", \"containers may be very resource-intensive to run on a single development machine. In\\nthis scenario, \", \"it may make sense to upgrade to using Kubernetes and Azure Dev Spaces, covered in\\nthe next section.\\n\", \"\\nAs portions of larger applications are broken up into their own smaller, independent microservices,\", \"\\nadditional design patterns can be used to improve app behavior. Instead of working directly with\\nin\", \"dividual services, an AP/ gateway can simplify access and decouple the client from its back end.\\nHav\", \"ing separate service back ends for different front ends also allows services to evolve in concert\\nwi\", \"th their consumers. Common services can be accessed via a separate sidecar container, which might\\nin\", \"clude common client connectivity libraries using the ambassador pattern.\\n\\n105 CHAPTER 10 | Azure hos\", \"ting recommendations for ASP.NET Core web apps\\nMicroservices application\\n\\nBackends for\\nFrontends\\n\\nAP\", \"I Gateway\\n\\nMicroservice\\n\\nGateway ara for\\nGateway ___ Routing\\n\\nOffloading\\n\\nAmbassador\\n\\nRemote\\n> servi\", \"ce\\n\\nGateway\\n\\n* Microservice for\\nAggregation\\n\\nmobile\\n\\nMicroservice\\nStrangler\\n\\nAnti-corruption\\nlayer\\n\\n\", \"Legacy system\\n\\nLearn more about design patterns to consider when building microservice-based systems\", \".\\n\\nClient\\napplication\\n\\nAzure Kubernetes Service\\n\\nAzure Kubernetes Service (AKS) manages your hosted \", \"Kubernetes environment, making it quick and\\neasy to deploy and manage containerized applications wit\", \"hout container orchestration expertise. It\\nalso eliminates the burden of ongoing operations and main\", \"tenance by provisioning, upgrading, and\\nscaling resources on-demand, without taking your application\", \"s offline.\\n\\nAKS reduces the complexity and operational overhead of managing a Kubernetes cluster by\\n\", \"offloading much of that responsibility to Azure. As a hosted Kubernetes service, Azure handles criti\", \"cal\\ntasks like health monitoring and maintenance for you. Also, you pay only for the agent nodes wit\", \"hin\\nyour clusters, not for the masters. As a managed Kubernetes service, AKS provides:\\n\\n. Automated \", \"Kubernetes version upgrades and patching.\\n. Easy cluster scaling.\\n. Self-healing hosted control plan\", \"e (masters).\\n. Cost savings - pay only for running agent pool nodes.\\nWith Azure handling the managem\", \"ent of the nodes in your AKS cluster, you no longer need to\\n\\nperform many tasks manually, like clust\", \"er upgrades. Because Azure handles these critical maintenance\\ntasks for you, AKS doesn\\u2019t provide dir\", \"ect access (such as with SSH) to the cluster.\\n\\nTeams who are leveraging AKS can also take advantage \", \"of Azure Dev Spaces. Azure Dev Spaces helps\\nteams to focus on the development and rapid iteration of\", \" their microservice application by allowing\\nteams to work directly with their entire microservices a\", \"rchitecture or application running in AKS. Azure\\nDev Spaces also provides a way to independently upd\", \"ate portions of your microservices architecture\\nin isolation without affecting the rest of the AKS c\", \"luster or other developers.\\n\\n106 CHAPTER 10 | Azure hosting recommendations for ASP.NET Core web app\", \"s\\nhttp://dev.myapp.eus.azds.io\\n\\n|\\n\\nAzure Dev Spaces:\\n\\n. Minimize local machine setup time and resour\", \"ce requirements\\n. Allow teams to iterate more rapidly\\n. Reduce the number of integration environment\", \"s required by a team\\n\\n. Remove the need to mock certain services in a distributed system when develo\", \"ping/testing\\n\\nLearn more about Azure Dev Spaces\\n\\nAzure Virtual Machines\\n\\nIf you have an existing app\", \"lication that would require substantial modifications to run in App Service,\\nyou could choose Virtua\", \"l Machines in order to simplify migrating to the cloud. However, correctly\\nconfiguring, securing, an\", \"d maintaining VMs requires much more time and IT expertise compared to\\nAzure App Service. If you're \", \"considering Azure Virtual Machines, make sure you take into account the\\nongoing maintenance effort r\", \"equired to patch, update, and manage your VM environment. Azure\\nVirtual Machines is infrastructure a\", \"s a service (laaS), while App Service is PaaS. You should also\\nconsider whether deploying your app a\", \"s a Windows Container to Web App for Containers might be a\\nviable option for your scenario.\\n\\nLogical\", \" processes\\n\\nIndividual logical processes that can be decoupled from the rest of the application may \", \"be deployed\\nindependently to Azure Functions in a \\u201cserverless\\u201d manner. Azure Functions lets you just\", \" write the\\ncode you need for a given problem, without worrying about the application or infrastructu\", \"re to run it.\\nYou can choose from a variety of programming languages, including C#, F#, Node.js, Pyt\", \"hon, and\\nPHP, allowing you to pick the most productive language for the task at hand. Like most clou\", \"d-based\\nsolutions, you pay only for the amount of time your use, and you can trust Azure Functions t\", \"o scale up\\nas needed.\\n\\nData\\n\\nAzure offers a wide variety of data storage options, so that your appli\", \"cation can use the appropriate\\ndata provider for the data in question.\\n\\n107 CHAPTER 10 | Azure hosti\", \"ng recommendations for ASP.NET Core web apps\\nFor transactional, relational data, Azure SQL Databases\", \" are the best option. For high performance\\nread-mostly data, a Redis cache backed by an Azure SQL Da\", \"tabase is a good solution.\\n\\nUnstructured JSON data can be stored in a variety of ways, from SQL Data\", \"base columns to Blobs or\\nTables in Azure Storage, to Azure Cosmos DB. Of these, Azure Cosmos DB offe\", \"rs the best querying\\nfunctionality, and is the recommended option for large numbers of JSON-based do\", \"cuments that must\\nsupport querying.\\n\\nTransient command- or event-based data used to orchestrate appl\", \"ication behavior can use Azure\\nService Bus or Azure Storage Queues. Azure Service Bus offers more fl\", \"exibility and is the\\nrecommended service for non-trivial messaging within and between applications.\\n\", \"\\nArchitecture recommendations\\n\\nYour application\\u2019s requirements should dictate its architecture. Ther\", \"e are many different Azure\\nservices available. Choosing the right one is an important decision. Micr\", \"osoft offers a gallery of\\nreference architectures to help identify typical architectures optimized f\", \"or common scenarios. You\\nmay find a reference architecture that maps closely to your application\\u2019s r\", \"equirements, or at least\\noffers a starting point.\\n\\nFigure 11-1 shows an example reference architectu\", \"re. This diagram describes a recommended\\narchitecture approach for a Sitecore content management sys\", \"tem website optimized for marketing.\\n\\n\\u20ac \\u2014\\nBrowser ce\\nSitecore Content\\nManagementon Web App\\n\\nRedis Ca\", \"che  Sitecore Content Sitecore Analytics Azure Search\\n. on Azure SQL on Azure SQL\\n\\nSitecore Content\\n\", \"\\nDelivery on Web App\\n\\n?\\n\\nApplication Insights\\n\\nFigure 11-1. Sitecore marketing website reference arc\", \"hitecture.\\n\\nReferences \\u2014 Azure hosting recommendations\\n\\n\\u00b0 Azure Solution Architectures\\nhttps://azure\", \".microsoft.com/solutions/architecture\\n\\n108 CHAPTER 10 | Azure hosting recommendations for ASP.NET Co\", \"re web apps\\n109\\n\\nAzure Basic Web Application Architecture\\n\\nhttps://learn.microsoft.com/azure/archite\", \"cture/reference-architectures/app-service-web-\\napp/basic-web-app\\n\\nDesign Patterns for Microservices\\n\", \"\\nhttps://learn.microsoft.com/azure/architecture/microservices/design/patterns\\n\\nAzure Developer Guide\", \"\\n\\nhttps://azure.microsoft.com/campaigns/developer-guide/\\n\\nWeb Apps overview\\n\\nhttps://learn.microsoft\", \".com/azure/app-service/app-service-web-overview\\n\\nWeb App for Containers\\nhttps://azure.microsoft.com/\", \"services/app-service/containers/\\n\\nIntroduction to Azure Kubernetes Service (AKS)\\n\\nhttps://learn.micr\", \"osoft.com/azure/aks/intro-kubernetes\\n\\nCHAPTER 10 | Azure hosting recommendations for ASP.NET Core we\", \"b apps\\n\"]"