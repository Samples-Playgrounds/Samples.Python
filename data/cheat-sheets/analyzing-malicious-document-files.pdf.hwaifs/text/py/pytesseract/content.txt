ANALYZING MALICIOUS DOCUMENTS

This cheat sheet outlines tips and tools for analyzing
malicious documents, such as Microsoft Office, RTF,
and PDF files.

General Approach to Document Analysis

1. Examine the document for anomalies, such as
risky tags, scripts, and embedded artifacts.

2. Locate embedded code, such as shellcode, -
macros, Javascript, or other suspicious objects.

3. Extract suspicious code or objects from the file.

4. If relevant, deobfuscate and examine macros,
JavaScript, or other embedded code.

5. If relevant, ‘emulate, disassemble and/or debug»
shellcode that you extracted from the document.

6. Understand the next steps in the infection chain.

Microsoft Office Format Notes

Binary Microsoft Office document files (.doc, .xls,
etc. ) use the OLE2 (a. k.a. Structured Storage) format. |

SRP streams in OLE2 documents sometimes store a
cached version of earlier VBA macro code.

OOXML document files (.docx, .xlsm, etc.) supported —
by Microsoft Office are compressed zip archives.

VBA macros in OOXML documents are stored inside” /
an OLE2 binary file, which j is within the zip archive. |

Excel supports XLM. macros s that are ‘embedded as
formulas i in sheets without the OLE2 binary file.

RTE documents don’ t support macros but can contain
malicious embedded files and objects.

Useful MS Office File Analysis Commands

Zipdump.py Examine contents of OOXML
file.pptx file file. pptx.

Zipdump. py Extract file with index 3 from

file. pptx -S 3 Fo _ file. pptx to STDOUT.

olevba fi Le. xism Locate and extract macros

from file.xlsm.

oledump. py List all OLE2 streams present
file.xls -i in file.xls.

oledump. py Extract VBA s source e code.
file. xls "$3 -v from stream 3 in file.xis.

xm dump . py ‘pretty | Format XML file supplied vi via
STDIN for easier analysis.

oledump.py file.xls -p Find obfuscated URLs
plugin_http_heuristics _ in file.xls macros.

vmonkey Emulate the execution of macros
file. doc in file.doc to analyze them.

evilclippy -UU Remove the password prompt —
fi Le. ppt from macros in file.ppt.

msoffc rypto- -tool Decrypt outfile. docm using -
infile.docm specified password to create
outfile.docm -p outfile. docm.

pcodedmp Disassemble VBA- -stomped
fi Le.doc p-code macro from file.doc.
pcode2code Decompile VBA-stomped
file. doc p-code macro from file.doc.
rtfob1. py Extract objects embedded
file.rtf into RTF file.rtf.
rtfdump.py List groups and structure of
fi le. rtf RTF file file.rtf.
rt fdump. py Examine objects ir in RTF file”
file.rtf -0 file.rtf.
rtfdump. py file. rtf Extract hex contents from,
-s 5 -H -d group in RTF file file. rtf.
xlmdeobfuscator Deobfuscate XLM (Excel 4)
--file file.xlsm macros in file.x/sm.

Risky PDF Keywords

/OpenAction and /AA specify the script or action to
run automatically.

/JavaScript, /JS, /AcroForm, and /XFA can specify
JavaScript to run.

/ObjStm can hide objects inside an object stream.

/XObject ca can n embed an n image for phishing.

Be mindful of obfuscation with hex codes, suchas
/JavaScript vs. /J#61vaScript. (See examples.)

Useful PDF File Analysis Commands

pdfid.py Display risky keywords present in
file.pdf -n file file. pdf.

pdf-parser.py | Show stats about keywords. Add
file.pdf -a “.O” to include object streams.

pdf-parser. py Display contents of object id. Add
file. Pat - -o id “ ‘-d” to dump object’ s stream.

odf- parser. py Display objects that
file. ‘pdf -r td reference object id.

gpdf - _password=pass- Decrypt infile. pdf using

--decrypt infile.pdf password pass to create
outfile. pdf outfile.pdf.

Shellcode and Other Analysis Commands

xorsearch -W Locate shellcode patterns inside
7d 3 File. ‘bin the binary file file. bin.

scdbgc /f ‘Emulate execution of shellcode ir in

file.bin file.bin. Use “/off” to specify offset.
runsc32 -f Execute shellcode in file.bin to
file.bin -n observe behavior in an isolated lab.
base64dump. py List Base64-encoded strings
file.txt present in file file. txt.
numbers-to- Convert numbers that represent

string.py file characters in file to a string.

Additional Document Analysis Tools

SpiderMonkey, cscript, and box-js help deobfuscate
JavaScript that you extract from document files.

Use the debugger built into Microsoft Officeto
deobfuscate macros in an isolated lab.

Use AMS\ScriptContentRetrieval. ps 1 to observe |
Microsoft Office execute macros in an 1 isolated lab.

Some automated analysis sandboxes s can analyze
aspects of malicious document files.

REMnux distro includes many of the free document
analysis tools mentioned above.

Authored by Lenny Zeltser with feedback from Pedro Bueno and Didier Stevens. Malicious document analysis and related topics are covered in the SANS Institute course

FOR610: Reverse-Engineering Malware, which Lenny co-authored. Creative Commons v3 “Attribution” License for this cheat sheet version 4.1. More at zeltser.com/cheat-sheets.
